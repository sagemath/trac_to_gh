# Issue 26978: Remove broken SAGE_BUILD_TOOLCHAIN support

Issue created by migration from https://trac.sagemath.org/ticket/27215

Original creator: jdemeyer

Original creation time: 2019-02-04 14:28:17

CC:  embray

The environment variable `SAGE_BUILD_TOOLCHAIN` has always been a bit of a hack. It is currently broken (probably due to #24919): imagine a system where the `gcc` Sage package is installed. If `mpir` is upgraded, then `mpir` is rebuilt (as dependency of `gcc`) with `SAGE_BUILD_TOOLCHAIN` but there is nothing forcing a second build of `mpir`.


---

Comment by jdemeyer created at 2019-02-04 16:30:30

New commits:


---

Comment by git created at 2019-02-04 17:08:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-02-04 17:10:34

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-03-11 11:51:54

I think #27373 shows the other side of the same problem--things aren't nice with mpir/gmp if they come from the system rather than built.


---

Comment by dimpase created at 2019-03-11 12:26:18

Does this ticket try to repair anything, or just removes stuff?


---

Comment by dimpase created at 2019-03-11 12:27:57

I guess #27212 ought to depend on this one, or the other way around, otherwise merging gets messy.


---

Comment by jdemeyer created at 2019-03-11 12:35:50

Replying to [comment:6 dimpase]:
> Does this ticket try to repair anything

Yes, as explained in the ticket description. That's also why it's a blocker ticket: it breaks builds whenever the Sage GCC package is installed.


---

Comment by dimpase created at 2019-03-11 13:34:05

The ticket description does not explain the change in functionality that should be the result, it only explains the defect.


---

Comment by embray created at 2019-03-11 14:19:30

Replying to [comment:9 dimpase]:
> The ticket description does not explain the change in functionality that should be the result, it only explains the defect.

It doesn't even explain the defect.  Just "it breaks".  What breaks? How?  How does this fix it? Is there anything this fix breaks?


---

Comment by jdemeyer created at 2019-03-11 14:22:31

Replying to [comment:12 embray]:
> Just "it breaks".  What breaks?

With all due respect, I think that this explanation from the ticket description is more than just "it breaks":

> imagine a system where the `gcc` Sage package is installed. If `mpir` is upgraded, then `mpir` is rebuilt (as dependency of `gcc`) with `SAGE_BUILD_TOOLCHAIN` but there is nothing forcing a second build of `mpir`.

If you have more concrete questions, I'm happy to answer them.


---

Comment by embray created at 2019-03-11 14:41:17

I had to re-read it several times (I don't know if that's a problem with the wording, or if it's just subtle), but I think I understand now.  And because mpir is not rebuilt, in this case, with `SAGE_BUILD_TOOLCHAIN=no` it is missing some functionality I guess (specifically it is built without the C++ library).

I think there probably could be a better way to indicate if mpir is being built as a dependency of a (not yet built) gcc.  But I agree that there's not a whole lot of advantage to doing so, especially if the feature breaks normal builds in service to a (what I would consider) the rather marginal use case of installing Sage's own gcc.


---

Comment by embray created at 2019-03-11 14:41:17

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-03-11 14:43:53

I guess it would be a problem on a system without a C++ compiler to begin with (per #12782).  I suppose we're saying we don't care about that though--install a minimal C++ compiler as a prerequisite.


---

Comment by embray created at 2019-03-11 14:46:41

Changing status from positive_review to needs_info.


---

Comment by embray created at 2019-03-11 14:46:41

Actually one quick question before I set back to positive-review: Unless this issue actually broke some buildbots or something, do we really want to increase the package versions?  For successfully built systems this changes nothing about their GMP/MPIR builds, so I would rather not force the overhead of rebuilding those packages and their many dependencies if we don't really need to.


---

Comment by jdemeyer created at 2019-03-11 14:48:49

Replying to [comment:17 embray]:
> For successfully built systems

Well, this change was meant for non-successfully built systems.


---

Comment by embray created at 2019-03-11 14:54:35

I think, up to a point, we don't have to care about a few broken builds due to issues introduced several versions ago, unless we have some specific known need to (e.g. fixing some incremental builds on buildbots).  Otherwise you're just forcing a lot of needless electricity usage.


---

Comment by jdemeyer created at 2019-03-11 14:56:31

OK, I see your point.


---

Comment by dimpase created at 2019-03-11 18:11:31

So, do we agree do not bump up the versions here? I'd like to merge this branch into #27212...


---

Comment by embray created at 2019-03-12 12:51:44

I leave it up to Jeroen--I think it's a sensible policy to always _default_ to bumping package versions when updating their spkg-install, but I also believe there are cases (and this is one of them) where it might be smarter not to unless there's a strong reason for doing so.


---

Comment by git created at 2019-03-12 13:56:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-03-12 13:57:58

Changing status from needs_info to positive_review.


---

Comment by jdemeyer created at 2019-03-12 13:57:58

Removed the package version bumping.


---

Comment by vbraun created at 2019-03-14 18:14:05

Resolution: fixed
