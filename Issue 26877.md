# Issue 26877: Further libffi fixes

Issue created by migration from https://trac.sagemath.org/ticket/27114

Original creator: jdemeyer

Original creation time: 2019-01-25 09:40:55

CC:  embray strogdon




---

Comment by jdemeyer created at 2019-01-25 09:41:21

New commits:


---

Comment by jdemeyer created at 2019-01-25 09:42:56

Changing status from new to needs_review.


---

Comment by embray created at 2019-01-25 10:56:28

Since Steven already said this worked, I'm inclined to go ahead and set this to positive review.  Though I might like to try on OSX since it doesn't have pkg-config and I'm not 100% sure what it will do in this case (I think it will "fail correctly" but I'm not certain).


---

Comment by strogdon created at 2019-01-25 15:17:27

Replying to [comment:4 embray]:
> Since Steven already said this worked, I'm inclined to go ahead and set this to positive review.  Though I might like to try on OSX since it doesn't have pkg-config and I'm not 100% sure what it will do in this case (I think it will "fail correctly" but I'm not certain).
I'm fine with this. I too think it should be checked on other distros.


---

Comment by strogdon created at 2019-01-27 21:19:02

Perhaps we should try to get this in as soon as possible, else there will be Linuxes with system `libffi` installed where the Sage version will be built and used. A system `libffi` will then not be used until an upgrade or a manual removal of the Sage installed version.


---

Comment by tscrim created at 2019-01-28 05:18:21

See https://groups.google.com/forum/?pli=1#!topic/sage-devel/PvcY2LHU1fo


---

Comment by strogdon created at 2019-01-28 20:36:41

Is there any reason why the patchbot emmits:

```
configure:8323: error: possibly undefined macro: AC_SEARCH_LIBS
configure:8324: error: possibly undefined macro: AC_CHECK_HEADERS
```

Shouldn't it have `autotools` installed?


---

Comment by embray created at 2019-01-29 17:33:35

On OSX this "works" okay, or doesn't work as the case may be, in that it (correctly) fails to find `pkg-config`, and thus does not try to _use_ `pkg-config`.

I am seeing some other troubling problems failing to detect a system libffi on OSX, but I think whatever that problem is predates this ticket.


---

Comment by embray created at 2019-01-29 17:34:19

I have no idea about the patchbot.  It is probably missing some dependency for running autoconf.  Maybe this ticket needs a `configure.tar.gz` package, though it really should't...


---

Comment by embray created at 2019-01-29 17:35:32

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-29 17:35:50

Let's just ask Volker and see.


---

Comment by git created at 2019-01-29 17:57:04

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2019-01-29 17:57:04

Changing status from positive_review to needs_review.


---

Comment by embray created at 2019-01-29 17:57:30

With apologies for being a bit sloppy about it, here are a couple more fixes I found while testing this on OSX.


---

Comment by embray created at 2019-01-29 17:57:56

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-01-31 13:00:13

just to confirm that libffi's spkg-configure.m4 on this branch works with the pretty non-standard settings on Gentoo, cf. #27175.


---

Comment by dimpase created at 2019-01-31 19:44:25

However, supporting this properly on Homebrew really needs a call to pkg-config.
(as there ffi.h really goes to a weird location).


---

Comment by vbraun created at 2019-02-03 23:26:28

Fails ./bootstrap on kucalc (autoconf-2.13), maybe the script could be made more backward compatible?

```
make[1]: warning: -jN forced in submake: disabling jobserver mode.
configure.ac:308: installing 'config/compile'
configure.ac:105: installing 'config/config.guess'
configure.ac:105: installing 'config/config.sub'
configure.ac:68: installing 'config/install-sh'
configure.ac:68: installing 'config/missing'
configure.ac:13: error: possibly undefined macro: dnl
      If this token and others are legitimate, please use m4_pattern_allow.
      See the Autoconf documentation.
configure:9028: error: possibly undefined macro: AC_CHECK_HEADERS
configure:9029: error: possibly undefined macro: AC_SEARCH_LIBS
Makefile:197: recipe for target 'configure' failed
make[1]: Leaving directory '/var/lib/buildbot/slave/sage_git/build'
make[1]: *** [configure] Error 1
Makefile:31: recipe for target 'base-toolchain' failed
make: *** [base-toolchain] Error 2
make: Target 'start' not remade because of errors.
```



---

Comment by vbraun created at 2019-02-03 23:26:28

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2019-02-04 01:08:09

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2019-02-04 01:08:09

`configure.ac:13: error: possibly undefined macro: dnl` indicates that this is waaaay to old for anything useful, really. It is from 1999 ([sic!](https://ftp.gnu.org/gnu/autoconf/))

I think we should move on here, and whoever runs that bot should update...


---

Comment by vbraun created at 2019-02-04 10:14:30

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-02-04 10:14:30

This is Ubuntu 16.04.5 LTS. Sorry I had the wrong autoconf version (multiple are installed)

```
vbraun@kucalc:~$ autoconf --version
autoconf (GNU Autoconf) 2.69
```



---

Comment by dimpase created at 2019-02-04 11:00:42

Replying to [comment:20 vbraun]:
> This is Ubuntu 16.04.5 LTS. Sorry I had the wrong autoconf version (multiple are installed)
> {{{
> vbraun`@`kucalc:~$ autoconf --version
> autoconf (GNU Autoconf) 2.69
> }}}

But the error messages are from a very old autoconf...
What is the problem then, what "needs_work"?

Are you saying you want a check that autoconf is new enough, and better error messages?


---

Comment by embray created at 2019-02-04 11:02:16

Volker, please clarify: Should this just have a new `configure` tarball?  There's no reason for this to fail unless that machine is missing some dependencies to build the configure script, or some of the other tooling is misconfigured.  I cannot reproduce the same issue.


---

Comment by embray created at 2019-02-04 15:22:26

Okay, I was able to reproduce in a container.  Probably something is missing but I'm not sure what...


---

Comment by embray created at 2019-02-04 15:29:49

Changing status from needs_work to needs_info.


---

Comment by embray created at 2019-02-04 15:29:49

I see.  These errors indicate that `pkg-config` is not installed, since it is required to have the `PKG_CHECK_MODULES` macro.

I could put in a fallback so that it works when `PKG_CHECK_MODULES` is not defined, but that would still build to a partially-crippled `configure` script.  So can we just require `pkg-config` to be installed to build the `configure` script?

Alternatively, it might work if I include a copy of `pkg.m4` in our `m4/` directory, but I would rather not have to.


---

Comment by embray created at 2019-02-04 15:33:33

Replying to [comment:24 embray]:
> Alternatively, it might work if I include a copy of `pkg.m4` in our `m4/` directory, but I would rather not have to.

Update: this does work, but it's not ideal.  I would rather just have pkg-config installed.


---

Comment by dimpase created at 2019-02-04 15:38:13

If this dependence is really prebuilt- only, then why not, I see no problem in requiring it along with autotools


---

Comment by vbraun created at 2019-02-04 18:57:22

I don't mind requiring pkgconfig to actually run autoconf, but having bootstrap error out and not download the confball is not an option ;-)


---

Comment by dimpase created at 2019-02-04 20:16:46

Please see #27219 to deal with the bootstrap issue.


---

Comment by dimpase created at 2019-02-07 14:53:38

Erik, are you fine with this?


---

Comment by dimpase created at 2019-02-07 14:53:38

Changing status from needs_info to needs_review.


---

Comment by embray created at 2019-02-07 18:15:01

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-02-07 18:15:01

Yep, per my comment on the other ticket.  Thanks!


---

Comment by vbraun created at 2019-02-10 12:55:44

Resolution: fixed


---

Comment by dimpase created at 2019-02-12 09:18:35

Changing keywords from "" to "spkg-configure".
