# Issue 21757: Change behavior of the % operator for p-adic integral elements

Issue created by migration from Trac.

Original creator: roed

Original creation time: 2016-11-29 23:01:47

CC:  caruso saraedum

In `padic_generic_element.pyx`, the documentation for `_mod_` describes two options for implementing `a%b` and `a//b`.


(2) If `b = pi^k`, the series expansion (in terms of `pi`) of `a//b` is just the series expansion of `a`, shifted over by `k` terms.

(2') The series expansion of `a % pi^k` has no terms above `pi^(k-1)`.

The conditions (2) and (2') are equivalent.  But when we generalize these conditions to arbitrary `b` they diverge.

(3) For general `b`, the series expansion of `a//b` is just the series expansion of `a/b`, truncating terms with negative exponents of `pi`.

(4) For general `b`, the series expansion of `a%b` has no terms above `b.valuation() - 1`.

In order to satisfy (3), one defines


```
a // b = (a / b.unit_part()) >> b.valuation()
a % b = a - (a // b) * b
```


In order to satisfy (4), one defines


```
a % b = a.lift() % pi.lift()^b.valuation()
a // b = ((a - a % b) >> b.valuation()) / b.unit_part()
```


Currently, Sage implements option (3).  The justification given is that "it is more easily defined in terms of shifting and thus generalizes more easily to extension rings."

On the other hand, (4) behaves better in terms of precision: the remainder in the definition (4) is always known with the maximal precision (and actually to infinite precision) while in (3) we are loosing precision for the quotient and the remainder at the same
time.

On a related note, when using definition (4), if `u` has valuation 0 then


```
a % (bu) = a % b
a // (bu) = (a // b) * u^(-1)
```

There is no corresponding simple relations if we are using definition (3).


In this ticket, we implement behavior (4) as an option and provide deprecation messages for behavior (3).  


---

Comment by caruso created at 2018-05-23 16:13:50

Is there some code available somewhere?


---

Comment by roed created at 2018-05-24 19:59:52

I don't think I have any code for this.


---

Comment by roed created at 2018-07-22 20:40:11

Changing keywords from "" to "padicIMA".


---

Comment by git created at 2018-07-26 05:35:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2018-07-26 05:47:17

Changing status from new to needs_review.


---

Comment by roed created at 2018-07-26 05:47:17

All tests pass, but should still wait for remainder of patchbot report.


---

Comment by git created at 2018-07-26 18:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-07-26 19:46:59

Looks good to me (after my update).
Positive review if the patchbot is happy (but it probably won't...)
----
New commits:


---

Comment by caruso created at 2018-07-26 20:56:15

Changing status from needs_review to positive_review.


---

Comment by git created at 2018-07-27 16:48:16

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2018-07-27 16:48:16

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-07-27 16:54:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-27 17:15:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-07-27 19:12:56

I think that the variables `powhelper_oneunit`, etc. aren't used in this ticket. (Probably they are in #23218.)


---

Comment by caruso created at 2018-07-27 19:55:45

Changing status from needs_review to positive_review.


---

Comment by caruso created at 2018-07-27 19:55:45

Patchbot is happy. I give a positive review to this ticket.


---

Comment by vbraun created at 2018-08-05 08:43:26

Resolution: fixed
