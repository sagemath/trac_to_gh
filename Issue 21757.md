# Issue 21757: Change behavior of the % operator for p-adic integral elements

archive/issues_021757.json:
```json
{
    "body": "CC:  @xcaruso @saraedum\n\nIn `padic_generic_element.pyx`, the documentation for `_mod_` describes two options for implementing `a%b` and `a//b`.\n\n\n(2) If `b = pi^k`, the series expansion (in terms of `pi`) of `a//b` is just the series expansion of `a`, shifted over by `k` terms.\n\n(2') The series expansion of `a % pi^k` has no terms above `pi^(k-1)`.\n\nThe conditions (2) and (2') are equivalent.  But when we generalize these conditions to arbitrary `b` they diverge.\n\n(3) For general `b`, the series expansion of `a//b` is just the series expansion of `a/b`, truncating terms with negative exponents of `pi`.\n\n(4) For general `b`, the series expansion of `a%b` has no terms above `b.valuation() - 1`.\n\nIn order to satisfy (3), one defines\n\n\n```\na // b = (a / b.unit_part()) >> b.valuation()\na % b = a - (a // b) * b\n```\n\n\nIn order to satisfy (4), one defines\n\n\n```\na % b = a.lift() % pi.lift()^b.valuation()\na // b = ((a - a % b) >> b.valuation()) / b.unit_part()\n```\n\n\nCurrently, Sage implements option (3).  The justification given is that \"it is more easily defined in terms of shifting and thus generalizes more easily to extension rings.\"\n\nOn the other hand, (4) behaves better in terms of precision: the remainder in the definition (4) is always known with the maximal precision (and actually to infinite precision) while in (3) we are loosing precision for the quotient and the remainder at the same\ntime.\n\nOn a related note, when using definition (4), if `u` has valuation 0 then\n\n\n```\na % (bu) = a % b\na // (bu) = (a // b) * u^(-1)\n```\n\nThere is no corresponding simple relations if we are using definition (3).\n\n\nIn this ticket, we implement behavior (4) as an option and provide deprecation messages for behavior (3).  \n\nIssue created by migration from https://trac.sagemath.org/ticket/21994\n\n",
    "created_at": "2016-11-29T23:01:47Z",
    "labels": [
        "padics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Change behavior of the % operator for p-adic integral elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21757",
    "user": "@roed314"
}
```
CC:  @xcaruso @saraedum

In `padic_generic_element.pyx`, the documentation for `_mod_` describes two options for implementing `a%b` and `a//b`.


(2) If `b = pi^k`, the series expansion (in terms of `pi`) of `a//b` is just the series expansion of `a`, shifted over by `k` terms.

(2') The series expansion of `a % pi^k` has no terms above `pi^(k-1)`.

The conditions (2) and (2') are equivalent.  But when we generalize these conditions to arbitrary `b` they diverge.

(3) For general `b`, the series expansion of `a//b` is just the series expansion of `a/b`, truncating terms with negative exponents of `pi`.

(4) For general `b`, the series expansion of `a%b` has no terms above `b.valuation() - 1`.

In order to satisfy (3), one defines


```
a // b = (a / b.unit_part()) >> b.valuation()
a % b = a - (a // b) * b
```


In order to satisfy (4), one defines


```
a % b = a.lift() % pi.lift()^b.valuation()
a // b = ((a - a % b) >> b.valuation()) / b.unit_part()
```


Currently, Sage implements option (3).  The justification given is that "it is more easily defined in terms of shifting and thus generalizes more easily to extension rings."

On the other hand, (4) behaves better in terms of precision: the remainder in the definition (4) is always known with the maximal precision (and actually to infinite precision) while in (3) we are loosing precision for the quotient and the remainder at the same
time.

On a related note, when using definition (4), if `u` has valuation 0 then


```
a % (bu) = a % b
a // (bu) = (a // b) * u^(-1)
```

There is no corresponding simple relations if we are using definition (3).


In this ticket, we implement behavior (4) as an option and provide deprecation messages for behavior (3).  

Issue created by migration from https://trac.sagemath.org/ticket/21994





---

archive/issue_comments_301873.json:
```json
{
    "body": "Is there some code available somewhere?",
    "created_at": "2018-05-23T16:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301873",
    "user": "@xcaruso"
}
```

Is there some code available somewhere?



---

archive/issue_comments_301874.json:
```json
{
    "body": "I don't think I have any code for this.",
    "created_at": "2018-05-24T19:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301874",
    "user": "@roed314"
}
```

I don't think I have any code for this.



---

archive/issue_comments_301875.json:
```json
{
    "body": "Changing keywords from \"\" to \"padicIMA\".",
    "created_at": "2018-07-22T20:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301875",
    "user": "@roed314"
}
```

Changing keywords from "" to "padicIMA".



---

archive/issue_comments_301876.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-26T05:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301876",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301877.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-26T05:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301877",
    "user": "@roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_301878.json:
```json
{
    "body": "All tests pass, but should still wait for remainder of patchbot report.",
    "created_at": "2018-07-26T05:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301878",
    "user": "@roed314"
}
```

All tests pass, but should still wait for remainder of patchbot report.



---

archive/issue_comments_301879.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-26T18:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301879",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301880.json:
```json
{
    "body": "Looks good to me (after my update).\nPositive review if the patchbot is happy (but it probably won't...)\n----\nNew commits:",
    "created_at": "2018-07-26T19:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301880",
    "user": "@xcaruso"
}
```

Looks good to me (after my update).
Positive review if the patchbot is happy (but it probably won't...)
----
New commits:



---

archive/issue_comments_301881.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-26T20:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301881",
    "user": "@xcaruso"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301882.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-07-27T16:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301882",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_301883.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-07-27T16:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301883",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_301884.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-27T16:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301884",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301885.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-27T17:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301885",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301886.json:
```json
{
    "body": "I think that the variables `powhelper_oneunit`, etc. aren't used in this ticket. (Probably they are in #23218.)",
    "created_at": "2018-07-27T19:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301886",
    "user": "@xcaruso"
}
```

I think that the variables `powhelper_oneunit`, etc. aren't used in this ticket. (Probably they are in #23218.)



---

archive/issue_comments_301887.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-27T19:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301887",
    "user": "@xcaruso"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301888.json:
```json
{
    "body": "Patchbot is happy. I give a positive review to this ticket.",
    "created_at": "2018-07-27T19:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301888",
    "user": "@xcaruso"
}
```

Patchbot is happy. I give a positive review to this ticket.



---

archive/issue_comments_301889.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-05T08:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21757",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21757#issuecomment-301889",
    "user": "@vbraun"
}
```

Resolution: fixed
