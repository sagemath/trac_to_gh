# Issue 2523: bug in modular symbols for GammaH subgroup

archive/issues_002523.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage: ModularSymbols(GammaH(33,[1,2]),2).cuspidal_subspace()\nTraceback (most recent call last):\n...\nKeyError: 11\n```\n\nAssignee: **@craigcitro**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/2523_\n\n",
    "closed_at": "2008-04-26T21:19:06Z",
    "created_at": "2008-03-15T00:01:36Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20modular%20forms",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.0.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "bug in modular symbols for GammaH subgroup",
    "type": "issue",
    "updated_at": "2008-04-26T21:19:06Z",
    "url": "https://github.com/sagemath/sage/issues/2523",
    "user": "https://github.com/williamstein"
}
```

```
sage: ModularSymbols(GammaH(33,[1,2]),2).cuspidal_subspace()
Traceback (most recent call last):
...
KeyError: 11
```

Assignee: **@craigcitro**

_Issue created by migration from https://trac.sagemath.org/ticket/2523_





---

archive/issue_events_022859.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-03-15T00:01:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "milestone_number": null,
    "milestone_title": "sage-3.0.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22859"
}
```



---

archive/issue_events_022860.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-03-15T00:01:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "component: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22860"
}
```



---

archive/issue_events_022861.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-03-15T00:01:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22861"
}
```



---

archive/issue_events_022862.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-03-15T00:01:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22862"
}
```



---

archive/issue_events_022863.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2008-04-23T02:35:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "component: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22863"
}
```



---

archive/issue_events_022864.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2008-04-23T02:35:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20modular%20forms",
    "label_color": "0000ff",
    "label_name": "component: modular forms",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22864"
}
```



---

archive/issue_comments_013625.json:
```json
{
    "body": "Changed assignee from **@williamstein** to **@craigcitro**",
    "created_at": "2008-04-23T02:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13625",
    "user": "https://github.com/aghitza"
}
```

Changed assignee from **@williamstein** to **@craigcitro**



---

archive/issue_comments_013626.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI've done a bit of digging and gotten a bit closer to the source of the problem (which I think is actually in congroup.py):\n\n```\nsage: G = GammaH(6, [5])\nsage: M = ModularSymbols(G, 2)\nsage: B = M.boundary_space()\nsage: bas = M.basis(); bas\n((1,0), (3,2), (4,1))\nsage: B(bas[0])\n[Infinity] - [0]\nsage: B(bas[2])\n[0] - [-1/2]\nsage: B(bas[1])\nTraceback (most recent call last):\n...\nKeyError: 3\n```",
    "created_at": "2008-04-23T02:54:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13626",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:2'>Comment 2:</a>
I've done a bit of digging and gotten a bit closer to the source of the problem (which I think is actually in congroup.py):

```
sage: G = GammaH(6, [5])
sage: M = ModularSymbols(G, 2)
sage: B = M.boundary_space()
sage: bas = M.basis(); bas
((1,0), (3,2), (4,1))
sage: B(bas[0])
[Infinity] - [0]
sage: B(bas[2])
[0] - [-1/2]
sage: B(bas[1])
Traceback (most recent call last):
...
KeyError: 3
```



---

archive/issue_events_022865.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-04-26T11:25:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22865"
}
```



---

archive/issue_comments_013627.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nI'm attaching a fix. The fix also cleans up a few related functions. The problem was in the `_coset_reduction_data` functions -- specifically, one of the functions only generated data up to the square root of the level. However, in use, one needs more data -- at the very least, one needs to generate all data up to where the gcd of the term with N is at most square root of N. In that case, it seems easier to just generate all the data.\n\nAdded some doctests, though I'm not completely satisfied with my doctests: in particular, I couldn't come up with a doctest for `_reduce_cusp` that would have `t == -1`. I'd be happy if someone came up with one and added it. \n\nI just noticed that this patch is actually in the tree where I'd already applied AlexGhitza's patch from #2995. Given that it's already been merged anyway, I'm just not going to worry about it.",
    "created_at": "2008-04-26T11:25:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13627",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:3'>Comment 3:</a>
I'm attaching a fix. The fix also cleans up a few related functions. The problem was in the `_coset_reduction_data` functions -- specifically, one of the functions only generated data up to the square root of the level. However, in use, one needs more data -- at the very least, one needs to generate all data up to where the gcd of the term with N is at most square root of N. In that case, it seems easier to just generate all the data.

Added some doctests, though I'm not completely satisfied with my doctests: in particular, I couldn't come up with a doctest for `_reduce_cusp` that would have `t == -1`. I'd be happy if someone came up with one and added it. 

I just noticed that this patch is actually in the tree where I'd already applied AlexGhitza's patch from #2995. Given that it's already been merged anyway, I'm just not going to worry about it.



---

archive/issue_events_022866.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-04-26T11:25:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22866"
}
```



---

archive/issue_comments_013628.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nAttachment: **[trac-2523.patch.gz](https://github.com/sagemath/sage/files/ticket2523/trac-2523.patch.gz)**\n\nThere are some typos, namely `specfically` in at least two places.\n\nI'm worried about the lack of `t==-1` doctest as well, but this looks good to me anyway.",
    "created_at": "2008-04-26T17:20:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13628",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:4'>Comment 4:</a>
Attachment: **[trac-2523.patch.gz](https://github.com/sagemath/sage/files/ticket2523/trac-2523.patch.gz)**

There are some typos, namely `specfically` in at least two places.

I'm worried about the lack of `t==-1` doctest as well, but this looks good to me anyway.



---

archive/issue_events_022867.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2008-04-26T17:20:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22867"
}
```



---

archive/issue_comments_013629.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nTwo comments:\n\n1. this patch is great; not only does it fix the current issue, but also fixes #2938.  Awesome!\n\n2. regarding t = -1: looking at the code, I notice that t = -1 is returned only if, towards the end, u > N_over_2; but before that u goes through a bunch of reductions modulo d, so u is at most d.  On the other hand, d=gcd(v,N), so the only way this can be bigger than half of N is if it's equal to N, i.e. if v = N.  Having run a lot of random examples, I don't think t is ever -1, but it would be nice to have a theoretical proof of this (maybe William or John know this, or maybe they know how to construct an example with t=-1).\n\nHaving said this, I think we should be grateful for point (1) and merge, and figure out point (2) later.",
    "created_at": "2008-04-26T17:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13629",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:5'>Comment 5:</a>
Two comments:

1. this patch is great; not only does it fix the current issue, but also fixes #2938.  Awesome!

2. regarding t = -1: looking at the code, I notice that t = -1 is returned only if, towards the end, u > N_over_2; but before that u goes through a bunch of reductions modulo d, so u is at most d.  On the other hand, d=gcd(v,N), so the only way this can be bigger than half of N is if it's equal to N, i.e. if v = N.  Having run a lot of random examples, I don't think t is ever -1, but it would be nice to have a theoretical proof of this (maybe William or John know this, or maybe they know how to construct an example with t=-1).

Having said this, I think we should be grateful for point (1) and merge, and figure out point (2) later.



---

archive/issue_comments_013630.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nAttachment: **[trac-2523-pt2.patch.gz](https://github.com/sagemath/sage/files/ticket2523/trac-2523-pt2.patch.gz)**\n\nAdded a small patch fixing the typos ncalexan pointed out. Also, I'm closing #2938 as fixed.",
    "created_at": "2008-04-26T18:26:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13630",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:6'>Comment 6:</a>
Attachment: **[trac-2523-pt2.patch.gz](https://github.com/sagemath/sage/files/ticket2523/trac-2523-pt2.patch.gz)**

Added a small patch fixing the typos ncalexan pointed out. Also, I'm closing #2938 as fixed.



---

archive/issue_events_022868.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-04-26T21:19:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22868"
}
```



---

archive/issue_events_022869.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-04-26T21:19:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2523#event-22869"
}
```



---

archive/issue_comments_013631.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nMerged in Sage 3.0.1.alpha1",
    "created_at": "2008-04-26T21:19:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2523#issuecomment-13631",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:7'>Comment 7:</a>
Merged in Sage 3.0.1.alpha1
