# Issue 2256: matrix inverse over CC raises ZeroDivisionError

archive/issues_002256.json:
```json
{
    "body": "\n```\nsage: M = matrix(CC, 2, 2, [(-1.00000000000000 - 2.00000000000000*I, 5.00000000000000 - 6.00000000000000*I), (-2.00000000000000 - 2.00000000000000*I, 7.00000000000000 - 8.00000000000000*I)])\nsage: M\n\n[-1.00000000000000 - 2.00000000000000*I  5.00000000000000 - 6.00000000000000*I]\n[-2.00000000000000 - 2.00000000000000*I  7.00000000000000 - 8.00000000000000*I]\nsage: M.determinant()\n-1.00000000000000 - 8.00000000000000*I\nsage: M.inverse()\n---------------------------------------------------------------------------\n<type 'exceptions.ZeroDivisionError'>     Traceback (most recent call last)\n\n/Users/ncalexan/sage-2.10.2.alpha0/devel/sage-genus2cm/sage/schemes/plane_curves/<ipython console> in <module>()\n\n/Users/ncalexan/sage-2.10.2.alpha0/devel/sage-genus2cm/sage/schemes/plane_curves/matrix2.pyx in sage.matrix.matrix2.Matrix.inverse()\n\n/Users/ncalexan/sage-2.10.2.alpha0/devel/sage-genus2cm/sage/schemes/plane_curves/matrix0.pyx in sage.matrix.matrix0.Matrix.__invert__()\n\n<type 'exceptions.ZeroDivisionError'>: self is not invertible\nsage: M.parent().change_ring(CDF)(M).inverse()\n\n[ 0.876923076923 + 0.984615384615*I -0.661538461538 - 0.707692307692*I]\n[-0.276923076923 + 0.215384615385*I 0.261538461538 - 0.0923076923077*I]\n```\n\n**Assignee:** @williamstein\n\n**CC:**  @ncalexan @jasongrout cwitty @robertwb\n\n**Keywords:** matrix inverse CC complex\n\n**Author:** Craig Citro\n\n**Reviewer:** Jason Grout, Nick Alexander\n\n**Merged:** 4.0.2.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/2256\n\n",
    "closed_at": "2009-06-14T22:49:07Z",
    "created_at": "2008-02-22T08:00:07Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.0.2",
    "title": "matrix inverse over CC raises ZeroDivisionError",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/2256",
    "user": "https://github.com/ncalexan"
}
```

```
sage: M = matrix(CC, 2, 2, [(-1.00000000000000 - 2.00000000000000*I, 5.00000000000000 - 6.00000000000000*I), (-2.00000000000000 - 2.00000000000000*I, 7.00000000000000 - 8.00000000000000*I)])
sage: M

[-1.00000000000000 - 2.00000000000000*I  5.00000000000000 - 6.00000000000000*I]
[-2.00000000000000 - 2.00000000000000*I  7.00000000000000 - 8.00000000000000*I]
sage: M.determinant()
-1.00000000000000 - 8.00000000000000*I
sage: M.inverse()
---------------------------------------------------------------------------
<type 'exceptions.ZeroDivisionError'>     Traceback (most recent call last)

/Users/ncalexan/sage-2.10.2.alpha0/devel/sage-genus2cm/sage/schemes/plane_curves/<ipython console> in <module>()

/Users/ncalexan/sage-2.10.2.alpha0/devel/sage-genus2cm/sage/schemes/plane_curves/matrix2.pyx in sage.matrix.matrix2.Matrix.inverse()

/Users/ncalexan/sage-2.10.2.alpha0/devel/sage-genus2cm/sage/schemes/plane_curves/matrix0.pyx in sage.matrix.matrix0.Matrix.__invert__()

<type 'exceptions.ZeroDivisionError'>: self is not invertible
sage: M.parent().change_ring(CDF)(M).inverse()

[ 0.876923076923 + 0.984615384615*I -0.661538461538 - 0.707692307692*I]
[-0.276923076923 + 0.215384615385*I 0.261538461538 - 0.0923076923077*I]
```

**Assignee:** @williamstein

**CC:**  @ncalexan @jasongrout cwitty @robertwb

**Keywords:** matrix inverse CC complex

**Author:** Craig Citro

**Reviewer:** Jason Grout, Nick Alexander

**Merged:** 4.0.2.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/2256





---

archive/issue_comments_014018.json:
```json
{
    "body": "<a id='comment:1'></a>\nI made a similar ticket with the same issue with RQDF.  I think the following is the underlying problem:\n\n```\nsage: me = M.echelon_form()\nsage: me\n\n[                         1.00000000000000                     -2.22044604925031e-16]\n[                                        0 1.00000000000000 - 5.55111512312578e-17*I]\nsage: me[0,0] == 1\nTrue\nsage: me[1,1] == 1\nFalse\n```",
    "created_at": "2008-02-22T21:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14018",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:1'></a>
I made a similar ticket with the same issue with RQDF.  I think the following is the underlying problem:

```
sage: me = M.echelon_form()
sage: me

[                         1.00000000000000                     -2.22044604925031e-16]
[                                        0 1.00000000000000 - 5.55111512312578e-17*I]
sage: me[0,0] == 1
True
sage: me[1,1] == 1
False
```



---

archive/issue_comments_014019.json:
```json
{
    "body": "<a id='comment:2'></a>\nmhansen's comment is right on.  Indeed, SAGE is successfully computing the inverse, but the __invert__ method is throwing an exception because of the diagonal elements of the echelon form are not all ones.   This is simply because:\n\n```\nsage: a = CC(-1, -2); b = CC(5, -6); c = CC(-2,-2); d = CC(7, -8)\nsage: z = d - b*c/a\nsage: z * z^-1\n1.00000000000000 - 5.55111512312578e-17*I\n```\n\nAh, the joys of inexact fields.   See also the ticket #3162.",
    "created_at": "2008-05-12T02:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14019",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:2'></a>
mhansen's comment is right on.  Indeed, SAGE is successfully computing the inverse, but the __invert__ method is throwing an exception because of the diagonal elements of the echelon form are not all ones.   This is simply because:

```
sage: a = CC(-1, -2); b = CC(5, -6); c = CC(-2,-2); d = CC(7, -8)
sage: z = d - b*c/a
sage: z * z^-1
1.00000000000000 - 5.55111512312578e-17*I
```

Ah, the joys of inexact fields.   See also the ticket #3162.



---

archive/issue_comments_014020.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2009-06-09T09:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14020",
    "user": "https://github.com/craigcitro"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_014021.json:
```json
{
    "body": "<a id='comment:3'></a>\nI'm attaching a patch which doesn't **completely** fix this, but makes it better -- I think. \n\nFirst, a brief description of the problem: the code creates an augmented matrix, puts it in echelon form, and asks if the lower right entry of the left half is equal to 1. This is correct over an exact field, but over an inexact ring like `CC`, this causes trouble. \n\nNow, if we're working over a base ring which we know is a field (or at least models a field), then we know the lower right entry of the matrix must be either 1 or 0. So rather than test to see if something equals 1, I simply test that the lower right entry is **not** 0. \n\nA better solution would be to ask that the determinant is nonzero -- unfortunately, our determinant over general inexact fields is a joke, and can't even deal with a `10x10` example, so that's a no-go. \n\nComments:\n\nThis still isn't perfect -- it's easy enough to imagine cases where numerical instability causes trouble. Note that the current behavior is basically always wrong (since it almost always claims the matrix isn't invertible when it is), and it's also pretty confusing to newcomers. The new code has the disadvantage that it can now offer to return an inverse for non-invertible matrices, based on numerical issues. However, I think that to someone who's used matrices over inexact rings before in their life, this isn't so surprising -- it's just the way it goes with approximations. \n\nI don't know what the \"right\" solution is -- we should probably ask someone who studies numerical analysis.\n\nI'm adding `jason`, `cwitty`, and `robertwb` to the ticket, because they're all likely to have interesting commentary and/or review the patch.",
    "created_at": "2009-06-09T09:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14021",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:3'></a>
I'm attaching a patch which doesn't **completely** fix this, but makes it better -- I think. 

First, a brief description of the problem: the code creates an augmented matrix, puts it in echelon form, and asks if the lower right entry of the left half is equal to 1. This is correct over an exact field, but over an inexact ring like `CC`, this causes trouble. 

Now, if we're working over a base ring which we know is a field (or at least models a field), then we know the lower right entry of the matrix must be either 1 or 0. So rather than test to see if something equals 1, I simply test that the lower right entry is **not** 0. 

A better solution would be to ask that the determinant is nonzero -- unfortunately, our determinant over general inexact fields is a joke, and can't even deal with a `10x10` example, so that's a no-go. 

Comments:

This still isn't perfect -- it's easy enough to imagine cases where numerical instability causes trouble. Note that the current behavior is basically always wrong (since it almost always claims the matrix isn't invertible when it is), and it's also pretty confusing to newcomers. The new code has the disadvantage that it can now offer to return an inverse for non-invertible matrices, based on numerical issues. However, I think that to someone who's used matrices over inexact rings before in their life, this isn't so surprising -- it's just the way it goes with approximations. 

I don't know what the "right" solution is -- we should probably ask someone who studies numerical analysis.

I'm adding `jason`, `cwitty`, and `robertwb` to the ticket, because they're all likely to have interesting commentary and/or review the patch.



---

archive/attachments_001959.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-2256.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket2256/trac-2256.patch",
    "created_at": "2009-06-09T11:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jasongrout"
}
```



---

archive/issue_comments_014022.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe LU decomposition patch at #3048 may go a long ways towards helping this.  At least the determinant then is much, much better.  Or even better, just examine the U of the LU decomposition and decide if a diagonal entry is zero (which avoids the overhead of a product).\n\nThe LU decomposition patch (#3048) also changes the inverse function to use sove_right (which uses LU decomposition) as in general, that should be faster anyway.\n\nThe real way to do this is to have a rank function which works by looking at the smallest singular value.  That requires having a singular value decomposition...",
    "created_at": "2009-06-09T11:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14022",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'></a>
The LU decomposition patch at #3048 may go a long ways towards helping this.  At least the determinant then is much, much better.  Or even better, just examine the U of the LU decomposition and decide if a diagonal entry is zero (which avoids the overhead of a product).

The LU decomposition patch (#3048) also changes the inverse function to use sove_right (which uses LU decomposition) as in general, that should be faster anyway.

The real way to do this is to have a rank function which works by looking at the smallest singular value.  That requires having a singular value decomposition...



---

archive/issue_comments_014023.json:
```json
{
    "body": "**Reviewer:** Jason Grout, Nick Alexander",
    "created_at": "2009-06-14T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14023",
    "user": "https://github.com/ncalexan"
}
```

**Reviewer:** Jason Grout, Nick Alexander



---

archive/issue_comments_014024.json:
```json
{
    "body": "**Merged:** 4.0.2.alpha0",
    "created_at": "2009-06-14T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14024",
    "user": "https://github.com/ncalexan"
}
```

**Merged:** 4.0.2.alpha0



---

archive/issue_events_006708.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-14T22:49:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2256#event-6708"
}
```



---

archive/issue_comments_014025.json:
```json
{
    "body": "**Author:** Craig Citro",
    "created_at": "2009-06-14T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14025",
    "user": "https://github.com/ncalexan"
}
```

**Author:** Craig Citro



---

archive/issue_comments_014026.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2009-06-14T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14026",
    "user": "https://github.com/ncalexan"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_014027.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe LU stuff is not ready and this at least improves the situation.",
    "created_at": "2009-06-14T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2256#issuecomment-14027",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:5'></a>
The LU stuff is not ready and this at least improves the situation.
