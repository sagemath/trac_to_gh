# Issue 2460: some issues with factorization.py

archive/issues_002460.json:
```json
{
    "body": "Various people worked on factorization.py and unfortunately ignored some implicit \nassumptions in what that code is supposed to do.  In particular, this function\n\n```\n    def base_ring(self):\n        if len(self) > 0:\n            return self[0][0].parent()\n        else:\n            return self.unit().parent()\n```\nassumes that (1) ever element has the same parent, and (2) the parent is a ring.\nNeither assumption need be satisfied.   \n\nThis is_commutative function then relies on base_ring working.  \nHere's an example of this leading to *wrong* answers:\n\n```\nsage: R.<x,y> = FreeAlgebra(QQ,2)\nsage: Factorization([(3,1), (x,2), (y,3), (x,1), (y,2)])\n3 * x^3 * y^5\n```\n\nProposal: Simply call Sequence on the list of bases in the factorization\nto get a new list where the basis lie in a common university.  Then refine\nis_commutative to mean that the universe is a commuative ring, and only then\ncommute factors automatically.\n\nSecond, after the above is resolved, the sort function for comparison \nshould call universe() (not base_ring) and use some sensible defaults,\nbefore resorting to that mess of code in the current sort method. \n\n\n\n**Assignee:** @williamstein\n\n**Keywords:** editor_wstein\n\nIssue created by migration from https://trac.sagemath.org/ticket/2460\n\n",
    "closed_at": "2008-11-14T08:52:38Z",
    "created_at": "2008-03-10T16:02:43Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.1.2",
    "title": "some issues with factorization.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/2460",
    "user": "https://github.com/williamstein"
}
```
Various people worked on factorization.py and unfortunately ignored some implicit 
assumptions in what that code is supposed to do.  In particular, this function

```
    def base_ring(self):
        if len(self) > 0:
            return self[0][0].parent()
        else:
            return self.unit().parent()
```
assumes that (1) ever element has the same parent, and (2) the parent is a ring.
Neither assumption need be satisfied.   

This is_commutative function then relies on base_ring working.  
Here's an example of this leading to *wrong* answers:

```
sage: R.<x,y> = FreeAlgebra(QQ,2)
sage: Factorization([(3,1), (x,2), (y,3), (x,1), (y,2)])
3 * x^3 * y^5
```

Proposal: Simply call Sequence on the list of bases in the factorization
to get a new list where the basis lie in a common university.  Then refine
is_commutative to mean that the universe is a commuative ring, and only then
commute factors automatically.

Second, after the above is resolved, the sort function for comparison 
should call universe() (not base_ring) and use some sensible defaults,
before resorting to that mess of code in the current sort method. 



**Assignee:** @williamstein

**Keywords:** editor_wstein

Issue created by migration from https://trac.sagemath.org/ticket/2460





---

archive/issue_comments_013397.json:
```json
{
    "body": "**Assignee:** @williamstein",
    "created_at": "2008-03-10T16:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13397",
    "user": "https://github.com/williamstein"
}
```

**Assignee:** @williamstein



---

archive/issue_comments_013398.json:
```json
{
    "body": "**Changing assignee** from @williamstein to @garyfurnish.",
    "created_at": "2008-03-10T16:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13398",
    "user": "https://github.com/garyfurnish"
}
```

**Changing assignee** from @williamstein to @garyfurnish.



---

archive/issue_events_012797.json:
```json
{
    "actor": "https://github.com/garyfurnish",
    "created_at": "2008-03-10T16:29:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12797"
}
```



---

archive/attachments_002217.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_2460.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket2460/trac_2460.patch",
    "created_at": "2008-03-10T16:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/garyfurnish"
}
```



---

archive/issue_comments_013399.json:
```json
{
    "body": "<a id='comment:4'></a>\n",
    "created_at": "2008-03-10T16:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13399",
    "user": "https://github.com/garyfurnish"
}
```

<a id='comment:4'></a>




---

archive/issue_comments_013400.json:
```json
{
    "body": "<a id='comment:5'></a>\nThere is a possibility that fixing commutativity may other things.",
    "created_at": "2008-03-10T16:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13400",
    "user": "https://github.com/garyfurnish"
}
```

<a id='comment:5'></a>
There is a possibility that fixing commutativity may other things.



---

archive/issue_comments_013401.json:
```json
{
    "body": "**Changing assignee** from @garyfurnish to @williamstein.",
    "created_at": "2008-03-10T17:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13401",
    "user": "https://github.com/garyfurnish"
}
```

**Changing assignee** from @garyfurnish to @williamstein.



---

archive/issue_events_012798.json:
```json
{
    "actor": "https://github.com/garyfurnish",
    "created_at": "2008-03-10T17:12:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12798"
}
```



---

archive/issue_comments_013402.json:
```json
{
    "body": "<a id='comment:6'></a>\nThere are non-trivial issues involved with fixing this (namely, moving things to the universe causes issues with repr and commutes, and I can't find a way to fix those issues without refactoring other code to make this work well, so this should probably see some discussion.",
    "created_at": "2008-03-10T17:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13402",
    "user": "https://github.com/garyfurnish"
}
```

<a id='comment:6'></a>
There are non-trivial issues involved with fixing this (namely, moving things to the universe causes issues with repr and commutes, and I can't find a way to fix those issues without refactoring other code to make this work well, so this should probably see some discussion.



---

archive/issue_events_012799.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-03-22T21:25:08Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "rename": {
        "from": "some issues with factorization.py",
        "to": "[do not review] some issues with factorization.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12799"
}
```



---

archive/issue_events_012800.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-06-20T04:46:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12800"
}
```



---

archive/issue_events_012801.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-06-20T04:46:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12801"
}
```



---

archive/issue_comments_013403.json:
```json
{
    "body": "<a id='comment:10'></a>\nHi Carig,\n\nnot to be prickly Pete, but can give a reason why this was invalidated?\n\nCheers,\n\nMichael",
    "created_at": "2008-06-23T05:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13403",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>
Hi Carig,

not to be prickly Pete, but can give a reason why this was invalidated?

Cheers,

Michael



---

archive/issue_events_012802.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-06-23T05:56:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "milestone": "sage-3.1.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12802"
}
```



---

archive/issue_events_012803.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-06-23T05:56:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12803"
}
```



---

archive/issue_events_012804.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-06-27T20:20:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12804"
}
```



---

archive/issue_comments_013404.json:
```json
{
    "body": "<a id='comment:11'></a>\nWoah -- I incorrectly thought this had long since been fixed.  NOT.\n\n```\nsage: R.<x,y> = FreeAlgebra(QQ,2)\nsage: sage: Factorization([(3,1), (x,2), (y,3), (x,1), (y,2)])\n3 * x^3 * y^5\n```",
    "created_at": "2008-06-27T20:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13404",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
Woah -- I incorrectly thought this had long since been fixed.  NOT.

```
sage: R.<x,y> = FreeAlgebra(QQ,2)
sage: sage: Factorization([(3,1), (x,2), (y,3), (x,1), (y,2)])
3 * x^3 * y^5
```



---

archive/issue_events_012805.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-06-27T20:20:32Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "rename": {
        "from": "[do not review] some issues with factorization.py",
        "to": "some issues with factorization.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12805"
}
```



---

archive/issue_events_012806.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-06-27T20:20:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12806"
}
```



---

archive/issue_comments_013405.json:
```json
{
    "body": "<a id='comment:13'></a>\nOk, moving this back to a current milestone so that it can be seen :)\n\nCheers,\n\nMichael",
    "created_at": "2008-07-03T07:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13405",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:13'></a>
Ok, moving this back to a current milestone so that it can be seen :)

Cheers,

Michael



---

archive/issue_events_012807.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-03T07:08:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "milestone": "sage-3.1.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12807"
}
```



---

archive/issue_events_012808.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-03T07:08:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12808"
}
```



---

archive/issue_comments_013406.json:
```json
{
    "body": "<a id='comment:14'></a>\nWilliam, \n\ncan you be the editor of this patch? Feel free to bounce it back to me.\n\nCheers,\n\nMichael",
    "created_at": "2008-07-06T11:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13406",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:14'></a>
William, 

can you be the editor of this patch? Feel free to bounce it back to me.

Cheers,

Michael



---

archive/issue_comments_013407.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"editor_wstein\".",
    "created_at": "2008-07-06T11:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13407",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing keywords** from "" to "editor_wstein".



---

archive/issue_comments_013408.json:
```json
{
    "body": "<a id='comment:15'></a>\nLooking at factorization.py I was all ready to fix all the problems I could see -- using Sequence to get a common universe for the bases on construction, cache this base_ring, only allow operations between factorizations with the same base_ring, and so on.\n\nBut then I saw what appeared to be a totally weird example:\n\n```\nsage: F = Factorization([(ZZ^3, 2), (ZZ^2, 5)], cr=True); F\n(Ambient free module of rank 2 over the principal ideal domain Integer Ring)^5 * \n(Ambient free module of rank 3 over the principal ideal domain Integer Ring)^2            \n```\nThis bears no relation at all to what I thought the Factorization class was for.  Doing a search_src showed that this is designed in to support splitting of modular symbols spaces (and similar).\n\nThis leaves a question almost certainly for William:  is it really sensible to have one class serve both as the structure to hold \"prime factorizations\" for UFDs and other rings, as well as to hold lists of subspaces with multiplicities?\n\nIf so, perhaps we need to refactor this to have a base class which just handles the basics, with (at least) 2 derived classes, one for rings factorizations and one for additive decompositions?\n\nJohn\n\n# I have added this posting to trac#2460 too.",
    "created_at": "2008-08-22T17:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13408",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>
Looking at factorization.py I was all ready to fix all the problems I could see -- using Sequence to get a common universe for the bases on construction, cache this base_ring, only allow operations between factorizations with the same base_ring, and so on.

But then I saw what appeared to be a totally weird example:

```
sage: F = Factorization([(ZZ^3, 2), (ZZ^2, 5)], cr=True); F
(Ambient free module of rank 2 over the principal ideal domain Integer Ring)^5 * 
(Ambient free module of rank 3 over the principal ideal domain Integer Ring)^2            
```
This bears no relation at all to what I thought the Factorization class was for.  Doing a search_src showed that this is designed in to support splitting of modular symbols spaces (and similar).

This leaves a question almost certainly for William:  is it really sensible to have one class serve both as the structure to hold "prime factorizations" for UFDs and other rings, as well as to hold lists of subspaces with multiplicities?

If so, perhaps we need to refactor this to have a base class which just handles the basics, with (at least) 2 derived classes, one for rings factorizations and one for additive decompositions?

John

# I have added this posting to trac#2460 too.



---

archive/issue_comments_013409.json:
```json
{
    "body": "<a id='comment:16'></a>\nI think the issues raised here have all been dealt with by the patches I put up at #3927 (which started out as a separate enhancement, hence the new ticket).  In particular the good parts of the patch attached to this ticket have been used there.\n\nI suggest that this ticket be closed, with a link to #3927 instead.",
    "created_at": "2008-08-23T16:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13409",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:16'></a>
I think the issues raised here have all been dealt with by the patches I put up at #3927 (which started out as a separate enhancement, hence the new ticket).  In particular the good parts of the patch attached to this ticket have been used there.

I suggest that this ticket be closed, with a link to #3927 instead.



---

archive/issue_events_012809.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2008-11-14T08:52:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "milestone": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12809"
}
```



---

archive/issue_events_012810.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2008-11-14T08:52:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "milestone": "sage-3.1.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12810"
}
```



---

archive/issue_events_012811.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2008-11-14T08:52:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12811"
}
```



---

archive/issue_events_012812.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2008-11-14T08:52:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2460#event-12812"
}
```



---

archive/issue_comments_013410.json:
```json
{
    "body": "<a id='comment:17'></a>\nI think that this can be closed as well due to #3927.",
    "created_at": "2008-11-14T08:52:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2460#issuecomment-13410",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:17'></a>
I think that this can be closed as well due to #3927.
