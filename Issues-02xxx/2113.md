# Issue 2113: [with patch and spkg] twisted.web2 should be gzip compressing things it sends out to the notebook

archive/issues_002113.json:
```json
{
    "body": "We ought to check to make sure that twisted has the gzip filter enabled and is sending things in zip encoding when it can.\n\n\n**Assignee:** @jasongrout\n\nIssue created by migration from https://trac.sagemath.org/ticket/2113\n\n",
    "closed_at": "2009-02-07T01:09:32Z",
    "created_at": "2008-02-08T14:32:43Z",
    "labels": [
        "component: notebook"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.3",
    "title": "[with patch and spkg] twisted.web2 should be gzip compressing things it sends out to the notebook",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/2113",
    "user": "https://github.com/jasongrout"
}
```
We ought to check to make sure that twisted has the gzip filter enabled and is sending things in zip encoding when it can.


**Assignee:** @jasongrout

Issue created by migration from https://trac.sagemath.org/ticket/2113





---

archive/issue_comments_013060.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis needs to be optional; for local notebooks (where the notebook and web browser are running on the same machine), this would very likely slow things down.",
    "created_at": "2008-02-08T19:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13060",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:1'></a>
This needs to be optional; for local notebooks (where the notebook and web browser are running on the same machine), this would very likely slow things down.



---

archive/attachments_001772.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "gzip.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket2113/gzip.patch",
    "created_at": "2008-10-19T05:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jasongrout"
}
```



---

archive/issue_comments_013061.json:
```json
{
    "body": "",
    "created_at": "2008-10-19T05:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13061",
    "user": "https://github.com/jasongrout"
}
```





---

archive/issue_comments_013062.json:
```json
{
    "body": "<a id='comment:2'></a>\nI posted a new twisted spkg that contains needed modifications to make this work here:  http://sage.math.washington.edu/home/jason/twisted-8.1.0.p2.spkg\n\nThe above patch, combined with this new spkg, makes it so that pretty much all javascript, java, css, and a few other things are sent over the network compressed when the receiving host is not 'localhost' or '127.0.0.1'.  It seems to cut the transfer down to about a third of what it was.",
    "created_at": "2008-10-19T05:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13062",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'></a>
I posted a new twisted spkg that contains needed modifications to make this work here:  http://sage.math.washington.edu/home/jason/twisted-8.1.0.p2.spkg

The above patch, combined with this new spkg, makes it so that pretty much all javascript, java, css, and a few other things are sent over the network compressed when the receiving host is not 'localhost' or '127.0.0.1'.  It seems to cut the transfer down to about a third of what it was.



---

archive/issue_events_006066.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "rename": {
        "from": "twisted.web2 should be gzip compressing things it sends out to the notebook",
        "to": "[with patch and spkg] twisted.web2 should be gzip compressing things it sends out to the notebook"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2113#event-6066"
}
```



---

archive/issue_comments_013063.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-10-19T05:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13063",
    "user": "https://github.com/jasongrout"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_013064.json:
```json
{
    "body": "<a id='comment:4'></a>\nI applied this patch on 3.1.4 after I applied the patch at #4267.",
    "created_at": "2008-10-19T05:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13064",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'></a>
I applied this patch on 3.1.4 after I applied the patch at #4267.



---

archive/issue_comments_013065.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe spkg and patch here apply fine on top of #4267 with 3.2.alpha2. How do you measure the actual bandwidth usage? The patch seems simple enough -- I'll presume that twisted really does gzip what it claims to -- but I want to see lower bandwidth usage. :)",
    "created_at": "2008-11-03T08:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13065",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:5'></a>
The spkg and patch here apply fine on top of #4267 with 3.2.alpha2. How do you measure the actual bandwidth usage? The patch seems simple enough -- I'll presume that twisted really does gzip what it claims to -- but I want to see lower bandwidth usage. :)



---

archive/issue_comments_013066.json:
```json
{
    "body": "<a id='comment:6'></a>\nddrake: use firebug in firefox.  It will show exactly how much each page and include is taking, bandwidth-wise and speed-wise.",
    "created_at": "2008-11-28T04:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13066",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:6'></a>
ddrake: use firebug in firefox.  It will show exactly how much each page and include is taking, bandwidth-wise and speed-wise.



---

archive/issue_comments_013067.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2008-11-28T04:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13067",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_013068.json:
```json
{
    "body": "<a id='comment:7'></a>\nREFEREE REPORT:\n\nI will give this a positive review when the following trivial things are all fixed. \n\n1. The spkg has a file in there that it shouldn't have in the root directory:\n\n```\nteragon-2:twisted-8.1.0.p2 wstein$ pwd\n/Users/wstein/Desktop/twisted-8.1.0.p2\nteragon-2:twisted-8.1.0.p2 wstein$ hg status\n? gzip.py.patch\nteragon-2:twisted-8.1.0.p2 wstein$ ls\nSPKG.txt\tgzip.py.patch\tpatches\t\tspkg-install\tsrc\n```\nJust delete it and remake the spkg.\n\nThe spkg itself compiles fine. \n\nThat said, I'm confused as to what/where gzip.py.patch comes from.  Evidently mhansen wrote it.  It should probably be upstreamed?\n\n2. There is a problem with SPKG.txt claiming mhansen did something, but actually Jason did:\n\n```\n20:26 < mhansen> How is this due to me?\n20:26 < mhansen> I haven't seen this ticket before.\n20:27 < jason--> the patch on the ticket just modifies twist.py\n20:28 < ws-4636_2113> === twisted-8.1.0.p2 (Mike Hansen, October 18, 2008) === * Apply the patches to make the gzip filter deal \n                      with javascript mime types.\n20:28 < ws-4636_2113> It's in SPKG.txt\n20:28 < jason--> in the spkg that is on the ticket?\n20:28 < ws-4636_2113> I think Jason Grout may have been impersonating you!\n20:28 < mabshoff> And that is why we need SPKG.txt files\n20:28 < jason--> is p1 from mhansen?\n20:28 < jason--> (did I copy and not change something?)\n20:28 < mabshoff> copy & paste?\n20:28 < mhansen> I can't for the life of me remember doing that.\n20:28 < ws-4636_2113> It's checked in by Jason.\n20:29 < ws-4636_2113> So I think you didn't do it -- jason did.\n```\n\n3. The patch fails to apply, but almost applies:\n\n```\nwas@sage:~/build/sage-3.2.1.alpha1$ ./sage\n----------------------------------------------------------------------\n| Sage Version 3.2.1.alpha1, Release Date: 2008-11-26                |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nhg_sage.applsage: hg_sage.apply('http://trac.sagemath.org/sage_trac/attachment/ticket/2113/gzip.patch')\nAttempting to load remote file: http://trac.sagemath.org/sage_trac/attachment/ticket/2113/gzip.patch?format=raw\nLoading: [.]\ncd \"/home/was/build/sage-3.2.1.alpha1/devel/sage\" && hg status\ncd \"/home/was/build/sage-3.2.1.alpha1/devel/sage\" && hg status\ncd \"/home/was/build/sage-3.2.1.alpha1/devel/sage\" && hg import   \"/home/was/.sage/temp/sage/9182/tmp_0.patch\"\napplying /home/was/.sage/temp/sage/9182/tmp_0.patch\npatching file sage/server/notebook/twist.py\nHunk #10 FAILED at 1791\n1 out of 11 hunks FAILED -- saving rejects to file sage/server/notebook/twist.py.rej\nabort: patch failed to apply\n```\n\nOnly one hunk fails, which doesn't really impact much how this works.",
    "created_at": "2008-11-28T04:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13068",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>
REFEREE REPORT:

I will give this a positive review when the following trivial things are all fixed. 

1. The spkg has a file in there that it shouldn't have in the root directory:

```
teragon-2:twisted-8.1.0.p2 wstein$ pwd
/Users/wstein/Desktop/twisted-8.1.0.p2
teragon-2:twisted-8.1.0.p2 wstein$ hg status
? gzip.py.patch
teragon-2:twisted-8.1.0.p2 wstein$ ls
SPKG.txt	gzip.py.patch	patches		spkg-install	src
```
Just delete it and remake the spkg.

The spkg itself compiles fine. 

That said, I'm confused as to what/where gzip.py.patch comes from.  Evidently mhansen wrote it.  It should probably be upstreamed?

2. There is a problem with SPKG.txt claiming mhansen did something, but actually Jason did:

```
20:26 < mhansen> How is this due to me?
20:26 < mhansen> I haven't seen this ticket before.
20:27 < jason--> the patch on the ticket just modifies twist.py
20:28 < ws-4636_2113> === twisted-8.1.0.p2 (Mike Hansen, October 18, 2008) === * Apply the patches to make the gzip filter deal 
                      with javascript mime types.
20:28 < ws-4636_2113> It's in SPKG.txt
20:28 < jason--> in the spkg that is on the ticket?
20:28 < ws-4636_2113> I think Jason Grout may have been impersonating you!
20:28 < mabshoff> And that is why we need SPKG.txt files
20:28 < jason--> is p1 from mhansen?
20:28 < jason--> (did I copy and not change something?)
20:28 < mabshoff> copy & paste?
20:28 < mhansen> I can't for the life of me remember doing that.
20:28 < ws-4636_2113> It's checked in by Jason.
20:29 < ws-4636_2113> So I think you didn't do it -- jason did.
```

3. The patch fails to apply, but almost applies:

```
was@sage:~/build/sage-3.2.1.alpha1$ ./sage
----------------------------------------------------------------------
| Sage Version 3.2.1.alpha1, Release Date: 2008-11-26                |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
hg_sage.applsage: hg_sage.apply('http://trac.sagemath.org/sage_trac/attachment/ticket/2113/gzip.patch')
Attempting to load remote file: http://trac.sagemath.org/sage_trac/attachment/ticket/2113/gzip.patch?format=raw
Loading: [.]
cd "/home/was/build/sage-3.2.1.alpha1/devel/sage" && hg status
cd "/home/was/build/sage-3.2.1.alpha1/devel/sage" && hg status
cd "/home/was/build/sage-3.2.1.alpha1/devel/sage" && hg import   "/home/was/.sage/temp/sage/9182/tmp_0.patch"
applying /home/was/.sage/temp/sage/9182/tmp_0.patch
patching file sage/server/notebook/twist.py
Hunk #10 FAILED at 1791
1 out of 11 hunks FAILED -- saving rejects to file sage/server/notebook/twist.py.rej
abort: patch failed to apply
```

Only one hunk fails, which doesn't really impact much how this works.



---

archive/issue_comments_013069.json:
```json
{
    "body": "**Changing assignee** from boothby to @jasongrout.",
    "created_at": "2008-11-28T04:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13069",
    "user": "https://github.com/jasongrout"
}
```

**Changing assignee** from boothby to @jasongrout.



---

archive/issue_comments_013070.json:
```json
{
    "body": "**Changing status** from new to assigned.",
    "created_at": "2008-11-28T04:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13070",
    "user": "https://github.com/jasongrout"
}
```

**Changing status** from new to assigned.



---

archive/issue_comments_013071.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2009-02-03T09:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13071",
    "user": "https://github.com/jasongrout"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_013072.json:
```json
{
    "body": "<a id='comment:9'></a>\nI've refreshed the spkg to address the concerns above.  The patch applies cleanly for me on a (slightly modified) sage 3.3alpha3.",
    "created_at": "2009-02-03T09:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13072",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:9'></a>
I've refreshed the spkg to address the concerns above.  The patch applies cleanly for me on a (slightly modified) sage 3.3alpha3.



---

archive/issue_events_006067.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2009-02-03T09:23:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2113#event-6067"
}
```



---

archive/issue_events_006068.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-02-07T00:39:34Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2113#event-6068"
}
```



---

archive/issue_events_006069.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-02-07T00:39:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2113#event-6069"
}
```



---

archive/issue_comments_013073.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2009-02-07T00:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13073",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_013074.json:
```json
{
    "body": "<a id='comment:11'></a>\nLooks good now.",
    "created_at": "2009-02-07T00:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13074",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
Looks good now.



---

archive/issue_comments_013075.json:
```json
{
    "body": "<a id='comment:12'></a>\nMerged twisted-8.1.0.p2.spkg in Sage 3.3.alpha6.\n\nCheers,\n\nMichael",
    "created_at": "2009-02-07T01:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13075",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>
Merged twisted-8.1.0.p2.spkg in Sage 3.3.alpha6.

Cheers,

Michael



---

archive/issue_events_006070.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-02-07T01:09:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/2113#event-6070"
}
```



---

archive/issue_comments_013076.json:
```json
{
    "body": "<a id='comment:13'></a>\nDid gzip.patch get merged? On 3.3.alpha6, I don't see anything from that patch in twist.py, and I also don't see anything getting gzip'ed. When I apply the patch, I get some things, but not all, gzip encoded.\n\nAlso, on 3.3.alpha6, in spkg/installed, I see twisted-8.1.0.p1 and twisted-8.1.0.p2. Should there just be one there?",
    "created_at": "2009-02-10T10:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13076",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:13'></a>
Did gzip.patch get merged? On 3.3.alpha6, I don't see anything from that patch in twist.py, and I also don't see anything getting gzip'ed. When I apply the patch, I get some things, but not all, gzip encoded.

Also, on 3.3.alpha6, in spkg/installed, I see twisted-8.1.0.p1 and twisted-8.1.0.p2. Should there just be one there?



---

archive/issue_comments_013077.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [ddrake](#comment%3A13):\n> Did gzip.patch get merged? On 3.3.alpha6, I don't see anything from that patch in twist.py, and I also don't see anything getting gzip'ed. When I apply the patch, I get some things, but not all, gzip encoded.\n\n\nOops, merging the patch now. I thought it was inside the spkg and did not apply to the Sage library. Thanks for checking. \n\n> Also, on 3.3.alpha6, in spkg/installed, I see twisted-8.1.0.p1 and twisted-8.1.0.p2. Should there just be one there?\n\n\nYes, I am deleting p1 now. \n\nI guess this wasn't the best merge :(\n\nCheers,\n\nMichael",
    "created_at": "2009-02-10T10:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13077",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:14'></a>
Replying to [ddrake](#comment%3A13):
> Did gzip.patch get merged? On 3.3.alpha6, I don't see anything from that patch in twist.py, and I also don't see anything getting gzip'ed. When I apply the patch, I get some things, but not all, gzip encoded.


Oops, merging the patch now. I thought it was inside the spkg and did not apply to the Sage library. Thanks for checking. 

> Also, on 3.3.alpha6, in spkg/installed, I see twisted-8.1.0.p1 and twisted-8.1.0.p2. Should there just be one there?


Yes, I am deleting p1 now. 

I guess this wasn't the best merge :(

Cheers,

Michael



---

archive/issue_comments_013078.json:
```json
{
    "body": "<a id='comment:15'></a>\nDan,\n\nI checked my 3.3.rc0 merge tree and I only have twisted-8.1.0.p2.spkg, so if you upgraded it would explain why you might have twisted-8.1.0.p1.spkg also in tree. Maybe -bdist also killed the extra twisted.spkg, but I am too lazy to find out :)\n\nCheers,\n\nMichael",
    "created_at": "2009-02-10T10:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/2113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/2113#issuecomment-13078",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:15'></a>
Dan,

I checked my 3.3.rc0 merge tree and I only have twisted-8.1.0.p2.spkg, so if you upgraded it would explain why you might have twisted-8.1.0.p1.spkg also in tree. Maybe -bdist also killed the extra twisted.spkg, but I am too lazy to find out :)

Cheers,

Michael
