# Issue 2504: number field .units() method caches proof=False result and returns it for proof=True

archive/issues_002504.json:
```json
{
    "assignees": [],
    "body": "The following was reported by Luis Finotti on sage-support, here: http://groups.google.com/group/sage-support/browse_thread/thread/f01e8661743d36d4#\n\nThe following commands return an error:\n\n```\n   P.<x>=PolynomialRing(QQ)\n   f=x^17+3\n   K=NumberField(f,'a')\n   K.units(proof=True) # default\n```\nbecause Sage is incapable of performing the computation with proof=True.\n(The error ends with \"not enough precomputed primes, need primelimit ~  (35)\".)\n\nIf you then do\n\n```\n   K.units(proof=False)\n```\nyou get an answer immediately; then repeating the original\n\n```\n   K.units(proof=True)\n```\ngives you the unproved answer again even though proof=True is specified.\n\nAssignee: **@williamstein**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/2504_\n\n",
    "closed_at": "2008-04-26T21:58:58Z",
    "created_at": "2008-03-13T03:14:46Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20number%20theory",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.0.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "number field .units() method caches proof=False result and returns it for proof=True",
    "type": "issue",
    "updated_at": "2008-04-26T21:58:58Z",
    "url": "https://github.com/sagemath/sage/issues/2504",
    "user": "https://github.com/sagetrac-cwitty"
}
```
The following was reported by Luis Finotti on sage-support, here: http://groups.google.com/group/sage-support/browse_thread/thread/f01e8661743d36d4#

The following commands return an error:

```
   P.<x>=PolynomialRing(QQ)
   f=x^17+3
   K=NumberField(f,'a')
   K.units(proof=True) # default
```
because Sage is incapable of performing the computation with proof=True.
(The error ends with "not enough precomputed primes, need primelimit ~  (35)".)

If you then do

```
   K.units(proof=False)
```
you get an answer immediately; then repeating the original

```
   K.units(proof=True)
```
gives you the unproved answer again even though proof=True is specified.

Assignee: **@williamstein**

_Issue created by migration from https://trac.sagemath.org/ticket/2504_





---

archive/issue_events_022628.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2008-03-13T03:14:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "milestone_number": null,
    "milestone_title": "sage-3.0.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22628"
}
```



---

archive/issue_events_022629.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2008-03-13T03:14:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "component: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22629"
}
```



---

archive/issue_events_022630.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2008-03-13T03:14:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22630"
}
```



---

archive/issue_events_022631.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2008-03-13T03:14:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22631"
}
```



---

archive/issue_comments_013378.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nAttachment: **[2504-units_cache.patch.gz](https://github.com/sagemath/sage/files/ticket2504/2504-units_cache.patch.gz)**\n\nThe attached patch fixes this and adds doctests illustrating the correct behavior.",
    "created_at": "2008-04-13T02:27:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2504#issuecomment-13378",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:1'>Comment 1:</a>
Attachment: **[2504-units_cache.patch.gz](https://github.com/sagemath/sage/files/ticket2504/2504-units_cache.patch.gz)**

The attached patch fixes this and adds doctests illustrating the correct behavior.



---

archive/issue_events_022632.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2008-04-13T02:27:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22632"
}
```



---

archive/issue_comments_013379.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nWait -- if you ask for units with proof, the value is cached.  If you then ask for it without proof, shouldn't we return the cached value?  The code doesn't look like it does that.",
    "created_at": "2008-04-15T16:34:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2504#issuecomment-13379",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:2'>Comment 2:</a>
Wait -- if you ask for units with proof, the value is cached.  If you then ask for it without proof, shouldn't we return the cached value?  The code doesn't look like it does that.



---

archive/issue_comments_013380.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nAttachment: **[2504-units_cache.2.patch.gz](https://github.com/sagemath/sage/files/ticket2504/2504-units_cache.2.patch.gz)**\n\nYou are completely right.  I've replaced the patch and reorganized the code so it looks a bit cleaner.",
    "created_at": "2008-04-15T20:18:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2504#issuecomment-13380",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:3'>Comment 3:</a>
Attachment: **[2504-units_cache.2.patch.gz](https://github.com/sagemath/sage/files/ticket2504/2504-units_cache.2.patch.gz)**

You are completely right.  I've replaced the patch and reorganized the code so it looks a bit cleaner.



---

archive/issue_events_022633.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2008-04-26T17:16:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22633"
}
```



---

archive/issue_events_022634.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2008-04-26T17:16:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22634"
}
```



---

archive/issue_comments_013381.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nLooks good to me.",
    "created_at": "2008-04-26T17:16:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2504#issuecomment-13381",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:4'>Comment 4:</a>
Looks good to me.



---

archive/issue_comments_013382.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nMerged 2504-units_cache.2.patch in Sage 3.0.1.alpha1",
    "created_at": "2008-04-26T21:58:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/2504#issuecomment-13382",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:5'>Comment 5:</a>
Merged 2504-units_cache.2.patch in Sage 3.0.1.alpha1



---

archive/issue_events_022635.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-04-26T21:58:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22635"
}
```



---

archive/issue_events_022636.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-04-26T21:58:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/2504",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/2504#event-22636"
}
```
