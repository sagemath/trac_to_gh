# Issue 13794: hash of a pickled Sequence is broken

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2013-01-23 16:38:17

Assignee: slabbe

The following works::


```
    sage: M = ModularSymbols(1,12,sign=1)
    sage: M
    Modular Symbols space of dimension 2 for Gamma_0(1) of weight 12 with sign 1 over Rational Field
    sage: S = M.cuspidal_submodule().decomposition()[0].free_module().basis()
    sage: type(S)
    <class 'sage.structure.sequence.Sequence_generic'>
    sage: S
    [
    (1, 0)
    ]
    sage: hash(S)
    979268961
```


But if you do the same from a certain pickled object, it is broken (tested on sage-4.7 and sage-5.6.rc0)::


```
    sage: M = load('http://sage.math.washington.edu/home/slabbe/LMFDB/mstest.sobj')
    Attempting to load remote file: http://sage.math.washington.edu/home/slabbe/LMFDB/mstest.sobj
    Loading: [.]
    sage: M
    Modular Symbols space of dimension 2 for Gamma_0(1) of weight 12 with sign 1 over Rational Field
    sage: S = M.cuspidal_submodule().decomposition()[0].free_module().basis()
    sage: type(S)
    <class 'sage.structure.sequence.Sequence_generic'>
    sage: S
    [
    (1, 0)
    ]
    sage: hash(S)
    Traceback (most recent call last)
    ...
    AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
```


This particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage.


---

Comment by slabbe created at 2013-01-23 17:58:50

Here is a way to reproduce the problem on a recent version of Sage:


```
sage: S = Sequence([])
sage: S.set_immutable()
sage: del S._Sequence_generic__hash
sage: hash(S)
Traceback (most recent call last):
...
AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
sage:
sage: S._Sequence__hash = 34  # providing this value should fix the above error but it doesn't:
sage: hash(S)
Traceback (most recent call last):
...
AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
```


This is what I am going to use to doctest the fix.


---

Comment by slabbe created at 2013-01-23 18:04:12

Changing status from new to needs_review.


---

Attachment


---

Comment by ehlen created at 2013-01-24 16:52:32

Changing status from needs_review to positive_review.


---

Comment by ehlen created at 2013-01-24 16:52:32

I tested the patch with sage version 5.5.

I tested that:
* The described bug does not occur anymore with the pickled object (see also my remark below).
* The buggy behaviour described in comment 1 is now fixed.
* The patch adds doctests for the patch with reference to the trac ticket.
* The doctests complete without any errors.
* The sage documentation builds fine.

Remark: In fact, the pickled object was provided by me and belongs to a large collection that serves the LMFDB (www.lmfdb.org) website currently. This means that the bug affected >13000 pickled objects. Now the first example from above works with the objects taken from the database
(I tested a few, not all of them.)


---

Comment by jdemeyer created at 2013-01-25 16:19:15

Please fill in the Author / Reviewer fields.


---

Comment by jdemeyer created at 2013-01-30 07:36:13

Resolution: fixed
