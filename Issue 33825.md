# Issue 33825: enhance our conversion system

Issue created by migration from https://trac.sagemath.org/ticket/34062

Original creator: chapoton

Original creation time: 2022-06-24 15:12:21

Currently, we create the `symbol_table` to handle back-conversion from other systems. I will use "giac" as an example.

For example, we have `symbol_table["giac"]`, which is a dictionary ``string: func`` where ``string`` is a function name in giac and ``func`` is the corresponding function in sage.

Proposal:

Enrich the conversion dictionary as follows :
``(string, number): func`` where number is number of arguments.

This allows to handle the conversion better when "giac" has one single function with various numbers of arguments and we have different functions.

More generally, this allows to be more precise in what we are doing.


---

Comment by chapoton created at 2022-06-24 15:13:05

New commits:


---

Comment by chapoton created at 2022-06-24 15:13:05

Changing status from new to needs_review.


---

Comment by chapoton created at 2022-06-24 15:29:55

For example, this happens in `Fricas` for `ellipticE` in

https://fricas.github.io/api/SpecialFunctionCategory.html

and something similar in `maple` for `Zeta` (more fishy) :

https://fr.maplesoft.com/support/help/maple/view.aspx?path=Zeta

and in `math...` for Gamma:

https://reference.wolfram.com/language/ref/Gamma.html


---

Comment by git created at 2022-06-24 15:37:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-24 15:45:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2022-06-24 20:51:38

maybe you could fix the typo in

```
register_symbol(lambda: infinity, {'fricas': 'plusInfinity'}, 0) # %plusInfinity::INFORM is (minusInfinity)
```

on the way? ("minus" should be "plus")


---

Comment by git created at 2022-06-25 06:48:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-06-25 06:49:24

done, but the Fricas interface still breaks on hypergeometric functions, which use "CONSTRUCT" with an arbirary number of arguments.


---

Comment by mantepse created at 2022-06-25 07:22:18

I am currently rebuilding sage with this ticket.

I do not know (please take this literally, not as criticism) whether having to specify the number of arguments is the best approach.

I guess it should be possible to allow for functions with an arbitrary number of arguments, eg. by specifying `None` instead.  However, FriCAS itself actually does not allow this.  I have to sort out whether `construct` is special, or whether it does fit into the usual scheme.


---

Comment by mantepse created at 2022-06-25 08:36:35

I guess the following is the easy fix.

```diff
diff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py
index 19a56c062f4..671b4d2d085 100644
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -1367,7 +1367,10 @@ class FriCASElement(ExpectElement):
         try:
             fun = symbol_table["fricas"][(fun_string, len(args))]
         except KeyError:
-            fun = function(fun_string)
+            try:
+                fun = symbol_table["fricas"][(fun_string, -1)]
+            except KeyError:
+                fun = function(fun_string)
         return fun(*args), a
 
     @staticmethod
```



---

Comment by git created at 2022-06-25 11:56:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-06-26 10:03:13

now maple interface needs to be repaired


---

Comment by mantepse created at 2022-06-26 10:23:35

I don't have access to maple, sorry.


---

Comment by git created at 2022-06-26 10:54:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-06-26 11:05:37

maple interface now fixed. Somebody needs to check the mathematica back-conversion, please.


---

Comment by git created at 2022-06-26 18:36:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2022-06-26 21:22:50

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2022-06-26 21:22:50

Replying to [comment:15 chapoton]:
> maple interface now fixed. Somebody needs to check the mathematica back-conversion, please.

Well...


```
charpent@zen-book-flip:/usr/local/sage-9$ sage -t src/sage/interfaces/mathematica.py 
Running doctests with ID 2022-06-26-23-17-49-22d13eec.
Git branch: t/34062/34062
Git ref: 9.7.beta3-7-gac8fbb128cd
Running with SAGE_LOCAL='/usr/local/sage-9/local' and SAGE_VENV='/usr/local/sage-9/local/var/lib/sage/venv-python3.10'
Using --optional=debian,dot2tex,fricas,gap_packages,libsemigroups,mathics,mathics_scanner,palettable,pint,pip,pysingular,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
Traceback (most recent call last):
  File "/usr/local/sage-9/src/bin/sage-runtests", line 153, in <module>
    err = DC.run()
  File "/usr/local/sage-9/src/sage/doctest/control.py", line 1376, in run
    self.run_doctests()
  File "/usr/local/sage-9/src/sage/doctest/control.py", line 1052, in run_doctests
    self.dispatcher = DocTestDispatcher(self)
  File "/usr/local/sage-9/src/sage/doctest/forker.py", line 1626, in __init__
    init_sage(controller)
  File "/usr/local/sage-9/src/sage/doctest/forker.py", line 193, in init_sage
    controller.load_environment()
  File "/usr/local/sage-9/src/sage/doctest/control.py", line 589, in load_environment
    return import_module(self.options.environment)
  File "/usr/lib/python3.10/importlib/__init__.py", line 126, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
  File "<frozen importlib._bootstrap>", line 1050, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1006, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 688, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 883, in exec_module
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
  File "/usr/local/sage-9/src/sage/repl/ipython_kernel/all_jupyter.py", line 5, in <module>
    from sage.all_cmdline import *
  File "/usr/local/sage-9/src/sage/all_cmdline.py", line 19, in <module>
    from sage.all import *
  File "/usr/local/sage-9/src/sage/all.py", line 135, in <module>
    from sage.symbolic.all   import *
  File "/usr/local/sage-9/src/sage/symbolic/all.py", line 10, in <module>
    from .constants import (pi, e, NaN, golden_ratio, log2, euler_gamma, catalan,
  File "/usr/local/sage-9/src/sage/symbolic/constants.py", line 231, in <module>
    register_symbol(infinity, {'maxima':'inf'}, 0)
  File "sage/symbolic/pynac_impl.pxi", line 2375, in sage.symbolic.expression.register_symbol
TypeError: register_symbol() takes exactly 2 positional arguments (3 given)
```


==> `needs_work`


---

Comment by charpent created at 2022-06-26 21:40:03

Replying to [comment:17 charpent]:
> Replying to [comment:15 chapoton]:

[ Snip... ]

> ==> `needs_work`

Well... `configure --enable-editable` wasn('t sufficint in this case. After re-`make`ing :


```
charpent@zen-book-flip:/usr/local/sage-9$ sage -t src/sage/interfaces/mathematica.py 
Running doctests with ID 2022-06-26-23-34-51-5fc132c3.
Git branch: t/34062/34062
Git ref: 9.7.beta3-7-gac8fbb128cd
Running with SAGE_LOCAL='/usr/local/sage-9/local' and SAGE_VENV='/usr/local/sage-9/local/var/lib/sage/venv-python3.10'
Using --optional=debian,dot2tex,fricas,gap_packages,libsemigroups,mathics,mathics_scanner,palettable,pint,pip,pysingular,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --warn-long 194.5 --random-seed=217146151663288597630828810215703796564 src/sage/interfaces/mathematica.py
    [25 tests, 0.05 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 5.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Features detected for doctesting: 
pytest is not installed in the venv, skip checking tests that rely on it
```


==> `needs_review`. Sorry for the noise...

`ptestlong` underway. Stay tuned.


---

Comment by charpent created at 2022-06-26 21:40:03

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2022-06-27 03:10:56

`ptestlong` gets the same failures as it does on `develop`.

==>`positive_review`.

I suggest a further check against the Wolfram engine before proceeding, but can't do that for to days (at least).

HTH,


---

Comment by charpent created at 2022-06-27 03:10:56

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-06-27 03:21:38

Reviewer name


---

Comment by charpent created at 2022-06-27 06:06:49

Wups !Again...


---

Comment by vbraun created at 2022-07-09 22:32:54

Resolution: fixed
