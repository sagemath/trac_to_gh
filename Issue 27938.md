# Issue 27938: Move sage optimization backends to a separate package

Issue created by migration from https://trac.sagemath.org/ticket/28175

Original creator: mkoeppe

Original creation time: 2019-07-11 17:54:04

CC:  isuruf saraedum fbissey dimpase tmonteil vdelecroix slabbe

`sage.numerical.backends` depends on very little from Sage and should become a separate Cython package. This would make it easier to reconfigure it when new solvers are installed and eliminate some optional extensions from sagelib.

Details:
 - `get_solver` uses base_ring
 - GLPKBackend depends on `sage.libs.glpk`, which should also become a separate Cython package (see https://en.wikibooks.org/wiki/GLPK/Python for a list of other glpk bindings)


---

Comment by dcoudert created at 2019-07-23 20:30:59

Can you be more precise on your plans.

These backends are used in graphs. So what will happen if linear programming backends are in a separate package ?


---

Comment by mkoeppe created at 2019-07-24 15:24:12

Replying to [comment:1 dcoudert]:
> These backends are used in graphs. So what will happen if linear programming backends are in a separate package ? 
In my plan, the backends would be a standard package of the sage distribution, and the cython modules it provides would be automatically imported when MixedIntegerLinearProgram is used.


---

Comment by fbissey created at 2019-11-28 04:00:36

For glpk it looks like https://github.com/biosustain/swiglpk/releases is the best maintained. Excluding sage and cvxopt.


---

Comment by mkoeppe created at 2019-12-24 05:14:19

I have prepared a first module, https://github.com/mkoeppe/sage-numerical-backends-coin.
It depends on Sage (as it inherits from `sage.numerical.backends.generic_backend.GenericBackend`).


---

Comment by dimpase created at 2019-12-25 02:42:57

Is there a git branch to try, replacing Sage's current COIN-OR backend with this one?


---

Comment by mkoeppe created at 2019-12-25 03:11:14

Not yet (working on it right now), but the 3 backends already pass their test suites separately.


---

Comment by git created at 2019-12-25 03:19:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-12-25 03:20:01

Now the packages can be installed using `sage -i -c`... please test


---

Comment by dimpase created at 2019-12-25 03:27:28

remains of copypaste, I see `PyNormaliz` in the branch...


---

Comment by git created at 2019-12-25 03:28:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-12-25 03:29:24

Changing status from new to needs_review.


---

Comment by git created at 2019-12-25 03:33:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-25 04:34:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-25 05:48:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-25 05:50:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-27 04:11:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-12-27 16:40:43

Since these are currently part of the Sage distribution, it makes sense to me to have them as standard packages (in regards to comment:2). Similarly I would argue they do not require a vote on sage-devel, but I would just post something quick there to see if there are any objections.


---

Comment by mkoeppe created at 2019-12-27 16:50:29

They can't be standard packages because they only compile if the respective solvers are installed.


---

Comment by mkoeppe created at 2019-12-27 16:51:48

Note that I narrowed down the ticket recently; the early comments were on a broader proposal to move ALL backends out to separate packages.


---

Comment by tscrim created at 2019-12-27 17:15:23

Ah, I see. Sorry for the noise.


---

Comment by fbissey created at 2019-12-27 19:21:05

`coin` is problematic for me on sage-on-gentoo, and has been for a while. So, making it a standard package would be annoying. The `coin` interface doesn't seem to be very stable and `coin` in sage is not updated often (neither it is in gentoo). Version mismatch usually lead to a failure to build the interface.


---

Comment by mkoeppe created at 2019-12-27 19:28:46

Well, the point of this ticket is to make the sage build *less* dependent on coin, not more. 

Also, I'd appreciate any help with testing https://github.com/mkoeppe/sage-numerical-backends-coin on sage installations such as the one provided on gentoo. My current test scripts (using [GitHub](GitHub) actions) cover conda-forge so far, and I'm working on various debian/ubuntu flavors.


---

Comment by fbissey created at 2019-12-27 19:41:41

Replying to [comment:30 mkoeppe]:
> Well, the point of this ticket is to make the sage build *less* dependent on coin, not more. 
> 
> Also, I'd appreciate any help with testing https://github.com/mkoeppe/sage-numerical-backends-coin on sage installations such as the one provided on gentoo. My current test scripts (using [GitHub](GitHub) actions) cover conda-forge so far, and I'm working on various debian/ubuntu flavors.

I will have a look at it. It looks interesting but where does it install itself? I cannot promise speedy review as I about to have my annual internet /computer detox for a few days :)


---

Comment by mkoeppe created at 2019-12-27 19:44:08

It just installs itself as a Python package named `sage_numerical_backends_coin.coin_backend` (note, underscores, not dots).
The https://github.com/mkoeppe/sage-numerical-backends-coin/blob/master/README.md explains how to use it, including how to patch it into a sage for testing purposes.


---

Comment by dimpase created at 2019-12-28 09:16:44

for coin, there is a verssion mismatch. On pypi and in the ticket description the minor version is b9, in build/pkgs/ it is b10, the latest on github is b12 :-)

So I took b12 from github, renamed the tarfile (arrgh), bumped up the version,

```diff
diff --git a/build/pkgs/sage_numerical_backends_coin/checksums.ini b/build/pkgs/sage_numerical_backends_coin/checksums.ini
index 03b250b653..3062652fc1 100644
--- a/build/pkgs/sage_numerical_backends_coin/checksums.ini
+++ b/build/pkgs/sage_numerical_backends_coin/checksums.ini
@@ -1,4 +1,4 @@
 tarball=sage_numerical_backends_coin-VERSION.tar.gz
-sha1=fd96cfc224f1f45bad6bacaaf37df3904fa7a561
-md5=98e5a002648cdf3167df2dafb16cde47
-cksum=869439056
+sha1=0c424f8d01bdd44169630bc898738a4ee146ea2c
+md5=09b6b74d7c8b9b3526424cf8850f8700
+cksum=1339126990
diff --git a/build/pkgs/sage_numerical_backends_coin/package-version.txt b/build/pkgs/sage_numerical_backends_coin/package-version.txt
index 5d6a14cdd9..1700f7be00 100644
--- a/build/pkgs/sage_numerical_backends_coin/package-version.txt
+++ b/build/pkgs/sage_numerical_backends_coin/package-version.txt
@@ -1 +1 @@
-9.0b10
+9.0b12
```


and then 

```
$ SAGE_CHECK=yes ./sage -i sage_numerical_backends_coin
```

worked on Debian with system's cbc 2.9.9.
(using #28908)


---

Comment by dimpase created at 2019-12-28 09:18:53

Where are the tests from now gone `sage/numerical/backends/coin_backend.pyx` ?
Are they all being run while installing with `SAGE_CHECK=yes` ?


---

Comment by fbissey created at 2019-12-28 09:34:07

In a way related to #26511, upstream devs for cbc have published their own python interface https://git.patrikdufresne.com/pdsl/cbcpy the fact that it uses swig may be an obstacle for immediate inclusion but switching to something maintained externally is something to think about. The project is quite new (August 2019 according to https://pypi.org/project/cbcpy/ ) which is why it may escaped attention before.


---

Comment by dimpase created at 2019-12-28 09:53:36

in the environment as above for coin, 

`SAGE_CHECK=yes ./sage -f sage_numerical_backends_gurobi`

fails with


```
...
[sage_numerical_backends_gurobi-9.0b9] Running the test suite for sage_numerical_backends_gurobi-9.0b9...
[sage_numerical_backends_gurobi-9.0b9] running test
[sage_numerical_backends_gurobi-9.0b9] Searching for sage-package
[sage_numerical_backends_gurobi-9.0b9] Reading https://pypi.org/simple/sage-package/
[sage_numerical_backends_gurobi-9.0b9] Using gurobi_include_directories=['/home/dimpase/sage/upstream/gurobi900/linux64/include'], libraries=['gurobi90'], library_dirs=['/home/dimpase/sage/upstream/gurobi900/linux64/lib']
[sage_numerical_backends_gurobi-9.0b9] Download error on https://pypi.org/simple/sage-package/: [Errno 110] Connection timed out -- Some packages may not be found!
[sage_numerical_backends_gurobi-9.0b9] Couldn't find index page for 'sage-package' (maybe misspelled?)
[sage_numerical_backends_gurobi-9.0b9] Scanning index of all packages (this may take a while)
[sage_numerical_backends_gurobi-9.0b9] Reading https://pypi.org/simple/
[sage_numerical_backends_gurobi-9.0b9] Download error on https://pypi.org/simple/: [Errno 110] Connection timed out -- Some packages may not be found!
[sage_numerical_backends_gurobi-9.0b9] No local packages or working download links found for sage-package
[sage_numerical_backends_gurobi-9.0b9] error: Could not find suitable distribution for Requirement.parse('sage-package')
[sage_numerical_backends_gurobi-9.0b9] 
[sage_numerical_backends_gurobi-9.0b9] real     1m4.289s
[sage_numerical_backends_gurobi-9.0b9] user     0m0.833s
[sage_numerical_backends_gurobi-9.0b9] sys      0m0.148s
[sage_numerical_backends_gurobi-9.0b9] ************************************************************************
[sage_numerical_backends_gurobi-9.0b9] Error testing package sage_numerical_backends_gurobi-9.0b9
```



---

Comment by mkoeppe created at 2019-12-28 15:08:07

Replying to [comment:34 dimpase]:
> So I took b12 from github, renamed the tarfile (arrgh)...

I recommend to take the release files from pypi - they have been built with `setup.py sdist`.


---

Comment by mkoeppe created at 2019-12-28 15:12:48

Replying to [comment:35 dimpase]:
> Where are the tests from now gone `sage/numerical/backends/coin_backend.pyx` ?
> Are they all being run while installing with `SAGE_CHECK=yes` ?

They are here:
https://github.com/mkoeppe/sage-numerical-backends-coin/blob/master/sage_numerical_backends_coin/coin_backend.pyx
They are run in the CI scripts of the package, and also when installing the spkg with `SAGE_CHECK=yes`.


---

Comment by dimpase created at 2019-12-28 15:29:43

Replying to [comment:38 mkoeppe]:
> Replying to [comment:34 dimpase]:
> > So I took b12 from github, renamed the tarfile (arrgh)...
> 
> I recommend to take the release files from pypi - they have been built with `setup.py sdist`.

sure, but b12 was not there yet. https://pypi.org/project/sage-numerical-backends-coin/#files says it made it there ~10 hours ago.


---

Comment by mkoeppe created at 2019-12-28 15:30:27

Created follow-up ticket, cleaned up ticket description


---

Comment by dimpase created at 2019-12-28 15:31:58

Replying to [comment:41 mkoeppe]:
> Created follow-up ticket, cleaned up ticket description

some links to packages are not up to date.


---

Comment by mkoeppe created at 2019-12-28 15:32:34

Replying to [comment:36 fbissey]:
> In a way related to #26511, upstream devs for cbc have published their own python interface https://git.patrikdufresne.com/pdsl/cbcpy the fact that it uses swig may be an obstacle for immediate inclusion but switching to something maintained externally is something to think about. The project is quite new (August 2019 according to https://pypi.org/project/cbcpy/ ) which is why it may escaped attention before.
Thank you! I've added this information to #26511.


---

Comment by mkoeppe created at 2019-12-28 15:33:35

Replying to [comment:42 dimpase]:
> Replying to [comment:41 mkoeppe]:
> > Created follow-up ticket, cleaned up ticket description
> 
> some links to packages are not up to date.
Thanks for testing! I'll update the cplex and gurobi packages with my changes to the coin package and then make new releases.


---

Comment by dimpase created at 2019-12-28 15:40:16

Perhaps Gurobi (and similarly, CPLEX) can get some spkg-configure.m4 helpers to reduce the hassle of

```
export GUROBI_HOME="/opt/gurobi900/linux64"
export PATH="${PATH}:${GUROBI_HOME}/bin"
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${GUROBI_HOME}/lib"
```

to a minimum.
E.g. there could be an `--with-gurobi-home=` option which would default to
`$GUROBI_HOME`, 
and `GUROBI_HOME` should be written in `sage-env-config` etc.

This is for a follow-up ticket, of course.


---

Comment by mkoeppe created at 2019-12-28 16:29:21

Replying to [comment:45 dimpase]:
> Perhaps Gurobi (and similarly, CPLEX) can get some spkg-configure.m4 helpers to reduce the hassle of
> {{{
> export GUROBI_HOME="/opt/gurobi900/linux64"
> export PATH="${PATH}:${GUROBI_HOME}/bin"
> export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${GUROBI_HOME}/lib"
> }}}
> to a minimum.
> E.g. there could be an `--with-gurobi-home=` option which would default to
> `$GUROBI_HOME`, 
> and `GUROBI_HOME` should be written in `sage-env-config` etc.
> 
> This is for a follow-up ticket, of course.

The macOS installer of Gurobi adds the following symlinks:

```
lrwxr-xr-x  1 root  wheel  40 Apr 28  2016 /usr/local/bin/gurobi.env -> //Library/gurobi651/mac64/bin/gurobi.env
lrwxr-xr-x  1 root  admin  39 Dec 24 12:11 /usr/local/bin/gurobi.sh -> //Library/gurobi900/mac64/bin/gurobi.sh
lrwxr-xr-x  1 root  admin  39 Dec 24 12:11 /usr/local/bin/gurobi_cl -> //Library/gurobi900/mac64/bin/gurobi_cl
```


See https://github.com/mkoeppe/sage-numerical-backends-gurobi/blob/master/README.md (just updated) - 
I am using gurobi.sh to do all the build configuration. 
Does this work on Linux?


---

Comment by mkoeppe created at 2019-12-28 16:48:36

Replying to [comment:46 mkoeppe]:
> Replying to [comment:45 dimpase]:
> > Perhaps Gurobi (and similarly, CPLEX) can get some spkg-configure.m4 helpers to reduce the hassle of
> > {{{
> > export GUROBI_HOME="/opt/gurobi900/linux64"
> > export PATH="${PATH}:${GUROBI_HOME}/bin"
> > export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${GUROBI_HOME}/lib"
> > }}}
> > to a minimum.
> > E.g. there could be an `--with-gurobi-home=` option which would default to
> > `$GUROBI_HOME`, 
> > and `GUROBI_HOME` should be written in `sage-env-config` etc.
> > 
> > This is for a follow-up ticket, of course.
> 
> The macOS installer of Gurobi adds the following symlinks:
> {{{
> lrwxr-xr-x  1 root  wheel  40 Apr 28  2016 /usr/local/bin/gurobi.env -> //Library/gurobi651/mac64/bin/gurobi.env
> lrwxr-xr-x  1 root  admin  39 Dec 24 12:11 /usr/local/bin/gurobi.sh -> //Library/gurobi900/mac64/bin/gurobi.sh
> lrwxr-xr-x  1 root  admin  39 Dec 24 12:11 /usr/local/bin/gurobi_cl -> //Library/gurobi900/mac64/bin/gurobi_cl
> }}}
> 
> See https://github.com/mkoeppe/sage-numerical-backends-gurobi/blob/master/README.md (just updated) - 
> I am using gurobi.sh to do all the build configuration. 
> Does this work on Linux?

I see, on Linux it's not an installer but just a tgz.


---

Comment by dimpase created at 2019-12-29 01:50:53

Even on a Mac, with a multi-user installation one might want to hardcode `GUROBI_HOME` and the license file location (`GRB_LICENSE_FILE`).


---

Comment by git created at 2019-12-29 03:05:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-12-29 03:10:24

There's a new version of the gurobi package now. I have done some testing on Linux now, but I could not do a full test with a Gurobi license because it does not like to generate license keys on a Docker container. I have revised thee installation instructions to include Linux:
https://github.com/mkoeppe/sage-numerical-backends-gurobi/blob/master/README.md


---

Comment by mkoeppe created at 2019-12-29 03:12:06

Replying to [comment:48 dimpase]:
> Even on a Mac, with a multi-user installation one might want to hardcode `GUROBI_HOME` and the license file location (`GRB_LICENSE_FILE`).
Sure. The package looks at `GUROBI_HOME` first.


---

Comment by git created at 2019-12-29 14:00:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-12-29 14:01:41

Just updated the cplex backend. 
Ready for review.


---

Comment by isuruf created at 2019-12-29 16:12:16

I suggest using a namespace package for this. See https://packaging.python.org/guides/packaging-namespace-packages/


```
diff --git a/setup.py b/setup.py
index 176e75e..6dcffe2 100755
--- a/setup.py
+++ b/setup.py
@@ -44,8 +44,8 @@ cbc_library_dirs = cbc_pc['library_dirs']
 cbc_include_dirs = cbc_pc['include_dirs']
 
 
-ext_modules = [Extension('sage_numerical_backends_coin.coin_backend',
-                         sources=[os.path.join('sage_numerical_backends_coin',
+ext_modules = [Extension('sage.numerical.backends.coin_backend',
+                         sources=[os.path.join('sage/numerical/backends',
                                     'coin_backend.pyx')],
                          libraries=cbc_libs,
                          include_dirs=sage_include_directories() + cbc_include_dirs,
@@ -81,7 +81,7 @@ except CompileError:
 print("Using compile_time_env: {}".format(compile_time_env), file=sys.stderr)
 
 setup(
-    name="sage_numerical_backends_coin",
+    name="sage.numerical.backends.coin_backend",
     version=readfile("VERSION").strip(),
     description="COIN-OR backend for Sage MixedIntegerLinearProgram",
     long_description = readfile("README.md"), # get the long description from the README
@@ -109,9 +109,8 @@ setup(
                             compile_time_env=compile_time_env),
     cmdclass = {'test': SageTest}, # adding a special setup command for tests
     keywords=['milp', 'linear-programming', 'optimization'],
-    packages=['sage_numerical_backends_coin'],
-    package_dir={'sage_numerical_backends_coin': 'sage_numerical_backends_coin'},
-    package_data={'sage_numerical_backends_coin': ['*.pxd']},
+    packages=['sage.numerical.backends'],
+    package_data={'sage.numerical.backends': ['*.pxd']},
     install_requires = [# 'sage>=8',    ### On too many distributions, sage is actually not known as a pip package
                         'sphinx'],
     setup_requires   = ['pkgconfig'],
```



---

Comment by mkoeppe created at 2019-12-29 16:24:50

Replying to [comment:56 isuruf]:
> I suggest using a namespace package for this. See https://packaging.python.org/guides/packaging-namespace-packages/

Thanks a lot! I was briefly looking into this before I created the new packages, but was discouraged by various warnings on this page that seemed to imply one needs control of all packages sharing a namespace simultaneously. But I want the packages to work also with versions of sagelib that are already released.
Which of the three approaches mentioned on the page do you specifically recommend?


---

Comment by isuruf created at 2019-12-29 16:29:59

The diff above is for "1. native namespace package".

> But I want the packages to work also with versions of sagelib that are already released.

This should work in the case of sagelib already released and if the optional extension is already installed, it will be overriden I think.


---

Comment by mkoeppe created at 2019-12-29 16:40:15

Replying to [comment:58 isuruf]:
> The diff above is for "1. native namespace package".

Thanks. This seems to be for Python 3 only, which would conflict with the goal of my packages to support older released versions such as sage 8.1 on Ubuntu bionic. But I'll keep it in mind for the future.


---

Comment by mkoeppe created at 2019-12-29 16:47:33

Thanks for the pull request at https://github.com/mkoeppe/sage-numerical-backends-coin/pull/4 . Let's continue the discussion regarding namespace packages there.


---

Comment by git created at 2019-12-30 00:07:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-12-30 14:35:36

Replying to [comment:60 mkoeppe]:
> Thanks for the pull request at https://github.com/mkoeppe/sage-numerical-backends-coin/pull/4 . Let's continue the discussion regarding namespace packages there.
I consider the idea of using namespace packages beyond the scope of the present ticket. I have created ticket #28925 (Modify `clean_stale_files` to support modularization of `sagelib` by namespace packages) for this direction.


---

Comment by dimpase created at 2019-12-30 15:56:02

OK, coin and gurobi work, I can't test cplex, but I think it should be OK.
It won't make it into 9.0, so I bumped up the milestone.


---

Comment by dimpase created at 2019-12-30 15:56:22

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2019-12-30 16:08:41

Thank you!


---

Comment by vbraun created at 2020-01-05 15:47:42

Resolution: fixed


---

Comment by slabbe created at 2020-01-05 17:38:37

Sorry, I was late testing this. It works for me with Ubuntu 16.04 running Gurobi 8.1.1 and CPLEX 12.9.

Question: how can I make sure that the tests involing Gurobi and cplex backends continue to work in the next dev versions of SageMath now that those files are gone from the sage library?


---

Comment by mkoeppe created at 2020-01-05 17:43:32

Replying to [comment:68 slabbe]:
> It works for me with Ubuntu 16.04 running Gurobi 8.1.1 and CPLEX 12.9.

Thanks for testing!

> Question: how can I make sure that the tests involing Gurobi and cplex backends continue to work in the next dev versions of SageMath now that those files are gone from the sage library?

The tests are run when you install the new packages with `sage -i -c`.
