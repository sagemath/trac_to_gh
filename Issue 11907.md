# Issue 11907: Two memory leaks in mpmath extension code

Issue created by migration from https://trac.sagemath.org/ticket/12079

Original creator: fredrik.johansson

Original creation time: 2011-11-24 10:44:27

Assignee: rlm

The attached patch fixes two memory leaks triggered by repeatedly calling mpmath.zeta(s) for complex s, as reported on sage-nt. Example:


```
import mpmath

for i in range(200):
    x = mpmath.zetazero(2000)
    print get_memory_usage()
```



---

Attachment

fix memory leak


---

Comment by fredrik.johansson created at 2011-11-24 10:45:08

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-11-24 12:19:30

Nice catch :-)


---

Comment by vbraun created at 2011-11-24 12:19:30

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-27 09:20:17

Resolution: fixed


---

Comment by dimpase created at 2011-12-13 06:27:12

with the patch applied, a slight modification shows another leak:

```
for k in range(100):
    reset(); 
    import mpmath, gc;# 
    gc.collect()
    from mpmath import *
    mp.dps=1000 
    r=randint(50,200)
    ii=mpmath.zetazero(r)
    print r, get_memory_usage()
    ii=mpmath.zetazero(r)
    print r, get_memory_usage()
    ii=mpmath.zetazero(r)
```


here is part of output:

```
0
195 915.9609375
195 915.9609375
0
61 917.12109375
61 917.12109375
0
57 917.765625
57 917.765625
0
64 918.51171875
64 918.51171875
0
179 920.98828125
179 920.98828125
0
80 921.6328125
80 921.6328125
0
62 921.6328125
62 921.6328125
0
169 922.40625
169 922.40625
0
57 922.40625
57 922.40625
0
140 924.0234375
140 924.0234375
0
173 924.0234375
173 924.0234375
0
50 924.0234375
50 924.0234375
```


It does not show if one repeatedly computes the same root of zeta, perhaps meaning that this is a memoization problem...


---

Comment by fredrik.johansson created at 2011-12-13 10:18:04

Yes, I think so. It seems to be stable if you add mpmath.libmp.gammazeta.borwein_cache.clear()


---

Comment by dimpase created at 2011-12-14 00:31:21

Changing assignee from rlm to dimpase.


---

Comment by dimpase created at 2011-12-14 00:35:06

Replying to [comment:5 fredrik.johansson]:
> Yes, I think so. It seems to be stable if you add mpmath.libmp.gammazeta.borwein_cache.clear()

I'm trying to figure out how to reopen this ticket
