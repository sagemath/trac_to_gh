# Issue 32262: OpenSSL 3.0.0 is out !

Issue created by migration from https://trac.sagemath.org/ticket/32499

Original creator: tmonteil

Original creation time: 2021-09-10 13:13:29

OpenSSL 3.0.0 is out !



---

Comment by mkoeppe created at 2021-09-10 17:43:17

New commits:


---

Comment by mkoeppe created at 2021-09-10 17:43:17

Changing status from new to needs_review.


---

Comment by tmonteil created at 2021-09-11 12:55:01

On my side, self-tests pass, pip is usable, data on OEIS can be fetched. For this later however, i have to export `SSL_CERT_DIR` environment variable to `/etc/ssl/certs`. So perhaps there is an issue with `certifi`, not sure if this has to be part of this ticket.


---

Comment by mkoeppe created at 2021-09-11 17:47:58

Replying to [comment:3 tmonteil]:
> data on OEIS can be fetched. For this later however, i have to export `SSL_CERT_DIR` environment variable to `/etc/ssl/certs`. 

Is this different from the behavior without this ticket?


---

Comment by mkoeppe created at 2021-09-11 17:50:03

We currently don't test `optional - internet` tests on GH Actions - should we? See #25536#comment:93


---

Comment by tmonteil created at 2021-09-14 22:48:05

Here are some additional bits: i setup a VM for this ticket, without `openssl` nor `openssl-dev` from the distro (Debian), and with `openssl 3.0.0` spkg installed . However, when i do 


```
sage: import ssl
sage: ssl.OPENSSL_VERSION
```


i got


```
'OpenSSL 1.1.1k  25 Mar 2021'
```


which means that the Python shipped with Sage sometimes links to the `libssl1.1` that is shipped with the distro. This package is needed for important things like `passwd`, `ssh`, `apt`, etc. If i destroy the distro by removing `libssl1.1`, `./configure` aborts with 


```
configure: error: C++ preprocessor "/lib/cpp" fails sanity check
```


Hence, i can not really test `openssl3.0.0` because i will never be sure whether some part of Sage fully uses `openssl 3.0.0`. To really fix the issue i should be able to acces some machine that really needs the `openssl 3.0.0` spkg, namely those for which no openssl is available. I am not sure which OS are concerned, and which Sage dev have such machine available.


---

Comment by tmonteil created at 2021-09-14 22:49:11

By the way, while (the way we use) `urllib` seems not to work with openssl3.0.0, `requests` seems to work well, moreover it is recommended by Python for high-level web operations. Hence, i think we should move from `urllib` to `requests` when fetching online services. This should be part of a dedicated ticket though.


---

Comment by mkoeppe created at 2021-09-14 22:51:08

Replying to [comment:6 tmonteil]:
> Here are some additional bits: i setup a VM for this ticket, without `openssl` nor `openssl-dev` from the distro (Debian), and with `openssl 3.0.0` spkg installed . However, when i do 
> 
> {{{
> sage: import ssl
> sage: ssl.OPENSSL_VERSION
> }}}
> 
> i got
> 
> {{{
> 'OpenSSL 1.1.1k  25 Mar 2021'
> }}}
> 
> which means that the Python shipped with Sage sometimes links to the `libssl1.1` that is shipped with the distro. 

Just test with `./configure --without-system-python3`


---

Comment by mkoeppe created at 2021-09-14 22:51:55

Replying to [comment:7 tmonteil]:
> By the way, while (the way we use) `urllib` seems not to work with openssl3.0.0, 

Details?


---

Comment by tmonteil created at 2021-09-14 22:52:56

Replying to [comment:7 tmonteil]:
> `requests` seems to work well, moreover it is recommended by Python for high-level web operations.

See https://docs.python.org/3/library/urllib.request.html


---

Comment by mkoeppe created at 2021-09-14 23:01:13

I mean details about what failure you observe.


---

Comment by tmonteil created at 2021-09-14 23:08:40

Replying to [comment:11 mkoeppe]:
> I mean details about what failure you observe.

`OSError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate`

You may be right that, since i installed a lot of Sage dependencies, Python 3 might be the one of the distro, hence it is normal that it links with `libssl1.1`. Let me test with a bare VM.


---

Comment by mkoeppe created at 2021-09-14 23:22:24

Replying to [comment:12 tmonteil]:
> Replying to [comment:11 mkoeppe]:
> > I mean details about what failure you observe.
> 
> `OSError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate`

... on what operation?


---

Comment by tmonteil created at 2021-09-14 23:32:46

Replying to [comment:13 mkoeppe]:
> Replying to [comment:12 tmonteil]:
> > Replying to [comment:11 mkoeppe]:
> > > I mean details about what failure you observe.
> > 
> > `OSError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate`
> 
> ... on what operation?

`urllib.request.urlopen` in calling e.g. `oeis(42)`


---

Comment by tmonteil created at 2021-09-16 22:00:55

Replying to [comment:12 tmonteil]:
> Let me test with a bare VM.

I setup a bare VM with the minimal dependencies, in particular no Python 3. I can reproduce the previous error with `urllib` and OpenSSL 3.0.0.


Replying to [comment:4 mkoeppe]: 
> Is this different from the behavior without this ticket?

No, the error appears both with OpenSSL 3.0.0-beta2 and 3.0.0, which means that the introduction of OpenSSL 3.x in Sage was not tested enough.

Hence, since self-tests pass, since 3.0.0 is the first stable release of OpenSSL 3, and since there is no regression compared to the current OpenSSL 3.0.0-beta2, i suggest that we merge this ticket.


---

Comment by tmonteil created at 2021-09-16 22:10:36

The issue about utllib not working with OpenSSL 3.x is addressed at #32527.


---

Comment by mkoeppe created at 2021-09-16 22:24:43

Replying to [comment:15 tmonteil]:
> since self-tests pass, since 3.0.0 is the first stable release of OpenSSL 3, and since there is no regression compared to the current OpenSSL 3.0.0-beta2, i suggest that we merge this ticket.
I agree with this reasoning.


---

Comment by mkoeppe created at 2021-09-16 22:26:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-09-25 23:18:02

Resolution: fixed
