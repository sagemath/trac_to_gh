# Issue 15104: Hashing of GammaH congruence groups is broken

archive/issues_015104.json:
```json
{
    "body": "CC:  tmonteil\n\nTo quote the python reference manual: http://docs.python.org/2/reference/datamodel.html#object.__hash__\n\nThe only required property is that objects which compare equal have the same hash value;\n\nHowever:\n\n```\nG1=GammaH(21,[4])\nG2=GammaH(21,[4,16])\nprint G1==G2\nprint hash(GammaH(21,[4,16]))\nprint hash(GammaH(21,[4]))\n```\n\n\nprints:\n\n\n```\nTrue\n8309769839484863814\n1170799062851396877\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15341\n\n",
    "created_at": "2013-10-29T21:33:26Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Hashing of GammaH congruence groups is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15104",
    "user": "https://github.com/koffie"
}
```
CC:  tmonteil

To quote the python reference manual: http://docs.python.org/2/reference/datamodel.html#object.__hash__

The only required property is that objects which compare equal have the same hash value;

However:

```
G1=GammaH(21,[4])
G2=GammaH(21,[4,16])
print G1==G2
print hash(GammaH(21,[4,16]))
print hash(GammaH(21,[4]))
```


prints:


```
True
8309769839484863814
1170799062851396877
```


Issue created by migration from https://trac.sagemath.org/ticket/15341





---

archive/issue_comments_193343.json:
```json
{
    "body": "It will fail on 32bit systems, this ticket is reviewable if one just keeps in the back of your mind that a doctest needs to be changed for 32bit systems. \n\nHopefully the patchbot will provide the correct value (otherwise we should find someone with a 32 bit system).\n----\nNew commits:",
    "created_at": "2017-08-27T06:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193343",
    "user": "https://github.com/koffie"
}
```

It will fail on 32bit systems, this ticket is reviewable if one just keeps in the back of your mind that a doctest needs to be changed for 32bit systems. 

Hopefully the patchbot will provide the correct value (otherwise we should find someone with a 32 bit system).
----
New commits:



---

archive/issue_comments_193344.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-27T06:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193344",
    "user": "https://github.com/koffie"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_193345.json:
```json
{
    "body": "Author name.",
    "created_at": "2017-08-27T15:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193345",
    "user": "https://github.com/videlec"
}
```

Author name.



---

archive/issue_comments_193346.json:
```json
{
    "body": "Why not\n\n```\nif xK in L:\n    rts_L.append((L(xK), mult))\n```\n",
    "created_at": "2017-08-27T15:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193346",
    "user": "https://github.com/videlec"
}
```

Why not

```
if xK in L:
    rts_L.append((L(xK), mult))
```




---

archive/issue_comments_193347.json:
```json
{
    "body": "Hi thanks for looking at this,\n\nSorry, I should have been more clear. Only commmit b96aa08b6fe8cd1809fd514a37cc48bb6c144e99 is new. Al the other commits are just #23656 so your comment only makes sense for that ticket, and doesn't relate to the code under review here.\n\nDo you happen to know a way to only show the new commits at this ticket? I tried setting #23656 as a dependency. But that doesn't work.",
    "created_at": "2017-08-27T17:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193347",
    "user": "https://github.com/koffie"
}
```

Hi thanks for looking at this,

Sorry, I should have been more clear. Only commmit b96aa08b6fe8cd1809fd514a37cc48bb6c144e99 is new. Al the other commits are just #23656 so your comment only makes sense for that ticket, and doesn't relate to the code under review here.

Do you happen to know a way to only show the new commits at this ticket? I tried setting #23656 as a dependency. But that doesn't work.



---

archive/issue_comments_193348.json:
```json
{
    "body": "My comment does not apply to anything, it was intended for #23726",
    "created_at": "2017-08-27T20:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193348",
    "user": "https://github.com/videlec"
}
```

My comment does not apply to anything, it was intended for #23726



---

archive/issue_comments_193349.json:
```json
{
    "body": "Hi Thierry Monteil,\n\nI saw at https://wiki.sagemath.org/buildbot/owners that you have a 32bit patchbot. Could you test this ticket so that I know what hashes are returned on a 32bit machine.\n\nThanks in advance,\nMaarten",
    "created_at": "2017-08-27T21:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193349",
    "user": "https://github.com/koffie"
}
```

Hi Thierry Monteil,

I saw at https://wiki.sagemath.org/buildbot/owners that you have a 32bit patchbot. Could you test this ticket so that I know what hashes are returned on a 32bit machine.

Thanks in advance,
Maarten



---

archive/issue_comments_193350.json:
```json
{
    "body": "I am compiling your branch on a 32bit VM running Debian stretch. Which files chould i doctest ?",
    "created_at": "2017-08-29T16:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193350",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

I am compiling your branch on a 32bit VM running Debian stretch. Which files chould i doctest ?



---

archive/issue_comments_193351.json:
```json
{
    "body": "Thanks, the file is `src/sage/modular/arithgroup/arithgroup_generic.py`",
    "created_at": "2017-08-29T17:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193351",
    "user": "https://github.com/koffie"
}
```

Thanks, the file is `src/sage/modular/arithgroup/arithgroup_generic.py`



---

archive/issue_comments_193352.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-29T22:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193352",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_193353.json:
```json
{
    "body": "I got : \n\n\n```\nsagemath@tmonteil-debian-stretch-32:/opt/sagemath/sage-8.0$ ./sage -t src/sage/modular/arithgroup/arithgroup_generic.py\nForcing sage-location, probably because a new package was installed.\nCleaning up, do not interrupt this.\nDone cleaning.\nRunning doctests with ID 2017-08-29-22-50-23-b6ae0811.\nGit branch: develop\nUsing --optional=4ti2,benzene,bliss,buckygen,cbc,ccache,cmake,coxeter3,cryptominisat,csdp,d3js,database_gap,database_pari,frobby,gambit,gap_jupyter,gap_packages,gdb,giacpy_sage,gmpy2,gp2c,igraph,latte_int,libbraiding,libhomfly,libogg,lidia,lrslib,mcqd,meataxe,mpir,normaliz,ore_algebra,pandoc_attributes,pandocfilters,pari_jupyter,plantri,pynormaliz,pysingular,python2,python_igraph,qepcad,rst2ipynb,saclib,sage,scons,singular_jupyter,sip,sirocco,tdlib,termcap,tides,topcom\nDoctesting 1 file.\nsage -t --warn-long 47.4 src/sage/modular/arithgroup/arithgroup_generic.py\n**********************************************************************\nFile \"src/sage/modular/arithgroup/arithgroup_generic.py\", line 199, in sage.modular.arithgroup.arithgroup_generic.ArithmeticSubgroup.__hash__\nFailed example:\n    Gamma0(11).__hash__()\nExpected:\n    -545929996 \nGot:\n    118770652\n**********************************************************************\nFile \"src/sage/modular/arithgroup/arithgroup_generic.py\", line 202, in sage.modular.arithgroup.arithgroup_generic.ArithmeticSubgroup.__hash__\nFailed example:\n    Gamma1(11).__hash__()\nExpected:\n    -830809815 \nGot:\n    201042552\n**********************************************************************\n1 item had failures:\n   2 of   8 in sage.modular.arithgroup.arithgroup_generic.ArithmeticSubgroup.__hash__\n    [159 tests, 2 failures, 5.60 s]\n----------------------------------------------------------------------\nsage -t --warn-long 47.4 src/sage/modular/arithgroup/arithgroup_generic.py  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 5.7 seconds\n    cpu time: 3.5 seconds\n    cumulative wall time: 5.6 seconds\n```\n\n\nWhich is consistent with your latest commit.",
    "created_at": "2017-08-29T22:52:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193353",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

I got : 


```
sagemath@tmonteil-debian-stretch-32:/opt/sagemath/sage-8.0$ ./sage -t src/sage/modular/arithgroup/arithgroup_generic.py
Forcing sage-location, probably because a new package was installed.
Cleaning up, do not interrupt this.
Done cleaning.
Running doctests with ID 2017-08-29-22-50-23-b6ae0811.
Git branch: develop
Using --optional=4ti2,benzene,bliss,buckygen,cbc,ccache,cmake,coxeter3,cryptominisat,csdp,d3js,database_gap,database_pari,frobby,gambit,gap_jupyter,gap_packages,gdb,giacpy_sage,gmpy2,gp2c,igraph,latte_int,libbraiding,libhomfly,libogg,lidia,lrslib,mcqd,meataxe,mpir,normaliz,ore_algebra,pandoc_attributes,pandocfilters,pari_jupyter,plantri,pynormaliz,pysingular,python2,python_igraph,qepcad,rst2ipynb,saclib,sage,scons,singular_jupyter,sip,sirocco,tdlib,termcap,tides,topcom
Doctesting 1 file.
sage -t --warn-long 47.4 src/sage/modular/arithgroup/arithgroup_generic.py
**********************************************************************
File "src/sage/modular/arithgroup/arithgroup_generic.py", line 199, in sage.modular.arithgroup.arithgroup_generic.ArithmeticSubgroup.__hash__
Failed example:
    Gamma0(11).__hash__()
Expected:
    -545929996 
Got:
    118770652
**********************************************************************
File "src/sage/modular/arithgroup/arithgroup_generic.py", line 202, in sage.modular.arithgroup.arithgroup_generic.ArithmeticSubgroup.__hash__
Failed example:
    Gamma1(11).__hash__()
Expected:
    -830809815 
Got:
    201042552
**********************************************************************
1 item had failures:
   2 of   8 in sage.modular.arithgroup.arithgroup_generic.ArithmeticSubgroup.__hash__
    [159 tests, 2 failures, 5.60 s]
----------------------------------------------------------------------
sage -t --warn-long 47.4 src/sage/modular/arithgroup/arithgroup_generic.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 5.7 seconds
    cpu time: 3.5 seconds
    cumulative wall time: 5.6 seconds
```


Which is consistent with your latest commit.



---

archive/issue_comments_193354.json:
```json
{
    "body": "Replying to [comment:12 mderickx]:\n> Hi Thierry Monteil,\n> \n> I saw at https://wiki.sagemath.org/buildbot/owners that you have a 32bit patchbot. Could you test this ticket so that I know what hashes are returned on a 32bit machine.\n\nHashing on a 32 bit is just the same thing but modulo `2^32`\n\n```\nsage: 3713075136762760156 % (2**32)\n118770652\n```\n\n(though the result are in (-2<sup>31</sup>, 2<sup>31</sup>])",
    "created_at": "2017-09-01T23:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193354",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:12 mderickx]:
> Hi Thierry Monteil,
> 
> I saw at https://wiki.sagemath.org/buildbot/owners that you have a 32bit patchbot. Could you test this ticket so that I know what hashes are returned on a 32bit machine.

Hashing on a 32 bit is just the same thing but modulo `2^32`

```
sage: 3713075136762760156 % (2**32)
118770652
```

(though the result are in (-2<sup>31</sup>, 2<sup>31</sup>])



---

archive/issue_comments_193355.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-06T05:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193355",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_193356.json:
```json
{
    "body": "ok",
    "created_at": "2017-09-06T05:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193356",
    "user": "https://github.com/fchapoton"
}
```

ok



---

archive/issue_comments_193357.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T22:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15104#issuecomment-193357",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
