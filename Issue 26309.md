# Issue 26309: matrix_gfpn_dense: exceptions ignored in field_to_int()

Issue created by migration from https://trac.sagemath.org/ticket/26546

Original creator: jdemeyer

Original creation time: 2018-10-24 09:45:15

CC:  simonking


```
sage: from sage.matrix.matrix_gfpn_dense import PrimeFieldConverter_class
sage: C = PrimeFieldConverter_class(GF(5))
sage: C.field_to_int("foo")
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
ValueError: invalid literal for int() with base 10: 'foo'
Exception ValueError: "invalid literal for int() with base 10: 'foo'" in 'sage.matrix.matrix_gfpn_dense.PrimeFieldConverter_class.field_to_int' ignored
0
```


Maybe all calls to `field_to_int` are done safely such that doesn't occur in practice. But still, it seems safer to have proper exception handling here.

The easiest solution seems to be to return a Python object from `field_to_int` and do the conversion to `int` later.


---

Comment by jdemeyer created at 2018-10-24 10:05:16

Simon, what you do think about this:

> I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.


---

Comment by SimonKing created at 2018-10-24 10:28:18

Replying to [comment:3 jdemeyer]:
> Simon, what you do think about this:
> 
> > I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.

That seems to make sense.

If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.


---

Comment by jdemeyer created at 2018-10-24 10:33:39

Replying to [comment:4 SimonKing]:
> If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.

My plan was to change this to take a `FEL` as argument and return a `FEL` and then use `except? 255`. If you agree, I'll make that change.


---

Comment by SimonKing created at 2018-10-24 10:38:32

Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 SimonKing]:
> > If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.
> 
> My plan was to change this to take a `FEL` as argument and return a `FEL` and then use `except? 255`. If you agree, I'll make that change.

Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.

In any case, if you have a function returning FEL, you can do `except 255` without `?`, as the size of a field is at most 251.


---

Comment by jdemeyer created at 2018-10-24 11:50:57

Replying to [comment:6 SimonKing]:
> Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.

Yes, that's exactly what I meant: replace `int` by `FEL`.


---

Comment by SimonKing created at 2018-10-24 11:58:08

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 SimonKing]:
> > Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.
> 
> Yes, that's exactly what I meant: replace `int` by `FEL`.

OK, as long as you do not want to change the input of `field_to_int` or the output of `int_to_field`, because that would clearly be a Sage object (element of `GF(25,'x')`, for example).

Then, it should probably be called `field_to_fel` and `fel_to_field`. How could these be doc tested, as FEL is a C type?


---

Comment by jdemeyer created at 2018-10-24 12:12:11

Replying to [comment:8 SimonKing]:
> How could these be doc tested, as FEL is a C type?

Well, `int` is also a C type and you're already testing that...


---

Comment by SimonKing created at 2018-10-24 12:14:20

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 SimonKing]:
> > How could these be doc tested, as FEL is a C type?
> 
> Well, `int` is also a C type and you're already testing that...

Sure. Actually I thought it already is a problem if one renames a C type to some equivalent type. But if that's not a problem, then FEL certainly is the way to go.


---

Comment by git created at 2018-10-26 08:47:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-10-26 08:48:28

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-10-26 10:28:07

What does "cdef readonly" mean?


---

Comment by SimonKing created at 2018-10-26 10:31:42

This comment

```
.. WARNING::

        Before calling the ``fel_to_field`` or ``field_to_fel`` methods,
        one should call the ``FfSetField`` function.
```

(appearing at least twice) looks potentially confusing. The user might ask, HOW to call ``FfSetField``. Since it's a C library function, the user cannot call it, unless she writes Cython code.


---

Comment by jdemeyer created at 2018-10-26 11:36:20

Replying to [comment:15 SimonKing]:
> What does "cdef readonly" mean?

Accessible from Python, but read-only (contrary to `cdef public` which is read-write)


---

Comment by jdemeyer created at 2018-10-26 11:38:23

Replying to [comment:16 SimonKing]:
> Since it's a C library function, the user cannot call it, unless she writes Cython code.

The whole thing is only really useful for Cython anyway... but I see your point.


---

Comment by git created at 2018-10-29 18:55:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2018-11-02 12:41:49

The changes look good to me and the tests at least in sage/matrix pass. Later I will run a complete test, and if that works it will be positive review.


---

Comment by SimonKing created at 2018-11-02 23:41:39

Tests pass, so, here is the previously announced positive review.


---

Comment by SimonKing created at 2018-11-02 23:41:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-11-06 21:34:01

See patchbot

```
sage -t --long src/sage/matrix/matrix_gfpn_dense.pyx  # 2 doctests failed
```



---

Comment by vbraun created at 2018-11-06 21:34:01

Changing status from positive_review to needs_work.


---

Comment by SimonKing created at 2018-11-06 21:51:45

Replying to [comment:22 vbraun]:
> See patchbot
> {{{
> sage -t --long src/sage/matrix/matrix_gfpn_dense.pyx  # 2 doctests failed
> }}}

Right, that test lacks `# optional: meataxe`. So, that test will fail if and only if meataxe is not installed (that's why that error didn't occur for me).


---

Comment by SimonKing created at 2018-12-04 08:19:19

Changing status from needs_work to positive_review.


---

Comment by SimonKing created at 2018-12-04 08:19:19

I just noticed that the forgotten "# optional" still hasn't been added.

Fixed, tests pass now with and without optional meataxe. I suppose I can return to giving a positive review, as the new commit can be considered a "reviewer patch".
----
New commits:


---

Comment by jdemeyer created at 2018-12-04 10:44:41

If it passes tests, sure.


---

Comment by vbraun created at 2018-12-07 12:10:43

Resolution: fixed
