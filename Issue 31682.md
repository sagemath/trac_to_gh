# Issue 31682: ABC for convex sets

Issue created by migration from https://trac.sagemath.org/ticket/31919

Original creator: mkoeppe

Original creation time: 2021-06-06 21:57:32

CC:  @kliem yzh jipilab tscrim novoselt mjo

We create a base class `ConvexSet_base` with abstract methods to define an API for convex sets (convex subsets of a finite dimensional topological R-vector space such as `R^n`).

We use it to test/unify the API of `Polyhedron`, `ConvexRationalPolyhedralCone`, `LatticePolytope`, `RelativeInterior` (#31916)


---

Comment by git created at 2021-06-07 05:56:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 19:54:06

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-06-07 20:02:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 23:26:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 23:47:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-07 23:48:36

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-06-08 18:12:40

Missing doctest.


```
+    def is_empty(self):
+        """
+        Return whether ``self`` is the empty set.
+
+        Because a cone always contains the origin, this method returns ``False``.
+        """
+        return False
```



---

Comment by @kliem created at 2021-06-08 18:12:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-08 20:33:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-06-09 06:11:52

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-06-09 06:11:52

I guess it is back on needs review.


---

Comment by @kliem created at 2021-06-09 17:49:25

Can you please add doctests for `src/sage/geometry/convex_set.py` yet.


---

Comment by git created at 2021-06-10 18:53:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-10 19:00:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-11 00:23:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-11 00:24:23

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-06-11 01:39:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-11 04:59:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-06-12 12:30:54

New commits:


---

Comment by @kliem created at 2021-06-12 13:01:12

- I don't think `ambient_dimension` should return the dimension of ``self``.

```diff
+    def ambient_dimension(self):
+        Return the dimension of ``self``.
+
+        This is the same as :meth:`ambient_dim`.
```

- That `codim` is an alias of `codimension` should be doctested I think. 
- Why have you removed the test suite on the relative interior of the empty polyhedron?

```diff
-            sage: P = Polyhedron()
+            sage: P = Polyhedron([[1, 2], [3, 4]])
             sage: from sage.geometry.relative_interior import RelativeInterior
             sage: TestSuite(RelativeInterior(P)).run()
```

  Would it make sense to run the test suite on relative interior of polyhedra as part of the standard polyhedron test suite? Just like in #31821.
- Cartesian product is now a new alias of product. This should be doctested with a tiny doctest I think.


---

Comment by mkoeppe created at 2021-06-12 13:52:08

Thanks for these fixes and suggestions!


---

Comment by mkoeppe created at 2021-06-12 13:53:22

Replying to [comment:25 gh-kliem]:
> - Why have you removed the test suite on the relative interior of the empty polyhedron?

The reason for this is the assumption in `is_closed`


---

Comment by @kliem created at 2021-06-12 15:54:31

Replying to [comment:28 mkoeppe]:
> Replying to [comment:25 gh-kliem]:
> > - Why have you removed the test suite on the relative interior of the empty polyhedron?
> 
> The reason for this is the assumption in `is_closed`

I see. I think it should be fixed then. Either we drop the requirement of being identical in the test suite or we add another clause for `Polyhedron_base.relative_interior`:


```diff
    if not self.is_full_dimensional():
+       if self.is_empty():
+           return self
        return self.parent().element_class(self.parent(), None, None)
    return self.relative_interior()
```

----
New commits:


---

Comment by @kliem created at 2021-06-12 16:03:20

Replying to [comment:24 gh-kliem]:
> New commits:
> ||[c75ba42](https://git.sagemath.org/sage.git/commit?id=c75ba428cd91e71a8b237602a3529b936eb6d965)||`fix coverage`||

Please fix coverage or cherry-pick the above commit.

It's trivial, I see no need to add me as an author. Of course this case is trivial. But if we allow people to not test trivial things, where do we draw the line?

This is one reason why I improved `sage --fixdoctests` to work for error messages as well.


---

Comment by mkoeppe created at 2021-06-12 16:11:30

Sorry, forgot to pull in your changes


---

Comment by git created at 2021-06-12 16:14:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-12 16:21:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-12 16:33:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-12 16:34:24

Replying to [comment:30 gh-kliem]:
> Replying to [comment:28 mkoeppe]:
> > Replying to [comment:25 gh-kliem]:
> > > - Why have you removed the test suite on the relative interior of the empty polyhedron?
> > 
> > The reason for this is the assumption in `is_closed`
> 
> I see. I think it should be fixed then. Either we drop the requirement of being identical in the test suite or we add another clause for `Polyhedron_base.relative_interior`:
> 
> {{{#!diff
>     if not self.is_full_dimensional():
> +       if self.is_empty():
> +           return self
>         return self.parent().element_class(self.parent(), None, None)
>     return self.relative_interior()
> }}}

I have made a similar fix


---

Comment by mkoeppe created at 2021-06-12 16:34:57

Replying to [comment:31 gh-kliem]:
> This is one reason why I improved `sage --fixdoctests` to work for error messages as well.

Yes, this was a great improvement!


---

Comment by git created at 2021-06-12 16:40:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-06-12 18:16:38


```
sage -t --long --warn-long 111.1 --random-seed=0 relative_interior.py
**********************************************************************
File "relative_interior.py", line 82, in sage.geometry.relative_interior.RelativeInterior.ambient
Failed example:
    ri_segment.ambient()
Exception raised:
    Traceback (most recent call last):
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.relative_interior.RelativeInterior.ambient[2]>", line 1, in <module>
        ri_segment.ambient()
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/relative_interior.py", line 84, in ambient
        return self._polyhedron.ambient()
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/base_ZZ.py", line 51, in __getattribute__
        return super(Polyhedron_ZZ, self).__getattribute__(name)
      File "sage/structure/element.pyx", line 493, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4708)
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 506, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4820)
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 367, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2551)
        raise AttributeError(dummy_error_message)
    AttributeError: 'Polyhedra_ZZ_ppl_with_category.element_class' object has no attribute 'ambient'
**********************************************************************
File "relative_interior.py", line 96, in sage.geometry.relative_interior.RelativeInterior.ambient_vector_space
Failed example:
    ri_segment.ambient_vector_space()
Exception raised:
    Traceback (most recent call last):
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.relative_interior.RelativeInterior.ambient_vector_space[2]>", line 1, in <module>
        ri_segment.ambient_vector_space()
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/relative_interior.py", line 98, in ambient_vector_space
        return self._polyhedron.ambient_vector_space(base_field=base_field)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/base_ZZ.py", line 51, in __getattribute__
        return super(Polyhedron_ZZ, self).__getattribute__(name)
      File "sage/structure/element.pyx", line 493, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4708)
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 506, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4820)
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 367, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2551)
        raise AttributeError(dummy_error_message)
    AttributeError: 'Polyhedra_ZZ_ppl_with_category.element_class' object has no attribute 'ambient_vector_space'
**********************************************************************
2 items had failures:
   1 of   4 in sage.geometry.relative_interior.RelativeInterior.ambient
   1 of   4 in sage.geometry.relative_interior.RelativeInterior.ambient_vector_space
    [59 tests, 2 failures, 0.13 s]
----------------------------------------------------------------------
sage -t --long --warn-long 111.1 --random-seed=0 relative_interior.py  # 2 doctests failed
```



---

Comment by @kliem created at 2021-06-12 18:16:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-12 19:46:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-06-12 19:47:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-12 19:47:58

Cherry-picking 1448835 from #31959 was a mistake, thanks for catching this.
Let's see what the patchbot thinks now


---

Comment by mkoeppe created at 2021-06-13 02:48:03

Patchbot is green modulo the unrelated `src/sage/misc/package.py` failure


---

Comment by @kliem created at 2021-06-13 06:15:21

We could replace the imports in `lattice_polytope.py` and `cone.py` by lazy imports:


```
========== startup_modules ==========

--- 9.4.beta1

+++ 9.4.beta1 + #31919


-Total count: 1762
+Total count: 1764
+New:
+sage.geometry.convex_set
+    sage.geometry.relative_interior
+====================

+sage.geometry.convex_set

+sage.geometry.relative_interior

-startup_modules Passed
+startup_modules Failed
```



---

Comment by mkoeppe created at 2021-06-13 06:17:09

Fine with me if you want to make this change


---

Comment by mkoeppe created at 2021-06-13 14:21:43

Actually I think after #31705 this won't matter


---

Comment by @kliem created at 2021-06-14 06:24:18

Replying to [comment:45 mkoeppe]:
> Actually I think after #31705 this won't matter

Yes, that's right.


---

Comment by @kliem created at 2021-06-14 07:01:54

One tiny thing about `RelativeInterior.interior`: It should return `self`, if the relative interior is full-dimensional. This is currently the case, because the method `relative_interior` is cached for polyhedra and cones. Maybe it is cleaner to immediately catch the case. But it is not really needed.

Either way, LGTM.


---

Comment by @kliem created at 2021-06-14 07:01:54

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-14 07:07:43

Thank you!

We can make refinements to `RelativeInterior` in a later ticket. For now I prefer the version as is.


---

Comment by vbraun created at 2021-06-29 17:40:23

Resolution: fixed
