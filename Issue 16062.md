# Issue 16062: upgrade numpy/scipy to 1.8.1 and 0.14

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2014-05-07 01:42:37

Upgrade numpy/scipy to latest versions. scipy 0.14 has finally ditched oldnumeric which means it won't generate warnings all over the place. A few doctests will have to be updated.


---

Comment by fbissey created at 2014-05-09 10:59:24

OK so it


---

Comment by fbissey created at 2014-05-09 11:05:52

Woopsie. Anyway I have updated the checksums and SPKG.txt for numpy and scipy. No changes where necessary to the packages themselves as far as I could tell. I fixed three doctests:
 * src/sage/functions/exp_integral.py: the last digit of a test changed, I put "..." since it is probably a little unstable.
 * src/sage/numerical/optimize.py: also a numerical precision thing. In this case we ask for a value within 0.0001 tolerance but tests the answer to 16 decimal places. No surprise when we have changes behind the 5th place.
 * src/sage/modules/vector_double_dense.pyx: a doctest warning has changed code.


---

Comment by fbissey created at 2014-05-09 11:05:52

Changing status from new to needs_review.


---

Comment by dunfield created at 2014-05-16 15:10:41

I tried out this branch and the new packages with Sage 6.2 on two systems: OX Mavericks and RHEL 6.3 (gcc 4.4).  Both numpy and scipy installed cleanly and the three modified doctests passed on both systems.  Other changes in the patch look fine, so setting status to "positive review".


---

Comment by dunfield created at 2014-05-16 15:10:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-21 10:51:03

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-05-21 10:51:03

Breaks doctests on OSX (10.6 and 10.9):

```
sage -t --long src/sage/tests/french_book/calculus_doctest.py
**********************************************************************
File "src/sage/tests/french_book/calculus_doctest.py", line 216, in sage.tests.french_book.calculus_doctest
Failed example:
    find_root(expr, 0.1, pi)
Expected:
    2.0943951023931957
Got:
    2.0943951023931953
```



---

Comment by fbissey created at 2014-05-21 10:59:39

OK, will amend that. Any other failures I missed?


---

Comment by git created at 2014-05-21 22:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2014-05-21 22:56:52

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2014-05-21 22:56:52

OK fixed the doctest and pushed. Ready for another round of review.


---

Comment by vbraun created at 2014-05-21 23:21:12

I don't see any reason why this should give a different result on OSX. Do you?


---

Comment by fbissey created at 2014-05-22 00:04:48

Not sure. We are talking about a difference in the 4E-16 which is in the relative tolerance of the function and well within its own tolerance.

```
def find_root(f, a, b, xtol=10e-13, rtol=4.5e-16, maxiter=100, full_output=False):
```

But I would have been more ready to accept a difference based on CPU arch rather than OS on similar CPU. 

Looking at scipy the underlying c code hasn't changed since 2008 but higher up tolerance checking has been enforced in 0.14rc2 (scipy/optimize/zeros.py) that's the only thing I can see having an impact.


---

Comment by dunfield created at 2014-05-22 01:01:03

Changing status from needs_review to positive_review.


---

Comment by dunfield created at 2014-05-22 01:01:03

I did a little testing, and definitely the issue is a result of the scipy upgrade and not the numpy one.  It also shows up on OS X version 10.8 as well.  

My experience is that the last digit in numerics like this can be remarkably sensitive to the OS/CPU/compiler version/phase of the moon.  I once had two Ubuntu 12.04 virtual machines running on the same physical hardware where the last digit differed like this; one had a 32bit kernel and the other a 64bit one, which you wouldn't think would make a difference...

I think this sort of thing is to be expected, and it certainly seems harmless enough in this instance.   So I've changed the status back to "positive review".


---

Comment by fbissey created at 2014-05-22 01:07:05

Replying to [comment:15 dunfield]:
> I did a little testing, and definitely the issue is a result of the scipy upgrade and not the numpy one.  It also shows up on OS X version 10.8 as well.  
> 
> My experience is that the last digit in numerics like this can be remarkably sensitive to the OS/CPU/compiler version/phase of the moon.  I once had two Ubuntu 12.04 virtual machines running on the same physical hardware where the last digit differed like this; one had a 32bit kernel and the other a 64bit one, which you wouldn't think would make a difference...
> 

Oh, yes I would. But then I have seen tickets where that happens in the last 6 years.

> I think this sort of thing is to be expected, and it certainly seems harmless enough in this instance.   So I've changed the status back to "positive review".  

It is technically harmless it is however a curiosity because the change is sudden. If I had time I would check other versions of scipy to narrow down when the change happened and try to understand why.


---

Comment by fbissey created at 2014-05-22 02:31:02

In the end I spent the time checking [https://github.com/scipy/scipy/commit/8edf03864b7c3e43e652ac154f98e96ee4913687](https://github.com/scipy/scipy/commit/8edf03864b7c3e43e652ac154f98e96ee4913687) and [https://github.com/scipy/scipy/commit/0ee24117ad63399b7a3353269de4e916fe409ad7](https://github.com/scipy/scipy/commit/0ee24117ad63399b7a3353269de4e916fe409ad7) are responsible. I didn't try to pin it on one or the other. So it looks like we approch the root slightly differently between OS X and linux. My guess is that without the enforcement of tolerance OS X would go through one (or) more iteration(s) and end up with the same value as Linux.


---

Comment by vbraun created at 2014-05-23 11:30:51

Resolution: fixed
