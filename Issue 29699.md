# Issue 29699: Fix precicion errors in geometry

archive/issues_029699.json:
```json
{
    "body": "CC:  @slel @orlitzky @tscrim @greglaun jhonrubia6\n\nThere are some claims in doctests of `geometry/hyperbolic_space/hyperbolic_geodesic.py` about precicion that simply don't hold unless you get lucky.\n\nAlso there is an equality in `geometry/hyperbolic_space/hyperbolic_point.py` that doesn't always hold.\n\nWe fix those tests to also hold at random state.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29936\n\n",
    "created_at": "2020-06-22T15:12:39Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Fix precicion errors in geometry",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29699",
    "user": "https://github.com/kliem"
}
```
CC:  @slel @orlitzky @tscrim @greglaun jhonrubia6

There are some claims in doctests of `geometry/hyperbolic_space/hyperbolic_geodesic.py` about precicion that simply don't hold unless you get lucky.

Also there is an equality in `geometry/hyperbolic_space/hyperbolic_point.py` that doesn't always hold.

We fix those tests to also hold at random state.

Issue created by migration from https://trac.sagemath.org/ticket/29936





---

archive/issue_comments_421306.json:
```json
{
    "body": "The first thing is to use the flag `# abs tol` to obtain more meaningful doctest failures at random states. I get the following (not all during the same run):\n\n\n```\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 912, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesic.perpendicular_bisector\nFailed example:\n    abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())  # abs tol 1e-9\nExpected:\n    0\nGot:\n    0.309903204800636\nTolerance exceeded:\n    0 vs 0.309903204800636, tolerance 4e-1 > 1e-9\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1376, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP.perpendicular_bisector\nFailed example:\n    abs(c(g.intersection(h)[0]) - c(g.midpoint()))  # abs tol 1e-9\nExpected:\n    0\nGot:\n    9.74965482957673\nTolerance exceeded:\n    0 vs 9.74965482957673, tolerance 1e1 > 1e-9\n\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix\nFailed example:\n    abs(moebius_transform(A, p1))  # abs tol 1e-9\nExpected:\n    0\nGot:\n    1.82859072578637\nTolerance exceeded:\n    0 vs 1.82859072578637, tolerance 2e0 > 1e-9\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1916, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix\nFailed example:\n    abs(moebius_transform(A, p2) - 1)  # abs tol 1e-9\nExpected:\n    0\nGot:\n    0.619923876802936\nTolerance exceeded:\n    0 vs 0.619923876802936, tolerance 7e-1 > 1e-9\n```\n\n\nThis tells me that the preciseness that is claimed with the doctests is far from valid. \n----\nNew commits:",
    "created_at": "2020-06-22T15:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421306",
    "user": "https://github.com/kliem"
}
```

The first thing is to use the flag `# abs tol` to obtain more meaningful doctest failures at random states. I get the following (not all during the same run):


```
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 912, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesic.perpendicular_bisector
Failed example:
    abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())  # abs tol 1e-9
Expected:
    0
Got:
    0.309903204800636
Tolerance exceeded:
    0 vs 0.309903204800636, tolerance 4e-1 > 1e-9
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1376, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP.perpendicular_bisector
Failed example:
    abs(c(g.intersection(h)[0]) - c(g.midpoint()))  # abs tol 1e-9
Expected:
    0
Got:
    9.74965482957673
Tolerance exceeded:
    0 vs 9.74965482957673, tolerance 1e1 > 1e-9

**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix
Failed example:
    abs(moebius_transform(A, p1))  # abs tol 1e-9
Expected:
    0
Got:
    1.82859072578637
Tolerance exceeded:
    0 vs 1.82859072578637, tolerance 2e0 > 1e-9
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1916, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix
Failed example:
    abs(moebius_transform(A, p2) - 1)  # abs tol 1e-9
Expected:
    0
Got:
    0.619923876802936
Tolerance exceeded:
    0 vs 0.619923876802936, tolerance 7e-1 > 1e-9
```


This tells me that the preciseness that is claimed with the doctests is far from valid. 
----
New commits:



---

archive/issue_comments_421307.json:
```json
{
    "body": "I know very little about numerics. From what I remember it makes sense to consider the relative error as well:\n\n\n\n\n```\nsage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform\nsage: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP\nsage: UHP = HyperbolicPlane().UHP()\nsage: def foo():\n....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\n....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\n....:     a = abs(moebius_transform(A, p1))\n....:     b = abs((moebius_transform(A, p2) - 1))\n....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()\n....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)\n....: \nsage: max(foo()[1] for _ in range(1000))\n0.157952578757514\nsage: max(foo()[0] for _ in range(1000))\n0.0615941849084595\n```\n\n\nThe situation is far worse with the other two tests, which are essentially the same, if I understand correctly:\n\n\n```\nsage: def foo():\n....:     g = HyperbolicPlane().PD().random_geodesic()\n....:     h = g.perpendicular_bisector()\n....:     error = abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())\n....:     sum_of_norms = h.intersection(g)[0].coordinates().norm() + g.midpoint().coordinates().norm()\n....:     return min(error, error/sum_of_norms)\n....: \nsage: max(foo() for _ in range(10))\n0.908342722333419\n```\n",
    "created_at": "2020-06-22T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421307",
    "user": "https://github.com/kliem"
}
```

I know very little about numerics. From what I remember it makes sense to consider the relative error as well:




```
sage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform
sage: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP
sage: UHP = HyperbolicPlane().UHP()
sage: def foo():
....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
....:     a = abs(moebius_transform(A, p1))
....:     b = abs((moebius_transform(A, p2) - 1))
....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()
....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)
....: 
sage: max(foo()[1] for _ in range(1000))
0.157952578757514
sage: max(foo()[0] for _ in range(1000))
0.0615941849084595
```


The situation is far worse with the other two tests, which are essentially the same, if I understand correctly:


```
sage: def foo():
....:     g = HyperbolicPlane().PD().random_geodesic()
....:     h = g.perpendicular_bisector()
....:     error = abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())
....:     sum_of_norms = h.intersection(g)[0].coordinates().norm() + g.midpoint().coordinates().norm()
....:     return min(error, error/sum_of_norms)
....: 
sage: max(foo() for _ in range(10))
0.908342722333419
```




---

archive/issue_comments_421308.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-22T18:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421308",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421309.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-22T18:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421309",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421310.json:
```json
{
    "body": "I tested 10 times and not a single test failed. I hope that is good enough.",
    "created_at": "2020-06-22T18:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421310",
    "user": "https://github.com/kliem"
}
```

I tested 10 times and not a single test failed. I hope that is good enough.



---

archive/issue_comments_421311.json:
```json
{
    "body": "Changing keywords from \"\" to \"hyperbolic geodesic, hyperbolic point\".",
    "created_at": "2020-06-22T18:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421311",
    "user": "https://github.com/kliem"
}
```

Changing keywords from "" to "hyperbolic geodesic, hyperbolic point".



---

archive/issue_comments_421312.json:
```json
{
    "body": "I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n\nFor something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?",
    "created_at": "2020-07-12T19:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421312",
    "user": "https://github.com/orlitzky"
}
```

I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.

For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?



---

archive/issue_comments_421313.json:
```json
{
    "body": "Theoretically, there is not need to base this on top of #29962. But basically #29962 discovers those problems. So the doctest works fine until you test it on top of #29962 with a different random seed than 0.\n----\nLast 10 new commits:",
    "created_at": "2020-07-12T20:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421313",
    "user": "https://github.com/kliem"
}
```

Theoretically, there is not need to base this on top of #29962. But basically #29962 discovers those problems. So the doctest works fine until you test it on top of #29962 with a different random seed than 0.
----
Last 10 new commits:



---

archive/issue_comments_421314.json:
```json
{
    "body": "Replying to [comment:6 mjo]:\n> I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\nI agree. That's why I opened #29939 to fix this.\n> \n> For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?\n\nI agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read. But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).",
    "created_at": "2020-07-12T20:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421314",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:6 mjo]:
> I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.
I agree. That's why I opened #29939 to fix this.
> 
> For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?

I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read. But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).



---

archive/issue_comments_421315.json:
```json
{
    "body": "Replying to [comment:9 gh-kliem]:\n> Replying to [comment:6 mjo]:\n> > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n> I agree. That's why I opened #29939 to fix this.\n\nIt looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.\n\n> > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?\n> \n> I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.\n\nI disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.\n\n> But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).\n\nYou have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.",
    "created_at": "2020-07-12T23:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421315",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:9 gh-kliem]:
> Replying to [comment:6 mjo]:
> > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.
> I agree. That's why I opened #29939 to fix this.

It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.

> > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?
> 
> I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.

I disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.

> But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).

You have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.



---

archive/issue_comments_421316.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> \n> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.\n\nThe original tests also fail if you introduce any randomness at all. I'm mainly concerned about the errors that Jonathan noticed right away, e.g.\n\n\n```\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix\nFailed example:\n    abs(moebius_transform(A, p1))  # abs tol 1e-9\nExpected:\n    0\nGot:\n    1.82859072578637\nTolerance exceeded:\n    0 vs 1.82859072578637, tolerance 2e0 > 1e-9\n```\n\n\nIf you have a method that's supposed to return zero but instead returns two, something other than numerical noise might be to blame. Can that test be re-run with a failing random seed, to see what a failing example looks like?",
    "created_at": "2020-07-13T01:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421316",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:10 tscrim]:
> 
> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.

The original tests also fail if you introduce any randomness at all. I'm mainly concerned about the errors that Jonathan noticed right away, e.g.


```
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix
Failed example:
    abs(moebius_transform(A, p1))  # abs tol 1e-9
Expected:
    0
Got:
    1.82859072578637
Tolerance exceeded:
    0 vs 1.82859072578637, tolerance 2e0 > 1e-9
```


If you have a method that's supposed to return zero but instead returns two, something other than numerical noise might be to blame. Can that test be re-run with a failing random seed, to see what a failing example looks like?



---

archive/issue_comments_421317.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> Replying to [comment:9 gh-kliem]:\n> > Replying to [comment:6 mjo]:\n> > > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n> > I agree. That's why I opened #29939 to fix this.\n> \n> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.\n> \n> > > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?\n> > \n> > I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.\n> \n> I disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.\n> \n> > But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).\n> \n> You have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.\n\nI'm taking the minimum of the absolute and the relative error, because I want to be fair. This makes it much better. This is the original test:\n\n```\nsage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform\n....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP\n....: UHP = HyperbolicPlane().UHP()\n....: def foo():\n....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\n....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\n....:     a = abs(moebius_transform(A, p1))\n....:     b = abs((moebius_transform(A, p2) - 1))\n....:     return (a,b)\n....: \nsage: max(foo()[1] for _ in range(1000))\n19.6483996640312\nsage: max(foo()[0] for _ in range(1000))\n76.0110826766808\n```\n\n\nHere are examples that perform bad. I hope you see, why I chose to change the doctest to minimum of absolute and relative norm:\n\n```\nsage: (p1, p2, p3) = (-2.29920829511711 + 5.52937627459424*I, -2.37141010564321 + 5.57310680132109*I, 8.28221981185745 + 2.99165901130902*I)\nsage: A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\nsage: a = abs(moebius_transform(A, p1)); a\n105.706157025922\nsage: b = abs((moebius_transform(A, p2) - 1)); b\n105.113014884487\nsage: sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm(); sum_of_norms\n216.645504358830\n```\n",
    "created_at": "2020-07-13T05:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421317",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:10 tscrim]:
> Replying to [comment:9 gh-kliem]:
> > Replying to [comment:6 mjo]:
> > > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.
> > I agree. That's why I opened #29939 to fix this.
> 
> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.
> 
> > > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?
> > 
> > I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.
> 
> I disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.
> 
> > But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).
> 
> You have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.

I'm taking the minimum of the absolute and the relative error, because I want to be fair. This makes it much better. This is the original test:

```
sage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform
....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP
....: UHP = HyperbolicPlane().UHP()
....: def foo():
....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
....:     a = abs(moebius_transform(A, p1))
....:     b = abs((moebius_transform(A, p2) - 1))
....:     return (a,b)
....: 
sage: max(foo()[1] for _ in range(1000))
19.6483996640312
sage: max(foo()[0] for _ in range(1000))
76.0110826766808
```


Here are examples that perform bad. I hope you see, why I chose to change the doctest to minimum of absolute and relative norm:

```
sage: (p1, p2, p3) = (-2.29920829511711 + 5.52937627459424*I, -2.37141010564321 + 5.57310680132109*I, 8.28221981185745 + 2.99165901130902*I)
sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
sage: a = abs(moebius_transform(A, p1)); a
105.706157025922
sage: b = abs((moebius_transform(A, p2) - 1)); b
105.113014884487
sage: sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm(); sum_of_norms
216.645504358830
```




---

archive/issue_comments_421318.json:
```json
{
    "body": "Given those values, I think the original doctests are unacceptable. We know those exactness claims are wrong. Even if it succeeds with random seed 0, we shouldn't leave it as it is.",
    "created_at": "2020-07-13T05:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421318",
    "user": "https://github.com/kliem"
}
```

Given those values, I think the original doctests are unacceptable. We know those exactness claims are wrong. Even if it succeeds with random seed 0, we shouldn't leave it as it is.



---

archive/issue_comments_421319.json:
```json
{
    "body": "So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).\n\nFor the issue in the geodesic, the mathematics is correct:\n\n```\nsage: var('a0,a1,a2,b0,b1,b2')\n(a0, a1, a2, b0, b1, b2)\nsage: p0 = a0+b0*I\nsage: p1 = a1+b1*I\nsage: p2 = a2+b2*I\nsage: p0 = a0+b0*I\nsage: p1 = a1+b1*I\nsage: p2 = a2+b2*I\nsage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)\nsage: moebius_transform(A, p0)\n0\nsage: moebius_transform(A, p1).factor()\n1\nsage: moebius_transform(A, p2)\n+Infinity\n```\n\nSo I think the issue comes from this in the `moebius_transform` function:\n\n```python\n        if a * d - b * c < 0:\n            w = z.conjugate()  # Reverses orientation\n        else:\n            w = z\n```\n\nAt least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.\n\nThe problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.",
    "created_at": "2020-07-13T05:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421319",
    "user": "https://github.com/tscrim"
}
```

So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).

For the issue in the geodesic, the mathematics is correct:

```
sage: var('a0,a1,a2,b0,b1,b2')
(a0, a1, a2, b0, b1, b2)
sage: p0 = a0+b0*I
sage: p1 = a1+b1*I
sage: p2 = a2+b2*I
sage: p0 = a0+b0*I
sage: p1 = a1+b1*I
sage: p2 = a2+b2*I
sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)
sage: moebius_transform(A, p0)
0
sage: moebius_transform(A, p1).factor()
1
sage: moebius_transform(A, p2)
+Infinity
```

So I think the issue comes from this in the `moebius_transform` function:

```python
        if a * d - b * c < 0:
            w = z.conjugate()  # Reverses orientation
        else:
            w = z
```

At least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.

The problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.



---

archive/issue_comments_421320.json:
```json
{
    "body": "See also: https://en.wikipedia.org/wiki/M%C3%B6bius_transformation#Mapping_first_to_0,_1,_%E2%88%9E",
    "created_at": "2020-07-13T05:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421320",
    "user": "https://github.com/tscrim"
}
```

See also: https://en.wikipedia.org/wiki/M%C3%B6bius_transformation#Mapping_first_to_0,_1,_%E2%88%9E



---

archive/issue_comments_421321.json:
```json
{
    "body": "Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.\n\nI still don't know what is going on with the perpendicular bisector.",
    "created_at": "2020-07-13T05:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421321",
    "user": "https://github.com/tscrim"
}
```

Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.

I still don't know what is going on with the perpendicular bisector.



---

archive/issue_comments_421322.json:
```json
{
    "body": "With the bisector, sometimes it is not intersecting the geodesic (but the completed versions do intersect perpendicularly). So that is why the test is failing, but I don't know why it is doing this.",
    "created_at": "2020-07-13T05:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421322",
    "user": "https://github.com/tscrim"
}
```

With the bisector, sometimes it is not intersecting the geodesic (but the completed versions do intersect perpendicularly). So that is why the test is failing, but I don't know why it is doing this.



---

archive/issue_comments_421323.json:
```json
{
    "body": "Replying to [comment:16 tscrim]:\n> Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.\n> \n> I still don't know what is going on with the perpendicular bisector.\n\nYou're right. It is a sign issue and not a precision issue:\n\n\n```\n....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP\n....: UHP = HyperbolicPlane().UHP()\n....: def foo():\n....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\n....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\n....:     a1 = abs(moebius_transform(A, p1))\n....:     a2 = abs(moebius_transform(A, p1.conjugate()))\n....:     a = min(a1, a2)\n....:     b1 = abs((moebius_transform(A, p2) - 1))\n....:     b2 = abs((moebius_transform(A, p2.conjugate()) - 1))\n....:     b = min(b1, b2)   \n....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()\n....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)\nsage: max(foo()[1] for _ in range(1000))\n3.32270874593069e-17\nsage: max(foo()[0] for _ in range(1000))\n0.000000000000000\n```\n\n\nIf you return just `a, b` (the absolute errors), you get:\n\n```\nsage: max(foo()[1] for _ in range(1000))\n2.79547014692442e-15\nsage: max(foo()[0] for _ in range(1000))\n0.000000000000000\n```\n\n\nI guess the absolute error works as well, because `The points are uniformly distributed over the rectangle [-10, 10] \\times [0, 10i]`.",
    "created_at": "2020-07-13T06:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421323",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:16 tscrim]:
> Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.
> 
> I still don't know what is going on with the perpendicular bisector.

You're right. It is a sign issue and not a precision issue:


```
....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP
....: UHP = HyperbolicPlane().UHP()
....: def foo():
....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
....:     a1 = abs(moebius_transform(A, p1))
....:     a2 = abs(moebius_transform(A, p1.conjugate()))
....:     a = min(a1, a2)
....:     b1 = abs((moebius_transform(A, p2) - 1))
....:     b2 = abs((moebius_transform(A, p2.conjugate()) - 1))
....:     b = min(b1, b2)   
....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()
....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)
sage: max(foo()[1] for _ in range(1000))
3.32270874593069e-17
sage: max(foo()[0] for _ in range(1000))
0.000000000000000
```


If you return just `a, b` (the absolute errors), you get:

```
sage: max(foo()[1] for _ in range(1000))
2.79547014692442e-15
sage: max(foo()[0] for _ in range(1000))
0.000000000000000
```


I guess the absolute error works as well, because `The points are uniformly distributed over the rectangle [-10, 10] \times [0, 10i]`.



---

archive/issue_comments_421324.json:
```json
{
    "body": "So the original doctests are fine up to a sign issue.",
    "created_at": "2020-07-13T06:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421324",
    "user": "https://github.com/kliem"
}
```

So the original doctests are fine up to a sign issue.



---

archive/issue_comments_421325.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).\n> \n> For the issue in the geodesic, the mathematics is correct:\n> {{{\n> sage: var('a0,a1,a2,b0,b1,b2')\n> (a0, a1, a2, b0, b1, b2)\n> sage: p0 = a0+b0*I\n> sage: p1 = a1+b1*I\n> sage: p2 = a2+b2*I\n> sage: p0 = a0+b0*I\n> sage: p1 = a1+b1*I\n> sage: p2 = a2+b2*I\n> sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)\n> sage: moebius_transform(A, p0)\n> 0\n> sage: moebius_transform(A, p1).factor()\n> 1\n> sage: moebius_transform(A, p2)\n> +Infinity\n> }}}\n> So I think the issue comes from this in the `moebius_transform` function:\n> {{{#!python\n>         if a * d - b * c < 0:\n>             w = z.conjugate()  # Reverses orientation\n>         else:\n>             w = z\n> }}}\n> At least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.\n> \n> The problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.\n\nI opened #29939 to fix this problem. But if we can fix this here that is fine with me to. If it would have been a precision problem, I don't think I would have been able to fix this. So this is why I opened a separate ticket.\n\nAnyway, I'm glad you figured out the actual problem.",
    "created_at": "2020-07-13T06:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421325",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:14 tscrim]:
> So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).
> 
> For the issue in the geodesic, the mathematics is correct:
> {{{
> sage: var('a0,a1,a2,b0,b1,b2')
> (a0, a1, a2, b0, b1, b2)
> sage: p0 = a0+b0*I
> sage: p1 = a1+b1*I
> sage: p2 = a2+b2*I
> sage: p0 = a0+b0*I
> sage: p1 = a1+b1*I
> sage: p2 = a2+b2*I
> sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)
> sage: moebius_transform(A, p0)
> 0
> sage: moebius_transform(A, p1).factor()
> 1
> sage: moebius_transform(A, p2)
> +Infinity
> }}}
> So I think the issue comes from this in the `moebius_transform` function:
> {{{#!python
>         if a * d - b * c < 0:
>             w = z.conjugate()  # Reverses orientation
>         else:
>             w = z
> }}}
> At least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.
> 
> The problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.

I opened #29939 to fix this problem. But if we can fix this here that is fine with me to. If it would have been a precision problem, I don't think I would have been able to fix this. So this is why I opened a separate ticket.

Anyway, I'm glad you figured out the actual problem.



---

archive/issue_comments_421326.json:
```json
{
    "body": "So the issue with the perp bisector comes from this:\n\n```\nsage: g = UHP.random_geodesic()   # Good one\nsage: g.start(), g.end()\n(Point in UHP -9.26728445125634 + 7.15068223909426*I,\n Point in UHP -8.57515638592863 + 0.982992065975858*I)\nsage: g = UHP.random_geodesic()   # Bad one\nsage: g.start(), g.end()\n(Point in UHP -4.92591958004554 + 7.81075974592370*I,\n Point in UHP -8.44416583993011 + 3.87025183089797*I)\n```\n\nIn particular, the completed geodesics always have the endpoints in order. I am not sure if this is the best fix, but it does fix that issue.\n\nHowever, I don't yet understand enough of the mathematics to fix the issue with the crossratio matrix.\n----\nNew commits:",
    "created_at": "2020-07-13T08:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421326",
    "user": "https://github.com/tscrim"
}
```

So the issue with the perp bisector comes from this:

```
sage: g = UHP.random_geodesic()   # Good one
sage: g.start(), g.end()
(Point in UHP -9.26728445125634 + 7.15068223909426*I,
 Point in UHP -8.57515638592863 + 0.982992065975858*I)
sage: g = UHP.random_geodesic()   # Bad one
sage: g.start(), g.end()
(Point in UHP -4.92591958004554 + 7.81075974592370*I,
 Point in UHP -8.44416583993011 + 3.87025183089797*I)
```

In particular, the completed geodesics always have the endpoints in order. I am not sure if this is the best fix, but it does fix that issue.

However, I don't yet understand enough of the mathematics to fix the issue with the crossratio matrix.
----
New commits:



---

archive/issue_comments_421327.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-13T08:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421327",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_421328.json:
```json
{
    "body": "Changing keywords from \"hyperbolic geodesic, hyperbolic point\" to \"hyperbolic geodesic\".",
    "created_at": "2020-07-13T09:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421328",
    "user": "https://github.com/kliem"
}
```

Changing keywords from "hyperbolic geodesic, hyperbolic point" to "hyperbolic geodesic".



---

archive/issue_comments_421329.json:
```json
{
    "body": "I would rewrite the test along these lines:\n\n```\n+        Check the result is independent of the order::\n+\n+            sage: def works_both_ways(a, b):\n+            ....:     UHP = HyperbolicPlane().UHP()\n+            ....:     g = UHP.get_geodesic(a, b)\n+            ....:     h = UHP.get_geodesic(b, a)\n+            ....:     p = g.perpendicular_bisector()\n+            ....:     q = h.perpendicular_bisector()\n+            ....:     c = lambda x: x.coordinates()\n+            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)\n+            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)\n+            sage: works_both_ways(1 + I, 2 + 0.5*I)\n+            sage: works_both_ways(2 + I, 2 + 0.5*I)\n```\n",
    "created_at": "2020-07-13T09:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421329",
    "user": "https://github.com/slel"
}
```

I would rewrite the test along these lines:

```
+        Check the result is independent of the order::
+
+            sage: def works_both_ways(a, b):
+            ....:     UHP = HyperbolicPlane().UHP()
+            ....:     g = UHP.get_geodesic(a, b)
+            ....:     h = UHP.get_geodesic(b, a)
+            ....:     p = g.perpendicular_bisector()
+            ....:     q = h.perpendicular_bisector()
+            ....:     c = lambda x: x.coordinates()
+            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)
+            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)
+            sage: works_both_ways(1 + I, 2 + 0.5*I)
+            sage: works_both_ways(2 + I, 2 + 0.5*I)
```




---

archive/issue_comments_421330.json:
```json
{
    "body": "That is a better way to do the test. I will change that next chance I get (although it might not be until the end of the week).",
    "created_at": "2020-07-13T10:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421330",
    "user": "https://github.com/tscrim"
}
```

That is a better way to do the test. I will change that next chance I get (although it might not be until the end of the week).



---

archive/issue_comments_421331.json:
```json
{
    "body": "Some more suggestions.\n\nAdd trac ticket number to test:\n\n```\n+        Check the result is independent of the order (:trac:`29936`)::\n```\n\n\nRephrase comment?\n\n```\n-        # Since the complete geodesic p1 -> p2 always returns p1 < p2,\n-        #   we need to swap start and end when that happens\n+        # Completed geodesics always have endpoints in order,\n+        # so we swap start and end if needed.\n```\n\n\nDefine `S` immediately after the swap, since that's where `.complete()` happens.\n\n```\n+        S = self.complete()._to_std_geod(start)\n         d = self._model._dist_points(start, self._end.coordinates()) / 2\n-        S = self.complete()._to_std_geod(start)\n```\n\n\nAvoid detour to the symbolic ring.\n\n```\n-        s2 = sqrt(2) * 0.5\n+        s2 = sqrt(0.5)\n```\n",
    "created_at": "2020-07-13T10:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421331",
    "user": "https://github.com/slel"
}
```

Some more suggestions.

Add trac ticket number to test:

```
+        Check the result is independent of the order (:trac:`29936`)::
```


Rephrase comment?

```
-        # Since the complete geodesic p1 -> p2 always returns p1 < p2,
-        #   we need to swap start and end when that happens
+        # Completed geodesics always have endpoints in order,
+        # so we swap start and end if needed.
```


Define `S` immediately after the swap, since that's where `.complete()` happens.

```
+        S = self.complete()._to_std_geod(start)
         d = self._model._dist_points(start, self._end.coordinates()) / 2
-        S = self.complete()._to_std_geod(start)
```


Avoid detour to the symbolic ring.

```
-        s2 = sqrt(2) * 0.5
+        s2 = sqrt(0.5)
```




---

archive/issue_comments_421332.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-15T02:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421332",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421333.json:
```json
{
    "body": "I managed to find a bit of time today. Here are the changes you requested although I used a different version of the comment.\n\nNow to figure out how to fix the issue in comment:14 as some parts of the code that use `moebius_transformation` seem to use that conjugation...",
    "created_at": "2020-07-15T02:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421333",
    "user": "https://github.com/tscrim"
}
```

I managed to find a bit of time today. Here are the changes you requested although I used a different version of the comment.

Now to figure out how to fix the issue in comment:14 as some parts of the code that use `moebius_transformation` seem to use that conjugation...



---

archive/issue_comments_421334.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421334",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_421335.json:
```json
{
    "body": "The patchbot's pyflakes plugin complains that `moebius_transform` is undefined.",
    "created_at": "2021-02-26T11:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421335",
    "user": "https://github.com/slel"
}
```

The patchbot's pyflakes plugin complains that `moebius_transform` is undefined.



---

archive/issue_comments_421336.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-23T08:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421336",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_421337.json:
```json
{
    "body": "Here is a rebased branch that fixes the other problem. It is indeed related with the `moebius_tranformation`. That is really meant for isomorphisms of **CP**<sup>1</sup> with maps in PGL(2, **C**), so we should not do complex conjugation. Moreover, we cannot expect the determinant to be a real number unless we choose a good representative, but it is more numerically stable to not do more divisions than necessary. The orientation preserving maps of H<sup>2</sup> in the UHP model are for PGL(2, **R**), so there is a realness assumption of the determinant that we can apply, which means we can compare with `0`. Because of this, I moved the orientation reversing code directly into the model computations. This should now fix all of the issues noted above.",
    "created_at": "2021-04-23T08:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421337",
    "user": "https://github.com/tscrim"
}
```

Here is a rebased branch that fixes the other problem. It is indeed related with the `moebius_tranformation`. That is really meant for isomorphisms of **CP**<sup>1</sup> with maps in PGL(2, **C**), so we should not do complex conjugation. Moreover, we cannot expect the determinant to be a real number unless we choose a good representative, but it is more numerically stable to not do more divisions than necessary. The orientation preserving maps of H<sup>2</sup> in the UHP model are for PGL(2, **R**), so there is a realness assumption of the determinant that we can apply, which means we can compare with `0`. Because of this, I moved the orientation reversing code directly into the model computations. This should now fix all of the issues noted above.



---

archive/issue_comments_421338.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-23T08:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421338",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421339.json:
```json
{
    "body": "We also need the detour to the symbolic ring because sometimes a computation could be wanted in the symbolic ring and it makes checking for valid isometries much more stable.",
    "created_at": "2021-04-23T08:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421339",
    "user": "https://github.com/tscrim"
}
```

We also need the detour to the symbolic ring because sometimes a computation could be wanted in the symbolic ring and it makes checking for valid isometries much more stable.



---

archive/issue_comments_421340.json:
```json
{
    "body": "I missed one thing: to check a complex number is small, use its norm:\n\n```diff\n             sage: def works_both_ways(a, b):\n             ....:     UHP = HyperbolicPlane().UHP()\n             ....:     g = UHP.get_geodesic(a, b)\n             ....:     h = UHP.get_geodesic(b, a)\n             ....:     p = g.perpendicular_bisector()\n             ....:     q = h.perpendicular_bisector()\n             ....:     c = lambda x: x.coordinates()\n-            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)\n-            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)\n+            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))\n+            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))\n+            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9))\n```\n\n\nIndeed, `c(g.intersection(p)[0]) - c(g.midpoint())`\nis a complex number, and:\n\n```\nsage: I < 1e-9\nTrue\n```\n",
    "created_at": "2021-04-23T09:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421340",
    "user": "https://github.com/slel"
}
```

I missed one thing: to check a complex number is small, use its norm:

```diff
             sage: def works_both_ways(a, b):
             ....:     UHP = HyperbolicPlane().UHP()
             ....:     g = UHP.get_geodesic(a, b)
             ....:     h = UHP.get_geodesic(b, a)
             ....:     p = g.perpendicular_bisector()
             ....:     q = h.perpendicular_bisector()
             ....:     c = lambda x: x.coordinates()
-            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)
-            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)
+            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))
+            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))
+            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9))
```


Indeed, `c(g.intersection(p)[0]) - c(g.midpoint())`
is a complex number, and:

```
sage: I < 1e-9
True
```




---

archive/issue_comments_421341.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-23T09:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421341",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421342.json:
```json
{
    "body": "Good point, which uncovered that there is still an error in the second test...",
    "created_at": "2021-04-23T09:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421342",
    "user": "https://github.com/tscrim"
}
```

Good point, which uncovered that there is still an error in the second test...



---

archive/issue_comments_421343.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-23T09:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421343",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_421344.json:
```json
{
    "body": "There is an issue with the midpoints:\n\n```\nsage: UHP = HyperbolicPlane().UHP()\nsage: g = UHP.get_geodesic(2+I,2+0.5*I)\nsage: h = UHP.get_geodesic(2+0.5*I,2+I)\nsage: g.midpoint()\nPoint in UHP 2.00000000000000 + 1.41421356237309*I\nsage: h.midpoint()\nPoint in UHP 2.00000000000000 + 0.707106781186547*I\n```\n",
    "created_at": "2021-04-23T09:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421344",
    "user": "https://github.com/tscrim"
}
```

There is an issue with the midpoints:

```
sage: UHP = HyperbolicPlane().UHP()
sage: g = UHP.get_geodesic(2+I,2+0.5*I)
sage: h = UHP.get_geodesic(2+0.5*I,2+I)
sage: g.midpoint()
Point in UHP 2.00000000000000 + 1.41421356237309*I
sage: h.midpoint()
Point in UHP 2.00000000000000 + 0.707106781186547*I
```




---

archive/issue_comments_421345.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T05:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421345",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421346.json:
```json
{
    "body": "This now fixes the issue with `midpoint()`, which was the same issue as in the perp bisector.",
    "created_at": "2021-04-24T05:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421346",
    "user": "https://github.com/tscrim"
}
```

This now fixes the issue with `midpoint()`, which was the same issue as in the perp bisector.



---

archive/issue_comments_421347.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-24T05:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421347",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421348.json:
```json
{
    "body": "We test a bisector intersects a segment at its midpoint up to rounding error.\n\nTesting that in terms of relative hyperbolic distances would be cleaner.\n\nProposed replacement for the `works_both_ways` test:\n\n```diff\n-            sage: def works_both_ways(a, b):\n-            ....:     UHP = HyperbolicPlane().UHP()\n-            ....:     g = UHP.get_geodesic(a, b)\n-            ....:     h = UHP.get_geodesic(b, a)\n-            ....:     p = g.perpendicular_bisector()\n-            ....:     q = h.perpendicular_bisector()\n-            ....:     c = lambda x: x.coordinates()\n-            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))\n-            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))\n-            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9)), (error_ab, error_ba)\n-            sage: works_both_ways(1 + I, 2 + 0.5*I)\n-            sage: works_both_ways(2 + I, 2 + 0.5*I)\n+            sage: def bisector_gets_midpoint(a, b):\n+            ....:     UHP = HyperbolicPlane().UHP()\n+            ....:     g = UHP.get_geodesic(a, b)\n+            ....:     p = g.perpendicular_bisector()\n+            ....:     x, m = g.intersection(p)[0]), g.midpoint()\n+            ....:     return bool(x.dist(m) < 1e-9 * a.dist(b))\n+            sage: a, b, c = 1 + I, 2 + I, 2 + 0.5*I\n+            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]\n+            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)\n```\n\n\nThis also seems more readable to me. Sorry for the slow iterations.",
    "created_at": "2021-04-24T08:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421348",
    "user": "https://github.com/slel"
}
```

We test a bisector intersects a segment at its midpoint up to rounding error.

Testing that in terms of relative hyperbolic distances would be cleaner.

Proposed replacement for the `works_both_ways` test:

```diff
-            sage: def works_both_ways(a, b):
-            ....:     UHP = HyperbolicPlane().UHP()
-            ....:     g = UHP.get_geodesic(a, b)
-            ....:     h = UHP.get_geodesic(b, a)
-            ....:     p = g.perpendicular_bisector()
-            ....:     q = h.perpendicular_bisector()
-            ....:     c = lambda x: x.coordinates()
-            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))
-            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))
-            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9)), (error_ab, error_ba)
-            sage: works_both_ways(1 + I, 2 + 0.5*I)
-            sage: works_both_ways(2 + I, 2 + 0.5*I)
+            sage: def bisector_gets_midpoint(a, b):
+            ....:     UHP = HyperbolicPlane().UHP()
+            ....:     g = UHP.get_geodesic(a, b)
+            ....:     p = g.perpendicular_bisector()
+            ....:     x, m = g.intersection(p)[0]), g.midpoint()
+            ....:     return bool(x.dist(m) < 1e-9 * a.dist(b))
+            sage: a, b, c = 1 + I, 2 + I, 2 + 0.5*I
+            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]
+            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)
```


This also seems more readable to me. Sorry for the slow iterations.



---

archive/issue_comments_421349.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T09:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421349",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421350.json:
```json
{
    "body": "I agree that that version is more readable. I tweaked the input points to have floating point numbers as otherwise the code wants to do a really horrible (but exact) symbolic computation. I also made the distance check absolute instead of relative since they should be the same point.",
    "created_at": "2021-04-24T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421350",
    "user": "https://github.com/tscrim"
}
```

I agree that that version is more readable. I tweaked the input points to have floating point numbers as otherwise the code wants to do a really horrible (but exact) symbolic computation. I also made the distance check absolute instead of relative since they should be the same point.



---

archive/issue_comments_421351.json:
```json
{
    "body": "The gap between iterations is no problem. Thank you for taking the time to review this.",
    "created_at": "2021-04-24T09:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421351",
    "user": "https://github.com/tscrim"
}
```

The gap between iterations is no problem. Thank you for taking the time to review this.



---

archive/issue_comments_421352.json:
```json
{
    "body": "Replying to [comment:42 tscrim]:\n> made the distance check absolute instead of relative\n> since they should be the same point.\n\nFor short segments (say of length `1e-12`) we might\nprefer relative, but the current doctest uses segments\nof length on the order of one anyway, so I don't mind.\n\nI agree with you about doctesting with floating-point values.\nHow about this then:\n\n\n```diff\n-            sage: a, b, c = 1.0 + I, 2.0 + I, 2.0 + 0.5*I\n-            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]\n-            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)\n+            sage: c, d, e = CC(1, 1), CC(2, 1), CC(2, 0.5)\n+            sage: pairs = [(c, d), (d, c), (c, e), (e, c), (d, e), (e, d)]\n+            sage: all(bisector_gets_midpoint(a, b) for a, b in pairs)\n```\n\n\nIn `hyperbolic_isometry.py`, pyflakes complains:\n`'sage.rings.all.RR' imported but unused`.",
    "created_at": "2021-04-24T10:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421352",
    "user": "https://github.com/slel"
}
```

Replying to [comment:42 tscrim]:
> made the distance check absolute instead of relative
> since they should be the same point.

For short segments (say of length `1e-12`) we might
prefer relative, but the current doctest uses segments
of length on the order of one anyway, so I don't mind.

I agree with you about doctesting with floating-point values.
How about this then:


```diff
-            sage: a, b, c = 1.0 + I, 2.0 + I, 2.0 + 0.5*I
-            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]
-            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)
+            sage: c, d, e = CC(1, 1), CC(2, 1), CC(2, 0.5)
+            sage: pairs = [(c, d), (d, c), (c, e), (e, c), (d, e), (e, d)]
+            sage: all(bisector_gets_midpoint(a, b) for a, b in pairs)
```


In `hyperbolic_isometry.py`, pyflakes complains:
`'sage.rings.all.RR' imported but unused`.



---

archive/issue_comments_421353.json:
```json
{
    "body": "I will make that change tomorrow.\n\nAh. right, I forgot to take care of that pyflakes issue...",
    "created_at": "2021-04-25T03:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421353",
    "user": "https://github.com/tscrim"
}
```

I will make that change tomorrow.

Ah. right, I forgot to take care of that pyflakes issue...



---

archive/issue_comments_421354.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T23:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421354",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421355.json:
```json
{
    "body": "Fixed.",
    "created_at": "2021-04-25T23:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421355",
    "user": "https://github.com/tscrim"
}
```

Fixed.



---

archive/issue_comments_421356.json:
```json
{
    "body": "Green patchbot.",
    "created_at": "2021-05-05T03:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421356",
    "user": "https://github.com/tscrim"
}
```

Green patchbot.



---

archive/issue_comments_421357.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-10T22:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421357",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421358.json:
```json
{
    "body": "Good to see these issues solved.",
    "created_at": "2021-05-10T22:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421358",
    "user": "https://github.com/slel"
}
```

Good to see these issues solved.



---

archive/issue_comments_421359.json:
```json
{
    "body": "Thank you for the review.\n\nAt some point, when I have more free time, I want to implement higher dimensional hyperbolic space. Unfortunately other directly-applicable-to-my-research-code (and paper writing) takes priority...",
    "created_at": "2021-05-10T22:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421359",
    "user": "https://github.com/tscrim"
}
```

Thank you for the review.

At some point, when I have more free time, I want to implement higher dimensional hyperbolic space. Unfortunately other directly-applicable-to-my-research-code (and paper writing) takes priority...



---

archive/issue_events_027393.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2021-05-27T20:29:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29699#event-27393"
}
```



---

archive/issue_comments_421360.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29699#issuecomment-421360",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
