# Issue 12688: Incorrect computation of maximal orders in quaternion algebras

Issue created by migration from https://trac.sagemath.org/ticket/12860

Original creator: daniels

Original creation time: 2012-04-19 20:39:36

Assignee: daniels

The maximal_order function of QuaternionOrder can produce incorrect results.
It is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i^2 and b=j^2 to have a special form. Not all the necessary conditions are checked by the code.

E.g. the following is obviously not an order since it contains non-integral elements:


```
sage: A.<i,j,k> = QuaternionAlgebra(17)
sage: print A.invariants()
(-3, -17)
sage: R = A.maximal_order()
sage: b = R.basis()
sage: print b
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
sage: b[0]*b[1]
9/2*i
sage: (b[0]*b[1]).reduced_norm() 
243/4
```


But this is ok, because now the invariants are as in Pizer's paper:


```
sage: A.<i,j,k> = QuaternionAlgebra(-17,-3)
sage: print A.maximal_order().basis()
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
```


This could be fixed by simply swapping (i,j) in the formula depending on the invariants, but the invariants can deviate from the required form in more than one way, again possibly resulting in failure of the formula:


```
sage: A.<i,j,k> = QuaternionAlgebra(-17*9,-3)
sage: print A.maximal_order().basis()
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
sage: print (-1/3*j - 1/3*k).reduced_norm()
154/3
```


(#11464 is related)

**Patch follows.**


---

Comment by daniels created at 2012-04-19 21:04:41

The patch does the following:

* Move `maximal_order` from `brandt.py` to `quaternion_algebra.py`.

* Fix `maximal_order` to raise a NotImplementedError if the invariants are not of the expected form

* Add checks in `___init___` of QuaternionOrder to verify if the given basis actually is the basis of an order (this would have catched the bug earlier).

* Fix all the doctests that were expecting the mathematically incorrect results.


---

Comment by daniels created at 2012-04-19 22:47:59

See also #12861, for a patch extending this one by a more general algorithm.


---

Comment by daniels created at 2012-04-20 09:54:05

New patch applies to sage-5.0.beta13 (old one conflicted with #12461)


---

Comment by aly.deines created at 2012-07-21 23:15:52

Changing status from new to needs_review.


---

Attachment

This applies to sage-5.2.rc0 and all tests pass.  

This looks good to me!


---

Comment by aly.deines created at 2012-07-21 23:16:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-07-27 20:40:13

Please fill in your real name as Author.


---

Comment by jdemeyer created at 2012-07-27 20:44:07

Please fill in your real name as Reviewer.


---

Comment by jdemeyer created at 2012-08-01 12:11:19

Resolution: fixed
