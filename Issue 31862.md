# Issue 31862: Fix file-cache location for database_knotinfo

Issue created by migration from https://trac.sagemath.org/ticket/32099

Original creator: soehms

Original creation time: 2021-07-02 16:26:37

CC:  fbissey

Keywords: database knotinfo

In #31921 the location for the file-cache of the KnotInfo databases has been changed from `$SAGE_LOCAL` to `$DOT_SAGE`. Unfortunately this change has not been performed with respect to cleaning on version updates. This will be fixed here.

Furthermore, an upgrade to  the first official release 21.7 of the PyPI-package will be done.

The original databases on the [KnotInfo](https://knotinfo.math.indiana.edu/) web-page are developed under continuous flow. In order to keep track with that I've installed a [cronjob](https://github.com/soehms/database_knotinfo/blob/main/.github/workflows/check_version_changed.yml) that looks for differences and creates new releases if necessary. This is done once a month. The version numbers correspond to the month giving the next differences. The first such release is [21.7](https://pypi.org/project/database-knotinfo/21.7/).

This upgrade just puts Sage on that release. It does not effect any functionality. As far as I've seen, the major difference to the former release is the addition of 2 new columns for proper links (`'arf_invariant': 'Arf Invariant'`, `'topological_four_genus': 'Genus-4D (Top.)'`).


---

Comment by soehms created at 2021-07-02 16:34:25

Changing status from new to needs_review.


---

Comment by soehms created at 2021-07-02 16:34:25

New commits:


---

Comment by soehms created at 2021-07-02 16:43:20

Changing type from PLEASE CHANGE to defect.


---

Comment by mkoeppe created at 2021-07-02 16:57:56

I don't think the spkg-install should be in charge of clearing things in the user's .sage directory. This won't work in multi-user installations. This needs a better solution


---

Comment by fbissey created at 2021-07-02 20:00:27

Replying to [comment:4 mkoeppe]:
> I don't think the spkg-install should be in charge of clearing things in the user's .sage directory. This won't work in multi-user installations. This needs a better solution

Indeed not. This was possibly overlooked as of non consequence on a multi-user install because it would only apply to the installing user's `DOT_SAGE`. But if cleaning is needed, it has to be done at runtime when the user starts sage or the specific functionality.


---

Comment by soehms created at 2021-07-03 10:35:05

Replying to [comment:5 fbissey]:
>> Replying to [comment:4 mkoeppe]:

> But if cleaning is needed, it has to be done at runtime when the user starts sage or the specific functionality.

Sure! I will do it next week.


---

Comment by git created at 2021-07-06 10:27:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-06 10:28:56

An automatic refresh of the file-cache at runtime is already implemented. It is performed whenever the file `num_knots.sobj` in the file-cache directory is missing. Thus, the only thing to do is to add the version number to this file-name.


---

Comment by git created at 2021-07-06 10:33:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-08 22:03:47

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-07-08 22:03:47

This is not a good solution - let's please not re-introduce uses of `sage.misc.package` - this is specific to sage-the-distribution.

I would suggest to instead query the version of the installed Python package using standard Python means: 
- either using a variable that your Python package `database_knotinfo` provides for this purpose
- or using `importlib.metadata` https://docs.python.org/3/library/importlib.metadata.html


---

Comment by git created at 2021-07-09 11:37:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-09 11:39:16

Replying to [comment:10 mkoeppe]:
> This is not a good solution - let's please not re-introduce uses of `sage.misc.package` - this is specific to sage-the-distribution.
> 
> I would suggest to instead query the version of the installed Python package using standard Python means: 
> - either using a variable that your Python package `database_knotinfo` provides for this purpose
> - or using `importlib.metadata` https://docs.python.org/3/library/importlib.metadata.html


Thanks for the hint!


---

Comment by soehms created at 2021-07-09 11:39:16

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-09 15:49:11

Thanks for making this change. 

Because we still support Python 3.7, I think this will need a `try...except` with fallback to using the backport package `importlib_metadata` (see https://importlib-metadata.readthedocs.io/en/latest/using.html)


---

Comment by git created at 2021-07-12 08:17:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-12 08:19:43

Since I couldn't test with python 3.7 I started the [GitHub workflow tox-optional](https://github.com/soehms/sage/actions/runs/1020446425) instead.


---

Comment by mkoeppe created at 2021-07-12 17:01:25

The `debian-buster-standard` run (which has system python 3.7) looks fine.


---

Comment by mkoeppe created at 2021-07-12 17:10:59

Testing locally, I am getting numerous doctest failures though:

```
File "src/sage/knots/link.py", line 3931, in sage.knots.link.Link.is_isotopic
Failed example:
    from sage.knots.knotinfo import KnotInfo
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.knots.link.Link.is_isotopic[5]>", line 1, in <module>
        from sage.knots.knotinfo import KnotInfo
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/knots/knotinfo.py", line 2416, in <module>
        KnotInfo = KnotInfoBase('KnotInfo', db.row_names())
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__
        self.cache = f(self._instance)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/knotinfo_db.py", line 707, in row_names
        row_dict = self.read_row_dict()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__
        self.cache = f(self._instance)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/knotinfo_db.py", line 685, in read_row_dict
        return load('%s/%s' %(sobj_path, filename))
      File "sage/misc/persist.pyx", line 187, in sage.misc.persist.load
        with open(filename, 'rb') as fobj:
    FileNotFoundError: [Errno 2] No such file or directory: '/Users/mkoeppe/.sage/knotinfo/row_dict.sobj'
```



---

Comment by soehms created at 2021-07-14 06:58:09

Replying to [comment:17 mkoeppe]:
> Testing locally, I am getting numerous doctest failures though: ....

I've no idea where this could come from. Can you please say more about the test-case. Have there been error messages from the new method `version`? If so, can you please post them?


---

Comment by git created at 2021-07-16 06:43:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-16 06:45:35

I think the first option of your suggestion in comment 10 is the better choice, since it can be implemented independent on the Python version. Thus, I'm switching to this solution, now.


---

Comment by git created at 2021-07-19 12:18:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-19 12:22:30

After an inspection of the log-files being attached to the `tox-optional` workflow run mentioned in [comment 15](https://trac.sagemath.org/ticket/32099#comment:15) (for example the [one for ubunto focal](https://github.com/soehms/sage/runs/3040930473?check_suite_focus=true)) I realized that a couple of dependencies to standard `spkg` being necassary to have the doctests of `spkg-check.in` pass successfully during a clean build, were missing.

I've added these and started the [workflow](https://github.com/soehms/sage/actions/runs/1044132433) again.


I suspect that the problem which has been reported in [comment 17](https://trac.sagemath.org/ticket/32099#comment:17) is related to that and should be fixed, now.

BTW: Is it intended that the jobs of `tox-optional` are marked green even though `spkg-check.in` failed?


---

Comment by git created at 2021-07-23 08:32:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-23 08:35:32

Now, the doctests did pass for the current workflow run on all jobs that I've inspected (by random choice of those that did not fail by some other reason). For example on Debian buster:


```bash
Successfully installed database-knotinfo-21.7.15
Removed build tracker: '/tmp/pip-req-tracker-1y0wwg_k'

real    0m2.628s
user    0m2.231s
sys     0m0.401s
Copying package files from temporary location /sage/local/var/tmp/sage/build/database_knotinfo-21.7.15/inst to /sage/local
Running the test suite for database_knotinfo-21.7.15...
Testing databases/knotinfo_db.py
no stored timings available
Running doctests with ID 2021-07-20-03-48-43-957b59f6.
Using --optional=database_knotinfo,sage
Doctesting 1 file.
sage -t --long --random-seed=0 databases/knotinfo_db.py
    [101 tests, 25.38 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 25.5 seconds
    cpu time: 24.8 seconds
    cumulative wall time: 25.4 seconds
Pytest is not installed, skip checking tests that rely on it.
Testing knots/knotinfo.py
too few successful tests, not using stored timings
Running doctests with ID 2021-07-20-03-49-12-54c67d38.
Using --optional=database_knotinfo,sage
Doctesting 1 file.
sage -t --random-seed=0 knots/knotinfo.py
    [352 tests, 5.04 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 5.2 seconds
    cpu time: 5.0 seconds
    cumulative wall time: 5.0 seconds
Pytest is not installed, skip checking tests that rely on it.
Testing knots/link.py
too few successful tests, not using stored timings
Running doctests with ID 2021-07-20-03-49-20-81ce905a.
Using --optional=database_knotinfo,sage
Doctesting 1 file.
sage -t --random-seed=0 knots/link.py
    [539 tests, 13.25 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 13.4 seconds
    cpu time: 13.2 seconds
    cumulative wall time: 13.3 seconds
Pytest is not installed, skip checking tests that rely on it.

real    0m52.506s
user    0m48.852s
sys     0m2.132s
Passed the test suite for database_knotinfo-21.7.15.
Successfully installed database_knotinfo-21.7.15
Deleting temporary build directory
```




The current commit is independent on that. Again, it just switches to a new version number format (see [issue 2 on GitHub](https://github.com/soehms/database_knotinfo/issues/2)).


---

Comment by mkoeppe created at 2021-07-25 22:22:23

Replying to [comment:22 soehms]:
> After an inspection of the log-files being attached to the `tox-optional` workflow run mentioned in [comment 15](https://trac.sagemath.org/ticket/32099#comment:15) (for example the [one for ubunto focal](https://github.com/soehms/sage/runs/3040930473?check_suite_focus=true)) I realized that a couple of dependencies to standard `spkg` being necassary to have the doctests of `spkg-check.in` pass successfully during a clean build, were missing.

To declare check-specific dependencies, you can use the format/trick that is used in  `build/pkgs/networkx/dependencies`


---

Comment by mkoeppe created at 2021-07-25 22:24:20

Replying to [comment:22 soehms]:
> BTW: Is it intended that the jobs of `tox-optional` are marked green even though `spkg-check.in` failed?

Yes, it's intentional.  Just too many optional packages fail at the moment. Seeing everything or almost everything fail is neither informative nor encouraging...


---

Comment by git created at 2021-07-27 08:33:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-07-27 08:36:38

Replying to [comment:25 mkoeppe]:

> To declare check-specific dependencies, you can use the format/trick that is used in  `build/pkgs/networkx/dependencies`

The package I used as example was `p_group_cohomology` which performes Sage doctests in `spkg-ceck.in`, as well. Anyway, I followed your suggestion and tested that at least the goal of the former commit has not been damaged. On the other hand I didn't test whether there are less restrictions if no check option is given. But, I think that should work here, too, if it is working for `networkx`.


---

Comment by soehms created at 2021-07-27 08:37:21

Replying to [comment:26 mkoeppe]:

> Yes, it's intentional.  Just too many optional packages fail at the moment. Seeing everything or almost everything fail is neither informative nor encouraging...

Yes, that's right.


---

Comment by mkoeppe created at 2021-08-03 01:07:18

Right after installation of the new version of the package I get the following errors upon `./sage -tp src/sage/databases/ src/sage/features/ src/sage/knots/`.

```
sage -t --random-seed=0 src/sage/features/databases.py
**********************************************************************
File "src/sage/features/databases.py", line 113, in sage.features.databases.DatabaseKnotInfo
Failed example:
    DatabaseKnotInfo().is_present()  # optional: database_knotinfo
Expected:
    FeatureTestResult('sage.knots.knotinfo', True)
Got:
    FeatureTestResult('database_knotinfo', True)
**********************************************************************
1 item had failures:
   1 of   3 in sage.features.databases.DatabaseKnotInfo
    [15 tests, 1 failure, 0.02 s]
sage -t --random-seed=0 src/sage/knots/link.py
**********************************************************************
File "src/sage/knots/link.py", line 2667, in sage.knots.link.Link.homfly_polynomial
Failed example:
    KI, m = K.get_knotinfo(); KI, m
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.knots.link.Link.homfly_polynomial[14]>", line 1, in <module>
        KI, m = K.get_knotinfo(); KI, m
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/knots/link.py", line 3861, in get_knotinfo
        ls, proved_s = self._knotinfo_matching_list()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__
        self.cache = f(self._instance)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/knots/link.py", line 3489, in _knotinfo_matching_list
        from sage.knots.knotinfo import KnotInfoSeries
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/knots/knotinfo.py", line 2416, in <module>
        KnotInfo = KnotInfoBase('KnotInfo', db.row_names())
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__
        self.cache = f(self._instance)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/knotinfo_db.py", line 705, in row_names
        row_dict = self.read_row_dict()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__
        self.cache = f(self._instance)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/knotinfo_db.py", line 683, in read_row_dict
        return load('%s/%s' %(sobj_path, filename))
      File "sage/misc/persist.pyx", line 187, in sage.misc.persist.load
        with open(filename, 'rb') as fobj:
    FileNotFoundError: [Errno 2] No such file or directory: '/Users/mkoeppe/.sage/knotinfo/row_dict.sobj'
**********************************************************************
File "src/sage/knots/link.py", line 2669, in sage.knots.link.Link.homfly_polynomial
Failed example:
    K.homfly_polynomial(normalization='vz') == KI.homfly_polynomial()
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.knots.link.Link.homfly_polynomial[15]>", line 1, in <module>
        K.homfly_polynomial(normalization='vz') == KI.homfly_polynomial()
    NameError: name 'KI' is not defined
**********************************************************************
1 item had failures:
   2 of  31 in sage.knots.link.Link.homfly_polynomial
    [540 tests, 2 failures, 11.52 s]
```



This is not stable: I reran the same command and got different errors:

```
sage -t --random-seed=0 src/sage/knots/knotinfo.py  # 232 doctests failed
sage -t --random-seed=0 src/sage/features/databases.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/knots/link.py  # 2 doctests failed
```


My guess is that what is happening here is that creating the cache is not safe for parallel doctesting. You may want to make this step atomic.


---

Comment by mkoeppe created at 2021-08-03 01:07:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-08-07 16:52:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-08-07 17:09:51

Changing status from needs_work to needs_review.


---

Comment by soehms created at 2021-08-07 17:09:51

Replying to [comment:30 mkoeppe]:
> My guess is that what is happening here is that creating the cache is not safe for parallel doctesting. You may want to make this step atomic.

Exactly! Shame on me: I only tested serial! Since I didn't find an appropriate Sage class to use for this purpose I created a variation of `atomic_write` in #32344


---

Comment by git created at 2021-08-11 09:25:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-08-11 09:33:07

I rename `reset_filcache` to `create_filecache`. Cleaning is resticted to a change of the version or user input, now!


---

Comment by git created at 2021-09-07 16:50:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-09-07 16:50:48

Let's take the current version of the PyPI package with us. It's the first release completely created by the cron-job.


---

Comment by mkoeppe created at 2021-09-07 18:35:21

This seems to work well now!


---

Comment by mkoeppe created at 2021-09-07 18:35:21

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2021-09-08 07:19:38

Many Thanks!


---

Comment by vbraun created at 2021-09-15 22:06:11

Resolution: fixed
