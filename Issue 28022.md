# Issue 28022: graph add_edges/delete_edges are dramatically slow

archive/issues_028022.json:
```json
{
    "body": "CC:  dcoudert\n\nWhen dealing with dynamical graph (where vertices and edges have to change many times) then I suffer a lot from the slowness of `add_edges` and `delete_edges`. Compared to a pair of dictionary of lists (to save adjacencies) one get a `x3` factor\n\n```\nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]\nsage: dout = defaultdict(list); din = defaultdict(list)\nsage: %time for i,j in edges: dout[i].append(j); din[j].append(i)\nCPU times: user 46.9 ms, sys: 0 ns, total: 46.9 ms\nWall time: 46.5 ms\nsage: D = DiGraph(multiedges=True, loops=True)\nsage: %time D.add_edges(edges)\nCPU times: user 129 ms, sys: 0 ns, total: 129 ms\nWall time: 129 ms\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28259\n\n",
    "created_at": "2019-07-25T11:47:53Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "title": "graph add_edges/delete_edges are dramatically slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28022",
    "user": "vdelecroix"
}
```
CC:  dcoudert

When dealing with dynamical graph (where vertices and edges have to change many times) then I suffer a lot from the slowness of `add_edges` and `delete_edges`. Compared to a pair of dictionary of lists (to save adjacencies) one get a `x3` factor

```
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
sage: dout = defaultdict(list); din = defaultdict(list)
sage: %time for i,j in edges: dout[i].append(j); din[j].append(i)
CPU times: user 46.9 ms, sys: 0 ns, total: 46.9 ms
Wall time: 46.5 ms
sage: D = DiGraph(multiedges=True, loops=True)
sage: %time D.add_edges(edges)
CPU times: user 129 ms, sys: 0 ns, total: 129 ms
Wall time: 129 ms
```


Issue created by migration from https://trac.sagemath.org/ticket/28259





---

archive/issue_comments_396093.json:
```json
{
    "body": "Changing keywords from \"\" to \"days100\".",
    "created_at": "2019-07-25T11:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396093",
    "user": "vdelecroix"
}
```

Changing keywords from "" to "days100".



---

archive/issue_comments_396094.json:
```json
{
    "body": "It's true that we should work on optimizing the backend, and also simplifying it. But we have to be careful as it might have a strong impact (slowdown) on other kinds of operations.",
    "created_at": "2019-07-25T13:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396094",
    "user": "dcoudert"
}
```

It's true that we should work on optimizing the backend, and also simplifying it. But we have to be careful as it might have a strong impact (slowdown) on other kinds of operations.



---

archive/issue_comments_396095.json:
```json
{
    "body": "Attachment [cf_prof_K2_Q2000_R5.pdf](tarball://root/attachments/some-uuid/ticket28259/cf_prof_K2_Q2000_R5.pdf) by vdelecroix created at 2019-07-29 12:25:29",
    "created_at": "2019-07-29T12:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396095",
    "user": "vdelecroix"
}
```

Attachment [cf_prof_K2_Q2000_R5.pdf](tarball://root/attachments/some-uuid/ticket28259/cf_prof_K2_Q2000_R5.pdf) by vdelecroix created at 2019-07-29 12:25:29



---

archive/issue_comments_396096.json:
```json
{
    "body": "For me, it is the other way around. My code is slow **because** of the slowness of vertex/edge manipulation... have a look at [attachment:cf_prof_K2_Q2000_R5.pdf].",
    "created_at": "2019-07-29T12:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396096",
    "user": "vdelecroix"
}
```

For me, it is the other way around. My code is slow **because** of the slowness of vertex/edge manipulation... have a look at [attachment:cf_prof_K2_Q2000_R5.pdf].



---

archive/issue_comments_396097.json:
```json
{
    "body": "The profiling is impressive: 95% of the computation is spent by the vertex/edge management\n- add_edge 19% (for ~250K calls)\n- delete_vertex 50% (for ~5K calls)\n- has_vertex 2.7% (for ~180K calls)\n- iterator_in_edges 1.8% (for ~250K calls)\n- iterator_out_edges 11% (for ~800K calls)\n\nOf course, my computation use the graphs extensively. But still it does not only use that... The only thing I can do to make it faster is to either make Sage graphs better or get rid of them in my program. At this stage, I am not sure which direction to take. The sparse graph backend is a huge mess of code. Rewriting any part of it will take a considerable amount of time. I will probably write a custom graph class from scratch that fits my need. In a second time, I will see whether it can be plugged in as a backend for Sage.",
    "created_at": "2019-07-29T12:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396097",
    "user": "vdelecroix"
}
```

The profiling is impressive: 95% of the computation is spent by the vertex/edge management
- add_edge 19% (for ~250K calls)
- delete_vertex 50% (for ~5K calls)
- has_vertex 2.7% (for ~180K calls)
- iterator_in_edges 1.8% (for ~250K calls)
- iterator_out_edges 11% (for ~800K calls)

Of course, my computation use the graphs extensively. But still it does not only use that... The only thing I can do to make it faster is to either make Sage graphs better or get rid of them in my program. At this stage, I am not sure which direction to take. The sparse graph backend is a huge mess of code. Rewriting any part of it will take a considerable amount of time. I will probably write a custom graph class from scratch that fits my need. In a second time, I will see whether it can be plugged in as a backend for Sage.



---

archive/issue_comments_396098.json:
```json
{
    "body": "I agree that we must rewrite and simplify the graph backend and that it's not an easy task. As far as I know, it has been designed like that to allow some optimization of some specific use when vertices are only integers in 0..n-1 and are created in this order, but it has a cost for other usage.\n\nAnother important task is to better distinguish the label and the id of a vertex. Roughly, for most internal use, we should only manipulate integers and not the labels of the vertices.",
    "created_at": "2019-07-29T16:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396098",
    "user": "dcoudert"
}
```

I agree that we must rewrite and simplify the graph backend and that it's not an easy task. As far as I know, it has been designed like that to allow some optimization of some specific use when vertices are only integers in 0..n-1 and are created in this order, but it has a cost for other usage.

Another important task is to better distinguish the label and the id of a vertex. Roughly, for most internal use, we should only manipulate integers and not the labels of the vertices.



---

archive/issue_comments_396099.json:
```json
{
    "body": "I created a meta ticket #28895 for all those tickets simplifying or improving graph backends.\n\nCurrently I'm working on improving the deleting of vertices. The solution should be, to move the reversed graph to the CGraph structure. The backend keeps a reversed copy of the graph, but the CGraph doesn't know it and can't use it. Therefore deleting vertices takes forever (the CGraph doesn't know the incoming edges, but the reversed one would have known it easily).",
    "created_at": "2019-12-20T13:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396099",
    "user": "@kliem"
}
```

I created a meta ticket #28895 for all those tickets simplifying or improving graph backends.

Currently I'm working on improving the deleting of vertices. The solution should be, to move the reversed graph to the CGraph structure. The backend keeps a reversed copy of the graph, but the CGraph doesn't know it and can't use it. Therefore deleting vertices takes forever (the CGraph doesn't know the incoming edges, but the reversed one would have known it easily).



---

archive/issue_comments_396100.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396100",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_396101.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396101",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_396102.json:
```json
{
    "body": "#30769 might be a good step towards this goal.\n\nWith this ticket, I get the following timings:\n\n- `igraph`: 10 ms\n- dense `DiGraph`: 15 ms\n- sparse `DiGraph`: 32 ms\n\nNote that sparse graphs also carry a copy of the reversed graph, so the actual arc is added twice.\n\nProfiling suggests that this business of `get_vertex_checked` should be improved, especially in case of integers. For dense graphs this seems to take up almost all the time. (I'm not sure how to proceed with this.)\n\nThis also implies that improving the data structure for sparse graphs could give us a large speedup here. (But I'm even less sure how to proceed with this.)",
    "created_at": "2020-10-14T09:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396102",
    "user": "@kliem"
}
```

#30769 might be a good step towards this goal.

With this ticket, I get the following timings:

- `igraph`: 10 ms
- dense `DiGraph`: 15 ms
- sparse `DiGraph`: 32 ms

Note that sparse graphs also carry a copy of the reversed graph, so the actual arc is added twice.

Profiling suggests that this business of `get_vertex_checked` should be improved, especially in case of integers. For dense graphs this seems to take up almost all the time. (I'm not sure how to proceed with this.)

This also implies that improving the data structure for sparse graphs could give us a large speedup here. (But I'm even less sure how to proceed with this.)



---

archive/issue_comments_396103.json:
```json
{
    "body": "Replying to [comment:12 gh-kliem]:\n> #30769 might be a good step towards this goal.\n> \n> With this ticket, I get the following timings:\n> \n> - `igraph`: 10 ms\n> - dense `DiGraph`: 15 ms\n> - sparse `DiGraph`: 32 ms\n\nNice!\n\n> Note that sparse graphs also carry a copy of the reversed graph, so the actual arc is added twice.\n> \n> Profiling suggests that this business of `get_vertex_checked` should be improved, especially in case of integers. For dense graphs this seems to take up almost all the time. (I'm not sure how to proceed with this.)\n\nThis is a pity. Maybe a flag `.has_integral_vertices` which implies that the graph has vertex set `{0, 1, ..., n-1}`? When the flag is set, one could bypass translations.\n\n> This also implies that improving the data structure for sparse graphs could give us a large speedup here. (But I'm even less sure how to proceed with this.)\n\nI did try in the past to rewrite sparse graph (do not remember which ticket), but it ended up being painful. Ideally we should just be wrapping some pure C implementation but vertex labels and edge labels are delicate to deal with.\n\nAlso, we could introduce a new (simpler) datastructure similar to static sparse graphs but for which one can reallocate individually the arrays used for neighbor lists. This can be amortized in terms of graph creation and would benefit from all algorithms already implemented for static sparse graph. However, such data structure will be a bit costly for merging vertices.",
    "created_at": "2020-10-14T09:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396103",
    "user": "vdelecroix"
}
```

Replying to [comment:12 gh-kliem]:
> #30769 might be a good step towards this goal.
> 
> With this ticket, I get the following timings:
> 
> - `igraph`: 10 ms
> - dense `DiGraph`: 15 ms
> - sparse `DiGraph`: 32 ms

Nice!

> Note that sparse graphs also carry a copy of the reversed graph, so the actual arc is added twice.
> 
> Profiling suggests that this business of `get_vertex_checked` should be improved, especially in case of integers. For dense graphs this seems to take up almost all the time. (I'm not sure how to proceed with this.)

This is a pity. Maybe a flag `.has_integral_vertices` which implies that the graph has vertex set `{0, 1, ..., n-1}`? When the flag is set, one could bypass translations.

> This also implies that improving the data structure for sparse graphs could give us a large speedup here. (But I'm even less sure how to proceed with this.)

I did try in the past to rewrite sparse graph (do not remember which ticket), but it ended up being painful. Ideally we should just be wrapping some pure C implementation but vertex labels and edge labels are delicate to deal with.

Also, we could introduce a new (simpler) datastructure similar to static sparse graphs but for which one can reallocate individually the arrays used for neighbor lists. This can be amortized in terms of graph creation and would benefit from all algorithms already implemented for static sparse graph. However, such data structure will be a bit costly for merging vertices.



---

archive/issue_comments_396104.json:
```json
{
    "body": "Apparently, our heuristics are better for strings than for integers. So something must be wrong:\n\nThis is on top of #30769:\n\n\n```\nsage: set_random_seed(0)                                                                                                                                                                                                                                                                                                                                                   \nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                                                                                                                                                                                                                                                                  \nsage: D = DiGraph(multiedges=False, loops=True, sparse=False)\nsage: D.add_vertices([Integer(i) for i in range(1001)])                                                                                                                                                                                                                                                           \nsage: %time D.add_edges(edges)                                                                                                                                                                                                                                                                                                                                             \nCPU times: user 14.9 ms, sys: 0 ns, total: 14.9 ms\nWall time: 14.9 ms\n                                                                                                                                                                                                                                                                                    \nsage: set_random_seed(0)       \nsage: strings = [\"{}\".format(i) for i in range(1001)]                                                                                                                                                                                                                                                                                       \nsage: edges = [(strings[randint(0,1000)], strings[randint(0,1000)]) for _ in range(100000)]                                                                                                                                                                                                                                                                                \nsage: D = DiGraph(multiedges=False, loops=True, sparse=False)\nsage: D.add_vertices(strings)                                                                                                                                                                                                                                                                                     \nsage: %time D.add_edges(edges)                                                                                                                                                                                                                                                                                                                                             \nCPU times: user 11.2 ms, sys: 0 ns, total: 11.2 ms\nWall time: 11.3 ms\n\nsage: set_random_seed(0)                                                                                                                                                                                                                                                                                                                                                   \nsage: edges = [(int(randint(0,1000)), int(randint(0,1000))) for _ in range(100000)]                                                                                                                                                                                                                                                                                        \nsage: D = DiGraph(multiedges=False, loops=True, sparse=False)                                                                                                                                                                                                                                                                                                              \nsage: D.add_vertices(range(1001))                                                                                                                                                                                                                                                                                                                                          \nsage: %time D.add_edges(edges)                                                                                                                                                                                                                                                                                                                                             \nCPU times: user 14.6 ms, sys: 0 ns, total: 14.6 ms\nWall time: 14.6 ms\n```\n",
    "created_at": "2020-10-14T10:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396104",
    "user": "@kliem"
}
```

Apparently, our heuristics are better for strings than for integers. So something must be wrong:

This is on top of #30769:


```
sage: set_random_seed(0)                                                                                                                                                                                                                                                                                                                                                   
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                                                                                                                                                                                                                                                                  
sage: D = DiGraph(multiedges=False, loops=True, sparse=False)
sage: D.add_vertices([Integer(i) for i in range(1001)])                                                                                                                                                                                                                                                           
sage: %time D.add_edges(edges)                                                                                                                                                                                                                                                                                                                                             
CPU times: user 14.9 ms, sys: 0 ns, total: 14.9 ms
Wall time: 14.9 ms
                                                                                                                                                                                                                                                                                    
sage: set_random_seed(0)       
sage: strings = ["{}".format(i) for i in range(1001)]                                                                                                                                                                                                                                                                                       
sage: edges = [(strings[randint(0,1000)], strings[randint(0,1000)]) for _ in range(100000)]                                                                                                                                                                                                                                                                                
sage: D = DiGraph(multiedges=False, loops=True, sparse=False)
sage: D.add_vertices(strings)                                                                                                                                                                                                                                                                                     
sage: %time D.add_edges(edges)                                                                                                                                                                                                                                                                                                                                             
CPU times: user 11.2 ms, sys: 0 ns, total: 11.2 ms
Wall time: 11.3 ms

sage: set_random_seed(0)                                                                                                                                                                                                                                                                                                                                                   
sage: edges = [(int(randint(0,1000)), int(randint(0,1000))) for _ in range(100000)]                                                                                                                                                                                                                                                                                        
sage: D = DiGraph(multiedges=False, loops=True, sparse=False)                                                                                                                                                                                                                                                                                                              
sage: D.add_vertices(range(1001))                                                                                                                                                                                                                                                                                                                                          
sage: %time D.add_edges(edges)                                                                                                                                                                                                                                                                                                                                             
CPU times: user 14.6 ms, sys: 0 ns, total: 14.6 ms
Wall time: 14.6 ms
```




---

archive/issue_comments_396105.json:
```json
{
    "body": "in your timing, `strings` is not defined.",
    "created_at": "2020-10-14T12:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396105",
    "user": "dcoudert"
}
```

in your timing, `strings` is not defined.



---

archive/issue_comments_396106.json:
```json
{
    "body": "Replying to [comment:15 dcoudert]:\n> in your timing, `strings` is not defined.\n\nFixed.",
    "created_at": "2020-10-14T13:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396106",
    "user": "@kliem"
}
```

Replying to [comment:15 dcoudert]:
> in your timing, `strings` is not defined.

Fixed.



---

archive/issue_comments_396107.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28022#issuecomment-396107",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
