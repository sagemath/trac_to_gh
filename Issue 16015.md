# Issue 16015: optional doctest broken in oeis

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2014-04-27 14:17:46

Assignee: vdelecroix

CC:  tmonteil

Most of the doctests in oeis are broken (as the database has been updated).


---

Comment by vdelecroix created at 2014-04-27 14:56:21

Changing keywords from "" to "oeis, doctest".


---

Comment by vdelecroix created at 2014-04-27 14:56:21

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2014-04-27 14:56:21

New commits:


---

Comment by wluebbe created at 2014-05-02 09:06:43

2 doctest failures:

```
 ./sage -t --optional=sage,internet src/sage/databases/oeis.py
Running doctests with ID 2014-05-02-10-48-57-d24662df.
Doctesting 1 file.
sage -t src/sage/databases/oeis.py
**********************************************************************
File "src/sage/databases/oeis.py", line 835, in sage.databases.oeis.OEISSequence.keywords
Failed example:
    f.keywords()                          # optional -- internet
Expected:
    ('core', 'nonn', 'easy', 'nice', 'hear')
Got:
    ('core', 'nonn', 'easy', 'nice', 'hear', 'changed')
**********************************************************************
File "src/sage/databases/oeis.py", line 1730, in sage.databases.oeis.OEISSequence.programs
Failed example:
    ee = oeis('A001113') ; ee             # optional -- internet
Expected:
    A001113: Decimal expansion of e.
Got:
    Created new window in existing browser session.
    A001113: Decimal expansion of e.
**********************************************************************
2 items had failures:
   1 of   7 in sage.databases.oeis.OEISSequence.keywords
   1 of   7 in sage.databases.oeis.OEISSequence.programs
    [258 tests, 2 failures, 67.62 s]
----------------------------------------------------------------------
sage -t src/sage/databases/oeis.py  # 2 doctests failed
```

Have the keywords changed again `...,'nice', 'hear', 'changed')`? Then one could consider this test as brittle :-/


And the statement `Created new window in existing browser session.` is true - while not expected. It opened `http://oeis.org/A000045` a new tab in Chromium (ubuntu 14.04)


---

Comment by wluebbe created at 2014-05-02 09:06:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-05-02 09:32:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-05-02 09:33:26

Hi Wilfried,

Thanks for looking at this.

I modified a bit the first test in order to make it more robust to small changes in the database. I do not understand what happened with the second one. Only the method `browse` and `links` should open some windows in your browser. Could you try again?

Vincent


---

Comment by vdelecroix created at 2014-05-02 09:33:26

Changing status from needs_work to needs_review.


---

Comment by wluebbe created at 2014-05-02 11:19:16

Hi Vincent,

the first failure is gone - the second not.

I replaced `45` by `10` in line 1645 (doctest of `browse()` and got 

```
File "src/sage/databases/oeis.py", line 1645, in sage.databases.oeis.OEISSequence.browse
Failed example:
    f = oeis(10) ; f                      # optional -- internet, webbrowser
Expected:
    A000045: Fibonacci numbers: F(n) = F(n-1) + F(n-2) with F(0) = 0 and F(1) = 1.
Got:
    A000010: Euler totient function phi(n): count numbers <= n and prime to n.
**********************************************************************
File "src/sage/databases/oeis.py", line 1735, in sage.databases.oeis.OEISSequence.programs
Failed example:
    ee = oeis('A001113') ; ee             # optional -- internet
Expected:
    A001113: Decimal expansion of e.
Got:
    Created new window in existing browser session.
    A001113: Decimal expansion of e.
**********************************************************************
2 items had failures:
   1 of   3 in sage.databases.oeis.OEISSequence.browse
   1 of   7 in sage.databases.oeis.OEISSequence.programs
    [261 tests, 2 failures, 71.93 s]
```

Now the first failure is expected. My browser opened `http://oeis.org/A000010`.
This seems to indicate that the new message `Created new ...` is left over by the doctest of browse(). But why? Don't you see this behavior?

This is what I get in a terminal

```
sage: import sage.databases.o
sage.databases.odlyzko  sage.databases.oeis     
sage: import sage.databases.oeis
sage: f = oeis(1)
sage: f
A000001: Number of groups of order n.
sage: f.browse()
sage: Created new window in existing browser session.

sage: f.show()
ID
A000001
```

After `sage: Created new window in existing browser session.` I had to press ENTER to  see the `sage:` prompt again.


---

Comment by wluebbe created at 2014-05-02 11:19:16

Changing status from needs_review to needs_work.


---

Comment by wluebbe created at 2014-05-05 14:26:41

The doctest failure is likely environment dependent:


The module `webbrowser` is a Python standard module. It use some logic to select a suitable browser and calls it with `subprocess.Popen()`. The message `Created new ...` is issued by Chromium (revealed be a Google search :-).

Today I closed my Chromium //Version 34.0.1847.116 Ubuntu 14.04 aura (260972)// before starting the test. The result:

```
File "src/sage/databases/oeis.py", line 1735, in sage.databases.oeis.OEISSequence.programs
Failed example:
    ee = oeis('A001113') ; ee             # optional -- internet
Expected:
    A001113: Decimal expansion of e.
Got:
    ATTENTION: default value of option force_s3tc_enable overridden by environment.
    [12960:12960:0505/151917:ERROR:sandbox_linux.cc(268)] InitializeSandbox() called with multiple threads in process gpu-process
    A001113: Decimal expansion of e.
**********************************************************************
1 item had failures:
   1 of   7 in sage.databases.oeis.OEISSequence.programs
    [261 tests, 1 failure, 78.67 s]
```

So there are environments (e.g. mine) that can produce some unexpected browser output.

At last I got `All tests passed!` with 

```
            sage: ee = oeis('A001113') ; ee             # optional -- internet
            Created new window in existing browser session.
            A001113: Decimal expansion of e.
```

But this is not really a solution :-((


---

Comment by vdelecroix created at 2014-05-05 15:32:00

Hi,

I do have a problem since the line

```
sage: ee = oeis('A001113')
```

does not call webbrowser. It is only the following that does

```
sage: ee.browse()
```

Hence I do not really understand what happens on your computer (even if it is now clear that it depends on the browser).

Maybe there is a way to turn off the writing of the subprocess on stdout/stderr... I will dig in. There are partial answers on [stackoverflow](http://stackoverflow.com/questions/1352361/suppress-redirect-stderr-when-calling-python-webrowser) but which are plateform and installation dependent... but it is better than nothing!

Vincent


---

Comment by wluebbe created at 2014-05-05 16:07:19

Hi Vincent, 

the browser is called in a doctest of `browse()` in line 1645 `sage: f = oeis(45) ; f`. 

This can be seen in my comment 5 where I changed `oeis(45)` to `oeis(10)`. The browser opened A000010. The message from Chromium then surfaced in the other (later) doctest from line 1735.

Maybe this is (one more) hint that //some// test are better suited for a testing framework like [nose](https://pypi.python.org/pypi/nose/1.3.2) or [py.test](https://pypi.python.org/pypi/pytest/2.5.2). But that's a whole new story ...


---

Comment by git created at 2014-05-05 16:34:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-05-05 16:35:55

Hi,

There was a typo in the documentation. In order to skip the doctest one should write

```
sage: f.browse() # optional -- internet webbrowser
```

and not

```
sage: f.browse() # optional -- internet, webbrowser
```


I did the correction in the last commit. Could you try again? You should get no error with

```
./sage -t --optional=sage,internet SAGE_ROOT/src/sage/databases/oeis.py
```

but might get one with

```
./sage -t --optional=sage,internet,webbrowser SAGE_ROOT/src/sage/databases/oeis.py
```


Vincent


---

Comment by wluebbe created at 2014-05-05 19:22:58

Changing status from needs_work to positive_review.


---

Comment by wluebbe created at 2014-05-05 19:22:58

Hi,

just as you predicted ...

```
~/sage-6.2.rc0$ ./sage -t --optional=sage,internet src/sage/databases/oeis.py
Running doctests with ID 2014-05-05-21-13-21-9a2728e4.
Doctesting 1 file.
sage -t src/sage/databases/oeis.py
    [259 tests, 74.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 74.1 seconds
    cpu time: 1.4 seconds
    cumulative wall time: 74.0 seconds
wluebbe`@`Willis-Ubuntu:~/sage-6.2.rc0$ ./sage -t --optional=sage,internet,webbrowser src/sage/databases/oeis.py
Running doctests with ID 2014-05-05-21-16-48-fbdfca29.
Doctesting 1 file.
sage -t src/sage/databases/oeis.py
**********************************************************************
File "src/sage/databases/oeis.py", line 637, in sage.databases.oeis.OEISSequence.__init__
Failed example:
    sfibo = oeis('A039834')               # optional -- internet
Expected nothing
Got:
    Created new window in existing browser session.
**********************************************************************
File "src/sage/databases/oeis.py", line 1735, in sage.databases.oeis.OEISSequence.programs
Failed example:
    ee = oeis('A001113') ; ee             # optional -- internet
Expected:
    A001113: Decimal expansion of e.
Got:
    Created new window in existing browser session.
    Created new window in existing browser session.
    A001113: Decimal expansion of e.
**********************************************************************
2 items had failures:
   1 of   3 in sage.databases.oeis.OEISSequence.__init__
   1 of   7 in sage.databases.oeis.OEISSequence.programs
    [264 tests, 2 failures, 76.03 s]
----------------------------------------------------------------------
sage -t src/sage/databases/oeis.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 76.1 seconds
    cpu time: 1.4 seconds
    cumulative wall time: 76.0 seconds
```

Therefore I say: the patch looks good! - Doctest with (optional) webbrowser Chromium is a different story.


---

Comment by vdelecroix created at 2014-05-05 21:07:32

Thanks!

Vincent


---

Comment by tmonteil created at 2014-05-05 22:05:35

Hi,

i am a bit lost with the new framework, how it is possible that this ticket get positive review while  #14567 is not settled ?

Could it be better to fix OEIS-changes in a self-contained ticket, and continued_fractions changes (even in oeis.py) in the other one ?


---

Comment by vdelecroix created at 2014-05-06 04:54:06

Hi Thierry,

In the current state, this one will wait until #14567 gets reviewed. If there are some changes in #14567 then either there is a trivial merge and everything is fine, or the merge is non trivial and it will need another (short) review.

It might be better that #14567 gets reviewed... if you want to fix this one independently of #14567, it is up to you.

Vincent


---

Comment by wluebbe created at 2014-05-07 11:56:24

Changing status from positive_review to needs_work.


---

Comment by wluebbe created at 2014-05-07 11:56:24

While focusing on the doctest failures in `oeis.py` I missed the on dependency #14567 (and that the patch contained much more than `oeis.py`).

Therefore I think this ticket should stay with //needs review// until #14567 is positive. Then I will review this again :-)

Meanwhile I discovered some more optional doctest failures (#16302) ...


---

Comment by wluebbe created at 2014-05-07 11:56:32

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-11-07 13:01:17

Changing component from documentation to doctest coverage.


---

Comment by vdelecroix created at 2015-02-01 11:17:29

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-02-01 11:17:29

The doctests are broken again due to updates in the sloane database...

Vincent


---

Comment by tmonteil created at 2015-06-10 18:03:00

Since i could not merge Vincent's branch to the current develop branch, i made a new one based on latest 6.8.beta3 (and current version of OEIS).
----
New commits:


---

Comment by tmonteil created at 2015-06-10 18:03:00

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2015-06-10 18:22:13

I agree that the tests need to be fixed, but can we do it in such a way that they won't break frequently due to changes in the database?


---

Comment by chapoton created at 2015-06-10 18:28:58

I have made some pep8 cleanup.

I was about to give a positive review, but I agree it is not good to be forced to update the test all the time..
----
New commits:


---

Comment by jhpalmieri created at 2015-06-10 19:12:48

To expand on this: because of #18558, many tests labeled "optional" will now be run. This is not true yet for "optional - internet" tests, but that could change, and then we want robust tests.


---

Comment by jdemeyer created at 2015-06-10 19:24:49

I don't like this: `\xc3\xa9`: can we please support unicode instead?


---

Comment by jdemeyer created at 2015-06-10 19:27:51

This needs to be rebased to #18637.


---

Comment by jdemeyer created at 2015-06-10 19:30:42

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-10 19:30:42

And this also looks like a regression:

```diff
- QQ as continued fractions
+ <class 'sage.rings.continued_fraction.ContinuedFraction_periodic'>
```



---

Comment by vdelecroix created at 2015-06-10 19:39:32

Replying to [comment:28 jdemeyer]:
> And this also looks like a regression:
> {{{
> #!diff
> - QQ as continued fractions
> + <class 'sage.rings.continued_fraction.ContinuedFraction_periodic'>
> }}}

It is not (or at least independent from that ticket). Comes from #14567.


---

Comment by jdemeyer created at 2015-06-10 19:46:35

Replying to [comment:29 vdelecroix]:
> Comes from #14567.
I think it comes from this change on this ticket:

```diff
- return ContinuedFractionField()(self.first_terms())
+ from sage.rings.continued_fraction import continued_fraction
+ return continued_fraction(self.first_terms())
```



---

Comment by vdelecroix created at 2015-06-10 19:51:19

Replying to [comment:30 jdemeyer]:
> Replying to [comment:29 vdelecroix]:
> > Comes from #14567.
> I think it comes from this change on this ticket:
> {{{
> #!diff
> - return ContinuedFractionField()(self.first_terms())
> + from sage.rings.continued_fraction import continued_fraction
> + return continued_fraction(self.first_terms())
> }}}

Right. But the continued fraction field is likely to be deprecated. It serves no purpose unless being there.


---

Comment by tmonteil created at 2015-06-10 20:26:30

Concerning workaround doctests that are robust to database changes.

Replying to [comment:23 jhpalmieri]:
> I agree that the tests need to be fixed, but can we do it in such a way that they won't break frequently due to changes in the database?

The "doc" part of the doctest is important too. As you can check, most failed doctests are designed to be examples for the user. I think the user should be exposed to what she will actually get, even if there is some small noise in the result, humans can adapt to such noise, and they need examples.

Replying to [comment:24 chapoton]:
> I was about to give a positive review, but I agree it is not good to be forced to update the test all the time..

We are not, the users are able to understand the examples even if they slightly differ from what they will get by testing themselves. In my opinion, those should be updated from time to time but there is no hurry to be on the edge, it is not like openssl or so.

Replying to [comment:25 jhpalmieri]:
> To expand on this: because of #18558, many tests labeled "optional" will now be run. This is not true yet for "optional - internet" tests, but that could change, and then we want robust tests.

I am -1 to run the internet doctests by default, or we are going to flood OEIS servers for almost no benefit. Actually, this is why a fake OEIS entry is hardcoded in the file (those tests are run everytime).

The robustness can be achieved as follows : run internet doctests once before a release and fix them if they are severe (e.g. change in the database structure, change in the URL scheme).


---

Comment by tmonteil created at 2015-06-10 20:40:03

Replying to [comment:31 vdelecroix]:
> 
> Right. But the continued fraction field is likely to be deprecated. It serves no purpose unless being there.


To complement Vincent's answer, there is a semantic issue in using `ContinuedFractionField()`.

The problem is that most (if not all) continued fractions in OEIS corrrespond to irrational numbers (OEIS is not much about periodic sequences), so a parent modelling the rationals is not appropriate, even if we only have the fist few partial coefficients (like elements of `RDF` are rationals but do not represent rational numbers). Perhaps should we use `type` instead of `parent` here (i used `parent` to be consistent with other cases) ?

Actually, i am planning to plug infinite sequences implemented in Sage with oeis calss (e.g. Fibonacci), so that we could ask for arbitrary many partial coefficients for the related continued fraction, not only those provided by `.first_terms()` method.


---

Comment by jhpalmieri created at 2015-06-10 21:32:53

Replying to [comment:32 tmonteil]:
> Concerning workaround doctests that are robust to database changes.
> 
> Replying to [comment:23 jhpalmieri]:
> > I agree that the tests need to be fixed, but can we do it in such a way that they won't break frequently due to changes in the database?
> 
> The "doc" part of the doctest is important too. 

Of course there has to be a balance, but I don't know of any examples where we intentionally allow failed doctests for the sake of this balance. Instead, it is often possible to write doctests which are both illustrative and correct.

> Replying to [comment:25 jhpalmieri]:
> > To expand on this: because of #18558, many tests labeled "optional" will now be run. This is not true yet for "optional - internet" tests, but that could change, and then we want robust tests.
> 
> I am -1 to run the internet doctests by default, or we are going to flood OEIS servers for almost no benefit. Actually, this is why a fake OEIS entry is hardcoded in the file (those tests are run everytime).

I think there may be valid reasons to not run internet doctests by default, but I'm not  convinced by this one. If you are worried that we might flood the OEIS servers, then rewrite the doctests to avoid this. For example, I can easily imagine someone adding "internet" to the optional doctest tags for the patchbots.

> The robustness can be achieved as follows : run internet doctests once before a release and fix them if they are severe (e.g. change in the database structure, change in the URL scheme).

According to everything I know about Sage's doctesting, there is no tolerance for failed doctests. We don't fix them only if they are severe.


---

Comment by jdemeyer created at 2015-06-10 21:43:00

Replying to [comment:31 vdelecroix]:
> Right. But the continued fraction field is likely to be deprecated. It serves no purpose unless being there.

Fine, but then change the `parent()` doctest to `type()`. The fact that `parent()` returns `type()` for a non-`Element` is an implementation detail which shouldn't be exposed by these doctests.

(of course, I wonder why the result of `continued_fraction()` is no longer an `Element` but that's off topic)


---

Comment by git created at 2015-06-12 11:14:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-12 11:22:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-06-12 12:05:01

Replying to [comment:34 jhpalmieri]:
> Of course there has to be a balance, but I don't know of any examples where we intentionally allow failed doctests for the sake of this balance. Instead, it is often possible to write doctests which are both illustrative and correct.

The goal of this ticket is precisely about fixing broken doctests. We do not intentionally allow failed doctests, they will all be illustrative and correct once this ticket get merged. I am just saying that such broken doctests do not exhibit new bugs or regression in Sage, but only minor changes in remote database. As such, they are less important than all the nonfixed bugs that are waiting on trac without breaking any doctest. The aim of this module is about querying a remote dynamic database, if we want to be illustrative, we should show the results provided by the database, and they are subject to changes.

> I think there may be valid reasons to not run internet doctests by default, but I'm not  convinced by this one. If you are worried that we might flood the OEIS servers, then rewrite the doctests to avoid this. For example, I can easily imagine someone adding "internet" to the optional doctest tags for the patchbots.

The thing is that i do not want to use something like `not tested` because it should be possible to test them in order to fix them easily. Since the doctests should still be runable, they will be runable by any patchbot as well. What do you suggest ? Should we add a `please_do_not_run_by_default` keyword ?


---

Comment by jdemeyer created at 2015-06-12 12:17:22

Replying to [comment:38 tmonteil]:
> Should we add a `please_do_not_run_by_default` keyword ?
I think that keyword is called `optional - internet`.


---

Comment by git created at 2015-06-12 12:38:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-06-12 13:10:57

Replying to [comment:27 jdemeyer]:
> This needs to be rebased to #18637.

I can not fetch the branch, `git trac fetch 18637` leads to an error.


---

Comment by tmonteil created at 2015-06-12 17:34:28

Replying to [comment:41 tmonteil]:
> I can not fetch the branch, `git trac fetch 18637` leads to an error.

It seems that i have been victim of [this](http://thread.gmane.org/gmane.comp.mathematics.sage.devel/75678) [issue](https://groups.google.com/forum/?fromgroups#!searchin/sage-devel/branch$20ticket$20closed/sage-devel/FJuKA4OiMWY/mAJeDFlAXX8J).


---

Comment by git created at 2015-06-12 17:35:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-06-12 17:51:52

I hope i did the merge the correct way. What looks weird to me is that when i click on the merge commit ([50b983a](http://git.sagemath.org/sage.git/commit/?id=50b983ae7a64a3ae7cd3e7c55a021f24e65dd30c)) i see tons of changes that correspond to #18637, wile i would expect to see only the few minor choices i had to make between the two versions. So, i wonder how could this be reviewed. Is there a got tool to see what non-automatic was done in a merge commit ? Otherwise, i could use a merge commit to insert some bad code and be almost sure that it will not be reviewed because it will be considered as code coming from the other branch.


---

Comment by tmonteil created at 2015-06-12 17:52:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-12 19:50:29

Replying to [comment:44 tmonteil]:
> I hope i did the merge the correct way. What looks weird to me is that when i click on the merge commit ([50b983a](http://git.sagemath.org/sage.git/commit/?id=50b983ae7a64a3ae7cd3e7c55a021f24e65dd30c)) i see tons of changes that correspond to #18637, wile i would expect to see only the few minor choices i had to make between the two versions. So, i wonder how could this be reviewed. Is there a got tool to see what non-automatic was done in a merge commit ? Otherwise, i could use a merge commit to insert some bad code and be almost sure that it will not be reviewed because it will be considered as code coming from the other branch.
I think it's best to review the branch as a whole, not the individual commits. Especially for a ticket like this with not so many changes this is the best.


---

Comment by chapoton created at 2015-06-13 12:15:05

patchbot now complains about pickle. This usually means a unicode character problem.
Maybe the word "Lamé" is the culprit..


---

Comment by git created at 2015-06-13 16:35:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-06-22 19:52:33

Apparently, no patchbot is willing to work on this ticket anymore :/


---

Comment by git created at 2015-07-08 16:32:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-07-08 19:01:38

Just a detail, but what's with all the changes of the form

```diff
- sage: oeis(seq)[0]  # optional - internet
+ sage: oeis(seq)[0]                              # optional -- internet
```



---

Comment by tmonteil created at 2015-07-08 22:29:34

It is more readable when you access the doc from the command line.


---

Comment by ncohen created at 2015-09-02 12:41:00

Broken doctest in `combinat/species/library.py`. Otherwise it looks good.

Nathann


---

Comment by ncohen created at 2015-09-02 12:41:00

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-09-02 13:11:42

Actually:


```
sage -t --long quickref.py  # 1 doctest failed
sage -t --long integer_list.py  # 1 doctest failed
sage -t --long species/library.py  # 1 doctest failed

```



---

Comment by chapoton created at 2015-09-18 11:25:08

Very broken:

```
sage -t --optional=sage,internet src/sage/databases/oeis.py
```

gives

```
sage -t src/sage/databases/oeis.py  # 25 doctests failed
```



---

Comment by ncohen created at 2015-09-18 12:01:03

Instead of fixing the doctests by changing their expected output, we should really test those features without relying on the exact text received from the OEIS. These doctests are broken most of the time nowadays.

Nathann


---

Comment by tmonteil created at 2015-09-18 19:29:15

Replying to [comment:54 ncohen]:
> Actually:
> 
> {{{
> sage -t --long quickref.py  # 1 doctest failed
> sage -t --long integer_list.py  # 1 doctest failed
> sage -t --long species/library.py  # 1 doctest failed
> 
> }}}

Thanks, i updated the branch (and merged it with the latest beta).


---

Comment by git created at 2015-09-18 19:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-09-18 19:30:41

Replying to [comment:55 chapoton]:
> Very broken:
> {{{
> sage -t --optional=sage,internet src/sage/databases/oeis.py
> }}}
> gives
> {{{
> sage -t src/sage/databases/oeis.py  # 25 doctests failed
> }}}

I do not see any error here, did you apply the branch ?


---

Comment by tmonteil created at 2015-09-18 19:46:57

Replying to [comment:56 ncohen]:
> Instead of fixing the doctests by changing their expected output, we should really test those features without relying on the exact text received from the OEIS. These doctests are broken most of the time nowadays.
> 
> Nathann

The problem is that those doctests have a role of documentation, not test. They are an illustration of some mathematical concept, hence the actual text is important. In the last commit, the oeis calls are supposed to illustrate things about:

- Genus of modular group Gamma_0(n),
- Motzkin numbers,
- species of simple graphs,
- Coefficients of a Bessel function,

not about testing Sage/oeis features, so writing indirect doctests that will not show the results provided by the OEIS database might not be interesting.


---

Comment by tmonteil created at 2015-09-18 19:47:36

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-09-18 19:57:24

> The problem is that those doctests have a role of documentation, not test. 

Then add a `# random` flag at the end of those lines, so that the tests do not break so often. And where you actually need to test something, add it in a TEST section where you can be as unclear as you want to test what you want to test (as you don't need to be understood by a newcomer), so that what should be tested is tested.

Nathann


---

Comment by tmonteil created at 2015-09-19 08:37:43

Replying to [comment:62 ncohen]:
> Then add a `# random` flag at the end of those lines, so that the tests do not break so often. And where you actually need to test something, add it in a TEST section where you can be as unclear as you want to test what you want to test (as you don't need to be understood by a newcomer), so that what should be tested is tested.

The tests do not break at all thanks to the `# internet` flag, which is not turned on by default. It has the same effect than `# random` except that we can run them from time to time to check/update.

Please read the whole thread, all this has already been discussed, in particular see [comment:39 comment 39 (jdemeyer)]:
> Replying to [comment:38 tmonteil]:
> > Should we add a `please_do_not_run_by_default` keyword ?
> I think that keyword is called `optional - internet`.


---

Comment by ncohen created at 2015-09-19 08:51:33

> The tests do not break at all thanks to the `# internet` flag, which is not turned on by default. It has the same effect than `# random` except that we can run them from time to time to check/update.

No, it has not. It gives you a way to have a clean documentation that is helpful to the users even if the remote database changes, and it gives you a way to write consistent tests why will not break even if the database changes.

> Please read the whole thread

I do not care at all if you like to write broken test and to fix them every two months. I just mentionned a way to do the job properly, and I will not fight with you if you do not care. Have fun fixing them again in 6 months.

Nathann


---

Comment by tmonteil created at 2015-09-29 14:12:01

Thanks for your actual contribution on this ticket.

Now, if someone could review it, the changes could enter Sage.


---

Comment by git created at 2015-11-13 20:01:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-13 20:49:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-22 13:20:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-01-22 13:32:12

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-01-22 13:32:12

ok, looks good to me.


---

Comment by vbraun created at 2016-01-23 20:42:38

Resolution: fixed
