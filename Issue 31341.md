# Issue 31341: System gcc with multilib support generates linker (ld) warnings when running doctests

archive/issues_031341.json:
```json
{
    "body": "CC:  @kiwifb @mkoeppe @orlitzky @dimpase @isuruf\n\nWith `9.3.rc0` typical results with multilib support in gcc:\n\n```\n./sage -t --random-seed=0 src/sage/misc/cython.py\n**********************************************************************\nFile \"src/sage/misc/cython.py\", line 136, in sage.misc.cython.?\nFailed example:\n    cython(os.linesep.join(code))\nExpected nothing\nGot:\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.so when searching for -ldl\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.a when searching for -ldl\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.so when searching for -ldl\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.a when searching for -ldl\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libm.so when searching for -lm\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libm.a when searching for -lm\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libpthread.so when searching for -lpthread\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libpthread.a when searching for -lpthread\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libc.so when searching for -lc\n    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libc.a when searching for -lc\n```\n\nThere is no such problem with `9.3.beta7`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31578\n\n",
    "created_at": "2021-03-29T17:43:34Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "System gcc with multilib support generates linker (ld) warnings when running doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31341",
    "user": "https://github.com/strogdon"
}
```
CC:  @kiwifb @mkoeppe @orlitzky @dimpase @isuruf

With `9.3.rc0` typical results with multilib support in gcc:

```
./sage -t --random-seed=0 src/sage/misc/cython.py
**********************************************************************
File "src/sage/misc/cython.py", line 136, in sage.misc.cython.?
Failed example:
    cython(os.linesep.join(code))
Expected nothing
Got:
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.so when searching for -ldl
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.a when searching for -ldl
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.so when searching for -ldl
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libdl.a when searching for -ldl
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libm.so when searching for -lm
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libm.a when searching for -lm
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libpthread.so when searching for -lpthread
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libpthread.a when searching for -lpthread
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libc.so when searching for -lc
    /usr/lib/gcc/x86_64-pc-linux-gnu/10.2.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible ///usr/lib/libc.a when searching for -lc
```

There is no such problem with `9.3.beta7`.

Issue created by migration from https://trac.sagemath.org/ticket/31578





---

archive/issue_comments_447735.json:
```json
{
    "body": "Using `git bisect` to locate the commit that is causing the issue I have from `git bisect log`:\n\n```\ngit bisect start\n# bad: [2c25f07cfd0cbb5cb4a9b57b7bc62ec997039987] Updated SageMath version to 9.3.rc0\ngit bisect bad 2c25f07cfd0cbb5cb4a9b57b7bc62ec997039987\n# good: [8453ffb849b047893b6c61dd09176a84c9133342] Updated SageMath version to 9.3.beta7\ngit bisect good 8453ffb849b047893b6c61dd09176a84c9133342\n# bad: [d32f41ee20a421ca91f36abbf889b4b4792f4822] Trac #20784: not all symbolic equations stay unevaluated\ngit bisect bad d32f41ee20a421ca91f36abbf889b4b4792f4822\n# good: [8ff8b0b90c78d09fb2e71ee35205e96371e60f05] Trac #30537: Upgrade giac to 1.6.0-47\ngit bisect good 8ff8b0b90c78d09fb2e71ee35205e96371e60f05\n# good: [2bcac009dd878272858ece0d853a67571fcd1c0d] Trac #31317: eclib interface uses bad default value for elliptic curve modular symbols\ngit bisect good 2bcac009dd878272858ece0d853a67571fcd1c0d\n# bad: [64c1336fc356f17406c579e2471e0fa92f0e9123] Trac #31373: Upgrade ipython to 7.20.0 and jedi to 0.18.0\ngit bisect bad 64c1336fc356f17406c579e2471e0fa92f0e9123\n# good: [74cfd6dbc612f8aad20cbfb67d672a4157f60b89] Trac #31358: python3 spkg-configure.m4: Do not reject python based on sysconfig LDFLAGS containing \"-L.\"\ngit bisect good 74cfd6dbc612f8aad20cbfb67d672a4157f60b89\n# good: [70cbb47cb79de70c21d00ed2aad8eb90f035f8b5] Trac #31364: Don't use deprecated numpy type aliases\ngit bisect good 70cbb47cb79de70c21d00ed2aad8eb90f035f8b5\n```\n\nThe next commit that is to be tested is\n\n```\ncommit 7b1e27b96e143d6d44b448692ba266050e667399 (HEAD)\nAuthor: Matthias Koeppe <mkoeppe@math.ucdavis.edu>\nDate:   Wed Feb 10 19:36:48 2021 -0800\n\n    Merge distutils directives for Cython files using ntl\n```\n\nwhich fails to build with\n\n```\nTraceback (most recent call last):\n  File \"/local/sage-git/sage/build/pkgs/sagelib/src/setup.py\", line 21, in <module>\n    import sage.env\n  File \"/local/sage-git/sage/build/pkgs/sagelib/src/sage/env.py\", line 160, in <module>\n    HOSTNAME = var(\"HOSTNAME\", socket.gethostname())\n  File \"/local/sage-git/sage/build/pkgs/sagelib/src/sage/env.py\", line 144, in var\n    import sage_conf\n  File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage_conf.py\", line 9\n    NTL_INCDIR = \".\n                   ^\nSyntaxError: EOL while scanning string literal\n```\n\nSomehow `sage_conf.py` has gotten corrupted?\n\n```\n# build/pkgs/sage_conf/src/sage_conf.py.  Generated from sage_conf.py.in by configure.\n\nVERSION = \"9.3.beta7\"\n\nMAXIMA = \"/local/sage-git/sage/local/bin/maxima\"\n\nARB_LIBRARY = \"arb\"\n\nNTL_INCDIR = \".\n.\n///usr/include/NTL\"\nNTL_LIBDIR = \".\n.\n///usr/include\"\n```\n",
    "created_at": "2021-03-29T17:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447735",
    "user": "https://github.com/strogdon"
}
```

Using `git bisect` to locate the commit that is causing the issue I have from `git bisect log`:

```
git bisect start
# bad: [2c25f07cfd0cbb5cb4a9b57b7bc62ec997039987] Updated SageMath version to 9.3.rc0
git bisect bad 2c25f07cfd0cbb5cb4a9b57b7bc62ec997039987
# good: [8453ffb849b047893b6c61dd09176a84c9133342] Updated SageMath version to 9.3.beta7
git bisect good 8453ffb849b047893b6c61dd09176a84c9133342
# bad: [d32f41ee20a421ca91f36abbf889b4b4792f4822] Trac #20784: not all symbolic equations stay unevaluated
git bisect bad d32f41ee20a421ca91f36abbf889b4b4792f4822
# good: [8ff8b0b90c78d09fb2e71ee35205e96371e60f05] Trac #30537: Upgrade giac to 1.6.0-47
git bisect good 8ff8b0b90c78d09fb2e71ee35205e96371e60f05
# good: [2bcac009dd878272858ece0d853a67571fcd1c0d] Trac #31317: eclib interface uses bad default value for elliptic curve modular symbols
git bisect good 2bcac009dd878272858ece0d853a67571fcd1c0d
# bad: [64c1336fc356f17406c579e2471e0fa92f0e9123] Trac #31373: Upgrade ipython to 7.20.0 and jedi to 0.18.0
git bisect bad 64c1336fc356f17406c579e2471e0fa92f0e9123
# good: [74cfd6dbc612f8aad20cbfb67d672a4157f60b89] Trac #31358: python3 spkg-configure.m4: Do not reject python based on sysconfig LDFLAGS containing "-L."
git bisect good 74cfd6dbc612f8aad20cbfb67d672a4157f60b89
# good: [70cbb47cb79de70c21d00ed2aad8eb90f035f8b5] Trac #31364: Don't use deprecated numpy type aliases
git bisect good 70cbb47cb79de70c21d00ed2aad8eb90f035f8b5
```

The next commit that is to be tested is

```
commit 7b1e27b96e143d6d44b448692ba266050e667399 (HEAD)
Author: Matthias Koeppe <mkoeppe@math.ucdavis.edu>
Date:   Wed Feb 10 19:36:48 2021 -0800

    Merge distutils directives for Cython files using ntl
```

which fails to build with

```
Traceback (most recent call last):
  File "/local/sage-git/sage/build/pkgs/sagelib/src/setup.py", line 21, in <module>
    import sage.env
  File "/local/sage-git/sage/build/pkgs/sagelib/src/sage/env.py", line 160, in <module>
    HOSTNAME = var("HOSTNAME", socket.gethostname())
  File "/local/sage-git/sage/build/pkgs/sagelib/src/sage/env.py", line 144, in var
    import sage_conf
  File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage_conf.py", line 9
    NTL_INCDIR = ".
                   ^
SyntaxError: EOL while scanning string literal
```

Somehow `sage_conf.py` has gotten corrupted?

```
# build/pkgs/sage_conf/src/sage_conf.py.  Generated from sage_conf.py.in by configure.

VERSION = "9.3.beta7"

MAXIMA = "/local/sage-git/sage/local/bin/maxima"

ARB_LIBRARY = "arb"

NTL_INCDIR = ".
.
///usr/include/NTL"
NTL_LIBDIR = ".
.
///usr/include"
```




---

archive/issue_comments_447736.json:
```json
{
    "body": "`@`mkoeppe perhaps you have some insight into this. It's not clear to me why `sage_conf.py` is corrupted which prevents further bisecting. I have implemented the bisecting twice with the same result.",
    "created_at": "2021-03-29T18:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447736",
    "user": "https://github.com/strogdon"
}
```

`@`mkoeppe perhaps you have some insight into this. It's not clear to me why `sage_conf.py` is corrupted which prevents further bisecting. I have implemented the bisecting twice with the same result.



---

archive/issue_comments_447737.json:
```json
{
    "body": "You should be able to see these corrupted values already in `config.status`. \nThey are determined by `build/pkgs/ntl/spkg-configure.m4` using a (horrible) macro called `AX_ABSOLUTE_HEADER`.",
    "created_at": "2021-03-29T18:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447737",
    "user": "https://github.com/mkoeppe"
}
```

You should be able to see these corrupted values already in `config.status`. 
They are determined by `build/pkgs/ntl/spkg-configure.m4` using a (horrible) macro called `AX_ABSOLUTE_HEADER`.



---

archive/issue_comments_447738.json:
```json
{
    "body": "From `config.status` there is\n\n```\nS[\"SAGE_FLINT_PREFIX\"]=\"\"\nS[\"NTL_LIBDIR\"]=\".\\n\"\\\n\".\\n\"\\\n\"///usr/include\"\nS[\"NTL_INCDIR\"]=\".\\n\"\\\n\".\\n\"\\\n\"///usr/include/NTL\"\nS[\"SAGE_NTL_PREFIX\"]=\"\"\n```\n",
    "created_at": "2021-03-29T18:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447738",
    "user": "https://github.com/strogdon"
}
```

From `config.status` there is

```
S["SAGE_FLINT_PREFIX"]=""
S["NTL_LIBDIR"]=".\n"\
".\n"\
"///usr/include"
S["NTL_INCDIR"]=".\n"\
".\n"\
"///usr/include/NTL"
S["SAGE_NTL_PREFIX"]=""
```




---

archive/issue_comments_447739.json:
```json
{
    "body": "Yes. So, as I thought, the error is made in the `configure` script.\n\nYou can try to debug this using `CONFIG_SHELL=\"bash -x\" ./configure`.",
    "created_at": "2021-03-29T18:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447739",
    "user": "https://github.com/mkoeppe"
}
```

Yes. So, as I thought, the error is made in the `configure` script.

You can try to debug this using `CONFIG_SHELL="bash -x" ./configure`.



---

archive/issue_comments_447740.json:
```json
{
    "body": "What platform is this, by the way?",
    "created_at": "2021-03-29T19:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447740",
    "user": "https://github.com/mkoeppe"
}
```

What platform is this, by the way?



---

archive/issue_comments_447741.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> What platform is this, by the way?\nGentoo\n\n\n```\nLinux hp-probook 5.4.97-gentoo-x86_64 #16 SMP Mon Mar 15 21:41:09 MDT 2021 x86_64 AMD Ryzen 7 4700U with Radeon Graphics AuthenticAMD GNU/Linux\n```\n\nSame issue on\n\n```\nLinux hp-envy 5.4.38-gentoo #7 SMP Sat Jan 16 21:46:51 MST 2021 x86_64 Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz GenuineIntel GNU/Linux\n```\n",
    "created_at": "2021-03-29T19:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447741",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:6 mkoeppe]:
> What platform is this, by the way?
Gentoo


```
Linux hp-probook 5.4.97-gentoo-x86_64 #16 SMP Mon Mar 15 21:41:09 MDT 2021 x86_64 AMD Ryzen 7 4700U with Radeon Graphics AuthenticAMD GNU/Linux
```

Same issue on

```
Linux hp-envy 5.4.38-gentoo #7 SMP Sat Jan 16 21:46:51 MST 2021 x86_64 Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz GenuineIntel GNU/Linux
```




---

archive/issue_comments_447742.json:
```json
{
    "body": "The NTL variables in `sage_conf` were introduced in 6e30e3ac2d891a16fdd1ad89506db767d4edb9e5 in #31365.\n\nHelp with fixing this issue is welcome. Note that 9.3.rc0 built fine on gentoo in https://github.com/sagemath/sage/runs/2180104858?check_suite_focus=true",
    "created_at": "2021-03-29T19:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447742",
    "user": "https://github.com/mkoeppe"
}
```

The NTL variables in `sage_conf` were introduced in 6e30e3ac2d891a16fdd1ad89506db767d4edb9e5 in #31365.

Help with fixing this issue is welcome. Note that 9.3.rc0 built fine on gentoo in https://github.com/sagemath/sage/runs/2180104858?check_suite_focus=true



---

archive/issue_comments_447743.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> The NTL variables in `sage_conf` were introduced in 6e30e3ac2d891a16fdd1ad89506db767d4edb9e5 in #31365.\n> \n> Help with fixing this issue is welcome. Note that 9.3.rc0 built fine on gentoo in https://github.com/sagemath/sage/runs/2180104858?check_suite_focus=true\n\nFor `9.3.rc0`, `sage_conf.py` contains\n\n```\n# build/pkgs/sage_conf/src/sage_conf.py.  Generated from sage_conf.py.in by configure.\n\nVERSION = \"9.3.rc0\"\n\nMAXIMA = \"/local/sage-git/sage/local/bin/maxima\"\n\nARB_LIBRARY = \"arb\"\n\nNTL_INCDIR = \"///usr/include\"\nNTL_LIBDIR = \"///usr/lib\" \n```\n\n\nSo the question is whether the `///` are causing the linker warnings when doctesting?",
    "created_at": "2021-03-29T19:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447743",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:8 mkoeppe]:
> The NTL variables in `sage_conf` were introduced in 6e30e3ac2d891a16fdd1ad89506db767d4edb9e5 in #31365.
> 
> Help with fixing this issue is welcome. Note that 9.3.rc0 built fine on gentoo in https://github.com/sagemath/sage/runs/2180104858?check_suite_focus=true

For `9.3.rc0`, `sage_conf.py` contains

```
# build/pkgs/sage_conf/src/sage_conf.py.  Generated from sage_conf.py.in by configure.

VERSION = "9.3.rc0"

MAXIMA = "/local/sage-git/sage/local/bin/maxima"

ARB_LIBRARY = "arb"

NTL_INCDIR = "///usr/include"
NTL_LIBDIR = "///usr/lib" 
```


So the question is whether the `///` are causing the linker warnings when doctesting?



---

archive/issue_comments_447744.json:
```json
{
    "body": "You can edit this file and run `make sage_conf` to have it installed",
    "created_at": "2021-03-29T20:06:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447744",
    "user": "https://github.com/mkoeppe"
}
```

You can edit this file and run `make sage_conf` to have it installed



---

archive/issue_comments_447745.json:
```json
{
    "body": "Replying to [comment:2 strogdon]:\n> I have implemented the bisecting twice with the same result.\n\nYou may want to use `git bisect --first-parent`, so that you don't trip over intermediate commits within a ticket's branch.",
    "created_at": "2021-03-29T20:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447745",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 strogdon]:
> I have implemented the bisecting twice with the same result.

You may want to use `git bisect --first-parent`, so that you don't trip over intermediate commits within a ticket's branch.



---

archive/issue_comments_447746.json:
```json
{
    "body": "FWIW, Sage-on-Gentoo does [this](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/sage-9999.ebuild#L199) to avoid linker warnings. But this change does not resolve things on vanilla Sage.",
    "created_at": "2021-03-29T20:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447746",
    "user": "https://github.com/strogdon"
}
```

FWIW, Sage-on-Gentoo does [this](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/sage-9999.ebuild#L199) to avoid linker warnings. But this change does not resolve things on vanilla Sage.



---

archive/issue_comments_447747.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> You can edit this file and run `make sage_conf` to have it installed\nCorrect me if I misunderstand. For `9.3.rc0` I changed\n\n```\nNTL_INCDIR = \"///usr/include\"\nNTL_LIBDIR = \"///usr/lib\" \n```\n\nto\n\n```\nNTL_INCDIR = \"/usr/include\"\nNTL_LIBDIR = \"/usr/lib\"\n```\n\ndid `make sage_conf` and `./sage -t --random-seed=0 src/sage/misc/cython.py` still displays linker warnings. If correct I could make this change when bisecting to see if bisecting can proceed.",
    "created_at": "2021-03-29T20:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447747",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:10 mkoeppe]:
> You can edit this file and run `make sage_conf` to have it installed
Correct me if I misunderstand. For `9.3.rc0` I changed

```
NTL_INCDIR = "///usr/include"
NTL_LIBDIR = "///usr/lib" 
```

to

```
NTL_INCDIR = "/usr/include"
NTL_LIBDIR = "/usr/lib"
```

did `make sage_conf` and `./sage -t --random-seed=0 src/sage/misc/cython.py` still displays linker warnings. If correct I could make this change when bisecting to see if bisecting can proceed.



---

archive/issue_comments_447748.json:
```json
{
    "body": "Ahh, maybe the issue is\n\n```\nNTL_LIBDIR = \"/usr/lib\"\n```\n\nShouldn't this be\n\n```\nNTL_LIBDIR = \"/usr/lib64\"\n```\n",
    "created_at": "2021-03-29T20:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447748",
    "user": "https://github.com/strogdon"
}
```

Ahh, maybe the issue is

```
NTL_LIBDIR = "/usr/lib"
```

Shouldn't this be

```
NTL_LIBDIR = "/usr/lib64"
```




---

archive/issue_comments_447749.json:
```json
{
    "body": "Replying to [comment:14 strogdon]:\n> Ahh, maybe the issue is\n> {{{\n> NTL_LIBDIR = \"/usr/lib\"\n> }}}\n> Shouldn't this be\n> {{{\n> NTL_LIBDIR = \"/usr/lib64\"\n> }}}\nYes,  this is the issue.",
    "created_at": "2021-03-29T20:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447749",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:14 strogdon]:
> Ahh, maybe the issue is
> {{{
> NTL_LIBDIR = "/usr/lib"
> }}}
> Shouldn't this be
> {{{
> NTL_LIBDIR = "/usr/lib64"
> }}}
Yes,  this is the issue.



---

archive/issue_comments_447750.json:
```json
{
    "body": "OK, so `ntl/spkg-configure.m4` needs changing so that it detects the correct library dir.",
    "created_at": "2021-03-29T22:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447750",
    "user": "https://github.com/mkoeppe"
}
```

OK, so `ntl/spkg-configure.m4` needs changing so that it detects the correct library dir.



---

archive/issue_comments_447751.json:
```json
{
    "body": "Yes, a number of packages don't do proper detection and try to do location instead. Which can cause troubles on multilib install. I'll have a look at the macro when I can.",
    "created_at": "2021-03-29T23:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447751",
    "user": "https://github.com/kiwifb"
}
```

Yes, a number of packages don't do proper detection and try to do location instead. Which can cause troubles on multilib install. I'll have a look at the macro when I can.



---

archive/issue_comments_447752.json:
```json
{
    "body": "The title is not really descriptive of the issue. It was a poor attempt to describe what what was happening. It should probably be changed.",
    "created_at": "2021-03-30T03:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447752",
    "user": "https://github.com/strogdon"
}
```

The title is not really descriptive of the issue. It was a poor attempt to describe what what was happening. It should probably be changed.



---

archive/issue_comments_447753.json:
```json
{
    "body": "From the end `ntl/spkg-configure.m4`\n\n```\n    if test x$sage_spkg_install_ntl = xyes; then\n        AC_SUBST(SAGE_NTL_PREFIX, ['$SAGE_LOCAL'])\n    else\n        AC_SUBST(SAGE_NTL_PREFIX, [''])\n        AX_ABSOLUTE_HEADER([NTL/ZZ.h])\n        ntl_inc_ntl_dir=`AS_DIRNAME([\"$gl_cv_absolute_NTL_ZZ_h\"])`\n        ntl_inc_dir=`AS_DIRNAME([\"$ntl_inc_ntl_dir\"])`\n        ntl_prefix=`AS_DIRNAME([\"$ntl_inc_dir\"])`\n        AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])\n        AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])\n    fi\n```\n\nFirst of, the assumption on the value of `NTL_LIBDIR` is completely unwarranted. What is more extra-ordinary to me is that if the previous detection test before you get to this branch are successful nothing after `AC_SUBST(SAGE_NTL_PREFIX, [''])` is useful. \n\nWere any of these value provided for detection? No. So, why would they be needed later on?\n\nIf someone wants to provide some values for `NTL_INCDIR` and `NTL_LIBDIR` that can be arranged but then they should be tested - separately.\n\nAs far as I am concerned, those two variables should just be eliminated which would quite the patch during a rc.",
    "created_at": "2021-03-30T22:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447753",
    "user": "https://github.com/kiwifb"
}
```

From the end `ntl/spkg-configure.m4`

```
    if test x$sage_spkg_install_ntl = xyes; then
        AC_SUBST(SAGE_NTL_PREFIX, ['$SAGE_LOCAL'])
    else
        AC_SUBST(SAGE_NTL_PREFIX, [''])
        AX_ABSOLUTE_HEADER([NTL/ZZ.h])
        ntl_inc_ntl_dir=`AS_DIRNAME(["$gl_cv_absolute_NTL_ZZ_h"])`
        ntl_inc_dir=`AS_DIRNAME(["$ntl_inc_ntl_dir"])`
        ntl_prefix=`AS_DIRNAME(["$ntl_inc_dir"])`
        AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])
        AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])
    fi
```

First of, the assumption on the value of `NTL_LIBDIR` is completely unwarranted. What is more extra-ordinary to me is that if the previous detection test before you get to this branch are successful nothing after `AC_SUBST(SAGE_NTL_PREFIX, [''])` is useful. 

Were any of these value provided for detection? No. So, why would they be needed later on?

If someone wants to provide some values for `NTL_INCDIR` and `NTL_LIBDIR` that can be arranged but then they should be tested - separately.

As far as I am concerned, those two variables should just be eliminated which would quite the patch during a rc.



---

archive/issue_comments_447754.json:
```json
{
    "body": "Also the macro `AX_ABSOLUTE_HEADER` is generating those strange `///` at the beginning on purpose. So that some compiler (Sun originally) wouldn't complain with the result if it happens to be a system location. Not making it up, it is in its own documentation\n[https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html](https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html). I was really looking for a `AX_ABSOLUTE_LIBRARY` equivalent (there isn't).",
    "created_at": "2021-03-30T22:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447754",
    "user": "https://github.com/kiwifb"
}
```

Also the macro `AX_ABSOLUTE_HEADER` is generating those strange `///` at the beginning on purpose. So that some compiler (Sun originally) wouldn't complain with the result if it happens to be a system location. Not making it up, it is in its own documentation
[https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html](https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html). I was really looking for a `AX_ABSOLUTE_LIBRARY` equivalent (there isn't).



---

archive/issue_comments_447755.json:
```json
{
    "body": "Replying to [comment:20 fbissey]:\n> From the end `ntl/spkg-configure.m4`\n> {{{\n>     if test x$sage_spkg_install_ntl = xyes; then\n>         AC_SUBST(SAGE_NTL_PREFIX, ['$SAGE_LOCAL'])\n>     else\n>         AC_SUBST(SAGE_NTL_PREFIX, [''])\n>         AX_ABSOLUTE_HEADER([NTL/ZZ.h])\n>         ntl_inc_ntl_dir=`AS_DIRNAME([\"$gl_cv_absolute_NTL_ZZ_h\"])`\n>         ntl_inc_dir=`AS_DIRNAME([\"$ntl_inc_ntl_dir\"])`\n>         ntl_prefix=`AS_DIRNAME([\"$ntl_inc_dir\"])`\n>         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])\n>         AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])\n>     fi\n> }}}\n> First of, the assumption on the value of `NTL_LIBDIR` is completely unwarranted.\n\nI agree, this was sloppy.\n\n> What is more extra-ordinary to me is that if the previous detection test before you get to this branch are successful nothing after `AC_SUBST(SAGE_NTL_PREFIX, [''])` is useful. \n> \n> Were any of these value provided for detection? No. So, why would they be needed later on?\n\nThey are needed because of the unfortunate need for a compile time environment at runtime of Sage when using the `cython` function. In this situation we cannot rely on the proper compile time environment being set (such as on macOS using the `.homebrew-build-env`.)\n\nIt would be fine with me to back out the setting of these two variables for Sage 9.3 if you think this helps.",
    "created_at": "2021-03-30T22:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447755",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:20 fbissey]:
> From the end `ntl/spkg-configure.m4`
> {{{
>     if test x$sage_spkg_install_ntl = xyes; then
>         AC_SUBST(SAGE_NTL_PREFIX, ['$SAGE_LOCAL'])
>     else
>         AC_SUBST(SAGE_NTL_PREFIX, [''])
>         AX_ABSOLUTE_HEADER([NTL/ZZ.h])
>         ntl_inc_ntl_dir=`AS_DIRNAME(["$gl_cv_absolute_NTL_ZZ_h"])`
>         ntl_inc_dir=`AS_DIRNAME(["$ntl_inc_ntl_dir"])`
>         ntl_prefix=`AS_DIRNAME(["$ntl_inc_dir"])`
>         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])
>         AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])
>     fi
> }}}
> First of, the assumption on the value of `NTL_LIBDIR` is completely unwarranted.

I agree, this was sloppy.

> What is more extra-ordinary to me is that if the previous detection test before you get to this branch are successful nothing after `AC_SUBST(SAGE_NTL_PREFIX, [''])` is useful. 
> 
> Were any of these value provided for detection? No. So, why would they be needed later on?

They are needed because of the unfortunate need for a compile time environment at runtime of Sage when using the `cython` function. In this situation we cannot rely on the proper compile time environment being set (such as on macOS using the `.homebrew-build-env`.)

It would be fine with me to back out the setting of these two variables for Sage 9.3 if you think this helps.



---

archive/issue_comments_447756.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> They are needed because of the unfortunate need for a compile time environment at runtime of Sage when using the `cython` function. In this situation we cannot rely on the proper compile time environment being set (such as on macOS using the `.homebrew-build-env`.)\n> \n\nThat's unfortunately a valid use case. We may have had that discussion already. Total removal would break that use case while we are currently only dealing with extra warnings. Noisy, but not breaking any functionality.",
    "created_at": "2021-03-30T22:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447756",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:22 mkoeppe]:
> They are needed because of the unfortunate need for a compile time environment at runtime of Sage when using the `cython` function. In this situation we cannot rely on the proper compile time environment being set (such as on macOS using the `.homebrew-build-env`.)
> 

That's unfortunately a valid use case. We may have had that discussion already. Total removal would break that use case while we are currently only dealing with extra warnings. Noisy, but not breaking any functionality.



---

archive/issue_comments_447757.json:
```json
{
    "body": "I think we should try `AC_LIB_LINKFLAGS` and see if that return something that we can use sensibly [https://www.gnu.org/software/gnulib/manual/html_node/Searching-for-Libraries.html](https://www.gnu.org/software/gnulib/manual/html_node/Searching-for-Libraries.html). This is gnulib stuff however.",
    "created_at": "2021-03-30T22:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447757",
    "user": "https://github.com/kiwifb"
}
```

I think we should try `AC_LIB_LINKFLAGS` and see if that return something that we can use sensibly [https://www.gnu.org/software/gnulib/manual/html_node/Searching-for-Libraries.html](https://www.gnu.org/software/gnulib/manual/html_node/Searching-for-Libraries.html). This is gnulib stuff however.



---

archive/issue_comments_447758.json:
```json
{
    "body": "For the general problem I have a ticket (#31041 - Set environment for sage.misc.cython) but not a solution yet",
    "created_at": "2021-03-30T22:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447758",
    "user": "https://github.com/mkoeppe"
}
```

For the general problem I have a ticket (#31041 - Set environment for sage.misc.cython) but not a solution yet



---

archive/issue_comments_447759.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> For the general problem I have a ticket (#31041 - Set environment for sage.misc.cython) but not a solution yet\n\nYes, we should work on that there, that may turn out to be a bit of a patch bomb. At best I say we deal with accepting the potential warnings in the present ticket.",
    "created_at": "2021-03-30T23:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447759",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:25 mkoeppe]:
> For the general problem I have a ticket (#31041 - Set environment for sage.misc.cython) but not a solution yet

Yes, we should work on that there, that may turn out to be a bit of a patch bomb. At best I say we deal with accepting the potential warnings in the present ticket.



---

archive/issue_events_083032.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31341#event-83032"
}
```



---

archive/issue_comments_447760.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447760",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_447761.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> Also the macro `AX_ABSOLUTE_HEADER` is generating those strange `///` at the beginning on purpose. So that some compiler (Sun originally) wouldn't complain with the result if it happens to be a system location. Not making it up, it is in its own documentation\n> [https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html](https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html). I was really looking for a `AX_ABSOLUTE_LIBRARY` equivalent (there isn't).\n\nwell, on #28906 I wrote something akin to `AX_ABSOLUTE_LIBRARY`, see\nhttps://git.sagemath.org/sage.git/tree/m4/sage_absolute_lib.m4?id=2d4a1cdac919203e68f0d56174cd6257f600fe00",
    "created_at": "2021-04-16T10:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447761",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:21 fbissey]:
> Also the macro `AX_ABSOLUTE_HEADER` is generating those strange `///` at the beginning on purpose. So that some compiler (Sun originally) wouldn't complain with the result if it happens to be a system location. Not making it up, it is in its own documentation
> [https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html](https://www.gnu.org/software/autoconf-archive/ax_absolute_header.html). I was really looking for a `AX_ABSOLUTE_LIBRARY` equivalent (there isn't).

well, on #28906 I wrote something akin to `AX_ABSOLUTE_LIBRARY`, see
https://git.sagemath.org/sage.git/tree/m4/sage_absolute_lib.m4?id=2d4a1cdac919203e68f0d56174cd6257f600fe00



---

archive/issue_comments_447762.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> Replying to [comment:20 fbissey]:\n> > From the end `ntl/spkg-configure.m4`\n> > {{{\n> >     if test x$sage_spkg_install_ntl = xyes; then\n> >         AC_SUBST(SAGE_NTL_PREFIX, ['$SAGE_LOCAL'])\n> >     else\n> >         AC_SUBST(SAGE_NTL_PREFIX, [''])\n> >         AX_ABSOLUTE_HEADER([NTL/ZZ.h])\n> >         ntl_inc_ntl_dir=`AS_DIRNAME([\"$gl_cv_absolute_NTL_ZZ_h\"])`\n> >         ntl_inc_dir=`AS_DIRNAME([\"$ntl_inc_ntl_dir\"])`\n> >         ntl_prefix=`AS_DIRNAME([\"$ntl_inc_dir\"])`\n> >         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])\n> >         AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])\n> >     fi\n> > }}}\n> > First of, the assumption on the value of `NTL_LIBDIR` is completely unwarranted.\n> \n> I agree, this was sloppy.\nshort of using a kind of macro mentioned in comment:29, \nhow about checking for presence of `$ntl_prefix/lib/libntl.*` - and if there is none,\ntry `$ntl_prefix/lib64/libntl.*`\n\nShould we error out if none of these works?",
    "created_at": "2021-04-16T10:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447762",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:22 mkoeppe]:
> Replying to [comment:20 fbissey]:
> > From the end `ntl/spkg-configure.m4`
> > {{{
> >     if test x$sage_spkg_install_ntl = xyes; then
> >         AC_SUBST(SAGE_NTL_PREFIX, ['$SAGE_LOCAL'])
> >     else
> >         AC_SUBST(SAGE_NTL_PREFIX, [''])
> >         AX_ABSOLUTE_HEADER([NTL/ZZ.h])
> >         ntl_inc_ntl_dir=`AS_DIRNAME(["$gl_cv_absolute_NTL_ZZ_h"])`
> >         ntl_inc_dir=`AS_DIRNAME(["$ntl_inc_ntl_dir"])`
> >         ntl_prefix=`AS_DIRNAME(["$ntl_inc_dir"])`
> >         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])
> >         AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])
> >     fi
> > }}}
> > First of, the assumption on the value of `NTL_LIBDIR` is completely unwarranted.
> 
> I agree, this was sloppy.
short of using a kind of macro mentioned in comment:29, 
how about checking for presence of `$ntl_prefix/lib/libntl.*` - and if there is none,
try `$ntl_prefix/lib64/libntl.*`

Should we error out if none of these works?



---

archive/issue_comments_447763.json:
```json
{
    "body": "Replying to [comment:30 dimpase]:\n> how about checking for presence of `$ntl_prefix/lib/libntl.*` - and if there is none,\n> try `$ntl_prefix/lib64/libntl.*`\n> \n\nWhat if they are both present? Does that cover Debian's way of doing multilib? Your macro is interesting.",
    "created_at": "2021-04-16T11:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447763",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:30 dimpase]:
> how about checking for presence of `$ntl_prefix/lib/libntl.*` - and if there is none,
> try `$ntl_prefix/lib64/libntl.*`
> 

What if they are both present? Does that cover Debian's way of doing multilib? Your macro is interesting.



---

archive/issue_comments_447764.json:
```json
{
    "body": "even though such a macro might not work on  weird platforms, it would be a solution for Linux multilib.\nI don't recall if I tested on MacOS though. (I guess Arm vs non-arm cases might be *interesting*)",
    "created_at": "2021-04-16T14:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447764",
    "user": "https://github.com/dimpase"
}
```

even though such a macro might not work on  weird platforms, it would be a solution for Linux multilib.
I don't recall if I tested on MacOS though. (I guess Arm vs non-arm cases might be *interesting*)



---

archive/issue_comments_447765.json:
```json
{
    "body": "Replying to [comment:29 dimpase]:\n> well, on #28906 I wrote something akin to `AX_ABSOLUTE_LIBRARY`, see\n> https://git.sagemath.org/sage.git/tree/m4/sage_absolute_lib.m4?id=2d4a1cdac919203e68f0d56174cd6257f600fe00\n\nI don't think this is the right approach. Mixing in runtime library paths can only create more confusion.",
    "created_at": "2021-04-16T16:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447765",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:29 dimpase]:
> well, on #28906 I wrote something akin to `AX_ABSOLUTE_LIBRARY`, see
> https://git.sagemath.org/sage.git/tree/m4/sage_absolute_lib.m4?id=2d4a1cdac919203e68f0d56174cd6257f600fe00

I don't think this is the right approach. Mixing in runtime library paths can only create more confusion.



---

archive/issue_comments_447766.json:
```json
{
    "body": "Wouldn't gentoo be able to provide a .pc file for NTL that we can check for first?",
    "created_at": "2021-04-16T16:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447766",
    "user": "https://github.com/mkoeppe"
}
```

Wouldn't gentoo be able to provide a .pc file for NTL that we can check for first?



---

archive/issue_comments_447767.json:
```json
{
    "body": "Replying to [comment:34 mkoeppe]:\n> Wouldn't gentoo be able to provide a .pc file for NTL that we can check for first?\nit doesn't; even if it did, it won't help, as normally speaking `-L` is only specified for a library in its *.pc file only if the location is not known to the linker. Here, the location **is** known.\n\nAmazingly, there is no standard way to find out this path...",
    "created_at": "2021-04-16T20:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447767",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:34 mkoeppe]:
> Wouldn't gentoo be able to provide a .pc file for NTL that we can check for first?
it doesn't; even if it did, it won't help, as normally speaking `-L` is only specified for a library in its *.pc file only if the location is not known to the linker. Here, the location **is** known.

Amazingly, there is no standard way to find out this path...



---

archive/issue_comments_447768.json:
```json
{
    "body": "Replying to [comment:33 mkoeppe]:\n> Replying to [comment:29 dimpase]:\n> > well, on #28906 I wrote something akin to `AX_ABSOLUTE_LIBRARY`, see\n> > https://git.sagemath.org/sage.git/tree/m4/sage_absolute_lib.m4?id=2d4a1cdac919203e68f0d56174cd6257f600fe00\n> \n> I don't think this is the right approach. Mixing in runtime library paths can only create more confusion.\n> \nit already does create confusion. \n\nShould `NTL_LIBDIR` be just empty list if the location of libntl is one of standard locations?",
    "created_at": "2021-04-16T20:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447768",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:33 mkoeppe]:
> Replying to [comment:29 dimpase]:
> > well, on #28906 I wrote something akin to `AX_ABSOLUTE_LIBRARY`, see
> > https://git.sagemath.org/sage.git/tree/m4/sage_absolute_lib.m4?id=2d4a1cdac919203e68f0d56174cd6257f600fe00
> 
> I don't think this is the right approach. Mixing in runtime library paths can only create more confusion.
> 
it already does create confusion. 

Should `NTL_LIBDIR` be just empty list if the location of libntl is one of standard locations?



---

archive/issue_comments_447769.json:
```json
{
    "body": "Most pkgconfig files do provide variables such as `libdir`.",
    "created_at": "2021-04-16T20:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447769",
    "user": "https://github.com/mkoeppe"
}
```

Most pkgconfig files do provide variables such as `libdir`.



---

archive/issue_comments_447770.json:
```json
{
    "body": "Besides, we do not really need this absolute path. We only use these variables in `cython_aliases` because there is no .pc file to use.",
    "created_at": "2021-04-16T20:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447770",
    "user": "https://github.com/mkoeppe"
}
```

Besides, we do not really need this absolute path. We only use these variables in `cython_aliases` because there is no .pc file to use.



---

archive/issue_comments_447771.json:
```json
{
    "body": "What exactly is the problem with cython? Is it just that people start sage without setting up their build environment (e.g. `source .homebrew-build-env`), and then expect to be able to compile things via `cython()`?",
    "created_at": "2021-04-16T20:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447771",
    "user": "https://github.com/orlitzky"
}
```

What exactly is the problem with cython? Is it just that people start sage without setting up their build environment (e.g. `source .homebrew-build-env`), and then expect to be able to compile things via `cython()`?



---

archive/issue_comments_447772.json:
```json
{
    "body": "So, how about an upstream pull request that adds a pkgconfig file to NTL.",
    "created_at": "2021-04-16T20:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447772",
    "user": "https://github.com/mkoeppe"
}
```

So, how about an upstream pull request that adds a pkgconfig file to NTL.



---

archive/issue_comments_447773.json:
```json
{
    "body": "Replying to [comment:39 mjo]:\n> What exactly is the problem with cython? Is it just that people start sage without setting up their build environment (e.g. `source .homebrew-build-env`), and then expect to be able to compile things via `cython()`?\nYes, precisely. (I know...)",
    "created_at": "2021-04-16T20:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447773",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:39 mjo]:
> What exactly is the problem with cython? Is it just that people start sage without setting up their build environment (e.g. `source .homebrew-build-env`), and then expect to be able to compile things via `cython()`?
Yes, precisely. (I know...)



---

archive/issue_comments_447774.json:
```json
{
    "body": "Replying to [comment:40 mkoeppe]:\n> So, how about an upstream pull request that adds a pkgconfig file to NTL.\n\nAnd we'll have to do it again and again with any packages we need? Not that it is a bad thing in and of itself.",
    "created_at": "2021-04-16T20:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447774",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:40 mkoeppe]:
> So, how about an upstream pull request that adds a pkgconfig file to NTL.

And we'll have to do it again and again with any packages we need? Not that it is a bad thing in and of itself.



---

archive/issue_comments_447775.json:
```json
{
    "body": "Yes, one package at a time.",
    "created_at": "2021-04-16T20:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447775",
    "user": "https://github.com/mkoeppe"
}
```

Yes, one package at a time.



---

archive/issue_comments_447776.json:
```json
{
    "body": "Oh, well, that doesn't work =)\n\nSeriously though, this problem is going to manifest elsewhere as well. Trying to guess at the exact environment that was present during `./configure` so that it can be replicated during `cython()` will be a losing battle.\n\nAdding a .pc file upstream might help or it might make things worse. There are two separate libdirs, and I'm not sure off the top of my head how `pkg-config` decides which *.pc file to use (and thus which libdir to return) on a multilib system.\n\nEven if it works, you're basically forbidding people from installing things manually and passing `-L` and `-I` during the build, instead forcing everyone to both provide *.pc files and then override `PKG_CONFIG_DIR`. It seems like a lot of antipattern to bury ourselves under to avoid telling people to set up their build environment before they want to build.",
    "created_at": "2021-04-16T20:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447776",
    "user": "https://github.com/orlitzky"
}
```

Oh, well, that doesn't work =)

Seriously though, this problem is going to manifest elsewhere as well. Trying to guess at the exact environment that was present during `./configure` so that it can be replicated during `cython()` will be a losing battle.

Adding a .pc file upstream might help or it might make things worse. There are two separate libdirs, and I'm not sure off the top of my head how `pkg-config` decides which *.pc file to use (and thus which libdir to return) on a multilib system.

Even if it works, you're basically forbidding people from installing things manually and passing `-L` and `-I` during the build, instead forcing everyone to both provide *.pc files and then override `PKG_CONFIG_DIR`. It seems like a lot of antipattern to bury ourselves under to avoid telling people to set up their build environment before they want to build.



---

archive/issue_comments_447777.json:
```json
{
    "body": "The problem really just applies to the libraries listed in `sage.misc.cython._standard_libs_libdirs_incdirs_aliases`: the small set of libraries that were anointed as \"standard\" sometime in the ancient past.",
    "created_at": "2021-04-16T20:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447777",
    "user": "https://github.com/mkoeppe"
}
```

The problem really just applies to the libraries listed in `sage.misc.cython._standard_libs_libdirs_incdirs_aliases`: the small set of libraries that were anointed as "standard" sometime in the ancient past.



---

archive/issue_comments_447778.json:
```json
{
    "body": "https://github.com/libntl/ntl is taking pull requests.",
    "created_at": "2021-04-17T15:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447778",
    "user": "https://github.com/mkoeppe"
}
```

https://github.com/libntl/ntl is taking pull requests.



---

archive/issue_comments_447779.json:
```json
{
    "body": "I already *.pc-fied mpfr, m4ri, eclib, perhaps something else as well, anyone wants to take the token?",
    "created_at": "2021-04-17T16:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447779",
    "user": "https://github.com/dimpase"
}
```

I already *.pc-fied mpfr, m4ri, eclib, perhaps something else as well, anyone wants to take the token?



---

archive/issue_comments_447780.json:
```json
{
    "body": "Replying to [comment:47 dimpase]:\n> I already *.pc-fied mpfr, m4ri, eclib, perhaps something else as well, anyone wants to take the token?\n\nalso, I don't speak Perl, and for NTL config this is needed: https://github.com/libntl/ntl/blob/main/src/DoConfig",
    "created_at": "2021-04-18T09:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447780",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:47 dimpase]:
> I already *.pc-fied mpfr, m4ri, eclib, perhaps something else as well, anyone wants to take the token?

also, I don't speak Perl, and for NTL config this is needed: https://github.com/libntl/ntl/blob/main/src/DoConfig



---

archive/issue_comments_447781.json:
```json
{
    "body": "Replying to [comment:48 dimpase]:\n> Replying to [comment:47 dimpase]:\n> > I already *.pc-fied mpfr, m4ri, eclib, perhaps something else as well, anyone wants to take the token?\n> \n> also, I don't speak Perl, and for NTL config this is needed: https://github.com/libntl/ntl/blob/main/src/DoConfig\n\nDarn! I do, I am a bit rusty but the script is not really complicated enough to be a big issue.",
    "created_at": "2021-04-18T09:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447781",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:48 dimpase]:
> Replying to [comment:47 dimpase]:
> > I already *.pc-fied mpfr, m4ri, eclib, perhaps something else as well, anyone wants to take the token?
> 
> also, I don't speak Perl, and for NTL config this is needed: https://github.com/libntl/ntl/blob/main/src/DoConfig

Darn! I do, I am a bit rusty but the script is not really complicated enough to be a big issue.



---

archive/issue_comments_447782.json:
```json
{
    "body": "OK, I have started work at https://github.com/kiwifb/ntl/tree/pcfile so you can send your criticism already. There is one more little piece I think should dealt with before sending the PR is setting the variable `PACKAGE_VERSION`. Unfortunately, that bit will be a bit more complicated. It is contained in the file `DIRNAME` but preceded by the string `ntl-`. Some extra reading and parsing needs to be added to `DoConfig` for it.",
    "created_at": "2021-04-20T01:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447782",
    "user": "https://github.com/kiwifb"
}
```

OK, I have started work at https://github.com/kiwifb/ntl/tree/pcfile so you can send your criticism already. There is one more little piece I think should dealt with before sending the PR is setting the variable `PACKAGE_VERSION`. Unfortunately, that bit will be a bit more complicated. It is contained in the file `DIRNAME` but preceded by the string `ntl-`. Some extra reading and parsing needs to be added to `DoConfig` for it.



---

archive/issue_comments_447783.json:
```json
{
    "body": "OK people can now experiment with the attached patch to see if it behaves as they expect.",
    "created_at": "2021-04-20T10:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447783",
    "user": "https://github.com/kiwifb"
}
```

OK people can now experiment with the attached patch to see if it behaves as they expect.



---

archive/issue_comments_447784.json:
```json
{
    "body": "Replying to [comment:51 fbissey]:\n> OK people can now experiment with the attached patch to see if it behaves as they expect.\nPerhaps cosmetic for purposes here but in the `makefile` there is `INCLUDEDIR=$(PREFIX)/include` which on a gentoo install gives\n\n```\n$ pkg-config --cflags ntl\n-I$(PREFIX)/include/NTL\n```\n\ni.e. from the installed `ntl.pc`\n\n```\nincludedir=$(PREFIX)/include/NTL\n```\n\nSomehow `(PREFIX)` should be `{PREFIX}`.",
    "created_at": "2021-04-20T17:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447784",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:51 fbissey]:
> OK people can now experiment with the attached patch to see if it behaves as they expect.
Perhaps cosmetic for purposes here but in the `makefile` there is `INCLUDEDIR=$(PREFIX)/include` which on a gentoo install gives

```
$ pkg-config --cflags ntl
-I$(PREFIX)/include/NTL
```

i.e. from the installed `ntl.pc`

```
includedir=$(PREFIX)/include/NTL
```

Somehow `(PREFIX)` should be `{PREFIX}`.



---

archive/issue_comments_447785.json:
```json
{
    "body": "Replying to [comment:52 strogdon]:\n> Replying to [comment:51 fbissey]:\n> > OK people can now experiment with the attached patch to see if it behaves as they expect.\n> Perhaps cosmetic for purposes here but in the `makefile` there is `INCLUDEDIR=$(PREFIX)/include` which on a gentoo install gives\n> {{{\n> $ pkg-config --cflags ntl\n> -I$(PREFIX)/include/NTL\n> }}}\n> i.e. from the installed `ntl.pc`\n> {{{\n> includedir=$(PREFIX)/include/NTL\n> }}}\n> Somehow `(PREFIX)` should be `{PREFIX}`.\n\nOK, I need to figure out a better substitution. I didn't notice the braces are the wrong kind. On top of that I shouldn't have added `NTL` I am sure.",
    "created_at": "2021-04-20T19:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447785",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:52 strogdon]:
> Replying to [comment:51 fbissey]:
> > OK people can now experiment with the attached patch to see if it behaves as they expect.
> Perhaps cosmetic for purposes here but in the `makefile` there is `INCLUDEDIR=$(PREFIX)/include` which on a gentoo install gives
> {{{
> $ pkg-config --cflags ntl
> -I$(PREFIX)/include/NTL
> }}}
> i.e. from the installed `ntl.pc`
> {{{
> includedir=$(PREFIX)/include/NTL
> }}}
> Somehow `(PREFIX)` should be `{PREFIX}`.

OK, I need to figure out a better substitution. I didn't notice the braces are the wrong kind. On top of that I shouldn't have added `NTL` I am sure.



---

archive/issue_comments_447786.json:
```json
{
    "body": "Replying to [comment:53 fbissey]:\n> Replying to [comment:52 strogdon]:\n> > Replying to [comment:51 fbissey]:\n> > > OK people can now experiment with the attached patch to see if it behaves as they expect.\n> > Perhaps cosmetic for purposes here but in the `makefile` there is `INCLUDEDIR=$(PREFIX)/include` which on a gentoo install gives\n> > {{{\n> > $ pkg-config --cflags ntl\n> > -I$(PREFIX)/include/NTL\n> > }}}\n> > i.e. from the installed `ntl.pc`\n> > {{{\n> > includedir=$(PREFIX)/include/NTL\n> > }}}\n> > Somehow `(PREFIX)` should be `{PREFIX}`.\n> \n> OK, I need to figure out a better substitution. I didn't notice the braces are the wrong kind. On top of that I shouldn't have added `NTL` I am sure.\nThe `libdir` thingy does work\n\n```\nsage: import pkgconfig                                                                                   \nsage: pkgconfig.variables('ntl')['libdir']                                                               \n'/usr/lib64'\nsage:\n```\n",
    "created_at": "2021-04-20T20:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447786",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:53 fbissey]:
> Replying to [comment:52 strogdon]:
> > Replying to [comment:51 fbissey]:
> > > OK people can now experiment with the attached patch to see if it behaves as they expect.
> > Perhaps cosmetic for purposes here but in the `makefile` there is `INCLUDEDIR=$(PREFIX)/include` which on a gentoo install gives
> > {{{
> > $ pkg-config --cflags ntl
> > -I$(PREFIX)/include/NTL
> > }}}
> > i.e. from the installed `ntl.pc`
> > {{{
> > includedir=$(PREFIX)/include/NTL
> > }}}
> > Somehow `(PREFIX)` should be `{PREFIX}`.
> 
> OK, I need to figure out a better substitution. I didn't notice the braces are the wrong kind. On top of that I shouldn't have added `NTL` I am sure.
The `libdir` thingy does work

```
sage: import pkgconfig                                                                                   
sage: pkgconfig.variables('ntl')['libdir']                                                               
'/usr/lib64'
sage:
```




---

archive/issue_comments_447787.json:
```json
{
    "body": "Yes, because when you configure on Gentoo, and probably other distros, `LIBDIR` is defined in full on the command line. If you were to do a vanilla config with the default location, you would get something in braces.",
    "created_at": "2021-04-20T20:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447787",
    "user": "https://github.com/kiwifb"
}
```

Yes, because when you configure on Gentoo, and probably other distros, `LIBDIR` is defined in full on the command line. If you were to do a vanilla config with the default location, you would get something in braces.



---

archive/issue_comments_447788.json:
```json
{
    "body": "It is just an extra line in `DoConfig` but I am not sure when I'll be able to post it.",
    "created_at": "2021-04-20T20:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447788",
    "user": "https://github.com/kiwifb"
}
```

It is just an extra line in `DoConfig` but I am not sure when I'll be able to post it.



---

archive/issue_comments_447789.json:
```json
{
    "body": "I have pushed on github though.",
    "created_at": "2021-04-20T20:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447789",
    "user": "https://github.com/kiwifb"
}
```

I have pushed on github though.



---

archive/issue_comments_447790.json:
```json
{
    "body": "Attachment [ntl-pc.patch](tarball://root/attachments/some-uuid/ticket31578/ntl-pc.patch) by @kiwifb created at 2021-04-21 02:31:31\n\nPatch to ntl to create a ntl.pc file",
    "created_at": "2021-04-21T02:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447790",
    "user": "https://github.com/kiwifb"
}
```

Attachment [ntl-pc.patch](tarball://root/attachments/some-uuid/ticket31578/ntl-pc.patch) by @kiwifb created at 2021-04-21 02:31:31

Patch to ntl to create a ntl.pc file



---

archive/issue_comments_447791.json:
```json
{
    "body": "Patch updated.",
    "created_at": "2021-04-21T02:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447791",
    "user": "https://github.com/kiwifb"
}
```

Patch updated.



---

archive/issue_comments_447792.json:
```json
{
    "body": "I have put this [ntl-pc.patch](https://github.com/sheerluck/sage-on-gentoo-stage4/blob/master/ntl-pc.patch) in /etc/portage/patches/dev-libs/ntl and now we have /usr/lib64/pkgconfig/ntl.pc in all three [latest images](https://hub.docker.com/r/sheerluck/sage-on-gentoo-stage4/tags)\n\nI hoped to see linker warnings go away but  \n[Actions](https://github.com/sheerluck/sage/actions/runs/804492747) shows that those warnings are still there :(\n\n**cddlib-0.94m** in logs confirms github surely used latest image.",
    "created_at": "2021-05-02T19:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447792",
    "user": "https://github.com/sheerluck"
}
```

I have put this [ntl-pc.patch](https://github.com/sheerluck/sage-on-gentoo-stage4/blob/master/ntl-pc.patch) in /etc/portage/patches/dev-libs/ntl and now we have /usr/lib64/pkgconfig/ntl.pc in all three [latest images](https://hub.docker.com/r/sheerluck/sage-on-gentoo-stage4/tags)

I hoped to see linker warnings go away but  
[Actions](https://github.com/sheerluck/sage/actions/runs/804492747) shows that those warnings are still there :(

**cddlib-0.94m** in logs confirms github surely used latest image.



---

archive/issue_comments_447793.json:
```json
{
    "body": "Replying to [comment:59 gh-sheerluck]:\n> I hoped to see linker warnings go away but  \n> [Actions](https://github.com/sheerluck/sage/actions/runs/804492747) shows that those warnings are still there :(\n\nA branch here on this ticket still needs to change Sage so it actually uses that pc file!",
    "created_at": "2021-05-02T19:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447793",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:59 gh-sheerluck]:
> I hoped to see linker warnings go away but  
> [Actions](https://github.com/sheerluck/sage/actions/runs/804492747) shows that those warnings are still there :(

A branch here on this ticket still needs to change Sage so it actually uses that pc file!



---

archive/issue_comments_447794.json:
```json
{
    "body": "Yes, I left making a branch for later. I wanted feedback on the `ntl.pc` file first. Making a branch is not without issues. There is a before `ntl.pc` file and after. So, some strategic decisions are needed.\n* Do we require a version of ntl that has a .pc file?\n* Do we have a transition period where we do one thing if there is a .pc file and another thing if not.\n\nThose are important because they will shape ntl's `spkg-configure.m4` file. I believe handling various scenario is not too hard in `env.py` so long as the `spkg-configure.m4` does the right things, but that's where it becomes quite complicated if we allow a transition period.",
    "created_at": "2021-05-02T21:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447794",
    "user": "https://github.com/kiwifb"
}
```

Yes, I left making a branch for later. I wanted feedback on the `ntl.pc` file first. Making a branch is not without issues. There is a before `ntl.pc` file and after. So, some strategic decisions are needed.
* Do we require a version of ntl that has a .pc file?
* Do we have a transition period where we do one thing if there is a .pc file and another thing if not.

Those are important because they will shape ntl's `spkg-configure.m4` file. I believe handling various scenario is not too hard in `env.py` so long as the `spkg-configure.m4` does the right things, but that's where it becomes quite complicated if we allow a transition period.



---

archive/issue_comments_447795.json:
```json
{
    "body": "Replying to [comment:61 fbissey]:\n> * Do we require a version of ntl that has a .pc file?\n\nNo, just use it if present and do whatever we do now if not.",
    "created_at": "2021-05-03T01:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447795",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:61 fbissey]:
> * Do we require a version of ntl that has a .pc file?

No, just use it if present and do whatever we do now if not.



---

archive/issue_comments_447796.json:
```json
{
    "body": "Same linker warnings when building https://github.com/fredstro/psage\n\n(for sagemath-9.3 it has `feature/sage9.3` branch)",
    "created_at": "2021-05-18T07:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447796",
    "user": "https://github.com/sheerluck"
}
```

Same linker warnings when building https://github.com/fredstro/psage

(for sagemath-9.3 it has `feature/sage9.3` branch)



---

archive/issue_comments_447797.json:
```json
{
    "body": "how about putting the .pc file creation up as an NTL PR?\n(although admittedly upstream is rather picky regarding PRs, it seems - why is it a problem merging .gitignore updates? it beats me)",
    "created_at": "2021-05-18T08:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447797",
    "user": "https://github.com/dimpase"
}
```

how about putting the .pc file creation up as an NTL PR?
(although admittedly upstream is rather picky regarding PRs, it seems - why is it a problem merging .gitignore updates? it beats me)



---

archive/issue_comments_447798.json:
```json
{
    "body": "actually, I just noticed that upstream merged autotools configuration for NTL written by Isuru. In src/libtool* dirs there. Maybe Isuru can tell us how to use it and adding a .pc file there will be trivial.",
    "created_at": "2021-05-18T08:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447798",
    "user": "https://github.com/dimpase"
}
```

actually, I just noticed that upstream merged autotools configuration for NTL written by Isuru. In src/libtool* dirs there. Maybe Isuru can tell us how to use it and adding a .pc file there will be trivial.



---

archive/issue_comments_447799.json:
```json
{
    "body": "If that's a replacement or a superset to the perl configuration tool, then writing a .pc file becomes really trivial. The perl stuff was tricky.",
    "created_at": "2021-05-18T08:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447799",
    "user": "https://github.com/kiwifb"
}
```

If that's a replacement or a superset to the perl configuration tool, then writing a .pc file becomes really trivial. The perl stuff was tricky.



---

archive/issue_comments_447800.json:
```json
{
    "body": "For discussion since I'm not an `autoconf` expert. With a system `ntl.pc` file installed the following modification\n\n```diff\ndiff --git a/build/pkgs/ntl/spkg-configure.m4 b/build/pkgs/ntl/spkg-configure.m4\nindex 48e41de6ea..d069a798de 100644\n--- a/build/pkgs/ntl/spkg-configure.m4\n+++ b/build/pkgs/ntl/spkg-configure.m4\n@@ -44,7 +44,13 @@ SAGE_SPKG_CONFIGURE([ntl], [\n         ntl_inc_dir=`AS_DIRNAME([\"$ntl_inc_ntl_dir\"])`\n         ntl_prefix=`AS_DIRNAME([\"$ntl_inc_dir\"])`\n         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])\n-        AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])\n+        ntl_libdir=`pkg-config --variable=libdir ntl`\n+        if test x$ntl_libdir = x; then\n+            AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])\n+        else\n+            libdir=`basename $ntl_libdir`\n+            AC_SUBST(NTL_LIBDIR, [$ntl_prefix/$libdir])\n+        fi\n     fi\n ])\n```\n\ngives, after `./configure` (perhaps a `./bootstrap` is needed before the `./configure`)\n\n```\n$ grep NTL build/pkgs/sage_conf/src/sage_conf.py\nNTL_INCDIR = \"///usr/include\"\nNTL_LIBDIR = \"///usr/lib64\"\n```\n\nThis assumes that `pkg-config` is installed and works correctly and that `basename` is installed. Not sure if there are `autoconf` equivalents to these. This gives the current result if a system `ntl.pc` file is not installed.",
    "created_at": "2021-05-21T05:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447800",
    "user": "https://github.com/strogdon"
}
```

For discussion since I'm not an `autoconf` expert. With a system `ntl.pc` file installed the following modification

```diff
diff --git a/build/pkgs/ntl/spkg-configure.m4 b/build/pkgs/ntl/spkg-configure.m4
index 48e41de6ea..d069a798de 100644
--- a/build/pkgs/ntl/spkg-configure.m4
+++ b/build/pkgs/ntl/spkg-configure.m4
@@ -44,7 +44,13 @@ SAGE_SPKG_CONFIGURE([ntl], [
         ntl_inc_dir=`AS_DIRNAME(["$ntl_inc_ntl_dir"])`
         ntl_prefix=`AS_DIRNAME(["$ntl_inc_dir"])`
         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])
-        AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])
+        ntl_libdir=`pkg-config --variable=libdir ntl`
+        if test x$ntl_libdir = x; then
+            AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])
+        else
+            libdir=`basename $ntl_libdir`
+            AC_SUBST(NTL_LIBDIR, [$ntl_prefix/$libdir])
+        fi
     fi
 ])
```

gives, after `./configure` (perhaps a `./bootstrap` is needed before the `./configure`)

```
$ grep NTL build/pkgs/sage_conf/src/sage_conf.py
NTL_INCDIR = "///usr/include"
NTL_LIBDIR = "///usr/lib64"
```

This assumes that `pkg-config` is installed and works correctly and that `basename` is installed. Not sure if there are `autoconf` equivalents to these. This gives the current result if a system `ntl.pc` file is not installed.



---

archive/issue_comments_447801.json:
```json
{
    "body": "Replying to [comment:67 strogdon]:\n[...]\n> This assumes that `pkg-config` is installed and works correctly and that `basename` is installed. Not sure if there are `autoconf` equivalents to these. \n\n`PKG_CHECK_VAR` and other `PKG_` autoconf macros are ones to use from .m4 files to interact with `pkg-config`. Cf https://autotools.io/pkgconfig/variables.html",
    "created_at": "2021-05-21T08:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447801",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:67 strogdon]:
[...]
> This assumes that `pkg-config` is installed and works correctly and that `basename` is installed. Not sure if there are `autoconf` equivalents to these. 

`PKG_CHECK_VAR` and other `PKG_` autoconf macros are ones to use from .m4 files to interact with `pkg-config`. Cf https://autotools.io/pkgconfig/variables.html



---

archive/issue_comments_447802.json:
```json
{
    "body": "Replying to [comment:68 dimpase]:\n> Replying to [comment:67 strogdon]:\n> [...]\n> > This assumes that `pkg-config` is installed and works correctly and that `basename` is installed. Not sure if there are `autoconf` equivalents to these. \n> \n> `PKG_CHECK_VAR` and other `PKG_` autoconf macros are ones to use from .m4 files to interact with `pkg-config`. Cf https://autotools.io/pkgconfig/variables.html\n> \n> \n> \nOK, second try that seems to work:\n\n```diff\ndiff --git a/build/pkgs/ntl/spkg-configure.m4 b/build/pkgs/ntl/spkg-configure.m4\nindex 48e41de6ea..5f83cfaac4 100644\n--- a/build/pkgs/ntl/spkg-configure.m4\n+++ b/build/pkgs/ntl/spkg-configure.m4\n@@ -44,7 +44,10 @@ SAGE_SPKG_CONFIGURE([ntl], [\n         ntl_inc_dir=`AS_DIRNAME([\"$ntl_inc_ntl_dir\"])`\n         ntl_prefix=`AS_DIRNAME([\"$ntl_inc_dir\"])`\n         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])\n-        AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])\n+        PKG_CHECK_VAR([ntl_libdir], [ntl], [libdir])\n+        AS_IF([test \"x$ntl_libdir\" = x], [AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])],\n+             [test \"x$ntl_libdir\" != x], [AC_SUBST(NTL_LIBDIR, [$ntl_prefix/[$(basename $ntl_libdir)]])]\n+            )\n     fi\n ])\n```\n\nNo comments are written to `config.log`. This assumes that `test` and `basename` are available.",
    "created_at": "2021-05-22T06:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447802",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:68 dimpase]:
> Replying to [comment:67 strogdon]:
> [...]
> > This assumes that `pkg-config` is installed and works correctly and that `basename` is installed. Not sure if there are `autoconf` equivalents to these. 
> 
> `PKG_CHECK_VAR` and other `PKG_` autoconf macros are ones to use from .m4 files to interact with `pkg-config`. Cf https://autotools.io/pkgconfig/variables.html
> 
> 
> 
OK, second try that seems to work:

```diff
diff --git a/build/pkgs/ntl/spkg-configure.m4 b/build/pkgs/ntl/spkg-configure.m4
index 48e41de6ea..5f83cfaac4 100644
--- a/build/pkgs/ntl/spkg-configure.m4
+++ b/build/pkgs/ntl/spkg-configure.m4
@@ -44,7 +44,10 @@ SAGE_SPKG_CONFIGURE([ntl], [
         ntl_inc_dir=`AS_DIRNAME(["$ntl_inc_ntl_dir"])`
         ntl_prefix=`AS_DIRNAME(["$ntl_inc_dir"])`
         AC_SUBST(NTL_INCDIR, [$ntl_inc_dir])
-        AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])
+        PKG_CHECK_VAR([ntl_libdir], [ntl], [libdir])
+        AS_IF([test "x$ntl_libdir" = x], [AC_SUBST(NTL_LIBDIR, [$ntl_prefix/lib])],
+             [test "x$ntl_libdir" != x], [AC_SUBST(NTL_LIBDIR, [$ntl_prefix/[$(basename $ntl_libdir)]])]
+            )
     fi
 ])
```

No comments are written to `config.log`. This assumes that `test` and `basename` are available.



---

archive/issue_comments_447803.json:
```json
{
    "body": "Replying to [comment:69 strogdon]:\n> OK, second try that seems to work:\n[These actions](https://github.com/sheerluck/sage/actions/runs/866050081) show that with [your patch](https://github.com/sheerluck/sage/commit/f4344665364af35261a33d825dd4212b1527f682#diff-20d1eb2dd5315b7c869b6e39abc71d81dd429cf8a445a6fb04909d486cfe540d) there are no **skipping incompatible** in logs anymore\n\n(just `sage -t --random-seed=0 src/sage/misc/sageinspect.py  # Timed out` but that is not for this ticket)\n\nSo, positive review, I guess?",
    "created_at": "2021-05-22T10:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447803",
    "user": "https://github.com/sheerluck"
}
```

Replying to [comment:69 strogdon]:
> OK, second try that seems to work:
[These actions](https://github.com/sheerluck/sage/actions/runs/866050081) show that with [your patch](https://github.com/sheerluck/sage/commit/f4344665364af35261a33d825dd4212b1527f682#diff-20d1eb2dd5315b7c869b6e39abc71d81dd429cf8a445a6fb04909d486cfe540d) there are no **skipping incompatible** in logs anymore

(just `sage -t --random-seed=0 src/sage/misc/sageinspect.py  # Timed out` but that is not for this ticket)

So, positive review, I guess?



---

archive/issue_comments_447804.json:
```json
{
    "body": "This branch will only be useful if the system `ntl` installs a `pc` file. Let's make sure I haven't missed some corner cases.\n----\nNew commits:",
    "created_at": "2021-05-22T16:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447804",
    "user": "https://github.com/strogdon"
}
```

This branch will only be useful if the system `ntl` installs a `pc` file. Let's make sure I haven't missed some corner cases.
----
New commits:



---

archive/issue_comments_447805.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-22T16:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447805",
    "user": "https://github.com/strogdon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_447806.json:
```json
{
    "body": "why `[$ntl_prefix/[$(basename $ntl_libdir)]]` and not just `[$ntl_libdir]` ?",
    "created_at": "2021-05-24T21:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447806",
    "user": "https://github.com/dimpase"
}
```

why `[$ntl_prefix/[$(basename $ntl_libdir)]]` and not just `[$ntl_libdir]` ?



---

archive/issue_comments_447807.json:
```json
{
    "body": "Replying to [comment:73 dimpase]:\n> why `[$ntl_prefix/[$(basename $ntl_libdir)]]` and not just `[$ntl_libdir]` ?\nFrom what I recall (comment:23) the extra `//` in `///usr/lib` were needed so I assumed `///usr/lib64` was also needed. If not needed then yes, use `[$ntl_libdir]`.",
    "created_at": "2021-05-24T23:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447807",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:73 dimpase]:
> why `[$ntl_prefix/[$(basename $ntl_libdir)]]` and not just `[$ntl_libdir]` ?
From what I recall (comment:23) the extra `//` in `///usr/lib` were needed so I assumed `///usr/lib64` was also needed. If not needed then yes, use `[$ntl_libdir]`.



---

archive/issue_comments_447808.json:
```json
{
    "body": "the `///` story has to do with suppression of warnings from Sun compiler which is totally irrelevant to us.",
    "created_at": "2021-05-25T10:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447808",
    "user": "https://github.com/dimpase"
}
```

the `///` story has to do with suppression of warnings from Sun compiler which is totally irrelevant to us.



---

archive/issue_comments_447809.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-25T15:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447809",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447810.json:
```json
{
    "body": "the question is: what to do with absence of .pc file?",
    "created_at": "2021-05-27T10:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447810",
    "user": "https://github.com/dimpase"
}
```

the question is: what to do with absence of .pc file?



---

archive/issue_comments_447811.json:
```json
{
    "body": "Replying to [comment:59 gh-sheerluck]:\n> I have put this [ntl-pc.patch](https://github.com/sheerluck/sage-on-gentoo-stage4/blob/master/ntl-pc.patch) in /etc/portage/patches/dev-libs/ntl and now we have /usr/lib64/pkgconfig/ntl.pc in all three [latest images](https://hub.docker.com/r/sheerluck/sage-on-gentoo-stage4/tags)\n\nwhat should to done to get ntl.pc into Gentoo mainline?",
    "created_at": "2021-05-27T10:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447811",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:59 gh-sheerluck]:
> I have put this [ntl-pc.patch](https://github.com/sheerluck/sage-on-gentoo-stage4/blob/master/ntl-pc.patch) in /etc/portage/patches/dev-libs/ntl and now we have /usr/lib64/pkgconfig/ntl.pc in all three [latest images](https://hub.docker.com/r/sheerluck/sage-on-gentoo-stage4/tags)

what should to done to get ntl.pc into Gentoo mainline?



---

archive/issue_comments_447812.json:
```json
{
    "body": "Replying to [comment:78 dimpase]:\n> what should to done to get ntl.pc into Gentoo mainline?\nIt's for Fran\u00e7ois Bissey (fbissey) to decide. Maybe Michael Orlitzky (mjo) can help.",
    "created_at": "2021-05-27T11:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447812",
    "user": "https://github.com/sheerluck"
}
```

Replying to [comment:78 dimpase]:
> what should to done to get ntl.pc into Gentoo mainline?
It's for François Bissey (fbissey) to decide. Maybe Michael Orlitzky (mjo) can help.



---

archive/issue_comments_447813.json:
```json
{
    "body": "Replying to [comment:79 gh-sheerluck]:\n> Replying to [comment:78 dimpase]:\n> > what should to done to get ntl.pc into Gentoo mainline?\n> It's for Fran\u00e7ois Bissey (fbissey) to decide. Maybe Michael Orlitzky (mjo) can help.\n\nOne, since it seems that the mechanism works well enough, I will submit it upstream. Two, I can include it in the sage-on-gentoo overlay but Michael has gone to a lot of effort to bring ntl up to date in Gentoo so I will submit a PR there as well.\n\nBut hopefully upstream will accept it and include it in the next release.",
    "created_at": "2021-05-27T11:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447813",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:79 gh-sheerluck]:
> Replying to [comment:78 dimpase]:
> > what should to done to get ntl.pc into Gentoo mainline?
> It's for François Bissey (fbissey) to decide. Maybe Michael Orlitzky (mjo) can help.

One, since it seems that the mechanism works well enough, I will submit it upstream. Two, I can include it in the sage-on-gentoo overlay but Michael has gone to a lot of effort to bring ntl up to date in Gentoo so I will submit a PR there as well.

But hopefully upstream will accept it and include it in the next release.



---

archive/issue_comments_447814.json:
```json
{
    "body": "This is antithetical to why I work on these things in the first place. This is a sage bug, where sage is doing something stupid that it shouldn't be doing.\n\nI work on these packages at the distro level to **reduce** the amount of work that I have to do. Distro maintainers should be able to ship working upstream software (which they're going to do anyway), and it should be usable by sage out-of-the-box. The user experience is improved with no additional effort.\n\nInstead, what has happened is that now upstream and like five different distros all get bullied into re-creating every ugly hack that sage invents to work around sage problems. Gentoo doesn't need this patch; nobody does except sage, to fix the stupid thing that sage is doing.\n\nFrancois does most of the work anyway and I'm still happy to merge his work, but don't expect me to volunteer to backport patches like these that fix unrelated problems within sage.",
    "created_at": "2021-05-27T15:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447814",
    "user": "https://github.com/orlitzky"
}
```

This is antithetical to why I work on these things in the first place. This is a sage bug, where sage is doing something stupid that it shouldn't be doing.

I work on these packages at the distro level to **reduce** the amount of work that I have to do. Distro maintainers should be able to ship working upstream software (which they're going to do anyway), and it should be usable by sage out-of-the-box. The user experience is improved with no additional effort.

Instead, what has happened is that now upstream and like five different distros all get bullied into re-creating every ugly hack that sage invents to work around sage problems. Gentoo doesn't need this patch; nobody does except sage, to fix the stupid thing that sage is doing.

Francois does most of the work anyway and I'm still happy to merge his work, but don't expect me to volunteer to backport patches like these that fix unrelated problems within sage.



---

archive/issue_comments_447815.json:
```json
{
    "body": "Is there a way to fix this without requiring a `.pc` file? Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?",
    "created_at": "2021-05-27T17:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447815",
    "user": "https://github.com/strogdon"
}
```

Is there a way to fix this without requiring a `.pc` file? Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?



---

archive/issue_comments_447816.json:
```json
{
    "body": "Replying to [comment:82 strogdon]:\n> Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?\n\nYes, it is part of \"best practices\" of a library to supply a .pc file.",
    "created_at": "2021-05-27T17:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447816",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:82 strogdon]:
> Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?

Yes, it is part of "best practices" of a library to supply a .pc file.



---

archive/issue_comments_447817.json:
```json
{
    "body": "Replying to [comment:82 strogdon]:\n> Is there a way to fix this without requiring a `.pc` file? Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?\n\nDelete the `NTL_*` variables and tell macOS users that they have to run sage from homebrew if they built it using homebrew (only in rare cases where they later want to compile & run cython code).\n\nThere's no reason for most libraries to have a pkg-config file; although it's not the pkg-config file that I have a problem with if it solves an **actual** problem (at worse, it's harmless cruft). It's using the pkg-config file to work around a sage issue, tweaking sage to reject NTL when there is no pkg-config file, and then forcing everyone to backport (and test, and stabilize, and then support) a completely unnecessary patch if they want to use their own NTL with sage. We've all already spent time getting working versions of NTL into our distros. If I wanted sage-specific patched versions of all these packages, I could achieve that with a lot less wasted time.",
    "created_at": "2021-05-27T17:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447817",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:82 strogdon]:
> Is there a way to fix this without requiring a `.pc` file? Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?

Delete the `NTL_*` variables and tell macOS users that they have to run sage from homebrew if they built it using homebrew (only in rare cases where they later want to compile & run cython code).

There's no reason for most libraries to have a pkg-config file; although it's not the pkg-config file that I have a problem with if it solves an **actual** problem (at worse, it's harmless cruft). It's using the pkg-config file to work around a sage issue, tweaking sage to reject NTL when there is no pkg-config file, and then forcing everyone to backport (and test, and stabilize, and then support) a completely unnecessary patch if they want to use their own NTL with sage. We've all already spent time getting working versions of NTL into our distros. If I wanted sage-specific patched versions of all these packages, I could achieve that with a lot less wasted time.



---

archive/issue_comments_447818.json:
```json
{
    "body": "Replying to [comment:84 mjo]:\n> tweaking sage to reject NTL when there is no pkg-config file\n\nI don't think this is part of the plan. We obviously cannot do this -- Sage supports lots of released distributions (which obviously do not have ntl.pc)",
    "created_at": "2021-05-27T18:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447818",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:84 mjo]:
> tweaking sage to reject NTL when there is no pkg-config file

I don't think this is part of the plan. We obviously cannot do this -- Sage supports lots of released distributions (which obviously do not have ntl.pc)



---

archive/issue_comments_447819.json:
```json
{
    "body": "Replying to [comment:84 mjo]:\n> Replying to [comment:82 strogdon]:\n> > Is there a way to fix this without requiring a `.pc` file? Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?\n> \n> Delete the `NTL_*` variables and tell macOS users that they have to run sage from homebrew if they built it using homebrew (only in rare cases where they later want to compile & run cython code).\n\nEven better would be to incorporate sourcing of all these things into `sage` script on Homebrew, no?\n\n> \n> There's no reason for most libraries to have a pkg-config file;\n\nthis is only true for sane OSes with sane sysadmins.\n\n> although it's not the pkg-config file that I have a problem with if it solves an **actual** problem (at worse, it's harmless cruft). It's using the pkg-config file to work around a sage issue,\n\nmany (most?) (semi)distros are hostile to multiplatform solutions; e.g. Sage on Gentoo chooses not to\nrun `./configure`, forcing Sage to basically have a lot of cruft specifically for such cases.\nSage has to jump hoops to make distros happy...\n\n\n> tweaking sage to reject NTL when there is no pkg-config file, and then forcing everyone to backport (and test, and stabilize, and then support) a completely unnecessary patch if they want to use their own NTL with sage. We've all already spent time getting working versions of NTL into our distros. If I wanted sage-specific patched versions of all these packages, I could achieve that with a lot less wasted time.",
    "created_at": "2021-05-27T18:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447819",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:84 mjo]:
> Replying to [comment:82 strogdon]:
> > Is there a way to fix this without requiring a `.pc` file? Can it be argued that `ntl` should really be supplying this file - apart from this sage issue?
> 
> Delete the `NTL_*` variables and tell macOS users that they have to run sage from homebrew if they built it using homebrew (only in rare cases where they later want to compile & run cython code).

Even better would be to incorporate sourcing of all these things into `sage` script on Homebrew, no?

> 
> There's no reason for most libraries to have a pkg-config file;

this is only true for sane OSes with sane sysadmins.

> although it's not the pkg-config file that I have a problem with if it solves an **actual** problem (at worse, it's harmless cruft). It's using the pkg-config file to work around a sage issue,

many (most?) (semi)distros are hostile to multiplatform solutions; e.g. Sage on Gentoo chooses not to
run `./configure`, forcing Sage to basically have a lot of cruft specifically for such cases.
Sage has to jump hoops to make distros happy...


> tweaking sage to reject NTL when there is no pkg-config file, and then forcing everyone to backport (and test, and stabilize, and then support) a completely unnecessary patch if they want to use their own NTL with sage. We've all already spent time getting working versions of NTL into our distros. If I wanted sage-specific patched versions of all these packages, I could achieve that with a lot less wasted time.



---

archive/issue_comments_447820.json:
```json
{
    "body": "Replying to [comment:84 mjo]:\n> There's no reason for most libraries to have a pkg-config file\n\nFrom the viewpoint of distribution packaging, `.pc` files are not very useful. But that's missing the point entirely - `pkg-config` is designed as a solution to the problem of finding libraries in a heterogeneous environment.",
    "created_at": "2021-05-27T18:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447820",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:84 mjo]:
> There's no reason for most libraries to have a pkg-config file

From the viewpoint of distribution packaging, `.pc` files are not very useful. But that's missing the point entirely - `pkg-config` is designed as a solution to the problem of finding libraries in a heterogeneous environment.



---

archive/issue_comments_447821.json:
```json
{
    "body": "How about in the absence of `ntl.pc`, to do a AC_TRY_LINK with candidates for the library subdirectory (`lib`, `lib64`). You can copy this kind of code from `m4/ax_boost_base.m4`.",
    "created_at": "2021-05-27T18:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447821",
    "user": "https://github.com/mkoeppe"
}
```

How about in the absence of `ntl.pc`, to do a AC_TRY_LINK with candidates for the library subdirectory (`lib`, `lib64`). You can copy this kind of code from `m4/ax_boost_base.m4`.



---

archive/issue_comments_447822.json:
```json
{
    "body": "Replying to [comment:87 mkoeppe]:\n> Replying to [comment:84 mjo]:\n> > There's no reason for most libraries to have a pkg-config file\n> \n> From the viewpoint of distribution packaging, `.pc` files are not very useful. But that's missing the point entirely - `pkg-config` is designed as a solution to the problem of finding libraries in a heterogeneous environment.\n\nFor most libraries, `AC_SEARCH_LIBS` and friends accomplish that. Unless you're sure that all of your users will have pkg-config installed (and *.pc files for all of their libraries...), you need to have both `PKG_CHECK_MODULES` and fallback `AC_SEARCH_LIBS` checks in your `configure.ac`. But at that point, what purpose does the `PKG_CHECK_MODULES` check serve? You might as well delete it. Another benefit of `AC_SEARCH_LIBS` is that it lets you search for the same function in multiple libraries (or in no libraries!) easily in case the function you need is provided by different libraries or by the OS on various platforms.\n\nWhere pkg-config really shines is with packages whose layouts are universally wacky or with libraries meant to be used in nonstandard ways. And, particularly, it's better to have a standard pkg-config interface than it is to use apache-config, postgres-config, etc. if they're going to be there anyway.\n\nBut you don't really have to convince me that pkg-config itself is useful. I've been fixing awful build systems long enough, and still regularly find thousands of lines of (broken) configure.ac code that does god-knows-what with the stated goal of... detecting a library. It's much easier to send those people a pull request that deletes the whole thing and uses `PKG_CHECK_MODULES` instead.",
    "created_at": "2021-05-27T19:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447822",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:87 mkoeppe]:
> Replying to [comment:84 mjo]:
> > There's no reason for most libraries to have a pkg-config file
> 
> From the viewpoint of distribution packaging, `.pc` files are not very useful. But that's missing the point entirely - `pkg-config` is designed as a solution to the problem of finding libraries in a heterogeneous environment.

For most libraries, `AC_SEARCH_LIBS` and friends accomplish that. Unless you're sure that all of your users will have pkg-config installed (and *.pc files for all of their libraries...), you need to have both `PKG_CHECK_MODULES` and fallback `AC_SEARCH_LIBS` checks in your `configure.ac`. But at that point, what purpose does the `PKG_CHECK_MODULES` check serve? You might as well delete it. Another benefit of `AC_SEARCH_LIBS` is that it lets you search for the same function in multiple libraries (or in no libraries!) easily in case the function you need is provided by different libraries or by the OS on various platforms.

Where pkg-config really shines is with packages whose layouts are universally wacky or with libraries meant to be used in nonstandard ways. And, particularly, it's better to have a standard pkg-config interface than it is to use apache-config, postgres-config, etc. if they're going to be there anyway.

But you don't really have to convince me that pkg-config itself is useful. I've been fixing awful build systems long enough, and still regularly find thousands of lines of (broken) configure.ac code that does god-knows-what with the stated goal of... detecting a library. It's much easier to send those people a pull request that deletes the whole thing and uses `PKG_CHECK_MODULES` instead.



---

archive/issue_comments_447823.json:
```json
{
    "body": "Replying to [comment:80 fbissey]:\n> since it seems that the mechanism works well enough, I will submit it upstream. \n\nGreat, please post the URL here on the ticket description when done",
    "created_at": "2021-05-27T19:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447823",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:80 fbissey]:
> since it seems that the mechanism works well enough, I will submit it upstream. 

Great, please post the URL here on the ticket description when done



---

archive/issue_comments_447824.json:
```json
{
    "body": "I have taken the liberty to push a related fix to this ticket here.\n----\nNew commits:",
    "created_at": "2021-05-27T19:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447824",
    "user": "https://github.com/mkoeppe"
}
```

I have taken the liberty to push a related fix to this ticket here.
----
New commits:



---

archive/issue_comments_447825.json:
```json
{
    "body": "Replying to [comment:88 mkoeppe]:\n> How about in the absence of `ntl.pc`, to do a AC_TRY_LINK with candidates for the library subdirectory (`lib`, `lib64`). You can copy this kind of code from `m4/ax_boost_base.m4`.\n\nIs anyone interested in implementing this?",
    "created_at": "2021-05-27T19:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447825",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:88 mkoeppe]:
> How about in the absence of `ntl.pc`, to do a AC_TRY_LINK with candidates for the library subdirectory (`lib`, `lib64`). You can copy this kind of code from `m4/ax_boost_base.m4`.

Is anyone interested in implementing this?



---

archive/issue_comments_447826.json:
```json
{
    "body": "OK PR added to the description. Note that there is a minor change to the patch attached here. `includedir` shouldn't have included `NTL` as remarqued by Steve Trogdon.",
    "created_at": "2021-05-27T22:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447826",
    "user": "https://github.com/kiwifb"
}
```

OK PR added to the description. Note that there is a minor change to the patch attached here. `includedir` shouldn't have included `NTL` as remarqued by Steve Trogdon.



---

archive/issue_comments_447827.json:
```json
{
    "body": "Replying to [comment:93 mkoeppe]:\n> Replying to [comment:88 mkoeppe]:\n> > How about in the absence of `ntl.pc`, to do a AC_TRY_LINK with candidates for the library subdirectory (`lib`, `lib64`). You can copy this kind of code from `m4/ax_boost_base.m4`.\n> \n> Is anyone interested in implementing this?\nI can have a go at it, if noone else will.",
    "created_at": "2021-06-09T14:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447827",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:93 mkoeppe]:
> Replying to [comment:88 mkoeppe]:
> > How about in the absence of `ntl.pc`, to do a AC_TRY_LINK with candidates for the library subdirectory (`lib`, `lib64`). You can copy this kind of code from `m4/ax_boost_base.m4`.
> 
> Is anyone interested in implementing this?
I can have a go at it, if noone else will.



---

archive/issue_comments_447828.json:
```json
{
    "body": "While we all are waiting for upstream I come up with crazy idea. What if we merge this branch into `develop` just for the sake of GH Actions. It's not gonna break anything or hurt anyone, right?",
    "created_at": "2021-07-10T07:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447828",
    "user": "https://github.com/sheerluck"
}
```

While we all are waiting for upstream I come up with crazy idea. What if we merge this branch into `develop` just for the sake of GH Actions. It's not gonna break anything or hurt anyone, right?



---

archive/issue_comments_447829.json:
```json
{
    "body": "I agree that there is no need to wait for upstream. If gentoo decides to ship a .pc file, that's a good enough reason to check for it in Sage. \n\nThe fix in `ntl/spkg-configure.m4` could use some cleanup though. Getting NTL_LIBDIR from pkgconfig but not NTL_INCDIR seems strange and is basically guaranteeing breakage if any other distribution decides to ship a .pc file. \n\nAlso, the macro `AS_IF` does have an \"run-if-false\" clause, so its use can be simplified. https://www.gnu.org/software/autoconf/manual/autoconf-2.67/html_node/Common-Shell-Constructs.html",
    "created_at": "2021-07-10T17:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447829",
    "user": "https://github.com/mkoeppe"
}
```

I agree that there is no need to wait for upstream. If gentoo decides to ship a .pc file, that's a good enough reason to check for it in Sage. 

The fix in `ntl/spkg-configure.m4` could use some cleanup though. Getting NTL_LIBDIR from pkgconfig but not NTL_INCDIR seems strange and is basically guaranteeing breakage if any other distribution decides to ship a .pc file. 

Also, the macro `AS_IF` does have an "run-if-false" clause, so its use can be simplified. https://www.gnu.org/software/autoconf/manual/autoconf-2.67/html_node/Common-Shell-Constructs.html



---

archive/issue_comments_447830.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-10T17:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447830",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_447831.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-10T20:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447831",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_447832.json:
```json
{
    "body": "New update works on gentoo w/o system .pc file\n\n\n```\n$ grep NTL build/pkgs/sage_conf/src/sage_conf.py\nNTL_INCDIR = \"///usr/include\"\nNTL_LIBDIR = \"///usr/lib\"\n```\n\n\nand with system .pc file\n\n\n```\n$ grep NTL build/pkgs/sage_conf/src/sage_conf.py\nNTL_INCDIR = \"/usr/include\"\nNTL_LIBDIR = \"/usr/lib64\"\n```\n\n----\nNew commits:",
    "created_at": "2021-07-10T20:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447832",
    "user": "https://github.com/strogdon"
}
```

New update works on gentoo w/o system .pc file


```
$ grep NTL build/pkgs/sage_conf/src/sage_conf.py
NTL_INCDIR = "///usr/include"
NTL_LIBDIR = "///usr/lib"
```


and with system .pc file


```
$ grep NTL build/pkgs/sage_conf/src/sage_conf.py
NTL_INCDIR = "/usr/include"
NTL_LIBDIR = "/usr/lib64"
```

----
New commits:



---

archive/issue_comments_447833.json:
```json
{
    "body": "LGTM",
    "created_at": "2021-07-10T20:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447833",
    "user": "https://github.com/mkoeppe"
}
```

LGTM



---

archive/issue_comments_447834.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-10T20:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447834",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_447835.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-07-19T00:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447835",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_events_083033.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-23T20:11:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31341#event-83033"
}
```



---

archive/issue_comments_447836.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31341#issuecomment-447836",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
