# Issue 30832: Upgrade: Flint 2.7.0

Issue created by migration from https://trac.sagemath.org/ticket/31069

Original creator: slelievre

Original creation time: 2020-12-17 20:40:10

CC:  arojas dimpase fbissey @timokau isuruf mjo mkoeppe slelievre saraedum vdelecroix @kliem

Keywords: upgrade, flint

This is to upgrade to Flint 2.7.0.

Our last upgrade was to Flint 2.6.3 in #29719.


---

Comment by slelievre created at 2020-12-17 20:43:06

Flint 2.7-rc2 is out. Can someone test with Sage?

- https://github.com/wbhart/flint2/releases
- [sage-devel announcement: flint 2.7.0 rc1, rc2](https://groups.google.com/g/sage-devel/c/cW2MsZDCrJY)


---

Comment by slelievre created at 2020-12-18 10:13:07

Flint 2.7.0 was released today (2020-12-18).


---

Comment by arojas created at 2020-12-18 11:23:42

singular and e-antic fail to build due to the API changes in `fmpz_mod_poly`


---

Comment by arojas created at 2020-12-18 15:33:12

Actually, Singular is fixed in the (just released) 4.2.0 version. Unfortunately doesn't help much since the Singular upgrade has been stuck for years in #25993


---

Comment by arojas created at 2020-12-19 09:17:13

sagelib itself builds fine with flint 2.7 and passes doctests, modulo the singular upgrade.


---

Comment by kedlaya created at 2021-01-22 05:01:23

For the record, we are now up to Flint 2.7.1. As the timing and numbering suggest, this is mainly a bugfix release.


---

Comment by @thierry-FreeBSD created at 2021-01-23 22:20:38

e-antic has been fixed (in head, to be 1.0.0).


---

Comment by vdelecroix created at 2021-02-20 09:49:29

New commits:


---

Comment by vdelecroix created at 2021-02-20 10:31:01

I did not have any trouble to build singular. What was the issue?


---

Comment by arojas created at 2021-02-20 10:55:25

Replying to [comment:16 vdelecroix]:
> I did not have any trouble to build singular. What was the issue?

Which version of singular?


---

Comment by vdelecroix created at 2021-02-20 12:17:21

Replying to [comment:17 arojas]:
> Replying to [comment:16 vdelecroix]:
> > I did not have any trouble to build singular. What was the issue?
> 
> Which version of singular?

4.1.1p2.p0 shipped with sage 9.3.beta7


---

Comment by arojas created at 2021-02-20 12:36:26

Replying to [comment:18 vdelecroix]:
> Replying to [comment:17 arojas]:
> > Replying to [comment:16 vdelecroix]:
> > > I did not have any trouble to build singular. What was the issue?
> > 
> > Which version of singular?
> 
> 4.1.1p2.p0 shipped with sage 9.3.beta7

It builds because it's not using flint

```
checking for FLINT >= 2.4... problem
Sorry, your FLINT version is too old. Disabling.
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
```



---

Comment by mkoeppe created at 2021-02-20 16:58:04

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-02-20 17:11:54

Can't we patch up the failing configure check in Singular to avoid the dependency on #25993?


---

Comment by vdelecroix created at 2021-02-20 17:12:43

Replying to [comment:22 mkoeppe]:
> Can't we patch up the failing configure check in Singular to avoid the dependency on #25993?

That would be an alternative. But because of the API change I believe it is not enough. Let me give it a try.


---

Comment by arojas created at 2021-02-20 17:13:45

Replying to [comment:22 mkoeppe]:
> Can't we patch up the failing configure check in Singular to avoid the dependency on #25993?

Then it will fail to build with real compilation errors, unless you also backport the flint 2.7 support patches for singular


---

Comment by mkoeppe created at 2021-02-20 17:16:12

perhaps just Singular commit 2e7e3dc89e04ca1ef4175816cd23db6780ad5a38?


---

Comment by mkoeppe created at 2021-02-23 00:35:36

Does anyone already have e-antic 0.1.x patches to work with FLINT 2.7?


---

Comment by arojas created at 2021-02-23 07:08:49

Replying to [comment:26 mkoeppe]:
> Does anyone already have e-antic 0.1.x patches to work with FLINT 2.7?

Yes, https://github.com/archlinux/svntogit-community/blob/packages/e-antic/trunk/e-antic-flint-2.7.patch

Needs massive ifdef'ing if you still want to support flint <2.7


---

Comment by mkoeppe created at 2021-02-23 16:47:35

Replying to [comment:27 arojas]:
> Replying to [comment:26 mkoeppe]:
> > Does anyone already have e-antic 0.1.x patches to work with FLINT 2.7?
> 
> Yes, https://github.com/archlinux/svntogit-community/blob/packages/e-antic/trunk/e-antic-flint-2.7.patch
> 
> Needs massive ifdef'ing if you still want to support flint <2.7

Thanks! I've prepared this in https://github.com/mkoeppe/e-antic/tree/flint-2.7, testing currently at https://github.com/mkoeppe/e-antic/actions/runs/593267164


---

Comment by mkoeppe created at 2021-02-23 18:52:44

Opened #31430 for e-antic patch (or ideally new 0.1.x release)


---

Comment by git created at 2021-03-19 01:08:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-19 01:55:58

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-03-19 01:56:37

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-19 16:40:44

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-03-19 16:40:44

There are still problems with `e_antic` (0.1.9):

`ubuntu-trusty-maximal` (https://github.com/mkoeppe/sage/runs/2145415921 - uses FLINT from SPKG): 

```
  [e_antic-0.1.9]   checking for gmp.h... yes
  [e_antic-0.1.9]   checking for __gmpz_add in -lgmp... yes
  [e_antic-0.1.9]   checking for flint/flint.h... yes
  [e_antic-0.1.9]   checking for flint/fmpz.h... no
  [e_antic-0.1.9]   configure: error: flint header not found
```


`cygwin-standard` (https://github.com/mkoeppe/sage/runs/2145195263 - uses system FLINT 2.7)

```
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -fopenmp -O2 -g -march=native -c poly_extra/fmpz_nextprime.c -o poly_extra/fmpz_nextprime.o >/dev/null 2>&1
poly_extra/fmpz_randprime.c:17:6: error: conflicting types for 'fmpz_randprime'
   17 | void fmpz_randprime(fmpz_t f, flint_rand_t state, mp_bitcnt_t bits, int proved)
      |      ^~~~~~~~~~~~~~
In file included from /usr/include/flint/fmpz_poly.h:33,
                 from ./e-antic/poly_extra.h:17,
                 from poly_extra/fmpz_randprime.c:13:
/usr/include/flint/fmpz.h:188:16: note: previous declaration of 'fmpz_randprime' was here
  188 | FLINT_DLL void fmpz_randprime(fmpz_t f, flint_rand_t state,
      |                ^~~~~~~~~~~~~~
make[4]: *** [Makefile:2699: poly_extra/fmpz_randprime.lo] Error 1
```



---

Comment by mkoeppe created at 2021-03-19 22:38:31

OTOH, on `ubuntu-xenial-maximal` (https://github.com/mkoeppe/sage/runs/2145415962)and `ubuntu-bionic-maximal` (https://github.com/mkoeppe/sage/runs/2145416018), `e_antic`  installs OK.
We can just write off `ubuntu-trusty` - Normaliz does not compile with the ancient compiler there either.


---

Comment by mkoeppe created at 2021-03-19 22:42:49

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-03-19 22:49:15

A serious issue: On `ubuntu-focal-standard` (https://github.com/mkoeppe/sage/runs/2145416039) 

```
  [sagelib-9.3.beta9]   In file included from build/cythonized/sage/data_structures/bounded_integer_sequences.c:3535:
  [sagelib-9.3.beta9]   sage/libs/flint/flint_wrap.h: At top level:
  [sagelib-9.3.beta9]   sage/libs/flint/flint_wrap.h:39:10: fatal error: flint/fmpz_mod.h: No such file or directory
  [sagelib-9.3.beta9]      39 | #include <flint/fmpz_mod.h>
  [sagelib-9.3.beta9]         |          ^~~~~~~~~~~~~~~~~~
  [sagelib-9.3.beta9]   compilation terminated.
```

This is using system `flint` 2.5.2 (see https://repology.org/project/flint/versions)


---

Comment by mkoeppe created at 2021-03-19 22:49:15

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-03-19 22:55:42

(`fmpz_mod.h` was introduced in 2.6.0 according to https://github.com/wbhart/flint2/blob/trunk/NEWS)


---

Comment by mkoeppe created at 2021-03-19 23:07:05

I think dropping support for system FLINT 2.5.x is too disruptive for Sage 9.3, given that the new features are not used yet by anything. 

So I propose to split the ticket into just the upgrade and put the Cython interface to the new FLINT functions on a follow-up ticket for Sage 9.4.


---

Comment by git created at 2021-03-19 23:29:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-03-19 23:29:55

Replying to [comment:41 mkoeppe]:
> I propose to split the ticket into just the upgrade and put the Cython interface to the new FLINT functions on a follow-up ticket for Sage 9.4.

This is now #31525.


---

Comment by mkoeppe created at 2021-03-19 23:33:51

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-03-24 21:17:20

I think this is OK. The main issues were in other packages that have already been fixed. With system flint-2.7.1, I see only one doctest failure due to a timeout in pari that probably cannot be blamed on flint.

I see "unrelated" failures in the CI runs as well. If you are convinced of flint's innocence, we can set this to positive review.


---

Comment by dimpase created at 2021-03-24 21:42:56

lgtm too


---

Comment by dimpase created at 2021-03-24 21:42:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-03-24 22:16:37

Thanks!


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Setting priority to blocker to bring this ticket to the attention of the release bot.


---

Comment by roed created at 2021-03-30 07:32:38

After merging this ticket into #31548 (since I want to use new functionality from FLINT 2.7.1 there) I'm getting errors starting Sage.  I don't usually update spkgs outside of beta releases, so I could be doing something wrong (I'm running OS X 10.15.2).

```
$ git trac fetch 31069 && git merge
$ make build
...
Sage build/upgrade complete!
$ sage
ImportError Python 3.9.1: /Users/roed/sage/sage-9.3.beta7/local/bin/python3
...
ImportError: dlopen(/Users/roed/sage/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/matrix/matrix_mpolynomial_dense.cpython-39-darwin.so, 2): Library not loaded: /Users/roed/sage/sage-9.3.beta7/local/lib/libSingular-4.1.1.dylib
  Referenced from: /Users/roed/sage/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/matrix/matrix_mpolynomial_dense.cpython-39-darwin.so
  Reason: image not found
```

Full install.log available [here](https://math.mit.edu/~roed/31548_install.log).


---

Comment by fbissey created at 2021-03-30 07:36:09

I believe you need singular 4.2.0p1 (9.3.beta8 if I am not mistaken) with that. Singular uses flint so does need rebuilding and 4.2.0 is the first one that is compatible with flint-2.7.1.


---

Comment by roed created at 2021-03-30 08:53:12

Despite the folder name, this is based on sage-9.3.beta9, and when I did `make build` it appeared to be building `singular-4.2.0p1+2021-03-13+sage`.


---

Comment by roed created at 2021-03-30 08:58:24

I feel like I'm missing something basic here: when I try running `sage -f flint` it gives me lots of errors saying that `flint-2.7.1` isn't found:

```
[flint-2.7.1] Attempting to download package flint-2.7.1.tar.gz from mirrors
[flint-2.7.1] http://mirrors.mit.edu/sage/spkg/upstream/flint/flint-2.7.1.tar.gz
[flint-2.7.1] [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[flint-2.7.1] ERROR [transfer|run:135]: [Errno 404] Not Found: '//mirrors.mit.edu/sage/spkg/upstream/flint/flint-2.7.1.tar.gz'
[flint-2.7.1] http://www.mirrorservice.org/sites/www.sagemath.org/spkg/upstream/flint/flint-2.7.1.tar.gz
...
[flint-2.7.1] FileNotMirroredError: tarball does not exist on mirror network
[flint-2.7.1] ************************************************************************
[flint-2.7.1] ************************************************************************
[flint-2.7.1] Error downloading flint-2.7.1.tar.gz

```

Do I need to download a tarball manually from somewhere?


---

Comment by fbissey created at 2021-03-30 08:59:41

Replying to [comment:51 roed]:
> Despite the folder name, this is based on sage-9.3.beta9, and when I did `make build` it appeared to be building `singular-4.2.0p1+2021-03-13+sage`.

OK, then it appears that somehow `sage/matrix/matrix_mpolynomial_dense.cpython-39-darwin.so` has not be rebuilt because it is still looking for libSingular-4.1.1 when it should look for libSingular-4.2.0.


---

Comment by fbissey created at 2021-03-30 09:04:37

Replying to [comment:52 roed]:
> I feel like I'm missing something basic here: when I try running `sage -f flint` it gives me lots of errors saying that `flint-2.7.1` isn't found:
> {{{
> [flint-2.7.1] Attempting to download package flint-2.7.1.tar.gz from mirrors
> [flint-2.7.1] http://mirrors.mit.edu/sage/spkg/upstream/flint/flint-2.7.1.tar.gz
> [flint-2.7.1] [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
> [flint-2.7.1] ERROR [transfer|run:135]: [Errno 404] Not Found: '//mirrors.mit.edu/sage/spkg/upstream/flint/flint-2.7.1.tar.gz'
> [flint-2.7.1] http://www.mirrorservice.org/sites/www.sagemath.org/spkg/upstream/flint/flint-2.7.1.tar.gz
> ...
> [flint-2.7.1] FileNotMirroredError: tarball does not exist on mirror network
> [flint-2.7.1] ************************************************************************
> [flint-2.7.1] ************************************************************************
> [flint-2.7.1] Error downloading flint-2.7.1.tar.gz
> 
> }}}
> Do I need to download a tarball manually from somewhere?

This ticket is not merged, tarball are not usually mirrored before Volker attempt to merge the tickets. You'll have to fetch the source a different way. Matthias created a handy way of using a string called `upstream_url` in the file checksum.ini to do the fetching from upstream but I cannot remember how it works.


---

Comment by slelievre created at 2021-03-30 09:33:26

Do this:

```
$ ./bootstrap -q
$ ./configure --enable-download-from-upstream-url -q
$ make -s V=0
```



---

Comment by roed created at 2021-03-30 17:52:46

Thanks!  That seems to have worked.


---

Comment by roed created at 2021-03-31 15:48:42

For anyone else looking at this, I also had to do `sage -f flint` after the commands Samuel gave.


---

Comment by slelievre created at 2021-03-31 18:30:03

This should do everything at once:

```
$ ./bootstrap -q
$ ./configure --enable-download-from-upstream-url -q
$ make -s V=0 flint-clean
$ make -s V=0
```



---

Comment by mkoeppe created at 2021-04-02 19:43:36

Looks unrealistic to squeeze this into 9.3


---

Comment by mkoeppe created at 2021-04-02 19:43:36

Changing priority from blocker to critical.


---

Comment by vbraun created at 2021-05-27 20:30:50

Resolution: fixed
