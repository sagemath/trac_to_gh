# Issue 18790: matroid partitioning, matroid union

archive/issues_018790.json:
```json
{
    "body": "CC:  stefan yomcat rudi\n\nImplement:\n- an algorithm to partition the matroid into minimum number of independent sets.\n- rank oracle for matroid union.\n\nBoth algorithm is based on matroid intersection and requires matroid sum (as a matroid) and a partition matroid.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19027\n\n",
    "created_at": "2015-08-13T18:58:38Z",
    "labels": [
        "component: matroid theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "matroid partitioning, matroid union",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18790",
    "user": "https://github.com/chaoxu"
}
```
CC:  stefan yomcat rudi

Implement:
- an algorithm to partition the matroid into minimum number of independent sets.
- rank oracle for matroid union.

Both algorithm is based on matroid intersection and requires matroid sum (as a matroid) and a partition matroid.

Issue created by migration from https://trac.sagemath.org/ticket/19027





---

archive/issue_comments_256553.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-08-13T19:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256553",
    "user": "https://github.com/chaoxu"
}
```

New commits:



---

archive/issue_comments_256554.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-08-13T19:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256554",
    "user": "https://github.com/chaoxu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_256555.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-13T20:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256555",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_256556.json:
```json
{
    "body": "Wow. Matroid union. I've been hoping that it would come true for a looooong time. There is a graph function that \"screams\" for that: `Graph.edge_disjoint_spanning_trees` `:-P`",
    "created_at": "2015-08-14T07:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256556",
    "user": "https://github.com/nathanncohen"
}
```

Wow. Matroid union. I've been hoping that it would come true for a looooong time. There is a graph function that "screams" for that: `Graph.edge_disjoint_spanning_trees` `:-P`



---

archive/issue_comments_256557.json:
```json
{
    "body": "Replying to [comment:4 ncohen]:\n> Wow. Matroid union. I've been hoping that it would come true for a looooong time. There is a graph function that \"screams\" for that: `Graph.edge_disjoint_spanning_trees` `:-P`\n\nThere are still 2 barriers to using matroid union for `Graph.edge_disjoint_spanning_trees`.\n1. The algorithm is slow and likely can't surpass a highly optimized integer program implementation for reasonable input sizes. (#18946 will speed things up a lot)\n2. The current implementation of matroid union is a reduction to matroid intersection. We can find min base covering but not max base packing. I'm not sure how to get the packing version other than implement a direct matroid union algorithm.\n\nMatroid union and matroid partition have similar running time. (both reduces to matroid intersection of a matroid sum and a partition matroid)\nA rough estimate for matroid partition running time is O(n<sup>3</sup>Q) where Q is the time for independence oracle query, n is the size of the groundset. For a graphic matroid of only 60 elements, it took 30 seconds! (in the worst case Q can be as bad as O(r<sup>3</sup>) because we use linear matroid to implement graphic matroid. Here r is the rank of the matroid) The rank computation is almost 100% of the running time. \n\nThe good news is that the algorithm in #18946 speeds things up greatly. Just replace all occurrence of `intersection` with `_intersection_unweighted`. The process that took 30 seconds originally took less than 2 seconds. A closer inspection shows it uses much fewer rank computations, not because of faster rank computations.\n\nBut a faster rank computations would be even more helpful. We are suppose to expect running time of O(n<sup>3</sup>) in linear matroids if pivoting are done in the right order [Cunningham 1986, the same paper in #18946].\n\nHere is the actual run time breakdown of that 30 second computation. See  `basis_exchange_matroid.pyx:670(_rank)`. \n\n\n```\nsage: M=Matroid(graphs.RandomRegular(3,40)))\nsage: %prun M.partition()\n         114970426 function calls in 31.515 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n  1753573   10.459    0.000   11.930    0.000 linear_matroid.pyx:5506(__exchange)\n   309403    5.859    0.000   28.289    0.000 basis_exchange_matroid.pyx:271(__move)\n 18323845    5.128    0.000    7.242    0.000 bitset.pxi:466(bitset_next)\n  7828013    1.310    0.000    1.758    0.000 bitset.pxi:356(bitset_add)\n 18245089    1.082    0.000    1.082    0.000 bitset.pxi:408(_bitset_first_in_limb)\n 18245090    1.031    0.000    1.031    0.000 bitset.pxi:55(limb_lower_bits_down)\n   309403    1.021    0.000    2.368    0.000 basis_exchange_matroid.pyx:236(__pack)\n 13592459    1.016    0.000    1.016    0.000 linear_matroid.pyx:5500(__is_exchange_pair)\n  6907871    1.005    0.000    1.326    0.000 bitset.pxi:417(bitset_first)\n  5260719    0.937    0.000    1.251    0.000 bitset.pxi:341(bitset_discard)\n  1753573    0.597    0.000    1.471    0.000 basis_exchange_matroid.pyx:264(__exchange)\n  7828013    0.448    0.000    0.448    0.000 bitset.pxi:43(limb_one_set_bit)\n  5429232    0.321    0.000    0.321    0.000 bitset.pxi:401(_bitset_first_in_limb_nonzero)\n  5260719    0.315    0.000    0.315    0.000 bitset.pxi:49(limb_one_zero_bit)\n     1830    0.298    0.000    0.311    0.000 matroid.pyx:537(_circuit)\n   309402    0.209    0.000   28.571    0.000 basis_exchange_matroid.pyx:318(__max_independent)\n   309402    0.176    0.000   31.140    0.000 basis_exchange_matroid.pyx:670(_rank)\n  1753573    0.104    0.000    0.104    0.000 bitset.pxi:199(bitset_isempty)\n       61    0.063    0.001   32.689    0.536 matroid.pyx:6015(_intersection_augmentation)\n   618845    0.044    0.000    0.044    0.000 bitset.pxi:584(bitset_difference)\n   309402    0.028    0.000    0.028    0.000 bitset.pxi:546(bitset_intersection)\n   309402    0.025    0.000    0.025    0.000 bitset.pxi:504(bitset_len)\n   309442    0.024    0.000    0.024    0.000 bitset.pxi:121(bitset_clear)\n     1830    0.012    0.000    0.012    0.000 matroid.pyx:808(_is_independent)\n        1    0.001    0.001   32.689   32.689 matroid.pyx:5975(_intersection)\n       39    0.000    0.000    0.001    0.000 basis_exchange_matroid.pyx:291(__fundamental_cocircuit)\n       61    0.000    0.000    0.033    0.001 matroid.pyx:599(_closure)\n        1    0.000    0.000   32.689   32.689 matroid.pyx:5917(intersection)\n```\n",
    "created_at": "2015-08-14T17:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256557",
    "user": "https://github.com/chaoxu"
}
```

Replying to [comment:4 ncohen]:
> Wow. Matroid union. I've been hoping that it would come true for a looooong time. There is a graph function that "screams" for that: `Graph.edge_disjoint_spanning_trees` `:-P`

There are still 2 barriers to using matroid union for `Graph.edge_disjoint_spanning_trees`.
1. The algorithm is slow and likely can't surpass a highly optimized integer program implementation for reasonable input sizes. (#18946 will speed things up a lot)
2. The current implementation of matroid union is a reduction to matroid intersection. We can find min base covering but not max base packing. I'm not sure how to get the packing version other than implement a direct matroid union algorithm.

Matroid union and matroid partition have similar running time. (both reduces to matroid intersection of a matroid sum and a partition matroid)
A rough estimate for matroid partition running time is O(n<sup>3</sup>Q) where Q is the time for independence oracle query, n is the size of the groundset. For a graphic matroid of only 60 elements, it took 30 seconds! (in the worst case Q can be as bad as O(r<sup>3</sup>) because we use linear matroid to implement graphic matroid. Here r is the rank of the matroid) The rank computation is almost 100% of the running time. 

The good news is that the algorithm in #18946 speeds things up greatly. Just replace all occurrence of `intersection` with `_intersection_unweighted`. The process that took 30 seconds originally took less than 2 seconds. A closer inspection shows it uses much fewer rank computations, not because of faster rank computations.

But a faster rank computations would be even more helpful. We are suppose to expect running time of O(n<sup>3</sup>) in linear matroids if pivoting are done in the right order [Cunningham 1986, the same paper in #18946].

Here is the actual run time breakdown of that 30 second computation. See  `basis_exchange_matroid.pyx:670(_rank)`. 


```
sage: M=Matroid(graphs.RandomRegular(3,40)))
sage: %prun M.partition()
         114970426 function calls in 31.515 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
  1753573   10.459    0.000   11.930    0.000 linear_matroid.pyx:5506(__exchange)
   309403    5.859    0.000   28.289    0.000 basis_exchange_matroid.pyx:271(__move)
 18323845    5.128    0.000    7.242    0.000 bitset.pxi:466(bitset_next)
  7828013    1.310    0.000    1.758    0.000 bitset.pxi:356(bitset_add)
 18245089    1.082    0.000    1.082    0.000 bitset.pxi:408(_bitset_first_in_limb)
 18245090    1.031    0.000    1.031    0.000 bitset.pxi:55(limb_lower_bits_down)
   309403    1.021    0.000    2.368    0.000 basis_exchange_matroid.pyx:236(__pack)
 13592459    1.016    0.000    1.016    0.000 linear_matroid.pyx:5500(__is_exchange_pair)
  6907871    1.005    0.000    1.326    0.000 bitset.pxi:417(bitset_first)
  5260719    0.937    0.000    1.251    0.000 bitset.pxi:341(bitset_discard)
  1753573    0.597    0.000    1.471    0.000 basis_exchange_matroid.pyx:264(__exchange)
  7828013    0.448    0.000    0.448    0.000 bitset.pxi:43(limb_one_set_bit)
  5429232    0.321    0.000    0.321    0.000 bitset.pxi:401(_bitset_first_in_limb_nonzero)
  5260719    0.315    0.000    0.315    0.000 bitset.pxi:49(limb_one_zero_bit)
     1830    0.298    0.000    0.311    0.000 matroid.pyx:537(_circuit)
   309402    0.209    0.000   28.571    0.000 basis_exchange_matroid.pyx:318(__max_independent)
   309402    0.176    0.000   31.140    0.000 basis_exchange_matroid.pyx:670(_rank)
  1753573    0.104    0.000    0.104    0.000 bitset.pxi:199(bitset_isempty)
       61    0.063    0.001   32.689    0.536 matroid.pyx:6015(_intersection_augmentation)
   618845    0.044    0.000    0.044    0.000 bitset.pxi:584(bitset_difference)
   309402    0.028    0.000    0.028    0.000 bitset.pxi:546(bitset_intersection)
   309402    0.025    0.000    0.025    0.000 bitset.pxi:504(bitset_len)
   309442    0.024    0.000    0.024    0.000 bitset.pxi:121(bitset_clear)
     1830    0.012    0.000    0.012    0.000 matroid.pyx:808(_is_independent)
        1    0.001    0.001   32.689   32.689 matroid.pyx:5975(_intersection)
       39    0.000    0.000    0.001    0.000 basis_exchange_matroid.pyx:291(__fundamental_cocircuit)
       61    0.000    0.000    0.033    0.001 matroid.pyx:599(_closure)
        1    0.000    0.000   32.689   32.689 matroid.pyx:5917(intersection)
```




---

archive/issue_comments_256558.json:
```json
{
    "body": "I see I see. Thank you very much for the details `:-)`",
    "created_at": "2015-08-14T20:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256558",
    "user": "https://github.com/nathanncohen"
}
```

I see I see. Thank you very much for the details `:-)`



---

archive/issue_comments_256559.json:
```json
{
    "body": "I'm giving this a positive review. There's still the question of how to make this available to end users, but let's put that in a new ticket (which I'll open in a second).",
    "created_at": "2015-08-21T20:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256559",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

I'm giving this a positive review. There's still the question of how to make this available to end users, but let's put that in a new ticket (which I'll open in a second).



---

archive/issue_comments_256560.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-08-21T20:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256560",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_256561.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-08-22T02:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18790#issuecomment-256561",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052952.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-08-22T02:43:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18790",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18790#event-52952"
}
```
