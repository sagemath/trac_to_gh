# Issue 30769: Add more typing information to manifold package

Issue created by migration from https://trac.sagemath.org/ticket/31006

Original creator: @tobiasdiez

Original creation time: 2020-12-04 12:42:25

CC:  tscrim nthiery @mjungmath egourgoulhon chapoton

In extension of #29775, more typing information is added to the manifold package (and its dependencies).


---

Comment by @tobiasdiez created at 2020-12-04 12:42:32

Changing status from new to needs_review.


---

Comment by git created at 2020-12-04 12:44:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-04 18:51:25

`from __future__ import annotations` is not available in Python 3.6, which we still support, so I am adding #30551 (Drop Python 3.6 support) as a dependency


---

Comment by chapoton created at 2020-12-04 19:46:47

same in #30989


---

Comment by @tobiasdiez created at 2020-12-05 12:32:53

Good to know, (but isn't #30053 already breaking 3.6 support?)


---

Comment by mkoeppe created at 2020-12-05 17:37:46

Replying to [comment:5 gh-tobiasdiez]:
> isn't #30053 already breaking 3.6 support?
That was temporary, just for one beta during the 9.2 cycle. Python 3.6 support was restored in #30576, #30740, #30758.


---

Comment by chapoton created at 2020-12-19 18:21:24

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2020-12-19 18:21:24

red branch


---

Comment by git created at 2020-12-20 22:51:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-20 22:52:20

Merged develop branch.


---

Comment by @tobiasdiez created at 2020-12-20 22:52:20

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-02-02 16:56:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-27 22:29:49

Now that we have dropped support for Python 3.6 (#30551), there is no obstacle to using `from __future__ import annotations` any more.


---

Comment by chapoton created at 2021-07-13 13:13:43

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-07-13 13:13:43

red branch => needs work


---

Comment by git created at 2021-11-28 21:02:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-11-28 21:02:22

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-11-28 21:02:22

Rebased


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-01-13 00:29:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-13 00:29:51

The patchbot found some unused imports, which I've now removed. Should be green now.


---

Comment by mkoeppe created at 2022-02-23 17:59:01

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-23 17:59:01

red branch


---

Comment by @tobiasdiez created at 2022-02-23 21:53:19

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-23 21:53:19

Merging the develop branch should be trivial, but I'll not be able to do this is in the near future; so setting it back to "needs review".


---

Comment by mkoeppe created at 2022-02-23 23:53:52

That's not how it works


---

Comment by @tobiasdiez created at 2022-02-24 22:47:11

The exact terminology of the ticket states is still somewhat mysterious to me. What I'm generally used to from participating in other projects is that "needs review" means that the PR is ready to be checked by the core developers. After the review process is complete but there are merge conflicts, then it's the responsibility of the contributer to fix then and after a final sign off it's merged. Sorry if that's different in sage and I've violated some unwritten laws


---

Comment by mkoeppe created at 2022-02-24 22:55:04

Yes, that's not how it works. Ready for review means that the branch can be merged and tested as is. The burden should not be on reviewers to fix merge conflicts


---

Comment by chapoton created at 2022-02-26 20:33:14

To add my own grain of salt, I do not like to have red blobs on my patchtbot summary:

https://patchbot.sagemath.org/?base=develop&participant=chapoton

Usually, I immediatly hammers them down to "needs work".


---

Comment by git created at 2022-03-01 13:35:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-01 18:01:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-01 18:03:16

Replying to [comment:24 mkoeppe]:
> Yes, that's not how it works. Ready for review means that the branch can be merged and tested as is. The burden should not be on reviewers to fix merge conflicts

I agree the reviewer shouldn't have to merge the latest develop version, but fail to see why the ticket cannot reviewed with merge conflicts.

Anyway, rebased so ready for review.


---

Comment by mkoeppe created at 2022-03-03 01:21:37


```
     def chart(self, coordinates='', names=None, calc_method=None,
-              coord_restrictions=None):
+              coord_restrictions=None) -> Union[Chart, RealDiffChart]:
         r"""
         Define a chart, the domain of which is the manifold.
 
@@ -1928,7 +1938,7 @@ class TopologicalManifold(ManifoldSubset):
         return self._scalar_field_algebra
 
     def scalar_field(self, coord_expression=None, chart=None, name=None,
-                     latex_name=None):
+                     latex_name=None) -> Union[ScalarField, DiffScalarField]:
```


Why a union here - `Chart` is a base class of `RealDiffChart`.
Likewise for `ScalarField`.


---

Comment by mkoeppe created at 2022-03-03 01:29:03

And same comment as I made in #29775: Please no gratuitous reformatting like this:

```
         for more examples and documentation.
 
         """
-        from sage.manifolds.differentiable.tensorfield_module import \
-                                                              TensorFieldModule
+        from sage.manifolds.differentiable.tensorfield_module import TensorFieldModule
         if (k,l) not in self._tensor_modules:
             self._tensor_modules[(k,l)] = TensorFieldModule(self, (k,l))
         return self._tensor_modules[(k,l)]
```

or this:

```
         from sage.manifolds.differentiable.metric import PseudoRiemannianMetricParal
-        return PseudoRiemannianMetricParal(self, name,
-                                           signature=signature[0]-signature[1],
-                                           latex_name=latex_name)
+
+        return PseudoRiemannianMetricParal(
+            self, name, signature=signature[0] - signature[1], latex_name=latex_name
+        )
```


It's easier for reviewers if you focus the changes on what is promised on the ticket. Don't mix it with style changes and random other changes


---

Comment by mkoeppe created at 2022-03-03 01:29:19

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-03 12:49:28

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-03 12:49:28

Replying to [comment:29 mkoeppe]:
> Why a union here - `Chart` is a base class of `RealDiffChart`.
> Likewise for `ScalarField`.
> 

That was a workaround for a bug in pylance, which had troubles to correctly infer that RealDiffChart is indeed a subclass of Chart. This seems to be fixed in the meantime, so I've removed the union again. Thanks for pointing this out.


---

Comment by git created at 2022-03-03 12:49:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-03 19:12:20

Before setting to needs review, please check whether you have addressed all comments


---

Comment by mkoeppe created at 2022-03-03 19:12:20

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-03 19:20:17

What is still missing?


---

Comment by git created at 2022-03-20 13:06:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-20 16:18:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-20 16:19:13

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-20 16:47:09

Also these changes are unnecessary:

```
 
         # 0/ Compatibility checks:
         if comp._ring is not self._ring:
-            raise ValueError("the components are not defined on the "
-                             "same ring as the module")
+            raise ValueError("the components are not defined on the " +
+                              "same ring as the module")
         if comp._frame not in self._known_bases:
```



---

Comment by @tobiasdiez created at 2022-03-20 16:56:04

Yes, I agree. As I've said above, these changes came from accidentally running a code formatter. Now it's quite a lot of work to untie these changes. But they are minor reformats, so I hope its fine to keep them as part of this ticket.


---

Comment by git created at 2022-03-21 01:11:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-21 01:12:13

Squashed, dropped reformats, rebased on top of #29775, fixed so that it works in Python 3.7


---

Comment by mkoeppe created at 2022-03-21 01:13:05

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-21 09:51:13

Thanks


---

Comment by @mjungmath created at 2022-03-21 10:27:48

Changing status from positive_review to needs_work.


---

Comment by @mjungmath created at 2022-03-21 10:27:48

Same comment as in #29775 here:


```diff
+        That is, return `\Gamma^\infty(\Phi^* TN)` where `\Phi:\ M \to N` is a smooth map.
```


Doc changes are not supposed to be part of this ticket. I would appreciate if we can address that in another ticket, and then discuss it with Eric and Travis.


---

Comment by git created at 2022-03-21 11:43:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-21 11:43:35

Rebased onto narrowed #29775


---

Comment by mkoeppe created at 2022-03-21 11:43:35

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-03-21 23:07:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-21 23:07:27

Rebased onto updated #29775


---

Comment by git created at 2022-03-21 23:21:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-28 10:38:00

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-28 10:38:00

As all remarks seem to be addressed, Matthias is fine with my changes and I'm with his, I'll set it back to positively reviewed.


---

Comment by egourgoulhon created at 2022-03-28 10:49:42

Changing status from positive_review to needs_work.


---

Comment by egourgoulhon created at 2022-03-28 10:49:42

Merge failure with Sage 9.6.beta6


---

Comment by git created at 2022-03-29 08:53:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-29 08:58:39

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-29 08:58:39

Merged latest version of #29775


---

Comment by egourgoulhon created at 2022-03-30 19:56:29

As in #29775, the coverage issue reported by the patchbot is a spurious one, due to the use of ``@`overload`. 

Michael, do you agree with the positive review?


---

Comment by egourgoulhon created at 2022-03-30 19:56:29

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-30 20:00:35

Thanks!


---

Comment by @mjungmath created at 2022-04-02 12:12:21

Replying to [comment:56 egourgoulhon]:
> Michael, do you agree with the positive review?

Yes. I still find some style changes unnecessary, e.g.


```diff
-    def set_embedding(self, phi, inverse=None, var=None,
-                      t_inverse=None):
+    def set_embedding(
+        self, phi: ContinuousMap, inverse=None, var=None, t_inverse=None
+    ):
```


leaving a glimpse of inconsistency behind. If that could be changed: I am happy. But I can also live with this. I would just appreciated it if we can stick to previously established styling rules in the future. Otherwise the code becomes more a patchwork rug than it already is.


---

Comment by vbraun created at 2022-04-03 11:13:51

Resolution: fixed
