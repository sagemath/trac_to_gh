# Issue 23982: critical bug in comparison between RealField and QQ

archive/issues_023982.json:
```json
{
    "body": "CC:  @jdemeyer\n\n\n```\nsage: t = RealField(2)(1)\nsage: t >= 5/4\nTrue\n```\n\nThis is clearly wrong. My guess is that `5/4` is first converted to a 2-bit\nfloating-point number, which is `1` in mode to nearest, then the comparison is made.\n\nThe fix is either to convert `5/4` with directed rounding (here toward +infinity),\nor to convert `t` to rational using `exact_rational`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24219\n\n",
    "created_at": "2017-11-15T14:07:06Z",
    "labels": [
        "component: basic arithmetic",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "critical bug in comparison between RealField and QQ",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23982",
    "user": "https://github.com/zimmermann6"
}
```
CC:  @jdemeyer


```
sage: t = RealField(2)(1)
sage: t >= 5/4
True
```

This is clearly wrong. My guess is that `5/4` is first converted to a 2-bit
floating-point number, which is `1` in mode to nearest, then the comparison is made.

The fix is either to convert `5/4` with directed rounding (here toward +infinity),
or to convert `t` to rational using `exact_rational`.

Issue created by migration from https://trac.sagemath.org/ticket/24219





---

archive/issue_comments_335630.json:
```json
{
    "body": "\n```\nsage: t\n1.0\nsage: RealField(2)(5/4)\n1.0\n```\n\nSo this is not really a bug",
    "created_at": "2017-11-15T14:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335630",
    "user": "https://github.com/fchapoton"
}
```


```
sage: t
1.0
sage: RealField(2)(5/4)
1.0
```

So this is not really a bug



---

archive/issue_comments_335631.json:
```json
{
    "body": "I did not ask `t >= RealField(2)(5/4)`, but `t >= 5/4`.\nDoes the following convince you? Note that 6*t is exactly representable in 2-bit precision.\n\n```\nsage: t = RealField(2)(1)\nsage: t >= 7/6\nTrue\nsage: 6*t >= 7\nFalse\n```\n",
    "created_at": "2017-11-15T15:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335631",
    "user": "https://github.com/zimmermann6"
}
```

I did not ask `t >= RealField(2)(5/4)`, but `t >= 5/4`.
Does the following convince you? Note that 6*t is exactly representable in 2-bit precision.

```
sage: t = RealField(2)(1)
sage: t >= 7/6
True
sage: 6*t >= 7
False
```




---

archive/issue_comments_335632.json:
```json
{
    "body": "Well, comparison happens after coercion, and coercion can only lose precision. If you want comparison that makes sense, you should avoid using such a small precision.",
    "created_at": "2017-11-15T15:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335632",
    "user": "https://github.com/fchapoton"
}
```

Well, comparison happens after coercion, and coercion can only lose precision. If you want comparison that makes sense, you should avoid using such a small precision.



---

archive/issue_comments_335633.json:
```json
{
    "body": "where is it documented that comparison happens after coercion? Is the user warned about that?\nAnd why is the coercion done in the direction QQ to RealField and not the converse, which would not lose any information?",
    "created_at": "2017-11-15T15:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335633",
    "user": "https://github.com/zimmermann6"
}
```

where is it documented that comparison happens after coercion? Is the user warned about that?
And why is the coercion done in the direction QQ to RealField and not the converse, which would not lose any information?



---

archive/issue_comments_335634.json:
```json
{
    "body": "Coercion is supposed to be exact (mathematically), so it can not guess anything from an approximate real number. Going from R to QQ is a conversion.\n\n```\nsage: R = RealField(2)\nsage: R.coerce_map_from(QQ)\n\nGeneric map:\n  From: Rational Field\n  To:   Real Field with 2 bits of precision\nsage: QQ.coerce_map_from(R)\n```\n",
    "created_at": "2017-11-15T15:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335634",
    "user": "https://github.com/fchapoton"
}
```

Coercion is supposed to be exact (mathematically), so it can not guess anything from an approximate real number. Going from R to QQ is a conversion.

```
sage: R = RealField(2)
sage: R.coerce_map_from(QQ)

Generic map:
  From: Rational Field
  To:   Real Field with 2 bits of precision
sage: QQ.coerce_map_from(R)
```




---

archive/issue_comments_335635.json:
```json
{
    "body": "For your first question, see \n\nhttp://doc.sagemath.org/html/en/reference/coercion/index.html\n\nand\n\nhttp://doc.sagemath.org/html/en/reference/structure/sage/structure/element.html",
    "created_at": "2017-11-15T15:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335635",
    "user": "https://github.com/fchapoton"
}
```

For your first question, see 

http://doc.sagemath.org/html/en/reference/coercion/index.html

and

http://doc.sagemath.org/html/en/reference/structure/sage/structure/element.html



---

archive/issue_comments_335636.json:
```json
{
    "body": "the issue can be simplified to:\n\n```\nsage: RealField(2)(7) == 10\nTrue\n```\n",
    "created_at": "2017-11-15T15:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335636",
    "user": "https://github.com/zimmermann6"
}
```

the issue can be simplified to:

```
sage: RealField(2)(7) == 10
True
```




---

archive/issue_comments_335637.json:
```json
{
    "body": "Changing component from basic arithmetic to coercion.",
    "created_at": "2017-11-16T08:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335637",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from basic arithmetic to coercion.



---

archive/issue_comments_335638.json:
```json
{
    "body": "The behaviour that you see is by design, so by definition it's a feature and not a bug.\n\nNote also that what you see is consistent with subtraction, which is a good thing:\n\n```\nsage: RealField(2)(1) - 5/4\n0.00\n```\n\n\nI don't see a simple fix here... it would require substantial changes to the coercion model.",
    "created_at": "2017-11-16T08:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335638",
    "user": "https://github.com/jdemeyer"
}
```

The behaviour that you see is by design, so by definition it's a feature and not a bug.

Note also that what you see is consistent with subtraction, which is a good thing:

```
sage: RealField(2)(1) - 5/4
0.00
```


I don't see a simple fix here... it would require substantial changes to the coercion model.



---

archive/issue_comments_335639.json:
```json
{
    "body": "> I don't see a simple fix here... \n\nwhy no simply forbid comparison involving floating-point numbers, if it can result in mathematically wrong results? Then the user would have to do:\n\n```\nsage: RealField(2)(7).exact_rational() == 10\nFalse\n```\n",
    "created_at": "2017-11-16T16:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335639",
    "user": "https://github.com/zimmermann6"
}
```

> I don't see a simple fix here... 

why no simply forbid comparison involving floating-point numbers, if it can result in mathematically wrong results? Then the user would have to do:

```
sage: RealField(2)(7).exact_rational() == 10
False
```




---

archive/issue_comments_335640.json:
```json
{
    "body": "Replying to [comment:9 zimmerma]:\n> > I don't see a simple fix here... \n> \n> why no simply forbid comparison involving floating-point numbers\n\nI don't think that's realistic. I'm pretty sure that a lot of stuff in Sage would break if we did that.",
    "created_at": "2017-11-16T18:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335640",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 zimmerma]:
> > I don't see a simple fix here... 
> 
> why no simply forbid comparison involving floating-point numbers

I don't think that's realistic. I'm pretty sure that a lot of stuff in Sage would break if we did that.



---

archive/issue_comments_335641.json:
```json
{
    "body": "I don't quite see it as a mathematically wrong result as it is correct up to the estimate bounds. If we did that, then I feel this would have to return `False` by the same argument:\n\n```\nsage: bool(pi.n() == pi)\nTrue\n```\n\nsince `pi.n()` is an inexact floating point number. Also, we have this doctest in `exact_rational`:\n\n```\nsage: RR(3^60).exact_rational() - 3^60\n6125652559\n```\n",
    "created_at": "2017-11-16T21:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335641",
    "user": "https://github.com/tscrim"
}
```

I don't quite see it as a mathematically wrong result as it is correct up to the estimate bounds. If we did that, then I feel this would have to return `False` by the same argument:

```
sage: bool(pi.n() == pi)
True
```

since `pi.n()` is an inexact floating point number. Also, we have this doctest in `exact_rational`:

```
sage: RR(3^60).exact_rational() - 3^60
6125652559
```




---

archive/issue_comments_335642.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> I don't quite see it as a mathematically wrong result as it is correct up to the estimate bounds. If we did that, then I feel this would have to return `False` by the same argument:\n> {{{\n> sage: bool(pi.n() == pi)\n> True\n> }}}\n> since `pi.n()` is an inexact floating point number.\n\nit would indeed be correct to return False, since `pi.n()` is a well-defined rational number, namely `884279719003555/2^48`, and it is well known that `pi` is not rational, thus we cannot get equality.\n\nAnyway, since I'm alone to consider this as a bug, I will simply use `exact_rational` whenever I want correct comparisons with floating-point numbers.",
    "created_at": "2017-11-16T22:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335642",
    "user": "https://github.com/zimmermann6"
}
```

Replying to [comment:11 tscrim]:
> I don't quite see it as a mathematically wrong result as it is correct up to the estimate bounds. If we did that, then I feel this would have to return `False` by the same argument:
> {{{
> sage: bool(pi.n() == pi)
> True
> }}}
> since `pi.n()` is an inexact floating point number.

it would indeed be correct to return False, since `pi.n()` is a well-defined rational number, namely `884279719003555/2^48`, and it is well known that `pi` is not rational, thus we cannot get equality.

Anyway, since I'm alone to consider this as a bug, I will simply use `exact_rational` whenever I want correct comparisons with floating-point numbers.



---

archive/issue_comments_335643.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-03-08T10:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23982#issuecomment-335643",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: wontfix



---

archive/issue_events_022432.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-08T10:04:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23982",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23982#event-22432"
}
```
