# Issue 34290: Make `Composition`s into a `collections.abc.Sequence`

archive/issues_034290.json:
```json
{
    "body": "CC:  @tscrim @trevorkarn\n\nKeywords: gsoc2022 compositions sequence\n\nCurrently Sage does not understand `Composition`s as a `collections.abc.Sequence`:\n\n\n```\nsage: c = Composition([3,4,2,4])\nsage: from collections.abc import Sequence\nsage: isinstance(c, Sequence)\nFalse\n```\n\n\nThis ticket implements the methods required to fix that, namely `Composition.__reversed__` and `Composition.count`\n\nIssue created by migration from https://trac.sagemath.org/ticket/34527\n\n",
    "created_at": "2022-09-13T18:02:12Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Make `Composition`s into a `collections.abc.Sequence`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34290",
    "user": "https://github.com/trevorkarn"
}
```
CC:  @tscrim @trevorkarn

Keywords: gsoc2022 compositions sequence

Currently Sage does not understand `Composition`s as a `collections.abc.Sequence`:


```
sage: c = Composition([3,4,2,4])
sage: from collections.abc import Sequence
sage: isinstance(c, Sequence)
False
```


This ticket implements the methods required to fix that, namely `Composition.__reversed__` and `Composition.count`

Issue created by migration from https://trac.sagemath.org/ticket/34527





---

archive/issue_comments_485696.json:
```json
{
    "body": "The methods required according to the collections documentation (https://docs.python.org/3/library/collections.abc.html#collections-abstract-base-classes) are present except for `__reversed__` and `count`.\n\n\n```\nsage: c.__getitem__\n<bound method CombinatorialObject.__getitem__ of [3, 4, 2, 4]>\nsage: c.__len__\n<bound method CombinatorialObject.__len__ of [3, 4, 2, 4]>\nsage: c.__contains__\n<bound method CombinatorialObject.__contains__ of [3, 4, 2, 4]>\nsage: c.__iter__\n<bound method CombinatorialObject.__iter__ of [3, 4, 2, 4]>\nsage: c.__reversed__\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\nInput In [30], in <cell line: 1>()\n----> 1 c.__reversed__\n\nFile ~/Applications/sage/src/sage/structure/element.pyx:494, in sage.structure.element.Element.__getattr__()\n    492         AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    493     \"\"\"\n--> 494     return self.getattr_from_category(name)\n    495 \n    496 cdef getattr_from_category(self, name):\n\nFile ~/Applications/sage/src/sage/structure/element.pyx:507, in sage.structure.element.Element.getattr_from_category()\n    505     else:\n    506         cls = P._abstract_element_class\n--> 507     return getattr_from_other_class(self, cls, name)\n    508 \n    509 def __dir__(self):\n\nFile ~/Applications/sage/src/sage/cpython/getattr.pyx:356, in sage.cpython.getattr.getattr_from_other_class()\n    354     dummy_error_message.cls = type(self)\n    355     dummy_error_message.name = name\n--> 356     raise AttributeError(dummy_error_message)\n    357 cdef PyObject* attr = instance_getattr(cls, name)\n    358 if attr is NULL:\n\nAttributeError: 'Compositions_all_with_category.element_class' object has no attribute '__reversed__'\nsage: index(c)\n---------------------------------------------------------------------------\nNameError                                 Traceback (most recent call last)\nInput In [31], in <cell line: 1>()\n----> 1 index(c)\n\nNameError: name 'index' is not defined\nsage: c.index\n<bound method CombinatorialObject.index of [3, 4, 2, 4]>\nsage: c.count\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\nInput In [33], in <cell line: 1>()\n----> 1 c.count\n\nFile ~/Applications/sage/src/sage/structure/element.pyx:494, in sage.structure.element.Element.__getattr__()\n    492         AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    493     \"\"\"\n--> 494     return self.getattr_from_category(name)\n    495 \n    496 cdef getattr_from_category(self, name):\n\nFile ~/Applications/sage/src/sage/structure/element.pyx:507, in sage.structure.element.Element.getattr_from_category()\n    505     else:\n    506         cls = P._abstract_element_class\n--> 507     return getattr_from_other_class(self, cls, name)\n    508 \n    509 def __dir__(self):\n\nFile ~/Applications/sage/src/sage/cpython/getattr.pyx:356, in sage.cpython.getattr.getattr_from_other_class()\n    354     dummy_error_message.cls = type(self)\n    355     dummy_error_message.name = name\n--> 356     raise AttributeError(dummy_error_message)\n    357 cdef PyObject* attr = instance_getattr(cls, name)\n    358 if attr is NULL:\n\nAttributeError: 'Compositions_all_with_category.element_class' object has no attribute 'count'\n```\n",
    "created_at": "2022-09-13T18:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485696",
    "user": "https://github.com/trevorkarn"
}
```

The methods required according to the collections documentation (https://docs.python.org/3/library/collections.abc.html#collections-abstract-base-classes) are present except for `__reversed__` and `count`.


```
sage: c.__getitem__
<bound method CombinatorialObject.__getitem__ of [3, 4, 2, 4]>
sage: c.__len__
<bound method CombinatorialObject.__len__ of [3, 4, 2, 4]>
sage: c.__contains__
<bound method CombinatorialObject.__contains__ of [3, 4, 2, 4]>
sage: c.__iter__
<bound method CombinatorialObject.__iter__ of [3, 4, 2, 4]>
sage: c.__reversed__
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
Input In [30], in <cell line: 1>()
----> 1 c.__reversed__

File ~/Applications/sage/src/sage/structure/element.pyx:494, in sage.structure.element.Element.__getattr__()
    492         AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    493     """
--> 494     return self.getattr_from_category(name)
    495 
    496 cdef getattr_from_category(self, name):

File ~/Applications/sage/src/sage/structure/element.pyx:507, in sage.structure.element.Element.getattr_from_category()
    505     else:
    506         cls = P._abstract_element_class
--> 507     return getattr_from_other_class(self, cls, name)
    508 
    509 def __dir__(self):

File ~/Applications/sage/src/sage/cpython/getattr.pyx:356, in sage.cpython.getattr.getattr_from_other_class()
    354     dummy_error_message.cls = type(self)
    355     dummy_error_message.name = name
--> 356     raise AttributeError(dummy_error_message)
    357 cdef PyObject* attr = instance_getattr(cls, name)
    358 if attr is NULL:

AttributeError: 'Compositions_all_with_category.element_class' object has no attribute '__reversed__'
sage: index(c)
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Input In [31], in <cell line: 1>()
----> 1 index(c)

NameError: name 'index' is not defined
sage: c.index
<bound method CombinatorialObject.index of [3, 4, 2, 4]>
sage: c.count
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
Input In [33], in <cell line: 1>()
----> 1 c.count

File ~/Applications/sage/src/sage/structure/element.pyx:494, in sage.structure.element.Element.__getattr__()
    492         AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    493     """
--> 494     return self.getattr_from_category(name)
    495 
    496 cdef getattr_from_category(self, name):

File ~/Applications/sage/src/sage/structure/element.pyx:507, in sage.structure.element.Element.getattr_from_category()
    505     else:
    506         cls = P._abstract_element_class
--> 507     return getattr_from_other_class(self, cls, name)
    508 
    509 def __dir__(self):

File ~/Applications/sage/src/sage/cpython/getattr.pyx:356, in sage.cpython.getattr.getattr_from_other_class()
    354     dummy_error_message.cls = type(self)
    355     dummy_error_message.name = name
--> 356     raise AttributeError(dummy_error_message)
    357 cdef PyObject* attr = instance_getattr(cls, name)
    358 if attr is NULL:

AttributeError: 'Compositions_all_with_category.element_class' object has no attribute 'count'
```




---

archive/issue_comments_485697.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-09-13T18:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485697",
    "user": "https://github.com/trevorkarn"
}
```

New commits:



---

archive/issue_comments_485698.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-13T18:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485698",
    "user": "https://github.com/trevorkarn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_485699.json:
```json
{
    "body": "Maybe some doctests to illustrate the supported operations would be good, to help other Sage users understand the Sequence protocol?",
    "created_at": "2022-09-13T19:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485699",
    "user": "https://github.com/mkoeppe"
}
```

Maybe some doctests to illustrate the supported operations would be good, to help other Sage users understand the Sequence protocol?



---

archive/issue_comments_485700.json:
```json
{
    "body": "Also in the doctest I would suggest to use the fully qualified name `collections.abc.Sequence` for clarity because there's also the unrelated global binding `Sequence` in Sage.",
    "created_at": "2022-09-13T19:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485700",
    "user": "https://github.com/mkoeppe"
}
```

Also in the doctest I would suggest to use the fully qualified name `collections.abc.Sequence` for clarity because there's also the unrelated global binding `Sequence` in Sage.



---

archive/issue_comments_485701.json:
```json
{
    "body": "+1 to Matthias\u2019s comments; in particular the `count` method is a bit unnatural for compositions.\n\nIt might make more sense to simply inherit from `Sequence` instead of registering it and providing a `__reversed__` method (which should return a `Composition`). The default `count` should be okay.",
    "created_at": "2022-09-13T23:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485701",
    "user": "https://github.com/tscrim"
}
```

+1 to Matthias’s comments; in particular the `count` method is a bit unnatural for compositions.

It might make more sense to simply inherit from `Sequence` instead of registering it and providing a `__reversed__` method (which should return a `Composition`). The default `count` should be okay.



---

archive/issue_comments_485702.json:
```json
{
    "body": "It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`. As Matthias suggested, I updated the doctest. I'm not sure there is a need to actually implement the `__reversed__` or `count` methods as I had suggested earlier.",
    "created_at": "2022-09-15T03:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485702",
    "user": "https://github.com/trevorkarn"
}
```

It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`. As Matthias suggested, I updated the doctest. I'm not sure there is a need to actually implement the `__reversed__` or `count` methods as I had suggested earlier.



---

archive/issue_comments_485703.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-15T03:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485703",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485704.json:
```json
{
    "body": "Replying to [comment:7 Trevor Karn]:\n> It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.\n\nYes, this is equivalent to inheriting from `Sequence`.",
    "created_at": "2022-09-15T04:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485704",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 Trevor Karn]:
> It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.

Yes, this is equivalent to inheriting from `Sequence`.



---

archive/issue_comments_485705.json:
```json
{
    "body": "comment:4?",
    "created_at": "2022-09-15T04:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485705",
    "user": "https://github.com/mkoeppe"
}
```

comment:4?



---

archive/issue_comments_485706.json:
```json
{
    "body": "Replying to [comment:10 Matthias K\u00f6ppe]:\n> comment:4?\n\nSorry, I think I misunderstood. Since we are registering it as a `Sequence` rather than implementing the \"required\" methods, the general `Sequence` protocol is not really followed. Maybe this is something that should go in the developer's guide rather than a doctest here?",
    "created_at": "2022-09-15T04:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485706",
    "user": "https://github.com/trevorkarn"
}
```

Replying to [comment:10 Matthias Köppe]:
> comment:4?

Sorry, I think I misunderstood. Since we are registering it as a `Sequence` rather than implementing the "required" methods, the general `Sequence` protocol is not really followed. Maybe this is something that should go in the developer's guide rather than a doctest here?



---

archive/issue_comments_485707.json:
```json
{
    "body": "Replying to [comment:7 Trevor Karn]:\n> It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.\n\nDoes it also pass the `issubclass` test too?\n\n> As Matthias suggested, I updated the doctest. I'm not sure there is a need to actually implement the `__reversed__` or `count` methods as I had suggested earlier.\n\nWhat is the type of the result from applying `reversed` to the composition? Some tests would help here, a la comment:4.",
    "created_at": "2022-09-15T04:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485707",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:7 Trevor Karn]:
> It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.

Does it also pass the `issubclass` test too?

> As Matthias suggested, I updated the doctest. I'm not sure there is a need to actually implement the `__reversed__` or `count` methods as I had suggested earlier.

What is the type of the result from applying `reversed` to the composition? Some tests would help here, a la comment:4.



---

archive/issue_comments_485708.json:
```json
{
    "body": "Replying to [comment:9 Matthias K\u00f6ppe]:\n> Replying to [comment:7 Trevor Karn]:\n> > It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.\n> \n> Yes, this is equivalent to inheriting from `Sequence`.\n\nI realize that I have to clarify this: It is equivalent as far as `isinstance` and `issubclass` are concerned, but you will get the mix-in methods listed in https://docs.python.org/3/library/collections.abc.html#collections-abstract-base-classes (`__reversed__`, `count`, etc.) only if you inherit from `Sequence` in the class definition.",
    "created_at": "2022-09-15T04:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485708",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:9 Matthias Köppe]:
> Replying to [comment:7 Trevor Karn]:
> > It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.
> 
> Yes, this is equivalent to inheriting from `Sequence`.

I realize that I have to clarify this: It is equivalent as far as `isinstance` and `issubclass` are concerned, but you will get the mix-in methods listed in https://docs.python.org/3/library/collections.abc.html#collections-abstract-base-classes (`__reversed__`, `count`, etc.) only if you inherit from `Sequence` in the class definition.



---

archive/issue_comments_485709.json:
```json
{
    "body": "Replying to [comment:12 Travis Scrimshaw]:\n> Replying to [comment:7 Trevor Karn]:\n> > It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.\n> \n> Does it also pass the `issubclass` test too?\n\nYes, of course, that should be added as a test maybe:\n\n```\nsage: import collections.abc\nsage: C = Composition([3,2,3])\nsage: issubclass(C.__class__, collections.abc.Sequence)\nTrue\nsage: isinstance(C, collections.abc.Sequence)\nTrue\n```\n",
    "created_at": "2022-09-15T04:37:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485709",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 Travis Scrimshaw]:
> Replying to [comment:7 Trevor Karn]:
> > It looks like things are sufficiently fixed just by calling `Sequence.register(Composition)`.
> 
> Does it also pass the `issubclass` test too?

Yes, of course, that should be added as a test maybe:

```
sage: import collections.abc
sage: C = Composition([3,2,3])
sage: issubclass(C.__class__, collections.abc.Sequence)
True
sage: isinstance(C, collections.abc.Sequence)
True
```




---

archive/issue_comments_485710.json:
```json
{
    "body": "Replying to [comment:12 Travis Scrimshaw]:\n> What is the type of the result from applying `reversed` to the composition? \n\n```\nsage: reversed(C)\n<reversed object at 0x7fe2e86c4e50>\n```\n",
    "created_at": "2022-09-15T04:38:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485710",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 Travis Scrimshaw]:
> What is the type of the result from applying `reversed` to the composition? 

```
sage: reversed(C)
<reversed object at 0x7fe2e86c4e50>
```




---

archive/issue_comments_485711.json:
```json
{
    "body": "Replying to [comment:11 Trevor Karn]:\n> Replying to [comment:10 Matthias K\u00f6ppe]:\n> > comment:4?\n> \n> Sorry, I think I misunderstood. Since we are registering it as a `Sequence` rather than implementing the \"required\" methods, the general `Sequence` protocol is not really followed.\n\nIt is followed. The \"mixin\" methods are not part of the protocol.",
    "created_at": "2022-09-15T04:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485711",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:11 Trevor Karn]:
> Replying to [comment:10 Matthias Köppe]:
> > comment:4?
> 
> Sorry, I think I misunderstood. Since we are registering it as a `Sequence` rather than implementing the "required" methods, the general `Sequence` protocol is not really followed.

It is followed. The "mixin" methods are not part of the protocol.



---

archive/issue_comments_485712.json:
```json
{
    "body": "Replying to [comment:16 Matthias K\u00f6ppe]:\n> Replying to [comment:11 Trevor Karn]:\n> > Replying to [comment:10 Matthias K\u00f6ppe]:\n> > > comment:4?\n> > \n> > Sorry, I think I misunderstood. Since we are registering it as a `Sequence` rather than implementing the \"required\" methods, the general `Sequence` protocol is not really followed.\n> \n> It is followed. The \"mixin\" methods are not part of the protocol.\n\nNo, sorry, my mistake. It's getting late here.\n\nYou are right, it is not allowed to register it without implementing these mixin methods.\nBut you'll get them for free by changing it to subclassing instead of registering.",
    "created_at": "2022-09-15T04:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485712",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:16 Matthias Köppe]:
> Replying to [comment:11 Trevor Karn]:
> > Replying to [comment:10 Matthias Köppe]:
> > > comment:4?
> > 
> > Sorry, I think I misunderstood. Since we are registering it as a `Sequence` rather than implementing the "required" methods, the general `Sequence` protocol is not really followed.
> 
> It is followed. The "mixin" methods are not part of the protocol.

No, sorry, my mistake. It's getting late here.

You are right, it is not allowed to register it without implementing these mixin methods.
But you'll get them for free by changing it to subclassing instead of registering.



---

archive/issue_comments_485713.json:
```json
{
    "body": "Replying to [comment:15 Matthias K\u00f6ppe]:\n> Replying to [comment:12 Travis Scrimshaw]:\n> > What is the type of the result from applying `reversed` to the composition? \n> {{{\n> sage: reversed(C)\n> <reversed object at 0x7fe2e86c4e50>\n> }}}\n\nAh, right, duh. It is an iterator and does not return the reversed object.",
    "created_at": "2022-09-15T04:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485713",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:15 Matthias Köppe]:
> Replying to [comment:12 Travis Scrimshaw]:
> > What is the type of the result from applying `reversed` to the composition? 
> {{{
> sage: reversed(C)
> <reversed object at 0x7fe2e86c4e50>
> }}}

Ah, right, duh. It is an iterator and does not return the reversed object.



---

archive/issue_comments_485714.json:
```json
{
    "body": "After subclassing:\n\n```\n  File \"/Users/trevorkarn/Applications/sage/src/sage/combinat/composition.py\", line 50, in <module>\n    class Composition(CombinatorialElement, Sequence):\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases\n```\n\n\nShould this be fixed at the `CombinatorialElement` level? Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?",
    "created_at": "2022-09-15T05:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485714",
    "user": "https://github.com/trevorkarn"
}
```

After subclassing:

```
  File "/Users/trevorkarn/Applications/sage/src/sage/combinat/composition.py", line 50, in <module>
    class Composition(CombinatorialElement, Sequence):
TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
```


Should this be fixed at the `CombinatorialElement` level? Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?



---

archive/issue_comments_485715.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-15T05:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485715",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485716.json:
```json
{
    "body": "Replying to [comment:19 Trevor Karn]:\n> After subclassing:\n> {{{\n>   File \"/Users/trevorkarn/Applications/sage/src/sage/combinat/composition.py\", line 50, in <module>\n>     class Composition(CombinatorialElement, Sequence):\n> TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases\n> }}}\n\nOuch. Python used a metaclass for their (collections) ABCs `abc.ABCMeta`. Well, I guess that settles it; we have to register it.\n\n> Should this be fixed at the `CombinatorialElement` level?\n\nNo, that is going to go away at some point.\n\n> Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?\n\nThis won't solve the problem:\n\n```\nsage: from sage.structure.list_clone import ClonableArray\nsage: ClonableArray.__class__\n<class 'sage.misc.inherit_comparison.InheritComparisonMetaclass'>\n```\n",
    "created_at": "2022-09-15T07:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485716",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:19 Trevor Karn]:
> After subclassing:
> {{{
>   File "/Users/trevorkarn/Applications/sage/src/sage/combinat/composition.py", line 50, in <module>
>     class Composition(CombinatorialElement, Sequence):
> TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
> }}}

Ouch. Python used a metaclass for their (collections) ABCs `abc.ABCMeta`. Well, I guess that settles it; we have to register it.

> Should this be fixed at the `CombinatorialElement` level?

No, that is going to go away at some point.

> Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?

This won't solve the problem:

```
sage: from sage.structure.list_clone import ClonableArray
sage: ClonableArray.__class__
<class 'sage.misc.inherit_comparison.InheritComparisonMetaclass'>
```




---

archive/issue_comments_485717.json:
```json
{
    "body": "Replying to [comment:21 Travis Scrimshaw]:\n> Replying to [comment:19 Trevor Karn]:\n> > After subclassing:\n> > {{{\n> >   File \"/Users/trevorkarn/Applications/sage/src/sage/combinat/composition.py\", line 50, in <module>\n> >     class Composition(CombinatorialElement, Sequence):\n> > TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases\n> > }}}\n> \n> Ouch. Python used a metaclass for their (collections) ABCs `abc.ABCMeta`. Well, I guess that settles it; we have to register it.\n\nGot it - then I think this is ready for review. I tried to inclued the doctests which were relevant to this conversation, but please let me know if I need more.\n\n> > Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?\n> \n> This won't solve the problem:\n> {{{\n> sage: from sage.structure.list_clone import ClonableArray\n> sage: ClonableArray.__class__\n> <class 'sage.misc.inherit_comparison.InheritComparisonMetaclass'>\n> }}}\nHuh. Should `ClonableArray` be a `Sequence`?",
    "created_at": "2022-09-15T17:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485717",
    "user": "https://github.com/trevorkarn"
}
```

Replying to [comment:21 Travis Scrimshaw]:
> Replying to [comment:19 Trevor Karn]:
> > After subclassing:
> > {{{
> >   File "/Users/trevorkarn/Applications/sage/src/sage/combinat/composition.py", line 50, in <module>
> >     class Composition(CombinatorialElement, Sequence):
> > TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
> > }}}
> 
> Ouch. Python used a metaclass for their (collections) ABCs `abc.ABCMeta`. Well, I guess that settles it; we have to register it.

Got it - then I think this is ready for review. I tried to inclued the doctests which were relevant to this conversation, but please let me know if I need more.

> > Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?
> 
> This won't solve the problem:
> {{{
> sage: from sage.structure.list_clone import ClonableArray
> sage: ClonableArray.__class__
> <class 'sage.misc.inherit_comparison.InheritComparisonMetaclass'>
> }}}
Huh. Should `ClonableArray` be a `Sequence`?



---

archive/issue_comments_485718.json:
```json
{
    "body": "Replying to [comment:22 Trevor Karn]:\n> Replying to [comment:21 Travis Scrimshaw]:\n> > Replying to [comment:19 Trevor Karn]:\n> > > Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?\n> > \n> > This won't solve the problem:\n> > {{{\n> > sage: from sage.structure.list_clone import ClonableArray\n> > sage: ClonableArray.__class__\n> > <class 'sage.misc.inherit_comparison.InheritComparisonMetaclass'>\n> > }}}\n> Huh. Should `ClonableArray` be a `Sequence`?\n\nThis is saying it also has a metaclass.",
    "created_at": "2022-09-16T00:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485718",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:22 Trevor Karn]:
> Replying to [comment:21 Travis Scrimshaw]:
> > Replying to [comment:19 Trevor Karn]:
> > > Or would it be better to just make `Composition` a subclass of `ClonableArray` to update it?
> > 
> > This won't solve the problem:
> > {{{
> > sage: from sage.structure.list_clone import ClonableArray
> > sage: ClonableArray.__class__
> > <class 'sage.misc.inherit_comparison.InheritComparisonMetaclass'>
> > }}}
> Huh. Should `ClonableArray` be a `Sequence`?

This is saying it also has a metaclass.



---

archive/issue_comments_485719.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-16T18:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485719",
    "user": "https://github.com/trevorkarn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_485720.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-17T14:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485720",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485721.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-17T14:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485721",
    "user": "https://github.com/trevorkarn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_485722.json:
```json
{
    "body": "Documentation is updated.",
    "created_at": "2022-09-17T14:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485722",
    "user": "https://github.com/trevorkarn"
}
```

Documentation is updated.



---

archive/issue_comments_485723.json:
```json
{
    "body": "Thanks. I am happy with this (modulo the one change below). Matthias?\n\nSphinx treats the backtick as normal text when between alpha(numeric?) characters:\n\n```diff\n     Typically, instances of ``collections.abc.Sequence`` have a ``.count`` method.\n-    This is *not* the case for ``Composition``s::\n+    This is *not* the case for a ``Composition``::\n```\n",
    "created_at": "2022-09-18T00:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485723",
    "user": "https://github.com/tscrim"
}
```

Thanks. I am happy with this (modulo the one change below). Matthias?

Sphinx treats the backtick as normal text when between alpha(numeric?) characters:

```diff
     Typically, instances of ``collections.abc.Sequence`` have a ``.count`` method.
-    This is *not* the case for ``Composition``s::
+    This is *not* the case for a ``Composition``::
```




---

archive/issue_comments_485724.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-18T01:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485724",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485725.json:
```json
{
    "body": "I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it",
    "created_at": "2022-09-18T05:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485725",
    "user": "https://github.com/mkoeppe"
}
```

I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it



---

archive/issue_comments_485726.json:
```json
{
    "body": "Replying to [comment:29 Matthias K\u00f6ppe]:\n> I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it\n\nI understand [this python discussion post](https://discuss.python.org/t/mapping-abc-and-friends-are-the-mixin-methods-required-to-satisfy-the-interface/9499/2) to mean that mix-in methods are *not* required.\n\nOn the other hand it is easy enough to implement `.count()` where `.count(n)` returns the number of parts of size `n`. So I'll do that later today.",
    "created_at": "2022-09-19T19:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485726",
    "user": "https://github.com/trevorkarn"
}
```

Replying to [comment:29 Matthias Köppe]:
> I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it

I understand [this python discussion post](https://discuss.python.org/t/mapping-abc-and-friends-are-the-mixin-methods-required-to-satisfy-the-interface/9499/2) to mean that mix-in methods are *not* required.

On the other hand it is easy enough to implement `.count()` where `.count(n)` returns the number of parts of size `n`. So I'll do that later today.



---

archive/issue_comments_485727.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-19T22:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485727",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485728.json:
```json
{
    "body": "Replying to [comment:29 Matthias K\u00f6ppe]:\n> I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it\n\nOk. I think `Sequence` things should be good to go.",
    "created_at": "2022-09-19T22:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485728",
    "user": "https://github.com/trevorkarn"
}
```

Replying to [comment:29 Matthias Köppe]:
> I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it

Ok. I think `Sequence` things should be good to go.



---

archive/issue_comments_485729.json:
```json
{
    "body": "Replying to [comment:29 Matthias K\u00f6ppe]:\n> I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it\n\nThis is in point (2) of the main Python ABC doc in comment:1.",
    "created_at": "2022-09-20T05:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485729",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:29 Matthias Köppe]:
> I think in comment:17, I concluded that all mix-in methods must be provided. Too tired this evening to re-read the Python reference to confirm it

This is in point (2) of the main Python ABC doc in comment:1.



---

archive/issue_comments_485730.json:
```json
{
    "body": "That takes care of all of the mixin methods. So I am good with this. Anything objections to a positive review Matthias?",
    "created_at": "2022-09-20T05:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485730",
    "user": "https://github.com/tscrim"
}
```

That takes care of all of the mixin methods. So I am good with this. Anything objections to a positive review Matthias?



---

archive/issue_comments_485731.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-22T03:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485731",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_485732.json:
```json
{
    "body": "LGTM, thanks.",
    "created_at": "2022-09-22T03:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485732",
    "user": "https://github.com/mkoeppe"
}
```

LGTM, thanks.



---

archive/issue_events_030807.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2022-09-25T16:34:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34290#event-30807"
}
```



---

archive/issue_comments_485733.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-25T16:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34290#issuecomment-485733",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
