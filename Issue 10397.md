# Issue 10397: Problem computing Hecke matrices on subspaces of modular forms spaces

archive/issues_010397.json:
```json
{
    "body": "Assignee: @craigcitro\n\nKeywords: hecke operator\n\nSage seems to have trouble computing Hecke matrices on subspaces of Gamma1 modular forms spaces, which is absurd, since it has no trouble computing Hecke matrices on the parent spaces:\n\n\n```\nsage: S = CuspForms(Gamma1(22))\nsage: S.new_submodule().hecke_matrix(5)\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n\n/home/masiao/<ipython console> in <module>()\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in hecke_matrix(self, n)\n   1288             raise IndexError, \"n must be positive.\"\n   1289         if not self._hecke_matrices.has_key(n):\n-> 1290             T = self._compute_hecke_matrix(n)\n   1291             T.set_immutable()\n   1292             self._hecke_matrices[n] = T\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix(self, n)\n   1311         \"\"\"\n   1312         if hasattr(self, '_compute_q_expansion_basis'):\n-> 1313             return hecke.HeckeModule_generic._compute_hecke_matrix(self, n)\n   1314         else:\n   1315             return hecke.HeckeSubmodule._compute_hecke_matrix(self, n)\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in _compute_hecke_matrix(self, n, **kwds)\n    214         \n    215         if arith.is_prime(n):\n--> 216             return self._compute_hecke_matrix_prime(n, **kwds)\n    217 \n    218         F = arith.factor(n)\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix_prime(self, p, prec)\n   1281         eps = self.character()\n   1282         if eps is None:\n-> 1283             raise NotImplementedError\n   1284         try:\n   1285             return hecke_operator_on_qexp.hecke_operator_on_basis(B, p,\n\nNotImplementedError: \nsage: S.old_submodule().hecke_matrix(5)\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n\n/home/masiao/<ipython console> in <module>()\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in hecke_matrix(self, n)\n   1288             raise IndexError, \"n must be positive.\"\n   1289         if not self._hecke_matrices.has_key(n):\n-> 1290             T = self._compute_hecke_matrix(n)\n   1291             T.set_immutable()\n   1292             self._hecke_matrices[n] = T\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix(self, n)\n   1311         \"\"\"\n   1312         if hasattr(self, '_compute_q_expansion_basis'):\n-> 1313             return hecke.HeckeModule_generic._compute_hecke_matrix(self, n)\n   1314         else:\n   1315             return hecke.HeckeSubmodule._compute_hecke_matrix(self, n)\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in _compute_hecke_matrix(self, n, **kwds)\n    214         \n    215         if arith.is_prime(n):\n--> 216             return self._compute_hecke_matrix_prime(n, **kwds)\n    217 \n    218         F = arith.factor(n)\n\n/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix_prime(self, p, prec)\n   1281         eps = self.character()\n   1282         if eps is None:\n-> 1283             raise NotImplementedError\n   1284         try:\n   1285             return hecke_operator_on_qexp.hecke_operator_on_basis(B, p,\n\nNotImplementedError:\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10450\n\n",
    "created_at": "2010-12-09T16:47:52Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "Problem computing Hecke matrices on subspaces of modular forms spaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10397",
    "user": "https://github.com/loefflerd"
}
```
Assignee: @craigcitro

Keywords: hecke operator

Sage seems to have trouble computing Hecke matrices on subspaces of Gamma1 modular forms spaces, which is absurd, since it has no trouble computing Hecke matrices on the parent spaces:


```
sage: S = CuspForms(Gamma1(22))
sage: S.new_submodule().hecke_matrix(5)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)

/home/masiao/<ipython console> in <module>()

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in hecke_matrix(self, n)
   1288             raise IndexError, "n must be positive."
   1289         if not self._hecke_matrices.has_key(n):
-> 1290             T = self._compute_hecke_matrix(n)
   1291             T.set_immutable()
   1292             self._hecke_matrices[n] = T

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix(self, n)
   1311         """
   1312         if hasattr(self, '_compute_q_expansion_basis'):
-> 1313             return hecke.HeckeModule_generic._compute_hecke_matrix(self, n)
   1314         else:
   1315             return hecke.HeckeSubmodule._compute_hecke_matrix(self, n)

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in _compute_hecke_matrix(self, n, **kwds)
    214         
    215         if arith.is_prime(n):
--> 216             return self._compute_hecke_matrix_prime(n, **kwds)
    217 
    218         F = arith.factor(n)

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix_prime(self, p, prec)
   1281         eps = self.character()
   1282         if eps is None:
-> 1283             raise NotImplementedError
   1284         try:
   1285             return hecke_operator_on_qexp.hecke_operator_on_basis(B, p,

NotImplementedError: 
sage: S.old_submodule().hecke_matrix(5)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)

/home/masiao/<ipython console> in <module>()

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in hecke_matrix(self, n)
   1288             raise IndexError, "n must be positive."
   1289         if not self._hecke_matrices.has_key(n):
-> 1290             T = self._compute_hecke_matrix(n)
   1291             T.set_immutable()
   1292             self._hecke_matrices[n] = T

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix(self, n)
   1311         """
   1312         if hasattr(self, '_compute_q_expansion_basis'):
-> 1313             return hecke.HeckeModule_generic._compute_hecke_matrix(self, n)
   1314         else:
   1315             return hecke.HeckeSubmodule._compute_hecke_matrix(self, n)

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/hecke/module.pyc in _compute_hecke_matrix(self, n, **kwds)
    214         
    215         if arith.is_prime(n):
--> 216             return self._compute_hecke_matrix_prime(n, **kwds)
    217 
    218         F = arith.factor(n)

/usr/local/sage/sage-4.6/local/lib/python2.6/site-packages/sage/modular/modform/space.pyc in _compute_hecke_matrix_prime(self, p, prec)
   1281         eps = self.character()
   1282         if eps is None:
-> 1283             raise NotImplementedError
   1284         try:
   1285             return hecke_operator_on_qexp.hecke_operator_on_basis(B, p,

NotImplementedError:
```


Issue created by migration from https://trac.sagemath.org/ticket/10450





---

archive/issue_comments_106825.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-09T22:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106825",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_106826.json:
```json
{
    "body": "Here's a 1/1/1 fix: one line, one comment and one doctest.",
    "created_at": "2010-12-09T22:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106826",
    "user": "https://github.com/loefflerd"
}
```

Here's a 1/1/1 fix: one line, one comment and one doctest.



---

archive/issue_comments_106827.json:
```json
{
    "body": "patch against 4.6.1.alpha3",
    "created_at": "2010-12-09T22:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106827",
    "user": "https://github.com/loefflerd"
}
```

patch against 4.6.1.alpha3



---

archive/issue_comments_106828.json:
```json
{
    "body": "Attachment [trac_10450.patch](tarball://root/attachments/some-uuid/ticket10450/trac_10450.patch) by @aghitza created at 2011-01-25 08:50:45\n\nThis looks good with one exception: we (still) can't have the action of Tn with n not squarefree:\n\n\n```\nsage: CuspForms(Gamma1(22), 2).new_submodule().hecke_matrix(9)\n...\nNotImplementedError: either character or _compute_hecke_matrix_prime_power must be overloaded in a derived class\n```\n\n\nDo you want to try to fix this here as well, or put this into a new ticket?",
    "created_at": "2011-01-25T08:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106828",
    "user": "https://github.com/aghitza"
}
```

Attachment [trac_10450.patch](tarball://root/attachments/some-uuid/ticket10450/trac_10450.patch) by @aghitza created at 2011-01-25 08:50:45

This looks good with one exception: we (still) can't have the action of Tn with n not squarefree:


```
sage: CuspForms(Gamma1(22), 2).new_submodule().hecke_matrix(9)
...
NotImplementedError: either character or _compute_hecke_matrix_prime_power must be overloaded in a derived class
```


Do you want to try to fix this here as well, or put this into a new ticket?



---

archive/issue_comments_106829.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-01-25T08:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106829",
    "user": "https://github.com/aghitza"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_106830.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2011-01-25T11:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106830",
    "user": "https://github.com/loefflerd"
}
```

apply only this patch



---

archive/issue_comments_106831.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-01-25T11:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106831",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_106832.json:
```json
{
    "body": "Attachment [trac_10450_new.patch](tarball://root/attachments/some-uuid/ticket10450/trac_10450_new.patch) by @loefflerd created at 2011-01-25 11:26:14\n\nHere's a new patch which should correct the prime power case as well. The new version does all of the factoring tricks etc at the level of the ambient space (or, where possible, its eisenstein or cuspidal submodule), and just restricts the answer to the given subspace at the end. Along the way, I've fixed a tiny bug in `eisenstein_submodule` and `cuspidal_submodule`, and added `is_eisenstein` and `is_cuspidal`, for generic mod forms spaces.",
    "created_at": "2011-01-25T11:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106832",
    "user": "https://github.com/loefflerd"
}
```

Attachment [trac_10450_new.patch](tarball://root/attachments/some-uuid/ticket10450/trac_10450_new.patch) by @loefflerd created at 2011-01-25 11:26:14

Here's a new patch which should correct the prime power case as well. The new version does all of the factoring tricks etc at the level of the ambient space (or, where possible, its eisenstein or cuspidal submodule), and just restricts the answer to the given subspace at the end. Along the way, I've fixed a tiny bug in `eisenstein_submodule` and `cuspidal_submodule`, and added `is_eisenstein` and `is_cuspidal`, for generic mod forms spaces.



---

archive/issue_comments_106833.json:
```json
{
    "body": "Great stuff, and good catch on the two missing return statements.\n\nOf course, these would never have made it in if there were doctests to check those parts of the code.  May I suggest adding some now?  Here is an easy example:\n\n\n```\nsage: M = ModularForms(6, 10)\nsage: S = M.cuspidal_submodule()\nsage: W = S.span_of_basis(S.basis()[0:2])\nsage: W.cuspidal_submodule()\nModular Forms subspace of dimension 2 of Modular Forms space of dimension 11 for Congruence Subgroup Gamma0(6) of weight 10 over Rational Field\n```\n\n\nand something along the same lines for `eisenstein_submodule`.",
    "created_at": "2011-01-25T12:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106833",
    "user": "https://github.com/aghitza"
}
```

Great stuff, and good catch on the two missing return statements.

Of course, these would never have made it in if there were doctests to check those parts of the code.  May I suggest adding some now?  Here is an easy example:


```
sage: M = ModularForms(6, 10)
sage: S = M.cuspidal_submodule()
sage: W = S.span_of_basis(S.basis()[0:2])
sage: W.cuspidal_submodule()
Modular Forms subspace of dimension 2 of Modular Forms space of dimension 11 for Congruence Subgroup Gamma0(6) of weight 10 over Rational Field
```


and something along the same lines for `eisenstein_submodule`.



---

archive/issue_comments_106834.json:
```json
{
    "body": "Attachment [trac_10450-extra_doctests.patch](tarball://root/attachments/some-uuid/ticket10450/trac_10450-extra_doctests.patch) by @loefflerd created at 2011-01-25 13:15:53\n\nOK, here's an additional patch adding those two doctests.",
    "created_at": "2011-01-25T13:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106834",
    "user": "https://github.com/loefflerd"
}
```

Attachment [trac_10450-extra_doctests.patch](tarball://root/attachments/some-uuid/ticket10450/trac_10450-extra_doctests.patch) by @loefflerd created at 2011-01-25 13:15:53

OK, here's an additional patch adding those two doctests.



---

archive/issue_comments_106835.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-25T13:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106835",
    "user": "https://github.com/aghitza"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_106836.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2011-01-25T13:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106836",
    "user": "https://github.com/aghitza"
}
```

Looks good to me.



---

archive/issue_comments_106837.json:
```json
{
    "body": "Thanks!",
    "created_at": "2011-01-25T13:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106837",
    "user": "https://github.com/loefflerd"
}
```

Thanks!



---

archive/issue_comments_106838.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-27T13:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10397#issuecomment-106838",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
