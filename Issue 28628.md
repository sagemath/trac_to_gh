# Issue 28628: 2 doctests failed in smallgraphs.py

archive/issues_028628.json:
```json
{
    "body": "CC:  @embray\n\n\n```\nsage -t --long src/sage/graphs/generators/smallgraphs.py\n```\n\n\ngives\n\n\n```\nUsing --optional=4ti2,build,cbc,ccache,cryptominisat,dochtml,dot2tex,e_antic,glucose,latte_int,lidia,lrslib,memlimit,normaliz,notedown,openssl,pandoc_attributes,pycosat,pynormaliz,rst2ipynb,sage,sagenb\nDoctesting 1 file.\nsage -t --long src/sage/graphs/generators/smallgraphs.py\n**********************************************************************\nFile \"src/sage/graphs/generators/smallgraphs.py\", line 4759, in sage.graphs.generators.smallgraphs.JankoKharaghaniGraph\nFailed example:\n    g = graphs.JankoKharaghaniGraph(936)   # long time\nException raised:\n    MemoryError\n\n    During handling of the above exception, another exception occurred:\n\n    MemoryError\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.generators.smallgraphs.JankoKharaghaniGraph[0]>\", line 1, in <module>\n        g = graphs.JankoKharaghaniGraph(Integer(936))   # long time\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/graphs/generators/smallgraphs.py\", line 4835, in JankoKharaghaniGraph\n        return Graph([e for e,v in six.iteritems(D.dict()) if v == 1],\n      File \"sage/matrix/matrix0.pyx\", line 246, in sage.matrix.matrix0.Matrix.dict (build/cythonized/sage/matrix/matrix0.c:4555)\n        return dict(self._dict())\n      File \"sage/matrix/matrix0.pyx\", line 303, in sage.matrix.matrix0.Matrix._dict (build/cythonized/sage/matrix/matrix0.c:4745)\n        x = self.get_unsafe(i, j)\n    MemoryError\n**********************************************************************\nFile \"src/sage/graphs/generators/smallgraphs.py\", line 4760, in sage.graphs.generators.smallgraphs.JankoKharaghaniGraph\nFailed example:\n    g.is_strongly_regular(parameters=True) # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.generators.smallgraphs.JankoKharaghaniGraph[1]>\", line 1, in <module>\n        g.is_strongly_regular(parameters=True) # long time\n    NameError: name 'g' is not defined\n**********************************************************************\n1 item had failures:\n   2 of   3 in sage.graphs.generators.smallgraphs.JankoKharaghaniGraph\n    [565 tests, 2 failures, 18.04 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/graphs/generators/smallgraphs.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28865\n\n",
    "created_at": "2019-12-10T08:27:12Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "2 doctests failed in smallgraphs.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28628",
    "user": "https://github.com/seblabbe"
}
```
CC:  @embray


```
sage -t --long src/sage/graphs/generators/smallgraphs.py
```


gives


```
Using --optional=4ti2,build,cbc,ccache,cryptominisat,dochtml,dot2tex,e_antic,glucose,latte_int,lidia,lrslib,memlimit,normaliz,notedown,openssl,pandoc_attributes,pycosat,pynormaliz,rst2ipynb,sage,sagenb
Doctesting 1 file.
sage -t --long src/sage/graphs/generators/smallgraphs.py
**********************************************************************
File "src/sage/graphs/generators/smallgraphs.py", line 4759, in sage.graphs.generators.smallgraphs.JankoKharaghaniGraph
Failed example:
    g = graphs.JankoKharaghaniGraph(936)   # long time
Exception raised:
    MemoryError

    During handling of the above exception, another exception occurred:

    MemoryError

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.smallgraphs.JankoKharaghaniGraph[0]>", line 1, in <module>
        g = graphs.JankoKharaghaniGraph(Integer(936))   # long time
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/graphs/generators/smallgraphs.py", line 4835, in JankoKharaghaniGraph
        return Graph([e for e,v in six.iteritems(D.dict()) if v == 1],
      File "sage/matrix/matrix0.pyx", line 246, in sage.matrix.matrix0.Matrix.dict (build/cythonized/sage/matrix/matrix0.c:4555)
        return dict(self._dict())
      File "sage/matrix/matrix0.pyx", line 303, in sage.matrix.matrix0.Matrix._dict (build/cythonized/sage/matrix/matrix0.c:4745)
        x = self.get_unsafe(i, j)
    MemoryError
**********************************************************************
File "src/sage/graphs/generators/smallgraphs.py", line 4760, in sage.graphs.generators.smallgraphs.JankoKharaghaniGraph
Failed example:
    g.is_strongly_regular(parameters=True) # long time
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.smallgraphs.JankoKharaghaniGraph[1]>", line 1, in <module>
        g.is_strongly_regular(parameters=True) # long time
    NameError: name 'g' is not defined
**********************************************************************
1 item had failures:
   2 of   3 in sage.graphs.generators.smallgraphs.JankoKharaghaniGraph
    [565 tests, 2 failures, 18.04 s]
----------------------------------------------------------------------
sage -t --long src/sage/graphs/generators/smallgraphs.py  # 2 doctests failed
----------------------------------------------------------------------
```


Issue created by migration from https://trac.sagemath.org/ticket/28865





---

archive/issue_comments_403728.json:
```json
{
    "body": "It's not easy to change this doctest as this generator can generates only 2 graphs, and this one is the smallest.\n\n```\nsage: %time g = graphs.JankoKharaghaniGraph(936)\nCPU times: user 1.95 s, sys: 190 ms, total: 2.14 s\nWall time: 2.19 s\nsage: g.order(), g.size()\n(936, 175500)\nsage: %time g = graphs.JankoKharaghaniGraph(1800)\n^[[A^[[A\nCPU times: user 22.8 s, sys: 1.64 s, total: 24.5 s\nWall time: 24.6 s\nsage: g.order(), g.size()\n(1800, 926100)\n```\n\nThis doctest fails when there is not enough memory. I don't know how to change this doctest.",
    "created_at": "2019-12-10T09:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403728",
    "user": "https://github.com/dcoudert"
}
```

It's not easy to change this doctest as this generator can generates only 2 graphs, and this one is the smallest.

```
sage: %time g = graphs.JankoKharaghaniGraph(936)
CPU times: user 1.95 s, sys: 190 ms, total: 2.14 s
Wall time: 2.19 s
sage: g.order(), g.size()
(936, 175500)
sage: %time g = graphs.JankoKharaghaniGraph(1800)
^[[A^[[A
CPU times: user 22.8 s, sys: 1.64 s, total: 24.5 s
Wall time: 24.6 s
sage: g.order(), g.size()
(1800, 926100)
```

This doctest fails when there is not enough memory. I don't know how to change this doctest.



---

archive/issue_comments_403729.json:
```json
{
    "body": "At least, we need a way to avoid the call to `D.dict()`. Any expert in matrix module to help here ?",
    "created_at": "2019-12-11T18:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403729",
    "user": "https://github.com/dcoudert"
}
```

At least, we need a way to avoid the call to `D.dict()`. Any expert in matrix module to help here ?



---

archive/issue_comments_403730.json:
```json
{
    "body": "Does it help to tag those tests with `# optional -- memlimit`?\n\nBy the way: what is the platform? How much memory? Does it depend on one of the external packages? How can I reproduce this?",
    "created_at": "2019-12-11T21:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403730",
    "user": "https://github.com/jhpalmieri"
}
```

Does it help to tag those tests with `# optional -- memlimit`?

By the way: what is the platform? How much memory? Does it depend on one of the external packages? How can I reproduce this?



---

archive/issue_comments_403731.json:
```json
{
    "body": "It only depends on the available memory (I don't know the limit) and not on external packages. In #28525 we were able to use smaller graphs for the doctests, but here it's not possible (the method creates only 2 graphs and the doctest is for the smallest). Avoiding the creation of `D.dict()` may help, but I'm not sure.",
    "created_at": "2019-12-12T08:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403731",
    "user": "https://github.com/dcoudert"
}
```

It only depends on the available memory (I don't know the limit) and not on external packages. In #28525 we were able to use smaller graphs for the doctests, but here it's not possible (the method creates only 2 graphs and the doctest is for the smallest). Avoiding the creation of `D.dict()` may help, but I'm not sure.



---

archive/issue_comments_403732.json:
```json
{
    "body": "I can reproduce the issue on my laptop and my desktop (both running Ubuntu 16.06 with SageMath version 9.0.beta9, Release Date: 2019-12-08).",
    "created_at": "2019-12-17T21:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403732",
    "user": "https://github.com/seblabbe"
}
```

I can reproduce the issue on my laptop and my desktop (both running Ubuntu 16.06 with SageMath version 9.0.beta9, Release Date: 2019-12-08).



---

archive/issue_comments_403733.json:
```json
{
    "body": "On my laptop (Ubuntu 16.06), I can not reproduce:\n\n\n```\nsage -t --long src/sage/graphs/generators/smallgraphs.py\n```\n\ngives\n\n```\nUsing --optional=4ti2,build,cbc,ccache,cryptominisat,dochtml,dot2tex,e_antic,glucose,latte_int,lidia,lrslib,memlimit,normaliz,notedown,openssl,pandoc_attributes,pycosat,pynormaliz,python2,rst2ipynb,sage,sagenb\nDoctesting 1 file.\nsage -t --long --warn-long 69.3 src/sage/graphs/generators/smallgraphs.py\n    [565 tests, 30.13 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n\n\nOn my desktop with the same optional packages (also Ubuntu 16.06), I get the issue and I can reproduce it. Strange.",
    "created_at": "2019-12-17T21:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403733",
    "user": "https://github.com/seblabbe"
}
```

On my laptop (Ubuntu 16.06), I can not reproduce:


```
sage -t --long src/sage/graphs/generators/smallgraphs.py
```

gives

```
Using --optional=4ti2,build,cbc,ccache,cryptominisat,dochtml,dot2tex,e_antic,glucose,latte_int,lidia,lrslib,memlimit,normaliz,notedown,openssl,pandoc_attributes,pycosat,pynormaliz,python2,rst2ipynb,sage,sagenb
Doctesting 1 file.
sage -t --long --warn-long 69.3 src/sage/graphs/generators/smallgraphs.py
    [565 tests, 30.13 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


On my desktop with the same optional packages (also Ubuntu 16.06), I get the issue and I can reproduce it. Strange.



---

archive/issue_comments_403734.json:
```json
{
    "body": "How much RAM do those machines have? And on the machines where it fails, does it help if you tag the doctests with `# optional -- memlimit` or `# high mem`? (I'm not sure about the last one, but that's what it says in `sage-runtests`. I found no instances of doctests tagged with `# high mem` in the Sage libary.)",
    "created_at": "2019-12-17T23:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403734",
    "user": "https://github.com/jhpalmieri"
}
```

How much RAM do those machines have? And on the machines where it fails, does it help if you tag the doctests with `# optional -- memlimit` or `# high mem`? (I'm not sure about the last one, but that's what it says in `sage-runtests`. I found no instances of doctests tagged with `# high mem` in the Sage libary.)



---

archive/issue_comments_403735.json:
```json
{
    "body": "Note that since I can't find \"high mem\" in the Sage source code, I doubt this is the right syntax. (The doctesting framework has to search for something when matching the tag with the behavior, and `git grep \"high.*mem\" src` doesn't return any promising hits.) \n\n`@`embray, do you know the right syntax for marking a test with a memory cap? `# optional - memlimit` (as is used in `sage/doctest/test.py` and a few other places) or `# high mem` (as it says in sage-runtests) or something else?",
    "created_at": "2019-12-17T23:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403735",
    "user": "https://github.com/jhpalmieri"
}
```

Note that since I can't find "high mem" in the Sage source code, I doubt this is the right syntax. (The doctesting framework has to search for something when matching the tag with the behavior, and `git grep "high.*mem" src` doesn't return any promising hits.) 

`@`embray, do you know the right syntax for marking a test with a memory cap? `# optional - memlimit` (as is used in `sage/doctest/test.py` and a few other places) or `# high mem` (as it says in sage-runtests) or something else?



---

archive/issue_comments_403736.json:
```json
{
    "body": "This ticket is in fact for the same issue than #25465. I did not remember it.",
    "created_at": "2019-12-20T12:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403736",
    "user": "https://github.com/dcoudert"
}
```

This ticket is in fact for the same issue than #25465. I did not remember it.



---

archive/issue_comments_403737.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-12-23T11:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403737",
    "user": "https://github.com/embray"
}
```

Resolution: duplicate



---

archive/issue_comments_403738.json:
```json
{
    "body": "Replying to [comment:8 jhpalmieri]:\n> Note that since I can't find \"high mem\" in the Sage source code, I doubt this is the right syntax. (The doctesting framework has to search for something when matching the tag with the behavior, and `git grep \"high.*mem\" src` doesn't return any promising hits.) \n> \n> `@`embray, do you know the right syntax for marking a test with a memory cap? `# optional - memlimit` (as is used in `sage/doctest/test.py` and a few other places) or `# high mem` (as it says in sage-runtests) or something else?\n\nYou can find it if you search the git history instead, but this is from #25907--in an earlier draft it was \"high mem\" but then during review changed to \"optional - memlimit\" but that string didn't get updated.\n\nClosing this ticket as a duplicate of #25465.",
    "created_at": "2019-12-23T11:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403738",
    "user": "https://github.com/embray"
}
```

Replying to [comment:8 jhpalmieri]:
> Note that since I can't find "high mem" in the Sage source code, I doubt this is the right syntax. (The doctesting framework has to search for something when matching the tag with the behavior, and `git grep "high.*mem" src` doesn't return any promising hits.) 
> 
> `@`embray, do you know the right syntax for marking a test with a memory cap? `# optional - memlimit` (as is used in `sage/doctest/test.py` and a few other places) or `# high mem` (as it says in sage-runtests) or something else?

You can find it if you search the git history instead, but this is from #25907--in an earlier draft it was "high mem" but then during review changed to "optional - memlimit" but that string didn't get updated.

Closing this ticket as a duplicate of #25465.



---

archive/issue_comments_403739.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> Replying to [comment:8 jhpalmieri]:\n> > Note that since I can't find \"high mem\" in the Sage source code, I doubt this is the right syntax. (The doctesting framework has to search for something when matching the tag with the behavior, and `git grep \"high.*mem\" src` doesn't return any promising hits.) \n> > \n> > `@`embray, do you know the right syntax for marking a test with a memory cap? `# optional - memlimit` (as is used in `sage/doctest/test.py` and a few other places) or `# high mem` (as it says in sage-runtests) or something else?\n> \n> You can find it if you search the git history instead, but this is from #25907--in an earlier draft it was \"high mem\" but then during review changed to \"optional - memlimit\" but that string didn't get updated.\n\nI opened #28978 to change the few remaining instances of \"high mem\" to \"memlimit\".",
    "created_at": "2020-01-10T00:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28628#issuecomment-403739",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:10 embray]:
> Replying to [comment:8 jhpalmieri]:
> > Note that since I can't find "high mem" in the Sage source code, I doubt this is the right syntax. (The doctesting framework has to search for something when matching the tag with the behavior, and `git grep "high.*mem" src` doesn't return any promising hits.) 
> > 
> > `@`embray, do you know the right syntax for marking a test with a memory cap? `# optional - memlimit` (as is used in `sage/doctest/test.py` and a few other places) or `# high mem` (as it says in sage-runtests) or something else?
> 
> You can find it if you search the git history instead, but this is from #25907--in an earlier draft it was "high mem" but then during review changed to "optional - memlimit" but that string didn't get updated.

I opened #28978 to change the few remaining instances of "high mem" to "memlimit".
