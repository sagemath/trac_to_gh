# Issue 29180: tox.ini, GitHub CI workflow - minor fixes

Issue created by migration from https://trac.sagemath.org/ticket/29417

Original creator: mkoeppe

Original creation time: 2020-03-27 17:06:56

CC:  jhpalmieri dimpase mjo @kliem vbraun




---

Comment by mkoeppe created at 2020-03-28 15:47:46

Last 10 new commits:


---

Comment by git created at 2020-03-28 15:59:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-30 19:44:52

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-03-30 20:01:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-30 20:09:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-30 22:07:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-03-31 13:46:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-02 16:13:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-02 16:39:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-02 21:00:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-03 17:15:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-03 19:19:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-03 22:49:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-04 21:02:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-05 21:06:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-08 01:26:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-08 01:30:14

Changing status from new to needs_review.


---

Comment by git created at 2020-04-08 13:02:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-08 13:53:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-08 19:33:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-09 18:35:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-09 18:39:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-04-09 19:20:23

Do you know how to resolve this? Is this resolved already?


```
 Error processing tar file(exit status 1): write /sage/local/share/doc/sage/html/en/reference/modsym/sage/modular/modsym/relation_matrix_pyx.html: no space left on device
ERROR: InvocationError: '/usr/bin/docker build . -f /home/runner/work/sage-test-27122/sage-test-27122/.tox/docker-ubuntu-trusty-standard/Dockerfile --build-arg EXTRA_CONFIGURE_ARGS=   --build-arg BASE_IMAGE=ubuntu:trusty --build-arg USE_MAKEFLAGS=-k V=0 SAGE_NUM_THREADS=3 --build-arg TARGETS=build ptest'
___________________________________ summary ____________________________________
ERROR:   docker-ubuntu-trusty-standard: commands failed
##[error]Process completed with exit code 1.
```


This appears to be the reason that every single test is marked as failed, which is kind of annoying.

[https://github.com/kliem/sage-test-27122/actions/runs/72102779](https://github.com/kliem/sage-test-27122/actions/runs/72102779)


---

Comment by mkoeppe created at 2020-04-09 19:24:55

Replying to [comment:29 gh-kliem]:
> Do you know how to resolve this? Is this resolved already?
> 
> {{{
>  Error processing tar file(exit status 1): write /sage/local/share/doc/sage/html/en/reference/modsym/sage/modular/modsym/relation_matrix_pyx.html: no space left on device
> ERROR: InvocationError: '/usr/bin/docker build . -f /home/runner/work/sage-test-27122/sage-test-27122/.tox/docker-ubuntu-trusty-standard/Dockerfile --build-arg EXTRA_CONFIGURE_ARGS=   --build-arg BASE_IMAGE=ubuntu:trusty --build-arg USE_MAKEFLAGS=-k V=0 SAGE_NUM_THREADS=3 --build-arg TARGETS=build ptest'
> ___________________________________ summary ____________________________________
> ERROR:   docker-ubuntu-trusty-standard: commands failed
> ##[error]Process completed with exit code 1.
> }}}

Help with this would be most welcome!

I have the following browser tabs open, which should help with finding a solution. Essentially, one needs to reconfigure the docker daemon to use  larger `dm.basesize`. 

Docker - Using systemd to control the Docker daemon
https://success.docker.com/article/using-systemd-to-control-the-docker-daemon

"systemctl set-property docker" - Google Search
https://www.google.com/search?safe=off&biw=834&bih=836&sxsrf=ALeKk02AnzFOj0bspN6PGW6rKhDhhp3f4w%3A1586407757228&ei=TamOXtqxDYKWtQW5zr3YBA&q=%22systemctl+set-property+docker%22&oq=%22systemctl+set-property+docker%22&gs_lcp=CgZwc3ktYWIQAzIECAAQHjoECAAQRzoGCAAQFhAeSgkIFxIFMTItNjJKCAgYEgQxMi00UNOnAVi1rQFg2a8BaABwAngAgAF4iAHlAZIBAzAuMpgBAKABAaoBB2d3cy13aXo&sclient=psy-ab&ved=0ahUKEwiajNq2xdroAhUCS60KHTlnD0s4ChDh1QMIDA&uact=5

Docker - How to resolve Resource Temporarily Unavailable errors due to TaskMax setting
https://success.docker.com/article/how-to-reserve-resource-temporarily-unavailable-errors-due-to-tasksmax-setting

"systemctl status docker.service" dm.basesize - Google Search
https://www.google.com/search?safe=off&sxsrf=ALeKk01dBCgUutnZt6DU3HHzqaJyqDfA_w%3A1586408161041&ei=4aqOXpKKAtHKswXerrtY&q=%22systemctl+status+docker.service%22+dm.basesize&oq=%22systemctl+status+docker.service%22+dm.basesize&gs_lcp=CgZwc3ktYWIQAzIFCCEQoAE6BAgAEEc6BggAEBYQHjoFCAAQzQI6CAghEBYQHRAeSgoIFxIGMTItMTE0SgkIGBIFMTItMThQpp4DWN7FA2DvyANoBHADeACAAaIBiAHcD5IBBDAuMTWYAQCgAQGqAQdnd3Mtd2l6&sclient=psy-ab&ved=0ahUKEwjS_qD3xtroAhVR5awKHV7XDgsQ4dUDCAw&uact=5

Cannot Change Docker Size on Ubuntu 16.04 - DevOps Stack Exchange
https://devops.stackexchange.com/questions/4062/cannot-change-docker-size-on-ubuntu-16-04

uggds/vagrant-docker
https://github.com/uggds/vagrant-docker

Can't install Docker - Cloudera Community
https://community.cloudera.com/t5/Support-Questions/Can-t-install-Docker/td-p/205969

docker disk size - Google Search
https://www.google.com/search?safe=off&sxsrf=ALeKk02gDtblI6DspE7pP0chAR0f7lCuJQ%3A1586404959534&ei=X56OXs-YIMHisAWJ-rWwBg&q=docker+disk+size&oq=docker+disk+size&gs_lcp=CgZwc3ktYWIQAzICCAAyBggAEAcQHjIGCAAQBxAeMgYIABAHEB4yAggAMgYIABAHEB4yBggAEAcQHjIGCAAQBxAeMgYIABAHEB4yAggAOgQIABBHOgYIABAFEB46CAgAEAcQBRAeOgQIABANOggIABAHEAoQHjoICAAQCBAHEB5KEAgXEgwxMC0yMTJnMTg0ZzdKDAgYEggxMC0xZzJnMlDhZVjfdGDjeGgDcAJ4AIAB4gGIAfwNkgEFMC40LjWYAQCgAQGqAQdnd3Mtd2l6&sclient=psy-ab&ved=0ahUKEwiPxNSAu9roAhVBMawKHQl9DWYQ4dUDCAw&uact=5

elasticsearch - Disk size of a docker image - Stack Overflow
https://stackoverflow.com/questions/48751032/disk-size-of-a-docker-image

dockerd | Docker Documentation
https://docs.docker.com/engine/reference/commandline/dockerd/

virtual-environments/Ubuntu1804-README.md at master · actions/virtual-environments
https://github.com/actions/virtual-environments/blob/master/images/linux/Ubuntu1804-README.md

Docker Engine 18.09 release notes | Docker Documentation
https://docs.docker.com/engine/release-notes/18.09/

systemctl(1) — systemd — Debian jessie — Debian Manpages
https://manpages.debian.org/jessie/systemd/systemctl.1.en.html


---

Comment by @kliem created at 2020-04-09 19:59:09

This looks really complicated. I'm afraid this is way above what I know.

Does this help?

https://github.community/t5/GitHub-Actions/BUG-Strange-quot-No-space-left-on-device-quot-IOExceptions-on/m-p/47691#M6920


---

Comment by mkoeppe created at 2020-04-09 21:17:53

No worries - at least I was able to close this browser window now!


---

Comment by @kliem created at 2020-04-10 12:56:58

It appears that the solution in the link I provided, is fixing at least part of the problem.

I have put this 


```diff
       - uses: actions/checkout@v2
+      - name: free disk space
+        run: |
+          sudo swapoff -a
+          sudo rm -f /swapfile
+          sudo apt clean
+          docker rmi $(docker image ls -aq)
+          df -h
       - name: Install test prerequisites
```

in the debian/ubuntu in `.github/workflows/tox.yml` and it seems to help. There are green checkmarks again. E.g. debian-jessie minimal passes [https://github.com/kliem/sage-test-27122/actions/runs/75035611](https://github.com/kliem/sage-test-27122/actions/runs/75035611), which previously had that `no space left on disk` error.

Now many of minimal runs pass, but the standards show error messages as


```
The command '/bin/sh -c make SAGE_SPKG="sage-spkg -y -o" ${USE_MAKEFLAGS} ${TARGETS}' returned a non-zero code: 2
ERROR: InvocationError: '/bin/bash -c for docker_target in with-targets; do  docker build . -f /home/runner/work/sage-test-27122/sage-test-27122/.tox/docker-debian-jessie-standard/Dockerfile  --target $docker_target  --tag sage-docker-debian-jessie-standard-$docker_target:$(git describe --dirty --always)  --build-arg EXTRA_CONFIGURE_ARGS="  "  --build-arg BASE_IMAGE=debian:jessie  --build-arg TARGETS_PRE=sagelib-build-deps  --build-arg TARGETS=build  --build-arg USE_MAKEFLAGS="-k V=0 SAGE_NUM_THREADS=3" --build-arg TARGETS="build ptest"; done'
```



---

Comment by @kliem created at 2020-04-10 12:59:02

In the link they also cleanup old artifacts


```
    - name: cleanup old action artifacts
      run: .github/workflows/purge_artifacts.sh ${{ secrets.REPO_ACCESS_TOKEN }}
```


I don't know what this is for. But maybe that is also helpful.


---

Comment by @kliem created at 2020-04-10 13:18:10

That is probably the expected behavior when not all tests pass.

Replying to [comment:33 gh-kliem]:
> 
> {{{
> The command '/bin/sh -c make SAGE_SPKG="sage-spkg -y -o" ${USE_MAKEFLAGS} ${TARGETS}' returned a non-zero code: 2
> ERROR: InvocationError: '/bin/bash -c for docker_target in with-targets; do  docker build . -f /home/runner/work/sage-test-27122/sage-test-27122/.tox/docker-debian-jessie-standard/Dockerfile  --target $docker_target  --tag sage-docker-debian-jessie-standard-$docker_target:$(git describe --dirty --always)  --build-arg EXTRA_CONFIGURE_ARGS="  "  --build-arg BASE_IMAGE=debian:jessie  --build-arg TARGETS_PRE=sagelib-build-deps  --build-arg TARGETS=build  --build-arg USE_MAKEFLAGS="-k V=0 SAGE_NUM_THREADS=3" --build-arg TARGETS="build ptest"; done'
> }}}


---

Comment by mkoeppe created at 2020-04-10 15:13:07

Replying to [comment:35 gh-kliem]:
> That is probably the expected behavior when not all tests pass.
> 
> Replying to [comment:33 gh-kliem]:
> > 
> > {{{
> > The command '/bin/sh -c make SAGE_SPKG="sage-spkg -y -o" ${USE_MAKEFLAGS} ${TARGETS}' returned a non-zero code: 2
> > ERROR: InvocationError: '/bin/bash -c for docker_target in with-targets; do  docker build . -f /home/runner/work/sage-test-27122/sage-test-27122/.tox/docker-debian-jessie-standard/Dockerfile  --target $docker_target  --tag sage-docker-debian-jessie-standard-$docker_target:$(git describe --dirty --always)  --build-arg EXTRA_CONFIGURE_ARGS="  "  --build-arg BASE_IMAGE=debian:jessie  --build-arg TARGETS_PRE=sagelib-build-deps  --build-arg TARGETS=build  --build-arg USE_MAKEFLAGS="-k V=0 SAGE_NUM_THREADS=3" --build-arg TARGETS="build ptest"; done'
> > }}}

Yes, this is expected behavior.

But it would perhaps be better to change it so that the docker build succeeds if there are only testsuite failures


---

Comment by mkoeppe created at 2020-04-10 17:04:52

Replying to [comment:36 mkoeppe]:
> But it would perhaps be better to change it so that the docker build succeeds if there are only testsuite failures

Working on a solution for this.


---

Comment by @kliem created at 2020-04-10 18:20:16

I think the above thing with the disk space is more important.

I like the green check marks, because then I can just trust that everything worked fine. However,
it would still be nice, if one can quickly access which tests failed. But maybe that is non-trivial and then that's just the way it is.

Also I still hope that very soon we will have most of the runs clean either way.


---

Comment by mkoeppe created at 2020-04-10 18:25:42

Replying to [comment:38 gh-kliem]:
> I think the above thing with the disk space is more important.

Yes, I'm trying out your patch


---

Comment by @kliem created at 2020-04-10 19:09:36

Maybe one could have failing doctests communicated as neutral runs (according to github this is also a possible state). I don't know how much work it would be to accomplish this, but it would be really nice. Than one knows at the first glance what's going on.


---

Comment by @kliem created at 2020-04-10 19:18:47

I don't think it is supported anymore [https://help.github.com/en/actions/building-actions/setting-exit-codes-for-actions](https://help.github.com/en/actions/building-actions/setting-exit-codes-for-actions)

I rather have failed tests as failure so that one has to check the details. Otherwise we might overlook critical failing tests.


---

Comment by mkoeppe created at 2020-04-11 00:14:07

Replying to [comment:41 gh-kliem]:
> I rather have failed tests as failure so that one has to check the details. Otherwise we might overlook critical failing tests.
In the branch that I'm testing right now this is conveniently configurable


---

Comment by mkoeppe created at 2020-04-11 16:39:42

A preview at https://github.com/mkoeppe/sage/actions/runs/75739694


---

Comment by git created at 2020-04-11 16:53:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-12 05:13:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-12 07:26:07

Running at https://github.com/mkoeppe/sage/actions/runs/76368041


---

Comment by mkoeppe created at 2020-04-12 16:04:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-04-12 17:38:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-12 17:39:00

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-04-13 00:04:06

This now seems to work very well. https://github.com/mkoeppe/sage/actions/runs/76629492

Failing `TARGETS_OPTIONAL` (default = `ptest`) do not abort the build. These show as green checkmarks in the left pane, but for all failing doctest logs (both packages and sagelib ptest) also a yellow "Check warning" is displayed as annotation in the right pane.

By setting `TARGETS_OPTIONAL` to include names of optional packages, we can also test these in the same way.


---

Comment by git created at 2020-04-13 05:33:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-13 05:34:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-04-13 05:34:56

Rebased on 9.1.rc0


---

Comment by mkoeppe created at 2020-04-13 15:44:00

Test for 9.1.rc0 running at https://github.com/mkoeppe/sage/actions/runs/76923542


---

Comment by git created at 2020-04-13 17:20:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-15 01:24:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-15 01:24:39

Can we finalize the review of this one please to get it into 9.1?


---

Comment by dimpase created at 2020-04-15 01:55:58

running GH Actions tests on this here: https://github.com/dimpase/sage/pull/3


---

Comment by dimpase created at 2020-04-15 17:44:37

Replying to [comment:59 dimpase]:
> running GH Actions tests on this here: https://github.com/dimpase/sage/pull/3

I see

```
/Users/runner/runners/2.168.0/work/sage/sage/build/bin/sage-venv "/Users/runner/runners/2.168.0/work/sage/sage/.tox/local-homebrew-macos-python3_pythonorg-standard/local"
2020-04-15T16:31:11.9205990Z /bin/sh: /Library/Frameworks/Python.framework/Versions/3.7/bin/python3: No such file or directory
2020-04-15T16:31:11.9206560Z make[1]: *** [/Users/runner/runners/2.168.0/work/sage/sage/.tox/local-homebrew-macos-python3_pythonorg-standard/local/pyvenv.cfg] Error 127
2020-04-15T16:31:11.9207060Z make[1]: Target `doc-html' not remade because of errors.
```

there. Isn't this ticked supposed to be fixing this?


---

Comment by mkoeppe created at 2020-04-15 18:17:49

Thanks for catching this. Turns out I forgot to install the python.org python3 in tox.yml.
(This cannot be done in tox.ini because it is not relocatable, see comment there)


---

Comment by git created at 2020-04-15 18:38:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-15 18:42:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-15 21:10:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-16 02:13:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-04-16 08:02:47

next try here: https://github.com/dimpase/sage/pull/4


---

Comment by dimpase created at 2020-04-17 15:55:26

`homebrew-macos-python3_pythonorg, standard` (https://github.com/dimpase/sage/runs/591414002) crashes at `[dochtml]` stage - not sure whether one can get complete `logs/dochtml.log` file from GitHub run above


---

Comment by dimpase created at 2020-04-17 16:03:33

I presume that various errors on local-macos `standard` runs are to be debugged individually. 

e.g. on https://github.com/dimpase/sage/runs/591413919 (homebrew-macos-python3_xcode, minimal) I see `##[error] ==== ERROR IN LOG FILE artifacts/logs-commit-8bb28ec8ffd6869c6b86e3f5224333decb049d09-tox-local-homebrew-macos-python3_xcode-minimal/log/pkgs/gc-7.6.4.p0.log ====` and
`Warning: Error testing package gc-7.6.4.p0 (ignored)`


---

Comment by dimpase created at 2020-04-17 16:03:33

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-17 16:21:18

Thanks!


---

Comment by mkoeppe created at 2020-04-17 16:21:39

Yes, errors are to be fixed on their own tickets.


---

Comment by mkoeppe created at 2020-04-17 16:23:23

Some of the errors are actually "only" testsuite failures. Tickets such as #29501 clean up some of the messages.


---

Comment by mkoeppe created at 2020-04-17 16:27:15

Replying to [comment:67 dimpase]:
> `homebrew-macos-python3_pythonorg, standard` (https://github.com/dimpase/sage/runs/591414002) crashes at `[dochtml]` stage - not sure whether one can get complete `logs/dochtml.log` file from GitHub run above

Yes, download the log artifact.  But it only says 

```
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/Users/runner/runners/2.169.0/work/sage/sage/src/bin/sage-python: line 2: 14003 Segmentation fault: 11  sage -python "$@"
```



---

Comment by vbraun created at 2020-04-19 19:25:17

Resolution: fixed
