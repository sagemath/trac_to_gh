# Issue 31853: Upgrade to Sirocco 2.1.0 and improvements on the fundamental group of curves.

archive/issues_031853.json:
```json
{
    "body": "CC:  @tscrim soe pportilla @baldursigdurs @enriqueartal @slel\n\nlibsirocco 2.1.0 provides the option of treating separatedly the factors of a polynomial, which would make homotopy continuation faster in the case of reducible curves.\n\nIn this ticket, I also address a possible issue with the selection of paths to compute the braid monodromy of a curve. The preexisting code used floating points approximations, without a complete proof of the correctness of the results. Here we use rationals, which are slower, but much more robust (depending on the case, this slowness can be compensated by the improvements in sirocco.\n\nFinally, it includes the option of getting the braid monodromy as a list of braids (some colleagues have been asking for this feature for a while).\n\nIssue created by migration from https://trac.sagemath.org/ticket/32090\n\n",
    "created_at": "2021-06-30T10:57:07Z",
    "labels": [
        "algebraic geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Upgrade to Sirocco 2.1.0 and improvements on the fundamental group of curves.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31853",
    "user": "@miguelmarco"
}
```
CC:  @tscrim soe pportilla @baldursigdurs @enriqueartal @slel

libsirocco 2.1.0 provides the option of treating separatedly the factors of a polynomial, which would make homotopy continuation faster in the case of reducible curves.

In this ticket, I also address a possible issue with the selection of paths to compute the braid monodromy of a curve. The preexisting code used floating points approximations, without a complete proof of the correctness of the results. Here we use rationals, which are slower, but much more robust (depending on the case, this slowness can be compensated by the improvements in sirocco.

Finally, it includes the option of getting the braid monodromy as a list of braids (some colleagues have been asking for this feature for a while).

Issue created by migration from https://trac.sagemath.org/ticket/32090





---

archive/issue_comments_455242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-30T11:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455242",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455243.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-30T11:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455243",
    "user": "@miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455244.json:
```json
{
    "body": "+1 to moving to rationals and exact arithmetic.\n\n`cpdef` functions will need doctests. Same for `def roots_interval_cached`.\n\nCode formatting versus latex:\n\n```diff\n-no other root of `f`, nor any root of the polynomials in `factors`,\n+no other root of ``f``, nor any root of the polynomials in ``factors``,\n```\n\n\n\n```diff\n @cached_function\n def corrected_voronoi_diagram(points):\n     r\"\"\"\n-    compute a Voronoi diagram of a set of points with rational coordinates, such\n+    Compute a Voronoi diagram of a set of points with rational coordinates, such\n     that the given points are granted to lie one in each bounded region.\n \n     INPUT:\n \n-    - ``points`` -- a list of complex numbers.\n+    - ``points`` -- a list of complex numbers\n```\n\n\n\n```diff\n def orient_circuit(circuit):\n     r\"\"\"\n-    reverses a circuit if it goes clockwise\n+    Reverses a circuit if it goes clockwise; otherwise leaves it unchanged.\n \n     INPUT:\n \n-    - `circuit` --  a circuit in the graph of a Voronoi Diagram, given\n-        by a list of edges\n+    - ``circuit`` -- a circuit in the graph of a Voronoi diagram, given\n+      by a list of edges\n \n-    OUTPUT: The same circuit if it goes counterclockwise, and its reverse otherwise\n+    OUTPUT:\n+\n+    The same circuit if it goes counterclockwise, and its reverse otherwise.\n```\n\n(Although you don't really need the `OUTPUT:` here since it is obvious from the 1-line description.)\n\n\n```diff\n def geometric_basis(G, E, p):\n     r\"\"\"\n     Return a geometric basis, based on a vertex.\n \n     INPUT:\n \n-    - ``G`` -- The graph of the bounded regions of a Voronoi Diagram\n+    - ``G`` -- the graph of the bounded regions of a Voronoi diagram\n \n-    - ``E`` -- The subgraph of `G` formed by the edges that touch an unbounded\n-    region\n+    - ``E`` -- the subgraph of ``G`` formed by the edges that touch an\n+      unbounded region\n \n-    - ``p`` -- A vertex of `E`\n+    - ``p`` -- a vertex of ``E``\n```\n\n\n\n```diff\n-raise ValueError(\"can't compute a correct path\")\n+raise ValueError(\"unable to compute a correct path\")\n```\n\n\n\n```diff\n def braid_monodromy(f):\n     r\"\"\"\n     Compute the braid monodromy of a projection of the curve defined by a polynomial\n \n     INPUT:\n \n     - ``f`` -- a polynomial with two variables, over a number field with an embedding\n-    in the complex numbers.\n+      in the complex numbers\n \n     OUTPUT:\n \n     A list of braids. The braids correspond to paths based in the same point;\n     each of this paths is the conjugated of a loop around one of the points\n-    in the discriminant of the projection of `f`.\n+    in the discriminant of the projection of ``f``.\n \n-    NOTE:\n+    .. NOTE::\n \n-    The projection over the `x` axis is used if there are no vertical asymptotes.\n-    Otherwise, a linear change of variables is done to fall into the previous case.\n+        The projection over the `x` axis is used if there are no vertical asymptotes.\n+        Otherwise, a linear change of variables is done to fall into the previous case.\n```\n\n\nYou can do\n\n```diff\n-p = E.vertices()[0]\n+p = next(E.vertex_iterator())\n```\n\nto get one vertex without building the entire list.\n\nTwo places:\n\n```diff\n-not (g, v) in roots_interval_cache.keys()\n+(g, v) not in roots_interval_cache\n```\n\n\nAlso, the number of blanklines in a few places is a little strange.",
    "created_at": "2021-07-01T00:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455244",
    "user": "@tscrim"
}
```

+1 to moving to rationals and exact arithmetic.

`cpdef` functions will need doctests. Same for `def roots_interval_cached`.

Code formatting versus latex:

```diff
-no other root of `f`, nor any root of the polynomials in `factors`,
+no other root of ``f``, nor any root of the polynomials in ``factors``,
```



```diff
 @cached_function
 def corrected_voronoi_diagram(points):
     r"""
-    compute a Voronoi diagram of a set of points with rational coordinates, such
+    Compute a Voronoi diagram of a set of points with rational coordinates, such
     that the given points are granted to lie one in each bounded region.
 
     INPUT:
 
-    - ``points`` -- a list of complex numbers.
+    - ``points`` -- a list of complex numbers
```



```diff
 def orient_circuit(circuit):
     r"""
-    reverses a circuit if it goes clockwise
+    Reverses a circuit if it goes clockwise; otherwise leaves it unchanged.
 
     INPUT:
 
-    - `circuit` --  a circuit in the graph of a Voronoi Diagram, given
-        by a list of edges
+    - ``circuit`` -- a circuit in the graph of a Voronoi diagram, given
+      by a list of edges
 
-    OUTPUT: The same circuit if it goes counterclockwise, and its reverse otherwise
+    OUTPUT:
+
+    The same circuit if it goes counterclockwise, and its reverse otherwise.
```

(Although you don't really need the `OUTPUT:` here since it is obvious from the 1-line description.)


```diff
 def geometric_basis(G, E, p):
     r"""
     Return a geometric basis, based on a vertex.
 
     INPUT:
 
-    - ``G`` -- The graph of the bounded regions of a Voronoi Diagram
+    - ``G`` -- the graph of the bounded regions of a Voronoi diagram
 
-    - ``E`` -- The subgraph of `G` formed by the edges that touch an unbounded
-    region
+    - ``E`` -- the subgraph of ``G`` formed by the edges that touch an
+      unbounded region
 
-    - ``p`` -- A vertex of `E`
+    - ``p`` -- a vertex of ``E``
```



```diff
-raise ValueError("can't compute a correct path")
+raise ValueError("unable to compute a correct path")
```



```diff
 def braid_monodromy(f):
     r"""
     Compute the braid monodromy of a projection of the curve defined by a polynomial
 
     INPUT:
 
     - ``f`` -- a polynomial with two variables, over a number field with an embedding
-    in the complex numbers.
+      in the complex numbers
 
     OUTPUT:
 
     A list of braids. The braids correspond to paths based in the same point;
     each of this paths is the conjugated of a loop around one of the points
-    in the discriminant of the projection of `f`.
+    in the discriminant of the projection of ``f``.
 
-    NOTE:
+    .. NOTE::
 
-    The projection over the `x` axis is used if there are no vertical asymptotes.
-    Otherwise, a linear change of variables is done to fall into the previous case.
+        The projection over the `x` axis is used if there are no vertical asymptotes.
+        Otherwise, a linear change of variables is done to fall into the previous case.
```


You can do

```diff
-p = E.vertices()[0]
+p = next(E.vertex_iterator())
```

to get one vertex without building the entire list.

Two places:

```diff
-not (g, v) in roots_interval_cache.keys()
+(g, v) not in roots_interval_cache
```


Also, the number of blanklines in a few places is a little strange.



---

archive/issue_comments_455245.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-01T12:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455245",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455246.json:
```json
{
    "body": "When I run this with `SAGE_NUM_THREADS` bigger than one, I get the following error:\n\n\n\n```\nsage: A.<x,y> = AffineSpace(QQ,2)                                                                                                                                                                   \nsage: C = A.curve((x^2-y^3)*(y-1))                                                                                                                                                                  \nsage: C.braid_monodromy()                                                                                                                                                                           \n---------------------------------------------------------------------------\nChildProcessError                         Traceback (most recent call last)\n<ipython-input-6-f0f066e7f668> in <module>\n----> 1 C.braid_monodromy()\n\n~/sage/local/lib/python3.7/site-packages/sage/schemes/curves/affine_curve.py in braid_monodromy(self)\n   1771                                       \" to the algebraic field\")\n   1772         f = self.defining_polynomial()\n-> 1773         return braid_monodromy(f)\n   1774 \n   1775 \n\n~/sage/local/lib/python3.7/site-packages/sage/schemes/curves/zariski_vankampen.py in braid_monodromy(f)\n    870     braidscomputed = braid_in_segment([(gfac, seg[0], seg[1]) for seg in segs])\n    871     segsbraids = dict()\n--> 872     for braidcomputed in braidscomputed:\n    873         seg = (braidcomputed[0][0][1], braidcomputed[0][0][2])\n    874         beginseg = (QQ(seg[0].real()), QQ(seg[0].imag()))\n\n~/sage/local/lib/python3.7/site-packages/sage/parallel/use_fork.py in __call__(self, f, inputs)\n    190 \n    191                     try:\n--> 192                         pid = os.wait()[0]\n    193                         cancel_alarm()\n    194                         W = workers.pop(pid)\n\n```\n\n\n\nIt only happens the first time I run it (after that, it works ok). It seems that something is going on with the parallel framework, but can't pinpoint it.\n\nAny clue about what would that be?",
    "created_at": "2021-07-01T12:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455246",
    "user": "@miguelmarco"
}
```

When I run this with `SAGE_NUM_THREADS` bigger than one, I get the following error:



```
sage: A.<x,y> = AffineSpace(QQ,2)                                                                                                                                                                   
sage: C = A.curve((x^2-y^3)*(y-1))                                                                                                                                                                  
sage: C.braid_monodromy()                                                                                                                                                                           
---------------------------------------------------------------------------
ChildProcessError                         Traceback (most recent call last)
<ipython-input-6-f0f066e7f668> in <module>
----> 1 C.braid_monodromy()

~/sage/local/lib/python3.7/site-packages/sage/schemes/curves/affine_curve.py in braid_monodromy(self)
   1771                                       " to the algebraic field")
   1772         f = self.defining_polynomial()
-> 1773         return braid_monodromy(f)
   1774 
   1775 

~/sage/local/lib/python3.7/site-packages/sage/schemes/curves/zariski_vankampen.py in braid_monodromy(f)
    870     braidscomputed = braid_in_segment([(gfac, seg[0], seg[1]) for seg in segs])
    871     segsbraids = dict()
--> 872     for braidcomputed in braidscomputed:
    873         seg = (braidcomputed[0][0][1], braidcomputed[0][0][2])
    874         beginseg = (QQ(seg[0].real()), QQ(seg[0].imag()))

~/sage/local/lib/python3.7/site-packages/sage/parallel/use_fork.py in __call__(self, f, inputs)
    190 
    191                     try:
--> 192                         pid = os.wait()[0]
    193                         cancel_alarm()
    194                         W = workers.pop(pid)

```



It only happens the first time I run it (after that, it works ok). It seems that something is going on with the parallel framework, but can't pinpoint it.

Any clue about what would that be?



---

archive/issue_comments_455247.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-01T12:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455247",
    "user": "@miguelmarco"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_455248.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-01T12:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455248",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455249.json:
```json
{
    "body": "Unfortunately I don't really know from a quick look. It might be that there is some other error that is happening in the child and it just isn't printing it correctly. It is strange it is working on the second try.",
    "created_at": "2021-07-02T02:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455249",
    "user": "@tscrim"
}
```

Unfortunately I don't really know from a quick look. It might be that there is some other error that is happening in the child and it just isn't printing it correctly. It is strange it is working on the second try.



---

archive/issue_comments_455250.json:
```json
{
    "body": "Also, you now have a merge conflict. `:/`",
    "created_at": "2021-07-02T02:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455250",
    "user": "@tscrim"
}
```

Also, you now have a merge conflict. `:/`



---

archive/issue_comments_455251.json:
```json
{
    "body": "Maybe I did something wrong but I get an error: ModuleNotFoundError: No module named 'sage.libs.sirocco', even for fundamental group. There was also a difficulty for git pull with affine_curve.py.\n\nI am doing it again since I rebased with develop and #31786 to avoid recompiling gcc in Fedora 34. This time without rebasing.",
    "created_at": "2021-07-04T19:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455251",
    "user": "@enriqueartal"
}
```

Maybe I did something wrong but I get an error: ModuleNotFoundError: No module named 'sage.libs.sirocco', even for fundamental group. There was also a difficulty for git pull with affine_curve.py.

I am doing it again since I rebased with develop and #31786 to avoid recompiling gcc in Fedora 34. This time without rebasing.



---

archive/issue_comments_455252.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-05T11:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455252",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455253.json:
```json
{
    "body": "I added/fixed the doctests, made fundamental group depend on braid monodromy (which produces zariski-vankampen presentations, and avoids code duplication). I also tried to track the problem with failing parallel computations the first time in each session...but didn't find the source. So I did an ugly hack via a try/except trick. It is horrible, but it seems to work.\n\nPlease test and review carefully, since there are a lot of potential corner cases that could produce subtle errors. I think I did manage to make sure they won't happen, but would be much safer to have more eyes looking.",
    "created_at": "2021-07-05T11:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455253",
    "user": "@miguelmarco"
}
```

I added/fixed the doctests, made fundamental group depend on braid monodromy (which produces zariski-vankampen presentations, and avoids code duplication). I also tried to track the problem with failing parallel computations the first time in each session...but didn't find the source. So I did an ugly hack via a try/except trick. It is horrible, but it seems to work.

Please test and review carefully, since there are a lot of potential corner cases that could produce subtle errors. I think I did manage to make sure they won't happen, but would be much safer to have more eyes looking.



---

archive/issue_comments_455254.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-05T23:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455254",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455255.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-05T23:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455255",
    "user": "@miguelmarco"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_455256.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T00:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455256",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455257.json:
```json
{
    "body": "I am a little worried about the global cache and things running in parallel since they are running in different processes. However, that won't cause the error above and it will likely mean that the cache is not working as effectively as it could. What might be related is calling a ``@`parallel` function within a ``@`parallel` function. That was not done before this ticket. It might be better to have a more direct implementation rather than using the ``@`parallel`, but since this is currently working, that could be a follow-up.\n\nA few things I noticed that could offer improvements:\n\n```diff\n-            if not any([a.overlaps(b) for a,b in Subsets(intervals[f], 2)]):\n-            intervals[f] = [r.interval(ComplexIntervalField(precision[f])) for r in y0sf]\n+            CIFp = ComplexIntervalField(precision[f])\n+            intervals[f] = [r.interval(CIFp) for r in y0sf]\n+            if not any(a.overlaps(b) for a,b in itertools.combinations(intervals[f], 2)):\n```\n\n\n```diff\n     global roots_interval_cache\n-    if (f,x0) in roots_interval_cache.keys():\n+    try:\n         return roots_interval_cache[(f,x0)]\n-    else:\n+    except KeyError:\n         result = roots_interval(f,x0)\n         roots_interval_cache[(f,x0)] = result\n         return result\n```\n\n\n```diff\n-        diam = min([(CF(r)-CF(r0)).abs() for r0 in roots[:i]+roots[i+1:]])/divisor\n+        diam = min((CF(r)-CF(r0)).abs() for r0 in roots[:i]+roots[i+1:]) / divisor\n```\n",
    "created_at": "2021-07-06T00:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455257",
    "user": "@tscrim"
}
```

I am a little worried about the global cache and things running in parallel since they are running in different processes. However, that won't cause the error above and it will likely mean that the cache is not working as effectively as it could. What might be related is calling a ``@`parallel` function within a ``@`parallel` function. That was not done before this ticket. It might be better to have a more direct implementation rather than using the ``@`parallel`, but since this is currently working, that could be a follow-up.

A few things I noticed that could offer improvements:

```diff
-            if not any([a.overlaps(b) for a,b in Subsets(intervals[f], 2)]):
-            intervals[f] = [r.interval(ComplexIntervalField(precision[f])) for r in y0sf]
+            CIFp = ComplexIntervalField(precision[f])
+            intervals[f] = [r.interval(CIFp) for r in y0sf]
+            if not any(a.overlaps(b) for a,b in itertools.combinations(intervals[f], 2)):
```


```diff
     global roots_interval_cache
-    if (f,x0) in roots_interval_cache.keys():
+    try:
         return roots_interval_cache[(f,x0)]
-    else:
+    except KeyError:
         result = roots_interval(f,x0)
         roots_interval_cache[(f,x0)] = result
         return result
```


```diff
-        diam = min([(CF(r)-CF(r0)).abs() for r0 in roots[:i]+roots[i+1:]])/divisor
+        diam = min((CF(r)-CF(r0)).abs() for r0 in roots[:i]+roots[i+1:]) / divisor
```




---

archive/issue_comments_455258.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T18:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455258",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455259.json:
```json
{
    "body": "It works after rebasing with #31786 to avoid gcc package in Fedora 34",
    "created_at": "2021-07-07T17:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455259",
    "user": "@enriqueartal"
}
```

It works after rebasing with #31786 to avoid gcc package in Fedora 34



---

archive/issue_comments_455260.json:
```json
{
    "body": "Any thoughts about comment:18 Miguel?",
    "created_at": "2021-07-08T23:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455260",
    "user": "@tscrim"
}
```

Any thoughts about comment:18 Miguel?



---

archive/issue_comments_455261.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-12T10:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455261",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455262.json:
```json
{
    "body": "If I am not mistaken, current code does not call a `@`parallel function from a `@`parallel function.\n\nI agree the current design is hacky, but couldn't find another way to achieve both cache and parallelism in a less hacky way. (Maybe encapsulating it in a specific class for that, but that does sound overkill).\n\nWhat would you suggest?",
    "created_at": "2021-07-12T10:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455262",
    "user": "@miguelmarco"
}
```

If I am not mistaken, current code does not call a `@`parallel function from a `@`parallel function.

I agree the current design is hacky, but couldn't find another way to achieve both cache and parallelism in a less hacky way. (Maybe encapsulating it in a specific class for that, but that does sound overkill).

What would you suggest?



---

archive/issue_comments_455263.json:
```json
{
    "body": "Replying to [comment:23 mmarco]:\n> If I am not mistaken, current code does not call a `@`parallel function from a `@`parallel function.\n\nYou have `braid_in_segment` -> `roots_interval_cached` -(if not cached)-> `roots_interval`. Perhaps this never happens because you have fully populated the cache, but this is not obvious to me.\n\n> I agree the current design is hacky, but couldn't find another way to achieve both cache and parallelism in a less hacky way. (Maybe encapsulating it in a specific class for that, but that does sound overkill).\n> \n> What would you suggest?\n\nYou would have to roll your own calls to Python's `multiprocessing` module. For now this should be okay as that could take a bit of work to do and it likely won't have a major impact. Note that if the cache is not fully computed, you would have to call `roots_interval` for the same input multiple times as the cache is not shared across different processes (only what it was initially at when everything was forked).",
    "created_at": "2021-07-12T22:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455263",
    "user": "@tscrim"
}
```

Replying to [comment:23 mmarco]:
> If I am not mistaken, current code does not call a `@`parallel function from a `@`parallel function.

You have `braid_in_segment` -> `roots_interval_cached` -(if not cached)-> `roots_interval`. Perhaps this never happens because you have fully populated the cache, but this is not obvious to me.

> I agree the current design is hacky, but couldn't find another way to achieve both cache and parallelism in a less hacky way. (Maybe encapsulating it in a specific class for that, but that does sound overkill).
> 
> What would you suggest?

You would have to roll your own calls to Python's `multiprocessing` module. For now this should be okay as that could take a bit of work to do and it likely won't have a major impact. Note that if the cache is not fully computed, you would have to call `roots_interval` for the same input multiple times as the cache is not shared across different processes (only what it was initially at when everything was forked).



---

archive/issue_comments_455264.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-23T08:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455264",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455265.json:
```json
{
    "body": "I have Added a function to explicitely populate the cache before the parallel call. It still uses the cached version of the function inside the parallel calls, but just as a safeguard: all the calls should be cached.",
    "created_at": "2021-07-23T08:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455265",
    "user": "@miguelmarco"
}
```

I have Added a function to explicitely populate the cache before the parallel call. It still uses the cached version of the function inside the parallel calls, but just as a safeguard: all the calls should be cached.



---

archive/issue_comments_455266.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-26T00:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455266",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455267.json:
```json
{
    "body": "Thanks. This will be good for now. It would be nice to figure out why we get that child process error (I confirmed it still exists with the current change), but this will work for now.",
    "created_at": "2021-07-26T00:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455267",
    "user": "@tscrim"
}
```

Thanks. This will be good for now. It would be nice to figure out why we get that child process error (I confirmed it still exists with the current change), but this will work for now.



---

archive/issue_comments_455268.json:
```json
{
    "body": "\n```\nsage -t --long --warn-long 44.1 --random-seed=0 src/sage/libs/sirocco.pyx\n**********************************************************************\nFile \"src/sage/libs/sirocco.pyx\", line 41, in sage.libs.sirocco.contpath_mp\nFailed example:\n    from sage.libs.sirocco import contpath_mp\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py\", line 718, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py\", line 1137, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.sirocco.contpath_mp[0]>\", line 1, in <module>\n        from sage.libs.sirocco import contpath_mp\n    ModuleNotFoundError: No module named 'sage.libs.sirocco'\n**********************************************************************\n```\n",
    "created_at": "2021-08-29T22:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455268",
    "user": "@vbraun"
}
```


```
sage -t --long --warn-long 44.1 --random-seed=0 src/sage/libs/sirocco.pyx
**********************************************************************
File "src/sage/libs/sirocco.pyx", line 41, in sage.libs.sirocco.contpath_mp
Failed example:
    from sage.libs.sirocco import contpath_mp
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.sirocco.contpath_mp[0]>", line 1, in <module>
        from sage.libs.sirocco import contpath_mp
    ModuleNotFoundError: No module named 'sage.libs.sirocco'
**********************************************************************
```




---

archive/issue_comments_455269.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-08-29T22:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455269",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_455270.json:
```json
{
    "body": "The doctests need more of `# optional - sirocco`",
    "created_at": "2021-08-30T01:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455270",
    "user": "@mkoeppe"
}
```

The doctests need more of `# optional - sirocco`



---

archive/issue_comments_455271.json:
```json
{
    "body": "This should take care of it.\n----\nNew commits:",
    "created_at": "2021-08-30T02:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455271",
    "user": "@tscrim"
}
```

This should take care of it.
----
New commits:



---

archive/issue_comments_455272.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-30T02:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455272",
    "user": "@tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_455273.json:
```json
{
    "body": "So, do you think can we set a positive review?",
    "created_at": "2021-09-17T16:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455273",
    "user": "@miguelmarco"
}
```

So, do you think can we set a positive review?



---

archive/issue_comments_455274.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-21T00:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455274",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455275.json:
```json
{
    "body": "Yes, I think so.",
    "created_at": "2021-09-21T00:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455275",
    "user": "@tscrim"
}
```

Yes, I think so.



---

archive/issue_comments_455276.json:
```json
{
    "body": "\n```\nFile \"src/sage/schemes/curves/zariski_vankampen.py\", line 334, in sage.schemes.curves.zariski_vankampen.followstrand\nFailed example:\n    followstrand(f, [fup, fdown], x0, x1, -1.0)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.curves.zariski_vankampen.followstrand[6]>\", line 1, in <module>\n        followstrand(f, [fup, fdown], x0, x1, -RealNumber('1.0'))\n    NameError: name 'followstrand' is not defined\n**********************************************************************\n1 item had failures:\n   1 of   8 in sage.schemes.curves.zariski_vankampen.followstrand\n    [100 tests, 1 failure, 0.24 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 43.0 --random-seed=93097112693405690428202520811084416543 src/sage/schemes/curves/zariski_vankampen.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2021-09-27T22:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455276",
    "user": "@vbraun"
}
```


```
File "src/sage/schemes/curves/zariski_vankampen.py", line 334, in sage.schemes.curves.zariski_vankampen.followstrand
Failed example:
    followstrand(f, [fup, fdown], x0, x1, -1.0)
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.curves.zariski_vankampen.followstrand[6]>", line 1, in <module>
        followstrand(f, [fup, fdown], x0, x1, -RealNumber('1.0'))
    NameError: name 'followstrand' is not defined
**********************************************************************
1 item had failures:
   1 of   8 in sage.schemes.curves.zariski_vankampen.followstrand
    [100 tests, 1 failure, 0.24 s]
----------------------------------------------------------------------
sage -t --long --warn-long 43.0 --random-seed=93097112693405690428202520811084416543 src/sage/schemes/curves/zariski_vankampen.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_455277.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-09-27T22:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455277",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_455278.json:
```json
{
    "body": "I have the branch installed in my laptop (`singular`) and in the computer in the office (`zariski`) in both cases the branch is merged with the last develop branch. In `singular` the same test as above passed with no problem, in `zariski` it gave the same error. After reinstalling `sirocco-2.1.0` (which was installed) the test passed. It was not in the mirrors I got it from https://github.com/miguelmarco/SIROCCO2/releases/download/2.1.0/libsirocco-2.1.0.tar.gz",
    "created_at": "2021-09-28T06:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455278",
    "user": "@enriqueartal"
}
```

I have the branch installed in my laptop (`singular`) and in the computer in the office (`zariski`) in both cases the branch is merged with the last develop branch. In `singular` the same test as above passed with no problem, in `zariski` it gave the same error. After reinstalling `sirocco-2.1.0` (which was installed) the test passed. It was not in the mirrors I got it from https://github.com/miguelmarco/SIROCCO2/releases/download/2.1.0/libsirocco-2.1.0.tar.gz



---

archive/issue_comments_455279.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T08:23:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455279",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455280.json:
```json
{
    "body": "Just a missing `# optional - sirocco` tag. Now fully tested both with and without sirocco installed.",
    "created_at": "2021-09-28T08:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455280",
    "user": "@tscrim"
}
```

Just a missing `# optional - sirocco` tag. Now fully tested both with and without sirocco installed.



---

archive/issue_comments_455281.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-09-28T08:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455281",
    "user": "@tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_455282.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-09T11:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31853#issuecomment-455282",
    "user": "@vbraun"
}
```

Resolution: fixed
