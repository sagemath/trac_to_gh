# Issue 31974: Test ticket: Upgrade FLINT to 2.8.0

Issue created by migration from https://trac.sagemath.org/ticket/32211

Original creator: mkoeppe

Original creation time: 2021-07-16 16:44:51

CC:  slelievre




---

Comment by mkoeppe created at 2021-07-16 17:20:04

New commits:


---

Comment by git created at 2021-07-16 20:51:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-17 04:58:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-17 20:56:46

After switching to the `cmake` build system:

Failure on `ubuntu-trusty-standard` (where Sage rejects system `ntl`), likely because FLINT accepts system NTL:

```
-- Detecting CXX compile features - done
-- Found GMP: /usr/include/x86_64-linux-gnu (Required is at least version "6.0.0") 
-- Found MPFR: /usr/include (Required is at least version "1.0.0") 
-- Found NTL: /usr/lib/libntl.so  
-- Found PythonInterp: /usr/bin/python (found version "2.7.6") 
-- Found CBLAS: /usr/include  
...
lib/libflint.so.16.1.0: undefined reference to `_ntl_gscompare(_ntl_gbigint_body*, long)'
lib/libflint.so.16.1.0: undefined reference to `_ntl_gmod(_ntl_gbigint_body*, _ntl_gbigint_body*, _ntl_gbigint_body**)'
lib/libflint.so.16.1.0: undefined reference to `_ntl_gfree(_ntl_gbigint_body*)'
lib/libflint.so.16.1.0: undefined reference to `_ntl_gsetlength(_ntl_gbigint_body**, long)'
lib/libflint.so.16.1.0: undefined reference to `mpfr_rootn_ui'
lib/libflint.so.16.1.0: undefined reference to `NTL::TerminalError(char const*)'
collect2: error: ld returned 1 exit status
make[5]: *** [bin/test-t-umul_ppmm] Error 1
```

(`ubuntu-trusty-minimal`, i.e., without installation of system `ntl`, is OK)



Likewise `ubuntu-xenial`, `debian-jessie`, `debian-stretch`, etc.


---

Comment by dimpase created at 2021-11-03 14:15:25

Flint 2.8.3 is out, please update.


---

Comment by slelievre created at 2021-11-12 17:15:09

Changing keywords from "" to "upgrade, arb, flint".


---

Comment by @kliem created at 2021-11-18 08:49:00

Replying to [comment:6 mkoeppe]:
> After switching to the `cmake` build system:
> 
> Failure on `ubuntu-trusty-standard` (where Sage rejects system `ntl`), likely because FLINT accepts system NTL:
> {{{
> -- Detecting CXX compile features - done
> -- Found GMP: /usr/include/x86_64-linux-gnu (Required is at least version "6.0.0") 
> -- Found MPFR: /usr/include (Required is at least version "1.0.0") 
> -- Found NTL: /usr/lib/libntl.so  
> -- Found PythonInterp: /usr/bin/python (found version "2.7.6") 
> -- Found CBLAS: /usr/include  
> ...
> lib/libflint.so.16.1.0: undefined reference to `_ntl_gscompare(_ntl_gbigint_body*, long)'
> lib/libflint.so.16.1.0: undefined reference to `_ntl_gmod(_ntl_gbigint_body*, _ntl_gbigint_body*, _ntl_gbigint_body**)'
> lib/libflint.so.16.1.0: undefined reference to `_ntl_gfree(_ntl_gbigint_body*)'
> lib/libflint.so.16.1.0: undefined reference to `_ntl_gsetlength(_ntl_gbigint_body**, long)'
> lib/libflint.so.16.1.0: undefined reference to `mpfr_rootn_ui'
> lib/libflint.so.16.1.0: undefined reference to `NTL::TerminalError(char const*)'
> collect2: error: ld returned 1 exit status
> make[5]: *** [bin/test-t-umul_ppmm] Error 1
> }}}
> (`ubuntu-trusty-minimal`, i.e., without installation of system `ntl`, is OK)
> 
> 
> 
> Likewise `ubuntu-xenial`, `debian-jessie`, `debian-stretch`, etc.
> 

According to `CMake/FindNTL.cmake` it accepts hints, namely by setting `$ENV{NTLDIR}`. It seems the same holds for the other packages.


---

Comment by @kliem created at 2021-11-18 09:22:02

New commits:


---

Comment by dimpase created at 2021-11-18 09:39:31

What are these "unreleased changes in Singular"?


---

Comment by dimpase created at 2021-11-18 09:40:35

Either these should be a Singular patch, or this should be removed in the ticket description.


---

Comment by @kliem created at 2021-11-18 17:42:07

Works locally for me, however I had to distclean.


---

Comment by git created at 2021-11-18 20:26:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-19 10:01:33

Are we upgrading arb here, too?


---

Comment by mkoeppe created at 2021-11-19 18:19:05

Replying to [comment:21 dimpase]:
> Either these should be a Singular patch, or this should be removed in the ticket description.

They have just tagged `Release-4-2-1p2`. "update for using FLINT 2.8.x" is a News item there, I don't know the details. We should probably do this update


---

Comment by mkoeppe created at 2021-11-19 18:41:43

I've opened #32907 for the Singular upgrade


---

Comment by @kliem created at 2021-11-19 22:15:15

Looks like we need to push the minimal version of NTL required, I'm not sure what is needed here:


```
   [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `_ntl_gscompare(_ntl_gbigint_body*, long)'
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `_ntl_gmod(_ntl_gbigint_body*, _ntl_gbigint_body*, _ntl_gbigint_body**)'
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `_ntl_gfree(_ntl_gbigint_body*)'
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `_ntl_gsetlength(_ntl_gbigint_body**, long)'
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `mpfr_rootn_ui'
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `NTL::TerminalError(char const*)'
```


And similar other failures.

Centos complains about:


```
   [flint-2.8.4]   make[5]: *** [CMakeFiles/fq_nmod_poly_factor-test-t-iterated_frobenius_preinv.dir/build.make:103: bin/fq_nmod_poly_factor-test-t-iterated_frobenius_preinv] Error 1
  [flint-2.8.4]   make[5]: Target 'CMakeFiles/fq_nmod_poly_factor-test-t-iterated_frobenius_preinv.dir/build' not remade because of errors.
  [flint-2.8.4]   make[4]: *** [CMakeFiles/Makefile2:63248: CMakeFiles/fq_nmod_poly_factor-test-t-iterated_frobenius_preinv.dir/all] Error 2
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `mpfr_rootn_ui'
  [flint-2.8.4]   collect2: error: ld returned 1 exit status
  [flint-2.8.4]   make[5]: *** [CMakeFiles/fq_poly-test-t-powmod_fmpz_binexp_preinv.dir/build.make:103: bin/fq_poly-test-t-powmod_fmpz_binexp_preinv] Error 1
  [flint-2.8.4]   make[5]: Target 'CMakeFiles/fq_poly-test-t-powmod_fmpz_binexp_preinv.dir/build' not remade because of errors.
  [flint-2.8.4]   make[4]: *** [CMakeFiles/Makefile2:63221: CMakeFiles/fq_poly-test-t-powmod_fmpz_binexp_preinv.dir/all] Error 2
  [flint-2.8.4]   lib/libflint.so.16.1.4: undefined reference to `mpfr_rootn_ui'
```


Apparently centos has an old version of mpfr.


---

Comment by @kliem created at 2021-11-19 22:36:05

Replying to [comment:18 gh-kliem]:
> Replying to [comment:6 mkoeppe]:
> > After switching to the `cmake` build system:
> > 
> > Failure on `ubuntu-trusty-standard` (where Sage rejects system `ntl`), likely because FLINT accepts system NTL:
> > {{{
> > -- Detecting CXX compile features - done
> > -- Found GMP: /usr/include/x86_64-linux-gnu (Required is at least version "6.0.0") 
> > -- Found MPFR: /usr/include (Required is at least version "1.0.0") 
> > -- Found NTL: /usr/lib/libntl.so  
> > -- Found PythonInterp: /usr/bin/python (found version "2.7.6") 
> > -- Found CBLAS: /usr/include  
> > ...
> > lib/libflint.so.16.1.0: undefined reference to `_ntl_gscompare(_ntl_gbigint_body*, long)'
> > lib/libflint.so.16.1.0: undefined reference to `_ntl_gmod(_ntl_gbigint_body*, _ntl_gbigint_body*, _ntl_gbigint_body**)'
> > lib/libflint.so.16.1.0: undefined reference to `_ntl_gfree(_ntl_gbigint_body*)'
> > lib/libflint.so.16.1.0: undefined reference to `_ntl_gsetlength(_ntl_gbigint_body**, long)'
> > lib/libflint.so.16.1.0: undefined reference to `mpfr_rootn_ui'
> > lib/libflint.so.16.1.0: undefined reference to `NTL::TerminalError(char const*)'
> > collect2: error: ld returned 1 exit status
> > make[5]: *** [bin/test-t-umul_ppmm] Error 1
> > }}}
> > (`ubuntu-trusty-minimal`, i.e., without installation of system `ntl`, is OK)
> > 
> > 
> > 
> > Likewise `ubuntu-xenial`, `debian-jessie`, `debian-stretch`, etc.
> > 
> 
> According to `CMake/FindNTL.cmake` it accepts hints, namely by setting `$ENV{NTLDIR}`. It seems the same holds for the other packages.

Ok, I really don't know how this works with cmake.

E.g. with mpfr flint does:


```
find_path(MPFR_INCLUDE_DIRS NAMES mpfr.h PATHS $ENV{GMPDIR} $ENV{MPFRDIR} ${INCLUDE_INSTALL_DIR})    
```



---

Comment by git created at 2021-11-20 14:43:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-11-29 08:05:45

Somehow `make build` after upgrading or downgrading flint doesn't work:


```
  File "sage/rings/polynomial/polynomial_element.pyx", line 67, in init sage.rings.polynomial.polynomial_element (build/cythonized/sage/rings/polynomial/polynomial_element.c:107015)
  File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_ring.py", line 154, in <module>
    import sage.rings.polynomial.polynomial_element_generic as polynomial_element_generic
  File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_element_generic.py", line 1556, in <module>
    from sage.rings.polynomial.polynomial_rational_flint import Polynomial_rational_flint
ImportError: libflint.so.16: cannot open shared object file: No such file or directory
```


Running `make build-clean` helped.


---

Comment by mkoeppe created at 2022-02-01 00:29:03

Changing priority from major to critical.


---

Comment by fbissey created at 2022-02-01 07:08:33

Needs rebasing.


---

Comment by slelievre created at 2022-02-01 08:31:02

Take the opportunity to upgrade to Arb 2.22.1?


---

Comment by mkoeppe created at 2022-02-01 09:03:28

Yes, that's probably a good idea


---

Comment by mkoeppe created at 2022-02-03 00:07:22

New commits:


---

Comment by mkoeppe created at 2022-02-03 00:07:51

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-02-04 01:16:42

I see doctest errors (numerical noise) in e.g. here

```
File "src/sage/rings/real_arb.pyx", line 3509, in sage.rings.real_arb.RealBall.erf
Failed example:
    RBF(1/2).erf()
Expected:
    [0.520499877813047 +/- 6.10e-16]
Got:
    [0.520499877813047 +/- 5.93e-16]
```

(this is on Debian 11,x86_64)


---

Comment by dimpase created at 2022-02-04 16:14:02

#33189 is needed here, so that comment:43 no longer applies.


---

Comment by dimpase created at 2022-02-04 16:53:07

lgtm


---

Comment by dimpase created at 2022-02-04 16:53:07

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-02-04 17:48:17

Thanks.


---

Comment by vbraun created at 2022-02-07 15:35:55

See https://github.com/vbraun/sage/runs/5086538238


---

Comment by vbraun created at 2022-02-07 15:35:55

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2022-02-07 15:58:04

Volker, you did not merge the dependency, #33189, that's why you got errors, e.g. here:
https://github.com/vbraun/sage/blob/7b26bb58475d9bc707bc9ed7d2a63351f2f4686c/src/sage/rings/real_arb.pyx#L3509

It should be 

```
sage: RBF(1/2).erf() # abs tol 1e-16
```

and not

```
sage: RBF(1/2).erf()
```

as in the branch you're testing.


---

Comment by dimpase created at 2022-02-07 15:58:04

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2022-02-07 16:13:29

When I added #33189 and set this to positive review, #33189 was already marked as merged,so I don't really understand how it was tested without it in the end.


---

Comment by vbraun created at 2022-02-12 22:07:05

Resolution: fixed
