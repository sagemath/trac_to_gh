# Issue 28582: disable problematic external doctests

archive/issues_028582.json:
```json
{
    "body": "This ticket marks the doctests in `sage.doctest.external` involving the standard interfaces to external software as `not tested` and some tests in the Mathematica interface as `mathematicafrontend`.\n\nIn particular, this is a workaround for the following problem:\n\nWhenever Sage runs the tests for src/sage/doctest/external.py, it tries to run a computation in Matlab. Even though the interface sort of works in interactive mode, it does not work at all during doctest mode, causing Matlab to crash which results in two numbered log files being written to the user home directory such as `matlab_crash_dump.281119-1` and `java.log.18975`. When running a patchbot, the home directory gets flooded by these files.\n\nRegardless of the Matlab issue, external software like this should not be invoked during normal test runs, unless explicitly enabled when running `all` or `external` tests. Especially this applies to software that requires a license to run.\n\nThe doctests this ticket disables in `sage.doctest.external` invoke functions that catch all exceptions and produce random output, so there is not much value in running those tests at all.\n\nThe Matlab problem still persists when running external doctests, but in that case failures are to be expected.\n\n-----\n\nA secondary problem is solved in the Mathematica interface:\n\nUsually, the Mathematica interface interacts with the program `WolframKernel`. However, a few doctests related to rendering result in the frontend program `Mathematica` to be launched by the WolframKernel. This is because graphics cannot be exported without access to a frontend, according to [this question](https://mathematica.stackexchange.com/questions/5026/generating-figures-over-remote-connection-using-terminal).\n\nThese instances of `Mathematica` do not always seem to get closed properly. When running a patchbot, this leads to a growing number of orphan processes of `Mathematica` which do not seem to react to a SIGTERM signal.\n\nMarking the doctests as `mathematicafrontend` effectively disables them. This solution had already been applied by #23112 for one of the doctests in the file.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28819\n\n",
    "created_at": "2019-11-29T07:02:50Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "disable problematic external doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28582",
    "user": "@mwageringel"
}
```
This ticket marks the doctests in `sage.doctest.external` involving the standard interfaces to external software as `not tested` and some tests in the Mathematica interface as `mathematicafrontend`.

In particular, this is a workaround for the following problem:

Whenever Sage runs the tests for src/sage/doctest/external.py, it tries to run a computation in Matlab. Even though the interface sort of works in interactive mode, it does not work at all during doctest mode, causing Matlab to crash which results in two numbered log files being written to the user home directory such as `matlab_crash_dump.281119-1` and `java.log.18975`. When running a patchbot, the home directory gets flooded by these files.

Regardless of the Matlab issue, external software like this should not be invoked during normal test runs, unless explicitly enabled when running `all` or `external` tests. Especially this applies to software that requires a license to run.

The doctests this ticket disables in `sage.doctest.external` invoke functions that catch all exceptions and produce random output, so there is not much value in running those tests at all.

The Matlab problem still persists when running external doctests, but in that case failures are to be expected.

-----

A secondary problem is solved in the Mathematica interface:

Usually, the Mathematica interface interacts with the program `WolframKernel`. However, a few doctests related to rendering result in the frontend program `Mathematica` to be launched by the WolframKernel. This is because graphics cannot be exported without access to a frontend, according to [this question](https://mathematica.stackexchange.com/questions/5026/generating-figures-over-remote-connection-using-terminal).

These instances of `Mathematica` do not always seem to get closed properly. When running a patchbot, this leads to a growing number of orphan processes of `Mathematica` which do not seem to react to a SIGTERM signal.

Marking the doctests as `mathematicafrontend` effectively disables them. This solution had already been applied by #23112 for one of the doctests in the file.


Issue created by migration from https://trac.sagemath.org/ticket/28819





---

archive/issue_comments_403475.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-11-29T07:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403475",
    "user": "@mwageringel"
}
```

New commits:



---

archive/issue_comments_403476.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-29T20:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403476",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403477.json:
```json
{
    "body": "Changing keywords from \"\" to \"matlab, mathematica\".",
    "created_at": "2019-11-29T20:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403477",
    "user": "@mwageringel"
}
```

Changing keywords from "" to "matlab, mathematica".



---

archive/issue_comments_403478.json:
```json
{
    "body": "I let the patchbot run on this ticket a couple of times and it works as intended.",
    "created_at": "2019-11-29T20:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403478",
    "user": "@mwageringel"
}
```

I let the patchbot run on this ticket a couple of times and it works as intended.



---

archive/issue_comments_403479.json:
```json
{
    "body": "> Regardless of the Matlab issue, external software like this should not be invoked during normal test runs, unless explicitly enabled when running all > or external tests. Especially this applies to software that requires a license to run.\n\nThen.., isn't this a right solution for the problems?\n\n```\n        sage: from sage.doctest.external import has_matlab\n        sage: has_matlab()  # optional -- matlab\n        True  \n```\n",
    "created_at": "2019-12-05T05:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403479",
    "user": "@kwankyu"
}
```

> Regardless of the Matlab issue, external software like this should not be invoked during normal test runs, unless explicitly enabled when running all > or external tests. Especially this applies to software that requires a license to run.

Then.., isn't this a right solution for the problems?

```
        sage: from sage.doctest.external import has_matlab
        sage: has_matlab()  # optional -- matlab
        True  
```




---

archive/issue_comments_403480.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-05T19:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403480",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403481.json:
```json
{
    "body": "Replying to [comment:4 klee]:\n> Then.., isn't this a right solution for the problems?\n> {{{\n>         sage: from sage.doctest.external import has_matlab\n>         sage: has_matlab()  # optional -- matlab\n>         True  \n> }}}\n\nIndeed, that also works and has the advantage that the tests are not deactivated entirely. I have updated the branch accordingly and let the patchbot run on it. It works as intended on my end.",
    "created_at": "2019-12-05T20:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403481",
    "user": "@mwageringel"
}
```

Replying to [comment:4 klee]:
> Then.., isn't this a right solution for the problems?
> {{{
>         sage: from sage.doctest.external import has_matlab
>         sage: has_matlab()  # optional -- matlab
>         True  
> }}}

Indeed, that also works and has the advantage that the tests are not deactivated entirely. I have updated the branch accordingly and let the patchbot run on it. It works as intended on my end.



---

archive/issue_comments_403482.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-06T03:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403482",
    "user": "@kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403483.json:
```json
{
    "body": "Thanks. It looks good to me.",
    "created_at": "2019-12-06T03:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403483",
    "user": "@kwankyu"
}
```

Thanks. It looks good to me.



---

archive/issue_comments_403484.json:
```json
{
    "body": "Thank you for the review.",
    "created_at": "2019-12-06T08:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403484",
    "user": "@mwageringel"
}
```

Thank you for the review.



---

archive/issue_comments_403485.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-12-06T21:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403485",
    "user": "@kwankyu"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_403486.json:
```json
{
    "body": "I now realized that the tag should be \n\n```\nsage: has_matlab()  # random, optional -- matlab\nTrue\n```\n\nbecause the doctest may fail when we do\n\n```\nsage -bt --optional=sage,optional,matlab src/sage/doctest/external.py \n```\n",
    "created_at": "2019-12-06T22:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403486",
    "user": "@kwankyu"
}
```

I now realized that the tag should be 

```
sage: has_matlab()  # random, optional -- matlab
True
```

because the doctest may fail when we do

```
sage -bt --optional=sage,optional,matlab src/sage/doctest/external.py 
```




---

archive/issue_comments_403487.json:
```json
{
    "body": "Replying to [comment:10 klee]:\n> because the doctest may fail when we do\n> {{{\n> sage -bt --optional=sage,optional,matlab src/sage/doctest/external.py \n> }}}\n\nWell, that is just because the Matlab interface is broken. Running the Matlab tests on `src/sage/interfaces/matlab.py` fails for the same reason, currently. When the interface is fixed, the function `has_matlab()` should always return True \u2013 otherwise the doctest would reveal an actual bug in `has_matlab()`.\n\nUntil then, I think it is fine if the doctest fails when the optional `matlab` flag is set, as it correctly indicates a problem. At this point, nobody seems to care much about the Matlab interface nor run its tests, anyway.",
    "created_at": "2019-12-06T22:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403487",
    "user": "@mwageringel"
}
```

Replying to [comment:10 klee]:
> because the doctest may fail when we do
> {{{
> sage -bt --optional=sage,optional,matlab src/sage/doctest/external.py 
> }}}

Well, that is just because the Matlab interface is broken. Running the Matlab tests on `src/sage/interfaces/matlab.py` fails for the same reason, currently. When the interface is fixed, the function `has_matlab()` should always return True – otherwise the doctest would reveal an actual bug in `has_matlab()`.

Until then, I think it is fine if the doctest fails when the optional `matlab` flag is set, as it correctly indicates a problem. At this point, nobody seems to care much about the Matlab interface nor run its tests, anyway.



---

archive/issue_comments_403488.json:
```json
{
    "body": "> When the interface is fixed, the function `has_matlab()` should always return True \u2013 otherwise the doctest would reveal an actual bug in `has_matlab()`.\n\nNo. If you don't have matlab, then it should return False. Not only for matlab.  Let's say you don't have magma, then\n\n```\nsage: has_magma()  # optional -- magma\nTrue\n```\n\nwould fail if you run, for whatever reason,\n\n```\nsage -bt --optional=sage,optional,magma src/sage/doctest/external.py \n```\n",
    "created_at": "2019-12-07T09:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403488",
    "user": "@kwankyu"
}
```

> When the interface is fixed, the function `has_matlab()` should always return True – otherwise the doctest would reveal an actual bug in `has_matlab()`.

No. If you don't have matlab, then it should return False. Not only for matlab.  Let's say you don't have magma, then

```
sage: has_magma()  # optional -- magma
True
```

would fail if you run, for whatever reason,

```
sage -bt --optional=sage,optional,magma src/sage/doctest/external.py 
```




---

archive/issue_comments_403489.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-12-07T11:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403489",
    "user": "@mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_403490.json:
```json
{
    "body": "Replying to [comment:12 klee]:\n> Let's say you don't have magma, then\n> {{{\n> sage: has_magma()  # optional -- magma\n> True\n> }}}\n> would fail\n\nEvery doctest in Sage tagged `optional -- magma` will fail if one does not have Magma, so this is expected. I do not have a strong opinion about this though, as it still solves the problem reported in this ticket, so here is a branch where the doctests in question are marked `random`.\n----\nNew commits:",
    "created_at": "2019-12-07T11:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403490",
    "user": "@mwageringel"
}
```

Replying to [comment:12 klee]:
> Let's say you don't have magma, then
> {{{
> sage: has_magma()  # optional -- magma
> True
> }}}
> would fail

Every doctest in Sage tagged `optional -- magma` will fail if one does not have Magma, so this is expected. I do not have a strong opinion about this though, as it still solves the problem reported in this ticket, so here is a branch where the doctests in question are marked `random`.
----
New commits:



---

archive/issue_comments_403491.json:
```json
{
    "body": "Replying to [comment:13 gh-mwageringel]:\n> Replying to [comment:12 klee]:\n> > Let's say you don't have magma, then\n> > {{{\n> > sage: has_magma()  # optional -- magma\n> > True\n> > }}}\n> > would fail\n> \n> Every doctest in Sage tagged `optional -- magma` will fail if one does not have Magma\n\nBut unlike every other doctest with `optional -- magma`, by its nature, `has_magma()` should work without Magma.  I think `optional -- magma` is used here simply as a trick to turn it off unless one explicitly wants to test it.  \n\n> I do not have a strong opinion about this though, as it still solves the problem reported in this ticket, so here is a branch where the doctests in question are marked `random`.\n\nThanks.",
    "created_at": "2019-12-07T13:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403491",
    "user": "@kwankyu"
}
```

Replying to [comment:13 gh-mwageringel]:
> Replying to [comment:12 klee]:
> > Let's say you don't have magma, then
> > {{{
> > sage: has_magma()  # optional -- magma
> > True
> > }}}
> > would fail
> 
> Every doctest in Sage tagged `optional -- magma` will fail if one does not have Magma

But unlike every other doctest with `optional -- magma`, by its nature, `has_magma()` should work without Magma.  I think `optional -- magma` is used here simply as a trick to turn it off unless one explicitly wants to test it.  

> I do not have a strong opinion about this though, as it still solves the problem reported in this ticket, so here is a branch where the doctests in question are marked `random`.

Thanks.



---

archive/issue_comments_403492.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-07T13:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403492",
    "user": "@kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403493.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-09T22:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28582#issuecomment-403493",
    "user": "@vbraun"
}
```

Resolution: fixed
