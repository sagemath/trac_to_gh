# Issue 28582: disable problematic external doctests

Issue created by migration from https://trac.sagemath.org/ticket/28819

Original creator: @mwageringel

Original creation time: 2019-11-29 07:02:50

This ticket marks the doctests in `sage.doctest.external` involving the standard interfaces to external software as `not tested` and some tests in the Mathematica interface as `mathematicafrontend`.

In particular, this is a workaround for the following problem:

Whenever Sage runs the tests for src/sage/doctest/external.py, it tries to run a computation in Matlab. Even though the interface sort of works in interactive mode, it does not work at all during doctest mode, causing Matlab to crash which results in two numbered log files being written to the user home directory such as `matlab_crash_dump.281119-1` and `java.log.18975`. When running a patchbot, the home directory gets flooded by these files.

Regardless of the Matlab issue, external software like this should not be invoked during normal test runs, unless explicitly enabled when running `all` or `external` tests. Especially this applies to software that requires a license to run.

The doctests this ticket disables in `sage.doctest.external` invoke functions that catch all exceptions and produce random output, so there is not much value in running those tests at all.

The Matlab problem still persists when running external doctests, but in that case failures are to be expected.

-----

A secondary problem is solved in the Mathematica interface:

Usually, the Mathematica interface interacts with the program `WolframKernel`. However, a few doctests related to rendering result in the frontend program `Mathematica` to be launched by the WolframKernel. This is because graphics cannot be exported without access to a frontend, according to [this question](https://mathematica.stackexchange.com/questions/5026/generating-figures-over-remote-connection-using-terminal).

These instances of `Mathematica` do not always seem to get closed properly. When running a patchbot, this leads to a growing number of orphan processes of `Mathematica` which do not seem to react to a SIGTERM signal.

Marking the doctests as `mathematicafrontend` effectively disables them. This solution had already been applied by #23112 for one of the doctests in the file.



---

Comment by @mwageringel created at 2019-11-29 07:16:02

New commits:


---

Comment by @mwageringel created at 2019-11-29 20:09:18

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-11-29 20:09:18

Changing keywords from "" to "matlab, mathematica".


---

Comment by @mwageringel created at 2019-11-29 20:09:18

I let the patchbot run on this ticket a couple of times and it works as intended.


---

Comment by klee created at 2019-12-05 05:15:13

> Regardless of the Matlab issue, external software like this should not be invoked during normal test runs, unless explicitly enabled when running all > or external tests. Especially this applies to software that requires a license to run.

Then.., isn't this a right solution for the problems?

```
        sage: from sage.doctest.external import has_matlab
        sage: has_matlab()  # optional -- matlab
        True  
```



---

Comment by git created at 2019-12-05 19:06:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2019-12-05 20:34:26

Replying to [comment:4 klee]:
> Then.., isn't this a right solution for the problems?
> {{{
>         sage: from sage.doctest.external import has_matlab
>         sage: has_matlab()  # optional -- matlab
>         True  
> }}}

Indeed, that also works and has the advantage that the tests are not deactivated entirely. I have updated the branch accordingly and let the patchbot run on it. It works as intended on my end.


---

Comment by klee created at 2019-12-06 03:52:01

Changing status from needs_review to positive_review.


---

Comment by klee created at 2019-12-06 03:52:01

Thanks. It looks good to me.


---

Comment by @mwageringel created at 2019-12-06 08:03:21

Thank you for the review.


---

Comment by klee created at 2019-12-06 21:52:54

Changing status from positive_review to needs_work.


---

Comment by klee created at 2019-12-06 22:04:58

I now realized that the tag should be 

```
sage: has_matlab()  # random, optional -- matlab
True
```

because the doctest may fail when we do

```
sage -bt --optional=sage,optional,matlab src/sage/doctest/external.py 
```



---

Comment by @mwageringel created at 2019-12-06 22:45:46

Replying to [comment:10 klee]:
> because the doctest may fail when we do
> {{{
> sage -bt --optional=sage,optional,matlab src/sage/doctest/external.py 
> }}}

Well, that is just because the Matlab interface is broken. Running the Matlab tests on `src/sage/interfaces/matlab.py` fails for the same reason, currently. When the interface is fixed, the function `has_matlab()` should always return True – otherwise the doctest would reveal an actual bug in `has_matlab()`.

Until then, I think it is fine if the doctest fails when the optional `matlab` flag is set, as it correctly indicates a problem. At this point, nobody seems to care much about the Matlab interface nor run its tests, anyway.


---

Comment by klee created at 2019-12-07 09:03:43

> When the interface is fixed, the function `has_matlab()` should always return True – otherwise the doctest would reveal an actual bug in `has_matlab()`.

No. If you don't have matlab, then it should return False. Not only for matlab.  Let's say you don't have magma, then

```
sage: has_magma()  # optional -- magma
True
```

would fail if you run, for whatever reason,

```
sage -bt --optional=sage,optional,magma src/sage/doctest/external.py 
```



---

Comment by @mwageringel created at 2019-12-07 11:51:40

Changing status from needs_work to needs_review.


---

Comment by @mwageringel created at 2019-12-07 11:51:40

Replying to [comment:12 klee]:
> Let's say you don't have magma, then
> {{{
> sage: has_magma()  # optional -- magma
> True
> }}}
> would fail

Every doctest in Sage tagged `optional -- magma` will fail if one does not have Magma, so this is expected. I do not have a strong opinion about this though, as it still solves the problem reported in this ticket, so here is a branch where the doctests in question are marked `random`.
----
New commits:


---

Comment by klee created at 2019-12-07 13:25:53

Replying to [comment:13 gh-mwageringel]:
> Replying to [comment:12 klee]:
> > Let's say you don't have magma, then
> > {{{
> > sage: has_magma()  # optional -- magma
> > True
> > }}}
> > would fail
> 
> Every doctest in Sage tagged `optional -- magma` will fail if one does not have Magma

But unlike every other doctest with `optional -- magma`, by its nature, `has_magma()` should work without Magma.  I think `optional -- magma` is used here simply as a trick to turn it off unless one explicitly wants to test it.  

> I do not have a strong opinion about this though, as it still solves the problem reported in this ticket, so here is a branch where the doctests in question are marked `random`.

Thanks.


---

Comment by klee created at 2019-12-07 13:25:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-12-09 22:54:30

Resolution: fixed
