# Issue 26403: Meta-ticket: make graphs compatible with Python 3

Issue created by migration from Trac.

Original creator: dcoudert

Original creation time: 2018-11-05 10:01:16

CC:  tscrim chapoton jhpalmieri @jfraymond

Keywords: py3, graph

This ticket is used to keep track of the progress towards python3 in graphs.


*Major issues*
- methods `.vertices()` and `.edges()` use sort by default
- direct comparison of vertex labels (e.g., in method `iterator_edges` of `base/sparse_graph.pyx`)


*Done*
- #26621 avoid using `.vertices()` and `.edges()` in `bliss.pyx`


---

Comment by chapoton created at 2018-11-05 12:48:13

Changing component from group theory to graph theory.


---

Comment by dcoudert created at 2018-11-29 08:31:56

I'm answering here the question of [#26567#comment:9](https://trac.sagemath.org/ticket/26567#comment:9) about how to make `iterator_edges` of `sparse_graph.pyx` py3 compatible, and if something similar to #26567 for `dense_graph.pyx` can be done for `sparse_graph.pyx`.

So far, I don't know what's the best option.
- just stop ordering end vertices of edges as well as vertices in general, but it shall break many algorithms
- change the way we use graphs to ensure that internally vertices are all integers, and then use method `get_vertex_label` (that we already have but rarely use) only when the user wants to display lists of vertices/edges. I think networkx is now doing something like that.
- try to mimic the py2 sorting using try... except statements, but this might induce some slowdown.
- maintain an ordering of the vertices and a mapping  from vertices to integers used when sorting list of vertices and the end vertices of edges. This ordering could be updated at vertex insertion/deletion time.

All these options have pros and cons, and each of them will require a significant amount of work to fix doctests and algorithms. 

In the last months, we did significant progresses on reducing the dependency on ordering, but this is not enough and this central issue is very complex to fix. Which is the best option in the short/long term ?


---

Comment by chapoton created at 2018-12-06 13:26:24

May I ask in which ticket, if any, you do touch the "is_isomorphic" method ?

I would really like this to work with python 3:

```python
sage: G = Graph()
sage: G.add_edge((1,'a'))
sage: G
Graph on 2 vertices
sage: G.is_isomorphic(G)
```



---

Comment by dcoudert created at 2018-12-06 13:51:49

I have not touched any method related to isomorphism. I have only opened a ticket to show a bug with `canonical_label` #26800.


---

Comment by chapoton created at 2018-12-06 13:53:22

ok.. Then either we wait for all these tickets to be closed (and this may take a lot of time) or we can try to fix this isomorphism problem now..


---

Comment by dcoudert created at 2018-12-06 14:03:18

We can start working on it. In the worst case, I will have to fix some merge conflicts.


---

Comment by chapoton created at 2018-12-06 16:59:37

I have made a first tentative at `u/chapoton/graphe_iso`


---

Comment by dcoudert created at 2018-12-06 17:28:55

I'm not good enough with git to know what you have changed, except the first 2 calls to `.vertices()`. It seems ok. Note that the function has 2 more calls to `.vertices()` that are clearly useless. I think the proposed change fix some doctests, so you should open a ticket.


---

Comment by chapoton created at 2018-12-06 19:36:40

I made #26846 for graph isomorphism


---

Comment by chapoton created at 2018-12-30 10:35:03

Salut !

* we should probably add #26971 somewhere

* where are the plot methods handled ?


---

Comment by dcoudert created at 2018-12-30 10:40:49

See #26469, #26478, #26480, #26484.

I will check #26971 soon.


---

Comment by chapoton created at 2018-12-30 10:44:33

Concerning plot, there are still problems in py3 when plotting posets. This point to the remaining

```
File "/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/graphs/graph_plot.py", line 255, in __init__
        self._nodelist = graph.vertices()
```



---

Comment by dcoudert created at 2019-01-03 15:14:17

With #27008, #27009 and #27010, all remaining doctest errors in `graph.py` concern the order in which solutions are displayed (not always the same in py2 and py3).


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by jhpalmieri created at 2019-01-15 21:52:00

I would like to ask some questions about how to deal with simplicial complexes.

- The `is_isomorphic` method for simplicial complexes translates each complex to a graph and then asks whether they are isomorphic, preserving edge labels. Some edges are labeled and some are not: the edge labels look like

```
sage: g.edge_labels()
[None,
 None,
 'special_edge',
 'special_edge']
```

 This fails in Python 3 because it tries to sort edges, and it can't sort `str` and `NoneType`. It is easy enough to provide labels in this case, but should the graph `is_isomorphic` method deal well with graphs where some edges have labels and some don't? (I don't have an opinion and I will fix the simplicial complex code separately.)

- Again with the `is_isomorphic` method for simplicial complexes: it defines a graph with vertices labeled by the vertices of the complex and its facets, and it adds an edge between a vertex `v` and a facet `f` if `v` is in `f`. The graph code tries to sort the vertices, and since the vertices in a simplicial complex can be integers, strings, whatever, the sorting goes badly. Again, I think I can handle this for simplicial complexes by translating everything to something sortable, then sorting, and then translating back at the end, but should the graph `is_isomorphic` method handle these sorts of cases better?

- Consider this:

```
sage: S1 = simplicial_complexes.Sphere(1)
sage: g = S1.wedge(S1).graph()
sage: g
Graph on 5 vertices
sage: g.vertices()
[0, 'L1', 'L2', 'R1', 'R2']
```

 In Python 3, the last line instead raises an error:

```
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-4-b2087dfc7b91> in <module>()
----> 1 g.vertices()

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/generic_graph.py in vertices(self, sort, key)
  10053             raise ValueError('sort keyword is False, yet a key function is given')
  10054         if sort:
> 10055             return sorted(list(self.vertex_iterator()), key=key)
  10056         return list(self.vertex_iterator())
  10057 

TypeError: '<' not supported between instances of 'int' and 'str'
sage: g.min_spanning_tree()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-8a025bbcbd58> in <module>()
----> 1 g.min_spanning_tree()

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/generic_graph.py in min_spanning_tree(self, weight_function, algorithm, starting_vertex, check)
   4231                 return min_spanning_tree(g,
   4232                                          weight_function=wfunction_float,
-> 4233                                          algorithm=algorithm.split("_")[0])
   4234 
   4235         if algorithm == "Prim_fringe":

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.min_spanning_tree (build/cythonized/sage/graphs/base/boost_graph.cpp:9345)()
    604 
    605 
--> 606 cpdef min_spanning_tree(g,
    607                         weight_function=None,
    608                         algorithm='Kruskal'):

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.min_spanning_tree (build/cythonized/sage/graphs/base/boost_graph.cpp:9100)()
    719     else:
    720         edges = [(int_to_vertex[<int> result[2*i]], int_to_vertex[<int> result[2*i+1]]) for i in range(n-1)]
--> 721         return [(min(e[0],e[1]), max(e[0],e[1]), g.edge_label(e[0], e[1])) for e in edges]
    722 
    723 

TypeError: '<' not supported between instances of 'int' and 'str'
```

 In Python 2, `g.min_spanning_tree()` works, while in Python 3, it raises a similar `TypeError`:

```
sage: g.min_spanning_tree()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-8a025bbcbd58> in <module>()
----> 1 g.min_spanning_tree()

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/generic_graph.py in min_spanning_tree(self, weight_function, algorithm, starting_vertex, check)
   4231                 return min_spanning_tree(g,
   4232                                          weight_function=wfunction_float,
-> 4233                                          algorithm=algorithm.split("_")[0])
   4234 
   4235         if algorithm == "Prim_fringe":

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.min_spanning_tree (build/cythonized/sage/graphs/base/boost_graph.cpp:9345)()
    604 
    605 
--> 606 cpdef min_spanning_tree(g,
    607                         weight_function=None,
    608                         algorithm='Kruskal'):

/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.6.rc1/local/lib/python3.6/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.min_spanning_tree (build/cythonized/sage/graphs/base/boost_graph.cpp:9100)()
    719     else:
    720         edges = [(int_to_vertex[<int> result[2*i]], int_to_vertex[<int> result[2*i+1]]) for i in range(n-1)]
--> 721         return [(min(e[0],e[1]), max(e[0],e[1]), g.edge_label(e[0], e[1])) for e in edges]
    722 
    723 

TypeError: '<' not supported between instances of 'int' and 'str'
```

 Once again, I could probably get around this by translating all of the vertices to something sortable and then translating back, but I do think that the graph theory code should be able to handle graphs whose vertices are a combination of `int` and `str` and anything else. I would like to put in a request for fixing this particular problem.


---

Comment by jhpalmieri created at 2019-01-15 22:15:05

Maybe one of these (the second one, I think) was taken care of by #27027.


---

Comment by jhpalmieri created at 2019-01-15 23:01:14

See #27067 for simplicial complexes fixes for the first two items.


---

Comment by dcoudert created at 2019-01-17 13:58:26

I fully agree that the graph theory code should be able to handle vertices of different types. We have done significant progresses recently, and many methods are no longer sorting vertices. But a lot remains to be done since a huge part of the code uses vertex ids instead of internal int labels. We have to find solutions for instance for listing edges as end points are currently sorted...

Note that I'm not able to try your example with py3 as this `S1.wedge(S1).graph()` already raises an error.


---

Comment by jhpalmieri created at 2019-01-17 18:08:14

First, you have all done great work with graphs, and you've made a tremendous amount of progress. Partly my questions were because I don't know whether some of these things have been done in tickets which have not yet been merged, but I think that's not the case.

Speaking of things which have not yet been merged, you need #26966 to be able to do `S1.wedge(S1).graph()`. Sorry, I hadn't realized that when I posted my example.


---

Comment by jhpalmieri created at 2019-01-17 18:17:57

Also, as I hope was clear in my questions, the first two are not critiques but honest questions: I don't know how Sage should handle those situations. The fact that things happen to work in Python 2 does not mean that they should automatically work in Python 3. For example, if you explicitly ask for isomorphisms preserving edge labels, an argument could be made that you should actually label all of the edges. The last item on my list was an explicit request, which it sounds like you agree with but also sounds like it take some work.


---

Comment by dcoudert created at 2019-01-31 14:09:44

With #26819, #27176, #27179, #27180, #27181, #27183 py3 and #27184, we fix 42 doctests in `generic_graph.py` !!!

The remainging issues are in `relabel`, `is_isomorphic` and `graph_isom_equivalent_non_edge_labeled_graph`.


---

Comment by dcoudert created at 2019-02-23 10:33:11

We have now drastically reduced the dependency to `.vertices()` and `.edges()` in the graph module (except in doctests, but we can specify `sort=True/False`). 

We must now identify the tasks to do and schedule the work.

Some issues to take care of in the graph module:
- #22349 Deprecate sorting of methods `.vertices()` and `.edges()`.
 - methods using matrices: `adjacency_matrix`, `distance_matrix`, etc. For all these methods, we can now give as input an ordering of the vertices that will be used to order rows and columns. Currently, we use `.vertices()` by default. If we switch to `list(G)` by default, we have to check that it's not breaking algorithms using these matrices.
 - methods using `.relabel()`. We must check that changing the default ordering of vertices/edges is safe. Should be ok, but we never know...
 - methods for isomorphisms were we also have issues with labels (see e.g. #27232 although the case is certainly beyond what we should reasonably do).
- Deprecate sorting of vertex labels in method `iterator_edges` of `base/sparse_graph.pyx` (so of the vertices of an edge). Deprecating this behavior is certainly a hard task. A first step could be to order the vertices according internal integer value, thus ensuring that `(u, v)` will always be ordered the same way.

And of course, changes done here will certainly break many methods in other modules...


---

Comment by dcoudert created at 2019-03-03 21:27:33

Proposal for an `EdgeView` for graphs in #27408.


---

Comment by jhpalmieri created at 2019-03-10 00:20:10

I don't know if this is a good idea or not, but see #27452 for a branch which fixes the last doctest failures in src/homology. This bypasses an issue with graphs, as mentioned above:

```
sage: S1 = simplicial_complexes.Sphere(1)
sage: g = S1.wedge(S1).graph()
sage: g
Graph on 5 vertices
sage: g.vertices()
...
TypeError: '<' not supported between instances of 'int' and 'str'
```

The branch at #27452 relabels the graph of a simplicial complex so that the vertices are sortable, before trying to compute its minimal spanning tree. Is this just sweeping things under the rug, or is it okay?


---

Comment by tscrim created at 2019-03-10 00:47:20

I think it is one way forward. It does suffer in large cases because you have to make a full copy of the simplicial complex's graph, but I don't think it is simply sweeping it under the rug. Perhaps for that a user should know better than to have complicated labels for such tests?


---

Comment by dcoudert created at 2019-03-10 10:54:31

An alternative is to (optionally) make spanning tree methods return a `Graph`, in which case there is no need to sort end vertices.


---

Comment by tscrim created at 2019-03-10 12:31:18

Replying to [comment:67 dcoudert]:
> An alternative is to (optionally) make spanning tree methods return a `Graph`, in which case there is no need to sort end vertices.

My gut reaction was that seems heavy handed. It would make sense, but I suspect the reason we don't is because it would be too expensive (relatively) to return a `(Di)Graph`. I haven't looked into this (it is too late for me to do so tonight), but just a thought.


---

Comment by dcoudert created at 2019-03-30 14:03:49

Some doctests are failing with `bliss` (not related to #27571) 

```
sage -t src/sage/graphs/generators/families.py
**********************************************************************
File "src/sage/graphs/generators/families.py", line 3191, in sage.graphs.generators.families.MathonPseudocyclicStronglyRegularGraph
Failed example:
    G3x3.automorphism_group(algorithm="bliss").order() # optional - bliss
Expected:
    27
Got:
    3
**********************************************************************
File "src/sage/graphs/generators/families.py", line 3196, in sage.graphs.generators.families.MathonPseudocyclicStronglyRegularGraph
Failed example:
    G9.automorphism_group(algorithm="bliss").order() # optional - bliss
Expected:
    9
Got:
    3
```



---

Comment by dcoudert created at 2019-07-10 11:10:35

We are almost done. We have currently 3 open tickets for the remaining failing doctests.

Needs work (contributors are more than welcome):
- #27435: failing doctest in `graph_database.py` with `interactive_query`.
- #28108: 2 `ValueError?` in `graph_generators.py` doctests with `plantri` optional package (follow up of #27948) 

Needs review / help / comment:
- #27232: fix failing doctests in `is_isomorphic`, which are the last 8 remaining failing doctests in `generic_graph.py`


---

Comment by jhpalmieri created at 2019-07-10 17:20:28

Replying to [comment:75 dcoudert]:
> We are almost done. We have currently 3 open tickets for the remaining failing doctests.
> 
> Needs work (contributors are more than welcome):
> - #27435: failing doctest in `graph_database.py` with `interactive_query`.

For this one, I would be tempted to label it `# py2` since it seems to rely on the legacy Sage notebook. I can open a ticket if that sounds like a valid approach.


---

Comment by dcoudert created at 2019-07-10 18:35:55

> > - #27435: failing doctest in `graph_database.py` with `interactive_query`.
> 
> For this one, I would be tempted to label it `# py2` since it seems to rely on the legacy Sage notebook. I can open a ticket if that sounds like a valid approach.

It is related to sage notebook, but doctests are failing only with py3... So I don't know which is the best approach. Should we try to make a little change to sagenb to make #27435 fixing the issue, although sagenb will be removed in the future (but when?) ?


---

Comment by jhpalmieri created at 2019-07-10 18:50:15

I apologize, my comments really belong on #27435. I'll continue the discussion there.


---

Comment by dcoudert created at 2019-07-29 11:06:24

All doctests in the standard graphs module are now fixed ! Thanks to all of you for your great help.

We can now check all optional packages. For instance, `plantri` has 2 failing doctests (#28108).


---

Comment by dcoudert created at 2019-08-20 14:11:58

The last failing doctests of the optional packages (benzene, bliss, buckygen, csdp, dot2tex and graphviz, gap_packages, igraph and python_igraph, mcqd, plantri, tdlib) are fixed with #27948, #28108  and #28371.


---

Comment by dcoudert created at 2020-04-18 10:18:20

it's time to close this ticket.


---

Comment by dcoudert created at 2020-04-18 10:18:20

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-04-18 17:43:35

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-04-18 17:43:35

Yes, I agree.


---

Comment by chapoton created at 2020-06-20 06:35:55

Resolution: worksforme
