# Issue 10567: Upgrade sphinx-0.9.6.p4 to sphinx-1.0.6

Issue created by migration from https://trac.sagemath.org/ticket/10620

Original creator: davidm

Original creation time: 2011-01-13 07:44:53

Assignee: mvngu

CC:  jason hivert

Keywords: sphinx uprgrade

Just made a spkg and a change to sage_autodoc in order to upgrade sphinx to the latest version. Spkg and patch attached.


---

Attachment

In 4.6.1, Sphinx was upgraded to 1.0.4.  Any new spkg should be based on the one found in #10350.


---

Comment by jason created at 2011-04-27 15:06:44

Changing status from new to needs_review.


---

Comment by jason created at 2011-04-27 15:06:44

Should this ticket be set to "needs review"?

I guess by now sphinx 1.0.7 is released.


---

Comment by kini created at 2011-04-28 05:39:44

We might want to wait for 1.1, depending on how long it will take, since 1.1 includes MathJax (hurrah!).


---

Comment by jhpalmieri created at 2011-07-23 21:48:24

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-07-23 21:48:24

The patch for sage_autodoc needs a lot more work: the file sage_autodoc should be kept in line with the file autodoc.py in sphinx/ext.  Should we somehow autogenerate this file (using patch) from autodoc.py?


---

Comment by jhpalmieri created at 2011-07-24 17:33:42

In fact, maybe we should include sage_autodoc.py in the Sphinx spkg: make a copy of autodoc.py, patch it, and write it in the sphinx/ext directory.  That would make it much easier to keep sage_autodoc.py in sync with autodoc.py. Then we just have to make this change in SAGE_ROOT/devel/sage/doc/common/conf.py:

```diff
diff --git a/doc/common/conf.py b/doc/common/conf.py
--- a/doc/common/conf.py
+++ b/doc/common/conf.py
@@ -13,7 +13,7 @@ sys.path.append(os.path.abspath(os.path.
 
 # Add any Sphinx extension module names here, as strings. They can be extensions
 # coming with Sphinx (named 'sphinx.ext.*') or your custom ones.
-extensions = ['sage_autodoc',  'sphinx.ext.graphviz',
+extensions = ['sphinx.ext.sage_autodoc',  'sphinx.ext.graphviz',
               'sphinx.ext.inheritance_diagram', 'sphinx.ext.todo',
               'sphinx.ext.intersphinx']
 # also of interest:
```



---

Comment by jason created at 2011-08-09 21:50:22

#10715 is also an "upgrade sphinx" ticket that might be considered a dup of this ticket.


---

Comment by leif created at 2011-08-09 22:38:58

And the spkg has to be rebased on that of #11659 (1.0.4.p7).


---

Comment by leif created at 2011-08-09 22:38:58

Changing keywords from "sphinx uprgrade" to "sphinx upgrade spkg autodoc".


---

Comment by leif created at 2011-08-10 19:19:57

Replying to [comment:9 leif]:
> And the spkg has to be rebased on that of #11659 (1.0.4.p7).

Oh, just remembered I had prepared a follow-up Sphinx 1.0.4.p8 spkg at #11665 myself (currently needing review).


---

Comment by jhpalmieri created at 2011-09-23 23:27:07

Version 1.0.8 of Sphinx has just been released.


---

Comment by jhpalmieri created at 2011-09-23 23:27:07

Changing component from documentation to packages.


---

Comment by jhpalmieri created at 2011-09-24 04:55:00

Okay, I have a new spkg, actually, two.  The first ("p0") is just a straightforward upgrade of the previous version.  However, we should probably update sage_autodoc.py in light of changes to the Sphinx extension autodoc.py, on which it is based.  I can provide a patch to the Sage library modifying sage_autodoc.py if necessary.

A different approach: the second spkg ("p1") autogenerates sage_autodoc.py from autodoc.py, and saves sage_autodoc.py in sphinx/ext instead of in sage/doc/common.  So using this one requires a change to sage/doc/common/conf.py, which I've provided.  This approach seems as though it will be easier to maintain, or at least it will be easier to keep sage_autodoc.py in line with autodoc.py.

With both of these approaches, I get some warnings about cross-references, which are why the other entries are in the patch for the Sage library.  I'm seeing lots of broken cross-references, though: take a look at the reference manual for categories/examples/finite_weyl_groups.py: 

```
    Only the following basic operations are implemented:
     - :meth:`one`
     - :meth:`product`
     - :meth:`simple_reflection`
     - :meth:`Element.has_right_descent`.
{{{
None of these produces a link.  I don't know what's going on.


---

Attachment

patch for sphinx pkg, for review only


---

Comment by jhpalmieri created at 2011-09-24 04:56:07

patch for sphinx pkg, for review only


---

Attachment


---

Comment by jhpalmieri created at 2011-09-24 05:03:08

By the way, we could use the new spkg (either version) and keep the Sage library intact; this would use the old, and now somewhat out-dated, sage_autodoc.py, but it does not have the cross-reference problems.


---

Comment by hivert created at 2011-09-24 08:59:10

Replying to [comment:13 jhpalmieri]:

Thanks for building the new spkg ! 

> By the way, we could use the new spkg (either version) and keep the Sage library intact; this would use the old, and now somewhat out-dated, sage_autodoc.py, but it does not have the cross-reference problems.

Concerning cross references, I've been doing some work in #9128. So my suggestion is to upgrade the spkg (I can probably find the time to review it this week) and the keep the cross reference problem for another ticket. What to you think ?


---

Comment by jhpalmieri created at 2011-09-24 18:08:04

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-09-24 18:08:04

Replying to [comment:14 hivert]:
> Replying to [comment:13 jhpalmieri]:
> 
> Thanks for building the new spkg ! 
> 
> > By the way, we could use the new spkg (either version) and keep the Sage library intact; this would use the old, and now somewhat out-dated, sage_autodoc.py, but it does not have the cross-reference problems.
> 
> Concerning cross references, I've been doing some work in #9128. So my suggestion is to upgrade the spkg (I can probably find the time to review it this week) and the keep the cross reference problem for another ticket. What to you think ? 

It makes me uncomfortable to have sage_autodoc.py so out-of-synch with autodoc.py, and as far as I can tell, changes to autodoc.py, and hence to the updated sage_autodoc.py, are what is causing the problem with the cross-references.  So I think just merging the spkg would only be acceptable if the work on #9128 (or elsewhere?) includes updating sage_autodoc.py.  What do you think of the idea of putting that file in the Sphinx directory (as in the "p1" version of the spkg) instead of keeping it in the Sage library?


---

Comment by jdemeyer created at 2011-11-05 18:50:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-11-05 18:50:06

There is now a version 1.1.2 of Sphinx.  Probably we should update this spkg.


---

Comment by jdemeyer created at 2011-11-05 19:45:56

I updated the "straightforward" spkg, I have no clue what `autodoc` is, so I left that alone.


---

Comment by jdemeyer created at 2011-11-05 19:45:56

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-11-05 20:18:00

`sage_autodoc` is the Sage version of the Sphinx extension `autodoc` (found in `sphinx/ext/`); it is used to extract the reference manual from the source code.  We've modified the original to handle various things (perhaps cython code, lazy methods, cached methods?).  So `sage_autodoc.py`, which lives in `devel/sage/doc/common`, used to be a simple modification of the Sphinx file `autodoc.py`, but now the two files differ more dramatically as `autodoc.py` has been patched in ways that `sage_autodoc.py` hasn't, and vice versa.

It might be good, to take full advantage of upgrades to Sphinx, to try to remedy this by creating `sage_autodoc.py` by patching `autodoc.py` in the Sphinx spkg.  Unfortunately, when I tried this approach, the new `sage_autodoc` module didn't work perfectly, probably because of recent changes in `autodoc`.  This could be dealt with on another ticket.  Following Leif's general suggestion about this kind of thing, perhaps we should add a "To do" item to the "Special Build Instructions" section of SPKG.txt.  I've prepared a new spkg (based on yours) with this change.  The spkg also removes the patch to 'autodoc.py', since I don't think we use that anymore: we use 'sage_autodoc.py' instead.


---

Comment by jdemeyer created at 2011-11-05 23:58:22

The following should be added to the scripts ``.hgignore``:

```
sphinx-apidoc
```



---

Comment by jdemeyer created at 2011-11-05 23:58:22

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-11-06 02:14:35

I think this is okay now.  It's a little more complicated than I thought.  First, Sage does use autodoc, in the 'sphinxify' routine when doing introspection.  So I restored the autodoc patch.  Second, with the new spkg, I was getting doctest failures: one piece of output in sageinspect.py was wrong.  I think that the new output is actually better: it's processing a docstring using sphinxify and coming up with nicer output.  So I think it's okay to change the output for the doctest.

So there are three or four patches, one for the scripts repo (hgignore), one for the Sage library (doctest), and one for the Sphinx spkg.  The patch for the Sage library should come with a corresponding patch for sagenb, but I don't know what to do about that.  Submit a ticket for the flask notebook?  I'll include one for the current sagenb repo, in case that's the right thing to do.


---

Comment by jhpalmieri created at 2011-11-06 02:14:35

Changing status from needs_work to needs_review.


---

Attachment

patch for sphinx 1.1.2 spkg; for review only


---

Attachment

scripts repo


---

Comment by jhpalmieri created at 2011-11-06 02:49:16

sage library repo


---

Attachment

sagenb repo


---

Comment by jdemeyer created at 2011-11-06 09:57:49

Replying to [comment:22 jhpalmieri]:
> I'll include one for the current sagenb repo, in case that's the right thing to do.
Yes, this is the right thing to do (I have discussed with the sagenb developers some time ago).


---

Comment by jdemeyer created at 2011-11-11 22:17:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-11 22:17:15

Looks good to me, but see the encoding issue at #10112.


---

Comment by jdemeyer created at 2011-11-14 17:31:48

Resolution: fixed
