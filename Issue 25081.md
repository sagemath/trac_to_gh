# Issue 25081: Minor optimizations of arithmetic with fraction field elements

Issue created by migration from https://trac.sagemath.org/ticket/25318

Original creator: mmezzarobba

Original creation time: 2018-05-09 19:34:28

CC:  roed caruso slelievre nthiery aschilling




---

Comment by git created at 2018-05-09 19:39:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-09 19:39:42

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2018-05-11 19:00:33

Changing priority from minor to major.


---

Comment by mmezzarobba created at 2018-05-11 19:00:33

New commits:


---

Comment by git created at 2018-05-11 19:01:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-12 05:02:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-12 07:39:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2018-05-12 08:55:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-12 10:04:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-12 16:09:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-12 17:55:09

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-05-27 19:17:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-29 08:51:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-29 09:05:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mmezzarobba created at 2018-05-29 09:07:15

Replying to [comment:12 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[15d9f06](https://git.sagemath.org/sage.git/commit/?id=15d9f0654b5dc744cfe066372214025b06301ad1)||`#25318 fix doctest after merging with develop`||

Oops, this fix should have gone to #16268. Moved it there and rebased on top of it.


---

Comment by git created at 2018-06-10 12:48:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mmezzarobba created at 2018-06-10 12:50:08

Rebased on 8.3.beta5 along with #16268.


---

Comment by git created at 2018-06-10 12:59:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-06-11 06:00:00

Could you explain why you need to remove the p-adic doctest? You mentioned this in #25440 but I could not immediately find a reason for this in this ticket:

```patch
-        Check that inexact elements are treated correctly::
-
-            sage: K=Qp(2,5)
-            sage: R.<x> = K[]
-            sage: L = R.fraction_field()
-            sage: S.<y> = L[]
-            sage: y(K(1,1)/x)
-            ((1 + O(2)))/((1 + O(2^5))*x)
```



---

Comment by saraedum created at 2018-06-11 06:00:00

Changing status from needs_review to needs_info.


---

Comment by mmezzarobba created at 2018-06-11 08:54:03

Because it breaks again after this ticket, due to new code that uses `is_one()` to test if a leading coefficient (or something like that, I don't remember exactly) is one. And while I have nothing against the workaround you added in #25440 to accommodate the behavior of `is_one()` for p-adics as long as it doesn't break anything else, I don't think we want to block other changes due to what I see as a bug of p-adics...


---

Comment by mmezzarobba created at 2018-06-11 08:54:10

Changing status from needs_info to needs_review.


---

Comment by saraedum created at 2018-06-11 15:39:46

I don't think it's a bug. p-adics make imho the less fortunate of two reasonable choices on how to implement `==`. No matter how you implement it, lots of implementations that are not aware of inexact elements break.

If you take the above doctest out, doesn't this mean that you produce a wrong result again now? I am not sure that it's valid to just claim that p-adics are broken, so we should not care about them.

I also don't want to block progress on fraction fields which would be quite nice. But can't we have both?


---

Comment by saraedum created at 2018-06-11 15:40:11

Let's hear what some other people think about this…


---

Comment by mmezzarobba created at 2018-06-11 17:26:18

Replying to [comment:21 saraedum]:
> I don't think it's a bug. p-adics make imho the less fortunate of two reasonable choices on how to implement `==`. No matter how you implement it, lots of implementations that are not aware of inexact elements break.

Ok, perhaps calling it a bug is a bit strong. But in the parts of Sage I'm familiar with, there are a number of generic algorithms that already use equality and (more importantly) `is_zero()`, `is_one()`, `bool()` in a way compatible with interval-like rings... but with the semantics of interval arithmetic, not those of p-adics.

> If you take the above doctest out, doesn't this mean that you produce a wrong result again now?

Yes, I think so.

> I am not sure that it's valid to just claim that p-adics are broken, so we should not care about them.
> 
> I also don't want to block progress on fraction fields which would be quite nice. But can't we have both?

In the present case, I don't really see how without changing the implementation of p-adics, but if you have an idea I'd love to hear it!

Do you think it would be break anything if we modified the p-adic `is_zero()` and `is_one()` without touching `==`, though? While it can be argued that `==` is an “internal” operation on each parent (using it in combination with coercion is known to be dangerous anyway), whose semantics could vary from parent to parent, I really don't see anyone calling `is_one()` and expecting it to return `True` on anything but the exact unit element, even for p-adics... And I guess that change already would be enough to make most generic algorithms work on p-adics.


---

Comment by caruso created at 2018-06-15 12:21:47

Currently, I think that the exact p-adic one does not exist in Sage (except for floating point arithmetics). So are you saying that `is_one` should always return `False`? Or that exact p-adic elements have to be implemented?


---

Comment by mmezzarobba created at 2018-06-15 12:38:49

Replying to [comment:24 caruso]:
> Currently, I think that the exact p-adic one does not exist in Sage (except for floating point arithmetics). So are you saying that `is_one` should always return `False`? Or that exact p-adic elements have to be implemented?

I don't know. Perhaps it should always return `False`, or perhaps it should return `True` when the element is one up to the maximum precision of the ring... I guess it depends how you want generic objects to behave. For example, what should be the degree of a polynomial whose leading term is O(p<sup>k</sup>)? When should multiplication by “zero”, resp. “one” yield `R.zero()`, resp. the other operand?


---

Comment by caruso created at 2018-06-15 13:54:15

My personal philosophy is that a should be considered as equal to b as soon as they are indistinguishable (which is the current behavior), but I agree that this has disadvantages as well.

I'm not sure that it's a good idea to let `a == 1` have a different meaning than `a.is_one()`. Personally, I consider the two constructions as equivalent.


---

Comment by mmezzarobba created at 2018-06-15 14:59:42

Replying to [comment:26 caruso]:
> My personal philosophy is that a should be considered as equal to b as soon as they are indistinguishable (which is the current behavior), but I agree that this has disadvantages as well.

And I'm fine with that. But it seems hard to me to make generic algorithms (that must work over other parents too) accommodate that, unless you also agree that operations involving p-adics can return results “equal” to the correct one in that sense (but possibly more precise).

I don't really like having `x.is_one()` differ from `== 1` either, but that would solve the problem in many cases...

What do you think we should do in the case of the present ticket? Or, to take a similar but simpler example, what do you think `c*pol` should return when `pol` is a generic polynomial and `c` is a scalar with `c.is_one()`? And when `c.is_zero()`?


---

Comment by caruso created at 2018-06-15 15:09:38

Something I'm using times to times is to add a named argument (I usually use `secure` but it can also be `exact`, it's possibly better). If `secure` is true, then `a == b` returns false (or raises an error) if one cannot assert that they are equal for sure; otherwise, it behaves as it does currently.

I'm not very very enthusiastic with the solution, but I guess that it may solve the problem.


---

Comment by git created at 2018-06-24 11:37:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2018-07-03 08:12:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by slelievre created at 2018-12-28 09:34:22

Could a few words be added to the ticket description?


---

Comment by mmezzarobba created at 2019-01-04 13:54:09

Replying to [comment:32 slelievre]:
> Could a few words be added to the ticket description?

I'm not sure what to add to what already is in the commit messages. (And I don't remember much about this ticket.) What information would you like to see?


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by git created at 2019-02-01 13:44:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-03 12:24:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by vdelecroix created at 2019-07-19 12:48:26

Marc, I am likely to have a look next week (Sage days 100). If you have time to rebase, that would be appreciated).


---

Comment by vdelecroix created at 2019-07-19 12:48:37

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-07-21 12:14:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-07-21 12:15:15

Replying to [comment:40 vdelecroix]:
> Marc, I am likely to have a look next week (Sage days 100). If you have time to rebase, that would be appreciated).

Done (but not tested at all: I'm on the train, on battery).


---

Comment by mmezzarobba created at 2019-07-21 12:15:22

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-11-21 16:51:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-11-21 16:51:20

rebased (result not tested)


---

Comment by chapoton created at 2019-11-22 09:50:36

Patchbot says

```
sage -t --long src/sage/combinat/root_system/non_symmetric_macdonald_polynomials.py  # 130 doctests failed
sage -t --long src/sage/combinat/root_system/root_lattice_realization_algebras.py  # 11 doctests failed
sage -t --long src/sage/combinat/root_system/hecke_algebra_representation.py  # 16 doctests failed
sage -t --long src/sage/categories/coxeter_group_algebras.py  # 1 doctest failed
```



---

Comment by mmezzarobba created at 2019-11-22 11:29:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-12-17 14:18:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-12-17 14:34:47

Ok, I think the actual issue behind these failures was in the py3 port of hecke_algebra_representations, see my last commit. (Phew, this one wasn't easy to track down!)


---

Comment by mmezzarobba created at 2019-12-17 14:34:47

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-12-27 17:04:04

I think the last commit is correct, but perhaps Nicolas or Anne, could one of you verify?


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by git created at 2020-01-10 12:00:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-10 12:02:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2020-01-10 16:54:00

patchbot says that

```
++        Returns self raised to the `n^{th}` power.
```

should be

```
++        Return ``self`` raised to the `n^{th}` power.
```



---

Comment by git created at 2020-01-11 16:07:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2020-01-11 16:08:35

Thank you.


---

Comment by saraedum created at 2020-02-06 23:02:27

In gcd, why is `self.__class__(self._parent, rnum*sden + rden*snum, rden*sden, coerce=False, reduce=False, is_reduced=True)` necessarily reduced? You then divide by `d` but in the `except:` case, it won't be reduced, right?


---

Comment by saraedum created at 2020-02-06 23:03:34

Same a few lines below of course.


---

Comment by saraedum created at 2020-02-06 23:04:17

I believe that this is only correct over exact rings:

```
        if rnum.is_zero() or snum.is_zero():
            return self._parent.zero()
        elif self.is_one():
            return right
        elif _right.is_one():
            return self
```



---

Comment by saraedum created at 2020-02-06 23:05:47

Why is this here automatically reduced in the except case?

```
+            tnum = rnum * snum
+            tden = rden * sden
+            res = self.__class__(self._parent, tnum, tden, coerce=False,
+                   reduce=False)
+            try:
+                (<FractionFieldElement> res).normalize_unit_denominator()
+            except (AttributeError, NotImplementedError):
+                pass
+            (<FractionFieldElement> res)._is_reduced = True
```



---

Comment by saraedum created at 2020-02-06 23:13:35

This is not correct for inexact rings I think:

```
+        elif self.is_one():
+            return ~right
```



---

Comment by saraedum created at 2020-02-06 23:14:54

Maybe I am missing something in general here but why would that be automatically reduced if `self` isn't?

```
             return self.__class__(self.parent(),
-                snum**right, sden**right,
-                coerce=False, reduce=False)
+                snum**n, sden**n,
+                coerce=False, reduce=False, is_reduced=True)
```



---

Comment by saraedum created at 2020-02-06 23:16:05

Shouldn't that be protected by a try-except like in other places? This one is in pow.

```
+            (<FractionFieldElement> res).normalize_unit_denominator()
+            (<FractionFieldElement> res)._is_reduced = True
```



---

Comment by saraedum created at 2020-02-06 23:16:53

Again, here in `neg`. Can't it be that `self` is not reduced?


```         
     return self.__class__(self._parent,
             -self.__numerator, self.__denominator,
-            coerce=False, reduce=False)
+            coerce=False, reduce=False, is_reduced=True)
```



---

Comment by saraedum created at 2020-02-06 23:20:24

In `inv`, should `normalize_unit_denominator` not be in try-except like in other places? Why is this reduced if `normalize_unit_denominator` failed silently? Why is this reduced if the original was not reduced?


```
+        (<FractionFieldElement> inv).normalize_unit_denominator()
+        (<FractionFieldElement> inv)._is_reduced = True
+        return inv
```



---

Comment by saraedum created at 2020-02-06 23:21:23

Why did you drop this test?

```
-
-        Check that inexact elements are treated correctly::
-
-            sage: K=Qp(2,5)
-            sage: R.<x> = K[]
-            sage: L = R.fraction_field()
-            sage: S.<y> = L[]
-            sage: y(K(1,1)/x)
-            (1 + O(2))/((1 + O(2))*x)
```



---

Comment by saraedum created at 2020-02-06 23:23:15

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2020-02-06 23:26:34

I like the idea of this ticket. Fraction fields are annoyingly slow and I am very much in favor of improving the situation. I might be misunderstanding a general pattern here, so looking forward to your comments.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-08-18 21:10:29

Needs rebase


---

Comment by git created at 2020-08-19 14:17:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2020-08-19 14:17:55

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2020-08-19 14:17:55

Thanks a lot for your comments--and sorry for taking so long to reply, you caught me at a bad time!

Replying to [comment:58 saraedum]:
> In gcd, why is `self.__class__(self._parent, rnum*sden + rden*snum, rden*sden, coerce=False, reduce=False, is_reduced=True)` necessarily reduced? You then divide by `d` but in the `except:` case, it won't be reduced, right?

I assume you mean in `_add_`? But even so I don't understand the question: this line is under `if d.is_unit()`, and I'm dividing by `d` (or trying to) when that's not the case.

Replying to [comment:59 saraedum]:
> Same a few lines below of course.

A few lines below, the whole fraction is zero.

Replying to [comment:60 saraedum]:
> I believe that this is only correct over exact rings:
> {{{
>         if rnum.is_zero() or snum.is_zero():
>             return self._parent.zero()
>         elif self.is_one():
>             return right
>         elif _right.is_one():
>             return self
> }}}

Replying to [comment:62 saraedum]:
> This is not correct for inexact rings I think:
> {{{
> +        elif self.is_one():
> +            return ~right
> }}}

Replying to [comment:67 saraedum]:
> Why did you drop this test?
> {{{
> -
> -        Check that inexact elements are treated correctly::
> -
> -            sage: K=Qp(2,5)
> -            sage: R.<x> = K[]
> -            sage: L = R.fraction_field()
> -            sage: S.<y> = L[]
> -            sage: y(K(1,1)/x)
> -            (1 + O(2))/((1 + O(2))*x)
> }}}

See the discussion above: I think it is correct over most inexact rings (RR, RDF, RBF, RIF, CC, CDF, CBF, CIF, SR... and constructions over them), but apparently not over p-adic rings, unfortunately. For want of a proper solution, I'm now using this logic over exact rings only.

I dropped the test because I didn't realize this behavior of `is_zero()` and `is_one()` was something the p-adics people actually wanted. I have restored it in the rebased branch.

Replying to [comment:61 saraedum]:
> Why is this here automatically reduced in the except case?
> {{{
> +            tnum = rnum * snum
> +            tden = rden * sden
> +            res = self.__class__(self._parent, tnum, tden, coerce=False,
> +                   reduce=False)
> +            try:
> +                (<FractionFieldElement> res).normalize_unit_denominator()
> +            except (AttributeError, NotImplementedError):
> +                pass
> +            (<FractionFieldElement> res)._is_reduced = True
> }}}

Strictly speaking it isn't, but that's because we're unable to reduce over that ring, hence there is no point in trying again later. (Cf. the comment in front of the initial definition of `_is_reduced` in `__init__()`.)

Replying to [comment:63 saraedum]:
> Maybe I am missing something in general here but why would that be automatically reduced if `self` isn't?
> {{{
>              return self.__class__(self.parent(),
> -                snum**right, sden**right,
> -                coerce=False, reduce=False)
> +                snum**n, sden**n,
> +                coerce=False, reduce=False, is_reduced=True)
> }}}

Replying to [comment:65 saraedum]:
> Again, here in `neg`. Can't it be that `self` is not reduced?
> 
> {{{         
>      return self.__class__(self._parent,
>              -self.__numerator, self.__denominator,
> -            coerce=False, reduce=False)
> +            coerce=False, reduce=False, is_reduced=True)
> }}}

I think you are right, `is_reduced=self._is_reduced` would be better in these cases.

Replying to [comment:64 saraedum]:
> Shouldn't that be protected by a try-except like in other places? This one is in pow.
> {{{
> +            (<FractionFieldElement> res).normalize_unit_denominator()
> +            (<FractionFieldElement> res)._is_reduced = True
> }}}

Replying to [comment:66 saraedum]:
> In `inv`, should `normalize_unit_denominator` not be in try-except like in other places?
> Why is this reduced if `normalize_unit_denominator` failed silently?
> Why is this reduced if the original was not reduced?
> 
> {{{
> +        (<FractionFieldElement> inv).normalize_unit_denominator()
> +        (<FractionFieldElement> inv)._is_reduced = True
> +        return inv
> }}}

AFAICT it is the other way around: the try-excepts that are present in some cases are leftovers from a previous version and are unnecessary.

See above for the other points.

----
New commits:


---

Comment by git created at 2020-08-20 11:42:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-12-20 17:29:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-08 16:05:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2021-03-08 16:06:27

Rebased on 9.3.beta8.


---

Comment by tscrim created at 2021-03-09 00:13:41

Do you have some timings?


---

Comment by mmezzarobba created at 2021-03-09 10:41:00

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2021-03-09 10:41:00

Replying to [comment:79 tscrim]:
> Do you have some timings?

Good question. I am almost certain my version was faster when I first wrote it, but with the current Sage beta I no longer see any measurable improvement. For all I know the this ticket's branch may even be a bit slower. Thanks for asking! `:-/`


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
