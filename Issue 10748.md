# Issue 10748: problems with loopy graphs

Issue created by migration from Trac.

Original creator: dsm

Original creation time: 2011-02-21 13:54:19

Assignee: jason, ncohen, rlm

Consider two manifestly isomorphic graphs:


```
sage: G = Graph(loops=True)
sage: G.add_edges([(0,1), (1,1)])
sage: G.vertices(), G.edges()
([0, 1], [(0, 1, None), (1, 1, None)])
sage: 
sage: G2 = Graph(loops=True)
sage: G2.add_edges([(0,2), (2,2)])
sage: G2.vertices(), G2.edges()
([0, 2], [(0, 2, None), (2, 2, None)])
sage: 
sage: G.is_isomorphic(G2), G2.is_isomorphic(G)
(False, False)
```


This occurs because the isomorphism comparison short-circuits because it notices that


```
sage: G.size()
2
sage: G2.size()
1
```


which is true because


```
sage: G.num_edges()
2
sage: G2.num_edges()
1
```


which I think happens because the following code in c_graph.pyx


```
            if self.loops(None):
                if self.multiple_edges(None):
                    for j in xrange(self.num_verts()):
                        if self.has_edge(j, j, None):
                            k += len(self.get_edge_label(j, j))
                else:
                    for j in xrange(self.num_verts()):
                        if self.has_edge(j, j, None):
                            k += 1
            i = (i - k) / 2
            return i + k
```


assumes that the vertex labels which show up in the edge list go from 0 to num_verts-1.  If I replace "for j in xrange(self.num_verts())" with "for j in self.iterator_verts(None)", things improve:


```
sage: G = Graph(loops=True)
sage: G.add_edges([(0,1), (1,1)])
sage: G.vertices(), G.edges()
([0, 1], [(0, 1, None), (1, 1, None)])
sage: 
sage: G2 = Graph(loops=True)
sage: G2.add_edges([(0,2), (2,2)])
sage: G2.vertices(), G2.edges()
([0, 2], [(0, 2, None), (2, 2, None)])
sage: 
sage: G.size(), G.num_edges()
(2, 2)
sage: G2.size(), G2.num_edges()
(2, 2)
sage: 
sage: G.is_isomorphic(G2), G2.is_isomorphic(G)
(True, True)
```


If someone can verify the above analysis I can work up a patch (the above case appeared when I was writing tests for a prospective patch to fix #10812).


---

Comment by ncohen created at 2011-02-21 16:34:28

Hello !!

When I type your commands in 4.6.2.alpha3, I get :


```
sage: G = Graph(loops=True)
sage: G.add_edges([(0,1), (1,1)])
sage: G.vertices(), G.edges()
([0, 1], [(0, 1, None), (1, 1, None)])
sage: G2 = Graph(loops=True)
sage: G2.add_edges([(0,2), (2,2)])
sage: G2.vertices(), G2.edges()
([0, 2], [(0, 2, None), (2, 2, None)])
sage: G.is_isomorphic(G2), G2.is_isomorphic(G)
(True, True)
```


I'm pretty sure I reviewed some patch about this very part of the code you're quoting, but unlike the one I mentionned in #10814 I can not find its number back. It was probably one of Robert's.

Anyway, the latest version of Sage and the one the developpers are working on usually corresponds to the latest post of sage-release.

... And Welome aboard `:-)`

Nathann


---

Comment by dsm created at 2011-02-22 03:30:08

Oy, you're right: it looks like it was fixed as part of a bigger change in #8395.  [By doing what I thought needed to be done, which is reassuring. `;^)`]   The above was in 4.6.1, and I should know better than not to mention which version..

Would it be inappropriate to add a doctest for the above problem to is_isomorphic anyway?


---

Comment by ncohen created at 2011-02-22 08:08:23

> Would it be inappropriate to add a doctest for the above problem to is_isomorphic anyway?

Of course not ! If I reviewed that patch without asking for one, it already a mistake from my part anyway `:-)`

Nathann


---

Comment by dsm created at 2011-02-22 08:59:05

Well, they caught the bug at the lower level, at the degree/size level.  I only noticed it at the higher level, so in a certain sense my test would be redundant, as I think the problem which led to it is already being well-doctested..  But I'll put up a patch anyway.


---

Comment by dsm created at 2011-02-22 08:59:05

Changing priority from critical to minor.


---

Comment by dsm created at 2011-02-22 08:59:05

Changing status from new to needs_review.


---

Comment by ncohen created at 2011-02-22 09:15:38

Nothing wrong in adding a doctest there, especially when they're that quick to run. Applies fine, passes long tests... Good to go ! `:-)`

Could you add your full name in "Author" ? I don't have the pleasure of knowing it ! And also to the list on 

http://trac.sagemath.org/sage_trac/wiki

(when you have a second)

Nathann


---

Comment by ncohen created at 2011-02-22 09:15:38

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-02-22 09:21:34

dsm: add you real name as Author of this ticket and also add yourself to [http://trac.sagemath.org/sage_trac/#AccountNamesmappedtoRealNames](http://trac.sagemath.org/sage_trac/#AccountNamesmappedtoRealNames).


---

Comment by dsm created at 2011-02-22 10:51:51

Done; although there seems to be something weird about the name map, it seems to want to link my last name to a description page whereas it doesn't for those of other people, even though to my eyes I used exactly the same format.  Not sure what I'm missing.


---

Comment by ncohen created at 2011-02-22 11:05:12

Replying to [comment:8 dsm]:
> Done; although there seems to be something weird about the name map, it seems to want to link my last name to a description page whereas it doesn't for those of other people, even though to my eyes I used exactly the same format.  Not sure what I'm missing.

Weird `O_o`.

Maybe McNeil is some Sage keyword. It does that with Graph too I think. If you have a web page, try adding it, as it may overrule the automatic link `:-)`

Nathann


---

Attachment

[version updated to use "::" instead of ":" after test description, otherwise unchanged]


---

Comment by jdemeyer created at 2011-03-11 22:12:24

Changing component from graph theory to doctest.


---

Comment by jdemeyer created at 2011-03-17 19:23:33

Resolution: fixed
