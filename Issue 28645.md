# Issue 28645: Provide diagonal_matrix as a method of matrix spaces

archive/issues_028645.json:
```json
{
    "body": "Keywords: diagonal matrix\n\nSage provides two functions `identity_matrix`\nand `diagonal_matrix` in the global namespace.\n\nBy contrast, matrix spaces have an `identity_matrix`\nmethod but no `diagonal_matrix` method.\n\nGlobal namespace functions:\n\n```\nsage: identity_matrix(ZZ, 2)\n[1 0]\n[0 1]\nsage: diagonal_matrix(ZZ, [3, 2])\n[3 0]\n[0 2]\n```\n\n\nMatrix space methods:\n\n```\nsage: M = MatrixSpace(ZZ, 2)\nsage: M.identity_matrix()\n[1 0]\n[0 1]\n```\n\n\nBefore this ticket:\n\n```\nsage: M = MatrixSpace(ZZ, 2)\nsage: M.diagonal_matrix([3, 2])\nTraceback (most recent call last)\n...\nAttributeError: 'MatrixSpace_with_category' object has no attribute 'diagonal_matrix'\n```\n\n\nAfter this ticket:\n\n```\nsage: M = MatrixSpace(ZZ, 2)\nsage: M.diagonal_matrix([3, 2])\n[3 0]\n[0 2]\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28882\n\n",
    "created_at": "2019-12-14T00:18:43Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Provide diagonal_matrix as a method of matrix spaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28645",
    "user": "https://github.com/slel"
}
```
Keywords: diagonal matrix

Sage provides two functions `identity_matrix`
and `diagonal_matrix` in the global namespace.

By contrast, matrix spaces have an `identity_matrix`
method but no `diagonal_matrix` method.

Global namespace functions:

```
sage: identity_matrix(ZZ, 2)
[1 0]
[0 1]
sage: diagonal_matrix(ZZ, [3, 2])
[3 0]
[0 2]
```


Matrix space methods:

```
sage: M = MatrixSpace(ZZ, 2)
sage: M.identity_matrix()
[1 0]
[0 1]
```


Before this ticket:

```
sage: M = MatrixSpace(ZZ, 2)
sage: M.diagonal_matrix([3, 2])
Traceback (most recent call last)
...
AttributeError: 'MatrixSpace_with_category' object has no attribute 'diagonal_matrix'
```


After this ticket:

```
sage: M = MatrixSpace(ZZ, 2)
sage: M.diagonal_matrix([3, 2])
[3 0]
[0 2]
```



Issue created by migration from https://trac.sagemath.org/ticket/28882





---

archive/issue_events_073060.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28645#event-73060"
}
```



---

archive/issue_comments_404024.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404024",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_404025.json:
```json
{
    "body": "I added a `diagonal_matrix` method in `matrix_space.py` pointing it to the original `diagonal_matrix` method in `special.py`.\n\nSo, I tried to think of reasons why we would be using `matrix_space` methods instead of the regular `matrix()` methods (crosspost: https://math.stackexchange.com/q/3537612/287775) but couldn't find any.\n\nAre there practical reasons, so that I can write better code for this file now/ in the future?\n\nAlso would like a review on this patch. \n----\nNew commits:",
    "created_at": "2020-02-11T13:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404025",
    "user": "https://github.com/Tinkidinki"
}
```

I added a `diagonal_matrix` method in `matrix_space.py` pointing it to the original `diagonal_matrix` method in `special.py`.

So, I tried to think of reasons why we would be using `matrix_space` methods instead of the regular `matrix()` methods (crosspost: https://math.stackexchange.com/q/3537612/287775) but couldn't find any.

Are there practical reasons, so that I can write better code for this file now/ in the future?

Also would like a review on this patch. 
----
New commits:



---

archive/issue_comments_404026.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-11T13:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404026",
    "user": "https://github.com/Tinkidinki"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_404027.json:
```json
{
    "body": "It would be better to model this on the `identity_matrix` method. In particular: it should raise an error if the matrix space is for non-square matrices, and there should be doctests. And it should raise an error if `entries` doesn't have the right length.",
    "created_at": "2020-02-11T22:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404027",
    "user": "https://github.com/jhpalmieri"
}
```

It would be better to model this on the `identity_matrix` method. In particular: it should raise an error if the matrix space is for non-square matrices, and there should be doctests. And it should raise an error if `entries` doesn't have the right length.



---

archive/issue_comments_404028.json:
```json
{
    "body": "Yes, this needs to be fixed for non-square matrices and requires doc-tests. However, ensuring the length of `entries` is correct is taken care of by the diagonal_matrix() method in special.py.",
    "created_at": "2020-02-14T05:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404028",
    "user": "https://github.com/Tinkidinki"
}
```

Yes, this needs to be fixed for non-square matrices and requires doc-tests. However, ensuring the length of `entries` is correct is taken care of by the diagonal_matrix() method in special.py.



---

archive/issue_comments_404029.json:
```json
{
    "body": "Changing keywords from \"diagonal matrix\" to \"diagonal matrix, beginner\".",
    "created_at": "2020-02-14T05:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404029",
    "user": "https://github.com/Tinkidinki"
}
```

Changing keywords from "diagonal matrix" to "diagonal matrix, beginner".



---

archive/issue_comments_404030.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-14T05:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404030",
    "user": "https://github.com/Tinkidinki"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_404031.json:
```json
{
    "body": "Please review. Currently, this doesn't work:\n\nsage: M1 = MatrixSpace(ZZ, 2, implementation='flint')\n\nsage: M2 = MatrixSpace(ZZ, 2, implementation='generic')\n\nsage: type(M1.diagonal_matrix([1, 2]))\n\n      <type 'sage.matrix.matrix_integer_dense.Matrix_integer_dense'>\n\nsage: type(M2.diagonal_matrix([1, 2]))\n\n      <type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>\n\nBoth the types are currently: \n\n<class 'sage.matrix.matrix_integer_sparse.Matrix_integer_sparse'>\n----\nNew commits:",
    "created_at": "2020-02-26T09:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404031",
    "user": "https://github.com/SagnikDey92"
}
```

Please review. Currently, this doesn't work:

sage: M1 = MatrixSpace(ZZ, 2, implementation='flint')

sage: M2 = MatrixSpace(ZZ, 2, implementation='generic')

sage: type(M1.diagonal_matrix([1, 2]))

      <type 'sage.matrix.matrix_integer_dense.Matrix_integer_dense'>

sage: type(M2.diagonal_matrix([1, 2]))

      <type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>

Both the types are currently: 

<class 'sage.matrix.matrix_integer_sparse.Matrix_integer_sparse'>
----
New commits:



---

archive/issue_comments_404032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-26T09:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404032",
    "user": "https://github.com/SagnikDey92"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_404033.json:
```json
{
    "body": "Matrix spaces can be created using the keyword `sparse`, with `False` the default, and you can recover this value using `M.is_sparse()`. So you should call `diagonal_matrix` with the argument `sparse=self.is_sparse()`:\n\n```diff\ndiff --git a/src/sage/matrix/matrix_space.py b/src/sage/matrix/matrix_space.py\nindex b4cb724e3b..3712806364 100644\n--- a/src/sage/matrix/matrix_space.py\n+++ b/src/sage/matrix/matrix_space.py\n@@ -1600,7 +1600,7 @@ class MatrixSpace(UniqueRepresentation, Parent):\n         \"\"\"\n         if self.__nrows != self.__ncols:\n             raise TypeError(\"diagonal matrix must be square\")\n-        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries)\n+        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries, sparse=self.is_sparse())\n         A.set_immutable()\n         return A\n\n```\n\n\nWhy make it immutable by default?",
    "created_at": "2020-02-26T21:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404033",
    "user": "https://github.com/jhpalmieri"
}
```

Matrix spaces can be created using the keyword `sparse`, with `False` the default, and you can recover this value using `M.is_sparse()`. So you should call `diagonal_matrix` with the argument `sparse=self.is_sparse()`:

```diff
diff --git a/src/sage/matrix/matrix_space.py b/src/sage/matrix/matrix_space.py
index b4cb724e3b..3712806364 100644
--- a/src/sage/matrix/matrix_space.py
+++ b/src/sage/matrix/matrix_space.py
@@ -1600,7 +1600,7 @@ class MatrixSpace(UniqueRepresentation, Parent):
         """
         if self.__nrows != self.__ncols:
             raise TypeError("diagonal matrix must be square")
-        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries)
+        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries, sparse=self.is_sparse())
         A.set_immutable()
         return A

```


Why make it immutable by default?



---

archive/issue_comments_404034.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-27T09:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404034",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404035.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> Matrix spaces can be created using the keyword `sparse`, with `False` the default, and you can recover this value using `M.is_sparse()`. So you should call `diagonal_matrix` with the argument `sparse=self.is_sparse()`:\n> {{{\n> #!diff\n> diff --git a/src/sage/matrix/matrix_space.py b/src/sage/matrix/matrix_space.py\n> index b4cb724e3b..3712806364 100644\n> --- a/src/sage/matrix/matrix_space.py\n> +++ b/src/sage/matrix/matrix_space.py\n> `@``@` -1600,7 +1600,7 `@``@` class MatrixSpace(UniqueRepresentation, Parent):\n>          \"\"\"\n>          if self.__nrows != self.__ncols:\n>              raise TypeError(\"diagonal matrix must be square\")\n> -        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries)\n> +        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries, sparse=self.is_sparse())\n>          A.set_immutable()\n>          return A\n> \n> }}}\n> \n> Why make it immutable by default?\n\nThe above discussion thread suggested to model diagonal_matrix on the identity_matrix function. Since that was immutable by default, I made it so in diagonal_matrix as well. I'll remove it if required. I've now made a change that keeps the implementation method the same in the diagonal matrix. Please review.",
    "created_at": "2020-02-27T09:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404035",
    "user": "https://github.com/SagnikDey92"
}
```

Replying to [comment:11 jhpalmieri]:
> Matrix spaces can be created using the keyword `sparse`, with `False` the default, and you can recover this value using `M.is_sparse()`. So you should call `diagonal_matrix` with the argument `sparse=self.is_sparse()`:
> {{{
> #!diff
> diff --git a/src/sage/matrix/matrix_space.py b/src/sage/matrix/matrix_space.py
> index b4cb724e3b..3712806364 100644
> --- a/src/sage/matrix/matrix_space.py
> +++ b/src/sage/matrix/matrix_space.py
> `@``@` -1600,7 +1600,7 `@``@` class MatrixSpace(UniqueRepresentation, Parent):
>          """
>          if self.__nrows != self.__ncols:
>              raise TypeError("diagonal matrix must be square")
> -        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries)
> +        A = sage.matrix.special.diagonal_matrix(self.base_ring(), self.dims()[0], entries, sparse=self.is_sparse())
>          A.set_immutable()
>          return A
> 
> }}}
> 
> Why make it immutable by default?

The above discussion thread suggested to model diagonal_matrix on the identity_matrix function. Since that was immutable by default, I made it so in diagonal_matrix as well. I'll remove it if required. I've now made a change that keeps the implementation method the same in the diagonal matrix. Please review.



---

archive/issue_comments_404036.json:
```json
{
    "body": "The `identity_matrix` is immutable because it is cached. If it were not immutable, this could happen:\n\n```\nsage: M = MatrixSpace(ZZ, 2)\nsage: a = M.identity_matrix()\nsage: a[0,0] = 2\nsage: M.identity_matrix()\n[2 0]\n[0 1]\n```\n\nThis is not an issue with `diagonal_matrix`, and I don't see a good reason for it to be immutable.",
    "created_at": "2020-02-27T17:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404036",
    "user": "https://github.com/jhpalmieri"
}
```

The `identity_matrix` is immutable because it is cached. If it were not immutable, this could happen:

```
sage: M = MatrixSpace(ZZ, 2)
sage: a = M.identity_matrix()
sage: a[0,0] = 2
sage: M.identity_matrix()
[2 0]
[0 1]
```

This is not an issue with `diagonal_matrix`, and I don't see a good reason for it to be immutable.



---

archive/issue_comments_404037.json:
```json
{
    "body": "Ok. Thank you for the clarification. I'm new to this library. I'll remove the immutability part and send the PR again.",
    "created_at": "2020-02-27T18:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404037",
    "user": "https://github.com/SagnikDey92"
}
```

Ok. Thank you for the clarification. I'm new to this library. I'll remove the immutability part and send the PR again.



---

archive/issue_comments_404038.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-28T05:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404038",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404039.json:
```json
{
    "body": "Replying to [comment:16 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[f48d915](https://git.sagemath.org/sage.git/commit/?id=f48d91551e994a81dbe7e6edd639d35b994608d3)||`Removed immutability of diagonal matrix and edited documentation appropriately`||\n\nPlease review",
    "created_at": "2020-02-28T05:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404039",
    "user": "https://github.com/SagnikDey92"
}
```

Replying to [comment:16 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[f48d915](https://git.sagemath.org/sage.git/commit/?id=f48d91551e994a81dbe7e6edd639d35b994608d3)||`Removed immutability of diagonal matrix and edited documentation appropriately`||

Please review



---

archive/issue_comments_404040.json:
```json
{
    "body": "I made a few changes:\n\n- edited the docstring so that there is an \"INPUTS\" block and so that the lines are under 80 characters.\n- added a doctest showing what happens if you try to create a diagonal matrix with entries from the wrong ring\n- removed the alias `diag`: I think `diagonal_matrix` is completely clear, whereas `diag` is ambiguous. People can easily get `diagonal_matrix` using tab-completion, so I'm not concerned about the extra characters.\n\nIf you are happy with these changes, feel free to set to positive review. Make sure to add your real name to the \"Authors\" field.\n----\nNew commits:",
    "created_at": "2020-02-28T21:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404040",
    "user": "https://github.com/jhpalmieri"
}
```

I made a few changes:

- edited the docstring so that there is an "INPUTS" block and so that the lines are under 80 characters.
- added a doctest showing what happens if you try to create a diagonal matrix with entries from the wrong ring
- removed the alias `diag`: I think `diagonal_matrix` is completely clear, whereas `diag` is ambiguous. People can easily get `diagonal_matrix` using tab-completion, so I'm not concerned about the extra characters.

If you are happy with these changes, feel free to set to positive review. Make sure to add your real name to the "Authors" field.
----
New commits:



---

archive/issue_comments_404041.json:
```json
{
    "body": "Thank you for the corrections u/jhpalmieri. Setting status to 'positive review'.",
    "created_at": "2020-02-29T06:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404041",
    "user": "https://github.com/SagnikDey92"
}
```

Thank you for the corrections u/jhpalmieri. Setting status to 'positive review'.



---

archive/issue_comments_404042.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-29T06:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404042",
    "user": "https://github.com/SagnikDey92"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404043.json:
```json
{
    "body": "\n```\nsage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst\n**********************************************************************\nFile \"src/doc/en/thematic_tutorials/coercion_and_categories.rst\", line 450, in doc.en.thematic_tutorials.coercion_and_categories\nFailed example:\n    len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\nExpected:\n    81\nGot:\n    82\n**********************************************************************\nFile \"src/doc/en/thematic_tutorials/coercion_and_categories.rst\", line 452, in doc.en.thematic_tutorials.coercion_and_categories\nFailed example:\n    len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\nExpected:\n    121\nGot:\n    122\n**********************************************************************\n1 item had failures:\n   2 of 192 in doc.en.thematic_tutorials.coercion_and_categories\n    [191 tests, 2 failures, 0.28 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst  # 2 doctests failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2020-02-29T21:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404043",
    "user": "https://github.com/vbraun"
}
```


```
sage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst
**********************************************************************
File "src/doc/en/thematic_tutorials/coercion_and_categories.rst", line 450, in doc.en.thematic_tutorials.coercion_and_categories
Failed example:
    len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
Expected:
    81
Got:
    82
**********************************************************************
File "src/doc/en/thematic_tutorials/coercion_and_categories.rst", line 452, in doc.en.thematic_tutorials.coercion_and_categories
Failed example:
    len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
Expected:
    121
Got:
    122
**********************************************************************
1 item had failures:
   2 of 192 in doc.en.thematic_tutorials.coercion_and_categories
    [191 tests, 2 failures, 0.28 s]
----------------------------------------------------------------------
sage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst  # 2 doctests failed
----------------------------------------------------------------------
```




---

archive/issue_comments_404044.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-02-29T21:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404044",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_404045.json:
```json
{
    "body": "Replying to [comment:21 vbraun]:\n> {{{\n> sage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst\n> **********************************************************************\n> File \"src/doc/en/thematic_tutorials/coercion_and_categories.rst\", line 450, in doc.en.thematic_tutorials.coercion_and_categories\n> Failed example:\n>     len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\n> Expected:\n>     81\n> Got:\n>     82\n> **********************************************************************\n> File \"src/doc/en/thematic_tutorials/coercion_and_categories.rst\", line 452, in doc.en.thematic_tutorials.coercion_and_categories\n> Failed example:\n>     len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\n> Expected:\n>     121\n> Got:\n>     122\n> **********************************************************************\n> 1 item had failures:\n>    2 of 192 in doc.en.thematic_tutorials.coercion_and_categories\n>     [191 tests, 2 failures, 0.28 s]\n> ----------------------------------------------------------------------\n> sage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst  # 2 doctests failed\n> ----------------------------------------------------------------------\n> }}}\n\nHey `@`vbraun, thanks for the pointer. I'm new to contributing to sage and this makes me realise I should run all the doctests before sending PRs. Just a clarification, should I also run the \"long\" tests?\n\nAlso, regarding this change, clearly, the error is because I added a new function so the number of expected functions should increase by one. I can make the change in the test file and send it if that's what is required. However, I tried rebasing with current develop branch and then running the doc test and this gives expected and got values different:\n\n```\nFailed example:\n    len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\nExpected:\n    81\nGot:\n    83\n**********************************************************************\nFile \"src/doc/en/thematic_tutorials/coercion_and_categories.rst\", line 452, in doc.en.thematic_tutorials.coercion_and_categories\nFailed example:\n    len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\nExpected:\n    120\nGot:\n    122\n```\n\nShould I change the doctest before or after rebase?",
    "created_at": "2020-03-02T18:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404045",
    "user": "https://github.com/SagnikDey92"
}
```

Replying to [comment:21 vbraun]:
> {{{
> sage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst
> **********************************************************************
> File "src/doc/en/thematic_tutorials/coercion_and_categories.rst", line 450, in doc.en.thematic_tutorials.coercion_and_categories
> Failed example:
>     len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
> Expected:
>     81
> Got:
>     82
> **********************************************************************
> File "src/doc/en/thematic_tutorials/coercion_and_categories.rst", line 452, in doc.en.thematic_tutorials.coercion_and_categories
> Failed example:
>     len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
> Expected:
>     121
> Got:
>     122
> **********************************************************************
> 1 item had failures:
>    2 of 192 in doc.en.thematic_tutorials.coercion_and_categories
>     [191 tests, 2 failures, 0.28 s]
> ----------------------------------------------------------------------
> sage -t --long --warn-long 35.4 src/doc/en/thematic_tutorials/coercion_and_categories.rst  # 2 doctests failed
> ----------------------------------------------------------------------
> }}}

Hey `@`vbraun, thanks for the pointer. I'm new to contributing to sage and this makes me realise I should run all the doctests before sending PRs. Just a clarification, should I also run the "long" tests?

Also, regarding this change, clearly, the error is because I added a new function so the number of expected functions should increase by one. I can make the change in the test file and send it if that's what is required. However, I tried rebasing with current develop branch and then running the doc test and this gives expected and got values different:

```
Failed example:
    len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
Expected:
    81
Got:
    83
**********************************************************************
File "src/doc/en/thematic_tutorials/coercion_and_categories.rst", line 452, in doc.en.thematic_tutorials.coercion_and_categories
Failed example:
    len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
Expected:
    120
Got:
    122
```

Should I change the doctest before or after rebase?



---

archive/issue_comments_404046.json:
```json
{
    "body": "I would propose this change:\n\n```diff\ndiff --git a/src/doc/en/thematic_tutorials/coercion_and_categories.rst b/src/doc/en/thematic_tutorials/coercion_and_categories.rst\nindex bd76813e9c..b58c9c59de 100644\n--- a/src/doc/en/thematic_tutorials/coercion_and_categories.rst\n+++ b/src/doc/en/thematic_tutorials/coercion_and_categories.rst\n@@ -447,10 +447,10 @@ Sage's category framework can differentiate the two cases::\n And indeed, ``MS2`` has *more* methods than ``MS1``::\n \n     sage: import inspect\n-    sage: len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\n-    81\n-    sage: len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\n-    121\n+    sage: L1 = len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\n+    sage: L2 = len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\n+    sage: L1 < L2\n+    True\n \n This is because the class of ``MS2`` also inherits from the parent\n class for algebras::\n```\n\nThe doctest in question is supposed to demonstrate that there are more methods for square matrices than non-square matrices, but I don't see why the actual numbers should be important. And as we see here, the actual numbers are sensitive to changes in the Sage library; testing `L1 < L2` is more robust.",
    "created_at": "2020-03-02T19:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404046",
    "user": "https://github.com/jhpalmieri"
}
```

I would propose this change:

```diff
diff --git a/src/doc/en/thematic_tutorials/coercion_and_categories.rst b/src/doc/en/thematic_tutorials/coercion_and_categories.rst
index bd76813e9c..b58c9c59de 100644
--- a/src/doc/en/thematic_tutorials/coercion_and_categories.rst
+++ b/src/doc/en/thematic_tutorials/coercion_and_categories.rst
@@ -447,10 +447,10 @@ Sage's category framework can differentiate the two cases::
 And indeed, ``MS2`` has *more* methods than ``MS1``::
 
     sage: import inspect
-    sage: len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
-    81
-    sage: len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
-    121
+    sage: L1 = len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
+    sage: L2 = len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
+    sage: L1 < L2
+    True
 
 This is because the class of ``MS2`` also inherits from the parent
 class for algebras::
```

The doctest in question is supposed to demonstrate that there are more methods for square matrices than non-square matrices, but I don't see why the actual numbers should be important. And as we see here, the actual numbers are sensitive to changes in the Sage library; testing `L1 < L2` is more robust.



---

archive/issue_comments_404047.json:
```json
{
    "body": "Replying to [comment:23 jhpalmieri]:\n> I would propose this change:\n> {{{\n> #!diff\n> diff --git a/src/doc/en/thematic_tutorials/coercion_and_categories.rst b/src/doc/en/thematic_tutorials/coercion_and_categories.rst\n> index bd76813e9c..b58c9c59de 100644\n> --- a/src/doc/en/thematic_tutorials/coercion_and_categories.rst\n> +++ b/src/doc/en/thematic_tutorials/coercion_and_categories.rst\n> `@``@` -447,10 +447,10 `@``@` Sage's category framework can differentiate the two cases::\n>  And indeed, ``MS2`` has *more* methods than ``MS1``::\n>  \n>      sage: import inspect\n> -    sage: len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\n> -    81\n> -    sage: len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\n> -    121\n> +    sage: L1 = len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])\n> +    sage: L2 = len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])\n> +    sage: L1 < L2\n> +    True\n>  \n>  This is because the class of ``MS2`` also inherits from the parent\n>  class for algebras::\n> }}}\n> The doctest in question is supposed to demonstrate that there are more methods for square matrices than non-square matrices, but I don't see why the actual numbers should be important. And as we see here, the actual numbers are sensitive to changes in the Sage library; testing `L1 < L2` is more robust.\n\nOk thank you, I'll make this change. Also, you recently changed the status of #27636 from positive_review to needs work. Can you please make a note there as to what change is required?",
    "created_at": "2020-03-02T19:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404047",
    "user": "https://github.com/SagnikDey92"
}
```

Replying to [comment:23 jhpalmieri]:
> I would propose this change:
> {{{
> #!diff
> diff --git a/src/doc/en/thematic_tutorials/coercion_and_categories.rst b/src/doc/en/thematic_tutorials/coercion_and_categories.rst
> index bd76813e9c..b58c9c59de 100644
> --- a/src/doc/en/thematic_tutorials/coercion_and_categories.rst
> +++ b/src/doc/en/thematic_tutorials/coercion_and_categories.rst
> `@``@` -447,10 +447,10 `@``@` Sage's category framework can differentiate the two cases::
>  And indeed, ``MS2`` has *more* methods than ``MS1``::
>  
>      sage: import inspect
> -    sage: len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
> -    81
> -    sage: len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
> -    121
> +    sage: L1 = len([s for s in dir(MS1) if inspect.ismethod(getattr(MS1,s,None))])
> +    sage: L2 = len([s for s in dir(MS2) if inspect.ismethod(getattr(MS2,s,None))])
> +    sage: L1 < L2
> +    True
>  
>  This is because the class of ``MS2`` also inherits from the parent
>  class for algebras::
> }}}
> The doctest in question is supposed to demonstrate that there are more methods for square matrices than non-square matrices, but I don't see why the actual numbers should be important. And as we see here, the actual numbers are sensitive to changes in the Sage library; testing `L1 < L2` is more robust.

Ok thank you, I'll make this change. Also, you recently changed the status of #27636 from positive_review to needs work. Can you please make a note there as to what change is required?



---

archive/issue_comments_404048.json:
```json
{
    "body": "That was vbraun, not me.",
    "created_at": "2020-03-02T19:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404048",
    "user": "https://github.com/jhpalmieri"
}
```

That was vbraun, not me.



---

archive/issue_comments_404049.json:
```json
{
    "body": "Replying to [comment:25 jhpalmieri]:\n> That was vbraun, not me.\nI'm so sorry I got mixed up...\nI've made the change now. Also, can you confirm if running all the doctests is necessary while sending the PRs? Since it takes some time on my local machine. Clearly only running it in the project folder I made changes to is not enough because this error was completely outside it?\n----\nNew commits:",
    "created_at": "2020-03-02T19:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404049",
    "user": "https://github.com/SagnikDey92"
}
```

Replying to [comment:25 jhpalmieri]:
> That was vbraun, not me.
I'm so sorry I got mixed up...
I've made the change now. Also, can you confirm if running all the doctests is necessary while sending the PRs? Since it takes some time on my local machine. Clearly only running it in the project folder I made changes to is not enough because this error was completely outside it?
----
New commits:



---

archive/issue_comments_404050.json:
```json
{
    "body": "First, the current branch fails to merge.\n\nSecond, it is always best if you run all doctests (`make ptestlong`), but there are bots that run tests as well. You can see their reports by clicking on the circles at the top right of the ticket description box; for this ticket, they take you to the page https://patchbot.sagemath.org/ticket/28882.",
    "created_at": "2020-03-02T19:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404050",
    "user": "https://github.com/jhpalmieri"
}
```

First, the current branch fails to merge.

Second, it is always best if you run all doctests (`make ptestlong`), but there are bots that run tests as well. You can see their reports by clicking on the circles at the top right of the ticket description box; for this ticket, they take you to the page https://patchbot.sagemath.org/ticket/28882.



---

archive/issue_comments_404051.json:
```json
{
    "body": "Here's a branch including that change.\n----\nNew commits:",
    "created_at": "2020-03-02T19:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404051",
    "user": "https://github.com/jhpalmieri"
}
```

Here's a branch including that change.
----
New commits:



---

archive/issue_comments_404052.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-03-02T19:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404052",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_404053.json:
```json
{
    "body": "Replying to [comment:28 jhpalmieri]:\n> First, the current branch fails to merge.\nOh sorry about that. Thank you for correcting it. I'll pull and rebase with current develop on my other branches as well.\n> \n> Second, it is always best if you run all doctests (`make ptestlong`), but there are bots that run tests as well. You can see their reports by clicking on the circles at the top right of the ticket description box; for this ticket, they take you to the page https://patchbot.sagemath.org/ticket/28882.\nThank you!",
    "created_at": "2020-03-02T19:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404053",
    "user": "https://github.com/SagnikDey92"
}
```

Replying to [comment:28 jhpalmieri]:
> First, the current branch fails to merge.
Oh sorry about that. Thank you for correcting it. I'll pull and rebase with current develop on my other branches as well.
> 
> Second, it is always best if you run all doctests (`make ptestlong`), but there are bots that run tests as well. You can see their reports by clicking on the circles at the top right of the ticket description box; for this ticket, they take you to the page https://patchbot.sagemath.org/ticket/28882.
Thank you!



---

archive/issue_comments_404054.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-03T23:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-404054",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073061.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-03T23:21:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28645#event-73061"
}
```
