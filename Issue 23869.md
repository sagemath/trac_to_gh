# Issue 23869: Install packages in temporary root before copying to $SAGE_LOCAL (simplified)

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-10-25 14:52:55

CC:  mkoeppe jdemeyer jhpalimieri

This is a stripped-down version of the patch in #22509, demonstrating the bare minimum functionality required to support staged installation via `DESTDIR`.  It does not add support for this to all packages as #22509 does.  That will require additional followups.

In particular, this supports passing a `SAGE_DESTDIR` variable to spkg build scripts.  In the case of packages installed with `make install`, this is passed to `make` as `DESTDIR=$SAGE_DESTDIR`.  Not all packages that use make support this (but most do).  For those that don't this is a no-op. The `sage-spkg` command then takes advantage of this by setting `$SAGE_DESTDIR` to a standard value before running the package build/install scripts.  It then uses the temporary install directory to generate a manifest for the package.  Currently this can be seen in action with the `patch` package (the only package currently using `sdh_make_install`).  With this patch applied:


```
$ ./sage -f patch
...
$ cat local/var/lib/sage/installed/patch-2.7.5
{
    "package_name": "patch",
    "package_version": "2.7.5",
    "install_date": "Wed Oct 25 14:32:16 UTC 2017",
    "system_uname": "Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux",
    "sage_version": "SageMath version 8.1.beta7, Release Date: 2017-10-03",
    "test_result": "",
    "files": [
        "bin/patch",
        "share/man/man1/patch.1"
    ]
}
```


The installed files are listed relative to `$SAGE_LOCAL`, and does not include empty directories (in a git-like manner).  This is because directories are not typically owned by a single package, only files.  In the rare case where an empty directory needs to be owned by a specific package, a placeholder file should be added to that directory (this is typical in some Linux distributions as well).

The same could be done easily for Python packages by having `sdh_pip_install` add `--root=${SAGE_DESTDIR}`, but currently that breaks a tiny set of Python packages whose build scripts do not fully support this kind of staged installation, so their case will be addressed separately.


---

Comment by embray created at 2017-10-25 14:54:14

CC'd people who have already shown interest in this work.


---

Comment by embray created at 2017-10-25 14:54:14

Changing status from new to needs_review.


---

Comment by embray created at 2017-10-25 14:54:14

Changing component from PLEASE CHANGE to build.


---

Comment by embray created at 2017-10-25 14:55:01

Depends on #24017 for merge consistency.


---

Comment by git created at 2017-10-25 15:21:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-31 15:18:06

The patchbot failure is due to #24092 so I'm going to merge that *sigh*


---

Comment by git created at 2017-10-31 15:19:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-11-27 16:21:19

What is the proof of concept package to test with this ticket? It's not clear to me.


---

Comment by embray created at 2017-11-27 16:48:08

Patch, mainly.


---

Comment by jdemeyer created at 2017-11-28 09:48:54

I'm getting a 500 Internal Server Error when clicking the branch on this ticket.


---

Comment by jdemeyer created at 2017-11-28 09:55:27

What is `$(pwd)` in this case?

```
export SAGE_DESTDIR="$(pwd)/inst"
```

Can we be more explicit and write

```
export SAGE_DESTDIR="${SAGE_BUILD_DIR}/${PKG_NAME}/inst"
```



---

Comment by jdemeyer created at 2017-11-28 09:56:36

I'd rather wait until #24025 has been merged in a beta before fully reviewing this.


---

Comment by embray created at 2017-11-28 13:41:39

Well the "milestone" for #24025 is set to 8.1, but that is apparently meaningless...


---

Comment by dimpase created at 2017-12-18 10:17:12

with `ccache` installed, I get a problem with this ticket; it tries to rebuild `ccache`, and at the very end of the installation of `ccache` I get

```
Copying package files from temporary location /home/dima/Sage/sage-dev/local/var/tmp/sage/build/ccache-3.2.2.p0/inst to /home/dima/Sage/sage-dev/local
cp: cannot create regular file '/home/dima/Sage/sage-dev/local/bin/ccache': Text file busy
************************************************************************
Error copying files for ccache.
************************************************************************
```


So probably one needs to somehow uninstall ccache beforehand...


---

Comment by jdemeyer created at 2018-01-05 10:53:44

1. As mentioned in [comment:9], it would be nice to more explicit here:

```
export SAGE_DESTDIR="$(pwd)/inst"
```


2. It could possibly be a lot more efficient (and also simpler) to _move_ instead of _copy_ the files from `SAGE_DESTDIR` to `SAGE_LOCAL`. Is there any good reason to keep the files in `SAGE_DESTDIR`?


---

Comment by jdemeyer created at 2018-01-05 10:53:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-01-05 10:57:52

Replying to [comment:13 dimpase]:
> `cp: cannot create regular file '/home/dima/Sage/sage-dev/local/bin/ccache': Text file busy`

This is also fixed by moving instead of copying (on my Linux box at least, but that might be POSIX-specified behaviour)


---

Comment by embray created at 2018-01-05 12:16:01

On occasion I've found it useful for debugging purposes to be able to inspect the contents of the destdir.  That said, as long as the system is working correctly, the results can just as easily be inspected directly in `$SAGE_LOCAL`, so I wouldn't be opposed to giving move a try.


---

Comment by git created at 2018-01-15 10:02:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-01-15 10:38:13

Turns out this is also broken until and unless at least a few packages get some small updates to their spkg-installs to support this mode of installation.


---

Comment by dimpase created at 2018-01-15 11:18:34

what are these small updates? are they already in?


---

Comment by embray created at 2018-01-15 15:16:39

No, I'll push them to this branch once I know what they are (i.e. after the build completes successfully).  I think it's small enough for now that it's okay to roll into this.


---

Comment by embray created at 2018-01-15 15:20:02

Replying to [comment:20 embray]:
> No, I'll push them to this branch once I know what they are (i.e. after the build completes successfully).  I think it's small enough for now that it's okay to roll into this.

If it turns out to be more I'll split it out.  This is mostly a matter of some packages that were updated in #24025 that perform a few additional actions on files in `$SAGE_LOCAL` that really should be working on `$SAGE_DESTDIR$SAGE_LOCAL`.


---

Comment by git created at 2018-01-16 12:55:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-16 12:58:48

I added the aforementioned tweaks.  It's likely others are needed, but these were the minimal fixes I needed for a successful build from scratch.

The one change that's a bit sketchy is the removal of the "sanity check" from patch's `spkg-install`.  I really don't think it's needed at all, but if we really wanted to keep it it would make more sense as a post-install step.

#22509 has a feature of allowing packages to include a `spkg-postinst` script that is run on the package after it's already been fully copied into `$SAGE_LOCAL`.  I left it out of this ticket to keep things simple, but I could add it back in, as it doesn't add very much complexity at all.


---

Comment by embray created at 2018-01-16 14:33:03

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-01-16 15:52:37

Looks good on first sight. Am I right that this affects only packages using `sdh_make_install`?


---

Comment by embray created at 2018-01-16 16:02:31

Replying to [comment:25 jdemeyer]:
> Looks good on first sight. Am I right that this affects only packages using `sdh_make_install`?

Right now, yes.  Obviously long-term it will affect all packages (as is the case for the original #22509), but for this ticket those are the only packages that are affected.


---

Comment by jdemeyer created at 2018-01-16 18:19:39

Is blocking internet access to unknown ports "a thing" in France? I'm in Besan√ßon right now and both the university network as well as my hotel network block SSH access (on a non-standard port) to a testing machine that I use for testing build-related tickets such as this one. I'd rather not reinstall Sage from scratch on my laptop, so could you please double-check that `make distclean; make ptest` passes with this ticket applied?


---

Comment by embray created at 2018-01-17 12:17:15

I don't think it's "a thing" in France any more than it is at any other random network.  I've also had problems at my university with very tight firewalls.


---

Comment by embray created at 2018-01-17 12:17:39

I feel like I just tested that that works yesterday, but I'll do it one more time....


---

Comment by embray created at 2018-01-17 13:41:32

The recent build failure of this on the Cygwin patchbot appears to be unrelated, though it's not entirely clear to me what happened.  I have a feeling there are still some unresolved race conditions involved in running DLL rebase.


---

Comment by embray created at 2018-01-17 15:04:22

Confirmed, build from scratch worked, at least on Linux.  I'm going to try on OSX too.  I now have (supposedly) access to an OSX machine to test on, though I haven't actually tried building Sage on it yet...


---

Comment by dimpase created at 2018-01-18 09:44:12

Replying to [comment:31 embray]:
> Confirmed, build from scratch worked, at least on Linux.  I'm going to try on OSX too.  I now have (supposedly) access to an OSX machine to test on, though I haven't actually tried building Sage on it yet...

I am using an OSX machine at LRI, trac.lri.fr, to run tests, etc.
If it's the same as you mean to use, it's probably better not to try doing it at the same time...

If you like I can test this branch there, as I'm planning to try the new beta from scratch anyway.


---

Comment by jdemeyer created at 2018-01-18 09:45:12

Please do test!


---

Comment by embray created at 2018-01-18 10:54:51

Worked fine for me on Cygwin locally--whatever went wrong with the patchbot is probably an unrelated fluke.


---

Comment by dimpase created at 2018-01-19 01:10:26

it builds on OSX just fine. Any other tests to run?


---

Comment by embray created at 2018-01-19 09:33:13

Replying to [comment:35 dimpase]:
> it builds on OSX just fine.

Thanks for checking that!

> Any other tests to run?

Not as far as I'm concerned.  It might be nice to get a patch bot to say it's good.  I think I'm going to reconfigure the docker patchbot to run "unsafe" tickets.


---

Comment by jdemeyer created at 2018-01-19 09:50:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-20 20:20:20

Resolution: fixed
