# Issue 18899: NO and NU graphs

Issue created by migration from https://trac.sagemath.org/ticket/19136

Original creator: dimpase

Original creation time: 2015-09-04 16:21:25

CC:  ncohen

add strongly regular graphs on non-isotropic points of various forms, orthogonal and Hermitean. see http://www.win.tue.nl/~aeb/graphs/srghub.html and p.145 of http://www.win.tue.nl/~aeb/2WF02/spectra.pdf


---

Comment by ncohen created at 2015-09-04 16:22:23

You know how to build those ? COOL `O_O`

They are like the main race of the graphs that we still can't build.

Nathann


---

Comment by dimpase created at 2015-09-04 16:28:02

Replying to [comment:1 ncohen]:
> You know how to build those ? COOL `O_O`
most of it should be trivial modifications of polar graph functions.
I think I also should do refactoring of `graphs/generators/families` here...

> 
> They are like the main race of the graphs that we still can't build.

there still `skewhad*` and `Pasechnik`, which need some skew-Hadamard matrices...
These still need few not  too trivial constructions by Williams to be implemented.


---

Comment by ncohen created at 2015-09-04 16:29:45

> most of it should be trivial modifications of polar graph functions.
> I think I also should do refactoring of `graphs/generators/families` here...

Yepyep, create the new module and update the names.

> there still `skewhad*` and `Pasechnik`, which need some skew-Hadamard matrices...
> These still need few not  too trivial constructions by Williams to be implemented.

I'm eager to have a `graphs.PasechnikGraph` `;-)`

Nathann


---

Comment by dimpase created at 2015-09-07 05:04:55

Last 10 new commits:


---

Comment by dimpase created at 2015-09-07 05:07:27

does this function naming

```
def NonisotropicOrthogonalPolarGraphF2(m, sign="+"):
    r"""
    Returns the Graph of Nonisotropic Points of a quadric `NO^{\epsilon}_{2m}(2)`.
```

sound about right?


---

Comment by ncohen created at 2015-09-07 09:01:20

Dima, your branch are next-to-impossible to review. Not only you always add 10 micro-commits [1], but in this case I can't even figure out which commits *move* code around, and which commits add/modify code.

And I can't review again code that has been checked in the past.

Nathann

[1] That's what "rewriting history" is for. So that the history of your branch is not the 'history of times where you saved your files' (which has no logic of its own) but an intelligent splitting of the work your ticket does.


---

Comment by ncohen created at 2015-09-07 09:02:28

Really, look at that: http://git.sagemath.org/sage.git/log/?q=70f7b1c5d206e8627f3d124a28b7083e3a82313a..abf0a5e6f9a2aa52550555d77e9bfc654ad59399&h=abf0a5e6f9a2aa52550555d77e9bfc654ad59399&qt=range

As you do not even include the number of the tickets in the commit, you can't even tell what belongs to this ticket and what belongs to another.


---

Comment by dimpase created at 2015-09-07 14:07:44

Dude, this ticket is not ready for review  by far! the branch is just a backup of work in progress...


---

Comment by ncohen created at 2015-09-07 15:03:02

Oh. My mistake. Sorry.


---

Comment by git created at 2015-09-08 21:48:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-09 05:12:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-10 06:26:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-10 18:19:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-09-10 19:48:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-09-10 19:49:47

with the latest commit, we only miss 152 graphs...

For this ticket to be done, we need parameters of NU(n,q)-srg's.


---

Comment by git created at 2015-09-11 06:41:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-11 19:27:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2015-09-11 19:29:38

the patchbomb is ready!


---

Comment by dimpase created at 2015-09-11 19:29:38

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-09-12 06:39:24

Could you make it easier to review, by having a commit that only *moves* the code from the old file to the new one? Otherwise it is very difficult to figure out what was just moved and what has to be reviewed again.

Nathann


---

Comment by dimpase created at 2015-09-12 07:31:37

Replying to [comment:20 ncohen]:
> Could you make it easier to review, by having a commit that only *moves* the code from the old file to the new one? Otherwise it is very difficult to figure out what was just moved and what has to be reviewed again.

The closest approximation of this is the 1st commit on the ticket, 	22114b7a6ada54c4c66a9b5705a2c2233046a61f

The bottom part of graphs/generators/families.py was chopped off and saved into the initial
graphs/generators/classical_geometries.py
And stuff happened to SymplecticGraph (it got renamed and deprecated).

Unfortunately I did not record this as two separate commits, and I don't see how I could change this now without much effort...


---

Comment by ncohen created at 2015-09-12 07:45:17

> Unfortunately I did not record this as two separate commits, and I don't see how I could change this now without much effort...

How do you think I should review this ticket, then? Re-review everything?


---

Comment by ncohen created at 2015-09-12 17:18:58

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-09-12 17:18:58

Hello Dima,

Here is a first-pass review.

- `graphs.SymplecticGraph` does not exist. It is not enough to create a
  deprecation alias, it must also be available in `graphs.<tab>`.

- In `NonisotropicOrthogonalPolarGraph`. Replace
  {{{
  else:
      if not perp is None:
         <code>
      else:
  }}}
  with
  {{{
  elif not perp is None:
         <code>
  else:
  }}}
  No need to indent everything twice.

- same function: `q` does not appear in the INPUT block

- same function: move the checks on q (prime power) and sign (+-) to the
  beginning of the function (not in a 'if' block). This function builds a
  (dense) graph, we are not at a level where we try to minimize the amount of
  unnecessary 'if'.

- REFERENCE block happens at the end of the docstring

- Remove the commented code that your functions contain

- Why 5 `is_NO*` functions instead of one `is_NO` ? I remember a comment of
  yours about copy/paste...

- If your function is slow it is because of that line
  {{{
  G = Graph([V,lambda x,y:P(vector(x),vector(y))==0],loops=False)
  }}}
  When you do this, 'vector' is called 'binomial(n,2)' times, and `vector` is
  *SLOW*. In a previous branch of yours, I added a commit to remove this in
  order to gain a large speedup (do you remember)? Try to find a way to avoid
  vectors. If you cannot, then instead of building `n^2` vectors you should turn
  everything into a vector *once*, and work on vectors instead. Observe that
  vectors have a `.set_immutable` method.

  Then, perhaps we will be able to remove those `# long time` everywhere in
  `_orthogonal_polar_graph` (and elsewhere).

- Same in `UnitaryPolarGraph`.

Next time, please think of the reviewer when you built your commits. When you
save minutes by not doing it, the reviewer loses hours trying to figure out what
exactly you did.

Thanks for the addition, however. I couldn't have done that.

Nathann

P.S.: Fill the 'authors' field. Think of doing it when you set your tickets to `needs_review`.


---

Comment by dimpase created at 2015-09-12 17:22:11

Replying to [comment:22 ncohen]:
> > Unfortunately I did not record this as two separate commits, and I don't see how I could change this now without much effort...
> 
> How do you think I should review this ticket, then? Re-review everything?

Splitting a file into two isn't really specially supported by git, no?
That is, in the new file one can potentially put anything..

%%% while I was writing this I saw your review, thanks! anyhow I'll leave it here just in case.

You can do the following: check out 22114b7a6ada54c4c66a9b5705a2c2233046a61f, 
take graphs/generators/classical_geometries.py and remove the top part before the first def.
Now join the result to the bottom of graphs/generators/families.py

Now you can look at the diff of the resulting graphs/generators/families.py and 
graphs/generators/families.py from the appropriate beta.
You will see all what happened at 22114b7a6ada54c4c66a9b5705a2c2233046a61f this way.

After that you can review the diff of the ticket branch against 22114b7a6ada54c4c66a9b5705a2c2233046a61f.


---

Comment by ncohen created at 2015-09-12 17:26:05

> Splitting a file into two isn't really specially supported by git, no?

No indeed, but you can make it easier for the reviewer this way:

1) Make a first commit that just *moves* code from one file to another. It is very easy to check something like that: I only have to make the same move in the other direction, and check that the two commits add up to no modification at all.

2) After this first commit the code may not compile (because of broken import and stuff). You can then change code wherever you like to adapt to it.

3) Do whatever else you need to do in this branch.

This way, after checking the first commit, I can review the diff of all commits except the first.

> You can do the following:

Thanks. I'll try it.

Nathann


---

Comment by git created at 2015-09-13 05:34:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2015-09-13 05:41:02

Replying to [comment:23 ncohen]:

> - `graphs.SymplecticGraph` does not exist. It is not enough to create a
>   deprecation alias, it must also be available in `graphs.<tab>`.

done
> 
> - In `NonisotropicOrthogonalPolarGraph`. Replace
>   {{{
>   else:
>       if not perp is None:
>          <code>
>       else:
>   }}}
>   with
>   {{{
>   elif not perp is None:
>          <code>
>   else:
>   }}}
>   No need to indent everything twice.

done

> 
> - same function: `q` does not appear in the INPUT block

done

> 
> - same function: move the checks on q (prime power) and sign (+-) to the
>   beginning of the function (not in a 'if' block). This function builds a
>   (dense) graph, we are not at a level where we try to minimize the amount of
>   unnecessary 'if'.

done

> 
> - REFERENCE block happens at the end of the docstring

done (moved REFERENCE twice)
> 
> - Remove the commented code that your functions contain

hmm, where? I've better worded a comment that looked  as code, but otherwise...

> 
> - Why 5 `is_NO*` functions instead of one `is_NO` ? I remember a comment of
>   yours about copy/paste...

it's because the arithmetic properties of parameters are quite different in each of these
cases. Each has a different algorithm coded.

> 
> - If your function is slow it is because of that line
>   {{{
>   G = Graph([V,lambda x,y:P(vector(x),vector(y))==0],loops=False)
>   }}}
>   When you do this, 'vector' is called 'binomial(n,2)' times, and `vector` is
>   *SLOW*. In a previous branch of yours, I added a commit to remove this in
>   order to gain a large speedup (do you remember)? Try to find a way to avoid
>   vectors. If you cannot, then instead of building `n^2` vectors you should turn
>   everything into a vector *once*, and work on vectors instead. Observe that
>   vectors have a `.set_immutable` method.

OK, I did the latter. Totally getting rid of `vector()` in these cases seems tricky.
Anyhow, it was quite an improvement.

> 
>   Then, perhaps we will be able to remove those `# long time` everywhere in
>   `_orthogonal_polar_graph` (and elsewhere).

done

> 
> - Same in `UnitaryPolarGraph`.

done (as above)


> 
> Next time, please think of the reviewer when you built your commits. When you
> save minutes by not doing it, the reviewer loses hours trying to figure out what
> exactly you did.

sorry for the mess...


---

Comment by dimpase created at 2015-09-13 05:41:14

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-09-13 06:49:19

Hellooooooo,

> > - Remove the commented code that your functions contain
> 
> hmm, where? I've better worded a comment that looked  as code, but otherwise...


```
(tmp|✔)~/sage/graphs$ grep "^# " strongly_regular_db.pyx
# -*- coding: utf-8 -*-
#    print "ev: ", r, " ", s, "\n"
#    print "p=", p, " t=", t, " r=", r, " s=", s,"\n"
#            print "2nd try: p=", p, " t=", t, " r=", r, " s=", s,"\n"
#    print "q=", q, "e=", e, "\n"
#    n  = t/kk + 2
#    print q**(n-1)*(q**n - e)/(q + 1), " ",\
#          (q**(n-1) + e)*(q**(n-2) - e), " ",\
#          q**(2*n-5)*(q+1) - e*q**(n-2)*(q-1) - 2, " ",\
#          q**(n-3)*(q + 1)*(q**(n-2) - e),"\n"
```


> > - Why 5 `is_NO*` functions instead of one `is_NO` ? I remember a comment of
> >   yours about copy/paste...
> 
> it's because the arithmetic properties of parameters are quite different in each of these
> cases. Each has a different algorithm coded.

So the test is different in each case, but the tests for prime powers, the ordering or `s,r`, the eigenvalues.. All this is common (not to mention a big part of the doc). Why not one function, with several 'if' for each case?

Nathann


---

Comment by git created at 2015-09-13 06:58:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2015-09-13 07:10:56

Replying to [comment:30 ncohen]:

> {{{
> (tmp|✔)~/sage/graphs$ grep "^# " strongly_regular_db.pyx
> # -*- coding: utf-8 -*-
> #    print "ev: ", r, " ", s, "\n"
> #    print "p=", p, " t=", t, " r=", r, " s=", s,"\n"
> #            print "2nd try: p=", p, " t=", t, " r=", r, " s=", s,"\n"
> #    print "q=", q, "e=", e, "\n"
> #    n  = t/kk + 2
> #    print q**(n-1)*(q**n - e)/(q + 1), " ",\
> #          (q**(n-1) + e)*(q**(n-2) - e), " ",\
> #          q**(2*n-5)*(q+1) - e*q**(n-2)*(q-1) - 2, " ",\
> #          q**(n-3)*(q + 1)*(q**(n-2) - e),"\n"
> }}}

OK, removed, sorry.

> 
> > > - Why 5 `is_NO*` functions instead of one `is_NO` ? I remember a comment of
> > >   yours about copy/paste...
> > 
> > it's because the arithmetic properties of parameters are quite different in each of these
> > cases. Each has a different algorithm coded.
> 
> So the test is different in each case, but the tests for prime powers, the ordering or `s,r`, the eigenvalues..

no, read the code: in some cases eigenvalues aren't even computed; if they are used then they are used differently in different functions, etc. Also note that there is a lot in common between all of the following:

```
is_affine_polar,is_orthogonal_polar,is_NOodd, is_NOperp_F5,
is_NO_F2, is_NO_F3, is_NU,
is_unitary_polar,is_unitary_dual_polar
```


And most of these test for more than one series of graphs, if you count all these '+', '-', etc.

> All this is common (not to mention a big part of the doc). Why not one function, with several 'if' for each case?

because several ifs suck and make code unreadable and harder to debug, and hard to document and test. Imagine e.g. how hard it would be to figure out what doctest tests what.


---

Comment by ncohen created at 2015-09-13 08:07:35

Yo,

> no, read the code: in some cases eigenvalues aren't even computed;

Depends how you see it. If you compute eigenvalues in several functions that could be merged, that you compute them too many times. If it were only one function, it wouldn't be the case.

> because several ifs suck and make code unreadable and harder to debug, and hard to document and test. Imagine e.g. how hard it would be to figure out what doctest tests what.

While you were developing it perhaps, but there is nothing to debug now, right?


---

Comment by ncohen created at 2015-09-13 08:35:52

Okay, let's get this merged. You and I seldom agree on anything when it comes to design, and the code works well anyway. I have been building all graphs for which we detect a constructions up to 1000+, and there is no problem there: we get the SRG we ask for, each time. And there is no N<whatever> in the list of graphs we miss.

Thanks,

Nathann


---

Comment by ncohen created at 2015-09-13 08:35:52

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2015-09-14 17:49:16

Replying to [comment:34 ncohen]:
> Okay, let's get this merged. You and I seldom agree on anything when it comes to design, and the code works well anyway. I have been building all graphs for which we detect a constructions up to 1000+, and there is no problem there: we get the SRG we ask for, each time. And there is no N<whatever> in the list of graphs we miss.
> 

we can refactor the code so that eigenvalues are computed very early and get
passed around as parameters to the `is_BLAH()` functions that use them.
Perhaps I'll do this some time later, if you don't mind.

OK, so we still have big classes to cover: 

  * GQs (of order (q-1,q+1) and (q+1,q-1), the others are there already).
  * skew-Hadamard and relatives (I promised to work on this already...)
  * Goethals-Seidel (8.C in [BvL84]; seems to be easy to do)
  * Mathon: symmetric conference matrices (8.B in [BvL84])

I easily can do GQs, too, unless you already are on them...


---

Comment by vbraun created at 2015-09-14 19:01:14

Resolution: fixed


---

Comment by ncohen created at 2015-09-14 20:41:40

> we can refactor the code so that eigenvalues are computed very early and get
> passed around as parameters to the `is_BLAH()` functions that use them.
> Perhaps I'll do this some time later, if you don't mind.

Indeed. No need to think of that before computing the eigenvalues becomes a critical cost.

> OK, so we still have big classes to cover: 
> 
>   * GQs (of order (q-1,q+1) and (q+1,q-1), the others are there already).
>   * skew-Hadamard and relatives (I promised to work on this already...)
>   * Goethals-Seidel (8.C in [BvL84]; seems to be easy to do)
>   * Mathon: symmetric conference matrices (8.B in [BvL84])
> 
> I easily can do GQs, too, unless you already are on them...

Err.. To be honest I don't know exactly which ones I could work on. If you tell me that you know how to deal with these classes then I can print the list of those that remain and see those that I can settle, as that would give me a starting point.

Nathann
