# Issue 14323: chromatic_polynomial - fixed memory leak and added new test cases

archive/issues_014323.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\nCC:  ncohen stefan slani\n\nThis patch fixes a minor memory leak in the chromatic polynomial code. It appears to me that the mpz variables should be freed at the end of the function.\n\nI have also added additional tests.\n\nThe code appears not to be practical for graphs of order +15. I am wondering if we could gain some speed by using memoization. It would complicate the code quite a bit but it might be a drastic improvement!\n\nIssue created by migration from https://trac.sagemath.org/ticket/14527\n\n",
    "created_at": "2013-05-04T08:34:19Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "chromatic_polynomial - fixed memory leak and added new test cases",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14323",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```
Assignee: jason, ncohen, rlm

CC:  ncohen stefan slani

This patch fixes a minor memory leak in the chromatic polynomial code. It appears to me that the mpz variables should be freed at the end of the function.

I have also added additional tests.

The code appears not to be practical for graphs of order +15. I am wondering if we could gain some speed by using memoization. It would complicate the code quite a bit but it might be a drastic improvement!

Issue created by migration from https://trac.sagemath.org/ticket/14527





---

archive/issue_comments_180581.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-04T08:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180581",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_180582.json:
```json
{
    "body": "Looks right ! Is there any reason why every `coeffs[i]` and `m` should not be cleared too ?\n\nNathann",
    "created_at": "2013-05-04T08:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180582",
    "user": "https://github.com/nathanncohen"
}
```

Looks right ! Is there any reason why every `coeffs[i]` and `m` should not be cleared too ?

Nathann



---

archive/issue_comments_180583.json:
```json
{
    "body": "m is a single mpz_t variable and is correctly freed in this patch. As for coeffs[i] you're right - nice catch. That should be freed as well IMO.\n\nI've attached a patch fixing this remark as well. Can you check if it makes sense to stack patches like that?\n\nPS. What is the status of the edge contraction code? I would like to test this memonization thing that I talk about..",
    "created_at": "2013-05-04T09:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180583",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

m is a single mpz_t variable and is correctly freed in this patch. As for coeffs[i] you're right - nice catch. That should be freed as well IMO.

I've attached a patch fixing this remark as well. Can you check if it makes sense to stack patches like that?

PS. What is the status of the edge contraction code? I would like to test this memonization thing that I talk about..



---

archive/issue_comments_180584.json:
```json
{
    "body": "Attachment [trac_14527_chrompoly2.patch](tarball://root/attachments/some-uuid/ticket14527/trac_14527_chrompoly2.patch) by @nathanncohen created at 2013-05-04 09:32:57\n\n> I've attached a patch fixing this remark as well. Can you check if it makes sense to stack patches like that?\n\n\nYeah it does. We do it often when we use Mercurial Queue, but if you don't perhaps it is not worth trying it... considering that we will switch to git soon (wheeeeeeeeeen ??)\n\n> PS. What is the status of the edge contraction code? I would like to test this memonization thing that I talk about..\n\n\nThe status ? Well, it has been there for years and never touched again :\n\n```\n~/sage/graphs$ hg log -r 13627\nchangeset:   13627:50d1cb107fc3\nuser:        Robert Miller <rlm@rlmiller.org>\ndate:        Thu Jan 14 00:38:41 2010 -0800\nsummary:     Added tag 4.3.1.alpha3 for changeset 79eb28e13210\n\n~/sage/graphs$ hg log -r 8924\nchangeset:   8924:ec7c9745bc66\nuser:        Robert L. Miller <rlm@rlmiller.org>\ndate:        Tue Mar 11 16:41:10 2008 -0700\nsummary:     chromatic polynomial revisited\n```\n\nNathann",
    "created_at": "2013-05-04T09:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180584",
    "user": "https://github.com/nathanncohen"
}
```

Attachment [trac_14527_chrompoly2.patch](tarball://root/attachments/some-uuid/ticket14527/trac_14527_chrompoly2.patch) by @nathanncohen created at 2013-05-04 09:32:57

> I've attached a patch fixing this remark as well. Can you check if it makes sense to stack patches like that?


Yeah it does. We do it often when we use Mercurial Queue, but if you don't perhaps it is not worth trying it... considering that we will switch to git soon (wheeeeeeeeeen ??)

> PS. What is the status of the edge contraction code? I would like to test this memonization thing that I talk about..


The status ? Well, it has been there for years and never touched again :

```
~/sage/graphs$ hg log -r 13627
changeset:   13627:50d1cb107fc3
user:        Robert Miller <rlm@rlmiller.org>
date:        Thu Jan 14 00:38:41 2010 -0800
summary:     Added tag 4.3.1.alpha3 for changeset 79eb28e13210

~/sage/graphs$ hg log -r 8924
changeset:   8924:ec7c9745bc66
user:        Robert L. Miller <rlm@rlmiller.org>
date:        Tue Mar 11 16:41:10 2008 -0700
summary:     chromatic polynomial revisited
```

Nathann



---

archive/issue_comments_180585.json:
```json
{
    "body": "To me this test on a random graph is too long, too `:-/`\n\n```\nsage: %time G.chromatic_polynomial()\nCPU times: user 9.76 s, sys: 0.00 s, total: 9.76 s\nWall time: 9.81 s\nx^13 - 57*x^12 + 1486*x^11 - 23364*x^10 + 245983*x^9 - 1820644*x^8 + 9675792*x^7 - 37032141*x^6 + 100750221*x^5 - 188744964*x^4 + 229141077*x^3 - 160012790*x^2 + 47819400*x\n```\n\nI understand what you want to do with these long tests, but I really think that people around will not like the side-effects if we keep on like that `:-/`\n\nNathann",
    "created_at": "2013-05-04T09:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180585",
    "user": "https://github.com/nathanncohen"
}
```

To me this test on a random graph is too long, too `:-/`

```
sage: %time G.chromatic_polynomial()
CPU times: user 9.76 s, sys: 0.00 s, total: 9.76 s
Wall time: 9.81 s
x^13 - 57*x^12 + 1486*x^11 - 23364*x^10 + 245983*x^9 - 1820644*x^8 + 9675792*x^7 - 37032141*x^6 + 100750221*x^5 - 188744964*x^4 + 229141077*x^3 - 160012790*x^2 + 47819400*x
```

I understand what you want to do with these long tests, but I really think that people around will not like the side-effects if we keep on like that `:-/`

Nathann



---

archive/issue_comments_180586.json:
```json
{
    "body": "Replying to [comment:4 ncohen]:\n> > I've attached a patch fixing this remark as well. Can you check if it makes sense to stack patches like that?\n\n> \n> Yeah it does. We do it often when we use Mercurial Queue, but if you don't perhaps it is not worth trying it... considering that we will switch to git soon (wheeeeeeeeeen ??)\nInteresting. What is the reason for switching to Git? Its because Linus uses it right???\n\n> \n> > PS. What is the status of the edge contraction code? I would like to test this memonization thing that I talk about..\n  \nNonono not this! I was asking about the code that you guys were doing that allows *contracting* an edge of a graph. I am not sure this thing was accepted yet? \n\n> \n> The status ? Well, it has been there for years and never touched again :\n> \n> \n> ```\n> ~/sage/graphs$ hg log -r 13627\n> changeset:   13627:50d1cb107fc3\n> user:        Robert Miller <rlm@rlmiller.org>\n> date:        Thu Jan 14 00:38:41 2010 -0800\n> summary:     Added tag 4.3.1.alpha3 for changeset 79eb28e13210\n> \n> ~/sage/graphs$ hg log -r 8924\n> changeset:   8924:ec7c9745bc66\n> user:        Robert L. Miller <rlm@rlmiller.org>\n> date:        Tue Mar 11 16:41:10 2008 -0700\n> summary:     chromatic polynomial revisited\n> ```\n> \n> Nathann",
    "created_at": "2013-05-04T10:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180586",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

Replying to [comment:4 ncohen]:
> > I've attached a patch fixing this remark as well. Can you check if it makes sense to stack patches like that?

> 
> Yeah it does. We do it often when we use Mercurial Queue, but if you don't perhaps it is not worth trying it... considering that we will switch to git soon (wheeeeeeeeeen ??)
Interesting. What is the reason for switching to Git? Its because Linus uses it right???

> 
> > PS. What is the status of the edge contraction code? I would like to test this memonization thing that I talk about..
  
Nonono not this! I was asking about the code that you guys were doing that allows *contracting* an edge of a graph. I am not sure this thing was accepted yet? 

> 
> The status ? Well, it has been there for years and never touched again :
> 
> 
> ```
> ~/sage/graphs$ hg log -r 13627
> changeset:   13627:50d1cb107fc3
> user:        Robert Miller <rlm@rlmiller.org>
> date:        Thu Jan 14 00:38:41 2010 -0800
> summary:     Added tag 4.3.1.alpha3 for changeset 79eb28e13210
> 
> ~/sage/graphs$ hg log -r 8924
> changeset:   8924:ec7c9745bc66
> user:        Robert L. Miller <rlm@rlmiller.org>
> date:        Tue Mar 11 16:41:10 2008 -0700
> summary:     chromatic polynomial revisited
> ```
> 
> Nathann



---

archive/issue_comments_180587.json:
```json
{
    "body": "Replying to [comment:5 ncohen]:\n> To me this test on a random graph is too long, too `:-/`\n> \n> \n> ```\n> sage: %time G.chromatic_polynomial()\n> CPU times: user 9.76 s, sys: 0.00 s, total: 9.76 s\n> Wall time: 9.81 s\n> x^13 - 57*x^12 + 1486*x^11 - 23364*x^10 + 245983*x^9 - 1820644*x^8 + 9675792*x^7 - 37032141*x^6 + 100750221*x^5 - 188744964*x^4 + 229141077*x^3 - 160012790*x^2 + 47819400*x\n> ```\n> \n> I understand what you want to do with these long tests, but I really think that people around will not like the side-effects if we keep on like that `:-/`\n> \n> Nathann\n\n\nI understand yes. Somehow I was thought to always extensively and insanely test software. The fact that i use this for research made me exaggerate even more.\n\nI still think that's the way to go but I completely agree with you that in the current setting this might not be the best way to go :-)",
    "created_at": "2013-05-04T10:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180587",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

Replying to [comment:5 ncohen]:
> To me this test on a random graph is too long, too `:-/`
> 
> 
> ```
> sage: %time G.chromatic_polynomial()
> CPU times: user 9.76 s, sys: 0.00 s, total: 9.76 s
> Wall time: 9.81 s
> x^13 - 57*x^12 + 1486*x^11 - 23364*x^10 + 245983*x^9 - 1820644*x^8 + 9675792*x^7 - 37032141*x^6 + 100750221*x^5 - 188744964*x^4 + 229141077*x^3 - 160012790*x^2 + 47819400*x
> ```
> 
> I understand what you want to do with these long tests, but I really think that people around will not like the side-effects if we keep on like that `:-/`
> 
> Nathann


I understand yes. Somehow I was thought to always extensively and insanely test software. The fact that i use this for research made me exaggerate even more.

I still think that's the way to go but I completely agree with you that in the current setting this might not be the best way to go :-)



---

archive/issue_comments_180588.json:
```json
{
    "body": "> Interesting. What is the reason for switching to Git? Its because Linus uses it right???\n\n\nFrom my point of view, it is because some Sage developpers think that it is great. And I've been contaminated by their enthusiasm, even though I barely used it `:-P`\n\n> Nonono not this! I was asking about the code that you guys were doing that allows *contracting* an edge of a graph. I am not sure this thing was accepted yet? \n\n\nOh. I don't know where it stands. I hate that patch. But honestly, if you want efficient code, rewrite your own. It is not a long code anyway.\n\nNathann",
    "created_at": "2013-05-04T10:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180588",
    "user": "https://github.com/nathanncohen"
}
```

> Interesting. What is the reason for switching to Git? Its because Linus uses it right???


From my point of view, it is because some Sage developpers think that it is great. And I've been contaminated by their enthusiasm, even though I barely used it `:-P`

> Nonono not this! I was asking about the code that you guys were doing that allows *contracting* an edge of a graph. I am not sure this thing was accepted yet? 


Oh. I don't know where it stands. I hate that patch. But honestly, if you want efficient code, rewrite your own. It is not a long code anyway.

Nathann



---

archive/issue_comments_180589.json:
```json
{
    "body": "Replying to [comment:8 ncohen]:\n> > Interesting. What is the reason for switching to Git? Its because Linus uses it right???\n  \n> \n> From my point of view, it is because some Sage developpers think that it is great. And I've been contaminated by their enthusiasm, even though I barely used it `:-P`\n> \n> > Nonono not this! I was asking about the code that you guys were doing that allows *contracting* an edge of a graph. I am not sure this thing was accepted yet? \n\n> \n> Oh. I don't know where it stands. I hate that patch. But honestly, if you want efficient code, rewrite your own. It is not a long code anyway.\n\n\nYes but I just wanted to quickly test something and not bother writing an edge contraction routine :-/ Do you happen to be able to extract that quickly from the patch or something? I just need to be able to contract an edge of a graph (ignoring loops & multiple edges)\n\n> \n> Nathann",
    "created_at": "2013-05-04T10:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180589",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

Replying to [comment:8 ncohen]:
> > Interesting. What is the reason for switching to Git? Its because Linus uses it right???
  
> 
> From my point of view, it is because some Sage developpers think that it is great. And I've been contaminated by their enthusiasm, even though I barely used it `:-P`
> 
> > Nonono not this! I was asking about the code that you guys were doing that allows *contracting* an edge of a graph. I am not sure this thing was accepted yet? 

> 
> Oh. I don't know where it stands. I hate that patch. But honestly, if you want efficient code, rewrite your own. It is not a long code anyway.


Yes but I just wanted to quickly test something and not bother writing an edge contraction routine :-/ Do you happen to be able to extract that quickly from the patch or something? I just need to be able to contract an edge of a graph (ignoring loops & multiple edges)

> 
> Nathann



---

archive/issue_comments_180590.json:
```json
{
    "body": "Quickly contract an edge `uv` ? What about that ?\n\n```\ng.add_edges([(u,x) for x in g.neighbors(v)])\ng.delete_vertex(v)\n```",
    "created_at": "2013-05-04T10:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180590",
    "user": "https://github.com/nathanncohen"
}
```

Quickly contract an edge `uv` ? What about that ?

```
g.add_edges([(u,x) for x in g.neighbors(v)])
g.delete_vertex(v)
```



---

archive/issue_comments_180591.json:
```json
{
    "body": "Oh. I mean, in a graph that does not allow multiple edges `:-P`\n\nNathann",
    "created_at": "2013-05-04T10:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180591",
    "user": "https://github.com/nathanncohen"
}
```

Oh. I mean, in a graph that does not allow multiple edges `:-P`

Nathann



---

archive/issue_comments_180592.json:
```json
{
    "body": "So, what do you decide with this patch ? If you make this 13 a 10 I agree with it, otherwise I will let somebody else give it a review. You tell me !\n\nNathann",
    "created_at": "2013-05-04T10:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180592",
    "user": "https://github.com/nathanncohen"
}
```

So, what do you decide with this patch ? If you make this 13 a 10 I agree with it, otherwise I will let somebody else give it a review. You tell me !

Nathann



---

archive/issue_comments_180593.json:
```json
{
    "body": "10 it is!",
    "created_at": "2013-05-04T10:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180593",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

10 it is!



---

archive/issue_comments_180594.json:
```json
{
    "body": "Okayyyyy, thanks ! `:-)`\n\nBy the way, when there are several patches on a ticket, Jeroen likes to have a message in the trac's description saying how they are to be applied. Like the one I just added.\n\nHave fuuuuuuuuuuuuuuun !\n\nNathann",
    "created_at": "2013-05-04T10:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180594",
    "user": "https://github.com/nathanncohen"
}
```

Okayyyyy, thanks ! `:-)`

By the way, when there are several patches on a ticket, Jeroen likes to have a message in the trac's description saying how they are to be applied. Like the one I just added.

Have fuuuuuuuuuuuuuuun !

Nathann



---

archive/issue_comments_180595.json:
```json
{
    "body": "And the following message is there to tell the patchbot (the circle that you see at the top of each ticket's page) how to apply the patches.",
    "created_at": "2013-05-04T10:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180595",
    "user": "https://github.com/nathanncohen"
}
```

And the following message is there to tell the patchbot (the circle that you see at the top of each ticket's page) how to apply the patches.



---

archive/issue_comments_180596.json:
```json
{
    "body": "Apply trac_14527_chrompoly.patch, trac_14527_chrompoly2.patch",
    "created_at": "2013-05-04T10:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180596",
    "user": "https://github.com/nathanncohen"
}
```

Apply trac_14527_chrompoly.patch, trac_14527_chrompoly2.patch



---

archive/issue_comments_180597.json:
```json
{
    "body": "Oh `O_o`\n\nLooks like your new example is missing a `::`\n\nNathann",
    "created_at": "2013-05-04T10:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180597",
    "user": "https://github.com/nathanncohen"
}
```

Oh `O_o`

Looks like your new example is missing a `::`

Nathann



---

archive/issue_comments_180598.json:
```json
{
    "body": "Attachment [trac_14527_chrompoly.patch](tarball://root/attachments/some-uuid/ticket14527/trac_14527_chrompoly.patch) by azi created at 2013-05-04 11:02:43\n\nFixed.",
    "created_at": "2013-05-04T11:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180598",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

Attachment [trac_14527_chrompoly.patch](tarball://root/attachments/some-uuid/ticket14527/trac_14527_chrompoly.patch) by azi created at 2013-05-04 11:02:43

Fixed.



---

archive/issue_comments_180599.json:
```json
{
    "body": "Good to go !\n\nNathann",
    "created_at": "2013-05-04T11:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180599",
    "user": "https://github.com/nathanncohen"
}
```

Good to go !

Nathann



---

archive/issue_comments_180600.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-04T11:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180600",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_180601.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-07T09:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14323#issuecomment-180601",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_041343.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-07T09:07:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14323",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14323#event-41343"
}
```
