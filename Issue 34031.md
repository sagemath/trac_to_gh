# Issue 34031: Reduce R to a dummy package, upgrade rpy2

Issue created by migration from https://trac.sagemath.org/ticket/34268

Original creator: mkoeppe

Original creation time: 2022-08-03 16:31:06

CC:  charpent vdelecroix dimpase isuruf jhpalmieri novoselt was

We reduce the unmaintained `r` package (stuck at 3.6.3) so that we detect a system installation of R but do not attempt to install it ourselves.

When found as a system package, `rpy2` will be built; otherwise it won't.


---

Comment by dimpase created at 2022-08-03 16:48:21

good idea


---

Comment by git created at 2022-08-03 18:40:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-03 18:46:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-03 18:52:38

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-08-03 19:09:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-03 19:19:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-03 19:20:11

Changing status from new to needs_review.


---

Comment by git created at 2022-08-03 19:52:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-03 20:06:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-08-04 09:26:44

How about requiring R to be at least version 4 (4.0.0 was released over two years ago)? The current R version is 4.2.1.
This would allow newer rpy2.


---

Comment by kcrisman created at 2022-08-04 12:32:05

How do the "rpy2" optional tests in [interfaces/r.py](https://github.com/sagemath/sage/blob/develop/src/sage/interfaces/r.py) do with this?


---

Comment by mkoeppe created at 2022-08-04 16:50:35

Replying to [comment:21 kcrisman]:
> How do the "rpy2" optional tests in [interfaces/r.py](https://github.com/sagemath/sage/blob/develop/src/sage/interfaces/r.py) do with this?

No change necessary


---

Comment by mkoeppe created at 2022-08-04 16:54:22

Replying to [comment:20 dimpase]:
> How about requiring R to be at least version 4 (4.0.0 was released over two years ago)? The current R version is 4.2.1.

This would make R unavailable on a lot more platforms, so I don't think it would be the right choice.

See https://repology.org/project/r/versions: `debian-buster`, `fedora` <= 32, `opensuse` <= 15.3, `ubuntu` <= focal


---

Comment by dimpase created at 2022-08-05 09:55:44

Fedora <= 32 is past EOL. We should not be concerned about it.
Further, accoding to https://cran.r-project.org/bin/linux/ubuntu/fullREADME.html, Ubunty Focal LTS has R 4.2.


---

Comment by mkoeppe created at 2022-08-05 16:00:16

Replying to [comment:24 dimpase]:
> Further, accoding to https://cran.r-project.org/bin/linux/ubuntu/fullREADME.html, Ubunty Focal LTS has R 4.2.

No, that's not what the page says.

They are offering a custom repository with their own package for ubuntu focal.


---

Comment by jhpalmieri created at 2022-08-05 16:45:12

Other than just the fact that it's newer, what is the compelling reason to push for a later version than 3.4.5 of `rpy2`?


---

Comment by mkoeppe created at 2022-08-05 17:01:36

I don't think there's a good reason, in particular given that there is zero evidence for the existence of any active users of our R interface


---

Comment by novoselt created at 2022-08-05 17:20:25

Replying to [comment:27 mkoeppe]:
> I don't think there's a good reason, in particular given that there is zero evidence for the existence of any active users of our R interface

Just a few hours ago I got a request for some improvements to how R is handled in [SageMathCell](SageMathCell), which does rely on our R interface. There were other discussions involving it over the years. So while I cannot say how wide-spread it is, there are certainly users out there and I would appreciate continuation of the support which is available via standard means, i.e. either by installing Sage and its packages, or using standard system packages. Using other custom repositories is highly undesirable as it tends to break over time.


---

Comment by mkoeppe created at 2022-08-05 17:24:35

Are you using system R on SageMathCell or a build of R from the SPKG?


---

Comment by novoselt created at 2022-08-05 17:30:26

SPKG, as far as I know. I didn't explore if it is already an option to use the system one.


---

Comment by kcrisman created at 2022-08-05 17:36:17

> > I don't think there's a good reason, in particular given that there is zero evidence for the existence of any active users of our R interface
> 
> Just a few hours ago I got a request for some improvements to how R is handled in [SageMathCell](SageMathCell), which does rely on our R interface. There were other discussions involving it over the years. So while I cannot say how wide-spread it is, there are certainly users out there

Thanks for pointing this out.  R (via the zillions of packages) provides access to so many weird numerical methods and other things that removing the interface seems unwise, even if it's not a prime use of Sage.  (This conversation seems to come up about every three years on sage-devel as well, where people come out of the woodwork; I've used the R interface for research purposes on several occasions myself.)


---

Comment by mkoeppe created at 2022-08-05 17:36:39

Using system R has been the default since #28884 (Sage 9.1)


---

Comment by mkoeppe created at 2022-08-05 17:37:37

Replying to [comment:31 kcrisman]:
> removing the interface seems unwise

This is not proposed on this ticket


---

Comment by kcrisman created at 2022-08-05 17:41:41

> > removing the interface seems unwise
> This is not proposed on this ticket
no worries, just being proactive regarding the phrase "given that there is zero evidence" which could be misinterpreted


---

Comment by mkoeppe created at 2022-08-05 17:47:53

Replying to [comment:30 novoselt]:
> SPKG, as far as I know. I didn't explore if it is already an option to use the system one.

The files in https://github.com/sagemath/sagecell/tree/master/contrib/vm suggest that you are using `ubuntu-bionic`, so if this is what you use in production, you will be affected by the proposed change.

The ticket is marked for the Sage 9.8 milestone, so you'll have plenty of time to do an upgrade to the current LTS (`ubuntu-jammy`)


---

Comment by dimpase created at 2022-08-05 22:12:01

Replying to [comment:26 jhpalmieri]:
> Other than just the fact that it's newer, what is the compelling reason to push for a later version than 3.4.5 of `rpy2`?

Upstreams hate to support old versions, that's the main reason.


---

Comment by mkoeppe created at 2022-08-05 23:49:57

I'd say that's not concrete enough to dictate that an upgrade has to go all the way to the most recent version. (Previous updates to rpy2 were done in 2020.)


---

Comment by jhpalmieri created at 2022-08-22 03:24:24

Something is going wrong with prerequisites. From `sagemath_doc_html-none.log`:

```
pkg_resources.DistributionNotFound: The 'rpy2<3.4,>=3.3' distribution was not found and is required by sagemath-standard
```

(The `rpy2` package has not yet been built â€” it's still in progress trying to download the tarball. Since the downloading timeouts can take a while, is there any way to tell Sage to skip the standard mirrors and just jump straight to the option given by `--enable-download-from-upstream-url`?)


---

Comment by mkoeppe created at 2022-08-22 03:28:23

Replying to [comment:42 jhpalmieri]:
> Since the downloading timeouts can take a while, is there any way to tell Sage to skip the standard mirrors and just jump straight to the option given by `--enable-download-from-upstream-url`?)

You can edit the file `upstream/mirror_list` to remove most mirrors


---

Comment by mkoeppe created at 2022-08-22 03:32:22

Replying to [comment:42 jhpalmieri]:
> Something is going wrong with prerequisites. From `sagemath_doc_html-none.log`:
> {{{
> pkg_resources.DistributionNotFound: The 'rpy2<3.4,>=3.3' distribution was not found and is required by sagemath-standard
> }}}

Is this giving an error, or does it continue after that?


---

Comment by jhpalmieri created at 2022-08-22 04:12:29

Replying to [comment:44 mkoeppe]:
> Replying to [comment:42 jhpalmieri]:
> > Something is going wrong with prerequisites. From `sagemath_doc_html-none.log`:
> > {{{
> > pkg_resources.DistributionNotFound: The 'rpy2<3.4,>=3.3' distribution was not found and is required by sagemath-standard
> > }}}
> 
> Is this giving an error, or does it continue after that?

The message repeats many times, including a traceback, but the build continues.


---

Comment by jhpalmieri created at 2022-08-22 04:13:54

Right, and of course it doesn't matter whether `rpy2` has been built, the same message appears, because this branch installs version 3.4.5 of `rpy2`, and that does not satisfy `rpy2<3.4,>=3.3`.


---

Comment by git created at 2022-08-22 04:16:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-08-22 05:45:11

`./configure` says

```
    notice: the following SPKGs did not find equivalent system packages:

        rpy2   4ti2 _recommended cbc coxeter3 ffmpeg gp2c igraph libsemigroups lrslib pandoc pdf2svg perl_mongodb perl_term_readline_gnu polymake
```

Do you know why there seems to be extra space after `rpy2`?


---

Comment by jhpalmieri created at 2022-08-22 06:38:14

With `./configure --with-system-r=no`, `rpy2` is not built and I see lots of warnings in docbuilding:

```
pkg_resources.DistributionNotFound: The 'rpy2>=3.3' distribution was not found and is required by sagemath-standard
```

The `scipy` log file says

```
sagemath-standard 9.7b8 requires networkx<3.0,>=2.4, which is not installed.
sagemath-standard 9.7b8 requires rpy2>=3.3, which is not installed.
```

(`networkx-2.8.4` had not yet finished installing at this point.)


---

Comment by mkoeppe created at 2022-08-22 16:31:46

Replying to [comment:48 jhpalmieri]:
> `./configure` says
> {{{
>     notice: the following SPKGs did not find equivalent system packages:
> 
>         rpy2   4ti2 _recommended cbc coxeter3 ffmpeg gp2c igraph libsemigroups lrslib pandoc pdf2svg perl_mongodb perl_term_readline_gnu polymake
> }}}
> Do you know why there seems to be extra space after `rpy2`?

I think I put this space there to separate standard packages from optional packages


---

Comment by git created at 2022-08-22 16:54:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-08-23 00:13:41

Looks okay to me. Passes tests with and without using the system installation of R.


---

Comment by jhpalmieri created at 2022-08-23 00:13:41

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-08-23 00:14:47

Thank you!


---

Comment by jhpalmieri created at 2022-08-23 00:16:53

Replying to [comment:43 mkoeppe]:
> Replying to [comment:42 jhpalmieri]:
> > Since the downloading timeouts can take a while, is there any way to tell Sage to skip the standard mirrors and just jump straight to the option given by `--enable-download-from-upstream-url`?)
> 
> You can edit the file `upstream/mirror_list` to remove most mirrors

Would it be useful to be able to add `$UPSTREAM` (or something like that) to the mirror list, which would have the effect of turning on `--enable-download-from-upstream-url`?


---

Comment by mkoeppe created at 2022-08-23 00:20:01

I think it would make sense to limit the number of mirrors it tries to some small number (5?) before it tries the upstream.


---

Comment by mkoeppe created at 2022-08-23 00:31:15

I've opened #34411 for this


---

Comment by mkoeppe created at 2022-08-23 00:34:24

Also see #32390


---

Comment by vbraun created at 2022-09-27 22:33:04

Merge failure on top of:

024b81f7a14 Trac #33812: Refactor distributions sagemath-{objects,categories} through sagemath-{environment,repl}

e4d3004ae09 Trac #33805: use Homebrew's primecount

5076cd5d57d Trac #34110: numpy 1.23.x

025fdd4137c Trac #34532: modernize super in manifolds/

f9129b172a6 Trac #34531: some details in LS paths crystals

7f7088d750d Trac #34529: remove deprecated method spring_layout_fast_split from src/sage/graphs/generic_graph_pyx.pyx

12890b6eae8 Trac #34520: Remove randomly failing doctest in src/sage/graphs/generators/random.py

c8511abe7bf Trac #34512: compute list CRT via tree

3f4e5446872 Trac #34508: Improve documentation of JoinFeature

cb5e1afa20e Trac #34493: Make TrivialFamily.map return a TrivialFamily

c036cccaab9 Trac #34486: VectorFieldModule: Faster fast path for tensor_module, exterior_power, dual_exterior_power

89b4155bd13 Trac #34469: modern super in matrix_space

4f3a9b020a0 Trac #34468: fix W605 in all pyx files inside matroids/

bfa6342db03 Trac #34465: Invalid escape sequence in special.py

cd65d443541 Trac #34462: Uniformize the headline: finite rings

7736a49d9a6 Trac #34435: Add method to trim trailing zeros from IntegerVector

154baa594e1 Trac #34432: Upgrade: jupyter-packaging 0.12.3

bfc2ccf5c01 Trac #34409: remove experimental warning for composite elliptic-curve isogenies

89b0d28500d Trac #34375: Replace sage.algebras.yangian.GeneratorIndexingSet with cartesian_product

ce82f8112a0 Trac #34358: pycodestyle cleanup in src/sage/graphs/generic_graph.py (part 4)

c8c541f386e Trac #34578: standard error messages in pbori

721c4c18d0d Trac #34573: Remove binary_function from ginac's code in sage

5fc16f5552a Trac #34571: fix typo in docstring

b836c6c85db Trac #34562: refactor multiple zeta values

1366a0d9f49 Trac #34528: Installation guide: Improve section on prerequisites/recommendations

ad97e1b2278 Trac #34413: implement derivatives of lazy series

a802d076b46 Trac #31664: Add package msolve 0.4.4 (multivariate polynomial system solver)

4541564cf15 Updated [SageMath](SageMath) version to 9.8.beta0



merge was not clean: conflicts in build/make/Makefile.in


---

Comment by vbraun created at 2022-09-27 22:33:04

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-09-30 00:56:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-30 00:57:39

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-10-11 09:14:43

Resolution: fixed
