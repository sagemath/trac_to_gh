# Issue 29735: Make stats doctests ready for random seeds

archive/issues_029735.json:
```json
{
    "body": "CC:  @slel\n\nThis ticket makes\n\n```\nsage -t --long --random-seed=n src/sage/stats/\n```\npass for different values `n` than just `0`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29972\n\n",
    "created_at": "2020-06-24T20:44:25Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Make stats doctests ready for random seeds",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29735",
    "user": "https://github.com/kliem"
}
```
CC:  @slel

This ticket makes

```
sage -t --long --random-seed=n src/sage/stats/
```
pass for different values `n` than just `0`.

Issue created by migration from https://trac.sagemath.org/ticket/29972





---

archive/issue_comments_421909.json:
```json
{
    "body": "At least the following need fixing:\n\n```\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 7 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/distributions/discrete_gaussian_lattice.py  # 9 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/distributions/discrete_gaussian_polynomial.py  # 6 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/hmm/chmm.pyx  # 8 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/hmm/distributions.pyx  # 3 doctests failed\n```",
    "created_at": "2020-06-24T20:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421909",
    "user": "https://github.com/kliem"
}
```

At least the following need fixing:

```
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 7 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/distributions/discrete_gaussian_lattice.py  # 9 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/distributions/discrete_gaussian_polynomial.py  # 6 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/hmm/chmm.pyx  # 8 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/stats/hmm/distributions.pyx  # 3 doctests failed
```



---

archive/issue_events_076963.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29735#event-76963"
}
```



---

archive/issue_comments_421910.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421910",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_076964.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29735#event-76964"
}
```



---

archive/issue_events_076965.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29735#event-76965"
}
```



---

archive/issue_comments_421911.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-29T12:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421911",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421912.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-29T12:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421912",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_421913.json:
```json
{
    "body": "I have tried 6 different seeds and got one failure:\n\n```\nsage -t --long --warn-long 134.7 --random-seed=2002 src/sage/stats/distributions/discrete_gaussian_lattice.py\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_lattice.py\", line 210, in sage.stats.distributions.discrete_gaussian_lattice.DiscreteGaussianDistributionLatticeSampler._normalisation_factor_zz\nFailed example:\n    l.count(v)  # abs tol 20\nExpected:\n    64\nGot:\n    87\nTolerance exceeded:\n    64 vs 87, tolerance 3e1 > 2e1\n```",
    "created_at": "2021-04-29T18:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421913",
    "user": "https://github.com/mwageringel"
}
```

I have tried 6 different seeds and got one failure:

```
sage -t --long --warn-long 134.7 --random-seed=2002 src/sage/stats/distributions/discrete_gaussian_lattice.py
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_lattice.py", line 210, in sage.stats.distributions.discrete_gaussian_lattice.DiscreteGaussianDistributionLatticeSampler._normalisation_factor_zz
Failed example:
    l.count(v)  # abs tol 20
Expected:
    64
Got:
    87
Tolerance exceeded:
    64 vs 87, tolerance 3e1 > 2e1
```



---

archive/issue_comments_421914.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-29T18:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421914",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_421915.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-29T20:38:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421915",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421916.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-29T20:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421916",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421917.json:
```json
{
    "body": "Ok, I made it a bit more flexible.\n\nThese doctests are really difficult to fix. As you noticed, it is far from stable.",
    "created_at": "2021-04-29T20:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421917",
    "user": "https://github.com/kliem"
}
```

Ok, I made it a bit more flexible.

These doctests are really difficult to fix. As you noticed, it is far from stable.



---

archive/issue_comments_421918.json:
```json
{
    "body": "You replaced:\n\n```diff\n-    sage: x=0; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n-    (13355, 13298)\n-    sage: x=4; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n-    (5479, 5467)\n-    sage: x=-10; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n-    (53, 51)\n+    sage: x=0; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n+    13298\n+    sage: l.count(x)  # rel tol 5e-2\n+    13298\n+    sage: x=4; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n+    5467\n+    sage: l.count(x)  # rel tol 5e-2\n+    5467\n+    sage: x=-10; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n+    51\n+    sage: l.count(x)  # rel tol 5e-1\n+    51\n```\nI would further rewrite that as:\n\n```diff\n+    sage: expected = lambda x: ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n+    sage: observed = lambda x: l.count(x)\n+    sage: expected(0)\n+    13298\n+    sage: observed(0)  # rel tol 5e-2\n+    13298\n+    sage: expected(4)\n+    5467\n+    sage: observed(4)  # rel tol 5e-2\n+    5467\n+    sage: expected(-10)\n+    51\n+    sage: observed(-10)  # rel tol 5e-1\n+    51\n```\n\nYou replaced:\n\n```diff\n-    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time\n-    (1.0, 1.00...)\n-    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time\n-    (1.32..., 1.36...)\n+    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1\n+    (1.0, 1.0)\n+    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1\n+    (1.36, 1.36)\n```\nI would further rewrite that as:\n\n```diff\n+    sage: expected = lambda x, y: (\n+    ....:     exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n())\n+    sage: observed = lambda x, y: float(l.count(x))/l.count(y)\n+    sage: expected(0, 1), observed(0, 1)  # long time  # abs tol 2e-1\n+    (1.0, 1.0)\n+    sage: expected(0, -100), observed(0, -100)  # long time  # abs tol 2e-1\n+    (1.36, 1.36)\n```\n\nIn `src/sage/stats/hmm/chmm.pyx` you add `set_random_seed(0)`\nin front of some tests.\n\nIs there an explanation somewhere of when to do that?\nI did not find one at #29935.",
    "created_at": "2021-04-29T22:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421918",
    "user": "https://github.com/slel"
}
```

You replaced:

```diff
-    sage: x=0; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
-    (13355, 13298)
-    sage: x=4; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
-    (5479, 5467)
-    sage: x=-10; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
-    (53, 51)
+    sage: x=0; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
+    13298
+    sage: l.count(x)  # rel tol 5e-2
+    13298
+    sage: x=4; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
+    5467
+    sage: l.count(x)  # rel tol 5e-2
+    5467
+    sage: x=-10; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
+    51
+    sage: l.count(x)  # rel tol 5e-1
+    51
```
I would further rewrite that as:

```diff
+    sage: expected = lambda x: ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
+    sage: observed = lambda x: l.count(x)
+    sage: expected(0)
+    13298
+    sage: observed(0)  # rel tol 5e-2
+    13298
+    sage: expected(4)
+    5467
+    sage: observed(4)  # rel tol 5e-2
+    5467
+    sage: expected(-10)
+    51
+    sage: observed(-10)  # rel tol 5e-1
+    51
```

You replaced:

```diff
-    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time
-    (1.0, 1.00...)
-    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time
-    (1.32..., 1.36...)
+    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1
+    (1.0, 1.0)
+    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1
+    (1.36, 1.36)
```
I would further rewrite that as:

```diff
+    sage: expected = lambda x, y: (
+    ....:     exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n())
+    sage: observed = lambda x, y: float(l.count(x))/l.count(y)
+    sage: expected(0, 1), observed(0, 1)  # long time  # abs tol 2e-1
+    (1.0, 1.0)
+    sage: expected(0, -100), observed(0, -100)  # long time  # abs tol 2e-1
+    (1.36, 1.36)
```

In `src/sage/stats/hmm/chmm.pyx` you add `set_random_seed(0)`
in front of some tests.

Is there an explanation somewhere of when to do that?
I did not find one at #29935.



---

archive/issue_comments_421919.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-30T08:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421919",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421920.json:
```json
{
    "body": "Replying to [comment:8 slelievre]:\n> You replaced:\n> \n> ```diff\n> -    sage: x=0; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> -    (13355, 13298)\n> -    sage: x=4; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> -    (5479, 5467)\n> -    sage: x=-10; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> -    (53, 51)\n> +    sage: x=0; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> +    13298\n> +    sage: l.count(x)  # rel tol 5e-2\n> +    13298\n> +    sage: x=4; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> +    5467\n> +    sage: l.count(x)  # rel tol 5e-2\n> +    5467\n> +    sage: x=-10; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> +    51\n> +    sage: l.count(x)  # rel tol 5e-1\n> +    51\n> ```\n> I would further rewrite that as:\n> \n> ```diff\n> +    sage: expected = lambda x: ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\n> +    sage: observed = lambda x: l.count(x)\n> +    sage: expected(0)\n> +    13298\n> +    sage: observed(0)  # rel tol 5e-2\n> +    13298\n> +    sage: expected(4)\n> +    5467\n> +    sage: observed(4)  # rel tol 5e-2\n> +    5467\n> +    sage: expected(-10)\n> +    51\n> +    sage: observed(-10)  # rel tol 5e-1\n> +    51\n> ```\n> \n> You replaced:\n> \n> ```diff\n> -    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time\n> -    (1.0, 1.00...)\n> -    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time\n> -    (1.32..., 1.36...)\n> +    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1\n> +    (1.0, 1.0)\n> +    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1\n> +    (1.36, 1.36)\n> ```\n> I would further rewrite that as:\n> \n> ```diff\n> +    sage: expected = lambda x, y: (\n> +    ....:     exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n())\n> +    sage: observed = lambda x, y: float(l.count(x))/l.count(y)\n> +    sage: expected(0, 1), observed(0, 1)  # long time  # abs tol 2e-1\n> +    (1.0, 1.0)\n> +    sage: expected(0, -100), observed(0, -100)  # long time  # abs tol 2e-1\n> +    (1.36, 1.36)\n> ```\n> \n> In `src/sage/stats/hmm/chmm.pyx` you add `set_random_seed(0)`\n> in front of some tests.\n> \n> Is there an explanation somewhere of when to do that?\n> I did not find one at #29935.\n\n\nThanks for the above suggestions.\n\nYes, we agreed to avoid `set_random_seed(0)` if at all possible.\nIt is harder to fix this for doctests that you don't understand.\nI removed this now.",
    "created_at": "2021-04-30T08:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421920",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:8 slelievre]:
> You replaced:
> 
> ```diff
> -    sage: x=0; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> -    (13355, 13298)
> -    sage: x=4; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> -    (5479, 5467)
> -    sage: x=-10; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> -    (53, 51)
> +    sage: x=0; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> +    13298
> +    sage: l.count(x)  # rel tol 5e-2
> +    13298
> +    sage: x=4; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> +    5467
> +    sage: l.count(x)  # rel tol 5e-2
> +    5467
> +    sage: x=-10; ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> +    51
> +    sage: l.count(x)  # rel tol 5e-1
> +    51
> ```
> I would further rewrite that as:
> 
> ```diff
> +    sage: expected = lambda x: ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
> +    sage: observed = lambda x: l.count(x)
> +    sage: expected(0)
> +    13298
> +    sage: observed(0)  # rel tol 5e-2
> +    13298
> +    sage: expected(4)
> +    5467
> +    sage: observed(4)  # rel tol 5e-2
> +    5467
> +    sage: expected(-10)
> +    51
> +    sage: observed(-10)  # rel tol 5e-1
> +    51
> ```
> 
> You replaced:
> 
> ```diff
> -    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time
> -    (1.0, 1.00...)
> -    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n() # long time
> -    (1.32..., 1.36...)
> +    sage: x=0;   y=1; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1
> +    (1.0, 1.0)
> +    sage: x=0; y=-100; float(l.count(x))/l.count(y), exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n()  # long time  # abs tol 2e-1
> +    (1.36, 1.36)
> ```
> I would further rewrite that as:
> 
> ```diff
> +    sage: expected = lambda x, y: (
> +    ....:     exp(-x^2/(2*sigma^2))/exp(-y^2/(2*sigma^2)).n())
> +    sage: observed = lambda x, y: float(l.count(x))/l.count(y)
> +    sage: expected(0, 1), observed(0, 1)  # long time  # abs tol 2e-1
> +    (1.0, 1.0)
> +    sage: expected(0, -100), observed(0, -100)  # long time  # abs tol 2e-1
> +    (1.36, 1.36)
> ```
> 
> In `src/sage/stats/hmm/chmm.pyx` you add `set_random_seed(0)`
> in front of some tests.
> 
> Is there an explanation somewhere of when to do that?
> I did not find one at #29935.


Thanks for the above suggestions.

Yes, we agreed to avoid `set_random_seed(0)` if at all possible.
It is harder to fix this for doctests that you don't understand.
I removed this now.



---

archive/issue_comments_421921.json:
```json
{
    "body": "This still fails too frequently (8 times out of 50). I understand the difficulty in making this work and I do not have a good solution either. Personally, I have the impression that we should not write tests that are guaranteed to fail sporadically at all, especially considering the vast number of doctests in Sage. Every false positive adds noise to the development process, which can make real issues go unnoticed. Besides that, including a test in the documentation making false claims about a probability distribution is a bit confusing.\n\nSetting the seed to 0 may be the only reliable solution, but I welcome other ideas and opinions. Or we just increase the tolerances enough for the tests to pass (almost) always.\n\nWhen I was running a patchbot client, I fixed several flaky doctests just to get the patchbot to report usable results, which is a time consuming process. That is why I am wary about introducing new such issues.\n\n```\nsage -t --long --warn-long 134.9 --random-seed=13008 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13008 src/sage/stats/hmm/chmm.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13016 src/sage/stats/hmm/chmm.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13032 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13034 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13042 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13047 src/sage/stats/hmm/chmm.pyx  # 1 doctest failed\nsage -t --long --warn-long 134.9 --random-seed=13049 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed\n```",
    "created_at": "2021-04-30T20:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421921",
    "user": "https://github.com/mwageringel"
}
```

This still fails too frequently (8 times out of 50). I understand the difficulty in making this work and I do not have a good solution either. Personally, I have the impression that we should not write tests that are guaranteed to fail sporadically at all, especially considering the vast number of doctests in Sage. Every false positive adds noise to the development process, which can make real issues go unnoticed. Besides that, including a test in the documentation making false claims about a probability distribution is a bit confusing.

Setting the seed to 0 may be the only reliable solution, but I welcome other ideas and opinions. Or we just increase the tolerances enough for the tests to pass (almost) always.

When I was running a patchbot client, I fixed several flaky doctests just to get the patchbot to report usable results, which is a time consuming process. That is why I am wary about introducing new such issues.

```
sage -t --long --warn-long 134.9 --random-seed=13008 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13008 src/sage/stats/hmm/chmm.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13016 src/sage/stats/hmm/chmm.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13032 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13034 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13042 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13047 src/sage/stats/hmm/chmm.pyx  # 1 doctest failed
sage -t --long --warn-long 134.9 --random-seed=13049 src/sage/stats/distributions/discrete_gaussian_integer.pyx  # 1 doctest failed
```



---

archive/issue_comments_421922.json:
```json
{
    "body": "I agree. See a similar discussion at\n\n- [Stack Overflow question 641318: Test probabilistic functions](https://stackoverflow.com/q//641318)",
    "created_at": "2021-04-30T20:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421922",
    "user": "https://github.com/slel"
}
```

I agree. See a similar discussion at

- [Stack Overflow question 641318: Test probabilistic functions](https://stackoverflow.com/q//641318)



---

archive/issue_comments_421923.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-05-01T00:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421923",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_421924.json:
```json
{
    "body": "Yes, 8 out of 50 is definitely too much.\n\nMy idea was to have meaningful tests that fail about 1 in 10000 or less. That is how I did the tests in #29976. Run the corresponding function a couple thousand times and take the maximum and minimum.\n\nE.g. there is a doctest in matrices that tests that random `GF(2)` 1000 x 1000 matrices have high rank (because that was an issue that has been fixed at some point). Now theoretically, it could still have a very low rank, but I don't think this will happen. The new doctest is rather meaningful, I think, because it documents that such a matrix will very probably (at least 99.9%) have rank 995 or higher. Also the doctest now is actually being run. It doesn't just tell us that for `random_seed(0)` things work out, but that things usually work out.",
    "created_at": "2021-05-01T00:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421924",
    "user": "https://github.com/kliem"
}
```

Yes, 8 out of 50 is definitely too much.

My idea was to have meaningful tests that fail about 1 in 10000 or less. That is how I did the tests in #29976. Run the corresponding function a couple thousand times and take the maximum and minimum.

E.g. there is a doctest in matrices that tests that random `GF(2)` 1000 x 1000 matrices have high rank (because that was an issue that has been fixed at some point). Now theoretically, it could still have a very low rank, but I don't think this will happen. The new doctest is rather meaningful, I think, because it documents that such a matrix will very probably (at least 99.9%) have rank 995 or higher. Also the doctest now is actually being run. It doesn't just tell us that for `random_seed(0)` things work out, but that things usually work out.



---

archive/issue_comments_421925.json:
```json
{
    "body": "Here is an example of something I feel comfortable with:\n\n```\nsage: def foo(): \n....:     A = random_matrix(GF(2), 1000, 1000) \n....:     return float(A.density()) \n....:                                                                                                                                                                               \nsage: max(foo() for _ in range(100))                                                                                                                                                \n0.50165\nsage: max(foo() for _ in range(1000))                                                                                                                                               \n0.501586\n```\n\nThen I decided that a tolerance of `0.01` to make it almost never fail.\nOf course there should \n\n```diff\n             sage: A = matrix(GF(2), 5, 5, 0)\n-            sage: A.randomize(0.5); A\n-            [0 0 0 1 1]\n-            [0 1 0 0 1]\n-            [1 0 0 0 0]\n-            [0 1 0 0 0]\n-            [0 0 0 1 0]\n-            sage: A.randomize(); A\n-            [0 0 1 1 0]\n-            [1 1 0 0 1]\n-            [1 1 1 1 0]\n-            [1 1 1 1 1]\n-            [0 0 1 1 0]\n+            sage: len(A.nonzero_positions())\n+            0\n+            sage: A.randomize(0.5)\n+            sage: 0 <= len(A.nonzero_positions()) < 12\n+            True\n+            sage: A.randomize()\n+            sage: 1 <= len(A.nonzero_positions()) < 24\n+            True\n```\n\nHere the last one fails apparently something like 1 in a million. Lets say there are thousand tests like this in sage and it takes 2 hours for a patch bot to run all tests. Then apparently every 83 days your patchbot will report such an error. Is this ok?\nOf course it will only die, if this happens after a beta. This will happen something like every twenty years.\n\nMaybe tests failing 1 in a 100 000 are still acceptable. But everything significantly below that would be annoying. You don't want to restart your patchbot every 50 days, because of stupid failures.\n\nAnd of course, if the test becomes meaningless by that kind of tolerance, we might want to go with `set_random_seed(0)`.",
    "created_at": "2021-05-01T01:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421925",
    "user": "https://github.com/kliem"
}
```

Here is an example of something I feel comfortable with:

```
sage: def foo(): 
....:     A = random_matrix(GF(2), 1000, 1000) 
....:     return float(A.density()) 
....:                                                                                                                                                                               
sage: max(foo() for _ in range(100))                                                                                                                                                
0.50165
sage: max(foo() for _ in range(1000))                                                                                                                                               
0.501586
```

Then I decided that a tolerance of `0.01` to make it almost never fail.
Of course there should 

```diff
             sage: A = matrix(GF(2), 5, 5, 0)
-            sage: A.randomize(0.5); A
-            [0 0 0 1 1]
-            [0 1 0 0 1]
-            [1 0 0 0 0]
-            [0 1 0 0 0]
-            [0 0 0 1 0]
-            sage: A.randomize(); A
-            [0 0 1 1 0]
-            [1 1 0 0 1]
-            [1 1 1 1 0]
-            [1 1 1 1 1]
-            [0 0 1 1 0]
+            sage: len(A.nonzero_positions())
+            0
+            sage: A.randomize(0.5)
+            sage: 0 <= len(A.nonzero_positions()) < 12
+            True
+            sage: A.randomize()
+            sage: 1 <= len(A.nonzero_positions()) < 24
+            True
```

Here the last one fails apparently something like 1 in a million. Lets say there are thousand tests like this in sage and it takes 2 hours for a patch bot to run all tests. Then apparently every 83 days your patchbot will report such an error. Is this ok?
Of course it will only die, if this happens after a beta. This will happen something like every twenty years.

Maybe tests failing 1 in a 100 000 are still acceptable. But everything significantly below that would be annoying. You don't want to restart your patchbot every 50 days, because of stupid failures.

And of course, if the test becomes meaningless by that kind of tolerance, we might want to go with `set_random_seed(0)`.



---

archive/issue_comments_421926.json:
```json
{
    "body": "Maybe the far more easy and reasonable solution is to have the patchbots run at random seed 0, when they verify that they are not broken. I mean this is our reference seed. We can life with bots reporting once in a while incorrect failures (it happens anyway).\n\nSo we could at this to the patchbot scripts?",
    "created_at": "2021-05-01T01:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421926",
    "user": "https://github.com/kliem"
}
```

Maybe the far more easy and reasonable solution is to have the patchbots run at random seed 0, when they verify that they are not broken. I mean this is our reference seed. We can life with bots reporting once in a while incorrect failures (it happens anyway).

So we could at this to the patchbot scripts?



---

archive/issue_comments_421927.json:
```json
{
    "body": "Sorry for all my comments.\n\nJust forget what I said earlier. I still think that tests with `set_random_seed(0)` are pretty worthless, because they don't test anything.\n\nHowever, doctests should be mathematically correct. So rethinking:\n\n```\n             sage: A = matrix(GF(2), 5, 5, 0)\n             sage: A.randomize()\n             sage: 1 <= len(A.nonzero_positions()) < 24\n             True\n```\nis NOT a good test. Not because it is likely to fail, but because it boils down to something as:\n\n```\nsage: randint(0, 2^24) != 0\nTrue\n```\nIt probably won't fail, but it is terrible.\n\nThere is two reasons for doctests that I think should be kept in mind\n- educational/documentation\n- actually testing that things work (e.g. that random really does something).\n\n**Here is my proposition:**\n\nI think the way to combine those things is using while statements in those tests for \"randomness\". Those tests succeed almost certainly in a mathematical correct way:\n- Testing that not all random elements are zero\n\n```\nsage: while GF(3).random_element().is_zero(): pass\n```\n- Testing that all (of finitely many) elements can be obtained eventually.\n- Testing that random matrices over `GF(2)` have different ranks:\n\n```\nsage: def random_rank():\n....:     A = matrix(GF(2), 5, 5, 0) \n....:     A.randomize() \n....:     return A.rank()\nsage: while random_rank() < 5: pass\nwhile while random_rank() >= 4: pass\n```\n- Testing that according to the law of large numbers an expectation is approximated at some point.\n\n```\nsage: from collections import defaultdict                                                                                             \nsage: counter = defaultdict(Integer)                                                                                                  \nsage: def throw_dice(): counter[randint(1, 6)] += 1                                                                                   \nsage: throw_dice()                                                                                                                    \nsage: def test(): return all((counter[i]*1.0/sum(counter.values()) - 1/6) < 0.01 for i in counter)                                    \nsage: while not test(): inc() \n```\n- Applying this to our situation this could look like:\n\n```   \nsage: from sage.stats.distributions.discrete_gaussian_integer import DiscreteGaussianDistributionIntegerSampler   \nsage: sigma = 3.0                                                                                                                     \nsage: D = DiscreteGaussianDistributionIntegerSampler(sigma=sigma)                                                                     \nsage: bound = (6*sigma).floor()                                                                                                       \nsage: norm_factor = sum([exp(-x^2/(2*sigma^2)) for x in range(-bound,bound+1)]) \n                                                      \nsage: from collections import defaultdict                                                                                             \nsage: counter = defaultdict(Integer)  \nsage: n = 0                                                                                                 \nsage: def add_sample(): \n....:     global counter, n \n....:     counter[D()] += 1 \n....:     n += 1 \n....:                                                                                                                                 \nsage: for _ in range(1000): add_sample()                                                                                                                                                                                  \nsage: expected = lambda x : ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))                                                            \nsage: observed = lambda x : counter[x]\n                                                                                                \nsage: while not counter[0]: add_sample()                                                                                              \nsage: while abs(expected(0)*1.0/observed(0) - 1.0) > 5e-2: add_sample()  # long time  \n                                                             \nsage: while not counter[4]: add_sample()                                                                     \nsage: while abs(expected(4)*1.0/observed(4) - 1.0) > 5e-2: add_sample()  # long time     \n                                                          \nsage: while not counter[-10]: add_sample()                                                                                            \nsage: while abs(expected(-10)*1.0/observed(-10) - 1.0) > 5e-2: add_sample()  # long time                          \n```\n\nAm I making any sense?\n\nIMO this would actually be a valuable doctest and mathematically correct. Because the probability of this not terminating is indeed a zero probability (at least if things are implemented correctly).\n\nOne can maybe speed this up by increasing the initial sample and by adding a number of samples instead of just one at a time.",
    "created_at": "2021-05-01T09:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421927",
    "user": "https://github.com/kliem"
}
```

Sorry for all my comments.

Just forget what I said earlier. I still think that tests with `set_random_seed(0)` are pretty worthless, because they don't test anything.

However, doctests should be mathematically correct. So rethinking:

```
             sage: A = matrix(GF(2), 5, 5, 0)
             sage: A.randomize()
             sage: 1 <= len(A.nonzero_positions()) < 24
             True
```
is NOT a good test. Not because it is likely to fail, but because it boils down to something as:

```
sage: randint(0, 2^24) != 0
True
```
It probably won't fail, but it is terrible.

There is two reasons for doctests that I think should be kept in mind
- educational/documentation
- actually testing that things work (e.g. that random really does something).

**Here is my proposition:**

I think the way to combine those things is using while statements in those tests for "randomness". Those tests succeed almost certainly in a mathematical correct way:
- Testing that not all random elements are zero

```
sage: while GF(3).random_element().is_zero(): pass
```
- Testing that all (of finitely many) elements can be obtained eventually.
- Testing that random matrices over `GF(2)` have different ranks:

```
sage: def random_rank():
....:     A = matrix(GF(2), 5, 5, 0) 
....:     A.randomize() 
....:     return A.rank()
sage: while random_rank() < 5: pass
while while random_rank() >= 4: pass
```
- Testing that according to the law of large numbers an expectation is approximated at some point.

```
sage: from collections import defaultdict                                                                                             
sage: counter = defaultdict(Integer)                                                                                                  
sage: def throw_dice(): counter[randint(1, 6)] += 1                                                                                   
sage: throw_dice()                                                                                                                    
sage: def test(): return all((counter[i]*1.0/sum(counter.values()) - 1/6) < 0.01 for i in counter)                                    
sage: while not test(): inc() 
```
- Applying this to our situation this could look like:

```   
sage: from sage.stats.distributions.discrete_gaussian_integer import DiscreteGaussianDistributionIntegerSampler   
sage: sigma = 3.0                                                                                                                     
sage: D = DiscreteGaussianDistributionIntegerSampler(sigma=sigma)                                                                     
sage: bound = (6*sigma).floor()                                                                                                       
sage: norm_factor = sum([exp(-x^2/(2*sigma^2)) for x in range(-bound,bound+1)]) 
                                                      
sage: from collections import defaultdict                                                                                             
sage: counter = defaultdict(Integer)  
sage: n = 0                                                                                                 
sage: def add_sample(): 
....:     global counter, n 
....:     counter[D()] += 1 
....:     n += 1 
....:                                                                                                                                 
sage: for _ in range(1000): add_sample()                                                                                                                                                                                  
sage: expected = lambda x : ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))                                                            
sage: observed = lambda x : counter[x]
                                                                                                
sage: while not counter[0]: add_sample()                                                                                              
sage: while abs(expected(0)*1.0/observed(0) - 1.0) > 5e-2: add_sample()  # long time  
                                                             
sage: while not counter[4]: add_sample()                                                                     
sage: while abs(expected(4)*1.0/observed(4) - 1.0) > 5e-2: add_sample()  # long time     
                                                          
sage: while not counter[-10]: add_sample()                                                                                            
sage: while abs(expected(-10)*1.0/observed(-10) - 1.0) > 5e-2: add_sample()  # long time                          
```

Am I making any sense?

IMO this would actually be a valuable doctest and mathematically correct. Because the probability of this not terminating is indeed a zero probability (at least if things are implemented correctly).

One can maybe speed this up by increasing the initial sample and by adding a number of samples instead of just one at a time.



---

archive/issue_comments_421928.json:
```json
{
    "body": "Yes, these are very good suggestions. Thanks for the detailed proposal.",
    "created_at": "2021-05-01T14:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421928",
    "user": "https://github.com/mwageringel"
}
```

Yes, these are very good suggestions. Thanks for the detailed proposal.



---

archive/issue_comments_421929.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-04T09:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421929",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421930.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-05-04T09:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421930",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421931.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-04T10:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421931",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421932.json:
```json
{
    "body": "I could only localize such a doctest in one other closed ticket and decided to fix it here as well.",
    "created_at": "2021-05-04T10:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421932",
    "user": "https://github.com/kliem"
}
```

I could only localize such a doctest in one other closed ticket and decided to fix it here as well.



---

archive/issue_comments_421933.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-04T10:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421933",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421934.json:
```json
{
    "body": "Very nice. This works well. \n\nI have tried the while loops manually to make sure they do not take too much time. Only this test in `discrete_gaussian_lattice` is sometimes a bit slow. This only happens rarely, but in one case it created more than 2 million samples.\n\n```\nsage: while abs(m*f(v)*1.0/c/counter[v] - 1.0) >= 0.2: add_samples(1000)  # long time\n```\nAs this does not happen often, I think we can set this ticket to positive review, but you can change the bound of this test if you prefer.",
    "created_at": "2021-05-08T18:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421934",
    "user": "https://github.com/mwageringel"
}
```

Very nice. This works well. 

I have tried the while loops manually to make sure they do not take too much time. Only this test in `discrete_gaussian_lattice` is sometimes a bit slow. This only happens rarely, but in one case it created more than 2 million samples.

```
sage: while abs(m*f(v)*1.0/c/counter[v] - 1.0) >= 0.2: add_samples(1000)  # long time
```
As this does not happen often, I think we can set this ticket to positive review, but you can change the bound of this test if you prefer.



---

archive/issue_comments_421935.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-08T18:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421935",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421936.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29735#issuecomment-421936",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_076966.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:30:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29735",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29735#event-76966"
}
```
