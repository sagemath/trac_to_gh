# Issue 27970: Derivative of piecewise function returns junk

archive/issues_027970.json:
```json
{
    "body": "CC:  @tscrim @slel @kliem\n\nKeywords: piecewise,derivative,diff\n\nReported in [Ask SageMath question #47169](https://ask.sagemath.org/question/47169/plotting-derivative-of-bump-function/), we can't differentiate the bump function:\n\n\n```\nsage: f(x) = piecewise([((-oo, -1), 0), ((-1, 1), exp(-1/(1 - x^2))), ((1, oo), 0)])\nsage: f.diff()\nx |--> (0, 0, 0)*D[0]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x) + D[1]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x)\nsage: f.diff()(0)\n(0, 0, 0)*e^(-1) + e^(-1)\nsage: f.diff()(0) in RR\nFalse\n```\n\n\nThat's not right...\n\nIssue created by migration from https://trac.sagemath.org/ticket/28207\n\n",
    "created_at": "2019-07-16T19:08:47Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Derivative of piecewise function returns junk",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27970",
    "user": "https://github.com/rburing"
}
```
CC:  @tscrim @slel @kliem

Keywords: piecewise,derivative,diff

Reported in [Ask SageMath question #47169](https://ask.sagemath.org/question/47169/plotting-derivative-of-bump-function/), we can't differentiate the bump function:


```
sage: f(x) = piecewise([((-oo, -1), 0), ((-1, 1), exp(-1/(1 - x^2))), ((1, oo), 0)])
sage: f.diff()
x |--> (0, 0, 0)*D[0]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x) + D[1]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x)
sage: f.diff()(0)
(0, 0, 0)*e^(-1) + e^(-1)
sage: f.diff()(0) in RR
False
```


That's not right...

Issue created by migration from https://trac.sagemath.org/ticket/28207





---

archive/issue_comments_394702.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394702",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_394703.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394703",
    "user": "https://github.com/mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_394704.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394704",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_394705.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-19T16:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394705",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_394706.json:
```json
{
    "body": "here is a tentative ; certainly better than before, but not perfect\n----\nNew commits:",
    "created_at": "2021-10-19T16:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394706",
    "user": "https://github.com/fchapoton"
}
```

here is a tentative ; certainly better than before, but not perfect
----
New commits:



---

archive/issue_comments_394707.json:
```json
{
    "body": "What would you say is missing from making it perfect?",
    "created_at": "2021-10-20T04:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394707",
    "user": "https://github.com/tscrim"
}
```

What would you say is missing from making it perfect?



---

archive/issue_comments_394708.json:
```json
{
    "body": "derivative wrt y is not working, giving the same result as wrt x...",
    "created_at": "2021-10-20T06:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394708",
    "user": "https://github.com/fchapoton"
}
```

derivative wrt y is not working, giving the same result as wrt x...



---

archive/issue_comments_394709.json:
```json
{
    "body": "Could we add a short explanation and doctest showing this behavior (and perhaps with the desired output)?",
    "created_at": "2021-10-20T07:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394709",
    "user": "https://github.com/tscrim"
}
```

Could we add a short explanation and doctest showing this behavior (and perhaps with the desired output)?



---

archive/issue_comments_394710.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-20T11:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394710",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394711.json:
```json
{
    "body": "This is still very ugly. One should try to fix that, but experts are lacking..",
    "created_at": "2021-10-20T11:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394711",
    "user": "https://github.com/fchapoton"
}
```

This is still very ugly. One should try to fix that, but experts are lacking..



---

archive/issue_comments_394712.json:
```json
{
    "body": "I am not sure these should actually count as bugs as the behavior is consistent with what other symbolic functions do:\n\n```\nsage: y = SR.var('y')\nsage: f(x) = x*y + x + y\nsage: type(f)\n<class 'sage.symbolic.expression.Expression'>\nsage: f\nx |--> x*y + x + y\n\nsage: f.derivative(x)\nx |--> y + 1\nsage: f.derivative(y)\nx |--> x + 1\n```\n\nWhat would you expect the output to be?",
    "created_at": "2021-10-20T23:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394712",
    "user": "https://github.com/tscrim"
}
```

I am not sure these should actually count as bugs as the behavior is consistent with what other symbolic functions do:

```
sage: y = SR.var('y')
sage: f(x) = x*y + x + y
sage: type(f)
<class 'sage.symbolic.expression.Expression'>
sage: f
x |--> x*y + x + y

sage: f.derivative(x)
x |--> y + 1
sage: f.derivative(y)
x |--> x + 1
```

What would you expect the output to be?



---

archive/issue_comments_394713.json:
```json
{
    "body": "I have written the expected output in the doctests. The actual behaviour, with the branch, is to raise an Error.",
    "created_at": "2021-10-21T07:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394713",
    "user": "https://github.com/fchapoton"
}
```

I have written the expected output in the doctests. The actual behaviour, with the branch, is to raise an Error.



---

archive/issue_comments_394714.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-21T07:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394714",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_394715.json:
```json
{
    "body": "Ah, sorry, I misunderstood. Thank you. LGTM.",
    "created_at": "2021-10-21T07:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394715",
    "user": "https://github.com/tscrim"
}
```

Ah, sorry, I misunderstood. Thank you. LGTM.



---

archive/issue_comments_394716.json:
```json
{
    "body": "I would have hoped that someone step in to fix that..\n\nHere is the traceback:\n\n```\nsage: y = SR.var('y')\nsage: h = piecewise([((-1,1),x**2*y)])\nsage: h.derivative(x)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-6-efc8c30bd882> in <module>\n----> 1 h.derivative(x)\n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()\n   4574             ValueError: No differentiation variable specified.\n   4575         \"\"\"\n-> 4576         return multi_derivative(self, args)\n   4577 \n   4578     diff = differentiate = derivative\n\n~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3218)()\n    220 \n    221     for arg in derivative_parse(args):\n--> 222         F = F._derivative(arg)\n    223     return F\n    224 \n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55084)()\n   4646         sig_on()\n   4647         try:\n-> 4648             x = self._gobj.diff(ex_to_symbol(symbol._gobj), deg)\n   4649         finally:\n   4650             sig_off()\n\n~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in _tderivative_(self, parameters, variable, *args, **kwds)\n    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)\n    313         \"\"\"\n--> 314         return piecewise([(domain, func.derivative(*args))\n    315                           for domain, func in parameters],\n    316                          var=variable)\n\n~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in <listcomp>(.0)\n    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)\n    313         \"\"\"\n--> 314         return piecewise([(domain, func.derivative(*args))\n    315                           for domain, func in parameters],\n    316                          var=variable)\n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()\n   4574             ValueError: No differentiation variable specified.\n   4575         \"\"\"\n-> 4576         return multi_derivative(self, args)\n   4577 \n   4578     diff = differentiate = derivative\n\n~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3114)()\n    217     if not args:\n    218         # fast version where no arguments supplied\n--> 219         return F._derivative()\n    220 \n    221     for arg in derivative_parse(args):\n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:54909)()\n   4636                 return self.gradient()\n   4637             else:\n-> 4638                 raise ValueError(\"No differentiation variable specified.\")\n   4639         if not isinstance(deg, (int, long, sage.rings.integer.Integer)) \\\n   4640                 or deg < 1:\n\nValueError: No differentiation variable specified.\n```\n",
    "created_at": "2021-10-21T07:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394716",
    "user": "https://github.com/fchapoton"
}
```

I would have hoped that someone step in to fix that..

Here is the traceback:

```
sage: y = SR.var('y')
sage: h = piecewise([((-1,1),x**2*y)])
sage: h.derivative(x)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-6-efc8c30bd882> in <module>
----> 1 h.derivative(x)

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()
   4574             ValueError: No differentiation variable specified.
   4575         """
-> 4576         return multi_derivative(self, args)
   4577 
   4578     diff = differentiate = derivative

~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3218)()
    220 
    221     for arg in derivative_parse(args):
--> 222         F = F._derivative(arg)
    223     return F
    224 

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55084)()
   4646         sig_on()
   4647         try:
-> 4648             x = self._gobj.diff(ex_to_symbol(symbol._gobj), deg)
   4649         finally:
   4650             sig_off()

~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in _tderivative_(self, parameters, variable, *args, **kwds)
    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)
    313         """
--> 314         return piecewise([(domain, func.derivative(*args))
    315                           for domain, func in parameters],
    316                          var=variable)

~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in <listcomp>(.0)
    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)
    313         """
--> 314         return piecewise([(domain, func.derivative(*args))
    315                           for domain, func in parameters],
    316                          var=variable)

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()
   4574             ValueError: No differentiation variable specified.
   4575         """
-> 4576         return multi_derivative(self, args)
   4577 
   4578     diff = differentiate = derivative

~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3114)()
    217     if not args:
    218         # fast version where no arguments supplied
--> 219         return F._derivative()
    220 
    221     for arg in derivative_parse(args):

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:54909)()
   4636                 return self.gradient()
   4637             else:
-> 4638                 raise ValueError("No differentiation variable specified.")
   4639         if not isinstance(deg, (int, long, sage.rings.integer.Integer)) \
   4640                 or deg < 1:

ValueError: No differentiation variable specified.
```




---

archive/issue_comments_394717.json:
```json
{
    "body": "I will try to dig a little deeper soon.",
    "created_at": "2021-10-21T11:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394717",
    "user": "https://github.com/tscrim"
}
```

I will try to dig a little deeper soon.



---

archive/issue_comments_394718.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-24T18:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27970#issuecomment-394718",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
