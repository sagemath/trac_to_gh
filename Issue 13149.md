# Issue 13149: FreeModule.hom stores its matrix over the wrong ring.

archive/issues_013149.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  novoselt jakobkroeker\n\nThis is ok:\n\n```\nsage: (ZZ^2).hom([[2,3],[3,6]],QQ^2) \nFree module morphism defined by the matrix\n[2 3]\n[3 6]\nDomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring\nCodomain: Vector space of dimension 2 over Rational Field\n```\n\nThis should not be possible: \n\n```\nsage: (QQ^2).hom([[1/3,1/4],[1/3,1/6]],ZZ^2)\nFree module morphism defined by the matrix\n[1/3 1/4]\n[1/3 1/6]\nDomain: Vector space of dimension 2 over Rational Field\nCodomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring\n```\n\n\nThis should work\n\n```\nsage: (ZZ^2).hom([[1/3,1/4],[1/3,1/6]],QQ^2) #goes boom with an error you might have excpected in the previous example\nTraceback (most recent call last):\n...\nTypeError: no conversion of this rational to integer\n```\n\n\nThis should defenitly also not work:\n\n```\nsage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)\nFree module morphism defined by the matrix\n[6 0]\n[0 0]\nDomain: Vector space of dimension 2 over Finite Field of size 7\nCodomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring\n```\n\n\nThe following should give a clue what is going wrong:\n\n\n```\n\nsage: (GF(7)^2).hom([[1/3,1/4],[1/3,1/6]],QQ^2)\nVector space morphism represented by the matrix:\n[5 2]\n[5 6]\nDomain: Vector space of dimension 2 over Finite Field of size 7\nCodomain: Vector space of dimension 2 over Rational Field\nsage: _.matrix().parent()\nFull MatrixSpace of 2 by 2 dense matrices over Finite Field of size 7\nsage: (QQ^2).hom([[1/3,1/4],[1/3,1/6]],ZZ^2)\nFree module morphism defined by the matrix\n[1/3 1/4]\n[1/3 1/6]\nDomain: Vector space of dimension 2 over Rational Field\nCodomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring\nsage: _.matrix().parent()\nFull MatrixSpace of 2 by 2 dense matrices over Rational Field\n```\n\nSeems that somewhere the domain and codomain are messed up.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13321\n\n",
    "created_at": "2012-08-01T13:08:28Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "FreeModule.hom stores its matrix over the wrong ring.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13149",
    "user": "mderickx"
}
```
Assignee: tbd

CC:  novoselt jakobkroeker

This is ok:

```
sage: (ZZ^2).hom([[2,3],[3,6]],QQ^2) 
Free module morphism defined by the matrix
[2 3]
[3 6]
Domain: Ambient free module of rank 2 over the principal ideal domain Integer Ring
Codomain: Vector space of dimension 2 over Rational Field
```

This should not be possible: 

```
sage: (QQ^2).hom([[1/3,1/4],[1/3,1/6]],ZZ^2)
Free module morphism defined by the matrix
[1/3 1/4]
[1/3 1/6]
Domain: Vector space of dimension 2 over Rational Field
Codomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring
```


This should work

```
sage: (ZZ^2).hom([[1/3,1/4],[1/3,1/6]],QQ^2) #goes boom with an error you might have excpected in the previous example
Traceback (most recent call last):
...
TypeError: no conversion of this rational to integer
```


This should defenitly also not work:

```
sage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)
Free module morphism defined by the matrix
[6 0]
[0 0]
Domain: Vector space of dimension 2 over Finite Field of size 7
Codomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring
```


The following should give a clue what is going wrong:


```

sage: (GF(7)^2).hom([[1/3,1/4],[1/3,1/6]],QQ^2)
Vector space morphism represented by the matrix:
[5 2]
[5 6]
Domain: Vector space of dimension 2 over Finite Field of size 7
Codomain: Vector space of dimension 2 over Rational Field
sage: _.matrix().parent()
Full MatrixSpace of 2 by 2 dense matrices over Finite Field of size 7
sage: (QQ^2).hom([[1/3,1/4],[1/3,1/6]],ZZ^2)
Free module morphism defined by the matrix
[1/3 1/4]
[1/3 1/6]
Domain: Vector space of dimension 2 over Rational Field
Codomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring
sage: _.matrix().parent()
Full MatrixSpace of 2 by 2 dense matrices over Rational Field
```

Seems that somewhere the domain and codomain are messed up.

Issue created by migration from https://trac.sagemath.org/ticket/13321





---

archive/issue_comments_160194.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2012-08-01T13:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160194",
    "user": "mderickx"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_160195.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to linear algebra.",
    "created_at": "2012-08-01T13:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160195",
    "user": "mderickx"
}
```

Changing component from PLEASE CHANGE to linear algebra.



---

archive/issue_comments_160196.json:
```json
{
    "body": "Changing assignee from tbd to jason, was.",
    "created_at": "2012-08-01T13:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160196",
    "user": "mderickx"
}
```

Changing assignee from tbd to jason, was.



---

archive/issue_comments_160197.json:
```json
{
    "body": "why should the following example not work?\n\n```\n   sage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)\n```\n\nall other mentioned ticket issues are fixed",
    "created_at": "2016-07-09T10:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160197",
    "user": "jakobkroeker"
}
```

why should the following example not work?

```
   sage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)
```

all other mentioned ticket issues are fixed



---

archive/issue_comments_160198.json:
```json
{
    "body": "It is not mathematically well-defined. See:\n\n```\nsage: ZZ.has_coerce_map_from(GF(7))\nFalse\n```\n",
    "created_at": "2016-07-09T16:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160198",
    "user": "tscrim"
}
```

It is not mathematically well-defined. See:

```
sage: ZZ.has_coerce_map_from(GF(7))
False
```




---

archive/issue_comments_160199.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> It is not mathematically well-defined. See:\n> {{{\n> sage: ZZ.has_coerce_map_from(GF(7))\n> False\n> }}}\n\nD'oh!\nIndeed. \n\nHopefully nobody reads my question.\nIt is still incorrect in recent sage 7.6, beta 4.",
    "created_at": "2017-03-04T03:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160199",
    "user": "jakobkroeker"
}
```

Replying to [comment:8 tscrim]:
> It is not mathematically well-defined. See:
> {{{
> sage: ZZ.has_coerce_map_from(GF(7))
> False
> }}}

D'oh!
Indeed. 

Hopefully nobody reads my question.
It is still incorrect in recent sage 7.6, beta 4.



---

archive/issue_comments_160200.json:
```json
{
    "body": "As an update to this ticket as of Sage 8.9, this appears to be almost fixed by now. The incorrect example:\n\n\n```\n(QQ^2).hom([[1/3,1/4],[1/3,1/6]],ZZ^2)\n```\n\n\nNow gives an error (`no conversion of this rational to integer`), and the example which is correct:\n\n\n```\n(ZZ^2).hom([[1/3,1/4],[1/3,1/6]],QQ^2)\n```\n\n\nDoes work. The part of this ticket that seems to be still relevant is the fact that the following does *not* give an error:\n\n\n```\nsage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)\nFree module morphism defined by the matrix\n[20  0]\n[ 0 21]\nDomain: Vector space of dimension 2 over Finite Field of size 7\nCodomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring\n```\n\n\nas mentioned above, since it doesn't make sense to coerce from `GF(7)` to `ZZ`. This is still something to fix",
    "created_at": "2019-07-07T23:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160200",
    "user": "@Torrencem"
}
```

As an update to this ticket as of Sage 8.9, this appears to be almost fixed by now. The incorrect example:


```
(QQ^2).hom([[1/3,1/4],[1/3,1/6]],ZZ^2)
```


Now gives an error (`no conversion of this rational to integer`), and the example which is correct:


```
(ZZ^2).hom([[1/3,1/4],[1/3,1/6]],QQ^2)
```


Does work. The part of this ticket that seems to be still relevant is the fact that the following does *not* give an error:


```
sage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)
Free module morphism defined by the matrix
[20  0]
[ 0 21]
Domain: Vector space of dimension 2 over Finite Field of size 7
Codomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring
```


as mentioned above, since it doesn't make sense to coerce from `GF(7)` to `ZZ`. This is still something to fix



---

archive/issue_comments_160201.json:
```json
{
    "body": "The final example in this issue seems to be solved. I.e. the following raises an error as expected:\n\n\n```\nsage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)                                       \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-11-f279e7ac9774> in <module>\n----> 1 (GF(Integer(7))**Integer(2)).hom([[Integer(20),Integer(0)],[Integer(0),Integer(21)]],ZZ**Integer(2))\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.hom (build/cythonized/sage/structure/parent.c:12200)()\n   1421             kwds['base_map'] = base_map\n   1422         Hom_kwds = {} if category is None else {'category': category}\n-> 1423         return self.Hom(codomain, **Hom_kwds)(im_gens, **kwds)\n   1424 \n   1425     #################################################################################\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/modules/free_module_homspace.py in __call__(self, A, check)\n    209                 pass\n    210         if not self.codomain().base_ring().has_coerce_map_from(self.domain().base_ring()) and not A.is_zero():\n--> 211             raise TypeError(\"nontrivial morphisms require a coercion map from the base ring of the domain to the base ring of the codomain\")\n    212         return free_module_morphism.FreeModuleMorphism(self, A)\n    213 \n\nTypeError: nontrivial morphisms require a coercion map from the base ring of the domain to the base ring of the codomain\n```\n\n\nAdditionally the only morphism that does exist is still valid:\n\n\n```\nsage: (GF(7)^2).hom([[0,0],[0,0]],ZZ^2)                                         \nFree module morphism defined by the matrix\n[0 0]\n[0 0]\nDomain: Vector space of dimension 2 over Finite Field of size 7\nCodomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring\n```\n",
    "created_at": "2021-11-28T10:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160201",
    "user": "mderickx"
}
```

The final example in this issue seems to be solved. I.e. the following raises an error as expected:


```
sage: (GF(7)^2).hom([[20,0],[0,21]],ZZ^2)                                       
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-f279e7ac9774> in <module>
----> 1 (GF(Integer(7))**Integer(2)).hom([[Integer(20),Integer(0)],[Integer(0),Integer(21)]],ZZ**Integer(2))

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.hom (build/cythonized/sage/structure/parent.c:12200)()
   1421             kwds['base_map'] = base_map
   1422         Hom_kwds = {} if category is None else {'category': category}
-> 1423         return self.Hom(codomain, **Hom_kwds)(im_gens, **kwds)
   1424 
   1425     #################################################################################

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/modules/free_module_homspace.py in __call__(self, A, check)
    209                 pass
    210         if not self.codomain().base_ring().has_coerce_map_from(self.domain().base_ring()) and not A.is_zero():
--> 211             raise TypeError("nontrivial morphisms require a coercion map from the base ring of the domain to the base ring of the codomain")
    212         return free_module_morphism.FreeModuleMorphism(self, A)
    213 

TypeError: nontrivial morphisms require a coercion map from the base ring of the domain to the base ring of the codomain
```


Additionally the only morphism that does exist is still valid:


```
sage: (GF(7)^2).hom([[0,0],[0,0]],ZZ^2)                                         
Free module morphism defined by the matrix
[0 0]
[0 0]
Domain: Vector space of dimension 2 over Finite Field of size 7
Codomain: Ambient free module of rank 2 over the principal ideal domain Integer Ring
```




---

archive/issue_comments_160202.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-28T10:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160202",
    "user": "mderickx"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160203.json:
```json
{
    "body": "Should we add a doctest to guard against changes to the current behavior?",
    "created_at": "2021-11-29T00:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160203",
    "user": "tscrim"
}
```

Should we add a doctest to guard against changes to the current behavior?



---

archive/issue_comments_160204.json:
```json
{
    "body": "I have added a doctest and refreshed the file.\n----\nNew commits:",
    "created_at": "2022-07-08T14:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160204",
    "user": "chapoton"
}
```

I have added a doctest and refreshed the file.
----
New commits:



---

archive/issue_comments_160205.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-08T17:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160205",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160206.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-09T22:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13149",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13149#issuecomment-160206",
    "user": "vbraun"
}
```

Resolution: fixed
