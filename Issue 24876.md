# Issue 24876: OSX is f*ed up

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2018-04-06 20:52:52

CC:  fbissey

The latest XCode broke Sage

```
sage -t --long src/doc/de/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/en/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/fr/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/ja/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/pt/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/ru/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/sage/rings/polynomial/groebner_fan.py  # 70 doctests failed
sage -t --long src/sage/rings/polynomial/multi_polynomial_ideal.py  # 1 doctest failed
```



---

Comment by dimpase created at 2018-04-07 06:27:16

I cannot reproduce this

```
$ ./sage -tp --long src/sage/rings/polynomial/groebner_fan.py
Running doctests with ID 2018-04-07-08-24-53-a2986dde.
Git branch: develop
Using --optional=gfortran,mpir,python2,sage
Doctesting 1 file using 8 threads.
sage -t --long --warn-long 46.6 src/sage/rings/polynomial/groebner_fan.py
    [357 tests, 4.34 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.5 seconds
    cpu time: 2.0 seconds
    cumulative wall time: 4.3 seconds
bash-3.2$ uname -a
Darwin trac.lri.fr 17.5.0 Darwin Kernel Version 17.5.0: Mon Mar  5 22:24:32 PST 2018; root:xnu-4570.51.1~1/RELEASE_X86_64 x86_64
```



---

Comment by fbissey created at 2018-04-07 06:34:02

Which version of xcode?


---

Comment by dimpase created at 2018-04-07 06:59:26

The latest, naturally. 

```
$ softwareupdate --history
Display Name                                       Version    Date                  
------------                                       -------    ----                  
iTunes                                             12.7.4     03/04/2018 at 23:54:12
macOS High Sierra 10.13.4 Update                              03/04/2018 at 23:54:12
Command Line Tools (macOS High Sierra version 10.13) for Xcode 9.3        03/04/2018 at 23:54:12
...
```



---

Comment by dimpase created at 2018-04-07 07:01:40

And yes, I did run `make distclean`, and then `./bootstrap`, `./configure CC=cc CXX=c++`

And I don't have `cchache` installed.


---

Comment by dimpase created at 2018-04-07 07:06:10

What else:


```
$ sysctl -n machdep.cpu.brand_string
Intel(R) Xeon(R) CPU E5-2697 v2 `@` 2.70GHz
```


So it could be that some other CPUs are f*cked, but not this one.


---

Comment by fbissey created at 2018-04-07 07:26:29

Interesting possibility 

```
$ sysctl -n machdep.cpu.brand_string
Intel(R) Core(TM) i5-4258U CPU `@` 2.40GHz
```



---

Comment by dimpase created at 2018-04-07 07:52:30

Other possibilities - I have `yasm` pre-built, so I don't build it over and over again; as well, I have pre-built autotools, and ran `./bootstrap` before building.

And next to no optional packages, it could be there is some rot there.


---

Comment by fbissey created at 2018-04-07 07:54:28

I did a clean build no optional packages. `yasm` would be intriguing since it is only involved in gmp/mpir.


---

Comment by dimpase created at 2018-04-07 08:07:51

Probably we should do everything with `SAGE_CHECK=yes`. I imagine this would show any problem with yasm while testing MPIR.

However, with this setting I get an error while testing `cython`. Perhaps that's where the real problem is --- however I don't know whether this worked before for `cython` on OSX, or there were always errors...


---

Comment by jhpalmieri created at 2018-04-07 16:04:13

On one machine:

```
$ softwareupdate --history
Display Name                                       Version    Date                  
------------                                       -------    ----                  
macOS High Sierra 10.13.4 Update                              03/30/2018, 08:36:15  
Command Line Tools (macOS High Sierra version 10.13) for Xcode 9.3        03/30/2018, 08:36:15  
iTunes                                             12.7.4     03/30/2018, 07:44:17 
```

and

```
$ sysctl -n machdep.cpu.brand_string
Intel(R) Core(TM) i7-7700K CPU `@` 4.20GHz
```

On another machine: similar for `softwareupdate --history` and

```
$ sysctl -n machdep.cpu.brand_string
Intel(R) Core(TM) i5-4260U CPU `@` 1.40GHz
```



---

Comment by jhpalmieri created at 2018-04-07 16:06:26

I saw the failures building from a fresh tarball, so I didn't run `./bootstrap` or anything else, just unpacked it and did `make ptestlong`. (I am pretty sure that I also did `make distclean` followed by `make ptestlong` and got the same errors.)


---

Comment by dimpase created at 2018-04-07 16:13:53

Perhaps a way to test whether this is CPU-dependent is to build with SAGE_FAT_BINARY on?


---

Comment by jhpalmieri created at 2018-04-07 16:30:17

Right now I have one machine with a still functioning build (because I was doing incremental upgrades). I can try to break it, but once it's been broken, I can't repeat the test. Should I try to break it by doing `./sage -f singular`? `./sage -f some_other_package`? What would help to diagnose this problem?


---

Comment by jhpalmieri created at 2018-04-07 16:42:18

I just tried `./sage -ba` and doctests still pass. I won't try anything else for now.


---

Comment by dimpase created at 2018-04-07 16:49:13

Can you build yasm using gcc and use it for a fresh build (instead of letting Sage build yasm)?
(yasm is like curl, configure will check if it is in the path and won't build it if it is there. I presume you can just create a link to such yasm you have built with gcc...)


---

Comment by jhpalmieri created at 2018-04-07 17:19:17

By `gcc`, you mean an actual `gcc` and not `/usr/bin/gcc`, which is actually `clang`? I have a copy of `gcc-6.4.0` lying around, and I used that to build `yasm`. Now a Sage build (using clang, not gcc) is underway.


---

Comment by dimpase created at 2018-04-07 17:36:29

Sure, I meant real gcc, not a fake one.


---

Comment by vbraun created at 2018-04-07 17:53:17

Compiling with SAGE_INSTALL_GCC=yes fixes it for me...

```
osx:~ vbraun$ sysctl -n machdep.cpu.brand_string
Intel(R) Core(TM) i7-3720QM CPU `@` 2.60GHz
```



---

Comment by jhpalmieri created at 2018-04-07 18:03:26

Using my own copy of yasm, I didn't run full doctests, but:

```
$ ./sage -tp src/doc/*/tutorial/
----------------------------------------------------------------------
sage -t src/doc/ru/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t src/doc/ja/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t src/doc/en/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t src/doc/de/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t src/doc/fr/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t src/doc/pt/tutorial/tour_advanced.rst  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by jhpalmieri created at 2018-04-07 18:03:58

Replying to [comment:19 vbraun]:
> Compiling with SAGE_INSTALL_GCC=yes fixes it for me...
> {{{
> osx:~ vbraun$ sysctl -n machdep.cpu.brand_string
> Intel(R) Core(TM) i7-3720QM CPU `@` 2.60GHz
> }}}

I also get no failures with Sage 8.1, which uses gcc instead of clang.


---

Comment by dimpase created at 2018-04-08 06:42:27

Are all these errors point at gfan?
One cannot tell without seeing errors in non-gfan dirs...

Does anyone know how to run gfan's testsuite? It would be a very good idea to do so, also adding spkg-check for gfan would be great...

There seems to be no make targets for this, is it done by some other tool?


---

Comment by vbraun created at 2018-04-08 09:43:42

FWIW gfan has a "make check" target but at least on gfan 0.6.2 it also fails with gcc on OSX. 

The fact that this is arch-dependent suggests that it is a bug in the clang optimizer.

In any case, we should just use gcc until this is fixed.
----
New commits:


---

Comment by vbraun created at 2018-04-08 09:44:26

For testing you need to run autoconf (and not download the packaged confball)


---

Comment by vbraun created at 2018-04-08 09:44:26

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-04-08 09:50:19

Should it be inside the `[...]` associated with the test for darwin? Rather than just out? It looks to me like it will be applied to all OSes.


---

Comment by vbraun created at 2018-04-08 10:07:42

No, the inside [] is not expanded in the configure.ac -> configure step. The end of the block is the `fi`


---

Comment by fbissey created at 2018-04-08 10:09:02

Replying to [comment:28 vbraun]:
> No, the inside [] is not expanded in the configure.ac -> configure step. The end of the block is the `fi`

Of course! Silly me, I wasn't thinking properly.


---

Comment by vbraun created at 2018-04-08 10:21:08

I also tripped over that one on the first go ;-)


---

Comment by jhpalmieri created at 2018-04-08 15:26:56

I'd rather this branch be on a stopgap ticket while this one remains open until a proper fix is found.


---

Comment by vbraun created at 2018-04-08 15:50:51

How about simply makeing a separate ticket for the proper fix to gfan?


---

Comment by vbraun created at 2018-04-08 15:54:36

This is now ï¿¼#25118: gfan fails when compiled with XCode 9.3


---

Comment by vbraun created at 2018-04-09 16:57:15

So can somebody set this to positive review?


---

Comment by fbissey created at 2018-04-10 07:58:34

LGTM.


---

Comment by fbissey created at 2018-04-10 07:58:34

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-04-10 20:38:25

Also on the ancient laptop tests fail like on i5/i7

```
$ sysctl -n machdep.cpu.brand_string
Intel(R) Core(TM)2 Duo CPU     L9400  `@` 1.86GHz
```


interestingly, clang is newer: `Apple LLVM version 9.1.0 (clang-902.0.39.1)`


---

Comment by vbraun created at 2018-04-10 22:33:07

Resolution: fixed


---

Comment by dimpase created at 2018-04-11 00:05:49

I must say I don't understand the rationale for this haste. 
Previous versions of Xcode are available, just don't use the broken one!

After all, it's what we do with gcc, we are not rushing to use the latest greatest, we are fine with gcc 5.4 still, right?

(One annoying part is that the older versions are harder to deploy, as they need to be downloaded from https://developer.apple.com/download/more/ but other than that...)


---

Comment by fbissey created at 2018-04-11 00:10:17

Replying to [comment:38 dimpase]:
> I must say I don't understand the rationale for this haste. 
> Previous versions of Xcode are available, just don't use the broken one!
> 
> After all, it's what we do with gcc, we are not rushing to use the latest greatest, we are fine with gcc 5.4 still, right?

I am assuming most people will be up to date and using the latest version they can. OS X users usually do. I am not sure how easy or hard it is to downgrade and stay there. Generally it is not nice to tell users to downgrade what they have.

You are right we could be pinpointing the version in question but actually maintaining a blacklist is quite costly.


---

Comment by dimpase created at 2018-04-11 00:16:56

conda-forge stays with Xcode 6, iirc.

No, I think on OSX people are not rushing to get the latest...


---

Comment by dimpase created at 2018-04-11 08:15:36

By the way, apparently Apple has been changing contents of their "Command line tools" bundles without bumping up versions, not sure whether it's the 1st accident of this sort, or not.

Namely, on my old laptop I installed Command Line Tools (macOS High Sierra version 10.13) for Xcode 9.3 on the 31st of March, and it had `Apple LLVM version 9.1.0 (clang-902.0.39.1)` (sic!), giving a broken gfan.
Yesterday I went and installed Command Line Tools (macOS High Sierra version 10.13) for Xcode 9.2 from their website,
and it has `Apple LLVM version 9.0.0 (clang-900.0.39.2)`, which results in OK gfan (with just one test broken, as on Ubuntu).

Could you people please install Command Line Tools (macOS High Sierra version 10.13) for Xcode 9.3 from https://developer.apple.com/download/more/ and test? (I presume you will get clang-902.0.39.1 this way).


---

Comment by fbissey created at 2018-04-11 08:37:01

We should arguing here and move that bit to #25118. Still that numbering makes you wonder if someone did build and ship the wrong level of tools or something.


---

Comment by dimpase created at 2018-04-11 10:07:18

Apparently the version of LLVM (from the same package!) depends upon the arch. I just tried installing Command Line Tools (macOS High Sierra version 10.13) for Xcode 9.3 on the Xeon box, but it did not result in a newer version.


---

Comment by dimpase created at 2018-04-11 15:27:44

Anyhow, I'm very close to have a complete fix for this on #25118.
