# Issue 17452: A tutorial on profiling in Sage

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2015-01-29 13:39:27

CC:  kcrisman jhpalmieri vdelecroix tmonteil dcoudert azi jmantysalo

This branch adds a tutorial on profiling in Sage. It merely points users toward the right tools and their specific documentation.

Nathann


---

Comment by ncohen created at 2015-01-29 13:40:19

New commits:


---

Comment by ncohen created at 2015-01-29 13:40:19

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-01-29 18:26:16

Hello,

Very cool to start that! Here are just potential improvements to discuss. This is not a complete review and I think it would be nice if several people actually read it.

 * For `%prun` would be cool to explain a little bit the columns. In particular why there is twice "percall".

 * In `%prun` what do you mean by 'critical functions'?

 * The following does not work for me
 {{{
  sage: %prun -r random_prime(2**500)
  sage: stats_object = _
  sage: stats.total_calls
  2547
  Traceback (most recent call last):
  ...
  AttributeError: 'module' object has no attribute 'total_calls'
 }}}

 * The `runsnake` program is curiously contained in the package `runsnakerun` on debian-like os. More generally, it would be cool to say on standard OS what are the packages to install. Right now it is only the case for `perf`.

 * For perf you need to launch the process before launching it??

Vincent


---

Comment by git created at 2015-01-29 19:14:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-01-29 19:20:31

Hello,

>  * For `%prun` would be cool to explain a little bit the columns. In particular why there is twice "percall".

I added a link for that. I am trying to keep this document "short and efficient" and to give users an idea of where to look for what they need, without documenting other people's code.

>  * In `%prun` what do you mean by 'critical functions'?

I meant 'performance-critical'. I rephrased it.

>  * The following does not work for me

The second 'stats' should be 'stats_object'. Fixed.

>  * The `runsnake` program is curiously contained in the package `runsnakerun` on debian-like os. More generally, it would be cool to say on standard OS what are the packages to install. Right now it is only the case for `perf`.

I added this information for 'perf' because 'perf' is a very common keyword in softwares, and that it is actually non-trivial to find out that it is part of linux-tools unless you more or less know what to look for.

To find out that 'runsnake' is included in the 'runsnakerun' debian package you need to type 'runsnake debian' in google (samek for ubuntu), and probably for most others. I fear that if I add one people will come from Fedora, archlinux and who knows what else to add totally trivial information.


```
~$ apt-cache search runsnake
runsnakerun - GUI utility for (Python) cProfile or Profile profiler dumps
```


>  * For perf you need to launch the process before launching it??

No need. This thing is a wonder.

Nathann


---

Comment by ncohen created at 2015-01-30 11:11:29

I just noticed a couple of mistakes in my last commit. I will update it today.


---

Comment by ncohen created at 2015-01-30 11:11:29

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-01-30 11:27:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-01-30 11:27:33

Done.


---

Comment by ncohen created at 2015-01-30 11:27:33

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-02-01 08:34:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-02-01 10:48:37

Hello,

I like the functional way of using `timeit`

```
sage: timeit("for i in range(2,100): _ = is_prime(i)")
625 loops, best of 3: 964 µs per loop
```

Especially because it allows you to tune the parameters

```
sage: timeit("for i in range(2,100): _ = is_prime(i)", number=137, precision=3)
137 loops, best of 3: 1.05 ms per loop
```

And even better, I like `sage_timeit` that allows you to play with the results (which is useful if you want to benchmark several implementations)

```
sage: from sage.misc.sage_timeit import sage_timeit
sage: t = sage_timeit("for i in range(2,100): _ = is_prime(i)", globals_dict=globals())
sage: t.stats
(625, 3, 3, 924.3534088134766, '\xc2\xb5s')
sage: t.series
[0.0009369647979736328, 0.0009340656280517578, 0.0009243534088134766]
```

What do you think of having it mentioned?

Vincent


---

Comment by ncohen created at 2015-02-01 11:05:52

Hello,

> I like the functional way of using `timeit`
>
> And even better, I like `sage_timeit` that allows you to play with the results (which is useful if you want to benchmark several implementations)
>
> What do you think of having it mentioned?

Would it be a problem for you if this documentation appeared in the docstring of `sage_timeit` (or its module)? Documenting the various arguments, their effects and uses is the job of the function's documentation.

We could then add a link from the tutorial to these places so that the interested user finds them.

I meant this page to be an overview of the different means to profile code in Sage, as it is difficult to find "timeit/prun/lprun/crun/perf" if you do not know the name already. With this page, people interested in profiling will find all the keywords they need, and links toward the specific documentations.

Nathann


---

Comment by git created at 2015-02-03 20:25:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-02-03 20:26:44

Turns out that we already had an interface with runsnake. I simplified an entry. Still in `needs_review`.

Nathann


---

Comment by ncohen created at 2015-02-05 10:21:44

Ping ?...

Nathann

P.S.: There is a stable release ahead, and the doc that will not make it before that will not appear online until the next one `^^;;;`


---

Comment by dcoudert created at 2015-02-06 17:11:48

This doc is very nice. Below are some comments / problems.

* `Note that while %time only runs the command once, timeit tries to return a more meaningful value over several runs.` -> shouldn't you write `%timeit` instead ?

* The `runsnake` command is not working on my mac, and the reported problem is not always the same :( Is this a known issue?

```
sage: runsnake('random_prime(2**500)')
sage:   File "/Users/dcoudert/.sage/temp/confetti.inria.fr/17114/tmp_WELnaQ", line 1
    {(i
      ^
SyntaxError: invalid syntax

sage: 
sage: runsnake('random_prime(2**500)')
sage:   File "/Users/dcoudert/.sage/temp/confetti.inria.fr/17114/tmp_UNaKxo", line 1
SyntaxError: Non-ASCII character '\xc5' in file /Users/dcoudert/.sage/temp/confetti.inria.fr/17114/tmp_UNaKxo on line 2, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details

sage: runsnake('random_prime(2**500)')
sage:   File "/Users/dcoudert/.sage/temp/confetti.inria.fr/17114/tmp_q4q1bM", line 1
SyntaxError: Non-ASCII character '\xfb' in file /Users/dcoudert/.sage/temp/confetti.inria.fr/17114/tmp_q4q1bM on line 2, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details

sage: 
```


* `%crun`: I have very different output. Is it normal ?

```
sage: %crun p=random_prime(2**500)
PROFILE: interrupts/evictions/bytes = 57/0/1840
Using local file /Users/dcoudert/sage/local/bin/python.
Using local file /Users/dcoudert/.sage/temp/confetti.inria.fr/38434/tmp_IbMOhg.perf.
Total: 57 samples
       0   0.0%   0.0%       10  17.5% __mh_execute_header
       3   5.3%   5.3%        3   5.3% 0x00007fff8a751c13
       0   0.0%   5.3%        2   3.5% 0x000000010225ce6b
       0   0.0%   5.3%        2   3.5% 0x00000001031e6ac8
       0   0.0%   5.3%        2   3.5% 0x000000010399c0ee
       0   0.0%   5.3%        2   3.5% 0x00007fff5da2fd4f
       0   0.0%   5.3%        1   1.8% 0x00000001021e57f9
```


* I'm not checking the linux-only section on my mac.

* As we already discussed, you may add a link to http://stackoverflow.com/questions/13075113/is-there-anyway-to-read-performance-counters-on-os-x-mountain-lion/13075880#13075880. The described procedure is not obvious and I'm not going to using it frequently, but it was working when I tried. It's really a pitty that profiling tools are not available on linux+mac.

David.


---

Comment by git created at 2015-02-06 22:51:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-02-06 22:56:08

Yo,

> * `Note that while %time only runs the command once, timeit tries to return a more meaningful value over several runs.` -> shouldn't you write `%timeit` instead ?

Fixed.

> * The `runsnake` command is not working on my mac, and the reported problem is not always the same :( Is this a known issue?

I don't know. There are two tickets that I know about `runsnake`: #17735 and #14414.

> * `%crun`: I have very different output. Is it normal ?

No idea. It looks like Python may have been compiled with different flags, but I do not know enough to answer that. I expect that the function will still be useful when the most time-consuming entries are Sage functions and not those internal Python functions.

> * As we already discussed, you may add a link to http://stackoverflow.com/questions/13075113/is-there-anyway-to-read-performance-counters-on-os-x-mountain-lion/13075880#13075880.

I prefer to not add a link toward a tutorial I cannot test myself.

Nathann


---

Comment by dcoudert created at 2015-02-07 13:12:43

Unfortunately I'm unable to test all proposed methods, so I cannot help more.


---

Comment by ncohen created at 2015-02-07 13:14:08

> Unfortunately I'm unable to test all proposed methods, so I cannot help more.

I understand, thanks for your help! But do give the 'perf' thing a try if you ever get a linux machine around, it may convince you to give mac up for your next laptop `;-)`

Nathann


---

Comment by ncohen created at 2015-02-10 17:44:02

Guys ?... The next stable release is pretty close. Would anybody have some time to review this patch so that it appears in the updated online doc ?

Nathann


---

Comment by ncohen created at 2015-02-13 08:54:38

Guys ?... It's only text...


---

Comment by tmonteil created at 2015-02-13 13:42:45

I am a bit overloaded right now to help more on this interesting and important ticket, but as such, there is a big confusion between ipython `%timeit` and Sage `timeit`, so `%timeit` has nothing to do with `timeit <sage.misc.sage_timeit_class>`. A problem with `%timeit` is that it is ipython only, so it will not work in Sage notebook (that does not rely on ipython). So you need at least to point to the right documentations for the two different `timeit`, see `timeit?` vs `%timeit?`.

For example, with the Sage `timeit()` command, you can not do:


```
sage: timeit(factor(1234567890))
AttributeError: 'IntegerFactorization' object has no attribute 'lstrip'
```


You have to do


```
sage: timeit("factor(1234567890)")
625 loops, best of 3: 72.8 µs per loop
```


But then, with ipython:


```
sage: %timeit("factor(1234567890)")
10000000 loops, best of 3: 26.3 ns per loop
```


Which is much faster... Indeed, it measures the time for creating the string ! What you have to do instead is:


```
sage: %timeit(factor(1234567890))
10000 loops, best of 3: 59.2 µs per loop
```


or


```
sage: %timeit factor(1234567890)
10000 loops, best of 3: 59.5 µs per loop
```


So there is a confusion that can lead to a silent misuse. It think this distinction should be made clear.


---

Comment by tmonteil created at 2015-02-13 13:42:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-13 15:47:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-02-13 15:49:13

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-02-13 15:49:13

> I am a bit overloaded right now to help more on this interesting and important ticket, but as such, there is a big confusion between ipython `%timeit` and Sage `timeit`, so `%timeit` has nothing to do with `timeit <sage.misc.sage_timeit_class>`.

As I did not even use `timeit` in the examples I chose to remove this link toward Sage's timeit function. We still link toward Python's timeit function.

All examples in this document use `%` functions, and the last one requires a terminal, so notebook users are already a bit out of scope.

Nathann


---

Comment by git created at 2015-03-11 12:46:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-03-11 12:46:26

Rebased on the latest beta.


---

Comment by ncohen created at 2015-03-17 12:55:30

Guys ?...


---

Comment by git created at 2015-03-31 14:28:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-31 14:37:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-31 14:47:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tmonteil created at 2015-03-31 14:51:49

I added some info about the `timeit` Sage function since the `%timeit` IPython magic is not available from the Sage notebook, and clarify the fact that `%` IPython magics are not Python commands. Is-it OK ?


---

Comment by ncohen created at 2015-03-31 15:05:24

> I added some info about the `timeit` Sage function since the `%timeit` IPython magic is not available from the Sage notebook, and clarify the fact that `%` IPython magics are not Python commands. Is-it OK ?

Yeahyeah it is fine (and concise, thanks ! `:-P`). I shortened a couple of sentences and replaced (as you asked me to) the 500 with a 300 in the first examples, so that the `timeit` call runs more than 1 loop.

Is that okay for you?

Nathann


---

Comment by git created at 2015-03-31 15:06:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-03-31 15:10:06

Changing status from needs_review to positive_review.


---

Comment by tmonteil created at 2015-03-31 15:10:06

Changing keywords from "" to "sd66".


---

Comment by tmonteil created at 2015-03-31 15:10:06

Good to go !


---

Comment by ncohen created at 2015-03-31 15:19:17

Wouhouuuuuuuu ! THaaaaaaaaaaanks ! `;-)`

Nathann


---

Comment by vbraun created at 2015-04-14 19:44:00

Resolution: fixed
