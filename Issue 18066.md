# Issue 18066: faster comparisons in AA and QQbar

Issue created by migration from https://trac.sagemath.org/ticket/18303

Original creator: vdelecroix

Original creation time: 2015-04-26 10:34:03

CC:  gagern jdemeyer

As remarked in #17890 the comparisons of elements in `QQbar` can be much faster by implementing `_richcmp_` instead of `__cmp__`. A naive implementation already gives a great speedup

old timing

```
sage: a = AA(125/13)
sage: b = AA(3/5)
sage: timeit("a < b", repeat=10, number=50000)
50000 loops, best of 10: 15.9 µs per loop
sage: a = AA(2).sqrt()
sage: timeit("a < b", repeat=10, number=50000)
50000 loops, best of 10: 17.9 µs per loop
```


new timing

```
sage: a = AA(125/13)
sage: b = AA(3/5)
sage: timeit("a < b", repeat=10, number=50000)
50000 loops, best of 10: 1.02 µs per loop
sage: a = AA(2).sqrt()
sage: timeit("a < b", repeat=10, number=50000)
50000 loops, best of 10: 7.6 µs per loop
```



---

Comment by git created at 2015-04-26 13:20:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-26 13:20:54

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-04-28 12:50:58

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-04-28 12:50:58

failing doctests


---

Comment by git created at 2015-04-29 22:22:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2015-04-29 22:23:13

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-05-05 08:18:41

2 failing doctests, see patchbot report


---

Comment by chapoton created at 2015-05-05 08:18:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-08 22:25:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2015-05-08 22:25:49

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-05-08 22:35:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-06 15:41:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-06 15:41:48

rebased on the rebased #18305


---

Comment by chapoton created at 2015-10-14 16:39:54

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-10-14 16:39:54

does not apply


---

Comment by chapoton created at 2017-04-30 17:19:36

here is a new tentative based on the existing branch

The idea is to use only rich comparison, and avoid calls to cmp or `_cmp_`
----
New commits:


---

Comment by chapoton created at 2017-04-30 17:19:57

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-04-30 17:30:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-30 19:31:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-02 11:27:08

Vincent, would you have time to make progress here ? Maybe this is close to be ready, but I am not so sure.

This is on the road to #22907, which is on the road to #22297, which is on the **long** road to python3.


---

Comment by git created at 2017-05-02 14:49:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-02 14:51:38

Thanks Frédéric for taking care. I squashed your two commits and rebased on 8.0.beta4. The code needed some fix and actually it was possible to get rid of one of the implementation of `__nonzero__`.

Needs review again!


---

Comment by git created at 2017-05-02 14:53:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-05-02 17:14:29

Merci, Vincent.

* There are now a few trivial failing doctests. Should I take care of them ?

* Did you check that speed is improved ?


---

Comment by git created at 2017-05-03 08:30:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-03 08:39:13

I confirm that the timings are much better.


---

Comment by git created at 2017-05-03 08:45:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-03 08:46:09

I do not understand the doctest block starting with

```
+        The following are non-trivially zeros (though no exactification occur)::
```

How are these doctests related to this sentence ?


---

Comment by chapoton created at 2017-05-03 15:36:02

I think one should rather keep `__bool__` for the name, and {{{__nonzero__}} only as an alias, as I did.


---

Comment by vdelecroix created at 2017-05-03 15:57:32

Replying to [comment:30 chapoton]:
> I think one should rather keep `__bool__` for the name, and {{{__nonzero__}} only as an alias, as I did.

What is the point!? `__nonzero__` is standard Python and is used everywhere in Sage.


---

Comment by vdelecroix created at 2017-05-03 15:58:02

Replying to [comment:29 chapoton]:
> I do not understand the doctest block starting with
> {{{
> +        The following are non-trivially zeros (though no exactification occur)::
> }}}
> How are these doctests related to this sentence ?

Because the doctests test whether some quantity is zero. Let me try to rephrase it.


---

Comment by vdelecroix created at 2017-05-03 15:59:04

(I don't understand, I did not receive any notification by mail!)


---

Comment by vdelecroix created at 2017-05-03 16:05:52

Replying to [comment:31 vdelecroix]:
> Replying to [comment:30 chapoton]:
> > I think one should rather keep `__bool__` for the name, and {{{__nonzero__}} only as an alias, as I did.
> 
> What is the point!? `__nonzero__` is standard Python and is used everywhere in Sage.

I see, `__nonzero__` does not exists anymore in Python3. But then, will you take care again of removing all aliases `__nonzero__ = __bool__`? As this 2to3 move is pretty simple I do not see the point of doing it now.


---

Comment by git created at 2017-05-03 16:12:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-03 17:09:27

I would not have insisted on `__nonzero__`, but this indeed for python3-readiness.

For the doctests, sorry but I still do not understand. You say morally 'let us check that something is zero non-trivially" and then all doctests are of the kind 

```
bool(something)
False
```

which mean that something is NOT zero. What am I missing ?


---

Comment by vdelecroix created at 2017-05-03 17:11:19

Replying to [comment:36 chapoton]:
> I would not have insisted on `__nonzero__`, but this indeed for python3-readiness.
> 
> For the doctests, sorry but I still do not understand. You say morally 'let us check that something is zero non-trivially" and then all doctests are of the kind 
> {{{
> bool(something)
> False
> }}}
> which mean that something is NOT zero. What am I missing ?

- `bool(0)` -> `False`
- `bool(1)` -> `True`


---

Comment by chapoton created at 2017-05-03 17:17:17

oh, damn. Must be tired.

Then I think this is ready to go. You can set to positive if you agree.

Replying to [comment:36 chapoton]:
> I would not have insisted on `__nonzero__`, but this indeed for python3-readiness.
> 
> For the doctests, sorry but I still do not understand. You say morally 'let us check that something is zero non-trivially" and then all doctests are of the kind 
> {{{
> bool(something)
> False
> }}}
> which mean that something is NOT zero. What am I missing ?


---

Comment by vdelecroix created at 2017-05-03 17:18:17

Will do. Just waiting for quasar.


---

Comment by vdelecroix created at 2017-05-03 17:29:25

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-05-03 17:29:25

quasar is happy! Thanks for the review.


---

Comment by vbraun created at 2017-05-08 21:19:06

Resolution: fixed
