# Issue 24504: py3: numerous additional fixes for sage.numerical

Issue created by migration from https://trac.sagemath.org/ticket/24741

Original creator: embray

Original creation time: 2018-02-15 14:59:56




---

Comment by embray created at 2018-02-15 15:00:10

New commits:


---

Comment by embray created at 2018-02-15 15:00:10

Changing status from new to needs_review.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by chapoton created at 2018-09-05 19:52:44

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-09-05 19:52:44

branch is red


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by chapoton created at 2018-12-28 20:57:32

red branch


---

Comment by chapoton created at 2019-02-24 12:34:26

still red


---

Comment by embray created at 2019-02-25 16:27:57

This branch is such a mess now.  I think a lot of the things in it were already fixed.  I'm trying to figure it out...


---

Comment by chapoton created at 2019-02-25 16:52:37

yes, indeed. That's why I did not manage to merge or rebase it myself..


---

Comment by embray created at 2019-02-27 16:04:27

Okay, I'm working on it.  From what I can tell there are still a handful of fixes in here that haven't made it into the mainline yet.


---

Comment by embray created at 2019-02-27 16:04:27

Set assignee to embray.


---

Comment by git created at 2019-02-27 17:00:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-27 17:03:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-02-27 17:41:15

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-02-27 17:41:15

I think this is fine now.  With this, the only failures I'm seeing in `sage.numerical` are due to `__round__`.


---

Comment by chapoton created at 2019-02-27 19:23:13

* some changes will likely conflict with #27342 (sorry for the lack of coordination)

* I am worried about the changes in `src/sage/numerical/backends/cvxopt_backend.pyx`,
because we iterate twice over the input, and this will fail if it is an iterator..


---

Comment by embray created at 2019-02-28 13:08:21

It could check if it's not already a `list` and just wrap it in `list` if not.  That would be superfluous for other sized sequences but there's no better way to deal with that case without #26769, which I still contend is useful.


---

Comment by embray created at 2019-02-28 13:08:54

Also if that's definitely a problem it's not caught be any tests.  Why don't you see if it actually does break, and if so a regression test should be added.


---

Comment by chapoton created at 2019-02-28 15:39:05

ok, then. Let us keep this question about `list` for somewhere else.

What about the conflict with #27342 ?


---

Comment by dcoudert created at 2019-02-28 16:34:01

- why using `if type(indices) is not list:` instead of `if not isinstance(indices, list):` ?

- in `src/sage/numerical/interactive_simplex_method.py`

```diff
-        names.extend([str(s) for s in self.x()])
+        names.extend(str(s) for s in self.x())
```


otherwise, LGTM


---

Comment by embray created at 2019-02-28 17:05:10

We want to convert these inputs explicitly to `PyListType`-typed objects so that Cython can generate efficient code to loop over them.  This is why the previous code explicitly typed those arguments as `list`.  This does effectively the same thing but allows the arguments to be iterables of other types, and then convert them to `list`.


---

Comment by dcoudert created at 2019-02-28 17:19:15

I perfectly understood that you now allow to give an iterable as input, and that it is important to cast to `PyListType`.

What I don't understand is the use of `type(indices) is not list` instead of `isinstance(indices, list)`. Is this a more efficient formulation in Cython or just a stylistic preference ?


---

Comment by embray created at 2019-03-01 11:20:28

Yes, if you want to check an _exact_ type using `type(foo) is bar` is orders of magnitude faster, because it's just a pointer comparison.

`isinstance(...)` is a much more complex beast that needs to be able to support things like subclasses as well as `__instancecheck_` and `__subclasscheck__`.  So it's better, especially in Cython code, to do exact type comparisons when that's all you need in a particular case.


---

Comment by dcoudert created at 2019-03-01 12:02:11

Thanks for the explanation. It's good to know.

The remaining issues with py3 are due to `__round__`, and there is this possible minor improvement #comment:19 for `names.extend`.


---

Comment by embray created at 2019-03-01 13:13:42

Hmm, not that it really matters much here either way but I'm not sure comment:19 is necessarily much of an improvement.  In most cases I do advocate for generator expressions, but for small collections there's actually more overhead in terms of setting up the generator object and iterating over it than it's worth.  For example:


```
In [1]: x = list(range(4))

In [2]: %%timeit
   ...: names = []
   ...: names.extend(str(_) for _ in x)
   ...:
100000 loops, best of 3: 2.19 µs per loop

In [3]: %%timeit
   ...: names = []
   ...: names.extend([str(_) for _ in x])
   ...:
1000000 loops, best of 3: 1.48 µs per loop
```


You can also see in the [list.extend](https://github.com/python/cpython/blob/69b4a17f342146d6b7a73975a37678db9916aa75/Objects/listobject.c#L799) implementation that it has a more optimized code path for the case where it's given a list or tuple and can use the `PySequence_Fast` API, as opposed to the more generic path of having to guess what the new size of the list will be (using `__length_hint__` if there is one) and slowly iterate over the iterable.

Of course that's all implementation detail and there's no guarantee in the language that this should be faster.  By rights the generator expression should be "better" but in practice it isn't, at least for small lists.


---

Comment by dcoudert created at 2019-03-01 13:45:05

Thank you very much for this detailed explanation. Then I agree that current formulation is good.

To avoid merge conflict with #27342, you should revert some changes
- `linear_functions.pyx` (same done in #27342)
- `mip.pyx`: 

```diff
-            sage: x_sol.keys()
+            sage: sorted(x_sol)
```



---

Comment by embray created at 2019-03-01 14:06:35

Thanks for reminding me. Yes, I'll just rebase this on top of #27342.


---

Comment by embray created at 2019-03-01 14:06:35

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-03-03 11:03:28

red branch, as expected


---

Comment by embray created at 2019-03-05 16:47:57

All the better then.


---

Comment by git created at 2019-03-05 17:12:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-03-05 17:14:26

I think this is still good, though I did not test on Python 3.


---

Comment by embray created at 2019-03-05 17:14:26

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-03-05 22:05:54

With this branch on Python3, I go from

```
sage -t src/sage/numerical/mip.pyx  # 1 doctest failed
sage -t src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 6 doctests failed
sage -t src/sage/numerical/sdp.pyx  # 10 doctests failed
sage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 9 doctests failed
sage -t src/sage/numerical/backends/glpk_backend.pyx  # Killed due to abort
```

to

```
sage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 8 doctests failed
sage -t src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 5 doctests failed
sage -t src/sage/numerical/sdp.pyx  # 8 doctests failed
```

which all look like `round`-type failures


---

Comment by tscrim created at 2019-03-05 22:05:54

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2019-03-06 07:53:48

Same for me. Good to go.


---

Comment by vbraun created at 2019-03-06 20:46:01

Resolution: fixed
