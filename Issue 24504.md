# Issue 24504: py3: numerous additional fixes for sage.numerical

archive/issues_024504.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/24741\n\n",
    "created_at": "2018-02-15T14:59:56Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "py3: numerous additional fixes for sage.numerical",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24504",
    "user": "@embray"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/24741





---

archive/issue_comments_343801.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-15T15:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343801",
    "user": "@embray"
}
```

New commits:



---

archive/issue_comments_343802.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-15T15:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343802",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343803.json:
```json
{
    "body": "I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343803",
    "user": "@embray"
}
```

I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_comments_343804.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-05T19:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343804",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343805.json:
```json
{
    "body": "branch is red",
    "created_at": "2018-09-05T19:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343805",
    "user": "@fchapoton"
}
```

branch is red



---

archive/issue_comments_343806.json:
```json
{
    "body": "Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343806",
    "user": "@embray"
}
```

Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_343807.json:
```json
{
    "body": "red branch",
    "created_at": "2018-12-28T20:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343807",
    "user": "@fchapoton"
}
```

red branch



---

archive/issue_comments_343808.json:
```json
{
    "body": "still red",
    "created_at": "2019-02-24T12:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343808",
    "user": "@fchapoton"
}
```

still red



---

archive/issue_comments_343809.json:
```json
{
    "body": "This branch is such a mess now.  I think a lot of the things in it were already fixed.  I'm trying to figure it out...",
    "created_at": "2019-02-25T16:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343809",
    "user": "@embray"
}
```

This branch is such a mess now.  I think a lot of the things in it were already fixed.  I'm trying to figure it out...



---

archive/issue_comments_343810.json:
```json
{
    "body": "yes, indeed. That's why I did not manage to merge or rebase it myself..",
    "created_at": "2019-02-25T16:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343810",
    "user": "@fchapoton"
}
```

yes, indeed. That's why I did not manage to merge or rebase it myself..



---

archive/issue_comments_343811.json:
```json
{
    "body": "Okay, I'm working on it.  From what I can tell there are still a handful of fixes in here that haven't made it into the mainline yet.",
    "created_at": "2019-02-27T16:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343811",
    "user": "@embray"
}
```

Okay, I'm working on it.  From what I can tell there are still a handful of fixes in here that haven't made it into the mainline yet.



---

archive/issue_comments_343812.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2019-02-27T16:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343812",
    "user": "@embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_343813.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-27T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343813",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343814.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-27T17:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343814",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343815.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-27T17:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343815",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_343816.json:
```json
{
    "body": "I think this is fine now.  With this, the only failures I'm seeing in `sage.numerical` are due to `__round__`.",
    "created_at": "2019-02-27T17:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343816",
    "user": "@embray"
}
```

I think this is fine now.  With this, the only failures I'm seeing in `sage.numerical` are due to `__round__`.



---

archive/issue_comments_343817.json:
```json
{
    "body": "* some changes will likely conflict with #27342 (sorry for the lack of coordination)\n\n* I am worried about the changes in `src/sage/numerical/backends/cvxopt_backend.pyx`,\nbecause we iterate twice over the input, and this will fail if it is an iterator..",
    "created_at": "2019-02-27T19:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343817",
    "user": "@fchapoton"
}
```

* some changes will likely conflict with #27342 (sorry for the lack of coordination)

* I am worried about the changes in `src/sage/numerical/backends/cvxopt_backend.pyx`,
because we iterate twice over the input, and this will fail if it is an iterator..



---

archive/issue_comments_343818.json:
```json
{
    "body": "It could check if it's not already a `list` and just wrap it in `list` if not.  That would be superfluous for other sized sequences but there's no better way to deal with that case without #26769, which I still contend is useful.",
    "created_at": "2019-02-28T13:08:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343818",
    "user": "@embray"
}
```

It could check if it's not already a `list` and just wrap it in `list` if not.  That would be superfluous for other sized sequences but there's no better way to deal with that case without #26769, which I still contend is useful.



---

archive/issue_comments_343819.json:
```json
{
    "body": "Also if that's definitely a problem it's not caught be any tests.  Why don't you see if it actually does break, and if so a regression test should be added.",
    "created_at": "2019-02-28T13:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343819",
    "user": "@embray"
}
```

Also if that's definitely a problem it's not caught be any tests.  Why don't you see if it actually does break, and if so a regression test should be added.



---

archive/issue_comments_343820.json:
```json
{
    "body": "ok, then. Let us keep this question about `list` for somewhere else.\n\nWhat about the conflict with #27342 ?",
    "created_at": "2019-02-28T15:39:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343820",
    "user": "@fchapoton"
}
```

ok, then. Let us keep this question about `list` for somewhere else.

What about the conflict with #27342 ?



---

archive/issue_comments_343821.json:
```json
{
    "body": "- why using `if type(indices) is not list:` instead of `if not isinstance(indices, list):` ?\n\n- in `src/sage/numerical/interactive_simplex_method.py`\n\n```diff\n-        names.extend([str(s) for s in self.x()])\n+        names.extend(str(s) for s in self.x())\n```\n\n\notherwise, LGTM",
    "created_at": "2019-02-28T16:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343821",
    "user": "@dcoudert"
}
```

- why using `if type(indices) is not list:` instead of `if not isinstance(indices, list):` ?

- in `src/sage/numerical/interactive_simplex_method.py`

```diff
-        names.extend([str(s) for s in self.x()])
+        names.extend(str(s) for s in self.x())
```


otherwise, LGTM



---

archive/issue_comments_343822.json:
```json
{
    "body": "We want to convert these inputs explicitly to `PyListType`-typed objects so that Cython can generate efficient code to loop over them.  This is why the previous code explicitly typed those arguments as `list`.  This does effectively the same thing but allows the arguments to be iterables of other types, and then convert them to `list`.",
    "created_at": "2019-02-28T17:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343822",
    "user": "@embray"
}
```

We want to convert these inputs explicitly to `PyListType`-typed objects so that Cython can generate efficient code to loop over them.  This is why the previous code explicitly typed those arguments as `list`.  This does effectively the same thing but allows the arguments to be iterables of other types, and then convert them to `list`.



---

archive/issue_comments_343823.json:
```json
{
    "body": "I perfectly understood that you now allow to give an iterable as input, and that it is important to cast to `PyListType`.\n\nWhat I don't understand is the use of `type(indices) is not list` instead of `isinstance(indices, list)`. Is this a more efficient formulation in Cython or just a stylistic preference ?",
    "created_at": "2019-02-28T17:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343823",
    "user": "@dcoudert"
}
```

I perfectly understood that you now allow to give an iterable as input, and that it is important to cast to `PyListType`.

What I don't understand is the use of `type(indices) is not list` instead of `isinstance(indices, list)`. Is this a more efficient formulation in Cython or just a stylistic preference ?



---

archive/issue_comments_343824.json:
```json
{
    "body": "Yes, if you want to check an *exact* type using `type(foo) is bar` is orders of magnitude faster, because it's just a pointer comparison.\n\n`isinstance(...)` is a much more complex beast that needs to be able to support things like subclasses as well as `__instancecheck_` and `__subclasscheck__`.  So it's better, especially in Cython code, to do exact type comparisons when that's all you need in a particular case.",
    "created_at": "2019-03-01T11:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343824",
    "user": "@embray"
}
```

Yes, if you want to check an *exact* type using `type(foo) is bar` is orders of magnitude faster, because it's just a pointer comparison.

`isinstance(...)` is a much more complex beast that needs to be able to support things like subclasses as well as `__instancecheck_` and `__subclasscheck__`.  So it's better, especially in Cython code, to do exact type comparisons when that's all you need in a particular case.



---

archive/issue_comments_343825.json:
```json
{
    "body": "Thanks for the explanation. It's good to know.\n\nThe remaining issues with py3 are due to `__round__`, and there is this possible minor improvement #comment:19 for `names.extend`.",
    "created_at": "2019-03-01T12:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343825",
    "user": "@dcoudert"
}
```

Thanks for the explanation. It's good to know.

The remaining issues with py3 are due to `__round__`, and there is this possible minor improvement #comment:19 for `names.extend`.



---

archive/issue_comments_343826.json:
```json
{
    "body": "Hmm, not that it really matters much here either way but I'm not sure comment:19 is necessarily much of an improvement.  In most cases I do advocate for generator expressions, but for small collections there's actually more overhead in terms of setting up the generator object and iterating over it than it's worth.  For example:\n\n\n```\nIn [1]: x = list(range(4))\n\nIn [2]: %%timeit\n   ...: names = []\n   ...: names.extend(str(_) for _ in x)\n   ...:\n100000 loops, best of 3: 2.19 \u00b5s per loop\n\nIn [3]: %%timeit\n   ...: names = []\n   ...: names.extend([str(_) for _ in x])\n   ...:\n1000000 loops, best of 3: 1.48 \u00b5s per loop\n```\n\n\nYou can also see in the [list.extend](https://github.com/python/cpython/blob/69b4a17f342146d6b7a73975a37678db9916aa75/Objects/listobject.c#L799) implementation that it has a more optimized code path for the case where it's given a list or tuple and can use the `PySequence_Fast` API, as opposed to the more generic path of having to guess what the new size of the list will be (using `__length_hint__` if there is one) and slowly iterate over the iterable.\n\nOf course that's all implementation detail and there's no guarantee in the language that this should be faster.  By rights the generator expression should be \"better\" but in practice it isn't, at least for small lists.",
    "created_at": "2019-03-01T13:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343826",
    "user": "@embray"
}
```

Hmm, not that it really matters much here either way but I'm not sure comment:19 is necessarily much of an improvement.  In most cases I do advocate for generator expressions, but for small collections there's actually more overhead in terms of setting up the generator object and iterating over it than it's worth.  For example:


```
In [1]: x = list(range(4))

In [2]: %%timeit
   ...: names = []
   ...: names.extend(str(_) for _ in x)
   ...:
100000 loops, best of 3: 2.19 µs per loop

In [3]: %%timeit
   ...: names = []
   ...: names.extend([str(_) for _ in x])
   ...:
1000000 loops, best of 3: 1.48 µs per loop
```


You can also see in the [list.extend](https://github.com/python/cpython/blob/69b4a17f342146d6b7a73975a37678db9916aa75/Objects/listobject.c#L799) implementation that it has a more optimized code path for the case where it's given a list or tuple and can use the `PySequence_Fast` API, as opposed to the more generic path of having to guess what the new size of the list will be (using `__length_hint__` if there is one) and slowly iterate over the iterable.

Of course that's all implementation detail and there's no guarantee in the language that this should be faster.  By rights the generator expression should be "better" but in practice it isn't, at least for small lists.



---

archive/issue_comments_343827.json:
```json
{
    "body": "Thank you very much for this detailed explanation. Then I agree that current formulation is good.\n\nTo avoid merge conflict with #27342, you should revert some changes\n- `linear_functions.pyx` (same done in #27342)\n- `mip.pyx`: \n\n```diff\n-            sage: x_sol.keys()\n+            sage: sorted(x_sol)\n```\n",
    "created_at": "2019-03-01T13:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343827",
    "user": "@dcoudert"
}
```

Thank you very much for this detailed explanation. Then I agree that current formulation is good.

To avoid merge conflict with #27342, you should revert some changes
- `linear_functions.pyx` (same done in #27342)
- `mip.pyx`: 

```diff
-            sage: x_sol.keys()
+            sage: sorted(x_sol)
```




---

archive/issue_comments_343828.json:
```json
{
    "body": "Thanks for reminding me. Yes, I'll just rebase this on top of #27342.",
    "created_at": "2019-03-01T14:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343828",
    "user": "@embray"
}
```

Thanks for reminding me. Yes, I'll just rebase this on top of #27342.



---

archive/issue_comments_343829.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-01T14:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343829",
    "user": "@embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343830.json:
```json
{
    "body": "red branch, as expected",
    "created_at": "2019-03-03T11:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343830",
    "user": "@fchapoton"
}
```

red branch, as expected



---

archive/issue_comments_343831.json:
```json
{
    "body": "All the better then.",
    "created_at": "2019-03-05T16:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343831",
    "user": "@embray"
}
```

All the better then.



---

archive/issue_comments_343832.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-05T17:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343832",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343833.json:
```json
{
    "body": "I think this is still good, though I did not test on Python 3.",
    "created_at": "2019-03-05T17:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343833",
    "user": "@embray"
}
```

I think this is still good, though I did not test on Python 3.



---

archive/issue_comments_343834.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-05T17:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343834",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_343835.json:
```json
{
    "body": "With this branch on Python3, I go from\n\n```\nsage -t src/sage/numerical/mip.pyx  # 1 doctest failed\nsage -t src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 6 doctests failed\nsage -t src/sage/numerical/sdp.pyx  # 10 doctests failed\nsage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 9 doctests failed\nsage -t src/sage/numerical/backends/glpk_backend.pyx  # Killed due to abort\n```\n\nto\n\n```\nsage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 8 doctests failed\nsage -t src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 5 doctests failed\nsage -t src/sage/numerical/sdp.pyx  # 8 doctests failed\n```\n\nwhich all look like `round`-type failures",
    "created_at": "2019-03-05T22:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343835",
    "user": "@tscrim"
}
```

With this branch on Python3, I go from

```
sage -t src/sage/numerical/mip.pyx  # 1 doctest failed
sage -t src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 6 doctests failed
sage -t src/sage/numerical/sdp.pyx  # 10 doctests failed
sage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 9 doctests failed
sage -t src/sage/numerical/backends/glpk_backend.pyx  # Killed due to abort
```

to

```
sage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 8 doctests failed
sage -t src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 5 doctests failed
sage -t src/sage/numerical/sdp.pyx  # 8 doctests failed
```

which all look like `round`-type failures



---

archive/issue_comments_343836.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-05T22:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343836",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_343837.json:
```json
{
    "body": "Same for me. Good to go.",
    "created_at": "2019-03-06T07:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343837",
    "user": "@dcoudert"
}
```

Same for me. Good to go.



---

archive/issue_comments_343838.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-06T20:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24504#issuecomment-343838",
    "user": "@vbraun"
}
```

Resolution: fixed
