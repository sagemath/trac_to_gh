# Issue 24668: Upgrade polymake to version 3.2r2

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2018-03-06 06:28:53

CC:  simonking jipilab vdelecroix slelievre @sophiasage paffenholz@mathematik.tu-darmstadt.de kastner@math.tu-berlin.de

https://polymake.org/doku.php/news/release_3_2


---

Comment by git created at 2018-04-05 21:38:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2018-04-05 21:47:42

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-04-06 12:14:14

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-04-06 12:14:14

`ninja_build` should be an order-only dependency (after the `|` symbol)


---

Comment by jdemeyer created at 2018-04-06 12:16:35

All other packages have `$(MP_LIBRARY)` in their dependencies instead of `$(INST)/$(SAGE_MP_LIBRARY)`. I guess this should be changed.


---

Comment by jdemeyer created at 2018-04-06 12:22:30

Unfortunately, I cannot test this because `perl_term_readline_gnu` fails to install:

```
[perl_term_readline_gnu-1.34] Could not find neither libtermcap.a, libncurses.a, or libcurses.
```

Indeed, there is no `libncurses.a` installed (but `libncurses.so` is).


---

Comment by mkoeppe created at 2018-04-06 16:31:12

Replying to [comment:7 jdemeyer]:
> Unfortunately, I cannot test this because `perl_term_readline_gnu` fails to install:
> {{{
> [perl_term_readline_gnu-1.34] Could not find neither libtermcap.a, libncurses.a, or libcurses.
> }}}
> Indeed, there is no `libncurses.a` installed (but `libncurses.so` is).
Could you create a separate ticket for this (and include more log detail)?


---

Comment by git created at 2018-04-06 16:38:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2018-04-06 18:45:18

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2018-04-06 18:51:54

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2018-04-06 19:36:06

This upgrade seems to break the whole polymake interface. Next step: Compare what's happening on the wire (pexpect log) between the two polymake versions.


---

Comment by mkoeppe created at 2018-04-06 20:23:48

Replying to [comment:8 mkoeppe]:
> Replying to [comment:7 jdemeyer]:
> > Unfortunately, I cannot test this because `perl_term_readline_gnu` fails to install:
> > {{{
> > [perl_term_readline_gnu-1.34] Could not find neither libtermcap.a, libncurses.a, or libcurses.
> > }}}
> > Indeed, there is no `libncurses.a` installed (but `libncurses.so` is).
> Could you create a separate ticket for this (and include more log detail)?

We have reproduced this problem on another linux box. Fix is in #25112.


---

Comment by git created at 2018-04-06 22:19:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2018-04-06 23:42:21

Compilation fails on Debian stretch. I copy the relevant section of the log file:


```
[706/940] LD /home/jplabbe/sage/local/var/tmp/sage/build/polymake-3.2r2/src/build/Opt/lib/polytope.so
FAILED: /home/jplabbe/sage/local/var/tmp/sage/build/polymake-3.2r2/src/build/Opt/lib/polytope.so 
g++ -shared -L/usr/local/lib -fstack-protector-strong -Wl,-z,lazy -Wl,--as-needed  -o 
LOOOOOOOOGGGGGGGGGGGGGGGGGGGGG LIST OF .o and .so files 
/home/jplabbe/sage/local/var/tmp/sage/build/polymake-3.2r2/src/build/Opt/staticlib/sympol/libsympol.a  -L/home/jplabbe/sage/local/lib -Wl,-rpath,/home/jplabbe/sage/local/lib -lsoplex -lz -lppl -llrsgmp -lnormaliz -lgmpxx -lcddgmp -L/home/jplabbe/sage/local/lib -Wl,-rpath,/home/jplabbe/sage/local/lib  -fopenmp -lmpfr -lgmp -lpthread  -ldl
/usr/bin/ld: /home/jplabbe/sage/local/lib/libsoplex.a(rational.cpp.o): relocation R_X86_64_TPOFF32 against symbol `_ZN6soplex8Rational10useListMemE' can not be used when making a shared object; recompile with -fPIC
/usr/bin/ld: /home/jplabbe/sage/local/lib/libsoplex.a(spxdefines.cpp.o): relocation R_X86_64_TPOFF32 against symbol `_ZN6soplex5Param9s_epsilonE' can not be used when making a shared object; recompile with -fPIC
/usr/bin/ld: final link failed: Nonrepresentable section on output
collect2: error: ld returned 1 exit status
```



---

Comment by git created at 2018-04-07 21:15:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2018-04-08 15:32:22

Now the compilation finishes without errors. Testing with `--optional=polymake`, I get:


```
----------------------------------------------------------------------
sage -t backend_polymake.py  # 53 doctests failed
sage -t base.py  # 13 doctests failed
----------------------------------------------------------------------
```


The first is:


```
sage: p = Polyhedron(vertices=[(0,0),(1,0),(0,1)], rays=[(1,1)],lines=[], backend='polymake')
```


for which I get:


```
Traceback (most recent call last):
...
TypeError: Can't locate File/Slurp.pm in `@`INC (you may need to install the File::Slurp module) (`@`INC contains: CODE(0x562008f51e88) /home/jplabbe/sage/local/share/polymake/perllib /home/jplabbe/sage/local/lib/polymake/perlx/5.24.1/x86_64-linux-gnu-thread-multi /home/jplabbe/sage/local/lib/polymake/perlx/5.24.1 /home/jplabbe/sage/local/lib/polymake/perlx /home/jplabbe/sage/local/lib/perl5/x86_64-linux-gnu-thread-multi /home/jplabbe/sage/local/lib/perl5 /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.24.1 /usr/local/share/perl/5.24.1 /usr/lib/x86_64-linux-gnu/perl5/5.24 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.24 /usr/share/perl/5.24 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base)
BEGIN failed--compilation aborted
```


Another type of error seems to be that not putting `()` at the end of a CAPITALIZEDPOLYMAKEMETHOD returns a function and not the result anymore.


---

Comment by mkoeppe created at 2018-04-08 16:12:10

For the error with Slurp, merge #24152 (needs review) and then re-read the polymake SPKG.txt regarding the Perl libraries that need to be installed.


---

Comment by mkoeppe created at 2018-04-08 16:13:55

Replying to [comment:22 jipilab]:
> Another type of error seems to be that not putting `()` at the end of a CAPITALIZEDPOLYMAKEMETHOD returns a function and not the result anymore.
Yes, that's exactly what I meant when I wrote "break[s] the whole polymake interface".


---

Comment by jipilab created at 2018-04-08 17:58:20

Replying to [comment:24 mkoeppe]:
> Replying to [comment:22 jipilab]:
> > Another type of error seems to be that not putting `()` at the end of a CAPITALIZEDPOLYMAKEMETHOD returns a function and not the result anymore.
> Yes, that's exactly what I meant when I wrote "break[s] the whole polymake interface".

I wanted to emphaSIZE the problem! ;)


---

Comment by jipilab created at 2018-04-08 18:05:44

Merged the dependency to #24152.
----
New commits:


---

Comment by mkoeppe created at 2018-04-08 20:11:50

Changing keywords from "" to "IMA-PolyGeom".


---

Comment by mkoeppe created at 2018-09-01 07:47:12

3.2r3 is out


---

Comment by jipilab created at 2018-09-01 08:15:51

Ok, good to know. At the beginning of October, I have a week where I'll try this once more.

Further, I had a comment recently that one might want to add a link to the backend `polymake` in the documentation page for the interface (because the interface is not the only way to use polymake in sage...).


---

Comment by git created at 2018-09-21 18:24:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-01-03 18:34:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-01-03 18:36:52

It seems that the commit 791f766 merged the develop branch into the upgrade polymake branch?

We then get all the diffs from the develop branch on this ticket... I would revert back to a previous commit if no changes were done at the same time as this merge... Let's see how it goes with this update on top of the last beta.

Now version 3.2.r4 is out as well and I updated the description of the ticket.

Polymake days are January 24-26 2019, I will ask them if a stable release is to be expected soon...


---

Comment by jipilab created at 2019-01-03 18:39:34

I accidently erased the patch to compile with gcc7 form a previous ticket... I do not have gcc7 on my computer... But I guess it would be good to check it again anyways on this new release...


---

Comment by jipilab created at 2019-01-04 12:36:01

I am looking at the broken polymake interface. I noticed a few things:

 - Quotes do not work the same way as before:


```
    sage: polymake("'ok'")                              # optional - polymake
    'ok'
```


   So we need to handle this differently when calling member functions.

 - I get a compilation error directly while asking for the Type of a polytope:


```
polytope > $c = cube(3);
polytope > $t = typeof $c;
polymake:  ERROR: Compilation error
```


This breaks pretty much everything, as the object is not able to catch its type and get the proper names for functions, and lots of other things...


---

Comment by jipilab created at 2019-01-05 12:18:45

New commits:


---

Comment by jipilab created at 2019-01-05 12:24:55

The previous commits fix the polymake interface, see https://forum.polymake.org/viewtopic.php?f=8&t=1675 for a discussion of the issue.

In short, the command

```
$t = typeof $c;
```


Stopped working (as in the tutorials mentionned in the discussion) and we should use:


```
$t = $c -> type;
```


This seems to have fixed the problems.

There is still a spurious failing test in the interface which is an appearing blankline. I ignore it for now...

Next, I'll check the polymake backend for polyhedron. There seems to be around 4 failing doctests. That's much better than the 100s... there was.


---

Comment by jipilab created at 2019-01-05 12:26:09

Replying to [comment:34 jipilab]:
> I am looking at the broken polymake interface. I noticed a few things:
> 
>  - Quotes do not work the same way as before:
> 
> {{{
>     sage: polymake("'ok'")                              # optional - polymake
>     'ok'
> }}}

This was simply because of the failing evaluation when setting variables. It seems fine now.


---

Comment by jipilab created at 2019-01-05 12:39:30

On the release page of polymake 3.2 https://polymake.org/doku.php/news/release_3_2

one can read under "polytope":

 - zero vectors in input properties throw an exception

This breaks a few of our tests.


---

Comment by jipilab created at 2019-01-05 12:45:31

Replying to [comment:38 jipilab]:
> On the release page of polymake 3.2 https://polymake.org/doku.php/news/release_3_2
> 
> one can read under "polytope":
> 
>  - zero vectors in input properties throw an exception
> 
> This breaks a few of our tests.

The question is now: how to get the full space as a polyhedron is polymake?


---

Comment by git created at 2019-01-05 13:15:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-01-05 13:16:43

It seems that the tests now pass.

Ready for review!


---

Comment by jipilab created at 2019-01-05 13:16:43

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-03-01 10:26:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-03-11 13:20:34

I'm getting the following error:

```
Running doctests with ID 2019-03-11-14-11-33-0ac43552.
Git branch: public/upgrade_polymake_to_version_3_2r4
Using --optional=4ti2,bliss,cmake,dochtml,gmpy2,latte_int,lidia,lrslib,memlimit,mpir,ninja_build,normaliz,polymake,pynormaliz,python2,qhull,sage,topcom
Doctesting 1 file.
sage -t --long --warn-long 41.5 src/sage/interfaces/polymake.py
**********************************************************************
File "src/sage/interfaces/polymake.py", line 1735, in sage.interfaces.polymake.PolymakeElement.get_member_function
Failed example:
    c.get_member_function("foo")()                        # optional - polymake
Expected:
    Traceback (most recent call last):
    ...
    TypeError: Can't locate object method "foo" via package "Polymake::polytope::Polytope__Rational" at input line 1.
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.PolymakeElement.get_member_function[6]>", line 1, in <module>
        c.get_member_function("foo")()                        # optional - polymake
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 2114, in __call__
        return self._obj._check_valid().function_call(self._name, list(args), kwds)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 284, in function_call
        return self(s)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 288, in __call__
        return cls(self, x, name=name)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1442, in __init__
        raise_(TypeError, TypeError(*x.args), sys.exc_info()[2])
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1437, in __init__
        self._name = parent._create(value, name=name)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 628, in _create
        self.set(name, value)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 717, in set
        self.eval(cmd)
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1351, in eval
        for L in code.split('\n') if L != ''])
      File "/srv/public/kliem/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 1068, in _eval_line
        raise PolymakeError(e)
    TypeError: Can't locate object method "foo" via package "Polymake::polytope::Polytope__Rational"
```


Also, I had to install perl yet with

```
cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
```

yet. With polymake 3.1 in sage, there was not need of that.


---

Comment by git created at 2019-03-13 09:17:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-03-13 09:23:37

Replying to [comment:44 gh-kliem]:

The failing doctest should be fixed now.

> 
> Also, I had to install perl yet with
> {{{
> cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
> }}}
> yet. With polymake 3.1 in sage, there was not need of that.

Could you be more specific about this? Could you say in which order you did this and if we have to add this to the installation instruction?


---

Comment by @kliem created at 2019-03-13 09:29:19

I had polymake installed via `./sage -i polymake` before.
This didn't require any extra installations.

I went through the instructions of this ticket and ignored
`./sage -info polymake`.
This failed. Following the instructions and executing

```
cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
```

beforehand worked fine.

To me it looks like `./sage -i polymake` worked somehow out of the box before and now it doesn't anymore.

Replying to [comment:46 jipilab]:
> Replying to [comment:44 gh-kliem]:
> 
> The failing doctest should be fixed now.
> 
> > 
> > Also, I had to install perl yet with
> > {{{
> > cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
> > }}}
> > yet. With polymake 3.1 in sage, there was not need of that.
> 
> Could you be more specific about this? Could you say in which order you did this and if we have to add this to the installation instruction?


---

Comment by @kliem created at 2019-03-13 10:43:24

Btw, also polymake is not auto-detected when running doctests.

So `./sage -t --all --long` will not use polymake unless specified.

I don't know, if this is a problem specific to my installation or not.


---

Comment by @kliem created at 2019-03-13 11:16:14

Almost everything passed now. This is the only thing remaining on my machine:


```
File "src/sage/interfaces/polymake.py", line 823, in sage.interfaces.polymake.Polymake._eval_line
Failed example:
    p.N_LATTICE_POINTS                # optional - polymake
Expected:
    used package latte
      LattE (Lattice point Enumeration) is a computer software dedicated to the
      problems of counting lattice points and integration inside convex polytopes.
      Copyright by Matthias Koeppe, Jesus A. De Loera and others.
      http://www.math.ucdavis.edu/~latte/
    27
Got:
    27
```



---

Comment by jipilab created at 2019-03-13 13:54:40

Replying to [comment:47 gh-kliem]:
> I had polymake installed via `./sage -i polymake` before.
> This didn't require any extra installations.
> 
> I went through the instructions of this ticket and ignored
> `./sage -info polymake`.
> This failed. Following the instructions and executing
> {{{
> cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
> }}}
> beforehand worked fine.
> 
> To me it looks like `./sage -i polymake` worked somehow out of the box before and now it doesn't anymore.

Have a look at the commit to see what changed. When we update a package, we change the source and the place to download the package. Since the package is not yet on the sage mirror, this is why you download it and put it in the appropriate folder by hand.

After doing so, as long as you are on this branch, installing polymake will install the newest version (the one written with this new ticket). If you go back to a different ticket, you have to (re-)install polymake the usual way. And it should work. But well, polymake installation used to not work before, so there's no discussion to have on this aspect. We should focus on the present installation.

Again, can you state clearly what you did step-by-step and say if each step worked or not. It is difficult to follow from what you write about what worked and what did not work.


---

Comment by jipilab created at 2019-03-13 13:56:06

Replying to [comment:48 gh-kliem]:
> Btw, also polymake is not auto-detected when running doctests.
> 
> So `./sage -t --all --long` will not use polymake unless specified.
> 
> I don't know, if this is a problem specific to my installation or not.

Polymake is an experimental package, so it is not included in the default testing. Perhaps there is a way to include all experimental package. But this is a recipe for disaster anyway. So just add it by hand each time you test. That's the cheapest solution.


---

Comment by jipilab created at 2019-03-13 13:57:19

Replying to [comment:49 gh-kliem]:
> Almost everything passed now. This is the only thing remaining on my machine:
> 
> {{{
> File "src/sage/interfaces/polymake.py", line 823, in sage.interfaces.polymake.Polymake._eval_line
> Failed example:
>     p.N_LATTICE_POINTS                # optional - polymake
> Expected:
>     used package latte
>       LattE (Lattice point Enumeration) is a computer software dedicated to the
>       problems of counting lattice points and integration inside convex polytopes.
>       Copyright by Matthias Koeppe, Jesus A. De Loera and others.
>       http://www.math.ucdavis.edu/~latte/
>     27
> Got:
>     27
> }}}

Okay, this is annoying, as I do not get this error in my case. It seems that they randomly throw out such transparency statements about libraries it uses. Okay. Thanks for pointing this out.


---

Comment by @kliem created at 2019-03-13 14:56:29

Ok, let's try again.

In my current Sage installation I had polymake 3.1 installed. When installing it, this worked out of the box. So a simply run of `./sage -i polymake` and I had polymake 3.3. No prereqs.

When testing this ticket, I checked out this branch and pulled and did everything as instructed, but ignored
`./sage -info polymake`. This did not work (yes I didn't follow the instructions completely).

When I paid attention to `./sage -info polymake` and installed the perl thing, it worked fine.

If somehow possible, it would be nice to have `./sage -i polymake` work without any prereqs again.
But I have no idea whats going on and whether this depends on my specific computer or not.

I just wanted to point out, that the update to polymake 3.2 has a prequirement that wasn't there before. You are probably aware of this, I just wanted to mention it.

Replying to [comment:50 jipilab]:
> Replying to [comment:47 gh-kliem]:
> > I had polymake installed via `./sage -i polymake` before.
> > This didn't require any extra installations.
> > 
> > I went through the instructions of this ticket and ignored
> > `./sage -info polymake`.
> > This failed. Following the instructions and executing
> > {{{
> > cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
> > }}}
> > beforehand worked fine.
> > 
> > To me it looks like `./sage -i polymake` worked somehow out of the box before and now it doesn't anymore.
> 
> Have a look at the commit to see what changed. When we update a package, we change the source and the place to download the package. Since the package is not yet on the sage mirror, this is why you download it and put it in the appropriate folder by hand.
> 
> After doing so, as long as you are on this branch, installing polymake will install the newest version (the one written with this new ticket). If you go back to a different ticket, you have to (re-)install polymake the usual way. And it should work. But well, polymake installation used to not work before, so there's no discussion to have on this aspect. We should focus on the present installation.
> 
> Again, can you state clearly what you did step-by-step and say if each step worked or not. It is difficult to follow from what you write about what worked and what did not work.


---

Comment by slabbe created at 2019-03-13 15:02:23

On Ubuntu 16.04 with sage 8.7.beta7, after installing the dependencies, the command

```
sage -t --optional=sage,optional,experimental,external,polymake src/sage/interfaces/polymake.py
```


gives:


```
Using --optional=4ti2,bliss,cbc,ccache,cmake,cryptominisat,dot2tex,experimental,external,glucose,latte_int,lidia,lrslib,memlimit,mpir,ninja_build,normaliz,notedown,pandoc_attributes,polymake,pycosat,pynormaliz,python2,qhull,rst2ipynb,sage,topcom
External software to be detected: cplex,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,scilab
Doctesting 1 file.
sage -t src/sage/interfaces/polymake.py
    [245 tests, 8.19 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 11.7 seconds
    cpu time: 1.8 seconds
    cumulative wall time: 8.2 seconds
External software detected for doctesting: 
```



---

Comment by @kliem created at 2019-03-13 15:06:52

Just to mention this.

I am using cofio: https://patchbot.sagemath.org/ticket/?machine=debian&machine=9.6&machine=x86_64&machine=4.9.0-8-amd64&machine=cofio&status=open

Not with the Sage same install, but I don't think it matters.

Replying to [comment:52 jipilab]:
> Replying to [comment:49 gh-kliem]:
> > Almost everything passed now. This is the only thing remaining on my machine:
> > 
> > {{{
> > File "src/sage/interfaces/polymake.py", line 823, in sage.interfaces.polymake.Polymake._eval_line
> > Failed example:
> >     p.N_LATTICE_POINTS                # optional - polymake
> > Expected:
> >     used package latte
> >       LattE (Lattice point Enumeration) is a computer software dedicated to the
> >       problems of counting lattice points and integration inside convex polytopes.
> >       Copyright by Matthias Koeppe, Jesus A. De Loera and others.
> >       http://www.math.ucdavis.edu/~latte/
> >     27
> > Got:
> >     27
> > }}}
> 
> Okay, this is annoying, as I do not get this error in my case. It seems that they randomly throw out such transparency statements about libraries it uses. Okay. Thanks for pointing this out.


---

Comment by jipilab created at 2019-03-13 15:11:27

Replying to [comment:53 gh-kliem]:
> Ok, let's try again.
> 
> In my current Sage installation I had polymake 3.1 installed. When installing it, this worked out of the box. So a simply run of `./sage -i polymake` and I had polymake 3.3. No prereqs.
> 
> When testing this ticket, I checked out this branch and pulled and did everything as instructed, but ignored
> `./sage -info polymake`. This did not work (yes I didn't follow the instructions completely).
> 
> When I paid attention to `./sage -info polymake` and installed the perl thing, it worked fine.
> 
> If somehow possible, it would be nice to have `./sage -i polymake` work without any prereqs again.
> But I have no idea whats going on and whether this depends on my specific computer or not.
> 
> I just wanted to point out, that the update to polymake 3.2 has a prequirement that wasn't there before. You are probably aware of this, I just wanted to mention it.
> 

Okay, thanks for the clarification. I do not know if there is a way to fix this through the installation of polymake. Since there is no section Debian in the installation instruction coming from  `sage -info polymake` which one did you execute? The ubuntu ones? None?


---

Comment by jipilab created at 2019-03-13 15:19:29

> > > {{{
> > > File "src/sage/interfaces/polymake.py", line 823, in sage.interfaces.polymake.Polymake._eval_line
> > > Failed example:
> > >     p.N_LATTICE_POINTS                # optional - polymake
> > > Expected:
> > >     used package latte
> > >       LattE (Lattice point Enumeration) is a computer software dedicated to the
> > >       problems of counting lattice points and integration inside convex polytopes.
> > >       Copyright by Matthias Koeppe, Jesus A. De Loera and others.
> > >       http://www.math.ucdavis.edu/~latte/
> > >     27
> > > Got:
> > >     27
> > > }}}

Typing in the terminal I get:


```
$ sage -experimental
[package]...............................[latest version] ([version])
perl_term_readline_gnu..................1.35 (1.35)
polymake................................3.2r4 (3.2r4)
```


I do get the verbose out from using `polymake3.2r4`. And all tests passed on an fresh install on a Ubuntu machine. Could you make sure that you used the latest `polymake`? Somehow it seems really odd to me and I can't figure out why it does not show the verbose in your case.


---

Comment by @kliem created at 2019-03-13 15:21:48


```
./sage -info polymake

...

A distribution-independent way to install Perl modules (into a user's
home directory) is using CPAN.

 cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp
```


This did the job. I also did 
`sage -i 4ti2 latte_int topcom qhull` then, but this has most likely nothing to do with the issue.


Replying to [comment:56 jipilab]:
> Replying to [comment:53 gh-kliem]:
> > Ok, let's try again.
> > 
> > In my current Sage installation I had polymake 3.1 installed. When installing it, this worked out of the box. So a simply run of `./sage -i polymake` and I had polymake 3.3. No prereqs.
> > 
> > When testing this ticket, I checked out this branch and pulled and did everything as instructed, but ignored
> > `./sage -info polymake`. This did not work (yes I didn't follow the instructions completely).
> > 
> > When I paid attention to `./sage -info polymake` and installed the perl thing, it worked fine.
> > 
> > If somehow possible, it would be nice to have `./sage -i polymake` work without any prereqs again.
> > But I have no idea whats going on and whether this depends on my specific computer or not.
> > 
> > I just wanted to point out, that the update to polymake 3.2 has a prequirement that wasn't there before. You are probably aware of this, I just wanted to mention it.
> > 
> 
> Okay, thanks for the clarification. I do not know if there is a way to fix this through the installation of polymake. Since there is no section Debian in the installation instruction coming from  `sage -info polymake` which one did you execute? The ubuntu ones? None?


---

Comment by @kliem created at 2019-03-13 15:24:39


```
kliem`@`cofio:~/localhome/sage$ sage -experimental
[package]...............................[latest version] ([version])

autotools...............................20141105.p0 (not_installed)
cocoalib................................0.99564 (not_installed)
compilerwrapper.........................1.2 (not_installed)
gap3....................................04jul17 (not_installed)
libtheora...............................1.1.1 (not_installed)
lie.....................................2.2.2 (not_installed)
modular_decomposition...................20100607 (not_installed)
perl_term_readline_gnu..................1.35 (1.35)
polymake................................3.2r4 (3.2r4)
qepcad..................................B.1.71 (not_installed)
scipoptsuite............................5.0.1 (not_installed)
surf....................................1.0.6-gcc6 (not_installed)
valgrind................................3.10.0 (not_installed)
```


Replying to [comment:57 jipilab]:
> 
> > > > {{{
> > > > File "src/sage/interfaces/polymake.py", line 823, in sage.interfaces.polymake.Polymake._eval_line
> > > > Failed example:
> > > >     p.N_LATTICE_POINTS                # optional - polymake
> > > > Expected:
> > > >     used package latte
> > > >       LattE (Lattice point Enumeration) is a computer software dedicated to the
> > > >       problems of counting lattice points and integration inside convex polytopes.
> > > >       Copyright by Matthias Koeppe, Jesus A. De Loera and others.
> > > >       http://www.math.ucdavis.edu/~latte/
> > > >     27
> > > > Got:
> > > >     27
> > > > }}}
> 
> Typing in the terminal I get:
> 
> {{{
> $ sage -experimental
> [package]...............................[latest version] ([version])
> perl_term_readline_gnu..................1.35 (1.35)
> polymake................................3.2r4 (3.2r4)
> }}}
> 
> I do get the verbose out from using `polymake3.2r4`. And all tests passed on an fresh install on a Ubuntu machine. Could you make sure that you used the latest `polymake`? Somehow it seems really odd to me and I can't figure out why it does not show the verbose in your case.


---

Comment by git created at 2019-03-13 15:40:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-13 15:49:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-03-13 15:52:06

Achhhh...

libjson-perl is now a requirement since version 3.3:

https://polymake.org/doku.php/news/release_3_3

I added it to the Ubuntu requirements, I will check how to install this on other platforms...


---

Comment by git created at 2019-03-14 10:02:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-03-14 10:11:21

Changing keywords from "IMA-PolyGeom" to "IMA-PolyGeom, thursdaysbdx".


---

Comment by git created at 2019-03-14 10:31:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jipilab created at 2019-03-14 10:34:00

It seems that polymake 3.3 does not compile out of the box on my stable Debian distribution...

I feel like version 3.3 should be a separate ticket and have a compiling, and working version of polymake as an experimental package. It is better than having the very latest release which fails to compile. Once this ticket is merged, I might invest time again to figure out what goes wrong in the compilation.


---

Comment by jipilab created at 2019-03-14 10:35:19

`@`MKoeppe: could you eventually check that the above works on OSX machine?

Best,


---

Comment by vklein created at 2019-03-14 16:19:29

This ticket with polymake 3.3 (before last push) compile on ubuntu 16.04.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-16 12:19:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment

log of a failed compilation.


---

Comment by selia created at 2019-04-17 09:06:11

I tried to compile on macOS Mojave and it failed. I attached my log file.


---

Comment by jipilab created at 2019-04-17 13:06:39

Replying to [comment:76 selia]:
> I tried to compile on macOS Mojave and it failed. I attached my log file.

The failure was reported on the polymake forum here:

https://forum.polymake.org/viewtopic.php?f=8&t=1702


---

Comment by slelievre created at 2019-04-19 14:03:06

Replying to [comment:77 jipilab]:
> Replying to [comment:76 selia]:
> > I tried to compile on macOS Mojave and it failed. I attached my log file.
> 
> The failure was reported on the polymake forum here:
> 
> https://forum.polymake.org/viewtopic.php?f=8&t=1702

Upstream say this is fixed in Polymake 3.4, released 2019-04-15.

Should we upgrade to Polymake 3.4 instead of 3.2 in this ticket?


---

Comment by vdelecroix created at 2019-04-19 14:04:15

Replying to [comment:78 slelievre]:
> Replying to [comment:77 jipilab]:
> > Replying to [comment:76 selia]:
> > > I tried to compile on macOS Mojave and it failed. I attached my log file.
> > 
> > The failure was reported on the polymake forum here:
> > 
> > https://forum.polymake.org/viewtopic.php?f=8&t=1702
> 
> Upstream say this is fixed in Polymake 3.4, released 2019-04-15.
> 
> Should we upgrade to Polymake 3.4 instead of 3.2 in this ticket?

+1. It makes no sense to upgrade to 3.2 before 3.4.


---

Comment by jipilab created at 2019-04-21 13:51:57

Replying to [comment:79 vdelecroix]:
> Replying to [comment:78 slelievre]:
> > Replying to [comment:77 jipilab]:
> > > Replying to [comment:76 selia]:
> > > > I tried to compile on macOS Mojave and it failed. I attached my log file.
> > > 
> > > The failure was reported on the polymake forum here:
> > > 
> > > https://forum.polymake.org/viewtopic.php?f=8&t=1702
> > 
> > Upstream say this is fixed in Polymake 3.4, released 2019-04-15.
> > 
> > Should we upgrade to Polymake 3.4 instead of 3.2 in this ticket?
> 
> +1. It makes no sense to upgrade to 3.2 before 3.4.

Agreed. Although the version 3.3 did not compile on debian stretch and this is why I thought that having 3.2rc4 working could have fixed the backend quickly. Since I do not know how long it will take to make the version 3.4 work, I thought it is better to do things one step at a time.

The whole interface was broken and at least now it works on debian and they proposed a fix.

Anyhow, yes, we can just skip to 3.4, let's just hope it is not a quantum leap...


---

Comment by git created at 2019-04-24 09:28:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-24 10:23:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-24 11:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-24 11:41:00

Upgrading to 3.4 now. Builds OK on Mac OS Mojave (see updated instructions for prerequisites!)

Many test failures from 
`./sage -t --optional=sage,polymake src/sage/interfaces/polymake.py `


---

Comment by mkoeppe created at 2019-04-24 11:41:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-04-24 13:30:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-24 13:33:38

Works now (on macOS Mojave). Please test on other platforms.

The following gives sporadic errors (can happen during doctest too):

```
sage: polymake.eval('help "TRIANGULATION";')
---------------------------------------------------------------------------
OSError                                   Traceback (most recent call last)
<ipython-input-14-18a26ee8f157> in <module>()
----> 1 polymake.eval('help "TRIANGULATION";')

/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1349                 elif split_lines:
   1350                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1351                                         for L in code.split('\n') if L != ''])
   1352                 else:
   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed, **kwds)
   1020                         i = pat
   1021                         while i:
-> 1022                             self._expect.send(chr(3))
   1023                             sleep(0.1)
   1024                             i = self._expect.expect(self._prompt, timeout=0.1)

/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python2.7/site-packages/pexpect/pty_spawn.pyc in send(self, s)
    566 
    567         b = self._encoder.encode(s, final=False)
--> 568         return os.write(self.child_fd, b)
    569 
    570     def sendline(self, s=''):

OSError: [Errno 5] Input/output error
```



---

Comment by mkoeppe created at 2019-04-24 13:33:54

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2019-04-24 21:56:10

Replying to [comment:86 mkoeppe]:
> Works now (on macOS Mojave). Please test on other platforms.
> 
> The following gives sporadic errors (can happen during doctest too):
> {{{
> sage: polymake.eval('help "TRIANGULATION";')
> ---------------------------------------------------------------------------
> OSError                                   Traceback (most recent call last)
> <ipython-input-14-18a26ee8f157> in <module>()
> ----> 1 polymake.eval('help "TRIANGULATION";')
> 
> /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
>    1349                 elif split_lines:
>    1350                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
> -> 1351                                         for L in code.split('\n') if L != ''])
>    1352                 else:
>    1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)
> 
> /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed, **kwds)
>    1020                         i = pat
>    1021                         while i:
> -> 1022                             self._expect.send(chr(3))
>    1023                             sleep(0.1)
>    1024                             i = self._expect.expect(self._prompt, timeout=0.1)
> 
> /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python2.7/site-packages/pexpect/pty_spawn.pyc in send(self, s)
>     566 
>     567         b = self._encoder.encode(s, final=False)
> --> 568         return os.write(self.child_fd, b)
>     569 
>     570     def sendline(self, s=''):
> 
> OSError: [Errno 5] Input/output error
> }}}

Is there a way to control/predict this kind of behavior? It would be annoying to have such errors in the doctests.

Since it is an experimental package, this could be tolerable, but it would be good to grasp how this occurs...

I will this new branch.


---

Comment by jipilab created at 2019-04-25 06:09:27

Compilation works on debian.

I get the following errors in the interface:


```
sage -t polymake.py
**********************************************************************
File "polymake.py", line 884, in sage.interfaces.polymake.Polymake._eval_line
Failed example:
    c                                 # optional - polymake
Expected:
    cube of dimension 15
Got:
    <repr(<sage.interfaces.polymake.PolymakeElement at 0x7fe892d55cd0>) failed: PolymakeError: Can't locate object method "description" via package "1" (perhaps you forgot to load "1"?)>
**********************************************************************
File "polymake.py", line 886, in sage.interfaces.polymake.Polymake._eval_line
Failed example:
    c.N_VERTICES                      # optional - polymake
Expected:
    32768
Got:
    Member function 'N_VERTICES' of print ref(`@`SAGE590);
    1 object
**********************************************************************
File "polymake.py", line 1133, in sage.interfaces.polymake.Polymake.application
Failed example:
    q.VERY_AMPLE                  # optional - polymake
Exception raised:
    Traceback (most recent call last):
      File "/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake.application[3]>", line 1, in <module>
        q.VERY_AMPLE                  # optional - polymake
      File "/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 1680, in __getattr__
        raise AttributeError
    AttributeError
**********************************************************************
```


All tests pass on the `backend_polymake.py`.

Will investigate.


---

Comment by jipilab created at 2019-04-25 12:07:55

I lauched the test with:

```
sage -t src/sage/interfaces/polymake.py --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,pynormaliz,python2,sage,topcom,polymake
```


Here is a longer trace about the last doctest failure:


```
sage: q = polymake.new_object("Polytope", INEQUALITIES=[[5,-4,0,1],[-3,0,-4,1],[-2,1,0,0],[-4,4,4,-1],[0,0,1,0],[8,0,0,-1],[1,0,-1,0],[3,-1,0,0]])
sage: q.H_VECTOR
1 5 5 1
sage: q.F_VECTOR
8 14 8
sage: q.VERY_AMPLE
/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py:1064: RuntimeWarning: could not compute 'HILBERT_BASIS_GENERATORS' probably because of unsatisfied preconditions:
precondition : POINTED ( HILBERT_BASIS_GENERATORS , N_HILBERT_BASIS : )
  warnings.warn(w, RuntimeWarning)
/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py:1064: RuntimeWarning: rule VERY_AMPLE : GRAPH.ADJACENCY, GRAPH.EDGE_DIRECTIONS, N_VERTICES, VERTICES, FACETS | INEQUALITIES failed: Can't use an undefined value as an ARRAY reference at /home/jplabbe/sage/local/share/polymake/apps/polytope/rules/lattice.rules line 603.
  warnings.warn(w, RuntimeWarning)
/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.py:1064: RuntimeWarning: rule HILBERT_BASIS_GENERATORS , N_HILBERT_BASIS : failed: 
*** Missing external software:
*** To compute Hilbert bases you need to have one of the following:
***    - bundled:libnormaliz enabled (requires boost, rerun configure)
***    - 4ti2 installed and configured (check 'show_unconfigured;')
  warnings.warn(w, RuntimeWarning)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-7-1f21cb7f3e00> in <module>()
----> 1 q.VERY_AMPLE

/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in __getattr__(self, attrname)
   1678                     return P('{}->{}'.format(self._name, attrname))
   1679                 except (TypeError, PolymakeError):
-> 1680                     raise AttributeError
   1681             else:
   1682                 return P._function_element_class()(self, '{}->{}'.format(self._name, attrname), memberfunction=True)

AttributeError: 
```



---

Comment by jipilab created at 2019-04-25 12:26:33

Here's the log of the configuration of polymake:


```
gcc version 6.3.0 20170516 (Debian 6.3.0-18+deb9u1) 
[polymake-3.4] ****************************************************
[polymake-3.4] Package 'polymake' is currently not installed
[polymake-3.4] No legacy uninstaller found for 'polymake'; nothing to do
[polymake-3.4] checking C++ compiler ... ok (g++ -std=gnu++11 is GCC 6.3.0)
[polymake-3.4] checking C++ library ... ok (GNU libstdc++ 20170516, C++ 201402)
[polymake-3.4] determining architecture ... ok (x86_64)
[polymake-3.4] determining compiler flags ... ok
[polymake-3.4]    CFLAGS= -march=native
[polymake-3.4]    CXXFLAGS= -std=c++14 -march=native -ftemplate-depth-200 -fno-strict-aliasing -Wno-parentheses -Wshadow -fopenmp -Wno-error=unused-function -Wno-maybe-uninitialized
[polymake-3.4]    LDFLAGS=-L/home/jplabbe/sage/local/lib -Wl,-rpath,/home/jplabbe/sage/local/lib  -fuse-ld=gold -fopenmp
[polymake-3.4] checking gmp installation ... ok
[polymake-3.4] checking mpfr installation ... ok
[polymake-3.4] checking boost installation ... ok
[polymake-3.4] checking libxml2 installation ... ok
[polymake-3.4] checking perl module XML::Writer ... ok
[polymake-3.4] checking perl module XML::LibXML ... ok
[polymake-3.4] checking perl module XML::LibXSLT ... ok
[polymake-3.4] checking perl module Term::ReadKey ... ok
[polymake-3.4] checking perl module Term::ReadLine ... ok
[polymake-3.4] checking perl module JSON ... ok
[polymake-3.4] checking shared perl library ... ok
[polymake-3.4] 
[polymake-3.4] Configuring bundled extensions:
[polymake-3.4] bundled extension java ... disabled by command-line
[polymake-3.4] bundled extension javaview ... disabled by command-line
[polymake-3.4] bundled extension soplex ... disabled by command-line
[polymake-3.4] bundled extension atint ... ok
[polymake-3.4] bundled extension bliss ... ok
[polymake-3.4] bundled extension cdd ... ok (0.94g `@` system)
[polymake-3.4] bundled extension libnormaliz ... failed
[polymake-3.4] bundled extension lrs ... ok (6.2 `@` system)
[polymake-3.4] bundled extension nauty ... disabled because of conflict with other extension: bliss
[polymake-3.4] bundled extension ppl ... ok (1.2.0 `@` /home/jplabbe/sage/local)
[polymake-3.4] bundled extension scip ... failed
[polymake-3.4] bundled extension singular ... ok (4.1.1 `@` system)
[polymake-3.4] bundled extension sympol ... ok (bundled)
[polymake-3.4] * If you want to change the configuration of bundled extensions please see build/bundled.log and try configure --help.
```



---

Comment by git created at 2019-04-25 14:02:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-04-25 14:26:38

Compiled fine on debian stretch and all relevant tests pass:


```
$ sage -t /sage/src/sage/interfaces/polymake.py --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,pynormaliz,python2,sage,topcom,polymake
Using --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,polymake,pynormaliz,python2,sage,topcom
Doctesting 1 file.
sage -t polymake.py
    [245 tests, 14.65 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


and


```
$ sage -t sage/src/sage/geometry/polyhedron/*.py --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,pynormaliz,python2,sage,topcom,polymake
too few successful tests, not using stored timings
Using --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,polymake,pynormaliz,python2,sage,topcom
Doctesting 25 files.
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2019-04-26 08:06:21

polymake patch sent upstream.


---

Comment by @LaisRast created at 2019-04-26 21:24:18

It compiled on Debian GNU/Linux 9.8 (stretch) x86_64. All relevant tests pass:

```
$ ./sage -t src/sage/interfaces/polymake.py --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,pynormaliz,python2,sage,topcom,polymake
```



```
too few successful tests, not using stored timings
Running doctests with ID 2019-04-26-23-04-17-71ea1904.
Git branch: polymake
Using --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,polymake,pynormaliz,python2,sage,topcom
Doctesting 1 file.
sage -t src/sage/interfaces/polymake.py
    [245 tests, 6.94 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 11.6 seconds
    cpu time: 1.4 seconds
    cumulative wall time: 6.9 seconds
```



```
$ ./sage -t src/sage/geometry/polyhedron/*.py --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,python2,sage,topcom,polymake
```



```
too few successful tests, not using stored timings
Running doctests with ID 2019-04-26-23-12-47-322d8126.
Git branch: polymake
Using --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,polymake,python2,sage,topcom
Doctesting 25 files.
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 65.0 seconds
    cpu time: 43.6 seconds
    cumulative wall time: 64.1 seconds
```



---

Comment by @sophiasage created at 2019-04-27 07:57:02

log of failed compilation. mac os mojave


---

Attachment

See the updated Perl module prerequisites by typing "sage -info polymake".


---

Attachment

sage -t src/sage/interfaces/polymake.py


---

Comment by @LaisRast created at 2019-04-27 10:59:03

It compiled on Arch Linux x86_64 (5.0.9-arch1-1-ARCH). All relevant tests pass except for three.
https://trac.sagemath.org/attachment/ticket/24905/polymake.log


---

Comment by @kliem created at 2019-04-27 11:41:30


```
[polymake-3.4] FAILED: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/bundled/singular/apps/ideal/cpperl/auto-contains_monomial.o                                                                                                    
[polymake-3.4]   g++ -std=gnu++11 -c -o /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/bundled/singular/apps/ideal/cpperl/auto-contains_monomial.o -MMD -MT /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.
4/src/build/Opt/bundled/singular/apps/ideal/cpperl/auto-contains_monomial.o -MF /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/bundled/singular/apps/ideal/cpperl/auto-contains_monomial.o.d -fPIC -pipe -std=c++14 -march=native -ft
emplate-depth-200 -fno-strict-aliasing -Wno-parentheses -Wshadow -fopenmp -Wno-error=unused-function -Wno-maybe-uninitialized  -DPOLYMAKE_DEBUG=0 -DNDEBUG -O3 -DPOLYMAKE_APPNAME=ideal -DPOLYMAKE_BUNDLED_EXT=singular -DSING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -DS
ING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -I/srv/public/kliem/patchbot-sage/sage/local/include -I/srv/public/kliem/patchbot-sage/sage/local/include/singular -I/srv/public/kliem/patchbot-sage/sage/local/include -I/srv/public/kliem/patchbot-sage/sage/local/include/s
ingular -I/srv/public/kliem/patchbot-sage/sage/local/include/ -I/srv/public/kliem/patchbot-sage/sage/local/include -I/srv/public/kliem/patchbot-sage/sage/local/include/ -I/srv/public/kliem/patchbot-sage/sage/local/include -Wno-unused-value -I/srv/public/kliem/patchbot-sa
ge/sage/local/var/tmp/sage/build/polymake-3.4/src/bundled/singular/include/app-wrappers -I/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/bundled/singular/include/apps -I/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake
-3.4/src/include/app-wrappers -I/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/include/apps -I/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/include/external/permlib -I/srv/public/kliem/patchbot-sage/sage/lo
cal/var/tmp/sage/build/polymake-3.4/src/include/external/TOSimplex -I/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/include/core-wrappers -I/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/include/core /srv/pu
blic/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc && : 'COMPILER_USED=6.3.0'
[polymake-3.4] In file included from ../../../../../../../../include/polymake/client.h:25:0,
[polymake-3.4]                  from ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc:6:
[polymake-3.4] ../../../../../../../../include/polymake/perl/calls.h: In constructor 'pm::perl::PropertyValue::PropertyValue(sv*, TOptions ...)':
[polymake-3.4] ../../../../../../../../include/polymake/perl/calls.h:48:7: warning: declaration of 'options' shadows a member of 'pm::perl::PropertyValue' [-Wshadow]
[polymake-3.4]        : Value(sv_arg)
[polymake-3.4]        ^
[polymake-3.4] In file included from ../../../../../../../../include/polymake/client.h:21:0,
[polymake-3.4]                  from ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc:6:
[polymake-3.4] ../../../../../../../../include/polymake/perl/Value.h:633:16: note: shadowed declaration is here
[polymake-3.4]     value_flags options;
[polymake-3.4]                 ^~~~~~~
[polymake-3.4] In file included from ../../../../../../../../include/polymake/next/SparseMatrix.h:24:0,
[polymake-3.4]                  from ../../../../../../../../include/polymake/SparseMatrix.h:20,
[polymake-3.4]                  from ../../../../../../../../include/polymake/PolynomialImpl.h:24,
[polymake-3.4]                  from ../../../../../../../../include/polymake/next/Polynomial.h:21,
[polymake-3.4]                  from ../../../../../../../../include/polymake/Polynomial.h:20,
[polymake-3.4]                  from ../../../../../../../../include/polymake/ideal/next/singularIdeal.h:24,
[polymake-3.4]                  from ../../../../../../../../include/polymake/ideal/singularIdeal.h:20,
[polymake-3.4]                  from ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc:7:
[polymake-3.4] ../../../../../../../../include/polymake/internal/sparse2d.h: In member function 'void pm::sparse2d::sym_permute_entries<Traits>::copy(const typename Traits::ruler*, typename Traits::ruler*, const Perm&, const InvPerm&)':
[polymake-3.4] ../../../../../../../../include/polymake/internal/sparse2d.h:881:4: warning: declaration of 'inv_perm' shadows a member of 'pm::sparse2d::sym_permute_entries<Traits>' [-Wshadow]
[polymake-3.4]     {
[polymake-3.4]     ^
[polymake-3.4] ../../../../../../../../include/polymake/internal/sparse2d.h:906:21: note: shadowed declaration is here
[polymake-3.4]     std::vector<int> inv_perm;
[polymake-3.4]                      ^~~~~~~~
[polymake-3.4] ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc: At global scope:
[polymake-3.4] ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc:10:1: error: 'FunctionCallerStart4perl' does not name a type
[polymake-3.4]  FunctionCallerStart4perl {
[polymake-3.4]  ^~~~~~~~~~~~~~~~~~~~~~~~
[polymake-3.4] ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc:13:20: error: expected constructor, destructor, or type conversion before '(' token
[polymake-3.4]  FunctionCaller4perl(contains_monomial, meth);
[polymake-3.4]                     ^
[polymake-3.4] ../../bundled/singular/apps/ideal/cpperl/generated/auto-contains_monomial.cc:14:30: error: expected constructor, destructor, or type conversion before '(' token
[polymake-3.4]  FunctionTemplateInstance4perl(0, contains_monomial, meth, contains_monomial:M, perl::Returns::normal, 0, (perl::Canned<const SingularIdeal&>));
[polymake-3.4]                               ^
[polymake-3.4] [359/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/lex_min_representative.o
[polymake-3.4] [360/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/orbit_permlib.o
[polymake-3.4] [361/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/permlib_group_tools.o
[polymake-3.4] [362/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/induced_action.o
[polymake-3.4] [363/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/conjugacy_classes.o
[polymake-3.4] [364/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/permlib.o
[polymake-3.4] [365/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/orbit.o
[polymake-3.4] [366/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/sparse_isotypic_components.o
[polymake-3.4] [367/902] COMPILE /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/apps/group/representations.o
[polymake-3.4] ninja: build stopped: subcommand failed.
[polymake-3.4] Makefile:34: recipe for target 'all' failed
[polymake-3.4] make[2]: *** [all] Error 1
[polymake-3.4] make[2]: Leaving directory '/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src'
[polymake-3.4] Error building polymake
[polymake-3.4]
[polymake-3.4] real     7m41.235s
[polymake-3.4] user     57m24.108s
[polymake-3.4] sys      1m28.580s
[polymake-3.4] ************************************************************************
[polymake-3.4] Error installing package polymake-3.4
[polymake-3.4] ************************************************************************
[polymake-3.4] Please email sage-devel (http://groups.google.com/group/sage-devel)
[polymake-3.4] explaining the problem and including the log file
[polymake-3.4]   /srv/public/kliem/patchbot-sage/sage/logs/pkgs/polymake-3.4.log
[polymake-3.4] Describe your computer, operating system, etc.
[polymake-3.4] If you want to try to fix the problem yourself, *don't* just cd to
[polymake-3.4] /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4 and type 'make' or whatever is appropriate.
[polymake-3.4] Instead, the following commands setup all environment variables
[polymake-3.4] correctly and load a subshell for you to debug the error:
[polymake-3.4]   (cd '/srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4' && '/srv/public/kliem/patchbot-sage/sage/sage' --sh)
[polymake-3.4] When you are done debugging, you can type "exit" to leave the subshell.
[polymake-3.4] ************************************************************************
Makefile:2162: recipe for target '/srv/public/kliem/patchbot-sage/sage/local/var/lib/sage/installed/polymake-3.4' failed
make[1]: *** [/srv/public/kliem/patchbot-sage/sage/local/var/lib/sage/installed/polymake-3.4] Error 1
make[1]: Leaving directory '/srv/public/kliem/patchbot-sage/sage/build/make'

real    7m44,443s
user    57m25,204s
sys     1m28,764s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make polymake'):

* package: ecl-16.1.3.p0
  log file: /srv/public/kliem/patchbot-sage/sage/logs/pkgs/ecl-16.1.3.p0.log
  build directory: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/ecl-16.1.3.p0

* package: numpy-1.16.0
  log file: /srv/public/kliem/patchbot-sage/sage/logs/pkgs/numpy-1.16.0.log
  build directory: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/numpy-1.16.0

* package: polymake-3.4
  log file: /srv/public/kliem/patchbot-sage/sage/logs/pkgs/polymake-3.4.log
  build directory: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4

* package: python
  log file: /srv/public/kliem/patchbot-sage/sage/logs/pkgs/python.log
  build directory: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/python

* package: r-3.4.4.p1
  log file: /srv/public/kliem/patchbot-sage/sage/logs/pkgs/r-3.4.4.p1.log
  build directory: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/r-3.4.4.p1

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

Makefile:31: recipe for target 'polymake' failed
make: *** [polymake] Error 1

```



---

Comment by mkoeppe created at 2019-04-27 14:46:46

Replying to [comment:98 gh-kliem]:
> 
> 
> {{{
> [polymake-3.4] FAILED: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/bundled/singular/apps/ideal/cpperl/auto-contains_monomial.o    
> }}}
Which compiler is that? Did Sage install its own gcc?


---

Comment by @kliem created at 2019-04-27 15:33:39

I don't know. I suppose its the systems gcc (Debian 6.3.0-18+deb9u1).

(This is the default gcc in the sage subshell as well.)

Now I did `./sage -i gcc` and will see if that makes any difference.

It does 
Replying to [comment:99 mkoeppe]:
> Replying to [comment:98 gh-kliem]:
> > 
> > 
> > {{{
> > [polymake-3.4] FAILED: /srv/public/kliem/patchbot-sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/Opt/bundled/singular/apps/ideal/cpperl/auto-contains_monomial.o    
> > }}}
> Which compiler is that? Did Sage install its own gcc?


---

Comment by git created at 2019-04-27 15:55:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-27 16:20:30

Replying to [comment:100 gh-kliem]:
> I don't know. I suppose its the systems gcc (Debian 6.3.0-18+deb9u1).
> 
> (This is the default gcc in the sage subshell as well.)
> 
> Now I did `./sage -i gcc` and will see if that makes any difference.
> 
> It does 

It may also be worth checking whether polymake builds OK from its source package with your system's gcc.


---

Comment by mkoeppe created at 2019-04-27 16:20:45

(outside of sage.)


---

Comment by @kliem created at 2019-04-27 17:59:23

polymake 3.3 worked fine. I didn't check with polymake 3.4.


---

Comment by @kliem created at 2019-04-27 20:44:12

Now my sage is messed up.

Those are some of the error that occure


```
File "src/sage/groups/generic.py", line 1104, in sage.groups.generic.?
Failed example:                                               
    F=GF(2^1279,'a')
Exception raised:                
    Traceback (most recent call last):
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)       
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)       
      File "<doctest sage.groups.generic.?[14]>", line 1, in <module>
        F=GF(Integer(2)**Integer(1279),'a')
      File "sage/structure/factory.pyx", line 367, in sage.structure.factory.UniqueFactory.__call__ (build/cythonized/sage/structure/factory.c:2059)
        key, kwds = self.create_key_and_extra_args(*args, **kwds)
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/rings/finite_rings/finite_field_constructor.py", line 566, in create_key_and_extra_args
        raise ValueError("the order of a finite field must be a prime power")
    ValueError: the order of a finite field must be a prime power
**********************************************************************
File "src/sage/groups/generic.py", line 1105, in sage.groups.generic.?
Failed example:           
    n=F.cardinality()-1 # Mersenne prime
Exception raised:                                                           
    Traceback (most recent call last):             
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.generic.?[15]>", line 1, in <module>
        n=F.cardinality()-Integer(1) # Mersenne prime
    AttributeError: 'IntegerFactorization' object has no attribute 'cardinality'
**********************************************************************
File "src/sage/groups/generic.py", line 1106, in sage.groups.generic.?
Failed example:
    order_from_multiple(F.random_element(),n,factorization=[(n,1)],operation='*')==n
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.generic.?[16]>", line 1, in <module>
        order_from_multiple(F.random_element(),n,factorization=[(n,Integer(1))],operation='*')==n
    AttributeError: 'IntegerFactorization' object has no attribute 'random_element'
```


It seems that almost nothing works anymore. I have no idea what I can do about it besides deleting everything and reinstalling sage.

Those errors are happening in the develop branch as well.

By the way, nothing works in src/sage/interfaces/polymake.py. This is the start of a very long list.


```
kliem`@`zancara:~/localhome/patchbot-sage/sage$  sage -t --long  src/sage/interfaces/polymake.py --optional=bliss,ccache,dochtml,lrslib,memlimit,mpir,ninja_build,normaliz,openssl,pynormaliz,python2,sage,polymake 
too many failed tests, not using stored timings
Running doctests with ID 2019-04-27-22-43-17-aca10dd8.
Git branch: develop
Using --optional=bliss,ccache,dochtml,lrslib,memlimit,mpir,ninja_build,normaliz,openssl,polymake,pynormaliz,python2,sage
Doctesting 1 file.
sage -t --long src/sage/interfaces/polymake.py
**********************************************************************
File "src/sage/interfaces/polymake.py", line 71, in sage.interfaces.polymake.PolymakeError
Failed example:
    polymake.eval('print foo;')    # optional polymake
Expected:
    Traceback (most recent call last):
    ...
    PolymakeError: Unquoted string "foo" may clash with future reserved word...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/import/sage-7.4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/import/sage-7.4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.PolymakeError[0]>", line 1, in <module>
        polymake.eval('print foo;')    # optional polymake
    AttributeError: Polymake instance has no attribute 'eval'
**********************************************************************
File "src/sage/interfaces/polymake.py", line 86, in sage.interfaces.polymake.polymake_console
Failed example:
    from sage.interfaces.polymake import polymake_console
Exception raised:
    Traceback (most recent call last):
      File "/import/sage-7.4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/import/sage-7.4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.polymake_console[0]>", line 1, in <module>
        from sage.interfaces.polymake import polymake_console
    ImportError: No module named polymake
**********************************************************************
File "src/sage/interfaces/polymake.py", line 127, in sage.interfaces.polymake.Polymake
Failed example:
    p = polymake.rand_sphere(4, 20, seed=5)       # optional - polymake
Exception raised:
    Traceback (most recent call last):
      File "/import/sage-7.4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/import/sage-7.4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake[0]>", line 1, in <module>
        p = polymake.rand_sphere(Integer(4), Integer(20), seed=Integer(5))       # optional - polymake
    AttributeError: Polymake instance has no attribute 'rand_sphere'
**********************************************************************
```



---

Comment by @kliem created at 2019-04-27 20:47:41

When I run polymake in the sage subshell I get a compilation error upon running ` $p = rand_sphere<4,20>;`.


---

Comment by jipilab created at 2019-04-27 21:45:24

Run a `sage distclean` and reinstall sage from scratch. Installing polymake also broke my sage somehow a some point. Reinstalling worked for me.


---

Comment by @kliem created at 2019-04-28 06:22:45

I already did it. Now `openssl` isn't working again. It will take a while until I have a working version of sage on this machine again.

Replying to [comment:107 jipilab]:
> Run a `sage distclean` and reinstall sage from scratch. Installing polymake also broke my sage somehow a some point. Reinstalling worked for me.


---

Comment by mkoeppe created at 2019-04-28 08:01:13

Replying to [comment:97 gh-LaisRast]:
> It compiled on Arch Linux x86_64 (5.0.9-arch1-1-ARCH). All relevant tests pass except for three.
> https://trac.sagemath.org/attachment/ticket/24905/polymake.log

Thanks for checking. In these three doctests it looks like polymake is emitting some extra newlines.
This is probably some nondeterministic pty interaction.


---

Comment by mkoeppe created at 2019-04-28 14:20:19

polymake 3.4 on macOS Mojave (built within sage, but also the official DMG from the polymake website) dies if one presses `^C` in quick succession during a computation such as the following:

```
  $p = cube(20);
  $p->VOLUME;
```



---

Comment by jipilab created at 2019-04-28 15:34:47

Replying to [comment:110 mkoeppe]:
> polymake 3.4 on macOS Mojave (built within sage, but also the official DMG from the polymake website) dies if one presses `^C` in quick succession during a computation such as the following:
> {{{
>   $p = cube(20);
>   $p->VOLUME;
> }}}

Similar on debian using `./sage -polymake`.


---

Comment by mkoeppe created at 2019-04-28 18:07:19

Replying to [comment:110 mkoeppe]:
> polymake 3.4 on macOS Mojave (built within sage, but also the official DMG from the polymake website) dies if one presses `^C` in quick succession during a computation such as the following:
> {{{
>   $p = cube(20);
>   $p->VOLUME;
> }}}
polymake 3.2 (from the official DMG) has the same problem.


---

Comment by mkoeppe created at 2019-04-28 18:13:20

Replying to [comment:112 mkoeppe]:
> Replying to [comment:110 mkoeppe]:
> > polymake 3.4 on macOS Mojave (built within sage, but also the official DMG from the polymake website) dies if one presses `^C` in quick succession during a computation such as the following:
> > {{{
> >   $p = cube(20);
> >   $p->VOLUME;
> > }}}
> polymake 3.2 (from the official DMG) has the same problem.
Likewise, polymake 3.1


---

Comment by @kliem created at 2019-04-28 20:35:00

I set up my sage again and everything worked (all tests passed).

After installing polymake (and normaliz pynormaliz 4ti2 latte_int topcom qhull)
I am getting the following failure:


```
kliem`@`zancara:~/localhome/patchbot-sage/sage$ ./sage -t --long src/sage/rings/integer.pyx --exitfirst
too many failed tests, not using stored timings
Running doctests with ID 2019-04-28-22-27-17-978fe65b.
Git branch: polymake
Using --optional=4ti2,bliss,cmake,dochtml,latte_int,lidia,lrslib,memlimit,ninja_build,normaliz,openssl,pynormaliz,python2,qhull,sage,topcom
Doctesting 1 file.
sage -t --long src/sage/rings/integer.pyx
**********************************************************************
File "src/sage/rings/integer.pyx", line 3009, in sage.rings.integer.Integer.divisors
Failed example:
    for i in range(20):  # long time
        try:
            alarm(RDF.random_element(1e-3, 0.5))
            _ = n.divisors()
            cancel_alarm()  # we never get here
        except AlarmInterrupt:
            pass
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/patchbot-sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.divisors[20]>", line 4, in <module>
        _ = n.divisors()
      File "sage/rings/integer.pyx", line 3079, in sage.rings.integer.Integer.divisors (build/cythonized/sage/rings/integer.c:19767)
        ptr = <unsigned long*>check_allocarray(divisor_count, 3 * sizeof(unsigned long))
      File "memory.pxd", line 87, in cysignals.memory.check_allocarray (build/cythonized/sage/rings/integer.c:47077)
    MemoryError: failed to allocate 33554432 * 24 bytes
**********************************************************************
1 item had failures:
   1 of  21 in sage.rings.integer.Integer.divisors
    [1127 tests, 1 failure, 19.40 s]
----------------------------------------------------------------------
sage -t --long src/sage/rings/integer.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 19.6 seconds
    cpu time: 19.4 seconds
    cumulative wall time: 19.4 seconds
```


This looks familiar and indeed I have had this issue before:

https://groups.google.com/forum/#!topic/sage-devel/wqnilUCLsT4

The last time I had this issue this also happened in connection with this ticket on a different machine.

There are several more failures in this file, but I believe they are all due to the same issue.


---

Comment by jipilab created at 2019-04-30 12:21:05

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2019-04-30 12:21:05

Replying to [comment:114 gh-kliem]:
> [snip]

I do not think that this error is related to this ticket as we are not touching the file `src/sage/rings/integer.pyx` directly, nor does the installation (as far as I can see) is related to this module. This looks like a local error on this machine.

Considering that:

 - This error was not so far reproduced on other machines,
 - that the package is experimental,
 - it compiles on macOS Mojave, debian, and ArchLinux,

I would set this ticket to positive review. Further issues can be reported here: #22710.


---

Comment by @kliem created at 2019-04-30 20:13:04

Replying to [comment:115 jipilab]:
> Replying to [comment:114 gh-kliem]:
> > [snip]
> 
> I do not think that this error is related to this ticket as we are not touching the file `src/sage/rings/integer.pyx` directly, nor does the installation (as far as I can see) is related to this module. This looks like a local error on this machine.

I have this error occuring on two different machines and it's installation dependent (on one machine it only shows up in one installation). As it hasn't been there in this installation before installing normaliz pynormaliz 4ti2 latte_int topcom qhull polymake, I suppose that one of them for some strange reason causes `alarm` to not work correctly anymore (this causes the memory overflow as the list of divisors is too long for `./sage -t` default).

It is possible that a patchbot cannot have polymake installed. But I'm not certain of this yet.
> 
> Considering that:
> 
>  - This error was not so far reproduced on other machines,
>  - that the package is experimental,
>  - it compiles on macOS Mojave, debian, and ArchLinux,
> 
> I would set this ticket to positive review. Further issues can be reported here: #22710.


---

Comment by mkoeppe created at 2019-05-01 22:49:23

I can't seem to reproduce a failure in the tests for `src/sage/rings/integer.pyx`.


---

Comment by @kliem created at 2019-05-02 04:44:23

The failure has nothing to do with this ticket.

I updated my post on sage-devel.

It seems that many patchbots fail that test in the sense that alarm interrupt takes way too long (they all take about a minute for this file and this seems to be the reason why).
In my case the machine allocates the list for the divisors already, which exceeds the default allowance for `.sage -t`.


---

Comment by fbissey created at 2019-05-06 00:54:25

These two doctests need to be marked optional

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py", line 1097, in sage.interfaces.polymake.Polymake._tab_completion
Failed example:
    'show_credits' in dir(polymake)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake._tab_completion[0]>", line 1, in <module>
        'show_credits' in dir(polymake)
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/tab_completion.py", line 52, in __dir__
        return dir(self.__class__) + list(self.__dict__) + tab_fn()
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py", line 1107, in _tab_completion
        self._start()
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py", line 362, in _start
        Expect._start(self, alt_message=None)
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/expect.py", line 523, in _start
        raise RuntimeError("unable to start %s: %s" % (self.name(), msg))
    RuntimeError: unable to start polymake: End Of File (EOF). Exception style platform.
    Polymake finished running /usr/bin/env TERM=dumb polymake
    command: /usr/bin/env
    args: ['/usr/bin/env', 'TERM=dumb', 'polymake']
    buffer (last 100 chars): ''
    before (last 100 chars): '/usr/bin/env: \xe2\x80\x98polymake\xe2\x80\x99: No such file or directory\r\n'
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: 127
    flag_eof: True
    pid: 26727
    child_fd: 15
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile('polytope > ')
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py", line 1102, in sage.interfaces.polymake.Polymake._tab_completion
Failed example:
    'lex_ordered' in dir(polymake)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake._tab_completion[1]>", line 1, in <module>
        'lex_ordered' in dir(polymake)
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/tab_completion.py", line 52, in __dir__
        return dir(self.__class__) + list(self.__dict__) + tab_fn()
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py", line 1107, in _tab_completion
        self._start()
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/polymake.py", line 362, in _start
        Expect._start(self, alt_message=None)
      File "/usr/lib64/python2.7/site-packages/sage/interfaces/expect.py", line 523, in _start
        raise RuntimeError("unable to start %s: %s" % (self.name(), msg))
    RuntimeError: unable to start polymake: End Of File (EOF). Exception style platform.
    Polymake finished running /usr/bin/env TERM=dumb polymake
    command: /usr/bin/env
    args: ['/usr/bin/env', 'TERM=dumb', 'polymake']
    buffer (last 100 chars): ''
    before (last 100 chars): '/usr/bin/env: \xe2\x80\x98polymake\xe2\x80\x99: No such file or directory\r\n'
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: 127
    flag_eof: True
    pid: 26731
    child_fd: 15
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile('polytope > ')
**********************************************************************
1 item had failures:
   2 of   3 in sage.interfaces.polymake.Polymake._tab_completion
    [24 tests, 2 failures, 0.09 s]
```



---

Comment by fbissey created at 2019-05-06 00:54:25

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-05-06 08:57:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-05-06 08:58:15

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-05-07 08:09:02

please provide a precise link to the tarball. The link in the description leads to source tarball, minimal tarball, etc...


---

Comment by mkoeppe created at 2019-05-07 08:34:11

The wget command line has the URL.


---

Comment by dimpase created at 2019-05-07 08:40:13

I see - but the instructions like this are flaky. By right, one has to get the branch and  the  tarball first, and only then go about building things.
Otherwise chances are that building chokes up on an unavailable tarball.

And you should run `make build` to get all the deps right (`sage -b` is really a quick and dirty plug that should go away)


---

Comment by dimpase created at 2019-05-07 08:58:03

why does one need `libncurses-dev`? Sage provides ncurses, and as soon as #27277 is in, it should be able to use system's (n)curses.


---

Comment by mkoeppe created at 2019-05-07 10:19:07

Replying to [comment:125 dimpase]:
> why does one need `libncurses-dev`? Sage provides ncurses, and as soon as #27277 is in, it should be able to use system's (n)curses. 

This might be copy-paste from polymake install instructions. Certainly the `ncurses` spkg is pulled in via `perl_term_readline_gnu` and `readline`. It would be good to test if the install works without this system package (it should).


---

Comment by dimpase created at 2019-05-07 10:48:16

OK - the previous instruction didn't work if polymake was already installed. (Surely, the fact that it's an experimental package only makes it more complicated).


---

Comment by dimpase created at 2019-05-07 16:34:40

some errors, please have a look at mis-posted #27763#comment:9
and 
https://trac.sagemath.org/ticket/27763#comment:11


---

Comment by dimpase created at 2019-05-07 20:50:07

Please apply this

```diff
--- a/src/sage/interfaces/polymake.py
+++ b/src/sage/interfaces/polymake.py
`@``@` -874,7 +874,7 `@``@` class Polymake(ExtraTabCompletion, Expect):
         sometimes it hangs, and therefore we remove it from the tests, for now::
 
             sage: c = polymake.cube(15)             # optional - polymake
-            sage: polymake.eval('print {}->F_VECTOR;'.format(c.name()), timeout=1) # optional - polymake # not tested
+            sage: polymake.eval('print {}->F_VECTOR;'.format(c.name()), timeout=1) # not tested # optional - polymake
             Traceback (most recent call last):
             ...
             RuntimeError: Polymake fails to respond timely
```


this order indeed suppresses running this line, otherwise it does not work for me.


---

Comment by mkoeppe created at 2019-05-08 08:51:09

Very strange. I don't think the order of these annotations makes a difference


---

Comment by dimpase created at 2019-05-08 08:59:57

The doctesting framework is a pile of .... - so I'm not surprised that on different platforms it behaves differently. E.g. we see doctests passing with `--serial` options and mysteriously crashing without it.


---

Comment by git created at 2019-05-08 09:04:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-08 09:58:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-05-08 09:59:38

looks good now.


---

Comment by dimpase created at 2019-05-08 09:59:38

Changing status from needs_review to positive_review.


---

Comment by git created at 2019-05-08 10:25:17

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-05-08 10:25:17

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by dimpase created at 2019-05-08 10:30:35

oops, sorry, I keep pushing into wrong branches these days! Please save your old branch...


---

Comment by dimpase created at 2019-05-08 10:33:31

specifically, Matthias, could you force-push your last #24905#comment:133 ?


---

Comment by dimpase created at 2019-05-08 10:43:47

On https://github.com/sagemath/sagetrac-mirror/tree/public/upgrade_polymake_to_version_3_2r4

we have everything till comment:101 - so I can recreate the thing from history here... <facepalm>


---

Comment by git created at 2019-05-08 10:55:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2019-05-08 10:57:31

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-05-08 10:57:31

OK, this looks like a correctly recovered branch to me.


---

Comment by dimpase created at 2019-05-08 12:40:06

On Debian I also had to install libterm-readkey-perl


---

Comment by git created at 2019-05-08 12:56:19

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-05-08 12:56:19

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2019-05-08 12:57:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-08 12:58:28

I restored the old branch and cherry-picked your "update docs" commit


---

Comment by dimpase created at 2019-05-08 13:06:51

could you also mention libterm-readline-gnu-perl as a package to install on !Debian/Ubuntu?


---

Comment by mkoeppe created at 2019-05-08 13:11:04

Perhaps it's time to change this package from "experimental" to "optional"?


---

Comment by git created at 2019-05-08 13:12:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-08 13:32:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-05-08 13:33:31

Let's get this done and open another ticket for promotion to optional.
IMHO it is not quite ready, e.g. it does not run on all supported platforms.
And the installation procedure isn't nice. I don't think we have a optional package where to install it one needs to install many things by hand in an ad hoc way.
----
New commits:


---

Comment by git created at 2019-05-08 13:35:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-08 13:35:59

Replying to [comment:151 dimpase]:
> Let's get this done and open another ticket for promotion to optional.
> IMHO it is not quite ready, e.g. it does not run on all supported platforms.
> And the installation procedure isn't nice. I don't think we have a optional package where to install it one needs to install many things by hand in an ad hoc way.

OK, I agree, good point.


---

Comment by mkoeppe created at 2019-05-08 13:38:07

I added one more perl package. Could you check this on Linux?
After adding it, the following should work:

```
polytope > $A = db_query( { "_id"=>"F.4D.0047" }, db=>"LatticePolytopes", collection=>"SmoothReflexive" );
polymake: used package polyDB
   Access to the polymake polytope database.
   (c) 2013-2018 Silke Horn, Andreas Paffenholz
   http://solros.de
   http://www.mathematik.tu-darmstadt.de/~paffenholz


polymake:  ERROR: #
# *** DEPRECATION WARNING ***
# ...
```

(The deprecation warning is normal.}


---

Comment by dimpase created at 2019-05-08 13:56:14

Building 72 more Perl packages now :-) Why is polymake itself not on CPAN?


---

Comment by dimpase created at 2019-05-08 15:46:55

this is what I got (after installing moar perl and rebuilding polymake)

```
 $ ./sage --polymake
Welcome to polymake version 3.4
Copyright (c) 1997-2019
Ewgenij Gawrilow, Michael Joswig (TU Berlin)
https://polymake.org

This is free software licensed under GPL; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Press F1 or enter 'help;' for basic instructions.

Application polytope currently uses following contributed and third-party software packages:
SVG, bliss, cdd, graphviz, latte, libnormaliz, lrs, permlib, polyDB, povray, ppl, qhull, singular, sketch, sympol, threejs, tikz, tosimplex
For more details:  show_credits;
polytope > $A = db_query( { "_id"=>"F.4D.0047" }, db=>"LatticePolytopes", collection=>"SmoothReflexive" );
polymake: used package polyDB
   Access to the polymake polytope database.
   (c) 2013-2018 Silke Horn, Andreas Paffenholz
   http://solros.de
   http://www.mathematik.tu-darmstadt.de/~paffenholz


polytope > 
```


perhaps you could add a meaningful doctest, tagged `internet`, for this?


---

Comment by mkoeppe created at 2019-05-08 15:56:40

When MongoDB is not available, the function `db_query` is not even present.
Not sure if/why we want to doctest that.

Let's postpone doctesting the `db_query` function in Sage to #27802, which adds support for the dictionary that appears in the argument list.


---

Comment by dimpase created at 2019-05-08 16:06:13

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-05-08 16:06:13

OK then.


---

Comment by dimpase created at 2019-05-08 17:13:19

one last nitpick `yum install perl-Term-ReadLine-Gnu` should be added to Fedora instructions


---

Comment by mkoeppe created at 2019-05-08 19:23:22

Thank you!


---

Comment by git created at 2019-05-08 19:25:06

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-05-08 19:25:06

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2019-05-08 19:25:48

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-05-08 20:48:39

Fedora's 26 perl is however not good.

```
[polymake-3.4] FAILED: /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/perlx/5.24.4/x86_64-linux-thread-multi/Customize.cc
[polymake-3.4] /usr/bin/perl /usr/share/perl5/ExtUtils/xsubpp -typemap /usr/share/perl5/ExtUtils/typemap  --output /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/perlx/5.24.4/x86_64-linux-thread-multi/Customize.cc /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/polymake-3.4/src/lib/core/src/perl/Customize.xxs
[polymake-3.4] Can't open perl script "/usr/share/perl5/ExtUtils/xsubpp": No such file or directory
```

This seems to be a known problem - not sure it's worthwhile to try to fix it though.

And, by the way, on stable Debian I get a problem building with (the standard) gcc 6.3.


---

Comment by mkoeppe created at 2019-05-09 09:36:43

Replying to [comment:163 dimpase]:
> Fedora's 26 perl is however not good.
> {{{
> [polymake-3.4] FAILED: /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/perlx/5.24.4/x86_64-linux-thread-multi/Customize.cc
> [polymake-3.4] /usr/bin/perl /usr/share/perl5/ExtUtils/xsubpp -typemap /usr/share/perl5/ExtUtils/typemap  --output /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/polymake-3.4/src/build/perlx/5.24.4/x86_64-linux-thread-multi/Customize.cc /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/polymake-3.4/src/lib/core/src/perl/Customize.xxs
> [polymake-3.4] Can't open perl script "/usr/share/perl5/ExtUtils/xsubpp": No such file or directory
> }}}
> This seems to be a known problem - not sure it's worthwhile to try to fix it though.

Known to who?


---

Comment by mkoeppe created at 2019-05-09 09:44:12

Follow-up ticket: Fix polymake 3.4 lrslib detection (#27803).


---

Comment by dimpase created at 2019-05-09 09:46:35

It's known to the internet that !Fedora/Centos perform a surgery on its Perl installation resulting in breakages like in comment:163 (missing `/usr/share/perl5/ExtUtils/xsubpp`; of course `xsubpp` is present, it's only not in this locaton, hardcoded somewhere...)


---

Comment by vbraun created at 2019-05-12 21:33:26

Resolution: fixed


---

Comment by vbraun created at 2019-05-12 21:33:26

Too late, a previous version was released in 8.8.beta5. Move any new code to a separate ticket


---

Comment by mkoeppe created at 2019-05-13 15:16:49

Replying to [comment:169 vbraun]:
> Too late, a previous version was released in 8.8.beta5. Move any new code to a separate ticket
No problem, the missing commit is on the branch of #27803
