# Issue 32880: Restore the Condon-Shortley phase in spherical harmonics and fix their derivatives

archive/issues_032880.json:
```json
{
    "body": "CC:  @mjungmath tscrim\n\nKeywords: spherical harmonics\n\nAs noticed in https://groups.google.com/g/sage-devel/c/2rNGCYg82rE/m/plZsnDN7EgAJ, Sage's spherical harmonics do not include the [Condon-Shortley phase](https://en.wikipedia.org/wiki/Spherical_harmonics#Condon%E2%80%93Shortley_phase), which makes them differ by a factor (-1)<sup>m</sup> from Wikipedia, SymPy and Mathematica spherical harmonics:\n\n```\nsage: theta, phi = var('theta phi')\nsage: spherical_harmonic(1, 1, theta, phi)\n1/4*sqrt(3)*sqrt(2)*sqrt(sin(theta)^2)*e^(I*phi)/sqrt(pi)\nsage: from sympy import Ynm\nsage: Ynm(1, 1, theta, phi).expand(func=True) # notice the sign difference \n-sqrt(6)*exp(I*phi)*sin(theta)/(4*sqrt(pi))\n```\n\n\nFurthermore, the computation of derivatives of spherical harmonics is based on a formula which assumes the Condon-Shortley phase! This makes it totally buggy:\n\n```\nsage: l, m, theta, phi = var('l m theta phi')\nsage: Ylm = spherical_harmonic(l, m, theta, phi)\nsage: DYlm = diff(Ylm, theta)\nsage: DYlm\nm*cot(theta)*spherical_harmonic(l, m, theta, phi)\n + sqrt((l + m + 1)*(l - m))*e^(-I*phi)*spherical_harmonic(l, m + 1, theta, phi)\nsage: DYlm.subs({l: 1, m: 0})\n1/2*sqrt(3)*sqrt(sin(theta)^2)/sqrt(pi)\nsage: diff(spherical_harmonic(1, 0, theta, phi), theta) # sign opposite to above!\n-1/2*sqrt(3)*sin(theta)/sqrt(pi)\n```\n\n\nAdding the Condon-Shortley phase in the definition of spherical harmonics would make them standard, thereby avoiding many confusions (especially with Wikipedia and SymPy) and would fix the derivative computation.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33117\n\n",
    "created_at": "2022-01-05T08:03:59Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Restore the Condon-Shortley phase in spherical harmonics and fix their derivatives",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32880",
    "user": "egourgoulhon"
}
```
CC:  @mjungmath tscrim

Keywords: spherical harmonics

As noticed in https://groups.google.com/g/sage-devel/c/2rNGCYg82rE/m/plZsnDN7EgAJ, Sage's spherical harmonics do not include the [Condon-Shortley phase](https://en.wikipedia.org/wiki/Spherical_harmonics#Condon%E2%80%93Shortley_phase), which makes them differ by a factor (-1)<sup>m</sup> from Wikipedia, SymPy and Mathematica spherical harmonics:

```
sage: theta, phi = var('theta phi')
sage: spherical_harmonic(1, 1, theta, phi)
1/4*sqrt(3)*sqrt(2)*sqrt(sin(theta)^2)*e^(I*phi)/sqrt(pi)
sage: from sympy import Ynm
sage: Ynm(1, 1, theta, phi).expand(func=True) # notice the sign difference 
-sqrt(6)*exp(I*phi)*sin(theta)/(4*sqrt(pi))
```


Furthermore, the computation of derivatives of spherical harmonics is based on a formula which assumes the Condon-Shortley phase! This makes it totally buggy:

```
sage: l, m, theta, phi = var('l m theta phi')
sage: Ylm = spherical_harmonic(l, m, theta, phi)
sage: DYlm = diff(Ylm, theta)
sage: DYlm
m*cot(theta)*spherical_harmonic(l, m, theta, phi)
 + sqrt((l + m + 1)*(l - m))*e^(-I*phi)*spherical_harmonic(l, m + 1, theta, phi)
sage: DYlm.subs({l: 1, m: 0})
1/2*sqrt(3)*sqrt(sin(theta)^2)/sqrt(pi)
sage: diff(spherical_harmonic(1, 0, theta, phi), theta) # sign opposite to above!
-1/2*sqrt(3)*sin(theta)/sqrt(pi)
```


Adding the Condon-Shortley phase in the definition of spherical harmonics would make them standard, thereby avoiding many confusions (especially with Wikipedia and SymPy) and would fix the derivative computation.

Issue created by migration from https://trac.sagemath.org/ticket/33117





---

archive/issue_comments_468925.json:
```json
{
    "body": "Here we go!\n----\nNew commits:",
    "created_at": "2022-03-01T21:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468925",
    "user": "egourgoulhon"
}
```

Here we go!
----
New commits:



---

archive/issue_comments_468926.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-01T21:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468926",
    "user": "egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468927.json:
```json
{
    "body": "Suggestions:\n\n\n```diff\n-    Note that this convention is opposite to Maxima's one, as revealed\n-    by the sign difference for odd values of `m`::\n+    Note that this convention differs from the one in Maxima,\n+    as revealed by the sign difference for odd values of `m`::\n```\n\n\n\n```diff\n-    It follows that, contrary to Maxima's ones, SageMath's spherical harmonics\n-    agree with those of SymPy, SciPy, Mathematica and\n-    :wikipedia:`Table_of_spherical_harmonics`.\n+    It follows that, contrary to Maxima, SageMath uses the same\n+    sign convention for spherical harmonics as SymPy, SciPy,\n+    Mathematica and :wikipedia:`Table_of_spherical_harmonics`.\n```\n\n\n\n```diff\n-        Check whether :trac:`25034` yields correct results compared to Maxima,\n-        up the Condon-Shortley phase factor `(-1)^m`::\n+        Check whether Sage yields correct results compared to Maxima,\n+        up to the Condon-Shortley phase factor `(-1)^m`\n+        (see :trac:`25034` and :trac:`33117`)::\n```\n\n\n\n```diff\n-        Check that :trac:33117 is fixed::\n+        Check that :trac:`33117` is fixed::\n```\n",
    "created_at": "2022-03-01T22:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468927",
    "user": "slelievre"
}
```

Suggestions:


```diff
-    Note that this convention is opposite to Maxima's one, as revealed
-    by the sign difference for odd values of `m`::
+    Note that this convention differs from the one in Maxima,
+    as revealed by the sign difference for odd values of `m`::
```



```diff
-    It follows that, contrary to Maxima's ones, SageMath's spherical harmonics
-    agree with those of SymPy, SciPy, Mathematica and
-    :wikipedia:`Table_of_spherical_harmonics`.
+    It follows that, contrary to Maxima, SageMath uses the same
+    sign convention for spherical harmonics as SymPy, SciPy,
+    Mathematica and :wikipedia:`Table_of_spherical_harmonics`.
```



```diff
-        Check whether :trac:`25034` yields correct results compared to Maxima,
-        up the Condon-Shortley phase factor `(-1)^m`::
+        Check whether Sage yields correct results compared to Maxima,
+        up to the Condon-Shortley phase factor `(-1)^m`
+        (see :trac:`25034` and :trac:`33117`)::
```



```diff
-        Check that :trac:33117 is fixed::
+        Check that :trac:`33117` is fixed::
```




---

archive/issue_comments_468928.json:
```json
{
    "body": "Agree with slelievre. Other than that, LGTM.\n\n+1 on the added documentation!",
    "created_at": "2022-03-02T09:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468928",
    "user": "@mjungmath"
}
```

Agree with slelievre. Other than that, LGTM.

+1 on the added documentation!



---

archive/issue_comments_468929.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T09:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468929",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468930.json:
```json
{
    "body": "Replying to [comment:4 slelievre]:\nThanks for the corrections! They are taken into account in the latest commit.",
    "created_at": "2022-03-02T09:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468930",
    "user": "egourgoulhon"
}
```

Replying to [comment:4 slelievre]:
Thanks for the corrections! They are taken into account in the latest commit.



---

archive/issue_comments_468931.json:
```json
{
    "body": "Any further comment?",
    "created_at": "2022-03-07T09:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468931",
    "user": "egourgoulhon"
}
```

Any further comment?



---

archive/issue_comments_468932.json:
```json
{
    "body": "Some things seem to be indented by 3 spaces,\nwhich seems off.\n\nCan you check indentation throughout?\nIn particular `.. MATH::` blocks.\n\nOther than that, good to go.\nOr that can be a separate ticket.",
    "created_at": "2022-03-08T07:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468932",
    "user": "slelievre"
}
```

Some things seem to be indented by 3 spaces,
which seems off.

Can you check indentation throughout?
In particular `.. MATH::` blocks.

Other than that, good to go.
Or that can be a separate ticket.



---

archive/issue_comments_468933.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-08T14:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468933",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468934.json:
```json
{
    "body": "Replying to [comment:9 slelievre]:\n> Some things seem to be indented by 3 spaces,\n> which seems off.\n> \n> Can you check indentation throughout?\n> In particular `.. MATH::` blocks.\n> \n\nDone in the above commit. \n\n> Other than that, good to go.\n> Or that can be a separate ticket.\n\nSince we were at it, done here...\nTruly speaking, the whole doc of special functions could be seriously improved. But this certainly should be done in another ticket.",
    "created_at": "2022-03-08T14:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468934",
    "user": "egourgoulhon"
}
```

Replying to [comment:9 slelievre]:
> Some things seem to be indented by 3 spaces,
> which seems off.
> 
> Can you check indentation throughout?
> In particular `.. MATH::` blocks.
> 

Done in the above commit. 

> Other than that, good to go.
> Or that can be a separate ticket.

Since we were at it, done here...
Truly speaking, the whole doc of special functions could be seriously improved. But this certainly should be done in another ticket.



---

archive/issue_comments_468935.json:
```json
{
    "body": "We have Abramovitz and Stegun in our main bibliography file,\nas well as some of its chapters, if you want to use that\nin the `REFERENCES` block you edited.\n\n\n```\n.. [AS-Bessel] \\F. W. J. Olver: 9. Bessel Functions of Integer Order,\n               in Abramowitz and Stegun: Handbook of Mathematical\n               Functions. http://people.math.sfu.ca/~cbm/aands/page_355.htm\n\n.. [AS-Spherical] \\H. A. Antosiewicz: 10. Bessel Functions of\n                  Fractional Order, in Abramowitz and Stegun: Handbook\n                  of Mathematical Functions. http://people.math.sfu.ca/~cbm/aands/page_435.htm\n\n.. [AS-Struve] \\M. Abramowitz: 12. Struve Functions and Related\n               Functions, in Abramowitz and Stegun: Handbook of\n               Mathematical Functions. http://people.math.sfu.ca/~cbm/aands/page_495.htm\n\n.. [AS1964] \\M. Abramowitz and I. A. Stegun, *Handbook of Mathematical\n            Functions*, National Bureau of Standards Applied\n            Mathematics Series, 55. 1964. See also\n            http://www.math.sfu.ca/~cbm/aands/.\n```\n\n\nOr leave it for a \"special functions doc cleanup\" ticket.",
    "created_at": "2022-03-08T15:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468935",
    "user": "slelievre"
}
```

We have Abramovitz and Stegun in our main bibliography file,
as well as some of its chapters, if you want to use that
in the `REFERENCES` block you edited.


```
.. [AS-Bessel] \F. W. J. Olver: 9. Bessel Functions of Integer Order,
               in Abramowitz and Stegun: Handbook of Mathematical
               Functions. http://people.math.sfu.ca/~cbm/aands/page_355.htm

.. [AS-Spherical] \H. A. Antosiewicz: 10. Bessel Functions of
                  Fractional Order, in Abramowitz and Stegun: Handbook
                  of Mathematical Functions. http://people.math.sfu.ca/~cbm/aands/page_435.htm

.. [AS-Struve] \M. Abramowitz: 12. Struve Functions and Related
               Functions, in Abramowitz and Stegun: Handbook of
               Mathematical Functions. http://people.math.sfu.ca/~cbm/aands/page_495.htm

.. [AS1964] \M. Abramowitz and I. A. Stegun, *Handbook of Mathematical
            Functions*, National Bureau of Standards Applied
            Mathematics Series, 55. 1964. See also
            http://www.math.sfu.ca/~cbm/aands/.
```


Or leave it for a "special functions doc cleanup" ticket.



---

archive/issue_comments_468936.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-08T16:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468936",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468937.json:
```json
{
    "body": "Replying to [comment:12 slelievre]:\n> We have Abramovitz and Stegun in our main bibliography file,\n> as well as some of its chapters, if you want to use that\n> in the `REFERENCES` block you edited.\n> \nOK, I've done it in the latest commit. Note that I had to edit the main bibliography file for the HTML links were obsolete there.",
    "created_at": "2022-03-08T16:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468937",
    "user": "egourgoulhon"
}
```

Replying to [comment:12 slelievre]:
> We have Abramovitz and Stegun in our main bibliography file,
> as well as some of its chapters, if you want to use that
> in the `REFERENCES` block you edited.
> 
OK, I've done it in the latest commit. Note that I had to edit the main bibliography file for the HTML links were obsolete there.



---

archive/issue_comments_468938.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-08T16:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468938",
    "user": "slelievre"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468939.json:
```json
{
    "body": "Thanks for all these extra updates. Let's get this in.",
    "created_at": "2022-03-08T16:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468939",
    "user": "slelievre"
}
```

Thanks for all these extra updates. Let's get this in.



---

archive/issue_comments_468940.json:
```json
{
    "body": "Thank you for the review!",
    "created_at": "2022-03-08T16:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468940",
    "user": "egourgoulhon"
}
```

Thank you for the review!



---

archive/issue_comments_468941.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-12T15:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32880#issuecomment-468941",
    "user": "vbraun"
}
```

Resolution: fixed
