# Issue 32880: Restore the Condon-Shortley phase in spherical harmonics and fix their derivatives

Issue created by migration from https://trac.sagemath.org/ticket/33117

Original creator: egourgoulhon

Original creation time: 2022-01-05 08:03:59

CC:  @mjungmath tscrim

Keywords: spherical harmonics

As noticed in https://groups.google.com/g/sage-devel/c/2rNGCYg82rE/m/plZsnDN7EgAJ, Sage's spherical harmonics do not include the [Condon-Shortley phase](https://en.wikipedia.org/wiki/Spherical_harmonics#Condon%E2%80%93Shortley_phase), which makes them differ by a factor (-1)<sup>m</sup> from Wikipedia, SymPy and Mathematica spherical harmonics:

```
sage: theta, phi = var('theta phi')
sage: spherical_harmonic(1, 1, theta, phi)
1/4*sqrt(3)*sqrt(2)*sqrt(sin(theta)^2)*e^(I*phi)/sqrt(pi)
sage: from sympy import Ynm
sage: Ynm(1, 1, theta, phi).expand(func=True) # notice the sign difference 
-sqrt(6)*exp(I*phi)*sin(theta)/(4*sqrt(pi))
```


Furthermore, the computation of derivatives of spherical harmonics is based on a formula which assumes the Condon-Shortley phase! This makes it totally buggy:

```
sage: l, m, theta, phi = var('l m theta phi')
sage: Ylm = spherical_harmonic(l, m, theta, phi)
sage: DYlm = diff(Ylm, theta)
sage: DYlm
m*cot(theta)*spherical_harmonic(l, m, theta, phi)
 + sqrt((l + m + 1)*(l - m))*e^(-I*phi)*spherical_harmonic(l, m + 1, theta, phi)
sage: DYlm.subs({l: 1, m: 0})
1/2*sqrt(3)*sqrt(sin(theta)^2)/sqrt(pi)
sage: diff(spherical_harmonic(1, 0, theta, phi), theta) # sign opposite to above!
-1/2*sqrt(3)*sin(theta)/sqrt(pi)
```


Adding the Condon-Shortley phase in the definition of spherical harmonics would make them standard, thereby avoiding many confusions (especially with Wikipedia and SymPy) and would fix the derivative computation.


---

Comment by egourgoulhon created at 2022-03-01 21:12:13

Here we go!
----
New commits:


---

Comment by egourgoulhon created at 2022-03-01 21:12:13

Changing status from new to needs_review.


---

Comment by slelievre created at 2022-03-01 22:21:09

Suggestions:


```diff
-    Note that this convention is opposite to Maxima's one, as revealed
-    by the sign difference for odd values of `m`::
+    Note that this convention differs from the one in Maxima,
+    as revealed by the sign difference for odd values of `m`::
```



```diff
-    It follows that, contrary to Maxima's ones, SageMath's spherical harmonics
-    agree with those of SymPy, SciPy, Mathematica and
-    :wikipedia:`Table_of_spherical_harmonics`.
+    It follows that, contrary to Maxima, SageMath uses the same
+    sign convention for spherical harmonics as SymPy, SciPy,
+    Mathematica and :wikipedia:`Table_of_spherical_harmonics`.
```



```diff
-        Check whether :trac:`25034` yields correct results compared to Maxima,
-        up the Condon-Shortley phase factor `(-1)^m`::
+        Check whether Sage yields correct results compared to Maxima,
+        up to the Condon-Shortley phase factor `(-1)^m`
+        (see :trac:`25034` and :trac:`33117`)::
```



```diff
-        Check that :trac:33117 is fixed::
+        Check that :trac:`33117` is fixed::
```



---

Comment by @mjungmath created at 2022-03-02 09:38:47

Agree with slelievre. Other than that, LGTM.

+1 on the added documentation!


---

Comment by git created at 2022-03-02 09:40:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-03-02 09:41:21

Replying to [comment:4 slelievre]:
Thanks for the corrections! They are taken into account in the latest commit.


---

Comment by egourgoulhon created at 2022-03-07 09:40:02

Any further comment?


---

Comment by slelievre created at 2022-03-08 07:57:08

Some things seem to be indented by 3 spaces,
which seems off.

Can you check indentation throughout?
In particular `.. MATH::` blocks.

Other than that, good to go.
Or that can be a separate ticket.


---

Comment by git created at 2022-03-08 14:47:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-03-08 14:52:58

Replying to [comment:9 slelievre]:
> Some things seem to be indented by 3 spaces,
> which seems off.
> 
> Can you check indentation throughout?
> In particular `.. MATH::` blocks.
> 

Done in the above commit. 

> Other than that, good to go.
> Or that can be a separate ticket.

Since we were at it, done here...
Truly speaking, the whole doc of special functions could be seriously improved. But this certainly should be done in another ticket.


---

Comment by slelievre created at 2022-03-08 15:49:23

We have Abramovitz and Stegun in our main bibliography file,
as well as some of its chapters, if you want to use that
in the `REFERENCES` block you edited.


```
.. [AS-Bessel] \F. W. J. Olver: 9. Bessel Functions of Integer Order,
               in Abramowitz and Stegun: Handbook of Mathematical
               Functions. http://people.math.sfu.ca/~cbm/aands/page_355.htm

.. [AS-Spherical] \H. A. Antosiewicz: 10. Bessel Functions of
                  Fractional Order, in Abramowitz and Stegun: Handbook
                  of Mathematical Functions. http://people.math.sfu.ca/~cbm/aands/page_435.htm

.. [AS-Struve] \M. Abramowitz: 12. Struve Functions and Related
               Functions, in Abramowitz and Stegun: Handbook of
               Mathematical Functions. http://people.math.sfu.ca/~cbm/aands/page_495.htm

.. [AS1964] \M. Abramowitz and I. A. Stegun, *Handbook of Mathematical
            Functions*, National Bureau of Standards Applied
            Mathematics Series, 55. 1964. See also
            http://www.math.sfu.ca/~cbm/aands/.
```


Or leave it for a "special functions doc cleanup" ticket.


---

Comment by git created at 2022-03-08 16:20:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-03-08 16:22:24

Replying to [comment:12 slelievre]:
> We have Abramovitz and Stegun in our main bibliography file,
> as well as some of its chapters, if you want to use that
> in the `REFERENCES` block you edited.
> 
OK, I've done it in the latest commit. Note that I had to edit the main bibliography file for the HTML links were obsolete there.


---

Comment by slelievre created at 2022-03-08 16:24:11

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2022-03-08 16:24:11

Thanks for all these extra updates. Let's get this in.


---

Comment by egourgoulhon created at 2022-03-08 16:25:58

Thank you for the review!


---

Comment by vbraun created at 2022-03-12 15:11:15

Resolution: fixed
