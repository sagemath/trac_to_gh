# Issue 22527: Remove the link SAGE_LOCAL/lib/python

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2017-04-05 21:51:04

We do not need the link `SAGE_LOCAL/lib/python`, pointing to `python2.7`, and it can interfere with the Python 3 build, at least on OS X. (See #22756.)



---

Comment by jhpalmieri created at 2017-04-05 21:54:20

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2017-04-05 21:54:20

New commits:


---

Comment by git created at 2017-04-05 22:09:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-05 22:34:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-04-06 12:10:10

see also #22638


---

Comment by chapoton created at 2017-04-06 20:33:58

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-04-06 20:33:58

does not apply


---

Comment by git created at 2017-04-06 20:39:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-04-06 20:42:52

This should apply now. The old version changed `src/sage/all.py` to fix a doctest. The conflict replaced the old doctest with the one from Sage 8.0.beta1 that looks more robust to me. I haven't built with this change, though, so I can't promise no doctest failures.


---

Comment by jhpalmieri created at 2017-04-06 20:42:52

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-04-06 20:47:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-04-06 23:38:02

Edit: moved the comment to #22756.


---

Comment by jdemeyer created at 2017-04-07 08:31:39

I don't agree with the change to `src/bin/sage`. It needs to check whether Sage was built inside `$SAGE_LOCAL` and the new code doesn't do that (it could potentially import a different version of Sage installed on the system).


---

Comment by jdemeyer created at 2017-04-07 08:31:39

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2017-04-07 14:31:48

I wasn't completely satisfied with that change, either. We could do something like this instead:

```diff
diff --git a/src/bin/sage b/src/bin/sage
index cc6e41cbed..b26618a3b8 100755
--- a/src/bin/sage
+++ b/src/bin/sage
`@``@` -383,7 +383,15 `@``@` fi
 # Prepare for running Sage, either interactively or non-interactively.
 sage_setup() {
     # Check that we're not in a source tarball which hasn't been built yet (#13561).
-    if ! python -c 'import sage.version' 2> /dev/null ; then
+    if [ ! -x "$SAGE_LOCAL/bin/python" ]; then
+        built=no
+    else
+        PYTHON_VERSION=$("$SAGE_LOCAL/bin/python" -c 'import sys; print("%d.%d" % sys.version_info[:2])')
+        if [ ! -d "$SAGE_LOCAL/lib/python$PYTHON_VERSION/site-packages/sage" ]; then
+            built=no
+        fi
+    fi
+    if [ $built = no ]; then
         echo >&2 '************************************************************************'
         echo >&2 'It seems that you are attempting to run Sage from an unpacked source'
         echo >&2 'tarball, but you have not compiled it yet (or maybe the build has not'
```

How about that?


---

Comment by vbraun created at 2017-04-08 17:41:21

Can't we just check for the presence of SAGE_LOCAL/bin/sage instead of messing around with python minutae?


---

Comment by jhpalmieri created at 2017-04-08 18:09:59

I think that `SAGE_LOCAL/bin/sage` can get installed well before the Sage library.


---

Comment by vbraun created at 2017-04-08 18:27:03

Yes, but so what? Its only a sanity check that you don't try to run an unpacked source tarball.


---

Comment by jhpalmieri created at 2017-04-08 18:48:14

Either way is fine with me: check for `local/lib/python$PYTHON_VERSION/site-packages/sage/` or for `local/bin/sage`.


---

Comment by git created at 2017-04-09 16:33:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-04-09 16:34:40

I decided that I like the more involved check. It is not complicated and it is more in line with the printed message, especially the part "(or maybe the build has not finished)".


---

Comment by jhpalmieri created at 2017-04-09 16:34:40

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2017-04-09 18:32:30

Thats hardcoding the assumption that python is a symlink to python3 when built with SAGE_PYTHON3=yes and would conflict with #22582


---

Comment by jhpalmieri created at 2017-04-09 20:10:47

Replying to [comment:19 vbraun]:
> Thats hardcoding the assumption that python is a symlink to python3 when built with SAGE_PYTHON3=yes

Yes, you're right.

> and would conflict with #22582

It would conflict with your current branch at #22582, but there is another option: making a reliable symlink `python -> python3` when `SAGE_PYTHON3=yes`. As I said at #22582, I would like to hear some other opinions about those two options. (As I also said at #22582, maybe `SAGE_PYTHON3` should control some run-time aspects of Sage, not just build-time. If such were available and did not just include the symlink, we could use those for this check.)


---

Comment by jhpalmieri created at 2017-04-12 17:17:46

Replying to [comment:19 vbraun]:
> Thats hardcoding the assumption that python is a symlink to python3 when built with SAGE_PYTHON3=yes and would conflict with #22582

Another way of looking at this: if we're not really thinking about how to run Sage using python3, that it's premature to do so, then: if you build with `SAGE_PYTHON3=yes`, the build will not complete because Sage isn't ready for Python 3 yet, so no matter what the symlink points to, you will get this message. If you build without `SAGE_PYTHON3=yes`, then the symlink should point to `python2` and this check will behave as it always has.

If we just check whether `local/bin/sage` exists, then you will get a less clear error message if Sage hasn't finished building yet, for whatever reason.

Once we figure out whether `SAGE_PYTHON3` has run-time effects or not, we can modify this check.


---

Comment by git created at 2017-04-12 21:25:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-04-12 21:25:42

But I don't really care that much.


---

Comment by jhpalmieri created at 2017-04-14 20:27:40

Should we bump the version numbers for python2 and python3, to make sure their spkg-install files get run, so the link actually gets removed when people upgrade?


---

Comment by vbraun created at 2017-04-16 22:49:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-16 22:49:36

Its not actually harmful, so I'm fine with leaving the old link hang around...


---

Comment by jhpalmieri created at 2017-04-17 04:03:04

The link can break the python3 build on OS X, but #22756 bumps the version number on python3 to try to address this. It still may break the first time, but in such a way that the build will get far enough to delete the link. After that it should work the next time.


---

Comment by vbraun created at 2017-04-18 22:36:43

Resolution: fixed
