# Issue 26936: p_group_cohomology depends on Cython

Issue created by migration from https://trac.sagemath.org/ticket/27173

Original creator: jdemeyer

Original creation time: 2019-01-30 08:31:29

CC:  simonking

The API change of `coercion_model` (#27021) broke `p_group_cohomology`: https://patchbot.sagemath.org/log/27152/Ubuntu/18.04/x86_64/4.15.0-38-generic/quasar/2019-01-29%2023:36:43

The fix is simple: rebuilding `p_group_cohomology` is sufficient (an analogous problem occurred with `giacpy_sage` on #27021). There is no automatic way to do this, but because of the missing dependency on cython (which is what I grepped for) I missed this.


---

Comment by jdemeyer created at 2019-01-30 08:38:06

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-01-30 08:38:06

New commits:


---

Comment by SimonKing created at 2019-01-30 08:38:49

Replying to [ticket:27173 jdemeyer]:
> The fix is simple: rebuilding `p_group_cohomology` is sufficient 

That's actually good news. When you wrote "API change broke the spkg", I thought I need to change code again (by the way, I am not sure: What is the current official spkg version in Sage? v3.1?).

> (an analogous problem occurred with `giacpy_sage` on #27021). There is no automatic way to do this, but because of the missing dependency on cython (which is what I grepped for) I missed this.

The current dependencies are

```
singular meataxe | matplotlib gap xz $(SAGERUNTIME)
```


Really the package does depend on sagelib. Namely, it cimports various Sage types (including Element, Parent).

In an ideal world, it would be possible to have a dependency list

```
singular meataxe sage.structure.element | matplotlib gap xz $(SAGERUNTIME)
```



---

Comment by SimonKing created at 2019-01-30 08:39:50

I hate the trac interface. Writing my comment destroyed your branch.

Can you provide the branch again?


---

Comment by chapoton created at 2019-01-30 08:41:28

New commits:


---

Comment by jdemeyer created at 2019-01-30 08:46:34

Replying to [comment:4 SimonKing]:
> Replying to [ticket:27173 jdemeyer]:
> > The fix is simple: rebuilding `p_group_cohomology` is sufficient 
> 
> That's actually good news. When you wrote "API change broke the spkg", I thought I need to change code again

No, what really happened is an incompatible change in `element.pxd` which means that every Cython file cimporting that must be recompiled.


---

Comment by jdemeyer created at 2019-01-30 08:46:53

Replying to [comment:4 SimonKing]:
> In an ideal world, it would be possible to have a dependency list
> {{{
> singular meataxe sage.structure.element | matplotlib gap xz $(SAGERUNTIME)
> }}}

Actually, why don't we just do that?


---

Comment by jdemeyer created at 2019-01-30 08:46:53

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2019-01-30 08:48:53

Replying to [comment:8 jdemeyer]:
> Replying to [comment:4 SimonKing]:
> > In an ideal world, it would be possible to have a dependency list
> > {{{
> > singular meataxe sage.structure.element | matplotlib gap xz $(SAGERUNTIME)
> > }}}
> 
> Actually, why don't we just do that?

Well, when I wrote my comment, I thought that it isn't supported yet.

So, are you saying that a dependency on _specific_ parts of the Sage library is possible? Or would that mean to extend Sage's build system?


---

Comment by git created at 2019-01-30 08:52:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-30 08:52:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-01-30 08:53:24

Note that this won't pick up transitive dependencies (the `Makefile` doesn't know that `element.pxd` depends on `sage_object.pxd` for example), but at least this should work when changing the file `element.pxd`.


---

Comment by jdemeyer created at 2019-01-30 08:54:29

Replying to [comment:9 SimonKing]:
> So, are you saying that a dependency on _specific_ parts of the Sage library is possible?

It's a `Makefile`, so it is possible to depend on specific filenames. It just never occurred to me to actually do that.


---

Comment by SimonKing created at 2019-01-30 08:57:57

Replying to [comment:13 jdemeyer]:
> Replying to [comment:9 SimonKing]:
> > So, are you saying that a dependency on _specific_ parts of the Sage library is possible?
> 
> It's a `Makefile`, so it is possible to depend on specific filenames. It just never occurred to me to actually do that.

Nice! I thought the `dependencies` file may only contain package names.

Also good that you add pip - indeed spkg-install uses pip.

But how to test it? Pull the branch, build sage, touch element.pxd, do `make` and see if the spkg gets rebuilt?


---

Comment by SimonKing created at 2019-01-30 09:02:45

I hate the trac interface.

When I write a comment, I certainly don't want that trac changes the ticket description back to what it was when I started to write my comment!


---

Comment by jdemeyer created at 2019-01-30 09:13:05

Replying to [comment:15 SimonKing]:
> But how to test it? Pull the branch, build sage, touch element.pxd, do `make` and see if the spkg gets rebuilt?

Yes, something like that.


---

Comment by SimonKing created at 2019-01-30 09:22:08

I think it would be possible to be a little more thorough. Here is the list of all cimports in the spkg that get stuff from outside the spkg (hence, that's dependencies):

```
src/pGroupCohomology/cochain.pxd:from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX
src/pGroupCohomology/cochain.pxd:from sage.libs.meataxe cimport *
src/pGroupCohomology/cochain.pxd:from sage.structure.element cimport RingElement, ModuleElement, Element
src/pGroupCohomology/cochain.pxd:from sage.rings.morphism cimport RingHomomorphism
src/pGroupCohomology/cochain.pyx:from sage.structure.element cimport RingElement
src/pGroupCohomology/cochain.pyx:from sage.matrix.matrix_gfpn_dense cimport new_mtx
src/pGroupCohomology/cochain.pyx:from libc.string cimport memcpy
src/pGroupCohomology/cochain.pyx:from cysignals.signals cimport sig_check, sig_on, sig_off
src/pGroupCohomology/cohomology.pyx:from libc.string cimport memcpy
src/pGroupCohomology/cohomology.pyx:from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX
src/pGroupCohomology/cohomology.pyx:from sage.matrix.matrix_gfpn_dense cimport new_mtx
src/pGroupCohomology/cohomology.pyx:from sage.libs.meataxe cimport *
src/pGroupCohomology/modular_cohomology.pyx:from sage.libs.meataxe cimport *
src/pGroupCohomology/modular_cohomology.pyx:from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX
src/pGroupCohomology/modular_cohomology.pyx:from sage.matrix.matrix_gfpn_dense cimport new_mtx
src/pGroupCohomology/resolution_bindings.pxd:from sage.libs.meataxe cimport *
src/pGroupCohomology/resolution.pxd:from sage.libs.meataxe cimport *
src/pGroupCohomology/resolution.pxd:from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX
src/pGroupCohomology/resolution.pyx:from libc.string cimport memcpy
src/pGroupCohomology/resolution.pyx:from cysignals.memory cimport sig_free
src/pGroupCohomology/resolution.pyx:from cysignals.signals cimport sig_check, sig_on, sig_off
src/pGroupCohomology/resolution.pyx:from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX
src/pGroupCohomology/resolution.pyx:from sage.matrix.matrix_gfpn_dense cimport FieldConverter_class, FieldConverter, new_mtx
src/pGroupCohomology/resolution.pyx:from sage.matrix.matrix0 cimport Matrix as Matrix0
```

So, the complete lists of dependencies is

```
sage.matrix.matrix_gfpn_dense
sage.libs.meataxe
sage.structure.element
sage.rings.morphism
libc.string
cysignals.signals
cysignals.memory
sage.matrix.matrix0
```


So, I suggest to include all this in the list of dependencies. Which gives rise to the questions:
- Has the dependency list be in a single line, or can it be one dependency per line? Would look nicer!
- What to do about libc and cysignals? Is that covered by the dependencies `python` and `cython`?


---

Comment by slelievre created at 2019-01-30 09:40:26

Replying to [comment:19 SimonKing]:

> Must the dependency list be in a single line, or can it be one dependency per line? Would look nicer!

Only the first line of the `dependencies` file is read, so yes, the dependencies must all
be listed in the first line of that file.


---

Comment by slelievre created at 2019-01-30 09:40:26

Changing keywords from "" to "dependencies".


---

Comment by SimonKing created at 2019-01-30 10:45:47

I have added all dependencies in sagelib, i.e., all pxd-files from which p_group_cohomology cimports.

So, what's missing is libc and cysignals. How to name them in the dependencies?
----
New commits:


---

Comment by jdemeyer created at 2019-01-30 14:25:05

Replying to [comment:19 SimonKing]:
> So, the complete lists of dependencies is
> {{{
> sage.matrix.matrix_gfpn_dense
> sage.libs.meataxe
> sage.structure.element
> sage.rings.morphism
> libc.string
> cysignals.signals
> cysignals.memory
> sage.matrix.matrix0
> }}}

No, that's not the complete list of dependencies. Like I said, you should also consider implied dependencies: for example, `sage.structure.element` depends on `sage.structure.parent` and so on. So my choice of `sage.structure.element` and `sage.matrix.matrix_gfpn_dense` was meant to be a reasonably small but meaningful set of dependencies.

For cysignals, just add a dependency on the `cysignals` package.


---

Comment by SimonKing created at 2019-01-30 16:02:35

Replying to [comment:23 jdemeyer]:
> No, that's not the complete list of dependencies. Like I said, you should also consider implied dependencies:

I understood that. But I think to the very least one should name _all_ pxd files from which the package cimports. Everything else would be too short.

> For cysignals, just add a dependency on the `cysignals` package.

Thanks. And for libc?


---

Comment by git created at 2019-01-31 14:18:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-31 14:20:00

I have added `cysignals` to the dependencies. What about `libc`? In any case, it is still "needs review", and since I added stuff (after searching for all cimports), I guess I qualify as one author.


---

Comment by jdemeyer created at 2019-01-31 15:20:45

Replying to [comment:26 SimonKing]:
> What about `libc`?

That's just the system C library on which virtually everything depends. It's assumed to remain ABI-compatible, so recompiling isn't needed.


---

Comment by jdemeyer created at 2019-01-31 21:44:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-04 23:02:35

Resolution: fixed
