# Issue 10207: Remove "warning: Replacing library search directory..." if caused by symbolic links

archive/issues_010207.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @nexttime\n\nThis follows up on #9896.\n\nIf there are symbolic links pointing to SAGE_ROOT, then running \"sage -b\" may cause a warning message like \n\n```\nwarning: Replacing library search directory in linker command:\n    \"[actual SAGE_ROOT directory]/local/lib\" -> \"[link]/local/lib\"\n```\n\nIt can be distracting having warning messages print when there is actually nothing wrong, so the attached patch removes this warning.  The warning will of course still print if the Sage library has actually been moved.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10208\n\n",
    "created_at": "2010-11-03T20:56:22Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Remove \"warning: Replacing library search directory...\" if caused by symbolic links",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10207",
    "user": "https://github.com/jhpalmieri"
}
```
Assignee: GeorgSWeber

CC:  @nexttime

This follows up on #9896.

If there are symbolic links pointing to SAGE_ROOT, then running "sage -b" may cause a warning message like 

```
warning: Replacing library search directory in linker command:
    "[actual SAGE_ROOT directory]/local/lib" -> "[link]/local/lib"
```

It can be distracting having warning messages print when there is actually nothing wrong, so the attached patch removes this warning.  The warning will of course still print if the Sage library has actually been moved.


Issue created by migration from https://trac.sagemath.org/ticket/10208





---

archive/issue_comments_103729.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-03T21:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103729",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_103730.json:
```json
{
    "body": "Would perhaps look nicer (in the code) if you just replaced the two occurrences of `os.path.normpath()` by `os.path.realpath()`, but I'm ok with your solution, since it does preserve more of the \"given\" directory names.\n\n`os.path.normpath(SAGE_LOCAL+\"/lib\")` should already be a fully dereferenced path (because `SAGE_ROOT` is), so you could omit the change into `os.path.realpath(sage_libdir)`.\n\nThe warning will only show up on MacOS X anyway.\n\nUnfortunately, on Darwin afaik `os.path.realpath()` does not necessarily return a unique name; perhaps this has meanwhile been fixed, but distutils still implement their own `canonicalize_path()` (or whatever it is called) for Darwin.",
    "created_at": "2010-11-03T21:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103730",
    "user": "https://github.com/nexttime"
}
```

Would perhaps look nicer (in the code) if you just replaced the two occurrences of `os.path.normpath()` by `os.path.realpath()`, but I'm ok with your solution, since it does preserve more of the "given" directory names.

`os.path.normpath(SAGE_LOCAL+"/lib")` should already be a fully dereferenced path (because `SAGE_ROOT` is), so you could omit the change into `os.path.realpath(sage_libdir)`.

The warning will only show up on MacOS X anyway.

Unfortunately, on Darwin afaik `os.path.realpath()` does not necessarily return a unique name; perhaps this has meanwhile been fixed, but distutils still implement their own `canonicalize_path()` (or whatever it is called) for Darwin.



---

archive/issue_comments_103731.json:
```json
{
    "body": "> Would perhaps look nicer ...\n\nOkay, here's a new patch.\n\nRegarding SAGE_ROOT: note that on my Mac, '/Applications/sage' is a link pointing to the real directory '/Applications/sage_builds/sage-4.6/'.\n\n```\nsage: SAGE_ROOT\n'/Applications/sage'\n```\n\nFrom the command line:\n\n```\n$ sage -sh\n\nStarting subshell with Sage environment variables set.\nBe sure to exit when you are done and do not do anything\nwith other copies of Sage!\n\nBypassing shell configuration files ...\n\nSAGE_ROOT=/Applications/sage\n```\n\nSo SAGE_ROOT is not actually \"fully dereferenced\", if that means what I think it means.  In case it doesn't mean what I think it means:\n\n```\nsage: os.path.realpath(SAGE_ROOT) == SAGE_ROOT\nFalse\n```\n\nSo I think we need os.path.realpath in both places.\n\n> Unfortunately, on Darwin afaik os.path.realpath() does not necessarily return a unique name; perhaps this has meanwhile been fixed, but distutils still implement their own canonicalize_path() (or whatever it is called) for Darwin.\n\nI don't know about this in general, but using os.path.realpath seems to fix this particular problem on my OS X machine.",
    "created_at": "2010-11-03T21:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103731",
    "user": "https://github.com/jhpalmieri"
}
```

> Would perhaps look nicer ...

Okay, here's a new patch.

Regarding SAGE_ROOT: note that on my Mac, '/Applications/sage' is a link pointing to the real directory '/Applications/sage_builds/sage-4.6/'.

```
sage: SAGE_ROOT
'/Applications/sage'
```

From the command line:

```
$ sage -sh

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

SAGE_ROOT=/Applications/sage
```

So SAGE_ROOT is not actually "fully dereferenced", if that means what I think it means.  In case it doesn't mean what I think it means:

```
sage: os.path.realpath(SAGE_ROOT) == SAGE_ROOT
False
```

So I think we need os.path.realpath in both places.

> Unfortunately, on Darwin afaik os.path.realpath() does not necessarily return a unique name; perhaps this has meanwhile been fixed, but distutils still implement their own canonicalize_path() (or whatever it is called) for Darwin.

I don't know about this in general, but using os.path.realpath seems to fix this particular problem on my OS X machine.



---

archive/issue_comments_103732.json:
```json
{
    "body": "Attachment [trac_10208-realpath.patch](tarball://root/attachments/some-uuid/ticket10208/trac_10208-realpath.patch) by @jhpalmieri created at 2010-11-03 21:34:22\n\n(sage library patch)",
    "created_at": "2010-11-03T21:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103732",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_10208-realpath.patch](tarball://root/attachments/some-uuid/ticket10208/trac_10208-realpath.patch) by @jhpalmieri created at 2010-11-03 21:34:22

(sage library patch)



---

archive/issue_comments_103733.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n> Regarding SAGE_ROOT: note that on my Mac, '/Applications/sage' is a link pointing to the real directory '/Applications/sage_builds/sage-4.6/'.\n> So SAGE_ROOT is not actually \"fully dereferenced\", if that means what I think it means.\n\n```\nsage: os.path.realpath(SAGE_ROOT) == SAGE_ROOT\nFalse\n```\n\n> So I think we need os.path.realpath in both places.\n\nOk, then (at least your) MacOS X lacks the `readlink` and `realpath` commands, or you've set `SAGE_ROOT` manually.\n\nIn general, I think it would be better to also assign `os.path.realpath(...)` to the Python variables `SAGE_ROOT`, `SAGE_LOCAL` etc. at the top of `setup.py` (line 32 ff.), which would also remove some redundant slashs.\n\n> > Unfortunately, on Darwin afaik os.path.realpath() does not necessarily return a unique name; perhaps this has meanwhile been fixed, but distutils still implement their own canonicalize_path() (or whatever it is called) for Darwin.\n> \n> I don't know about this in general, but using os.path.realpath seems to fix this particular problem on my OS X machine.\n\nMe either. Perhaps just history (when distutils were not part of the Python distribution), otherwise wouldn't make much sense to have distutils use their own version, leaving the standard Python function limited.",
    "created_at": "2010-11-03T22:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103733",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:3 jhpalmieri]:
> Regarding SAGE_ROOT: note that on my Mac, '/Applications/sage' is a link pointing to the real directory '/Applications/sage_builds/sage-4.6/'.
> So SAGE_ROOT is not actually "fully dereferenced", if that means what I think it means.

```
sage: os.path.realpath(SAGE_ROOT) == SAGE_ROOT
False
```

> So I think we need os.path.realpath in both places.

Ok, then (at least your) MacOS X lacks the `readlink` and `realpath` commands, or you've set `SAGE_ROOT` manually.

In general, I think it would be better to also assign `os.path.realpath(...)` to the Python variables `SAGE_ROOT`, `SAGE_LOCAL` etc. at the top of `setup.py` (line 32 ff.), which would also remove some redundant slashs.

> > Unfortunately, on Darwin afaik os.path.realpath() does not necessarily return a unique name; perhaps this has meanwhile been fixed, but distutils still implement their own canonicalize_path() (or whatever it is called) for Darwin.
> 
> I don't know about this in general, but using os.path.realpath seems to fix this particular problem on my OS X machine.

Me either. Perhaps just history (when distutils were not part of the Python distribution), otherwise wouldn't make much sense to have distutils use their own version, leaving the standard Python function limited.



---

archive/issue_comments_103734.json:
```json
{
    "body": "Ok, works as advertised. (I've only tested it on Linux by setting `LDSHARED`.)",
    "created_at": "2010-11-03T23:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103734",
    "user": "https://github.com/nexttime"
}
```

Ok, works as advertised. (I've only tested it on Linux by setting `LDSHARED`.)



---

archive/issue_comments_103735.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-11-03T23:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103735",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_103736.json:
```json
{
    "body": "Changing keywords from \"\" to \"LDSHARED symlink linker path\".",
    "created_at": "2010-11-03T23:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103736",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "" to "LDSHARED symlink linker path".



---

archive/issue_comments_103737.json:
```json
{
    "body": "Hmmm, I just noticed if the paths are equivalent the \"given\" path doesn't get normalized, i.e. redundant slashs and `..././` etc. removed, so in the messages still the unnormalized rather than the effective path appears.\n\nBut that's an even minor issue.",
    "created_at": "2010-11-03T23:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103737",
    "user": "https://github.com/nexttime"
}
```

Hmmm, I just noticed if the paths are equivalent the "given" path doesn't get normalized, i.e. redundant slashs and `..././` etc. removed, so in the messages still the unnormalized rather than the effective path appears.

But that's an even minor issue.



---

archive/issue_comments_103738.json:
```json
{
    "body": "Replying to [comment:4 leif]:\n> Ok, then (at least your) MacOS X lacks the `readlink` and `realpath` commands, or you've set `SAGE_ROOT` manually.\n\nI think that SAGE_ROOT is set in the script sage-env, by running \"pwd\" in an appropriate directory.  Perhaps with the GNU version of this, it resolves all links.  On Darwin, and it seems perhaps also on Solaris, you need to run \"pwd -P\" to do this.  On sage.math, 'pwd -P' also resolves links.  So we might also consider something like this change to sage-env:\n\n```diff\ndiff -r 4047e578febc sage-env\n--- a/sage-env\tSat Oct 30 16:05:33 2010 -0700\n+++ b/sage-env\tWed Nov 03 17:07:46 2010 -0700\n@@ -23,20 +23,20 @@\n ##########################################################################\n \n # GUESS SAGE_ROOT from pwd\n-SAVEDIR=\"`pwd`\"\n+PWD=\"pwd -P\"\n+SAVEDIR=\"`$PWD`\"\n if [ -f sage -a -d spkg ]; then\n-    GUESSED_SAGE_ROOT=\"`pwd`\"\n+    GUESSED_SAGE_ROOT=\"`$PWD`\"\n else \n     if [ -f ../../sage -a -d ../../spkg ]; then\n         cd ../../\n-        GUESSED_SAGE_ROOT=\"`pwd`\"\n+        GUESSED_SAGE_ROOT=\"`$PWD`\"\n     else\n         GUESSED_SAGE_ROOT=\"\"\n     fi\n fi\n cd \"$SAVEDIR\"\n \n-\n if [ \"$SAGE_ROOT\" = \"\" ]; then\n     if [ \"$GUESSED_SAGE_ROOT\" = \"\" ]; then\n         echo \"Error: You must set the SAGE_ROOT environment\"\n```\n\n(On the other hand, I don't understand why on sage.math, running 'pwd' from the command line in /scratch/palmieri/sage gives me \"/scratch/palmieri/sage\", while running it from sage-env gives me \"/mnt/usb1/scratch/palmieri/sage-4.6\".)",
    "created_at": "2010-11-04T00:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103738",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:4 leif]:
> Ok, then (at least your) MacOS X lacks the `readlink` and `realpath` commands, or you've set `SAGE_ROOT` manually.

I think that SAGE_ROOT is set in the script sage-env, by running "pwd" in an appropriate directory.  Perhaps with the GNU version of this, it resolves all links.  On Darwin, and it seems perhaps also on Solaris, you need to run "pwd -P" to do this.  On sage.math, 'pwd -P' also resolves links.  So we might also consider something like this change to sage-env:

```diff
diff -r 4047e578febc sage-env
--- a/sage-env	Sat Oct 30 16:05:33 2010 -0700
+++ b/sage-env	Wed Nov 03 17:07:46 2010 -0700
@@ -23,20 +23,20 @@
 ##########################################################################
 
 # GUESS SAGE_ROOT from pwd
-SAVEDIR="`pwd`"
+PWD="pwd -P"
+SAVEDIR="`$PWD`"
 if [ -f sage -a -d spkg ]; then
-    GUESSED_SAGE_ROOT="`pwd`"
+    GUESSED_SAGE_ROOT="`$PWD`"
 else 
     if [ -f ../../sage -a -d ../../spkg ]; then
         cd ../../
-        GUESSED_SAGE_ROOT="`pwd`"
+        GUESSED_SAGE_ROOT="`$PWD`"
     else
         GUESSED_SAGE_ROOT=""
     fi
 fi
 cd "$SAVEDIR"
 
-
 if [ "$SAGE_ROOT" = "" ]; then
     if [ "$GUESSED_SAGE_ROOT" = "" ]; then
         echo "Error: You must set the SAGE_ROOT environment"
```

(On the other hand, I don't understand why on sage.math, running 'pwd' from the command line in /scratch/palmieri/sage gives me "/scratch/palmieri/sage", while running it from sage-env gives me "/mnt/usb1/scratch/palmieri/sage-4.6".)



---

archive/issue_comments_103739.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> Replying to [comment:4 leif]:\n> > Ok, then (at least your) MacOS X lacks the `readlink` and `realpath` commands, or you've set `SAGE_ROOT` manually.\n> \n> I think that SAGE_ROOT is set in the script sage-env, by running \"pwd\" in an appropriate directory.\n\nBut only if `SAGE_ROOT` is not already set, which isn't the case if you run some `./sage ...` command, so it's a bit inconsistent.\n\nOh, but I see: `$SAGE_ROOT/sage` does not use `readlink -e` (which dereferences any symlink contained in its argument); without that, it returns an error if the *last component* is not a link. So if you have just links \"in the middle\", `sage` uses the basename of itself.\n\n> Perhaps with the GNU version of this, it resolves all links.  On Darwin, and it seems perhaps also on Solaris, you need to run \"pwd -P\" to do this.  On sage.math, 'pwd -P' also resolves links.  So we might also consider something like this change to sage-env...\n\nI wonder what new strange side-effects that would have... ;-)\n\n> (On the other hand, I don't understand why on sage.math, running 'pwd' from the command line in /scratch/palmieri/sage gives me \"/scratch/palmieri/sage\", while running it from sage-env gives me \"/mnt/usb1/scratch/palmieri/sage-4.6\".)\n\nThat depends on how you `cd` to a directory, or how a script is called. Which directory do you have in your path?\n\n`$0` should be set according to that inside a script, i.e. its basename should be the one where it was (first) found in your `$PATH` (i.e. even relative if you happen to have \"`.`\" in your path and the script is in the current directory).",
    "created_at": "2010-11-04T04:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103739",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:7 jhpalmieri]:
> Replying to [comment:4 leif]:
> > Ok, then (at least your) MacOS X lacks the `readlink` and `realpath` commands, or you've set `SAGE_ROOT` manually.
> 
> I think that SAGE_ROOT is set in the script sage-env, by running "pwd" in an appropriate directory.

But only if `SAGE_ROOT` is not already set, which isn't the case if you run some `./sage ...` command, so it's a bit inconsistent.

Oh, but I see: `$SAGE_ROOT/sage` does not use `readlink -e` (which dereferences any symlink contained in its argument); without that, it returns an error if the *last component* is not a link. So if you have just links "in the middle", `sage` uses the basename of itself.

> Perhaps with the GNU version of this, it resolves all links.  On Darwin, and it seems perhaps also on Solaris, you need to run "pwd -P" to do this.  On sage.math, 'pwd -P' also resolves links.  So we might also consider something like this change to sage-env...

I wonder what new strange side-effects that would have... ;-)

> (On the other hand, I don't understand why on sage.math, running 'pwd' from the command line in /scratch/palmieri/sage gives me "/scratch/palmieri/sage", while running it from sage-env gives me "/mnt/usb1/scratch/palmieri/sage-4.6".)

That depends on how you `cd` to a directory, or how a script is called. Which directory do you have in your path?

`$0` should be set according to that inside a script, i.e. its basename should be the one where it was (first) found in your `$PATH` (i.e. even relative if you happen to have "`.`" in your path and the script is in the current directory).



---

archive/issue_events_010328.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-10T22:22:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10207#event-10328"
}
```



---

archive/issue_comments_103740.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-10T22:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10207#issuecomment-103740",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
