# Issue 18608: Update NTL to 9.2.0

Issue created by migration from https://trac.sagemath.org/ticket/18845

Original creator: jpflori

Original creation time: 2015-07-03 08:11:04

CC:  fbissey jdemeyer

See:
* http://www.shoup.net/ntl/ntl-9.2.0.tar.gz


---

Comment by jpflori created at 2015-07-03 08:39:11

CCing s-o-g folk as they already worked hard to include an uptodate NTL there.


---

Comment by jpflori created at 2015-07-03 08:44:08

I've updated three fuzzy/failing patching.

I've not touched the error callback patch which does not apply ass we have two solutions:
* update our patch,
* use the native NTL error callback mechanism, this can arguably be done elsewhere if the former solution is trivial.

There should still be trouble with flint, singular and friends.
From what I read flint is fixed in git master.
No clear idea about Singular. From what I read there is a fix upstream, but is it available for 3.x as we are stuck with that at the moment, or only for 4.x?
----
New commits:


---

Comment by fbissey created at 2015-07-03 09:14:42

`flint` will build against it but not `singular`, I am not even sure `singular-4` will. I would need to check my inbox from when we looked at it in Gentoo with the guy that bumped `ntl` to 9.x.


---

Comment by fbissey created at 2015-07-03 10:12:08

`singular-4` has a fix in master: https://github.com/Singular/Sources/commit/de688442dfe449992dc14a000bca0691ecc7e106 that may be back portable.


---

Comment by jpflori created at 2015-07-06 14:19:50

Replying to [comment:5 fbissey]:
> `singular-4` has a fix in master: https://github.com/Singular/Sources/commit/de688442dfe449992dc14a000bca0691ecc7e106 that may be back portable.
Yes, it seems it just applies as is (with offset).


---

Comment by git created at 2015-07-06 15:51:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-06 16:01:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-06 17:32:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-07-06 21:14:15

There is something wrong with my modifs to David's code.
If someone could have a look, nothing jumps to me now...


---

Comment by jpflori created at 2015-07-06 21:25:50

My changes look pretty similar to the ones here:
* https://vabs.archlinux-br.org/x86_64/community-testing/S/sagemath-6.7-2/ntl9.patch
except for using `NTL::mulmod_t` instead of `NTL::wide_double`.


---

Comment by fbissey created at 2015-07-06 21:33:39

No idea what the difference is I am afraid.


---

Comment by git created at 2015-07-06 21:37:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-07-06 21:46:21

Replying to [comment:12 fbissey]:
> No idea what the difference is I am afraid.
Could you test this on a usual arch?
Currently, I only have Sage installed on a POWER7...


---

Comment by fbissey created at 2015-07-06 21:48:53

I'll have a look on my mac.


---

Comment by fbissey created at 2015-07-06 22:17:43

Taking longer than expected I wasn't completely up to date to beta7 (was on beta5). Will let you know when it is all done.


---

Comment by fbissey created at 2015-07-07 07:06:10

OK, I almost fell like I should have done a new build from scratch.

```
Mirage:sage-6.8.beta5 fbissey$ ./sage -t --long --warn-long 34.4 src/sage/rings/arith.py
Running doctests with ID 2015-07-07-17-26-18-c6eb7fbc.
Git branch: ntl92
Using --optional=gcc,mpir,python2,sage,scons
Doctesting 1 file.
sage -t --long --warn-long 34.4 src/sage/rings/arith.py
**********************************************************************
File "src/sage/rings/arith.py", line 294, in sage.rings.arith.bernoulli
Failed example:
    union([len(union(x))==1 for x in vals])  # long time (depends on previous line)
Expected:
    [True]
Got:
    [False, True]
**********************************************************************
File "src/sage/rings/arith.py", line 299, in sage.rings.arith.bernoulli
Failed example:
    union([len(union(x))==1 for x in vals])  # long time (depends on previous line)
Expected:
    [True]
Got:
    [False, True]
**********************************************************************
1 item had failures:
   2 of  16 in sage.rings.arith.bernoulli
    [785 tests, 2 failures, 51.51 s]
----------------------------------------------------------------------
sage -t --long --warn-long 34.4 src/sage/rings/arith.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 51.7 seconds
    cpu time: 38.6 seconds
    cumulative wall time: 51.5 seconds
Mirage:sage-6.8.beta5 fbissey$ ./sage -t --long --warn-long 34.4 src/sage/rings/bernmm.pyx
Running doctests with ID 2015-07-07-19-02-38-d29775f0.
Git branch: ntl92
Using --optional=gcc,mpir,python2,sage,scons
Doctesting 1 file.
sage -t --long --warn-long 34.4 src/sage/rings/bernmm.pyx
**********************************************************************
File "src/sage/rings/bernmm.pyx", line 68, in sage.rings.bernmm.bernmm_bern_rat
Failed example:
    lst1 == lst2
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/rings/bernmm.pyx", line 70, in sage.rings.bernmm.bernmm_bern_rat
Failed example:
    [ Zmod(101)(t) for t in lst1 ]
Expected:
    [77, 72, 89, 98, 86]
Got:
    [99, 0, 44, 42, 57]
**********************************************************************
1 item had failures:
   2 of  13 in sage.rings.bernmm.bernmm_bern_rat
    [23 tests, 2 failures, 0.79 s]
----------------------------------------------------------------------
sage -t --long --warn-long 34.4 src/sage/rings/bernmm.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 1.2 seconds
    cumulative wall time: 0.8 seconds
Mirage:sage-6.8.beta5 fbissey$ ./sage -t --long --warn-long 34.4 src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst
Running doctests with ID 2015-07-07-19-02-58-71d664dd.
Git branch: ntl92
Using --optional=gcc,mpir,python2,sage,scons
Doctesting 1 file.
sage -t --long --warn-long 34.4 src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst
**********************************************************************
File "src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst", line 212, in doc.en.thematic_tutorials.explicit_methods_in_number_theory.birds_other
Warning, slow doctest:
    w2 = bernoulli(100000, algorithm='pari')   # long time (6s on sage.math, 2011)
Test ran for 55.38 s
**********************************************************************
File "src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst", line 213, in doc.en.thematic_tutorials.explicit_methods_in_number_theory.birds_other
Failed example:
    w1 == w2  # long time
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  42 in doc.en.thematic_tutorials.explicit_methods_in_number_theory.birds_other
    [34 tests, 1 failure, 62.40 s]
----------------------------------------------------------------------
sage -t --long --warn-long 34.4 src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 62.4 seconds
    cpu time: 67.9 seconds
    cumulative wall time: 62.4 seconds
```



---

Comment by jpflori created at 2015-07-07 10:04:31

You get the same errors as I do.

And I cannot get NTL to build with `NTL_LEGACY_SP_MULMOD=on` to check that the old `double` implem is still fine.
Build fails with `#if with no expression` just as in #3486 or https://groups.google.com/forum/#!topic/sage-devel/4r8HrQVOSe4


---

Comment by jpflori created at 2015-07-07 10:06:22

For info, the corresponding part of NTL doc is at:
* http://www.shoup.net/ntl/doc/ZZ.cpp.html#modarith


---

Comment by jpflori created at 2015-07-07 10:55:17

My inability to try `NTL_LEGACY_SP_MULMOD` is caused by the fact that `InitSettings` does not build when it is set because of the typo:

```
 static inline long MulMod2(long a, long b, long n, wide_double bninv)
{
   return MulMod2_legacy(a, b, n, ninv);
}
```



---

Comment by fbissey created at 2015-07-07 10:59:44

Upstream bug then.


---

Comment by git created at 2015-07-07 11:03:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-07-07 11:05:35

Replying to [comment:21 fbissey]:
> Upstream bug then.
Sure, I just sent a report to Victor Shoup.

Note that it does not explain the failure in `bernmm` code with the new sp implem in (new) NTL.
It will just allow us to check that `bernmm` works as expected with the old sp implem in (new) NTL.


---

Comment by jpflori created at 2015-07-07 11:13:57

And it works just fine.

You can try NTL built with the legacy sp implem at `u/jpflori/ticket/18845legacy`.


---

Comment by jpflori created at 2015-07-07 11:14:19

Replying to [comment:23 jpflori]:
> Replying to [comment:21 fbissey]:
> > Upstream bug then.
> Sure, I just sent a report to Victor Shoup.
> 
And he will fix it asap.


---

Comment by jdemeyer created at 2015-07-07 12:24:46

Do you think you can fix the `bernmm` problem? If not, using the old the "legacy" implementation is better than not merging this ticket.


---

Comment by jdemeyer created at 2015-07-07 12:26:49

If this is true:

```
NTL provides its own error callback framework
```

we should use it.


---

Comment by jdemeyer created at 2015-07-07 12:35:32

OK, we still need the patch to the callback, but not for the reason stated. So, please
replace

```
NTL provides its own error callback framework, but it is simpler
than the one provided by this patch: there is no context object.
```

by

```
NTL provides its own error callback framework, but it's not suitable
for Sage since we don't want to see the error message printed, we want
the error message to be part of the callback function.
```



---

Comment by jdemeyer created at 2015-07-07 12:48:11

I just sent an e-mail to Shoup about the callback function.


---

Comment by jpflori created at 2015-07-07 13:01:27

Replying to [comment:26 jdemeyer]:
> Do you think you can fix the `bernmm` problem? If not, using the old the "legacy" implementation is better than not merging this ticket.
I'd say not quickly and I'm away for one week starting tonight.

I really have no idea why it does not work with the current patch.
The only way I see to understand this is to print everything bern_modp does to find the problem.
A small couple of problematic values is `k = 128` and `p = 7` (or another small prime).

So unless you see some obvious mistake in what I did, we can postpone the use of the new (and recommended upstream) sp implem for later.
We'll just need to remove one line in `spkg-install`.


---

Comment by jpflori created at 2015-07-07 13:03:02

Replying to [comment:29 jdemeyer]:
> I just sent an e-mail to Shoup about the callback function.
Thanks, I already mentioned that twice during our exchanges with Shoup but never really explained to him the difference between our and his error callback.

If by any chance you know why the `C++ new` patch for Singular is needed, I'd be happy you tell Shoup and I.


---

Comment by jpflori created at 2015-07-07 13:03:54

Also note that NTL now provides exception handling though I've not activated it here.


---

Comment by git created at 2015-07-07 13:06:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-07-07 13:07:19

Replying to [comment:28 jdemeyer]:
> OK, we still need the patch to the callback, but not for the reason stated. So, please
> replace
> {{{
> NTL provides its own error callback framework, but it is simpler
> than the one provided by this patch: there is no context object.
> }}}
> by
> {{{
> NTL provides its own error callback framework, but it's not suitable
> for Sage since we don't want to see the error message printed, we want
> the error message to be part of the callback function.
> }}}
Done.

I've also merged the changes from the legacy branch.


---

Comment by git created at 2015-07-07 13:37:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-07-07 13:59:15

Shoup answered that he will update the callback function such that it will be good enough for Sage.


---

Comment by jpflori created at 2015-07-07 15:53:48

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-07-07 17:09:23


```
Traceback (most recent call last):
  File "/usr/local/src/sage-config/src/doc/common/builder.py", line 1619, in <module>
    import sage.all
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/all.py", line 103, in <module>
    import sage.symbolic.pynac
ImportError: /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/symbolic/pynac.so: undefined symbol: _ZN3NTL5ErrorEPKc
```



---

Comment by jdemeyer created at 2015-07-07 17:09:23

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-07-07 17:32:37

It's a dependency problem: that module should depend on NTL, but it doesn't.


---

Comment by jpflori created at 2015-07-07 17:33:08

Strange:

```
[sage.git]$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath Version 6.8.beta7, Release Date: 2015-07-02               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import sage.symbolic.pynac
sage:
```

and

```
[sage.git]$ nm local/lib/python/site-packages/sage/symbolic/pynac.so |grep NTL
000000000000c610 t 00000058.plt_call._ZN3NTL13TerminalErrorEPKc+0
000000000000d088 t 00000058.plt_call._ZN3NTL14BlockConstructEPNS_4ZZ_pEl+0
000000000000ca20 t 00000058.plt_call._ZN3NTL3VecINS_4ZZ_pEE10AllocateToEl+0
000000000000c7a0 t 00000058.plt_call._ZN3NTL3VecINS_5ZZ_pEEE10AllocateToEl+0
000000000000d074 t 00000058.plt_call._ZN3NTL5ZZ_pX9normalizeEv+0
000000000000c55c t 00000058.plt_call._ZN3NTL6ZZ_pEX9normalizeEv+0
000000000000c764 t 00000058.plt_call._ZNK3NTL11ZZ_pContext7restoreEv+0
0000000000078cf0 D _Z19ZZ_pEX_conv_modulusRN3NTL6ZZ_pEXERKS0_RKNS_11ZZ_pContextE
                 U _ZN3NTL13TerminalErrorEPKc
                 U _ZN3NTL14BlockConstructEPNS_4ZZ_pEl
0000000000078cd0 W _ZN3NTL3VecINS_4ZZ_pEE10AllocateToEl
0000000000078ce0 W _ZN3NTL3VecINS_5ZZ_pEEE10AllocateToEl
                 U _ZN3NTL5ZZ_pX9normalizeEv
                 U _ZN3NTL6ZZ_pEX9normalizeEv
                 U _ZN3NTL8ZZ_pInfoE
                 U _ZNK3NTL11ZZ_pContext7restoreEv
```


Plain `Error` does not exist anymore in NTL 9.x.


---

Comment by jpflori created at 2015-07-07 17:35:45

Replying to [comment:39 jdemeyer]:
> It's a dependency problem: that module should depend on NTL, but it doesn't.
I see.
Can you fix this or should I do it?


---

Comment by jdemeyer created at 2015-07-07 17:59:56

Hmm, it's strange that this module isn't actually linked against `ntl`:

```
g++ -pthread -shared -L/usr/local/src/sage-config/local/lib build/temp.linux-x86_64-2.7/usr/local/src/sage-config/src/build/cythonized/sage/symbolic/pynac.o -L/usr/local/src/sage-config/local/lib -L/usr/local/src/sage-config/local/lib -lgsl -lgmp -lcblas -latlas -lpynac -lstdc++ -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/symbolic/pynac.so
```



---

Comment by jdemeyer created at 2015-07-07 18:12:29

I'm lost here... regardless of this ticket, the module `sage.symbolic.pynac` is _not_ linked against NTL, but it does contain those NTL symbols.


---

Comment by jpflori created at 2015-07-07 22:15:27

C++ templates black magic ? :)

Actually I had a quick look at the pyx file and found nothing about NTL...


---

Comment by fbissey created at 2015-07-07 22:25:56

Had a quick look earlier this morning, the only way `ntl` can get pulled is by a chain of include files that are not obvious to follow. `sage.symbolic.pynac` import some stuff from `sage.rings` and I think something in `rings.pxd` import some `ntl` stuff eventually. I will look for where precise `NTL` symbols are used next.


---

Comment by jpflori created at 2015-07-07 22:30:17

I'll be in a hidden valley for one week and though I might reply here, I won't have any ssh connection and any chance to fix this, so feel free to close the ticket without my help!


---

Comment by jdemeyer created at 2015-07-08 06:00:03

It seems that the module is really underlinked:

```
$ ./sage --python
Python 2.7.9 (default, Jul  5 2015, 21:49:10) 
[GCC 4.8.4] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import sage.symbolic.pynac
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ImportError: /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/symbolic/pynac.so: undefined symbol: _ZN3NTL8ZZ_pInfoE
```

The only reason there is no error in Sage is that NTL was imported before (by some other module imported earlier).


---

Comment by jdemeyer created at 2015-07-08 08:26:54

There are _many_ modules with the same linking problem. I think it's pointless to fix that problem without cleaning up the whole NTL interface (which is a big mess).

That leaves the problem of the dependency checking: I opened #18866 for that.


---

Comment by jdemeyer created at 2015-07-08 09:29:58

New commits:


---

Comment by git created at 2015-07-08 09:41:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-07-08 12:57:52

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-07-08 12:57:52

All doctests pass (but I haven't actually reviewed the changes)


---

Comment by vbraun created at 2015-07-08 22:53:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-09 19:55:55

Resolution: fixed


---

Comment by jdemeyer created at 2015-07-09 20:43:30

Follow-up: #18875
