# Issue 19403: Do not drop LDFLAGS

Issue created by migration from https://trac.sagemath.org/ticket/19640

Original creator: vbraun

Original creation time: 2015-11-29 12:46:10

CC:  jdemeyer fbissey




---

Comment by vbraun created at 2015-11-29 12:55:37

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-11-29 12:55:37

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2015-11-29 12:55:37

New commits:


---

Comment by vbraun created at 2015-11-29 12:55:37

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by vbraun created at 2015-11-29 12:56:23

This fixes everything except Singular, I think. The latter seems more complicated, so let's leave it for a different ticket.


---

Comment by fbissey created at 2015-11-29 20:45:04

Looks ok but begs the question for a separate ticket: Do we still need those `SAGE64` sections? If so why? Otherwise it looks good to me. But this is the only place for `singular` with `LDFLAGS`

```
if [ "x$SAGE64" = xyes ]; then
    echo "Building a 64-bit version of Singular"
    CFLAGS="$CFLAGS -m64 "
    CXXFLAGS="$CXXFLAGS -m64"
    CPPFLAGS="$CPPFLAGS -m64"
    LDFLAGS="$LDFLAGS -m64 "; export LDFLAGS
    if [ "x`uname`" = xSunOS ] ; then
        export CC="$CC -m64"
        export CXX="$CXX -m64"
    fi
fi
```

so it is not any harder that the others and it should already be OK. If it isn't, I'll be interested in a build log.


---

Comment by vbraun created at 2015-11-29 21:42:05

Singular doesn't respect those LDFLAGS, I tried ;-)

I have no idea about the SAGE64 stuff. My guess is no and that it has always been a bad idea to copy-paste the same stuff in every spkg-install script, though thats material for another ticket.


---

Comment by git created at 2015-11-29 21:50:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-11-29 21:53:24

I looked through the Singular configure/makefile and the only environment variable that we can used is CXX/LD. I'm not proud of the resulting hack but it does work ;-)


---

Comment by vbraun created at 2015-11-29 21:54:02

Hopefully the situation is better in Singular-4, though thats yet another ticket...


---

Comment by fbissey created at 2015-11-29 22:11:37

I thought I had a patch for `singular` now that I come to think of it, but it must have been dropped at some point. Looking at the corresponding gentoo ebuild the problem is probably similar. Internally `singular` uses `SLDFLAGS` for its linking flags (you can see that kind of stuff in one of the singular patch I wrote for using `CXX` for linking) I'll have to dig how it is defined but that would be another patch. We can ship your solution now or I can write a patch.


---

Comment by vbraun created at 2015-11-29 22:13:43

I saw the SLDFLAGS, but they aren't initialized with LDFLAGS :-(

I don't think there is much point in spending time cleaning up singular-3 though...


---

Comment by fbissey created at 2015-11-29 22:19:41

It's just a mess

```
Singular/Makefile.in:SLDFLAGS   = @SLDFLAGS@
Singular/Makefile.in:   $(LIBSINGULAR_LD) ${SLDFLAGS} ${LIBSINGULAR_FLAGS} -o libsingular.${SO_SUFFIX} \
Singular/Makefile.in:   $(LD) ${SLDFLAGS} -o $@ $^ -L${libdir} ${MP_LIBS} ${GLIBC_DYN_FIX}
Singular/Makefile.in:   $(LD) ${SLDFLAGS} -o $@ $^ ${GLIBC_DYN_FIX}
Singular/Makefile.in:   $(CXX) $^ ${PYTHON_MODULE_LDFLAGS} ${SLDFLAGS} ${PYTHON_MODULE_LIBS} ${LD_LIBC} -o $@
Singular/Makefile.in:   ${CXXG} ${CXXFLAGSG} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $@ $^ ${MP_LIBS} ${GLIBC_DYN_FIX}
Singular/Makefile.in:   ${CXXG} ${CXXFLAGSG} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $@ $^ ${MP_LIBS}
Singular/Makefile.in:   ${CXXP} ${CXXFLAGSP} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $@ $^ ${MP_LIBS} ${GLIBC_DYN_FIX}
Singular/Makefile.in:   ${CXXP} ${CXXFLAGSP} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $@ $^ ${MP_LIBS}
kernel/Makefile.in:SLDFLAGS     = @SLDFLAGS@
kernel/Makefile.in:     $(LD) ${SLDFLAGS} -o $@ $^
kernel/Makefile.in:     $(LD) ${SLDFLAGS} -o $@ $^
kernel/Makefile.in:     ${CXXP} ${CXXFLAGSP} ${SFLAGS} ${SLDFLAGS} $< -o $@
```

Some bits of `singular` are using `LDFLAGS` but we would need to add it wherever it is missing above, at least wherever `LD` is called. A quick `sed` from `$(LD) ${SLDFLAGS}` to `$(LD) ${SLDFLAGS} ${LDFLAGS}` should do.


---

Comment by fbissey created at 2015-11-29 22:37:57

And I was going to forget that little piece of underhanded linker definition in `Singular/Makefile.in`

```
LIBSINGULAR_LD = $(CXX)

# correct suffix for dynamic linking
ifeq ($(SINGUNAME),ix86Mac-darwin)
SO_SUFFIX        = dylib
MODULE_SUFFIX    = bundle
LIBSINGULAR_FLAGS = -single_module
LIBSINGULAR_LD = $(LD)
endif

ifeq ($(SINGUNAME),x86_64Mac-darwin)
SO_SUFFIX        = dylib
MODULE_SUFFIX    = bundle
LIBSINGULAR_FLAGS = -single_module
LIBSINGULAR_LD = $(LD)
endif
```

and

```
libsingular: mod2.h Makefile version.h $(WIN_LIBS) scanner.cc  ${OBJS} \
         iparith.o libparse.cc claptmpl.o mpsr_Tok.o $(DL_LIBS) 
	$(LIBSINGULAR_LD) ${SLDFLAGS} ${LIBSINGULAR_FLAGS} -o libsingular.${SO_SUFFIX} \
	iparith.o mpsr_Tok.o claptmpl.o \
	${OBJS} -lkernel -L../kernel -L../factory -L../libfac -L${libdir} ${LIBSINGULAR_LIBS}
```



---

Comment by fbissey created at 2015-11-29 22:45:13

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-11-29 22:45:13

I'll leave yours as the best of a bad lot. One of the problem with the fix is that if `LDFLAGS` contains naked linker commands (such as `-rpath`) it will fail on linux because `CXX` is used for linking, therefore linker commands should be preceded by `-Wl`. 
No matter of patching will fix that particular problem. `libtool` should have been used all the way really, not just here and there.


---

Comment by fbissey created at 2015-11-29 23:15:44

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2015-11-29 23:15:44

Actually, after reviewing some logs, we use `CXX` on OS X as well. My patch to use `CXX` instead of `ld` covers that, in fact I had to change some more stuff so it would work on OS X. So #19641 will work on OS X without doing some kind of filtering, that would have been the case otherwise. But on the other hand that means

```
export LD="$LD $LDFLAGS"     # Used on Darwin
```

is useless, as is the comment about linux on the line before.


---

Comment by git created at 2015-11-30 09:10:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-11-30 09:17:22

Looks good to me, if you have nothing to add, it is positive review from me.


---

Comment by vbraun created at 2015-11-30 09:19:44

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-11-30 23:09:32

Resolution: fixed


---

Comment by leif created at 2015-12-13 14:07:11

Replying to [comment:11 fbissey]:
> It's just a mess
> {{{
> Singular/Makefile.in:SLDFLAGS   = `@`SLDFLAGS`@`
> Singular/Makefile.in:   $(LIBSINGULAR_LD) ${SLDFLAGS} ${LIBSINGULAR_FLAGS} -o libsingular.${SO_SUFFIX} \
> Singular/Makefile.in:   $(LD) ${SLDFLAGS} -o $`@` $^ -L${libdir} ${MP_LIBS} ${GLIBC_DYN_FIX}
> Singular/Makefile.in:   $(LD) ${SLDFLAGS} -o $`@` $^ ${GLIBC_DYN_FIX}
> Singular/Makefile.in:   $(CXX) $^ ${PYTHON_MODULE_LDFLAGS} ${SLDFLAGS} ${PYTHON_MODULE_LIBS} ${LD_LIBC} -o $`@`
> Singular/Makefile.in:   ${CXXG} ${CXXFLAGSG} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $`@` $^ ${MP_LIBS} ${GLIBC_DYN_FIX}
> Singular/Makefile.in:   ${CXXG} ${CXXFLAGSG} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $`@` $^ ${MP_LIBS}
> Singular/Makefile.in:   ${CXXP} ${CXXFLAGSP} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $`@` $^ ${MP_LIBS} ${GLIBC_DYN_FIX}
> Singular/Makefile.in:   ${CXXP} ${CXXFLAGSP} ${SFLAGS} ${SLDFLAGS} ${LDFLAGS} -o $`@` $^ ${MP_LIBS}
> kernel/Makefile.in:SLDFLAGS     = `@`SLDFLAGS`@`
> kernel/Makefile.in:     $(LD) ${SLDFLAGS} -o $`@` $^
> kernel/Makefile.in:     $(LD) ${SLDFLAGS} -o $`@` $^
> kernel/Makefile.in:     ${CXXP} ${CXXFLAGSP} ${SFLAGS} ${SLDFLAGS} $< -o $`@`
> }}}
> Some bits of `singular` are using `LDFLAGS` but we would need to add it wherever it is missing above, at least wherever `LD` is called.

Nope, `LDFLAGS` are meant to be passed to the _compiler_, not directly to the linker.  (You'd frequently get syntax errors otherwise, because the linker doesn't necessarily take the same or all of the options.  The compiler in contrast passes anything it doesn't understand verbatim to the linker if applicable, so the opposite is not a problem.)


---

Comment by leif created at 2015-12-13 14:09:41

P.S.:  A while ago, a few occurrences of `LD` in Singular's Makefiles were actually hardcoded to `ld`.


---

Comment by vbraun created at 2015-12-13 14:24:54

Presumably things are better in Sigular-4, there isn't much point in beautifying anything before #17254 hits


---

Comment by leif created at 2015-12-13 14:26:40

Replying to [comment:4 fbissey]:
> Looks ok but begs the question for a separate ticket: Do we still need those `SAGE64` sections? If so why?

MacOS X used to default to 32-bit builds on 64-bit systems (until 10.6.x?); SunOS/Oraclis still does.

So in principle we still need the ugly `SAGE64` stuff (or should keep it for porting / to not break SunOS support further...).


---

Comment by leif created at 2015-12-13 14:29:06

Replying to [comment:21 vbraun]:
> Presumably things are better in Sigular-4, there isn't much point in beautifying anything before #17254 hits

Well, my impression was that Singular 4.x in Sage is rather a looong-term thing...


---

Comment by fbissey created at 2015-12-13 20:19:55

Replying to [comment:22 leif]:
> Replying to [comment:4 fbissey]:
> > Looks ok but begs the question for a separate ticket: Do we still need those `SAGE64` sections? If so why?
> 
> MacOS X used to default to 32-bit builds on 64-bit systems (until 10.6.x?); SunOS/Oraclis still does.
> 
> So in principle we still need the ugly `SAGE64` stuff (or should keep it for porting / to not break SunOS support further...).
> 

There are very few `SAGE64` sections left, so I am expecting it to be broken (because it would need more packages to have a `SAGE64` section) but I don't have a system to prove it. Also such a setting should centralised in one place rather than ditched in all spkg all over the place.
