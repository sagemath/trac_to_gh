# Issue 19007: Broken doctest in src/sage/categories/fields.py

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-09-19 10:53:45

CC:  robertwb nbruin simonking jpflori slabbe vdelecroix

Keywords: random_fail

The following doctest from #14058 breaks sometimes. I have seen it happen twice, but it's hard to reproduce:

```
sage -t --long src/sage/categories/fields.py
**********************************************************************
File "src/sage/categories/fields.py", line 104, in sage.categories.fields.Fields.__contains__
Failed example:
    len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n
Expected:
    0
Got:
    -1
**********************************************************************
```



---

Comment by SimonKing created at 2015-09-20 07:18:06

Changing status from new to needs_review.


---

Comment by SimonKing created at 2015-09-20 07:18:06

I have seen that repeatedly. I think at some point I suggested to test that the difference is not zero but is at most zero. Now I suggest a different solution.

We have seen the following phenomenon while we introduced Sage's weak coercion dictionaries. It is possible that `gc.collect()` collects some objects, and by this collection *other* objects become collectable, which however will only be collected during a subsequent cyclic garbage collection. One can construct examples such that n cyclic garbage collections will not collect a certain object, but the (n+1)-st cyclic garbage collection *will* collect it.

It could be that we see this phenomenon here in real life. I.e., it could be that the two `gc.collect()` commands in the test do not make a certain field collectable that was created in a different doctest. However, a third collection step that may or may not happen in the for-loop does make it collectable.

Thus, depending on whether or not a third collection happens, we see a failure or not.

If my explanation is correct, then disabling the garbage collection till we really want it to happen should fix the test permanently.

----
New commits:


---

Comment by SimonKing created at 2015-09-20 07:18:06

Changing component from categories to memleak.


---

Comment by SimonKing created at 2015-09-20 07:39:10

The following approach might be even more stable.

What do we want to test? We want to test that the NEWLY created fields can be garbage collected.

What happens if the test fails? There is an additional garbage collection of a PREVIOUSLY created field.

Hence, we must temporarily prevent all PREVIOUSLY created but uncollected objects from garbage collection.

This could be done by storing the output of gc.get_object() in a variable. It creates strong references to all previously created uncollected objects and will thus make the test stable.

What solution do you prefer? I prefer the second solution, since I am not sure whether the theory behind my previous solution is correct.


---

Comment by jdemeyer created at 2015-09-20 07:41:59

Replying to [comment:3 SimonKing]:
> This could be done by storing the output of gc.get_object() in a variable. It creates strong references to all previously created uncollected objects and will thus make the test stable.
> 
> What solution do you prefer? I prefer the second solution, since I am not sure whether the theory behind my previous solution is correct.

I agree.


---

Comment by jdemeyer created at 2015-09-20 07:41:59

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-09-20 07:46:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-09-20 07:48:07

Make your choice :-)


---

Comment by SimonKing created at 2015-09-20 07:48:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-20 13:01:21

What's the point of this?

```diff
+            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) > n
+            True
```



---

Comment by SimonKing created at 2015-09-20 13:24:57

Replying to [comment:7 jdemeyer]:
> What's the point of this?
> {{{
> #!diff
> +            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) > n
> +            True
> }}}

At time t, we determine the number n of fields in cache. At time t+2 we test that the number of fields in cache is again n. With the above line, I want to demonstrate that at time t+1, we really have more rings in cache than at time t. Otherwise, we actually haven't shown that a garbage collection has happened between time t+1 and time t+2. And that's the aim of the whole test: We have to show that at some point a ring exists and later it has vanished. The line shows that the ring exists.


---

Comment by jdemeyer created at 2015-09-20 14:29:17

Could you add some text in the doctest to explain what you just explained here?


---

Comment by jdemeyer created at 2015-09-20 14:29:17

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-09-20 14:41:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-09-20 14:41:33

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-20 17:50:58

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-09-20 17:50:58

Since the old broken doctest is hard to reproduce, I can't say for sure if this fixes it. But at least I believe your analysis.


---

Comment by vbraun created at 2015-09-22 14:49:17

Resolution: fixed
