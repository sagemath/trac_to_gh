# Issue 19007: Broken doctest in src/sage/categories/fields.py

archive/issues_019007.json:
```json
{
    "body": "CC:  robertwb nbruin simonking jpflori slabbe vdelecroix\n\nKeywords: random_fail\n\nThe following doctest from #14058 breaks sometimes. I have seen it happen twice, but it's hard to reproduce:\n\n```\nsage -t --long src/sage/categories/fields.py\n**********************************************************************\nFile \"src/sage/categories/fields.py\", line 104, in sage.categories.fields.Fields.__contains__\nFailed example:\n    len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n\nExpected:\n    0\nGot:\n    -1\n**********************************************************************\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19244\n\n",
    "created_at": "2015-09-19T10:53:45Z",
    "labels": [
        "categories",
        "blocker",
        "bug"
    ],
    "title": "Broken doctest in src/sage/categories/fields.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19007",
    "user": "jdemeyer"
}
```
CC:  robertwb nbruin simonking jpflori slabbe vdelecroix

Keywords: random_fail

The following doctest from #14058 breaks sometimes. I have seen it happen twice, but it's hard to reproduce:

```
sage -t --long src/sage/categories/fields.py
**********************************************************************
File "src/sage/categories/fields.py", line 104, in sage.categories.fields.Fields.__contains__
Failed example:
    len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n
Expected:
    0
Got:
    -1
**********************************************************************
```


Issue created by migration from https://trac.sagemath.org/ticket/19244





---

archive/issue_comments_260745.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-20T07:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260745",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_260746.json:
```json
{
    "body": "I have seen that repeatedly. I think at some point I suggested to test that the difference is not zero but is at most zero. Now I suggest a different solution.\n\nWe have seen the following phenomenon while we introduced Sage's weak coercion dictionaries. It is possible that `gc.collect()` collects some objects, and by this collection *other* objects become collectable, which however will only be collected during a subsequent cyclic garbage collection. One can construct examples such that n cyclic garbage collections will not collect a certain object, but the (n+1)-st cyclic garbage collection *will* collect it.\n\nIt could be that we see this phenomenon here in real life. I.e., it could be that the two `gc.collect()` commands in the test do not make a certain field collectable that was created in a different doctest. However, a third collection step that may or may not happen in the for-loop does make it collectable.\n\nThus, depending on whether or not a third collection happens, we see a failure or not.\n\nIf my explanation is correct, then disabling the garbage collection till we really want it to happen should fix the test permanently.\n\n----\nNew commits:",
    "created_at": "2015-09-20T07:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260746",
    "user": "SimonKing"
}
```

I have seen that repeatedly. I think at some point I suggested to test that the difference is not zero but is at most zero. Now I suggest a different solution.

We have seen the following phenomenon while we introduced Sage's weak coercion dictionaries. It is possible that `gc.collect()` collects some objects, and by this collection *other* objects become collectable, which however will only be collected during a subsequent cyclic garbage collection. One can construct examples such that n cyclic garbage collections will not collect a certain object, but the (n+1)-st cyclic garbage collection *will* collect it.

It could be that we see this phenomenon here in real life. I.e., it could be that the two `gc.collect()` commands in the test do not make a certain field collectable that was created in a different doctest. However, a third collection step that may or may not happen in the for-loop does make it collectable.

Thus, depending on whether or not a third collection happens, we see a failure or not.

If my explanation is correct, then disabling the garbage collection till we really want it to happen should fix the test permanently.

----
New commits:



---

archive/issue_comments_260747.json:
```json
{
    "body": "Changing component from categories to memleak.",
    "created_at": "2015-09-20T07:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260747",
    "user": "SimonKing"
}
```

Changing component from categories to memleak.



---

archive/issue_comments_260748.json:
```json
{
    "body": "The following approach might be even more stable.\n\nWhat do we want to test? We want to test that the NEWLY created fields can be garbage collected.\n\nWhat happens if the test fails? There is an additional garbage collection of a PREVIOUSLY created field.\n\nHence, we must temporarily prevent all PREVIOUSLY created but uncollected objects from garbage collection.\n\nThis could be done by storing the output of gc.get_object() in a variable. It creates strong references to all previously created uncollected objects and will thus make the test stable.\n\nWhat solution do you prefer? I prefer the second solution, since I am not sure whether the theory behind my previous solution is correct.",
    "created_at": "2015-09-20T07:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260748",
    "user": "SimonKing"
}
```

The following approach might be even more stable.

What do we want to test? We want to test that the NEWLY created fields can be garbage collected.

What happens if the test fails? There is an additional garbage collection of a PREVIOUSLY created field.

Hence, we must temporarily prevent all PREVIOUSLY created but uncollected objects from garbage collection.

This could be done by storing the output of gc.get_object() in a variable. It creates strong references to all previously created uncollected objects and will thus make the test stable.

What solution do you prefer? I prefer the second solution, since I am not sure whether the theory behind my previous solution is correct.



---

archive/issue_comments_260749.json:
```json
{
    "body": "Replying to [comment:3 SimonKing]:\n> This could be done by storing the output of gc.get_object() in a variable. It creates strong references to all previously created uncollected objects and will thus make the test stable.\n> \n> What solution do you prefer? I prefer the second solution, since I am not sure whether the theory behind my previous solution is correct.\n\nI agree.",
    "created_at": "2015-09-20T07:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260749",
    "user": "jdemeyer"
}
```

Replying to [comment:3 SimonKing]:
> This could be done by storing the output of gc.get_object() in a variable. It creates strong references to all previously created uncollected objects and will thus make the test stable.
> 
> What solution do you prefer? I prefer the second solution, since I am not sure whether the theory behind my previous solution is correct.

I agree.



---

archive/issue_comments_260750.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-20T07:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260750",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_260751.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-20T07:46:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260751",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260752.json:
```json
{
    "body": "Make your choice :-)",
    "created_at": "2015-09-20T07:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260752",
    "user": "SimonKing"
}
```

Make your choice :-)



---

archive/issue_comments_260753.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-20T07:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260753",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_260754.json:
```json
{
    "body": "What's the point of this?\n\n```diff\n+            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) > n\n+            True\n```\n",
    "created_at": "2015-09-20T13:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260754",
    "user": "jdemeyer"
}
```

What's the point of this?

```diff
+            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) > n
+            True
```




---

archive/issue_comments_260755.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> What's the point of this?\n> {{{\n> #!diff\n> +            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) > n\n> +            True\n> }}}\n\nAt time t, we determine the number n of fields in cache. At time t+2 we test that the number of fields in cache is again n. With the above line, I want to demonstrate that at time t+1, we really have more rings in cache than at time t. Otherwise, we actually haven't shown that a garbage collection has happened between time t+1 and time t+2. And that's the aim of the whole test: We have to show that at some point a ring exists and later it has vanished. The line shows that the ring exists.",
    "created_at": "2015-09-20T13:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260755",
    "user": "SimonKing"
}
```

Replying to [comment:7 jdemeyer]:
> What's the point of this?
> {{{
> #!diff
> +            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) > n
> +            True
> }}}

At time t, we determine the number n of fields in cache. At time t+2 we test that the number of fields in cache is again n. With the above line, I want to demonstrate that at time t+1, we really have more rings in cache than at time t. Otherwise, we actually haven't shown that a garbage collection has happened between time t+1 and time t+2. And that's the aim of the whole test: We have to show that at some point a ring exists and later it has vanished. The line shows that the ring exists.



---

archive/issue_comments_260756.json:
```json
{
    "body": "Could you add some text in the doctest to explain what you just explained here?",
    "created_at": "2015-09-20T14:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260756",
    "user": "jdemeyer"
}
```

Could you add some text in the doctest to explain what you just explained here?



---

archive/issue_comments_260757.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-20T14:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260757",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_260758.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-20T14:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260758",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260759.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-20T14:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260759",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_260760.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-20T17:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260760",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_260761.json:
```json
{
    "body": "Since the old broken doctest is hard to reproduce, I can't say for sure if this fixes it. But at least I believe your analysis.",
    "created_at": "2015-09-20T17:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260761",
    "user": "jdemeyer"
}
```

Since the old broken doctest is hard to reproduce, I can't say for sure if this fixes it. But at least I believe your analysis.



---

archive/issue_comments_260762.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-22T14:49:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19007#issuecomment-260762",
    "user": "vbraun"
}
```

Resolution: fixed
