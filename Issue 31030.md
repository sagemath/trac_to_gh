# Issue 31030: python 3.8.5 subpackage does not build

archive/issues_031030.json:
```json
{
    "body": "CC:  @dimpase @zlscherr @kliem\n\nrunning on Ubuntu 18.04\n\nconfig-log and build-log is attached.\n\nThe bug seems to have something to do with this error message:\n\n[python3-3.8.5] Following modules built successfully but were removed because they could not be imported:\n[python3-3.8.5] readline\n\nIssue created by migration from https://trac.sagemath.org/ticket/31267\n\n",
    "created_at": "2021-01-20T01:00:55Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "python 3.8.5 subpackage does not build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31030",
    "user": "@guenterrote"
}
```
CC:  @dimpase @zlscherr @kliem

running on Ubuntu 18.04

config-log and build-log is attached.

The bug seems to have something to do with this error message:

[python3-3.8.5] Following modules built successfully but were removed because they could not be imported:
[python3-3.8.5] readline

Issue created by migration from https://trac.sagemath.org/ticket/31267





---

archive/issue_comments_443223.json:
```json
{
    "body": "python build logfile",
    "created_at": "2021-01-20T01:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443223",
    "user": "@guenterrote"
}
```

python build logfile



---

archive/issue_comments_443224.json:
```json
{
    "body": "Attachment [python3-3.8.5.log](tarball://root/attachments/some-uuid/ticket31267/python3-3.8.5.log) by @guenterrote created at 2021-01-20 01:04:03\n\nconfig.log",
    "created_at": "2021-01-20T01:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443224",
    "user": "@guenterrote"
}
```

Attachment [python3-3.8.5.log](tarball://root/attachments/some-uuid/ticket31267/python3-3.8.5.log) by @guenterrote created at 2021-01-20 01:04:03

config.log



---

archive/issue_comments_443225.json:
```json
{
    "body": "Attachment [config.log](tarball://root/attachments/some-uuid/ticket31267/config.log) by @guenterrote created at 2021-01-20 01:05:00",
    "created_at": "2021-01-20T01:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443225",
    "user": "@guenterrote"
}
```

Attachment [config.log](tarball://root/attachments/some-uuid/ticket31267/config.log) by @guenterrote created at 2021-01-20 01:05:00



---

archive/issue_comments_443226.json:
```json
{
    "body": "From `python3...log`:\n\n```\nchecking for getc_unlocked() and friends... yes\nchecking how to link readline libs... -lreadline -ltinfo\n...\n```\n\nbut when python3 actually links readline, it is doing something else:\n\n```\nbuilding 'readline' extension\ngcc -pthread -fPIC -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -O2 -g -march=native -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration -I./Include/internal -I./Include -I/home/rote/Dokumente/Software/sage/local/include -I. -I/usr/include/x86_64-linux-gnu -I/usr/local/include -I/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Include -I/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src -c /home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Modules/readline.c -o build/temp.linux-x86_64-3.8/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Modules/readline.o\ngcc -pthread -shared -Wl,-rpath-link,/home/rote/Dokumente/Software/sage/local/lib -L/home/rote/Dokumente/Software/sage/local/lib -Wl,-rpath,/home/rote/Dokumente/Software/sage/local/lib -L. -Wl,-rpath-link,/home/rote/Dokumente/Software/sage/local/lib -L/home/rote/Dokumente/Software/sage/local/lib -Wl,-rpath,/home/rote/Dokumente/Software/sage/local/lib -L. -Wl,-rpath-link,/home/rote/Dokumente/Software/sage/local/lib -L/home/rote/Dokumente/Software/sage/local/lib -Wl,-rpath,/home/rote/Dokumente/Software/sage/local/lib build/temp.linux-x86_64-3.8/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Modules/readline.o -L/usr/lib/termcap -L. -L/home/rote/Dokumente/Software/sage/local/lib -L/usr/lib/x86_64-linux-gnu -L/usr/local/lib -lreadline -lncursesw -o build/lib.linux-x86_64-3.8/readline.cpython-38-x86_64-linux-gnu.so\n```\n\n\nYou could check if uninstalling `libncursesw5-dev` solves this problem",
    "created_at": "2021-01-20T01:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443226",
    "user": "@mkoeppe"
}
```

From `python3...log`:

```
checking for getc_unlocked() and friends... yes
checking how to link readline libs... -lreadline -ltinfo
...
```

but when python3 actually links readline, it is doing something else:

```
building 'readline' extension
gcc -pthread -fPIC -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -O2 -g -march=native -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration -I./Include/internal -I./Include -I/home/rote/Dokumente/Software/sage/local/include -I. -I/usr/include/x86_64-linux-gnu -I/usr/local/include -I/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Include -I/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src -c /home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Modules/readline.c -o build/temp.linux-x86_64-3.8/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Modules/readline.o
gcc -pthread -shared -Wl,-rpath-link,/home/rote/Dokumente/Software/sage/local/lib -L/home/rote/Dokumente/Software/sage/local/lib -Wl,-rpath,/home/rote/Dokumente/Software/sage/local/lib -L. -Wl,-rpath-link,/home/rote/Dokumente/Software/sage/local/lib -L/home/rote/Dokumente/Software/sage/local/lib -Wl,-rpath,/home/rote/Dokumente/Software/sage/local/lib -L. -Wl,-rpath-link,/home/rote/Dokumente/Software/sage/local/lib -L/home/rote/Dokumente/Software/sage/local/lib -Wl,-rpath,/home/rote/Dokumente/Software/sage/local/lib build/temp.linux-x86_64-3.8/home/rote/Dokumente/Software/sage/local/var/tmp/sage/build/python3-3.8.5/src/Modules/readline.o -L/usr/lib/termcap -L. -L/home/rote/Dokumente/Software/sage/local/lib -L/usr/lib/x86_64-linux-gnu -L/usr/local/lib -lreadline -lncursesw -o build/lib.linux-x86_64-3.8/readline.cpython-38-x86_64-linux-gnu.so
```


You could check if uninstalling `libncursesw5-dev` solves this problem



---

archive/issue_comments_443227.json:
```json
{
    "body": "https://github.com/python/cpython/blob/master/configure.ac#L4887 checks it in the order `\"\" tinfo ncursesw ncurses curses termcap`\n\nhttps://github.com/python/cpython/blob/master/setup.py#L975 `detect_readline_curses` redoes the checks in a different way",
    "created_at": "2021-01-20T01:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443227",
    "user": "@mkoeppe"
}
```

https://github.com/python/cpython/blob/master/configure.ac#L4887 checks it in the order `"" tinfo ncursesw ncurses curses termcap`

https://github.com/python/cpython/blob/master/setup.py#L975 `detect_readline_curses` redoes the checks in a different way



---

archive/issue_comments_443228.json:
```json
{
    "body": "G\u00fcnter, on a typical linux machine, one would actually expect that `ncurses` and `readline` can be used and do not have to be built from scratch. So I would recommend to do `make ncurses-clean readline-clean` and then re-run `configure`. This should be more robust than the current configuration",
    "created_at": "2021-01-20T02:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443228",
    "user": "@mkoeppe"
}
```

Günter, on a typical linux machine, one would actually expect that `ncurses` and `readline` can be used and do not have to be built from scratch. So I would recommend to do `make ncurses-clean readline-clean` and then re-run `configure`. This should be more robust than the current configuration



---

archive/issue_comments_443229.json:
```json
{
    "body": "\n```\nroot@4d2478da7517:/sage# ldd local/lib/libreadline.so.8\n\tlinux-vdso.so.1 (0x00007ffc7a3c8000)\n\tlibc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fee30793000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fee30dd5000)\nroot@4d2478da7517:/sage# ldd /usr/lib/x86_64-linux-gnu/libreadline.so \n\tlinux-vdso.so.1 (0x00007ffe23ded000)\n\tlibtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007f100ed8d000)\n\tlibc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f100e99c000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f100f200000)\n```\n\nThe issue likely arises because `find_library_file` inspects the system library but then the Sage-built library is used for linking https://github.com/python/cpython/blob/master/setup.py#L977\n\nI think this is a limitation of distutils - it does not know about `LIBRARY_PATH`",
    "created_at": "2021-01-20T02:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443229",
    "user": "@mkoeppe"
}
```


```
root@4d2478da7517:/sage# ldd local/lib/libreadline.so.8
	linux-vdso.so.1 (0x00007ffc7a3c8000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fee30793000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fee30dd5000)
root@4d2478da7517:/sage# ldd /usr/lib/x86_64-linux-gnu/libreadline.so 
	linux-vdso.so.1 (0x00007ffe23ded000)
	libtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007f100ed8d000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f100e99c000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f100f200000)
```

The issue likely arises because `find_library_file` inspects the system library but then the Sage-built library is used for linking https://github.com/python/cpython/blob/master/setup.py#L977

I think this is a limitation of distutils - it does not know about `LIBRARY_PATH`



---

archive/issue_comments_443230.json:
```json
{
    "body": "I think this would need a similar fix as it needed in the packaging of python3 in homebrew...",
    "created_at": "2021-01-20T18:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443230",
    "user": "@mkoeppe"
}
```

I think this would need a similar fix as it needed in the packaging of python3 in homebrew...



---

archive/issue_comments_443231.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> G\u00fcnter, on a typical linux machine, one would actually expect that `ncurses` and `readline` can be used and do not have to be built from scratch. So I would recommend to do `make ncurses-clean readline-clean` and then re-run `configure`. This should be more robust than the current configuration \n\nI tried this; the python installation seemed to go through fine, but eventually the build failed.\n\n```\ncd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log\n[dochtml] Traceback (most recent call last):\n...\n[dochtml]   File \"sage/matrix/matrix_mpolynomial_dense.pyx\", line 1, in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)\n[dochtml] ImportError: libreadline.so.8: cannot open shared object file: No such file or directory\n```\n\nTrying to start sage anyway displays a nice banner but crashes with the same error\n\n```\n---------------------------------------------------------------------------\nImportErrorPython 3.8.5: /home/rote/Dokumente/Software/sage/local/bin/python3\n                                                   Thu Jan 21 07:42:55 2021\nA problem occurred executing Python code.  Here is the sequence of function\n...\n...\n~/Dokumente/Software/sage/local/lib/python3.8/site-packages/sage/matrix/matrix_mpolynomial_dense.pyx in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)()\n----> 1 \"\"\"\n      2 Dense matrices over multivariate polynomials over fields\n...\nImportError: libreadline.so.8: cannot open shared object file: No such file or directory\n```\n",
    "created_at": "2021-01-21T07:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443231",
    "user": "@guenterrote"
}
```

Replying to [comment:5 mkoeppe]:
> Günter, on a typical linux machine, one would actually expect that `ncurses` and `readline` can be used and do not have to be built from scratch. So I would recommend to do `make ncurses-clean readline-clean` and then re-run `configure`. This should be more robust than the current configuration 

I tried this; the python installation seemed to go through fine, but eventually the build failed.

```
cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
[dochtml] Traceback (most recent call last):
...
[dochtml]   File "sage/matrix/matrix_mpolynomial_dense.pyx", line 1, in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)
[dochtml] ImportError: libreadline.so.8: cannot open shared object file: No such file or directory
```

Trying to start sage anyway displays a nice banner but crashes with the same error

```
---------------------------------------------------------------------------
ImportErrorPython 3.8.5: /home/rote/Dokumente/Software/sage/local/bin/python3
                                                   Thu Jan 21 07:42:55 2021
A problem occurred executing Python code.  Here is the sequence of function
...
...
~/Dokumente/Software/sage/local/lib/python3.8/site-packages/sage/matrix/matrix_mpolynomial_dense.pyx in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)()
----> 1 """
      2 Dense matrices over multivariate polynomials over fields
...
ImportError: libreadline.so.8: cannot open shared object file: No such file or directory
```




---

archive/issue_comments_443232.json:
```json
{
    "body": "Replying to [comment:11 guenterrote]:\n> Replying to [comment:5 mkoeppe]:\n> > G\u00fcnter, on a typical linux machine, one would actually expect that `ncurses` and `readline` can be used and do not have to be built from scratch. So I would recommend to do `make ncurses-clean readline-clean` and then re-run `configure`. This should be more robust than the current configuration \n> \n> I tried this; the python installation seemed to go through fine, but eventually the build failed.\n> {{{\n> cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log\n> [dochtml] Traceback (most recent call last):\n> ...\n> [dochtml]   File \"sage/matrix/matrix_mpolynomial_dense.pyx\", line 1, in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)\n> [dochtml] ImportError: libreadline.so.8: cannot open shared object file: No such file or directory\n> }}}\n> Trying to start sage anyway displays a nice banner but crashes with the same error\n> {{{\n> ---------------------------------------------------------------------------\n> ImportErrorPython 3.8.5: /home/rote/Dokumente/Software/sage/local/bin/python3\n>                                                    Thu Jan 21 07:42:55 2021\n> A problem occurred executing Python code.  Here is the sequence of function\n> ...\n> ...\n> ~/Dokumente/Software/sage/local/lib/python3.8/site-packages/sage/matrix/matrix_mpolynomial_dense.pyx in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)()\n> ----> 1 \"\"\"\n>       2 Dense matrices over multivariate polynomials over fields\n> ...\n> ImportError: libreadline.so.8: cannot open shared object file: No such file or directory\n> }}}\n\nThis looks like `make singular-clean sagelib-clean build` could fix it",
    "created_at": "2021-01-21T08:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443232",
    "user": "@mkoeppe"
}
```

Replying to [comment:11 guenterrote]:
> Replying to [comment:5 mkoeppe]:
> > Günter, on a typical linux machine, one would actually expect that `ncurses` and `readline` can be used and do not have to be built from scratch. So I would recommend to do `make ncurses-clean readline-clean` and then re-run `configure`. This should be more robust than the current configuration 
> 
> I tried this; the python installation seemed to go through fine, but eventually the build failed.
> {{{
> cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
> [dochtml] Traceback (most recent call last):
> ...
> [dochtml]   File "sage/matrix/matrix_mpolynomial_dense.pyx", line 1, in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)
> [dochtml] ImportError: libreadline.so.8: cannot open shared object file: No such file or directory
> }}}
> Trying to start sage anyway displays a nice banner but crashes with the same error
> {{{
> ---------------------------------------------------------------------------
> ImportErrorPython 3.8.5: /home/rote/Dokumente/Software/sage/local/bin/python3
>                                                    Thu Jan 21 07:42:55 2021
> A problem occurred executing Python code.  Here is the sequence of function
> ...
> ...
> ~/Dokumente/Software/sage/local/lib/python3.8/site-packages/sage/matrix/matrix_mpolynomial_dense.pyx in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8672)()
> ----> 1 """
>       2 Dense matrices over multivariate polynomials over fields
> ...
> ImportError: libreadline.so.8: cannot open shared object file: No such file or directory
> }}}

This looks like `make singular-clean sagelib-clean build` could fix it



---

archive/issue_comments_443233.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> \n> This looks like `make singular-clean sagelib-clean build` could fix it\n\nThis worked! Thanks!",
    "created_at": "2021-01-21T16:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443233",
    "user": "@guenterrote"
}
```

Replying to [comment:12 mkoeppe]:
> 
> This looks like `make singular-clean sagelib-clean build` could fix it

This worked! Thanks!



---

archive/issue_comments_443234.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443234",
    "user": "@mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_443235.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-02T00:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443235",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443236.json:
```json
{
    "body": "Probably because of our ncurses/readline update in #32137, `tox -e docker-ubuntu-bionic-standard -- ncurses readline python3` now works.",
    "created_at": "2022-07-02T00:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443236",
    "user": "@mkoeppe"
}
```

Probably because of our ncurses/readline update in #32137, `tox -e docker-ubuntu-bionic-standard -- ncurses readline python3` now works.



---

archive/issue_comments_443237.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-11T22:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443237",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443238.json:
```json
{
    "body": "ok",
    "created_at": "2022-07-11T22:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443238",
    "user": "@dimpase"
}
```

ok



---

archive/issue_comments_443239.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2022-08-02T06:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31030#issuecomment-443239",
    "user": "@mkoeppe"
}
```

Resolution: invalid
