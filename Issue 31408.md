# Issue 31408: incorrect handling of constant term when creating power series

Issue created by migration from https://trac.sagemath.org/ticket/31645

Original creator: @DaveWitteMorris

Original creation time: 2021-04-11 04:19:41

Keywords: pynac, series

As reported by user TBK in [this sage devel thread](https://groups.google.com/g/sage-devel/c/av4L3qQZl0o/m/d-UDze62AQAJ), the `series` method sometimes returns an incorrect power series in which a constant term has erroneously been multiplied by a power of x:

```
    sage: ((1-sqrt(1-x))/x + 0).series(x,3)
    1/2 + 1/8*x + 1/16*x^2 + Order(x^3)  # correct
    sage: ((1-sqrt(1-x))/x + 123).series(x,3)
    123*x^(-1) + 1/2 + 1/8*x + 1/16*x^2 + Order(x^3)  # wrong !!!
```



---

Comment by @DaveWitteMorris created at 2021-04-11 04:21:13

**Diagnosis:** Laurent polynomials are stored as a pair consisting of a polynomial and an offset `n` that represents multiplication by `x^n`. Pynac's `add::useries` method fails to account for the offset when adding the constant term to a power series.

This should be easy to fix, so I should be able to upload a PR soon.


---

Comment by @DaveWitteMorris created at 2021-04-11 18:52:00

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2021-04-11 18:52:00

The PR fixes the bug by moving the handling of the constant term to the initialization phase, where the offset is known to be 0.

With this PR applied, we get the correct result for the example in the ticket description:

```
sage: ((1-sqrt(1-x))/x + 123).series(x,3)
247/2 + 1/8*x + 1/16*x^2 + Order(x^3)
```

As a doctest, the PR uses the following very simple example that was also giving a wrong answer:

```
sage: (x^(-1) + 1).series(x,1)  # wrong answer !!!
2*x^(-1) + Order(x)
```


My recent pynac patches had merge conflicts, but I rebased this one on #31554 (hence the dependency), so I think it should merge cleanly.  Only the last 3 commits come from this ticket ("trac 31645 handling ...", "add doctest", and "increment pynac patch level").

This is a critical bug, so I hope it can be merged in 9.3.
----
Last 10 new commits:


---

Comment by tscrim created at 2021-04-11 22:52:45

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-04-11 22:52:45

LGTM.


---

Comment by @DaveWitteMorris created at 2021-04-11 23:00:28

Thanks!


---

Comment by mkoeppe created at 2021-04-18 16:13:17

Changing priority from critical to blocker.


---

Comment by @DaveWitteMorris created at 2021-04-19 05:11:13

Changing status from positive_review to needs_review.


---

Comment by @DaveWitteMorris created at 2021-04-19 05:11:13

Rebased on #31679 (which replaced #31554), and updated the patch version again.
----
New commits:


---

Comment by mkoeppe created at 2021-04-19 17:40:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-04-25 12:14:05

Resolution: fixed
