# Issue 27191: Invalid use of sig_on() in acb_calc_func_callback

archive/issues_027191.json:
```json
{
    "body": "CC:  mmezzarobba\n\nThe function `acb_calc_func_callback` ends with a `sig_on()` statement. This makes absolutely no sense at all. This was introduced in #24686.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27428\n\n",
    "created_at": "2019-03-05T11:47:21Z",
    "labels": [
        "cython",
        "major",
        "bug"
    ],
    "title": "Invalid use of sig_on() in acb_calc_func_callback",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27191",
    "user": "jdemeyer"
}
```
CC:  mmezzarobba

The function `acb_calc_func_callback` ends with a `sig_on()` statement. This makes absolutely no sense at all. This was introduced in #24686.

Issue created by migration from https://trac.sagemath.org/ticket/27428





---

archive/issue_comments_383145.json:
```json
{
    "body": "Replying to [ticket:27428 jdemeyer]:\n> The function `acb_calc_func_callback` ends with a `sig_on()` statement. This makes absolutely no sense at all (see https://cysignals.readthedocs.io/en/latest/interrupt.html#using-sig-on-and-sig-off).\n\nThanks for the notice. I think I'm unable to fix the issue by myself, unfortunately.\n\nIs there a description of `sig_on()`/`sig_off()` that explains what they do and where the rules listed in the cysignal manual come from, instead of just saying what one should and shouldn't do? I don't remember the rule that \u201c`sig_off()` should be called before the function that called `sig_on()` returns\u201d being there when we wrote that code (but I may well have missed it).\n\nWhat is the proper way to handle the case of (i) an external C library (ii) that performs callbacks into Python code (iii) but not very frequent ones, so that one would like the code running between two callbacks to be interruptible?",
    "created_at": "2019-03-05T13:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383145",
    "user": "mmezzarobba"
}
```

Replying to [ticket:27428 jdemeyer]:
> The function `acb_calc_func_callback` ends with a `sig_on()` statement. This makes absolutely no sense at all (see https://cysignals.readthedocs.io/en/latest/interrupt.html#using-sig-on-and-sig-off).

Thanks for the notice. I think I'm unable to fix the issue by myself, unfortunately.

Is there a description of `sig_on()`/`sig_off()` that explains what they do and where the rules listed in the cysignal manual come from, instead of just saying what one should and shouldn't do? I don't remember the rule that “`sig_off()` should be called before the function that called `sig_on()` returns” being there when we wrote that code (but I may well have missed it).

What is the proper way to handle the case of (i) an external C library (ii) that performs callbacks into Python code (iii) but not very frequent ones, so that one would like the code running between two callbacks to be interruptible?



---

archive/issue_comments_383146.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Is there a description of `sig_on()`/`sig_off()` that explains what they do and where the rules listed in the cysignal manual come from\n\nNot really, but the important bit to know is that it relies on `setjmp()`/`longjmp()`. So the restriction comes from `setjmp()`. From the [setjmp man page](http://man7.org/linux/man-pages/man3/setjmp.3.html):\n\n```\nIf the function which called setjmp() returns before longjmp() is called, the behavior is undefined.\n```\n\n\n> I don't remember the rule that \u201c`sig_off()` should be called before the function that called `sig_on()` returns\u201d being there when we wrote that code\n\nHow old is your code? That piece of documentation dates from #10109 :-)\n\n> What is the proper way to handle the case of (i) an external C library (ii) that performs callbacks into Python code (iii) but not very frequent ones, so that one would like the code running between two callbacks to be interruptible?\n\nIt's complicated. The hardest part is dealing with exceptions. I see that you already have provisions for that using the `ctx` object. An alternative way for dealing with exceptions is `sig_error()`. Note that you still have a lot of Python code unguarded by `try`/`except` which could raise exceptions (even an `assert` statement!).\n\nThe easy part is making sure that interrupts cannot happen while executing Python code. That can be done with `sig_block()`/`sig_unblock()`.",
    "created_at": "2019-03-05T14:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383146",
    "user": "jdemeyer"
}
```

Replying to [comment:3 mmezzarobba]:
> Is there a description of `sig_on()`/`sig_off()` that explains what they do and where the rules listed in the cysignal manual come from

Not really, but the important bit to know is that it relies on `setjmp()`/`longjmp()`. So the restriction comes from `setjmp()`. From the [setjmp man page](http://man7.org/linux/man-pages/man3/setjmp.3.html):

```
If the function which called setjmp() returns before longjmp() is called, the behavior is undefined.
```


> I don't remember the rule that “`sig_off()` should be called before the function that called `sig_on()` returns” being there when we wrote that code

How old is your code? That piece of documentation dates from #10109 :-)

> What is the proper way to handle the case of (i) an external C library (ii) that performs callbacks into Python code (iii) but not very frequent ones, so that one would like the code running between two callbacks to be interruptible?

It's complicated. The hardest part is dealing with exceptions. I see that you already have provisions for that using the `ctx` object. An alternative way for dealing with exceptions is `sig_error()`. Note that you still have a lot of Python code unguarded by `try`/`except` which could raise exceptions (even an `assert` statement!).

The easy part is making sure that interrupts cannot happen while executing Python code. That can be done with `sig_block()`/`sig_unblock()`.



---

archive/issue_comments_383147.json:
```json
{
    "body": "Wrong ticket?",
    "created_at": "2019-03-21T15:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383147",
    "user": "jdemeyer"
}
```

Wrong ticket?



---

archive/issue_comments_383148.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Wrong ticket?\nI know, It was a mistake.. How do I remove a branch from a ticket",
    "created_at": "2019-03-21T15:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383148",
    "user": "@Hrishabh-yadav"
}
```

Replying to [comment:6 jdemeyer]:
> Wrong ticket?
I know, It was a mistake.. How do I remove a branch from a ticket



---

archive/issue_comments_383149.json:
```json
{
    "body": "Replying to [comment:7 gh-Hrishabh-yadav]:\n> Replying to [comment:6 jdemeyer]:\n> > Wrong ticket?\n> I know, It was a mistake.. How do I remove a branch from a ticket\nThanks",
    "created_at": "2019-03-21T15:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383149",
    "user": "@Hrishabh-yadav"
}
```

Replying to [comment:7 gh-Hrishabh-yadav]:
> Replying to [comment:6 jdemeyer]:
> > Wrong ticket?
> I know, It was a mistake.. How do I remove a branch from a ticket
Thanks



---

archive/issue_comments_383150.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383150",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_383151.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27191#issuecomment-383151",
    "user": "embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).
