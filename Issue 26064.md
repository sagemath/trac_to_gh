# Issue 26064: Python 3 bug in zipfile

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-09-17 15:22:33

There's a doctest that invokes this bug in Python 3.6's `zipfile` module:


```
sage: from sage.plot.plot3d.shapes import Cylinder
sage: C = Cylinder(3, 1, closed=False)
sage: C.jmol_repr(C.testing_render_params())
Exception ignored in: <bound method ZipFile.__del__ of <zipfile.ZipFile [closed]>>
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py", line 1663, in __del__
    self.close()
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py", line 1681, in close
    self._write_end_record()
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py", line 1783, in _write_end_record
    centDirSize, centDirOffset, len(self._comment))
struct.error: argument out of range
['pmesh obj_1 "obj_1.pmesh"\ncolor pmesh  [102,102,255]']
```


The `Graphics3d.testing_render_params()` opens a `ZipFile` in write mode to `/dev/null`, so the bug seems to have to do with writing a zipfile to `/dev/null` (probably to do with a `tell()` call somewhere).

For the purposes of testing there's no reason this needs to go to `'/dev/null'`.  It can just as well use a temp file, so we can implement that workaround.  But we should also open an upstream bug report for the `zipfile` problem, if it hasn't already been reported.


---

Comment by chapoton created at 2018-10-04 19:20:57

Changing status from new to needs_review.


---

Comment by git created at 2018-10-04 19:20:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-10-05 09:11:19

Sure, looks good to me.  I still need to make sure to make an upstream bug report (but this is pretty minor, and after fixing it in Sage I doubt we'll revisit the issue).


---

Comment by embray created at 2018-10-05 10:03:14

Interestingly, I can't reproduce the bug on Cygwin, only on Linux.  I was trying to see if it was still broken in master, and at first I thought maybe it was fixed.  But no, it just doesn't happen on Cygwin that I can tell.  Maybe some difference in how /dev/null works; not sure.


---

Comment by embray created at 2018-10-05 10:31:03

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-10-05 10:31:03

Ok, upstream bug report submitted.  LGTM.


---

Comment by vbraun created at 2018-10-06 17:12:56

Resolution: fixed
