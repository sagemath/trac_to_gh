# Issue 13427: Sage refuses to run despite safe directory

archive/issues_013427.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  @jdemeyer\n\nSomething is wrong with the patch at #13579. This breaks the patchbot on Fedora:\n\n```\n(sage-sh) patchbot@volker-desktop:sage$ python -Werror -c ''\nRuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.\nUntrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n(sage-sh) patchbot@volker-desktop:sage$ ls -ald .\ndrwxrwxr-x. 7 patchbot patchbot 4096 Oct 20 11:24 .\n(sage-sh) patchbot@volker-desktop:sage$ umask\n0002\n(sage-sh) patchbot@volker-desktop:sage$ groups\npatchbot\n(sage-sh) patchbot@volker-desktop:sage$ id\nuid=1001(patchbot) gid=1001(patchbot) groups=1001(patchbot) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13631\n\n",
    "created_at": "2012-10-20T13:51:16Z",
    "labels": [
        "component: doctest coverage",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4",
    "title": "Sage refuses to run despite safe directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13427",
    "user": "https://github.com/vbraun"
}
```
Assignee: mvngu

CC:  @jdemeyer

Something is wrong with the patch at #13579. This breaks the patchbot on Fedora:

```
(sage-sh) patchbot@volker-desktop:sage$ python -Werror -c ''
RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
(sage-sh) patchbot@volker-desktop:sage$ ls -ald .
drwxrwxr-x. 7 patchbot patchbot 4096 Oct 20 11:24 .
(sage-sh) patchbot@volker-desktop:sage$ umask
0002
(sage-sh) patchbot@volker-desktop:sage$ groups
patchbot
(sage-sh) patchbot@volker-desktop:sage$ id
uid=1001(patchbot) gid=1001(patchbot) groups=1001(patchbot) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```


Issue created by migration from https://trac.sagemath.org/ticket/13631





---

archive/issue_comments_165287.json:
```json
{
    "body": "I get the following warning when I install the patchbot (sage -i patchbot).  This is on ubuntu 11.10.  \n\n```\n>>> Checking online list of optional packages.\nsys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.\nUntrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n[.]\n>>> Found patchbot-1.1.\n>>> Downloading patchbot-1.1.spkg.\nsys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.\nUntrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n[......]\npatchbot-1.1\n```\n\nHowever, the install appears to go okay. \n\nWhen I try to run the patchbot, though, it complains (after the building process goes fine, apparently):\n\n\n```\n========== end plugins.docbuild ==========\n$SAGE_ROOT/sage -tp 3 -sagenb $SAGE_ROOT/devel/sage-0/doc/common $SAGE_ROOT/devel/sage-0/doc/en $SAGE_ROOT/devel/sage-0/doc/fr $SAGE_ROOT/devel/sage-0/sage\nGlobal iterations: 1\nFile iterations: 1\nTraceback (most recent call last):\n  File \"/home/hugh/sage-5.4.rc2/local/bin/sage-ptest\", line 80, in <module>\n    .format(os.getcwd()))\nRuntimeError: refusing to run doctests from the current directory '/home/hugh/sage-5.4.rc2/devel/sage-0' since untrusted users could put files in this directory, making it unsafe to run Sage code from\nTraceback (most recent call last):\n  File \"/home/hugh/sage-5.4.rc2/local/bin/patchbot/patchbot.py\", line 416, in test_a_ticket\n    do_or_die(\"$SAGE_ROOT/sage %s %s\" % (test_cmd, ' '.join(test_dirs)))\n  File \"/home/hugh/sage-5.4.rc2/local/bin/patchbot/util.py\", line 62, in do_or_die\n    raise Exception, \"%s %s\" % (res, cmd)\nException: 256 $SAGE_ROOT/sage -tp 3 -sagenb $SAGE_ROOT/devel/sage-0/doc/common $SAGE_ROOT/devel/sage-0/doc/en $SAGE_ROOT/devel/sage-0/doc/fr $SAGE_ROOT/devel/sage-0/sage\n2012-10-20 23:08:09 -0700\n1439 seconds\nTraceback (most recent call last):\n  File \"/home/hugh/sage-5.4.rc2/local/bin/patchbot/patchbot.py\", line 416, in test_a_ticket\n    do_or_die(\"$SAGE_ROOT/sage %s %s\" % (test_cmd, ' '.join(test_dirs)))\n  File \"/home/hugh/sage-5.4.rc2/local/bin/patchbot/util.py\", line 62, in do_or_die\n    raise Exception, \"%s %s\" % (res, cmd)\nException: 256 $SAGE_ROOT/sage -tp 3 -sagenb $SAGE_ROOT/devel/sage-0/doc/common $SAGE_ROOT/devel/sage-0/doc/en $SAGE_ROOT/devel/sage-0/doc/fr $SAGE_ROOT/devel/sage-0/sage\nReporting 0 TestsFailed\n0 TestsFailed\nok\nDone reporting 0\n\n\n\nFailing tests in your install: TestsFailed. Continue anyways? [y/N] \n```\n",
    "created_at": "2012-10-21T06:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165287",
    "user": "https://github.com/hughrthomas"
}
```

I get the following warning when I install the patchbot (sage -i patchbot).  This is on ubuntu 11.10.  

```
>>> Checking online list of optional packages.
sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
[.]
>>> Found patchbot-1.1.
>>> Downloading patchbot-1.1.spkg.
sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
[......]
patchbot-1.1
```

However, the install appears to go okay. 

When I try to run the patchbot, though, it complains (after the building process goes fine, apparently):


```
========== end plugins.docbuild ==========
$SAGE_ROOT/sage -tp 3 -sagenb $SAGE_ROOT/devel/sage-0/doc/common $SAGE_ROOT/devel/sage-0/doc/en $SAGE_ROOT/devel/sage-0/doc/fr $SAGE_ROOT/devel/sage-0/sage
Global iterations: 1
File iterations: 1
Traceback (most recent call last):
  File "/home/hugh/sage-5.4.rc2/local/bin/sage-ptest", line 80, in <module>
    .format(os.getcwd()))
RuntimeError: refusing to run doctests from the current directory '/home/hugh/sage-5.4.rc2/devel/sage-0' since untrusted users could put files in this directory, making it unsafe to run Sage code from
Traceback (most recent call last):
  File "/home/hugh/sage-5.4.rc2/local/bin/patchbot/patchbot.py", line 416, in test_a_ticket
    do_or_die("$SAGE_ROOT/sage %s %s" % (test_cmd, ' '.join(test_dirs)))
  File "/home/hugh/sage-5.4.rc2/local/bin/patchbot/util.py", line 62, in do_or_die
    raise Exception, "%s %s" % (res, cmd)
Exception: 256 $SAGE_ROOT/sage -tp 3 -sagenb $SAGE_ROOT/devel/sage-0/doc/common $SAGE_ROOT/devel/sage-0/doc/en $SAGE_ROOT/devel/sage-0/doc/fr $SAGE_ROOT/devel/sage-0/sage
2012-10-20 23:08:09 -0700
1439 seconds
Traceback (most recent call last):
  File "/home/hugh/sage-5.4.rc2/local/bin/patchbot/patchbot.py", line 416, in test_a_ticket
    do_or_die("$SAGE_ROOT/sage %s %s" % (test_cmd, ' '.join(test_dirs)))
  File "/home/hugh/sage-5.4.rc2/local/bin/patchbot/util.py", line 62, in do_or_die
    raise Exception, "%s %s" % (res, cmd)
Exception: 256 $SAGE_ROOT/sage -tp 3 -sagenb $SAGE_ROOT/devel/sage-0/doc/common $SAGE_ROOT/devel/sage-0/doc/en $SAGE_ROOT/devel/sage-0/doc/fr $SAGE_ROOT/devel/sage-0/sage
Reporting 0 TestsFailed
0 TestsFailed
ok
Done reporting 0



Failing tests in your install: TestsFailed. Continue anyways? [y/N] 
```




---

archive/issue_comments_165288.json:
```json
{
    "body": "Hugh, could you provide the same information as Volker (`umask`, group ids, permissions of the relevant directory).\n\nAlso, Volker and Hugh: which version of Sage are you talking about?  In particular, is #13459 applied?",
    "created_at": "2012-10-21T07:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165288",
    "user": "https://github.com/jdemeyer"
}
```

Hugh, could you provide the same information as Volker (`umask`, group ids, permissions of the relevant directory).

Also, Volker and Hugh: which version of Sage are you talking about?  In particular, is #13459 applied?



---

archive/issue_comments_165289.json:
```json
{
    "body": "Looks like we should check the umask for `python -c`",
    "created_at": "2012-10-21T07:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165289",
    "user": "https://github.com/jdemeyer"
}
```

Looks like we should check the umask for `python -c`



---

archive/issue_comments_165290.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2012-10-21T07:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165290",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_165291.json:
```json
{
    "body": "I was running 5.4.rc2.  \n\nI'm not sure which directory is relevant. The directory which it refused to run doctests in was one that had just been created by the patchbot, /home/hugh/sage-5.4.rc2/devel/sage-0.  In that directory, I get the following:\n\n```\nhugh@hugh-laptop:~/sage-5.4.rc2/devel$ cd sage-0/\nhugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ ls -ald .\ndrwxrwxr-x 7 hugh hugh 4096 2012-10-20 22:45 .\nhugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ umask\n0002\nhugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ groups\nhugh adm dialout cdrom plugdev lpadmin admin sambashare\nhugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ id\nuid=1000(hugh) gid=1000(hugh) groups=1000(hugh),4(adm),20(dialout),24(cdrom),46(plugdev),105(lpadmin),119(admin),122(sambashare)\n```\n\n\nI don't know what the output from these commands means, so please let me know if you need more or different information.",
    "created_at": "2012-10-21T07:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165291",
    "user": "https://github.com/hughrthomas"
}
```

I was running 5.4.rc2.  

I'm not sure which directory is relevant. The directory which it refused to run doctests in was one that had just been created by the patchbot, /home/hugh/sage-5.4.rc2/devel/sage-0.  In that directory, I get the following:

```
hugh@hugh-laptop:~/sage-5.4.rc2/devel$ cd sage-0/
hugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ ls -ald .
drwxrwxr-x 7 hugh hugh 4096 2012-10-20 22:45 .
hugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ umask
0002
hugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ groups
hugh adm dialout cdrom plugdev lpadmin admin sambashare
hugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-0$ id
uid=1000(hugh) gid=1000(hugh) groups=1000(hugh),4(adm),20(dialout),24(cdrom),46(plugdev),105(lpadmin),119(admin),122(sambashare)
```


I don't know what the output from these commands means, so please let me know if you need more or different information.



---

archive/issue_comments_165292.json:
```json
{
    "body": "I can get the same error without the patchbot.\n\n\n```\nhugh@hugh-laptop:~$ cd sage-5.4.rc2/devel/sage-main/\nhugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-main$ ../../sage -t sage/combinat/tableau.py \nTraceback (most recent call last):\n  File \"/home/hugh/sage-5.4.rc2/local/bin/sage-test\", line 53, in <module>\n    .format(os.getcwd()))\nRuntimeError: refusing to run doctests from the current directory '/home/hugh/sage-5.4.rc2/devel/sage-main' since untrusted users could put files in this directory, making it unsafe to run Sage code from\n```\n\n\nI get the same output from the above commands (ls, etc.) in sage-main as in sage-0. \n\nIt works fine if I run sage -t from ~/sage-5.4.rc2.  There, I get:\n\n\n```\nhugh@hugh-laptop:~/sage-5.4.rc2$ ls -ald .\ndrwxr-xr-x 9 hugh hugh 4096 2012-10-20 22:44 .\n```\n\n\nI get same error as above if I run sage -t from ~/sage-5.4.rc2/devel, where the output from ls -ald ., etc., looks very similar.  to sage-5.4.rc2/devel/sage-main.",
    "created_at": "2012-10-21T08:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165292",
    "user": "https://github.com/hughrthomas"
}
```

I can get the same error without the patchbot.


```
hugh@hugh-laptop:~$ cd sage-5.4.rc2/devel/sage-main/
hugh@hugh-laptop:~/sage-5.4.rc2/devel/sage-main$ ../../sage -t sage/combinat/tableau.py 
Traceback (most recent call last):
  File "/home/hugh/sage-5.4.rc2/local/bin/sage-test", line 53, in <module>
    .format(os.getcwd()))
RuntimeError: refusing to run doctests from the current directory '/home/hugh/sage-5.4.rc2/devel/sage-main' since untrusted users could put files in this directory, making it unsafe to run Sage code from
```


I get the same output from the above commands (ls, etc.) in sage-main as in sage-0. 

It works fine if I run sage -t from ~/sage-5.4.rc2.  There, I get:


```
hugh@hugh-laptop:~/sage-5.4.rc2$ ls -ald .
drwxr-xr-x 9 hugh hugh 4096 2012-10-20 22:44 .
```


I get same error as above if I run sage -t from ~/sage-5.4.rc2/devel, where the output from ls -ald ., etc., looks very similar.  to sage-5.4.rc2/devel/sage-main.



---

archive/issue_comments_165293.json:
```json
{
    "body": "I'm talking about Sage-5.4.rc2 (which is the first one with your Python patch). The problem is the \n\n```\nif ((arg_stat.st_mode & 0022) == 0 && (program_stat.st_mode & 0022) == 0)\n```\n\ncheck, thats too restrictive. If you have your own group then its perfectly save to for the directory to be group-writable, and indeed Fedora sets you up with umask `0002` in that case.",
    "created_at": "2012-10-21T08:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165293",
    "user": "https://github.com/vbraun"
}
```

I'm talking about Sage-5.4.rc2 (which is the first one with your Python patch). The problem is the 

```
if ((arg_stat.st_mode & 0022) == 0 && (program_stat.st_mode & 0022) == 0)
```

check, thats too restrictive. If you have your own group then its perfectly save to for the directory to be group-writable, and indeed Fedora sets you up with umask `0002` in that case.



---

archive/issue_comments_165294.json:
```json
{
    "body": "Attachment [python-2.7.3.p2.diff](tarball://root/attachments/some-uuid/ticket13631/python-2.7.3.p2.diff) by @jdemeyer created at 2012-10-29 21:37:51\n\nDiff for the python spkg. For reference / review only.",
    "created_at": "2012-10-29T21:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165294",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [python-2.7.3.p2.diff](tarball://root/attachments/some-uuid/ticket13631/python-2.7.3.p2.diff) by @jdemeyer created at 2012-10-29 21:37:51

Diff for the python spkg. For reference / review only.



---

archive/issue_comments_165295.json:
```json
{
    "body": "Attachment [13631_untar.patch](tarball://root/attachments/some-uuid/ticket13631/13631_untar.patch) by @jdemeyer created at 2012-10-29 21:56:01",
    "created_at": "2012-10-29T21:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165295",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13631_untar.patch](tarball://root/attachments/some-uuid/ticket13631/13631_untar.patch) by @jdemeyer created at 2012-10-29 21:56:01



---

archive/issue_comments_165296.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-29T21:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165296",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_165297.json:
```json
{
    "body": "Looks good to me. Fixes the patchbot on Fedora 17, at least.",
    "created_at": "2012-10-30T10:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165297",
    "user": "https://github.com/vbraun"
}
```

Looks good to me. Fixes the patchbot on Fedora 17, at least.



---

archive/issue_comments_165298.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-30T10:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165298",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_165299.json:
```json
{
    "body": "Also fixed for me (Ubuntu 11.10).  At any rate, the patchbot is willing to run doctests again.  \n\nThe patchbot is now running the doctests.  I will let you know if anything has broken.",
    "created_at": "2012-10-30T15:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165299",
    "user": "https://github.com/hughrthomas"
}
```

Also fixed for me (Ubuntu 11.10).  At any rate, the patchbot is willing to run doctests again.  

The patchbot is now running the doctests.  I will let you know if anything has broken.



---

archive/issue_comments_165300.json:
```json
{
    "body": "I detected no problems.",
    "created_at": "2012-10-30T17:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165300",
    "user": "https://github.com/hughrthomas"
}
```

I detected no problems.



---

archive/issue_comments_165301.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-10-31T21:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13427#issuecomment-165301",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
