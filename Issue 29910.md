# Issue 29910: Fix spkg-configure.m4 for sympow

Issue created by migration from https://trac.sagemath.org/ticket/30147

Original creator: mkoeppe

Original creation time: 2020-07-14 22:46:29

CC:  mjo dimpase

#29673 (spkg-configure.m4 for sympow) accepts broken `sympow` versions on various systems, as noted on #29673, #3360



---

Comment by mkoeppe created at 2020-07-14 22:49:05

Some of the failures look similar to #25856


---

Comment by dimpase created at 2020-07-15 10:45:29

one sees

```
2020-07-14T05:25:18.6994389Z sage -t src/sage/lfunctions/sympow.py
2020-07-14T05:25:18.6994604Z **********************************************************************
2020-07-14T05:25:18.6994830Z File "src/sage/lfunctions/sympow.py", line 277, in sage.lfunctions.sympow.Sympow.analytic_rank
2020-07-14T05:25:18.6995039Z Failed example:
2020-07-14T05:25:18.6995370Z     sympow.analytic_rank(EllipticCurve('11a'))
2020-07-14T05:25:18.6996565Z Exception raised:
2020-07-14T05:25:18.6996805Z     Traceback (most recent call last):
2020-07-14T05:25:26.5012311Z       File "/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 707, in _run
2020-07-14T05:25:26.5013186Z         self.compile_and_execute(example, compiler, test.globs)
2020-07-14T05:25:26.5013747Z       File "/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1132, in compile_and_execute
2020-07-14T05:25:26.5014157Z         exec(compiled, globs)
2020-07-14T05:25:26.5014450Z       File "<doctest sage.lfunctions.sympow.Sympow.analytic_rank[0]>", line 1, in <module>
2020-07-14T05:25:26.5014877Z         sympow.analytic_rank(EllipticCurve('11a'))
2020-07-14T05:25:26.5015341Z       File "/sage/local/lib/python3.7/site-packages/sage/lfunctions/sympow.py", line 299, in analytic_rank
2020-07-14T05:25:26.5015643Z         raise RuntimeError("failed to compute analytic rank")
2020-07-14T05:25:26.5015887Z     RuntimeError: failed to compute analytic rank
2020-07-14T05:25:26.5016143Z **********************************************************************
2020-07-14T05:25:26.5016410Z File "src/sage/lfunctions/sympow.py", line 281, in sage.lfunctions.sympow.Sympow.analytic_rank
2020-07-14T05:25:26.5016673Z Failed example:
2020-07-14T05:25:26.5017073Z     sympow.analytic_rank(EllipticCurve('389a'))
2020-07-14T05:25:26.5017336Z Exception raised:
2020-07-14T05:25:26.5017696Z     Traceback (most recent call last):
2020-07-14T05:25:26.5018072Z       File "/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 707, in _run
2020-07-14T05:25:26.5018323Z         self.compile_and_execute(example, compiler, test.globs)
2020-07-14T05:25:26.5018717Z       File "/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1132, in compile_and_execute
2020-07-14T05:25:26.5018959Z         exec(compiled, globs)
2020-07-14T05:25:26.5019187Z       File "<doctest sage.lfunctions.sympow.Sympow.analytic_rank[2]>", line 1, in <module>
2020-07-14T05:25:26.5019540Z         sympow.analytic_rank(EllipticCurve('389a'))
2020-07-14T05:25:26.5019937Z       File "/sage/local/lib/python3.7/site-packages/sage/lfunctions/sympow.py", line 299, in analytic_rank
2020-07-14T05:25:26.5020183Z         raise RuntimeError("failed to compute analytic rank")
2020-07-14T05:25:26.5020412Z     RuntimeError: failed to compute analytic rank
2020-07-14T05:25:26.5020633Z **********************************************************************
2020-07-14T05:25:26.5020872Z File "src/sage/lfunctions/sympow.py", line 285, in sage.lfunctions.sympow.Sympow.analytic_rank
2020-07-14T05:25:26.5021096Z Failed example:
2020-07-14T05:25:26.5021442Z     sympow.analytic_rank(EllipticCurve([1, -1, 0, -79, 289]))
2020-07-14T05:25:26.5021672Z Exception raised:
2020-07-14T05:25:26.5021884Z     Traceback (most recent call last):
2020-07-14T05:25:26.5022253Z       File "/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 707, in _run
2020-07-14T05:25:26.5022498Z         self.compile_and_execute(example, compiler, test.globs)
2020-07-14T05:25:26.5022889Z       File "/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1132, in compile_and_execute
2020-07-14T05:25:26.5023126Z         exec(compiled, globs)
2020-07-14T05:25:26.5023354Z       File "<doctest sage.lfunctions.sympow.Sympow.analytic_rank[4]>", line 1, in <module>
2020-07-14T05:25:26.5023753Z         sympow.analytic_rank(EllipticCurve([Integer(1), -Integer(1), Integer(0), -Integer(79), Integer(289)]))
2020-07-14T05:25:26.5024160Z       File "/sage/local/lib/python3.7/site-packages/sage/lfunctions/sympow.py", line 299, in analytic_rank
2020-07-14T05:25:26.5024406Z         raise RuntimeError("failed to compute analytic rank")
2020-07-14T05:25:26.5024631Z     RuntimeError: failed to compute analytic rank
2020-07-14T05:25:26.5024853Z **********************************************************************
```


the last test can be done in spkg-configure.m4 by doing

```
$ sympow -curve [1,-1,0,-79,289] -analrank | grep ^"Analytic Rank is 4"
Analytic Rank is 4 : leading L-term 8.94385e+00
```

- this is what I get on Debian 10, while on Fedora 30 I get a segfault.

So this is something easy to add


---

Comment by mjo created at 2020-07-15 17:10:36

We can fake a version check with e.g.


```
$ sympow -version | cut -c1
2
```


but your feature test is better if we only have to add one or two of them. The sage library already looks for the string "Analytic Rank is" so grepping for it is reasonable.


---

Comment by dimpase created at 2020-07-15 17:54:37

The segfault on Fedora 30 might  be due to a file permission:

```
$ sympow -curve [1,-1,0,-79,289] -analrank
sympow 2.023.5 RELEASE  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [1,-1,0,-79,289]
At 2: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
At 117223: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 234446
Creating /var/cache/sympow/datafiles/le64/m01EM.bin from /usr/share/sympow/datafiles/m01EM.txt
Segmentation fault (core dumped)
```

but on this box `/var/cache/sympow/` is writable only for `root`, and there is no
`/var/cache/sympow/datafiles/`.


---

Comment by dimpase created at 2020-07-17 12:18:54

New commits:


---

Comment by dimpase created at 2020-07-17 12:27:02

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-07-17 12:27:02

works on Fedora 30 (recognised broken sympow) and Debian 10 (accepts good sympow).


---

Comment by dimpase created at 2020-07-17 12:29:11

the weird

```
sympow_rank_test=`echo "@<:@1,-1,0,-79,289@:>@" | sympow -analrank | grep ^"Analytic Rank is 4"`
```

is due to quoting hell - I couldn't find how to put in exactly the test from comment:2 - but this is minor.


---

Comment by mkoeppe created at 2020-07-17 12:39:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-25 22:51:30

Resolution: fixed
