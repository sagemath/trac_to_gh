# Issue 33663: small enhancements to generic discrete logs

archive/issues_033663.json:
```json
{
    "body": "CC:  lorenz\n\nKeywords: discrete, logarithm, group theory, generic\n\nPreviously, the generic discrete log function wouldn't ever use Pollard's rho. From what I can tell, no generic Pohlig-Hellman implementation existed which used Pollard's rho.\n\nAdditionally, discrete log functions did not seem to properly use the custom operation arguments.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33900\n\n",
    "created_at": "2022-05-25T04:15:07Z",
    "labels": [
        "group theory",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "small enhancements to generic discrete logs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33663",
    "user": "@k3w1k0d3r"
}
```
CC:  lorenz

Keywords: discrete, logarithm, group theory, generic

Previously, the generic discrete log function wouldn't ever use Pollard's rho. From what I can tell, no generic Pohlig-Hellman implementation existed which used Pollard's rho.

Additionally, discrete log functions did not seem to properly use the custom operation arguments.

Issue created by migration from https://trac.sagemath.org/ticket/33900





---

archive/issue_comments_479086.json:
```json
{
    "body": "Set assignee to @k3w1k0d3r.",
    "created_at": "2022-05-25T04:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479086",
    "user": "@k3w1k0d3r"
}
```

Set assignee to @k3w1k0d3r.



---

archive/issue_comments_479087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-25T05:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479087",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479088.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-05-25T05:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479088",
    "user": "@k3w1k0d3r"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_479089.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-25T20:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479089",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479090.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-25T21:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479090",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479091.json:
```json
{
    "body": "Thanks for the contribution!\n\nOne first comment: The `use_rho` keyword argument should be replaced by an `algorithm` argument (with options `\"bsgs\"`/`\"rho\"` and a reasonable default choice among these), as is standard practice throughout most of the Sage library. This makes sure the interface doesn't get awkward if someone wants to add another algorithm option later.",
    "created_at": "2022-05-26T02:44:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479091",
    "user": "lorenz"
}
```

Thanks for the contribution!

One first comment: The `use_rho` keyword argument should be replaced by an `algorithm` argument (with options `"bsgs"`/`"rho"` and a reasonable default choice among these), as is standard practice throughout most of the Sage library. This makes sure the interface doesn't get awkward if someone wants to add another algorithm option later.



---

archive/issue_comments_479092.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-26T03:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479092",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479093.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-27T05:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479093",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479094.json:
```json
{
    "body": "Thanks. Some more comments:\n\n- There's a spurious whitespace change in `build/bin/sage-bootstrap-python`.\n- Your `ValueError(\"unkown algorithm\")` contains a typo (\"unkown\" -> \"unknown\").\n- That same `ValueError` is immediately caught by the function and results in an incorrect \"no discrete log\" error.\n- The logic here:\n\n```python\n    mult = op if op is not None else [add, mul][operation in multiplication_names]\n    power = [mul, pow][operation in multiplication_names]\n    if(op is not None):\n        power = lambda x, y: multiple(x, y, operation=operation, identity=identity, inverse=inverse, op=op)\n    if ord is None:\n        if operation in multiplication_names:\n            mult = mul\n            power = pow\n            try:\n                ord = base.multiplicative_order()\n            except Exception:\n                ord = base.order()\n        elif operation in addition_names:\n            mult = add\n            power = mul\n```\n\nis weird. First, it should probably throw an error if `operation` is neither in `addition_names` nor in `multiplication_names`. Second, if `operation` is given but `ord` is not, this sets both `mult` and `power` twice (to the same value). Third, coding style: `if(foo):` should be `if foo:` in Python. Fourth, you use an `if` to set `power`, but the ternary `x if y else z` to set `mult`; this can be streamlined into a single `if`.\n\n- This should probably say \"in *the* group\":\n\n```diff\n+    - ``op()`` - function of 2 arguments ``x``, ``y`` returning ``x*y`` in group\n```\n",
    "created_at": "2022-05-27T06:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479094",
    "user": "lorenz"
}
```

Thanks. Some more comments:

- There's a spurious whitespace change in `build/bin/sage-bootstrap-python`.
- Your `ValueError("unkown algorithm")` contains a typo ("unkown" -> "unknown").
- That same `ValueError` is immediately caught by the function and results in an incorrect "no discrete log" error.
- The logic here:

```python
    mult = op if op is not None else [add, mul][operation in multiplication_names]
    power = [mul, pow][operation in multiplication_names]
    if(op is not None):
        power = lambda x, y: multiple(x, y, operation=operation, identity=identity, inverse=inverse, op=op)
    if ord is None:
        if operation in multiplication_names:
            mult = mul
            power = pow
            try:
                ord = base.multiplicative_order()
            except Exception:
                ord = base.order()
        elif operation in addition_names:
            mult = add
            power = mul
```

is weird. First, it should probably throw an error if `operation` is neither in `addition_names` nor in `multiplication_names`. Second, if `operation` is given but `ord` is not, this sets both `mult` and `power` twice (to the same value). Third, coding style: `if(foo):` should be `if foo:` in Python. Fourth, you use an `if` to set `power`, but the ternary `x if y else z` to set `mult`; this can be streamlined into a single `if`.

- This should probably say "in *the* group":

```diff
+    - ``op()`` - function of 2 arguments ``x``, ``y`` returning ``x*y`` in group
```




---

archive/issue_comments_479095.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-27T06:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479095",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479096.json:
```json
{
    "body": "Replying to [comment:11 lorenz]:\n> Thanks. Some more comments:\n> \n> - There's a spurious whitespace change in `build/bin/sage-bootstrap-python`.\n> - Your `ValueError(\"unkown algorithm\")` contains a typo (\"unkown\" -> \"unknown\").\n> - That same `ValueError` is immediately caught by the function and results in an incorrect \"no discrete log\" error.\n> - The logic here:\n> {{{#!python\n>     mult = op if op is not None else [add, mul][operation in multiplication_names]\n>     power = [mul, pow][operation in multiplication_names]\n>     if(op is not None):\n>         power = lambda x, y: multiple(x, y, operation=operation, identity=identity, inverse=inverse, op=op)\n>     if ord is None:\n>         if operation in multiplication_names:\n>             mult = mul\n>             power = pow\n>             try:\n>                 ord = base.multiplicative_order()\n>             except Exception:\n>                 ord = base.order()\n>         elif operation in addition_names:\n>             mult = add\n>             power = mul\n> }}}\n> is weird. First, it should probably throw an error if `operation` is neither in `addition_names` nor in `multiplication_names`. Second, if `operation` is given but `ord` is not, this sets both `mult` and `power` twice (to the same value). Third, coding style: `if(foo):` should be `if foo:` in Python. Fourth, you use an `if` to set `power`, but the ternary `x if y else z` to set `mult`; this can be streamlined into a single `if`.\n> \n> - This should probably say \"in *the* group\":\n> {{{#!diff\n> +    - ``op()`` - function of 2 arguments ``x``, ``y`` returning ``x*y`` in group\n> }}}\nthanks",
    "created_at": "2022-05-27T06:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479096",
    "user": "@k3w1k0d3r"
}
```

Replying to [comment:11 lorenz]:
> Thanks. Some more comments:
> 
> - There's a spurious whitespace change in `build/bin/sage-bootstrap-python`.
> - Your `ValueError("unkown algorithm")` contains a typo ("unkown" -> "unknown").
> - That same `ValueError` is immediately caught by the function and results in an incorrect "no discrete log" error.
> - The logic here:
> {{{#!python
>     mult = op if op is not None else [add, mul][operation in multiplication_names]
>     power = [mul, pow][operation in multiplication_names]
>     if(op is not None):
>         power = lambda x, y: multiple(x, y, operation=operation, identity=identity, inverse=inverse, op=op)
>     if ord is None:
>         if operation in multiplication_names:
>             mult = mul
>             power = pow
>             try:
>                 ord = base.multiplicative_order()
>             except Exception:
>                 ord = base.order()
>         elif operation in addition_names:
>             mult = add
>             power = mul
> }}}
> is weird. First, it should probably throw an error if `operation` is neither in `addition_names` nor in `multiplication_names`. Second, if `operation` is given but `ord` is not, this sets both `mult` and `power` twice (to the same value). Third, coding style: `if(foo):` should be `if foo:` in Python. Fourth, you use an `if` to set `power`, but the ternary `x if y else z` to set `mult`; this can be streamlined into a single `if`.
> 
> - This should probably say "in *the* group":
> {{{#!diff
> +    - ``op()`` - function of 2 arguments ``x``, ``y`` returning ``x*y`` in group
> }}}
thanks



---

archive/issue_comments_479097.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-27T07:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479097",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479098.json:
```json
{
    "body": "I didn't think https://git.sagemath.org/sage.git/commit/?id=f2cc9775d072728a444f0ab19a9349eef2668225 through very well and the tests didn't detect my mistake, I've now undone that change.",
    "created_at": "2022-05-27T07:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479098",
    "user": "@k3w1k0d3r"
}
```

I didn't think https://git.sagemath.org/sage.git/commit/?id=f2cc9775d072728a444f0ab19a9349eef2668225 through very well and the tests didn't detect my mistake, I've now undone that change.



---

archive/issue_comments_479099.json:
```json
{
    "body": "is it looking better now?",
    "created_at": "2022-06-08T00:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479099",
    "user": "@k3w1k0d3r"
}
```

is it looking better now?



---

archive/issue_comments_479100.json:
```json
{
    "body": "is there any update on this?",
    "created_at": "2022-08-02T19:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479100",
    "user": "@k3w1k0d3r"
}
```

is there any update on this?



---

archive/issue_comments_479101.json:
```json
{
    "body": "Sorry for the long silence. What's still missing are tests for the new `algorithm` flag: I guess you can just copy some of the existing tests and show that they also work if you pass `algorithm='rho'`.\n\nOnce that's done, I think this can be merged \u2014 while there are still plenty of things I would change in that file, it's certainly better than before.",
    "created_at": "2022-08-03T01:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479101",
    "user": "lorenz"
}
```

Sorry for the long silence. What's still missing are tests for the new `algorithm` flag: I guess you can just copy some of the existing tests and show that they also work if you pass `algorithm='rho'`.

Once that's done, I think this can be merged — while there are still plenty of things I would change in that file, it's certainly better than before.



---

archive/issue_comments_479102.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-03T08:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479102",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479103.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-08-04T08:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479103",
    "user": "lorenz"
}
```

Thanks!



---

archive/issue_comments_479104.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-04T08:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479104",
    "user": "lorenz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479105.json:
```json
{
    "body": "thank you! since it's positive review now, what would be the process for making further changes? should I open a new ticket?",
    "created_at": "2022-08-04T21:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479105",
    "user": "@k3w1k0d3r"
}
```

thank you! since it's positive review now, what would be the process for making further changes? should I open a new ticket?



---

archive/issue_comments_479106.json:
```json
{
    "body": "actually I'm pretty sure the current code has a bug so I should probably update this ticket. before I push, can you confirm that that's what I should do?",
    "created_at": "2022-08-05T04:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479106",
    "user": "@k3w1k0d3r"
}
```

actually I'm pretty sure the current code has a bug so I should probably update this ticket. before I push, can you confirm that that's what I should do?



---

archive/issue_comments_479107.json:
```json
{
    "body": "I'm not sure either what's the preferred way of dealing with this, but I think setting it back to \"needs work\" for now won't hurt.\n(Adding changes to a ticket that is in \"positive review\" state is discouraged because it makes it difficult to tell which version of the branch gets merged in the end.)\n\nWhat's the bug you found? Does it break things that used to work previously?",
    "created_at": "2022-08-05T04:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479107",
    "user": "lorenz"
}
```

I'm not sure either what's the preferred way of dealing with this, but I think setting it back to "needs work" for now won't hurt.
(Adding changes to a ticket that is in "positive review" state is discouraged because it makes it difficult to tell which version of the branch gets merged in the end.)

What's the bug you found? Does it break things that used to work previously?



---

archive/issue_comments_479108.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-08-05T04:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479108",
    "user": "lorenz"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_479109.json:
```json
{
    "body": "it has to do with the stop early CRT optimization.\n\n`CRT_list(l, [pi**ri for pi, ri in f[:len(l)]])`\n\nSince we stop before computing the latter part of `l`, we need to cut off the moduli early as well. The problem is that `l` is initialized with its full length, so this list slicing doesn't do anything. If this part of code got hit then some of the CRT relations would be wrong (unless 0 was the correct result for all remaining factors). The solution is simple, just slice `l` at the number of factors that have been checked.\n\nSince this optimization wasn't in there before, this does break something that used to work.",
    "created_at": "2022-08-05T04:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479109",
    "user": "@k3w1k0d3r"
}
```

it has to do with the stop early CRT optimization.

`CRT_list(l, [pi**ri for pi, ri in f[:len(l)]])`

Since we stop before computing the latter part of `l`, we need to cut off the moduli early as well. The problem is that `l` is initialized with its full length, so this list slicing doesn't do anything. If this part of code got hit then some of the CRT relations would be wrong (unless 0 was the correct result for all remaining factors). The solution is simple, just slice `l` at the number of factors that have been checked.

Since this optimization wasn't in there before, this does break something that used to work.



---

archive/issue_comments_479110.json:
```json
{
    "body": "I see, sorry for not catching that. In addition to fixing it, could you please add a test that currently fails because of the bug?\n\nIdeally, we should add more comprehensive (maybe randomized) testing to these functions too, but I suppose that can become part of the \"plenty of things I would change in that file\" I had alluded to earlier.",
    "created_at": "2022-08-05T08:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479110",
    "user": "lorenz"
}
```

I see, sorry for not catching that. In addition to fixing it, could you please add a test that currently fails because of the bug?

Ideally, we should add more comprehensive (maybe randomized) testing to these functions too, but I suppose that can become part of the "plenty of things I would change in that file" I had alluded to earlier.



---

archive/issue_comments_479111.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-05T09:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479111",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479112.json:
```json
{
    "body": "the first commit does a bit more than fix the bug because I didn't notice the bug until after doing some other things. I thought it was all related enough to go in one commit.",
    "created_at": "2022-08-05T09:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479112",
    "user": "@k3w1k0d3r"
}
```

the first commit does a bit more than fix the bug because I didn't notice the bug until after doing some other things. I thought it was all related enough to go in one commit.



---

archive/issue_comments_479113.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-06T00:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479113",
    "user": "@k3w1k0d3r"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479114.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-06T09:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479114",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479115.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-07T07:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479115",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479116.json:
```json
{
    "body": "Here's an example that still fails:\n\n```sage\ndiscrete_log(Mod(0,4), Mod(2,4), 4, operation='+', algorithm='lambda')\n```\n\n\nFrom a quick glance it looks like the upper bounds passed to `discrete_log_lambda` might be off by one.\n\nYou may want to add the following test to the function to catch things like this in the future:\n\n```diff\n--- a/src/sage/groups/generic.py\n+++ b/src/sage/groups/generic.py\n@@ -833,6 +833,28 @@ def discrete_log(a, base, ord=None, bounds=None, operation='*', identity=None, i\n         sage: discrete_log(u,g,algorithm='rho')\n         123456789\n\n+    TESTS:\n+\n+    Random testing::\n+\n+        sage: G = Zmod(randrange(1, 1000))\n+        sage: base = G.random_element()\n+        sage: order = base.additive_order()\n+        sage: assert order.divides(G.cardinality())\n+        sage: sol = randrange(order)\n+        sage: elem = sol * base\n+        sage: args = (elem, base, order)\n+        sage: kwargs = {'operation': '+'}\n+        sage: kwargs['algorithm'] = choice(['bsgs', 'rho', 'lambda'])\n+        sage: if randrange(2):\n+        ....:     lo = randrange(-order, sol+1)\n+        ....:     hi = randrange(sol+1, 2*order)\n+        ....:     assert lo <= sol < hi\n+        ....:     kwargs['bounds'] = (lo, hi)\n+        sage: res = discrete_log(*args, **kwargs)\n+        sage: res == sol\n+        True\n+\n     AUTHORS:\n\n     - William Stein and David Joyner (2005-01-05)\n@@ -845,7 +867,7 @@ def discrete_log(a, base, ord=None, bounds=None, operation='*', identity=None, i\n         mult = op\n         power = lambda x, y: multiple(x, y, operation=operation, identity=identity, inverse=inverse, op=op)\n     if bounds:\n-        lb, ub = bounds\n+        lb, ub = map(integer_ring.ZZ, bounds)\n     if (op is None or identity is None or inverse is None or ord is None) and operation not in addition_names+multiplication_names:\n         raise ValueError(\"ord, op, identity, and inverse must all be specified for this operation\")\n     if ord is None:\n```\n",
    "created_at": "2022-08-08T02:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479116",
    "user": "lorenz"
}
```

Here's an example that still fails:

```sage
discrete_log(Mod(0,4), Mod(2,4), 4, operation='+', algorithm='lambda')
```


From a quick glance it looks like the upper bounds passed to `discrete_log_lambda` might be off by one.

You may want to add the following test to the function to catch things like this in the future:

```diff
--- a/src/sage/groups/generic.py
+++ b/src/sage/groups/generic.py
@@ -833,6 +833,28 @@ def discrete_log(a, base, ord=None, bounds=None, operation='*', identity=None, i
         sage: discrete_log(u,g,algorithm='rho')
         123456789

+    TESTS:
+
+    Random testing::
+
+        sage: G = Zmod(randrange(1, 1000))
+        sage: base = G.random_element()
+        sage: order = base.additive_order()
+        sage: assert order.divides(G.cardinality())
+        sage: sol = randrange(order)
+        sage: elem = sol * base
+        sage: args = (elem, base, order)
+        sage: kwargs = {'operation': '+'}
+        sage: kwargs['algorithm'] = choice(['bsgs', 'rho', 'lambda'])
+        sage: if randrange(2):
+        ....:     lo = randrange(-order, sol+1)
+        ....:     hi = randrange(sol+1, 2*order)
+        ....:     assert lo <= sol < hi
+        ....:     kwargs['bounds'] = (lo, hi)
+        sage: res = discrete_log(*args, **kwargs)
+        sage: res == sol
+        True
+
     AUTHORS:

     - William Stein and David Joyner (2005-01-05)
@@ -845,7 +867,7 @@ def discrete_log(a, base, ord=None, bounds=None, operation='*', identity=None, i
         mult = op
         power = lambda x, y: multiple(x, y, operation=operation, identity=identity, inverse=inverse, op=op)
     if bounds:
-        lb, ub = bounds
+        lb, ub = map(integer_ring.ZZ, bounds)
     if (op is None or identity is None or inverse is None or ord is None) and operation not in addition_names+multiplication_names:
         raise ValueError("ord, op, identity, and inverse must all be specified for this operation")
     if ord is None:
```




---

archive/issue_comments_479117.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-08T02:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479117",
    "user": "lorenz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_479118.json:
```json
{
    "body": "there seems to be a bug in the lambda algorithm.\n\nnotice that the second pass through lambda is the one which fails to find a logarithm. the correct logarithm for that case is 0, and the bounds passed are (0, 2). the logarithm 0 should be found within this range, but it is not. this is incorrect behavior.\n\nthe reason for this (I think) is that the pollard lambda algorithm requires inclusive bounds to be sent, but the implementation checks that `c-d<ub` (note the strict comparison) before returning. when this comparison is changed to not be strict, 2 is returned. this is a correct logarithm, albeit not the smallest. I think this change probably should be made, because the prior behavior of failing is certainly incorrect.\n\nthe lambda implementation, however, isn't the only thing mistreating the bound inclusivity/exclusivity. with that change made, `discrete_log(Mod(0,4), Mod(2,4), 4, operation='+', algorithm='lambda')` returns 2. this is valid, but not the smallest. this doesn't happen with bsgs because bsgs is guaranteed to find the smallest log in the range. one solution is to mod by pi after getting a result from lambda, but the far cleaner solution is to subtract 1 from temp_bound so that a tighter but still correct bound is passed. these are the changes I'm pushing now.",
    "created_at": "2022-08-08T04:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479118",
    "user": "@k3w1k0d3r"
}
```

there seems to be a bug in the lambda algorithm.

notice that the second pass through lambda is the one which fails to find a logarithm. the correct logarithm for that case is 0, and the bounds passed are (0, 2). the logarithm 0 should be found within this range, but it is not. this is incorrect behavior.

the reason for this (I think) is that the pollard lambda algorithm requires inclusive bounds to be sent, but the implementation checks that `c-d<ub` (note the strict comparison) before returning. when this comparison is changed to not be strict, 2 is returned. this is a correct logarithm, albeit not the smallest. I think this change probably should be made, because the prior behavior of failing is certainly incorrect.

the lambda implementation, however, isn't the only thing mistreating the bound inclusivity/exclusivity. with that change made, `discrete_log(Mod(0,4), Mod(2,4), 4, operation='+', algorithm='lambda')` returns 2. this is valid, but not the smallest. this doesn't happen with bsgs because bsgs is guaranteed to find the smallest log in the range. one solution is to mod by pi after getting a result from lambda, but the far cleaner solution is to subtract 1 from temp_bound so that a tighter but still correct bound is passed. these are the changes I'm pushing now.



---

archive/issue_comments_479119.json:
```json
{
    "body": "this actually still doesn't work. the reason is that now on the first pass of lambda, the log being calculated is 0 with base 0. any answer would be valid here, and with bounds (0, 2) lambda returns 0 but with bounds (0, 1) lambda returns 1. this leads to the next pass of lambda taking log(2) base 0, which doesn't exist. the reason is that 4 isn't the correct order of 2 (2+2=0), and pohlig-hellman relies on knowing the order of the point.\n\nI'll implement a workaround so we don't need to trust the user to provide a correct order.",
    "created_at": "2022-08-08T04:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479119",
    "user": "@k3w1k0d3r"
}
```

this actually still doesn't work. the reason is that now on the first pass of lambda, the log being calculated is 0 with base 0. any answer would be valid here, and with bounds (0, 2) lambda returns 0 but with bounds (0, 1) lambda returns 1. this leads to the next pass of lambda taking log(2) base 0, which doesn't exist. the reason is that 4 isn't the correct order of 2 (2+2=0), and pohlig-hellman relies on knowing the order of the point.

I'll implement a workaround so we don't need to trust the user to provide a correct order.



---

archive/issue_comments_479120.json:
```json
{
    "body": "Oops, sorry, I didn't mean to give an example with incorrect inputs. Here's one with the correct order where it still fails:\n\n```sage\ndiscrete_log(Mod(1,5), Mod(4,5), 5, operation='+', algorithm='lambda')\n```\n\n\nI think trusting the user to provide the correct order is fine.",
    "created_at": "2022-08-08T05:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479120",
    "user": "lorenz"
}
```

Oops, sorry, I didn't mean to give an example with incorrect inputs. Here's one with the correct order where it still fails:

```sage
discrete_log(Mod(1,5), Mod(4,5), 5, operation='+', algorithm='lambda')
```


I think trusting the user to provide the correct order is fine.



---

archive/issue_comments_479121.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-08T05:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479121",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479122.json:
```json
{
    "body": "I haven't yet made the change to map bounds to ZZ, is there any reason for that?",
    "created_at": "2022-08-08T05:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479122",
    "user": "@k3w1k0d3r"
}
```

I haven't yet made the change to map bounds to ZZ, is there any reason for that?



---

archive/issue_comments_479123.json:
```json
{
    "body": "sorry I didn't see your comment to not add the workaround, should I undo that change?",
    "created_at": "2022-08-08T05:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479123",
    "user": "@k3w1k0d3r"
}
```

sorry I didn't see your comment to not add the workaround, should I undo that change?



---

archive/issue_comments_479124.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-08T05:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479124",
    "user": "@k3w1k0d3r"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479125.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-08T05:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479125",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479126.json:
```json
{
    "body": "okay I just hit the test that shows why the map on bounds is important. it seems fitting if we have the function assume bounds might be python ints that we also assume ord could be a python int, which also messes things up, so I made that change as well.",
    "created_at": "2022-08-08T06:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479126",
    "user": "@k3w1k0d3r"
}
```

okay I just hit the test that shows why the map on bounds is important. it seems fitting if we have the function assume bounds might be python ints that we also assume ord could be a python int, which also messes things up, so I made that change as well.



---

archive/issue_comments_479127.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-08T06:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479127",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479128.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-09T14:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479128",
    "user": "lorenz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_479129.json:
```json
{
    "body": "The random doctest currently fails rather frequently when it uses the `lambda` algorithm.\n\nWe should also make up our minds whether `discrete_log()` requires the exact order or just a multiple: The documentation says it can be a multiple, but `discrete_log(Mod(20,25), Mod(5,25), 25, operation='+')` now returns `1` which is clearly wrong. (It also doesn't work in Sage 9.6, but there it fails with a `ValueError`...)",
    "created_at": "2022-08-09T14:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479129",
    "user": "lorenz"
}
```

The random doctest currently fails rather frequently when it uses the `lambda` algorithm.

We should also make up our minds whether `discrete_log()` requires the exact order or just a multiple: The documentation says it can be a multiple, but `discrete_log(Mod(20,25), Mod(5,25), 25, operation='+')` now returns `1` which is clearly wrong. (It also doesn't work in Sage 9.6, but there it fails with a `ValueError`...)



---

archive/issue_comments_479130.json:
```json
{
    "body": "the wrong  answer happens because of this clearly incorrect line that I wrote `gamma = mult(gamma, power(base, -1))`. It's fixed now, I'll push soon. I haven't yet reproduced the lambda issue so I can't investigate too much but I think it might just be because lambda is probabilistic and has a chance of failing.",
    "created_at": "2022-08-09T17:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479130",
    "user": "@k3w1k0d3r"
}
```

the wrong  answer happens because of this clearly incorrect line that I wrote `gamma = mult(gamma, power(base, -1))`. It's fixed now, I'll push soon. I haven't yet reproduced the lambda issue so I can't investigate too much but I think it might just be because lambda is probabilistic and has a chance of failing.



---

archive/issue_comments_479131.json:
```json
{
    "body": "can you give the failing lambda parameters? I'm running the random test on loop with lambda algorithm only but I'm not seeing any issues.",
    "created_at": "2022-08-09T17:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479131",
    "user": "@k3w1k0d3r"
}
```

can you give the failing lambda parameters? I'm running the random test on loop with lambda algorithm only but I'm not seeing any issues.



---

archive/issue_comments_479132.json:
```json
{
    "body": "okay I'm pretty sure the failing lambda tests are because of the probabilistic nature of pollard lambda. they all seem to sometimes succeed and sometimes fail. as an example `discrete_log(Mod(656, 956), Mod(698, 956), operation='+', algorithm='lambda')`.",
    "created_at": "2022-08-09T17:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479132",
    "user": "@k3w1k0d3r"
}
```

okay I'm pretty sure the failing lambda tests are because of the probabilistic nature of pollard lambda. they all seem to sometimes succeed and sometimes fail. as an example `discrete_log(Mod(656, 956), Mod(698, 956), operation='+', algorithm='lambda')`.



---

archive/issue_comments_479133.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-09T17:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479133",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479134.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-09T17:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479134",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479135.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-09T18:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479135",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479136.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-09T19:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479136",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479137.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-09T19:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479137",
    "user": "@k3w1k0d3r"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479138.json:
```json
{
    "body": "finally got the last bug I've noticed out.",
    "created_at": "2022-08-09T19:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479138",
    "user": "@k3w1k0d3r"
}
```

finally got the last bug I've noticed out.



---

archive/issue_comments_479139.json:
```json
{
    "body": "Looks good, thank you for all the work.\n\nNow we just need to avoid the doctest failures when `lambda` fails randomly. Maybe like this?\n\n\n```diff\n--- a/src/sage/groups/generic.py\n+++ b/src/sage/groups/generic.py\n@@ -851,9 +851,14 @@ def discrete_log(a, base, ord=None, bounds=None, operation='*', identity=None, i\n         ....:     hi = randrange(sol+1, 2*order)\n         ....:     assert lo <= sol <= hi\n         ....:     kwargs['bounds'] = (lo, hi)\n-        sage: res = discrete_log(*args, **kwargs)\n-        sage: res == sol\n-        True\n+        sage: try:\n+        ....:     res = discrete_log(*args, **kwargs)\n+        ....: except ValueError:\n+        ....:     # lambda can fail randomly\n+        ....:     if kwargs['algorithm'] != 'lambda':\n+        ....:         raise\n+        ....: else:\n+        ....:     assert res == sol\n\n     AUTHORS:\n\n```\n\n\nYou may also want to consider adding yourself to the list of authors for the `discrete_log` function.",
    "created_at": "2022-08-10T03:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479139",
    "user": "lorenz"
}
```

Looks good, thank you for all the work.

Now we just need to avoid the doctest failures when `lambda` fails randomly. Maybe like this?


```diff
--- a/src/sage/groups/generic.py
+++ b/src/sage/groups/generic.py
@@ -851,9 +851,14 @@ def discrete_log(a, base, ord=None, bounds=None, operation='*', identity=None, i
         ....:     hi = randrange(sol+1, 2*order)
         ....:     assert lo <= sol <= hi
         ....:     kwargs['bounds'] = (lo, hi)
-        sage: res = discrete_log(*args, **kwargs)
-        sage: res == sol
-        True
+        sage: try:
+        ....:     res = discrete_log(*args, **kwargs)
+        ....: except ValueError:
+        ....:     # lambda can fail randomly
+        ....:     if kwargs['algorithm'] != 'lambda':
+        ....:         raise
+        ....: else:
+        ....:     assert res == sol

     AUTHORS:

```


You may also want to consider adding yourself to the list of authors for the `discrete_log` function.



---

archive/issue_comments_479140.json:
```json
{
    "body": "thanks. is there any reason to leave lambda in the random tests if we don't actually check if it worked?",
    "created_at": "2022-08-10T03:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479140",
    "user": "@k3w1k0d3r"
}
```

thanks. is there any reason to leave lambda in the random tests if we don't actually check if it worked?



---

archive/issue_comments_479141.json:
```json
{
    "body": "We still check `res == sol` in case there is no exception. Thus, the test is not vacuous: It guarantees that *if* the `lambda` implementation returns something, then it's correct.",
    "created_at": "2022-08-10T03:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479141",
    "user": "lorenz"
}
```

We still check `res == sol` in case there is no exception. Thus, the test is not vacuous: It guarantees that *if* the `lambda` implementation returns something, then it's correct.



---

archive/issue_comments_479142.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-10T04:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479142",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479143.json:
```json
{
    "body": "thank you!",
    "created_at": "2022-08-10T04:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479143",
    "user": "@k3w1k0d3r"
}
```

thank you!



---

archive/issue_comments_479144.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-10T05:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479144",
    "user": "lorenz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479145.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-30T19:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33663#issuecomment-479145",
    "user": "vbraun"
}
```

Resolution: fixed
