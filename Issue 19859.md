# Issue 19859: Replace ATLAS by OpenBLAS

Issue created by migration from Trac.

Original creator: cpernet

Original creation time: 2016-02-22 13:15:32

CC:  jpflori

Keywords: BLAS

OpenBLAS should replace ATLAS as it is 
 * (much) faster to install
 * faster to run

This replacement is mentionned in #17635 (upgrade fflas-ffpack) and is related to #19719 (upgrade ATLAS), and #17630 (clean up the BLAS).


---

Comment by vbraun created at 2016-02-22 14:29:45

Hardcoding one blas over another blas ist imho the wrong way. It should be configurable, see #17075.


---

Comment by cpernet created at 2016-02-22 14:39:13

Sure. I should have been clearer: the idea is to
- change the default BLAS installed by [SageMath](SageMath) from ATLAS to OpenBLAS
- let the user the option to specify which BLAS to link against.
- simplify the current BLAS, BLAS2 variable mess


---

Comment by cpernet created at 2016-02-22 15:49:53

Changing component from linear algebra to packages: standard.


---

Comment by jpflori created at 2016-05-09 10:08:21

Should we close this after #20542?
Or switch to openblas by default here?


---

Comment by jpflori created at 2016-08-09 09:25:26

Anyone else thinks we should go ahead with this one?


---

Comment by vbraun created at 2016-08-09 16:51:08

+1... send a patch ;-)


---

Comment by cpernet created at 2016-08-23 17:48:23

New commits:


---

Comment by git created at 2016-08-23 18:15:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-23 20:18:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-08-23 21:07:10

Changing status from new to needs_review.


---

Comment by jpflori created at 2016-08-23 21:07:10

Changing keywords from "BLAS" to "BLAS, sd75".


---

Comment by jpflori created at 2016-08-23 21:15:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-24 22:16:00

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-08-24 22:16:00


```
sage -t --long src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 179, in sage.misc.package.list_packages
Failed example:
    sorted(L.keys())
Expected:
    ['alabaster',
     'arb',
     'atlas',
     ...
     'zn_poly',
     'zope_interface']
Got:
    ['alabaster',
     'arb',
     'babel',
     'backports_abc',
```



---

Comment by git created at 2016-08-24 22:41:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cpernet created at 2016-08-24 22:44:50

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-08-26 21:24:52

Openblas fails to build on some 32-bit Linux platforms, e.g. http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu16_32s02%20%28Ubuntu%2016.04%2032%20bit%29%20incremental/builds/258/steps/compile_1/logs/stdio

```
[openblas-0.2.15] gfortran -O2 -Wall  -L/home/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildbot/slave/sage_git/build/local/lib  -o sblat1 sblat1.o ../libopenblas_haswellp-r0.2.15.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran 
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(saxpy.o): In function `saxpy_':
[openblas-0.2.15] axpy.c:(.text+0x9a): undefined reference to `saxpy_k'
[openblas-0.2.15] axpy.c:(.text+0x12a): undefined reference to `saxpy_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(sswap.o): In function `sswap_':
[openblas-0.2.15] swap.c:(.text+0x84): undefined reference to `sswap_k'
[openblas-0.2.15] swap.c:(.text+0xfb): undefined reference to `sswap_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(scopy.o): In function `scopy_':
[openblas-0.2.15] copy.c:(.text+0x41): undefined reference to `scopy_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(sscal.o): In function `sscal_':
[openblas-0.2.15] scal.c:(.text+0x67): undefined reference to `sscal_k'
[openblas-0.2.15] scal.c:(.text+0xc1): undefined reference to `sscal_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(sdot.o): In function `sdot_':
[openblas-0.2.15] dot.c:(.text+0x41): undefined reference to `sdot_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(sasum.o): In function `sasum_':
[openblas-0.2.15] asum.c:(.text+0x28): undefined reference to `sasum_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(snrm2.o): In function `snrm2_':
[openblas-0.2.15] nrm2.c:(.text+0x28): undefined reference to `snrm2_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(isamax.o): In function `isamax_':
[openblas-0.2.15] imax.c:(.text+0x2b): undefined reference to `isamax_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(srot.o): In function `srot_':
[openblas-0.2.15] rot.c:(.text+0x4f): undefined reference to `srot_k'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(memory.o): In function `blas_memory_alloc':
[openblas-0.2.15] memory.c:(.text+0x456): undefined reference to `cpuid'
[openblas-0.2.15] ../libopenblas_haswellp-r0.2.15.a(parameter.o): In function `get_L2_size':
[openblas-0.2.15] parameter.c:(.text+0x35): undefined reference to `cpuid'
[openblas-0.2.15] collect2: error: ld returned 1 exit status
```



---

Comment by vbraun created at 2016-08-26 21:24:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-08-26 22:32:12

Also, numerical noise:

```
sage -t --long src/sage/matrix/matrix_double_dense.pyx
**********************************************************************
File "src/sage/matrix/matrix_double_dense.pyx", line 1009, in sage.matrix.matrix_double_dense.Matrix_double_dense.singular_values
Failed example:
    A.condition() > 1.6e16 or A.condition()
Expected:
    True
Got:
    1.5972138093369194e+16
**********************************************************************
1 item had failures:
   1 of  31 in sage.matrix.matrix_double_dense.Matrix_double_dense.singular_values
    [636 tests, 1 failure, 1.91 s]
```



---

Comment by vbraun created at 2016-08-26 22:33:36

More numerical noise:

```
sage -t --long src/sage/modular/modform/numerical.py
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 429, in sage.modular.modform.numerical.NumericalEigenforms.eigenvalues
Failed example:
    n.eigenvalues([3,5,13])  # rel tol 2e-10
Expected:
    [[177148.0, 252.00000000001896], [48828126.0, 4830.000000001376], [1792160394038.0, -577737.9999898539]]
Got:
    [[177148.0, 252.00000000001413],
     [48828126.0, 4830.000000003907],
     [1792160394038.0, -577737.9998566243]]
Tolerance exceeded in 1 of 6:
    -577737.9999898539 vs -577737.9998566243, tolerance 2e-10 > 2e-10
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 446, in sage.modular.modform.numerical.NumericalEigenforms.eigenvalues.phi
Failed example:
    n.eigenvalues([3,5,13])  # rel tol 2e-10
Expected:
    [[177148.0, 252.00000000001896], [48828126.0, 4830.000000001376], [1792160394038.0, -577737.9999898539]]
Got:
    [[177148.0, 252.00000000001413],
     [48828126.0, 4830.000000003907],
     [1792160394038.0, -577737.9998566243]]
Tolerance exceeded in 1 of 6:
    -577737.9999898539 vs -577737.9998566243, tolerance 2e-10 > 2e-10
**********************************************************************
2 items had failures:
   1 of   3 in sage.modular.modform.numerical.NumericalEigenforms.eigenvalues
   1 of   3 in sage.modular.modform.numerical.NumericalEigenforms.eigenvalues.phi
    [46 tests, 2 failures, 0.56 s]
```



---

Comment by cpernet created at 2016-08-28 12:46:21

Very surprising.
Could you give the details on the host architecture where the numerical noise issues appeared (`uname -a` and `cat /proc/cpuinfo`)?
I could not reproduce them on my x86_64 sandibridge running linux-mint 14. 

Similarly for the 32 bit linking errors (it never saw it fail to compile on 32 bits ubuntu's). I could then try to find a similar arch and investigate it and/or report the problem upstream.


---

Comment by vbraun created at 2016-08-28 13:16:46

The buildbot machine with the link failure is Ubuntu 16.04 32-bit (in a VM).

As far as the numerical noise goes, the tolerance just needs to be incremented a a tiny bit.


---

Comment by cpernet created at 2016-08-29 06:20:50

The linking issue looks like [https://github.com/xianyi/OpenBLAS/issues/657](https://github.com/xianyi/OpenBLAS/issues/657).
OpenBLAS devs say they did not tune the 32bit haswell case, and recommend passing `BINARY=32` to make which will default to nehalem kernels.


---

Comment by git created at 2016-08-29 10:13:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-29 12:42:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cpernet created at 2016-08-30 06:55:56

The last two commits fix the two issues raised by Volker:
* linking error on 32 bits -> passing BINARY=32 to make
* numerical noise -> fixing the tolerance


---

Comment by cpernet created at 2016-08-30 06:55:56

Changing status from needs_work to needs_review.


---

Comment by cpernet created at 2016-08-30 16:24:07

Changing status from needs_review to needs_work.


---

Comment by cpernet created at 2016-08-30 16:24:07

Damn, this patch doesn't work as SAGE64 is not necessarily set to yes when compiling on a 64 bits machine.
After reading about the uselessness of SAGE64 on sage-devel, and browsing through MPIR's and M4RI's spkg's I don't find  any environment variable that would tell us whether the target architecture is 32 or 64 bits.

An option could be to copy/paste MPIR's long case switch setting ABI=32/64. Does anybody have a better solution?


---

Comment by git created at 2016-08-30 16:46:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cpernet created at 2016-08-30 16:50:54

Ok, I pushed an new python way of checking this.


---

Comment by cpernet created at 2016-08-30 16:50:54

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-08-30 16:51:16

IMHO at this point its easier to just write the spkg-install in Python


---

Comment by jpflori created at 2016-08-30 17:46:20

Replying to [comment:32 cpernet]:
> Damn, this patch doesn't work as SAGE64 is not necessarily set to yes when compiling on a 64 bits machine.
> After reading about the uselessness of SAGE64 on sage-devel, and browsing through 
Yes indeed.
`SAGE64` was used on strange archs where kernel is 64 bits but userspace is 32 bits by default, e.g. old OS X or Solaris.


---

Comment by jpflori created at 2016-08-30 17:47:41

Replying to [comment:34 cpernet]:
> Ok, I pushed an new python way of checking this.
Then we should make the `spkg` dependent on `python`.
Note that `ATLAS` install script also used `python` so there is no regression here.


---

Comment by jpflori created at 2016-08-30 17:48:03

(I mean the `spkg-intall` script for `ATLAS`).


---

Comment by jpflori created at 2016-08-30 17:54:41

Maybe using something with `uname -m` could work without depending on python?
And maybe it's time for a `testabi.sh` script in `sage/src/bin/`?

`@`volker: any preferred solution?


---

Comment by vbraun created at 2016-08-31 06:51:18

We require a system python so it doesn't have to depend on our Python. IMHO the atlas dependency is incorrect. It needs to be python2/3 compatible, though.


---

Comment by jpflori created at 2016-08-31 08:22:21

Not sure it is what Volker meant, but you cannot use `print` the same way in Python 2 and 3...


---

Comment by git created at 2016-08-31 11:32:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2016-08-31 11:40:59

You can after

```
from __future__ import print_function
```



---

Comment by cpernet created at 2016-08-31 11:44:15

I've just fixed the `print` so it would work on a system python v3 as well as v2.

As for comment:39 : a solution using calls to `uname` is being used in mpir/spkg-install. It would be a good starting point to write a `testabi.sh`, but I do not feel confident enough with sage's build system to write myself.
I also find this solution rather complicated, compared to calling python's `plateform.architecture()`

If required, I'll rewrite the `spkg-install` in python, but as I noticed many other `spkg-install`s are in bash and make a one line call to python, I thought it would be ok like this.


---

Comment by jpflori created at 2016-09-05 09:37:04

Replying to [comment:44 cpernet]:
> I've just fixed the `print` so it would work on a system python v3 as well as v2.
That's quite lucky :)
Adding

```
from __future__ import print_function
```

turns `print` into a real function.
With your code it calls the magic `print` on `("...")` which turns out to have the same behavior in this specific case.
> 
> As for comment:39 : a solution using calls to `uname` is being used in mpir/spkg-install. It would be a good starting point to write a `testabi.sh`, but I do not feel confident enough with sage's build system to write myself.
> I also find this solution rather complicated, compared to calling python's `plateform.architecture()`
> 
> If required, I'll rewrite the `spkg-install` in python, but as I noticed many other `spkg-install`s are in bash and make a one line call to python, I thought it would be ok like this.
Nope, please don't do so.


---

Comment by git created at 2016-09-12 12:06:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-09-12 12:06:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-12 20:28:13

On arando (linux 32-bit):

```
[openblas-0.2.15] gfortran -O2 -Wall  -L/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildslave-sage/slave/sage_git/build/local/lib  -o zblat3 zblat3.o ../libopenblas_sandybridgep-r0.2.15.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran 
[openblas-0.2.15] ../libopenblas_sandybridgep-r0.2.15.a: file not recognized: File truncated
[openblas-0.2.15] collect2: error: ld returned 1 exit status
[openblas-0.2.15] make[4]: *** [dblat3] Error 1
[openblas-0.2.15] ../libopenblas_sandybridgep-r0.2.15.a: file not recognized: File truncated
[openblas-0.2.15] collect2: error: ld returned 1 exit status
[openblas-0.2.15] make[4]: *** [cblat3] Error 1
[openblas-0.2.15] ../libopenblas_sandybridgep-r0.2.15.a: file not recognized: File truncated
[openblas-0.2.15] collect2: error: ld returned 1 exit status
[openblas-0.2.15] make[4]: *** [zblat3] Error 1
[openblas-0.2.15] make[4]: Target `all' not remade because of errors.
[openblas-0.2.15] make[4]: Leaving directory `/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/openblas-0.2.15/src/test'
[openblas-0.2.15] make[3]: *** [tests] Error 2
[openblas-0.2.15] make[3]: Leaving directory `/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/openblas-0.2.15/src'
[openblas-0.2.15] Error while running the OpenBLAS testsuite ... exiting
[openblas-0.2.15] 
[openblas-0.2.15] real	0m0.438s
[openblas-0.2.15] user	0m0.172s
[openblas-0.2.15] sys	0m0.024s
[openblas-0.2.15] ************************************************************************
[openblas-0.2.15] Error testing package openblas-0.2.15
```



---

Comment by vbraun created at 2016-09-12 20:28:13

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-09-12 20:31:16

The first occurence of "libopenblas_sandybridgep" is 

```
[openblas-0.2.15] touch libopenblas_sandybridgep-r0.2.15.a
[openblas-0.2.15] make -j 4 -C test all
[openblas-0.2.15] make[4]: Entering directory `/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/openblas-0.2.15/src/test'
[openblas-0.2.15] gfortran -O2 -Wall  -L/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildslave-sage/slave/sage_git/build/local/lib  -o sblat1 sblat1.o ../libopenblas_sandybridgep-r0.2.15.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran 
[openblas-0.2.15] gfortran -O2 -Wall  -L/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildslave-sage/slave/sage_git/build/local/lib  -o dblat1 dblat1.o ../libopenblas_sandybridgep-r0.2.15.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran 
[openblas-0.2.15] gfortran -O2 -Wall  -L/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildslave-sage/slave/sage_git/build/local/lib  -o cblat1 cblat1.o ../libopenblas_sandybridgep-r0.2.15.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran 
[openblas-0.2.15] gfortran -O2 -Wall  -L/home/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildslave-sage/slave/sage_git/build/local/lib  -o zblat1 zblat1.o ../libopenblas_sandybridgep-r0.2.15.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran 
[openblas-0.2.15] ../libopenblas_sandybridgep-r0.2.15.a: file not recognized: File truncated
[openblas-0.2.15] collect2: error: ld returned 1 exit status
[openblas-0.2.15] ../libopenblas_sandybridgep-r0.2.15.a: file not recognized: File truncated
[openblas-0.2.15] make[4]: *** [sblat1] Error 1
```

You can't build a static archive with "touch" %-)


---

Comment by jpflori created at 2016-09-13 09:09:31

Oops...


---

Comment by jpflori created at 2016-09-13 09:17:59

Isn't there a previous issue with the static archive in the log?
`touch` is maybe just here to update the timestamp...

We could/should also disable building a static archive.

And update openblas to 0.2.19 and hope the problem disappear...


---

Comment by jpflori created at 2016-09-13 09:36:14

Indeed on my machine, running `make tests` starts by touching the static archive.
No we have to devise why passing `BINARY=32` somehow prevents the required archive to be produced.
`@`volker: can you tell us what `so` and `a` files were produced on arando?


---

Comment by vbraun created at 2016-09-13 09:37:49

No, there was no previous apperance. It could have been `> /dev/null` but there is no valid .a ...

Ask Dima for an account on arando.


---

Comment by vbraun created at 2016-09-13 09:38:16

In general, disabling static libs is a +1 from me


---

Comment by jpflori created at 2016-09-14 11:18:27

Hum this was actually an easy one...
In `spkg-check` we run `make tests` without `BINARY=32` so the static archive name the tests want to link to is not the right one...


---

Comment by git created at 2016-09-14 11:28:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-09-14 11:37:28

Changing status from needs_work to positive_review.


---

Comment by jpflori created at 2016-09-14 11:37:28

The modification is quite easy so I put this back to positive review.

`@`volker: if you think we'd better patch the `Makefile` to use a symlink for linking to the static archive when building the tests, please put this back to `needs_work`.


---

Comment by vbraun created at 2016-09-16 06:55:26

Resolution: fixed


---

Comment by leif created at 2016-10-02 14:09:59

Replying to [comment:37 jpflori]:
> Replying to [comment:34 cpernet]:
> > Ok, I pushed an new python way of checking this.
> Then we should make the `spkg` dependent on `python`.
> Note that `ATLAS` install script also used `python` so there is no regression here.

This is a bug.  Sage meanwhile _requires_ a system Python (>= 2.6) to build / bootstrap anyway.

And while ATLAS' `spkg-install` in some files at least claims to aim at compatibility to Python 2.4(!), I have some patches to make it work with Python 2.6 (in order to drop the dependency on _Sage's_ Python, such that it is built *early*, almost first)...


---

Comment by leif created at 2016-10-02 14:12:46

Follow-up w.r.t. OpenBLAS brokenness:  #21561 (build issues; it also segfaults on AMD CPUs, cf. sage-devel thread from September 25th)


---

Comment by vbraun created at 2016-12-04 19:41:23

Apologies, wrong ticket!
