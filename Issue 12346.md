# Issue 12346: Enumerated set from iterator

Issue created by migration from https://trac.sagemath.org/ticket/12518

Original creator: vdelecroix

Original creation time: 2012-02-16 09:25:49

Assignee: vdelecroix

CC:  sstarosta

Keywords: set, iterator

Implementation of a set (using the category framework) from a function that returns an iterator. Building a set directly from an iterator leads to the impossibility of pickling.

A previous implementation was CombinatorialClassFromIterator (in sage.combinat.combinat) which is now deprecated.


---

Comment by vdelecroix created at 2012-02-16 09:31:01

Hi,

I'm in trouble with two points:

1) What to do with the equality test when the set are both infinite ? (see in the patch the warning printing on stderr)

2) What is the good way to implement the decorator for a method ? The implementation for functions work quite well but in sage.misc.cachefunc the implementation for methods rather than functions seem more tricky.


---

Comment by vdelecroix created at 2012-02-18 15:55:16

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2012-02-28 16:10:48

I removed trailing whitespaces and correct a failing doctest.


---

Comment by vdelecroix created at 2012-03-09 02:23:21

I changed the attachment in order to make the patchbot happy :-)


---

Comment by davidloeffler created at 2012-03-11 11:25:20

But patchbot's not happy -- a bunch of doctests fail (as you can see from the latest patchbot logs). I reproduced this by hand on 5.0.beta7, so it's not just a patchbot issue. The failures all have something to do with dicts not being hashable. (I'm not sure what patch has caused this conflict, but it worked in 5.0.beta3; my guess would be #10998.)


---

Comment by davidloeffler created at 2012-03-11 11:25:20

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2012-03-12 23:41:21

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2012-04-29 19:22:00

I just remove the only trailing whitespace (in sage/combinat/combinat.py) that made the patchbot unhappy.


---

Comment by tscrim created at 2012-11-27 23:40:54

Hey Vincent,

I also get the patchbot errors when running the patch in the combinat queue on 5.5.rc0. Also from a quick look-through the patch, there are a few things which I believe needs to be addressed:
- Documentation and tests for the deprecated functions in `combinat/combinat.py`
- An example in `iter_with_cache()`, I also don't quite understand the documentation.
- You'll need to add `iter_with_cache` and `set_from_iterator` to the documentation by adding/editing a `.rst` file (probably `misc.rst`).
- I prefer to see the reserved words in code blocks: ```None```, ```self```, ```True```, and ```False```
- Same for input parameters and private functions, even in private functions.
- I prefer to have as much linking as possible: ex. `:class:`EnumeratedSetFromIterator``
- Instead of
  {{{#!python
  if x is True:
  ...
  if x is False:
  ...
  }}}
  it is better to do
  {{{#!python
  if x:
  ...
  if not x:
  ...
  }}}
  in case `x` is not a boolean (ex. `x = 1`).

Thanks,

Travis


---

Comment by vdelecroix created at 2012-11-28 06:21:49

Hi Travis,

> I also get the patchbot errors when running the patch in the combinat queue on 5.5.rc0. Also from a quick look-through the patch, there are a few things which I believe needs to be addressed:
> - Documentation and tests for the deprecated functions in `combinat/combinat.py`

These functions were *only* in the sage-combinat queues and not inside Sage. So the deprecation is just intended for people from combinat who were using it (and I think that none of them uses it).

> - An example in `iter_with_cache()`, I also don't quite understand the documentation.

I will open (few days) a new ticket for a better implementation of iter_with_cache. There is a similar construction in lazy power series and I would like to merge both. The idea is to have a Python data structure that behave like a list but with possibly infinitely many entries.

> - I prefer to see the reserved words in code blocks: ```None```, ```self```, ```True```, and ```False```

Is there a difference for documentation ? I thought that code blocks open a new paragraph.

Thanks for careful reading, I will adress all remarks in a new patch.

Best,
Vincent


---

Comment by tscrim created at 2012-11-29 16:45:37

Hey Vincent,

> > I also get the patchbot errors when running the patch in the combinat queue on 5.5.rc0. Also from a quick look-through the patch, there are a few things which I believe needs to be addressed:
> > - Documentation and tests for the deprecated functions in `combinat/combinat.py`
> 
> These functions were *only* in the sage-combinat queues and not inside Sage. So the deprecation is just intended for people from combinat who were using it (and I think that none of them uses it).

Since these functions are not in sage, its probably best to remove these functions from this patch and then put a second patch in the combinat queue deprecating these functions.

> > - I prefer to see the reserved words in code blocks: ```None```, ```self```, ```True```, and ```False```
> 
> Is there a difference for documentation ? I thought that code blocks open a new paragraph.

I should have called it (inline) code format, and it just changes the format in the output html.

Thanks,

Travis


---

Attachment


---

Comment by vdelecroix created at 2012-11-30 06:12:58

Hi,

The error in patchbot comes from the lazy import of graphs (which does not support pickling). I modify a little bit the implementation to use the generic framework of lazy list (in #13778). In particular, there is no more iter_with_cache.

Best,
Vincent


---

Comment by tscrim created at 2012-12-04 17:57:18

Hey Vincent,

I'm uploading a review patch which just makes some documentation tweaks. Functionally it looks good. 

However I would like those functions in `combinat/combinat.py` removed since they only exist in your patch (I grep'ed the patches in the queue and only found them in this patch), and I believe we don't need to follow the sage deprecation scheme within the combinat queue (please correct me if I'm wrong). If you're worried about it, I would place the functions in a separate patch.

Thank you,

Travis


---

Attachment


---

Comment by vdelecroix created at 2012-12-06 07:41:59

Hi Travis,

> I'm uploading a review patch which just makes some documentation tweaks. Functionally it looks good. 

I fold your patch in trac_12518-*-final-*
 
> However I would like those functions in `combinat/combinat.py` removed since they only exist in your patch (I grep'ed the patches in the queue and only found them in this patch), and I believe we don't need to follow the sage deprecation scheme within the combinat queue (please correct me if I'm wrong). If you're worried about it, I would place the functions in a separate patch.

I removed it and I also delete the decorator on bruhat_succ adn bruhat_pred that was previously on the sage-combinat server.


Thanks,
Vincent


---

Comment by tscrim created at 2012-12-06 08:58:44

Hey Vincent,

Thanks. However there's one small mistake (and it's mine in the review patch, sorry) in the class doc for `EnumeratedSetFromIterator`, it should be `.. NOTE::`, the space is missing.

Best,

Travis

Edit - Once you do this, feel free to set this to positive review.

For patchbot:

Apply only: trac_12518-enumerated_set_from_iterator-final.patch


---

Comment by vdelecroix created at 2012-12-06 09:34:15

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2012-12-06 09:34:15

All right... done


---

Comment by vdelecroix created at 2012-12-06 12:42:26

apply trac_12518-enumerated_set_from_iterator-final.patch

(for patchbot)


---

Comment by vdelecroix created at 2012-12-06 14:09:39

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2012-12-06 14:09:39

The following does not work

```
sage: from sage.sets.set_from_iterator import set_from_method
sage: class A:
...     a = 10
...     @set_from_method
...     def f(self):
...         return xsrange(self.a)
sage: a = A()
sage: a.f()             # works perfectly
{0, 1, 2, 3, 4, ...}
sage: A.f(a)            # does not work at all
Traceback (most recent call last):
...
TypeError: f() takes exactly 1 argument (2 given)
```


It causes many problems with element classes which are Cython classes.

I am on this. Sorry.
Vincent


---

Comment by vdelecroix created at 2012-12-06 17:43:20

apply trac_12518-enumerated_set_from_iterator-final.patch

(for patchbot)


---

Comment by vdelecroix created at 2012-12-06 17:44:13

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2012-12-06 17:50:46

Hey Vincent,

Could you remove all of your (commented) print statements and move the `DummyExampleForPicklingTest` into the doctest for `__init__()` where you use it?

Thanks,

Travis


---

Comment by vdelecroix created at 2012-12-06 18:01:29

Hey Travis,

> Could you remove all of your (commented) print statements

This I can.

> and move the `DummyExampleForPicklingTest` into the doctest for `__init__()` where you use it?

Do you mean put the whole class DummyExampleForPicklingTest into the doctest ? If it is the case, I can not because pickling classes defined in an interactive console is not (easily) possible.

Cheers,
Vincent


---

Comment by tscrim created at 2012-12-06 18:16:06

Replying to [comment:26 vdelecroix]:
> > and move the `DummyExampleForPicklingTest` into the doctest for `__init__()` where you use it?
> 
> Do you mean put the whole class DummyExampleForPicklingTest into the doctest ? If it is the case, I can not because pickling classes defined in an interactive console is not (easily) possible.
Ah okay, then a quick doctest for the `f()` method and something like:

```
.. WARNING::

    This class is used for pickling tests only. Do not use.
```

docstring for the class. Thanks.


---

Attachment

apply trac_12518-enumerated_set_from_iterator-final.patch

(for patchbot)


---

Comment by tscrim created at 2012-12-06 18:37:20

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2012-12-06 18:37:20

Looks good to me now. Thanks Vincent.


---

Comment by vdelecroix created at 2012-12-07 07:39:05

Replying to [comment:29 tscrim]:
> Looks good to me now. Thanks Vincent.

Thanks for your review !


---

Comment by vdelecroix created at 2012-12-07 09:09:21

apply trac_12518-enumerated_set_from_iterator-final.patch trac_12518-enumerated_set_from_iterator-final_fix.patch

(for patchbot)


---

Comment by jdemeyer created at 2012-12-30 09:22:57

[attachment:trac_12518-enumerated_set_from_iterator-final_fix.patch] is missing a commit message.


---

Comment by jdemeyer created at 2012-12-30 09:22:57

Changing status from positive_review to needs_work.


---

Attachment

Replying to [comment:35 jdemeyer]:
> [attachment:trac_12518-enumerated_set_from_iterator-final_fix.patch] is missing a commit message.

Thanks. Done.


---

Comment by jdemeyer created at 2013-01-01 11:37:17

Resolution: fixed


---

Comment by jdemeyer created at 2015-02-18 11:28:13

Could you please explain the motivation behind the doctests

```
        TESTS::

            sage: from sage.sets.set_from_iterator import set_from_method
            sage: from sage.structure.misc import getattr_from_other_class
            sage: class A:
            ...      stop = 10000
            ...      @set_from_method
            ...      def f(self,start):
            ...          return xsrange(start,self.stop)
            sage: a = A()
            sage: getattr_from_other_class(a, A, 'f')(4)
            {4, 5, 6, 7, 8, ...}

            sage: class B:
            ...      stop = 10000
            ...      @set_from_method(category=FiniteEnumeratedSets())
            ...      def f(self,start):
            ...          return xsrange(start,self.stop)
            sage: b = B()
            sage: getattr_from_other_class(b, B, 'f')(2)
            {2, 3, 4, 5, 6, ...}
```


However, the documentation of `getattr_from_other_class` says:

```
    If self is an instance of cls, raises an ``AttributeError``, to
    avoid a double lookup. This function is intended to be called from
    __getattr__, and so should not be called if name is an attribute
    of self.
```


But this is precisely what that doctest is doing! Due to a bug in `getattr_from_other_class` (see #17801), the `AttributeError` is not always raised when it should. The obvious fix for that bug gives doctest failures in the above doctests.


---

Comment by vdelecroix created at 2015-02-18 12:06:44

Replying to [comment:38 jdemeyer]:
> Could you please explain the motivation behind the doctests
> ...

No idea. I guess it would be safe to replace them with `sage: A.f(a,4)` and `sage: B.f(b,2)`.
