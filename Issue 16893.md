# Issue 16893: Coercion after _eval_() in symbolic functions

archive/issues_016893.json:
```json
{
    "body": "CC:  burcin rws\n\nThis uses coercion correctly:\n\n```\nsage: bessel_Y._eval_(RealField(300)(1), 1.0)\n-0.781212821300289\n```\n\n\nHowever, it seems that `__call__()` coerces this result back to the first parent, giving false precision:\n\n```\nsage: bessel_Y(RealField(300)(1), 1.0)\n-0.781212821300288684511770043172873556613922119140625000000000000000000000000000000000000000\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17130\n\n",
    "created_at": "2014-10-10T09:22:33Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Coercion after _eval_() in symbolic functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16893",
    "user": "jdemeyer"
}
```
CC:  burcin rws

This uses coercion correctly:

```
sage: bessel_Y._eval_(RealField(300)(1), 1.0)
-0.781212821300289
```


However, it seems that `__call__()` coerces this result back to the first parent, giving false precision:

```
sage: bessel_Y(RealField(300)(1), 1.0)
-0.781212821300288684511770043172873556613922119140625000000000000000000000000000000000000000
```


Issue created by migration from https://trac.sagemath.org/ticket/17130





---

archive/issue_comments_223701.json:
```json
{
    "body": "Just to clarify, you mean that the precision of the less precise input (`1.0`) is used, but then for some reason this is sent back to the precision of the first one? \n\nMy guess is that [this line](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/symbolic/function.pyx#n919) is to blame. \n\n```\n        # we want to convert the result to the original parent if the input\n        # is not exact, so we store the parent here\n        org_parent = parent_c(args[0])\n```\n\nI don't have time right now to check this out, but I would not be at all surprised.  Or it's the `super` call just above that, I don't myself 100% understand how the inheritance works, and I keep forgetting when `eval` versus `call` are called in the functions.  You could try other functions with multiple arguments and see if the same problem happens, or try to reverse the precisions and see what happens to test this hypothesis.",
    "created_at": "2014-10-10T09:51:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223701",
    "user": "kcrisman"
}
```

Just to clarify, you mean that the precision of the less precise input (`1.0`) is used, but then for some reason this is sent back to the precision of the first one? 

My guess is that [this line](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/symbolic/function.pyx#n919) is to blame. 

```
        # we want to convert the result to the original parent if the input
        # is not exact, so we store the parent here
        org_parent = parent_c(args[0])
```

I don't have time right now to check this out, but I would not be at all surprised.  Or it's the `super` call just above that, I don't myself 100% understand how the inheritance works, and I keep forgetting when `eval` versus `call` are called in the functions.  You could try other functions with multiple arguments and see if the same problem happens, or try to reverse the precisions and see what happens to test this hypothesis.



---

archive/issue_comments_223702.json:
```json
{
    "body": "Replying to [comment:1 kcrisman]:\n> Just to clarify, you mean that the precision of the less precise input (`1.0`) is used, but then for some reason this is sent back to the precision of the first one? \nYes, the less-precise result is converted to the more-precise parent.",
    "created_at": "2014-10-10T09:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223702",
    "user": "jdemeyer"
}
```

Replying to [comment:1 kcrisman]:
> Just to clarify, you mean that the precision of the less precise input (`1.0`) is used, but then for some reason this is sent back to the precision of the first one? 
Yes, the less-precise result is converted to the more-precise parent.



---

archive/issue_comments_223703.json:
```json
{
    "body": "Replying to [comment:1 kcrisman]:\n> {{{\n>         # we want to convert the result to the original parent if the input\n>         # is not exact, so we store the parent here\n>         org_parent = parent_c(args[0])\n> }}}\nEspecially the `args[0]` is very suspicious indeed.",
    "created_at": "2014-10-10T10:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223703",
    "user": "jdemeyer"
}
```

Replying to [comment:1 kcrisman]:
> {{{
>         # we want to convert the result to the original parent if the input
>         # is not exact, so we store the parent here
>         org_parent = parent_c(args[0])
> }}}
Especially the `args[0]` is very suspicious indeed.



---

archive/issue_comments_223704.json:
```json
{
    "body": "The following patch fixes the problem\n\n```diff\ndiff --git a/src/sage/symbolic/function.pyx b/src/sage/symbolic/function.pyx\nindex 408b6da..5beb01d 100644\n--- a/src/sage/symbolic/function.pyx\n+++ b/src/sage/symbolic/function.pyx\n@@ -914,38 +914,6 @@ cdef class BuiltinFunction(Function):\n         res = super(BuiltinFunction, self).__call__(\n                         *args, coerce=coerce, hold=hold)\n \n-        # we want to convert the result to the original parent if the input\n-        # is not exact, so we store the parent here\n-        org_parent = parent_c(args[0])\n-\n-        # convert the result back to the original parent previously stored\n-        # otherwise we end up with\n-        #     sage: arctan(RR(1))\n-        #     1/4*pi\n-        # which is surprising, to say the least...\n-        if org_parent is not SR and \\\n-                (org_parent is float or org_parent is complex or \\\n-                (PY_TYPE_CHECK(org_parent, Parent) and \\\n-                    not org_parent.is_exact())):\n-            try:\n-                return org_parent(res)\n-            except (TypeError, ValueError):\n-                pass\n-\n-            # conversion to the original parent failed\n-            # we try if it works with the corresponding complex domain\n-            if org_parent is float or org_parent is complex:\n-                try:\n-                    from sage.rings.complex_double import CDF\n-                    return complex(CDF(res))\n-                except (TypeError, ValueError):\n-                    pass\n-            elif hasattr(org_parent, 'complex_field'):\n-                try:\n-                    return org_parent.complex_field()(res)\n-                except (TypeError, ValueError):\n-                    pass\n-\n         return res\n \n     cdef _is_registered(self):\n```\n\nbut with quite a bit of doctest failures.",
    "created_at": "2014-10-10T10:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223704",
    "user": "jdemeyer"
}
```

The following patch fixes the problem

```diff
diff --git a/src/sage/symbolic/function.pyx b/src/sage/symbolic/function.pyx
index 408b6da..5beb01d 100644
--- a/src/sage/symbolic/function.pyx
+++ b/src/sage/symbolic/function.pyx
@@ -914,38 +914,6 @@ cdef class BuiltinFunction(Function):
         res = super(BuiltinFunction, self).__call__(
                         *args, coerce=coerce, hold=hold)
 
-        # we want to convert the result to the original parent if the input
-        # is not exact, so we store the parent here
-        org_parent = parent_c(args[0])
-
-        # convert the result back to the original parent previously stored
-        # otherwise we end up with
-        #     sage: arctan(RR(1))
-        #     1/4*pi
-        # which is surprising, to say the least...
-        if org_parent is not SR and \
-                (org_parent is float or org_parent is complex or \
-                (PY_TYPE_CHECK(org_parent, Parent) and \
-                    not org_parent.is_exact())):
-            try:
-                return org_parent(res)
-            except (TypeError, ValueError):
-                pass
-
-            # conversion to the original parent failed
-            # we try if it works with the corresponding complex domain
-            if org_parent is float or org_parent is complex:
-                try:
-                    from sage.rings.complex_double import CDF
-                    return complex(CDF(res))
-                except (TypeError, ValueError):
-                    pass
-            elif hasattr(org_parent, 'complex_field'):
-                try:
-                    return org_parent.complex_field()(res)
-                except (TypeError, ValueError):
-                    pass
-
         return res
 
     cdef _is_registered(self):
```

but with quite a bit of doctest failures.



---

archive/issue_comments_223705.json:
```json
{
    "body": "I think a correct result with the wrong parent is better than a wrong result with the correct parent, so I'm inclined to really remove that block of code and fix individual functions instead.",
    "created_at": "2014-10-10T10:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223705",
    "user": "jdemeyer"
}
```

I think a correct result with the wrong parent is better than a wrong result with the correct parent, so I'm inclined to really remove that block of code and fix individual functions instead.



---

archive/issue_comments_223706.json:
```json
{
    "body": "I'm not surprised - the problem is that this kind of code was added at various times to handle certain cases where the output was not the same type as the input (e.g., complex output for real/float input). For instance, does the example mentioned in the code\n\n```\narctan(RR(1)) \n```\n\nwork properly with this patch? Again, I'm sorry I don't have time to do more than read code for five minutes at this point :(\n\nEdit: I see your most recent comment - yes, that would certainly be helpful, though I have a feeling a LOT of functions would have to be fixed... because some probably implicitly rely on this block but aren't thoroughly tested for unusual input/output.\n\nEdit by jdemeyer: Sorry, edit instead of reply",
    "created_at": "2014-10-10T10:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223706",
    "user": "kcrisman"
}
```

I'm not surprised - the problem is that this kind of code was added at various times to handle certain cases where the output was not the same type as the input (e.g., complex output for real/float input). For instance, does the example mentioned in the code

```
arctan(RR(1)) 
```

work properly with this patch? Again, I'm sorry I don't have time to do more than read code for five minutes at this point :(

Edit: I see your most recent comment - yes, that would certainly be helpful, though I have a feeling a LOT of functions would have to be fixed... because some probably implicitly rely on this block but aren't thoroughly tested for unusual input/output.

Edit by jdemeyer: Sorry, edit instead of reply



---

archive/issue_comments_223707.json:
```json
{
    "body": "Perhaps one could take the coercion mutual parents of all args instead for a minimal change?  (Would that work?)  I think in principle it's better to handle this all at once rather than having things in each individual function - if possible, of course.",
    "created_at": "2014-10-10T10:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223707",
    "user": "kcrisman"
}
```

Perhaps one could take the coercion mutual parents of all args instead for a minimal change?  (Would that work?)  I think in principle it's better to handle this all at once rather than having things in each individual function - if possible, of course.



---

archive/issue_comments_223708.json:
```json
{
    "body": "Replying to [comment:7 kcrisman]:\n> {{{\n> arctan(RR(1)) \n> }}}\n> work properly with this patch?\nThis works as it should, many doctest failures involve Python types:\n\n```\nsage: arctan(float(1))\n1/4*pi\n```\n\n(I guess this goes through Pynac)",
    "created_at": "2014-10-10T10:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223708",
    "user": "jdemeyer"
}
```

Replying to [comment:7 kcrisman]:
> {{{
> arctan(RR(1)) 
> }}}
> work properly with this patch?
This works as it should, many doctest failures involve Python types:

```
sage: arctan(float(1))
1/4*pi
```

(I guess this goes through Pynac)



---

archive/issue_comments_223709.json:
```json
{
    "body": "Replying to [comment:8 kcrisman]:\n> Perhaps one could take the coercion mutual parents of all args instead for a minimal change?\nThat still wouldn't fix the case where the function is computed to less precision than the inputs.\n\nI think the following would fix most issues:\n- before calling the function, convert all Python types to the corresponding Sage types (`float` -> `RDF` and so on)\n- after calling the function, convert back if needed",
    "created_at": "2014-10-10T10:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223709",
    "user": "jdemeyer"
}
```

Replying to [comment:8 kcrisman]:
> Perhaps one could take the coercion mutual parents of all args instead for a minimal change?
That still wouldn't fix the case where the function is computed to less precision than the inputs.

I think the following would fix most issues:
- before calling the function, convert all Python types to the corresponding Sage types (`float` -> `RDF` and so on)
- after calling the function, convert back if needed



---

archive/issue_comments_223710.json:
```json
{
    "body": "Not all arguments need to be floating point types, there could be integer or string parameters. So you can't indiscriminately coerce.\n\nIMHO we should just add a clause that if output is float and of lower precision then use that lower precision. In an ideal world we would be able to evaluate everything to arbitrary precision, of course.",
    "created_at": "2014-10-10T10:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223710",
    "user": "vbraun"
}
```

Not all arguments need to be floating point types, there could be integer or string parameters. So you can't indiscriminately coerce.

IMHO we should just add a clause that if output is float and of lower precision then use that lower precision. In an ideal world we would be able to evaluate everything to arbitrary precision, of course.



---

archive/issue_comments_223711.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-10-11T12:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223711",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_223712.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-11T13:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223712",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223713.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-11T14:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223713",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_223714.json:
```json
{
    "body": "Wow, that first commit is a nice patch bomb.  I hesitate to make so much change to how symbolic functions are evaluated without taking a pretty close look, my apologies for not trying to do that immediately.  Also, I think there was an actual reason for calling it `inexact` and not `numerical`, though I don't remember offhand.",
    "created_at": "2014-10-22T18:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223714",
    "user": "kcrisman"
}
```

Wow, that first commit is a nice patch bomb.  I hesitate to make so much change to how symbolic functions are evaluated without taking a pretty close look, my apologies for not trying to do that immediately.  Also, I think there was an actual reason for calling it `inexact` and not `numerical`, though I don't remember offhand.



---

archive/issue_comments_223715.json:
```json
{
    "body": "Replying to [comment:21 kcrisman]:\n> Wow, that first commit is a nice patch bomb.\nWould you be more willing to review the patch if it would be split up? I could try to do that but only if I have confirmation that it will increase the chances of this ticket being reviewed.",
    "created_at": "2014-10-23T07:08:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223715",
    "user": "jdemeyer"
}
```

Replying to [comment:21 kcrisman]:
> Wow, that first commit is a nice patch bomb.
Would you be more willing to review the patch if it would be split up? I could try to do that but only if I have confirmation that it will increase the chances of this ticket being reviewed.



---

archive/issue_comments_223716.json:
```json
{
    "body": "I don't think it is overly long, nor is there a good way of splitting it up. Patch looks good to me.\n\nIts somewhat confusing that `is_numerical` is completely different from `GiNaC::numeric`. How about `is_approximate`, `is_limited_precision`, or `is_floating_point` (I'd be happy to call padics \"floating point\" in this case). \n\nIs it possible to replace `is_inexact` with `is_numerical` everywhere? The difference is\n\n```\nsage: is_inexact(pi)\nTrue\nsage: sin._is_numerical(pi)\nFalse\n```\n\nI'm not super happy with pi being \"inexact\", though perhaps there is a technical reason for why we need it.",
    "created_at": "2014-10-23T10:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223716",
    "user": "vbraun"
}
```

I don't think it is overly long, nor is there a good way of splitting it up. Patch looks good to me.

Its somewhat confusing that `is_numerical` is completely different from `GiNaC::numeric`. How about `is_approximate`, `is_limited_precision`, or `is_floating_point` (I'd be happy to call padics "floating point" in this case). 

Is it possible to replace `is_inexact` with `is_numerical` everywhere? The difference is

```
sage: is_inexact(pi)
True
sage: sin._is_numerical(pi)
False
```

I'm not super happy with pi being "inexact", though perhaps there is a technical reason for why we need it.



---

archive/issue_comments_223717.json:
```json
{
    "body": "* Deprecation, folks.  \n* No, it isn't long, but I at least need to think about the mechanism by which things are evaluated and want to make sure we don't miss any odd cases.  `_eval_` has been fairly standard for quite some time.\n* I agree that the naming is problematic no matter what name you choose.  I think the rings folks had some good reasons for their choices:\n\n```\n    cpdef bint is_exact(self) except -2:\n        \"\"\"\n        Test whether the ring is exact.\n\n        .. NOTE::\n\n            This defaults to true, so even if it does return ``True``\n            you have no guarantee (unless the ring has properly\n            overloaded this).\n\n        OUTPUT:\n\n        Return True if elements of this ring are represented exactly, i.e.,\n        there is no precision loss when doing arithmetic.\n\n        EXAMPLES::\n\n            sage: QQ.is_exact()\n            True\n            sage: ZZ.is_exact()\n            True\n            sage: Qp(7).is_exact()\n            False\n            sage: Zp(7, type='capped-abs').is_exact()\n            False\n        \"\"\"\n        return True\n```\n\n  but the symbolic ring might have inexact stuff in it, so \n\n```\n\nDefinition:     SR.is_exact(self)\nSource:\n    cpdef bint is_exact(self) except -2:\n        \"\"\"\n        Return False, because there are approximate elements in the\n        symbolic ring.\n\n        EXAMPLES::\n\n            sage: SR.is_exact()\n            False\n\n        Here is an inexact element.\n\n        ::\n\n            sage: SR(1.9393)\n            1.93930000000000\n        \"\"\"\n        return False\n```\n\n  does that make sense?",
    "created_at": "2014-10-23T14:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223717",
    "user": "kcrisman"
}
```

* Deprecation, folks.  
* No, it isn't long, but I at least need to think about the mechanism by which things are evaluated and want to make sure we don't miss any odd cases.  `_eval_` has been fairly standard for quite some time.
* I agree that the naming is problematic no matter what name you choose.  I think the rings folks had some good reasons for their choices:

```
    cpdef bint is_exact(self) except -2:
        """
        Test whether the ring is exact.

        .. NOTE::

            This defaults to true, so even if it does return ``True``
            you have no guarantee (unless the ring has properly
            overloaded this).

        OUTPUT:

        Return True if elements of this ring are represented exactly, i.e.,
        there is no precision loss when doing arithmetic.

        EXAMPLES::

            sage: QQ.is_exact()
            True
            sage: ZZ.is_exact()
            True
            sage: Qp(7).is_exact()
            False
            sage: Zp(7, type='capped-abs').is_exact()
            False
        """
        return True
```

  but the symbolic ring might have inexact stuff in it, so 

```

Definition:     SR.is_exact(self)
Source:
    cpdef bint is_exact(self) except -2:
        """
        Return False, because there are approximate elements in the
        symbolic ring.

        EXAMPLES::

            sage: SR.is_exact()
            False

        Here is an inexact element.

        ::

            sage: SR(1.9393)
            1.93930000000000
        """
        return False
```

  does that make sense?



---

archive/issue_comments_223718.json:
```json
{
    "body": "Replying to [comment:24 kcrisman]:\n> * Deprecation, folks.\nWhat should be deprecated? Is there something which used to work and no longer works now and should be deprecated?",
    "created_at": "2014-10-23T14:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223718",
    "user": "jdemeyer"
}
```

Replying to [comment:24 kcrisman]:
> * Deprecation, folks.
What should be deprecated? Is there something which used to work and no longer works now and should be deprecated?



---

archive/issue_comments_223719.json:
```json
{
    "body": "> > * Deprecation, folks.\n> What should be deprecated? Is there something which used to work and no longer works now and should be deprecated?\nI just meant if one changed the name completely, that's all.",
    "created_at": "2014-10-23T14:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223719",
    "user": "kcrisman"
}
```

> > * Deprecation, folks.
> What should be deprecated? Is there something which used to work and no longer works now and should be deprecated?
I just meant if one changed the name completely, that's all.



---

archive/issue_comments_223720.json:
```json
{
    "body": "Replying to [comment:23 vbraun]:\n> Its somewhat confusing that `is_numerical` is completely different from `GiNaC::numeric`. How about `is_approximate`, `is_limited_precision`, or `is_floating_point` (I'd be happy to call padics \"floating point\" in this case).\n\nI like none of those 3 alternatives, as there are valid cases for exact integers being \"numerical\": this isn't yet implemented on this ticket, but for number theoretical functions (`binomial`, `factorial`) it absolutely makes sense to consider integers \"numerical\". So the name should not obviously exclude integers.\n\nIn fact, this was one of the reasons to make `_is_numerical` a method of the function and not a global function (possible support of `p`-adics is indeed another reason).",
    "created_at": "2014-10-23T14:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223720",
    "user": "jdemeyer"
}
```

Replying to [comment:23 vbraun]:
> Its somewhat confusing that `is_numerical` is completely different from `GiNaC::numeric`. How about `is_approximate`, `is_limited_precision`, or `is_floating_point` (I'd be happy to call padics "floating point" in this case).

I like none of those 3 alternatives, as there are valid cases for exact integers being "numerical": this isn't yet implemented on this ticket, but for number theoretical functions (`binomial`, `factorial`) it absolutely makes sense to consider integers "numerical". So the name should not obviously exclude integers.

In fact, this was one of the reasons to make `_is_numerical` a method of the function and not a global function (possible support of `p`-adics is indeed another reason).



---

archive/issue_comments_223721.json:
```json
{
    "body": "Replying to [comment:26 kcrisman]:\n> I just meant if one changed the name completely, that's all.\nIf you show me a concrete instance where a deprecation is needed, I'll happily add it.",
    "created_at": "2014-10-23T14:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223721",
    "user": "jdemeyer"
}
```

Replying to [comment:26 kcrisman]:
> I just meant if one changed the name completely, that's all.
If you show me a concrete instance where a deprecation is needed, I'll happily add it.



---

archive/issue_comments_223722.json:
```json
{
    "body": "> > I just meant if one changed the name completely, that's all.\n> If you show me a concrete instance where a deprecation is needed, I'll happily add it.\nSo far it isn't!  I was being a little preemptive in terms of the `is_*` guys.  No worries.",
    "created_at": "2014-10-23T14:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223722",
    "user": "kcrisman"
}
```

> > I just meant if one changed the name completely, that's all.
> If you show me a concrete instance where a deprecation is needed, I'll happily add it.
So far it isn't!  I was being a little preemptive in terms of the `is_*` guys.  No worries.



---

archive/issue_comments_223723.json:
```json
{
    "body": "I have implemented #17151 on top of this patch. Could you please comment on if the code in `Func_laguerre._evalf_()` needed to determine `real_parent` can be reduced further, maybe by adding it to this patch, too?",
    "created_at": "2014-11-09T17:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223723",
    "user": "rws"
}
```

I have implemented #17151 on top of this patch. Could you please comment on if the code in `Func_laguerre._evalf_()` needed to determine `real_parent` can be reduced further, maybe by adding it to this patch, too?



---

archive/issue_comments_223724.json:
```json
{
    "body": "Replying to [comment:34 rws]:\n> I have implemented #17151 on top of this patch. Could you please comment on if the code in `Func_laguerre._evalf_()` needed to determine `real_parent` can be reduced further\nMost likely it can be reduced further (why not simply take the parent of `x`?). I also don't like the name `real_parent` since it can be complex too.\n\n> maybe by adding it to this patch, too?\nNo. People are already complaining that this patch is too big. But a follow-up ticket certainly makes sense.",
    "created_at": "2014-11-12T22:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223724",
    "user": "jdemeyer"
}
```

Replying to [comment:34 rws]:
> I have implemented #17151 on top of this patch. Could you please comment on if the code in `Func_laguerre._evalf_()` needed to determine `real_parent` can be reduced further
Most likely it can be reduced further (why not simply take the parent of `x`?). I also don't like the name `real_parent` since it can be complex too.

> maybe by adding it to this patch, too?
No. People are already complaining that this patch is too big. But a follow-up ticket certainly makes sense.



---

archive/issue_comments_223725.json:
```json
{
    "body": "Something else to note (very minor) is that if the top of http://trac.sagemath.org/wiki/symbolics/functions needed some slight updating in order to still be useful, it would be good to do that at the time this was resolved.",
    "created_at": "2014-11-17T17:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223725",
    "user": "kcrisman"
}
```

Something else to note (very minor) is that if the top of http://trac.sagemath.org/wiki/symbolics/functions needed some slight updating in order to still be useful, it would be good to do that at the time this was resolved.



---

archive/issue_comments_223726.json:
```json
{
    "body": "Replying to [comment:36 kcrisman]:\n> Something else to note (very minor) is that if the top of http://trac.sagemath.org/wiki/symbolics/functions needed some slight updating in order to still be useful, it would be good to do that at the time this was resolved.\n\nI don't think anything needs updating. But it would be good though to think more generally about what the API should be for symbolic functions. I consider this ticket as a first step in the right direction.",
    "created_at": "2014-11-18T07:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223726",
    "user": "jdemeyer"
}
```

Replying to [comment:36 kcrisman]:
> Something else to note (very minor) is that if the top of http://trac.sagemath.org/wiki/symbolics/functions needed some slight updating in order to still be useful, it would be good to do that at the time this was resolved.

I don't think anything needs updating. But it would be good though to think more generally about what the API should be for symbolic functions. I consider this ticket as a first step in the right direction.



---

archive/issue_comments_223727.json:
```json
{
    "body": "This is very useful for upcoming code of symbolic functions and contains fixes to `functions` too. I think I can follow what you do in `symbolic`. So apart from the doctest fails it's positive from me.\n\n`make ptestlong`:\n\n```\nsage -t --long src/sage/modular/modform_hecketriangle/abstract_space.py  # 12 doctests failed\nsage -t --long src/sage/modular/modform_hecketriangle/readme.py  # 7 doctests failed\nsage -t --long src/sage/functions/other.py  # 3 doctests failed\n```\n\n----\nNew commits:",
    "created_at": "2014-11-25T17:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223727",
    "user": "rws"
}
```

This is very useful for upcoming code of symbolic functions and contains fixes to `functions` too. I think I can follow what you do in `symbolic`. So apart from the doctest fails it's positive from me.

`make ptestlong`:

```
sage -t --long src/sage/modular/modform_hecketriangle/abstract_space.py  # 12 doctests failed
sage -t --long src/sage/modular/modform_hecketriangle/readme.py  # 7 doctests failed
sage -t --long src/sage/functions/other.py  # 3 doctests failed
```

----
New commits:



---

archive/issue_comments_223728.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-11-25T17:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223728",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_223729.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-11-26T08:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223729",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_223730.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-11-26T08:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223730",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_223731.json:
```json
{
    "body": "Passes previously failed tests.",
    "created_at": "2014-11-26T09:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223731",
    "user": "rws"
}
```

Passes previously failed tests.



---

archive/issue_comments_223732.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-26T09:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223732",
    "user": "rws"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_223733.json:
```json
{
    "body": "Patchbot failed because of `[tutorial ] IOError: [Errno 28] No space left on device`",
    "created_at": "2014-11-26T14:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223733",
    "user": "rws"
}
```

Patchbot failed because of `[tutorial ] IOError: [Errno 28] No space left on device`



---

archive/issue_comments_223734.json:
```json
{
    "body": "I get more numerical noise\n\n```\nsage -t --long src/sage/functions/hyperbolic.py\n**********************************************************************\nFile \"src/sage/functions/hyperbolic.py\", line 546, in sage.functions.hyperbolic.Function_arccoth.__init__\nFailed example:\n    float(arccoth(2))\nExpected:\n    0.5493061443340548\nGot:\n    0.5493061443340549\n**********************************************************************\n1 item had failures:\n   1 of   9 in sage.functions.hyperbolic.Function_arccoth.__init__\n    [156 tests, 1 failure, 1.22 s]\nsage -t --long src/sage/functions/hypergeometric.py\n    [143 tests, 5.23 s]\nsage -t --long src/sage/functions/jacobi.py\n    [188 tests, 4.02 s]\nsage -t --long src/sage/functions/log.py\n**********************************************************************\nFile \"src/sage/functions/log.py\", line 661, in sage.functions.log.Function_lambert_w._evalf_\nFailed example:\n    lambert_w(RDF(-1))\nExpected:\n    -0.3181315052047642 + 1.3372357014306895*I\nGot:\n    -0.31813150520476413 + 1.3372357014306895*I\n**********************************************************************\nFile \"src/sage/functions/log.py\", line 663, in sage.functions.log.Function_lambert_w._evalf_\nFailed example:\n    lambert_w(float(-1))\nExpected:\n    (-0.3181315052047642+1.3372357014306895j)\nGot:\n    (-0.31813150520476413+1.3372357014306895j)\n**********************************************************************\n1 item had failures:\n   2 of   9 in sage.functions.log.Function_lambert_w._evalf_\nsage -t --long src/sage/functions/special.py\n**********************************************************************\nFile \"src/sage/functions/special.py\", line 355, in sage.functions.special.MaximaFunction._evalf_\nFailed example:\n    f._evalf_(1, I, parent=CDF)\nExpected:\n    0.8483795707591759 - 0.0742924734216079*I\nGot:\n    0.8483795707591759 - 0.07429247342160791*I\n**********************************************************************\n1 item had failures:\n   1 of  13 in sage.functions.special.MaximaFunction._evalf_\n    [116 tests, 1 failure, 2.35 s]\n```\n",
    "created_at": "2014-11-27T22:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223734",
    "user": "vbraun"
}
```

I get more numerical noise

```
sage -t --long src/sage/functions/hyperbolic.py
**********************************************************************
File "src/sage/functions/hyperbolic.py", line 546, in sage.functions.hyperbolic.Function_arccoth.__init__
Failed example:
    float(arccoth(2))
Expected:
    0.5493061443340548
Got:
    0.5493061443340549
**********************************************************************
1 item had failures:
   1 of   9 in sage.functions.hyperbolic.Function_arccoth.__init__
    [156 tests, 1 failure, 1.22 s]
sage -t --long src/sage/functions/hypergeometric.py
    [143 tests, 5.23 s]
sage -t --long src/sage/functions/jacobi.py
    [188 tests, 4.02 s]
sage -t --long src/sage/functions/log.py
**********************************************************************
File "src/sage/functions/log.py", line 661, in sage.functions.log.Function_lambert_w._evalf_
Failed example:
    lambert_w(RDF(-1))
Expected:
    -0.3181315052047642 + 1.3372357014306895*I
Got:
    -0.31813150520476413 + 1.3372357014306895*I
**********************************************************************
File "src/sage/functions/log.py", line 663, in sage.functions.log.Function_lambert_w._evalf_
Failed example:
    lambert_w(float(-1))
Expected:
    (-0.3181315052047642+1.3372357014306895j)
Got:
    (-0.31813150520476413+1.3372357014306895j)
**********************************************************************
1 item had failures:
   2 of   9 in sage.functions.log.Function_lambert_w._evalf_
sage -t --long src/sage/functions/special.py
**********************************************************************
File "src/sage/functions/special.py", line 355, in sage.functions.special.MaximaFunction._evalf_
Failed example:
    f._evalf_(1, I, parent=CDF)
Expected:
    0.8483795707591759 - 0.0742924734216079*I
Got:
    0.8483795707591759 - 0.07429247342160791*I
**********************************************************************
1 item had failures:
   1 of  13 in sage.functions.special.MaximaFunction._evalf_
    [116 tests, 1 failure, 2.35 s]
```




---

archive/issue_comments_223735.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-11-27T22:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223735",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_223736.json:
```json
{
    "body": "Replying to [comment:46 vbraun]:\n> I get more numerical noise\nAppears to be system dependent, as all tests in `functions/` pass here (OpenSUSE 12.3)",
    "created_at": "2014-11-28T09:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223736",
    "user": "rws"
}
```

Replying to [comment:46 vbraun]:
> I get more numerical noise
Appears to be system dependent, as all tests in `functions/` pass here (OpenSUSE 12.3)



---

archive/issue_comments_223737.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-11-28T09:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223737",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223738.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-11-28T09:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223738",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_223739.json:
```json
{
    "body": "Still passes tests in `functions/` here.",
    "created_at": "2014-11-28T10:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223739",
    "user": "rws"
}
```

Still passes tests in `functions/` here.



---

archive/issue_comments_223740.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-28T10:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223740",
    "user": "rws"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_223741.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-11-29T01:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223741",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_223742.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/functions/log.py\n**********************************************************************\nFile \"src/sage/functions/log.py\", line 661, in sage.functions.log.Function_lambert_w._evalf_\nFailed example:\n    lambert_w(RDF(-1))  # abs tol 1e-16\nExpected:\n    -0.31813150520476413 + 1.3372357014306895*I\nGot:\n    -0.31813150520476413 + 1.3372357014306893*I\nTolerance exceeded in 1 of 2:\n    + 1.3372357014306895 vs + 1.3372357014306893, tolerance 2e-16 > 1e-16\n**********************************************************************\nFile \"src/sage/functions/log.py\", line 663, in sage.functions.log.Function_lambert_w._evalf_\nFailed example:\n    lambert_w(float(-1))  # abs tol 1e-16\nExpected:\n    (-0.31813150520476413+1.3372357014306895j)\nGot:\n    (-0.31813150520476413+1.3372357014306893j)\nTolerance exceeded in 1 of 2:\n    +1.3372357014306895 vs +1.3372357014306893, tolerance 2e-16 > 1e-16\n**********************************************************************\n1 item had failures:\n   2 of   9 in sage.functions.log.Function_lambert_w._evalf_\n    [171 tests, 2 failures, 2.51 s]\n```\n",
    "created_at": "2014-11-29T01:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223742",
    "user": "vbraun"
}
```


```
sage -t --long src/sage/functions/log.py
**********************************************************************
File "src/sage/functions/log.py", line 661, in sage.functions.log.Function_lambert_w._evalf_
Failed example:
    lambert_w(RDF(-1))  # abs tol 1e-16
Expected:
    -0.31813150520476413 + 1.3372357014306895*I
Got:
    -0.31813150520476413 + 1.3372357014306893*I
Tolerance exceeded in 1 of 2:
    + 1.3372357014306895 vs + 1.3372357014306893, tolerance 2e-16 > 1e-16
**********************************************************************
File "src/sage/functions/log.py", line 663, in sage.functions.log.Function_lambert_w._evalf_
Failed example:
    lambert_w(float(-1))  # abs tol 1e-16
Expected:
    (-0.31813150520476413+1.3372357014306895j)
Got:
    (-0.31813150520476413+1.3372357014306893j)
Tolerance exceeded in 1 of 2:
    +1.3372357014306895 vs +1.3372357014306893, tolerance 2e-16 > 1e-16
**********************************************************************
1 item had failures:
   2 of   9 in sage.functions.log.Function_lambert_w._evalf_
    [171 tests, 2 failures, 2.51 s]
```




---

archive/issue_comments_223743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-11-29T09:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223743",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223744.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-11-29T09:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223744",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_223745.json:
```json
{
    "body": "There may be a followup in a later ticket to deal with an inconsistency, if you agree that the following discrepancy between functions with one and two parameters needs addressing:\n\n```\nsage: i = ComplexField(30).0\nsage: gamma(i)\n-0.15494983 - 0.49801567*I\nsage: gamma(1.0*I)\n-0.154949828301811 - 0.498015668118356*I\nsage: jacobi_am(2., 2)\n0.549820282407325\nsage: jacobi_am(2., i)\njacobi_am(2.00000000000000, 1.0000000*I)\nsage: jacobi_am(2., 1.0*I)\njacobi_am(2.00000000000000, 1.00000000000000*I)\n```\n\n\nEDIT: Ah, never mind, `jacobi_am` takes only reals.",
    "created_at": "2014-11-30T07:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223745",
    "user": "rws"
}
```

There may be a followup in a later ticket to deal with an inconsistency, if you agree that the following discrepancy between functions with one and two parameters needs addressing:

```
sage: i = ComplexField(30).0
sage: gamma(i)
-0.15494983 - 0.49801567*I
sage: gamma(1.0*I)
-0.154949828301811 - 0.498015668118356*I
sage: jacobi_am(2., 2)
0.549820282407325
sage: jacobi_am(2., i)
jacobi_am(2.00000000000000, 1.0000000*I)
sage: jacobi_am(2., 1.0*I)
jacobi_am(2.00000000000000, 1.00000000000000*I)
```


EDIT: Ah, never mind, `jacobi_am` takes only reals.



---

archive/issue_comments_223746.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-30T14:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223746",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_223747.json:
```json
{
    "body": "Question for Jeroen and Ralf - any updating needed in the documentation in sage/symbolic/function_factory.py function `function` as a result of this ticket?   I'd be happy to open a followup if need be.",
    "created_at": "2014-12-02T15:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223747",
    "user": "kcrisman"
}
```

Question for Jeroen and Ralf - any updating needed in the documentation in sage/symbolic/function_factory.py function `function` as a result of this ticket?   I'd be happy to open a followup if need be.



---

archive/issue_comments_223748.json:
```json
{
    "body": "Replying to [comment:57 kcrisman]:\n> Question for Jeroen and Ralf - any updating needed in the documentation in sage/symbolic/function_factory.py function `function` as a result of this ticket?\nNo, this is only about `BuiltinFunction`s, there are no functional changes to user-defined functions.",
    "created_at": "2014-12-02T18:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16893#issuecomment-223748",
    "user": "jdemeyer"
}
```

Replying to [comment:57 kcrisman]:
> Question for Jeroen and Ralf - any updating needed in the documentation in sage/symbolic/function_factory.py function `function` as a result of this ticket?
No, this is only about `BuiltinFunction`s, there are no functional changes to user-defined functions.
