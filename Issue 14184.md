# Issue 14184: Fix Cygwin failure in plural polynomials overflow error

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2013-03-30 01:28:05

Assignee: tbd

CC:  jpflori dimpase

Keywords: Cygwin

On Cygwin we see that now most failures are of the following nature.

```
sage -t  devel/sage-main/sage/algebras/free_algebra.py
Exception KeyError: (The ring pointer -0x1f5282c,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
Exception KeyError: (The ring pointer -0x1f52768,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
Exception KeyError: (The ring pointer -0x1f526a4,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
**********************************************************************
File "/home/sagetest/sage-5.8.beta4/devel/sage-main/sage/algebras/free_algebra.py", line 820:
    sage: G=A.g_algebra({y*x:-x*y})
Exception raised:
    Traceback (most recent call last):
      File "/home/sagetest/sage-5.8.beta4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/sagetest/sage-5.8.beta4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/sagetest/sage-5.8.beta4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_18[3]>", line 1, in <module>
        G=A.g_algebra({y*x:-x*y})###line 820:
    sage: G=A.g_algebra({y*x:-x*y})
      File "/home/sagetest/sage-5.8.beta4/local/lib/python/site-packages/sage/algebras/free_algebra.py", line 872, in g_algebra
        order=order, check=check)
      File "factory.pyx", line 143, in sage.structure.factory.UniqueFactory.__call__ (sage/structure/factory.c:1119)
      File "factory.pyx", line 170, in sage.structure.factory.UniqueFactory.get_object (sage/structure/factory.c:1311)
      File "plural.pyx", line 180, in sage.rings.polynomial.plural.G_AlgFactory.create_object (sage/rings/polynomial/plural.cpp:4289)
      File "plural.pyx", line 358, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__init__ (sage/rings/polynomial/plural.cpp:5351)
      File "plural.pyx", line 1471, in sage.rings.polynomial.plural.NCPolynomial_plural.__richcmp__ (sage/rings/polynomial/plural.cpp:11452)
      File "element.pyx", line 855, in sage.structure.element.Element._richcmp (sage/structure/element.c:7980)
      File "coerce.pyx", line 913, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8304)
      File "coerce.pyx", line 1068, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps (sage/structure/coerce.c:9855)
      File "coerce.pyx", line 1209, in sage.structure.coerce.CoercionModel_cache_maps.discover_coercion (sage/structure/coerce.c:11405)
      File "parent.pyx", line 2116, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14383)
      File "parent.pyx", line 2937, in sage.structure.parent._register_pair (sage/structure/parent.c:21545)
      File "parent.pyx", line 2911, in sage.structure.parent.EltPair.__hash__ (sage/structure/parent.c:21193)
      File "plural.pyx", line 573, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__hash__ (sage/rings/polynomial/plural.cpp:6487)
    OverflowError: Python int too large to convert to C long
```



---

Comment by kcrisman created at 2013-03-30 01:29:12

Note that, technically speaking, there are two errors - the overflow issue, and the pointer exception.  Either one could be fixed here, and then a new ticket opened for the other, if necessary.


---

Comment by nbruin created at 2013-03-30 02:22:57

We have seen such overflow errors before due to storing an unsigned long into a python int and then trying to put it in a signed long.


---

Comment by kcrisman created at 2013-03-30 02:24:39

> We have seen such overflow errors before due to storing an unsigned long into a python int and then trying to put it in a signed long.
So you think it could be basically the same type of problem as #14254?  Unfortunately this particular set of errors wasn't fixed by that ticket.


---

Comment by kcrisman created at 2013-03-30 02:30:35

In particular, do you think that 

```
cdef long result = 0 # store it in a c-int and just let the overflowing additions wrap
```

in sage/rings/polynomial/plural.pyx could be the problem?  This is just a very naive idea, but all the problems do come in this same place (hash).


---

Comment by nbruin created at 2013-03-30 03:30:20

Replying to [comment:3 kcrisman]:
> So you think it could be basically the same type of problem as #14254?  Unfortunately this particular set of errors wasn't fixed by that ticket.

It looks like it's exactly that problem. Look at line 573 of plural.pyx

```
    def __hash__(self):
...
        return id(self)
```

The special method `__hash__` is supposed to return a `Py_hash_t` (probably a "long"). The code is trying to return `id`, which is a python integer, and on a machine where ints are 32 bits, can easily exceed `2^31`. So it won't be able to convert to an int. Explicitly cast instead, via something like

```
    return <Py_hash_t><void*>self
```

which will be orders of magnitude faster too.

Incidentally, Python itself shifts right by 2 any time an id gets used as a hash, because the lowest two bits are almost certainly 0.

Looks like this line is due to #4539, patch `trac4539_fix_docs_rel10903.patch`. This is liable to fail on any 32-bit platform (64 bit too, very few systems make it into the upper half of the address space there).

I'm pretty sure that the proposed fix would be safe.


---

Comment by jdemeyer created at 2013-03-30 03:55:24

You might want to use the `signed_id()` function from `sage/structure/coerce_dict.pyx` (see #14254)


---

Comment by jdemeyer created at 2013-03-30 03:56:27

Or yes, perhaps

```
    return <Py_hash_t><void*>self
```

is even better (and guaranteed to be safe).


---

Comment by kcrisman created at 2013-03-30 12:12:44

Okay, I'll definitely try this soon.  I noticed that `id` was a problem before, but since #14254 didn't fix this particular one, and I'm still learning about all these C-type (no pun intended) things, I was reluctant to mess about in such dangerous waters.


---

Comment by kcrisman created at 2013-03-30 13:32:33

Thanks for your help.  I'd love to use this, but I get a compilation error 

```
Error compiling Cython file:
------------------------------------------------------------
...
            sage: P = A.g_algebra(relations={y*x:-x*y}, order = 'lex')
            sage: {P:2}[P]            # indirect doctest
            2

        """
        return <Py_hash_t><void*>self
               ^
------------------------------------------------------------

sage/rings/polynomial/plural.pyx:573:16: 'Py_hash_t' is not a type identifier
Error running command, failed with status 256.
```

and apparently this `Py_hash_t` doesn't even show up in the Sage source code!  Or so `search_src` says.


---

Comment by jpflori created at 2013-03-30 13:38:42

I cannot reproduce this one on 5.9.beta0 on (64 bits, but this should not really interfere) Windows 7.
Trying a 32 bits W7 later.


---

Comment by nbruin created at 2013-03-30 16:15:36

Replying to [comment:9 kcrisman]:
> and apparently this `Py_hash_t` doesn't even show up in the Sage source code!  Or so `search_src` says.   

It's a standard type in CPython, so then it simply doesn't get imported into cython. Something along the lines of

```
    cdef extern ctypedef int Py_hash_t
```

should do the trick (as far as cython is concerned, typechecking on `int` is close enough. The generated `C` will see the proper definition).

If you feel that's too heavy handed  you can also just cast `<long><void *>self`, which will be close enough.


---

Comment by nbruin created at 2013-03-30 16:18:24

Replying to [comment:10 jpflori]:
> I cannot reproduce this one on 5.9.beta0 on (64 bits, but this should not really interfere)
If that means 64 bit system word types it makes all the difference for the overflow error. As a result, you won't see the "ignored exceptions" either. Those don't trigger a doctest failure. You just get to see them if another failure causes the output to be printed (probably stderr gets spooled to the same file, but not tested by the doctest code)


---

Comment by jpflori created at 2013-03-30 16:24:21

Cygwin is 32 bits only so I don't think the fact that Windows is or not matters.
Anyway I'll check on a completly 32 bits setup later.


---

Comment by jpflori created at 2013-03-30 17:42:05

Same result with 5.9.beta1 on the completely 32 bits system, I mean no error for me.

Karl-Dieter, I know it will take some time, but could you give sage-5.9.beta* a shot?

Anyway, if the id(self) looks really fishy, we could just relpace it, even if the error disappear in 5.9.


---

Comment by nbruin created at 2013-03-30 17:48:18

Replying to [comment:14 jpflori]:
> Same result with 5.9.beta1 on the completely 32 bits system, I mean no error for me.
Yes, that just means that the pointers in question happen to end up in the lower half of the memory map on your machine.


---

Comment by kcrisman created at 2013-03-30 18:54:52

Sorry, JP - this _is_ on a 5.9.beta2 as well, I just pasted one from earlier.

Unfortunately, this needs more massaging, apparently.  I wish I knew more about this.

```
$ ../../sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Building modified file sage/rings/polynomial/plural.pyx.
Executing 1 command (using 1 thread)
cython --gdb --cplus --old-style-globals --embed-positions --directive cdivision=True,autotestdict=False,fast_getattr=True -I/home/sagetest/sage-5.9.beta2/devel/sage-main -o sage/rings/polynomial/plural.cpp sage/rings/polynomial/plural.pyx

Error compiling Cython file:
------------------------------------------------------------
...

"""
include "sage/ext/stdsage.pxi"
include "sage/ext/interrupt.pxi"

cdef extern ctypedef int Py_hash_t
           ^
------------------------------------------------------------

sage/rings/polynomial/plural.pyx:108:12: Expected an identifier, found 'ctypedef'

Error compiling Cython file:
------------------------------------------------------------
...

"""
include "sage/ext/stdsage.pxi"
include "sage/ext/interrupt.pxi"

cdef extern ctypedef int Py_hash_t
                        ^
------------------------------------------------------------

sage/rings/polynomial/plural.pyx:108:25: Syntax error in C variable declaration
Error running command, failed with status 256.
Error installing modified sage library code.
```


However, casting to longs did the trick - `<long><void *>self` - as you suggested. I don't know how robust that is, though, say on other systems.


---

Comment by nbruin created at 2013-03-30 19:23:48

Replying to [comment:16 kcrisman]:

It should be clear now that I'm not the best reference for such cython-specific things either. How about:

```
cdef extern from *:
    ctypedef long Py_hash_t
```

All we need to do is convince Cython it can use the type `Py_hash_t` in long-like contexts and that the C-compiler will know how to handle it. Cython-generated c-files *contain* the type definition for `Py_hash_t` already anyway.

The python C-api actually specifies that `tp_hash` special methods should return a `C long`, so perhaps the `Py_hash_t` thing is a Cython internal type anyway.


---

Comment by jpflori created at 2013-03-30 19:29:40

The last solution looks ok.


---

Attachment


---

Comment by jpflori created at 2013-03-30 19:35:30

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-03-30 20:54:45

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2013-03-30 20:54:45

Ah, I see, the header files... I think this works fine, let's get it in.


---

Comment by jdemeyer created at 2013-04-01 13:03:56

Changing keywords from "Cygwin" to "32-bit".


---

Comment by jdemeyer created at 2013-04-01 13:03:56

Changing component from porting: Cygwin to porting.


---

Comment by jdemeyer created at 2013-04-04 17:40:40

Resolution: fixed
