# Issue 30556: Sage may ignore the imaginary part of variables not explicitly declared complex

archive/issues_030556.json:
```json
{
    "body": "CC:  pbruin\n\nSeen in this ask.sagemapt [question](https://ask.sagemath.org/question/53947/problem-with-factor-and-imag/), discussed in [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/WSZ55IRWeiI) :\n\nSage seems to assume that a not otherwise specified symbolic variable is real :\n\n```\nsage: var(\"z\")\nz\nsage: real(z).simplify()\nz\nsage: imag(z).simplify()\n0\nsage: with assuming(z,\"complex\"): real(z).simplify()\nrealpart(z)\nsage: with assuming(z,\"complex\"): imag(z).simplify()\nimagpart(z)\n```\n\n\nAs corollaries :\n\n```\nsage: var(\"a, b\")\n(a, b)\nsage: (a*imag(z) + b*imag(z)).factor()\n0\nsage: (a*z + b*z).factor().imag_part()\nimag_part(z)*real_part(a) + imag_part(z)*real_part(b) + imag_part(a)*real_part(z) + imag_part(b)*real_part(z)\nsage: (a*z + b*z).factor().imag_part().factor()\n0\nsage: (a*z + b*z).factor().imag_part().simplify()\n0\n```\n\n\nbut :\n\n```\nsage: with assuming(z,\"complex\"): (a*z + b*z).factor().imag_part().factor()\n(a + b)*imagpart(z)\nsage: with assuming(z,\"complex\"): (a*z + b*z).factor().imag_part().simplify()\na*imagpart(z) + b*imagpart(z)\n```\n\n\n`Maxima` has the same problem : in Sage's `maxima` :\n\n```\nsage: %%maxima\n....: domain;\n....: imagpart(z);\n....: imagpart(ratsimp(z));\n....: imagpart(factor(z));\n....: \n....: \ncomplex\n0\n0\n0\n```\n\n\nbut :\n\n```\nsage: %%maxima\n....: declare(z,complex);\n....: imagpart(z);\n....: imagpart(ratsimp(z));\n....: imagpart(factor(z));\n....: \n....: \ndone\n'imagpart(z)\n'imagpart(z)\n'imagpart(z)\n```\n\n\nFiling this as `blocker`, because this problem may lead to Sage //silently// returning mathematical nonsense...\n\nIssue created by migration from https://trac.sagemath.org/ticket/30793\n\n",
    "created_at": "2020-10-19T06:44:22Z",
    "labels": [
        "symbolics",
        "blocker",
        "bug"
    ],
    "title": "Sage may ignore the imaginary part of variables not explicitly declared complex",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30556",
    "user": "charpent"
}
```
CC:  pbruin

Seen in this ask.sagemapt [question](https://ask.sagemath.org/question/53947/problem-with-factor-and-imag/), discussed in [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/WSZ55IRWeiI) :

Sage seems to assume that a not otherwise specified symbolic variable is real :

```
sage: var("z")
z
sage: real(z).simplify()
z
sage: imag(z).simplify()
0
sage: with assuming(z,"complex"): real(z).simplify()
realpart(z)
sage: with assuming(z,"complex"): imag(z).simplify()
imagpart(z)
```


As corollaries :

```
sage: var("a, b")
(a, b)
sage: (a*imag(z) + b*imag(z)).factor()
0
sage: (a*z + b*z).factor().imag_part()
imag_part(z)*real_part(a) + imag_part(z)*real_part(b) + imag_part(a)*real_part(z) + imag_part(b)*real_part(z)
sage: (a*z + b*z).factor().imag_part().factor()
0
sage: (a*z + b*z).factor().imag_part().simplify()
0
```


but :

```
sage: with assuming(z,"complex"): (a*z + b*z).factor().imag_part().factor()
(a + b)*imagpart(z)
sage: with assuming(z,"complex"): (a*z + b*z).factor().imag_part().simplify()
a*imagpart(z) + b*imagpart(z)
```


`Maxima` has the same problem : in Sage's `maxima` :

```
sage: %%maxima
....: domain;
....: imagpart(z);
....: imagpart(ratsimp(z));
....: imagpart(factor(z));
....: 
....: 
complex
0
0
0
```


but :

```
sage: %%maxima
....: declare(z,complex);
....: imagpart(z);
....: imagpart(ratsimp(z));
....: imagpart(factor(z));
....: 
....: 
done
'imagpart(z)
'imagpart(z)
'imagpart(z)
```


Filing this as `blocker`, because this problem may lead to Sage //silently// returning mathematical nonsense...

Issue created by migration from https://trac.sagemath.org/ticket/30793





---

archive/issue_comments_436455.json:
```json
{
    "body": "either blocker for the 9.3 milestone, or critical only, please",
    "created_at": "2020-10-19T06:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436455",
    "user": "chapoton"
}
```

either blocker for the 9.3 milestone, or critical only, please



---

archive/issue_comments_436456.json:
```json
{
    "body": "Replying to [comment:1 chapoton]:\n> either blocker for the 9.3 milestone, or critical only, please\n\nOkay. Will do that also for #30688.",
    "created_at": "2020-10-19T07:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436456",
    "user": "charpent"
}
```

Replying to [comment:1 chapoton]:
> either blocker for the 9.3 milestone, or critical only, please

Okay. Will do that also for #30688.



---

archive/issue_comments_436457.json:
```json
{
    "body": "De facto this can't be a blocker if noone is enough invested to work on it. Probably should be fixed on the maxima side first, too.",
    "created_at": "2021-03-28T08:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436457",
    "user": "vbraun"
}
```

De facto this can't be a blocker if noone is enough invested to work on it. Probably should be fixed on the maxima side first, too.



---

archive/issue_comments_436458.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2021-03-28T08:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436458",
    "user": "vbraun"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_436459.json:
```json
{
    "body": "Well, has anyone filed it as an upstream bug?",
    "created_at": "2021-03-28T22:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436459",
    "user": "mkoeppe"
}
```

Well, has anyone filed it as an upstream bug?



---

archive/issue_comments_436460.json:
```json
{
    "body": "This was reported upstream on #6862. The maxima developers deny that it is a bug, and I agree with them, because the maxima documentation makes it clear that merely setting `domain:complex` will not make individual variables default to being complex. If sage wants variables to be complex, then it should declare them that way. \n\nHowever, I tried this a couple of months ago (just by making a minor modification to `SR.symbol`) and got lots of doctest failures. The two main problems were: \n\n1. Maxima seems to give different (much more complicated) answers for some definite integrals when the integration variable is declared to be complex. \n2. There were also a lot of failures in `manifolds`, so perhaps that code is assuming that the variables are real.\n\nThe problem has been around a long time, and I don't think this can be fixed in time for 9.3.  We should try to do something for 9.4, but I think it will require serious work.\n\nMaybe this ticket should be closed as a duplicate of #6862.",
    "created_at": "2021-03-28T22:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436460",
    "user": "@DaveWitteMorris"
}
```

This was reported upstream on #6862. The maxima developers deny that it is a bug, and I agree with them, because the maxima documentation makes it clear that merely setting `domain:complex` will not make individual variables default to being complex. If sage wants variables to be complex, then it should declare them that way. 

However, I tried this a couple of months ago (just by making a minor modification to `SR.symbol`) and got lots of doctest failures. The two main problems were: 

1. Maxima seems to give different (much more complicated) answers for some definite integrals when the integration variable is declared to be complex. 
2. There were also a lot of failures in `manifolds`, so perhaps that code is assuming that the variables are real.

The problem has been around a long time, and I don't think this can be fixed in time for 9.3.  We should try to do something for 9.4, but I think it will require serious work.

Maybe this ticket should be closed as a duplicate of #6862.



---

archive/issue_comments_436461.json:
```json
{
    "body": "Thanks for the analysis! +1 for consolidating the two tickets, closing one of them, and moving the remaining one to milestone 9.4.",
    "created_at": "2021-03-28T23:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436461",
    "user": "mkoeppe"
}
```

Thanks for the analysis! +1 for consolidating the two tickets, closing one of them, and moving the remaining one to milestone 9.4.



---

archive/issue_comments_436462.json:
```json
{
    "body": "Replying to [comment:5 gh-DaveWitteMorris]:\n\n> 1. Maxima seems to give different (much more complicated) answers for some definite integrals when the integration variable is declared to be complex. \n\nThat's to be expected. Complex path integrals are generally path-dependent, so just specifying the end points of the path doesn't tell the whole story. Much of the integration machinery will normally be assuming real variables. This is one reason to *not* assume complex variables by default.\n\nThe main problem found on #6862 is the present incompatibility between pynac's and maxima's default. With this information, perhaps it would be worth seeing how bad inserting a default `assume(<var>,\"real\")` so that pynac at least agrees with maxima. If that leads to significantly less doctests, perhaps that's a preferable direction to resolve the mismatch.",
    "created_at": "2021-03-29T00:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436462",
    "user": "nbruin"
}
```

Replying to [comment:5 gh-DaveWitteMorris]:

> 1. Maxima seems to give different (much more complicated) answers for some definite integrals when the integration variable is declared to be complex. 

That's to be expected. Complex path integrals are generally path-dependent, so just specifying the end points of the path doesn't tell the whole story. Much of the integration machinery will normally be assuming real variables. This is one reason to *not* assume complex variables by default.

The main problem found on #6862 is the present incompatibility between pynac's and maxima's default. With this information, perhaps it would be worth seeing how bad inserting a default `assume(<var>,"real")` so that pynac at least agrees with maxima. If that leads to significantly less doctests, perhaps that's a preferable direction to resolve the mismatch.



---

archive/issue_comments_436463.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30556",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30556#issuecomment-436463",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.
