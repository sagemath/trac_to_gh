# Issue 17463: wrong symbolic results in case the answer is not known

Issue created by migration from Trac.

Original creator: jakobkroeker

Original creation time: 2015-01-30 17:14:22

CC:  ​eviatarbach ​tmonteil slelievre vdelecroix

A failing example is taken from 

http://ask.sagemath.org/question/10388/testing-inequalities-in-sage/

```

var('a','b')
bool( abs(a+b) <= abs(a) + abs(b) ) # False, expected True or 'Unknown'
assert (not False == bool( abs(a+b) <= abs(a) + abs(b) ) ) #fails
```


see also discussion at 
https://groups.google.com/d/msg/sage-devel/vNxnHSeRBW4/0OpeL0yv9YUJ

In that thread the exception variant is preferred in case of 'don't know'

Please also take into consideration Tristate variants
( A sandbox for a Tristate class: 
https://github.com/jakobkroeker/Tristate.py )


---

Comment by eviatarbach created at 2015-02-27 07:30:31

Thanks for opening this ticket! I think this is a huge problem in Sage symbolics.

I can't remember what I did to change the behaviour so that when a comparison is made and the result can't be determined it raises an exception instead of returning `False`; I'll try to look into it this weekend.

I like the idea of having a three-valued logic (https://en.wikipedia.org/wiki/Three-valued_logic); unfortunately Python makes this very difficult, as the `Tristate` class shows. There does not seem to be an elegant solution, so I wonder if it's not just best to stick with exceptions.


---

Comment by rws created at 2015-02-27 09:21:52

I'll gladly do a review of this ticket.


---

Comment by leif created at 2015-05-13 12:54:50

Btw., also the coercion framework occasionally leads to "surprising" results (because silently `False` is returned upon comparison when no coercion can be established, such that for example `a == b and a == c` doesn't imply `b == c`).  This and similar has been discussed on sage-devel a couple of times.


---

Comment by rws created at 2015-07-17 08:08:18

The ticket is about symbolics so let's get concrete. It happens that at the moment I'm implementing more logic affecting comparisons/relations/zero tests of expressions in Pynac. The decision process for the logic in Sage is:

`Expression.__nonzero__()` is called on input of `bool`. `__nonzero__` is the one that should throw an exception for unknown results. In `__nonzero__`,
 1. first the relations of constants are decided
 1. Pynac's `relational_to_bool` is called (`relational::safe_bool()`), it does:
   1. relations with one or two infinities; any result gets returned by `__nonzero__` right away
   1. if l.h.s - r.h.s is a Python object (other than `Expression`) compare it to zero, i.e., delegate to the resp. class
   1. else if relation is >= or <= use positive flag of (l.h.s - r.h.s) or its negative to decide (Pynac-0.3.9.3/0.4.3)
 1. the previous result may now get changed in case of not-equal; already here Maxima may be called (I think this is wrong, Maxima should always be the last resort)
 1. if no assumptions are needed now is time for `test_relation` which has some detailed logic and uses interval fields to disprove relations ("interval fields never return false positives"); it already has tristate logic by returning `NotImplemented` if unsure
 1. if the previous neither returns `True/False` return what `symbolic/relation.py:test_relation_maxima()` returns
   1. the relation is tested and any `True` is returned immediately
   1. simplification is attempted before returning the final `True/False`

EDIT: `__nonzero__` is not called by Pynac
EDIT: add info about upcoming Pynac snippet


---

Comment by rws created at 2015-07-19 16:10:08

In https://github.com/pynac/pynac/issues/80 we implement multistate for item 2 above. The Sage part raises a `TypeError` with text `Undecidable relation: ...` if Pynac returns `undecidable` and continues on with item 3/4 in case of `not implemented`.


---

Comment by rws created at 2015-07-20 07:54:05

The second issue this ticket depends on concerns the Maxima interface in item 5. There is e.g.:

```
sage: from sage.symbolic.relation import test_relation_maxima
sage: test_relation_maxima(I>0)
False
```

because in Maxima

```
(%i8) is(%i>0);
(%o8)                               false
```

so the 'false' result should raise a `NotImplementedError` in `__nonzero__` because Maxima does not distinguish between `false`, `known undecidable`, and `unknown`. This produces hundreds of doctest fails in `symbolics` alone.

Moreover, trying to snatch this decision functionality from Maxima presupposes an independent assumption framework.

EDIT: I is %i in Maxima


---

Comment by eviatarbach created at 2016-07-02 00:20:59

I started doing some work on this. Since Sage already has an `Unknown` object for representing indeterminate truth values, I thought we could adapt it for use here. Ticket #20920 makes some changes to `Unknown` to raise an error when attempting to evaluate its truth value with `__nonzero__`, as well as adding an `Undecidable` object.


---

Comment by rws created at 2016-07-02 04:51:10

Great. See also #19040.
