# Issue 24797: Special case for gen_legendre_P with n == m gives incorrect results for x in (-1,1)

archive/issues_024797.json:
```json
{
    "body": "CC:  @rwst @slel @fredrik-johansson @tscrim\n\nKeywords: legendre, special function, spherical harmonic\n\nI am using the gen_legendre_P function (an instance of Func_assoc_legendre_P from sage/functions/orthogonal_polys.py) to evaluate associated Legendre functions / Ferrers functions in Sage Math 8.1.\n\nThere appears to be a discrepancy in the results I obtain, depending on whether I use gen_legendre_P.eval_poly() or directly call gen_legendre_P() in some cases. I think this is because the _eval_ method first tries to call the _eval_special_values_ method, before using eval_poly.\n\nWith this input\n\n\n```\nx = SR.var('x')\nprint gen_legendre_P.eval_poly(1,1,x)\nprint gen_legendre_P(1,1,x)\nprint gen_legendre_P.eval_poly(1,1,0.5)\nprint gen_legendre_P(1,1,0.5)\n```\n\n\nI obtain\n\n\n```\n-sqrt(-x^2 + 1)\nsqrt(x^2 - 1)\n-0.866025403784439\n5.30287619362453e-17 + 0.866025403784439*I\n```\n\n\nThe result from eval_poly agrees with Mathematica, i.e.\n\n\n```\nLegendreP[1, 1, 0.5]\n-0.866025\n```\n\n\nBased on the above output, it seems to me that gen_legendre_P.eval_poly(1,1,cos(theta)) will always be real while gen_legendre_P(1,1,cos(theta)) will be complex (unless |cos(theta)| = 1), since cos(theta) is in the interval [-1,1].\n\nLooking at the code for Func_assoc_legendre_P._eval_special_values_, I suspect the culprit is the n == m case, which returns\n\n\n```\nfactorial(2*m)/2**m/factorial(m) * (x**2-1)**(m/2)\n```\n\n\nThis discrepancy also seems to be present in spherical_harmonic when n == m (an instance of SphericalHarmonic from sage/functions/special.py), which is built using gen_legendre_P.\n\nAfter discussion in the sage-devel mailing list (https://groups.google.com/d/msg/sage-devel/IDtiGF6HB28/ErLsqI1eBAAJ) it appears that this is because the n == m case in _eval_special_values_ is based on  https://dlmf.nist.gov/14.7#E15, but this is not defined in (-infinity,1].\n\nFor the spherical harmonics, where the argument x = cos(theta), x will always be in the range [-1, 1 ], where special case used in _eval_special_values_ is not defined.\n\nOn the sage-devel mailing list, Howard Cohl suggested that the correct formula for x < 1 is \n\n\n```\nP_m^m(x)=(-1)^m (2m)!/(2^m m!) (1-x^2)^(m/2)\n```\n\n\nSee: https://groups.google.com/d/msg/sage-devel/IDtiGF6HB28/QWwnAeLJBAAJ\n\nAccording to Howard Cohl this is formally a Ferrers function (defined on (-1,1) ), rather than an associated Legendre polynomial. However, the existing code for Func_assoc_legendre_P does not seem to make any distinction between Ferrers and associated Legendre functions. \n\nMy proposed fix would be to have Func_assoc_legendre_P._eval_special_values_ choose between two n == m special cases, based on whether -1 <= x <= 1 (above expression) or > 1 (current expression).\n\nThis raises the question of whether Func_assoc_legendre_P is correctly defined, as at present it would seem to cover both Ferrers functions and associated Legendre functions. \n\nIn my experience with the physics/chemistry literature, the spherical harmonics are universally defined in terms of \"associated Legendre functions\", even though the argument is x = cos(theta). DLMF suggests these are defined in terms of Ferrers functions of the first kind (https://dlmf.nist.gov/14.30.E1). Wolfram Mathematica does not seem to distinguish. Possibly it is worth flagging in the docstring for Func_assoc_legendre_P that the class seems to cover both functions.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25034\n\n",
    "created_at": "2018-03-27T09:09:57Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Special case for gen_legendre_P with n == m gives incorrect results for x in (-1,1)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24797",
    "user": "jcwomack"
}
```
CC:  @rwst @slel @fredrik-johansson @tscrim

Keywords: legendre, special function, spherical harmonic

I am using the gen_legendre_P function (an instance of Func_assoc_legendre_P from sage/functions/orthogonal_polys.py) to evaluate associated Legendre functions / Ferrers functions in Sage Math 8.1.

There appears to be a discrepancy in the results I obtain, depending on whether I use gen_legendre_P.eval_poly() or directly call gen_legendre_P() in some cases. I think this is because the _eval_ method first tries to call the _eval_special_values_ method, before using eval_poly.

With this input


```
x = SR.var('x')
print gen_legendre_P.eval_poly(1,1,x)
print gen_legendre_P(1,1,x)
print gen_legendre_P.eval_poly(1,1,0.5)
print gen_legendre_P(1,1,0.5)
```


I obtain


```
-sqrt(-x^2 + 1)
sqrt(x^2 - 1)
-0.866025403784439
5.30287619362453e-17 + 0.866025403784439*I
```


The result from eval_poly agrees with Mathematica, i.e.


```
LegendreP[1, 1, 0.5]
-0.866025
```


Based on the above output, it seems to me that gen_legendre_P.eval_poly(1,1,cos(theta)) will always be real while gen_legendre_P(1,1,cos(theta)) will be complex (unless |cos(theta)| = 1), since cos(theta) is in the interval [-1,1].

Looking at the code for Func_assoc_legendre_P._eval_special_values_, I suspect the culprit is the n == m case, which returns


```
factorial(2*m)/2**m/factorial(m) * (x**2-1)**(m/2)
```


This discrepancy also seems to be present in spherical_harmonic when n == m (an instance of SphericalHarmonic from sage/functions/special.py), which is built using gen_legendre_P.

After discussion in the sage-devel mailing list (https://groups.google.com/d/msg/sage-devel/IDtiGF6HB28/ErLsqI1eBAAJ) it appears that this is because the n == m case in _eval_special_values_ is based on  https://dlmf.nist.gov/14.7#E15, but this is not defined in (-infinity,1].

For the spherical harmonics, where the argument x = cos(theta), x will always be in the range [-1, 1 ], where special case used in _eval_special_values_ is not defined.

On the sage-devel mailing list, Howard Cohl suggested that the correct formula for x < 1 is 


```
P_m^m(x)=(-1)^m (2m)!/(2^m m!) (1-x^2)^(m/2)
```


See: https://groups.google.com/d/msg/sage-devel/IDtiGF6HB28/QWwnAeLJBAAJ

According to Howard Cohl this is formally a Ferrers function (defined on (-1,1) ), rather than an associated Legendre polynomial. However, the existing code for Func_assoc_legendre_P does not seem to make any distinction between Ferrers and associated Legendre functions. 

My proposed fix would be to have Func_assoc_legendre_P._eval_special_values_ choose between two n == m special cases, based on whether -1 <= x <= 1 (above expression) or > 1 (current expression).

This raises the question of whether Func_assoc_legendre_P is correctly defined, as at present it would seem to cover both Ferrers functions and associated Legendre functions. 

In my experience with the physics/chemistry literature, the spherical harmonics are universally defined in terms of "associated Legendre functions", even though the argument is x = cos(theta). DLMF suggests these are defined in terms of Ferrers functions of the first kind (https://dlmf.nist.gov/14.30.E1). Wolfram Mathematica does not seem to distinguish. Possibly it is worth flagging in the docstring for Func_assoc_legendre_P that the class seems to cover both functions.

Issue created by migration from https://trac.sagemath.org/ticket/25034





---

archive/issue_comments_348174.json:
```json
{
    "body": "A (quite severe IMHO) consequence of this bug is\n\n```\nsage: theta, phi = var('theta phi')\nsage: spherical_harmonic(1, 1, theta, phi)\n-1/4*sqrt(3)*sqrt(2)*sqrt(cos(theta)^2 - 1)*e^(I*phi)/sqrt(pi)\n```\n\nwhich is plain wrong: the term `sqrt(cos(theta)^2-1)` (which is imaginary for `theta` real) should actually be `sin(theta)`.",
    "created_at": "2018-04-08T16:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348174",
    "user": "@egourgoulhon"
}
```

A (quite severe IMHO) consequence of this bug is

```
sage: theta, phi = var('theta phi')
sage: spherical_harmonic(1, 1, theta, phi)
-1/4*sqrt(3)*sqrt(2)*sqrt(cos(theta)^2 - 1)*e^(I*phi)/sqrt(pi)
```

which is plain wrong: the term `sqrt(cos(theta)^2-1)` (which is imaginary for `theta` real) should actually be `sin(theta)`.



---

archive/issue_comments_348175.json:
```json
{
    "body": "For reference, here are some related issues reported by users:\n- https://groups.google.com/forum/#!msg/sage-support/I_d_meMxRbM/bDhZ_wtoAgAJ\n- https://ask.sagemath.org/question/49694\n- https://ask.sagemath.org/question/48776",
    "created_at": "2020-01-28T14:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348175",
    "user": "@egourgoulhon"
}
```

For reference, here are some related issues reported by users:
- https://groups.google.com/forum/#!msg/sage-support/I_d_meMxRbM/bDhZ_wtoAgAJ
- https://ask.sagemath.org/question/49694
- https://ask.sagemath.org/question/48776



---

archive/issue_comments_348176.json:
```json
{
    "body": "Replying to [comment:4 egourgoulhon]:\n> For reference, here are some related issues reported by users:\n> - https://groups.google.com/forum/#!msg/sage-support/I_d_meMxRbM/bDhZ_wtoAgAJ\n> - https://ask.sagemath.org/question/49694\n> - https://ask.sagemath.org/question/48776\n\nOne more:\n- https://ask.sagemath.org/question/49891/",
    "created_at": "2020-02-12T20:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348176",
    "user": "@egourgoulhon"
}
```

Replying to [comment:4 egourgoulhon]:
> For reference, here are some related issues reported by users:
> - https://groups.google.com/forum/#!msg/sage-support/I_d_meMxRbM/bDhZ_wtoAgAJ
> - https://ask.sagemath.org/question/49694
> - https://ask.sagemath.org/question/48776

One more:
- https://ask.sagemath.org/question/49891/



---

archive/issue_comments_348177.json:
```json
{
    "body": "> > For reference, here are some related issues reported by users:\n> > - https://groups.google.com/forum/#!msg/sage-support/I_d_meMxRbM/bDhZ_wtoAgAJ\n> > - https://ask.sagemath.org/question/49694\n> > - https://ask.sagemath.org/question/48776\n> \n> One more:\n> - https://ask.sagemath.org/question/49891/\nYet one more:\n- https://ask.sagemath.org/question/51994/",
    "created_at": "2020-06-15T15:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348177",
    "user": "@egourgoulhon"
}
```

> > For reference, here are some related issues reported by users:
> > - https://groups.google.com/forum/#!msg/sage-support/I_d_meMxRbM/bDhZ_wtoAgAJ
> > - https://ask.sagemath.org/question/49694
> > - https://ask.sagemath.org/question/48776
> 
> One more:
> - https://ask.sagemath.org/question/49891/
Yet one more:
- https://ask.sagemath.org/question/51994/



---

archive/issue_comments_348178.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-04-08T21:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348178",
    "user": "@mjungmath"
}
```

Changing priority from major to critical.



---

archive/issue_comments_348179.json:
```json
{
    "body": "Since this features is obviously highly demanded, and within two years not resolved, I took the freedom to shift it's priority to \"critical\".",
    "created_at": "2021-04-08T21:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348179",
    "user": "@mjungmath"
}
```

Since this features is obviously highly demanded, and within two years not resolved, I took the freedom to shift it's priority to "critical".



---

archive/issue_comments_348180.json:
```json
{
    "body": "What about separately adding `Func_ferrers` to the library with the appropriate convention then?\n\nOne can easily refer to https://dlmf.nist.gov/14.7#E8 and https://dlmf.nist.gov/14.7#E14 respectively and clarify the convention.\n\nAlso, I found a nice stackexchange post explaining the origin of this difference: https://math.stackexchange.com/a/2986444",
    "created_at": "2021-04-09T21:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348180",
    "user": "@mjungmath"
}
```

What about separately adding `Func_ferrers` to the library with the appropriate convention then?

One can easily refer to https://dlmf.nist.gov/14.7#E8 and https://dlmf.nist.gov/14.7#E14 respectively and clarify the convention.

Also, I found a nice stackexchange post explaining the origin of this difference: https://math.stackexchange.com/a/2986444



---

archive/issue_comments_348181.json:
```json
{
    "body": "I already worked on something. Will push tomorrow.",
    "created_at": "2021-04-10T00:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348181",
    "user": "@mjungmath"
}
```

I already worked on something. Will push tomorrow.



---

archive/issue_comments_348182.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-10T10:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348182",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348183.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-10T12:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348183",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348184.json:
```json
{
    "body": "I have uploaded a proposal. Please let me know in case I have missed any details.\n\n**What have I done?**\n\n- The main modification is as proposed:\n   {{{#!diff\n         if m == 0:\n             return legendre_P(n, x)\n         if n == m:\n-            return (-1)**m*(1-x**2)**(m/2) * ZZ(2*m-1).multifactorial(2)\n+            return (-1)**m*factorial(2*m)/(2**m*factorial(m)) * (1-x**2)**(m/2)\n   }}}\n\n- Furthermore I have added the feature of negative `m` which wasn't there yet.\n- The special case `m+1=n` has been added.\n\nYou are invited to contribute more doctests, especially for spherical harmonics. So far, I have only collected some of the code snippets posted above that have not worked. They are working now.\n\n**Follow-Ups**\n\n- As for resolving convention conflicts, I propose to wrap this up in a follow-up ticket (#31637).\n\n- Moreover, imho the documentation for orthogonal polynomials is a mess and urgently needs to be cleaned up. I suggest to attack this in another follow-up ticket (#31636).",
    "created_at": "2021-04-10T12:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348184",
    "user": "@mjungmath"
}
```

I have uploaded a proposal. Please let me know in case I have missed any details.

**What have I done?**

- The main modification is as proposed:
   {{{#!diff
         if m == 0:
             return legendre_P(n, x)
         if n == m:
-            return (-1)**m*(1-x**2)**(m/2) * ZZ(2*m-1).multifactorial(2)
+            return (-1)**m*factorial(2*m)/(2**m*factorial(m)) * (1-x**2)**(m/2)
   }}}

- Furthermore I have added the feature of negative `m` which wasn't there yet.
- The special case `m+1=n` has been added.

You are invited to contribute more doctests, especially for spherical harmonics. So far, I have only collected some of the code snippets posted above that have not worked. They are working now.

**Follow-Ups**

- As for resolving convention conflicts, I propose to wrap this up in a follow-up ticket (#31637).

- Moreover, imho the documentation for orthogonal polynomials is a mess and urgently needs to be cleaned up. I suggest to attack this in another follow-up ticket (#31636).



---

archive/issue_comments_348185.json:
```json
{
    "body": "Thank you so much for tackling this! \n\nShall the ticket be set to needs_review? (in order to draw it to the patchbots' attention)",
    "created_at": "2021-04-10T12:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348185",
    "user": "@egourgoulhon"
}
```

Thank you so much for tackling this! 

Shall the ticket be set to needs_review? (in order to draw it to the patchbots' attention)



---

archive/issue_comments_348186.json:
```json
{
    "body": "Replying to [comment:17 egourgoulhon]:\n> Thank you so much for tackling this! \n> \n> Shall the ticket be set to needs_review? (in order to get the attention of the patchbots)\n\nWould you mind to add some more doctests for spherical coordinates before? I think, the current doctesting is a little bit sparse considering that the bug has not been caught. At least I would feel more comfortable if some identities or important values are checked that haven't worked before.",
    "created_at": "2021-04-10T12:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348186",
    "user": "@mjungmath"
}
```

Replying to [comment:17 egourgoulhon]:
> Thank you so much for tackling this! 
> 
> Shall the ticket be set to needs_review? (in order to get the attention of the patchbots)

Would you mind to add some more doctests for spherical coordinates before? I think, the current doctesting is a little bit sparse considering that the bug has not been caught. At least I would feel more comfortable if some identities or important values are checked that haven't worked before.



---

archive/issue_comments_348187.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-10T14:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348187",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348188.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-10T15:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348188",
    "user": "@mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348189.json:
```json
{
    "body": "Replying to [comment:18 gh-mjungmath]:\n> Would you mind to add some more doctests for spherical coordinates before? I think, the current doctesting is a little bit sparse considering that the bug has not been caught. At least I would feel more comfortable if some identities or important values are checked that haven't worked before.\n\nAlright, technically speaking spherical harmonics do not belong to this ticket. Let's finish this one first before messing with spherical harmonics. I created a follow-up: #31639.",
    "created_at": "2021-04-10T15:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348189",
    "user": "@mjungmath"
}
```

Replying to [comment:18 gh-mjungmath]:
> Would you mind to add some more doctests for spherical coordinates before? I think, the current doctesting is a little bit sparse considering that the bug has not been caught. At least I would feel more comfortable if some identities or important values are checked that haven't worked before.

Alright, technically speaking spherical harmonics do not belong to this ticket. Let's finish this one first before messing with spherical harmonics. I created a follow-up: #31639.



---

archive/issue_comments_348190.json:
```json
{
    "body": "Patchbot is green at least.",
    "created_at": "2021-04-10T20:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348190",
    "user": "@mjungmath"
}
```

Patchbot is green at least.



---

archive/issue_comments_348191.json:
```json
{
    "body": "The order in which you perform tests is important. Here:\n\n```\nif n in ZZ and m in ZZ and (x in ZZ or not SR(x).is_numeric()) and n >= 0:\n```\n\nyou should have the `n >= 0` before the `x` tests as it is quicker.\n\nI am also not sure about doing the multiplication first in the quotient here:\n\n```\nreturn (-1)**m*factorial(2*m)/(2**m*factorial(m)) * (1-x**2)**(m/2)\n```\n\nI feel like \n\n```\n(-1)**m * factorial(2*m)/factorial(m)/2**m * (1-x**2)**(m/2)\n```\n\nshould give better performance since we know the first division is exact. (I really would prefer `//`, but that won't work if `m` is a symbolic variable unfortunately...)\n\nAlso, a while-we-are-at-it:\n\n```diff\n-return ZZ(0)\n+return ZZ.zero()\n```\n\n\nI probably would also be good to add support for negative `n` by replacing it with `-n-1`. This will get rid of the error for `gen_legendre_P(-2,-2,x)`.\n\nI don't understand why you feed this back through the full evaluation instead of this:\n\n```diff\n-return x*(2*m+1)*gen_legendre_P(m, m, x)\n+return x * (2*m+1) * self._eval_special_values_(m, m, x)\n```\n\n\nA small tweak in the language:\n\n```diff\n-Print the first associated Legendre polynomials::\n+We give the first associated Legendre polynomials::\n```\n\nI would also add a space around the `=` to make it easier to read the output.\n\nPlease put the `REFERENCES:` at the end of the docstring (and add the `S`).",
    "created_at": "2021-04-10T22:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348191",
    "user": "@tscrim"
}
```

The order in which you perform tests is important. Here:

```
if n in ZZ and m in ZZ and (x in ZZ or not SR(x).is_numeric()) and n >= 0:
```

you should have the `n >= 0` before the `x` tests as it is quicker.

I am also not sure about doing the multiplication first in the quotient here:

```
return (-1)**m*factorial(2*m)/(2**m*factorial(m)) * (1-x**2)**(m/2)
```

I feel like 

```
(-1)**m * factorial(2*m)/factorial(m)/2**m * (1-x**2)**(m/2)
```

should give better performance since we know the first division is exact. (I really would prefer `//`, but that won't work if `m` is a symbolic variable unfortunately...)

Also, a while-we-are-at-it:

```diff
-return ZZ(0)
+return ZZ.zero()
```


I probably would also be good to add support for negative `n` by replacing it with `-n-1`. This will get rid of the error for `gen_legendre_P(-2,-2,x)`.

I don't understand why you feed this back through the full evaluation instead of this:

```diff
-return x*(2*m+1)*gen_legendre_P(m, m, x)
+return x * (2*m+1) * self._eval_special_values_(m, m, x)
```


A small tweak in the language:

```diff
-Print the first associated Legendre polynomials::
+We give the first associated Legendre polynomials::
```

I would also add a space around the `=` to make it easier to read the output.

Please put the `REFERENCES:` at the end of the docstring (and add the `S`).



---

archive/issue_comments_348192.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-11T11:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348192",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348193.json:
```json
{
    "body": "Thank you Travis for the feedback! I hope I took everything in account now. In addition, I refactored `_eval_` a bit and completely removed `_eval_special_values_`. Please check this out.",
    "created_at": "2021-04-11T11:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348193",
    "user": "@mjungmath"
}
```

Thank you Travis for the feedback! I hope I took everything in account now. In addition, I refactored `_eval_` a bit and completely removed `_eval_special_values_`. Please check this out.



---

archive/issue_comments_348194.json:
```json
{
    "body": "I know that this is not absolutely precise at the moment. But at least this implementation is more or less consistent and makes spherical harmonics work properly. More elaborate thoughts to resolve this are very much appreciated in #31637.",
    "created_at": "2021-04-11T11:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348194",
    "user": "@mjungmath"
}
```

I know that this is not absolutely precise at the moment. But at least this implementation is more or less consistent and makes spherical harmonics work properly. More elaborate thoughts to resolve this are very much appreciated in #31637.



---

archive/issue_comments_348195.json:
```json
{
    "body": "Patchbot green again.",
    "created_at": "2021-04-11T14:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348195",
    "user": "@mjungmath"
}
```

Patchbot green again.



---

archive/issue_comments_348196.json:
```json
{
    "body": "I am -1 on removing `_eval_special_values_` as it has a clear purpose and is useful for future maintenance by having a more logical grouping of the code.",
    "created_at": "2021-04-11T22:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348196",
    "user": "@tscrim"
}
```

I am -1 on removing `_eval_special_values_` as it has a clear purpose and is useful for future maintenance by having a more logical grouping of the code.



---

archive/issue_comments_348197.json:
```json
{
    "body": "Now it is grouped into \"integer\" and \"non-integer\" case. Unfortunately, this didn't work well with `_eval_special_values_` because it would lead to many repeated if-statements. This is the most concise pattern I could think of. Do you have another idea?\n\nMoreover, the `x == 0` case seemingly didn't make sense for `_evalf_`. Please correct me if I am wrong here.",
    "created_at": "2021-04-11T23:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348197",
    "user": "@mjungmath"
}
```

Now it is grouped into "integer" and "non-integer" case. Unfortunately, this didn't work well with `_eval_special_values_` because it would lead to many repeated if-statements. This is the most concise pattern I could think of. Do you have another idea?

Moreover, the `x == 0` case seemingly didn't make sense for `_evalf_`. Please correct me if I am wrong here.



---

archive/issue_comments_348198.json:
```json
{
    "body": "I thought the previous version was fine. I don't like forcing it all together, as opposed to what many other functions do. I also don't really think the `SR(x).is_numeric()` test being run so frequently is good.\n\nAdditionally, with your current code, if passing symbolic `m == n`, it no longer gets the special value AFAICS.",
    "created_at": "2021-04-12T01:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348198",
    "user": "@tscrim"
}
```

I thought the previous version was fine. I don't like forcing it all together, as opposed to what many other functions do. I also don't really think the `SR(x).is_numeric()` test being run so frequently is good.

Additionally, with your current code, if passing symbolic `m == n`, it no longer gets the special value AFAICS.



---

archive/issue_comments_348199.json:
```json
{
    "body": "Replying to [comment:30 tscrim]:\n> Additionally, with your current code, if passing symbolic `m == n`, it no longer gets the special value AFAICS.\n\nTrue. However, this particular formula holds indeed if `m` and `n` are integers. But I am not sure whether this extends accordingly to arbitrary `m` and `n` using Gamma functions...\n\nPlaying around with the numeric tool, it turned out that the case `abs(m) > n` only yields zero for the integer case (try for example `gen_legendre_P(2.,3.*I,.5)`).\n\nGrouping it the same way as before would therefore lead to many redundant if-statements, as said above. I don't think this is desirable either.",
    "created_at": "2021-04-12T08:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348199",
    "user": "@mjungmath"
}
```

Replying to [comment:30 tscrim]:
> Additionally, with your current code, if passing symbolic `m == n`, it no longer gets the special value AFAICS.

True. However, this particular formula holds indeed if `m` and `n` are integers. But I am not sure whether this extends accordingly to arbitrary `m` and `n` using Gamma functions...

Playing around with the numeric tool, it turned out that the case `abs(m) > n` only yields zero for the integer case (try for example `gen_legendre_P(2.,3.*I,.5)`).

Grouping it the same way as before would therefore lead to many redundant if-statements, as said above. I don't think this is desirable either.



---

archive/issue_comments_348200.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-12T10:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348200",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348201.json:
```json
{
    "body": "What about this?",
    "created_at": "2021-04-12T10:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348201",
    "user": "@mjungmath"
}
```

What about this?



---

archive/issue_comments_348202.json:
```json
{
    "body": "At least the patchbot likes it. This version is very close to the version before, but now with negative `n`. This is still not optimal but I think more preciseness should be elaborated in the follow-up ticket.\n\nWhat do you think?",
    "created_at": "2021-04-13T11:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348202",
    "user": "@mjungmath"
}
```

At least the patchbot likes it. This version is very close to the version before, but now with negative `n`. This is still not optimal but I think more preciseness should be elaborated in the follow-up ticket.

What do you think?



---

archive/issue_comments_348203.json:
```json
{
    "body": "I think this is a lot better.\n\nThis is a bit cumbersome way of saying \"let m be a positive integer\":\n\n```\n+    For `n` being a non-negative integer, negative integer values for `m`\n+    with `|m| \\leq n` can be obtained by:\n+\n+    .. MATH::\n+\n+            P^{-|m|}_n(x) = (-1)^{|m|} \\frac{(n-|m|)!}{(n+|m|)!} P_n^{|m|}(x).\n```\n\n\nI am not sure about removing the `_eval_special_values_` from `_evalf_`. Can we add doctests for floating point input with special values?\n\nI think we should also add doctests to `_eval_special_values_` for symbolic `m` input as well.",
    "created_at": "2021-04-14T01:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348203",
    "user": "@tscrim"
}
```

I think this is a lot better.

This is a bit cumbersome way of saying "let m be a positive integer":

```
+    For `n` being a non-negative integer, negative integer values for `m`
+    with `|m| \leq n` can be obtained by:
+
+    .. MATH::
+
+            P^{-|m|}_n(x) = (-1)^{|m|} \frac{(n-|m|)!}{(n+|m|)!} P_n^{|m|}(x).
```


I am not sure about removing the `_eval_special_values_` from `_evalf_`. Can we add doctests for floating point input with special values?

I think we should also add doctests to `_eval_special_values_` for symbolic `m` input as well.



---

archive/issue_comments_348204.json:
```json
{
    "body": "Replying to [comment:35 tscrim]:\n> I am not sure about removing the `_eval_special_values_` from `_evalf_`. Can we add doctests for floating point input with special values?\n\nI think it is reasonable to assume that `mpmath` already uses optimized algorithms, isn't it? Moreover, without the above patch we have something like that:\n\n\n```\nsage: %%time \n....: gen_legendre_P(1.2,1.1,0)\nCPU times: user 2.78 ms, sys: 0 ns, total: 2.78 ms\nWall time: 2.8 ms\n2.14354692507259*cos(1.15000000000000*pi)*gamma(33/20)/(sqrt(pi)*gamma(749113601384401/713441525128001))\n```\n\n\nwhich already looks clunky. Moreover if we want the answer in terms of floating numbers, we get:\n\n\n```\nsage: %%time \n....: gen_legendre_P(1.2,1.1,0).n()\nCPU times: user 166 ms, sys: 7.01 ms, total: 173 ms\nWall time: 204 ms\n-0.996322549249593\n```\n\n\nwhereas compared to with patch:\n\n\n```\nsage: %%time \n....: gen_legendre_P(1.2,1.1,0)\nCPU times: user 302 \u00b5s, sys: 20 \u00b5s, total: 322 \u00b5s\nWall time: 326 \u00b5s\n-0.996322549249593\n```\n\n\nFor the case `m=n` however, the `mpmath` version seems to be slightly slower than evaluating the special case (now everything with the new patch):\n\n\n```\nsage: %%time \n....: gen_legendre_P._evalf_(1,1,.2)\nCPU times: user 1.29 ms, sys: 0 ns, total: 1.29 ms\nWall time: 1.29 ms\n-0.979795897113271\nsage: %%time \n....: gen_legendre_P._eval_special_values_(1,1,.2)\nCPU times: user 124 \u00b5s, sys: 0 ns, total: 124 \u00b5s\nWall time: 127 \u00b5s\n-0.979795897113271\n```\n\n\nBut treading these cases differently would dismantle `_eval_special_values_` again.\n\n> \n> I think we should also add doctests to `_eval_special_values_` for symbolic `m` input as well.\n\nI'll do.",
    "created_at": "2021-04-14T10:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348204",
    "user": "@mjungmath"
}
```

Replying to [comment:35 tscrim]:
> I am not sure about removing the `_eval_special_values_` from `_evalf_`. Can we add doctests for floating point input with special values?

I think it is reasonable to assume that `mpmath` already uses optimized algorithms, isn't it? Moreover, without the above patch we have something like that:


```
sage: %%time 
....: gen_legendre_P(1.2,1.1,0)
CPU times: user 2.78 ms, sys: 0 ns, total: 2.78 ms
Wall time: 2.8 ms
2.14354692507259*cos(1.15000000000000*pi)*gamma(33/20)/(sqrt(pi)*gamma(749113601384401/713441525128001))
```


which already looks clunky. Moreover if we want the answer in terms of floating numbers, we get:


```
sage: %%time 
....: gen_legendre_P(1.2,1.1,0).n()
CPU times: user 166 ms, sys: 7.01 ms, total: 173 ms
Wall time: 204 ms
-0.996322549249593
```


whereas compared to with patch:


```
sage: %%time 
....: gen_legendre_P(1.2,1.1,0)
CPU times: user 302 µs, sys: 20 µs, total: 322 µs
Wall time: 326 µs
-0.996322549249593
```


For the case `m=n` however, the `mpmath` version seems to be slightly slower than evaluating the special case (now everything with the new patch):


```
sage: %%time 
....: gen_legendre_P._evalf_(1,1,.2)
CPU times: user 1.29 ms, sys: 0 ns, total: 1.29 ms
Wall time: 1.29 ms
-0.979795897113271
sage: %%time 
....: gen_legendre_P._eval_special_values_(1,1,.2)
CPU times: user 124 µs, sys: 0 ns, total: 124 µs
Wall time: 127 µs
-0.979795897113271
```


But treading these cases differently would dismantle `_eval_special_values_` again.

> 
> I think we should also add doctests to `_eval_special_values_` for symbolic `m` input as well.

I'll do.



---

archive/issue_comments_348205.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-14T21:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348205",
    "user": "@mjungmath"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_348206.json:
```json
{
    "body": "We need to also be more careful if the type of the output is changing as this can break other code in the wild. It might be good to see how other special functions behave for different inputs to make sure things match if we are going to change stuff.",
    "created_at": "2021-04-15T07:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348206",
    "user": "@tscrim"
}
```

We need to also be more careful if the type of the output is changing as this can break other code in the wild. It might be good to see how other special functions behave for different inputs to make sure things match if we are going to change stuff.



---

archive/issue_comments_348207.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-17T13:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348207",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348208.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-17T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348208",
    "user": "@mjungmath"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348209.json:
```json
{
    "body": "I had a little chat with Howard Cohl. He said that one has to be *extremely* careful which formula goes under what condition. In particular, one shouldn't use formulas for cases that are not stated in https://dlmf.nist.gov/14.\n\nSo I tried to be very careful and always referred to the corresponding formula in the code. But please double check that for me.\n\nOther than that, this is ready for review again.",
    "created_at": "2021-04-17T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348209",
    "user": "@mjungmath"
}
```

I had a little chat with Howard Cohl. He said that one has to be *extremely* careful which formula goes under what condition. In particular, one shouldn't use formulas for cases that are not stated in https://dlmf.nist.gov/14.

So I tried to be very careful and always referred to the corresponding formula in the code. But please double check that for me.

Other than that, this is ready for review again.



---

archive/issue_comments_348210.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-17T13:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348210",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348211.json:
```json
{
    "body": "Thanks for this work! It's nice that you made references to the DLMF for formulas in the code.\n\nIn the doctests  *Check whether :trac:`25034` yields correct results compared to Maxima* in `special.py`, shouldn't there be markers `# abs tol 1e-14` ?  Same remark for\n\n```\n        sage: gen_legendre_P(-5/3,3,1.+I)\n        0.238163715352606 + 0.0548443903534220*I\n```\n\nin the docstring of `Func_assoc_legendre_P`.",
    "created_at": "2021-04-17T16:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348211",
    "user": "@egourgoulhon"
}
```

Thanks for this work! It's nice that you made references to the DLMF for formulas in the code.

In the doctests  *Check whether :trac:`25034` yields correct results compared to Maxima* in `special.py`, shouldn't there be markers `# abs tol 1e-14` ?  Same remark for

```
        sage: gen_legendre_P(-5/3,3,1.+I)
        0.238163715352606 + 0.0548443903534220*I
```

in the docstring of `Func_assoc_legendre_P`.



---

archive/issue_comments_348212.json:
```json
{
    "body": "Replying to [comment:43 egourgoulhon]:\n> In the doctests  *Check whether :trac:`25034` yields correct results compared to Maxima* in `special.py`, shouldn't there be markers `# abs tol 1e-14` ?  Same remark for\n> {{{\n>         sage: gen_legendre_P(-5/3,3,1.+I)\n>         0.238163715352606 + 0.0548443903534220*I\n> }}}\n> in the docstring of `Func_assoc_legendre_P`.\n\nDone.",
    "created_at": "2021-04-17T16:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348212",
    "user": "@mjungmath"
}
```

Replying to [comment:43 egourgoulhon]:
> In the doctests  *Check whether :trac:`25034` yields correct results compared to Maxima* in `special.py`, shouldn't there be markers `# abs tol 1e-14` ?  Same remark for
> {{{
>         sage: gen_legendre_P(-5/3,3,1.+I)
>         0.238163715352606 + 0.0548443903534220*I
> }}}
> in the docstring of `Func_assoc_legendre_P`.

Done.



---

archive/issue_comments_348213.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-17T16:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348213",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348214.json:
```json
{
    "body": "I hope this will make it in Sage 9.3.",
    "created_at": "2021-04-17T16:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348214",
    "user": "@mjungmath"
}
```

I hope this will make it in Sage 9.3.



---

archive/issue_comments_348215.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-18T10:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348215",
    "user": "@egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348216.json:
```json
{
    "body": "Thanks again! It's great that Sage has decent spherical harmonics at last!\n\nTravis, do you agree with the positive review?",
    "created_at": "2021-04-18T10:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348216",
    "user": "@egourgoulhon"
}
```

Thanks again! It's great that Sage has decent spherical harmonics at last!

Travis, do you agree with the positive review?



---

archive/issue_comments_348217.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-04-18T16:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348217",
    "user": "@mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_348218.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-19T00:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348218",
    "user": "@tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_348219.json:
```json
{
    "body": "You have renamed the public function `eval_poly`, so this need a `deprecated_function_alias`.\n\nAs per comment:39, I consider this to be a regression because you removed `_eval_special_values_` from `_evalf_`:\n\n```\nsage: gen_legendre_P(x,x,.2)                                                                              \ngen_legendre_P(x, x, 0.200000000000000)\n```\n\nversus before:\n\n```\n(-0.960000000000000)^(1/2*x)*factorial(2*x)/(2^x*factorial(x))\n```\n",
    "created_at": "2021-04-19T00:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348219",
    "user": "@tscrim"
}
```

You have renamed the public function `eval_poly`, so this need a `deprecated_function_alias`.

As per comment:39, I consider this to be a regression because you removed `_eval_special_values_` from `_evalf_`:

```
sage: gen_legendre_P(x,x,.2)                                                                              
gen_legendre_P(x, x, 0.200000000000000)
```

versus before:

```
(-0.960000000000000)^(1/2*x)*factorial(2*x)/(2^x*factorial(x))
```




---

archive/issue_comments_348220.json:
```json
{
    "body": "Replying to [comment:49 tscrim]:\n> You have renamed the public function `eval_poly`, so this need a `deprecated_function_alias`.\n\nRight!\n\n> As per comment:39, I consider this to be a regression because you removed `_eval_special_values_` from `_evalf_`:\n> {{{\n> sage: gen_legendre_P(x,x,.2)                                                                              \n> gen_legendre_P(x, x, 0.200000000000000)\n> }}}\n> versus before:\n> {{{\n> (-0.960000000000000)<sup>(1/2*x)*factorial(2*x)/(2</sup>x*factorial(x))\n> }}}\n\nThis has nothing to do with removing `_eval_special_values_`. In fact:\n\n\n```\nsage: assume(x, 'integer')                                                      \nsage: gen_legendre_P(x, x, .2)                                                  \n0.960000000000000^(1/2*x)*(-1)^x*factorial(2*x)/(2^x*factorial(x))\n```\n\n\nIt is the line\n\n\n```diff\n+        if m.is_integer() and n.is_integer():\n             ...\n             if m == n:\n```\n\nthat makes sure that this formula is only used when `x` is an integer.",
    "created_at": "2021-04-19T07:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348220",
    "user": "@mjungmath"
}
```

Replying to [comment:49 tscrim]:
> You have renamed the public function `eval_poly`, so this need a `deprecated_function_alias`.

Right!

> As per comment:39, I consider this to be a regression because you removed `_eval_special_values_` from `_evalf_`:
> {{{
> sage: gen_legendre_P(x,x,.2)                                                                              
> gen_legendre_P(x, x, 0.200000000000000)
> }}}
> versus before:
> {{{
> (-0.960000000000000)<sup>(1/2*x)*factorial(2*x)/(2</sup>x*factorial(x))
> }}}

This has nothing to do with removing `_eval_special_values_`. In fact:


```
sage: assume(x, 'integer')                                                      
sage: gen_legendre_P(x, x, .2)                                                  
0.960000000000000^(1/2*x)*(-1)^x*factorial(2*x)/(2^x*factorial(x))
```


It is the line


```diff
+        if m.is_integer() and n.is_integer():
             ...
             if m == n:
```

that makes sure that this formula is only used when `x` is an integer.



---

archive/issue_comments_348221.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-19T07:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348221",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348222.json:
```json
{
    "body": "Here we go. Moreover, I have added some examples in the visible doc that show some floating number examples like the one above.",
    "created_at": "2021-04-19T07:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348222",
    "user": "@mjungmath"
}
```

Here we go. Moreover, I have added some examples in the visible doc that show some floating number examples like the one above.



---

archive/issue_comments_348223.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-19T07:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348223",
    "user": "@mjungmath"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348224.json:
```json
{
    "body": "Okay, thanks for the explanation. This will be good. Just a few more minor things:\n\n- `Case `|m| > |n|` for integers:` needs a `::`\n- Add a period at the end of the `.. MATH::` in `eval_gen_poly`.\n- Some formatting: `Evaluate the Ferrers function `P(n, m, x)` for `m` and `n` being concrete`\n- I would move the paragraph `These expressions ... `where |m| \\leq |n|`.` to the main part of the documentation so it is more visible.\n\nOnly the first is a must-do, but the rest are good while-we-are-at-it things.\n\nOnce these are done, it will be a positive review from me.",
    "created_at": "2021-04-20T02:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348224",
    "user": "@tscrim"
}
```

Okay, thanks for the explanation. This will be good. Just a few more minor things:

- `Case `|m| > |n|` for integers:` needs a `::`
- Add a period at the end of the `.. MATH::` in `eval_gen_poly`.
- Some formatting: `Evaluate the Ferrers function `P(n, m, x)` for `m` and `n` being concrete`
- I would move the paragraph `These expressions ... `where |m| \leq |n|`.` to the main part of the documentation so it is more visible.

Only the first is a must-do, but the rest are good while-we-are-at-it things.

Once these are done, it will be a positive review from me.



---

archive/issue_comments_348225.json:
```json
{
    "body": "I think references should go in the master bibliography file (`src/doc/en/reference/references/index.rst`), instead of the docstring.  See #27497.",
    "created_at": "2021-04-20T03:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348225",
    "user": "@DaveWitteMorris"
}
```

I think references should go in the master bibliography file (`src/doc/en/reference/references/index.rst`), instead of the docstring.  See #27497.



---

archive/issue_comments_348226.json:
```json
{
    "body": "Replying to [comment:54 tscrim]:\n> - I would move the paragraph `These expressions ... `where |m| \\leq |n|`.` to the main part of the documentation so it is more visible.\n\nI agree. However, the documentation of the whole file needs to be refactored imo (see #31636). Thus, I'll leave it there for now.\n\nAs for the rest: thank you for taking such a thorough look! :)",
    "created_at": "2021-04-20T07:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348226",
    "user": "@mjungmath"
}
```

Replying to [comment:54 tscrim]:
> - I would move the paragraph `These expressions ... `where |m| \leq |n|`.` to the main part of the documentation so it is more visible.

I agree. However, the documentation of the whole file needs to be refactored imo (see #31636). Thus, I'll leave it there for now.

As for the rest: thank you for taking such a thorough look! :)



---

archive/issue_comments_348227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T07:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348227",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348228.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T07:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348228",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348229.json:
```json
{
    "body": "Replying to [comment:55 gh-DaveWitteMorris]:\n> I think references should go in the master bibliography file (`src/doc/en/reference/references/index.rst`), instead of the docstring.  See #27497.\n\nIs that alright?\n\nBranch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T07:36:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348229",
    "user": "@mjungmath"
}
```

Replying to [comment:55 gh-DaveWitteMorris]:
> I think references should go in the master bibliography file (`src/doc/en/reference/references/index.rst`), instead of the docstring.  See #27497.

Is that alright?

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348230.json:
```json
{
    "body": "Patchbot is green. :)",
    "created_at": "2021-04-20T17:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348230",
    "user": "@mjungmath"
}
```

Patchbot is green. :)



---

archive/issue_comments_348231.json:
```json
{
    "body": "Looks like all sufficient conditions for positive review are satisfied.",
    "created_at": "2021-04-20T18:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348231",
    "user": "@mkoeppe"
}
```

Looks like all sufficient conditions for positive review are satisfied.



---

archive/issue_comments_348232.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-20T18:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348232",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348233.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-25T12:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348233",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_348234.json:
```json
{
    "body": "Thank you Matthias! :)",
    "created_at": "2021-04-26T15:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24797#issuecomment-348234",
    "user": "@mjungmath"
}
```

Thank you Matthias! :)
