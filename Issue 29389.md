# Issue 29389: ./configure --enable-SPKG does not work for optional pip packages

Issue created by migration from https://trac.sagemath.org/ticket/29626

Original creator: mkoeppe

Original creation time: 2020-04-30 19:41:16

CC:  slabbe dimpase jhpalmieri mjo

As reported in https://groups.google.com/d/msg/sage-release/6hBUt5i9FLs/RM-2eCdcBgAJ:

```
It seems that if I do

./configure  --enable-beautifulsoup4

or

./configure  --enable-pyopenssl

I get

make[3]: ***  Aucune règle pour fabriquer la cible « /home/slabbe/GitBox/sage/local/var/lib
/sage/installed/beautifulsoup4-none », nécessaire pour « all-sage ». Arrêt.
make[3]: *** Attente des tâches non terminées....
...

make[3]: ***  Aucune règle pour fabriquer la cible « /home/slabbe/GitBox/sage/local/var/lib/sage/installed/pyopenssl-none », nécessaire pour « all-sage ». Arrêt.
...

and make stops with an error.
```



---

Comment by jhpalmieri created at 2020-04-30 22:28:02

Related to #29113 and #29481, I'm guessing. See also ticket:29418#comment:23.


---

Comment by mkoeppe created at 2020-04-30 23:37:45

It's trying to use a target that does exist for the case of pip packages. See macro `PIP_PACKAGE_templ` in `build/make/Makefile.in`


---

Comment by mkoeppe created at 2020-04-30 23:42:56

See also #29097, which needs to touch the same bits of the Makefile


---

Comment by mkoeppe created at 2020-05-01 00:17:21

For 9.1 a quick fix could be to disable the `--enable-SPKG` options for pip packages.


---

Comment by mkoeppe created at 2020-05-01 00:44:09

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-05-01 00:44:09

New commits:


---

Comment by jhpalmieri created at 2020-05-01 03:50:35

I suggest also removing this message in `src/bin/sage`:

```
    if [ -n "$ENABLE_ARGS" ]; then
        echo >&2 "Hint: These optional/experimental packages can also be configured"
        echo >&2 "to be installed by passing$ENABLE_ARGS to ./configure"
    fi
```

Or make it conditional on the type of package, but that seems a bit involved.


---

Comment by jhpalmieri created at 2020-05-01 03:55:43

What is standard `./configure` behavior regarding bad flags? I see

```
$ ./configure --enable-pyflakes
configure: WARNING: unrecognized options: --enable-pyflakes
```

and then the warning message gets swept off the screen by all of the other messages. Should this be printed as part of a summary? Or do we assume that a user who knows enough to try something like this also knows enough to pay attention?


---

Comment by git created at 2020-05-01 04:03:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-01 04:05:01

Replying to [comment:7 jhpalmieri]:
> I suggest also removing this message in `src/bin/sage`:
> {{{
>     if [ -n "$ENABLE_ARGS" ]; then
>         echo >&2 "Hint: These optional/experimental packages can also be configured"
>         echo >&2 "to be installed by passing$ENABLE_ARGS to ./configure"
>     fi
> }}}

Done. Let's revisit this in the next release cycle.

> Or make it conditional on the type of package, but that seems a bit involved.

I agree, too complicated


---

Comment by mkoeppe created at 2020-05-01 04:07:57

Replying to [comment:8 jhpalmieri]:
> What is standard `./configure` behavior regarding bad flags? I see
> {{{
> $ ./configure --enable-pyflakes
> configure: WARNING: unrecognized options: --enable-pyflakes
> }}}
> and then the warning message gets swept off the screen by all of the other messages. Should this be printed as part of a summary? Or do we assume that a user who knows enough to try something like this also knows enough to pay attention?

That's normal and this part is not really configurable in autoconf.

One can disable these warning using `--disable-option-checking`, but I don't think there is an option to change these warnings to errors.


---

Comment by jhpalmieri created at 2020-05-01 04:15:47

Regarding the new message in `sage_spkg_collect.m4`: `sage -i PKG` and `make PKG` both seem to work, and so does `sage --pip install PKG`. Is there any reason to prefer any of these? (Well, `sage -i PKG` does other stuff, too, so that one isn't as good, in my opinion.)


---

Comment by jhpalmieri created at 2020-05-01 04:58:05

In fact, I would prefer `make PKG`, since it works with a fresh tarball, whereas `sage --pip install PKG` doesn't do what I want: since I'm using the system Python, it installs the package in the system location, not in SAGE_ROOT/local/...  `make PKG` installs in the correct place.


---

Comment by mkoeppe created at 2020-05-01 05:08:13

Thanks for catching this. That's an important point


---

Comment by git created at 2020-05-01 05:16:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-01 05:20:55

Replying to [comment:13 jhpalmieri]:
> In fact, I would prefer `make PKG`, since it works with a fresh tarball, whereas `sage --pip install PKG` doesn't do what I want: since I'm using the system Python, it installs the package in the system location, not in SAGE_ROOT/local/...  `make PKG` installs in the correct place.

I have created a separate isssue for this: #29627 ("sage -pip" should never install into the system Python's site-packages)


---

Comment by mkoeppe created at 2020-05-01 05:22:04

I am using `sage -i PKG` in the message instead of `make PKG` because I'm not sure if we should advertise the latter.


---

Comment by mkoeppe created at 2020-05-01 05:22:35

(`sage -i` is already documented.)


---

Comment by dimpase created at 2020-05-01 07:43:32

Replying to [comment:17 mkoeppe]:
> I am using `sage -i PKG` in the message instead of `make PKG` because I'm not sure if we should advertise the latter.

I thought it's the plan to move to using `make` instead of `sage -i`


---

Comment by dimpase created at 2020-05-01 08:24:28

I can't reproduce the problem this ticket is meant to solve.


---

Comment by slabbe created at 2020-05-01 08:38:54

Replying to [comment:20 dimpase]:
> I can't reproduce the problem this ticket is meant to solve.

To be honest, I was using configure with other options. Let me try again the minimal example... On my working installation of 9.1.rc2, if I do:


```
./configure  --enable-pyopenssl
make
```


I get


```
make[3]: ***  Aucune règle pour fabriquer la cible « /home/slabbe/GitBox/sage/local/var/lib/sage/installed/pyopenssl-none », nécessaire pour « all-sage ». Arrêt.
make[3] : on quitte le répertoire « /home/slabbe/GitBox/sage/build/make »
Makefile:1841 : la recette pour la cible « all-start » a échouée
make[2]: *** [all-start] Erreur 2
make[2] : on quitte le répertoire « /home/slabbe/GitBox/sage/build/make »

real	1m40.559s
user	1m29.896s
sys	0m10.192s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make all-start'):

It is safe to delete any log files and build directories, but they
contain information that is helpful for debugging build problems.
WARNING: If you now run 'make' again, the build directory of the
same version of the package will, by default, be deleted. Set the
environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

Makefile:31 : la recette pour la cible « all-start » a échouée
make[1]: *** [all-start] Erreur 1
make[1] : on quitte le répertoire « /home/slabbe/GitBox/sage »
Makefile:13 : la recette pour la cible « all » a échouée
make: *** [all] Erreur 2
```


which confirms the issue on my machine.


---

Comment by slabbe created at 2020-05-01 08:40:32

Notice also that the list of `The following package(s) may have failed to build` is empty which is kind of weird and which made me search longer to discover the problem.


---

Comment by slabbe created at 2020-05-01 08:55:00

With the branch applied, I confirm that it is not documented anymore:


```
$ ./configure  --help | grep pyopenssl
$ ./configure  --help | grep fricas
  --enable-fricas={no|if_installed|yes}
                          enable build and use of the optional package fricas
                          package information: ./sage -info fricas
  --disable-fricas        disable build and uninstall if previously installed
                          by Sage in PREFIX; same as --enable-fricas=no
```


But still, if I decide to do it, then


```
./configure  --enable-pyopenssl
```


prints the warning `configure: WARNING: unrecognized options: --enable-pyopenssl`

And then


```
MAKE='make -j8' make
```

finishes without error.

And as expected, `pyopenssl` is not installed:


```
$ sage -optional | grep pyopenssl
pyopenssl...............................19.1.0 (not_installed)
```


To me it is a positive review (for the behavior). I did not check the code itself. So I let John or Dima or someone else to change the status of the ticket to positive review if that part is good too.


---

Comment by slabbe created at 2020-05-01 09:00:12

Replying to [comment:19 dimpase]:
> I thought it's the plan to move to using `make` instead of `sage -i`
I also thought that (well read it from previous very involved developpers).


---

Comment by slabbe created at 2020-05-01 09:11:53

I don't see how to obtain the message that tells me to `make pyopensl` or `sage -i pyopenssl` ?


---

Comment by mkoeppe created at 2020-05-01 15:25:29

It is displayed during the package summary at the end of the `./configure` run.


---

Comment by mkoeppe created at 2020-05-01 15:27:46

Replying to [comment:19 dimpase]:
> Replying to [comment:17 mkoeppe]:
> > I am using `sage -i PKG` in the message instead of `make PKG` because I'm not sure if we should advertise the latter.
> 
> I thought it's the plan to move to using `make` instead of `sage -i`

My plan is to fully support `./configure --enable-PKG`. But this feature is not ready for pip packages for the 9.1 release.

I don't know whose plan it was to make `make PKG` the advertised interface. There is no ticket that outlines this plan as far as I can see.


---

Comment by jhpalmieri created at 2020-05-01 17:12:07

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-05-01 17:12:07

We can leave it as is, but there is a significant difference between `sage -i PKG` and `make PKG`: the former installs the package (and its prereqs) and then builds all of Sage, while the second just installs the package (and its prereqs).


---

Comment by mkoeppe created at 2020-05-01 17:14:03

That's right. Which is part of why I don't want to advertise `make PKG` to Sage users. It's for advanced developer use, I would say.


---

Comment by mkoeppe created at 2020-05-01 17:17:06

Thanks for reviewing!


---

Comment by vbraun created at 2020-05-04 06:41:05

Resolution: fixed
