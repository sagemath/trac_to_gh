# Issue 29773: Split sage_setup.docbuild out to a separate package

Issue created by migration from https://trac.sagemath.org/ticket/30010

Original creator: mkoeppe

Original creation time: 2020-06-28 16:16:39

CC:  fbissey jhpalmieri isuruf @mwageringel schilly mmezzarobba

`sage_setup.docbuild` has very different dependencies:

It depends on `sagelib` and `sphinx`, 
whereas the rest of `sage_setup` is for building `sagelib`.

We split it out.


---

Comment by mkoeppe created at 2020-07-13 21:33:46

Last 10 new commits:


---

Comment by mkoeppe created at 2020-07-14 00:06:07

Changing status from new to needs_review.


---

Comment by git created at 2020-07-15 18:55:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-15 19:25:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-07-20 22:34:38

In the new `spkg-install` file, why

```
. sage-dist-helpers
```

Why do this at all, and if you're going to do it, why not use `source` instead of `.`, to be consistent with how `sage-spkg` does things?


---

Comment by git created at 2020-07-20 22:37:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-20 22:38:11

Thanks. This was a leftover from when I was using `sdh_pip_install`.


---

Comment by jhpalmieri created at 2020-07-21 00:03:52

Can you please add `sage_setup_docbuild` to `DOC_DEPENDENCIES` in `build/make/Makefile.in`?

Edit: No, sorry, it's already there. I just built Sage and it build `sage_setup_docbuild` at the end, after the documentation. I don't know why.


---

Comment by mkoeppe created at 2020-07-21 00:46:19

Hm... it's possible that it is always built because its dependency sagelib is always built...


---

Comment by git created at 2020-08-10 01:19:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-10 01:21:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-08 22:56:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-09-08 23:09:58

I wrote these comments before the most recent change, but I think they are still relevant:

I propose the following change:

```diff
diff --git a/build/pkgs/sage_setup_docbuild/dependencies b/build/pkgs/sage_setup_docbuild/dependencies
index 20f527f0f1..b21990c270 100644
--- a/build/pkgs/sage_setup_docbuild/dependencies
+++ b/build/pkgs/sage_setup_docbuild/dependencies
@@ -1 +1 @@
-$(PYTHON) sphinx six | $(PYTHON_TOOLCHAIN) sagelib
+$(PYTHON) sphinx | $(PYTHON_TOOLCHAIN) sagelib
diff --git a/build/pkgs/sage_setup_docbuild/src/requirements.txt b/build/pkgs/sage_setup_docbuild/src/requirements.txt
index 2dedc630e9..4e5dd84d0e 100644
--- a/build/pkgs/sage_setup_docbuild/src/requirements.txt
+++ b/build/pkgs/sage_setup_docbuild/src/requirements.txt
@@ -1,3 +1,2 @@
 #sage
 sphinx
-six
diff --git a/src/sage_setup/docbuild/ext/sage_autodoc.py b/src/sage_setup/docbuild/ext/sage_autodoc.py
index 032365d6bd..92d19b883e 100644
--- a/src/sage_setup/docbuild/ext/sage_autodoc.py
+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py
@@ -26,8 +26,6 @@ AUTHORS:
 - Kwankyu Lee (2018-12-26): rebase on the latest sphinx.ext.autodoc
 
 """
-from six import PY2, itervalues, text_type, class_types, string_types
-
 import inspect
 import re
 import sys
@@ -1176,27 +1174,19 @@ class ClassDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):
         if ret:
             module = getattr(self.object, '__module__', False)
             name = getattr(self.object, '__name__', False)
-            if PY2:
-                if name and module:
-                    cls = getattr(sys.modules[module], name, None)
-                    self.doc_as_attr = (self.objpath != name.split('.') and
-                                        self.object is cls)
-                else:
-                    self.doc_as_attr = True
+            qualname = getattr(self.object, '__qualname__', name)
+            if qualname and module:
+                # walk the standard attribute lookup path for this object
+                qualname_parts = qualname.split('.')
+                cls = getattr(sys.modules[module], qualname_parts[0], None)
+                for part in qualname_parts[1:]:
+                    if cls is None:
+                        break
+                    cls = getattr(cls, part, None)
+                self.doc_as_attr = (self.objpath != qualname_parts and
+                                    self.object is cls)
             else:
-                qualname = getattr(self.object, '__qualname__', name)
-                if qualname and module:
-                    # walk the standard attribute lookup path for this object
-                    qualname_parts = qualname.split('.')
-                    cls = getattr(sys.modules[module], qualname_parts[0], None)
-                    for part in qualname_parts[1:]:
-                        if cls is None:
-                            break
-                        cls = getattr(cls, part, None)
-                    self.doc_as_attr = (self.objpath != qualname_parts and
-                                        self.object is cls)
-                else:
-                    self.doc_as_attr = True
+                self.doc_as_attr = True
         return ret
 
     def format_args(self):

```


- Also, I don't understand the "tarball" aspects of this. There is no tarball, is there? So why have `spkg-src`?

- Is it built in `build/pkgs/sage_setup_docbuild/src/`? After building, I see new directories `build` and `sage_setup.docbuild.egg-info` there.

- The installation log file says `package init file 'sage_setup/__init__.py' not found (or not a regular file)`. I assume this is not a big issue, since everything worked after installation.


---

Comment by mkoeppe created at 2020-09-09 00:31:18

I agree with these changes; could you push them to the branch please?


---

Comment by mkoeppe created at 2020-09-09 00:37:07

Replying to [comment:23 jhpalmieri]:
> - Also, I don't understand the "tarball" aspects of this. There is no tarball, is there? So why have `spkg-src`?

The spkg-src script can build a tarball for the purpose of uploading a source distribution to PyPI.

> - Is it built in `build/pkgs/sage_setup_docbuild/src/`? After building, I see new directories `build` and `sage_setup.docbuild.egg-info` there.

That's right. 

I should probably add a `sage_setup_docbuild-clean` target that deletes them.

> - The installation log file says `package init file 'sage_setup/__init__.py' not found (or not a regular file)`. I assume this is not a big issue, since everything worked after installation.

This is not an error. `sage_setup` is now a native namespace package - these do not have `__init__.py` files.


---

Comment by jhpalmieri created at 2020-09-09 02:34:42

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-09-09 02:34:42

Adding a `sage_setup_docbuild-clean` would be nice, and/or an `spkg-postinst` script — can happen either here or on another ticket.
----
New commits:


---

Comment by mkoeppe created at 2020-09-09 03:51:13

Thank you. I think I'll be doing the cleaning via #29386.


---

Comment by vbraun created at 2020-09-27 18:00:25

I'm getting lots of 

```
sage -t --long --warn-long 44.0 --random-seed=0 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 38, in sage_setup.find.read_distribution
Failed example:
    from sage_setup.find import read_distribution
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.read_distribution[1]>", line 1, in <module>
        from sage_setup.find import read_distribution
    ModuleNotFoundError: No module named 'sage_setup.find'
**********************************************************************
```

Are incremental builds supported?


---

Comment by vbraun created at 2020-09-27 18:00:25

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-09-27 18:11:49

I'll revisit this ticket at the start of the 9.3 series


---

Comment by mkoeppe created at 2020-12-06 17:46:30

Changing keywords from "" to "sd111".


---

Comment by git created at 2021-02-21 19:22:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-21 19:31:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-21 19:33:48

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-02-21 19:47:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-02-23 19:02:11

Doctesting fails for me:

```
./sage -t -p --all --long --logfile=logs/ptestlong.log
Running doctests with ID 2021-02-23-09-29-26-45521505.
Git branch: t/30010/split_sage_setup_docbuild_out_to_a_separate_package
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting entire Sage library.
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/src/bin/sage-runtests", line 182, in <module>
    err = DC.run()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1206, in run
    self.expand_files_into_sources()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py", line 790, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py", line 790, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/sources.py", line 527, in __init__
    raise ValueError("unknown file extension %r"%ext)
ValueError: unknown file extension ''
make: *** [ptestlong] Error 1
```



---

Comment by jhpalmieri created at 2021-02-23 19:31:00

I think the problem is this:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 7d2b84b9c3..eafcf924de 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -697,6 +697,7 @@ class DocTestController(SageObject):
             # don't make sense to run outside a build environment
             if have_git:
                 self.files.append(opj(SAGE_SRC, 'sage_setup'))
+                self.files.append(opj(SAGE_SRC, 'sage_doctest'))
             self.files.append(SAGE_DOC_SRC)
 
         if self.options.all or (self.options.new and not have_git):
```

Should `sage_doctest` be `sage_docbuild` instead?


---

Comment by mkoeppe created at 2021-02-23 19:37:46

Yes, thanks for catching this! Please push it to the ticket


---

Comment by jhpalmieri created at 2021-02-23 21:10:38

The directory structure looks very strange: inside `SAGE_ROOT/build/pkgs/sage_docbuild/src/` I see


```
build
  lib
     build
        lib
           build
              lib
                 build
                    lib
                       sage_docbuild
                 sage_docbuild
           sage_docbuild
     sage_docbuild
```

where indentations indicate levels of subdirectories. For example, I see `SAGE_ROOT/build/pkgs/sage_docbuild/src/build/lib/build/lib/build/lib/build/lib/sage_docbuild`. All of the `sage_docbuild` directories look identical.
----
New commits:


---

Comment by mkoeppe created at 2021-02-23 21:19:48

Thanks for catching this! This commit should fix it
----
New commits:


---

Comment by jhpalmieri created at 2021-02-23 22:15:31

Perhaps for another ticket, but shouldn't `make distclean` clean up build artifacts like those subdirectories of `build/pkgs/PKG/src/`? To test the most recent change, I had to delete the extraneous stuff by hand, or alternatively start with a fresh tarball. Since I'm testing with various branches combined (to allow docbuilding to succeed on my Mac, for example), I would rather not use a fresh tarball in these situations.


---

Comment by mkoeppe created at 2021-02-23 23:29:10

Yes, a target `sage_docbuild-clean` is definitely missing, I'll add one.


---

Comment by mkoeppe created at 2021-02-23 23:31:52

Replying to [comment:50 jhpalmieri]:
> I would rather not use a fresh tarball in these situations.

What works really well for me is `git worktree` - easy to create a new "distclean" copy of the branch with this


---

Comment by jhpalmieri created at 2021-02-23 23:52:40

I get this at the start of doctesting:

```
    ModuleNotFoundError in doctesting framework
**********************************************************************
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2508, in __call__
    doctests, extras = self._run(runner, options, results)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2551, in _run
    doctests, extras = self.source.create_doctests(sage_namespace)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/sources.py", line 733, in create_doctests
    load(filename, namespace) # errors raised here will be caught in DocTestTask
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/repl/load.py", line 252, in load
    exec(code, globals)
  File "./clean.py", line 18, in <module>
ModuleNotFoundError: No module named 'sage_setup.find'
```

leading to

```
sage -t --long --random-seed=0 src/sage_setup/clean.py  # ModuleNotFoundError in doctesting framework
```

and then I get other doctest failures:

```
sage -t --long --random-seed=0 src/sage_setup/find.py  # 6 doctests failed
sage -t --long --random-seed=0 src/sage_setup/util.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage_setup/optional_extension.py  # 2 doctests failed
```

These all have a similar form:

```
**********************************************************************
File "src/sage_setup/find.py", line 38, in sage_setup.find.read_distribution
Failed example:
    from sage_setup.find import read_distribution
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.read_distribution[1]>", line 1, in <module>
        from sage_setup.find import read_distribution
    ModuleNotFoundError: No module named 'sage_setup.find'
**********************************************************************
File "src/sage_setup/find.py", line 92, in sage_setup.find.find_python_sources
Failed example:
    from sage_setup.find import find_python_sources
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.find_python_sources[1]>", line 1, in <module>
        from sage_setup.find import find_python_sources
    ModuleNotFoundError: No module named 'sage_setup.find'
```



---

Comment by git created at 2021-02-24 01:46:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-24 01:58:18

I don't know how to reproduce the `ModuleNotFoundError`... could you run `make sagelib-clean sagelib` and test again?


---

Comment by jhpalmieri created at 2021-02-24 05:01:44

Replying to [comment:55 mkoeppe]:
> I don't know how to reproduce the `ModuleNotFoundError`... could you run `make sagelib-clean sagelib` and test again?

I did that and got the same failures. This was with Sage's own Python and #18272. Then I switched to just this branch and used homebrew's Python and got the same errors.


---

Comment by git created at 2021-02-24 06:08:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-24 06:10:34

Thanks for testing - I've found the problem now. As a leftover from the previous version of the branch, `sage_setup` had lost its `__init__.py` file, causing an incomplete installation of it in `site-packages`


---

Comment by jhpalmieri created at 2021-02-24 18:21:58

Now the `ext` directory is missing from `build/pkgs/sage_docbuild/src/build/lib/sage_docbuild` and similarly for `local/lib/python3.9/site-packages/sage_docbuild`, so the documentation fails to build. It thinks it succeeds — no error — but the log file says things like

```
Building ja/a_tour_of_sage.

[a_tour_of] Extension error:
[a_tour_of] Could not import extension sage_docbuild.ext.inventory_builder (exception: No module named 'sage_docbuild.ext')
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/share/doc/sage/html/ja/a_tour_of_sage
```



---

Comment by git created at 2021-02-24 18:58:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-24 18:59:29

Sorry, thanks for your patience with this. I was using `find_namespace_packages` wrong, now I have just replaced it with an explicit list of packages.


---

Comment by jhpalmieri created at 2021-02-25 00:59:10

Can you explain the `dependencies` file? 

```
$(PYTHON) sphinx ../pkgs/sage_docbuild/src/sage_docbuild/*.py ../pkgs/sage_docbuild/src/sage_docbuild/ext/*.py | $(PYTHON_TOOLCHAIN) sagelib
```

I don't know what `.../*.py` is supposed to accomplish: how does `make` know what py files are supposed to be there or what to do with those targets?


---

Comment by mkoeppe created at 2021-02-25 01:33:51

These dependencies point to `$SAGE_SRC/docbuild` (going through the symbolic link at `$SAGE_ROOT/build/pkgs/sage_docbuild/src`). `make` expands the wildcard pattern to the source file names there. When they are newer than the timestamp file `$SAGE_LOCAL/var/lib/sage/installed/sage_docbuild-9.3.beta7`, this triggers a rebuild/reinstallation of the package `sage_docbuild`.


---

Comment by jhpalmieri created at 2021-02-25 04:16:15

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-02-25 04:16:15

Okay, thanks, that makes sense. This is working for me now, both building from scratch and upgrading from #31344.


---

Comment by mkoeppe created at 2021-02-25 04:39:29

Thank you!


---

Comment by vbraun created at 2021-03-09 00:00:35

Resolution: fixed
