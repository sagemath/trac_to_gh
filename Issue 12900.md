# Issue 12900: Implementation of PartitionTuple + some minor fixes to partition.py

Issue created by migration from https://trac.sagemath.org/ticket/13072

Original creator: andrew.mathas

Original creation time: 2012-06-01 06:35:03

Assignee: Andrew Mathas

CC:  sage-combinat

Keywords: tuples of partitions

This patch implements the following classes:
* PartitionTuple          - returns a tuple of partitions
* PartitionTuples         - factory class for all tuples of partitions
* PartitionTuples_level   - class of all tuples of partition of a fixed level
* PartitionTuples_n       - class of all tuples of partition of a fixed size 
* PartitionTuples_level_n - class of all tuples of partition of a fixed level and size. The first three of these are infinite enumerated classes whereas the last is finite. They all have iterators.

The idea is to implement a fully function class for PartitionTuples as I currently need this together with a class for tuples of (standard) tableaux (coming soon).

My initial intention was to consider Partitions() as PartitionTuples(), however, I found that this caused some minor issues because constructions like

```
     for component in mu: 
          do X
```

work differently for l-tuples of partitions when l=1 (partitions) and when l>1. If some one can see a nice way around this please let me know.

The patch currently fails some of the category tests called from TestSuite. I think that these failures are all caused by the fact the category is always set to 
`Category of elements of Tuple of Partitions`
whereas the tests expect it to be set to category of the subclasses. There ought to be a simple fix to this but I have found it yet. Improvements welcome!

In terms of implementation, for my use of these objects the `level` is more intrinsic than the size so I have set the syntax for the PartitionTuples classes as

```
PartitionTuples(level=l, n=n)
```

where `level` and `n` are both optional named arguments BUT level is specified first. Previously, `n` was given first and `level` second. I think that it makes much more sense this way around, but if people feel really strongly about this I will change it back. Previously, `level` was just called `k`, which is a fairly random variable whereas `level` makes sense in terms of categorification and higher level Fock spaces. (Replacing `n` with `size` would also be sensible but I didn't go there.)

Finally, in addition to these new classes I have removed a bunch functions which were depreciated years ago. I also added normal_nodes() and good_nodes methods to Partition_class and reinstated the beta_numbers() methods which were removed in the last patch to partition.py (this patch said that beta_numbers and frobenius_coordinates are identical objects, but they are actually different).


---

Comment by andrew.mathas created at 2012-07-06 16:00:45

Changing status from new to needs_review.


---

Comment by andrew.mathas created at 2012-07-31 00:08:04

Changing priority from minor to major.


---

Comment by andrew.mathas created at 2012-07-31 00:08:04

Should now apply cleanly to sage 5.2


---

Comment by andrew.mathas created at 2012-08-01 03:22:33

Apply trac_13072-tuples-of-partitions_am.patch


---

Comment by andrew.mathas created at 2012-08-03 10:34:50

New version of patch which creates a new file partition_tuple.py which contains all of the partition_tuple code.


---

Comment by andrew.mathas created at 2012-08-14 13:05:30

For the patchbot:

Apply  trac_13072-tuples-of-partitions_am.patch


---

Comment by andrew.mathas created at 2012-08-29 04:54:06

For the patchbot:

Apply trac_13072-tuples-of-partitions_am.patch


---

Comment by andrew.mathas created at 2012-08-29 12:27:43

The following timings show that there is a dramatic speed-up when number_of_partitions is cached:

**With caching**:

```
sage: %timeit [Partitions(n).random_element() for n in range(100)]
25 loops, best of 3: 25 ms per loop
sage: %timeit [Partitions(n).random_element() for n in range(100)]
25 loops, best of 3: 24.6 ms per loop
sage: %timeit [Partitions(n).random_element() for n in range(100)]
25 loops, best of 3: 25.4 ms per loop
```


**Without caching**:

```
sage: %timeit [Partitions(n).random_element() for n in range(100)]
5 loops, best of 3: 1.23 s per loop
sage: %timeit [Partitions(n).random_element() for n in range(100)]
5 loops, best of 3: 1.23 s per loop
sage: %timeit [Partitions(n).random_element() for n in range(100)]
5 loops, best of 3: 1.26 s per loop
```



---

Comment by jhpalmieri created at 2012-08-29 19:49:27

Regarding `RestrictedPartitions`: see #12278. Should it be deprecated at all? In particular, what's the replacement for something like `RestrictedPartitions(5,[3,2,1], 3)`? The best I can come up with is

```
[p for p in Partitions(5, parts_in=[3,2,1]) if len(p) == 3]
```

but surely this isn't ideal.


---

Comment by andrew.mathas created at 2012-08-31 05:26:58

For the patchbot:

Apply trac_13072-tuples-of-partitions_am.patch


---

Comment by andrew.mathas created at 2012-10-08 03:34:55

For the patchbot:

Apply trac_13072-tuples-of-partitions_am.patch


---

Comment by andrew.mathas created at 2012-10-08 12:08:39

Replying to [comment:16 jhpalmieri]:
> Regarding `RestrictedPartitions`: see #12278. Should it be deprecated at all? In particular, what's the replacement for something like `RestrictedPartitions(5,[3,2,1], 3)`? The best I can come up with is
> {{{
> [p for p in Partitions(5, parts_in=[3,2,1]) if len(p) == 3]
> }}}
> but surely this isn't ideal.
This was discussed in detail on sage-combinat, eventually leading to point #5 in the blurb for this ticket.


---

Comment by tscrim created at 2012-10-08 21:55:45

Looks good. I've added #11446 as a dependency since this is based respect to #11446 and it's dependency #11442 (both slightly modify `partition.py` as well).


---

Comment by tscrim created at 2012-10-08 21:55:45

Changing status from needs_review to positive_review.


---

Comment by hivert created at 2012-10-08 22:30:47

Changing status from positive_review to needs_work.


---

Comment by hivert created at 2012-10-08 22:30:47

Hi Andrew and Travis,

Thanks both for your work. I'm hate to switch back to needs works but looking at the compiled doc, I see various small problems which should be fixed. Here are some of them:

- Don't indent bulleted list. It adds an extra uneeded indentation (see e.g. REFERENCE vs AUTHORS in the module class;

- There is a proper markup for references (see developper guide);

- In the doc of the class `PartitionTuple`, there is a miss indentation between `INPUT` and `EXAMPLES:`

- in the doc of `Garnir_tableau` please write ```self``` ```cell```, ```FALSE``` ... (verbatim set-up) but don't forget single back-quote for ``(k,a+1,c)`` (latex set-up) and similar. The hyperlink in SEE ALSO are missing

- There is a proper markup for linking to trac ticket eg: `:trac:`13123``

- There is a typo in "The Garnir tableau are the “first” non-standard tableaux which arise when you at by simple transpositions."

Sorry for being picky for the doc. If it wasn't so late et France, I would have written a review patch. 

For Travis: please check the compiled doc when your are reviewing a patch. You can refer to `http://wiki.sagemath.org/ReviewChecklist`.

Cheers,

Florent


---

Comment by andrew.mathas created at 2012-10-08 22:51:01

Hi Florent,

Thanks for the specific comments about what needs to be fixed. I'll go through and fix these.

> For Travis: please check the compiled doc when your are reviewing a patch. You can refer to `http://wiki.sagemath.org/ReviewChecklist`.

Actually, Travis has already spent a large amount of time fixing my doc strings, so there would be many more problems without the large amount of time that he has already spent on this.

Andrew


---

Comment by andrew.mathas created at 2012-10-08 23:33:02

Hi Florent,

I think that the revised patch fixes all of the problems that you highlighted -- well, except for the Garnir tableaux issues which are in #13074.

Cheers,
Andrew


---

Comment by hivert created at 2012-10-09 05:50:55

Hi Andrew,

Replying to [comment:27 andrew.mathas]:
> Actually, Travis has already spent a large amount of time fixing my doc strings, so there would be many more problems without the large amount of time that he has already spent on this.

Sorry, I you feel I'm being rude. It wasn't my intend. However, I've no chance to know that since there is no record of his work on this ticket. Even when the review is done offline, it is good to keep a (not necessarily detailed) trace of what has been done on the ticket, if only to give proper credit.

Cheers,

Florent

PS: Unfortunately, I've no time to answer your comment on #13074, right now (run to catch a train + teaching).


---

Comment by andrew.mathas created at 2012-10-09 08:02:54

Hi Florent,

No, no, that's OK. I just wanted to acknowledge that Travis has done a lot of work on the documentation and that any errors that remained were mine and mine alone. I appreciate your looking at the patch and trying to improve it. 

I have mostly sorted out the doc string problems in these two patches but there are till one or two that remain. If there is any trick to working out where the errors appear in the code from the rest errors messages please let me know when you have the time as currently I am doing pseudo random searches.

Thanks again,
Andrew


---

Comment by andrew.mathas created at 2012-10-09 13:18:28

I think that all of the doc string issues really are fixed now.


---

Comment by tscrim created at 2012-10-09 15:34:51

Florent,

Thank you for catching these docstring problems. I appreciate you begin picky about the docs. I didn't know about the indentation of the bullet lists, and I did miss that indentation of EXAMPLES:: block in the compiled doc.

Andrew,

A few more minor issues.
- I believe this line (line 263 in `partition_tuple.py`) has a comma misplaced:

```
When these algebras are not semisimple partition, tuples index...
```

- In `partition_tuple.hook_length()` it should be `coordinates of the form `(k,r,c)``
- In `partition.random_element()`, the inputs `uniform` and `Plancherel` should be indented one more since they are the types of inputs for `measure`.


---

Comment by andrew.mathas created at 2012-10-10 03:23:41

Hi Travis,

I have uploaded a new version of the patch which fixes the errant comma and the indentation in random_element but I think that the ```(k,r,c)``` in the hook_length function is correct because k,r and c are arguments to this function. Of course, it would be more correct to write `(``k``,``r``,``c``)` but ReST complains about this. I guess that `(``k``, ``r``, ``c``)` might be OK, although I suspect that it will want a few more spaces like `( ``k`` , ``r`` , ``c`` )` to be legal syntax. I prefer using ```(k,r,c)``` as these three integers together comprise a cell which is really a "single" variable... Let me know if you disagree.

Cheers,
Andrew


---

Comment by tscrim created at 2012-10-10 15:15:03

Hey Andrew,

Yes, it should be ```(k,r,c)``` but right now it is ```(r,c)```. Although on further thought, it might be better to move the note about 0-based (and adding ```k```) and the python *-operator to the header. That way it covers all of the similar functions.

Thanks,
Travis


---

Comment by andrew.mathas created at 2012-10-12 03:45:06

Thanks Travis, you are right of course. I've updated the patch.

Andrew

--

For the patchbot:

Apply trac_13072-tuples-of-partitions_am.patch


---

Comment by tscrim created at 2012-10-12 04:00:59

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2012-10-12 04:00:59

Thanks Andrew! Looks good. I like the notes.


---

Comment by jdemeyer created at 2012-10-13 21:37:18

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-10-13 21:37:18


```
sage -t  -force_lib devel/sage/sage/structure/sage_object.pyx
**********************************************************************
File "/release/merger/sage-5.5.beta0/devel/sage-main/sage/structure/sage_object.pyx", line 1114:
    sage: sage.structure.sage_object.unpickle_all()  # (4s on sage.math, 2011)
Expected:
    doctest:... DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    See http://trac.sagemath.org/4260 for details.
    Successfully unpickled ... objects.
    Failed to unpickle 0 objects.
Got:
     * unpickle failure: load('/release/merger/sage-5.5.beta0/home/.sage/tmp/sage.math.washington.edu/5737/dir_i3wI40//pickle_jar/_class__sage_combinat_partition_PartitionTuples_nk__.sobj')
    doctest:1172: DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    See http://trac.sagemath.org/4260 for details.
    Failed:
    _class__sage_combinat_partition_PartitionTuples_nk__.sobj
    Successfully unpickled 593 objects.
    Failed to unpickle 1 objects.
**********************************************************************
```



---

Comment by jdemeyer created at 2012-10-13 21:38:00


```
sage -t  --long -force_lib devel/sage/sage/combinat/partition.py
**********************************************************************
File "/release/merger/sage-5.5.beta0/devel/sage-main/sage/combinat/partition.py", line 434:
    sage: all(test2(core,tuple(mus))  # long time (5s on sage.math, 2011)
          for k in range(Integer(1),Integer(10))
          for n_core in range(Integer(10)-k)
          for core in Partitions(n_core)
          if core.core(k) == core
          for n_mus in range(Integer(10)-k)
          for mus in PartitionTuples(n_mus,k))
Exception raised:
    Traceback (most recent call last):
      File "/release/merger/sage-5.5.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/release/merger/sage-5.5.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/release/merger/sage-5.5.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_5[6]>", line 2, in <module>
        for k in range(Integer(1),Integer(10))
      File "<doctest __main__.example_5[6]>", line 7, in <genexpr>
        for mus in PartitionTuples(n_mus,k))
      File "classcall_metaclass.pyx", line 279, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclas
s.c:946)
      File "/release/merger/sage-5.5.beta0/local/lib/python/site-packages/sage/combinat/partition_tuple.py", line 1059, in __classcall_pri
vate__
        raise ValueError, 'the level must be a positive integer'
    ValueError: the level must be a positive integer
**********************************************************************
```



---

Comment by andrew.mathas created at 2012-10-14 13:44:15

Hi Jeroen,

Perhaps I am confused, but most of these pickles shouldn't exist any more as they should have been removed by the new pickle jar attached to #9265. Specifically, the pickles

  _class!__   sage_combinat_skew_tableau_SemistandardSkewTableaux_n!__   .sobj')
   _class!__   sage_combinat_skew_tableau_SemistandardSkewTableaux_nmu!__   .sobj')
   _class!__   sage_combinat_skew_tableau_SemistandardSkewTableaux_p!__   .sobj')
   _class!__   sage_combinat_skew_tableau_SemistandardSkewTableaux_pmu!__   .sobj')
   _class!__   sage_combinat_skew_tableau_StandardSkewTableaux_n!__   .sobj')
   _class!__   sage_combinat_tableau_SemistandardTableaux_n!__   .sobj')
   _class!__   sage_combinat_tableau_SemistandardTableaux_nmu!__   .sobj')
   _class!__   sage_combinat_tableau_SemistandardTableaux_p!__   .sobj')
   _class!__   sage_combinat_tableau_SemistandardTableaux_pmu!__   .sobj')
   _class!__   sage_combinat_tableau_StandardTableaux_n!__   .sobj')
   _class!__   sage_combinat_tableau_StandardTableaux_partition!__   .sobj')
   _class!__   sage_combinat_tableau_Tableau_class!__   .sobj')
   _class!__   sage_combinat_tableau_Tableaux_n!__   .sobj')

shouldn't be there having been replaced with new improved pickles with slightly more informative names (for example, _n_ -->  _size_, _p_ --> _shape_ etc.).  The pickle

  _class!__  sage_combinat_partition_PartitionTuples_nk!__  .sobj

I agree is mine to fix but I am also not entirely convinced that the first three pickles are caused by this patch, that is the following pickles:

  class!__  sage_combinat_crystals_affine_AffineCrystalFromClassicalAndPromotion_with_category_element_class!__  .sobj')
  class!__  sage_combinat_crystals_tensor_product_CrystalOfTableaux_with_category_element_class!__  .sobj')
  class!__  sage_combinat_crystals_tensor_product_TensorProductOfCrystalsWithGenerators_with_category!__  .sobj')

as I think that I might have also created new pickles for these in #9265. I am, of course, happy to rebuild them just in case.

Can you please confirm that the pickle_jar was updated as per the attachment for #9265. The mistake is quite probably mine as I assumed that the whole pickle jar would be replaced whereas if you just added in the new pickles then you would not have been aware that some of the old pickles needed to be deleted (although presumably it would not have been possible to unpickle them...??). If there is any documentation on updating the pickle jar please let me know.

Please advise.

Cheers,

Andrew



---

Comment by jdemeyer created at 2012-10-15 08:03:29

Replying to [comment:41 andrew.mathas]:
> Can you please confirm that the pickle_jar was updated as per the attachment for #9265.
Yes, certainly it was updated.


---

Comment by jdemeyer created at 2012-10-15 08:05:21

I don't quite understand what you're saying, since my failed test is only complaining about *one pickle*, namely

```
_class__sage_combinat_partition_PartitionTuples_nk__.sobj
```



---

Comment by andrew.mathas created at 2012-10-15 09:08:19

Sorry, my mistake: I was testing on 5.3.

A.


---

Comment by andrew.mathas created at 2012-10-15 13:29:53

OK, I have fixed the long-test problem. With the pickle it seems to me that the only way to fix the problem is to replace the bad


```
PartitionTuples_nk
```

pickle in the pickle jar with a good one (and leave the other pickles untouched) as the underlying class has changed too much (vbraun posted a comment on #9265 suggesting that I should use `register_unpickle_override instead but I tried experimenting with this and it doesn't seem to work).`


Jeroen can you please confirm that you are are happy for me to do this.




---

Comment by jdemeyer created at 2012-10-15 13:40:52

Replying to [comment:45 andrew.mathas]:
> Jeroen can you please confirm that you are are happy for me to do this.
Given the comments of Volker Braun and Simon King, I cannot be happy with this.  No objects should be removed from the pickle jar.


---

Comment by nthiery created at 2012-10-15 13:53:15

Replying to [comment:46 jdemeyer]:
> Replying to [comment:45 andrew.mathas]:
> > Jeroen can you please confirm that you are are happy for me to do this.
> Given the comments of Volker Braun and Simon King, I cannot be happy with this.  No objects should be removed from the pickle jar.

Just my 2 cents: at this point, partition tuples are a rather peripheral feature. If anyone has saved some pickle containing one, most likely he is in the Sage-Combinat group. Well most likely it's Andrew actually. So I vote for not wasting Andrew's time and simply dropping backward compatibility in that particular situation. I am not taking much risk by volunteering to help whoever might have trouble with such an old pickle :-)

Of course, the official procedure would be to run a poll; if you insist, we can do that on Sage-Combinat devel.


---

Comment by jdemeyer created at 2012-10-15 14:47:03

Nicolas, I started a thread on sage-devel about the pickle jar.


---

Comment by andrew.mathas created at 2012-10-17 12:21:28

Unpickling works now.


---

Comment by andrew.mathas created at 2012-10-17 12:21:28

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2012-10-19 22:30:06

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2012-10-19 22:30:06

Everything looks good to me (double checked the pickle jar and `sage_object.pyx`).


---

Comment by jdemeyer created at 2012-11-01 10:19:27

Removing all whitespace everywhere is a bad idea, don't do it as it will lead to merge conflicts (unless it was approved by the sage-combinat group, then I take back my words).


---

Comment by jdemeyer created at 2012-11-01 10:19:27

Changing status from positive_review to needs_work.


---

Comment by andrew.mathas created at 2012-11-01 11:35:02

Replying to [comment:51 jdemeyer]:
> Removing all whitespace everywhere is a bad idea, don't do it as it will lead to merge conflicts (unless it was approved by the sage-combinat group, then I take back my words).

Jeroen, I removed whitespaces added by the patch and then checked that the sage-combiat queue applied cleanly before pushing the patch both to the sage-combinat queue and back to trac. I did not remove all white space from the source files affected by this patch as, I agree, this would probably cause havoc with the queue. As all of the patches in the sage-combinat queue still apply cleanly I am putting this back to a positive review.


---

Comment by andrew.mathas created at 2012-11-01 11:35:21

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2012-11-01 12:04:22

Resolution: fixed


---

Comment by jdemeyer created at 2012-11-01 12:08:58

The new patch needs a proper commit message.


---

Comment by andrew.mathas created at 2012-11-01 12:28:10

Adding proper commit message
