# Issue 12507: rewrite Matrix_modn_sparse and vector_modn_sparse code so that the modulus is 64-bit on 64-bit platforms

Issue created by migration from https://trac.sagemath.org/ticket/12679

Original creator: was

Original creation time: 2012-03-16 18:21:34

Assignee: jason, was

CC:  bouillaguet cpernet embray vdelecroix

Right now the matrix modn sparse class uses ints to store entries.    The basic reason is the code

```
cdef struct c_vector_modint:
    int *entries
```

in sage/modules/vector_modn_sparse_h.pxi.  This should probably instead use the unsigned C99 type uint_fast64_t. 


---

Comment by vbraun created at 2013-05-22 18:58:02

As discussed in #14627, this should really be signed `int_fast64_t`. Then it fits into a PyInt on all sensible (i.e. excluding Win64) platforms.


---

Comment by chapoton created at 2019-09-25 13:02:46

tentative
----
New commits:


---

Comment by chapoton created at 2019-09-25 13:02:46

Changing status from new to needs_info.


---

Comment by chapoton created at 2019-09-25 18:02:19

Is this a good idea or not ?


---

Comment by chapoton created at 2019-09-25 18:02:19

Changing status from needs_info to needs_review.


---

Comment by cpernet created at 2019-09-30 14:04:29

I strongly support using ints with a specified size when they will be used for arithmetic. I am not familar with the Win64 support problem so I can not tell for this aspect, but otherwise, this seems like a very good move.


---

Comment by chapoton created at 2019-09-30 17:59:34

Thanks. And the patchbot is green.

So we should ask Erik what happens on Windows. Erik ?


---

Comment by chapoton created at 2019-11-21 15:17:17

Erik or anybody else ? review, opinion, please ?


---

Comment by chapoton created at 2019-11-29 13:27:10

Do someone have any comments ? Could somebody please test on Windows ?


---

Comment by tscrim created at 2019-12-09 02:44:10

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-12-09 02:44:10

LGTM.


---

Comment by embray created at 2019-12-09 10:51:37

I do need to get the Cygwin patchbot working again.  I was running one for a time but it went down, and I never got it running again.  Samuel also had one running for a time but he's out of town and I don't know what happened to it.  Maybe I'll work on that today.

Nevertheless I don't see any special reason to test this on Windows.  int_fast_64_t is part of the C99 standard and will resolve to the appropriate type on the target platform.


---

Comment by embray created at 2019-12-09 11:01:07

Replying to [comment:1 vbraun]:
> As discussed in #14627, this should really be signed `int_fast64_t`. Then it fits into a PyInt on all sensible (i.e. excluding Win64) platforms.
>

I see, you were worrying about this comment.  But it's not an issue.  I think the concern here was that on native Windows compilers `sizeof(long) == 4` (and the Python 2 `PyIntObject` uses a `long` to store its value).  But [on Cygwin](https://cygwin.com/cygwin-ug-net/programming.html#gcc-64) `sizeof(long) == 8` so this is not a problem, as we don't support Sage on native Windows anyways.

Plus it's only an issue for Python 2.  In the Python 3 `PyLongObject` which is used for all `int`s, it uses (by default, on any modern 64-bit system) exact bit size types.


---

Comment by vbraun created at 2019-12-11 21:46:31

Resolution: fixed
