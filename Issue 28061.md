# Issue 28061: py3: final polishing of the last failing doctests

Issue created by migration from https://trac.sagemath.org/ticket/28298

Original creator: chapoton

Original creation time: 2019-07-31 07:56:10

CC:  vklein embray jmantysalo @timokau jhpalmieri dcoudert etn40ff arojas

After #26212, there remains only a few failing doctests (not using any optional package).

Those that are not yet handled are:

- on some machines:

```
 'src/sage/libs/singular/function.pyx  # 1 doctest failed',
 'src/sage/libs/eclib/interface.py # 1 (line 597)',
 'src/sage/numerical/backends/generic_backend.pyx  # 2 doctests failed',
 'src/sage/repl/attach.py  # 4 doctests failed',
 'src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 1 doctest failed',
  'src/sage/rings/polynomial/polynomial_rational_flint.pyx',
```


- on all machines:

```
 'src/sage/combinat/root_system/non_symmetric_macdonald_polynomials.py  # 1 doctest failed',
 'src/sage/combinat/root_system/weyl_group.py  # 7 doctests failed', #27967
 'src/sage/symbolic/expression.pyx  # 1 doctest failed', #28219
 'src/sage/tests/books/computational-mathematics-with-sagemath/graphtheory_doctest.py  # 1 doctest failed',
 'src/sage/tests/books/computational-mathematics-with-sagemath/sol/graphtheory_doctest.py  # 1 doctest failed',
```



---

Comment by jhpalmieri created at 2019-08-01 02:45:04

Are all of the failures "on some machines" actually on the same machine? Can these be reproduced by anyone else?


---

Comment by chapoton created at 2019-08-01 06:30:33

the flint one has been reported by several people on sage-release


---

Comment by jhpalmieri created at 2019-08-01 22:52:56

The flint one is strange, since flint doesn't depend on Python. So either the error occurs also in Python 2, or there is something strange going on with the flint interface.


---

Comment by @mwageringel created at 2019-08-04 15:30:21

Maybe this is a stupid question, but are we sure that the errors that are unique to the patchbot are machine-specific (i.e. reproducible on that machine) or is there a chance this could be fixed by doing a clean install?


---

Comment by chapoton created at 2019-08-04 15:35:28

I have just "make distclean" that precise patchbot machine. It is currently running, and we will see the results in 2 hours. This machine has a fairly stable configuration, and the remaining failing doctests have been there since many releases.

Some of these errors pass when each file is doctested alone. Some look like a mis-synchronized (pexpect ?) interface.

Of course, we will have to make the decision when we claim "all doctests pass", in spite of the remaining quantum noise..


---

Comment by chapoton created at 2019-08-05 06:48:25

Please add your machine results in the table, to help understand the remaining errors.


---

Comment by jhpalmieri created at 2019-08-05 16:43:52

I have access to three different OS X Mojave machines: an iMac Pro, an iMac, and a MacBook Air, and I see the same failures on all three. I've updated the table correspondingly.


---

Comment by @mwageringel created at 2019-08-05 21:58:02

Same results on two CentOS machines.


---

Comment by jhpalmieri created at 2019-08-06 20:27:14

Frédéric, if you have a machine with the flint problem, can you try to track it down? Eric G thought it dated back at least to 8.8.rc3, but I don't see that in his report on sage-release. Emmanuel first reported it for 8.9.beta2 and provided a report for 8.9.beta1 without this failure, so maybe it happened between 8.9.beta1 and 8.9.beta2.

Can you use `git bisect` to try to locate the problem? Could it have been #28048? (I don't see why, but I'm looking at the tickets merged in 8.9.beta2, trying to see what could possibly be related. Could accents in `SAGE_LOCAL` be causing this?)


---

Comment by egourgoulhon created at 2019-08-06 20:42:08

Replying to [comment:17 chapoton]:
> Please add your machine results in the table, to help understand the remaining errors.

For my laptop (Ubuntu 18.04.2, Core i7-6700HQ, 16 GB RAM), the results are identical to those marked as "laptop ch".


---

Comment by klee created at 2019-08-06 22:18:58

I guess the OS of the machine is important to understand the failures. Then  what OS are the reference patchbot and "laptop ch"?


---

Comment by jhpalmieri created at 2019-08-07 23:27:20

Replying to [comment:21 jhpalmieri]:
> Frédéric, if you have a machine with the flint problem, can you try to track it down? Eric G thought it dated back at least to 8.8.rc3, but I don't see that in his report on sage-release. Emmanuel first reported it for 8.9.beta2 and provided a report for 8.9.beta1 without this failure, so maybe it happened between 8.9.beta1 and 8.9.beta2.

Oh, I see, the relevant folder wasn't in `python3-known-passing-test.txt` until 8.9.beta2, so it may have been failing for some time before that.


---

Comment by egourgoulhon created at 2019-08-08 07:18:57

Replying to [comment:24 jhpalmieri]:
> Replying to [comment:21 jhpalmieri]:
> > Frédéric, if you have a machine with the flint problem, can you try to track it down? Eric G thought it dated back at least to 8.8.rc3, but I don't see that in his report on sage-release. Emmanuel first reported it for 8.9.beta2 and provided a report for 8.9.beta1 without this failure, so maybe it happened between 8.9.beta1 and 8.9.beta2.
> 
> Oh, I see, the relevant folder wasn't in `python3-known-passing-test.txt` until 8.9.beta2, so it may have been failing for some time before that.

Yes I confirm. I've still a working version of Python3 8.8.rc3 (on Ubuntu 18.04) and the flint issue is already there.


---

Comment by jhpalmieri created at 2019-08-08 17:01:43

I don't have any solutions, but let's track the flint problem at #28334.


---

Comment by jhpalmieri created at 2019-08-26 02:50:41

I expect (K) to fail on all machines due to the nature of the problem, but I've only tested on OS X.


---

Comment by chapoton created at 2019-08-29 13:08:50

Got a patchbot report from another machine, with similar results as for the reference machine:

```
https://patchbot.sagemath.org/log/0/Ubuntu/18.04/x86_64/4.15.0-54-generic/petitbonum/2019-08-29%2012:45:45?short
```

namely

```
sage -t --long src/sage/symbolic/expression.pyx  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/weyl_group.py  # 7 doctests failed
sage -t --long src/sage/rings/polynomial/polynomial_rational_flint.pyx  # 1 doctest failed
sage -t --long src/sage/libs/eclib/interface.py  # 1 doctest failed
sage -t --long src/sage/crypto/block_cipher/present.py  # 2 doctests failed
sage -t --long src/sage/repl/attach.py  # 4 doctests failed
sage -t --long src/sage/libs/singular/function.pyx  # 1 doctest failed
sage -t --long src/sage/numerical/backends/generic_backend.pyx  # 2 doctests failed
```



---

Comment by chapoton created at 2019-09-03 09:40:55

one fixed in 8.9.b9


---

Comment by chapoton created at 2019-09-03 09:42:13

rather two, in fact


---

Comment by charpent created at 2019-09-03 20:23:34

At this point, it begins to be useful to widen the scope of our checks. I proceeded to ` make ptestalllong` on two different machines (but very close), with a few optional packages, both running 8.9.beta9.

//Please let me know if this isn't the right place to post this kind of reports...//

TL;DR:
* ` make ptestalllong` gives failures on 22 packages total (20 on one machine, 19 on the other);
* Most of these failure cannot be reproduced when running the test standalone (whether `MAKE` is defined or not). Three file persist to fail when ran standalone:
    - src/sage/combinat/root_system/weyl_group.py (known)
    - src/sage/libs/eclib/interface.py (also known)
    - src/sage/tests/gap_packages.py (not known but optional package, fails only on one of my machines).

I have no explanation for the intermachines differences; one is a Debian testing desktop (core i7, 8 GB RAM), the other is a Debian testing laptop (core i7, 16 GB RAM).

The large number of transient failures let me think that some parts of the libraries are not as reentrant as we might wish them to be...

Details of failing files:

```
```

| Test file                                               | Laptop | Desktop | Standalone |
|---------------------------------------------------------+--------+---------+------------|
| src/sage/graphs/generators/smallgraphs.py               | Y      | N       | N          |
| src/sage/combinat/posets/posets.py                      | Y      | Y       | N          |
| src/sage/combinat/root_system/weyl_group.py             | Y      | Y       | Y          |
| src/sage/plot/animate.py                                | Y      | Y       | N          |
| src/sage/doctest/forker.py                              | Y      | N       | N          |
| src/sage/libs/eclib/interface.py                        | Y      | Y       | Y          |
| src/sage/combinat/matrices/hadamard_matrix.py           | Y      | Y       | N          |
| src/sage/rings/polynomial/polynomial_rational_flint.pyx | Y      | Y       | N          |
| src/sage/symbolic/integration/external.py               | Y      | Y       | N          |
| src/sage/misc/latex.py                                  | Y      | Y       | N          |
| src/sage/coding/databases.py                            | Y      | Y       | N          |
| src/sage/misc/persist.pyx                               | Y      | Y       | N          |
| src/sage/databases/oeis.py                              | Y      | Y       | N          |
| src/sage/tests/gap_packages.py                          | Y      | N       | Y          |
| src/sage/repl/load.py                                   | Y      | Y       | N          |
| src/sage/graphs/graph_latex.py                          | Y      | Y       | N          |
| src/sage/combinat/designs/ext_rep.py                    | Y      | N       | N          |
| src/sage/misc/remote_file.py                            | Y      | Y       | N          |
| src/sage/databases/findstat.py                          | Y      | Y       | N          |
| src/sage/interfaces/magma_free.py                       | N      | Y       | N          |
| src/sage/interfaces/mathematica.py                      | N      | Y       | N          |
Details on the failures on request (including the full logs...).
 HTH,


---

Comment by egourgoulhon created at 2019-09-04 14:29:16

Description modified according to the report https://groups.google.com/d/msg/sage-release/M1JjXhXfsU4/TuPETvGUAgAJ


---

Comment by egourgoulhon created at 2019-09-04 14:43:50

Replying to [comment:38 egourgoulhon]:
> Description modified according to the report https://groups.google.com/d/msg/sage-release/M1JjXhXfsU4/TuPETvGUAgAJ

See however #28334#comment:11 for a possible further update of the summary table.


---

Comment by jhpalmieri created at 2019-09-04 21:59:59

I may have accidentally found a fix for the `eclib/interface.py` problem. See #28454. Needs testing and, more importantly, some understanding of whether this is a valid fix.


---

Comment by jhpalmieri created at 2019-10-03 18:19:29

Regarding (H), (I), (J): I don't see them ordinarily on OS X, even when running `make ptestlong`, but I do see them on my OS X patchbot. Is there something different about patchbots which could lead to these failures?


---

Comment by jhpalmieri created at 2019-10-17 17:14:14

Replying to [comment:48 jhpalmieri]:
> Regarding (H), (I), (J): I don't see them ordinarily on OS X, even when running `make ptestlong`, but I do see them on my OS X patchbot. Is there something different about patchbots which could lead to these failures?

I really think this is the case. I've opened #28622 for this, not that I have any ideas how to fix it.


---

Comment by jhpalmieri created at 2019-10-17 18:35:26

These failures seem to also occur outside of the patchbot, but they are very repeatable when using the patchbot, as described at #28622, so I hope if we can fix the patchbot problems, it will either fix them outside of the patchbot or at least give us some clues.


---

Comment by jhpalmieri created at 2019-10-24 04:14:11

I still don't know if anyone else has seen (K) or (L). (F) maybe hasn't been seen for a long time. Things are looking good!


---

Comment by @timokau created at 2019-10-24 16:50:16

If all remaining failures are transient, maybe its time to switch the betas over to py3 and do some more extensive testing?


---

Comment by @mwageringel created at 2019-10-24 17:11:17

Replying to [comment:53 jhpalmieri]:
> I still don't know if anyone else has seen (K) or (L).

I can reproduce (K) on macOS reliably, but have not seen (L).


---

Comment by jhpalmieri created at 2019-11-13 18:12:10

I haven't seen (L) in a while. I haven't heard any other reports of it, either. So I would put a very low priority on it.


---

Comment by klee created at 2019-12-02 07:36:57

I propose to clear up (F), (K), and (L) here. They are all intermittent failures with obscure causes, and do not seem likely to get any solution in the near future, and just blocking sage on python 3. They can change to regular tickets. Any one object?


---

Comment by chapoton created at 2019-12-02 08:07:08

These are not blocking anything. The switch to python3 is happening.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by chapoton created at 2020-01-01 11:15:50

Resolution: worksforme
