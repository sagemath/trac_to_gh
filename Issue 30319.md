# Issue 30319: Build Python's ssl module

archive/issues_030319.json:
```json
{
    "body": "CC:  @mwageringel @mkoeppe @slel @williamstein @dimpase\n\nKeywords: openssl, python\n\nWhen building Python 3.8.5, Sage does not build its\nssl module even if OpenSSL is available system-wide.\n\nThis differs from what happened with Python 3.7.\n\nReported on sage-release:\n\n- [initial report on sage-release](https://groups.google.com/d/msg/sage-release/hobZzw74Rv0/pkiQFTg9AQAJ)\n\nIssue created by migration from https://trac.sagemath.org/ticket/30556\n\n",
    "created_at": "2020-09-11T18:11:02Z",
    "labels": [
        "component: packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Build Python's ssl module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30319",
    "user": "https://github.com/slel"
}
```
CC:  @mwageringel @mkoeppe @slel @williamstein @dimpase

Keywords: openssl, python

When building Python 3.8.5, Sage does not build its
ssl module even if OpenSSL is available system-wide.

This differs from what happened with Python 3.7.

Reported on sage-release:

- [initial report on sage-release](https://groups.google.com/d/msg/sage-release/hobZzw74Rv0/pkiQFTg9AQAJ)

Issue created by migration from https://trac.sagemath.org/ticket/30556





---

archive/issue_comments_431984.json:
```json
{
    "body": "Many builds of the python3 spkg without its `_ssl` module\nlikely result from an oversight.\n\nCould there be a `configure` flag to explicitly require\nbuilding python3 without its `_ssl` module?\n\nWithout that flag, consider openssl a dependency of python3,\nand let the build fail if it's not there.",
    "created_at": "2020-09-11T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431984",
    "user": "https://github.com/slel"
}
```

Many builds of the python3 spkg without its `_ssl` module
likely result from an oversight.

Could there be a `configure` flag to explicitly require
building python3 without its `_ssl` module?

Without that flag, consider openssl a dependency of python3,
and let the build fail if it's not there.



---

archive/issue_comments_431985.json:
```json
{
    "body": "Even when configuring with `--enable-openssl`,\nI think `openssl` may be built after `python3`.\n\nSo currently one really has to separate into two steps:\n\n```\n$ make openssl\n$ make\n```\n\n\nor later have to repair with\n\n```\n$ sage -i openssl\n$ sage -f python3\n```\n",
    "created_at": "2020-09-11T19:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431985",
    "user": "https://github.com/slel"
}
```

Even when configuring with `--enable-openssl`,
I think `openssl` may be built after `python3`.

So currently one really has to separate into two steps:

```
$ make openssl
$ make
```


or later have to repair with

```
$ sage -i openssl
$ sage -f python3
```




---

archive/issue_comments_431986.json:
```json
{
    "body": "Replying to [comment:4 slelievre]:\n> Even when configuring with `--enable-openssl`,\n> I think `openssl` may be built after `python3`.\n\nYes, this is a problem. We do not have a mechanism to order \"optional dependencies\".",
    "created_at": "2020-09-11T19:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431986",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:4 slelievre]:
> Even when configuring with `--enable-openssl`,
> I think `openssl` may be built after `python3`.

Yes, this is a problem. We do not have a mechanism to order "optional dependencies".



---

archive/issue_comments_431987.json:
```json
{
    "body": "See #21700 - Packages with \"optional\" dependencies (a package manager's suggested/recommended packages)",
    "created_at": "2020-09-11T19:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431987",
    "user": "https://github.com/mkoeppe"
}
```

See #21700 - Packages with "optional" dependencies (a package manager's suggested/recommended packages)



---

archive/issue_comments_431988.json:
```json
{
    "body": "We could add `openssl` to TOOLCHAIN_DEPS as a workaround. Then it would be built at the very beginning.",
    "created_at": "2020-09-11T19:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431988",
    "user": "https://github.com/mkoeppe"
}
```

We could add `openssl` to TOOLCHAIN_DEPS as a workaround. Then it would be built at the very beginning.



---

archive/issue_comments_431989.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> We could add `openssl` to TOOLCHAIN_DEPS as a workaround. Then it would be built at the very beginning.\nThis is now #30560",
    "created_at": "2020-09-11T21:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431989",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 mkoeppe]:
> We could add `openssl` to TOOLCHAIN_DEPS as a workaround. Then it would be built at the very beginning.
This is now #30560



---

archive/issue_comments_431990.json:
```json
{
    "body": "If we are building `python3` and `openssl` is not available as a system package and not enabled, then we should disable the packages that depend on openssl -- Jupyter notebook (and dependencies) and all `source=pip` packages. The latter are already optional packages by definition. But we would need give the Jupyter notebook packages a new package type: `optional-enabled-by-default` (#30383).",
    "created_at": "2020-09-13T19:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431990",
    "user": "https://github.com/mkoeppe"
}
```

If we are building `python3` and `openssl` is not available as a system package and not enabled, then we should disable the packages that depend on openssl -- Jupyter notebook (and dependencies) and all `source=pip` packages. The latter are already optional packages by definition. But we would need give the Jupyter notebook packages a new package type: `optional-enabled-by-default` (#30383).



---

archive/issue_comments_431991.json:
```json
{
    "body": "Replying to [comment:3 slelievre]:\n> Could there be a `configure` flag to explicitly require\n> building python3 without its `_ssl` module?\n\nThis would effectively make openssl a standard package. I don't think we should do that because of license reasons. Warnings about the disabled features are better.",
    "created_at": "2020-09-13T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431991",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:3 slelievre]:
> Could there be a `configure` flag to explicitly require
> building python3 without its `_ssl` module?

This would effectively make openssl a standard package. I don't think we should do that because of license reasons. Warnings about the disabled features are better.



---

archive/issue_comments_431992.json:
```json
{
    "body": "I would like to mention that the SSL requirement for Jupyter seems to be a recent change \u2013 presumably the upgrade of tornado or other Jupyter packages in 9.2.beta9. This was not clear to me and part of why I was confused on the mailing list. I was actually using the Python 3 SPKG without SSL all along and until now I have not experienced any problem with this. In particular, this is not related to the Python 3.8 upgrade as I had assumed at first.",
    "created_at": "2020-09-19T08:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431992",
    "user": "https://github.com/mwageringel"
}
```

I would like to mention that the SSL requirement for Jupyter seems to be a recent change â€“ presumably the upgrade of tornado or other Jupyter packages in 9.2.beta9. This was not clear to me and part of why I was confused on the mailing list. I was actually using the Python 3 SPKG without SSL all along and until now I have not experienced any problem with this. In particular, this is not related to the Python 3.8 upgrade as I had assumed at first.



---

archive/issue_comments_431993.json:
```json
{
    "body": "This might be worth investigating more.",
    "created_at": "2020-09-19T13:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431993",
    "user": "https://github.com/mkoeppe"
}
```

This might be worth investigating more.



---

archive/issue_comments_431994.json:
```json
{
    "body": "Replying to [comment:13 mkoeppe]:\n> This might be worth investigating more.\n\nAs suspected, this is a consequence of the Jupyter upgrades in #26919, merged in 9.2.beta9. The dependency on `ssl` in `tornado/httpserver.py` was added in [this commit](https://github.com/tornadoweb/tornado/commit/1b51b7dea0217927dbc52339f6db3b1233d7c539).",
    "created_at": "2020-09-27T10:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431994",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:13 mkoeppe]:
> This might be worth investigating more.

As suspected, this is a consequence of the Jupyter upgrades in #26919, merged in 9.2.beta9. The dependency on `ssl` in `tornado/httpserver.py` was added in [this commit](https://github.com/tornadoweb/tornado/commit/1b51b7dea0217927dbc52339f6db3b1233d7c539).



---

archive/issue_comments_431995.json:
```json
{
    "body": "Replying to [comment:14 gh-mwageringel]:\n> Replying to [comment:13 mkoeppe]:\n> > This might be worth investigating more.\n> \n> As suspected, this is a consequence of the Jupyter upgrades in #26919, merged in 9.2.beta9. The dependency on `ssl` in `tornado/httpserver.py` was added in [this commit](https://github.com/tornadoweb/tornado/commit/1b51b7dea0217927dbc52339f6db3b1233d7c539).\n\nLooks like this would be easy to patch out.",
    "created_at": "2020-09-27T18:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431995",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:14 gh-mwageringel]:
> Replying to [comment:13 mkoeppe]:
> > This might be worth investigating more.
> 
> As suspected, this is a consequence of the Jupyter upgrades in #26919, merged in 9.2.beta9. The dependency on `ssl` in `tornado/httpserver.py` was added in [this commit](https://github.com/tornadoweb/tornado/commit/1b51b7dea0217927dbc52339f6db3b1233d7c539).

Looks like this would be easy to patch out.



---

archive/issue_comments_431996.json:
```json
{
    "body": "This is now #30674",
    "created_at": "2020-09-27T21:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431996",
    "user": "https://github.com/mkoeppe"
}
```

This is now #30674



---

archive/issue_comments_431997.json:
```json
{
    "body": "Building a Python without ssl module is happening on `ubuntu-trusty` (https://github.com/sagemath/sage/runs/1553902103) in 9.3.beta4\n\nOur configure finds system openssl; system python3 is too old, so python 3.8 is built from source; but apparently it fails to build the ssl module. (This should be investigated!)\n\nThe symptom is that `pytest` (a pip package that is a check-only dependency of some standard package) fails to install:\n\n```\n[pytest] installing. Log file: /sage/logs/pkgs/pytest.log\n  [pytest] error installing, exit status 1. End of log file:\n  [pytest]   WARNING: pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.\n  [pytest]   WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")': /simple/pytest/\n```\n\nIt is likely that this problem has actually been around for a while and was only masked by the faulty SAGE_CHECK logic fixed in #31020.",
    "created_at": "2020-12-15T04:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431997",
    "user": "https://github.com/mkoeppe"
}
```

Building a Python without ssl module is happening on `ubuntu-trusty` (https://github.com/sagemath/sage/runs/1553902103) in 9.3.beta4

Our configure finds system openssl; system python3 is too old, so python 3.8 is built from source; but apparently it fails to build the ssl module. (This should be investigated!)

The symptom is that `pytest` (a pip package that is a check-only dependency of some standard package) fails to install:

```
[pytest] installing. Log file: /sage/logs/pkgs/pytest.log
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   WARNING: pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.
  [pytest]   WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError("Can't connect to HTTPS URL because the SSL module is not available.")': /simple/pytest/
```

It is likely that this problem has actually been around for a while and was only masked by the faulty SAGE_CHECK logic fixed in #31020.



---

archive/issue_comments_431998.json:
```json
{
    "body": "Same in `ubuntu-xenial-standard`.\n\nAlso in various `-minimal` builds, of course, where the SSL headers are not available. For example `ubuntu-hirsute-minimal` (https://github.com/sagemath/sage/runs/1553902375)",
    "created_at": "2020-12-15T04:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431998",
    "user": "https://github.com/mkoeppe"
}
```

Same in `ubuntu-xenial-standard`.

Also in various `-minimal` builds, of course, where the SSL headers are not available. For example `ubuntu-hirsute-minimal` (https://github.com/sagemath/sage/runs/1553902375)



---

archive/issue_comments_431999.json:
```json
{
    "body": "#31062 \"tox / GH Actions: Disable testsuites of packages depending on pip packages (pytest, ...) if there is no ssl\" proposes a workaround",
    "created_at": "2020-12-16T19:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-431999",
    "user": "https://github.com/mkoeppe"
}
```

#31062 "tox / GH Actions: Disable testsuites of packages depending on pip packages (pytest, ...) if there is no ssl" proposes a workaround



---

archive/issue_comments_432000.json:
```json
{
    "body": "Moving it to 9.4; we seem to have an OK solution for now",
    "created_at": "2021-03-26T21:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-432000",
    "user": "https://github.com/mkoeppe"
}
```

Moving it to 9.4; we seem to have an OK solution for now
