# Issue 30319: Build Python's ssl module

Issue created by migration from https://trac.sagemath.org/ticket/30556

Original creator: slelievre

Original creation time: 2020-09-11 18:11:02

CC:  @mwageringel mkoeppe slelievre was dimpase

Keywords: openssl, python

When building Python 3.8.5, Sage does not build its
ssl module even if OpenSSL is available system-wide.

This differs from what happened with Python 3.7.

Reported on sage-release:

- [initial report on sage-release](https://groups.google.com/d/msg/sage-release/hobZzw74Rv0/pkiQFTg9AQAJ)


---

Comment by slelievre created at 2020-09-11 19:10:29

Many builds of the python3 spkg without its `_ssl` module
likely result from an oversight.

Could there be a `configure` flag to explicitly require
building python3 without its `_ssl` module?

Without that flag, consider openssl a dependency of python3,
and let the build fail if it's not there.


---

Comment by slelievre created at 2020-09-11 19:23:22

Even when configuring with `--enable-openssl`,
I think `openssl` may be built after `python3`.

So currently one really has to separate into two steps:

```
$ make openssl
$ make
```


or later have to repair with

```
$ sage -i openssl
$ sage -f python3
```



---

Comment by mkoeppe created at 2020-09-11 19:27:36

Replying to [comment:4 slelievre]:
> Even when configuring with `--enable-openssl`,
> I think `openssl` may be built after `python3`.

Yes, this is a problem. We do not have a mechanism to order "optional dependencies".


---

Comment by mkoeppe created at 2020-09-11 19:31:27

See #21700 - Packages with "optional" dependencies (a package manager's suggested/recommended packages)


---

Comment by mkoeppe created at 2020-09-11 19:33:09

We could add `openssl` to TOOLCHAIN_DEPS as a workaround. Then it would be built at the very beginning.


---

Comment by mkoeppe created at 2020-09-11 21:47:16

Replying to [comment:7 mkoeppe]:
> We could add `openssl` to TOOLCHAIN_DEPS as a workaround. Then it would be built at the very beginning.
This is now #30560


---

Comment by mkoeppe created at 2020-09-13 19:54:32

If we are building `python3` and `openssl` is not available as a system package and not enabled, then we should disable the packages that depend on openssl -- Jupyter notebook (and dependencies) and all `source=pip` packages. The latter are already optional packages by definition. But we would need give the Jupyter notebook packages a new package type: `optional-enabled-by-default` (#30383).


---

Comment by mkoeppe created at 2020-09-13 19:58:30

Replying to [comment:3 slelievre]:
> Could there be a `configure` flag to explicitly require
> building python3 without its `_ssl` module?

This would effectively make openssl a standard package. I don't think we should do that because of license reasons. Warnings about the disabled features are better.


---

Comment by @mwageringel created at 2020-09-19 08:32:35

I would like to mention that the SSL requirement for Jupyter seems to be a recent change â€“ presumably the upgrade of tornado or other Jupyter packages in 9.2.beta9. This was not clear to me and part of why I was confused on the mailing list. I was actually using the Python 3 SPKG without SSL all along and until now I have not experienced any problem with this. In particular, this is not related to the Python 3.8 upgrade as I had assumed at first.


---

Comment by mkoeppe created at 2020-09-19 13:14:46

This might be worth investigating more.


---

Comment by @mwageringel created at 2020-09-27 10:58:50

Replying to [comment:13 mkoeppe]:
> This might be worth investigating more.

As suspected, this is a consequence of the Jupyter upgrades in #26919, merged in 9.2.beta9. The dependency on `ssl` in `tornado/httpserver.py` was added in [this commit](https://github.com/tornadoweb/tornado/commit/1b51b7dea0217927dbc52339f6db3b1233d7c539).


---

Comment by mkoeppe created at 2020-09-27 18:45:49

Replying to [comment:14 gh-mwageringel]:
> Replying to [comment:13 mkoeppe]:
> > This might be worth investigating more.
> 
> As suspected, this is a consequence of the Jupyter upgrades in #26919, merged in 9.2.beta9. The dependency on `ssl` in `tornado/httpserver.py` was added in [this commit](https://github.com/tornadoweb/tornado/commit/1b51b7dea0217927dbc52339f6db3b1233d7c539).

Looks like this would be easy to patch out.


---

Comment by mkoeppe created at 2020-09-27 21:49:45

This is now #30674


---

Comment by mkoeppe created at 2020-12-15 04:28:28

Building a Python without ssl module is happening on `ubuntu-trusty` (https://github.com/sagemath/sage/runs/1553902103) in 9.3.beta4

Our configure finds system openssl; system python3 is too old, so python 3.8 is built from source; but apparently it fails to build the ssl module. (This should be investigated!)

The symptom is that `pytest` (a pip package that is a check-only dependency of some standard package) fails to install:

```
[pytest] installing. Log file: /sage/logs/pkgs/pytest.log
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   WARNING: pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.
  [pytest]   WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError("Can't connect to HTTPS URL because the SSL module is not available.")': /simple/pytest/
```

It is likely that this problem has actually been around for a while and was only masked by the faulty SAGE_CHECK logic fixed in #31020.


---

Comment by mkoeppe created at 2020-12-15 04:38:14

Same in `ubuntu-xenial-standard`.

Also in various `-minimal` builds, of course, where the SSL headers are not available. For example `ubuntu-hirsute-minimal` (https://github.com/sagemath/sage/runs/1553902375)


---

Comment by mkoeppe created at 2020-12-16 19:59:12

#31062 "tox / GH Actions: Disable testsuites of packages depending on pip packages (pytest, ...) if there is no ssl" proposes a workaround


---

Comment by mkoeppe created at 2021-03-26 21:01:57

Changing priority from critical to major.


---

Comment by mkoeppe created at 2021-03-26 21:01:57

Moving it to 9.4; we seem to have an OK solution for now
