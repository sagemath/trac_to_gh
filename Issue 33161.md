# Issue 33161: Update doctests for compatibility with SymPy 1.10

Issue created by migration from https://trac.sagemath.org/ticket/33398

Original creator: mkoeppe

Original creation time: 2022-02-21 20:29:22

CC:  egourgoulhon @oscarbenjamin

From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
**********************************************************************
File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
Failed example:
    a, cond
Expected:
    (-oo, True)
Got:
    (0, True)
**********************************************************************

sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
**********************************************************************
File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
Failed example:
    Phi.coord_functions(c_UV, c_xyz)
Expected:
    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
     on the Chart (M, (U, V))
Got:
    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))

sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/differentiable/diff_form.py
**********************************************************************
File "src/sage/manifolds/differentiable/diff_form.py", line 268, in sage.manifolds.differentiable.diff_form.DiffForm
Failed example:
    s.display(eU)
Expected:
    a∧b = -x*(2*x*y + 1) dx∧dy
Got:
    a∧b = x*(-2*x*y - 1) dx∧dy
**********************************************************************
File "src/sage/manifolds/differentiable/diff_form.py", line 277, in sage.manifolds.differentiable.diff_form.DiffForm
Failed example:
    s.display(eU)
Expected:
    f*a = -y*(x**2 + 2*x*y + y**2) dx + x*(x**2 + 2*x*y + y**2) dy
Got:
    f*a = y*(-x**2 - 2*x*y - y**2) dx + x*(x**2 + 2*x*y + y**2) dy
**********************************************************************

sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
**********************************************************************
File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
Failed example:
    Phi.coord_functions(c_UV, c_xyz)
Expected:
    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
     on the Chart (M, (U, V))
Got:
    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
**********************************************************************

sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy == f_sympy.diff(x, 2, y, 1)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
        return _derivative_dispatch(self, *symbols, **assumptions)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
        return Derivative(expr, *variables, **kwargs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
        raise ValueError(filldedent('''
    ValueError: 
    Can't calculate derivative wrt 2.
**********************************************************************
```



---

Comment by mkoeppe created at 2022-02-21 21:00:25


```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy == f_sympy.diff(x, 2, y, 1)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
        return _derivative_dispatch(self, *symbols, **assumptions)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
        return Derivative(expr, *variables, **kwargs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
        raise ValueError(filldedent('''
    ValueError: 
    Can't calculate derivative wrt 2.
**********************************************************************
```


For this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144


---

Comment by mkoeppe created at 2022-02-21 22:57:18

A few more that are only seen with `sage -t --long`:

```
sage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 334, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    f.display()  # long time
Expected:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 343, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 348, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 357, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): V → ℝ
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
Got:
    t(a,b): V → ℝ
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
**********************************************************************
1 item had failures:
   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField
    [1059 tests, 4 failures, 716.84 s]
```



---

Comment by egourgoulhon created at 2022-02-22 10:14:55

Thanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.


---

Comment by mkoeppe created at 2022-02-25 22:18:44

Replying to [comment:1 mkoeppe]:
> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144

Fixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166


---

Comment by mkoeppe created at 2022-02-25 22:19:14

Replying to [comment:3 egourgoulhon]:
> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? 

Yes, I think so


---

Comment by mkoeppe created at 2022-02-25 23:40:25

Replying to [ticket:33398 mkoeppe]:
> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
> {{{
> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
> **********************************************************************
> File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
> Failed example:
>     a, cond
> Expected:
>     (-oo, True)
> Got:
>     (0, True)
> **********************************************************************

This change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.


---

Comment by mkoeppe created at 2022-03-04 23:18:31

New commits:


---

Comment by git created at 2022-03-05 00:07:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-06 17:42:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-06 17:42:44

Changing priority from major to critical.


---

Comment by mkoeppe created at 2022-03-06 17:42:44

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-03-06 21:08:07

LGTM. Thanks!


---

Comment by egourgoulhon created at 2022-03-06 21:08:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-03-09 23:38:35

Resolution: fixed
