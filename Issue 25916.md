# Issue 25916: sage-spkg does not correctly overwrite existing directories

Issue created by migration from https://trac.sagemath.org/ticket/26153

Original creator: jdemeyer

Original creation time: 2018-08-28 15:16:17

CC:  embray

This line in `sage-spkg`

```
$SAGE_SUDO mv "$PREFIX/$filename" "${SAGE_LOCAL%/}/$filename"
```

might move a file `$filename` (to be installed) into a _directory_ `$filename` (if the latter was an existing directory).

This is partially responsible for #26152.


---

Comment by embray created at 2018-08-28 15:17:35

Note: This is probably fixed by #26011


---

Comment by embray created at 2018-08-28 15:22:25

> if the latter was an existing directory

Or, it seems, a symlink pointing to a directory.  That's the real problem.


---

Comment by jdemeyer created at 2018-08-28 15:24:03

Replying to [comment:3 embray]:
> Or, it seems, a symlink pointing to a directory.  That's the real problem.

Yes, I clarified that in an edit of the description that you reverted.


---

Comment by embray created at 2018-08-28 15:27:07

It looks like we were just posting at the same time--sorry, I didn't notice the warning.


---

Comment by dimpase created at 2018-09-25 11:50:30

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-09-25 11:51:15

Do I understand it right that the branch on #26011 fixes this?


---

Comment by embray created at 2018-09-25 13:04:17

It would.  The problem here was that I was manually calling `mv` on each file one-by-one, which in its own right is a bit slow when you have lots of files to move.  But there are some unfortunate subtleties to `mv`, especially when symlinks are involved, that were not taken into account (see the problem Jeroen described in this ticket).  #26011 would replace N `mv` calls with a single `cp -r` of the entire directory tree, which AFAICT handles cases like symlinks well too.  

In #26011 Jeroen raised some valid concerns about that approach which I attempted to answer, but I admit I don't know what the best play is here (though most online resources I've scoured really do seem to suggest that using `cp` is the most robust approach in most cases, even if that means needless copying of data.  But I'm definitely up for other approaches if they can be suggested...


---

Comment by vbraun created at 2018-10-05 22:21:53

Duplicate?


---

Comment by embray created at 2018-10-08 09:49:06

Resolution: fixed


---

Comment by embray created at 2018-10-08 09:49:06

I wouldn't say it's a duplicate per se, but since #26011 has been accepted we should be able to call this fixed as well.  I'm still not sure if Jeroen will be satisfied with the solution to this (I'm not entirely either) but if we revisit the issue we should just make sure this case is preserved s well.


---

Comment by jdemeyer created at 2018-11-05 13:49:31

It's not really "fixed" by #26011 in the sense that the condition now becomes a hard error (after #26642), failing the installation. Ideally, it should _overwrite_ any existing directories.

That being said, I think that you can only do so much with simple shell scripts. Anything more complicated should really be done in Python.


---

Comment by embray created at 2018-11-06 10:17:11

Yes, ideally sage-spkg should still be rewritten mostly if not entirely in Python.
