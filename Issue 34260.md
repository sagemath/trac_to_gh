# Issue 34260: Refactor Components into parent & element, step 1

Issue created by migration from https://trac.sagemath.org/ticket/34497

Original creator: mkoeppe

Original creation time: 2022-09-06 00:14:36

CC:  egourgoulhon tscrim

We introduce a parent class for `Components`, called `TensorFreeModuleWithBasis` (although it won't be a module yet as of this ticket). 

We move symmetry attributes, frame, and output formatter there.

This is a step toward #30307.



---

Comment by egourgoulhon created at 2022-09-06 09:00:37

I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis, namely the [coefficients of an affine connection](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/affine_connection.html#sage.manifolds.differentiable.affine_connection.AffineConnection.coef) on a differentiable manifold. Because of the lack of a clear algebraic structure, I am not convinced either that the !Parent/Element scheme is what we need here. We had a discussion about this in #30307. I understand the need to delegate the handling of symmetries to a devoted class, but maybe not a `Parent` class... 
----
New commits:


---

Comment by mkoeppe created at 2022-09-06 15:29:42

Replying to [comment:2 Eric Gourgoulhon]:
> I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis

The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.

This module would be just like a `FreeModule` or a `MatrixSpace`. Note that a matrix also does not know how it should transform - whether as the matrix of a linear map or as the matrix of a quadratic form.


---

Comment by mkoeppe created at 2022-09-06 15:39:34

To add to this, the information how things transform is stored in the morphism from the `TensorFreeModule` to the `TensorFreeModuleWithBasis`, not in the module.

In the context of some of the other recent tickets: This morphism is exactly the `isomorphism_with_fixed_basis` (#34427).


---

Comment by egourgoulhon created at 2022-09-06 16:18:20

Replying to [comment:3 Matthias Köppe]:
> Replying to [comment:2 Eric Gourgoulhon]:
> > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis
> 
> The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.

Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. 
> 
> This module would be just like a `FreeModule` or a `MatrixSpace`. Note that a matrix also does not know how it should transform - whether as the matrix of a linear map or as the matrix of a quadratic form.

Yes, that's clear. The "matrix" point of view should be the one to adopt here. For the case of the connection coefficients, the module operations would have no meaning for the affine connections they come from, but this is OK, i.e. these operations will simply not be used in that case (there is no addition nor scalar multiplication defined at the level of `AffineConnection`).


---

Comment by mkoeppe created at 2022-09-06 16:54:44

Replying to [comment:5 Eric Gourgoulhon]:
> Replying to [comment:3 Matthias Köppe]:
> > Replying to [comment:2 Eric Gourgoulhon]:
> > > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis
> > 
> > The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.
> 
> Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. 

OK, this is a great point, thank you. Now I remember #30245, which goes in a similar direction. The presence of these automatically provided addition and multiplication operations can indeed be misleading in such situations.

It would be worthwhile to think about whether we should make it possible to create a `MatrixSpace` or `TensorFreeModuleWithBasis` in a larger category than `ModulesWithBasis`, perhaps just `Sets`, and in that case use an element class that does not provide the module operations (`_add_`, `_lmul_` etc.)


---

Comment by mkoeppe created at 2022-09-06 16:58:36

Of course, one could say "if you want just an array, use an array, not a matrix", but this would ignore that we have specialized element classes for matrices over specific base rings, which are advantageous to use even if there's no module structure.


---

Comment by egourgoulhon created at 2022-09-06 17:41:32

Replying to [comment:6 Matthias Köppe]:
> Replying to [comment:5 Eric Gourgoulhon]:
> > Replying to [comment:3 Matthias Köppe]:
> > > Replying to [comment:2 Eric Gourgoulhon]:
> > > > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis
> > > 
> > > The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.
> > 
> > Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. 
> 
> OK, this is a great point, thank you. Now I remember #30245, which goes in a similar direction. The presence of these automatically provided addition and multiplication operations can indeed be misleading in such situations.

It looks less severe here than in #30245: as you pointed out, the connection coefficients in a given basis can be considered as elements of a tensor module and one can performed module operations of them (after all, the class `Components` defines `__add__` and `__rmul__`), simply these operations do not correspond to operations on the connections themselves, so that they will not be used in an actual code.

> 
> It would be worthwhile to think about whether we should make it possible to create a `MatrixSpace` or `TensorFreeModuleWithBasis` in a larger category than `ModulesWithBasis`, perhaps just `Sets`, and in that case use an element class that does not provide the module operations (`_add_`, `_lmul_` etc.)
> 

Given the remark above, I would say it is fine to stay with the category `ModulesWithBasis`.


---

Comment by egourgoulhon created at 2022-09-06 17:50:09

Replying to [comment:7 Matthias Köppe]:
> Of course, one could say "if you want just an array, use an array, not a matrix", but this would ignore that we have specialized element classes for matrices over specific base rings, which are advantageous to use even if there's no module structure.
That's a good point.
 
A possible concern about moving to the `Parent/Element` scheme is about the efficiency with respect to the pure array-like structure. The class `Components` is at the root of the calculus on manifolds and one should make sure that introducing parents does now yield some significant slow down. But this is something we can check and benchmark.


---

Comment by mkoeppe created at 2022-09-06 17:56:57

Absolutely. The intention here is to make construction of elements and arithmetic faster, not slower; and this will have to be benchmarked.


---

Comment by @mjungmath created at 2022-09-07 21:28:39

We already had this discussion somewhere. I raised the concern that, mathematically speaking, a parent is not a "small object". The category of objects would be more appropriate, IMHO.

I also think that the name is misleading. In the previous ticket I proposed `CompParent`.


---

Comment by mkoeppe created at 2022-09-07 21:51:55

It's a module, hence `...Module`.


---

Comment by @mjungmath created at 2022-09-08 06:12:42

Ah I see, you let the parent handle the frames. Then, at least mathematically, it should be fine.

But from the programming viewpoint I see a problem with `UniqueRepresentation`. The nice thing about the current implementation (and also the curse for maintenance) is that frames can flexibly be added. If the parent's signature is determined by the list of frames, we run into troubles when we want to add another one at a later point.


---

Comment by @mjungmath created at 2022-09-08 06:20:42

Perhaps a class of family of frames that is a `UniqueRepresentation` and allows to flexibly add (and remove?) frames is what we want?


---

Comment by @mjungmath created at 2022-09-08 06:28:47

Actually, I think this is even a great idea in terms of the big picture. That way, we can build pre-sheaves of frames on manifolds and probably even frame-bundles more easily.

Moreover, I think we can get rid of a lot of code redundancies w.r.t. frames/bases.

What do you think?


---

Comment by mkoeppe created at 2022-09-08 07:08:23

Replying to [comment:13 Michael Jung]:
> from the programming viewpoint I see a problem with `UniqueRepresentation`. The nice thing about the current implementation (and also the curse for maintenance) is that frames can flexibly be added. If the parent's signature is determined by the list of frames, we run into troubles when we want to add another one at a later point.

You are misunderstanding the code on the branch. The frame is fixed in an instance of the parent `TensorFreeModuleWithBasis`. `frames` (and `start_indices`) are plural because I'm keeping one frame per tensor index as preparation for supporting tensor products of different spaces, such as `V (x) W (x) V^* (x) W^*`.


---

Comment by @mjungmath created at 2022-09-08 07:22:22

Ah! That's clever. Then I agree with everything that was said.

(Otherwise it's also not a module...!)

Thank you for the clarification.


---

Comment by @mjungmath created at 2022-09-08 07:23:06

We should keep the idea of families of frames in mind though.


---

Comment by mkoeppe created at 2022-09-08 15:27:02

Replying to [comment:18 Michael Jung]:
> We should keep the idea of families of frames in mind though.

Yes, I'm preparing the sheafy stuff in #34398, #34461
