# Issue 34260: Refactor Components into parent & element, step 1

archive/issues_034260.json:
```json
{
    "body": "CC:  @egourgoulhon @tscrim\n\nWe introduce a parent class for `Components`, called `TensorFreeModuleWithBasis` (although it won't be a module yet as of this ticket). \n\nWe move symmetry attributes, frame, and output formatter there.\n\nThis is a step toward #30307.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34497\n\n",
    "created_at": "2022-09-06T00:14:36Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Refactor Components into parent & element, step 1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34260",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @egourgoulhon @tscrim

We introduce a parent class for `Components`, called `TensorFreeModuleWithBasis` (although it won't be a module yet as of this ticket). 

We move symmetry attributes, frame, and output formatter there.

This is a step toward #30307.


Issue created by migration from https://trac.sagemath.org/ticket/34497





---

archive/issue_comments_485273.json:
```json
{
    "body": "I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis, namely the [coefficients of an affine connection](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/affine_connection.html#sage.manifolds.differentiable.affine_connection.AffineConnection.coef) on a differentiable manifold. Because of the lack of a clear algebraic structure, I am not convinced either that the !Parent/Element scheme is what we need here. We had a discussion about this in #30307. I understand the need to delegate the handling of symmetries to a devoted class, but maybe not a `Parent` class... \n----\nNew commits:",
    "created_at": "2022-09-06T09:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485273",
    "user": "https://github.com/egourgoulhon"
}
```

I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis, namely the [coefficients of an affine connection](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/affine_connection.html#sage.manifolds.differentiable.affine_connection.AffineConnection.coef) on a differentiable manifold. Because of the lack of a clear algebraic structure, I am not convinced either that the !Parent/Element scheme is what we need here. We had a discussion about this in #30307. I understand the need to delegate the handling of symmetries to a devoted class, but maybe not a `Parent` class... 
----
New commits:



---

archive/issue_comments_485274.json:
```json
{
    "body": "Replying to [comment:2 Eric Gourgoulhon]:\n> I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis\n\nThe basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.\n\nThis module would be just like a `FreeModule` or a `MatrixSpace`. Note that a matrix also does not know how it should transform - whether as the matrix of a linear map or as the matrix of a quadratic form.",
    "created_at": "2022-09-06T15:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485274",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 Eric Gourgoulhon]:
> I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis

The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.

This module would be just like a `FreeModule` or a `MatrixSpace`. Note that a matrix also does not know how it should transform - whether as the matrix of a linear map or as the matrix of a quadratic form.



---

archive/issue_comments_485275.json:
```json
{
    "body": "To add to this, the information how things transform is stored in the morphism from the `TensorFreeModule` to the `TensorFreeModuleWithBasis`, not in the module.\n\nIn the context of some of the other recent tickets: This morphism is exactly the `isomorphism_with_fixed_basis` (#34427).",
    "created_at": "2022-09-06T15:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485275",
    "user": "https://github.com/mkoeppe"
}
```

To add to this, the information how things transform is stored in the morphism from the `TensorFreeModule` to the `TensorFreeModuleWithBasis`, not in the module.

In the context of some of the other recent tickets: This morphism is exactly the `isomorphism_with_fixed_basis` (#34427).



---

archive/issue_comments_485276.json:
```json
{
    "body": "Replying to [comment:3 Matthias K\u00f6ppe]:\n> Replying to [comment:2 Eric Gourgoulhon]:\n> > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis\n> \n> The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.\n\nIndeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. \n> \n> This module would be just like a `FreeModule` or a `MatrixSpace`. Note that a matrix also does not know how it should transform - whether as the matrix of a linear map or as the matrix of a quadratic form.\n\nYes, that's clear. The \"matrix\" point of view should be the one to adopt here. For the case of the connection coefficients, the module operations would have no meaning for the affine connections they come from, but this is OK, i.e. these operations will simply not be used in that case (there is no addition nor scalar multiplication defined at the level of `AffineConnection`).",
    "created_at": "2022-09-06T16:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485276",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:3 Matthias Köppe]:
> Replying to [comment:2 Eric Gourgoulhon]:
> > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis
> 
> The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.

Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. 
> 
> This module would be just like a `FreeModule` or a `MatrixSpace`. Note that a matrix also does not know how it should transform - whether as the matrix of a linear map or as the matrix of a quadratic form.

Yes, that's clear. The "matrix" point of view should be the one to adopt here. For the case of the connection coefficients, the module operations would have no meaning for the affine connections they come from, but this is OK, i.e. these operations will simply not be used in that case (there is no addition nor scalar multiplication defined at the level of `AffineConnection`).



---

archive/issue_comments_485277.json:
```json
{
    "body": "Replying to [comment:5 Eric Gourgoulhon]:\n> Replying to [comment:3 Matthias K\u00f6ppe]:\n> > Replying to [comment:2 Eric Gourgoulhon]:\n> > > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis\n> > \n> > The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.\n> \n> Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. \n\nOK, this is a great point, thank you. Now I remember #30245, which goes in a similar direction. The presence of these automatically provided addition and multiplication operations can indeed be misleading in such situations.\n\nIt would be worthwhile to think about whether we should make it possible to create a `MatrixSpace` or `TensorFreeModuleWithBasis` in a larger category than `ModulesWithBasis`, perhaps just `Sets`, and in that case use an element class that does not provide the module operations (`_add_`, `_lmul_` etc.)",
    "created_at": "2022-09-06T16:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485277",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:5 Eric Gourgoulhon]:
> Replying to [comment:3 Matthias Köppe]:
> > Replying to [comment:2 Eric Gourgoulhon]:
> > > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis
> > 
> > The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.
> 
> Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. 

OK, this is a great point, thank you. Now I remember #30245, which goes in a similar direction. The presence of these automatically provided addition and multiplication operations can indeed be misleading in such situations.

It would be worthwhile to think about whether we should make it possible to create a `MatrixSpace` or `TensorFreeModuleWithBasis` in a larger category than `ModulesWithBasis`, perhaps just `Sets`, and in that case use an element class that does not provide the module operations (`_add_`, `_lmul_` etc.)



---

archive/issue_comments_485278.json:
```json
{
    "body": "Of course, one could say \"if you want just an array, use an array, not a matrix\", but this would ignore that we have specialized element classes for matrices over specific base rings, which are advantageous to use even if there's no module structure.",
    "created_at": "2022-09-06T16:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485278",
    "user": "https://github.com/mkoeppe"
}
```

Of course, one could say "if you want just an array, use an array, not a matrix", but this would ignore that we have specialized element classes for matrices over specific base rings, which are advantageous to use even if there's no module structure.



---

archive/issue_comments_485279.json:
```json
{
    "body": "Replying to [comment:6 Matthias K\u00f6ppe]:\n> Replying to [comment:5 Eric Gourgoulhon]:\n> > Replying to [comment:3 Matthias K\u00f6ppe]:\n> > > Replying to [comment:2 Eric Gourgoulhon]:\n> > > > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis\n> > > \n> > > The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.\n> > \n> > Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. \n> \n> OK, this is a great point, thank you. Now I remember #30245, which goes in a similar direction. The presence of these automatically provided addition and multiplication operations can indeed be misleading in such situations.\n\nIt looks less severe here than in #30245: as you pointed out, the connection coefficients in a given basis can be considered as elements of a tensor module and one can performed module operations of them (after all, the class `Components` defines `__add__` and `__rmul__`), simply these operations do not correspond to operations on the connections themselves, so that they will not be used in an actual code.\n\n> \n> It would be worthwhile to think about whether we should make it possible to create a `MatrixSpace` or `TensorFreeModuleWithBasis` in a larger category than `ModulesWithBasis`, perhaps just `Sets`, and in that case use an element class that does not provide the module operations (`_add_`, `_lmul_` etc.)\n> \n\nGiven the remark above, I would say it is fine to stay with the category `ModulesWithBasis`.",
    "created_at": "2022-09-06T17:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485279",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:6 Matthias Köppe]:
> Replying to [comment:5 Eric Gourgoulhon]:
> > Replying to [comment:3 Matthias Köppe]:
> > > Replying to [comment:2 Eric Gourgoulhon]:
> > > > I am not convinced about the tensor module structure for the parent, because, in some cases, `Components` is used to store data that do not behave as tensor components under a change of basis
> > > 
> > > The basis is fixed, and a `Components` instance does not even know which indices are covariant and which are contravariant positions, so I don't think any claims how things transform are made.
> > 
> > Indeed, but the very name `TensorFreeModuleWithBasis` suggests that we are dealing with the components of a tensor on a free module, while the connection coefficients are no such thing. In particular, the set of affine connections on a given manifold is usually not endowed with a module structure: there is no meaning in adding two affine connections, and the multiplication by an element of the (potential) base ring --- the algebra of smooth scalar fields, would not lead to another affine connection. 
> 
> OK, this is a great point, thank you. Now I remember #30245, which goes in a similar direction. The presence of these automatically provided addition and multiplication operations can indeed be misleading in such situations.

It looks less severe here than in #30245: as you pointed out, the connection coefficients in a given basis can be considered as elements of a tensor module and one can performed module operations of them (after all, the class `Components` defines `__add__` and `__rmul__`), simply these operations do not correspond to operations on the connections themselves, so that they will not be used in an actual code.

> 
> It would be worthwhile to think about whether we should make it possible to create a `MatrixSpace` or `TensorFreeModuleWithBasis` in a larger category than `ModulesWithBasis`, perhaps just `Sets`, and in that case use an element class that does not provide the module operations (`_add_`, `_lmul_` etc.)
> 

Given the remark above, I would say it is fine to stay with the category `ModulesWithBasis`.



---

archive/issue_comments_485280.json:
```json
{
    "body": "Replying to [comment:7 Matthias K\u00f6ppe]:\n> Of course, one could say \"if you want just an array, use an array, not a matrix\", but this would ignore that we have specialized element classes for matrices over specific base rings, which are advantageous to use even if there's no module structure.\nThat's a good point.\n \nA possible concern about moving to the `Parent/Element` scheme is about the efficiency with respect to the pure array-like structure. The class `Components` is at the root of the calculus on manifolds and one should make sure that introducing parents does now yield some significant slow down. But this is something we can check and benchmark.",
    "created_at": "2022-09-06T17:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485280",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:7 Matthias Köppe]:
> Of course, one could say "if you want just an array, use an array, not a matrix", but this would ignore that we have specialized element classes for matrices over specific base rings, which are advantageous to use even if there's no module structure.
That's a good point.
 
A possible concern about moving to the `Parent/Element` scheme is about the efficiency with respect to the pure array-like structure. The class `Components` is at the root of the calculus on manifolds and one should make sure that introducing parents does now yield some significant slow down. But this is something we can check and benchmark.



---

archive/issue_comments_485281.json:
```json
{
    "body": "Absolutely. The intention here is to make construction of elements and arithmetic faster, not slower; and this will have to be benchmarked.",
    "created_at": "2022-09-06T17:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485281",
    "user": "https://github.com/mkoeppe"
}
```

Absolutely. The intention here is to make construction of elements and arithmetic faster, not slower; and this will have to be benchmarked.



---

archive/issue_comments_485282.json:
```json
{
    "body": "We already had this discussion somewhere. I raised the concern that, mathematically speaking, a parent is not a \"small object\". The category of objects would be more appropriate, IMHO.\n\nI also think that the name is misleading. In the previous ticket I proposed `CompParent`.",
    "created_at": "2022-09-07T21:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485282",
    "user": "https://github.com/mjungmath"
}
```

We already had this discussion somewhere. I raised the concern that, mathematically speaking, a parent is not a "small object". The category of objects would be more appropriate, IMHO.

I also think that the name is misleading. In the previous ticket I proposed `CompParent`.



---

archive/issue_comments_485283.json:
```json
{
    "body": "It's a module, hence `...Module`.",
    "created_at": "2022-09-07T21:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485283",
    "user": "https://github.com/mkoeppe"
}
```

It's a module, hence `...Module`.



---

archive/issue_comments_485284.json:
```json
{
    "body": "Ah I see, you let the parent handle the frames. Then, at least mathematically, it should be fine.\n\nBut from the programming viewpoint I see a problem with `UniqueRepresentation`. The nice thing about the current implementation (and also the curse for maintenance) is that frames can flexibly be added. If the parent's signature is determined by the list of frames, we run into troubles when we want to add another one at a later point.",
    "created_at": "2022-09-08T06:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485284",
    "user": "https://github.com/mjungmath"
}
```

Ah I see, you let the parent handle the frames. Then, at least mathematically, it should be fine.

But from the programming viewpoint I see a problem with `UniqueRepresentation`. The nice thing about the current implementation (and also the curse for maintenance) is that frames can flexibly be added. If the parent's signature is determined by the list of frames, we run into troubles when we want to add another one at a later point.



---

archive/issue_comments_485285.json:
```json
{
    "body": "Perhaps a class of family of frames that is a `UniqueRepresentation` and allows to flexibly add (and remove?) frames is what we want?",
    "created_at": "2022-09-08T06:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485285",
    "user": "https://github.com/mjungmath"
}
```

Perhaps a class of family of frames that is a `UniqueRepresentation` and allows to flexibly add (and remove?) frames is what we want?



---

archive/issue_comments_485286.json:
```json
{
    "body": "Actually, I think this is even a great idea in terms of the big picture. That way, we can build pre-sheaves of frames on manifolds and probably even frame-bundles more easily.\n\nMoreover, I think we can get rid of a lot of code redundancies w.r.t. frames/bases.\n\nWhat do you think?",
    "created_at": "2022-09-08T06:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485286",
    "user": "https://github.com/mjungmath"
}
```

Actually, I think this is even a great idea in terms of the big picture. That way, we can build pre-sheaves of frames on manifolds and probably even frame-bundles more easily.

Moreover, I think we can get rid of a lot of code redundancies w.r.t. frames/bases.

What do you think?



---

archive/issue_comments_485287.json:
```json
{
    "body": "Replying to [comment:13 Michael Jung]:\n> from the programming viewpoint I see a problem with `UniqueRepresentation`. The nice thing about the current implementation (and also the curse for maintenance) is that frames can flexibly be added. If the parent's signature is determined by the list of frames, we run into troubles when we want to add another one at a later point.\n\nYou are misunderstanding the code on the branch. The frame is fixed in an instance of the parent `TensorFreeModuleWithBasis`. `frames` (and `start_indices`) are plural because I'm keeping one frame per tensor index as preparation for supporting tensor products of different spaces, such as `V (x) W (x) V^* (x) W^*`.",
    "created_at": "2022-09-08T07:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485287",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:13 Michael Jung]:
> from the programming viewpoint I see a problem with `UniqueRepresentation`. The nice thing about the current implementation (and also the curse for maintenance) is that frames can flexibly be added. If the parent's signature is determined by the list of frames, we run into troubles when we want to add another one at a later point.

You are misunderstanding the code on the branch. The frame is fixed in an instance of the parent `TensorFreeModuleWithBasis`. `frames` (and `start_indices`) are plural because I'm keeping one frame per tensor index as preparation for supporting tensor products of different spaces, such as `V (x) W (x) V^* (x) W^*`.



---

archive/issue_comments_485288.json:
```json
{
    "body": "Ah! That's clever. Then I agree with everything that was said.\n\n(Otherwise it's also not a module...!)\n\nThank you for the clarification.",
    "created_at": "2022-09-08T07:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485288",
    "user": "https://github.com/mjungmath"
}
```

Ah! That's clever. Then I agree with everything that was said.

(Otherwise it's also not a module...!)

Thank you for the clarification.



---

archive/issue_comments_485289.json:
```json
{
    "body": "We should keep the idea of families of frames in mind though.",
    "created_at": "2022-09-08T07:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485289",
    "user": "https://github.com/mjungmath"
}
```

We should keep the idea of families of frames in mind though.



---

archive/issue_comments_485290.json:
```json
{
    "body": "Replying to [comment:18 Michael Jung]:\n> We should keep the idea of families of frames in mind though.\n\nYes, I'm preparing the sheafy stuff in #34398, #34461",
    "created_at": "2022-09-08T15:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34260#issuecomment-485290",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:18 Michael Jung]:
> We should keep the idea of families of frames in mind though.

Yes, I'm preparing the sheafy stuff in #34398, #34461
