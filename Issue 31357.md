# Issue 31357: Accept giac-1.7.x from the system

archive/issues_031357.json:
```json
{
    "body": "CC:  mkoeppe dimpase isuruf arojas fbissey\n\nThis works fine out-of-the-box, we just need to tweak the version bounds in spkg-configure.m4 to accept it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31594\n\n",
    "created_at": "2021-04-02T13:32:01Z",
    "labels": [
        "build: configure",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Accept giac-1.7.x from the system",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31357",
    "user": "mjo"
}
```
CC:  mkoeppe dimpase isuruf arojas fbissey

This works fine out-of-the-box, we just need to tweak the version bounds in spkg-configure.m4 to accept it.

Issue created by migration from https://trac.sagemath.org/ticket/31594





---

archive/issue_comments_448732.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-02T13:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448732",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448733.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-02T13:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448733",
    "user": "mjo"
}
```

New commits:



---

archive/issue_comments_448734.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448734",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_448735.json:
```json
{
    "body": "I am prepared to accept this, although I probably would want #31563 to be done first.",
    "created_at": "2021-04-11T23:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448735",
    "user": "tscrim"
}
```

I am prepared to accept this, although I probably would want #31563 to be done first.



---

archive/issue_comments_448736.json:
```json
{
    "body": "One of the main benefits of using system packages is that we don't all have to wait for someone to duplicate pointless work in the SPKG =)",
    "created_at": "2021-04-14T12:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448736",
    "user": "mjo"
}
```

One of the main benefits of using system packages is that we don't all have to wait for someone to duplicate pointless work in the SPKG =)



---

archive/issue_comments_448737.json:
```json
{
    "body": "Replying to [comment:4 mjo]:\n> One of the main benefits of using system packages is that we don't all have to wait for someone to duplicate pointless work in the SPKG =)\n> \nI am impatiently waiting for removal of gcc and gfortran packages (along with the rest of Sage toolchain), to start with :-)",
    "created_at": "2021-04-14T13:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448737",
    "user": "dimpase"
}
```

Replying to [comment:4 mjo]:
> One of the main benefits of using system packages is that we don't all have to wait for someone to duplicate pointless work in the SPKG =)
> 
I am impatiently waiting for removal of gcc and gfortran packages (along with the rest of Sage toolchain), to start with :-)



---

archive/issue_comments_448738.json:
```json
{
    "body": "let me test on Gentoo. It seems I'd also  need pari 2.13 from the system for this to work, though.",
    "created_at": "2021-04-14T13:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448738",
    "user": "dimpase"
}
```

let me test on Gentoo. It seems I'd also  need pari 2.13 from the system for this to work, though.



---

archive/issue_comments_448739.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-14T13:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448739",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448740.json:
```json
{
    "body": "Beware that the latest 1.7.0.3 version causes some breakage. Some tests fail because of changes in expression expansion, but there are some other weird failures such as\n\n\n```\nFile \"/usr/lib/python3.9/site-packages/sage/interfaces/giac.py\", line 724, in sage.interfaces.giac.Giac._equality_symbol\nFailed example:\n    giac(2) == giac(2)\nExpected:\n    True\nGot:\n    False\n```\n",
    "created_at": "2021-05-01T17:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448740",
    "user": "arojas"
}
```

Beware that the latest 1.7.0.3 version causes some breakage. Some tests fail because of changes in expression expansion, but there are some other weird failures such as


```
File "/usr/lib/python3.9/site-packages/sage/interfaces/giac.py", line 724, in sage.interfaces.giac.Giac._equality_symbol
Failed example:
    giac(2) == giac(2)
Expected:
    True
Got:
    False
```




---

archive/issue_comments_448741.json:
```json
{
    "body": "Seems that evalb is just broken in 1.7.0.3\n\n```\n0>> a:=0\n0\n// Time 0\n1>> evalb(a==0)\nfalse\n// Time 0\n```\n\nCould someone with an account please report it upstream?",
    "created_at": "2021-05-02T10:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448741",
    "user": "arojas"
}
```

Seems that evalb is just broken in 1.7.0.3

```
0>> a:=0
0
// Time 0
1>> evalb(a==0)
false
// Time 0
```

Could someone with an account please report it upstream?



---

archive/issue_comments_448742.json:
```json
{
    "body": "evalb bug fixed [https://dev.geogebra.org/trac/changeset/69847/](https://dev.geogebra.org/trac/changeset/69847/)\nThere are indeed some changes in symbolic integration and simplification in giac 1.7.0-3.",
    "created_at": "2021-05-02T17:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448742",
    "user": "parisse"
}
```

evalb bug fixed [https://dev.geogebra.org/trac/changeset/69847/](https://dev.geogebra.org/trac/changeset/69847/)
There are indeed some changes in symbolic integration and simplification in giac 1.7.0-3.



---

archive/issue_comments_448743.json:
```json
{
    "body": "1.7.0-3 doesn't like the default `-std=c++17` of gcc-11. I guess that applies to all the previous versions as well. Setting `CXX=\"g++ -std=c++14\"` or passing the standard as a CXXFLAGS does work.",
    "created_at": "2021-05-02T21:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448743",
    "user": "fbissey"
}
```

1.7.0-3 doesn't like the default `-std=c++17` of gcc-11. I guess that applies to all the previous versions as well. Setting `CXX="g++ -std=c++14"` or passing the standard as a CXXFLAGS does work.



---

archive/issue_comments_448744.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-05-09T10:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448744",
    "user": "mjo"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_448745.json:
```json
{
    "body": "I'll change this to accept only 1.7.0.1 for now, since the simplification changes are likely to stick around.",
    "created_at": "2021-05-09T10:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448745",
    "user": "mjo"
}
```

I'll change this to accept only 1.7.0.1 for now, since the simplification changes are likely to stick around.



---

archive/issue_comments_448746.json:
```json
{
    "body": "Oh, they all return the same version number.",
    "created_at": "2021-05-09T10:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448746",
    "user": "mjo"
}
```

Oh, they all return the same version number.



---

archive/issue_comments_448747.json:
```json
{
    "body": "Why not just modify the tests so they pass with both versions? IMHO a slight change in output format shouldn't block using a system package. And some of these tests already have a very generic expected output:\n\n```\nFile \"/usr/lib/python3.9/site-packages/sage/interfaces/giac.py\", line 609, in sage.interfaces.giac.Giac._eval_line\nFailed example:\n    giac(h)\nExpected:\n    12*(...)\n```\n",
    "created_at": "2021-05-09T10:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448747",
    "user": "arojas"
}
```

Why not just modify the tests so they pass with both versions? IMHO a slight change in output format shouldn't block using a system package. And some of these tests already have a very generic expected output:

```
File "/usr/lib/python3.9/site-packages/sage/interfaces/giac.py", line 609, in sage.interfaces.giac.Giac._eval_line
Failed example:
    giac(h)
Expected:
    12*(...)
```




---

archive/issue_comments_448748.json:
```json
{
    "body": "Replying to [comment:14 arojas]:\n> Why not just modify the tests so they pass with both versions?\n\nI came to this same conclusion a few seconds ago =)\n\nFirst I have to update our Gentoo package to 1.7.0.5 so that I can see the new output and fix the c++17 issue, but then I'll update this branch with tests that work with all versions.",
    "created_at": "2021-05-09T10:49:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448748",
    "user": "mjo"
}
```

Replying to [comment:14 arojas]:
> Why not just modify the tests so they pass with both versions?

I came to this same conclusion a few seconds ago =)

First I have to update our Gentoo package to 1.7.0.5 so that I can see the new output and fix the c++17 issue, but then I'll update this branch with tests that work with all versions.



---

archive/issue_comments_448749.json:
```json
{
    "body": "The bump is trivial. c++17 is probably a can of worms.",
    "created_at": "2021-05-09T10:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448749",
    "user": "fbissey"
}
```

The bump is trivial. c++17 is probably a can of worms.



---

archive/issue_comments_448750.json:
```json
{
    "body": "By \"fix\" I mean `append-cxxflags -std=c++14`",
    "created_at": "2021-05-09T10:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448750",
    "user": "mjo"
}
```

By "fix" I mean `append-cxxflags -std=c++14`



---

archive/issue_comments_448751.json:
```json
{
    "body": "Yes, I did that in the overlay. A bit ham-fisted but it basically works.",
    "created_at": "2021-05-09T10:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448751",
    "user": "fbissey"
}
```

Yes, I did that in the overlay. A bit ham-fisted but it basically works.



---

archive/issue_comments_448752.json:
```json
{
    "body": "Replying to [comment:14 arojas]:\n> Why not just modify the tests so they pass with both versions? IMHO a slight change in output format shouldn't block using a system package. And some of these tests already have a very generic expected output:\n> {{{\n> File \"/usr/lib/python3.9/site-packages/sage/interfaces/giac.py\", line 609, in sage.interfaces.giac.Giac._eval_line\n> Failed example:\n>     giac(h)\n> Expected:\n>     12*(...)\n> }}}\n\nThis is not such a great example anyway:\n\n\n```\nsage: f = 1/x*((-2*x^(1/3)+1)^(1/4))^3                                                                                                                                       \nsage: integrate(f,x,algorithm='maxima')(x=1).n()                                                                                                                             \n-0.760158905420130 + 10.1849368661895*I\nsage: integrate(f,x,algorithm='sympy')(x=1).n()                                                                                                                              \n-10.1849368661895 + 10.1849368661895*I\nsage: integrate(f,x,algorithm='giac')(x=1).n()                                                                                                                               \n-0.760158905420130 + 4.29445064070865*I\n```\n\n\nI think I'll replace it with an integral that I can do in my head.",
    "created_at": "2021-05-10T12:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448752",
    "user": "mjo"
}
```

Replying to [comment:14 arojas]:
> Why not just modify the tests so they pass with both versions? IMHO a slight change in output format shouldn't block using a system package. And some of these tests already have a very generic expected output:
> {{{
> File "/usr/lib/python3.9/site-packages/sage/interfaces/giac.py", line 609, in sage.interfaces.giac.Giac._eval_line
> Failed example:
>     giac(h)
> Expected:
>     12*(...)
> }}}

This is not such a great example anyway:


```
sage: f = 1/x*((-2*x^(1/3)+1)^(1/4))^3                                                                                                                                       
sage: integrate(f,x,algorithm='maxima')(x=1).n()                                                                                                                             
-0.760158905420130 + 10.1849368661895*I
sage: integrate(f,x,algorithm='sympy')(x=1).n()                                                                                                                              
-10.1849368661895 + 10.1849368661895*I
sage: integrate(f,x,algorithm='giac')(x=1).n()                                                                                                                               
-0.760158905420130 + 4.29445064070865*I
```


I think I'll replace it with an integral that I can do in my head.



---

archive/issue_comments_448753.json:
```json
{
    "body": "Replying to [comment:19 mjo]:\n> {{{\n> sage: f = 1/x*((-2*x<sup>(1/3)+1)</sup>(1/4))^3                                                                                                                                       \n> sage: integrate(f,x,algorithm='maxima')(x=1).n()                                                                                                                             \n> -0.760158905420130 + 10.1849368661895*I\n> sage: integrate(f,x,algorithm='sympy')(x=1).n()                                                                                                                              \n> -10.1849368661895 + 10.1849368661895*I\n> sage: integrate(f,x,algorithm='giac')(x=1).n()                                                                                                                               \n> -0.760158905420130 + 4.29445064070865*I\n> }}}\n\n```\nsage: integrate(f,x,algorithm='fricas')(x=1).n()\n-0.760158905420130 + 10.1849368661895*I\n```\n",
    "created_at": "2021-05-10T15:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448753",
    "user": "@sheerluck"
}
```

Replying to [comment:19 mjo]:
> {{{
> sage: f = 1/x*((-2*x<sup>(1/3)+1)</sup>(1/4))^3                                                                                                                                       
> sage: integrate(f,x,algorithm='maxima')(x=1).n()                                                                                                                             
> -0.760158905420130 + 10.1849368661895*I
> sage: integrate(f,x,algorithm='sympy')(x=1).n()                                                                                                                              
> -10.1849368661895 + 10.1849368661895*I
> sage: integrate(f,x,algorithm='giac')(x=1).n()                                                                                                                               
> -0.760158905420130 + 4.29445064070865*I
> }}}

```
sage: integrate(f,x,algorithm='fricas')(x=1).n()
-0.760158905420130 + 10.1849368661895*I
```




---

archive/issue_comments_448754.json:
```json
{
    "body": "If I understand correctly, you are evaluating an antiderivative at x=1 and you get an approximation. I do not understand how this test can be meaningful, since an antiderivative is defined up to a constant. One could argue it should stay the same for a given CAS, but that's not true, I made some improvements in symbolic integration recently in giac, and that means sometimes that the algorithm changes and the antiderivative expression too.",
    "created_at": "2021-05-10T17:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448754",
    "user": "parisse"
}
```

If I understand correctly, you are evaluating an antiderivative at x=1 and you get an approximation. I do not understand how this test can be meaningful, since an antiderivative is defined up to a constant. One could argue it should stay the same for a given CAS, but that's not true, I made some improvements in symbolic integration recently in giac, and that means sometimes that the algorithm changes and the antiderivative expression too.



---

archive/issue_comments_448755.json:
```json
{
    "body": "I'm not blaming giac for anything here. The existing test was a bad choice:\n\n1. It was testing the exact string form of an indefinite integral, which, as you note, is unreliable for many reasons.\n2. The results of that indefinite integral do not agree (even up to a constant) between the various integration engines we have, so who knows if \"expected\" output is correct.\n\nMy use of `(x=1).n()` just makes it clear that the answers are different, since the resulting expression is rather ugly.",
    "created_at": "2021-05-10T18:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448755",
    "user": "mjo"
}
```

I'm not blaming giac for anything here. The existing test was a bad choice:

1. It was testing the exact string form of an indefinite integral, which, as you note, is unreliable for many reasons.
2. The results of that indefinite integral do not agree (even up to a constant) between the various integration engines we have, so who knows if "expected" output is correct.

My use of `(x=1).n()` just makes it clear that the answers are different, since the resulting expression is rather ugly.



---

archive/issue_comments_448756.json:
```json
{
    "body": "A more meaningful test would be F=integrate(f) then simplify(diff(F)-f). I have added some examples in the check subdirectory of giac, from the independent integrals testsuite from [https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2](https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2)",
    "created_at": "2021-05-10T19:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448756",
    "user": "parisse"
}
```

A more meaningful test would be F=integrate(f) then simplify(diff(F)-f). I have added some examples in the check subdirectory of giac, from the independent integrals testsuite from [https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2](https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2)



---

archive/issue_comments_448757.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-05-11T12:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448757",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448758.json:
```json
{
    "body": "Replying to [comment:23 parisse]:\n> A more meaningful test would be F=integrate(f) then simplify(diff(F)-f). I have added some examples in the check subdirectory of giac, from the independent integrals testsuite from [https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2](https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2)\n\nThe call to `simplify()` takes ages in this case. Since the point of that test is to check that we can pass a string to `giac()`, I changed the example to `sin(x)^2 + cos(x)^2` and have compared the result (`x`) as a symbolic expression.",
    "created_at": "2021-05-11T12:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448758",
    "user": "mjo"
}
```

Replying to [comment:23 parisse]:
> A more meaningful test would be F=integrate(f) then simplify(diff(F)-f). I have added some examples in the check subdirectory of giac, from the independent integrals testsuite from [https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2](https://www.12000.org/my_notes/CAS_integration_tests/reports/rubi_4_16_1_graded/inch1.htm#x2-30001.2)

The call to `simplify()` takes ages in this case. Since the point of that test is to check that we can pass a string to `giac()`, I changed the example to `sin(x)^2 + cos(x)^2` and have compared the result (`x`) as a symbolic expression.



---

archive/issue_comments_448759.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-05-11T12:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448759",
    "user": "mjo"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_448760.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-11T22:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448760",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448761.json:
```json
{
    "body": "lgtm",
    "created_at": "2021-05-11T22:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448761",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_448762.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31357#issuecomment-448762",
    "user": "vbraun"
}
```

Resolution: fixed
