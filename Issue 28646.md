# Issue 28646: update pkgconfig to version 1.5.1

archive/issues_028646.json:
```json
{
    "body": "CC:  fbissey embray thansen infinity0 isuruf mkoeppe\n\nthe current version is buggy, as we found out on #27870\n\nIssue created by migration from https://trac.sagemath.org/ticket/28883\n\n",
    "created_at": "2019-12-14T02:26:26Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "update pkgconfig to version 1.5.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28646",
    "user": "dimpase"
}
```
CC:  fbissey embray thansen infinity0 isuruf mkoeppe

the current version is buggy, as we found out on #27870

Issue created by migration from https://trac.sagemath.org/ticket/28883





---

archive/issue_comments_404499.json:
```json
{
    "body": "I found adding `setup.py` into the \"orig\" tarball rather than into debian/patches rather unusual.",
    "created_at": "2019-12-14T09:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404499",
    "user": "dimpase"
}
```

I found adding `setup.py` into the "orig" tarball rather than into debian/patches rather unusual.



---

archive/issue_comments_404500.json:
```json
{
    "body": "That `poetry` stuff is really a replacement for `pip`. And from where I see it, it can only fully replace superficially simple `setup.py` files. And it probably can generate such simple `setup.py` file, although I cannot see that in the Readme. And to be able to do what it does, it must be able to process complicated `setup.py` just fine, since it will install stuff that was never prepared for poetry if I am not mistaken.\n\nAnyway that's outside of the scope of the ticket. But one more of this things to potentially deal with :(",
    "created_at": "2019-12-14T09:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404500",
    "user": "fbissey"
}
```

That `poetry` stuff is really a replacement for `pip`. And from where I see it, it can only fully replace superficially simple `setup.py` files. And it probably can generate such simple `setup.py` file, although I cannot see that in the Readme. And to be able to do what it does, it must be able to process complicated `setup.py` just fine, since it will install stuff that was never prepared for poetry if I am not mistaken.

Anyway that's outside of the scope of the ticket. But one more of this things to potentially deal with :(



---

archive/issue_comments_404501.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-14T10:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404501",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_404502.json:
```json
{
    "body": "I guess poetry generates setup.py files as a part of its pypi deployment feature.",
    "created_at": "2019-12-14T10:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404502",
    "user": "dimpase"
}
```

I guess poetry generates setup.py files as a part of its pypi deployment feature.



---

archive/issue_comments_404503.json:
```json
{
    "body": "[ A stupidity. Sorry for the noise ... ]",
    "created_at": "2019-12-14T16:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404503",
    "user": "charpent"
}
```

[ A stupidity. Sorry for the noise ... ]



---

archive/issue_comments_404504.json:
```json
{
    "body": "Replying to [comment:6 charpent]:\n> [ A stupidity. Sorry for the noise ... ]\n\n[ After re-checking the setup... ] This doesn't seem to be effective. I still get the systemwide pkg-config:\n\n\n```\ncharpent@zen-book-flip:/usr/local/sage-9$ git status\nSur la branche t/28883/packages/pkgconfig151\nVotre branche est \u00e0 jour avec 'trac/u/dimpase/packages/pkgconfig151'.\n\nrien \u00e0 valider, la copie de travail est propre\ncharpent@zen-book-flip:/usr/local/sage-9$ ./sage -sh\n\nStarting subshell with Sage environment variables set.  Don't forget\nto exit when you are done.  Beware:\n * Do not do anything with other copies of Sage on your system.\n * Do not use this for installing Sage packages using \"sage -i\" or for\n   running \"make\" at Sage's root directory.  These should be done\n   outside the Sage shell.\n\nBypassing shell configuration files...\n\nNote: SAGE_ROOT=/usr/local/sage-9\n(sage-sh) charpent@zen-book-flip:sage-9$ command -v pkg-config\n/usr/bin/pkg-config\n(sage-sh) charpent@zen-book-flip:sage-9$ pkg-config --version\n0.29\n(sage-sh) charpent@zen-book-flip:sage-9$ exit\nexit\nExited Sage subshell.\n```\n",
    "created_at": "2019-12-14T16:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404504",
    "user": "charpent"
}
```

Replying to [comment:6 charpent]:
> [ A stupidity. Sorry for the noise ... ]

[ After re-checking the setup... ] This doesn't seem to be effective. I still get the systemwide pkg-config:


```
charpent@zen-book-flip:/usr/local/sage-9$ git status
Sur la branche t/28883/packages/pkgconfig151
Votre branche est à jour avec 'trac/u/dimpase/packages/pkgconfig151'.

rien à valider, la copie de travail est propre
charpent@zen-book-flip:/usr/local/sage-9$ ./sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/usr/local/sage-9
(sage-sh) charpent@zen-book-flip:sage-9$ command -v pkg-config
/usr/bin/pkg-config
(sage-sh) charpent@zen-book-flip:sage-9$ pkg-config --version
0.29
(sage-sh) charpent@zen-book-flip:sage-9$ exit
exit
Exited Sage subshell.
```




---

archive/issue_comments_404505.json:
```json
{
    "body": "this is a Python interface to pkg-config.\nSo you need to `import pkgconfig` in Sage's Python to see it in action.",
    "created_at": "2019-12-14T16:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404505",
    "user": "dimpase"
}
```

this is a Python interface to pkg-config.
So you need to `import pkgconfig` in Sage's Python to see it in action.



---

archive/issue_comments_404506.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-15T01:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404506",
    "user": "isuruf"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404507.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-17T22:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404507",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_404508.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2019-12-21T11:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404508",
    "user": "vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_404509.json:
```json
{
    "body": "This breaks on OSX:\n\n```\n[sagelib-9.0.beta9] Traceback (most recent call last):\n[sagelib-9.0.beta9]   File \"setup.py\", line 72, in <module>\n[sagelib-9.0.beta9]     from module_list import ext_modules, library_order\n[sagelib-9.0.beta9]   File \"/Users/buildbot-sage/slave/sage_git/build/src/module_list.py\", line 42, in <module>\n[sagelib-9.0.beta9]     zlib_pc = pkgconfig.parse('zlib')\n[sagelib-9.0.beta9]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py\", line 248, in parse\n[sagelib-9.0.beta9]     _raise_if_not_exists(package)\n[sagelib-9.0.beta9]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py\", line 103, in _raise_if_not_exists\n[sagelib-9.0.beta9]     raise PackageNotFoundError(package)\n[sagelib-9.0.beta9] pkgconfig.pkgconfig.PackageNotFoundError: zlib not found\n[sagelib-9.0.beta9] ************************************************************************\n[sagelib-9.0.beta9] Error building the Sage library\n[sagelib-9.0.beta9] ************************************************************************\n```\n",
    "created_at": "2019-12-21T11:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404509",
    "user": "vbraun"
}
```

This breaks on OSX:

```
[sagelib-9.0.beta9] Traceback (most recent call last):
[sagelib-9.0.beta9]   File "setup.py", line 72, in <module>
[sagelib-9.0.beta9]     from module_list import ext_modules, library_order
[sagelib-9.0.beta9]   File "/Users/buildbot-sage/slave/sage_git/build/src/module_list.py", line 42, in <module>
[sagelib-9.0.beta9]     zlib_pc = pkgconfig.parse('zlib')
[sagelib-9.0.beta9]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 248, in parse
[sagelib-9.0.beta9]     _raise_if_not_exists(package)
[sagelib-9.0.beta9]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
[sagelib-9.0.beta9]     raise PackageNotFoundError(package)
[sagelib-9.0.beta9] pkgconfig.pkgconfig.PackageNotFoundError: zlib not found
[sagelib-9.0.beta9] ************************************************************************
[sagelib-9.0.beta9] Error building the Sage library
[sagelib-9.0.beta9] ************************************************************************
```




---

archive/issue_comments_404510.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2019-12-21T11:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404510",
    "user": "vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_404511.json:
```json
{
    "body": "probably buildbot had a workaround for the buggy package?",
    "created_at": "2019-12-21T13:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404511",
    "user": "dimpase"
}
```

probably buildbot had a workaround for the buggy package?



---

archive/issue_comments_404512.json:
```json
{
    "body": "isn't the !Sage/Python environment of that buildbot broken?\nOne should have\n\n```\nsage: import pkgconfig\nsage: pkgconfig.parse('zlib')\ndefaultdict(<class 'list'>, {'libraries': ['z']})\n```\n",
    "created_at": "2019-12-21T13:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404512",
    "user": "dimpase"
}
```

isn't the !Sage/Python environment of that buildbot broken?
One should have

```
sage: import pkgconfig
sage: pkgconfig.parse('zlib')
defaultdict(<class 'list'>, {'libraries': ['z']})
```




---

archive/issue_comments_404513.json:
```json
{
    "body": "It works for me on OS X 10.15.2.",
    "created_at": "2019-12-21T20:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404513",
    "user": "jhpalmieri"
}
```

It works for me on OS X 10.15.2.



---

archive/issue_comments_404514.json:
```json
{
    "body": "Turns out #27870 is the culprit...",
    "created_at": "2019-12-22T15:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404514",
    "user": "vbraun"
}
```

Turns out #27870 is the culprit...



---

archive/issue_comments_404515.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-22T15:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404515",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_404516.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-22T15:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404516",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404517.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-12-22T15:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404517",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_404518.json:
```json
{
    "body": "Oh just noticed that this ticket is merged into #27870",
    "created_at": "2019-12-22T15:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404518",
    "user": "vbraun"
}
```

Oh just noticed that this ticket is merged into #27870



---

archive/issue_comments_404519.json:
```json
{
    "body": "To me, it looks like a Python with broken zlib module. Nothing to do with pkgconfig.\n\nYes, it could also be that local/lib/pkgconfig/ contents are somehow broken and thus\nbreak Python's pkgconfig.\n\nWas it a build from scratch? If not, stale things in local/lib/pkgconfig/  may break stuff.",
    "created_at": "2019-12-22T15:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404519",
    "user": "dimpase"
}
```

To me, it looks like a Python with broken zlib module. Nothing to do with pkgconfig.

Yes, it could also be that local/lib/pkgconfig/ contents are somehow broken and thus
break Python's pkgconfig.

Was it a build from scratch? If not, stale things in local/lib/pkgconfig/  may break stuff.



---

archive/issue_comments_404520.json:
```json
{
    "body": "On Catalina, there is no zlib in /usr/lib/pkgconfig and we don't build our own zlib with #27870.\n\n```\nbuildbot-sage@osx build % ./sage -sh -c 'pkgconf --cflags zlib'\n\nPackage zlib was not found in the pkg-config search path.\nPerhaps you should add the directory containing `zlib.pc'\nto the PKG_CONFIG_PATH environment variable\nPackage 'zlib', required by 'world', not found\n```\n\nAll builds from scratch.",
    "created_at": "2019-12-22T15:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404520",
    "user": "vbraun"
}
```

On Catalina, there is no zlib in /usr/lib/pkgconfig and we don't build our own zlib with #27870.

```
buildbot-sage@osx build % ./sage -sh -c 'pkgconf --cflags zlib'

Package zlib was not found in the pkg-config search path.
Perhaps you should add the directory containing `zlib.pc'
to the PKG_CONFIG_PATH environment variable
Package 'zlib', required by 'world', not found
```

All builds from scratch.



---

archive/issue_comments_404521.json:
```json
{
    "body": "The version bump here should be ok, its #27870 that is borked",
    "created_at": "2019-12-22T15:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404521",
    "user": "vbraun"
}
```

The version bump here should be ok, its #27870 that is borked



---

archive/issue_comments_404522.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-12-22T15:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404522",
    "user": "vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_404523.json:
```json
{
    "body": "No, #27870 is fine.\n\nwhat's \"borked\" is that the new pkgconfig v1.5.1 throws an error if there is no `.pc` file. E.g. on this branch one sees\n\n```\nsage: import pkgconfig\nsage: pkgconfig.parse(\"uhohoh\")\n---------------------------------------------------------------------------\nPackageNotFoundError                      Traceback (most recent call last)\n<ipython-input-2-d927c49e8798> in <module>()\n----> 1 pkgconfig.parse(\"uhohoh\")\n\n/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py in parse(packages, static)\n    246     \"\"\"\n    247     for package in packages.split():\n--> 248         _raise_if_not_exists(package)\n    249 \n    250     out = _query(packages, *_build_options('--cflags --libs', static=static))\n\n/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py in _raise_if_not_exists(package)\n    101 def _raise_if_not_exists(package):\n    102     if not exists(package):\n--> 103         raise PackageNotFoundError(package)\n    104 \n    105 \n\nPackageNotFoundError: uhohoh not found\nsage: \n```\n\n\nbut the previous version merrily returns some stuff:\n\n```\nsage: pkgconfig.parse(\"uhohoh\")\ndefaultdict(<type 'list'>, {'define_macros': []})\n```\n\n\nAll the systems this was tested apparently had `zlib.pc` somewhere, and so it worked.\nYour box does not have it, and so an error is thrown.\n\nOK, would it be easier if this is fixed (trivially) on a followup ticket rather than here?",
    "created_at": "2019-12-22T15:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404523",
    "user": "dimpase"
}
```

No, #27870 is fine.

what's "borked" is that the new pkgconfig v1.5.1 throws an error if there is no `.pc` file. E.g. on this branch one sees

```
sage: import pkgconfig
sage: pkgconfig.parse("uhohoh")
---------------------------------------------------------------------------
PackageNotFoundError                      Traceback (most recent call last)
<ipython-input-2-d927c49e8798> in <module>()
----> 1 pkgconfig.parse("uhohoh")

/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py in parse(packages, static)
    246     """
    247     for package in packages.split():
--> 248         _raise_if_not_exists(package)
    249 
    250     out = _query(packages, *_build_options('--cflags --libs', static=static))

/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py in _raise_if_not_exists(package)
    101 def _raise_if_not_exists(package):
    102     if not exists(package):
--> 103         raise PackageNotFoundError(package)
    104 
    105 

PackageNotFoundError: uhohoh not found
sage: 
```


but the previous version merrily returns some stuff:

```
sage: pkgconfig.parse("uhohoh")
defaultdict(<type 'list'>, {'define_macros': []})
```


All the systems this was tested apparently had `zlib.pc` somewhere, and so it worked.
Your box does not have it, and so an error is thrown.

OK, would it be easier if this is fixed (trivially) on a followup ticket rather than here?



---

archive/issue_comments_404524.json:
```json
{
    "body": "Feel free to fix it here since there are already a number of tickets that depend on this one that can't be merged until the issue is resolved",
    "created_at": "2019-12-22T16:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404524",
    "user": "vbraun"
}
```

Feel free to fix it here since there are already a number of tickets that depend on this one that can't be merged until the issue is resolved



---

archive/issue_comments_404525.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-12-22T16:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404525",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_404526.json:
```json
{
    "body": "imho the zlib spkg-configure.m4 should just ensure that a zlib.pc file can be found (i.e. use PKG_CHECK_MODULES)",
    "created_at": "2019-12-22T16:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404526",
    "user": "vbraun"
}
```

imho the zlib spkg-configure.m4 should just ensure that a zlib.pc file can be found (i.e. use PKG_CHECK_MODULES)



---

archive/issue_comments_404527.json:
```json
{
    "body": "The whole thing about assuming that `zlib.pc` exists was iffy since #26286 - that's basically where the bug has slipped in. \n\nIt \"worked\" as the absense of `zlib.pc` was ignored by old Python's `pkgconfig`. \n\nThere is no actual need to insist on `zlib.pc` present, as Apple's implementation of zlib is good enough to be used.",
    "created_at": "2019-12-22T16:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404527",
    "user": "dimpase"
}
```

The whole thing about assuming that `zlib.pc` exists was iffy since #26286 - that's basically where the bug has slipped in. 

It "worked" as the absense of `zlib.pc` was ignored by old Python's `pkgconfig`. 

There is no actual need to insist on `zlib.pc` present, as Apple's implementation of zlib is good enough to be used.



---

archive/issue_comments_404528.json:
```json
{
    "body": "Indeed its never actually necessary to have .pc files you can always kludge it by hand and fudge cflags/libs on all supported platforms. Its just not a sane/maintainable/scalable system of working with shared libraries.\n\nIf you want to save OSX users from having to build zlib then we should just provide an appropriate zlib.pc on that particular snowflake of a platform.",
    "created_at": "2019-12-22T16:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404528",
    "user": "vbraun"
}
```

Indeed its never actually necessary to have .pc files you can always kludge it by hand and fudge cflags/libs on all supported platforms. Its just not a sane/maintainable/scalable system of working with shared libraries.

If you want to save OSX users from having to build zlib then we should just provide an appropriate zlib.pc on that particular snowflake of a platform.



---

archive/issue_comments_404529.json:
```json
{
    "body": "I'll provide workaround here, and properly deal with generation on `zlib.pc` on #28906.\n\nFor the problem at hand it'd suffice just to avoid an expection, and fake the output of\n`pkgconfig.parse()` if need be.",
    "created_at": "2019-12-22T16:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404529",
    "user": "dimpase"
}
```

I'll provide workaround here, and properly deal with generation on `zlib.pc` on #28906.

For the problem at hand it'd suffice just to avoid an expection, and fake the output of
`pkgconfig.parse()` if need be.



---

archive/issue_comments_404530.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-12-22T17:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404530",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_404531.json:
```json
{
    "body": "This should fix the OSX issue, IMHO (can't test on OSX, though)",
    "created_at": "2019-12-22T17:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404531",
    "user": "dimpase"
}
```

This should fix the OSX issue, IMHO (can't test on OSX, though)



---

archive/issue_comments_404532.json:
```json
{
    "body": "Oh blast, need to rename this branch...",
    "created_at": "2019-12-22T17:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404532",
    "user": "dimpase"
}
```

Oh blast, need to rename this branch...



---

archive/issue_comments_404533.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-22T17:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404533",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_404534.json:
```json
{
    "body": "potentially, there could also be a problem with libpng.pc, for which ./configure does not check for/does not insist on its presense. But it comes before zlib.pc is tested, so that's apparently not blocking. I'll change #28906 to deal with these too.",
    "created_at": "2019-12-23T04:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404534",
    "user": "dimpase"
}
```

potentially, there could also be a problem with libpng.pc, for which ./configure does not check for/does not insist on its presense. But it comes before zlib.pc is tested, so that's apparently not blocking. I'll change #28906 to deal with these too.



---

archive/issue_comments_404535.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-12-23T11:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404535",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_404536.json:
```json
{
    "body": "That should be `pkgconfig.PackageNotFoundError`, otherwise you'll just get a `NameError` raised during exception handling.  Please fix that and rebase to squash the fix.",
    "created_at": "2019-12-23T11:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404536",
    "user": "embray"
}
```

That should be `pkgconfig.PackageNotFoundError`, otherwise you'll just get a `NameError` raised during exception handling.  Please fix that and rebase to squash the fix.



---

archive/issue_comments_404537.json:
```json
{
    "body": "I'm a little confused here. On OS X, when I run the command in comment:21 (`./sage -sh -c 'pkgconf --cflags zlib'`), I get the same output as given there, but the build succeeds for me. Why does it fail on some OS X systems and succeed on others? (It worked for me with the current branch but also the earlier one.)",
    "created_at": "2019-12-23T19:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404537",
    "user": "jhpalmieri"
}
```

I'm a little confused here. On OS X, when I run the command in comment:21 (`./sage -sh -c 'pkgconf --cflags zlib'`), I get the same output as given there, but the build succeeds for me. Why does it fail on some OS X systems and succeed on others? (It worked for me with the current branch but also the earlier one.)



---

archive/issue_comments_404538.json:
```json
{
    "body": "Replying to [comment:34 jhpalmieri]:\n> I'm a little confused here. On OS X, when I run the command in comment:21 (`./sage -sh -c 'pkgconf --cflags zlib'`), I get the same output as given there, but the build succeeds for me. Why does it fail on some OS X systems and succeed on others? (It worked for me with the current branch but also the earlier one.)\n\nHow about the commands in comment:15 ?\n\n```\nsage: import pkgconfig\nsage: pkgconfig.parse('zlib')\n```\n",
    "created_at": "2019-12-24T02:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404538",
    "user": "dimpase"
}
```

Replying to [comment:34 jhpalmieri]:
> I'm a little confused here. On OS X, when I run the command in comment:21 (`./sage -sh -c 'pkgconf --cflags zlib'`), I get the same output as given there, but the build succeeds for me. Why does it fail on some OS X systems and succeed on others? (It worked for me with the current branch but also the earlier one.)

How about the commands in comment:15 ?

```
sage: import pkgconfig
sage: pkgconfig.parse('zlib')
```




---

archive/issue_comments_404539.json:
```json
{
    "body": "With the current branch:\n\n```\nsage:  import pkgconfig\nsage: pkgconfig.parse('zlib')\ndefaultdict(<class 'list'>, {'libraries': ['z']})\n```\n",
    "created_at": "2019-12-24T02:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404539",
    "user": "jhpalmieri"
}
```

With the current branch:

```
sage:  import pkgconfig
sage: pkgconfig.parse('zlib')
defaultdict(<class 'list'>, {'libraries': ['z']})
```




---

archive/issue_comments_404540.json:
```json
{
    "body": "From reading https://github.com/matze/pkgconfig/blob/master/pkgconfig/pkgconfig.py\nit could happen that you have environment variable PKG_CONFIG defined, and its value will be used instead of `pkg-config` in your PATH.\n\nhttps://github.com/matze/pkgconfig/blob/a7108a65625a529dc1cf1b4779d23e5701f202dc/pkgconfig/pkgconfig.py#L108",
    "created_at": "2019-12-24T02:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404540",
    "user": "dimpase"
}
```

From reading https://github.com/matze/pkgconfig/blob/master/pkgconfig/pkgconfig.py
it could happen that you have environment variable PKG_CONFIG defined, and its value will be used instead of `pkg-config` in your PATH.

https://github.com/matze/pkgconfig/blob/a7108a65625a529dc1cf1b4779d23e5701f202dc/pkgconfig/pkgconfig.py#L108



---

archive/issue_comments_404541.json:
```json
{
    "body": "When I run Sage, it defines the environment variable\n\n```\nPKG_CONFIG_PATH=.../path/to/SAGE_ROOT/local/lib/pkgconfig\n```\n\nbut I don't have anything similar set myself. `export | grep PKG` returns nothing.",
    "created_at": "2019-12-24T03:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404541",
    "user": "jhpalmieri"
}
```

When I run Sage, it defines the environment variable

```
PKG_CONFIG_PATH=.../path/to/SAGE_ROOT/local/lib/pkgconfig
```

but I don't have anything similar set myself. `export | grep PKG` returns nothing.



---

archive/issue_comments_404542.json:
```json
{
    "body": "Is the output of \n\n```\nsage: import os\nsage: os.system(\"which pkg-config\")\n```\n\nthe same as of `which pkg-config` at `./sage -sh` prompt?\n\nAs well, please compare the value of env. var. `PKG_CONFIG_PATH` at the latter prompt with the output of \n\n```\nsage: os.environ.get('PKG_CONFIG_PATH', None)\n```\n",
    "created_at": "2019-12-24T03:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404542",
    "user": "dimpase"
}
```

Is the output of 

```
sage: import os
sage: os.system("which pkg-config")
```

the same as of `which pkg-config` at `./sage -sh` prompt?

As well, please compare the value of env. var. `PKG_CONFIG_PATH` at the latter prompt with the output of 

```
sage: os.environ.get('PKG_CONFIG_PATH', None)
```




---

archive/issue_comments_404543.json:
```json
{
    "body": "`which pkg-config` points to the homebrew installation, `/usr/local/bin/pkg-config` in both invocations.\n\n```\nsage: os.environ.get('PKG_CONFIG_PATH', None)\n'/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/pkgconfig'\nsage: sage.env.var('PKG_CONFIG_PATH')\nsage:\n```\n\nand after running `sage --sh`:\n\n```\n$ echo $PKG_CONFIG_PATH\n/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/pkgconfig\n```\n\n('/Users/palmieri/Desktop/Sage_stuff/git/sage/` is SAGE_ROOT.)",
    "created_at": "2019-12-24T04:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404543",
    "user": "jhpalmieri"
}
```

`which pkg-config` points to the homebrew installation, `/usr/local/bin/pkg-config` in both invocations.

```
sage: os.environ.get('PKG_CONFIG_PATH', None)
'/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/pkgconfig'
sage: sage.env.var('PKG_CONFIG_PATH')
sage:
```

and after running `sage --sh`:

```
$ echo $PKG_CONFIG_PATH
/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/pkgconfig
```

('/Users/palmieri/Desktop/Sage_stuff/git/sage/` is SAGE_ROOT.)



---

archive/issue_comments_404544.json:
```json
{
    "body": "So maybe it's the presence of the homebrew `pkg-config` that makes this system behave differently from Volker's buildbot.",
    "created_at": "2019-12-24T04:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404544",
    "user": "jhpalmieri"
}
```

So maybe it's the presence of the homebrew `pkg-config` that makes this system behave differently from Volker's buildbot.



---

archive/issue_comments_404545.json:
```json
{
    "body": "You probably have zlib installed from homebrew.\n\nWhat do you get with `pkg-config zlib --variable pcfiledir` ?",
    "created_at": "2019-12-24T04:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404545",
    "user": "isuruf"
}
```

You probably have zlib installed from homebrew.

What do you get with `pkg-config zlib --variable pcfiledir` ?



---

archive/issue_comments_404546.json:
```json
{
    "body": "Sage's Python has to dig up `zlib.pc` to read by `pkgconfig.parse()`, from somewhere.\n\nBy the way, I don't understand  `pkgconf` in `./sage -sh -c 'pkgconf --cflags zlib` ???\n\nit should be `pkg-config` \n\nI guess `pkgconf` is some \"unofficial\" name for `pkg-config`, used by Sage's `pkgconf` package, which installs `pkg-config`.",
    "created_at": "2019-12-24T04:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404546",
    "user": "dimpase"
}
```

Sage's Python has to dig up `zlib.pc` to read by `pkgconfig.parse()`, from somewhere.

By the way, I don't understand  `pkgconf` in `./sage -sh -c 'pkgconf --cflags zlib` ???

it should be `pkg-config` 

I guess `pkgconf` is some "unofficial" name for `pkg-config`, used by Sage's `pkgconf` package, which installs `pkg-config`.



---

archive/issue_comments_404547.json:
```json
{
    "body": "`pkgconf` and `pkg-config` are two different programs both of which does the same thing. `pkgconf` has a `pkg-config` symlink as well. (Think of `pkgconf` as MPIR built with GMP compat and `pkg-config` as GMP.)",
    "created_at": "2019-12-24T04:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404547",
    "user": "isuruf"
}
```

`pkgconf` and `pkg-config` are two different programs both of which does the same thing. `pkgconf` has a `pkg-config` symlink as well. (Think of `pkgconf` as MPIR built with GMP compat and `pkg-config` as GMP.)



---

archive/issue_comments_404548.json:
```json
{
    "body": "So you were confused by Volker's `pkgconf` invocation --- sorry, I should have noticed it earlier. I bet `./sage -sh -c 'pkg-config --libs zlib` has meaningful output with `-lz` in it.",
    "created_at": "2019-12-24T04:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404548",
    "user": "dimpase"
}
```

So you were confused by Volker's `pkgconf` invocation --- sorry, I should have noticed it earlier. I bet `./sage -sh -c 'pkg-config --libs zlib` has meaningful output with `-lz` in it.



---

archive/issue_comments_404549.json:
```json
{
    "body": "Replying to [comment:42 isuruf]:\n> You probably have zlib installed from homebrew.\n> \n> What do you get with `pkg-config zlib --variable pcfiledir` ?\n\n`/usr/local/Homebrew/Library/Homebrew/os/mac/pkgconfig/10.15`. Also\n\n```\n$ ./sage -sh -c 'pkg-config --libs zlib'\n-lz\n```\n",
    "created_at": "2019-12-24T04:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404549",
    "user": "jhpalmieri"
}
```

Replying to [comment:42 isuruf]:
> You probably have zlib installed from homebrew.
> 
> What do you get with `pkg-config zlib --variable pcfiledir` ?

`/usr/local/Homebrew/Library/Homebrew/os/mac/pkgconfig/10.15`. Also

```
$ ./sage -sh -c 'pkg-config --libs zlib'
-lz
```




---

archive/issue_comments_404550.json:
```json
{
    "body": "What does `pkg-config zlib --variable libdir` give you?",
    "created_at": "2019-12-24T04:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404550",
    "user": "isuruf"
}
```

What does `pkg-config zlib --variable libdir` give you?



---

archive/issue_comments_404551.json:
```json
{
    "body": "Replying to [comment:46 jhpalmieri]:\n> Replying to [comment:42 isuruf]:\n> > You probably have zlib installed from homebrew.\n> > \n> > What do you get with `pkg-config zlib --variable pcfiledir` ?\n> \n> `/usr/local/Homebrew/Library/Homebrew/os/mac/pkgconfig/10.15`. Also\n> {{{\n> $ ./sage -sh -c 'pkg-config --libs zlib'\n> -lz\n> }}}\n\nso it appears that you use zlib provided by Homebrew, which does supply zlib.pc, so everything works as it should. (I don't know whether they install a real zlib, or just provide zlib.pc pointing to the MacOS native one, probably the former)",
    "created_at": "2019-12-24T04:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404551",
    "user": "dimpase"
}
```

Replying to [comment:46 jhpalmieri]:
> Replying to [comment:42 isuruf]:
> > You probably have zlib installed from homebrew.
> > 
> > What do you get with `pkg-config zlib --variable pcfiledir` ?
> 
> `/usr/local/Homebrew/Library/Homebrew/os/mac/pkgconfig/10.15`. Also
> {{{
> $ ./sage -sh -c 'pkg-config --libs zlib'
> -lz
> }}}

so it appears that you use zlib provided by Homebrew, which does supply zlib.pc, so everything works as it should. (I don't know whether they install a real zlib, or just provide zlib.pc pointing to the MacOS native one, probably the former)



---

archive/issue_comments_404552.json:
```json
{
    "body": "Replying to [comment:47 isuruf]:\n> What does `pkg-config zlib --variable libdir` give you?\n\n`/usr/lib`",
    "created_at": "2019-12-24T05:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404552",
    "user": "jhpalmieri"
}
```

Replying to [comment:47 isuruf]:
> What does `pkg-config zlib --variable libdir` give you?

`/usr/lib`



---

archive/issue_comments_404553.json:
```json
{
    "body": "For information on PEP517 and the whole `poetry` business of packaging https://blogs.gentoo.org/mgorny/2019/12/24/handling-pep-517-pyproject-toml-packages-in-gentoo/",
    "created_at": "2019-12-25T20:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404553",
    "user": "fbissey"
}
```

For information on PEP517 and the whole `poetry` business of packaging https://blogs.gentoo.org/mgorny/2019/12/24/handling-pep-517-pyproject-toml-packages-in-gentoo/



---

archive/issue_comments_404554.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-27T02:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404554",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404555.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-27T02:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404555",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_404556.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-12-27T02:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404556",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_404557.json:
```json
{
    "body": "I've tried #28906 but it is ugly as hell, so not sure whether it should be getting in. So this is the minimal (rebased) fix.",
    "created_at": "2019-12-27T02:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404557",
    "user": "dimpase"
}
```

I've tried #28906 but it is ugly as hell, so not sure whether it should be getting in. So this is the minimal (rebased) fix.



---

archive/issue_comments_404558.json:
```json
{
    "body": "Looks good and works well on macOS Catalina - after fixing #28676.",
    "created_at": "2019-12-28T03:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404558",
    "user": "mkoeppe"
}
```

Looks good and works well on macOS Catalina - after fixing #28676.



---

archive/issue_comments_404559.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-28T03:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404559",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404560.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-05T15:47:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404560",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_404561.json:
```json
{
    "body": "Follow-up on the poetry issue at #29810",
    "created_at": "2020-06-05T22:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404561",
    "user": "mkoeppe"
}
```

Follow-up on the poetry issue at #29810



---

archive/issue_comments_404562.json:
```json
{
    "body": "\"...and other forms of boredom advertised as poetry.\"",
    "created_at": "2020-06-12T09:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28646#issuecomment-404562",
    "user": "dimpase"
}
```

"...and other forms of boredom advertised as poetry."
