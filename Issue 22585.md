# Issue 22585: openblas from Cygwin's package deadloops after fork

archive/issues_022585.json:
```json
{
    "body": "After some pain and headscratching I see what's going on here.  Normally when I build Sage for Cygwin I use Cygwin's system liblapack0 package using `SAGE_ATLAS_LIB` and selecting `--with-blas=atlas` at configure time.\n\nThe `liblapack0` package provides *a* BLAS implementation, but I'm not exactly sure what.  I thought it was ATLAS but now I'm not sure (it might be the netlib version which would not be ideal).  In any case it *works* but I haven't done any performance comparisons.\n\nWhen you install the `liblapack0` package it installs the cygblas-0.dll in `/usr/lib/lapack` as well as an `/etc/profile.d/` script that appends `/usr/lib/lapack` to `$PATH` so that any `cygblas-0.dll` is found there.\n\n*However*, at some point I installed the Cygwin R package, which depends on Cygwin's openblas package which is actually the default BLAS on Cygwin (that is, it installs `cygblas-0.dll` to `/bin`.  Since this comes earlier on the path, this is the BLAS that gets used if it's installed.  That would be fine, except there is a problem with the package.  It is not configured to use pthreads, and instead uses OpenBLAS's Windows threading driver.  That works fine *until* you fork a process, at which case the entire threading state becomes invalid, but since the Windows threading driver doesn't know about fork it just carries on, and doesn't have enough error-handling to deal properly with this scenario.  Any attempt to perform a multi-threaded operation after a fork goes into a dead wait for a thread that doesn't exist to become available.  This is similar to the issue I described in #22694, though more severe since it just locks, rather than crashes.\n\nThis can be avoided a number of ways (I will also post something about this on the wiki):\n\n1. For now, definitely just don't install Cygwin's openblas package.\n2. Cygwin's openblas package should be fixed to be built with pthread support; I don't know why it isn't but I will report this...\n3. OpenBLAS could be fixed upstream to recognize building on Cygwin, and install post-fork handlers even when using the Windows threading driver (similar to what libgc does).\n4. Build either ATLAS or OpenBLAS in Sage and don't use the system package--in my experience this has generally worked too, though I haven't tested either one extensively.  I need to do more work with both and see what issues arise.  This option is certainly fine too, but it saves a lot of development time to use the system package.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22822\n\n",
    "created_at": "2017-04-17T15:51:09Z",
    "labels": [
        "component: porting: cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "openblas from Cygwin's package deadloops after fork",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22585",
    "user": "https://github.com/embray"
}
```
After some pain and headscratching I see what's going on here.  Normally when I build Sage for Cygwin I use Cygwin's system liblapack0 package using `SAGE_ATLAS_LIB` and selecting `--with-blas=atlas` at configure time.

The `liblapack0` package provides *a* BLAS implementation, but I'm not exactly sure what.  I thought it was ATLAS but now I'm not sure (it might be the netlib version which would not be ideal).  In any case it *works* but I haven't done any performance comparisons.

When you install the `liblapack0` package it installs the cygblas-0.dll in `/usr/lib/lapack` as well as an `/etc/profile.d/` script that appends `/usr/lib/lapack` to `$PATH` so that any `cygblas-0.dll` is found there.

*However*, at some point I installed the Cygwin R package, which depends on Cygwin's openblas package which is actually the default BLAS on Cygwin (that is, it installs `cygblas-0.dll` to `/bin`.  Since this comes earlier on the path, this is the BLAS that gets used if it's installed.  That would be fine, except there is a problem with the package.  It is not configured to use pthreads, and instead uses OpenBLAS's Windows threading driver.  That works fine *until* you fork a process, at which case the entire threading state becomes invalid, but since the Windows threading driver doesn't know about fork it just carries on, and doesn't have enough error-handling to deal properly with this scenario.  Any attempt to perform a multi-threaded operation after a fork goes into a dead wait for a thread that doesn't exist to become available.  This is similar to the issue I described in #22694, though more severe since it just locks, rather than crashes.

This can be avoided a number of ways (I will also post something about this on the wiki):

1. For now, definitely just don't install Cygwin's openblas package.
2. Cygwin's openblas package should be fixed to be built with pthread support; I don't know why it isn't but I will report this...
3. OpenBLAS could be fixed upstream to recognize building on Cygwin, and install post-fork handlers even when using the Windows threading driver (similar to what libgc does).
4. Build either ATLAS or OpenBLAS in Sage and don't use the system package--in my experience this has generally worked too, though I haven't tested either one extensively.  I need to do more work with both and see what issues arise.  This option is certainly fine too, but it saves a lot of development time to use the system package.

Issue created by migration from https://trac.sagemath.org/ticket/22822





---

archive/issue_comments_314778.json:
```json
{
    "body": "Finally also brought this up on Cygwin.  I meant to do that a long time ago, but it helps to have an actual patch to discuss.",
    "created_at": "2018-02-06T12:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22585#issuecomment-314778",
    "user": "https://github.com/embray"
}
```

Finally also brought this up on Cygwin.  I meant to do that a long time ago, but it helps to have an actual patch to discuss.



---

archive/issue_comments_314779.json:
```json
{
    "body": "Beware of conflicts with #24638.",
    "created_at": "2018-02-06T15:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22585#issuecomment-314779",
    "user": "https://github.com/jdemeyer"
}
```

Beware of conflicts with #24638.



---

archive/issue_comments_314780.json:
```json
{
    "body": "AFIACT there is no conflict.",
    "created_at": "2018-02-06T16:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22585#issuecomment-314780",
    "user": "https://github.com/embray"
}
```

AFIACT there is no conflict.



---

archive/issue_comments_314781.json:
```json
{
    "body": "FWIW I *think* this issue is fixed.  The bug in OpenBLAS has been long-since fixed, and the Cygwin package has been updated as well.\n\nWhat we don't have yet is getting Sage built against the system OpenBLAS.  Once that's done and confirmed working, we can definitely close this issue.",
    "created_at": "2021-03-10T15:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22585#issuecomment-314781",
    "user": "https://github.com/embray"
}
```

FWIW I *think* this issue is fixed.  The bug in OpenBLAS has been long-since fixed, and the Cygwin package has been updated as well.

What we don't have yet is getting Sage built against the system OpenBLAS.  Once that's done and confirmed working, we can definitely close this issue.
