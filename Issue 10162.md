# Issue 10162: make doc-html sometimes hangs after having finished

archive/issues_010162.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nKeywords: build\n\nThe following is a non-reproducible problem, but it happened at least twice for me:\nwhen building Sage from source using\n\n```\nexport MAKE=\"make -j8\"\n$MAKE\n```\n\nit can happen that `make` simply hangs forever after the message\n\n```\nBuild finished.  The built documents can be found in /mnt/usb1/scratch/jdemeyer/merger/sage-4.6.1.alpha0/devel/sage/doc/output/html/fr/a_tour_of_sage\n```\n\n\nPressing CTRL-C at this point gives\n\n```\nmake: *** [doc-html] Interrupt\n```\n\n\nI'm not sure whether the \"-j8\" option has anything to do with it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10163\n\n",
    "created_at": "2010-10-23T21:57:18Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "make doc-html sometimes hangs after having finished",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10162",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: GeorgSWeber

Keywords: build

The following is a non-reproducible problem, but it happened at least twice for me:
when building Sage from source using

```
export MAKE="make -j8"
$MAKE
```

it can happen that `make` simply hangs forever after the message

```
Build finished.  The built documents can be found in /mnt/usb1/scratch/jdemeyer/merger/sage-4.6.1.alpha0/devel/sage/doc/output/html/fr/a_tour_of_sage
```


Pressing CTRL-C at this point gives

```
make: *** [doc-html] Interrupt
```


I'm not sure whether the "-j8" option has anything to do with it.

Issue created by migration from https://trac.sagemath.org/ticket/10163





---

archive/issue_comments_102731.json:
```json
{
    "body": "Changing keywords from \"build\" to \"build Makefile\".",
    "created_at": "2010-12-19T13:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102731",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "build" to "build Makefile".



---

archive/issue_comments_102732.json:
```json
{
    "body": "This might be due to NFS (I know it happened on sage.math.washington.edu but I can't remember whether it ever happened on other machines).",
    "created_at": "2010-12-19T13:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102732",
    "user": "https://github.com/jdemeyer"
}
```

This might be due to NFS (I know it happened on sage.math.washington.edu but I can't remember whether it ever happened on other machines).



---

archive/issue_comments_102733.json:
```json
{
    "body": "I am getting more and more convinced that this is an NFS issue, so proposal to close this ticket as invalid.",
    "created_at": "2011-01-19T13:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102733",
    "user": "https://github.com/jdemeyer"
}
```

I am getting more and more convinced that this is an NFS issue, so proposal to close this ticket as invalid.



---

archive/issue_comments_102734.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-01-19T13:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102734",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_102735.json:
```json
{
    "body": "Just because NFS triggers it doesn't necessarily mean that its not a bug in Sage. I've never seen this issue, but then I never use high-latency filesystems. Can you run strace/gdb on the stuck process if you see it again? (use -p to attach to existing pid)",
    "created_at": "2011-03-02T10:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102735",
    "user": "https://github.com/vbraun"
}
```

Just because NFS triggers it doesn't necessarily mean that its not a bug in Sage. I've never seen this issue, but then I never use high-latency filesystems. Can you run strace/gdb on the stuck process if you see it again? (use -p to attach to existing pid)



---

archive/issue_comments_102736.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-03-02T10:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102736",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_102737.json:
```json
{
    "body": "Should there be some timeout setting in sage-cleaner?  If it has to wait too long, exit but print a warning message that there may be some stray processes which should be killed by hand?",
    "created_at": "2011-10-06T18:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102737",
    "user": "https://github.com/jhpalmieri"
}
```

Should there be some timeout setting in sage-cleaner?  If it has to wait too long, exit but print a warning message that there may be some stray processes which should be killed by hand?



---

archive/issue_comments_102738.json:
```json
{
    "body": "No the sage cleaner needs to stick around for as long as Sage is running. There might be a computation running that, after a long while, does a big `@`parallel loop and if nobody is cleaning up the filesystem will be very unhappy.",
    "created_at": "2011-10-06T19:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102738",
    "user": "https://github.com/vbraun"
}
```

No the sage cleaner needs to stick around for as long as Sage is running. There might be a computation running that, after a long while, does a big `@`parallel loop and if nobody is cleaning up the filesystem will be very unhappy.



---

archive/issue_comments_102739.json:
```json
{
    "body": "Does `sage-cleaner` actually run when you do `sage -docbuild ...` (which is called by `make doc-html`)?  It doesn't look like it to me.  It seems that `sage -docbuild all html` creates a bunch of temporary directories in `DOT_SAGE/temp/HOSTNAME`, and those aren't deleted until the next time I run Sage, when `sage-cleaner` actually runs.  So maybe the issue on this ticket isn't related to `sage-cleaner`.",
    "created_at": "2011-10-06T20:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102739",
    "user": "https://github.com/jhpalmieri"
}
```

Does `sage-cleaner` actually run when you do `sage -docbuild ...` (which is called by `make doc-html`)?  It doesn't look like it to me.  It seems that `sage -docbuild all html` creates a bunch of temporary directories in `DOT_SAGE/temp/HOSTNAME`, and those aren't deleted until the next time I run Sage, when `sage-cleaner` actually runs.  So maybe the issue on this ticket isn't related to `sage-cleaner`.



---

archive/issue_comments_102740.json:
```json
{
    "body": "Can you also add the content of `~/.sage/temp/HOSTNAME/` to the bug report? The sage cleaner lives on until it is empty...",
    "created_at": "2011-10-07T11:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102740",
    "user": "https://github.com/vbraun"
}
```

Can you also add the content of `~/.sage/temp/HOSTNAME/` to the bug report? The sage cleaner lives on until it is empty...



---

archive/issue_comments_102741.json:
```json
{
    "body": "It seems to have pulled itself through after a while.  Don't know why...",
    "created_at": "2011-10-07T12:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102741",
    "user": "https://github.com/jdemeyer"
}
```

It seems to have pulled itself through after a while.  Don't know why...



---

archive/issue_comments_102742.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> Can you also add the content of `~/.sage/temp/HOSTNAME/` to the bug report? The sage cleaner lives on until it is empty...\n\nWhat do mean with \"empty\"?  Does this mean that, if I have 10 copies of Sage running, the Sage cleaner will only exit if all those 10 copies of Sage exit?",
    "created_at": "2011-10-07T12:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102742",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 vbraun]:
> Can you also add the content of `~/.sage/temp/HOSTNAME/` to the bug report? The sage cleaner lives on until it is empty...

What do mean with "empty"?  Does this mean that, if I have 10 copies of Sage running, the Sage cleaner will only exit if all those 10 copies of Sage exit?



---

archive/issue_comments_102743.json:
```json
{
    "body": "I think so. Its purpose is to delete the `~/.sage/temp/HOSTNAME/PID` directory once the process with `PID` has ended. Also, note that if you start Sage multiple times only one sage-cleaner process is started. Really, `make doc` should not wait for the sage cleaner process to finish...",
    "created_at": "2011-10-07T13:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102743",
    "user": "https://github.com/vbraun"
}
```

I think so. Its purpose is to delete the `~/.sage/temp/HOSTNAME/PID` directory once the process with `PID` has ended. Also, note that if you start Sage multiple times only one sage-cleaner process is started. Really, `make doc` should not wait for the sage cleaner process to finish...



---

archive/issue_comments_102744.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> I think so. Its purpose is to delete the `~/.sage/temp/HOSTNAME/PID` directory once the process with `PID` has ended. Also, note that if you start Sage multiple times only one sage-cleaner process is started. Really, `make doc` should not wait for the sage cleaner process to finish...\n\nThis is probably because of file descriptors being open.",
    "created_at": "2011-10-07T13:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102744",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> I think so. Its purpose is to delete the `~/.sage/temp/HOSTNAME/PID` directory once the process with `PID` has ended. Also, note that if you start Sage multiple times only one sage-cleaner process is started. Really, `make doc` should not wait for the sage cleaner process to finish...

This is probably because of file descriptors being open.



---

archive/issue_comments_102745.json:
```json
{
    "body": "I will do some more controlled tests on `geom.math.washington.edu`, a machine where I normally don't run Sage.",
    "created_at": "2011-10-07T13:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102745",
    "user": "https://github.com/jdemeyer"
}
```

I will do some more controlled tests on `geom.math.washington.edu`, a machine where I normally don't run Sage.



---

archive/issue_comments_102746.json:
```json
{
    "body": "I still don't know why sage-cleaner is running at all if you're doing make doc-html.  That runs sage -docbuild, which runs this (from sage-sage):\n\n```sh\nif [ \"$1\" = \"-docbuild\" -o \"$1\" = \"--docbuild\" ]; then\n   cd \"$CUR\"\n   shift\n   python \"$SAGE_ROOT\"/devel/sage/doc/common/builder.py $@\n   exit $?\nfi\n```\n\nIt doesn't run sage-cleaner or sage_setup, so where does sage-cleaner get started?\n\nAre you running another copy of Sage at the same time?",
    "created_at": "2011-10-07T14:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102746",
    "user": "https://github.com/jhpalmieri"
}
```

I still don't know why sage-cleaner is running at all if you're doing make doc-html.  That runs sage -docbuild, which runs this (from sage-sage):

```sh
if [ "$1" = "-docbuild" -o "$1" = "--docbuild" ]; then
   cd "$CUR"
   shift
   python "$SAGE_ROOT"/devel/sage/doc/common/builder.py $@
   exit $?
fi
```

It doesn't run sage-cleaner or sage_setup, so where does sage-cleaner get started?

Are you running another copy of Sage at the same time?



---

archive/issue_comments_102747.json:
```json
{
    "body": "Replying to [comment:19 jhpalmieri]:\n> Are you running another copy of Sage at the same time?\n\nYes, that's why I said I will do more controlled tests.  However, the fact that the session ID of the `sage-cleaner` is the same as `make doc-html` indicates that `sage-cleaner` might have been started by the docbuilder.  Are you sure that the docbuilder doesn't run Sage?",
    "created_at": "2011-10-07T15:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102747",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:19 jhpalmieri]:
> Are you running another copy of Sage at the same time?

Yes, that's why I said I will do more controlled tests.  However, the fact that the session ID of the `sage-cleaner` is the same as `make doc-html` indicates that `sage-cleaner` might have been started by the docbuilder.  Are you sure that the docbuilder doesn't run Sage?



---

archive/issue_comments_102748.json:
```json
{
    "body": "I'm not sure, but I don't see why sage-cleaner would start, and if I run \"sage -docbuild html all\" or \"make doc-html\" in one window, `ps ux | grep clean` comes up empty while it's running.",
    "created_at": "2011-10-07T15:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102748",
    "user": "https://github.com/jhpalmieri"
}
```

I'm not sure, but I don't see why sage-cleaner would start, and if I run "sage -docbuild html all" or "make doc-html" in one window, `ps ux | grep clean` comes up empty while it's running.



---

archive/issue_comments_102749.json:
```json
{
    "body": "Note that it's still only a conjecture that `sage-cleaner` has anything to do with it. I'm putting some hooks into `sage-cleaner` and see what that gives.  Another thing to consider is that maybe it only happens the very first time documentation is built.",
    "created_at": "2011-10-07T15:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102749",
    "user": "https://github.com/jdemeyer"
}
```

Note that it's still only a conjecture that `sage-cleaner` has anything to do with it. I'm putting some hooks into `sage-cleaner` and see what that gives.  Another thing to consider is that maybe it only happens the very first time documentation is built.



---

archive/issue_comments_102750.json:
```json
{
    "body": "`sphinx-build` *does* start `sage-cleaner`:\n\n```\n$ ps -u jdemeyer xfo pid,ppid,pgid,sess,tty,tpgid,stat,args\n  PID  PPID  PGID  SESS TT       TPGID STAT COMMAND\n 2811     1  2262 26064 pts/3    26064 T    python /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sage-cleaner\n 2830 24409  2829 24409 pts/6     2829 S+    |   \\_ grep -e pts/3 -e COMMAND\n26064  6198 26064 26064 pts/3    26064 Ss+   \\_ /bin/bash\n 2262 26064  2262 26064 pts/3    26064 T     |   \\_ make doc-html\n 2781  2262  2262 26064 pts/3    26064 T     |       \\_ /bin/sh -c spkg/pipestatus \"./sage -docbuild --no-pdf-links all html  2>&1\" \"tee -a dochtml.log\"\n 2782  2781  2262 26064 pts/3    26064 T     |           \\_ bash spkg/pipestatus ./sage -docbuild --no-pdf-links all html  2>&1 tee -a dochtml.log\n 2783  2782  2262 26064 pts/3    26064 T     |               \\_ bash ./sage -docbuild --no-pdf-links all html\n 2791  2783  2262 26064 pts/3    26064 T     |               |   \\_ bash /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sage-sage -docbuild --no-pdf-links all html\n 2806  2791  2262 26064 pts/3    26064 T     |               |       \\_ python /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/common/builder.py --no-pdf-links all html\n 2807  2806  2262 26064 pts/3    26064 T     |               |           \\_ /bin/sh -c sphinx-build -b html -d /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/de/tutorial   -A hide_pdf_links=1 /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/de/tutorial /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/html/de/tutorial\n 2808  2807  2262 26064 pts/3    26064 T     |               |               \\_ python /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sphinx-build -b html -d /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/de/tutorial -A hide_pdf_links=1 /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/de/tutorial /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/html/de/tutorial\n 2784  2782  2262 26064 pts/3    26064 T     |               \\_ tee -a dochtml.log\n```\n",
    "created_at": "2011-10-08T09:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102750",
    "user": "https://github.com/jdemeyer"
}
```

`sphinx-build` *does* start `sage-cleaner`:

```
$ ps -u jdemeyer xfo pid,ppid,pgid,sess,tty,tpgid,stat,args
  PID  PPID  PGID  SESS TT       TPGID STAT COMMAND
 2811     1  2262 26064 pts/3    26064 T    python /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sage-cleaner
 2830 24409  2829 24409 pts/6     2829 S+    |   \_ grep -e pts/3 -e COMMAND
26064  6198 26064 26064 pts/3    26064 Ss+   \_ /bin/bash
 2262 26064  2262 26064 pts/3    26064 T     |   \_ make doc-html
 2781  2262  2262 26064 pts/3    26064 T     |       \_ /bin/sh -c spkg/pipestatus "./sage -docbuild --no-pdf-links all html  2>&1" "tee -a dochtml.log"
 2782  2781  2262 26064 pts/3    26064 T     |           \_ bash spkg/pipestatus ./sage -docbuild --no-pdf-links all html  2>&1 tee -a dochtml.log
 2783  2782  2262 26064 pts/3    26064 T     |               \_ bash ./sage -docbuild --no-pdf-links all html
 2791  2783  2262 26064 pts/3    26064 T     |               |   \_ bash /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sage-sage -docbuild --no-pdf-links all html
 2806  2791  2262 26064 pts/3    26064 T     |               |       \_ python /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/common/builder.py --no-pdf-links all html
 2807  2806  2262 26064 pts/3    26064 T     |               |           \_ /bin/sh -c sphinx-build -b html -d /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/de/tutorial   -A hide_pdf_links=1 /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/de/tutorial /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/html/de/tutorial
 2808  2807  2262 26064 pts/3    26064 T     |               |               \_ python /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sphinx-build -b html -d /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/de/tutorial -A hide_pdf_links=1 /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/de/tutorial /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/html/de/tutorial
 2784  2782  2262 26064 pts/3    26064 T     |               \_ tee -a dochtml.log
```




---

archive/issue_comments_102751.json:
```json
{
    "body": "Frustrating that it is hard to reproduce: `make doc-html` *sometimes* runs `sage-cleaner`.",
    "created_at": "2011-10-08T09:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102751",
    "user": "https://github.com/jdemeyer"
}
```

Frustrating that it is hard to reproduce: `make doc-html` *sometimes* runs `sage-cleaner`.



---

archive/issue_comments_102752.json:
```json
{
    "body": "This is `sphinx-build`:\n\n```/usr/bin/env python\n# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.0.4','console_scripts','sphinx-build'\n__requires__ = 'Sphinx==1.0.4'\nimport sys\nfrom pkg_resources import load_entry_point\nimport sage.all\nsys.exit(\n   load_entry_point('Sphinx==1.0.4', 'console_scripts', 'sphinx-build')()\n)\n```\n\n\nNote the line \"import sage.all\".  Perhaps this can sometimes (indirectly) run `sage-cleaner`?",
    "created_at": "2011-10-08T10:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102752",
    "user": "https://github.com/jdemeyer"
}
```

This is `sphinx-build`:

```/usr/bin/env python
# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.0.4','console_scripts','sphinx-build'
__requires__ = 'Sphinx==1.0.4'
import sys
from pkg_resources import load_entry_point
import sage.all
sys.exit(
   load_entry_point('Sphinx==1.0.4', 'console_scripts', 'sphinx-build')()
)
```


Note the line "import sage.all".  Perhaps this can sometimes (indirectly) run `sage-cleaner`?



---

archive/issue_comments_102753.json:
```json
{
    "body": "I don't see how the import sage.all could start sage-cleaner. If you can reproduce the problem, how about you strace the docbuild process? Then it would be easy to find out which child process starts the cleaner.",
    "created_at": "2011-10-08T11:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102753",
    "user": "https://github.com/vbraun"
}
```

I don't see how the import sage.all could start sage-cleaner. If you can reproduce the problem, how about you strace the docbuild process? Then it would be easy to find out which child process starts the cleaner.



---

archive/issue_comments_102754.json:
```json
{
    "body": "Replying to [comment:28 vbraun]:\n> If you can reproduce the problem\nThat's precisely the problem, it must be some weird race-condition.",
    "created_at": "2011-10-08T11:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102754",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:28 vbraun]:
> If you can reproduce the problem
That's precisely the problem, it must be some weird race-condition.



---

archive/issue_comments_102755.json:
```json
{
    "body": "I found a way to reproduce it: when `$HOME/.sage` does not exist, `sage-cleaner` is always started when doing `make doc-html`.",
    "created_at": "2011-10-08T12:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102755",
    "user": "https://github.com/jdemeyer"
}
```

I found a way to reproduce it: when `$HOME/.sage` does not exist, `sage-cleaner` is always started when doing `make doc-html`.



---

archive/issue_comments_102756.json:
```json
{
    "body": "It is indeed the line `import sage.all` which causes `sage-cleaner` to be run.",
    "created_at": "2011-10-08T12:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102756",
    "user": "https://github.com/jdemeyer"
}
```

It is indeed the line `import sage.all` which causes `sage-cleaner` to be run.



---

archive/issue_comments_102757.json:
```json
{
    "body": "Attachment [10163_debug_sage_cleaner.patch](tarball://root/attachments/some-uuid/ticket10163/10163_debug_sage_cleaner.patch) by @jdemeyer created at 2011-10-08 12:43:26\n\nSTOP all processes when sage-cleaner is run, **do not apply**",
    "created_at": "2011-10-08T12:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102757",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10163_debug_sage_cleaner.patch](tarball://root/attachments/some-uuid/ticket10163/10163_debug_sage_cleaner.patch) by @jdemeyer created at 2011-10-08 12:43:26

STOP all processes when sage-cleaner is run, **do not apply**



---

archive/issue_comments_102758.json:
```json
{
    "body": "`gap` seems to be involved somehow.  The last thing which happens before starting `sage-cleaner` is starting `gap`.",
    "created_at": "2011-10-08T12:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102758",
    "user": "https://github.com/jdemeyer"
}
```

`gap` seems to be involved somehow.  The last thing which happens before starting `sage-cleaner` is starting `gap`.



---

archive/issue_comments_102759.json:
```json
{
    "body": "But why does make hang until the cleaner exits? The sage-cleaner process is already orphaned, so nobody should be waiting for it. Did you strace the hanging make process? I would tend to think that it is a good thing that the sage-cleaner is started.",
    "created_at": "2011-10-08T12:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102759",
    "user": "https://github.com/vbraun"
}
```

But why does make hang until the cleaner exits? The sage-cleaner process is already orphaned, so nobody should be waiting for it. Did you strace the hanging make process? I would tend to think that it is a good thing that the sage-cleaner is started.



---

archive/issue_comments_102760.json:
```json
{
    "body": "This reproduces the problem:\n\n```\n$ ( export HOME=/tmp/sagehome; rm -rf $HOME; mkdir -p $HOME/.sage/temp/`hostname`/$$; make doc-html; )\n```\n\nWhat happens here is that we start from a clean `$HOME` and create a bogus directory in `$HOME/.sage/temp/$hostname` to make sure `sage-cleaner` does not exit.  Note that you can delete the last 3 lines from `local/bin/sphinx-build` to speed up testing.",
    "created_at": "2011-10-08T13:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102760",
    "user": "https://github.com/jdemeyer"
}
```

This reproduces the problem:

```
$ ( export HOME=/tmp/sagehome; rm -rf $HOME; mkdir -p $HOME/.sage/temp/`hostname`/$$; make doc-html; )
```

What happens here is that we start from a clean `$HOME` and create a bogus directory in `$HOME/.sage/temp/$hostname` to make sure `sage-cleaner` does not exit.  Note that you can delete the last 3 lines from `local/bin/sphinx-build` to speed up testing.



---

archive/issue_comments_102761.json:
```json
{
    "body": "Attachment [10163_sage_cleaner.patch](tarball://root/attachments/some-uuid/ticket10163/10163_sage_cleaner.patch) by @jdemeyer created at 2011-10-08 13:18:48",
    "created_at": "2011-10-08T13:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102761",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10163_sage_cleaner.patch](tarball://root/attachments/some-uuid/ticket10163/10163_sage_cleaner.patch) by @jdemeyer created at 2011-10-08 13:18:48



---

archive/issue_comments_102762.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-10-08T13:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102762",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_102763.json:
```json
{
    "body": "The problem was dangling file descriptors.  This patch fixes the problem for me.",
    "created_at": "2011-10-08T13:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102763",
    "user": "https://github.com/jdemeyer"
}
```

The problem was dangling file descriptors.  This patch fixes the problem for me.



---

archive/issue_comments_102764.json:
```json
{
    "body": "Hmm maybe sage-cleaner should close its stdout/stderr instead of hoping that all instances that call it do. But then that would make it annoying to debug the cleaner... In any case, the patch looks good to me.",
    "created_at": "2011-10-08T13:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102764",
    "user": "https://github.com/vbraun"
}
```

Hmm maybe sage-cleaner should close its stdout/stderr instead of hoping that all instances that call it do. But then that would make it annoying to debug the cleaner... In any case, the patch looks good to me.



---

archive/issue_comments_102765.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-08T13:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102765",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_102766.json:
```json
{
    "body": "Replying to [comment:37 vbraun]:\n> Hmm maybe sage-cleaner should close its stdout/stderr instead of hoping that all instances that call it do. But then that would make it annoying to debug the cleaner...\n\nExactly, that's what I was also thinking.",
    "created_at": "2011-10-08T13:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102766",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 vbraun]:
> Hmm maybe sage-cleaner should close its stdout/stderr instead of hoping that all instances that call it do. But then that would make it annoying to debug the cleaner...

Exactly, that's what I was also thinking.



---

archive/issue_comments_102767.json:
```json
{
    "body": "Changing keywords from \"build Makefile\" to \"build Makefile sage-cleaner\".",
    "created_at": "2011-10-08T13:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102767",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "build Makefile" to "build Makefile sage-cleaner".



---

archive/issue_comments_102768.json:
```json
{
    "body": "Changing keywords from \"build Makefile sage-cleaner\" to \"build Makefile sage-cleaner cleaner\".",
    "created_at": "2011-10-08T13:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102768",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "build Makefile sage-cleaner" to "build Makefile sage-cleaner cleaner".



---

archive/issue_comments_102769.json:
```json
{
    "body": "We had similar problems with (e.g.) `ptestlong` and (GAP?) orphans IIRC; while `sage -tp ...` did terminate (*\"All tests passed!\"*), `tee` did not because some file descriptor(s) were still open, so you didn't get the shell prompt back.\n\nKilling the orphans the shell prompt returned.",
    "created_at": "2011-10-08T16:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102769",
    "user": "https://github.com/nexttime"
}
```

We had similar problems with (e.g.) `ptestlong` and (GAP?) orphans IIRC; while `sage -tp ...` did terminate (*"All tests passed!"*), `tee` did not because some file descriptor(s) were still open, so you didn't get the shell prompt back.

Killing the orphans the shell prompt returned.



---

archive/issue_events_010284.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-08T18:14:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10162#event-10284"
}
```



---

archive/issue_comments_102770.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-10-08T18:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10162#issuecomment-102770",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
