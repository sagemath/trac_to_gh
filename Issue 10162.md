# Issue 10162: make doc-html sometimes hangs after having finished

Issue created by migration from https://trac.sagemath.org/ticket/10163

Original creator: jdemeyer

Original creation time: 2010-10-23 21:57:18

Assignee: GeorgSWeber

Keywords: build

The following is a non-reproducible problem, but it happened at least twice for me:
when building Sage from source using

```
export MAKE="make -j8"
$MAKE
```

it can happen that `make` simply hangs forever after the message

```
Build finished.  The built documents can be found in /mnt/usb1/scratch/jdemeyer/merger/sage-4.6.1.alpha0/devel/sage/doc/output/html/fr/a_tour_of_sage
```


Pressing CTRL-C at this point gives

```
make: *** [doc-html] Interrupt
```


I'm not sure whether the "-j8" option has anything to do with it.


---

Comment by jdemeyer created at 2010-12-19 13:57:41

Changing keywords from "build" to "build Makefile".


---

Comment by jdemeyer created at 2010-12-19 13:57:41

This might be due to NFS (I know it happened on sage.math.washington.edu but I can't remember whether it ever happened on other machines).


---

Comment by jdemeyer created at 2011-01-19 13:31:48

I am getting more and more convinced that this is an NFS issue, so proposal to close this ticket as invalid.


---

Comment by jdemeyer created at 2011-01-19 13:31:48

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-03-02 10:09:37

Just because NFS triggers it doesn't necessarily mean that its not a bug in Sage. I've never seen this issue, but then I never use high-latency filesystems. Can you run strace/gdb on the stuck process if you see it again? (use -p to attach to existing pid)


---

Comment by vbraun created at 2011-03-02 10:09:37

Changing status from needs_review to needs_info.


---

Comment by jhpalmieri created at 2011-10-06 18:48:34

Should there be some timeout setting in sage-cleaner?  If it has to wait too long, exit but print a warning message that there may be some stray processes which should be killed by hand?


---

Comment by vbraun created at 2011-10-06 19:09:59

No the sage cleaner needs to stick around for as long as Sage is running. There might be a computation running that, after a long while, does a big `@`parallel loop and if nobody is cleaning up the filesystem will be very unhappy.


---

Comment by jhpalmieri created at 2011-10-06 20:10:33

Does `sage-cleaner` actually run when you do `sage -docbuild ...` (which is called by `make doc-html`)?  It doesn't look like it to me.  It seems that `sage -docbuild all html` creates a bunch of temporary directories in `DOT_SAGE/temp/HOSTNAME`, and those aren't deleted until the next time I run Sage, when `sage-cleaner` actually runs.  So maybe the issue on this ticket isn't related to `sage-cleaner`.


---

Comment by vbraun created at 2011-10-07 11:19:01

Can you also add the content of `~/.sage/temp/HOSTNAME/` to the bug report? The sage cleaner lives on until it is empty...


---

Comment by jdemeyer created at 2011-10-07 12:08:43

It seems to have pulled itself through after a while.  Don't know why...


---

Comment by jdemeyer created at 2011-10-07 12:09:30

Replying to [comment:12 vbraun]:
> Can you also add the content of `~/.sage/temp/HOSTNAME/` to the bug report? The sage cleaner lives on until it is empty...

What do mean with "empty"?  Does this mean that, if I have 10 copies of Sage running, the Sage cleaner will only exit if all those 10 copies of Sage exit?


---

Comment by vbraun created at 2011-10-07 13:35:01

I think so. Its purpose is to delete the `~/.sage/temp/HOSTNAME/PID` directory once the process with `PID` has ended. Also, note that if you start Sage multiple times only one sage-cleaner process is started. Really, `make doc` should not wait for the sage cleaner process to finish...


---

Comment by jdemeyer created at 2011-10-07 13:39:08

Replying to [comment:16 vbraun]:
> I think so. Its purpose is to delete the `~/.sage/temp/HOSTNAME/PID` directory once the process with `PID` has ended. Also, note that if you start Sage multiple times only one sage-cleaner process is started. Really, `make doc` should not wait for the sage cleaner process to finish...

This is probably because of file descriptors being open.


---

Comment by jdemeyer created at 2011-10-07 13:43:28

I will do some more controlled tests on `geom.math.washington.edu`, a machine where I normally don't run Sage.


---

Comment by jhpalmieri created at 2011-10-07 14:45:59

I still don't know why sage-cleaner is running at all if you're doing make doc-html.  That runs sage -docbuild, which runs this (from sage-sage):

```sh
if [ "$1" = "-docbuild" -o "$1" = "--docbuild" ]; then
   cd "$CUR"
   shift
   python "$SAGE_ROOT"/devel/sage/doc/common/builder.py $@
   exit $?
fi
```

It doesn't run sage-cleaner or sage_setup, so where does sage-cleaner get started?

Are you running another copy of Sage at the same time?


---

Comment by jdemeyer created at 2011-10-07 15:10:30

Replying to [comment:19 jhpalmieri]:
> Are you running another copy of Sage at the same time?

Yes, that's why I said I will do more controlled tests.  However, the fact that the session ID of the `sage-cleaner` is the same as `make doc-html` indicates that `sage-cleaner` might have been started by the docbuilder.  Are you sure that the docbuilder doesn't run Sage?


---

Comment by jhpalmieri created at 2011-10-07 15:26:00

I'm not sure, but I don't see why sage-cleaner would start, and if I run "sage -docbuild html all" or "make doc-html" in one window, `ps ux | grep clean` comes up empty while it's running.


---

Comment by jdemeyer created at 2011-10-07 15:30:55

Note that it's still only a conjecture that `sage-cleaner` has anything to do with it. I'm putting some hooks into `sage-cleaner` and see what that gives.  Another thing to consider is that maybe it only happens the very first time documentation is built.


---

Comment by jdemeyer created at 2011-10-08 09:04:37

`sphinx-build` _does_ start `sage-cleaner`:

```
$ ps -u jdemeyer xfo pid,ppid,pgid,sess,tty,tpgid,stat,args
  PID  PPID  PGID  SESS TT       TPGID STAT COMMAND
 2811     1  2262 26064 pts/3    26064 T    python /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sage-cleaner
 2830 24409  2829 24409 pts/6     2829 S+    |   \_ grep -e pts/3 -e COMMAND
26064  6198 26064 26064 pts/3    26064 Ss+   \_ /bin/bash
 2262 26064  2262 26064 pts/3    26064 T     |   \_ make doc-html
 2781  2262  2262 26064 pts/3    26064 T     |       \_ /bin/sh -c spkg/pipestatus "./sage -docbuild --no-pdf-links all html  2>&1" "tee -a dochtml.log"
 2782  2781  2262 26064 pts/3    26064 T     |           \_ bash spkg/pipestatus ./sage -docbuild --no-pdf-links all html  2>&1 tee -a dochtml.log
 2783  2782  2262 26064 pts/3    26064 T     |               \_ bash ./sage -docbuild --no-pdf-links all html
 2791  2783  2262 26064 pts/3    26064 T     |               |   \_ bash /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sage-sage -docbuild --no-pdf-links all html
 2806  2791  2262 26064 pts/3    26064 T     |               |       \_ python /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/common/builder.py --no-pdf-links all html
 2807  2806  2262 26064 pts/3    26064 T     |               |           \_ /bin/sh -c sphinx-build -b html -d /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/de/tutorial   -A hide_pdf_links=1 /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/de/tutorial /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/html/de/tutorial
 2808  2807  2262 26064 pts/3    26064 T     |               |               \_ python /scratch/jdemeyer/sage-4.7.2.alpha3/local/bin/sphinx-build -b html -d /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/de/tutorial -A hide_pdf_links=1 /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/de/tutorial /scratch/jdemeyer/sage-4.7.2.alpha3/devel/sage/doc/output/html/de/tutorial
 2784  2782  2262 26064 pts/3    26064 T     |               \_ tee -a dochtml.log
```



---

Comment by jdemeyer created at 2011-10-08 09:20:31

Frustrating that it is hard to reproduce: `make doc-html` _sometimes_ runs `sage-cleaner`.


---

Comment by jdemeyer created at 2011-10-08 10:53:01

This is `sphinx-build`:

```/usr/bin/env python
# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.0.4','console_scripts','sphinx-build'
__requires__ = 'Sphinx==1.0.4'
import sys
from pkg_resources import load_entry_point
import sage.all
sys.exit(
   load_entry_point('Sphinx==1.0.4', 'console_scripts', 'sphinx-build')()
)
```


Note the line "import sage.all".  Perhaps this can sometimes (indirectly) run `sage-cleaner`?


---

Comment by vbraun created at 2011-10-08 11:13:32

I don't see how the import sage.all could start sage-cleaner. If you can reproduce the problem, how about you strace the docbuild process? Then it would be easy to find out which child process starts the cleaner.


---

Comment by jdemeyer created at 2011-10-08 11:23:47

Replying to [comment:28 vbraun]:
> If you can reproduce the problem
That's precisely the problem, it must be some weird race-condition.


---

Comment by jdemeyer created at 2011-10-08 12:39:23

I found a way to reproduce it: when `$HOME/.sage` does not exist, `sage-cleaner` is always started when doing `make doc-html`.


---

Comment by jdemeyer created at 2011-10-08 12:40:34

It is indeed the line `import sage.all` which causes `sage-cleaner` to be run.


---

Attachment

STOP all processes when sage-cleaner is run, *do not apply*


---

Comment by jdemeyer created at 2011-10-08 12:53:36

`gap` seems to be involved somehow.  The last thing which happens before starting `sage-cleaner` is starting `gap`.


---

Comment by vbraun created at 2011-10-08 12:59:13

But why does make hang until the cleaner exits? The sage-cleaner process is already orphaned, so nobody should be waiting for it. Did you strace the hanging make process? I would tend to think that it is a good thing that the sage-cleaner is started.


---

Comment by jdemeyer created at 2011-10-08 13:14:42

This reproduces the problem:

```
$ ( export HOME=/tmp/sagehome; rm -rf $HOME; mkdir -p $HOME/.sage/temp/`hostname`/$$; make doc-html; )
```

What happens here is that we start from a clean `$HOME` and create a bogus directory in `$HOME/.sage/temp/$hostname` to make sure `sage-cleaner` does not exit.  Note that you can delete the last 3 lines from `local/bin/sphinx-build` to speed up testing.


---

Attachment


---

Comment by jdemeyer created at 2011-10-08 13:19:12

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2011-10-08 13:19:41

The problem was dangling file descriptors.  This patch fixes the problem for me.


---

Comment by vbraun created at 2011-10-08 13:27:59

Hmm maybe sage-cleaner should close its stdout/stderr instead of hoping that all instances that call it do. But then that would make it annoying to debug the cleaner... In any case, the patch looks good to me.


---

Comment by vbraun created at 2011-10-08 13:27:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-10-08 13:31:54

Replying to [comment:37 vbraun]:
> Hmm maybe sage-cleaner should close its stdout/stderr instead of hoping that all instances that call it do. But then that would make it annoying to debug the cleaner...

Exactly, that's what I was also thinking.


---

Comment by jdemeyer created at 2011-10-08 13:31:54

Changing keywords from "build Makefile" to "build Makefile sage-cleaner".


---

Comment by jdemeyer created at 2011-10-08 13:32:07

Changing keywords from "build Makefile sage-cleaner" to "build Makefile sage-cleaner cleaner".


---

Comment by leif created at 2011-10-08 16:36:15

We had similar problems with (e.g.) `ptestlong` and (GAP?) orphans IIRC; while `sage -tp ...` did terminate (_"All tests passed!"_), `tee` did not because some file descriptor(s) were still open, so you didn't get the shell prompt back.

Killing the orphans the shell prompt returned.


---

Comment by jdemeyer created at 2011-10-08 18:14:56

Resolution: fixed
