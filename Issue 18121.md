# Issue 18121: a cython function that produces long given python input

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-05-03 20:25:38

CC:  ncohen

I met twice the same problem which is the nedd for a standalone function that given a python objects return an associated long (if it makes sense).

The following is not safe

```
cdef long f(x):
    return x
```

since `f(2/3)` would return `0` (see e.g. #18278). Moreover, one could expect something that would be very fast for both Python int and Sage integers (see #18346).


---

Comment by jdemeyer created at 2015-05-03 20:44:04

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-05-03 20:44:04

That's not a bug report, but a support request. If you post this to `sage-support`, I'll answer.


---

Comment by jdemeyer created at 2015-05-03 20:44:09

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-05-03 20:49:38

Replying to [comment:1 jdemeyer]:
> That's not a bug report, but a support request. If you post this to `sage-support`, I'll answer.

https://groups.google.com/forum/#!topic/sage-support/0ATjCgQlq4c


---

Comment by vdelecroix created at 2015-05-04 13:08:02

In view of your answer on sage-support, it might still be worth to have something along

```
cdef inline long long_or_LONG_MIN(x):
    if PyInt_CheckExact(x):
        return PyInt_AS_LONG(x)
    elif type(x) is Integer:
        if mpz_fits_slong_p((<Integer>x).value):
            return mpz_get_si((<Integer>x).value)
        else:
            return LONG_MIN
    else:
        try:
            return PyNumber_Index(x)
        except Exception:
            return LONG_MIN 
```

It would be faster for Python ints and Sage integers.

Vincent


---

Comment by jdemeyer created at 2015-05-04 13:46:04

For Python `int`s, there will not be much difference (calling `PyNumber_Index(x)` on an `int` just returns `x`, so the only overhead is a function call and some reference counting).

For `Integer`, there is a larger gain. It's just annoying that Python doesn't allow defining a fast conversion `ArbitraryType` -> C `long`.


---

Comment by jdemeyer created at 2015-05-04 14:02:05

Changing status from positive_review to needs_work.


---

Comment by nbruin created at 2015-05-04 16:07:39

Replying to [comment:5 jdemeyer]:

> For `Integer`, there is a larger gain. It's just annoying that Python doesn't allow defining a fast conversion `ArbitraryType` -> C `long`.

It does! It's called `tp_hash` :-). It's of course already taken for other purposes. We'd need an extra slot. Something along the lines of the conversion macro suggested in comment:4 would probably be the best we can do without it.


---

Comment by jdemeyer created at 2015-05-04 17:30:38

Replying to [comment:7 nbruin]:
> We'd need an extra slot.
Sometimes I wish I could just patch Python...

> Something along the lines of the conversion macro suggested in comment:4 would probably be the best we can do without it.
Indeed.


---

Comment by vdelecroix created at 2015-05-05 13:45:06

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-05-05 13:45:06

Here is an experimental branch with a macro `pyobject_to_long` in `sage.misc.long`. I do not like the gestion of error but I do not know how to do better without affecting performance. Please tell me.

It is used in `Integer.__pow__` and `Rational.__pow__` as a proof of concept. And we win 20 precious nano seconds when the exponent is a small Sage Integer (~10%):

```
sage: timeit("2**5", number=400000, repeat=20)
400000 loops, best of 20: 248 ns per loop
sage: timeit("(2/3)**2", number=100000, repeat=20)
100000 loops, best of 20: 1.1 Âµs per loop
```

against

```
sage: timeit("2**5", number=400000, repeat=20)
400000 loops, best of 20: 228 ns per loop
sage: timeit("(2/3)**2", number=100000, repeat=20)
200000 loops, best of 30: 990 ns per loop
```


Vincent
----
New commits:


---

Comment by git created at 2015-05-05 13:45:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-05 14:47:55

`except LONG_MIN` -> `except? LONG_MIN` and there is no need to document `LONG_MIN` in the docstring.


---

Comment by jdemeyer created at 2015-05-05 14:48:19

`PyInt_CheckExact(...)` -> `isinstance(..., int)`


---

Comment by jdemeyer created at 2015-05-05 14:50:34

`OverflowError` -> `OverflowError("Integer too large to convert to C long")` or something like that.

And obviously: doctests please.


---

Comment by jdemeyer created at 2015-05-05 14:50:34

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-05-05 15:45:20

Replying to [comment:13 jdemeyer]:
> `OverflowError` -> `OverflowError("Integer too large to convert to C long")` or something like that.
> 
> And obviously: doctests please.

How? Should I use `Integer.__pow__` and `Rational.__pow__` with indirect doctests?


---

Comment by jdemeyer created at 2015-05-05 19:00:28

Replying to [comment:14 vdelecroix]:
> Replying to [comment:13 jdemeyer]:
> > `OverflowError` -> `OverflowError("Integer too large to convert to C long")` or something like that.
> > 
> > And obviously: doctests please.
> 
> How? Should I use `Integer.__pow__` and `Rational.__pow__` with indirect doctests?
That's actually not a bad idea. You should probably test the following numbers: `int(10)`, `long(10)`, `long(10^100)`, `10`, `10^100`, `QQ(10)`, `QQ(10^100)`, `1/2`.


---

Comment by jdemeyer created at 2015-05-05 21:01:35

It would make sense to merge 6.7.beta4 and replace all occurances of `PyNumber_Index` and `PyNumber_AsSsize_t` by this new function.


---

Comment by vdelecroix created at 2015-05-05 21:26:14

Replying to [comment:16 jdemeyer]:
> It would make sense to merge 6.7.beta4 and replace all occurances of `PyNumber_Index` and `PyNumber_AsSsize_t` by this new function.

It might not be good everywhere as the overflow might not be appropriate. I will have a look at occurrences.


---

Comment by git created at 2015-05-06 07:10:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-06 07:11:33

Rebased on sage-6.7.beta4. I used `pyobject_to_long` where it seemed appropriate.

Vincent


---

Comment by vdelecroix created at 2015-05-06 07:11:33

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-06 07:29:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-06 07:29:33

In `c_graph`, if you call a variable `u_long`, actually make it a `long` (now it's still an `int` which means it can silently overflow).


---

Comment by jdemeyer created at 2015-05-06 07:33:08

You're not actually using this:

```
sage: tens = [10r, 10l, 10, 10/1]
```



---

Comment by jdemeyer created at 2015-05-06 07:37:08

I would prefer to replace

```
try:
    n = pyobject_to_long(exp)
except TypeError:
    raise TypeError("non-integral exponents not supported")
```

by

```
n = pyobject_to_long(exp)
```



---

Comment by git created at 2015-05-11 17:21:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-05-11 17:25:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-12 12:31:12

Two more points:

1. `raied` -> `raised`

2. The doctests for `Integer.__pow__` and `Rational.__pow__` seem redundant. It's sufficient to keep just one.


---

Comment by jdemeyer created at 2015-05-12 12:44:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-13 16:15:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-05-13 16:15:26

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-13 19:53:43

I didn't run doctests again, but positive_review assuming that they pass.


---

Comment by jdemeyer created at 2015-05-13 19:53:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-14 22:40:19

Resolution: fixed
