# Issue 32277: src/sage/misc/persist.pyx: Fix doctest error when run as root

Issue created by migration from https://trac.sagemath.org/ticket/32514

Original creator: mkoeppe

Original creation time: 2021-09-14 20:07:51

CC:  chapoton mjo slelievre

... as seen on GH Actions tests in 9.5.beta1
https://github.com/sagemath/sage/runs/3593002892?check_suite_focus=true

```
age -t --random-seed=0 src/sage/misc/persist.pyx
**********************************************************************
File "src/sage/misc/persist.pyx", line 1018, in sage.misc.persist.picklejar
Failed example:
    if uid==0:
        raise OSError('You must not run the doctests as root, geez!')
    elif sys.platform == 'cygwin':
        raise OSError("This won't always behave on Cygwin depending on permission handling configuration.")
    else:
        sage.misc.persist.picklejar(1, dir + '/noaccess')
Expected:
    Traceback (most recent call last):
    ...
    PermissionError: ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.persist.picklejar[7]>", line 2, in <module>
        raise OSError('You must not run the doctests as root, geez!')
    OSError: You must not run the doctests as root, geez!
**********************************************************************
```



The patronizing message "You must not run the doctests as root" should be removed altogether

The failure is likely caused by the changes in #32326




---

Comment by mkoeppe created at 2021-09-17 17:12:02

New commits:


---

Comment by mkoeppe created at 2021-09-17 17:12:02

Changing status from new to needs_review.


---

Comment by mjo created at 2021-09-18 11:18:15

The test suite _shouldn't_ be run as root, but that's not the place to enforce it. Can you make that doctest save/restore the original permissions rather than setting them to 0755 unconditionally (which is too permissive)? Otherwise LGTM.


---

Comment by git created at 2021-09-18 16:53:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-09-18 18:06:41

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2021-09-18 18:06:41

thanks


---

Comment by mkoeppe created at 2021-09-18 18:07:23

Thanks for reviewing!


---

Comment by slelievre created at 2021-09-23 12:07:53

Changing keywords from "" to "permission".


---

Comment by slelievre created at 2021-09-23 12:07:53

This fixes the only failing doctest I saw
in Sage 9.5.beta1 (Cygwin 3.2.0, Windows 10).


---

Comment by vbraun created at 2021-09-25 23:17:53

Resolution: fixed
