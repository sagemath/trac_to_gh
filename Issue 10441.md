# Issue 10441: Upgrading 4.6->4.6.1 does not upgrade sagenb

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2010-12-19 09:41:39

Assignee: GeorgSWeber

CC:  leif

Keywords: sagenb

It seems that `sage -f sagenb-VERSION` doesn't actually do anything. It does *not* change the `devel/sagenb-main` directory. This issue also breaks upgrading sage-4.6 to sage-4.6.1.alpha3 for me, because sagenb is not actually upgraded.


---

Comment by jdemeyer created at 2010-12-19 13:50:28

SAGENB patch


---

Comment by jdemeyer created at 2010-12-19 13:51:04

Changing status from new to needs_review.


---

Attachment

Patch copied from #10176.


---

Comment by jdemeyer created at 2010-12-19 13:52:16

Leif, it seems your patch (unintentionally?) fixes upgrading.


---

Comment by jdemeyer created at 2010-12-19 14:07:18

I discovered what went wrong with upgrading: the command

```
cp -pr sagenb "$SAGE_ROOT/devel/sagenb-main"
```

would create a directory `$SAGE_ROOT/devel/sagenb-main/sagenb` if `sagenb-main` already exists.  The patch fixes this by first renaming `$SAGE_ROOT/devel/sagenb-main`


---

Comment by jdemeyer created at 2010-12-23 19:51:59

Positive review to Leif's patch, added still untested reviewer patch.


---

Attachment

Reviewer patch, SAGENB


---

Comment by jdemeyer created at 2010-12-24 09:53:08

Reviewer patch, SAGENB (fixed filename, ignore previous)


---

Attachment


---

Comment by leif created at 2010-12-26 20:17:30

* `command -v sage` is a bit faster than `sage -v`, but I don't mind.
   (The latter isn't much more specific since other programs called `sage` are likely to also understand that option, with arbitrary results...)

 * Solaris' `grep` _does_ understand `-q`, but unfortunately not the one in the "default" path. We should IMHO check in Sage's `configure` (and/or `sage-env`) that we have the proper / capable (POSIX-conformant) tools in the path, not limited to `grep`.

 * If `sage -pkg ...` fails, the error message should start with "`Error: `" and go to `sys.stderr`; I would also _quote_ the failed command there.

 * W.r.t.

```python
# This spkg-dist doesn't need any Sage components, it is fine to run 
# it from a system-wide Python. -- Jeroen Demeyer
```

  I wouldn't rely on a (potentially) system-wide `python`, since that might actually lack some components, or have versions which are too old (which definitely _can_ cause import errors).

 It's not that clear what you mean by "Sage components"; `spkg-dist` certainly requires Sage's Mercurial, some scripts and the programs these use. It also requires (at least) `setuptools`, which are shipped with Sage, but may not be installed in a system-wide Python.
 
 (We could `try: import ... except ImportError: ...`  to give a more "friendly" error message in the latter case. I don't know if some / what minimal versions of Python and the imported modules are required. Experienced Sage developers are likely to have current versions installed, but I think SageNB is meanwhile subject to changes by a wider group as well.)

 So it would be safer to use Sage's Python; if we keep `sage-python` in `SAGE_ROOT`, which should be in the path, or at least `sage-python` itself, we could use

```sh
#!/usr/bin/env sage-python
```

 in the `spkg-dist` script.


I think I'm ok with the rest of the reviewer patch; I still have to provide a version of my patch(es) with the currently "lost" commit messages...


---

Comment by leif created at 2010-12-27 03:28:07

Replying to [comment:2 jdemeyer]:
> Leif, it seems your patch (unintentionally?) fixes upgrading.

Of course intentionally. ;-)

Besides that a missing `#!` can have strange "side" effects, too, I replaced the `cp` by `mv`, which makes the deletion of `sagenb-main` obsolete (and is of course much faster).


---

Comment by jdemeyer created at 2011-01-03 11:16:55

Second reviewer patch added, needs review.


---

Comment by jdemeyer created at 2011-01-03 11:21:10

Second reviewer patch, SAGENB, apply on top of previous


---

Attachment

Possible issue: is it reasonable to expect SAGE_SETUPTOOLS_DEBUG to always be set to "yes" or is it worth worrying about something like SAGE_SETUPTOOLS_DEBUG == "Yes"?


---

Comment by jdemeyer created at 2011-01-10 02:22:49

Replying to [comment:10 gbe]:
> Possible issue: is it reasonable to expect SAGE_SETUPTOOLS_DEBUG to always be set to "yes" or is it worth worrying about something like SAGE_SETUPTOOLS_DEBUG == "Yes"? 

I think it is well-known that one should only use "yes" and no other variant, so I would not worry about this.


---

Comment by gbe created at 2011-01-10 07:48:01

Changing status from needs_review to positive_review.


---

Comment by gbe created at 2011-01-10 07:48:01

Looks good. The only other issue I see is some code in spkg-dist is never reached, but I'll open a separate ticket for that issue.


---

Comment by jdemeyer created at 2011-01-10 20:51:32

Resolution: fixed
