# Issue 23120: upgrade gf2x to version 1.2

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2017-07-03 17:15:43

CC:  zimmerma thome fbissey embray

1.2 has been released.

tarball: 

https://gforge.inria.fr/frs/download.php/file/36934/gf2x-1.2.tar.gz


---

Comment by dimpase created at 2017-07-03 22:14:42

removed the patches and bumped up the version; this works on Linux with gcc, seemingly without problems. 

More testing, esp. on OSX and Cygwin, needed.
----
New commits:


---

Comment by fbissey created at 2017-07-03 22:20:08

The tuning is much faster in this version so I think we should alter some of the settings in `spkg-install` before we finalise the ticket.


---

Comment by dimpase created at 2017-07-03 22:26:34

On FreeBSD with CC=clang-3.8 this is problematic if I set `SAGE_FAT_BINARY=yes`, that is, will have

```
GF2X_CONFIGURE="--disable-hardware-specific-code $GF2X_CONFIGURE"
```


Have I removed too many patches?


```
...
[gf2x-1.2] cc -DHAVE_CONFIG_H -I. -I../gf2x  -I.. -I.. -DTUNING=2   -O2 -g -fPIC -Wall -W -MT ../lowlevel/tune_mul2t-mul2t.o -MD -MP -MF ../lowlevel/.deps/tune_mul2t-mul2t.Tpo -c -o ../lowlevel/tune_mul2t-mul2t.o `test -f '../lowlevel/mul2t.c' || echo './'`../lowlevel/mul2t.c
[gf2x-1.2] ../lowlevel/mul2t.c:43:2: error: "This code needs sse-2 support"
[gf2x-1.2] #error "This code needs sse-2 support"
[gf2x-1.2]  ^
[gf2x-1.2] ../lowlevel/mul2t.c:64:5: error: use of undeclared identifier '__m128i'
[gf2x-1.2]     __m128i u;
...
```



---

Comment by fbissey created at 2017-07-03 22:34:29

I am inspecting configure.ac it would be helpful to have config.log for gf2x.


---

Comment by dimpase created at 2017-07-03 22:36:56

Does it work for you with SAGE_FAT_BINARY=yes ?

Without it, it builds on FreeBSD, so this might actually be an issue upstream...


---

Comment by thome created at 2017-07-03 22:37:34

wish you had provided feedback on the rc's...


---

Comment by fbissey created at 2017-07-03 22:37:59

Haven't tried that yet I must say. I'll try when this round of tuning finishes.


---

Comment by fbissey created at 2017-07-03 22:39:28

Replying to [comment:8 thome]:
> wish you had provided feedback on the rc's...

Sorry, i only got so much time on my hands... My priority is almost at "fight fires" rather than proofing.


---

Comment by dimpase created at 2017-07-03 22:40:47

Replying to [comment:8 thome]:
> wish you had provided feedback on the rc's...
Well, I duly wanted to provide it today :-)  
Have you been testing rc with 

```
GF2X_CONFIGURE="--disable-hardware-specific-code
```



---

Comment by thome created at 2017-07-03 22:43:52

Just re-checking right now a couple of configs.
`freebsd11-amd64 CC=clang38 CXX=clang++38` --> ok.
same with `--disable-hardware-specific-code` seems to compile but does not pass make check. Is it what you observe ?


---

Comment by thome created at 2017-07-03 22:44:43

I mean, the check binaries don't compile.


---

Comment by thome created at 2017-07-03 22:46:00

What is `SAGE_FAT_BINARY` all about ?
Anything to do with gmp's `fat` mechanism ?


---

Comment by fbissey created at 2017-07-03 22:48:49

Producing generic binaries for the arch. Must be able to run on any cpus of the arch. So no using cpu specific instructions. Arguably it is hard to find x86 without sse2 these days (Ok there is one in my garage).


---

Comment by thome created at 2017-07-03 22:51:39

x86 or x86_64 ? This is a debate we had with JPFiori a while back whether x86_64 without sse2 are a thing. SSE types are mentioned in the ABI but, tagged "optional".


---

Comment by fbissey created at 2017-07-03 22:56:40

I know of that debate. Apparently there were a few early core2 chips without sse2, good luck finding one of those - however they probably can be emulated in a VM, there is no telling what an end user will do. The machine in my garage is vintage x86 from 2002.


---

Comment by thome created at 2017-07-03 22:58:16

forcibly disable all gf2x_cv_cc_supports_XXX variables when we have --disable-hardware-specific-code


---

Attachment

Last patch should fix the check issue you're getting on fbsd.


---

Comment by fbissey created at 2017-07-03 23:08:13

I have just reproduced the issue on linux, the patch seems to do the work it is supposed to do. I am a bit surprised you had to define those explicitly but you obviously know the code better. I am not even sure the compilation was failing in the test. It may have been during tuning. Not sure why some tuning is still run while building a binary package, that's a bit of non-sense that will have to be fixed.


---

Comment by thome created at 2017-07-03 23:12:32

`AM_CONDITIONAL`'s based on `configure.ac`'s variables are a pain. And I ocasionally (why, I wonder) define the latter as e.g. `yes, with -msse2`. So the `AM_DEFINE`'s use `test x$gf2x_cv_cc_supports_sse2 != xno` which is obviously wrong if the test didn't run in the first place. Not pretty, I confess.

This being said, no tuning should normally be run. What are you using to build the package ? Plain `make && make install` ? Something else ?


---

Comment by thome created at 2017-07-03 23:16:24

Replying to [comment:6 fbissey]:
> I am inspecting configure.ac it would be helpful to have config.log for gf2x.

gf2x puts its config.log at the normal place in the build tree.


---

Comment by fbissey created at 2017-07-03 23:17:21

Ok. Gentoo does just plain `configure && make && make install` but sage's package by default does

```
configure
make
make tune-lowlevel && make tune-toom TOOM_TUNING_LIMIT=100
make install
```

You have alternatives to do nothing or replace the tuning bit by

```
make tune-lowlevel && make tune-toom && make tune-fft
```

Are you saying that's just a waste of time :)


---

Comment by thome created at 2017-07-03 23:20:26

More precisely: I have no objection if you try to run some tuning before creating the binary package, but you don't have to.

There's probably less craftsmanship in the tuning thresholds of gf2x than with, e.g., gmp. But the default should nevertheless be fine.

In fact, doing limited tuning with `TOOM_TUNING_LIMIT=100` probably does more harm than good, since the default tables are computed with a larger limit.


---

Comment by thome created at 2017-07-03 23:25:17

FYI the info on the tuning data present in the shipped files is in the preprocessor macros `GF2X_TOOM_TUNING_INFO` and `GF2X_FFT_TUNING_INFO`, both defined in `gf2x-thresholds.h`.

I'll be able to answer further queries tomorrow if time allows. Right now it's getting late here.


---

Comment by fbissey created at 2017-07-03 23:26:01

Replying to [comment:23 thome]:
> 
> More precisely: I have no objection if you try to run some tuning before creating the binary package, but you don't have to.
> 

Well I think it is stupid to make a generic package and then somehow tuning it again to the building cpu. Even without using special instructions, that feels a bit daft.

> There's probably less craftsmanship in the tuning thresholds of gf2x than with, e.g., gmp. But the default should nevertheless be fine.
> 
> In fact, doing limited tuning with `TOOM_TUNING_LIMIT=100` probably does more harm than good, since the default tables are computed with a larger limit.

Well, as a matter of fact, tuning is much faster in 1.2, time considerations probably lead to `TOOM_TUNING_LIMIT=100` (I don't speak from authority, that's my guess), and I think we should at least drop it in 1.2. The FFT tuning on the other hand runs and runs.... forever.

Have a good night.


---

Comment by zimmerma created at 2017-07-04 06:21:41

well, indeed doing `make tune` with `SAGE_FAT_BINARY=yes` does not make much sense.


---

Comment by git created at 2017-07-04 10:56:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-07-04 11:02:20

hopefully the last commit summarises the discussion right.
I have also removed the time limit `TOOM_TUNING_LIMIT=100`, it still builds in 2 minutes on my Linux desktop, with default settings.

I also checked that with `SAGE_FAT_BINARY=yes` it builds (very fast), and with 
`SAGE_TUNE_GF2X="full"` (triggering FFT tuning) it takes about 45 minutes to complete.


---

Comment by dimpase created at 2017-07-04 11:02:20

Changing status from new to needs_review.


---

Comment by embray created at 2017-07-04 12:21:01

Stupid question: Does the patchbot not test tickets that contain package updates?  I don't see any patchbot results for this ticket yet (I guess part of the question is it would need to know where to get the new tarball...?)


---

Comment by dimpase created at 2017-07-04 12:23:46

It takes a while for patchbots to start on a ticket. They should be able to get the tarball URL from the ticket description, I think...


---

Comment by embray created at 2017-07-04 12:38:45

Yes, I looked at the patchbot source code and it looks like it should be able (albeit a bit hackishly--maybe there should be a ticket field specifically for upstream tarballs).  I guess I just figured by now there'd be at least one.

Anyways, good to know.  I have a Cygwin patchbot running full time now so it should be able to give results.  It's just on a very slow machine right now--I'm working on getting more resources for it, hopefully soon.


---

Comment by fbissey created at 2017-07-05 03:07:17

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-07-05 03:07:17

Send it to the bots!


---

Comment by vbraun created at 2017-07-26 22:12:46

Resolution: fixed
