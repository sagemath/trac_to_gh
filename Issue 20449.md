# Issue 20449: Optimize method lookup from the categories for instances of Cython classes

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2016-05-26 13:36:13

CC:  jdemeyer tscrim

For instances of Cython classes, the inheritance from categories is
emulated by a manual lookup in
`sage.structure.element.Element.__getattr__`. This lookup is about 10
times slower than a normal method lookup::


```
sage: def foo(self): return
sage: Sets().element_class.foo = foo

sage: def g(x):
....:     for i in range(1000):
....:          x.foo()

sage: x = Semigroups().example().an_element()
sage: %timeit g(x)
10000 loops, best of 3: 115 Âµs per loop

sage: x = 1
sage: %timeit g(x)
1000 loops, best of 3: 1.18 ms per loop
```


So there should be room for optimization (or using a different
approach for emulating this inheritance).

First step: profiling ...


---

Comment by jdemeyer created at 2016-05-26 14:56:35

I might have some ideas... discuss in Meudon?


---

Comment by nthiery created at 2016-05-26 15:18:30

+1


---

Comment by jdemeyer created at 2016-06-14 15:13:30

New commits:


---

Comment by git created at 2016-06-14 15:58:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-06-14 19:56:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-06-14 20:54:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-06-15 10:26:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-06-15 11:52:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-06-15 11:52:57

Changing status from new to needs_review.


---

Comment by git created at 2016-06-15 13:05:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-06-15 18:41:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-06-15 19:17:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-06-15 21:35:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-06-16 07:39:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-06-17 14:32:13

Changing keywords from "" to "test".


---

Comment by embray created at 2016-06-17 14:32:27

Changing keywords from "test" to "".


---

Comment by git created at 2016-06-20 13:12:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-06-22 09:01:05

New commits:


---

Comment by jdemeyer created at 2016-06-22 09:03:55

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-06-22 09:04:07

Thanks Erik!


---

Comment by jdemeyer created at 2016-07-15 14:35:12

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-15 14:40:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-07-15 14:57:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-07-15 16:08:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-25 15:54:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-07-25 22:14:03

why is this test removed

```diff
-        We test that "private" attributes are not requested from the element class
-        of the category (:trac:`10467`)::
-
-            sage: C = EuclideanDomains()
-            sage: P.<x> = QQ[]
-            sage: C.element_class.__foo = 'bar'
-            sage: x.parent() in C
-            True
-            sage: x.__foo
-            Traceback (most recent call last):
-            ...
-            AttributeError: 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint' object has no attribute '__foo'
```



---

Comment by vdelecroix created at 2016-07-25 22:14:50

similarly

```diff
-        We test that "private" attributes are not requested from the element class
-        of the category (:trac:`10467`)::
-
-            sage: P = Parent(QQ, category=CommutativeRings())
-            sage: P.category().parent_class.__foo = 'bar'
-            sage: P.__foo
-            Traceback (most recent call last):
-            ...
-            AttributeError: 'sage.structure.parent.Parent' object has no attribute '__foo'
```



---

Comment by jdemeyer created at 2016-07-26 07:27:16

Replying to [comment:43 vdelecroix]:
> why is this test removed

Because #10467 was a mistake, see point 3 in the ticket description.


---

Comment by jdemeyer created at 2016-07-26 07:27:59

More precisely: see #10467#comment:18


---

Comment by jdemeyer created at 2016-07-26 15:07:09

Aargh....... this whole "category lookup" mechanism is causing me so much frustration with #20767. It is a very fragile hack which just happens to work correctly in the current setting but when you change anything in the coercion model it breaks.

I am starting to think we should reconsider the whole category approach.


---

Comment by nthiery created at 2016-07-26 21:14:58

In case this could be useful, we could have a live chat about this tomorrow between 11pm and 2pm, or latter in the week.

Cheers,


---

Comment by vdelecroix created at 2016-07-27 03:12:54

Replying to [comment:48 nthiery]:
> In case this could be useful, we could have a live chat about this tomorrow between 11pm and 2pm, or latter in the week.

You meant 11am-2pm? Given that Santiago is -6h from Paris, it will be hard for me before 2pm (=8am in Santiago).


---

Comment by jdemeyer created at 2016-07-27 07:52:50

I am available most days during Paris daytime...


---

Comment by jdemeyer created at 2016-07-27 13:20:35

Anyway, I am also hitting Cython bugs/oddities, so there are other battles to fight.


---

Comment by jdemeyer created at 2016-08-03 11:00:42

In #20767, I "solved" the category problem (see [comment:47]) in the following way:

- double-underscore methods (e.g. `__add__`) are never taken from the category.

- anything deriving directly from `Element` fully supports single-underscore methods (e.g. `_add_`) from the category.

- anything deriving from `ModuleElement`, `RingElement`,... has only partial support for single-underscore methods from the category.

- nothing changes for non-arithmetic methods (e.g. `base_ring`).

The above rules do not break any existing usage of categories. I hope you can live with this...


---

Comment by vdelecroix created at 2016-08-26 14:45:50

The following example of `getattr_from_other_class` line 249-253 in `sage/structure/misc.pyx` seems broken

```
sage: n = 1
sage: ip = get_ipython()
sage: ip.magic_psearch('n.N')
Traceback (most recent call last):
...
AttributeError: 'SageTerminalInteractiveShell' object has no attribute 'magic_psearch'
```



---

Comment by jdemeyer created at 2016-08-26 15:27:33

Replying to [comment:53 vdelecroix]:
> The following example of `getattr_from_other_class` line 249-253 in `sage/structure/misc.pyx` seems broken

True, but surely not because of this ticket. Most likely, it has to do with the IPython 5 upgrade.


---

Comment by vdelecroix created at 2016-08-26 16:00:46

Is that what we want

```
if self._category is None:
    # Usually, this will just raise AttributeError in
    # getattr_from_other_class().
    cls = type
else:
    cls = self._category.parent_class
```

In other words, are there use case where the category is not initialized but we still might need to go through `__getattr__`?


---

Comment by vdelecroix created at 2016-08-26 16:04:17

Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?


---

Comment by jdemeyer created at 2016-08-27 08:45:23

Replying to [comment:56 vdelecroix]:
> Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?

Mainly because I care more about `Element` than `Parent` (with #20767 in mind). The idea of `getattr_from_category` was to allow direct access to the category methods without normal methods. In the end, I am not using this in #20767 but I kept it because it looked potentially useful. And, since this a `cdef` method, there is essentially no performance penalty.


---

Comment by jdemeyer created at 2016-08-27 08:47:35

Replying to [comment:55 vdelecroix]:
> In other words, are there use case where the category is not initialized but we still might need to go through `__getattr__`?

Probably not, but the old code also supported that (directly raising an `AttributeError`). But I just let `getattr_from_other_class` raise the error.


---

Comment by vdelecroix created at 2016-08-30 13:46:02

Replying to [comment:57 jdemeyer]:
> Replying to [comment:56 vdelecroix]:
> > Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?
> 
> Mainly because I care more about `Element` than `Parent` (with #20767 in mind). The idea of `getattr_from_category` was to allow direct access to the category methods without normal methods. In the end, I am not using this in #20767 but I kept it because it looked potentially useful. And, since this a `cdef` method, there is essentially no performance penalty.

It just looks weird to have twice the same thing implemented differently. I am just complaining about readability.


---

Comment by jdemeyer created at 2016-08-31 07:58:40

Replying to [comment:59 vdelecroix]:
> It just looks weird to have twice the same thing implemented differently. I am just complaining about readability.

OK, I will make the requested changes. I will also move the category lookup stuff from `Parent` to `CategoryObject` where it belongs.


---

Comment by jdemeyer created at 2016-08-31 07:58:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-31 08:52:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-08-31 08:52:37

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-08-31 14:51:04

Do you know whether it is worth it to keep this `__cached_method` dictionary? I would be happy to see timings here. (though this is rather disjoint from the main preoccupation of this ticket)


---

Comment by vdelecroix created at 2016-08-31 14:53:27

In `CategoryObject.__getattr__`  it would better to do

```
try:
    return self.__cached_methods[name]
except KeyError:
    if self._category is None:
        cls = type
    else:
        cls = self._category.parent_class
    attr = getattr_from_other_class(self, cls, name)
    self.__cached_methods[name] = attr
    return attr
```



---

Comment by jdemeyer created at 2016-08-31 14:58:21

Replying to [comment:64 vdelecroix]:
> Do you know whether it is worth it to keep this `__cached_method` dictionary?

I would guess so since a lookup in a dictionary should be faster than whatever `getattr_from_other_class` is doing.


---

Comment by jdemeyer created at 2016-08-31 14:59:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-31 16:34:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-08-31 16:36:18

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-08-31 21:29:58

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-08-31 21:29:58

Got two failures with ptestlong

```
File "src/sage/combinat/root_system/integrable_representations.py", line 189, in sage.combinat.root_system.integrable_representations.IntegrableRepresentation.__init__
Failed example:
    TestSuite(V).run()
Expected nothing
Got:
   Failure in _test_additive_associativity:
   Traceback (most recent call last):
   ...
   AttributeError: 'IntegrableRepresentation' object has no attribute '_an_element_'
   ...
```

and similarly

```
**********************************************************************
File "src/sage/homology/hochschild_complex.py", line 98, in sage.homology.hochschild_complex.HochschildComplex.__init__
Failed example:
    TestSuite(H).run(skip="_test_category")
Expected nothing
Got:
    Failure in _test_additive_associativity:
    Traceback (most recent call last):
    ...
    AttributeError: 'HochschildComplex' object has no attribute '_an_element_'
    ...
```



---

Comment by vdelecroix created at 2016-08-31 21:31:51

And also not related to `_an_element_`

```
**********************************************************************
File "src/sage/combinat/root_system/integrable_representations.py", line 189, in sage.combinat.root_system.integrable_representations.IntegrableRepresentation.
__init__
Failed example:
    TestSuite(V).run()
Expected nothing
Got:
    ...
    Failure in _test_not_implemented_methods:
    Traceback (most recent call last):
    ...
    AssertionError: Not implemented method: __contains__
    ...
```



---

Comment by jdemeyer created at 2016-09-01 07:22:11

The last patchbot report was green, so this must be a recently-introduced problem.


---

Comment by jdemeyer created at 2016-09-01 08:21:04

Interestingly, these failures are for classes inheriting from `CategoryObject` but not `Parent`.


---

Comment by jdemeyer created at 2016-09-01 08:32:07

Those failures are true bugs in `HochschildComplex` and `IntegrableRepresentation`: they pretend to be in some category but do not actually implement everything needed to be in that category. This ticket causes the category tests to be run (which is good) but then the tests fail.


```
sage: SGA = SymmetricGroupAlgebra(QQ, 3)
sage: T = SGA.trivial_representation()
sage: H = SGA.hochschild_complex(T)
sage: H in CommutativeAdditiveGroups()
True
sage: H.zero()
...
TypeError: 'HochschildComplex' object is not callable
```


and


```
sage: Lambda = RootSystem(['A',3,1]).weight_lattice(extended=true).fundamental_weights()
sage: V = IntegrableRepresentation(Lambda[1]+Lambda[2]+Lambda[3])
sage: V in CommutativeAdditiveGroups()
True
sage: V.zero()
...
TypeError: 'IntegrableRepresentation' object is not callable
```


I think the right thing to do here is to mark those tests as `# known bug`.


---

Comment by git created at 2016-09-01 08:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-01 08:55:16

I created #21386 and #21387 for the broken testsuites.


---

Comment by jdemeyer created at 2016-09-01 08:55:16

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-09-01 13:52:36

I hope to fix both today.


---

Comment by vdelecroix created at 2016-09-01 14:22:12

good to go!


---

Comment by vdelecroix created at 2016-09-01 14:22:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-03 15:11:26

This ticket seems to cause #21409


---

Comment by vbraun created at 2016-09-04 13:38:02

Resolution: fixed
