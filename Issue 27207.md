# Issue 27207: Expose multithreaded fflas-ffpack features

archive/issues_027207.json:
```json
{
    "body": "CC:  cpernet\n\nDense linear algebra mod small p uses fflas-ffpack over float or double.\nThis library support multithreading for some routines: \n- matrix-matrix multiplication\n- PLUQ decomposition\n- etc.\n\nThis ticket proposes to expose these parallel variants to Sage user.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27444\n\n",
    "created_at": "2019-03-08T09:49:11Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "Expose multithreaded fflas-ffpack features",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27207",
    "user": "@ZHG2017"
}
```
CC:  cpernet

Dense linear algebra mod small p uses fflas-ffpack over float or double.
This library support multithreading for some routines: 
- matrix-matrix multiplication
- PLUQ decomposition
- etc.

This ticket proposes to expose these parallel variants to Sage user.

Issue created by migration from https://trac.sagemath.org/ticket/27444





---

archive/issue_comments_383328.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-15T11:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383328",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383329.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-15T14:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383329",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383330.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-20T17:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383330",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383331.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-21T13:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383331",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383332.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-21T17:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383332",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383333.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-21T17:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383333",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383334.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-22T08:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383334",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383335.json:
```json
{
    "body": "For the record: matrix multiplication over finite field works in parallel. The following experiment is on a 12 cores Intel skylake-x server:\n\n```\npernet@retourdest:~/soft/sage$ export OMP_NUM_THREADS=12;./sage \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.7.beta7, Release Date: 2019-03-10               \u2502\n\u2502 Using Python 2.7.15. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: a=random_matrix(GF(11),10000)\nsage: time b=a*a\nCPU times: user 23.3 s, sys: 405 ms, total: 23.7 s\nWall time: 3.3 s\n```\n\nwhile on the same machine, on master we get:\n\n```\nsage: a=random_matrix(GF(11),10000)\nsage: time b=a*a\nCPU times: user 18.4 s, sys: 211 ms, total: 18.6 s\nWall time: 18.7 s\n```\n\n\nThe speed-up of 6 for a 12 core machine is below what a self-standing fflas-ffpack achieves.\nWe need to investigate the reasons: alignment, strassen-winograd threshold, numa placement, etc.",
    "created_at": "2019-03-22T10:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383335",
    "user": "cpernet"
}
```

For the record: matrix multiplication over finite field works in parallel. The following experiment is on a 12 cores Intel skylake-x server:

```
pernet@retourdest:~/soft/sage$ export OMP_NUM_THREADS=12;./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.7.beta7, Release Date: 2019-03-10               │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: a=random_matrix(GF(11),10000)
sage: time b=a*a
CPU times: user 23.3 s, sys: 405 ms, total: 23.7 s
Wall time: 3.3 s
```

while on the same machine, on master we get:

```
sage: a=random_matrix(GF(11),10000)
sage: time b=a*a
CPU times: user 18.4 s, sys: 211 ms, total: 18.6 s
Wall time: 18.7 s
```


The speed-up of 6 for a 12 core machine is below what a self-standing fflas-ffpack achieves.
We need to investigate the reasons: alignment, strassen-winograd threshold, numa placement, etc.



---

archive/issue_comments_383336.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383336",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_383337.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-26T09:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383337",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383338.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-27T12:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383338",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383339.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383339",
    "user": "embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_383340.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-20T13:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383340",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383341.json:
```json
{
    "body": "I confirm that the branch successfullly parallizes det, rank and echelonize. However, in the current version of the branch, the matrix product is no longer parallelized. Could you revert the call to pfgemm?",
    "created_at": "2019-06-27T11:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383341",
    "user": "cpernet"
}
```

I confirm that the branch successfullly parallizes det, rank and echelonize. However, in the current version of the branch, the matrix product is no longer parallelized. Could you revert the call to pfgemm?



---

archive/issue_comments_383342.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-27T12:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383342",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383343.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-26T18:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383343",
    "user": "cpernet"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_383344.json:
```json
{
    "body": "I pushed a fix to a misplaced \"noefd\" algorithm specification. This seems to fix the broken doctests.\n----\nNew commits:",
    "created_at": "2019-08-27T08:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383344",
    "user": "cpernet"
}
```

I pushed a fix to a misplaced "noefd" algorithm specification. This seems to fix the broken doctests.
----
New commits:



---

archive/issue_comments_383345.json:
```json
{
    "body": "I'm curious about these:\n\n\n```\nif m*n > 100000: sig_on()\n```\n\n\nAny reason not to always call `sig_on()`?",
    "created_at": "2019-08-27T19:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383345",
    "user": "defeo"
}
```

I'm curious about these:


```
if m*n > 100000: sig_on()
```


Any reason not to always call `sig_on()`?



---

archive/issue_comments_383346.json:
```json
{
    "body": "Docs need updating.\n\nIn `parallelism.py`:\n\n> EXAMPLES:\n>\n> The number of processes is initialized to 1 (no parallelization) for each field **(only tensor computations are implemented at the moment)**:\n\nAlso, it would be good to document in the matrix reference the availability of parallelism, like it is done in http://doc.sagemath.org/html/en/reference/tensor_free_modules/sage/tensor/modules/free_module_tensor.html#sage.tensor.modules.free_module_tensor.FreeModuleTensor.disp",
    "created_at": "2019-08-27T20:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383346",
    "user": "defeo"
}
```

Docs need updating.

In `parallelism.py`:

> EXAMPLES:
>
> The number of processes is initialized to 1 (no parallelization) for each field **(only tensor computations are implemented at the moment)**:

Also, it would be good to document in the matrix reference the availability of parallelism, like it is done in http://doc.sagemath.org/html/en/reference/tensor_free_modules/sage/tensor/modules/free_module_tensor.html#sage.tensor.modules.free_module_tensor.FreeModuleTensor.disp



---

archive/issue_comments_383347.json:
```json
{
    "body": "Otherwise, I confirm there is no regression with Python 3. If you can fix the docs, this ticket is good for me.",
    "created_at": "2019-08-27T21:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383347",
    "user": "defeo"
}
```

Otherwise, I confirm there is no regression with Python 3. If you can fix the docs, this ticket is good for me.



---

archive/issue_comments_383348.json:
```json
{
    "body": "Replying to [comment:24 defeo]:\n> I'm curious about these:\n> \n> {{{\n> if m*n > 100000: sig_on()\n> }}}\n> \n> Any reason not to always call `sig_on()`?\n\nI guess the reason is to avoid the overhead of using the sigs when the call is with a tiny instance which runs almost instantly and will therefore have no chance of being interrupted.",
    "created_at": "2019-08-28T07:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383348",
    "user": "cpernet"
}
```

Replying to [comment:24 defeo]:
> I'm curious about these:
> 
> {{{
> if m*n > 100000: sig_on()
> }}}
> 
> Any reason not to always call `sig_on()`?

I guess the reason is to avoid the overhead of using the sigs when the call is with a tiny instance which runs almost instantly and will therefore have no chance of being interrupted.



---

archive/issue_comments_383349.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-28T15:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383349",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383350.json:
```json
{
    "body": "`@`defeo: Doc fixed in the above commit. Should be good to go now.",
    "created_at": "2019-08-28T15:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383350",
    "user": "cpernet"
}
```

`@`defeo: Doc fixed in the above commit. Should be good to go now.



---

archive/issue_comments_383351.json:
```json
{
    "body": "The ticket has no authors?",
    "created_at": "2019-08-28T16:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383351",
    "user": "defeo"
}
```

The ticket has no authors?



---

archive/issue_comments_383352.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-28T16:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383352",
    "user": "defeo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_383353.json:
```json
{
    "body": "and no milestone ?",
    "created_at": "2019-08-28T19:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383353",
    "user": "chapoton"
}
```

and no milestone ?



---

archive/issue_comments_383354.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-09-02T21:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383354",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_383355.json:
```json
{
    "body": "I don't think this ticket should have removed `--disable-openmp` from the fflas_ffpack build without mention, because now it requires OpenMP support in any modules which link to it, and this doesn't seem to work properly.",
    "created_at": "2019-10-07T16:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27207#issuecomment-383355",
    "user": "embray"
}
```

I don't think this ticket should have removed `--disable-openmp` from the fflas_ffpack build without mention, because now it requires OpenMP support in any modules which link to it, and this doesn't seem to work properly.
