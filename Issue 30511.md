# Issue 30511: Replace startup exception by warning

archive/issues_030511.json:
```json
{
    "body": "CC:  mkoeppe chapoton tscrim\n\nIn #22752 it was introduced that when a lazy import is used during startup, then an RuntimeException is thrown. This leads to problems if you want to use code with lazy imports in a library mode (e.g. in standalone tests or python scripts). To support these use cases, I've degraded the exception to a print statement.\n\nAnother possible solution would be to also introduce a `start_startup` method that is used at the very beginning of loading sage, and then only consider everything between `start_startup` and `finish_startup` as \"startup\".\n\nIssue created by migration from https://trac.sagemath.org/ticket/30748\n\n",
    "created_at": "2020-10-08T21:53:33Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "Replace startup exception by warning",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30511",
    "user": "@tobiasdiez"
}
```
CC:  mkoeppe chapoton tscrim

In #22752 it was introduced that when a lazy import is used during startup, then an RuntimeException is thrown. This leads to problems if you want to use code with lazy imports in a library mode (e.g. in standalone tests or python scripts). To support these use cases, I've degraded the exception to a print statement.

Another possible solution would be to also introduce a `start_startup` method that is used at the very beginning of loading sage, and then only consider everything between `start_startup` and `finish_startup` as "startup".

Issue created by migration from https://trac.sagemath.org/ticket/30748





---

archive/issue_comments_435553.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-08T21:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435553",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435554.json:
```json
{
    "body": "Perhaps the start_startup....finish_startup could be a context manager?",
    "created_at": "2020-10-08T22:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435554",
    "user": "mkoeppe"
}
```

Perhaps the start_startup....finish_startup could be a context manager?



---

archive/issue_comments_435555.json:
```json
{
    "body": "I like the idea! Where is the startup code located? I couldn't find the global \"import sage.all\". \n\nSecond question, is how LazyImport gets access to the global startup guard. Should this be done via `global`?",
    "created_at": "2020-10-09T07:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435555",
    "user": "@tobiasdiez"
}
```

I like the idea! Where is the startup code located? I couldn't find the global "import sage.all". 

Second question, is how LazyImport gets access to the global startup guard. Should this be done via `global`?



---

archive/issue_comments_435556.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-11T15:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435556",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435557.json:
```json
{
    "body": "I've now implemented the idea with the context manager.",
    "created_at": "2020-10-11T15:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435557",
    "user": "@tobiasdiez"
}
```

I've now implemented the idea with the context manager.



---

archive/issue_comments_435558.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-02T19:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435558",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435559.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-05T18:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435559",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435560.json:
```json
{
    "body": "Doctests fail (are not in the correct format), see patchbot output",
    "created_at": "2020-11-05T18:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435560",
    "user": "mkoeppe"
}
```

Doctests fail (are not in the correct format), see patchbot output



---

archive/issue_comments_435561.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-07T20:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435561",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435562.json:
```json
{
    "body": "Should be fixed now.",
    "created_at": "2020-11-07T20:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435562",
    "user": "@tobiasdiez"
}
```

Should be fixed now.



---

archive/issue_comments_435563.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-07T20:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435563",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435564.json:
```json
{
    "body": "Patchbot still complains",
    "created_at": "2020-11-08T00:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435564",
    "user": "mkoeppe"
}
```

Patchbot still complains



---

archive/issue_comments_435565.json:
```json
{
    "body": "The pyflakes warnings are not related to my changes, and the additional startup_module is also expected since `startup_guard` is now a new class. So I'm not sure what I can/should do.",
    "created_at": "2020-11-08T13:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435565",
    "user": "@tobiasdiez"
}
```

The pyflakes warnings are not related to my changes, and the additional startup_module is also expected since `startup_guard` is now a new class. So I'm not sure what I can/should do.



---

archive/issue_comments_435566.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-09T03:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435566",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435567.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> Patchbot still complains\n... take a look at \"shortlog\" and you will see many errors.",
    "created_at": "2020-11-09T03:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435567",
    "user": "mkoeppe"
}
```

Replying to [comment:11 mkoeppe]:
> Patchbot still complains
... take a look at "shortlog" and you will see many errors.



---

archive/issue_comments_435568.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-09T11:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435568",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435569.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-09T11:05:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435569",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435570.json:
```json
{
    "body": "Ah thanks, wasn't aware of these links before. Should be fixed now (hopefully).",
    "created_at": "2020-11-09T11:05:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435570",
    "user": "@tobiasdiez"
}
```

Ah thanks, wasn't aware of these links before. Should be fixed now (hopefully).



---

archive/issue_comments_435571.json:
```json
{
    "body": "please set back to needs review when the doctests succeed",
    "created_at": "2020-11-09T16:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435571",
    "user": "mkoeppe"
}
```

please set back to needs review when the doctests succeed



---

archive/issue_comments_435572.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-09T16:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435572",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435573.json:
```json
{
    "body": "Sorry, I thought I've fixed all doctests.\n\nOn a closer inspection, now a lot of doctests are failing because of this warnings `print('Option ``at_startup=True`` for lazy import {0} not needed anymore'.format(self._name))`. I have to admit I don't really understand the purpose of this message, but I guess it should be shown if `lazy_import` is used with `at_startup = true` but sage is actually not loading at this point. If that's the case, then the current output of these doctests seems to be correct now, but I'm not sure why these warnings were not shown before.",
    "created_at": "2020-11-09T21:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435573",
    "user": "@tobiasdiez"
}
```

Sorry, I thought I've fixed all doctests.

On a closer inspection, now a lot of doctests are failing because of this warnings `print('Option ``at_startup=True`` for lazy import {0} not needed anymore'.format(self._name))`. I have to admit I don't really understand the purpose of this message, but I guess it should be shown if `lazy_import` is used with `at_startup = true` but sage is actually not loading at this point. If that's the case, then the current output of these doctests seems to be correct now, but I'm not sure why these warnings were not shown before.



---

archive/issue_comments_435574.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-12T09:39:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435574",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435575.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-12T10:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435575",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435576.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-12T11:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435576",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435577.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-12T12:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435577",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435578.json:
```json
{
    "body": "I would appreciate if this could be reviewed relatively soon, as it's blocking my local development (I've to include it in every branch I'm working on). Thanks!",
    "created_at": "2020-12-06T15:03:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435578",
    "user": "@tobiasdiez"
}
```

I would appreciate if this could be reviewed relatively soon, as it's blocking my local development (I've to include it in every branch I'm working on). Thanks!



---

archive/issue_comments_435579.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435579",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_435580.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435580",
    "user": "mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_435581.json:
```json
{
    "body": "Did you had a chance to look at this ticket during the Sage days?",
    "created_at": "2020-12-18T21:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435581",
    "user": "@tobiasdiez"
}
```

Did you had a chance to look at this ticket during the Sage days?



---

archive/issue_comments_435582.json:
```json
{
    "body": "Yes, briefly. Overall I'm not convinced by the change to a context manager (which I had suggested). So let's please split this ticket please into a minimal change (error to warning) and defer the change to using a context manager for later consideration.",
    "created_at": "2020-12-19T05:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435582",
    "user": "mkoeppe"
}
```

Yes, briefly. Overall I'm not convinced by the change to a context manager (which I had suggested). So let's please split this ticket please into a minimal change (error to warning) and defer the change to using a context manager for later consideration.



---

archive/issue_comments_435583.json:
```json
{
    "body": "Ok, I've extracted it to #31080. But I would still ask you to also review this ticket, as otherwise I have to subtract it from some of my other tickets (which is not as easy as just pulling the new version of a branch).\n\nWhy don't you like the context manager? I think it's the right tool, as we are managing a local state.",
    "created_at": "2020-12-19T09:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435583",
    "user": "@tobiasdiez"
}
```

Ok, I've extracted it to #31080. But I would still ask you to also review this ticket, as otherwise I have to subtract it from some of my other tickets (which is not as easy as just pulling the new version of a branch).

Why don't you like the context manager? I think it's the right tool, as we are managing a local state.



---

archive/issue_comments_435584.json:
```json
{
    "body": "Making changes always has a cost, and the benefit here is not clear.\n\nWe only have a small number of developers who know about the details of the issues with circular imports in sage. Changing code makes it harder for them to contribute later.",
    "created_at": "2020-12-19T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435584",
    "user": "mkoeppe"
}
```

Making changes always has a cost, and the benefit here is not clear.

We only have a small number of developers who know about the details of the issues with circular imports in sage. Changing code makes it harder for them to contribute later.



---

archive/issue_comments_435585.json:
```json
{
    "body": "Replying to [comment:27 gh-tobiasdiez]:\n> Why don't you like the context manager? I think it's the right tool, as we are managing a local state.\n\nI also thought it could be the right tool -- but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865)",
    "created_at": "2020-12-19T18:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435585",
    "user": "mkoeppe"
}
```

Replying to [comment:27 gh-tobiasdiez]:
> Why don't you like the context manager? I think it's the right tool, as we are managing a local state.

I also thought it could be the right tool -- but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865)



---

archive/issue_comments_435586.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-19T21:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435586",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435587.json:
```json
{
    "body": "I've thought about this again and realized that one actually would like to neither throw an error nor print an error message. Instead one should try to catch the resolved import already during development time. Thus, I've now implemented it as a doctest that fails as soon as there are resolved imports during startup.\n\nWhat do you think?",
    "created_at": "2020-12-19T21:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435587",
    "user": "@tobiasdiez"
}
```

I've thought about this again and realized that one actually would like to neither throw an error nor print an error message. Instead one should try to catch the resolved import already during development time. Thus, I've now implemented it as a doctest that fails as soon as there are resolved imports during startup.

What do you think?



---

archive/issue_comments_435588.json:
```json
{
    "body": "I think I agree but this is orthogonal to the conversion to a context manager -- so shouldn't this be done in #31080 instead?",
    "created_at": "2020-12-19T21:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435588",
    "user": "mkoeppe"
}
```

I think I agree but this is orthogonal to the conversion to a context manager -- so shouldn't this be done in #31080 instead?



---

archive/issue_comments_435589.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-20T11:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435589",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435590.json:
```json
{
    "body": "I needed the context manager to write the tests.\n\n> but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865) \n\nWhat does the context manager has to do with modularization? It sets only the IS_STARTUP flag...",
    "created_at": "2020-12-20T11:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435590",
    "user": "@tobiasdiez"
}
```

I needed the context manager to write the tests.

> but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865) 

What does the context manager has to do with modularization? It sets only the IS_STARTUP flag...



---

archive/issue_comments_435591.json:
```json
{
    "body": "How is the startup phase defined?",
    "created_at": "2020-12-20T18:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435591",
    "user": "mkoeppe"
}
```

How is the startup phase defined?



---

archive/issue_comments_435592.json:
```json
{
    "body": "It's essentially equivalent to \"during the import of sage.all\", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).",
    "created_at": "2020-12-20T19:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435592",
    "user": "@tobiasdiez"
}
```

It's essentially equivalent to "during the import of sage.all", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).



---

archive/issue_comments_435593.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-20T19:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435593",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435594.json:
```json
{
    "body": "Replying to [comment:37 gh-tobiasdiez]:\n> It's essentially equivalent to \"during the import of sage.all\", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).\nWell, the concept of `sage.all` will certainly be affected by the modularization...",
    "created_at": "2020-12-20T19:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435594",
    "user": "mkoeppe"
}
```

Replying to [comment:37 gh-tobiasdiez]:
> It's essentially equivalent to "during the import of sage.all", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).
Well, the concept of `sage.all` will certainly be affected by the modularization...



---

archive/issue_comments_435595.json:
```json
{
    "body": "Sure, but in a modularized setting you probably don't need this check since it's only purpose right now is to make sure that lazy imports are indeed lazy and not already resolved during startup. If that's the case for sage.all, then it's also the case for sub-modules.\n\nIn either case, the startup context manager will make it easy to define also other parts as startup in a modularized setting in case this is necessary.",
    "created_at": "2020-12-20T19:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435595",
    "user": "@tobiasdiez"
}
```

Sure, but in a modularized setting you probably don't need this check since it's only purpose right now is to make sure that lazy imports are indeed lazy and not already resolved during startup. If that's the case for sage.all, then it's also the case for sub-modules.

In either case, the startup context manager will make it easy to define also other parts as startup in a modularized setting in case this is necessary.



---

archive/issue_comments_435596.json:
```json
{
    "body": "Without code that's a little bit too vague, which is why it's too early to do this ticket. In particular, it's unclear whether a single flag / context manager can really do the job for several modules.",
    "created_at": "2020-12-20T20:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435596",
    "user": "mkoeppe"
}
```

Without code that's a little bit too vague, which is why it's too early to do this ticket. In particular, it's unclear whether a single flag / context manager can really do the job for several modules.



---

archive/issue_comments_435597.json:
```json
{
    "body": "I agree, but the new code is still an improvement over the current one in my opinion (which used a custom-build context manager in some sense). So can we please not hold this ticket off, just because there might be possible changes in the future...\n\nMoreover, the startup manager can easily be extended to handle multiple startup contexts by passing the context name as an argument to the `startup` method, including neasting etc because we use a context manager (which is not easily possible with the current code).",
    "created_at": "2020-12-20T20:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435597",
    "user": "@tobiasdiez"
}
```

I agree, but the new code is still an improvement over the current one in my opinion (which used a custom-build context manager in some sense). So can we please not hold this ticket off, just because there might be possible changes in the future...

Moreover, the startup manager can easily be extended to handle multiple startup contexts by passing the context name as an argument to the `startup` method, including neasting etc because we use a context manager (which is not easily possible with the current code).



---

archive/issue_comments_435598.json:
```json
{
    "body": "Replying to [comment:35 gh-tobiasdiez]:\n> I needed the context manager to write the tests.\n\nI don't think so, the same thing can be done in the original code",
    "created_at": "2020-12-20T20:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435598",
    "user": "mkoeppe"
}
```

Replying to [comment:35 gh-tobiasdiez]:
> I needed the context manager to write the tests.

I don't think so, the same thing can be done in the original code



---

archive/issue_comments_435599.json:
```json
{
    "body": "By the way, I would guess that also the print message \n\n```\n   print(f\"Option ``at_startup=True`` for lazy import {self._name} not needed anymore\"`\n```\n\nshould be handled in the doctest as well instead of printing at runtime.",
    "created_at": "2020-12-20T20:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435599",
    "user": "mkoeppe"
}
```

By the way, I would guess that also the print message 

```
   print(f"Option ``at_startup=True`` for lazy import {self._name} not needed anymore"`
```

should be handled in the doctest as well instead of printing at runtime.



---

archive/issue_comments_435600.json:
```json
{
    "body": "Replying to [comment:43 mkoeppe]:\n> Replying to [comment:35 gh-tobiasdiez]:\n> > I needed the context manager to write the tests.\n> \n> I don't think so, the same thing can be done in the original code\n\nI was not able to, but you are invited to try (although its more time effective to just review this ticket...).",
    "created_at": "2020-12-20T20:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435600",
    "user": "@tobiasdiez"
}
```

Replying to [comment:43 mkoeppe]:
> Replying to [comment:35 gh-tobiasdiez]:
> > I needed the context manager to write the tests.
> 
> I don't think so, the same thing can be done in the original code

I was not able to, but you are invited to try (although its more time effective to just review this ticket...).



---

archive/issue_comments_435601.json:
```json
{
    "body": "Replying to [comment:44 mkoeppe]:\n> By the way, I would guess that also the print message \n> {{{\n>    print(f\"Option ``at_startup=True`` for lazy import {self._name} not needed anymore\"`\n> }}}\n> should be handled in the doctest as well instead of printing at runtime.\n\nGood point, something for a followup ticket.",
    "created_at": "2020-12-20T20:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435601",
    "user": "@tobiasdiez"
}
```

Replying to [comment:44 mkoeppe]:
> By the way, I would guess that also the print message 
> {{{
>    print(f"Option ``at_startup=True`` for lazy import {self._name} not needed anymore"`
> }}}
> should be handled in the doctest as well instead of printing at runtime.

Good point, something for a followup ticket.



---

archive/issue_comments_435602.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-29T10:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435602",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435603.json:
```json
{
    "body": "How should we proceed with this ticket?",
    "created_at": "2021-01-15T12:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435603",
    "user": "@tobiasdiez"
}
```

How should we proceed with this ticket?



---

archive/issue_comments_435604.json:
```json
{
    "body": "As previously suggested, we defer it until the design constraints from modularization become clearer.",
    "created_at": "2021-01-15T18:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435604",
    "user": "mkoeppe"
}
```

As previously suggested, we defer it until the design constraints from modularization become clearer.



---

archive/issue_comments_435605.json:
```json
{
    "body": "What's the status of the modularization? Any new input that is relevant for this PR?",
    "created_at": "2021-05-18T07:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435605",
    "user": "@tobiasdiez"
}
```

What's the status of the modularization? Any new input that is relevant for this PR?



---

archive/issue_comments_435606.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435606",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_435607.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-11-30T00:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435607",
    "user": "mjo"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_435608.json:
```json
{
    "body": "We now have a number of small, medium, and large distributions (see #29705 for distribution names in boldface, in particular on tickets that need review), so the question of how to organize startup could be investigated with concrete examples.",
    "created_at": "2021-11-30T00:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435608",
    "user": "mkoeppe"
}
```

We now have a number of small, medium, and large distributions (see #29705 for distribution names in boldface, in particular on tickets that need review), so the question of how to organize startup could be investigated with concrete examples.



---

archive/issue_comments_435609.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-30T14:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435609",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435610.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-30T15:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435610",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435611.json:
```json
{
    "body": "As far as I can see (please correct me if I'm wrong), the other (distribution) packages don't use `sage.all` and thus shouldn't be affected by the changes to the startup guard.\n\nI've now introduced a third \"startup state\" (Uninitialized) that represents that sage is used without `sage.all` (or before `sage.all` is imported), e.g. in a modularized environment. This makes it possible to fix #32619 in a more ergonomic way.\n\nFrom my point of view this is ready for review.",
    "created_at": "2021-11-30T16:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435611",
    "user": "@tobiasdiez"
}
```

As far as I can see (please correct me if I'm wrong), the other (distribution) packages don't use `sage.all` and thus shouldn't be affected by the changes to the startup guard.

I've now introduced a third "startup state" (Uninitialized) that represents that sage is used without `sage.all` (or before `sage.all` is imported), e.g. in a modularized environment. This makes it possible to fix #32619 in a more ergonomic way.

From my point of view this is ready for review.



---

archive/issue_comments_435612.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-11-30T16:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435612",
    "user": "@tobiasdiez"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_435613.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-30T16:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435613",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435614.json:
```json
{
    "body": "This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions",
    "created_at": "2021-11-30T18:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435614",
    "user": "mkoeppe"
}
```

This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions



---

archive/issue_comments_435615.json:
```json
{
    "body": "Replying to [comment:59 mkoeppe]:\n> This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions\n\nDid you already found the time to test it?",
    "created_at": "2021-12-28T18:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435615",
    "user": "@tobiasdiez"
}
```

Replying to [comment:59 mkoeppe]:
> This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions

Did you already found the time to test it?



---

archive/issue_comments_435616.json:
```json
{
    "body": "I have been testing this for a while now with #32432, and there are no problems. (As you point out in comment:57, it's not really being invoked in this context). On the other hand, I don't have additional evidence yet that this change going in a useful direction for modularization.",
    "created_at": "2022-03-20T17:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435616",
    "user": "mkoeppe"
}
```

I have been testing this for a while now with #32432, and there are no problems. (As you point out in comment:57, it's not really being invoked in this context). On the other hand, I don't have additional evidence yet that this change going in a useful direction for modularization.



---

archive/issue_comments_435617.json:
```json
{
    "body": "I confirm that it fixes the error shown by `./sage -t src/sage/all.py` noted in the ticket description of #33531 (the error is replaced by 21 pytest warnings).\n\nTests pass.",
    "created_at": "2022-03-20T17:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435617",
    "user": "mkoeppe"
}
```

I confirm that it fixes the error shown by `./sage -t src/sage/all.py` noted in the ticket description of #33531 (the error is replaced by 21 pytest warnings).

Tests pass.



---

archive/issue_comments_435618.json:
```json
{
    "body": "I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement as it converts the state management to a local thing, removing the \"external\" component.\n\nAlso the design should be flexible enough to incorporate new needs that may arise in the context of modularization.",
    "created_at": "2022-03-20T17:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435618",
    "user": "@tobiasdiez"
}
```

I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement as it converts the state management to a local thing, removing the "external" component.

Also the design should be flexible enough to incorporate new needs that may arise in the context of modularization.



---

archive/issue_comments_435619.json:
```json
{
    "body": "Replying to [comment:65 gh-tobiasdiez]:\n> I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement\n\nYes, it's good that there's a start now.",
    "created_at": "2022-03-20T17:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435619",
    "user": "mkoeppe"
}
```

Replying to [comment:65 gh-tobiasdiez]:
> I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement

Yes, it's good that there's a start now.



---

archive/issue_comments_435620.json:
```json
{
    "body": "But I don't understand the semantics of `startup`. Why would it allow going from FINISHED back to RUNNING?",
    "created_at": "2022-03-20T17:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435620",
    "user": "mkoeppe"
}
```

But I don't understand the semantics of `startup`. Why would it allow going from FINISHED back to RUNNING?



---

archive/issue_comments_435621.json:
```json
{
    "body": "That's needed due to the nature of how the doctests are invoked. At the beginning sage/all is imported, so the state is already \"FINISHED\". In order to write a meaningful test, one has to be able to reset this state (this is similar to the old test_fake_startup method).",
    "created_at": "2022-03-20T17:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435621",
    "user": "@tobiasdiez"
}
```

That's needed due to the nature of how the doctests are invoked. At the beginning sage/all is imported, so the state is already "FINISHED". In order to write a meaningful test, one has to be able to reset this state (this is similar to the old test_fake_startup method).



---

archive/issue_comments_435622.json:
```json
{
    "body": "I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.",
    "created_at": "2022-03-20T17:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435622",
    "user": "mkoeppe"
}
```

I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.



---

archive/issue_comments_435623.json:
```json
{
    "body": "And actually I don't think `startup_guard` should be a new separate module.",
    "created_at": "2022-03-20T17:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435623",
    "user": "mkoeppe"
}
```

And actually I don't think `startup_guard` should be a new separate module.



---

archive/issue_comments_435624.json:
```json
{
    "body": "Replying to [comment:69 mkoeppe]:\n> I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.\n\nI'm not sure, but what output would you expect from\n\n```\nwith startup_guard.startup():\n   print(startup_guard.startup_state)\n\nprint(startup_guard.startup_state)\n\nwith startup_guard.startup():\n   print(startup_guard.startup_state)\n```\n\nSince this is now a proper guard, for me \"RUNNING, FINISHED, RUNNING\" feels correctly.",
    "created_at": "2022-03-20T17:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435624",
    "user": "@tobiasdiez"
}
```

Replying to [comment:69 mkoeppe]:
> I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.

I'm not sure, but what output would you expect from

```
with startup_guard.startup():
   print(startup_guard.startup_state)

print(startup_guard.startup_state)

with startup_guard.startup():
   print(startup_guard.startup_state)
```

Since this is now a proper guard, for me "RUNNING, FINISHED, RUNNING" feels correctly.



---

archive/issue_comments_435625.json:
```json
{
    "body": "Replying to [comment:70 mkoeppe]:\n> And actually I don't think `startup_guard` should be a new separate module. \n\nWhere would you put it?",
    "created_at": "2022-03-20T17:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435625",
    "user": "@tobiasdiez"
}
```

Replying to [comment:70 mkoeppe]:
> And actually I don't think `startup_guard` should be a new separate module. 

Where would you put it?



---

archive/issue_comments_435626.json:
```json
{
    "body": "Where it was - lazy_import.",
    "created_at": "2022-03-20T17:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435626",
    "user": "mkoeppe"
}
```

Where it was - lazy_import.



---

archive/issue_comments_435627.json:
```json
{
    "body": "Replying to [comment:71 gh-tobiasdiez]:\n> Since this is now a proper guard, for me \"RUNNING, FINISHED, RUNNING\" feels correctly.\n\nIt makes no sense to discuss this abstractly, without reference to what the guard protects.",
    "created_at": "2022-03-20T17:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435627",
    "user": "mkoeppe"
}
```

Replying to [comment:71 gh-tobiasdiez]:
> Since this is now a proper guard, for me "RUNNING, FINISHED, RUNNING" feels correctly.

It makes no sense to discuss this abstractly, without reference to what the guard protects.



---

archive/issue_comments_435628.json:
```json
{
    "body": "Replying to [comment:73 mkoeppe]:\n> Where it was - lazy_import.\n\nI guess these points are connected. For me the guard is a general \"we in the progress of starting sage\", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.",
    "created_at": "2022-03-20T18:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435628",
    "user": "@tobiasdiez"
}
```

Replying to [comment:73 mkoeppe]:
> Where it was - lazy_import.

I guess these points are connected. For me the guard is a general "we in the progress of starting sage", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.



---

archive/issue_comments_435629.json:
```json
{
    "body": "Replying to [comment:74 mkoeppe]:\n> Replying to [comment:71 gh-tobiasdiez]:\n> > Since this is now a proper guard, for me \"RUNNING, FINISHED, RUNNING\" feels correctly.\n> \n> It makes no sense to discuss this abstractly, without reference to what the guard protects.\n\nThat feels like an abstract answer (a bit of pun intended). Of course the startup guard signals that sage is starting (or if you want that lazy imports are lazy). So with that, what is the expected behavior of\n\n```\nwith startup_guard.startup():\n   lazy_import(xyz1)\n\nlazy_import(xyz2)\n\nwith startup_guard.startup():\n   lazy_import(xyz3)\n```\n\n\nI would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily.",
    "created_at": "2022-03-20T18:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435629",
    "user": "@tobiasdiez"
}
```

Replying to [comment:74 mkoeppe]:
> Replying to [comment:71 gh-tobiasdiez]:
> > Since this is now a proper guard, for me "RUNNING, FINISHED, RUNNING" feels correctly.
> 
> It makes no sense to discuss this abstractly, without reference to what the guard protects.

That feels like an abstract answer (a bit of pun intended). Of course the startup guard signals that sage is starting (or if you want that lazy imports are lazy). So with that, what is the expected behavior of

```
with startup_guard.startup():
   lazy_import(xyz1)

lazy_import(xyz2)

with startup_guard.startup():
   lazy_import(xyz3)
```


I would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily.



---

archive/issue_comments_435630.json:
```json
{
    "body": "Replying to [comment:76 gh-tobiasdiez]:\n> I would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily. \n\nNo, that's absolutely not what the intended semantics is. lazy imports are always lazy.",
    "created_at": "2022-03-20T18:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435630",
    "user": "mkoeppe"
}
```

Replying to [comment:76 gh-tobiasdiez]:
> I would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily. 

No, that's absolutely not what the intended semantics is. lazy imports are always lazy.



---

archive/issue_comments_435631.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-20T18:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435631",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435632.json:
```json
{
    "body": "Replying to [comment:75 gh-tobiasdiez]:\n> For me the guard is a general \"we in the progress of starting sage\", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.\n\nI'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.",
    "created_at": "2022-03-20T18:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435632",
    "user": "mkoeppe"
}
```

Replying to [comment:75 gh-tobiasdiez]:
> For me the guard is a general "we in the progress of starting sage", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.

I'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.



---

archive/issue_comments_435633.json:
```json
{
    "body": "Replying to [comment:79 mkoeppe]:\n> Replying to [comment:75 gh-tobiasdiez]:\n> > For me the guard is a general \"we in the progress of starting sage\", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.\n> \n> I'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.\n\nThe code above was of course only meant schematically. Read \"what should be imported directly\" as \"what is the output of _get_imports_resolved_at_startup\".",
    "created_at": "2022-03-20T18:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435633",
    "user": "@tobiasdiez"
}
```

Replying to [comment:79 mkoeppe]:
> Replying to [comment:75 gh-tobiasdiez]:
> > For me the guard is a general "we in the progress of starting sage", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.
> 
> I'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.

The code above was of course only meant schematically. Read "what should be imported directly" as "what is the output of _get_imports_resolved_at_startup".



---

archive/issue_comments_435634.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-04-05T15:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435634",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435635.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-04-10T17:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435635",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435636.json:
```json
{
    "body": "Well, the review says: Someone needs to figure out the semantics before pushing this code.",
    "created_at": "2022-04-10T17:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435636",
    "user": "mkoeppe"
}
```

Well, the review says: Someone needs to figure out the semantics before pushing this code.



---

archive/issue_comments_435637.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-11T17:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435637",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435638.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-11T17:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435638",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435639.json:
```json
{
    "body": "I've narrowed down the scope of the lock/guard. What do you think?",
    "created_at": "2022-04-11T17:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435639",
    "user": "@tobiasdiez"
}
```

I've narrowed down the scope of the lock/guard. What do you think?



---

archive/issue_comments_435640.json:
```json
{
    "body": "Thanks, this is better for the discussion of the needed semantics.\n\nSo what needs to be figured out is: What should happen if\n1) There is a sequence of two start ups.\n2) Two startups are nested.",
    "created_at": "2022-04-11T17:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435640",
    "user": "mkoeppe"
}
```

Thanks, this is better for the discussion of the needed semantics.

So what needs to be figured out is: What should happen if
1) There is a sequence of two start ups.
2) Two startups are nested.



---

archive/issue_comments_435641.json:
```json
{
    "body": "That feels like an academic issues since the actual code doesn't use either of these constructions and can easily be changed if these situations occur in the future.",
    "created_at": "2022-04-11T22:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435641",
    "user": "@tobiasdiez"
}
```

That feels like an academic issues since the actual code doesn't use either of these constructions and can easily be changed if these situations occur in the future.



---

archive/issue_comments_435642.json:
```json
{
    "body": "It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see comment:69).",
    "created_at": "2022-04-11T23:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435642",
    "user": "mkoeppe"
}
```

It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see comment:69).



---

archive/issue_comments_435643.json:
```json
{
    "body": "Replying to [comment:87 mkoeppe]:\n> What should happen if\n> 1) There is a sequence of two start ups.\n\nFor example, if a user tries to reload the module `sage.all`.",
    "created_at": "2022-04-11T23:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435643",
    "user": "mkoeppe"
}
```

Replying to [comment:87 mkoeppe]:
> What should happen if
> 1) There is a sequence of two start ups.

For example, if a user tries to reload the module `sage.all`.



---

archive/issue_comments_435644.json:
```json
{
    "body": "Replying to [comment:89 mkoeppe]:\n> It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see comment:69).\n\nAs written in the ticket description, the ticket fixes a bug with importing (using importlib) the sage all module.\n\nAnd yes, replacing the boolean by an enum is an improvement by itself, https://stackoverflow.com/questions/4337942/using-enum-vs-boolean.",
    "created_at": "2022-04-13T20:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435644",
    "user": "@tobiasdiez"
}
```

Replying to [comment:89 mkoeppe]:
> It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see comment:69).

As written in the ticket description, the ticket fixes a bug with importing (using importlib) the sage all module.

And yes, replacing the boolean by an enum is an improvement by itself, https://stackoverflow.com/questions/4337942/using-enum-vs-boolean.



---

archive/issue_comments_435645.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-13T20:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435645",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435646.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-05-22T23:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435646",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435647.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-05-24T15:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435647",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435648.json:
```json
{
    "body": "comment:87 is still unaddressed. Besides, the new term \"lock\" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.",
    "created_at": "2022-05-24T15:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435648",
    "user": "mkoeppe"
}
```

comment:87 is still unaddressed. Besides, the new term "lock" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.



---

archive/issue_comments_435649.json:
```json
{
    "body": "Replying to [comment:94 mkoeppe]:\n> comment:87 is still unaddressed. Besides, the new term \"lock\" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.\n> \n\nThere is a doctest describing the behavior of two sequential locks, the behavior of nested locks is not further specified as we don't need it yet (but as with this simplest implementation the both locks share the global \"lock\" variable, the state is in \"locked\" until the nested lock exits and then switches to \"unlocked\").\n\nI'm open for suggestions for how to improve the terminology. I thought that \"locked\" is pretty standard for a \"guard\", e.g. file locks. \"Started\"/\"Not started\" or \"Initialized/Not initialized\" is confusing with how sequential locks work.",
    "created_at": "2022-05-25T14:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435649",
    "user": "@tobiasdiez"
}
```

Replying to [comment:94 mkoeppe]:
> comment:87 is still unaddressed. Besides, the new term "lock" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.
> 

There is a doctest describing the behavior of two sequential locks, the behavior of nested locks is not further specified as we don't need it yet (but as with this simplest implementation the both locks share the global "lock" variable, the state is in "locked" until the nested lock exits and then switches to "unlocked").

I'm open for suggestions for how to improve the terminology. I thought that "locked" is pretty standard for a "guard", e.g. file locks. "Started"/"Not started" or "Initialized/Not initialized" is confusing with how sequential locks work.



---

archive/issue_comments_435650.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-05-25T14:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435650",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435651.json:
```json
{
    "body": "Replying to [comment:95 gh-tobiasdiez]:\n> I thought that \"locked\" is pretty standard for a \"guard\", e.g. file locks. \"Started\"/\"Not started\" or \"Initialized/Not initialized\" is confusing with how sequential locks work.\n\nYes, file locks are locks. They protect against concurrent operations.\n\nThe start-up guard has nothing to do with concurrency. It just makes no sense to work with this analogy.",
    "created_at": "2022-05-25T16:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435651",
    "user": "mkoeppe"
}
```

Replying to [comment:95 gh-tobiasdiez]:
> I thought that "locked" is pretty standard for a "guard", e.g. file locks. "Started"/"Not started" or "Initialized/Not initialized" is confusing with how sequential locks work.

Yes, file locks are locks. They protect against concurrent operations.

The start-up guard has nothing to do with concurrency. It just makes no sense to work with this analogy.



---

archive/issue_comments_435652.json:
```json
{
    "body": "In other words, still comment:74",
    "created_at": "2022-05-25T17:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435652",
    "user": "mkoeppe"
}
```

In other words, still comment:74



---

archive/issue_comments_435653.json:
```json
{
    "body": "Replying to [comment:97 mkoeppe]:\n> In other words, still comment:74\n\nThat concerned the more general version, now the purpose and scope of the lock should be clear.",
    "created_at": "2022-05-25T20:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435653",
    "user": "@tobiasdiez"
}
```

Replying to [comment:97 mkoeppe]:
> In other words, still comment:74

That concerned the more general version, now the purpose and scope of the lock should be clear.



---

archive/issue_comments_435654.json:
```json
{
    "body": "Well, it clearly isn't clear, as I said in comment:96. Try to explain it in the documentation or in the ticket.",
    "created_at": "2022-05-25T20:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435654",
    "user": "mkoeppe"
}
```

Well, it clearly isn't clear, as I said in comment:96. Try to explain it in the documentation or in the ticket.



---

archive/issue_comments_435655.json:
```json
{
    "body": "comment:74 is: You are trying to explain things in too much generality, based on an abstraction that you have come up with. But the abstraction does not capture the purpose of the startup guard mechanism: What exactly is the guard intended to protect?\nShort of explaining this, you are essentially trying to explain to me what a bit is.",
    "created_at": "2022-05-25T20:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435655",
    "user": "mkoeppe"
}
```

comment:74 is: You are trying to explain things in too much generality, based on an abstraction that you have come up with. But the abstraction does not capture the purpose of the startup guard mechanism: What exactly is the guard intended to protect?
Short of explaining this, you are essentially trying to explain to me what a bit is.



---

archive/issue_comments_435656.json:
```json
{
    "body": "The purpose of the guard/lock/whatever you want to call it is the same as in the develop branch: when the guard is active, lazy imports should not be resolved. The only difference is that the guard has to be activated now explicitly.",
    "created_at": "2022-05-25T21:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435656",
    "user": "@tobiasdiez"
}
```

The purpose of the guard/lock/whatever you want to call it is the same as in the develop branch: when the guard is active, lazy imports should not be resolved. The only difference is that the guard has to be activated now explicitly.



---

archive/issue_comments_435657.json:
```json
{
    "body": "Replying to [comment:101 gh-tobiasdiez]:\n>  when the guard is active, lazy imports should not be resolved.\n\nNo, that's not what it does.",
    "created_at": "2022-05-25T21:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435657",
    "user": "mkoeppe"
}
```

Replying to [comment:101 gh-tobiasdiez]:
>  when the guard is active, lazy imports should not be resolved.

No, that's not what it does.



---

archive/issue_comments_435658.json:
```json
{
    "body": "Replying to [comment:102 mkoeppe]:\n> Replying to [comment:101 gh-tobiasdiez]:\n> >  when the guard is active, lazy imports should not be resolved.\n> \n> No, that's not what it does.\n\nSo what is it doing then?",
    "created_at": "2022-05-25T21:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435658",
    "user": "@tobiasdiez"
}
```

Replying to [comment:102 mkoeppe]:
> Replying to [comment:101 gh-tobiasdiez]:
> >  when the guard is active, lazy imports should not be resolved.
> 
> No, that's not what it does.

So what is it doing then?



---

archive/issue_comments_435659.json:
```json
{
    "body": "You can see it in the source code of `LazyImport._get_object` - it does not change what is resolved when or anything. It only informs developers (by printing warnings) whether the laziness was effective or if the module was imported anyway.",
    "created_at": "2022-05-25T22:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435659",
    "user": "mkoeppe"
}
```

You can see it in the source code of `LazyImport._get_object` - it does not change what is resolved when or anything. It only informs developers (by printing warnings) whether the laziness was effective or if the module was imported anyway.



---

archive/issue_comments_435660.json:
```json
{
    "body": "Yes, but isn't this a qualification of what \"should\" in \"lazy import should not be resolved\" means? Also from the ticket description: \"convert runtime warning about resolved lazy imports to doctest.\"\n\nAnyway, now that we agree on the terminology, do you still have questions about the serial behavior?",
    "created_at": "2022-05-26T10:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435660",
    "user": "@tobiasdiez"
}
```

Yes, but isn't this a qualification of what "should" in "lazy import should not be resolved" means? Also from the ticket description: "convert runtime warning about resolved lazy imports to doctest."

Anyway, now that we agree on the terminology, do you still have questions about the serial behavior?



---

archive/issue_comments_435661.json:
```json
{
    "body": "Replying to [comment:105 gh-tobiasdiez]:\n> Yes, but isn't this a qualification of what \"should\" in \"lazy import should not be resolved\" means?\n\nOK, I now understand what you meant by \"should\".",
    "created_at": "2022-05-26T14:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435661",
    "user": "mkoeppe"
}
```

Replying to [comment:105 gh-tobiasdiez]:
> Yes, but isn't this a qualification of what "should" in "lazy import should not be resolved" means?

OK, I now understand what you meant by "should".



---

archive/issue_comments_435662.json:
```json
{
    "body": "Replying to [comment:105 gh-tobiasdiez]:\n> do you still have questions about the serial behavior?\n\nYes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?",
    "created_at": "2022-05-26T14:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435662",
    "user": "mkoeppe"
}
```

Replying to [comment:105 gh-tobiasdiez]:
> do you still have questions about the serial behavior?

Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?



---

archive/issue_comments_435663.json:
```json
{
    "body": "Replying to [comment:105 gh-tobiasdiez]:\n> now that we agree on the terminology\n\nWe don't. It's not a lock, so please don't introduce this terminology in the ticket.",
    "created_at": "2022-05-26T15:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435663",
    "user": "mkoeppe"
}
```

Replying to [comment:105 gh-tobiasdiez]:
> now that we agree on the terminology

We don't. It's not a lock, so please don't introduce this terminology in the ticket.



---

archive/issue_comments_435664.json:
```json
{
    "body": "Replying to [comment:107 mkoeppe]:\n> Replying to [comment:105 gh-tobiasdiez]:\n> > do you still have questions about the serial behavior?\n> \n> Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?\n\nIt's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished. The improvement is currently only visible in the tests, as this is the only place where it is used. But I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.",
    "created_at": "2022-05-27T16:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435664",
    "user": "@tobiasdiez"
}
```

Replying to [comment:107 mkoeppe]:
> Replying to [comment:105 gh-tobiasdiez]:
> > do you still have questions about the serial behavior?
> 
> Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?

It's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished. The improvement is currently only visible in the tests, as this is the only place where it is used. But I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.



---

archive/issue_comments_435665.json:
```json
{
    "body": "Replying to [comment:108 mkoeppe]:\n> Replying to [comment:105 gh-tobiasdiez]:\n> > now that we agree on the terminology\n> \n> We don't. It's not a lock, so please don't introduce this terminology in the ticket.\n\ncomment:95",
    "created_at": "2022-05-27T16:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435665",
    "user": "@tobiasdiez"
}
```

Replying to [comment:108 mkoeppe]:
> Replying to [comment:105 gh-tobiasdiez]:
> > now that we agree on the terminology
> 
> We don't. It's not a lock, so please don't introduce this terminology in the ticket.

comment:95



---

archive/issue_comments_435666.json:
```json
{
    "body": "In comment:95 you called it a \"sequential lock\". It isn't.",
    "created_at": "2022-05-27T21:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435666",
    "user": "mkoeppe"
}
```

In comment:95 you called it a "sequential lock". It isn't.



---

archive/issue_comments_435667.json:
```json
{
    "body": "Or is your reference to comment:95 \"I'm open for suggestions\"?\n\nLet's see. A \"lock\" is locked or unlocked. A \"guard\" is ... active/inactive? engaged/disengaged? on/off?\n\nAnything like this sounds fine, I don't have a preference. It's just important to avoid using words that can be mistaken as standard technical terms when there is no relation.",
    "created_at": "2022-05-27T21:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435667",
    "user": "mkoeppe"
}
```

Or is your reference to comment:95 "I'm open for suggestions"?

Let's see. A "lock" is locked or unlocked. A "guard" is ... active/inactive? engaged/disengaged? on/off?

Anything like this sounds fine, I don't have a preference. It's just important to avoid using words that can be mistaken as standard technical terms when there is no relation.



---

archive/issue_comments_435668.json:
```json
{
    "body": "Replying to [comment:109 gh-tobiasdiez]:\n> Replying to [comment:107 mkoeppe]:\n> > Replying to [comment:105 gh-tobiasdiez]:\n> > > do you still have questions about the serial behavior?\n> > \n> > Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?\n> \n> It's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished.\n\nOK, that's not quite where I wanted to take the discussion. \n\nLet's please ignore the old doctesting-only helper functions - they have no relevance for discussing the semantics. \n\nIn `develop`, `finish_startup` can only be called once, and an error is raised otherwise; and then there is `ensure_startup_finished`, which can be called multiple times and which is a no-op if it was called before.\n\n> [...] I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.\n\nYes, I am interested in this -- which is why I brought up the scenarios of sequences of such startup-guarded blocks and also nested startup-guarded blocks in comment:87. \n\nSo with the changes on this ticket, it becomes possible to have a sequence of two startup-guarded blocks:\n\n```\nwith ...:\n    Block 1\nwith ...:\n    Block 2\n```\n\nI think we both agree on what the first block should do. Now, why should the second one behave as you implemented?",
    "created_at": "2022-05-27T22:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435668",
    "user": "mkoeppe"
}
```

Replying to [comment:109 gh-tobiasdiez]:
> Replying to [comment:107 mkoeppe]:
> > Replying to [comment:105 gh-tobiasdiez]:
> > > do you still have questions about the serial behavior?
> > 
> > Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?
> 
> It's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished.

OK, that's not quite where I wanted to take the discussion. 

Let's please ignore the old doctesting-only helper functions - they have no relevance for discussing the semantics. 

In `develop`, `finish_startup` can only be called once, and an error is raised otherwise; and then there is `ensure_startup_finished`, which can be called multiple times and which is a no-op if it was called before.

> [...] I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.

Yes, I am interested in this -- which is why I brought up the scenarios of sequences of such startup-guarded blocks and also nested startup-guarded blocks in comment:87. 

So with the changes on this ticket, it becomes possible to have a sequence of two startup-guarded blocks:

```
with ...:
    Block 1
with ...:
    Block 2
```

I think we both agree on what the first block should do. Now, why should the second one behave as you implemented?



---

archive/issue_comments_435669.json:
```json
{
    "body": "Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not. What other implementation would you suggest?",
    "created_at": "2022-05-28T21:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435669",
    "user": "@tobiasdiez"
}
```

Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not. What other implementation would you suggest?



---

archive/issue_comments_435670.json:
```json
{
    "body": "Replying to [comment:114 gh-tobiasdiez]:\n> Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not.\n\nBut *why* do you think that this the right semantics?",
    "created_at": "2022-05-28T21:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435670",
    "user": "mkoeppe"
}
```

Replying to [comment:114 gh-tobiasdiez]:
> Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not.

But *why* do you think that this the right semantics?



---

archive/issue_comments_435671.json:
```json
{
    "body": "It seemed the most logical and easy to implement solution, that worked well with the currently only use case of the tests. What other implementation do you have in mind? Make the second block a noop?",
    "created_at": "2022-05-29T08:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435671",
    "user": "@tobiasdiez"
}
```

It seemed the most logical and easy to implement solution, that worked well with the currently only use case of the tests. What other implementation do you have in mind? Make the second block a noop?



---

archive/issue_comments_435672.json:
```json
{
    "body": "Replying to [comment:116 gh-tobiasdiez]:\n> Make the second block a noop? \n\nYes, a kind of no-op is what I had in mind.\n\nIn the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):\n\n```\nwith ...:\n    Block 1\nwith ...:\n    Block 2\n```\n\nHowever, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.\n(Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)\n\nSo in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.",
    "created_at": "2022-05-29T22:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435672",
    "user": "mkoeppe"
}
```

Replying to [comment:116 gh-tobiasdiez]:
> Make the second block a noop? 

Yes, a kind of no-op is what I had in mind.

In the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):

```
with ...:
    Block 1
with ...:
    Block 2
```

However, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.
(Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)

So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.



---

archive/issue_comments_435673.json:
```json
{
    "body": "On the other hand, this structure:\n\n```\nwith ...:\n    with ...:\n        Block 1\n    with ...:\n        Block 2\n    Block 3\n```\n\nwould appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.",
    "created_at": "2022-05-29T22:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435673",
    "user": "mkoeppe"
}
```

On the other hand, this structure:

```
with ...:
    with ...:
        Block 1
    with ...:
        Block 2
    Block 3
```

would appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.



---

archive/issue_comments_435674.json:
```json
{
    "body": "Replying to [comment:117 mkoeppe]:\n> Replying to [comment:116 gh-tobiasdiez]:\n> > Make the second block a noop? \n> \n> Yes, a kind of no-op is what I had in mind.\n> \n> In the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):\n> {{{\n> with ...:\n>     Block 1\n> with ...:\n>     Block 2\n> }}}\n> However, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.\n> (Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)\n> \n> So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.\n\nIn this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued.",
    "created_at": "2022-05-30T10:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435674",
    "user": "@tobiasdiez"
}
```

Replying to [comment:117 mkoeppe]:
> Replying to [comment:116 gh-tobiasdiez]:
> > Make the second block a noop? 
> 
> Yes, a kind of no-op is what I had in mind.
> 
> In the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):
> {{{
> with ...:
>     Block 1
> with ...:
>     Block 2
> }}}
> However, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.
> (Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)
> 
> So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.

In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued.



---

archive/issue_comments_435675.json:
```json
{
    "body": "Replying to [comment:118 mkoeppe]:\n> On the other hand, this structure:\n> {{{\n> with ...:\n>     with ...:\n>         Block 1\n>     with ...:\n>         Block 2\n>     Block 3\n> }}}\n> would appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.\n\nIn my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. But if the nested structure does arise in the future, then the implementation of the guard can easily be changed to accommodate of this.",
    "created_at": "2022-05-30T10:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435675",
    "user": "@tobiasdiez"
}
```

Replying to [comment:118 mkoeppe]:
> On the other hand, this structure:
> {{{
> with ...:
>     with ...:
>         Block 1
>     with ...:
>         Block 2
>     Block 3
> }}}
> would appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.

In my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. But if the nested structure does arise in the future, then the implementation of the guard can easily be changed to accommodate of this.



---

archive/issue_comments_435676.json:
```json
{
    "body": "Replying to [comment:120 gh-tobiasdiez]:\n> Replying to [comment:118 mkoeppe]:\n> > imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.\n> \n> In my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. \n\nThe `all` scripts have two purposes: (1) To orchestrate startup, and I agree with you that the library should be changed to make it unnecessary - that's #33580. (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.",
    "created_at": "2022-05-30T18:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435676",
    "user": "mkoeppe"
}
```

Replying to [comment:120 gh-tobiasdiez]:
> Replying to [comment:118 mkoeppe]:
> > imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.
> 
> In my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. 

The `all` scripts have two purposes: (1) To orchestrate startup, and I agree with you that the library should be changed to make it unnecessary - that's #33580. (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.



---

archive/issue_comments_435677.json:
```json
{
    "body": "Replying to [comment:120 gh-tobiasdiez]:\n> But if the nested structure does arise in the future\n\nWell, it will, as I said in comment:118.\n\n> then the implementation of the guard can easily be changed to accommodate of this. \n\nIn your current branch you are introducing a public interface (including new terminology) for the `GuardState`. That's not a good way forward when we already know that it does not capture what is needed.",
    "created_at": "2022-05-30T19:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435677",
    "user": "mkoeppe"
}
```

Replying to [comment:120 gh-tobiasdiez]:
> But if the nested structure does arise in the future

Well, it will, as I said in comment:118.

> then the implementation of the guard can easily be changed to accommodate of this. 

In your current branch you are introducing a public interface (including new terminology) for the `GuardState`. That's not a good way forward when we already know that it does not capture what is needed.



---

archive/issue_comments_435678.json:
```json
{
    "body": "Replying to [comment:119 gh-tobiasdiez]:\n> Replying to [comment:117 mkoeppe]:\n> > Replying to [comment:116 gh-tobiasdiez]:\n> > > Make the second block a noop? \n> > \n> > Yes, a kind of no-op is what I had in mind.\n> > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]\n> > \n> > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.\n> \n> In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. \n\nNot no-op enough. The doctests can also be invoked from within a running Sage.",
    "created_at": "2022-05-30T20:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435678",
    "user": "mkoeppe"
}
```

Replying to [comment:119 gh-tobiasdiez]:
> Replying to [comment:117 mkoeppe]:
> > Replying to [comment:116 gh-tobiasdiez]:
> > > Make the second block a noop? 
> > 
> > Yes, a kind of no-op is what I had in mind.
> > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]
> > 
> > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.
> 
> In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. 

Not no-op enough. The doctests can also be invoked from within a running Sage.



---

archive/issue_comments_435679.json:
```json
{
    "body": "Replying to [comment:121 mkoeppe]:\n> (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.\n\nBut you only have one prompt so one global guard should be sufficient. I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module to declare what methods should be available in the sage prompt in the first place.",
    "created_at": "2022-05-30T20:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435679",
    "user": "@tobiasdiez"
}
```

Replying to [comment:121 mkoeppe]:
> (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.

But you only have one prompt so one global guard should be sufficient. I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module to declare what methods should be available in the sage prompt in the first place.



---

archive/issue_comments_435680.json:
```json
{
    "body": "Replying to [comment:123 mkoeppe]:\n> Replying to [comment:119 gh-tobiasdiez]:\n> > Replying to [comment:117 mkoeppe]:\n> > > Replying to [comment:116 gh-tobiasdiez]:\n> > > > Make the second block a noop? \n> > > \n> > > Yes, a kind of no-op is what I had in mind.\n> > > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]\n> > > \n> > > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.\n> > \n> > In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. \n> \n> Not no-op enough. The doctests can also be invoked from within a running Sage.\n\nThe test would still only fail if there are already resolved lazy imports in the first load.",
    "created_at": "2022-05-30T20:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435680",
    "user": "@tobiasdiez"
}
```

Replying to [comment:123 mkoeppe]:
> Replying to [comment:119 gh-tobiasdiez]:
> > Replying to [comment:117 mkoeppe]:
> > > Replying to [comment:116 gh-tobiasdiez]:
> > > > Make the second block a noop? 
> > > 
> > > Yes, a kind of no-op is what I had in mind.
> > > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]
> > > 
> > > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.
> > 
> > In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. 
> 
> Not no-op enough. The doctests can also be invoked from within a running Sage.

The test would still only fail if there are already resolved lazy imports in the first load.



---

archive/issue_comments_435681.json:
```json
{
    "body": "Replying to [comment:124 gh-tobiasdiez]:\n> Replying to [comment:121 mkoeppe]:\n> > (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.\n> \n> But you only have one prompt \n\nNope. See https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#testing-distribution-packages\n\n> I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module \n\nNot the module, the distribution.",
    "created_at": "2022-05-30T20:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435681",
    "user": "mkoeppe"
}
```

Replying to [comment:124 gh-tobiasdiez]:
> Replying to [comment:121 mkoeppe]:
> > (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.
> 
> But you only have one prompt 

Nope. See https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#testing-distribution-packages

> I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module 

Not the module, the distribution.



---

archive/issue_comments_435682.json:
```json
{
    "body": "Replying to [comment:125 gh-tobiasdiez]:\n> Replying to [comment:123 mkoeppe]:\n> > Not no-op enough. The doctests can also be invoked from within a running Sage.\n> \n> The test would still only fail if there are already resolved lazy imports in the first load. \n\nThere are two types warnings, right? Let's break the analysis down by type.",
    "created_at": "2022-05-30T20:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30511#issuecomment-435682",
    "user": "mkoeppe"
}
```

Replying to [comment:125 gh-tobiasdiez]:
> Replying to [comment:123 mkoeppe]:
> > Not no-op enough. The doctests can also be invoked from within a running Sage.
> 
> The test would still only fail if there are already resolved lazy imports in the first load. 

There are two types warnings, right? Let's break the analysis down by type.
