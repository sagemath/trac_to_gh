# Issue 15386: Immutable graph backend for Posets

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2014-01-02 21:36:09

CC:  simonking

At long, long last, it passes all tests `:-P`

Thank you Simon for your help with all this !!!

Nathann


---

Comment by ncohen created at 2014-01-02 21:37:50

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-01-03 11:16:20

Last 10 new commits:


---

Comment by SimonKing created at 2014-01-03 23:22:33

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2014-01-03 23:22:33

Merging all the dependencies (there are review commits that are not part of your branch), I get this error:

```
sage -t src/sage/combinat/posets/posets.py
**********************************************************************
File "src/sage/combinat/posets/posets.py", line 1488, in sage.combinat.posets.posets.FinitePoset.to_graph
Failed example:
    hash(G) == hash(G)
Exception raised:
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.combinat.posets.posets.FinitePoset.to_graph[4]>", line 1, in <module>
        hash(G) == hash(G)
      File "cachefunc.pyx", line 1790, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (sage/misc/cachefunc.c:9772)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 496, in __hash__
        raise TypeError("This graph is mutable, and thus not hashable. "
    TypeError: This graph is mutable, and thus not hashable. Create an immutable copy by `g.copy(data_structure='static_sparse')`
**********************************************************************
1 item had failures:
   1 of   6 in sage.combinat.posets.posets.FinitePoset.to_graph
    [837 tests, 1 failure, 11.73 s]
```

I am wondering: Shouldn't the error message say `g.copy(immutable=False)`? What thing did I forgot to merge?

But in any case, this error needs fixing. I'll see what I can do about it.


---

Comment by SimonKing created at 2014-01-03 23:25:19

Aha. This is about a function that returns

```
        from sage.graphs.graph import Graph
        G = Graph(self.hasse_diagram())
        return G
```

I suppose this should be

```
        from sage.graphs.graph import Graph
        return Graph(self.hasse_diagram(), immutable=True)
```

instead. The fact that the doctest is about hash shows that we want an immutable graph.


---

Comment by SimonKing created at 2014-01-04 00:03:31

With the review commit I just added, all tests should pass. "Should". I'll hopefully finish review tomorrow. PS: Again I had to change the commit field manually.


---

Comment by SimonKing created at 2014-01-04 00:03:31

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2014-01-06 15:59:01

Please resolve the conflict with your new commit in #15622.


---

Comment by SimonKing created at 2014-01-06 15:59:01

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-01-07 08:10:38

Done !

Nathann


---

Comment by ncohen created at 2014-01-07 08:10:38

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-01-07 08:10:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-01-07 08:11:47

I don't know how THIS could be read without the ticket numbers `:-P`


---

Comment by SimonKing created at 2014-01-07 22:49:00

The merge was successful (looking at the code), and all tests pass.


---

Comment by SimonKing created at 2014-01-07 22:49:00

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-01-07 22:49:46

Wow. Done `:-P`

Thaaaaaaaaaaank you very much Simon for all these reviews !

Nathann


---

Comment by ncohen created at 2014-01-07 22:54:14

Arggggggg !! Simon !! Simon !! `:-P`

It's because of these comments on the Tutte thread `:-P`

Nathann


---

Comment by tscrim created at 2014-01-27 07:20:18

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2014-01-27 07:20:18

This doesn't merge with the latest `develop` branch I'm afraid.


---

Comment by SimonKing created at 2014-01-27 10:52:10

I attempted to merge the develop branch into the ticket branch. Nathann, could you check whether you think the merge was successful? I am running tests now. If it works, then I think it can be back to positive review
----
New commits:


---

Comment by SimonKing created at 2014-01-27 10:52:10

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2014-01-27 11:17:20

Arrgh. It seems I did wrong.

```
File "src/sage/graphs/generic_graph.py", line 845, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    hash(H)   # random
Exception raised:
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[32]>", line 1, in <module>
        hash(H)   # random
      File "cachefunc.pyx", line 1790, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (sage/misc/cachefunc.c:9772)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 495, in __hash__
        return hash((tuple(self.vertices()), tuple(self.edges())))
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 8770, in vertices
        return sorted(list(self.vertex_iterator()), key=key)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/posets/elements.py", line 222, in __lt__
        return self._cmp(other) == -1 or False
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/posets/elements.py", line 155, in _cmp
        return self.parent().compare_elements(self,other)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/posets/posets.py", line 1851, in compare_elements
        elif self._hasse_diagram.is_less_than(j, i):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/posets/hasse_diagram.py", line 245, in is_less_than
        return self.is_lequal(x,y)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/posets/hasse_diagram.py", line 219, in is_lequal
        (i < j and j in self.breadth_first_search(i))
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 13335, in breadth_first_search
        for v in self._backend.breadth_first_search(start, ignore_direction = ignore_direction):
      File "c_graph.pyx", line 2636, in sage.graphs.base.c_graph.CGraphBackend.breadth_first_search (sage/graphs/base/c_graph.c:18478)
      File "c_graph.pyx", line 3039, in sage.graphs.base.c_graph.Search_iterator.__init__ (sage/graphs/base/c_graph.c:20167)
    AttributeError: 'StaticSparseBackend' object has no attribute 'vertex_ints'
**********************************************************************
1 item had failures:
   1 of 307 in sage.graphs.generic_graph.GenericGraph.?
    [2519 tests, 1 failure, 50.35 s]
```



---

Comment by SimonKing created at 2014-01-27 11:34:29

There are more errors concerning the missing attribute 'vertex_ints'.

Nathann, do you have an idea what went wrong?


---

Comment by SimonKing created at 2014-01-27 11:34:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-01-27 11:53:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-01-27 11:56:53

Ahaaaa! It seems that I did wrong when merging! Namely, I have removed the vertex_ints attribute.

In a second commit, I re-introduced it. Well, the joy of git. I don't dare to amend the merge commit and rather add an ugly second commit on top of a wrong first commit `:-P`

At least one of the failing doctests is now working. So, needs review again, and since I am the reviewer, I suppose I can revert to positive review as soon as `make ptest` passes for me!


---

Comment by SimonKing created at 2014-01-27 11:56:53

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2014-01-27 13:18:12

`make ptest` does pass, hence, the merge seems to be successful, and hopefully I am entitled to revert to positive review.


---

Comment by SimonKing created at 2014-01-27 13:18:12

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-01-28 14:02:37

Looks good to me, but I wasn't able to see directly from git how the conflicts were manually solved. So it works, but it's a bit scary that there does not seem to be a way to see that `O_o`

Thank you Simon for doing this ! I was away for 4 days, and rather unreachable in cold cold Hungary. I was there because I had promised a pretty girl a braid of dried chili, and a friend told me they had nice ones in Hungary `:-P`

Nathann


---

Comment by vbraun created at 2014-02-01 19:39:14

Resolution: fixed
