# Issue 14086: Running doctests from within Sage doesn't work

Issue created by migration from https://trac.sagemath.org/ticket/14290

Original creator: roed

Original creation time: 2013-03-17 07:53:21

Assignee: mvngu

Running doctests from within Sage results in any test that has output failing.  For example:


```
sage: run_doctests(sage.algebras.algebra)
Doctesting /Users/roed/sage/sage-5.9.beta0/devel/sage/sage/algebras/algebra.py
Running doctests with ID 2013-03-17-01-02-17-09f21e8e.
Doctesting 1 file.
sage -t /Users/roed/sage/sage-5.9.beta0/devel/sage/sage/algebras/algebra.py
**********************************************************************
File "/Users/roed/sage/sage-5.9.beta0/devel/sage/sage/algebras/algebra.py", line 29, in sage.algebras.algebra.is_Algebra
Failed example:
    is_Algebra(R)
Expected:
    True
Got:
    True
**********************************************************************
File "/Users/roed/sage/sage-5.9.beta0/devel/sage/sage/algebras/algebra.py", line 31, in sage.algebras.algebra.is_Algebra
Failed example:
    sig_on_count()
Expected:
    0
Got:
    0
**********************************************************************
1 item had failures:
   2 of   4 in sage.algebras.algebra.is_Algebra
    [3 tests, 2 failures, 0.1 s]
----------------------------------------------------------------------
sage -t /Users/roed/sage/sage-5.9.beta0/devel/sage/sage/algebras/algebra.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 0.1 seconds
```


This is the result of IPython coloring the output.


---

Attachment


---

Comment by roed created at 2013-03-17 07:55:44

I couldn't figure out a way to doctest this fix (since the problem only occurred when running doctests from IPython), but it's ready for review.


---

Comment by roed created at 2013-03-17 07:55:44

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-03-26 22:56:50

Positive review to your patch. 

I still think that it would be nice to have a note added to the diff that there were ansi escape sequences, since they don't get printed and you are otherwise just left with two identical strings which makes it non-obvious why the doctest failed. So I rescued that piece of the patch from #14359.


---

Comment by roed created at 2013-03-26 23:35:30

Changing status from needs_review to positive_review.


---

Comment by roed created at 2013-03-26 23:35:30

Your patch looks good too.


---

Comment by jdemeyer created at 2013-03-27 02:35:35

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-03-27 02:35:35

This should be rebased to #14331 + #13278.


---

Comment by vbraun created at 2013-03-27 07:09:43

Patch applies cleanly here on top of sage-5.9.beta1 + #14331 + #13278.


---

Comment by jdemeyer created at 2013-03-27 07:43:19

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-03-27 07:43:19

Agreed, I must have done something wrong.


---

Comment by jdemeyer created at 2013-03-28 02:27:54

Concerning escapes: on OS X 10.8 I am seeing

```
\e[?1034h
```

(where `\e` stands for the escape character).
Could you also check for this code (no idea what it does).


---

Comment by jdemeyer created at 2013-03-28 02:27:54

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-03-28 10:10:26

That is not a color code but smm = "turn meta on". Most likely coming from readline if you have the wrong TERM set. 

I'll update the patch to generate better diagnostic for escape sequences.


---

Comment by vbraun created at 2013-03-28 14:11:33

Updated patch


---

Comment by vbraun created at 2013-03-28 14:14:31

Changing status from needs_work to needs_review.


---

Attachment

The updated patch now makes all escape sequences visible (and doctestable):

```
EXAMPLES::

    sage: print 'This ist \x1b[1mbold\x1b[0m text'
    This ist <CSI-1m>bold<CSI-0m> text
```



---

Comment by jdemeyer created at 2013-03-28 18:21:03

What does `CSI` mean? I prefer to use `ESC` always.

Also, are you sure want to mess with `\x9b`? I think that won't go well with UTF-8.


---

Comment by jdemeyer created at 2013-03-28 19:08:25

Resolution: fixed


---

Comment by jdemeyer created at 2013-03-28 19:08:25

For the escape codes, see #14375.


---

Comment by roed created at 2013-03-28 22:46:13

Changing component from doctest to doctest framework.
