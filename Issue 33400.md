# Issue 33400: bring back a non-broken get_memory_usage

archive/issues_033400.json:
```json
{
    "body": "CC:  @orlitzky @koffie\n\nSee #32656\n\nand also my comments below that just reverting #32656 won't help, since get_memory_usage was evidently broken anyways.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33637\n\n",
    "created_at": "2022-04-03T15:04:06Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "bring back a non-broken get_memory_usage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33400",
    "user": "https://github.com/williamstein"
}
```
CC:  @orlitzky @koffie

See #32656

and also my comments below that just reverting #32656 won't help, since get_memory_usage was evidently broken anyways.

Issue created by migration from https://trac.sagemath.org/ticket/33637





---

archive/issue_comments_474904.json:
```json
{
    "body": "I tried the last few versions of Sage (at least on CoCalc, so ubuntu linux), and get_memory_usage returns total nonsense on them.  Maybe it accounts for some huge amount of virtual memory address spaces that Pari allocates (I don't know).\n\n```\n~$ sage-9.4\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.4, Release Date: 2021-08-22                     \u2502\n\u2502 Using Python 3.9.5. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: get_memory_usage()                                                                                                    \n16626.8125\nsage:                                                                                                                       \nExiting Sage (CPU time 0m0.76s, Wall time 0m4.99s).\nsag~$ sage-9.3\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3, Release Date: 2021-05-09                     \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: get_memory_usage()                                                                                                    \n16609.203125\nsage:                                                                                                                       \nExiting Sage (CPU time 0m0.09s, Wall time 0m2.84s).\nsage~$ sage-9.\nsage-9.1  sage-9.2  sage-9.3  sage-9.4  sage-9.5  \n~$ sage-9.1\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.1, Release Date: 2020-05-20                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: get_memory_usage()\n16542.44140625\nsage: \n```\n\nThe \"smem -ntk\" command (which is I think written in Python) does give perfectly useful memory information about the above Sage process:\n\n```\n~$ smem -ntk |grep 32967\n33075 2001     grep --color=auto 32967            0   424.0K   456.0K     2.3M \n32967 2001     python3 /ext/sage/9.4/src/b        0   136.5M   171.1M   213.0M \n```\nso this isn't an unsolvable problem.\n\nI'll update this ticket title to include \"not broken\".",
    "created_at": "2022-04-03T15:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474904",
    "user": "https://github.com/williamstein"
}
```

I tried the last few versions of Sage (at least on CoCalc, so ubuntu linux), and get_memory_usage returns total nonsense on them.  Maybe it accounts for some huge amount of virtual memory address spaces that Pari allocates (I don't know).

```
~$ sage-9.4
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4, Release Date: 2021-08-22                     │
│ Using Python 3.9.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: get_memory_usage()                                                                                                    
16626.8125
sage:                                                                                                                       
Exiting Sage (CPU time 0m0.76s, Wall time 0m4.99s).
sag~$ sage-9.3
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3, Release Date: 2021-05-09                     │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: get_memory_usage()                                                                                                    
16609.203125
sage:                                                                                                                       
Exiting Sage (CPU time 0m0.09s, Wall time 0m2.84s).
sage~$ sage-9.
sage-9.1  sage-9.2  sage-9.3  sage-9.4  sage-9.5  
~$ sage-9.1
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.1, Release Date: 2020-05-20                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: get_memory_usage()
16542.44140625
sage: 
```

The "smem -ntk" command (which is I think written in Python) does give perfectly useful memory information about the above Sage process:

```
~$ smem -ntk |grep 32967
33075 2001     grep --color=auto 32967            0   424.0K   456.0K     2.3M 
32967 2001     python3 /ext/sage/9.4/src/b        0   136.5M   171.1M   213.0M 
```
so this isn't an unsolvable problem.

I'll update this ticket title to include "not broken".



---

archive/issue_comments_474905.json:
```json
{
    "body": "`smem` is Linux-only.",
    "created_at": "2022-04-03T15:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474905",
    "user": "https://github.com/dimpase"
}
```

`smem` is Linux-only.



---

archive/issue_comments_474906.json:
```json
{
    "body": "To clarify, when I tested our existing get_memory_usage from sage-9.4, which does not provide useful output, I was testing on Linux.  Similarly, with smem.",
    "created_at": "2022-04-03T15:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474906",
    "user": "https://github.com/williamstein"
}
```

To clarify, when I tested our existing get_memory_usage from sage-9.4, which does not provide useful output, I was testing on Linux.  Similarly, with smem.



---

archive/issue_comments_474907.json:
```json
{
    "body": "With WSL widely available and cygwin consistently broken, our effective list of supported platforms is\n\n* linux\n* macOS\n* other BSD\n* WSL\n\nWith that in mind, what number should `get_memory_usage()` return? I suppose we could have different notions of \"memory usage\" on different platforms, so long as it's documented.\n\nEven on linux however there are a number of options (see e.g. the `/proc/[pid]/smaps` section in `man proc`), each of which can be misleading in its own special way. Sage now makes use of system libraries that can be shared with other processes, and modern operating systems will do things like deduplication of pages that make accounting a headache.\n\nThere's also the question of subprocesses (like pexpect maxima) that would have to be accounted for separately, if at all.\n\nThis doesn't have to be perfect, but I think we should have an idea of what it should do this time around.",
    "created_at": "2022-04-06T11:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474907",
    "user": "https://github.com/orlitzky"
}
```

With WSL widely available and cygwin consistently broken, our effective list of supported platforms is

* linux
* macOS
* other BSD
* WSL

With that in mind, what number should `get_memory_usage()` return? I suppose we could have different notions of "memory usage" on different platforms, so long as it's documented.

Even on linux however there are a number of options (see e.g. the `/proc/[pid]/smaps` section in `man proc`), each of which can be misleading in its own special way. Sage now makes use of system libraries that can be shared with other processes, and modern operating systems will do things like deduplication of pages that make accounting a headache.

There's also the question of subprocesses (like pexpect maxima) that would have to be accounted for separately, if at all.

This doesn't have to be perfect, but I think we should have an idea of what it should do this time around.



---

archive/issue_comments_474908.json:
```json
{
    "body": "Thanks for supporting bring this back, and taking such a systematic approach.  \n\nFor me personally, I can list some reasons that I use get_memory_usage:\n\n- I allocate something that I think should be \"big\", e.g., a list of primes, and want to get a rough estimate of just how big it actually is.  For this, I would call get_memory_usage before and after the allocation, and I only care about the difference.   This is nice because it avoids a lot of the traps you mention above about system libraries, etc.\n\n- I write a little snippet of code and suspect a blatant memory leak of some sort, e.g., possibly due to some implicit caching in the Sage library.  Running get_memory_usage before and after the computation can provide me with a little bit of additional information about my concerns.\n\n- I want to do a memory intensive big computation on my computer with 16GB of RAM.  I do some smaller cases, interpolate data computed using get_memory_usage before and after each run, and decide that yes, this computation will probably fit in 16GB of RAM.   This is much easier than trying to understand how all the underlying code and libraries work and correctly predict RAM usage.   Again, all I need is deltas.   Often linear algebra algorithms that I use (basis for a lot of modular forms computations) are more worrisome in terms of memory requirements than time requirements (unlike combinatorics, say).\n\nIn Sage there is a common contruction:\n\n```\nt = cputime()\n...\ncputime(t)\n```\n\nwhich outputs the elapsed cputime.  Similar for walltime.   We could support and encourage something similar for get_memory_usage, e.g.,\n\n```\nm = get_memory_usage()\n...\nget_memory_usage(m)\n/// prints change in memory\n```\n\nAcknowledgement: I copied this \"cputime(t)\" approach (which gives the delta) from Magma.",
    "created_at": "2022-04-06T14:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474908",
    "user": "https://github.com/williamstein"
}
```

Thanks for supporting bring this back, and taking such a systematic approach.  

For me personally, I can list some reasons that I use get_memory_usage:

- I allocate something that I think should be "big", e.g., a list of primes, and want to get a rough estimate of just how big it actually is.  For this, I would call get_memory_usage before and after the allocation, and I only care about the difference.   This is nice because it avoids a lot of the traps you mention above about system libraries, etc.

- I write a little snippet of code and suspect a blatant memory leak of some sort, e.g., possibly due to some implicit caching in the Sage library.  Running get_memory_usage before and after the computation can provide me with a little bit of additional information about my concerns.

- I want to do a memory intensive big computation on my computer with 16GB of RAM.  I do some smaller cases, interpolate data computed using get_memory_usage before and after each run, and decide that yes, this computation will probably fit in 16GB of RAM.   This is much easier than trying to understand how all the underlying code and libraries work and correctly predict RAM usage.   Again, all I need is deltas.   Often linear algebra algorithms that I use (basis for a lot of modular forms computations) are more worrisome in terms of memory requirements than time requirements (unlike combinatorics, say).

In Sage there is a common contruction:

```
t = cputime()
...
cputime(t)
```

which outputs the elapsed cputime.  Similar for walltime.   We could support and encourage something similar for get_memory_usage, e.g.,

```
m = get_memory_usage()
...
get_memory_usage(m)
/// prints change in memory
```

Acknowledgement: I copied this "cputime(t)" approach (which gives the delta) from Magma.



---

archive/issue_comments_474909.json:
```json
{
    "body": "Suggestion: how about `memory_usage` instead of `get_memory_usage`?\n\nTo everyone's satisfaction we use `cputime` and not `get_cputime`.",
    "created_at": "2022-04-06T14:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474909",
    "user": "https://github.com/slel"
}
```

Suggestion: how about `memory_usage` instead of `get_memory_usage`?

To everyone's satisfaction we use `cputime` and not `get_cputime`.



---

archive/issue_comments_474910.json:
```json
{
    "body": "For what it is worth, the names we currently use were copied (by me) from Magma, which has:\n\n- GetMemoryUsage\n- Cputime\n- Walltime\n\nI would provide a link, but the Magma website seems down, or at least what google points at is down.",
    "created_at": "2022-04-06T15:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474910",
    "user": "https://github.com/williamstein"
}
```

For what it is worth, the names we currently use were copied (by me) from Magma, which has:

- GetMemoryUsage
- Cputime
- Walltime

I would provide a link, but the Magma website seems down, or at least what google points at is down.



---

archive/issue_comments_474911.json:
```json
{
    "body": "A few thoughts:\n\n- The IPython magic commands `%time` and `%timeit` work well, I think, and at least some uses of `cputime` could be replaced by those. Could we create an analogous magic command that measured the memory usage of a single command?\n- Could we instead or in addition implement something to be used in a Python context manager (a \"with\" block)?\n\n```\nwith m as memory():\n    do some stuff\n\nthen return the change in memory at the end\n```",
    "created_at": "2022-08-30T17:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474911",
    "user": "https://github.com/jhpalmieri"
}
```

A few thoughts:

- The IPython magic commands `%time` and `%timeit` work well, I think, and at least some uses of `cputime` could be replaced by those. Could we create an analogous magic command that measured the memory usage of a single command?
- Could we instead or in addition implement something to be used in a Python context manager (a "with" block)?

```
with m as memory():
    do some stuff

then return the change in memory at the end
```



---

archive/issue_comments_474912.json:
```json
{
    "body": "See also https://pypi.org/project/memory-profiler/. I don't know how well that functions on different platforms.",
    "created_at": "2022-08-30T18:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474912",
    "user": "https://github.com/jhpalmieri"
}
```

See also https://pypi.org/project/memory-profiler/. I don't know how well that functions on different platforms.



---

archive/issue_comments_474913.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> See also https://pypi.org/project/memory-profiler/. I don't know how well that functions on different platforms.\n\n\nit depends on `psutil`, so nothing too interesting.",
    "created_at": "2022-08-31T00:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474913",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:11 jhpalmieri]:
> See also https://pypi.org/project/memory-profiler/. I don't know how well that functions on different platforms.


it depends on `psutil`, so nothing too interesting.



---

archive/issue_comments_474914.json:
```json
{
    "body": "Replying to [comment:12 dimpase]:\n> Replying to [comment:11 jhpalmieri]:\n> > See also https://pypi.org/project/memory-profiler/. I don't know how well that functions on different platforms.\n\n> \n> it depends on `psutil`, so nothing too interesting.\n\n\nThe interface is worth looking at, including IPython integration via `%mprun` and `%memit`. Someone who can articulate them can also point out the flaws of `psutil` to the authors, and maybe they can come up with something. \"Building the car, not reinventing the wheel\" and all that.",
    "created_at": "2022-08-31T02:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33400#issuecomment-474914",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:12 dimpase]:
> Replying to [comment:11 jhpalmieri]:
> > See also https://pypi.org/project/memory-profiler/. I don't know how well that functions on different platforms.

> 
> it depends on `psutil`, so nothing too interesting.


The interface is worth looking at, including IPython integration via `%mprun` and `%memit`. Someone who can articulate them can also point out the flaws of `psutil` to the authors, and maybe they can come up with something. "Building the car, not reinventing the wheel" and all that.



---

archive/issue_events_088468.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33400",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33400#event-88468"
}
```
