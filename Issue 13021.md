# Issue 13021: erf evaluation is wrong along imaginary axis

archive/issues_013021.json:
```json
{
    "body": "Assignee: jason, jkantor\n\nThis was first noted at [this ask.sagemath.org question](http://ask.sagemath.org/question/1571/plot-solution-for-y-2xy-1).  Here are *some* of the symptoms.\n\n* Being off by a real part of 1 along the imaginary axis\n\n```\nsage: for z in [3,33,333,3333]:\n....:     mpmath.erf(i*z); erf(n(z)*i)\n....:     \nmpc(real='0.0', imag='1629.9946226015657')\n1.00000000000000 + 1629.86732385786*I\nmpc(real='0.0', imag='1.5128697751040891e+471')\n1.00000000000000 + 1.51286977510409e471*I\nmpc(real='0.0', imag='5.1260939089106243e+48155')\n1.00000000000000 + 5.12609390891062e48155*I\nmpc(real='0.0', imag='2.6385510598470926e+4824525')\n1.00000000000000 + 2.63855105984709e4824525*I\n```\n\n\n* Starting to be wrong in the imaginary component as well as the number gets closer to 0\n\n```\nsage: pari(3*i).erfc()\n-1.76710569338983 E-16 - 1629.86732385786*I\nsage: mpmath.erfc(3*i)\nmpc(real='1.0', imag='-1629.9946226015657')\nsage: 1-pari(3*i).erfc()\n1.00000000000000 + 1629.86732385786*I\nsage: mpmath.erf(3*i)\nmpc(real='0.0', imag='1629.9946226015657')\nsage: erf(i*1.42)\n1.00000000000000 + 4.03986343036907*I\nsage: import mpmath\nsage: mpmath.erf(i*1.42)\nmpc(real='0.0', imag='3.8217653554366318')\n```\n\n\nIdeally this would be fixed by #1173 or #13050, but if there is something else we can do (and soon) that would be fine too.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13193\n\n",
    "created_at": "2012-07-02T14:57:43Z",
    "labels": [
        "numerical",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.2",
    "title": "erf evaluation is wrong along imaginary axis",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13021",
    "user": "@kcrisman"
}
```
Assignee: jason, jkantor

This was first noted at [this ask.sagemath.org question](http://ask.sagemath.org/question/1571/plot-solution-for-y-2xy-1).  Here are *some* of the symptoms.

* Being off by a real part of 1 along the imaginary axis

```
sage: for z in [3,33,333,3333]:
....:     mpmath.erf(i*z); erf(n(z)*i)
....:     
mpc(real='0.0', imag='1629.9946226015657')
1.00000000000000 + 1629.86732385786*I
mpc(real='0.0', imag='1.5128697751040891e+471')
1.00000000000000 + 1.51286977510409e471*I
mpc(real='0.0', imag='5.1260939089106243e+48155')
1.00000000000000 + 5.12609390891062e48155*I
mpc(real='0.0', imag='2.6385510598470926e+4824525')
1.00000000000000 + 2.63855105984709e4824525*I
```


* Starting to be wrong in the imaginary component as well as the number gets closer to 0

```
sage: pari(3*i).erfc()
-1.76710569338983 E-16 - 1629.86732385786*I
sage: mpmath.erfc(3*i)
mpc(real='1.0', imag='-1629.9946226015657')
sage: 1-pari(3*i).erfc()
1.00000000000000 + 1629.86732385786*I
sage: mpmath.erf(3*i)
mpc(real='0.0', imag='1629.9946226015657')
sage: erf(i*1.42)
1.00000000000000 + 4.03986343036907*I
sage: import mpmath
sage: mpmath.erf(i*1.42)
mpc(real='0.0', imag='3.8217653554366318')
```


Ideally this would be fixed by #1173 or #13050, but if there is something else we can do (and soon) that would be fine too.

Issue created by migration from https://trac.sagemath.org/ticket/13193





---

archive/issue_comments_157486.json:
```json
{
    "body": "Note that up until about `1.42*i` we are fine, first noted by Jeff Denny.\n\n```\nsage: mpmath.erf(1.4*i)\nmpc(real='0.0', imag='3.6569574831625342')\nsage: erf(1.4*i)\n3.65695748316253*I\n```\n",
    "created_at": "2012-07-02T15:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157486",
    "user": "@kcrisman"
}
```

Note that up until about `1.42*i` we are fine, first noted by Jeff Denny.

```
sage: mpmath.erf(1.4*i)
mpc(real='0.0', imag='3.6569574831625342')
sage: erf(1.4*i)
3.65695748316253*I
```




---

archive/issue_comments_157487.json:
```json
{
    "body": "This should be reported upstream to PARI: http://pari.math.u-bordeaux.fr/Bugs/Reporting.html",
    "created_at": "2012-07-02T15:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157487",
    "user": "@jdemeyer"
}
```

This should be reported upstream to PARI: http://pari.math.u-bordeaux.fr/Bugs/Reporting.html



---

archive/issue_comments_157488.json:
```json
{
    "body": "> This should be reported upstream to PARI: http://pari.math.u-bordeaux.fr/Bugs/Reporting.html\nI'd been ... discouraged from this in the past.  But I'll try.  Part of the problem is that I don't have access to a more recent Pari, in case it's been fixed since our version.",
    "created_at": "2012-07-02T15:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157488",
    "user": "@kcrisman"
}
```

> This should be reported upstream to PARI: http://pari.math.u-bordeaux.fr/Bugs/Reporting.html
I'd been ... discouraged from this in the past.  But I'll try.  Part of the problem is that I don't have access to a more recent Pari, in case it's been fixed since our version.



---

archive/issue_comments_157489.json:
```json
{
    "body": "Okay, I tried this.   I am not sure where to look for it yet, but when I find it online I'll put up a link.",
    "created_at": "2012-07-02T16:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157489",
    "user": "@kcrisman"
}
```

Okay, I tried this.   I am not sure where to look for it yet, but when I find it online I'll put up a link.



---

archive/issue_comments_157490.json:
```json
{
    "body": "Update - this is now [Pari bug 1335](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1335).",
    "created_at": "2012-07-02T16:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157490",
    "user": "@kcrisman"
}
```

Update - this is now [Pari bug 1335](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1335).



---

archive/issue_comments_157491.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-10T15:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157491",
    "user": "@benjaminfjones"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_157492.json:
```json
{
    "body": "The madness with `erf` has gone on long enough! Here is a patch to tide us over until the `algorithm=...` parameter to `_evalf_` can be implemented. \n\nI only had to make one (tiny) change to one doctest after switching the numerical eval to mpmath. I also added a couple of doctests that reference this ticket.",
    "created_at": "2012-07-10T15:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157492",
    "user": "@benjaminfjones"
}
```

The madness with `erf` has gone on long enough! Here is a patch to tide us over until the `algorithm=...` parameter to `_evalf_` can be implemented. 

I only had to make one (tiny) change to one doctest after switching the numerical eval to mpmath. I also added a couple of doctests that reference this ticket.



---

archive/issue_comments_157493.json:
```json
{
    "body": "Does this do\n\n```\nerf(3*I).n()\n```\n\ncorrectly now?  If you are still passing doctests, then apparently not.",
    "created_at": "2012-07-10T15:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157493",
    "user": "@kcrisman"
}
```

Does this do

```
erf(3*I).n()
```

correctly now?  If you are still passing doctests, then apparently not.



---

archive/issue_comments_157494.json:
```json
{
    "body": "Yep,\n\n\n```\nsage: erf(3*I).n()\n1629.99462260157*I\n```\n\n\nwhere is the doctest you are referring to?",
    "created_at": "2012-07-10T16:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157494",
    "user": "@benjaminfjones"
}
```

Yep,


```
sage: erf(3*I).n()
1629.99462260157*I
```


where is the doctest you are referring to?



---

archive/issue_comments_157495.json:
```json
{
    "body": "In `sage/symbolic/expression.pyx` I found one. I didn't run full tests (was waiting for patchbot). I'll update the patch.",
    "created_at": "2012-07-10T16:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157495",
    "user": "@benjaminfjones"
}
```

In `sage/symbolic/expression.pyx` I found one. I didn't run full tests (was waiting for patchbot). I'll update the patch.



---

archive/issue_comments_157496.json:
```json
{
    "body": "update doctest in sage/symbolic/expression.pyx",
    "created_at": "2012-07-10T16:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157496",
    "user": "@benjaminfjones"
}
```

update doctest in sage/symbolic/expression.pyx



---

archive/issue_comments_157497.json:
```json
{
    "body": "Attachment [trac_13193.1.patch](tarball://root/attachments/some-uuid/ticket13193/trac_13193.1.patch) by @benjaminfjones created at 2012-07-10 16:42:53\n\n`@`kcrisman, it looks like your reviewer patch on #11948 was merged in 4.8.alpha6, but then my patch at #13001 reorganized the doctests (moved a bunch from `__init__` to the class docstring) and the `erf(3*I).n()` doctest got removed in the process (oops!). \n\nShould I add it back in do you think? I have `erf(3.0*I)` which calls `_evalf_` just the same.",
    "created_at": "2012-07-10T16:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157497",
    "user": "@benjaminfjones"
}
```

Attachment [trac_13193.1.patch](tarball://root/attachments/some-uuid/ticket13193/trac_13193.1.patch) by @benjaminfjones created at 2012-07-10 16:42:53

`@`kcrisman, it looks like your reviewer patch on #11948 was merged in 4.8.alpha6, but then my patch at #13001 reorganized the doctests (moved a bunch from `__init__` to the class docstring) and the `erf(3*I).n()` doctest got removed in the process (oops!). 

Should I add it back in do you think? I have `erf(3.0*I)` which calls `_evalf_` just the same.



---

archive/issue_comments_157498.json:
```json
{
    "body": "> `@`kcrisman, it looks like your reviewer patch on #11948 was merged in 4.8.alpha6, but then my patch at #13001 reorganized the doctests (moved a bunch from `__init__` to the class docstring) and the `erf(3*I).n()` doctest got removed in the process (oops!). \n\nThat's hilarious! You must have done this at the Sage Days, and not mentioned it to me :)  So you removed an erroneous doctest.  Glad you nabbed the one in symbolic/expression.pyx, though.\n\n> Should I add it back in do you think? I have `erf(3.0*I)` which calls `_evalf_` just the same.\n\nNo, the one you changed is sufficient, since it does integer times I instead of real times I.  Nice.\n\nShould this be a blocker for Sage 5.2, since it is mathematically wrong?  Anyway, on a first glance this seems like a good patch.\n\nBefore:\n\n```\nsage: timeit('erf(320).n()')\n625 loops, best of 3: 147 \u00b5s per loop\nsage: timeit('erf(320*I).n()')\n125 loops, best of 3: 5.49 ms per loop\nsage: timeit('erf(-100).n()')\n625 loops, best of 3: 160 \u00b5s per loop\nsage: timeit('erf(100-100*i).n()')\n125 loops, best of 3: 1.81 ms per loop\nsage: timeit('erf(1+i).n()')\n125 loops, best of 3: 1.65 ms per loop\n\n```\n\nAfter:\n\n```\nsage: timeit('erf(320).n()')\n625 loops, best of 3: 138 \u00b5s per loop\nsage: timeit('erf(320*I).n()')\n125 loops, best of 3: 2.15 ms per loop\nsage: timeit('erf(-100).n()')\n625 loops, best of 3: 137 \u00b5s per loop\nsage: timeit('erf(100-100*i).n()')\n125 loops, best of 3: 2.36 ms per loop\nsage: timeit('erf(1+i).n()')\n125 loops, best of 3: 1.73 ms per loop\n```\n\n\nSometimes slower, sometimes faster, except on the one that was wrong before, where it's faster.\n\nLooks pretty good.  I'll see what the patchbot says.",
    "created_at": "2012-07-10T17:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157498",
    "user": "@kcrisman"
}
```

> `@`kcrisman, it looks like your reviewer patch on #11948 was merged in 4.8.alpha6, but then my patch at #13001 reorganized the doctests (moved a bunch from `__init__` to the class docstring) and the `erf(3*I).n()` doctest got removed in the process (oops!). 

That's hilarious! You must have done this at the Sage Days, and not mentioned it to me :)  So you removed an erroneous doctest.  Glad you nabbed the one in symbolic/expression.pyx, though.

> Should I add it back in do you think? I have `erf(3.0*I)` which calls `_evalf_` just the same.

No, the one you changed is sufficient, since it does integer times I instead of real times I.  Nice.

Should this be a blocker for Sage 5.2, since it is mathematically wrong?  Anyway, on a first glance this seems like a good patch.

Before:

```
sage: timeit('erf(320).n()')
625 loops, best of 3: 147 µs per loop
sage: timeit('erf(320*I).n()')
125 loops, best of 3: 5.49 ms per loop
sage: timeit('erf(-100).n()')
625 loops, best of 3: 160 µs per loop
sage: timeit('erf(100-100*i).n()')
125 loops, best of 3: 1.81 ms per loop
sage: timeit('erf(1+i).n()')
125 loops, best of 3: 1.65 ms per loop

```

After:

```
sage: timeit('erf(320).n()')
625 loops, best of 3: 138 µs per loop
sage: timeit('erf(320*I).n()')
125 loops, best of 3: 2.15 ms per loop
sage: timeit('erf(-100).n()')
625 loops, best of 3: 137 µs per loop
sage: timeit('erf(100-100*i).n()')
125 loops, best of 3: 2.36 ms per loop
sage: timeit('erf(1+i).n()')
125 loops, best of 3: 1.73 ms per loop
```


Sometimes slower, sometimes faster, except on the one that was wrong before, where it's faster.

Looks pretty good.  I'll see what the patchbot says.



---

archive/issue_comments_157499.json:
```json
{
    "body": "I think this looks good.  How on earth does patchbot test the entire library on Volker's computer in 540 seconds?  My computer's a dinosaur in comparison - or, better, my computer's not a quick, lean, agile dinosaur in comparison.",
    "created_at": "2012-07-10T17:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157499",
    "user": "@kcrisman"
}
```

I think this looks good.  How on earth does patchbot test the entire library on Volker's computer in 540 seconds?  My computer's a dinosaur in comparison - or, better, my computer's not a quick, lean, agile dinosaur in comparison.



---

archive/issue_comments_157500.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-10T17:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157500",
    "user": "@kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_157501.json:
```json
{
    "body": "I was wondering that myself :) Why bother running doctests locally when Volker's machine will power through them in under 10 minutes! Thanks for the review.",
    "created_at": "2012-07-10T17:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157501",
    "user": "@benjaminfjones"
}
```

I was wondering that myself :) Why bother running doctests locally when Volker's machine will power through them in under 10 minutes! Thanks for the review.



---

archive/issue_comments_157502.json:
```json
{
    "body": "> Thanks for the review.\nThanks for DOING this.",
    "created_at": "2012-07-10T17:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157502",
    "user": "@kcrisman"
}
```

> Thanks for the review.
Thanks for DOING this.



---

archive/issue_comments_157503.json:
```json
{
    "body": "Please don't do this:\n\n```\n# avoid name conflicts with `parent` as a function parameter\nfrom sage.structure.coerce import parent as s_parent\n```\n\n\nIf you need to change something to avoid a conflict, change the function parameter instead.",
    "created_at": "2012-07-11T09:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157503",
    "user": "@jdemeyer"
}
```

Please don't do this:

```
# avoid name conflicts with `parent` as a function parameter
from sage.structure.coerce import parent as s_parent
```


If you need to change something to avoid a conflict, change the function parameter instead.



---

archive/issue_comments_157504.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-07-11T09:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157504",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_157505.json:
```json
{
    "body": "I thought this hack was used in several other place, though, so that we're being consistent with other stuff?  Also, in that case we would need some deprecation period, and we'd still need the hack to actually fix the problem.",
    "created_at": "2012-07-11T13:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157505",
    "user": "@kcrisman"
}
```

I thought this hack was used in several other place, though, so that we're being consistent with other stuff?  Also, in that case we would need some deprecation period, and we'd still need the hack to actually fix the problem.



---

archive/issue_comments_157506.json:
```json
{
    "body": "Agreed.",
    "created_at": "2012-07-11T13:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157506",
    "user": "@jdemeyer"
}
```

Agreed.



---

archive/issue_comments_157507.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-07-11T13:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157507",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_157508.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-07-16T16:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157508",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_157509.json:
```json
{
    "body": "Incidentally, the Pari bug is now [fixed](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1335&msg=5), so if/when we ever implement various backends for special functions, we can use Pari for this one!",
    "created_at": "2012-08-31T16:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13021#issuecomment-157509",
    "user": "@kcrisman"
}
```

Incidentally, the Pari bug is now [fixed](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1335&msg=5), so if/when we ever implement various backends for special functions, we can use Pari for this one!
