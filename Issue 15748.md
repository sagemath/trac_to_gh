# Issue 15748: Python 3 preparation: Fix implicit relative imports (from sibling modules)

Issue created by migration from https://trac.sagemath.org/ticket/15985

Original creator: wluebbe

Original creation time: 2014-03-20 15:22:38

CC:  tscrim jmantysalo jdemeyer

Keywords: python3

Python 3 accepts only absolute imports and explicit relative imports. 
To be Python 2 compatible all affected modules need `from __future__ import absolute_import`.

`lib2to3/fixes/fix_import.py` does not add this __future__ import.

Therefore we intend to use an enhanced fixer from `https://pypi.python.org/pypi/future/0.11.3`.

The latest development version also handles imports of pyx modules.

Changes according to `libfuturize/fixes/fix_absolute_imports.py`:

```
If spam is being imported from the local directory, this import:
    from spam import eggs
becomes:
    from .spam import eggs

and this import:
    import spam
becomes:
    from . import spam
```


This ticket is tracked as a dependency of meta-ticket ticket:15980.


---

Comment by wluebbe created at 2014-03-20 15:47:12

Changing type from defect to enhancement.


---

Comment by wluebbe created at 2014-04-01 09:32:01

Changing status from new to needs_review.


---

Comment by wluebbe created at 2014-04-01 09:32:01

New commits:


---

Comment by wluebbe created at 2014-04-01 09:39:24

Changing status from needs_review to needs_work.


---

Comment by wluebbe created at 2014-04-01 09:39:24

Ticket needs work :-(

make failed while building html-doc:

```
byte-compiling /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/probability/random_variable.py to random_variable.pyc
running install_egg_info
Removing /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage-6.2.beta5-py2.7.egg-info
Writing /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage-6.2.beta5-py2.7.egg-info

real	10m2.009s
user	35m33.530s
sys	0m48.657s
[ -f local/etc/sage-started.txt ] || local/bin/sage-starts
build/pipestatus "./sage --docbuild --no-pdf-links all html  2>&1" "tee -a logs/dochtml.log"
Traceback (most recent call last):
  File "/home/wluebbe/sage-6.2.beta4/src/doc/common/builder.py", line 1465, in <module>
    import sage.all
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/all.py", line 87, in <module>
    from sage.misc.all       import *         # takes a while
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/misc/all.py", line 94, in <module>
    from .functional import (additive_order,
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/misc/functional.py", line 37, in <module>
    from sage.rings.complex_double import CDF
  File "integer.pxd", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:17880)
  File "integer.pyx", line 179, in init sage.rings.integer (sage/rings/integer.c:40148)
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings/infinity.py", line 203, in <module>
    import sage.rings.rational
  File "fast_arith.pxd", line 5, in init sage.rings.rational (sage/rings/rational.c:29096)
  File "fast_arith.pyx", line 51, in init sage.rings.fast_arith (sage/rings/fast_arith.c:8036)
  File "integer_ring.pyx", line 65, in init sage.rings.integer_ring (sage/rings/integer_ring.c:12457)
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings/rational_field.py", line 54, in <module>
    from . import rational
ImportError: cannot import name rational
make: *** [doc-html] Error 1
```


The problem occurs while trying to import the cython module `ration.pyx`. But `rational.so`is in the same subdir. So the explicit relative import should succeed.

```
wluebbe@Willis-Ubuntu:~/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings$ ls -l ratio*
-rw-r--r-- 1 wluebbe wluebbe   28433 Apr  1 10:58 rational_field.py
-rw-r--r-- 1 wluebbe wluebbe   34240 Apr  1 11:08 rational_field.pyc
-rwxr-xr-x 1 wluebbe wluebbe 1666692 Apr  1 11:06 rational.so
```



---

Comment by git created at 2014-04-03 08:52:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by wluebbe created at 2014-04-03 08:53:08

Rebased on 6.2.beta6 and resolved merge conflicts.


---

Comment by ohanar created at 2014-04-03 16:15:43

New commits:


---

Comment by ohanar created at 2014-04-03 19:44:09

So it looks like the issue that you are getting into is the wonder that is affectionately referred to as Sage's import hell :).

Looking at the traceback, it looks like the issue is a circular import that mysteriously works right now: `sage.rings.rational` imports something from `sage.rings.fast_arith` which imports something from `sage.rings.integer_ring` which imports something from `sage.rings.rational_field` which imports `sage.rings.rational`.

This is one of the big reasons why Sage is not truly usable as a python library, because the order in which you import Sage is incredibly delicate, and seems to magically work (and as you can see from this patch which shouldn't change anything, it truly is magical). There hasn't been much effort to fix this, but I would say that getting Python 3 working is a pretty big motivator.


---

Comment by ohanar created at 2014-04-04 00:56:47

One thing to try (which still might break) is removing all relative imports in favor of absolute imports, rather than just converting them to explicit relative imports.


---

Comment by wluebbe created at 2014-04-04 08:29:48

Some numbers:
standard library and implicit relative import
(and 1 explicit relative import :-)|| about 5,000||
|                   |        |
|-------------------|--------|
|lines with "import"| 26,3231|
|- thereof lines with "from sage"| 19,581|
|- thereof lines with "import sage"| 1,650|
|leaving lines with imports from Python 
Questions:
* Is there agreement in the Sage community that absolute import is the way to go?
* Can it help with the above `ImportError`? And similar ones?
* Other benefits or drawbacks?


---

Comment by ohanar created at 2014-04-04 13:57:42

As your numbers indicate (and from my personal experience), there is definitely an unofficial convention to use absolute from..import statements in the sage library, i.e. `from sage.foo import bar`; however this is one of (if not the main) culprit behind the circular import issues of the Sage library. A lot of the circular import issues could be resolved by just importing a module, and not particular attributes of the module (i.e. using `import sage.foo` or `import sage.foo as bar` and using `sage.foo.baz`/`bar.baz` instead of `from sage.foo import baz`).


---

Comment by wluebbe created at 2014-04-04 14:42:19

Can I read this proposal as:

Do the (absolute) imports as `import sage.somewhere.amodule as am` and then use it as `am.a_function(a_parm)`.

Perhaps the module could recommend its "standard" abbreviation (here `am`). Such a convention might help while reading code that uses the module.


---

Comment by chapoton created at 2016-07-06 13:28:46

Let us do that chunk by chunk.

See #20958, #20960, #20955, #20945, #20947 for the first steps


---

Comment by chapoton created at 2016-07-15 11:55:52

Changing component from distribution to python3.


---

Comment by chapoton created at 2016-07-17 12:19:05

Almost done, last step is #21036

there just remains a small problem in src/sage/misc/sagedoc.py


---

Comment by chapoton created at 2016-07-19 12:14:08

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-07-19 12:14:08

Here is the very small last step. Hopefully the doctests will pass.

For the reviewer: to check, see that (after #21036 is closed)

`futurize -w -f absolute_import src/sage`

does nothing.

----
New commits:


---

Comment by jdemeyer created at 2016-07-25 10:05:38

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-07-25 10:05:38

It's not really the last step, since there are still a lot of implicit relative imports in Cython files.


---

Comment by vbraun created at 2016-07-27 20:24:57

Resolution: fixed


---

Comment by jdemeyer created at 2017-04-14 09:28:11

Replying to [comment:18 jdemeyer]:
> It's not really the last step, since there are still a lot of implicit relative imports in Cython files.

See #22806 and #22808.


---

Comment by jdemeyer created at 2017-04-14 09:38:43

Replying to [comment:17 chapoton]:
> Here is the very small last step.

How did you determine that this is the "last step"? In other words, how did you determine which modules need to be fixed?

There are still plenty of `.py` and `.pyx` files which do not have `from __future__ import absolute_import`.
