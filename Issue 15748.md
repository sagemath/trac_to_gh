# Issue 15748: Python 3 preparation: Fix implicit relative imports (from sibling modules)

archive/issues_015748.json:
```json
{
    "body": "CC:  tscrim jmantysalo jdemeyer\n\nKeywords: python3\n\nPython 3 accepts only absolute imports and explicit relative imports. \nTo be Python 2 compatible all affected modules need `from __future__ import absolute_import`.\n\n`lib2to3/fixes/fix_import.py` does not add this __future__ import.\n\nTherefore we intend to use an enhanced fixer from `https://pypi.python.org/pypi/future/0.11.3`.\n\nThe latest development version also handles imports of pyx modules.\n\nChanges according to `libfuturize/fixes/fix_absolute_imports.py`:\n\n```\nIf spam is being imported from the local directory, this import:\n    from spam import eggs\nbecomes:\n    from .spam import eggs\n\nand this import:\n    import spam\nbecomes:\n    from . import spam\n```\n\n\nThis ticket is tracked as a dependency of meta-ticket ticket:15980.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15985\n\n",
    "created_at": "2014-03-20T15:22:38Z",
    "labels": [
        "distribution",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Python 3 preparation: Fix implicit relative imports (from sibling modules)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15748",
    "user": "wluebbe"
}
```
CC:  tscrim jmantysalo jdemeyer

Keywords: python3

Python 3 accepts only absolute imports and explicit relative imports. 
To be Python 2 compatible all affected modules need `from __future__ import absolute_import`.

`lib2to3/fixes/fix_import.py` does not add this __future__ import.

Therefore we intend to use an enhanced fixer from `https://pypi.python.org/pypi/future/0.11.3`.

The latest development version also handles imports of pyx modules.

Changes according to `libfuturize/fixes/fix_absolute_imports.py`:

```
If spam is being imported from the local directory, this import:
    from spam import eggs
becomes:
    from .spam import eggs

and this import:
    import spam
becomes:
    from . import spam
```


This ticket is tracked as a dependency of meta-ticket ticket:15980.

Issue created by migration from https://trac.sagemath.org/ticket/15985





---

archive/issue_comments_203887.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2014-03-20T15:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203887",
    "user": "wluebbe"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_203888.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-01T09:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203888",
    "user": "wluebbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_203889.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-04-01T09:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203889",
    "user": "wluebbe"
}
```

New commits:



---

archive/issue_comments_203890.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-04-01T09:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203890",
    "user": "wluebbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_203891.json:
```json
{
    "body": "Ticket needs work :-(\n\nmake failed while building html-doc:\n\n```\nbyte-compiling /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/probability/random_variable.py to random_variable.pyc\nrunning install_egg_info\nRemoving /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage-6.2.beta5-py2.7.egg-info\nWriting /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage-6.2.beta5-py2.7.egg-info\n\nreal\t10m2.009s\nuser\t35m33.530s\nsys\t0m48.657s\n[ -f local/etc/sage-started.txt ] || local/bin/sage-starts\nbuild/pipestatus \"./sage --docbuild --no-pdf-links all html  2>&1\" \"tee -a logs/dochtml.log\"\nTraceback (most recent call last):\n  File \"/home/wluebbe/sage-6.2.beta4/src/doc/common/builder.py\", line 1465, in <module>\n    import sage.all\n  File \"/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/all.py\", line 87, in <module>\n    from sage.misc.all       import *         # takes a while\n  File \"/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/misc/all.py\", line 94, in <module>\n    from .functional import (additive_order,\n  File \"/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 37, in <module>\n    from sage.rings.complex_double import CDF\n  File \"integer.pxd\", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:17880)\n  File \"integer.pyx\", line 179, in init sage.rings.integer (sage/rings/integer.c:40148)\n  File \"/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings/infinity.py\", line 203, in <module>\n    import sage.rings.rational\n  File \"fast_arith.pxd\", line 5, in init sage.rings.rational (sage/rings/rational.c:29096)\n  File \"fast_arith.pyx\", line 51, in init sage.rings.fast_arith (sage/rings/fast_arith.c:8036)\n  File \"integer_ring.pyx\", line 65, in init sage.rings.integer_ring (sage/rings/integer_ring.c:12457)\n  File \"/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings/rational_field.py\", line 54, in <module>\n    from . import rational\nImportError: cannot import name rational\nmake: *** [doc-html] Error 1\n```\n\n\nThe problem occurs while trying to import the cython module `ration.pyx`. But `rational.so`is in the same subdir. So the explicit relative import should succeed.\n\n```\nwluebbe@Willis-Ubuntu:~/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings$ ls -l ratio*\n-rw-r--r-- 1 wluebbe wluebbe   28433 Apr  1 10:58 rational_field.py\n-rw-r--r-- 1 wluebbe wluebbe   34240 Apr  1 11:08 rational_field.pyc\n-rwxr-xr-x 1 wluebbe wluebbe 1666692 Apr  1 11:06 rational.so\n```\n",
    "created_at": "2014-04-01T09:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203891",
    "user": "wluebbe"
}
```

Ticket needs work :-(

make failed while building html-doc:

```
byte-compiling /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/probability/random_variable.py to random_variable.pyc
running install_egg_info
Removing /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage-6.2.beta5-py2.7.egg-info
Writing /home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage-6.2.beta5-py2.7.egg-info

real	10m2.009s
user	35m33.530s
sys	0m48.657s
[ -f local/etc/sage-started.txt ] || local/bin/sage-starts
build/pipestatus "./sage --docbuild --no-pdf-links all html  2>&1" "tee -a logs/dochtml.log"
Traceback (most recent call last):
  File "/home/wluebbe/sage-6.2.beta4/src/doc/common/builder.py", line 1465, in <module>
    import sage.all
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/all.py", line 87, in <module>
    from sage.misc.all       import *         # takes a while
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/misc/all.py", line 94, in <module>
    from .functional import (additive_order,
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/misc/functional.py", line 37, in <module>
    from sage.rings.complex_double import CDF
  File "integer.pxd", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:17880)
  File "integer.pyx", line 179, in init sage.rings.integer (sage/rings/integer.c:40148)
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings/infinity.py", line 203, in <module>
    import sage.rings.rational
  File "fast_arith.pxd", line 5, in init sage.rings.rational (sage/rings/rational.c:29096)
  File "fast_arith.pyx", line 51, in init sage.rings.fast_arith (sage/rings/fast_arith.c:8036)
  File "integer_ring.pyx", line 65, in init sage.rings.integer_ring (sage/rings/integer_ring.c:12457)
  File "/home/wluebbe/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings/rational_field.py", line 54, in <module>
    from . import rational
ImportError: cannot import name rational
make: *** [doc-html] Error 1
```


The problem occurs while trying to import the cython module `ration.pyx`. But `rational.so`is in the same subdir. So the explicit relative import should succeed.

```
wluebbe@Willis-Ubuntu:~/sage-6.2.beta4/local/lib/python2.7/site-packages/sage/rings$ ls -l ratio*
-rw-r--r-- 1 wluebbe wluebbe   28433 Apr  1 10:58 rational_field.py
-rw-r--r-- 1 wluebbe wluebbe   34240 Apr  1 11:08 rational_field.pyc
-rwxr-xr-x 1 wluebbe wluebbe 1666692 Apr  1 11:06 rational.so
```




---

archive/issue_comments_203892.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-04-03T08:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203892",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_203893.json:
```json
{
    "body": "Rebased on 6.2.beta6 and resolved merge conflicts.",
    "created_at": "2014-04-03T08:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203893",
    "user": "wluebbe"
}
```

Rebased on 6.2.beta6 and resolved merge conflicts.



---

archive/issue_comments_203894.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-04-03T16:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203894",
    "user": "ohanar"
}
```

New commits:



---

archive/issue_comments_203895.json:
```json
{
    "body": "So it looks like the issue that you are getting into is the wonder that is affectionately referred to as Sage's import hell :).\n\nLooking at the traceback, it looks like the issue is a circular import that mysteriously works right now: `sage.rings.rational` imports something from `sage.rings.fast_arith` which imports something from `sage.rings.integer_ring` which imports something from `sage.rings.rational_field` which imports `sage.rings.rational`.\n\nThis is one of the big reasons why Sage is not truly usable as a python library, because the order in which you import Sage is incredibly delicate, and seems to magically work (and as you can see from this patch which shouldn't change anything, it truly is magical). There hasn't been much effort to fix this, but I would say that getting Python 3 working is a pretty big motivator.",
    "created_at": "2014-04-03T19:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203895",
    "user": "ohanar"
}
```

So it looks like the issue that you are getting into is the wonder that is affectionately referred to as Sage's import hell :).

Looking at the traceback, it looks like the issue is a circular import that mysteriously works right now: `sage.rings.rational` imports something from `sage.rings.fast_arith` which imports something from `sage.rings.integer_ring` which imports something from `sage.rings.rational_field` which imports `sage.rings.rational`.

This is one of the big reasons why Sage is not truly usable as a python library, because the order in which you import Sage is incredibly delicate, and seems to magically work (and as you can see from this patch which shouldn't change anything, it truly is magical). There hasn't been much effort to fix this, but I would say that getting Python 3 working is a pretty big motivator.



---

archive/issue_comments_203896.json:
```json
{
    "body": "One thing to try (which still might break) is removing all relative imports in favor of absolute imports, rather than just converting them to explicit relative imports.",
    "created_at": "2014-04-04T00:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203896",
    "user": "ohanar"
}
```

One thing to try (which still might break) is removing all relative imports in favor of absolute imports, rather than just converting them to explicit relative imports.



---

archive/issue_comments_203897.json:
```json
{
    "body": "Some numbers:\nstandard library and implicit relative import\n(and 1 explicit relative import :-)|| about 5,000||\n|                   |        |\n|-------------------|--------|\n|lines with \"import\"| 26,3231|\n|- thereof lines with \"from sage\"| 19,581|\n|- thereof lines with \"import sage\"| 1,650|\n|leaving lines with imports from Python \nQuestions:\n* Is there agreement in the Sage community that absolute import is the way to go?\n* Can it help with the above `ImportError`? And similar ones?\n* Other benefits or drawbacks?",
    "created_at": "2014-04-04T08:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203897",
    "user": "wluebbe"
}
```

Some numbers:
standard library and implicit relative import
(and 1 explicit relative import :-)|| about 5,000||
|                   |        |
|-------------------|--------|
|lines with "import"| 26,3231|
|- thereof lines with "from sage"| 19,581|
|- thereof lines with "import sage"| 1,650|
|leaving lines with imports from Python 
Questions:
* Is there agreement in the Sage community that absolute import is the way to go?
* Can it help with the above `ImportError`? And similar ones?
* Other benefits or drawbacks?



---

archive/issue_comments_203898.json:
```json
{
    "body": "As your numbers indicate (and from my personal experience), there is definitely an unofficial convention to use absolute from..import statements in the sage library, i.e. `from sage.foo import bar`; however this is one of (if not the main) culprit behind the circular import issues of the Sage library. A lot of the circular import issues could be resolved by just importing a module, and not particular attributes of the module (i.e. using `import sage.foo` or `import sage.foo as bar` and using `sage.foo.baz`/`bar.baz` instead of `from sage.foo import baz`).",
    "created_at": "2014-04-04T13:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203898",
    "user": "ohanar"
}
```

As your numbers indicate (and from my personal experience), there is definitely an unofficial convention to use absolute from..import statements in the sage library, i.e. `from sage.foo import bar`; however this is one of (if not the main) culprit behind the circular import issues of the Sage library. A lot of the circular import issues could be resolved by just importing a module, and not particular attributes of the module (i.e. using `import sage.foo` or `import sage.foo as bar` and using `sage.foo.baz`/`bar.baz` instead of `from sage.foo import baz`).



---

archive/issue_comments_203899.json:
```json
{
    "body": "Can I read this proposal as:\n\nDo the (absolute) imports as `import sage.somewhere.amodule as am` and then use it as `am.a_function(a_parm)`.\n\nPerhaps the module could recommend its \"standard\" abbreviation (here `am`). Such a convention might help while reading code that uses the module.",
    "created_at": "2014-04-04T14:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203899",
    "user": "wluebbe"
}
```

Can I read this proposal as:

Do the (absolute) imports as `import sage.somewhere.amodule as am` and then use it as `am.a_function(a_parm)`.

Perhaps the module could recommend its "standard" abbreviation (here `am`). Such a convention might help while reading code that uses the module.



---

archive/issue_comments_203900.json:
```json
{
    "body": "Let us do that chunk by chunk.\n\nSee #20958, #20960, #20955, #20945, #20947 for the first steps",
    "created_at": "2016-07-06T13:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203900",
    "user": "chapoton"
}
```

Let us do that chunk by chunk.

See #20958, #20960, #20955, #20945, #20947 for the first steps



---

archive/issue_comments_203901.json:
```json
{
    "body": "Changing component from distribution to python3.",
    "created_at": "2016-07-15T11:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203901",
    "user": "chapoton"
}
```

Changing component from distribution to python3.



---

archive/issue_comments_203902.json:
```json
{
    "body": "Almost done, last step is #21036\n\nthere just remains a small problem in src/sage/misc/sagedoc.py",
    "created_at": "2016-07-17T12:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203902",
    "user": "chapoton"
}
```

Almost done, last step is #21036

there just remains a small problem in src/sage/misc/sagedoc.py



---

archive/issue_comments_203903.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-19T12:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203903",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_203904.json:
```json
{
    "body": "Here is the very small last step. Hopefully the doctests will pass.\n\nFor the reviewer: to check, see that (after #21036 is closed)\n\n`futurize -w -f absolute_import src/sage`\n\ndoes nothing.\n\n----\nNew commits:",
    "created_at": "2016-07-19T12:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203904",
    "user": "chapoton"
}
```

Here is the very small last step. Hopefully the doctests will pass.

For the reviewer: to check, see that (after #21036 is closed)

`futurize -w -f absolute_import src/sage`

does nothing.

----
New commits:



---

archive/issue_comments_203905.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-25T10:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203905",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203906.json:
```json
{
    "body": "It's not really the last step, since there are still a lot of implicit relative imports in Cython files.",
    "created_at": "2016-07-25T10:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203906",
    "user": "jdemeyer"
}
```

It's not really the last step, since there are still a lot of implicit relative imports in Cython files.



---

archive/issue_comments_203907.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-27T20:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203907",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_203908.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> It's not really the last step, since there are still a lot of implicit relative imports in Cython files.\n\nSee #22806 and #22808.",
    "created_at": "2017-04-14T09:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203908",
    "user": "jdemeyer"
}
```

Replying to [comment:18 jdemeyer]:
> It's not really the last step, since there are still a lot of implicit relative imports in Cython files.

See #22806 and #22808.



---

archive/issue_comments_203909.json:
```json
{
    "body": "Replying to [comment:17 chapoton]:\n> Here is the very small last step.\n\nHow did you determine that this is the \"last step\"? In other words, how did you determine which modules need to be fixed?\n\nThere are still plenty of `.py` and `.pyx` files which do not have `from __future__ import absolute_import`.",
    "created_at": "2017-04-14T09:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15748#issuecomment-203909",
    "user": "jdemeyer"
}
```

Replying to [comment:17 chapoton]:
> Here is the very small last step.

How did you determine that this is the "last step"? In other words, how did you determine which modules need to be fixed?

There are still plenty of `.py` and `.pyx` files which do not have `from __future__ import absolute_import`.
