# Issue 13754: number of generators of number field ideal blows up under multiplication

archive/issues_013754.json:
```json
{
    "body": "Assignee: @loefflerd\n\nCC:  @koffie\n\nKeywords: number field ideal multiplication power\n\nWith\n\n```\nK = QQ[sqrt(2)]\nI = K.ideal(2).factor()[0][0]\nI = I*I; I.ngens()\n4\nI = I*I; I.ngens()\n16\nI = I*I; I.ngens()\n256\nI = I*I; I.ngens()\n65536\n```\n\nthe first three squarings are fast, the fourth starts to be a bit slower, and if you try a fifth, it will take up all your memory.\nThe reason is that that the number of generators is multiplied with every multiplication and never reduced back to 1 or 2 with gens_reduced or gens_two, as you can see from the output.\n\nAddition suffers from the same problem, but the result is less dramatic\n\n```\nsage: I = K.ideal(2).factor()[0][0]\nsage: I = I+I; I.ngens()\n4\nsage: I = I+I; I.ngens()\n8\nsage: I = I+I; I.ngens()\n16\nsage: I = I+I; I.ngens()\n32\nsage: I = I+I; I.ngens()\n64\nsage: I = I+I; I.ngens()\n128\nsage: I = I+I; I.ngens()\n256\n```\n\n\nSolution: implement `__mul__` for `NumberFieldFractionalIdeal` (instead of inheriting the function from Ideal) and use gens_two or gens_reduced before giving the output. Or wrap functions from pari.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13958\n\n",
    "created_at": "2013-01-15T13:09:49Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "number of generators of number field ideal blows up under multiplication",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13754",
    "user": "https://github.com/mstreng"
}
```
Assignee: @loefflerd

CC:  @koffie

Keywords: number field ideal multiplication power

With

```
K = QQ[sqrt(2)]
I = K.ideal(2).factor()[0][0]
I = I*I; I.ngens()
4
I = I*I; I.ngens()
16
I = I*I; I.ngens()
256
I = I*I; I.ngens()
65536
```

the first three squarings are fast, the fourth starts to be a bit slower, and if you try a fifth, it will take up all your memory.
The reason is that that the number of generators is multiplied with every multiplication and never reduced back to 1 or 2 with gens_reduced or gens_two, as you can see from the output.

Addition suffers from the same problem, but the result is less dramatic

```
sage: I = K.ideal(2).factor()[0][0]
sage: I = I+I; I.ngens()
4
sage: I = I+I; I.ngens()
8
sage: I = I+I; I.ngens()
16
sage: I = I+I; I.ngens()
32
sage: I = I+I; I.ngens()
64
sage: I = I+I; I.ngens()
128
sage: I = I+I; I.ngens()
256
```


Solution: implement `__mul__` for `NumberFieldFractionalIdeal` (instead of inheriting the function from Ideal) and use gens_two or gens_reduced before giving the output. Or wrap functions from pari.

Issue created by migration from https://trac.sagemath.org/ticket/13958





---

archive/issue_comments_170451.json:
```json
{
    "body": "I don't know how it is exactly in pari, but representing an ideal with 2 generators is not always cheaply done. Some ideal operations more naturally produce a basis of the ideal as a ZZ-basis (or a pseudobasis for relative ideals), which of course are also generators in the ideal sense. So I expect that internally, you should have the possiblity of either (or both) representations and lazily compute one representation from the other. In fact, internally it would probably be good to store them as power products too (being a far more compact representation when doing factor-basis based computations)",
    "created_at": "2013-01-15T21:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170451",
    "user": "https://github.com/nbruin"
}
```

I don't know how it is exactly in pari, but representing an ideal with 2 generators is not always cheaply done. Some ideal operations more naturally produce a basis of the ideal as a ZZ-basis (or a pseudobasis for relative ideals), which of course are also generators in the ideal sense. So I expect that internally, you should have the possiblity of either (or both) representations and lazily compute one representation from the other. In fact, internally it would probably be good to store them as power products too (being a far more compact representation when doing factor-basis based computations)



---

archive/issue_comments_170452.json:
```json
{
    "body": "I did some profiling and from this it seems that gens_two is faster then pari_hnf. \n\nSee: http://pastebin.com/aejaKMds for timings with principal ideals and http://pastebin.com/HU2DExLH for timings with ideals generated by multiple random elements (where the amount or random elements changes).\n\nThe documentation says that gens_two runs in randomized polynomial time (but does not say anything about the degree of the polynomial).\nI think that at least in __mul__ it would make a lot of sense to call gens_two on both ideals before multiplication (at least if I.ngens()>2). Not doing this causes I.ngens() to explode as mentioned above. And my timing suggest that calling gens_two before multiplication and then multiplying is cheaper then first multiplying and then doing something like pari_hnf or gens_two . The reason is that as soon as your ideal is given by n!^2 generators (where n is the degree of the function field) then any operation to reduce the ammount of generators is going to be very costly, simply because the ammount of input generators is so big.",
    "created_at": "2013-01-16T11:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170452",
    "user": "https://github.com/koffie"
}
```

I did some profiling and from this it seems that gens_two is faster then pari_hnf. 

See: http://pastebin.com/aejaKMds for timings with principal ideals and http://pastebin.com/HU2DExLH for timings with ideals generated by multiple random elements (where the amount or random elements changes).

The documentation says that gens_two runs in randomized polynomial time (but does not say anything about the degree of the polynomial).
I think that at least in __mul__ it would make a lot of sense to call gens_two on both ideals before multiplication (at least if I.ngens()>2). Not doing this causes I.ngens() to explode as mentioned above. And my timing suggest that calling gens_two before multiplication and then multiplying is cheaper then first multiplying and then doing something like pari_hnf or gens_two . The reason is that as soon as your ideal is given by n!^2 generators (where n is the degree of the function field) then any operation to reduce the ammount of generators is going to be very costly, simply because the ammount of input generators is so big.



---

archive/issue_comments_170453.json:
```json
{
    "body": "i just wrote a patch and will upload it shortly. Just a message to avoid duplication of effort.",
    "created_at": "2013-01-17T16:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170453",
    "user": "https://github.com/koffie"
}
```

i just wrote a patch and will upload it shortly. Just a message to avoid duplication of effort.



---

archive/issue_comments_170454.json:
```json
{
    "body": "Ok, here is the patch. I did not do anything with the !__add!__ method. The reason being that I think that the memory usage doesn't blow up to bad (the memory needed to store the sum(list_of_ideals) is linear in len(list_of_ideals) while the memory needed for prod(list_of_ideals) was exponential in len(list_of_ideals). And reducing the amount of generators after each addition is probably slower then reducing the amount of generators only when you need to do something more fancy with the Ideal.",
    "created_at": "2013-01-18T10:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170454",
    "user": "https://github.com/koffie"
}
```

Ok, here is the patch. I did not do anything with the !__add!__ method. The reason being that I think that the memory usage doesn't blow up to bad (the memory needed to store the sum(list_of_ideals) is linear in len(list_of_ideals) while the memory needed for prod(list_of_ideals) was exponential in len(list_of_ideals). And reducing the amount of generators after each addition is probably slower then reducing the amount of generators only when you need to do something more fancy with the Ideal.



---

archive/issue_comments_170455.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-18T10:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170455",
    "user": "https://github.com/koffie"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_170456.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-21T15:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170456",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_170457.json:
```json
{
    "body": "off-trac comments sent to mderickx",
    "created_at": "2013-01-21T15:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170457",
    "user": "https://github.com/mstreng"
}
```

off-trac comments sent to mderickx



---

archive/issue_comments_170458.json:
```json
{
    "body": "There is one reaction to the off-trac comments of which I think it deserves to be on trac. Namely why the implementation in the attachement is different from what turned out to be fastest one in the timings in the previous one.\n\nThe reason that it is different is that I tried some other strategy (namely just let pari figure everything out), and I found one that this one was even faster. See: http://pastebin.com/xRhq3mrX\n\nSo that is why I changed the code to do it this way. This has an extra bonus, namely if the pari ideal mul gets improved, then we automatically benefit from this.",
    "created_at": "2013-01-23T11:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170458",
    "user": "https://github.com/koffie"
}
```

There is one reaction to the off-trac comments of which I think it deserves to be on trac. Namely why the implementation in the attachement is different from what turned out to be fastest one in the timings in the previous one.

The reason that it is different is that I tried some other strategy (namely just let pari figure everything out), and I found one that this one was even faster. See: http://pastebin.com/xRhq3mrX

So that is why I changed the code to do it this way. This has an extra bonus, namely if the pari ideal mul gets improved, then we automatically benefit from this.



---

archive/issue_comments_170459.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-23T14:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170459",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_170460.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-25T12:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170460",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170461.json:
```json
{
    "body": "Replying to [comment:1 nbruin]:\n> representing an ideal with 2 generators is not always cheaply done.\n[citation needed]",
    "created_at": "2013-01-25T12:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170461",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:1 nbruin]:
> representing an ideal with 2 generators is not always cheaply done.
[citation needed]



---

archive/issue_comments_170462.json:
```json
{
    "body": "This patch needs a proper commit message.",
    "created_at": "2013-01-25T12:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170462",
    "user": "https://github.com/jdemeyer"
}
```

This patch needs a proper commit message.



---

archive/issue_comments_170463.json:
```json
{
    "body": "Attachment [13958-better-numberfield-mul.patch](tarball://root/attachments/some-uuid/ticket13958/13958-better-numberfield-mul.patch) by @koffie created at 2013-01-26 21:52:45",
    "created_at": "2013-01-26T21:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170463",
    "user": "https://github.com/koffie"
}
```

Attachment [13958-better-numberfield-mul.patch](tarball://root/attachments/some-uuid/ticket13958/13958-better-numberfield-mul.patch) by @koffie created at 2013-01-26 21:52:45



---

archive/issue_comments_170464.json:
```json
{
    "body": "Sorry for the inconvenience. I added a commit message.",
    "created_at": "2013-01-26T21:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170464",
    "user": "https://github.com/koffie"
}
```

Sorry for the inconvenience. I added a commit message.



---

archive/issue_comments_170465.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-30T07:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13754#issuecomment-170465",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
