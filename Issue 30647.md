# Issue 30647: Replace sage_wraps by decorator library

Issue created by migration from https://trac.sagemath.org/ticket/30884

Original creator: @tobiasdiez

Original creation time: 2020-11-10 23:42:18

CC:  mkoeppe klee

Replace the sage custom sage_wrap and decorator_defaults methods by the well-maintained decorator library https://github.com/micheles/decorator.

My motivation is to replace sage's autodoc sphinx extension with the built-in one. For this, the Phyton introspection code needs to work without sage's customization. This ticket is a first step towards this goal. But independently of this motivation the approach using decorator library already provides cleaner code and better introspection results with respect to annotations (e.g. typing information). See the following test script for a comparison:


```
import inspect
from pathlib import Path
from sage.misc.decorators import decorator_keywords, sage_wraps
from decorator import decorator, getfullargspec
from sage.misc.sageinspect import sage_getargspec

@decorator
def warn_slow(func, timelimit=60, *args, **kw):
    print('%s took %d seconds', func.__name__, timelimit)
    return func(*args, **kw)

@warn_slow
def preprocess_input_files(inputdir: Path, tempdir):
    pass

@warn_slow(timelimit=600)
def run_calculation(tempdir, outdir):
    pass

print("With decorator")
print(getfullargspec(preprocess_input_files))
# FullArgSpec(args=['inputdir', 'tempdir'], varargs=None, varkw=None, defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={'inputdir': <class 'pathlib.Path'>})
print(inspect.getfullargspec(preprocess_input_files))
# FullArgSpec(args=['inputdir', 'tempdir'], varargs=None, varkw=None, defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={'inputdir': <class 'pathlib.Path'>})
# !! Yields full information as expected
print(sage_getargspec(preprocess_input_files))
# ArgSpec(args=['inputdir', 'tempdir'], varargs=None, keywords=None, defaults=None)
# !! No annotation information
print(getfullargspec(run_calculation))
# FullArgSpec(args=['tempdir', 'outdir'], varargs=None, varkw=None, defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={})
print(inspect.getfullargspec(run_calculation))
# FullArgSpec(args=['tempdir', 'outdir'], varargs=None, varkw=None, defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={})
print(sage_getargspec(preprocess_input_files))
# ArgSpec(args=['inputdir', 'tempdir'], varargs=None, keywords=None, defaults=None)

@decorator_keywords
def warn_slow_sage(func=None, timelimit=60):
     @sage_wraps(func)
     def wrapper(*args, **kwargs):
         print('%s took %d seconds', func.__name__, timelimit)
         return func(*args, **kw)
     return wrapper

@warn_slow_sage
def preprocess_input_files_sage(inputdir: Path, tempdir):
    pass

@warn_slow_sage(timelimit=600)
def run_calculation_sage(tempdir, outdir):
    pass

print("With sage")
print(getfullargspec(preprocess_input_files_sage))
# FullArgSpec(args=[], varargs='args', varkw='kwargs', defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={})
print(inspect.getfullargspec(preprocess_input_files_sage))
# FullArgSpec(args=[], varargs='args', varkw='kwargs', defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={})
# !! No args nor annotation
print(sage_getargspec(preprocess_input_files_sage))
# ArgSpec(args=['inputdir', 'tempdir'], varargs=None, keywords=None, defaults=None)
print(getfullargspec(run_calculation_sage))
# !! No annotation info
# FullArgSpec(args=[], varargs='args', varkw='kwargs', defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={})
print(inspect.getfullargspec(run_calculation_sage))
# FullArgSpec(args=[], varargs='args', varkw='kwargs', defaults=None, kwonlyargs=[], kwonlydefaults=None, annotations={})
print(sage_getargspec(preprocess_input_files_sage))
# ArgSpec(args=['inputdir', 'tempdir'], varargs=None, keywords=None, defaults=None)
```


Replacing `sage_getargspec` with `inspect.getfullargspec` will be done in a follow-up ticket (as this is already big enough).


---

Comment by git created at 2020-11-10 23:50:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-10 23:52:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-11 00:08:25

Functions such as `sage_wraps` cannot just be removed, as they may be used by user code. They need to go through deprecation


---

Comment by git created at 2020-11-11 15:52:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-11 15:53:27

Good to know! I've readded and marked as deprecated them.

This should be now ready for review.


---

Comment by @tobiasdiez created at 2020-11-11 15:53:41

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-11-11 15:54:10

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mkoeppe created at 2020-11-11 16:43:23

Better squash changes like this so that `git blame` is more accurate


---

Comment by mkoeppe created at 2020-11-11 16:57:55

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-11-11 16:57:55

Does the `decorator` library really misspell `decorator` as `decorater`?


---

Comment by git created at 2020-11-11 16:59:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-11 17:02:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-11 17:03:18

Replying to [comment:9 mkoeppe]:
> Does the `decorator` library really misspell `decorator` as `decorater`?

No of course not. That was a result of some last minute changes on my side. Fixed now.
----
New commits:


---

Comment by @tobiasdiez created at 2020-11-11 17:03:41

Changing status from needs_info to needs_review.


---

Comment by @tobiasdiez created at 2020-11-11 17:05:29

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2020-11-11 18:37:57

Can you explain the purpose of the change

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index b07e9c1..a4ba68e 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -564,7 +564,7 @@ class ReferenceBuilder(AllBuilder):
             if not os.path.exists(refdir):
                 continue
             logger.info('Building bibliography')
-            self._build_bibliography(lang, format, *args, **kwds)
+            #self._build_bibliography(lang, format, *args, **kwds)
             logger.info('Bibliography finished, building dependent manuals')
             self._build_everything_except_bibliography(lang, format, *args, **kwds)
             # The html refman must be build at the end to ensure correct
```

?


---

Comment by git created at 2020-11-11 19:10:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-11 19:11:45

That's only a temporary fix (that I accidentally committed) since I don't have latex installed.


---

Comment by git created at 2020-11-11 20:26:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-11 21:53:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-11 22:15:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-12 08:44:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-12 09:17:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-31 07:31:32

What's the status of this ticket? Just came across a `sage_getargspec` bug (#31309), so it would be great if we can get rid of it


---

Comment by git created at 2021-02-02 17:22:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-02 17:24:09

It is working in principle, but I still need to fix a few things here and there. The biggest problem is that there are some changes to cython files needed, for which it would be really handy if we could get #30371 merged.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-11-28 20:00:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-08 12:17:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-08 12:36:52

Branch pushed to git repo; I updated commit sha1. New commits:
