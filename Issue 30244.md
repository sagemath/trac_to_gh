# Issue 30244: allow any posix-compliant PATCH(1)

archive/issues_030244.json:
```json
{
    "body": "CC:  @thierry-freebsd @orlitzky\n\ncurrently we require GNU patch, version at least 2.7  (from 2009).\nIn particular, BSD patch does not know about `--no-backup-if-mismatch`, something that Sage used. An equivalent, and known to BSD patch as well as GNU patch, option is `--posix`.\n\nSo we could use `--posix` and change spkg-configure to accept BSD patch too.\nI am not sure what's needed to be checked, besides that `--posix` is accepted. Something to learn from https://savannah.gnu.org/forum/forum.php?forum_id=7361 ?\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30481\n\n",
    "created_at": "2020-08-31T17:08:16Z",
    "labels": [
        "component: build: configure",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "allow any posix-compliant PATCH(1)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30244",
    "user": "https://github.com/dimpase"
}
```
CC:  @thierry-freebsd @orlitzky

currently we require GNU patch, version at least 2.7  (from 2009).
In particular, BSD patch does not know about `--no-backup-if-mismatch`, something that Sage used. An equivalent, and known to BSD patch as well as GNU patch, option is `--posix`.

So we could use `--posix` and change spkg-configure to accept BSD patch too.
I am not sure what's needed to be checked, besides that `--posix` is accepted. Something to learn from https://savannah.gnu.org/forum/forum.php?forum_id=7361 ?




Issue created by migration from https://trac.sagemath.org/ticket/30481





---

archive/issue_comments_430732.json:
```json
{
    "body": "Sounds good to me. Additionally we could check to see if the system `patch` supports a `--posix` flag. If it does, we should pass it; otherwise we may simply assume that the implementation respects POSIX (and does not create backups).",
    "created_at": "2020-08-31T17:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430732",
    "user": "https://github.com/orlitzky"
}
```

Sounds good to me. Additionally we could check to see if the system `patch` supports a `--posix` flag. If it does, we should pass it; otherwise we may simply assume that the implementation respects POSIX (and does not create backups).



---

archive/issue_comments_430733.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430733",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_079151.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79151"
}
```



---

archive/issue_comments_430734.json:
```json
{
    "body": "need to check whether an oldish macOS patch (GNU patch 2.5.8, it says) is OK. \n----\nNew commits:",
    "created_at": "2021-06-27T12:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430734",
    "user": "https://github.com/dimpase"
}
```

need to check whether an oldish macOS patch (GNU patch 2.5.8, it says) is OK. 
----
New commits:



---

archive/issue_comments_430735.json:
```json
{
    "body": "This will actually only find a non-POSIX patch, since the `--posix` option only exists in non-conforming implementations =)\n\nI think `printf \"\" | patch --posix` might be a more reliable test of support for the `--posix` flag. And if `--posix` is not supported, we should assume that \"patch\" conforms, i.e.\n\n1. Find \"patch\" with AC_PATH_PROG\n2. Try `printf \"\" | ${PATCH} --posix`. If it works, set `SAGE_PATCH_ARGS=\"--posix\"`.\n3. Rename `build/bin/sage-apply-patches` with an `.in` suffix and add it to `AC_CONFIG_FILES`\n4. Set `patch_args=\"`@`SAGE_PATCH_ARGS`@`\"` in `build/bin/sage-apply-patches.in`.\n\nThat way, if `--posix` is supported, we use it. Otherwise, we assume POSIX conformance.",
    "created_at": "2021-06-27T12:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430735",
    "user": "https://github.com/orlitzky"
}
```

This will actually only find a non-POSIX patch, since the `--posix` option only exists in non-conforming implementations =)

I think `printf "" | patch --posix` might be a more reliable test of support for the `--posix` flag. And if `--posix` is not supported, we should assume that "patch" conforms, i.e.

1. Find "patch" with AC_PATH_PROG
2. Try `printf "" | ${PATCH} --posix`. If it works, set `SAGE_PATCH_ARGS="--posix"`.
3. Rename `build/bin/sage-apply-patches` with an `.in` suffix and add it to `AC_CONFIG_FILES`
4. Set `patch_args="`@`SAGE_PATCH_ARGS`@`"` in `build/bin/sage-apply-patches.in`.

That way, if `--posix` is supported, we use it. Otherwise, we assume POSIX conformance.



---

archive/issue_comments_430736.json:
```json
{
    "body": "meanwhile I am finding out that we cannot call `patch`\nwith `--posix` option, as it doesn't allow file creation.\nSo the patch in psutil spkg does not apply.",
    "created_at": "2021-06-27T14:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430736",
    "user": "https://github.com/dimpase"
}
```

meanwhile I am finding out that we cannot call `patch`
with `--posix` option, as it doesn't allow file creation.
So the patch in psutil spkg does not apply.



---

archive/issue_comments_430737.json:
```json
{
    "body": "on the other hand I see no harm in just dropping `--no-backup-if-mismatch` as it doesn't buy us anything.",
    "created_at": "2021-06-27T14:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430737",
    "user": "https://github.com/dimpase"
}
```

on the other hand I see no harm in just dropping `--no-backup-if-mismatch` as it doesn't buy us anything.



---

archive/issue_comments_430738.json:
```json
{
    "body": "Replying to [comment:5 dimpase]:\n> meanwhile I am finding out that we cannot call `patch`\n> with `--posix` option, as it doesn't allow file creation.\n> So the patch in psutil spkg does not apply.\n\nWhat's the problem with file creation?\n\nThe `--posix` docs for GNU patch mention that it will become impossible to *remove* files (you can only empty them), but don't say anything about file creation.\n\nIt may be important: if we start to accept any \"patch\", then we have to be prepared for one that follows the POSIX behavior. In other words, if the patches we ship only work with GNU/BSD patch, then we should probably check for one of those and not for any POSIX-compatible patch. (In that case, we can still test for the backup flag with `printf \"\" | patch --no-backup-if-mismatch`)",
    "created_at": "2021-06-27T15:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430738",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:5 dimpase]:
> meanwhile I am finding out that we cannot call `patch`
> with `--posix` option, as it doesn't allow file creation.
> So the patch in psutil spkg does not apply.

What's the problem with file creation?

The `--posix` docs for GNU patch mention that it will become impossible to *remove* files (you can only empty them), but don't say anything about file creation.

It may be important: if we start to accept any "patch", then we have to be prepared for one that follows the POSIX behavior. In other words, if the patches we ship only work with GNU/BSD patch, then we should probably check for one of those and not for any POSIX-compatible patch. (In that case, we can still test for the backup flag with `printf "" | patch --no-backup-if-mismatch`)



---

archive/issue_comments_430739.json:
```json
{
    "body": "Relaxing the spkg-configure.m4 of patch sounds to me like asking for trouble. Recall the insanity that had to be worked around in #30403?",
    "created_at": "2021-06-27T16:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430739",
    "user": "https://github.com/mkoeppe"
}
```

Relaxing the spkg-configure.m4 of patch sounds to me like asking for trouble. Recall the insanity that had to be worked around in #30403?



---

archive/issue_comments_430740.json:
```json
{
    "body": "Replying to [comment:7 mjo]:\n> Replying to [comment:5 dimpase]:\n> > meanwhile I am finding out that we cannot call `patch`\n> > with `--posix` option, as it doesn't allow file creation.\n> > So the patch in psutil spkg does not apply.\n> \n> What's the problem with file creation?\n> \n> The `--posix` docs for GNU patch mention that it will become impossible to *remove* files (you can only empty them), but don't say anything about file creation.\n\nI suppose it's due to the way `patch --posix` determines the filename to patch, and gathers it's `/dev/null`, oops.\n(this is what GNU `patch` does, I didn't look at what's BSD `patch` does.)\n \n> \n> It may be important: if we start to accept any \"patch\", then we have to be prepared for one that follows the POSIX behavior. In other words, if the patches we ship only work with GNU/BSD patch, then we should probably check for one of those and not for any POSIX-compatible patch. (In that case, we can still test for the backup flag with `printf \"\" | patch --no-backup-if-mismatch`)\n\nI agree, some more testing is needed.",
    "created_at": "2021-06-27T16:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430740",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:7 mjo]:
> Replying to [comment:5 dimpase]:
> > meanwhile I am finding out that we cannot call `patch`
> > with `--posix` option, as it doesn't allow file creation.
> > So the patch in psutil spkg does not apply.
> 
> What's the problem with file creation?
> 
> The `--posix` docs for GNU patch mention that it will become impossible to *remove* files (you can only empty them), but don't say anything about file creation.

I suppose it's due to the way `patch --posix` determines the filename to patch, and gathers it's `/dev/null`, oops.
(this is what GNU `patch` does, I didn't look at what's BSD `patch` does.)
 
> 
> It may be important: if we start to accept any "patch", then we have to be prepared for one that follows the POSIX behavior. In other words, if the patches we ship only work with GNU/BSD patch, then we should probably check for one of those and not for any POSIX-compatible patch. (In that case, we can still test for the backup flag with `printf "" | patch --no-backup-if-mismatch`)

I agree, some more testing is needed.



---

archive/issue_comments_430741.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Relaxing the spkg-configure.m4 of patch sounds to me like asking for trouble. Recall the insanity that had to be worked around in #30403? \n\nI don't think it's so hard, it's just an executable after all.\nAnd as a bonus we can just get rid of Sage's patch spkg, after this is done.",
    "created_at": "2021-06-27T18:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430741",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:8 mkoeppe]:
> Relaxing the spkg-configure.m4 of patch sounds to me like asking for trouble. Recall the insanity that had to be worked around in #30403? 

I don't think it's so hard, it's just an executable after all.
And as a bonus we can just get rid of Sage's patch spkg, after this is done.



---

archive/issue_comments_430742.json:
```json
{
    "body": "There are no problems with Sage's patch spkg, please don't create new problems",
    "created_at": "2021-06-27T18:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430742",
    "user": "https://github.com/mkoeppe"
}
```

There are no problems with Sage's patch spkg, please don't create new problems



---

archive/issue_comments_430743.json:
```json
{
    "body": "And until someone is sufficiently invested in a *BSD port to actually set up automatic testing, as discussed several times, let's please not use any BSD platform as motivation for changes like this.",
    "created_at": "2021-06-27T18:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430743",
    "user": "https://github.com/mkoeppe"
}
```

And until someone is sufficiently invested in a *BSD port to actually set up automatic testing, as discussed several times, let's please not use any BSD platform as motivation for changes like this.



---

archive/issue_comments_430744.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> There are no problems with Sage's patch spkg, please don't create new problems\n\nmy primary issue with patch is that it's part of the Sage's toolchain, and as such 1st in line to be kicked out.",
    "created_at": "2021-06-27T20:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430744",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:11 mkoeppe]:
> There are no problems with Sage's patch spkg, please don't create new problems

my primary issue with patch is that it's part of the Sage's toolchain, and as such 1st in line to be kicked out.



---

archive/issue_comments_430745.json:
```json
{
    "body": "comment 11 covers this.",
    "created_at": "2021-06-27T20:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430745",
    "user": "https://github.com/mkoeppe"
}
```

comment 11 covers this.



---

archive/issue_comments_430746.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> comment 11 covers this.\n\nHow? I don't see why we need to keep toolchain components vendored.",
    "created_at": "2021-06-27T20:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430746",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:14 mkoeppe]:
> comment 11 covers this.

How? I don't see why we need to keep toolchain components vendored.



---

archive/issue_comments_430747.json:
```json
{
    "body": "We are not vendoring it. We are providing a fallback installation script for the benefit of users who don't have it on their machines. It is working well: It installs correctly and has not caused other maintenance issues. (That's in contrast to the problematic `gcc` package - which is a fallback that works sometimes but not always; and requires relatively frequent upgrades.) So, let's please not solve nonexisting problems.",
    "created_at": "2021-06-27T20:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430747",
    "user": "https://github.com/mkoeppe"
}
```

We are not vendoring it. We are providing a fallback installation script for the benefit of users who don't have it on their machines. It is working well: It installs correctly and has not caused other maintenance issues. (That's in contrast to the problematic `gcc` package - which is a fallback that works sometimes but not always; and requires relatively frequent upgrades.) So, let's please not solve nonexisting problems.



---

archive/issue_comments_430748.json:
```json
{
    "body": "so far one outcome is that `--no-backup-if-mismatch` may be just dropped (this option is just cosmetic), and in fact native macOS `patch`, which is GNU patch 2.5.8, may be used just as well.\n\nI gather that the fallback is simply not needed, just as it's not needed for `tar` (`tar` used to be a Sage spkg). \n\nWhether BSD patch should be allowed is another question.\n\nOh, and iml spkg has a patch for a non-existing file, something I found out using `--posix` option :-)",
    "created_at": "2021-06-27T21:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30244#issuecomment-430748",
    "user": "https://github.com/dimpase"
}
```

so far one outcome is that `--no-backup-if-mismatch` may be just dropped (this option is just cosmetic), and in fact native macOS `patch`, which is GNU patch 2.5.8, may be used just as well.

I gather that the fallback is simply not needed, just as it's not needed for `tar` (`tar` used to be a Sage spkg). 

Whether BSD patch should be allowed is another question.

Oh, and iml spkg has a patch for a non-existing file, something I found out using `--posix` option :-)



---

archive/issue_events_079152.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79152"
}
```



---

archive/issue_events_079153.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79153"
}
```



---

archive/issue_events_079154.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79154"
}
```



---

archive/issue_events_079155.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79155"
}
```



---

archive/issue_events_079156.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79156"
}
```



---

archive/issue_events_079157.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79157"
}
```



---

archive/issue_events_079158.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79158"
}
```



---

archive/issue_events_079159.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30244",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30244#event-79159"
}
```
