# Issue 21373: Installation manual: Recommend `make -jNUM` instead of `MAKE='make -jNUM' make`

Issue created by migration from https://trac.sagemath.org/ticket/21610

Original creator: mkoeppe

Original creation time: 2016-09-29 06:53:25

CC:  embray jdemeyer vbraun jhpalmieri dimpase mjo

The current recommendation in the installation manual
causes a lot of:

```
warning: -jN forced in submake: disabling jobserver mode.
```



---

Comment by dimpase created at 2016-09-29 07:07:04

I always wondered about the reason for the current recommendation; it would be good to get to the bottom of it.


---

Comment by jdemeyer created at 2016-09-29 07:24:13

The `make -jNUM` command can only work properly if you use `make` for everything. In Sage, we don't use `make` for all Python-related builds, in particular the build of the Sage library and the documentation. For this, we actually look at the environment variable `MAKE`. So this proposal just doesn't work.

I am adjusting the ticket issue.


---

Comment by jdemeyer created at 2016-09-29 07:24:13

Changing component from documentation to build.


---

Comment by jdemeyer created at 2016-09-29 07:29:11

In other words, the `MAKE="make -jNUM` thing is a hack, but it works.


---

Comment by dimpase created at 2016-09-29 07:30:30

Replying to [comment:2 jdemeyer]:
> The `make -jNUM` command can only work properly if you use `make` for everything. In Sage, we don't use `make` for all Python-related builds, in particular the build of the Sage library and the documentation. For this, we actually look at the environment variable `MAKE`. So this proposal just doesn't work.

OK, would this mean that it's just an unfortunate choice of the name for this variable?
So if we renamed it to something it would also fix these warnings, etc?


---

Comment by jdemeyer created at 2016-09-29 07:41:07

Replying to [comment:4 dimpase]:
> OK, would this mean that it's just an unfortunate choice of the name for this variable?
No, because it also serves as `MAKE` variable.

> So if we renamed it to something it would also fix these warnings, etc?
I think that we can fix the warnings without changing the variable name.


---

Comment by jdemeyer created at 2016-09-29 07:58:09

I am currently doing a build from scratch of Sage, I'll check when those warnings appear.


---

Comment by jdemeyer created at 2016-09-29 08:10:35

In all cases where the warning occurs inside a package build, it is because of problems with the upstream package and it has nothing to do with the `MAKE` variable. Sometimes the upstream `Makefile` does not properly support a parallel build and we need to force `-j1`.


---

Comment by dimpase created at 2016-09-29 10:02:16

Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter). Why do we do this highly non-standard way of starting the build, with setting MAKE variable manually?


---

Comment by embray created at 2016-09-29 10:52:10

I've had this same thought before--really we should not be passing down `MAKE=make -jN` to sub-makes.

The problem is that for Sage's build it's being used for cross-purposes.  For packages that use make we want them to be able to take advantage of parallel builds (but jobserver mode is disabled that means the number of jobs started by make can actually well overtake `N`).  But at the same time we want to take advantage of it for Sage to build multiple packages simultaneously.

I experimented with this a bit in the past and found that it could actually speed things up quite a bit, but only in limited cases.  To really make it work properly we need further reworking of the spkg structure so that the builds for packages that use make are actually launched as proper sub-makes.


---

Comment by jdemeyer created at 2016-09-29 14:37:28

Replying to [comment:12 dimpase]:
> Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter).

Because there is no simple way to figure out the value of `-j` from a running instance of `make`.


---

Comment by jdemeyer created at 2016-09-29 14:39:15

Replying to [comment:13 embray]:
> jobserver mode is disabled that means the number of jobs started by make can actually well overtake `N`).

This statement is wrong. In Sage, parallel `make` works for packages using `make`. The problem is the parts of the build which do not use `make`, in particular the build of the Sage library and documentation.


---

Comment by dimpase created at 2016-09-29 15:00:57

Replying to [comment:14 jdemeyer]:
> Replying to [comment:12 dimpase]:
> > Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter).
> 
> Because there is no simple way to figure out the value of `-j` from a running instance of `make`.

How about this:


```
$ cat Makefile 
all: opts

opts:
	@echo $(MAKEFLAGS)
```

Now:

```
$ make -j10
-j10 --jobserver-auth=3,4
```

That is, you can parse top-level MAKEFLAGS and get the value you need.


---

Comment by jdemeyer created at 2016-09-29 15:05:46

What does `make --version` say? I would swear that I have tested this at some point and then it didn't work.


---

Comment by jdemeyer created at 2016-09-29 15:06:37

Well, your trick does _not_ work with

```
GNU Make 4.1
Built for x86_64-pc-linux-gnu
Copyright (C) 1988-2014 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```


The output is `-j --jobserver-fds=3,4`


---

Comment by dimpase created at 2016-09-29 15:12:05

Replying to [comment:19 jdemeyer]:
> Well, your trick does _not_ work with
> {{{
> GNU Make 4.1
> Built for x86_64-pc-linux-gnu
> Copyright (C) 1988-2014 Free Software Foundation, Inc.
> License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
> This is free software: you are free to change and redistribute it.
> There is NO WARRANTY, to the extent permitted by law.
> }}}
> 
> The output is `-j --jobserver-fds=3,4`

mine is 4.2.1. Well, a bug in `make`...
In 3.81 it is `--jobserver-fds=3,4 -j` So they tried to fix it ;-)


---

Comment by jdemeyer created at 2016-09-29 15:14:28

So there is hope that we might be able to implement this in the future...


---

Comment by dimpase created at 2016-09-29 15:17:07

Replying to [comment:21 jdemeyer]:
> So there is hope that we might be able to implement this in the future...
or we can add `make 4.2.1` package and have it now ;-)


---

Comment by jdemeyer created at 2016-09-29 15:21:07

Replying to [comment:22 dimpase]:
> or we can add `make 4.2.1` package and have it now ;-)

Not really because we are talking about the user running the system `make`.

What we _could_ do is try to support both mechanisms: for users running a recent enough version of `make`, we could support `make -j10`.


---

Comment by dimpase created at 2016-09-29 15:29:28

just for the sake of it, added this piece of `make` info as an answer at http://stackoverflow.com/questions/10898528/how-can-i-tell-what-j-option-was-provided-to-make


---

Comment by mkoeppe created at 2020-08-15 13:41:27

See #30369 for another approach -- actually using the jobserver protocol.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.
