# Issue 32177: Move is_... functions to separate modules to enable modularization

archive/issues_032177.json:
```json
{
    "body": "CC:  tscrim chapoton @kliem\n\n`git grep 'import.* is_[A-Z]'` reveals a common pattern in our code: We import a module just to check whether a user-provided object belongs to a class defined by that module.\n\nThis pattern is an obstacle to modularization. (The recent trend to replace this pattern by importing the class and `isinstance` does not help in this regard.)\n\nWe propose to move `is_...` methods into separate Python/Cython modules that can be imported even if the underlying implementation is not present.  For example, if `sagemath-symbolics` is not present, then `is_Expression` should just return `False` for every input.\n\nPossible implementation strategies:\n- Introduce stub classes, make the actual implementation classes subclasses. For example, define class `Expression_base`; make `Expression` a subclass; `is_Expression(x)` tests `isinstance(x, Expression_base`\n- `try: import ... except ImportError: return False`\n\nIssue created by migration from https://trac.sagemath.org/ticket/32414\n\n",
    "created_at": "2021-08-24T18:41:40Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Move is_... functions to separate modules to enable modularization",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32177",
    "user": "mkoeppe"
}
```
CC:  tscrim chapoton @kliem

`git grep 'import.* is_[A-Z]'` reveals a common pattern in our code: We import a module just to check whether a user-provided object belongs to a class defined by that module.

This pattern is an obstacle to modularization. (The recent trend to replace this pattern by importing the class and `isinstance` does not help in this regard.)

We propose to move `is_...` methods into separate Python/Cython modules that can be imported even if the underlying implementation is not present.  For example, if `sagemath-symbolics` is not present, then `is_Expression` should just return `False` for every input.

Possible implementation strategies:
- Introduce stub classes, make the actual implementation classes subclasses. For example, define class `Expression_base`; make `Expression` a subclass; `is_Expression(x)` tests `isinstance(x, Expression_base`
- `try: import ... except ImportError: return False`

Issue created by migration from https://trac.sagemath.org/ticket/32414





---

archive/issue_comments_459567.json:
```json
{
    "body": "I find this in general bothering that there are tons of modules etc. being imported (even at startup), just because some `isinstance` check.\n\n- The best I can come up with for the second is the following:\n\n```\n_Polyhedron_base = None\n\nclass _dummy:\n    pass\n\ndef is_polyhedron(P):\n    global _Polyhedron_base\n    if _Polyhedron_base is not None:\n        return isinstance(P, _Polyhedron_base)\n    try:\n        from sage.geometry.polyhedron.base import Polyhedron_base\n        _Polyhedron_base = Polyhedron_base\n        return isinstance(P, Polyhedron_base)\n    except ImportError:\n        _Polyhedron_base = _dummy\n        return False\n```\n\n\n  Apparently its a slow down of about 50 percent, when the import is found, otherwise much more.\n\n- The first thing is even faster (`isinstance(P, Polyhedron_containment_check)` is about 75 percent of `isinstance(P, Polyhedron_base)`), but I don't know how much another stupid inheritance slows down the actual class.\n\n  I would prefer a unique name scheme that can be used throughout sage. `_base` is already in use. Could as well be the original class name with a leading underscore to discourage people to use it for anything else, e.g. `_Polyhedron_base`, `_Expression`.",
    "created_at": "2021-08-24T21:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459567",
    "user": "@kliem"
}
```

I find this in general bothering that there are tons of modules etc. being imported (even at startup), just because some `isinstance` check.

- The best I can come up with for the second is the following:

```
_Polyhedron_base = None

class _dummy:
    pass

def is_polyhedron(P):
    global _Polyhedron_base
    if _Polyhedron_base is not None:
        return isinstance(P, _Polyhedron_base)
    try:
        from sage.geometry.polyhedron.base import Polyhedron_base
        _Polyhedron_base = Polyhedron_base
        return isinstance(P, Polyhedron_base)
    except ImportError:
        _Polyhedron_base = _dummy
        return False
```


  Apparently its a slow down of about 50 percent, when the import is found, otherwise much more.

- The first thing is even faster (`isinstance(P, Polyhedron_containment_check)` is about 75 percent of `isinstance(P, Polyhedron_base)`), but I don't know how much another stupid inheritance slows down the actual class.

  I would prefer a unique name scheme that can be used throughout sage. `_base` is already in use. Could as well be the original class name with a leading underscore to discourage people to use it for anything else, e.g. `_Polyhedron_base`, `_Expression`.



---

archive/issue_comments_459568.json:
```json
{
    "body": "Thanks for these thoughts and experiments. I also prefer the approach using new base classes; and also I have learned more about the multiyear effort to get rid of `is_...` methods. I have updated the ticket description accordingly",
    "created_at": "2021-08-24T23:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459568",
    "user": "mkoeppe"
}
```

Thanks for these thoughts and experiments. I also prefer the approach using new base classes; and also I have learned more about the multiyear effort to get rid of `is_...` methods. I have updated the ticket description accordingly



---

archive/issue_comments_459569.json:
```json
{
    "body": "Here's an attempt for `Polyhedron`. Still need to do some trick to make the constructor's docstring available\n----\nNew commits:",
    "created_at": "2021-08-25T01:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459569",
    "user": "mkoeppe"
}
```

Here's an attempt for `Polyhedron`. Still need to do some trick to make the constructor's docstring available
----
New commits:



---

archive/issue_comments_459570.json:
```json
{
    "body": "For getting the docstring I have tried to make `__doc__` a property, but this approach does not seem to work for Cython classes...",
    "created_at": "2021-08-29T01:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459570",
    "user": "mkoeppe"
}
```

For getting the docstring I have tried to make `__doc__` a property, but this approach does not seem to work for Cython classes...



---

archive/issue_comments_459571.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-29T01:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459571",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459572.json:
```json
{
    "body": "I think I'll need some help from Cython experts here...",
    "created_at": "2021-09-03T19:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459572",
    "user": "mkoeppe"
}
```

I think I'll need some help from Cython experts here...



---

archive/issue_comments_459573.json:
```json
{
    "body": "I think you're running into the fact that the Python special double underscore methods are handled in a special way. I don't know too much about how that's done, but that that is my recollection.",
    "created_at": "2021-09-03T21:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459573",
    "user": "tscrim"
}
```

I think you're running into the fact that the Python special double underscore methods are handled in a special way. I don't know too much about how that's done, but that that is my recollection.



---

archive/issue_comments_459574.json:
```json
{
    "body": "A different approach would be to keep the base class / constructor in `sage.geometry.polyhedron.constructor` (similar to the branch of #26366) and to assign this module to the distribution `sagemath-categories`.",
    "created_at": "2021-09-08T03:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459574",
    "user": "mkoeppe"
}
```

A different approach would be to keep the base class / constructor in `sage.geometry.polyhedron.constructor` (similar to the branch of #26366) and to assign this module to the distribution `sagemath-categories`.



---

archive/issue_comments_459575.json:
```json
{
    "body": "Revised the description - no longer attempt for the abc and the constructor to be the same object. This removes all of the technical difficulties discussed above.",
    "created_at": "2021-09-26T17:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32177",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32177#issuecomment-459575",
    "user": "mkoeppe"
}
```

Revised the description - no longer attempt for the abc and the constructor to be the same object. This removes all of the technical difficulties discussed above.
