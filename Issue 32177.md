# Issue 32177: Move is_... functions to separate modules to enable modularization

Issue created by migration from https://trac.sagemath.org/ticket/32414

Original creator: mkoeppe

Original creation time: 2021-08-24 18:41:40

CC:  tscrim chapoton @kliem

`git grep 'import.* is_[A-Z]'` reveals a common pattern in our code: We import a module just to check whether a user-provided object belongs to a class defined by that module.

This pattern is an obstacle to modularization. (The recent trend to replace this pattern by importing the class and `isinstance` does not help in this regard.)

We propose to move `is_...` methods into separate Python/Cython modules that can be imported even if the underlying implementation is not present.  For example, if `sagemath-symbolics` is not present, then `is_Expression` should just return `False` for every input.

Possible implementation strategies:
- Introduce stub classes, make the actual implementation classes subclasses. For example, define class `Expression_base`; make `Expression` a subclass; `is_Expression(x)` tests `isinstance(x, Expression_base`
- `try: import ... except ImportError: return False`


---

Comment by @kliem created at 2021-08-24 21:13:44

I find this in general bothering that there are tons of modules etc. being imported (even at startup), just because some `isinstance` check.

- The best I can come up with for the second is the following:

```
_Polyhedron_base = None

class _dummy:
    pass

def is_polyhedron(P):
    global _Polyhedron_base
    if _Polyhedron_base is not None:
        return isinstance(P, _Polyhedron_base)
    try:
        from sage.geometry.polyhedron.base import Polyhedron_base
        _Polyhedron_base = Polyhedron_base
        return isinstance(P, Polyhedron_base)
    except ImportError:
        _Polyhedron_base = _dummy
        return False
```


  Apparently its a slow down of about 50 percent, when the import is found, otherwise much more.

- The first thing is even faster (`isinstance(P, Polyhedron_containment_check)` is about 75 percent of `isinstance(P, Polyhedron_base)`), but I don't know how much another stupid inheritance slows down the actual class.

  I would prefer a unique name scheme that can be used throughout sage. `_base` is already in use. Could as well be the original class name with a leading underscore to discourage people to use it for anything else, e.g. `_Polyhedron_base`, `_Expression`.


---

Comment by mkoeppe created at 2021-08-24 23:06:29

Thanks for these thoughts and experiments. I also prefer the approach using new base classes; and also I have learned more about the multiyear effort to get rid of `is_...` methods. I have updated the ticket description accordingly


---

Comment by mkoeppe created at 2021-08-25 01:18:59

Here's an attempt for `Polyhedron`. Still need to do some trick to make the constructor's docstring available
----
New commits:


---

Comment by mkoeppe created at 2021-08-29 01:04:20

For getting the docstring I have tried to make `__doc__` a property, but this approach does not seem to work for Cython classes...


---

Comment by git created at 2021-08-29 01:04:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-03 19:20:09

I think I'll need some help from Cython experts here...


---

Comment by tscrim created at 2021-09-03 21:06:06

I think you're running into the fact that the Python special double underscore methods are handled in a special way. I don't know too much about how that's done, but that that is my recollection.


---

Comment by mkoeppe created at 2021-09-08 03:00:44

A different approach would be to keep the base class / constructor in `sage.geometry.polyhedron.constructor` (similar to the branch of #26366) and to assign this module to the distribution `sagemath-categories`.


---

Comment by mkoeppe created at 2021-09-26 17:13:04

Revised the description - no longer attempt for the abc and the constructor to be the same object. This removes all of the technical difficulties discussed above.
