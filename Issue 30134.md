# Issue 30134: In-place installs with "./sage -pip install --editable src/"

Issue created by migration from https://trac.sagemath.org/ticket/30371

Original creator: mkoeppe

Original creation time: 2020-08-15 14:24:53

CC:  @tobiasdiez fbissey jhpalmieri isuruf

After removing the sagelib installation (e.g. using `make sagelib-clean`), one can try to do an editable install (aka `setup.py develop`) to make development more convenient.

This currently fails as follows:

```
./sage -pip install --editable src/
Obtaining file:///Users/mkoeppe/s/sage/sage-rebasing/src
Installing collected packages: sage
  Running setup.py develop for sage
    ERROR: Command errored out with exit status 1:
     command: /Users/mkoeppe/s/sage/sage-rebasing/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/Users/mkoeppe/s/sage/sage-rebasing/src/setup.py'"'"'; __file__='"'"'/Users/mkoeppe/s/sage/sage-rebasing/src/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' develop --no-deps
         cwd: /Users/mkoeppe/s/sage/sage-rebasing/src/
    Complete output (426 lines):
    Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
    distributions = ['', 'sage-bliss']
    Discovering Python/Cython source code....
    Discovered Python/Cython sources, time: 0.52 seconds.
    running develop
    running egg_info
    writing sage.egg-info/PKG-INFO
    writing dependency_links to sage.egg-info/dependency_links.txt
    writing top-level names to sage.egg-info/top_level.txt
    writing manifest file 'sage.egg-info/SOURCES.txt'
    running build_ext
    running build_cython
    Enabling Cython debugging support
    Updating Cython code....
    Compiling sage/misc/parser.pyx because it depends on ./sage/cpython/string.pxd.
    Compiling sage/misc/sage_ostools.pyx because it changed.
    Compiling sage/misc/derivative.pyx because it depends on ./sage/rings/integer.pxd.
    Compiling sage/misc/lazy_attribute.pyx because it changed.
...
    Compiling sage/interfaces/process.pyx because it changed.
    Compiling sage/interfaces/sagespawn.pyx because it changed.
    Compiling sage/monoids/free_abelian_monoid_element.pyx because it depends on ./sage/rings/integer.pxd.
    /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/setuptools/dist.py:454: UserWarning: Normalizing '9.2.beta8' to '9.2b8'
      warnings.warn(tmpl.format(**locals()))
    ************************************************************************
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/Users/mkoeppe/s/sage/sage-rebasing/src/setup.py", line 175, in <module>
        ext_modules = cython_modules)
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/core.py", line 148, in setup
        dist.run_commands()
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/dist.py", line 966, in run_commands
        self.run_command(cmd)
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/dist.py", line 985, in run_command
        cmd_obj.run()
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/setuptools/command/develop.py", line 38, in run
        self.install_for_development()
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/setuptools/command/develop.py", line 140, in install_for_development
        self.run_command('build_ext')
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/cmd.py", line 313, in run_command
        self.distribution.run_command(command)
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/dist.py", line 985, in run_command
        cmd_obj.run()
      File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage_setup/command/sage_build_ext.py", line 16, in run
        self.run_command('build_cython')
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/cmd.py", line 313, in run_command
        self.distribution.run_command(command)
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/dist.py", line 985, in run_command
        cmd_obj.run()
      File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage_setup/command/sage_build_cython.py", line 248, in run
        cache=False,
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/Cython/Build/Dependencies.py", line 1093, in cythonize
        result.get(99999)  # seconds
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/pool.py", line 657, in get
        raise self._value
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/pool.py", line 431, in _handle_tasks
        put(task)
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/connection.py", line 206, in send
        self._send_bytes(_ForkingPickler.dumps(obj))
      File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/multiprocessing/reduction.py", line 51, in dumps
        cls(buf, protocol).dump(obj)
    _pickle.PicklingError: Can't pickle <class 'pkg_resources.extern.packaging._structures.Infinity'>: it's not the same object as pkg_resources.extern.packaging._structures.Infinity
    ************************************************************************
    Error building the Sage library
    ************************************************************************
    ----------------------------------------
ERROR: Command errored out with exit status 1: /Users/mkoeppe/s/sage/sage-rebasing/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/Users/mkoeppe/s/sage/sage-rebasing/src/setup.py'"'"'; __file__='"'"'/Users/mkoeppe/s/sage/sage-rebasing/src/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' develop --no-deps Check the logs for full command output.
```




Previous tickets on in-place builds, editable installs:
 - #12659
 - #21535


---

Comment by @tobiasdiez created at 2020-08-17 22:52:49

I've worked a bit on it. The current commit is a semi-working prototype, in the sense that all cython files are successfully compiled to C files if invoked via `python src/setup.py build_ext --inplace`. The second compilation of the c files does not yet work.

I had problems that none of the source cython files were correctly found on my system (wsl) and that a few dependencies in the current build files were not met (`'linbox', 'Singular', 'm4ri', 'zlib', 'cblas'`). For this reason, I started from scratch and only included what was needed so far. Any pointers to how to install these dependencies (I think they are needed for the second compilation).
----
New commits:


---

Comment by mkoeppe created at 2020-08-18 00:15:33

I don't really have time to look into this before the 9.2 release. But if you are looking for where include directories are determined, take a look at `sage_setup.command.sage_build_cython`


---

Comment by git created at 2020-08-19 16:33:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-19 16:46:59

The command `./sage src/setup.py build_ext --inplace` runs now fine for me. I had to change quite a few things to make it work, and found it easier to completely start over using `cythonize` instead of using the existing `build_cython` code. The resulting code is a minimal working version. Please let me know which features of the existing `build_cython` file you would like to keep (to be honest, I don't really understand what some of the code there is doing, and why its needed).

The code definitely needs cleanup, but otherwise is ready for a first round of review.


---

Comment by @tobiasdiez created at 2020-08-19 16:47:20

Changing status from new to needs_review.


---

Comment by git created at 2020-08-19 16:49:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-19 17:57:57


```
--- a/.gitignore
+++ b/.gitignore
@@ -99,7 +99,18 @@ gitlab-build-docker.log
 /src/build
 /src/Makefile
 /src/bin/sage-env-config
-/build/bin/sage-build-env-config
+/build
```

this is not good. Our `/build/` contains important files of the sage distribution


---

Comment by mkoeppe created at 2020-08-19 17:59:30

And the changes removing old python2 code really need to go on a separate ticket


---

Comment by git created at 2020-08-19 19:47:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-19 19:51:39

Ok, I was under the assumption that the build folder is for build artifacts. If this would be the case, then I suppose it would be better to whitelist those files in the build folder that needs to be checked-in. I've now replaced the global build ignore, by a more fine-grained statement which only ignores the "temporary" files.

Concerning the changes about old Python2 code, I've created #30397.


---

Comment by mkoeppe created at 2020-08-20 00:20:13

Replying to [comment:10 gh-tobiasdiez]:
> I was under the assumption that the build folder is for build artifacts.

No, not at all.


---

Comment by mkoeppe created at 2020-08-20 00:23:07

The changes I see in setup.py don't seem to fit so well into the plan I have regarding modularization of sagelib. See #29705 and #28925 (which needs help).


---

Comment by @tobiasdiez created at 2020-08-20 06:57:54

I wasn't aware of your changes in #28925. I guess what I'm proposing is a different strategy for the source discovery. The approach in #28925 is to change the source files themselves and enrich them by some form of metadata that decides in which distribution / package they land. Here I was proposing to specify the distribution of the files in the setup.py file. I guess both strategies have pros and cons. The main reason for me was that it seems the responsibility of the setup.py file to construct the distribution; why should the source file need to care about where they are used/included? I.e classical example of separation of concerns. I think, it's also the more flexible approach since it's easy to include a source file into multiple distributions etc. Moreover, you also gain a bit of performance at build time since you don't need to parse the files for some magic comments. What do you think?


---

Comment by mkoeppe created at 2020-08-20 13:28:53

Replying to [comment:13 gh-tobiasdiez]:
> [...] Here I was proposing to specify the distribution of the files in the setup.py file. I guess both strategies have pros and cons. The main reason for me was that it seems the responsibility of the setup.py file to construct the distribution; why should the source file need to care about where they are used/included? I.e classical example of separation of concerns. [...]

One more thing to be aware of is that (1) `setup.py` by itself actually is not able to control what goes into the source distribution. In #29865 (where I prepare some experimental subset distributions), I additionally use `MANIFEST.in` to control that.

Separation of concerns is, of course, desirable. But so is locality: (2) My plan for splitting up the distribution is driven to a large extent by the dependencies on different sets of C/C++ libraries. And these are already encoded in Cython distutils directives.

Also I have explored a little bit the packaging options beyond using setuptools (in part motivated because of the shortcoming (1)). See #29854 (flit), #29810 (poetry). Unfortunately currently there does not seem to be a proper mainstream solution for the source layout that we want to keep (a monolithic source tree in `src/sage`). For example, `flit` (and even `pip` out-of-directory installs) do not handle symbolic links well. In the long term, I was hoping to transform `sage_setup` to implement the PEP 517 API directly (see #29845). That's another reason why I would be reluctant to hard-code distribution information in `setup.py`.

In any case, I am hoping to have a broader discussion about all of this on sage-devel at the beginning of the 9.3 cycle.


---

Comment by @tobiasdiez created at 2020-08-20 22:17:30

> Separation of concerns is, of course, desirable. But so is locality: (2) My plan for splitting up the distribution is driven to a large extent by the dependencies on different sets of C/C++ libraries. And these are already encoded in Cython distutils directives.


One could also take this as an argument to remove the distutil dependency directives and put them into the setup.py, giving you locality and separation of concerns. 

Anyway, my goal with this PR is not to redesign or modularize the build. I just wanted to have a working inplace build. For this moving the distribution declaration to setup.py was the easiest option, and I quite liked  this also from a conceptual point of view. But if the current way is preferred, I change it back of course.
Anything else that needs to be changed?


---

Comment by mkoeppe created at 2020-08-20 22:22:57

Replying to [comment:15 gh-tobiasdiez]:
> One could also take this as an argument to remove the distutil dependency directives and put them into the setup.py, giving you locality and separation of concerns. 

Ha, no, we just moved them there. Getting rid of the messy file `modules_list.py` was an achievement in the present cycle. See #29706


---

Comment by mkoeppe created at 2020-08-20 22:34:13

Replying to [comment:15 gh-tobiasdiez]:
> Anything else that needs to be changed?

I haven't really had a chance to look at it in more detail yet, sorry. Soon...


---

Comment by git created at 2020-08-23 18:37:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-23 20:32:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 19:43:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 21:39:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 21:39:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-24 21:46:10

I've now changed the code to use the `% sage_setup: distribution = xyz` way. Moreover, I've cleanup up the code a bit.

Before I continue removing the code that is no longer needed, I would like to ask you which features of the current cythonize build script are missing from my new minimalistic implementation and should be reimplemented. (As I've said above, I don't really understand some of the code in `build_cython`.


---

Comment by mkoeppe created at 2020-09-08 04:48:49

These changes: 

```
-# distutils: sources = sage/libs/ppl_shim.cc
+# distutils: sources = src/sage/libs/ppl_shim.cc
```

are not good. The root of the sagelib source tree is `src`, and paths are relative to this - this is where `setup.py` lives, after all.

As a way forward, I would suggest to actually work on #29864 instead of the present ticket. #29864 is a step in the modularization task (#29705), creating two new distributions - `sage-core` and `sage-tdlib`. `sage-core` is like `sagelib` minus `sage-tdlib` and without the fancy incremental installation tricks.


---

Comment by mkoeppe created at 2020-09-08 04:49:08

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-09-08 08:54:37

Thanks for the feedback. I'll try to find a way to specify the paths relative to `src`. I think my problem there was that `setup.py` is invoked from the central `sage` script, which sits in the root and not in the src folder.

Can you please explain the connection to #29864 in detail? For my the main point of this ticket is that I can compile the cython files to obtain compiled `so` files in the same folder as the original cython file (e.g. `src/sage/rings`). This is needed so that VS code can pick up these dependencies, resolve the imports, provide intellisense for it etc. My longterm goal would be to have a normal python installation (central or virtual env), point VS towards this runtime, and be able to use the sage code (in /src) without the need to use `make` at any point. How are #29864 and #29705 helping for this?


---

Comment by mkoeppe created at 2020-09-08 20:01:26

Replying to [comment:27 gh-tobiasdiez]:
> Can you please explain the connection to #29864 in detail? 

Package `sage-core` created in #29864 will be a version of sagelib with a plain setuptools build system, intended for (modular) deployment of the Sage library on PyPI.  Since setuptools supports `setup.py develop`, this has synergy with your goal. 

And we will be able to work on the build system of `sage-core`, across several tickets, without having to worry about breaking `sagelib` builds - or what current users/developers are expecting of it.


---

Comment by @tobiasdiez created at 2020-09-09 07:27:23

That make sense, thanks for the explanation.

The only thing that I still don't understand is how the modularization will help with the compilation of cython files. If if everything is modularized, I guess the setup.py will still be used for this. And the point of this ticket is to improve the cyhonization...


---

Comment by mkoeppe created at 2020-09-09 15:48:43

Replying to [comment:29 gh-tobiasdiez]:
> The only thing that I still don't understand is how the modularization will help with the compilation of cython files. If if everything is modularized, I guess the setup.py will still be used for this.

Simply by having a separate `setup.py` in `build/pkgs/sage-core/src`.


---

Comment by mkoeppe created at 2020-09-14 20:06:02

Slight change of plans, forget about `sage-core`.


---

Comment by git created at 2020-09-14 20:35:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-09-14 20:40:29

TODO:
 - The changes to `src/sage/cpython/debugimpl.c` need to go on a separate ticket
 - The changes to `src/sage/misc/persist.pyx` need to go on a separate ticket
 - Don't change `find_python_sources` because `build/pkgs/sagelib/src/setup.py` continues to use it


---

Comment by git created at 2020-09-14 23:04:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-09-17 19:21:23

Replying to [comment:34 mkoeppe]:
> TODO:
>  - The changes to `src/sage/cpython/debugimpl.c` need to go on a separate ticket

This is now #30590


---

Comment by git created at 2020-09-25 21:52:52

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-09-25 21:54:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-09-25 22:54:49

I have now added a minimal pipfile including sage as an editable install. So running `pipenv install` results in a semi-workable virtual environment. "Semi" because not all pyx files could be compiled successfully since  they rely on external dependencies (e.g. singular, giac, ecl, ratpoints, ...).

For now, I've excluded the relevant pyx files from the compilation. Any ideas how to handle these dependencies are welcome! One approach would be to treat them similar to the the optional packages by putting a "sage_setup distribution" tag to the pyx file.

I also tried to run `pipenv install` directly under Windows, but that's not possible at the moment as some of the dependencies cannot be installed on Windows currently:
https://github.com/sagemath/cypari2/issues/19
https://github.com/sagemath/cysignals/pull/104


---

Comment by git created at 2020-09-25 22:54:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-26 00:32:00

Replying to [comment:44 gh-tobiasdiez]:
> [...] not all pyx files could be compiled successfully since  they rely on external dependencies (e.g. singular, giac, ecl, ratpoints, ...).
> One approach would be to treat them similar to the the optional packages by putting a "sage_setup distribution" tag to the pyx file.

Yes, exactly this approach is part of the "modularization" that I have in mind. See #29705 under the items titled "Deploy mildly modularized distributions", "Further modularization" for a sketch of such distributions. Basically, one distribution for each major C/C++ library (such as `sage-ntl`) - but some libraries come in packs that would not make much sense to separate (such as `sage-flint-arb-e_antic`).


---

Comment by mkoeppe created at 2020-09-26 00:36:37

Replying to [comment:44 gh-tobiasdiez]:
> I also tried to run `pipenv install` directly under Windows, but that's not possible at the moment as some of the dependencies cannot be installed on Windows currently:
> https://github.com/sagemath/cypari2/issues/19
> https://github.com/sagemath/cysignals/pull/104

Right, I hope that when modularization is done, a native Windows port of a tiny Sage subset would be an actionable project.


---

Comment by mkoeppe created at 2020-09-26 00:49:34

As in #30578 (where I am trying the same with `requirements.txt` and plain `venv`), I would like to get the following to work: 

1. Build the sage distribution (actually all prerequisites of sagelib, using `make sagelib-build-deps`)

2. Then within `sage -sh` (where all the libraries installed in `$SAGE_LOCAL` are available) do the in-place install into a new venv created by `pipenv` - using the wheels built in `$SAGE_LOCAL/var/lib/sage/wheels`.


---

Comment by @tobiasdiez created at 2020-09-26 10:27:09

Thanks for the quick feedback.

I agree the modularization is a good way to approach these problems. Sadly, I feel like this requires too much in-depth knowledge of sage for me to contribute directly. But after skimming the tickets, I suggest you have a look at my changes here to the way distributions are excluded. This seems to be somewhat opposite to say #29864 where this is handled by adding a new setup-tdlib/setup.py. For the in-place installation it is important that the src/setup.py results in a working installation.

What do you suggest as the way forward to align this ticket with the modularization effort?

As for #30578, my motivation here is a bit different: I wanted to have a prototype for sagelib with pipenv that works without ever invoking `sage/make` and directly uses the versions of the dependencies found on pypi instead of (re)building them locally. This seems to work in principle, and might lead to a workable solution for most purposes of development and ci testing, where the advantages of building the dependencies (like optimization) are not that important. That being said, I'm not sure if we really need to have a requirements.txt and a pipfile. I would opt for the more modern version and only keep the pipfile.

After installing singular via `apt-get install libsingular4-dev libpynac-dev`, a few more pyx files could be compiled. Should I add this in build\pkgs\singular\distros\debian ?

One more thing: Currently sage/rings/number_field/number_field_element_quadratic.pyx relies on the arb lib, but is also (indirectly) imported in sage.all. What's the best way to handle these imports that depend on external C/C++ libs? For now I've uncommented some of these all-imports.


---

Comment by git created at 2020-09-26 10:27:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-09-26 11:35:58

Yet another question: when/how is src/sage/ext/interpreters generated?


---

Comment by git created at 2020-09-26 12:16:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-26 14:03:16

Replying to [comment:49 gh-tobiasdiez]:
> As for #30578, my motivation here is a bit different: I wanted to have a prototype for sagelib with pipenv that works without ever invoking `sage/make` and directly uses the versions of the dependencies found on pypi instead of (re)building them locally.

Yes, I agree with this goal. But I would strongly suggest to focus on a smaller scope for this ticket: Make the in-place install work when all the dependencies are available. 
At the same time, make sure that the normal Sage build process does not get broken (e.g. take care of comment 34 "Don't change find_python_sources because build/pkgs/sagelib/src/setup.py continues to use it"). This ensures that the ticket can be merged in Sage, thus, a way forward. This is better than preparing one ticket with huge changes.


---

Comment by mkoeppe created at 2020-09-26 14:05:48

Replying to [comment:49 gh-tobiasdiez]:
> I suggest you have a look at my changes here to the way distributions are excluded. This seems to be somewhat opposite to say #29864 where this is handled by adding a new setup-tdlib/setup.py.

As discussed, adding these `sage_setup: distribution` tags to Cython source files is a way forward that aligns with the modularization effort.


---

Comment by mkoeppe created at 2020-09-26 14:13:32

Replying to [comment:49 gh-tobiasdiez]:
> Currently sage/rings/number_field/number_field_element_quadratic.pyx relies on the arb lib, but is also (indirectly) imported in sage.all. What's the best way to handle these imports that depend on external C/C++ libs?

Try lazy imports with `PythonModule` features, from #30616/#30647.


---

Comment by mkoeppe created at 2020-09-26 14:20:06

Replying to [comment:49 gh-tobiasdiez]:
> I suggest you have a look at my changes here to the way distributions are excluded. 

Well, it's the same as before in sagelib's setup.py, filtering by distributions, plus some hardcoded ones. Except that you have changed the interface of the function that does the filtering (see above - this change is not mergeable because `build/pkgs/sagelib/src/setup.py` needs to keep working!)


---

Comment by mkoeppe created at 2020-09-26 14:31:46

Replying to [comment:54 mkoeppe]:
> As discussed, adding these `sage_setup: distribution` tags to Cython source files is a way forward that aligns with the modularization effort.

I've opened #30666 for this. (The new distribution names have to be added to `setup.py`, of course, so that the files continue to be built in the Sage distribution.)


---

Comment by mkoeppe created at 2020-09-26 17:43:40

Replying to [comment:55 mkoeppe]:
> Replying to [comment:49 gh-tobiasdiez]:
> > Currently sage/rings/number_field/number_field_element_quadratic.pyx relies on the arb lib, but is also (indirectly) imported in sage.all. What's the best way to handle these imports that depend on external C/C++ libs?
> 
> Try lazy imports with `PythonModule` features, from #30616/#30647.

For another approach regarding the ".all" imports, see #29865. Probably we will need a combination of this and lazy imports.


---

Comment by git created at 2020-09-26 18:58:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-09-26 19:04:25

I've now restored the old find_python_sources method. Is there something else that needs to be done, except waiting for the other tickets to be finished?


---

Comment by mkoeppe created at 2020-09-26 20:56:24

Nothing immediate. This is going in a good direction


---

Comment by git created at 2020-09-27 09:18:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-27 16:32:23

Replying to [comment:64 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[849350c](https://git.sagemath.org/sage.git/commit/?id=849350c4edd2590f0ad5cbc13a919abea7a86538)||`Fix missing ccobject`||

Created #30672 (Remove `sage/ext` from `sage_include_directories`) for this


---

Comment by git created at 2020-09-28 18:56:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-09-28 18:57:33

New commits:


---

Comment by git created at 2020-10-01 15:32:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-01 15:47:10

This ticket is way too big. I really strong recommend to get a working in-place installation of sagelib in the situation when its dependencies have been built using the Sage distribution.


---

Comment by @tobiasdiez created at 2020-10-01 15:55:55

I've now followed your advice, and tried to have a prototype that works if all library dependencies are fulfilled (instead of adding exceptions / distribution annotations everywhere). And I was successful indeed, `import sage.all` works without error and I can do basic calculations with the manifold package. This required tinkering with a lot of system-installed packages (instructions added in the ticket).

The following is not yet working, and I would like to get input on how to resolve this:
- `sage/ext/interpreters` is empty. Where is the code generated? Can this easily be extracted to a script that can be invoked separately?
- The code relying on the arb library still doesn't compile although I've `libflint-arb-dev` installed. The compilation fails with `ld larb` was not found. Why is this, and what's the best way to solve it?
- The `sage.doctest` package conflicted with the `sympy` (I believe), i.e. sympy tried to load classes from `sage.doctest` for some reason, and couldn't locate them. I've fixed this by renaming `src/sage/doctest` to `sage-doctest`. Is the `doctest` package really required under the `sage` folder, or could it be e.g moved up to `src/doctest`?


I agree the ticket is too big at the moment. Once I found a solution to the above points, I'll clean the code. I sadly cannot work with the dependencies created by the sage distribution, as the build process fails due to compilation errors in the pip library...


---

Comment by git created at 2020-10-01 15:59:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-01 16:05:14

Replying to [comment:75 gh-tobiasdiez]:
> I've now followed your advice, and tried to have a prototype that works if all library dependencies are fulfilled (instead of adding exceptions / distribution annotations everywhere). And I was successful indeed, `import sage.all` works without error and I can do basic calculations with the manifold package. This required tinkering with a lot of system-installed packages (instructions added in the ticket).

Great.

> The following is not yet working, and I would like to get input on how to resolve this:
> - `sage/ext/interpreters` is empty. Where is the code generated? Can this easily be extracted to a script that can be invoked separately?

`sage_setup.command.sage_build`

> - The code relying on the arb library still doesn't compile although I've `libflint-arb-dev` installed. The compilation fails with `ld larb` was not found. Why is this, and what's the best way to solve it?

Use `sage.env.cython_aliases`. In particular `ARB_LIBRARY` gives you the name. (The Debian installation uses a different name from upstream.)

> - The `sage.doctest` package conflicted with the `sympy` (I believe), i.e. sympy tried to load classes from `sage.doctest` for some reason, and couldn't locate them. I've fixed this by renaming `src/sage/doctest` to `sage-doctest`. Is the `doctest` package really required under the `sage` folder, or could it be e.g moved up to `src/doctest`?

Sounds like a bad PYTHONPATH. `src/sage` should not be in it.

> I agree the ticket is too big at the moment. Once I found a solution to the above points, I'll clean the code. I sadly cannot work with the dependencies created by the sage distribution, as the build process fails due to compilation errors in the pip library...

Hm, that's still happening? Sorry I lost track of this since various other things seemed to break on WSL. Have you tried with downgrading/upgrading the pip package?


---

Comment by git created at 2020-10-01 16:06:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-01 16:07:17

By the way, for dev purposes until the WSL issues are resolved, you could try running Sage in Docker instead (bind-mount the source tree into it)


---

Comment by @tobiasdiez created at 2020-10-01 16:08:57

New commits:
----
New commits:


---

Comment by git created at 2020-10-01 16:17:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-01 16:46:26

> > - Fix installation of `ecl`:
>   After `apt-get install ecl` ecl is broken under WSL. To fix this, first run `apt-get install libtool autoconf`, then follow https://github.com/rdp/ffmpeg-windows-build-helpers/issues/452#issuecomment-638639182.

Could you try the related #30629 on WSL please?


---

Comment by git created at 2020-10-02 13:16:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-02 13:32:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-02 13:46:11

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-10-02 13:51:57

Perfect, thanks a lot Matthias! I got now a working installation of all libraries, and could import `sage.all` without the need to uncomment any imports. Yeaaaah!

I've also cleaned the code and extended the ticket description, so this ticket is now ready for review.


---

Comment by mkoeppe created at 2020-10-02 17:54:51

Could you put the changes to `sage_setup/autogen/interpreters/` on a separate ticket please?


---

Comment by mkoeppe created at 2020-10-02 18:04:35

The changes regarding imports (mostly around `sage.rings`) should also be on a separate ticket.


---

Comment by mkoeppe created at 2020-10-02 18:06:16

Also for the changes to `src/sage/libs/eclsig.h` -- which will certainly need discussion


---

Comment by mkoeppe created at 2020-10-02 18:17:34


```
+compile_time_env = dict(
+    PY_PLATFORM=sys.platform
+)
+cython_directives = dict(
+    language_level="3str",
+    cdivision=True,
+)
```


This duplicates settings defined in `sage_setup.command.sage_build_cython`. 
Could you refactor this so that these directives are defined in a reusable way?
Perhaps in a new module `sage_setup.cython_options`


---

Comment by mkoeppe created at 2020-10-02 18:26:06

Replying to [comment:92 mkoeppe]:
> Could you refactor this so that these directives are defined in a reusable way?
> Perhaps in a new module `sage_setup.cython_options` 

... in a separate ticket of course.


---

Comment by @tobiasdiez created at 2020-10-02 18:47:28

Will do so. For the cython options, they are actually only a small subset of the ones in `sage_build_cython`. Should I still refactor? (Feels a bit strange as there are more differences than similarities.) But I'm also not sure if the other cython options are needed...


---

Comment by mkoeppe created at 2020-10-02 18:49:11

Replying to [comment:95 gh-tobiasdiez]:
> Will do so. For the cython options, they are actually only a small subset of the ones in `sage_build_cython`. Should I still refactor? (Feels a bit strange as there are more differences than similarities.) But I'm also not sure if the other cython options are needed...
Well, the idea would be to see whether you can just build with the options that Sage uses instead of using your own set of options.


---

Comment by mkoeppe created at 2020-10-02 18:50:05

Whether other Cython build options can/should be used - should be orthogonal to whether an in-place or regular build is done. So it should not be done on this ticket.


---

Comment by mkoeppe created at 2020-10-02 19:31:29

Some comments on items in the ticket description:
> TODO (as followup tickets):
> - Automatically generate the `apt-get install` command with the necessary libraries (add them as `distros/debian.txt`?)

`./configure` takes care of all of this. Do you plan to do system interface configuration and system package advice without using `./configure` (or, more generally, Unix shell scripts)?  

A way forward is to reimplement (cleaner version of) some of the simple shell code for system package advice as Python code in `sage_bootstrap`. See #29146.

> - Remove `ARB_LIBRARY` env variable, and move check from `arb/config.m4` to `env.py`

My suggestion:  Instead of discussing to remove this variable (or other configuration variables that are set by `./configure`), rather discuss different ways of generating the `sage_conf` module / or providing different implementations of the interface defined by the `sage_conf` module for different use cases (such as supporting a platform that does not have a Unix shell).

> - Move package dependencies from pipfile to install_requires in `src/setup.py`. 

Best to put them in `src/setup.cfg` instead of `src/setup.py` (see #30578)


---

Comment by git created at 2020-10-03 12:50:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-10-03 17:49:57

Thanks for preparing this cleaned up branch.

Trying to test it, I seem to be running into something that looks like https://discuss.python.org/t/pip-19-1-and-installing-in-editable-mode-with-pyproject-toml/1553 : 
Something is generating a `pyproject.toml` in `src/` and then it dies with 

```
Writing supplied requirement line to temporary file: '-e .'
Installing 'e1839a8'
$ ['/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/bin/pip', 'install', '--verbose', '--upgrade', '--no-use-pep517', '--no-deps', '--exists-action=i', '-r', '/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pipenv-_yopr9l3-requirements/pipenv-7uv8tb0m-requirement.txt', '-i', 'https://pypi.org/simple']
Using source directory: '/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/src'
Using pip 20.2.1 from /Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip (python 3.8)
Non-user install by explicit request
...
  File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_internal/distributions/sdist.py", line 33, in prepare_distribution_metadata
    self.req.load_pyproject_toml()
  File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_internal/req/req_install.py", line 503, in load_pyproject_toml
    pyproject_toml_data = load_pyproject_toml(
  File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_internal/pyproject.py", line 95, in load_pyproject_toml
    raise InstallationError(
pip._internal.exceptions.InstallationError: Disabling PEP 517 processing is invalid: project specifies a build backend of setuptools.build_meta in pyproject.toml
Removed file:///Users/mkoeppe/s/sage/sage-rebasing/src (from -r /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pipenv-_yopr9l3-requirements/pipenv-7uv8tb0m-requirement.txt (line 1)) from build tracker '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-lxrv7bcd'
Removed build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-lxrv7bcd'
```



---

Comment by @tobiasdiez created at 2020-10-03 18:49:31

Strange. For some reason, for you pip is invoked with `--no-use-pep517`. For me it is not:


```
$ "/mnt/d/Programming/Projects/sage/src/.venv/bin/pip" install   --verbose  --no-deps  -e "." -i https://pypi.org/simple --exists-action w...
```

What version of pipenv do you use? For me: pipenv 11.9.0 (and the pip in the virtual env also differs: pip 20.0.2)


---

Comment by mkoeppe created at 2020-10-03 18:50:55

I'm using pipenv from homebrew, which is version 2020.8.13


---

Comment by @tobiasdiez created at 2020-10-03 19:05:49

I will try to update my pipenv later. For now you can have a look if setting the environment variable PIP_USE_PEP517 to true resolves the issue.


---

Comment by mkoeppe created at 2020-10-03 19:06:57

I'll try, but I think editable installs are not compatible with PEP517


---

Comment by mkoeppe created at 2020-10-03 19:41:39

No change after setting this environment variable


---

Comment by @tobiasdiez created at 2020-10-04 13:32:05

I had a closer look at this, and it turns out that the first time pip is correctly called without any `--no-use-pep517` argument, only on the retry this argument is used. Thus, the error actually shadows another error that occurs during the initial `pip install`.

Can you thus run the following `pipenv run pip install -e . --no-build-isolation` after `pipenv install`. This should point to the real issue why the editable install fails. 

I've created a github workflow because I don't have a mac. https://github.com/tobiasdiez/sage/blob/public/build/inplace/.github/workflows/ci-pipenv.yml It shows the same problem, the `pipenv install` fails apparently due to a pep517 issue, but the editable install actually fails due to missing interpreters and other dependencies (which requires manual installations as in the ticket description).


---

Comment by mkoeppe created at 2020-10-04 15:40:51

Hm...

```
(sage-sh) mkoeppe@egret:src$ pipenv run pip install -e . --no-build-isolation
Obtaining file:///Users/mkoeppe/s/sage/sage-rebasing/src
    Preparing wheel metadata ... error
    ERROR: Command errored out with exit status 1:
     command: /Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/bin/python /Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py prepare_metadata_for_build_wheel /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/tmpvt150u93
         cwd: /Users/mkoeppe/s/sage/sage-rebasing/src
    Complete output (14 lines):
    Traceback (most recent call last):
      File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 280, in <module>
        main()
      File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 263, in main
        json_out['return_val'] = hook(**hook_input['kwargs'])
      File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 133, in prepare_metadata_for_build_wheel
        return hook(metadata_directory, config_settings)
      File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/setuptools/build_meta.py", line 161, in prepare_metadata_for_build_wheel
        self.run_setup()
      File "/Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/setuptools/build_meta.py", line 145, in run_setup
        exec(compile(code, __file__, 'exec'), locals())
      File "setup.py", line 23, in <module>
        import sage.env
    ModuleNotFoundError: No module named 'sage'
    ----------------------------------------
ERROR: Command errored out with exit status 1: /Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/bin/python /Users/mkoeppe/.local/share/virtualenvs/src-BXov0SKG/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py prepare_metadata_for_build_wheel /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/tmpvt150u93 Check the logs for full command output.
```



---

Comment by @tobiasdiez created at 2020-10-04 17:01:49

No idea....for the github action this is not a problem: https://github.com/tobiasdiez/sage/runs/1205452529?check_suite_focus=true. Maybe `pipenv run pip install -e . --verbose --upgrade --exists-action=i --no-build-isolation` works, or you need to clean the venv first (pipenv -rm).


---

Comment by mkoeppe created at 2020-10-04 17:07:33

Sure, I'll play with it more in the next days.


---

Comment by git created at 2020-10-07 16:26:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-07 16:28:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-16 22:23:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-10-16 22:27:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-10-16 22:27:30

Rebased on top of the dependencies


---

Comment by mkoeppe created at 2020-10-16 22:28:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-10-17 19:14:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-17 19:23:30

Thanks for the rebase. Next time please try to not force-push to a branch that others have checked out because it messes up their git history.

I've updated the code to use the new cython options module.


---

Comment by @tobiasdiez created at 2020-10-17 19:23:30

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-10-17 19:41:51

Sorry if the push made it harder for you to continue on this branch. But rebasing it on top of the branches of the dependency tickets was a necessary cleanup


---

Comment by mkoeppe created at 2020-10-19 23:33:03

What's the status of this branch? Does it work for you? Can you run doctests in the in-place installation and does it pass them?


---

Comment by @tobiasdiez created at 2020-10-20 08:11:11

It's working for me. `pipenv install -dev` gives a fully functional virtual environment (so the cython compilation works). Moreover, `import sage.all` works as well, and one can then use it to run sage-code. So far, I've tested it with some code from the manifolds package. Not yet tried doctests, as I've no idea how to run them from the virtual environment.


---

Comment by mkoeppe created at 2020-10-20 16:42:24

Replying to [comment:124 gh-tobiasdiez]:
> Not yet tried doctests, as I've no idea how to run them from the virtual environment.

Well, the virtual environment has a `bin/sage` script, so `sage -t` "should" work. If it does not, this needs to be fixed. Likely some work in the direction of #22731 is necessary.


---

Comment by @tobiasdiez created at 2020-10-20 19:30:08

Yeah, `sage -t` still uses the python in `sage/local`. So this does not work, and a mechanism is needed to use the python of the activated virtual env (without changing env variables which is too inflexible in my opinion).

Directly running `bin/sage-runtests --all` also leads to errors:


```
no stored timings available
Running doctests with ID 2020-10-20-21-18-29-b0a05b3d.
Using --optional=dochtml,memlimit,sage,sage_spkg
Doctesting entire Sage library.
Traceback (most recent call last):
  File "bin/sage-runtests", line 182, in <module>
    err = DC.run()
  File "/mnt/d/Programming/Projects/sage/src/sage/doctest/control.py", line 1234, in run
    self.expand_files_into_sources()
  File "/mnt/d/Programming/Projects/sage/src/sage/doctest/control.py", line 817, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/mnt/d/Programming/Projects/sage/src/sage/doctest/control.py", line 817, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/mnt/d/Programming/Projects/sage/src/sage/doctest/sources.py", line 528, in __init__
    raise ValueError("unknown file extension %r"%ext)
ValueError: unknown file extension ''
```


(I guess some files are not found.)


Anyway, that's probably a topic for another ticket.


---

Comment by mkoeppe created at 2020-10-20 20:05:38

Replying to [comment:126 gh-tobiasdiez]:
> Yeah, `sage -t` still uses the python in `sage/local`. So this does not work, and a mechanism is needed to use the python of the activated virtual env (without changing env variables which is too inflexible in my opinion).

Yes, this is precisely #22731


---

Comment by git created at 2020-10-21 06:28:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-21 06:30:24

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-10-21 07:01:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-10-21 15:15:19

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2020-10-21 15:37:43

I've now added github actions to have a reproducible test in a clean environment. The compilation is working now (under linux), but the singular library cannot be found during runtime. https://github.com/tobiasdiez/sage/runs/1287237342?check_suite_focus=true

The problem appears to be that sage is looking for singular in `sysconfig.get_config_var('LIBDIR')` (e.g. `/usr/local/lib`) but it is installed as `/usr/lib/x86_64-linux-gnu/libsingular-Singular.so`. Is there a reason why `LIBDIR` is used in `env.py` instead of the approach using `pkgconfig` as during compilation time?


---

Comment by mkoeppe created at 2020-10-21 18:40:33

`_get_shared_lib_filename` actually also looks in `MULTILIB` and is supposed to find this Debian-specific install location via this mechanism. But it is possible that this is broken because we currently actually do not use system `singular` (nor `gap`) at all (see #29644, #29024, meta-ticket #27330). This needs more investigation.


---

Comment by mkoeppe created at 2020-10-21 18:47:54

Replying to [comment:133 gh-tobiasdiez]:
> Is there a reason why `LIBDIR` is used in `env.py` instead of the approach using `pkgconfig` as during compilation time?

pkgconfig does not really reveal the libname directly, so one would need to parse `pkgconfig --libs`. 

Another reason is that the .pc files are usually only available in "dev" packages. So the runtime of Sage should not depend on it. 

#29024 intends to make the location configurable (at build time!) via `sage_conf`.


---

Comment by git created at 2020-10-25 09:46:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-25 10:02:37

Thanks for the input. I had a closer look at `_get_shared_lib_filename` and the problem was that `libsingular-Singular.so` is in the subfolder `/usr/lib/x86_64-linux-gnu/` while `_get_shared_lib_filename` only searched the top folder `/usr/lib`. I've now changed it to also look in subfolders. That should be reasonable fix until #29024 is implemented.

With these changes, the github action workflow passes successful on linux: https://github.com/tobiasdiez/sage/runs/1303324520?check_suite_focus=true
It's nice to see that it only takes about 1 hour to have a fully workable sage environment.

This is now really ready for review.

TODOs (for further tickets):
- Investigate what needs to be installed on macOS to have a successful build, and add these steps to the github action. (I don't have a mac, so I'll not work on this.)
- Run doctests in the github action as soon as they no longer rely on `SAGE_LOCAL` (#22731)


---

Comment by mkoeppe created at 2020-10-25 15:24:33

Replying to [comment:137 gh-tobiasdiez]:
> Thanks for the input. I had a closer look at `_get_shared_lib_filename` and the problem was that `libsingular-Singular.so` is in the subfolder `/usr/lib/x86_64-linux-gnu/` while `_get_shared_lib_filename` only searched the top folder `/usr/lib`. I've now changed it to also look in subfolders. 

This should have been taking care of by `MULTILIB`. Is this not configured in your system?


---

Comment by @tobiasdiez created at 2020-10-25 16:37:50

`MULTILIB` is empty on my system (WSL Ubuntu 20.04), nor was it working for the github actions (Ubuntu 20.10).


---

Comment by mkoeppe created at 2020-10-25 17:17:36

Can you show the full output of `python3 -m sysconfig` on this system?


---

Comment by @tobiasdiez created at 2020-10-25 18:37:40


```
Platform: "linux-x86_64"
Python version: "3.8"
Current installation scheme: "posix_prefix"

Paths: 
        data = "/mnt/d/Programming/Projects/sage/src/.venv"
        include = "/usr/include/python3.8"
        platinclude = "/usr/include/python3.8"
        platlib = "/mnt/d/Programming/Projects/sage/src/.venv/lib/python3.8/site-packages"
        platstdlib = "/mnt/d/Programming/Projects/sage/src/.venv/lib/python3.8"
        purelib = "/mnt/d/Programming/Projects/sage/src/.venv/lib/python3.8/site-packages"
        scripts = "/mnt/d/Programming/Projects/sage/src/.venv/bin"
        stdlib = "/usr/lib/python3.8"

Variables: 
        ABIFLAGS = ""
        AC_APPLE_UNIVERSAL_BUILD = "0"
        AIX_GENUINE_CPLUSPLUS = "0"
        ALT_SOABI = "0"
        ANDROID_API_LEVEL = "0"
        AR = "x86_64-linux-gnu-gcc-ar"
        ARFLAGS = "rcs"
        BASECFLAGS = "-Wno-unused-result -Wsign-compare"
        BASECPPFLAGS = "-IObjects -IInclude -IPython"
        BASEMODLIBS = ""
        BINDIR = "/usr/bin"
        BINLIBDEST = "/usr/lib/python3.8"
        BLDLIBRARY = "-lpython3.8"
        BLDSHARED = "x86_64-linux-gnu-gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   "
        BUILDEXE = ""
        BUILDPYTHON = "python"
        BUILD_GNU_TYPE = "x86_64-pc-linux-gnu"
        BYTESTR_DEPS = "\"
        CC = "x86_64-linux-gnu-gcc -pthread"
        CCSHARED = "-fPIC"
        CFLAGS = "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g   -fstack-protector-strong -Wformat -Werror=format-security  -g -fwrapv -O2   "
        CFLAGSFORSHARED = "-fPIC"
        CFLAGS_ALIASING = ""
        CFLAGS_NODIST = ""
        CONFIGFILES = "configure configure.ac acconfig.h pyconfig.h.in Makefile.pre.in"
        CONFIGURE_CFLAGS = "-g   -fstack-protector-strong -Wformat -Werror=format-security"
        CONFIGURE_CFLAGS_NODIST = "-std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration"
        CONFIGURE_CPPFLAGS = "-Wdate-time -D_FORTIFY_SOURCE=2"
        CONFIGURE_LDFLAGS = "-Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   "
        CONFIGURE_LDFLAGS_NODIST = ""
        CONFIG_ARGS = "'--enable-shared' '--prefix=/usr' '--enable-ipv6' '--enable-loadable-sqlite-extensions' '--with-dbmliborder=bdb:gdbm' '--with-computed-gotos' '--without-ensurepip' '--with-system-expat' '--with-system-libmpdec' '--with-dtrace' '--with-system-ffi' 'CC=x86_64-linux-gnu-gcc' 'CFLAGS=-g   -fstack-protector-strong -Wformat -Werror=format-security ' 'LDFLAGS=-Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   ' 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2'"
        CONFINCLUDEDIR = "/usr/include"
        CONFINCLUDEPY = "/usr/include/python3.8"
        COREPYTHONPATH = ""
        COVERAGE_INFO = "/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared/coverage.info"
        COVERAGE_REPORT = "/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared/lcov-report"
        COVERAGE_REPORT_OPTIONS = "--no-branch-coverage --title "CPython lcov report""
        CPPFLAGS = "-IObjects -IInclude -IPython -I. -I../Include -Wdate-time -D_FORTIFY_SOURCE=2"
        CXX = "x86_64-linux-gnu-g++ -pthread"
        DESTDIRS = "/usr /usr/lib /usr/lib/python3.8 /usr/lib/python3.8/lib-dynload"
        DESTLIB = "/usr/lib/python3.8"
        DESTPATH = ""
        DESTSHARED = "/usr/lib/python3.8/lib-dynload"
        DFLAGS = ""
        DIRMODE = "755"
        DIST = "README.rst ChangeLog configure configure.ac acconfig.h pyconfig.h.in Makefile.pre.in Include Lib Misc Ext-dummy"
        DISTDIRS = "Include Lib Misc Ext-dummy"
        DISTFILES = "README.rst ChangeLog configure configure.ac acconfig.h pyconfig.h.in Makefile.pre.in"
        DLINCLDIR = "."
        DLLLIBRARY = ""
        DOUBLE_IS_ARM_MIXED_ENDIAN_IEEE754 = "0"
        DOUBLE_IS_BIG_ENDIAN_IEEE754 = "0"
        DOUBLE_IS_LITTLE_ENDIAN_IEEE754 = "1"
        DTRACE = "/usr/bin/dtrace"
        DTRACE_DEPS = "\"
        DTRACE_HEADERS = "Include/pydtrace_probes.h"
        DTRACE_OBJS = "Python/pydtrace.o"
        DYNLOADFILE = "dynload_shlib.o"
        ENABLE_IPV6 = "1"
        ENSUREPIP = "no"
        EXE = ""
        EXEMODE = "755"
        EXTRATESTOPTS = ""
        EXT_SUFFIX = ".cpython-38-x86_64-linux-gnu.so"
        FILEMODE = "644"
        FLOAT_WORDS_BIGENDIAN = "0"
        FLOCK_NEEDS_LIBBSD = "0"
        GETPGRP_HAVE_ARG = "0"
        GETTIMEOFDAY_NO_TZ = "0"
        GITBRANCH = ""
        GITTAG = ""
        GITVERSION = ""
        GNULD = "yes"
        HAVE_ACCEPT4 = "1"
        HAVE_ACOSH = "1"
        HAVE_ADDRINFO = "1"
        HAVE_ALARM = "1"
        HAVE_ALIGNED_REQUIRED = "0"
        HAVE_ALLOCA_H = "1"
        HAVE_ALTZONE = "0"
        HAVE_ASINH = "1"
        HAVE_ASM_TYPES_H = "1"
        HAVE_ATANH = "1"
        HAVE_BIND_TEXTDOMAIN_CODESET = "1"
        HAVE_BLUETOOTH_BLUETOOTH_H = "1"
        HAVE_BLUETOOTH_H = "0"
        HAVE_BROKEN_MBSTOWCS = "0"
        HAVE_BROKEN_NICE = "0"
        HAVE_BROKEN_PIPE_BUF = "0"
        HAVE_BROKEN_POLL = "0"
        HAVE_BROKEN_POSIX_SEMAPHORES = "0"
        HAVE_BROKEN_PTHREAD_SIGMASK = "0"
        HAVE_BROKEN_SEM_GETVALUE = "0"
        HAVE_BROKEN_UNSETENV = "0"
        HAVE_BUILTIN_ATOMIC = "1"
        HAVE_CHFLAGS = "0"
        HAVE_CHOWN = "1"
        HAVE_CHROOT = "1"
        HAVE_CLOCK = "1"
        HAVE_CLOCK_GETRES = "1"
        HAVE_CLOCK_GETTIME = "1"
        HAVE_CLOCK_SETTIME = "1"
        HAVE_COMPUTED_GOTOS = "1"
        HAVE_CONFSTR = "1"
        HAVE_CONIO_H = "0"
        HAVE_COPYSIGN = "1"
        HAVE_COPY_FILE_RANGE = "1"
        HAVE_CRYPT_H = "1"
        HAVE_CRYPT_R = "1"
        HAVE_CTERMID = "1"
        HAVE_CTERMID_R = "0"
        HAVE_CURSES_FILTER = "1"
        HAVE_CURSES_H = "1"
        HAVE_CURSES_HAS_KEY = "1"
        HAVE_CURSES_IMMEDOK = "1"
        HAVE_CURSES_IS_PAD = "1"
        HAVE_CURSES_IS_TERM_RESIZED = "1"
        HAVE_CURSES_RESIZETERM = "1"
        HAVE_CURSES_RESIZE_TERM = "1"
        HAVE_CURSES_SYNCOK = "1"
        HAVE_CURSES_TYPEAHEAD = "1"
        HAVE_CURSES_USE_ENV = "1"
        HAVE_CURSES_WCHGAT = "1"
        HAVE_DECL_ISFINITE = "1"
        HAVE_DECL_ISINF = "1"
        HAVE_DECL_ISNAN = "1"
        HAVE_DECL_RTLD_DEEPBIND = "1"
        HAVE_DECL_RTLD_GLOBAL = "1"
        HAVE_DECL_RTLD_LAZY = "1"
        HAVE_DECL_RTLD_LOCAL = "1"
        HAVE_DECL_RTLD_MEMBER = "0"
        HAVE_DECL_RTLD_NODELETE = "1"
        HAVE_DECL_RTLD_NOLOAD = "1"
        HAVE_DECL_RTLD_NOW = "1"
        HAVE_DECL_TZNAME = "0"
        HAVE_DEVICE_MACROS = "1"
        HAVE_DEV_PTC = "0"
        HAVE_DEV_PTMX = "1"
        HAVE_DIRECT_H = "0"
        HAVE_DIRENT_D_TYPE = "1"
        HAVE_DIRENT_H = "1"
        HAVE_DIRFD = "1"
        HAVE_DLFCN_H = "1"
        HAVE_DLOPEN = "1"
        HAVE_DUP2 = "1"
        HAVE_DUP3 = "1"
        HAVE_DYNAMIC_LOADING = "1"
        HAVE_ENDIAN_H = "1"
        HAVE_EPOLL = "1"
        HAVE_EPOLL_CREATE1 = "1"
        HAVE_ERF = "1"
        HAVE_ERFC = "1"
        HAVE_ERRNO_H = "1"
        HAVE_EXECV = "1"
        HAVE_EXPLICIT_BZERO = "1"
        HAVE_EXPLICIT_MEMSET = "0"
        HAVE_EXPM1 = "1"
        HAVE_FACCESSAT = "1"
        HAVE_FCHDIR = "1"
        HAVE_FCHMOD = "1"
        HAVE_FCHMODAT = "1"
        HAVE_FCHOWN = "1"
        HAVE_FCHOWNAT = "1"
        HAVE_FCNTL_H = "1"
        HAVE_FDATASYNC = "1"
        HAVE_FDOPENDIR = "1"
        HAVE_FDWALK = "0"
        HAVE_FEXECVE = "1"
        HAVE_FINITE = "1"
        HAVE_FLOCK = "1"
        HAVE_FORK = "1"
        HAVE_FORKPTY = "1"
        HAVE_FPATHCONF = "1"
        HAVE_FSEEK64 = "0"
        HAVE_FSEEKO = "1"
        HAVE_FSTATAT = "1"
        HAVE_FSTATVFS = "1"
        HAVE_FSYNC = "1"
        HAVE_FTELL64 = "0"
        HAVE_FTELLO = "1"
        HAVE_FTIME = "1"
        HAVE_FTRUNCATE = "1"
        HAVE_FUTIMENS = "1"
        HAVE_FUTIMES = "1"
        HAVE_FUTIMESAT = "1"
        HAVE_GAI_STRERROR = "1"
        HAVE_GAMMA = "1"
        HAVE_GCC_ASM_FOR_MC68881 = "0"
        HAVE_GCC_ASM_FOR_X64 = "1"
        HAVE_GCC_ASM_FOR_X87 = "1"
        HAVE_GCC_UINT128_T = "1"
        HAVE_GETADDRINFO = "1"
        HAVE_GETC_UNLOCKED = "1"
        HAVE_GETENTROPY = "1"
        HAVE_GETGRGID_R = "1"
        HAVE_GETGRNAM_R = "1"
        HAVE_GETGROUPLIST = "1"
        HAVE_GETGROUPS = "1"
        HAVE_GETHOSTBYNAME = "0"
        HAVE_GETHOSTBYNAME_R = "1"
        HAVE_GETHOSTBYNAME_R_3_ARG = "0"
        HAVE_GETHOSTBYNAME_R_5_ARG = "0"
        HAVE_GETHOSTBYNAME_R_6_ARG = "1"
        HAVE_GETITIMER = "1"
        HAVE_GETLOADAVG = "1"
        HAVE_GETLOGIN = "1"
        HAVE_GETNAMEINFO = "1"
        HAVE_GETPAGESIZE = "1"
        HAVE_GETPEERNAME = "1"
        HAVE_GETPGID = "1"
        HAVE_GETPGRP = "1"
        HAVE_GETPID = "1"
        HAVE_GETPRIORITY = "1"
        HAVE_GETPWENT = "1"
        HAVE_GETPWNAM_R = "1"
        HAVE_GETPWUID_R = "1"
        HAVE_GETRANDOM = "1"
        HAVE_GETRANDOM_SYSCALL = "1"
        HAVE_GETRESGID = "1"
        HAVE_GETRESUID = "1"
        HAVE_GETSID = "1"
        HAVE_GETSPENT = "1"
        HAVE_GETSPNAM = "1"
        HAVE_GETTIMEOFDAY = "1"
        HAVE_GETWD = "1"
        HAVE_GLIBC_MEMMOVE_BUG = "0"
        HAVE_GRP_H = "1"
        HAVE_HSTRERROR = "1"
        HAVE_HTOLE64 = "1"
        HAVE_HYPOT = "1"
        HAVE_IEEEFP_H = "0"
        HAVE_IF_NAMEINDEX = "1"
        HAVE_INET_ATON = "1"
        HAVE_INET_PTON = "1"
        HAVE_INITGROUPS = "1"
        HAVE_INTTYPES_H = "1"
        HAVE_IO_H = "0"
        HAVE_IPA_PURE_CONST_BUG = "0"
        HAVE_KILL = "1"
        HAVE_KILLPG = "1"
        HAVE_KQUEUE = "0"
        HAVE_LANGINFO_H = "1"
        HAVE_LARGEFILE_SUPPORT = "0"
        HAVE_LCHFLAGS = "0"
        HAVE_LCHMOD = "0"
        HAVE_LCHOWN = "1"
        HAVE_LGAMMA = "1"
        HAVE_LIBDL = "1"
        HAVE_LIBDLD = "0"
        HAVE_LIBIEEE = "0"
        HAVE_LIBINTL_H = "1"
        HAVE_LIBREADLINE = "1"
        HAVE_LIBRESOLV = "0"
        HAVE_LIBSENDFILE = "0"
        HAVE_LIBUTIL_H = "0"
        HAVE_LINK = "1"
        HAVE_LINKAT = "1"
        HAVE_LINUX_CAN_BCM_H = "1"
        HAVE_LINUX_CAN_H = "1"
        HAVE_LINUX_CAN_RAW_FD_FRAMES = "1"
        HAVE_LINUX_CAN_RAW_H = "1"
        HAVE_LINUX_MEMFD_H = "1"
        HAVE_LINUX_NETLINK_H = "1"
        HAVE_LINUX_QRTR_H = "1"
        HAVE_LINUX_RANDOM_H = "1"
        HAVE_LINUX_TIPC_H = "1"
        HAVE_LINUX_VM_SOCKETS_H = "1"
        HAVE_LOCKF = "1"
        HAVE_LOG1P = "1"
        HAVE_LOG2 = "1"
        HAVE_LONG_DOUBLE = "1"
        HAVE_LSTAT = "1"
        HAVE_LUTIMES = "1"
        HAVE_MADVISE = "1"
        HAVE_MAKEDEV = "1"
        HAVE_MBRTOWC = "1"
        HAVE_MEMFD_CREATE = "1"
        HAVE_MEMORY_H = "1"
        HAVE_MEMRCHR = "1"
        HAVE_MKDIRAT = "1"
        HAVE_MKFIFO = "1"
        HAVE_MKFIFOAT = "1"
        HAVE_MKNOD = "1"
        HAVE_MKNODAT = "1"
        HAVE_MKTIME = "1"
        HAVE_MMAP = "1"
        HAVE_MREMAP = "1"
        HAVE_NCURSES_H = "1"
        HAVE_NDIR_H = "0"
        HAVE_NETPACKET_PACKET_H = "1"
        HAVE_NET_IF_H = "1"
        HAVE_NICE = "1"
        HAVE_OPENAT = "1"
        HAVE_OPENPTY = "1"
        HAVE_PATHCONF = "1"
        HAVE_PAUSE = "1"
        HAVE_PIPE2 = "1"
        HAVE_PLOCK = "0"
        HAVE_POLL = "1"
        HAVE_POLL_H = "1"
        HAVE_POSIX_FADVISE = "1"
        HAVE_POSIX_FALLOCATE = "1"
        HAVE_POSIX_SPAWN = "1"
        HAVE_POSIX_SPAWNP = "1"
        HAVE_PREAD = "1"
        HAVE_PREADV = "1"
        HAVE_PREADV2 = "1"
        HAVE_PRLIMIT = "1"
        HAVE_PROCESS_H = "0"
        HAVE_PROTOTYPES = "1"
        HAVE_PTHREAD_CONDATTR_SETCLOCK = "1"
        HAVE_PTHREAD_DESTRUCTOR = "0"
        HAVE_PTHREAD_GETCPUCLOCKID = "1"
        HAVE_PTHREAD_H = "1"
        HAVE_PTHREAD_INIT = "0"
        HAVE_PTHREAD_KILL = "1"
        HAVE_PTHREAD_SIGMASK = "1"
        HAVE_PTY_H = "1"
        HAVE_PUTENV = "1"
        HAVE_PWRITE = "1"
        HAVE_PWRITEV = "1"
        HAVE_PWRITEV2 = "1"
        HAVE_READLINK = "1"
        HAVE_READLINKAT = "1"
        HAVE_READV = "1"
        HAVE_REALPATH = "1"
        HAVE_RENAMEAT = "1"
        HAVE_RL_APPEND_HISTORY = "1"
        HAVE_RL_CATCH_SIGNAL = "1"
        HAVE_RL_COMPLETION_APPEND_CHARACTER = "1"
        HAVE_RL_COMPLETION_DISPLAY_MATCHES_HOOK = "1"
        HAVE_RL_COMPLETION_MATCHES = "1"
        HAVE_RL_COMPLETION_SUPPRESS_APPEND = "1"
        HAVE_RL_PRE_INPUT_HOOK = "1"
        HAVE_RL_RESIZE_TERMINAL = "1"
        HAVE_ROUND = "1"
        HAVE_RTPSPAWN = "0"
        HAVE_SCHED_GET_PRIORITY_MAX = "1"
        HAVE_SCHED_H = "1"
        HAVE_SCHED_RR_GET_INTERVAL = "1"
        HAVE_SCHED_SETAFFINITY = "1"
        HAVE_SCHED_SETPARAM = "1"
        HAVE_SCHED_SETSCHEDULER = "1"
        HAVE_SEM_GETVALUE = "1"
        HAVE_SEM_OPEN = "1"
        HAVE_SEM_TIMEDWAIT = "1"
        HAVE_SEM_UNLINK = "1"
        HAVE_SENDFILE = "1"
        HAVE_SETEGID = "1"
        HAVE_SETEUID = "1"
        HAVE_SETGID = "1"
        HAVE_SETGROUPS = "1"
        HAVE_SETHOSTNAME = "1"
        HAVE_SETITIMER = "1"
        HAVE_SETLOCALE = "1"
        HAVE_SETPGID = "1"
        HAVE_SETPGRP = "1"
        HAVE_SETPRIORITY = "1"
        HAVE_SETREGID = "1"
        HAVE_SETRESGID = "1"
        HAVE_SETRESUID = "1"
        HAVE_SETREUID = "1"
        HAVE_SETSID = "1"
        HAVE_SETUID = "1"
        HAVE_SETVBUF = "1"
        HAVE_SHADOW_H = "1"
        HAVE_SHM_OPEN = "1"
        HAVE_SHM_UNLINK = "1"
        HAVE_SIGACTION = "1"
        HAVE_SIGALTSTACK = "1"
        HAVE_SIGFILLSET = "1"
        HAVE_SIGINFO_T_SI_BAND = "1"
        HAVE_SIGINTERRUPT = "1"
        HAVE_SIGNAL_H = "1"
        HAVE_SIGPENDING = "1"
        HAVE_SIGRELSE = "1"
        HAVE_SIGTIMEDWAIT = "1"
        HAVE_SIGWAIT = "1"
        HAVE_SIGWAITINFO = "1"
        HAVE_SNPRINTF = "1"
        HAVE_SOCKADDR_ALG = "1"
        HAVE_SOCKADDR_SA_LEN = "0"
        HAVE_SOCKADDR_STORAGE = "1"
        HAVE_SOCKETPAIR = "1"
        HAVE_SPAWN_H = "1"
        HAVE_SSIZE_T = "1"
        HAVE_STATVFS = "1"
        HAVE_STAT_TV_NSEC = "1"
        HAVE_STAT_TV_NSEC2 = "0"
        HAVE_STDARG_PROTOTYPES = "1"
        HAVE_STDINT_H = "1"
        HAVE_STDLIB_H = "1"
        HAVE_STD_ATOMIC = "1"
        HAVE_STRDUP = "1"
        HAVE_STRFTIME = "1"
        HAVE_STRINGS_H = "1"
        HAVE_STRING_H = "1"
        HAVE_STRLCPY = "0"
        HAVE_STROPTS_H = "0"
        HAVE_STRSIGNAL = "1"
        HAVE_STRUCT_PASSWD_PW_GECOS = "1"
        HAVE_STRUCT_PASSWD_PW_PASSWD = "1"
        HAVE_STRUCT_STAT_ST_BIRTHTIME = "0"
        HAVE_STRUCT_STAT_ST_BLKSIZE = "1"
        HAVE_STRUCT_STAT_ST_BLOCKS = "1"
        HAVE_STRUCT_STAT_ST_FLAGS = "0"
        HAVE_STRUCT_STAT_ST_GEN = "0"
        HAVE_STRUCT_STAT_ST_RDEV = "1"
        HAVE_STRUCT_TM_TM_ZONE = "1"
        HAVE_SYMLINK = "1"
        HAVE_SYMLINKAT = "1"
        HAVE_SYNC = "1"
        HAVE_SYSCONF = "1"
        HAVE_SYSEXITS_H = "1"
        HAVE_SYS_AUDIOIO_H = "0"
        HAVE_SYS_BSDTTY_H = "0"
        HAVE_SYS_DEVPOLL_H = "0"
        HAVE_SYS_DIR_H = "0"
        HAVE_SYS_ENDIAN_H = "0"
        HAVE_SYS_EPOLL_H = "1"
        HAVE_SYS_EVENT_H = "0"
        HAVE_SYS_FILE_H = "1"
        HAVE_SYS_IOCTL_H = "1"
        HAVE_SYS_KERN_CONTROL_H = "0"
        HAVE_SYS_LOADAVG_H = "0"
        HAVE_SYS_LOCK_H = "0"
        HAVE_SYS_MEMFD_H = "0"
        HAVE_SYS_MKDEV_H = "0"
        HAVE_SYS_MMAN_H = "1"
        HAVE_SYS_MODEM_H = "0"
        HAVE_SYS_NDIR_H = "0"
        HAVE_SYS_PARAM_H = "1"
        HAVE_SYS_POLL_H = "1"
        HAVE_SYS_RANDOM_H = "1"
        HAVE_SYS_RESOURCE_H = "1"
        HAVE_SYS_SELECT_H = "1"
        HAVE_SYS_SENDFILE_H = "1"
        HAVE_SYS_SOCKET_H = "1"
        HAVE_SYS_STATVFS_H = "1"
        HAVE_SYS_STAT_H = "1"
        HAVE_SYS_SYSCALL_H = "1"
        HAVE_SYS_SYSMACROS_H = "1"
        HAVE_SYS_SYS_DOMAIN_H = "0"
        HAVE_SYS_TERMIO_H = "0"
        HAVE_SYS_TIMES_H = "1"
        HAVE_SYS_TIME_H = "1"
        HAVE_SYS_TYPES_H = "1"
        HAVE_SYS_UIO_H = "1"
        HAVE_SYS_UN_H = "1"
        HAVE_SYS_UTSNAME_H = "1"
        HAVE_SYS_WAIT_H = "1"
        HAVE_SYS_XATTR_H = "1"
        HAVE_TCGETPGRP = "1"
        HAVE_TCSETPGRP = "1"
        HAVE_TEMPNAM = "1"
        HAVE_TERMIOS_H = "1"
        HAVE_TERM_H = "1"
        HAVE_TGAMMA = "1"
        HAVE_TIMEGM = "1"
        HAVE_TIMES = "1"
        HAVE_TMPFILE = "1"
        HAVE_TMPNAM = "1"
        HAVE_TMPNAM_R = "1"
        HAVE_TM_ZONE = "1"
        HAVE_TRUNCATE = "1"
        HAVE_TZNAME = "0"
        HAVE_UCS4_TCL = "0"
        HAVE_UNAME = "1"
        HAVE_UNISTD_H = "1"
        HAVE_UNLINKAT = "1"
        HAVE_UNSETENV = "1"
        HAVE_USABLE_WCHAR_T = "0"
        HAVE_UTIL_H = "0"
        HAVE_UTIMENSAT = "1"
        HAVE_UTIMES = "1"
        HAVE_UTIME_H = "1"
        HAVE_UUID_CREATE = "0"
        HAVE_UUID_ENC_BE = "0"
        HAVE_UUID_GENERATE_TIME_SAFE = "1"
        HAVE_UUID_H = "0"
        HAVE_UUID_UUID_H = "1"
        HAVE_WAIT3 = "1"
        HAVE_WAIT4 = "1"
        HAVE_WAITID = "1"
        HAVE_WAITPID = "1"
        HAVE_WCHAR_H = "1"
        HAVE_WCSCOLL = "1"
        HAVE_WCSFTIME = "1"
        HAVE_WCSXFRM = "1"
        HAVE_WMEMCMP = "1"
        HAVE_WORKING_TZSET = "1"
        HAVE_WRITEV = "1"
        HAVE_X509_VERIFY_PARAM_SET1_HOST = "1"
        HAVE_ZLIB_COPY = "1"
        HAVE__GETPTY = "0"
        HOST_GNU_TYPE = "x86_64-pc-linux-gnu"
        INCLDIRSTOMAKE = "/usr/include /usr/include /usr/include/python3.8 /usr/include/python3.8"
        INCLUDEDIR = "/usr/include"
        INCLUDEPY = "/usr/include/python3.8"
        INSTALL = "/usr/bin/install -c"
        INSTALL_DATA = "/usr/bin/install -c -m 644"
        INSTALL_PROGRAM = "/usr/bin/install -c"
        INSTALL_SCRIPT = "/usr/bin/install -c"
        INSTALL_SHARED = "/usr/bin/install -c -m 755"
        INSTSONAME = "libpython3.8.so.1.0"
        IO_H = "Modules/_io/_iomodule.h"
        IO_OBJS = "\"
        LDCXXSHARED = "x86_64-linux-gnu-g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions"
        LDFLAGS = "-Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   "
        LDFLAGS_NODIST = ""
        LDLIBRARY = "libpython3.8.so"
        LDLIBRARYDIR = ""
        LDSHARED = "x86_64-linux-gnu-gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   "
        LDVERSION = "3.8"
        LIBC = ""
        LIBDEST = "/usr/lib/python3.8"
        LIBDIR = "/usr/lib"
        LIBFFI_INCLUDEDIR = ""
        LIBM = "-lm"
        LIBOBJDIR = "Python/"
        LIBOBJS = ""
        LIBPC = "/usr/lib/x86_64-linux-gnu/pkgconfig"
        LIBPL = "/usr/lib/python3.8/config-3.8-x86_64-linux-gnu"
        LIBPYTHON = ""
        LIBRARY = "libpython3.8.a"
        LIBRARY_OBJS = "\"
        LIBRARY_OBJS_OMIT_FROZEN = "\"
        LIBS = "-lcrypt -lpthread -ldl  -lutil -lm"
        LIBSUBDIRS = "tkinter tkinter/test tkinter/test/test_tkinter \"
        LINKCC = "x86_64-linux-gnu-gcc -pthread"
        LINKFORSHARED = "-Xlinker -export-dynamic -Wl,-O1 -Wl,-Bsymbolic-functions"
        LIPO_32BIT_FLAGS = ""
        LLVM_PROF_ERR = "no"
        LLVM_PROF_FILE = ""
        LLVM_PROF_MERGER = "true"
        LN = "ln"
        LOCALMODLIBS = "-lexpat                       -L/usr/lib -lz                       -lexpat"
        MACHDEP = "linux"
        MACHDEP_OBJS = ""
        MACHDESTLIB = "/usr/lib/python3.8"
        MACOSX_DEPLOYMENT_TARGET = ""
        MAINCC = "x86_64-linux-gnu-gcc -pthread"
        MAJOR_IN_MKDEV = "0"
        MAJOR_IN_SYSMACROS = "1"
        MAKESETUP = "../Modules/makesetup"
        MANDIR = "/usr/share/man"
        MKDIR_P = "/bin/mkdir -p"
        MODBUILT_NAMES = "array  cmath  math  _struct  _random  _elementtree  _pickle  _datetime  _bisect  _heapq  _statistics  unicodedata  fcntl  spwd  grp  select  _csv  _socket  _posixsubprocess  _md5  _sha1  _sha256  _sha512  _sha3  _blake2  syslog  binascii  zlib  posix  errno  pwd  _sre  _codecs  _weakref  _functools  _operator  _collections  _abc  itertools  atexit  _signal  _stat  time  _thread  _locale  _io  faulthandler  _tracemalloc  _symtable  pyexpat  xxsubtype"
        MODDISABLED_NAMES = ""
        MODLIBS = "-lexpat                       -L/usr/lib -lz                       -lexpat"
        MODOBJS = "$(sort   Modules/arraymodule.o  Modules/cmathmodule.o Modules/_math.o  Modules/mathmodule.o Modules/_math.o  Modules/_struct.o  Modules/_randommodule.o  Modules/_elementtree.o  Modules/_pickle.o  Modules/_datetimemodule.o  Modules/_bisectmodule.o  Modules/_heapqmodule.o  Modules/_statisticsmodule.o  Modules/unicodedata.o  Modules/fcntlmodule.o  Modules/spwdmodule.o  Modules/grpmodule.o  Modules/selectmodule.o  Modules/_csv.o  Modules/socketmodule.o  Modules/_posixsubprocess.o  Modules/md5module.o  Modules/sha1module.o  Modules/sha256module.o  Modules/sha512module.o  Modules/sha3module.o  Modules/blake2module.o Modules/blake2b_impl.o Modules/blake2s_impl.o  Modules/syslogmodule.o  Modules/binascii.o  Modules/zlibmodule.o  Modules/posixmodule.o  Modules/errnomodule.o  Modules/pwdmodule.o  Modules/_sre.o  Modules/_codecsmodule.o  Modules/_weakref.o  Modules/_functoolsmodule.o  Modules/_operator.o  Modules/_collectionsmodule.o  Modules/_abc.o  Modules/itertoolsmodule.o  Modules/atexitmodule.o  Modules/signalmodule.o  Modules/_stat.o  Modules/timemodule.o  Modules/_threadmodule.o  Modules/_localemodule.o  Modules/_iomodule.o Modules/iobase.o Modules/fileio.o Modules/bytesio.o Modules/bufferedio.o Modules/textio.o Modules/stringio.o  Modules/faulthandler.o  Modules/_tracemalloc.o Modules/hashtable.o  Modules/symtablemodule.o  Modules/pyexpat.o  Modules/xxsubtype.o)"
        MODULE_OBJS = "\"
        MULTIARCH = "x86_64-linux-gnu"
        MULTIARCH_CPPFLAGS = "-DMULTIARCH=\"x86_64-linux-gnu\""
        MVWDELCH_IS_EXPRESSION = "1"
        NO_AS_NEEDED = "-Wl,--no-as-needed"
        OBJECT_OBJS = "\"
        OPENSSL_INCLUDES = ""
        OPENSSL_LDFLAGS = ""
        OPENSSL_LIBS = "-lssl -lcrypto"
        OPT = "-DNDEBUG -g -fwrapv -O2 -Wall"
        OTHER_LIBTOOL_OPT = ""
        PACKAGE_BUGREPORT = "0"
        PACKAGE_NAME = "0"
        PACKAGE_STRING = "0"
        PACKAGE_TARNAME = "0"
        PACKAGE_URL = "0"
        PACKAGE_VERSION = "0"
        PARSER_HEADERS = "\"
        PARSER_OBJS = "\ Parser/myreadline.o Parser/parsetok.o Parser/tokenizer.o"
        PGO_PROF_GEN_FLAG = "-fprofile-generate"
        PGO_PROF_USE_FLAG = ""
        POBJS = "\"
        POSIX_SEMAPHORES_NOT_ENABLED = "0"
        PROFILE_TASK = "-m test --pgo"
        PTHREAD_KEY_T_IS_COMPATIBLE_WITH_INT = "1"
        PTHREAD_SYSTEM_SCHED_SUPPORTED = "1"
        PURIFY = ""
        PY3LIBRARY = "libpython3.so"
        PYLONG_BITS_IN_DIGIT = "0"
        PYTHON = "python"
        PYTHONFRAMEWORK = ""
        PYTHONFRAMEWORKDIR = "no-framework"
        PYTHONFRAMEWORKINSTALLDIR = ""
        PYTHONFRAMEWORKPREFIX = ""
        PYTHONPATH = ""
        PYTHON_FOR_BUILD = "./python -E"
        PYTHON_FOR_REGEN = "python3.8"
        PYTHON_HEADERS = "\"
        PYTHON_OBJS = "\"
        PY_BUILTIN_MODULE_CFLAGS = "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g   -fstack-protector-strong -Wformat -Werror=format-security  -g -fwrapv -O2    -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration  -I../Include/internal -IObjects -IInclude -IPython -I. -I../Include -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -DPy_BUILD_CORE_BUILTIN"
        PY_CFLAGS = "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g   -fstack-protector-strong -Wformat -Werror=format-security  -g -fwrapv -O2   "
        PY_CFLAGS_NODIST = "-std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration  -I../Include/internal"
        PY_COERCE_C_LOCALE = "1"
        PY_CORE_CFLAGS = "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g   -fstack-protector-strong -Wformat -Werror=format-security  -g -fwrapv -O2    -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration  -I../Include/internal -IObjects -IInclude -IPython -I. -I../Include -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -DPy_BUILD_CORE"
        PY_CORE_LDFLAGS = "-Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   "
        PY_CPPFLAGS = "-IObjects -IInclude -IPython -I. -I../Include -Wdate-time -D_FORTIFY_SOURCE=2"
        PY_FORMAT_SIZE_T = ""z""
        PY_LDFLAGS = "-Wl,-Bsymbolic-functions  -Wl,-z,relro -g -fwrapv -O2   "
        PY_LDFLAGS_NODIST = ""
        PY_SSL_DEFAULT_CIPHERS = "1"
        PY_SSL_DEFAULT_CIPHER_STRING = "0"
        PY_STDMODULE_CFLAGS = "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g   -fstack-protector-strong -Wformat -Werror=format-security  -g -fwrapv -O2    -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration  -I../Include/internal -IObjects -IInclude -IPython -I. -I../Include -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC"
        Py_DEBUG = "0"
        Py_ENABLE_SHARED = "1"
        Py_HASH_ALGORITHM = "0"
        Py_TRACE_REFS = "0"
        QUICKTESTOPTS = "-x test_subprocess test_io test_lib2to3 \"
        READELF = "readelf"
        RESSRCDIR = "Mac/Resources/framework"
        RETSIGTYPE = "void"
        RUNSHARED = "LD_LIBRARY_PATH=/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared"
        SCRIPTDIR = "/usr/lib"
        SETPGRP_HAVE_ARG = "0"
        SGI_ABI = "@SGI_ABI@"
        SHELL = "/bin/sh"
        SHLIBS = "-lcrypt -lpthread -ldl  -lutil -lm"
        SHLIB_SUFFIX = ".so"
        SHM_NEEDS_LIBRT = "1"
        SIGNED_RIGHT_SHIFT_ZERO_FILLS = "0"
        SITEPATH = ""
        SIZEOF_DOUBLE = "8"
        SIZEOF_FLOAT = "4"
        SIZEOF_FPOS_T = "16"
        SIZEOF_INT = "4"
        SIZEOF_LONG = "8"
        SIZEOF_LONG_DOUBLE = "16"
        SIZEOF_LONG_LONG = "8"
        SIZEOF_OFF_T = "8"
        SIZEOF_PID_T = "4"
        SIZEOF_PTHREAD_KEY_T = "4"
        SIZEOF_PTHREAD_T = "8"
        SIZEOF_SHORT = "2"
        SIZEOF_SIZE_T = "8"
        SIZEOF_TIME_T = "8"
        SIZEOF_UINTPTR_T = "8"
        SIZEOF_VOID_P = "8"
        SIZEOF_WCHAR_T = "4"
        SIZEOF__BOOL = "1"
        SO = ".cpython-38-x86_64-linux-gnu.so"
        SOABI = "cpython-38-x86_64-linux-gnu"
        SRCDIRS = "Parser Objects Python Modules Modules/_io Programs"
        SRC_GDB_HOOKS = "../Tools/gdb/libpython.py"
        STDC_HEADERS = "1"
        STRICT_SYSV_CURSES = "/* Don't use ncurses extensions */"
        STRIPFLAG = "-s"
        SUBDIRS = ""
        SUBDIRSTOO = "Include Lib Misc"
        SYSLIBS = "-lm"
        SYS_SELECT_WITH_SYS_TIME = "1"
        TCLTK_INCLUDES = ""
        TCLTK_LIBS = ""
        TESTOPTS = ""
        TESTPATH = ""
        TESTPYTHON = "LD_LIBRARY_PATH=/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared ./python"
        TESTPYTHONOPTS = ""
        TESTRUNNER = "LD_LIBRARY_PATH=/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared ./python ../Tools/scripts/run_tests.py"
        TESTTIMEOUT = "1200"
        TIMEMODULE_LIB = "0"
        TIME_WITH_SYS_TIME = "1"
        TM_IN_SYS_TIME = "0"
        UNICODE_DEPS = "\"
        UNIVERSALSDK = ""
        UPDATE_FILE = "python3.8 ../Tools/scripts/update_file.py"
        USE_COMPUTED_GOTOS = "1"
        VERSION = "3.8"
        VPATH = ".."
        WINDOW_HAS_FLAGS = "1"
        WITH_DOC_STRINGS = "1"
        WITH_DTRACE = "1"
        WITH_DYLD = "0"
        WITH_LIBINTL = "0"
        WITH_NEXT_FRAMEWORK = "0"
        WITH_PYMALLOC = "1"
        WITH_VALGRIND = "0"
        X87_DOUBLE_ROUNDING = "0"
        XMLLIBSUBDIRS = "xml xml/dom xml/etree xml/parsers xml/sax"
        abiflags = ""
        abs_builddir = "/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared"
        abs_srcdir = "/build/python3.8-6QL2k7/python3.8-3.8.2/build-shared/.."
        base = "/mnt/d/Programming/Projects/sage/src/.venv"
        datarootdir = "/usr/share"
        exec_prefix = "/usr"
        installed_base = "/usr"
        installed_platbase = "/usr"
        multiarchsubdir = "/x86_64-linux-gnu"
        platbase = "/mnt/d/Programming/Projects/sage/src/.venv"
        prefix = "/usr"
        projectbase = "/usr/bin"
        py_version = "3.8.2"
        py_version_nodot = "38"
        py_version_short = "3.8"
        srcdir = "/usr/lib/python3.8/config-3.8-x86_64-linux-gnu"
        userbase = "/home/tobias/.local"
```



---

Comment by mkoeppe created at 2020-10-25 18:46:04

I see `MULTIARCH = "x86_64-linux-gnu"` and `multiarchsubdir = "/x86_64-linux-gnu"`.


---

Comment by mkoeppe created at 2020-10-25 18:50:53

One of these variables should be used in `_get_shared_lib_filename`. Why it is instead looking for `MULTILIB`, which indeed does not exist, should be investigated...


---

Comment by mkoeppe created at 2020-10-25 18:51:14

Let's make this a separate ticket please


---

Comment by mkoeppe created at 2020-10-26 20:16:19

This is now #30833


---

Comment by git created at 2020-10-27 14:43:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-02 18:25:06

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-11-02 18:36:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-02 19:49:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-03 00:24:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-03 00:24:53

I've now added the doctest run to the github workflow. It works in principle although there are quite a lot of failing tests (mainly because some of the system-installed libs are not discovered). In order to keep the focus of this ticket narrow, fixing this should better be done in follow-up tickets.


---

Comment by mkoeppe created at 2020-11-03 01:11:30

It has been reported that the current `src/setup.py` (in Sage 9.2) is able to install a working sagelib on top of conda (see #28745). 

I'll create a test for this in #30845, and then we can test the present ticket to make sure it does not break anything.


---

Comment by git created at 2020-11-03 12:01:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-03 19:10:59

Replying to [ticket:30371 mkoeppe]:
> - A few libraries are not contained in `distros/debian.txt` files. Should they be added? In particular, this concerns libsingular4-dev, liblinbox-dev, libratpoints-dev, libgap-dev, ecl, libpynac-dev.

Yes, let's add them in #30859. 

Some of the information that you put in the ticket description above could go as comments into the debian.txt files.


---

Comment by @tobiasdiez created at 2020-11-03 19:30:26

Thanks for opening a new ticket for this!

Concerning the conda integration, this ticket here might actually help with this. You can use pipenv on top of conda, see https://pipenv.pypa.io/en/latest/advanced/#pipenv-and-other-python-distributions.


---

Comment by git created at 2020-11-07 19:26:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-07 19:30:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-08 18:04:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-13 11:25:47

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-11-13 17:38:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-13 19:43:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-13 19:45:28

I've now merged the latest version of the dependencies, and cleaned the code.

Matthias (and others, of course), it would be nice if you could review the code (and its dependencies). I have a hard time working on other tickets as long as this ticket is not merged. So I would be grateful if that happens as soon as possible. Thanks!


---

Comment by mkoeppe created at 2020-11-13 20:02:27

See if you can get doctesting to work on this branch - by merging #30578.


---

Comment by mkoeppe created at 2020-11-14 00:31:38

Also removing `sage-env-config` from the list of installed scripts is not good. Instead please review and merge #29850 - which reassigns this script to the `sage_conf` package.


---

Comment by mkoeppe created at 2020-11-14 02:25:53

Replying to [comment:169 mkoeppe]:
> See if you can get doctesting to work on this branch - by merging #30578.
In #30578 I had to add a few more packages to `requirements.txt` that you don't have in `Pipfile` yet, so that more doctests pass.


---

Comment by @tobiasdiez created at 2020-11-14 13:19:24

Replying to [comment:170 mkoeppe]:
> Also removing `sage-env-config` from the list of installed scripts is not good. Instead please review and merge #29850 - which reassigns this script to the `sage_conf` package.

I agree #29850 is a better solution. I had a look at that ticket, but don't really feel comfortable enough with the code to review it. Sorry! However, I've now added it as a dependency of this branch, and will merge as soon as it is reviewed.


---

Comment by @tobiasdiez created at 2020-11-14 13:52:12

Replying to [comment:171 mkoeppe]:
> Replying to [comment:169 mkoeppe]:
> > See if you can get doctesting to work on this branch - by merging #30578.
> In #30578 I had to add a few more packages to `requirements.txt` that you don't have in `Pipfile` yet, so that more doctests pass.

Thanks for the pointer! I've now added these packages also to the pipfile. However, it is way beyond the scope of this ticket to make the doctest pass in the GH pipenv workflow. There are just so many things that need to be changed in order for the doctests to find the correct dependencies. For example, here are a few relevant error messages:

```
FileNotFoundError: [Errno 2] No such file or directory: '/mnt/d/Programming/Projects/sage/src/.venv/bin/gap'

RuntimeError: unable to start singular because the command 'Singular -t --ticks-per-sec 1000 --cntrlc=a' failed: The command was not found or was not executable: Singular.

RuntimeError: In order to initialize the database, /__w/sage/sage/src/.venv/share/conway_polynomials/conway_polynomials.p must exist.
```


I know that some of these errors would disappear if one use your recent progress towards installation of sage-build wheels.

Anyway, the aim of this ticket is to create a mostly-working editable install of sagelib. Making the doctests pass relative to this editable install in a venv should be subject of a follow-up ticket.


---

Comment by git created at 2020-11-14 13:52:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-14 16:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-14 20:06:46

Replying to [comment:174 gh-tobiasdiez]:
> Anyway, the aim of this ticket is to create a mostly-working editable install of sagelib. 

Most of the changes that you are doing in this ticket have really nothing to do with this goal. As I have pointed out previously, you are trying to solve the orthogonal problem of making sagelib work outside of the Sage distribution, i.e., without SAGE_LOCAL.


---

Comment by @tobiasdiez created at 2020-11-14 22:59:32

I agree. The thing is that it is currently my only way to work with sage, and thus test the editable install. But it's good that you are pushing from the other side and work on the editable install based on a working sage distribution.

So, is there something that I can still do here? I see that verifying and testing that the editable install works is important. It's just not very realistic to have a fully functional doctest without SAGE_LOCAL at the moment. However, I can also not very actively contribute to the editable install with SAGE_LOCAL.


---

Comment by mkoeppe created at 2020-11-14 23:36:50

Replying to [comment:178 gh-tobiasdiez]:
> I agree. The thing is that it is currently my only way to work with sage, and thus test the editable install. 
Is the WSL build of the Sage distribution still failing for you? Have you tried a different Linux distribution?
So far the WSL runs on GH Actions have not been very conclusive - they have failed for unrelated reasons - you could work on #30910 to improve it


---

Comment by mkoeppe created at 2020-11-14 23:43:57

Also, I am interested in a GH Actions workflow for the various new installations (venv based on requirements on top of SAGE_LOCAL, venv based on Pipfile on top of SAGE_LOCAL, conda without SAGE_LOCAL, etc.) This ticket adds something like this, but I don't like that it does Ubuntu-specific things again. We have a better way of doing such things already so that everything can be tested on all supported distributions, not just some Ubuntu. I would hope that we can add such workflows in #30845. #30859 will help with this. The powershell bits to work with system packages could also be valuable - see #30865.


---

Comment by @tobiasdiez created at 2020-11-15 12:17:22

Replying to [comment:179 mkoeppe]:
> Is the WSL build of the Sage distribution still failing for you? Have you tried a different Linux distribution?

Yes, it's still not working. In a few weeks I'll get a new PC and then will try again afresh using WSL 2.0.


---

Comment by @tobiasdiez created at 2020-11-15 12:21:29

Replying to [comment:180 mkoeppe]:
> This ticket adds something like this, but I don't like that it does Ubuntu-specific things again. We have a better way of doing such things already so that everything can be tested on all supported distributions, not just some Ubuntu.

Yes and no. Since the whole workflow only takes about 2 hours, my hope was that one can use it in the longterm to run it on each push to each branch, replacing/complementing the patchbot. But of course it could also serve as the blueprint for a complete matrix integration test suite.
Anyway, for the moment it serves as a record of the things I did locally on my system, and proofs that the editable install without SAGE_LOCAL works to a large degree.


---

Comment by @tobiasdiez created at 2020-11-17 21:39:01

After playing around with it further I was able to make most of the tests pass. There are still a few hundreds that fail (see below for details), most of which are related to issues with maxima (TypeError: unable to start maxima: End Of File (EOF). Exception style platform.) or fpylll (blocked due to https://github.com/fplll/fpylll/issues/185). Since most test pass and there are many subpackages for which all tests pass, I'd say that's enough "proof of concept" for this ticket and would leave the rest for follow-up tickets.


```
2020-11-17T19:31:00.7800025Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interacts/debugger.py  # 2 doctests failed
2020-11-17T19:31:00.7801032Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/singular.py  # 5 doctests failed
2020-11-17T19:31:00.7802028Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/maxima_lib.py  # 1 doctest failed
2020-11-17T19:31:00.7803005Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/quit.py  # 6 doctests failed
2020-11-17T19:31:00.7803974Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/maxima.py  # 144 doctests failed
2020-11-17T19:31:00.7804998Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/maxima_abstract.py  # 168 doctests failed
2020-11-17T19:31:00.7806039Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/interface.py  # 90 doctests failed
2020-11-17T19:31:00.7807034Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/expect.py  # 6 doctests failed
2020-11-17T19:31:00.7808001Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/tests.py  # 3 doctests failed
2020-11-17T19:31:00.7809010Z sage -t --random-seed=0 /__w/sage/sage/src/sage/interfaces/gap_workspace.py  # 2 doctests failed
2020-11-17T19:31:00.7810009Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/rational.pyx  # 2 doctests failed
2020-11-17T19:31:00.7810921Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/ring.pyx  # 1 doctest failed
2020-11-17T19:31:00.7811830Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/infinity.py  # 1 doctest failed
2020-11-17T19:31:00.7812754Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/real_mpfr.pyx  # 9 doctests failed
2020-11-17T19:31:00.7813669Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/real_mpfi.pyx  # 3 doctests failed
2020-11-17T19:31:00.7814600Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/complex_mpfr.pyx  # 2 doctests failed
2020-11-17T19:31:00.7815569Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/localization.py  # 1 doctest failed
2020-11-17T19:31:00.7816785Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/tests.py  # 2 doctests failed
2020-11-17T19:31:00.7817714Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/integer_ring.pyx  # 5 doctests failed
2020-11-17T19:31:00.7818771Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/polynomial/polynomial_zmod_flint.pyx  # 1 doctest failed
2020-11-17T19:31:00.7819934Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/polynomial/polynomial_quotient_ring.py  # 1 doctest failed
2020-11-17T19:31:00.7821093Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/polynomial/polynomial_modn_dense_ntl.pyx  # 6 doctests failed
2020-11-17T19:31:00.7822245Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/polynomial/polynomial_element.pyx  # 13 doctests failed
2020-11-17T19:31:00.7823414Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/polynomial/polynomial_number_field.pyx  # 19 doctests failed
2020-11-17T19:31:00.7824560Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/polynomial/multi_polynomial_ring.py  # 2 doctests failed
2020-11-17T19:31:00.7825670Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/finite_rings/residue_field.pyx  # 14 doctests failed
2020-11-17T19:31:00.7826727Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/S_unit_solver.py  # 18 doctests failed
2020-11-17T19:31:00.7827787Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/number_field_base.pyx  # 15 doctests failed
2020-11-17T19:31:00.7828969Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/class_group.py  # 2 doctests failed
2020-11-17T19:31:00.7830020Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/number_field_ideal.py  # 1 doctest failed
2020-11-17T19:31:00.7831068Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/galois_group.py  # 58 doctests failed
2020-11-17T19:31:00.7832134Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/splitting_field.py  # 28 doctests failed
2020-11-17T19:31:00.7833172Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/order.py  # 6 doctests failed
2020-11-17T19:31:00.7834186Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/number_field.py  # 33 doctests failed
2020-11-17T19:31:00.7835200Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/unit_group.py  # 1 doctest failed
2020-11-17T19:31:00.7836234Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/number_field_rel.py  # 11 doctests failed
2020-11-17T19:31:00.7837488Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/number_field_element.pyx  # 27 doctests failed
2020-11-17T19:31:00.7838576Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/number_field/bdd_height.py  # 2 doctests failed
2020-11-17T19:31:00.7839663Z sage -t --random-seed=0 /__w/sage/sage/src/sage/rings/valuation/inductive_valuation.py  # 4 doctests failed
2020-11-17T19:31:00.7840725Z sage -t --random-seed=0 /__w/sage/sage/src/sage/cpython/dict_del_by_value.pyx  # 2 doctests failed
2020-11-17T19:31:00.7841710Z sage -t --random-seed=0 /__w/sage/sage/src/sage/databases/cremona.py  # 2 doctests failed
2020-11-17T19:31:00.7842673Z sage -t --random-seed=0 /__w/sage/sage/src/sage/groups/cubic_braid.py  # 6 doctests failed
2020-11-17T19:31:00.7843635Z sage -t --random-seed=0 /__w/sage/sage/src/sage/sandpiles/sandpile.py  # 5 doctests failed
2020-11-17T19:31:00.7844616Z sage -t --random-seed=0 /__w/sage/sage/src/sage/coding/gabidulin_code.py  # 1 doctest failed
2020-11-17T19:31:00.7845566Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/cmdline.py  # 59 doctests failed
2020-11-17T19:31:00.7846502Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/benchmark.py  # 4 doctests failed
2020-11-17T19:31:00.7847448Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/gap_packages.py  # 1 doctest failed
2020-11-17T19:31:00.7848644Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/judson-abstract-algebra/galois-sage.py  # 9 doctests failed
2020-11-17T19:31:00.7850157Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/judson-abstract-algebra/fields-sage.py  # 17 doctests failed
2020-11-17T19:31:00.7851577Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/judson-abstract-algebra/domains-sage.py  # 5 doctests failed
2020-11-17T19:31:00.7853321Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py  # 1 doctest failed
2020-11-17T19:31:00.7855341Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py  # 3 doctests failed
2020-11-17T19:31:00.7857340Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py  # 1 doctest failed
2020-11-17T19:31:00.7859360Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/integration_doctest.py  # 1 doctest failed
2020-11-17T19:31:00.7861360Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py  # 2 doctests failed
2020-11-17T19:31:00.7863355Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py  # 3 doctests failed
2020-11-17T19:31:00.7865352Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py  # 2 doctests failed
2020-11-17T19:31:00.7867492Z sage -t --random-seed=0 /__w/sage/sage/src/sage/tests/books/computational-mathematics-with-sagemath/sol/graphique_doctest.py  # 8 doctests failed
2020-11-17T19:31:00.7868993Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/configuration.py  # 1 doctest failed
2020-11-17T19:31:00.7869942Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/image.py  # 4 doctests failed
2020-11-17T19:31:00.7870875Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/interpreter.py  # 7 doctests failed
2020-11-17T19:31:00.7871818Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/preparse.py  # 1 doctest failed
2020-11-17T19:31:00.7872750Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/ipython_tests.py  # 1 doctest failed
2020-11-17T19:31:00.7873726Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/rich_output/pretty_print.py  # 3 doctests failed
2020-11-17T19:31:00.7874739Z sage -t --random-seed=0 /__w/sage/sage/src/sage/repl/ipython_kernel/install.py  # 1 doctest failed
2020-11-17T19:31:00.7875703Z sage -t --random-seed=0 /__w/sage/sage/src/sage/doctest/forker.py  # 1 doctest failed
2020-11-17T19:31:00.7876633Z sage -t --random-seed=0 /__w/sage/sage/src/sage/doctest/control.py  # 2 doctests failed
2020-11-17T19:31:00.7883133Z sage -t --random-seed=0 /__w/sage/sage/src/sage/doctest/test.py  # 3 doctests failed
2020-11-17T19:31:00.7884402Z sage -t --random-seed=0 /__w/sage/sage/src/sage/libs/singular/function.pyx  # 1 doctest failed
2020-11-17T19:31:00.7885406Z sage -t --random-seed=0 /__w/sage/sage/src/sage/libs/pari/convert_sage.pyx  # 10 doctests failed
2020-11-17T19:31:00.7886362Z sage -t --random-seed=0 /__w/sage/sage/src/sage/libs/pari/__init__.py  # 12 doctests failed
2020-11-17T19:31:00.7887265Z sage -t --random-seed=0 /__w/sage/sage/src/sage/libs/pari/tests.py  # 9 doctests failed
2020-11-17T19:31:00.7888179Z sage -t --random-seed=0 /__w/sage/sage/src/sage/libs/pynac/pynac.pyx  # 1 doctest failed
2020-11-17T19:31:00.7889240Z sage -t --random-seed=0 /__w/sage/sage/src/sage/dynamics/arithmetic_dynamics/generic_ds.py  # 10 doctests failed
2020-11-17T19:31:00.7890445Z sage -t --random-seed=0 /__w/sage/sage/src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 25 doctests failed
2020-11-17T19:31:00.7891469Z sage -t --random-seed=0 /__w/sage/sage/src/sage/arith/misc.py  # 20 doctests failed
2020-11-17T19:31:00.7892598Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.py  # 3 doctests failed
2020-11-17T19:31:00.7893789Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/product_projective/space.py  # 1 doctest failed
2020-11-17T19:31:00.7895096Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/product_projective/rational_point.py  # 1 doctest failed
2020-11-17T19:31:00.7896170Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/affine/affine_space.py  # 1 doctest failed
2020-11-17T19:31:00.7897209Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/generic/algebraic_scheme.py  # 1 doctest failed
2020-11-17T19:31:00.7898340Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/riemann_surfaces/riemann_surface.py  # 31 doctests failed
2020-11-17T19:31:00.7899522Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/projective/projective_rational_point.py  # 4 doctests failed
2020-11-17T19:31:00.7900680Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/projective/projective_space.py  # 1 doctest failed
2020-11-17T19:31:00.7901771Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/toric/toric_subscheme.py  # 11 doctests failed
2020-11-17T19:31:00.7902793Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/toric/divisor.py  # 2 doctests failed
2020-11-17T19:31:00.7903768Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/toric/points.py  # 1 doctest failed
2020-11-17T19:31:00.7904739Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/toric/variety.py  # 4 doctests failed
2020-11-17T19:31:00.7905707Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/toric/ideal.py  # 43 doctests failed
2020-11-17T19:31:00.7906825Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/heegner.py  # 33 doctests failed
2020-11-17T19:31:00.7907884Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/kraus.py  # 4 doctests failed
2020-11-17T19:31:00.7908978Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/constructor.py  # 4 doctests failed
2020-11-17T19:31:00.7910128Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/gal_reps_number_field.py  # 2 doctests failed
2020-11-17T19:31:00.7911278Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/ell_rational_field.py  # 14 doctests failed
2020-11-17T19:31:00.7912397Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/isogeny_class.py  # 2 doctests failed
2020-11-17T19:31:00.7913509Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/ell_number_field.py  # 26 doctests failed
2020-11-17T19:31:00.7914601Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/gal_reps.py  # 2 doctests failed
2020-11-17T19:31:00.7915708Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/isogeny_small_degree.py  # 1 doctest failed
2020-11-17T19:31:00.7916803Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/ell_egros.py  # 4 doctests failed
2020-11-17T19:31:00.7918998Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py  # 1 doctest failed
2020-11-17T19:31:00.7920093Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/elliptic_curves/ell_field.py  # 2 doctests failed
2020-11-17T19:31:00.7921146Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/plane_conics/con_field.py  # 7 doctests failed
2020-11-17T19:31:00.7922203Z sage -t --random-seed=0 /__w/sage/sage/src/sage/schemes/plane_conics/con_number_field.py  # 3 doctests failed
2020-11-17T19:31:00.7923188Z sage -t --random-seed=0 /__w/sage/sage/src/sage/features/__init__.py  # 1 doctest failed
2020-11-17T19:31:00.7924137Z sage -t --random-seed=0 /__w/sage/sage/src/sage/calculus/desolvers.py  # 8 doctests failed
2020-11-17T19:31:00.7925128Z sage -t --random-seed=0 /__w/sage/sage/src/sage/calculus/calculus.py  # 25 doctests failed
2020-11-17T19:31:00.7926071Z sage -t --random-seed=0 /__w/sage/sage/src/sage/crypto/lattice.py  # 1 doctest failed
2020-11-17T19:31:00.7927011Z sage -t --random-seed=0 /__w/sage/sage/src/sage/combinat/tutorial.py  # 1 doctest failed
2020-11-17T19:31:00.7927975Z sage -t --random-seed=0 /__w/sage/sage/src/sage/combinat/combinat.py  # 5 doctests failed
2020-11-17T19:31:00.7929092Z sage -t --random-seed=0 /__w/sage/sage/src/sage/combinat/degree_sequences.pyx  # 1 doctest failed
2020-11-17T19:31:00.7930148Z sage -t --random-seed=0 /__w/sage/sage/src/sage/categories/algebra_functor.py  # 5 doctests failed
2020-11-17T19:31:00.7931175Z sage -t --random-seed=0 /__w/sage/sage/src/sage/categories/number_fields.py  # 1 doctest failed
2020-11-17T19:31:00.7932168Z sage -t --random-seed=0 /__w/sage/sage/src/sage/categories/rings.py  # 12 doctests failed
2020-11-17T19:31:00.7933122Z sage -t --random-seed=0 /__w/sage/sage/src/sage/categories/primer.py  # 1 doctest failed
2020-11-17T19:31:00.7934130Z sage -t --random-seed=0 /__w/sage/sage/src/sage/categories/quotient_fields.py  # 7 doctests failed
2020-11-17T19:31:00.7935102Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modular/cusps_nf.py  # 1 doctest failed
2020-11-17T19:31:00.7936063Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modular/etaproducts.py  # 10 doctests failed
2020-11-17T19:31:00.7937057Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modular/modsym/p1list_nf.py  # 1 doctest failed
2020-11-17T19:31:00.7938011Z sage -t --random-seed=0 /__w/sage/sage/src/sage/structure/formal_sum.py  # 1 doctest failed
2020-11-17T19:31:00.7938985Z sage -t --random-seed=0 /__w/sage/sage/src/sage/structure/element.pyx  # 5 doctests failed
2020-11-17T19:31:00.7940062Z sage -t --random-seed=0 /__w/sage/sage/src/sage/structure/dynamic_class.py  # 1 doctest failed
2020-11-17T19:31:00.7941022Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/nested_class.pyx  # 1 doctest failed
2020-11-17T19:31:00.7941915Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/trace.py  # 3 doctests failed
2020-11-17T19:31:00.7942828Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/sage_ostools.pyx  # 1 doctest failed
2020-11-17T19:31:00.7943764Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/functional.py  # 1 doctest failed
2020-11-17T19:31:00.7944692Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/edit_module.py  # 1 doctest failed
2020-11-17T19:31:00.7945625Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/temporary_file.py  # 1 doctest failed
2020-11-17T19:31:00.7946578Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/lazy_attribute.pyx  # 1 doctest failed
2020-11-17T19:31:00.7947551Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/sageinspect.py  # 13 doctests failed
2020-11-17T19:31:00.7948497Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/sagedoc.py  # 3 doctests failed
2020-11-17T19:31:00.7949390Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/compat.py  # 1 doctest failed
2020-11-17T19:31:00.7950304Z sage -t --random-seed=0 /__w/sage/sage/src/sage/misc/sphinxify.py  # 4 doctests failed
2020-11-17T19:31:00.7951326Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/hypergeometric.py  # 7 doctests failed
2020-11-17T19:31:00.7952357Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/bessel.py  # 7 doctests failed
2020-11-17T19:31:00.7953305Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/gamma.py  # 2 doctests failed
2020-11-17T19:31:00.7954306Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/special.py  # 1 doctest failed
2020-11-17T19:31:00.7955238Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/trig.py  # 1 doctest failed
2020-11-17T19:31:00.7956168Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/error.py  # 7 doctests failed
2020-11-17T19:31:00.7957101Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/log.py  # 6 doctests failed
2020-11-17T19:31:00.7958207Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/other.py  # 15 doctests failed
2020-11-17T19:31:00.7959216Z sage -t --random-seed=0 /__w/sage/sage/src/sage/functions/orthogonal_polys.py  # 11 doctests failed
2020-11-17T19:31:00.7960272Z sage -t --random-seed=0 /__w/sage/sage/src/sage/geometry/polyhedron/parent.py  # 2 doctests failed
2020-11-17T19:31:00.7961352Z sage -t --random-seed=0 /__w/sage/sage/src/sage/geometry/polyhedron/palp_database.py  # 1 doctest failed
2020-11-17T19:31:00.7962568Z sage -t --random-seed=0 /__w/sage/sage/src/sage/algebras/quaternion_algebra_element.py  # 4 doctests failed
2020-11-17T19:31:00.7963697Z sage -t --random-seed=0 /__w/sage/sage/src/sage/algebras/quatalg/quaternion_algebra.py  # 6 doctests failed
2020-11-17T19:31:00.7964873Z sage -t --random-seed=0 /__w/sage/sage/src/sage/algebras/quatalg/quaternion_algebra_element.pyx  # 38 doctests failed
2020-11-17T19:31:00.7965949Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modules/free_module.py  # 5 doctests failed
2020-11-17T19:31:00.7966956Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modules/free_module_morphism.py  # 3 doctests failed
2020-11-17T19:31:00.7967988Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modules/free_module_integer.py  # 57 doctests failed
2020-11-17T19:31:00.7969027Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modules/vector_space_morphism.py  # 3 doctests failed
2020-11-17T19:31:00.7970041Z sage -t --random-seed=0 /__w/sage/sage/src/sage/modules/fg_pid/fgp_module.py  # 3 doctests failed
2020-11-17T19:31:00.7971051Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/expression.pyx  # 17 doctests failed
2020-11-17T19:31:00.7972071Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/assumptions.py  # 3 doctests failed
2020-11-17T19:31:00.7973064Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/constants_c.pyx  # 1 doctest failed
2020-11-17T19:31:00.7974140Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/maxima_wrapper.py  # 2 doctests failed
2020-11-17T19:31:00.7975123Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/relation.py  # 4 doctests failed
2020-11-17T19:31:00.7976102Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/constants.py  # 17 doctests failed
2020-11-17T19:31:00.7977173Z sage -t --random-seed=0 /__w/sage/sage/src/sage/symbolic/expression_conversions.py  # 10 doctests failed
2020-11-17T19:31:00.7978261Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/comparability.pyx  # 1 doctest failed
2020-11-17T19:31:00.7979313Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/digraph_generators.py  # 8 doctests failed
2020-11-17T19:31:00.7980236Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/graph.py  # Timed out
2020-11-17T19:31:00.7981184Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/connectivity.pyx  # 2 doctests failed
2020-11-17T19:31:00.7982192Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/graph_generators.py  # Timed out
2020-11-17T19:31:00.7983217Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/hypergraph_generators.py  # 9 doctests failed
2020-11-17T19:31:00.7984259Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/graph_coloring.pyx  # 2 doctests failed
2020-11-17T19:31:00.7985206Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/genus.pyx  # 1 doctest failed
2020-11-17T19:31:00.7986147Z sage -t --random-seed=0 /__w/sage/sage/src/sage/graphs/generic_graph_pyx.pyx  # 2 doctests failed
2020-11-17T19:31:00.7987202Z sage -t --random-seed=0 /__w/sage/sage/src/sage/sets/set_from_iterator.py  # Timed out (and interrupt failed)
2020-11-17T19:31:00.7988200Z sage -t --random-seed=0 /__w/sage/sage/src/sage/matrix/matrix1.pyx  # 3 doctests failed
2020-11-17T19:31:00.7989131Z sage -t --random-seed=0 /__w/sage/sage/src/sage/matrix/matrix2.pyx  # 3 doctests failed
2020-11-17T19:31:00.7990123Z sage -t --random-seed=0 /__w/sage/sage/src/sage/matrix/matrix_rational_dense.pyx  # 1 doctest failed
2020-11-17T19:31:00.7991189Z sage -t --random-seed=0 /__w/sage/sage/src/sage/matrix/matrix_integer_dense.pyx  # 14 doctests failed
2020-11-17T19:31:00.7992217Z sage -t --random-seed=0 /__w/sage/sage/src/sage/matrix/matrix_symbolic_dense.pyx  # 1 doctest failed
```

https://github.com/tobiasdiez/sage/runs/1413136300?check_suite_focus=true


---

Comment by git created at 2020-11-18 09:56:02

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-09 02:16:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-09 09:41:13

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2020-12-09 09:42:54

From my side, this is actually ready for review. I've been using it now constantly the last few weeks and it is working. Or do you have something that I should be improving/working on?


---

Comment by git created at 2020-12-20 22:34:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-20 22:36:33

Merged the latest develop branch.


---

Comment by @tobiasdiez created at 2020-12-20 22:36:33

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-20 23:07:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-20 23:08:22

New commits:


---

Comment by mkoeppe created at 2020-12-21 18:05:23

Replying to [comment:156 mkoeppe]:
> It has been reported that the current `src/setup.py` (in Sage 9.2) is able to install a working sagelib on top of conda (see #28745). 
> 
> I'll create a test for this in #30845, and then we can test the present ticket to make sure it does not break anything.

Ensuring that the feature of installing sagelib on top of conda is not broken is a prerequisite for merging this ticket.

To move this ticket forward, could you help me with this GH Actions test?  (This should be on top of #30944, which still needs review)

I think there should be one new workflow for all tests that do not build the Sage distribution (no `build/pkgs`).


---

Comment by @tobiasdiez created at 2020-12-21 20:17:12

Sure, I will have a look at this. Could you by extending #30845 to include in more detail how the manual workflow with conda looks like (I've no experience with conda) and why #30944 is needed.

Maybe it's a good idea to review how the GH workflows are structured and revise this if necessary. For example, focus more on the purpose vs how it done, e.g. "test that building packages in build/pgks" works, "test that sagelib installed on top of various setups works". For the latter, my hope with pipenv was actually that one can easily run it on every push on every branch as a gateway in addition to the patchbot (since the time it takes is very minimal, time of setup of < 1h, + time for doctests).


---

Comment by mkoeppe created at 2020-12-21 23:25:55

Replying to [comment:201 gh-tobiasdiez]:
> Sure, I will have a look at this. Could you by extending #30845 to include in more detail how the manual workflow with conda looks like (I've no experience with conda) and

Done.

>  why #30944 is needed.

Well, it will be testing something that currently happens to work but is not automatically tested.

> Maybe it's a good idea to review how the GH workflows are structured and revise this if necessary. 

Sure, I'll be happy about more eyes on the workflows.

> For example, focus more on the purpose vs how it done

All workflows test from-scratch builds of the Sage distribution. 
Two workflows separately test optional / experimental packages. That's really all.


---

Comment by mkoeppe created at 2020-12-21 23:29:05

Replying to [comment:201 gh-tobiasdiez]:
> "test that sagelib installed on top of various setups works". For the latter, my hope with pipenv was actually that one can easily run it on every push on every branch as a gateway in addition to the patchbot (since the time it takes is very minimal, time of setup of < 1h, + time for doctests).

An incremental build setup based on Docker has already been developed, which drives the current [GitLab](GitLab) workflow. I'd recommend to start from there (it needs attention) instead of developing another thing from scratch... Take a look at #29536


---

Comment by git created at 2020-12-23 13:05:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-23 13:23:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-06 12:11:16

Since now most dependencies are merged in the develop branch, this ticket is now definitely ready for review.


---

Comment by git created at 2021-01-09 14:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-09 15:02:23

Matthias, I have a question: the current code works very well for system-installed packages. However, there are a few packages that are required but for which system-installed versions are not currently not supported (e.g. ecl). How could I use the sage-built versions of these packages for the built process of sagelib, i.e. for `pip install -e .`?

Take for example the import `cdef extern from "ecl/ecl.h"` in `libs/ecl.pxd`. 
I guess one needs to pass the path of `local/include/ecl` as argument to the C++ compiler. How is currently done?


---

Comment by mkoeppe created at 2021-01-10 00:39:19

Replying to [comment:209 gh-tobiasdiez]:
> Take for example the import `cdef extern from "ecl/ecl.h"` in `libs/ecl.pxd`. 
> I guess one needs to pass the path of `local/include/ecl` as argument to the C++ compiler. How is currently done? 

We install all packages that are not accepted from the system into $SAGE_LOCAL, and scripts such as `sage-env` and `sage-build-env` set up environment variables such as `LIBRARY_PATH` and `CPATH` so that compilers find stuff.  Configuration for Cython is somewhat separate - you are already familiar with the `cython_aliases` function.

For ECL, there's ticket #30770 to make this configuration more flexible.


---

Comment by mkoeppe created at 2021-01-10 00:41:07

Also, if you are able to use system packages for which we do not have system package detection yet (`spkg-configure.m4`), you can join the effort in #27330.


---

Comment by mkoeppe created at 2021-01-10 00:44:38

Replying to [comment:209 gh-tobiasdiez]:
>  How could I use the sage-built versions of these packages for the built process of sagelib, i.e. for `pip install -e .`?

One part of the answer to this involves the `sage_conf` package: Installing it into your virtual environment provides `sage-env-config` and the `sage_conf` module. So you may want to add it to `Pipfile`. (See also #30913).


---

Comment by @tobiasdiez created at 2021-01-10 12:48:59

Replying to [comment:210 mkoeppe]:
> For ECL, there's ticket #30770 to make this configuration more flexible.

Thanks! I'll see if I can make progress towards this.


---

Comment by @tobiasdiez created at 2021-01-10 12:49:41

Replying to [comment:212 mkoeppe]:
> One part of the answer to this involves the `sage_conf` package: Installing it into your virtual environment provides `sage-env-config` and the `sage_conf` module. So you may want to add it to `Pipfile`. (See also #30913).

That's already done:

```
+[dev-packages.8c46424]
+path = "./../build/pkgs/sage_conf/src"
+editable = true
```



---

Comment by git created at 2021-01-11 14:59:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 12:42:02

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-01-12 12:54:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 13:03:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 13:08:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 13:15:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 13:21:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 17:10:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 17:22:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 19:58:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-12 20:38:50

Replying to [comment:210 mkoeppe]:
> For ECL, there's ticket #30770 to make this configuration more flexible.

This seems to work now. Thanks for you help!

Two follow-up questions:
1. Is there a make target similar to sagelib-build-deps that doesn't install pythonic packages such as cython.
2. Why doesn't sagelib-build-deps install maxima?


---

Comment by git created at 2021-01-12 21:39:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 22:12:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-12 23:10:19

Replying to [comment:228 gh-tobiasdiez]:
> 1. Is there a make target similar to sagelib-build-deps that doesn't install pythonic packages such as cython.

Not yet. #30896 will go into this direction

> 2. Why doesn't sagelib-build-deps install maxima?

maxima is only needed at runtime of Sage, not while installing sagelib.


---

Comment by git created at 2021-01-13 01:11:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-13 10:42:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-13 12:13:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-13 13:11:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-13 15:53:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-13 15:56:33

Thanks for the help! I've now improved the github workflow and the doctest pass now (except a handful). So I would appreciate if this ticket could be review!

https://github.com/sagemath/sagetrac-mirror/actions?query=workflow%3A%22Build+%26+Test+using+pipenv%22


---

Comment by git created at 2021-01-14 08:27:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-14 10:09:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-14 12:14:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-19 15:47:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-21 01:40:37

Instead of introducing a new environment variable `SAGE_NUM_BUILD_JOBS`, probably best to use `SAGE_NUM_THREADS`, which is used already in the same source tree.


---

Comment by @tobiasdiez created at 2021-01-21 11:17:03

Replying to [comment:242 mkoeppe]:
> Instead of introducing a new environment variable `SAGE_NUM_BUILD_JOBS`, probably best to use `SAGE_NUM_THREADS`, which is used already in the same source tree.

Ok, done!


---

Comment by git created at 2021-01-21 11:28:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-21 13:38:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-21 16:08:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-22 10:16:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-22 12:02:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-22 20:53:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-22 21:06:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-23 10:39:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-23 14:49:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-02 17:55:11

I think it should be done on top of #30913


---

Comment by @tobiasdiez created at 2021-02-02 19:34:15

Since the pipfile in this ticket is more uptodate and is welltested (manually and through the added github action), I would actually argue that #30913 should be on top of this ticket.

Moreover, #30770 is the only open dependency of this ticket, so I guess its also more realistic to get this in first.


---

Comment by mkoeppe created at 2021-02-02 21:02:56

This approach would also work. But I am skeptical about checking in the `Pipfile.lock`. Stuff for nightmare merge conflicts for everyone. I think it would be better if this was an ignored file.


---

Comment by mkoeppe created at 2021-02-02 21:08:05

When the next beta comes out (hopefully soon), let's rebase it on top of it (and #30770). The commit history is a bit too wild


---

Comment by mkoeppe created at 2021-02-02 21:11:39

Also, could you please:
- clean up the ticket description 
- move documentation items from there to the manuals (installation and/or developer's manual) 
- move the remaining issues to new or existing tickets


---

Comment by mkoeppe created at 2021-02-02 21:11:39

Changing priority from major to critical.


---

Comment by @tobiasdiez created at 2021-02-03 13:15:22

Replying to [comment:256 mkoeppe]:
> But I am skeptical about checking in the `Pipfile.lock`. Stuff for nightmare merge conflicts for everyone. I think it would be better if this was an ignored file.

Without the lock file you wouldn't get a reproducible virtual environment, since pipenv would always use the latest versions (that are compatible with each other). Moreover, the lock file is normally not changed, except if you call `pipenv update`. 
The workflow to update Python packages would then look as follows:
- Run `pipenv update`
- Test
- If everything is fine, create ticket updating pipfile.lock and create a ticket for each updated dependency that is also listed in sage's build/pgks folder.

Will have a look at the other todo's you mention.


---

Comment by @tobiasdiez created at 2021-02-04 22:34:23

Cleaned up the ticket description and added a bit of documentation. Since this is still somewhat experimental, I've only put it in the coding basics of the development doc. I guess with the recent changes and support of virtual environments, it might soon be time to update the recommended way of setting up a development platform.


---

Comment by git created at 2021-02-04 22:34:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-05 04:28:02

Replying to [comment:260 gh-tobiasdiez]:
> The workflow to update Python packages would then look as follows [...]

I would say it's not a good idea to try to change the developer workflow regarding package upgrades as part of this ticket.


---

Comment by @tobiasdiez created at 2021-02-05 13:21:54

I agree, that was more meant to illustrate possible applications of the new pipenv environment (and the lockfile for that purpose).


---

Comment by mkoeppe created at 2021-02-05 19:37:39

OK. I have created #31346 as a place for this.


---

Comment by mkoeppe created at 2021-02-05 20:02:59

Regarding the documentation: "After following the normal procedure of setting up your local development environment" -- I think we should be explicit about requiring the full Sage distribution to be built first.  We cannot support experimental workflows as you (still) describe them in the ticket description.


---

Comment by git created at 2021-02-05 21:17:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-05 21:18:08

Sure!


---

Comment by git created at 2021-02-05 23:51:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-06 00:27:00

I've moved the part of the ticket description describing the experimental workflow on bare ubuntu to #31347.


---

Comment by mkoeppe created at 2021-02-07 20:49:15

9.3.beta7 is out, time for rebasing


---

Comment by git created at 2021-02-07 22:09:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-07 22:17:48

Nice, thanks for letting me know. I've merged the latest develop branch. The history of this branch still needs to be cleanup up, but let's do this after positive review.


---

Comment by mkoeppe created at 2021-02-07 22:43:02

Could you:
- remove the change to `tox.ini` please?
- Rename `sage_build_ext` and move it to a new module of `sage_setup.command` (and document what is different to the existing `sage_build_ext`)


---

Comment by mkoeppe created at 2021-02-07 23:08:46

In the new CI workflows:
 - For mac: I do not understand the line: `brew install pari`
 - For mac: Instead of setting `PKG_CONFIG_PATH` manually, perhaps use `.homebrew-build-env` because this is what `configure` suggests users to use
 - For linux: Why `make maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` (it is not done in the mac workflow). Should we create a `make` target that corresponds to what is needed?
 - For linux: Could you elaborate on "# Set SAGE_LOCAL (required for gap)"

Could you review and add comments to the file please?


---

Comment by mkoeppe created at 2021-02-07 23:15:33

Also, as #30589 has been merged, probably best to switch from python 3.8 to 3.9 here too


---

Comment by mkoeppe created at 2021-02-07 23:21:09

Also #30912 will bring merge conflicts that are best to resolve now


---

Comment by mkoeppe created at 2021-02-08 01:23:25

Another conflict from the current version of #30770.


---

Comment by mkoeppe created at 2021-02-08 01:32:55

Also `create_extension` duplicates some of the code in `sage_build_cython.create_extension`. In particular, it should not use `numpy.get_include()` directly but rather use `sage.env.sage_include_directories` (note #31333 for a related change).


---

Comment by mkoeppe created at 2021-02-08 02:20:20

I have tested this ticket (on top of #31335, which fixes macOS-specific problems, and resolving the mentioned merge conflicts); following the instructions from the added documentation, `pipenv install` leads to `ERROR: Couldn't install package: cypari2`.

The first error leading to this is:

```
  [1/7] Cythonizing cypari2/closure.pyx

  Error compiling Cython file:
  ------------------------------------------------------------
  ...
  #                  http://www.gnu.org/licenses/
  #*****************************************************************************

  from __future__ import absolute_import, division, print_function

  from cysignals.signals cimport sig_on, sig_off, sig_block, sig_unblock, sig_error
  ^
  ------------------------------------------------------------

  cypari2/closure.pyx:36:0: 'cysignals/signals.pxd' not found

```



---

Comment by mkoeppe created at 2021-02-08 02:36:46

The specific issue in `cypari2` is probably https://github.com/sagemath/cypari2/issues/93 (tracked in #30922).

But overall I think it is unrealistic for these instructions to work. 
Let's use more restrictive instructions, in which `pipenv` is used from within `sage --sh`. Then one can at least assume that all libraries are available.


---

Comment by mkoeppe created at 2021-02-08 02:40:53

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-02-08 02:43:48

(Something like `../sage -sh -c 'PIP_FIND_LINKS=file://$(cd .. && pwd)/local/var/lib/sage/wheels pipenv install -v -v'` similar to what I am testing in #30913.)


---

Comment by @tobiasdiez created at 2021-02-08 12:38:20

Thanks for the review!
Will address most of your points later.

Replying to [comment:276 mkoeppe]:
>  - For linux: Could you elaborate on "# Set SAGE_LOCAL (required for gap)"

Without this line one gets the following error:


```
Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py", line 1468, in __init__
        self._name = parent._create(value, name=name)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/interface.py", line 500, in _create
        self.set(name, value)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 1421, in set
        self._eval_line(cmd, allow_use_file=True)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 790, in _eval_line
        self._start()
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 1254, in _start
        gap_reset_workspace(verbose=False)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 1587, in gap_reset_workspace
        g.eval('SetUserPreference("HistoryMaxLines", 30)')
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 587, in eval
        result = Expect.eval(self, input_line, **kwds)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py", line 1381, in eval
        return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py", line 1381, in <listcomp>
        return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 790, in _eval_line
        self._start()
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/gap.py", line 1259, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py", line 520, in _start
        raise RuntimeError("unable to start %s: %s" % (self.name(), msg))
    RuntimeError: unable to start gap: End Of File (EOF). Exception style platform.
    Gap finished running /__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap -r -b -p -T -E -o 401m -s 401m -m 64m /__w/sagetrac-mirror/sagetrac-mirror/src/sage/ext_data/gap/sage.g
    command: /__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap
    args: ['/__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap', '-r', '-b', '-p', '-T', '-E', '-o', '401m', '-s', '401m', '-m', '64m', '/__w/sagetrac-mirror/sagetrac-mirror/src/sage/ext_data/gap/sage.g']
    buffer (last 100 chars): b''
    before (last 100 chars): b'Set the environment variable SAGE_LOCAL.\r\n'
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: 1
    flag_eof: True
    pid: 3124
    child_fd: 26
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile(b'gap> ')
```

I guess the current github workflows don't see this as everything is invoked in one tox command and not in multiple steps (and enviroment variables are only active in each step).


---

Comment by @tobiasdiez created at 2021-02-08 12:45:02

Concerning the cypari error, I have no clue what is needed for it to compile on mac. It's also strange that it works on the github action (for mac as well as linux) but not on your system. cysignals is actually declared in the pipenv file, so it should be installed.
The simplest solution would be if cypari would publish wheels on pypi.

> But overall I think it is unrealistic for these instructions to work. 

It's not unrealistic, it is working very well for Linux.


---

Comment by @tobiasdiez created at 2021-02-08 12:59:02

Replying to [comment:276 mkoeppe]:
>  - For linux: Why `make maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` (it is not done in the mac workflow). Should we create a `make` target that corresponds to what is needed?

That's the only way I found to install these packages into `SAGE_SHARE`. Will add it also to the mac workflow. I cannot judge if it would make sense to add a special make target for it, especially since you are working on making these packages normal python packages.


---

Comment by mkoeppe created at 2021-02-08 17:55:26

Replying to [comment:285 gh-tobiasdiez]:
> Replying to [comment:276 mkoeppe]:
> >  - For linux: Could you elaborate on "# Set SAGE_LOCAL (required for gap)"
> 
> Without this line one gets the following error:
> 
> {{{
> ...
>         Expect._start(self, "Failed to start GAP.")
>       File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py", line 520, in _start
> ...
> }}}
> I guess the current github workflows don't see this as everything is invoked in one tox command and not in multiple steps (and enviroment variables are only active in each step).

OK, I see. 

There are two ways to fix this:

- as described in #30818 ("Set environment for subprocesses invoked by Sage").  Currently subprocesses (such as the gap process invoked by the pexpect-based gap interface) rely on `sage-env` being sourced
- using `pipenv run sage -t` instead of `pipenv run sage-runtests`, which uses `sage-env`.


---

Comment by @tobiasdiez created at 2021-02-08 18:09:55

I've added it to #29644 (which is part of #30818).


---

Comment by mkoeppe created at 2021-02-08 18:21:06

Replying to [comment:287 gh-tobiasdiez]:
> Replying to [comment:276 mkoeppe]:
> >  - For linux: Why `make maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` (it is not done in the mac workflow). Should we create a `make` target that corresponds to what is needed?
> 
> That's the only way I found to install these packages into `SAGE_SHARE`. Will add it also to the mac workflow. I cannot judge if it would make sense to add a special make target for it, especially since you are working on making these packages normal python packages.

I've opened #31362 for this - which will add `make all-sage-local`.


---

Comment by @tobiasdiez created at 2021-02-08 20:58:29

Thanks!
Concerning the above cysignals problem, you can try to run `pipenv run pip install cysignals` and then `pipenv install` again. Similarly, `pipenv run pip install gmpy2==2.1.0b5` might be necessary if you have problems with the installation of pplpy. Let me know if this helps and I will add it to the documentation.


---

Comment by git created at 2021-02-08 21:11:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 21:12:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 21:19:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 21:28:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 21:51:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 21:52:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 22:02:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 22:16:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 22:35:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 22:36:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 22:37:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 22:42:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-02-08 22:50:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 23:07:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-02-08 23:22:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 23:25:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-08 23:38:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-09 01:01:07

Replying to [comment:290 mkoeppe]:
> Replying to [comment:287 gh-tobiasdiez]:
> > Replying to [comment:276 mkoeppe]:
> > >  - For linux: Why `make maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` (it is not done in the mac workflow). Should we create a `make` target that corresponds to what is needed?
> > 
> > That's the only way I found to install these packages into `SAGE_SHARE`. Will add it also to the mac workflow. I cannot judge if it would make sense to add a special make target for it, especially since you are working on making these packages normal python packages.
> 
> I've opened #31362 for this - which will add `make all-sage-local`.

OK, the top-level target is now `make build-local`.


---

Comment by mkoeppe created at 2021-02-09 01:26:49

Replying to [comment:289 gh-tobiasdiez]:
> I've added it to #29644 (which is part of #30818).
Thanks. Do you plan to work on it? Otherwise a quick fix is to use `pipenv run sage -t` instead of `pipenv run sage-runtests` as I wrote above.


---

Comment by mkoeppe created at 2021-02-09 06:57:05

Replying to [comment:286 gh-tobiasdiez]:
> Concerning the cypari error, I have no clue what is needed for it to compile on mac. 

Well it certainly needs the PARI library! When running `pipenv` outside of the environment set using `sage --sh`, it depends on everything already installed in the system. 

That's why I am saying the instructions to the users should run `pipenv` within that shell.


---

Comment by git created at 2021-02-09 10:04:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 10:16:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 10:19:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 10:21:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 11:17:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 11:18:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-09 11:58:05

Is it actually desired that tox local-homebrew installs a fresh homebrew in the tox folder (if I'm not misreading the logs). Is there a way to use the system's homebrew?


---

Comment by git created at 2021-02-09 13:34:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 14:28:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 16:07:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-09 17:11:50

Replying to [comment:318 gh-tobiasdiez]:
> Is it actually desired that tox local-homebrew installs a fresh homebrew in the tox folder

Yes, that's by design

> Is there a way to use the system's homebrew?

From tox.ini comments:

```
    # The variant "local-homebrew-macos-usrlocal" uses the global installation in /usr/local
    # instead.  It may install packages or update packages.  It will not remove packages.
    # Use at your own risk.
```



---

Comment by @tobiasdiez created at 2021-02-09 17:57:23

Thanks! That is working nicely.

I think I've now addressed all your comments and suggestions.

The only thing is that since merging the latest develop branch the sage packages (installed via tox) are no longer found when running `pipenv install`. At the commit https://github.com/sagemath/sagetrac-mirror/commit/4bdfef1b21da9f376cfd3c096cb9932fe5334e4e this was working, but stopped after I've merged the develop branch. Now packages such as linbox, singular and gap are still compiled by sage's make, but pkgconfig (in sage.env) cannot find them any longer and thus the c++ compilation stopped working. I don't have these problems locally, where I don't use tox. Do you have an idea which recent changes are the origin of this issue?

I've also tried your suggestion with `sage -sh pipenv` but run into several issues. I guess the problem is that pipenv is trying to reuse sages virtual environment.


---

Comment by git created at 2021-02-09 17:58:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 18:10:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-09 18:49:57

...never touch LD_LIBRARY_PATH... it's always wrong


---

Comment by mkoeppe created at 2021-02-09 19:18:40

Could you please take a look at #31362 - it provides `make build-local`, which I think is what you need


---

Comment by mkoeppe created at 2021-02-09 19:34:13

Thanks for making all the changes. 

Right now it's hard for me to test anything from this ticket because the homebrew changes in #31335 conflict.

I would propose to do the following: 
- Rebasing/squashing this branch on top of #31362, current #30770, and #30912.
- Merging the rebase back into the current branch -- by this trick you won't get merge conflicts in your other branches that depend on this ticket (if any)


---

Comment by mkoeppe created at 2021-02-09 19:35:51

Replying to [comment:323 gh-tobiasdiez]:
> I've also tried your suggestion with `sage -sh pipenv` but run into several issues. I guess the problem is that pipenv is trying to reuse sages virtual environment.

See if you can work around this by having `pipenv` use the base python that is shown in `$SAGE_LOCAL/pyvenv.cfg`.


---

Comment by git created at 2021-02-09 22:10:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-09 22:13:04

Replying to [comment:326 mkoeppe]:
> ...never touch LD_LIBRARY_PATH... it's always wrong

Ok, but what's then the correct way to do this?


---

Comment by mkoeppe created at 2021-02-09 22:17:17

Replying to [comment:331 gh-tobiasdiez]:
> Replying to [comment:326 mkoeppe]:
> > ...never touch LD_LIBRARY_PATH... it's always wrong
> 
> Ok, but what's then the correct way to do this?

Building all libraries with rpath - see LDFLAGS setting in `src/bin/sage-env`


---

Comment by git created at 2021-02-09 22:17:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-09 22:23:14

Replying to [comment:328 mkoeppe]:
> - Rebasing/squashing this branch on top of #31362, current #30770, and #30912.

 
I've merged the current versions of #30770 and #30912. Not sure what's the purpose of #31362. That would make the line `make maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` obsolete right? If it's just for this somewhat cosmetic improvement, I would suggest to turn around the tables and let #31362 depend on this ticket (and make the changes in the workflow there as well). Reason: I had to play a lot around with the different targets until everything works, so I'm a bit hesitant to change things again (and since unmerging a branch is not so easy, one cannot simply revert the experiment).


---

Comment by mkoeppe created at 2021-02-09 22:47:42

Replying to [comment:335 gh-tobiasdiez]:
> I've merged the current versions of #30770 and #30912. 

Thanks.

> Not sure what's the purpose of #31362. That would make the line `make maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` obsolete right? If it's just for this somewhat cosmetic improvement

Yes, it's for making all standard non-Python packages available in `SAGE_LOCAL`.

> Reason: I had to play a lot around with the different targets until everything works, so I'm a bit hesitant to change things again

This does not sound good. If installing additional packages from the distribution in `SAGE_LOCAL` breaks the proposed setup, then this ticket is definitely not ready.


---

Comment by mkoeppe created at 2021-02-09 22:54:50

Note also that #31362 does not change anything other than add two new make targets. So even if you find that these targets do not do what you need, there will be no need for unmerging it.


---

Comment by @tobiasdiez created at 2021-02-09 22:59:33

Replying to [comment:336 mkoeppe]:
> > Reason: I had to play a lot around with the different targets until everything works, so I'm a bit hesitant to change things again
> 
> This does not sound good. If installing additional packages from the distribution in `SAGE_LOCAL` breaks the proposed setup, then this ticket is definitely not ready.

More in the sense, that it was a bit of try-and-error to find the minimal set of make targets that make the build pass. You could have course build every package in the sage distribution, but the point is that with pipenv only a couple of them are actually needed.

So `build-local = sagelib-build-deps + maxima conway_polynomials jmol conway_polynomials elliptic_curves combinatorial_designs polytopes_db graphs threejs` ?


---

Comment by mkoeppe created at 2021-02-09 23:01:07

... minus the Python packages of sagelib-build-deps


---

Comment by mkoeppe created at 2021-02-09 23:01:31

For example, it would not build `numpy`.


---

Comment by mkoeppe created at 2021-02-09 23:04:49

Of course, there may be a number of non-Python libraries that are not needed IF you are able to pull in a wheel of the Python packages that somehow ship a bundled version of the non-Python library. For example, the `numpy` wheels may come with their own BLAS -- but it won't help because some of our own packages also need BLAS.


---

Comment by git created at 2021-02-09 23:06:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-09 23:09:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-09 23:10:06

ok, let's see if that works


---

Comment by mkoeppe created at 2021-02-09 23:11:55

In any case thanks to merging these tickets, I am able to merge the tickets that fix homebrew - so I'll be able to test later today.


---

Comment by mkoeppe created at 2021-02-10 03:34:24

`../sage -sh -c 'ARCHFLAGS= PIP_NO_BUILD_ISOLATION=1 pipenv install  -v -v'` got me a bit farther. (Setting `ARCHFLAGS` to the empty string helps on macOS; `PIP_NO_BUILD_ISOLATION=1` helps with some of the Python packages that declare their build dependencies incorrectly (see #30922). Now it fails with this:

```
    raise MetadataInconsistent(self._ireq, "name", dist.project_name)
pip._internal.exceptions.MetadataInconsistent: Requested fpylll from https://files.pythonhosted.org/packages/ad/c5/f30f354dcce03b928702414fdbdd916d60915c6b144360c88707784385bb/fpylll-0.5.4.tar.gz#egg=fpylll-recent (from -r /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pipenv-7zg7bw1s-requirements/pipenv-b8jmkho7-requirement.txt (line 1)) has different name in metadata: 'fpylll'
Removed build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-z5q5pu09'
...
    raise exceptions.InstallError(c.dep.name, extra=err_lines)
pipenv.exceptions.InstallError: ERROR: Couldn't install package: fpylll-recent
 Package installation failed...
```



---

Comment by git created at 2021-02-10 10:05:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-10 10:30:23

This error also occurred on the github workflow. I tried to fix it by setting the name in the pipfile. If this doesn't work can you please remove the fpylll-recent in the pipfile and invoke `pipenv install https://files.pythonhosted.org/packages/ad/c5/f30f354dcce03b928702414fdbdd916d60915c6b144360c88707784385bb/fpylll-0.5.4.tar.gz`
This should work. Could you then please post what pipenv writes to the pipfile, thanks!

`build-local` seems to work, except that it installs some python related tools/packages (pip, setuptools_scm, wheel) and doesn't install maxima.


---

Comment by git created at 2021-02-10 11:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-10 20:08:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-10 20:16:28

Replying to [comment:350 gh-tobiasdiez]:
> `build-local` seems to work, except that it installs some python related tools/packages (pip, setuptools_scm, wheel) and doesn't install maxima. 

wheel (which pulls in the python toolchain) is fixed in #31321.

maxima - could you double check?


---

Comment by @tobiasdiez created at 2021-02-10 20:20:53

Ok good. And false alarm, maxima is installed (the output is just condensed to one line in contrast to the pages of text for `make maxima` which has thrown me off).

The latest commit should hopefully fix the fpylll error.


---

Comment by git created at 2021-02-10 20:21:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-10 20:37:28

I will put a rebased/squashed version of the `setup.py`/`sage_setup` changes on #31377, because this part seems ready and I hope we can get it into 9.3 to get developers used to the in-place install idea.


---

Comment by mkoeppe created at 2021-02-10 20:39:11

(It looks to me like the venv aspects of this ticket will take more time; in particular since they seem to involve getting an uncooperative random set of wheels from PyPI to cooperate with the system.)


---

Comment by @tobiasdiez created at 2021-02-10 21:06:13

It's quite the opposite: since some of the python packages (fyplll, cypari2) don't provide wheels, system packages need to be installed which is quite hard to coordinate across different systems.


---

Comment by mkoeppe created at 2021-02-10 21:14:19

But the Sage distribution has already solved this problem. Just build within a sage-sh.


---

Comment by mkoeppe created at 2021-02-10 21:51:44

Please take a look if #31377 looks agreeable to you.


---

Comment by mkoeppe created at 2021-02-10 23:15:38

Replying to [comment:280 mkoeppe]:
> Also `create_extension` duplicates some of the code in `sage_build_cython.create_extension`.

Also as I just wrote in #31377, some of the code setting flags is missing, which is causing errors. Could you look into unifying this please when you have a chance?


---

Comment by vdelecroix created at 2021-02-11 17:29:49

Replying to [comment:357 mkoeppe]:
> (It looks to me like the venv aspects of this ticket will take more time; in particular since they seem to involve getting an uncooperative random set of wheels from PyPI to cooperate with the system.)

On this topic, see also the discussion at https://github.com/sagemath/cypari2/issues/105.

I think it is a desirable feature to be able to edit the source code in an inplace install of sage (ie what `pip -e` provides). This would greatly benefit all Sage developers. However, I have hard time to understand the benefit of the venv. On the other hand, I do not understand how wheels could solve the libraries/softwares dependencies. More precisely, here is a scenario (which happens to be happening in Sage)
- [SageMath](SageMath) depends on `pylib1` and `pylib2` that uses the same `libfoo` C library. Both of these libraries provide wheels that bundle `libfoo` to make some of their users happy.
- [SageMath](SageMath) also depends on `pylib3` that depends on both `pylib1` and `pylib2` and uses custom Cython code that uses functions from `libfoo`. `pylib3` does not provide wheel yet. How should it be implemented?


---

Comment by mkoeppe created at 2021-02-11 18:08:30

Hi Vincent, thanks for joining the discussion.

For a discussion of possible distribution strategies using wheels, let's use #31251 (Meta-ticket: Distribution as wheels), which also has a link to a recent post by Gommers on packaging. I agree with you that it is a hard problem.

For Sage 9.3, I have a much more modest goal regarding wheels that is already fully implemented and is only waiting for review (see ticket list in #29705 for tickets by milestone). Since #29500 (already in Sage 9.2), we generate wheels in `$SAGE_LOCAL/var/lib/sage/wheels`. These wheels are not distributable as they do not bundle their shared library dependencies but rather rpath into `$SAGE_LOCAL`. Users can make their own venvs for development purposes where they install the prebuilt wheels from this directory. #31045 and #31279 add some missing wheels. #30913 generates dependency metadata that makes it easier to set up the venv; and adds tests using `tox`.

For editable install of sagelib as part of the normal build system (no extra venv) using Tobias' new `setup.py` from this ticket, see #31377.


---

Comment by git created at 2021-02-11 21:28:14

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2021-02-11 21:31:46

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-02-11 21:31:46

So, I think, I've found a solution to the fpylll problems. In fact, the github workflow should now also work for macos (at least the last run installed everything fine except sage, which failed due to an NTL error that is fixed with #31365). Since macos runs on the sage repo run currently really slow, you can find the latest run at https://github.com/tobiasdiez/sage/actions.


---

Comment by mkoeppe created at 2021-02-11 22:20:40

I've split out another ticket from here: #31384


---

Comment by mkoeppe created at 2021-02-12 16:25:46

Changing priority from critical to major.


---

Comment by git created at 2021-02-13 09:25:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-13 13:03:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-13 19:23:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-02-13 19:24:01

Merged #31377, resolving edit conflicts.


---

Comment by mkoeppe created at 2021-02-13 19:27:08

I don't know which problem you are trying to solve with the big try/except. I don't think reducing `ImportError` is the correct solution.

If you are trying to make `setup.py sdist` work when libs are missing, consider using the code from `build/pkgs/sagelib/src/setup.py` line 61


---

Comment by @tobiasdiez created at 2021-02-13 19:29:46

Replying to [comment:373 mkoeppe]:
> Merged #31377, resolving edit conflicts.

Thanks, but this did revert some of my changes (in particular to setup.py)....


---

Comment by @tobiasdiez created at 2021-02-13 19:32:13

Replying to [comment:374 mkoeppe]:
> I don't know which problem you are trying to solve with the big try/except. I don't think reducing `ImportError` is the correct solution.
> 
> If you are trying to make `setup.py sdist` work when libs are missing, consider using the code from `build/pkgs/sagelib/src/setup.py` line 61

Yes, that was my goal. Creating the virtual environment otherwise fails as Cython is not yet installed into it. The file you refer to doesn't seem to exist.


---

Comment by git created at 2021-02-13 21:06:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-02-13 21:07:22

Replying to [comment:375 gh-tobiasdiez]:
> Replying to [comment:373 mkoeppe]:
> > Merged #31377, resolving edit conflicts.
> 
> Thanks, but this did revert some of my changes (in particular to setup.py)....

Sorry, my mistake. I've redone the merge now. Please take a look.


---

Comment by mkoeppe created at 2021-02-13 21:09:11

Replying to [comment:376 gh-tobiasdiez]:
> Replying to [comment:374 mkoeppe]:
> > I don't know which problem you are trying to solve with the big try/except. I don't think reducing `ImportError` is the correct solution.
> > 
> > If you are trying to make `setup.py sdist` work when libs are missing, consider using the code from `build/pkgs/sagelib/src/setup.py` line 61
> 
> Yes, that was my goal. Creating the virtual environment otherwise fails as Cython is not yet installed into it. The file you refer to doesn't seem to exist.

This file: https://git.sagemath.org/sage.git/tree/build/pkgs/sagelib/src/setup.py?id=fec55234a00e46d023ad583f8c6284b970141ab0


---

Comment by mkoeppe created at 2021-02-18 16:37:29

comment 374?


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-08-28 01:31:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-10-10 21:29:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-10 23:06:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-11 00:10:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-11 10:32:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-11 11:45:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-11 14:44:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-11 15:11:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-11 17:08:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-11 17:12:03

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-10-11 17:12:03

I've finally found the time to merge the most recent version. Since most changes (in the build pipline and adding the pipfile etc) have been done already in previous tickets, this ticket now essentially amounts to adding a github action verifying that the setup works indeed. So ready for review again.
----
New commits:


---

Comment by git created at 2021-10-11 17:15:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-11 17:20:20

The `memory_allocator` dep has been added in #32608


---

Comment by mkoeppe created at 2021-10-11 17:25:00

Separate tickets please for:
- the language=c++ changes
- the setup.py change


---

Comment by mkoeppe created at 2021-10-11 22:21:49

Replying to [comment:399 mkoeppe]:
> Separate tickets please for:
> - the language=c++ changes

(... if these changes are actually needed)


---

Comment by mkoeppe created at 2021-10-12 06:32:55

Replying to [comment:399 mkoeppe]:
> Separate tickets please for:
> - the setup.py change
could go into #32672


---

Comment by git created at 2021-10-12 10:50:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-12 10:55:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-12 11:03:31

Replying to [comment:399 mkoeppe]:
> Separate tickets please for:
> - the language=c++ changes
> - the setup.py change

Okay, I've removed the c++ changes as they seem to be no longer needed and opened #32673 for the changes to setup.py.


---

Comment by mkoeppe created at 2021-10-12 23:34:01


```
+        # Fix path to R, since otherwise sage's r is used
+        R_HOME: /usr/local/Cellar/r/4.0.3_2/lib/R
```

Is this needed, and if so, do we need this something like for a normal build too?


---

Comment by mkoeppe created at 2021-10-12 23:38:20


```
+        export SAGE_SHARE=$GITHUB_WORKSPACE/.tox/local-homebrew-macos-usrlocal/local/share
```

This line (in both workflow scripts) shouldn't be needed.

I also don't understand the other environment exports in the workflow script - why not invoke the `sage-env` script that sets up the correct environment?


---

Comment by mkoeppe created at 2021-10-12 23:42:24

Also the documentation on Pipenv added in `src/doc/en/developer/coding_basics.rst` is not sufficiently specific about the steps needed before pipenv is installed and used.


---

Comment by mkoeppe created at 2021-10-12 23:44:52

And finally, checking in the `Pipfile.lock` really does not fit into the Sage development workflow -- it will always be out of date and will lead to merge conflicts. We really should make do with just a `Pipfile` (generated from `Pipfile.m4`) from the versions declared in `build/pkgs`.


---

Comment by @tobiasdiez created at 2021-10-13 08:41:38

Replying to [comment:408 mkoeppe]:
> {{{
> +        # Fix path to R, since otherwise sage's r is used
> +        R_HOME: /usr/local/Cellar/r/4.0.3_2/lib/R
> }}}
> Is this needed, and if so, do we need this something like for a normal build too?

Otherwise the pip-install of rpy2 fails with

```
Collecting rpy2<3.4,>=3.3
  Downloading rpy2-3.3.6.tar.gz (179 kB)
    Running command python setup.py egg_info
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/pip-install-m6wdy35r/rpy2_0c800ed9b8e34449aeee849f526a409b/setup.py", line 115, in <module>
        c_extension_status = get_r_c_extension_status()
      File "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/pip-install-m6wdy35r/rpy2_0c800ed9b8e34449aeee849f526a409b/setup.py", line 99, in get_r_c_extension_status
        *situation.get_r_flags(r_home, '--ldflags')
      File "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/pip-install-m6wdy35r/rpy2_0c800ed9b8e34449aeee849f526a409b/rpy2/situation.py", line 209, in get_r_flags
        _get_r_cmd_config(r_home, flags,
      File "/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/pip-install-m6wdy35r/rpy2_0c800ed9b8e34449aeee849f526a409b/rpy2/situation.py", line 177, in _get_r_cmd_config
        output = subprocess.check_output(
      File "/Users/runner/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/subprocess.py", line 415, in check_output
        return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
      File "/Users/runner/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/subprocess.py", line 493, in run
        with Popen(*popenargs, **kwargs) as process:
      File "/Users/runner/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/subprocess.py", line 858, in __init__
        self._execute_child(args, executable, preexec_fn, close_fds,
      File "/Users/runner/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/subprocess.py", line 1704, in _execute_child
        raise child_exception_type(errno_num, err_msg, err_filename)
    FileNotFoundError: [Errno 2] No such file or directory: '/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-usrlocal/local/var/tmp/sage/build/r-3.6.3/src/bin/R'
```



---

Comment by @tobiasdiez created at 2021-10-13 08:44:19

Replying to [comment:409 mkoeppe]:
> I also don't understand the other environment exports in the workflow script - why not invoke the `sage-env` script that sets up the correct environment?

I was not aware of the sage-env script. How does one uses it to set the environment for the following steps and replace the manual exports I've added? I couldn't find any documentation about that script.


---

Comment by @tobiasdiez created at 2021-10-13 08:45:36

Replying to [comment:410 mkoeppe]:
> Also the documentation on Pipenv added in `src/doc/en/developer/coding_basics.rst` is not sufficiently specific about the steps needed before pipenv is installed and used.

What do you mean concretely? Please also note that the documentation about venv should be improved in general, see #31342.


---

Comment by @tobiasdiez created at 2021-10-13 09:08:47

Replying to [comment:411 mkoeppe]:
> And finally, checking in the `Pipfile.lock` really does not fit into the Sage development workflow -- it will always be out of date and will lead to merge conflicts. We really should make do with just a `Pipfile` (generated from `Pipfile.m4`) from the versions declared in `build/pkgs`.

I agree that it's somewhat suboptimal to have the version information of some packages specified in the sage distribution and in the pipenv lock file. However, the idea behind using pipenv is to provide an alternative way to quickly create a python environment for the development (and maybe at some point distribution) of sage. Thus such a duplication is needed to some degree for now. The point of the lock file is also to ensure that the python environment is the same for everyone (which makes it easier to reproduce issues and test failures etc) and more importantly that the builds in the github action are deterministic. Finally, in can be easily updated by running `pipenv lock` so it's not a lot of overhead. Please also note that it doesn't need to be updated every time a sage dependency is updated since pipenv uses the `install_requires` information to determine the admissible versions. I would suggest to run `pipenv lock` after every release for now and see how this goes.

Moreover, the lock file is required for now as some of the packages (pplpy for example) need cython and other packages installed already on sdist and egg_info. This makes setting up the pipenv from scratch rather hard, since you first need to create a new virtual environment, then install those dependencies and only then run pipenv install. These problems don't occur if you use the lock file (and subsequently `pipenv lock`).

Anyway, because there are pros and cons for each approach I would suggest to see how it goes with the lock file committed (as strongly recommended by pipenv). If it turns out that the disadvantages overweight we can always remove it later again.


---

Comment by git created at 2021-10-13 09:15:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-13 09:18:08

Rename because the ticket is now more about pipenv than editable installs.


---

Comment by mkoeppe created at 2021-10-13 16:36:36

Replying to [comment:414 gh-tobiasdiez]:
> Replying to [comment:410 mkoeppe]:
> > Also the documentation on Pipenv added in `src/doc/en/developer/coding_basics.rst` is not sufficiently specific about the steps needed before pipenv is installed and used.
> 
> What do you mean concretely? 

I'd say start by integrating the ticket description (which has some step by step instructions) into this section of the documentation. (Perhaps best to shorten the ticket description, referring to the added documentation.)

> Please also note that the documentation about venv should be improved in general, see #31342. 
Yes, that's true


---

Comment by mkoeppe created at 2021-10-13 16:38:57

Replying to [comment:415 gh-tobiasdiez]:
> ... can be easily updated by running `pipenv lock` so it's not a lot of overhead. Please also note that it doesn't need to be updated every time a sage dependency is updated since pipenv uses the `install_requires` information to determine the admissible versions. I would suggest to run `pipenv lock` after every release for now and see how this goes.

Could you add the precise process to the documentation please? This would be a task for the release manager, who would need to be briefed about this in detail


---

Comment by mkoeppe created at 2021-10-13 16:40:22

Replying to [comment:413 gh-tobiasdiez]:
> Replying to [comment:409 mkoeppe]:
> > I also don't understand the other environment exports in the workflow script - why not invoke the `sage-env` script that sets up the correct environment?
> 
> I was not aware of the sage-env script. How does one uses it to set the environment for the following steps and replace the manual exports I've added? I couldn't find any documentation about that script.

The top of the file (`src/bin/sage-env`) explains how to use it


---

Comment by mkoeppe created at 2021-10-13 16:54:34

Replying to [comment:418 mkoeppe]:
> I'd say start by integrating the ticket description (which has some step by step instructions) into this section of the documentation. (Perhaps best to shorten the ticket description, referring to the added documentation.)

(However, the `tox -e local-sudo-standard build-local` shouldn't go into the documentation because we do not want to advertise this as a build/provisioning tool; it is strictly meant for portability testing.)


---

Comment by git created at 2021-10-14 00:01:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-14 08:13:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-14 10:30:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-14 10:37:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-14 11:16:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-14 11:24:25

Thanks for your comments. I think I've addressed all of them now.

Only `. bin/sage-env` doesn't work for me. Afterwards, the `pipenv` command throws the error that the pipenv module cannot be found. I guess the reason is that pipenv is not installed in the sage python environment. Since this would also only replace the `export xyz` commands in the github workflow, I propose we do this in a follow-up ticket.


---

Comment by git created at 2021-10-14 13:25:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-14 13:57:11

Replying to [comment:409 mkoeppe]:
> {{{
> +        export SAGE_SHARE=$GITHUB_WORKSPACE/.tox/local-homebrew-macos-usrlocal/local/share
> }}}
> This line (in both workflow scripts) shouldn't be needed.
> 
Without it a lot of tests fail, for example because Cremona cannot be found. See https://github.com/sagemath/sagetrac-mirror/runs/3893523414?check_suite_focus=true. I've thus readded the sage share export.


---

Comment by git created at 2021-10-14 13:59:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-14 19:05:25

Doesn't your `sage-conf` provide the Cremona install paths?


---

Comment by @tobiasdiez created at 2021-10-14 19:13:11

Might this be that in the github action the installed sage-conf doesn't refer to the tox environment but to the one in `/local` ?


---

Comment by mkoeppe created at 2021-10-14 19:16:11

I don't know, but the idea of `sage-conf` is that you install a version that provides the correct setting of `SAGE_LOCAL`


---

Comment by @tobiasdiez created at 2021-10-14 19:28:47

Problem is that the path of sage-conf needs to be specified in the pipfile and thus has to be known before. Maybe in the future one can add a symlink (defaulting to pkgs/sage-conf) that can be changed to point to a tox environment? But I guess this would be more or less equivalent to changing SAGE_SHARE.


---

Comment by mkoeppe created at 2021-10-14 20:01:12

The path in the source tree is always `pkgs/sage-conf/`


---

Comment by mkoeppe created at 2021-10-14 20:02:34

(The `local` .tox builds do not make a copy of SAGE_ROOT. They only use a separate SAGE_LOCAL.)


---

Comment by git created at 2021-10-14 22:04:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-15 10:26:45

Replying to [comment:436 mkoeppe]:
> The path in the source tree is always `pkgs/sage-conf/`

Okay, then I don't know what the problem is. I would propose to keep the explicit SAGE_SHARE for now and then afterwards create a new ticket in which it is removed. The github workflow right now is anyway a big compromise of "how it should work" vs "what is actually needed to make it work". There are quite a few special tweaks and workarounds that ideally shouldn't be needed.


---

Comment by git created at 2021-10-15 10:31:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-15 15:06:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-15 16:23:39

Replying to [comment:439 gh-tobiasdiez]:
> Replying to [comment:436 mkoeppe]:
> > The path in the source tree is always `pkgs/sage-conf/`
> 
> Okay, then I don't know what the problem is. 

To debug this, in the activated venv you could ask `sage-config` to print the configuration


---

Comment by mkoeppe created at 2021-10-15 16:27:01

Replying to [comment:427 gh-tobiasdiez]:
> Only `. bin/sage-env` doesn't work for me. 

Take a look at what `bin/sage` does. It first sources config files on which `sage-env` relies.


---

Comment by mkoeppe created at 2021-10-15 16:31:45

Replying to [comment:415 gh-tobiasdiez]:
> some of the packages (pplpy for example) need cython and other packages installed already on sdist and egg_info. 

This should be fixed. Could you open issues please with these packages? We also have meta-ticket #30922 for keeping track of these issues.


---

Comment by mkoeppe created at 2021-10-15 16:43:04

Replying to [comment:415 gh-tobiasdiez]:
> The point of the lock file is also to ensure that the python environment is the same for everyone (which makes it easier to reproduce issues and test failures etc)

I understand that for general Python projects it has the benefit that you describe (although the benefit over plain `requirements.txt` is still not clear to me, but let's not elaborate on this now).

The problem is that in our case, adding the lock file locks versions that (1) are *not the same* as the ones in the Sage distribution, (2) it will be out of date next week because we have no established process to update it. So it reduces clarity for users and creates a maintenance burden for Sage development.

I think it would be a good idea to work on a process (= script/documentation) based on pipenv that actually helps Sage developers to make Python package upgrades. Currently this is a manual process based on guesswork and testing. So this could be a key added value that Pipenv provides.


---

Comment by mkoeppe created at 2021-10-15 16:51:32

Replying to [comment:415 gh-tobiasdiez]:
> Moreover, the lock file is required for now as some of the packages (pplpy for example) need cython and other packages installed already on sdist and egg_info. 

Actually pplpy declares these build dependencies correctly in https://gitlab.com/videlec/pplpy/-/blob/master/pyproject.toml


---

Comment by git created at 2021-10-15 19:49:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-15 21:19:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-15 21:35:04

comment:443 applies


---

Comment by git created at 2021-10-15 22:27:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-15 23:36:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-16 08:37:25

Replying to [comment:443 mkoeppe]:
> Replying to [comment:427 gh-tobiasdiez]:
> > Only `. bin/sage-env` doesn't work for me. 
> 
> Take a look at what `bin/sage` does. It first sources config files on which `sage-env` relies.

I was not able to make it work locally nor on github (where it fails with exit code 127 without giving any details). That's mostly because of my missing experience with bash and linux things. Also sage-env does a lot of things that are not needed at this point (e.g. overwriting the python location, which breaks pipenv). Anyway, lets make this a follow-up ticket.


---

Comment by git created at 2021-10-16 08:39:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-16 08:57:08

Replying to [comment:444 mkoeppe]:
> Replying to [comment:415 gh-tobiasdiez]:
> > some of the packages (pplpy for example) need cython and other packages installed already on sdist and egg_info. 
> 
> This should be fixed. Could you open issues please with these packages? We also have meta-ticket #30922 for keeping track of these issues.

Done: https://gitlab.com/videlec/pplpy/-/issues/27


---

Comment by @tobiasdiez created at 2021-10-16 09:20:46

Replying to [comment:445 mkoeppe]:
> The problem is that in our case, adding the lock file locks versions that (1) are *not the same* as the ones in the Sage distribution, 

Maybe a shift in viewpoint might be helpful to see how pipenv helps. Sagelib (things in `src`) declares its dependencies in form of `install_requires`. Currently, sage-the-distrubition is one way to provide a certain set of packages that satisfy the version constraints. The newly added pipfile.lock specifies another set of packages that also satisfy the constraints. If sagelib is indeed configured correctly, then it should work with both sets. So you can see the added github workflow as a test that the install_requires constraints are correct.

> (2) it will be out of date next week because we have no established process to update it. So it reduces clarity for users and creates a maintenance burden for Sage development.

dependabot or rennovate are the modern approaches to not worry about manually updating dependencies. But they don't support trac...
But updating the pipfile lock manually is easy, automated and only needs to be done rarely. Its definitively more convenient then updating the versions in sage-the-distro.
 
> I think it would be a good idea to work on a process (= script/documentation) based on pipenv that actually helps Sage developers to make Python package upgrades. Currently this is a manual process based on guesswork and testing. So this could be a key added value that Pipenv provides. 

I agree. First of all, my idea with pipenv was to completely replace sages python packages and use it also for distribution. But also in the short term, pipenv can be helpful. For example, the following are the versions determined by pipenv:

```
alabaster                     0.7.12
argon2-cffi                   21.1.0
attrs                         21.2.0
Babel                         2.9.1
backcall                      0.2.0
backports.zoneinfo            0.2.1
bleach                        4.1.0
certifi                       2021.10.8
cffi                          1.15.0
charset-normalizer            2.0.7
cycler                        0.10.0
cypari2                       2.1.2
cysignals                     1.10.3
Cython                        0.29.24
debugpy                       1.5.0
decorator                     5.1.0
defusedxml                    0.7.1
docutils                      0.17.1
entrypoints                   0.3
fpylll                        0.5.6
gmpy2                         2.1.0b5
idna                          3.3
imagesize                     1.2.0
iniconfig                     1.1.1
ipykernel                     6.4.1
ipython                       7.28.0
ipython-genutils              0.2.0
ipywidgets                    7.6.5
jedi                          0.18.0
Jinja2                        3.0.2
jsonschema                    4.1.0
jupyter-client                7.0.6
jupyter-core                  4.8.1
jupyterlab-pygments           0.1.2
jupyterlab-widgets            1.0.2
kiwisolver                    1.3.2
MarkupSafe                    2.0.1
matplotlib                    3.4.3
matplotlib-inline             0.1.3
memory-allocator              0.1.1
mistune                       0.8.4
mpmath                        1.2.1
nbclient                      0.5.4
nbconvert                     6.2.0
nbformat                      5.1.3
nest-asyncio                  1.5.1
networkx                      2.6.3
notebook                      6.4.4
numpy                         1.21.2
packaging                     21.0
pandocfilters                 1.5.0
parso                         0.8.2
pexpect                       4.8.0
pickleshare                   0.7.5
Pillow                        8.3.2
pip                           21.2.4
pkgconfig                     1.5.5
pluggy                        1.0.0
pplpy                         0.8.7
prometheus-client             0.11.0
prompt-toolkit                3.0.20
psutil                        5.8.0
ptyprocess                    0.7.0
py                            1.10.0
pycparser                     2.20
Pygments                      2.10.0
pyparsing                     2.4.7
pyrsistent                    0.18.0
pytest                        6.2.5
python-dateutil               2.8.2
pytz                          2021.3
pyzmq                         22.3.0
requests                      2.26.0
rpy2                          3.3.6
sage-conf                     9.5b3     /__w/sagetrac-mirror/sagetrac-mirror/pkgs/sage-conf
sagemath-standard             9.5b3     /__w/sagetrac-mirror/sagetrac-mirror/src
scipy                         1.7.1
Send2Trash                    1.8.0
setuptools                    58.1.0
six                           1.16.0
snowballstemmer               2.1.0
Sphinx                        4.1.2
sphinxcontrib-applehelp       1.0.2
sphinxcontrib-devhelp         1.0.2
sphinxcontrib-htmlhelp        2.0.0
sphinxcontrib-jsmath          1.0.1
sphinxcontrib-qthelp          1.0.3
sphinxcontrib-serializinghtml 1.1.5
sympy                         1.9
terminado                     0.12.1
testpath                      0.5.0
toml                          0.10.2
tornado                       6.1
traitlets                     5.1.0
tzlocal                       3.0
urllib3                       1.26.7
wcwidth                       0.2.5
webencodings                  0.5.1
wheel                         0.37.0
widgetsnbextension            3.5.1
```

Now you can use those versions as the package version of sage-the-distro. Lets discuss this further in #31346.


---

Comment by mkoeppe created at 2021-10-16 17:01:44

Replying to [comment:454 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[d4d8236](https://git.sagemath.org/sage.git/commit/?id=d4d8236d91cf864744d7a7dee4710732b10a2b72)||`I give up on sage-env...`||

You forgot to use sage-env-config etc. as per comment:443


---

Comment by mkoeppe created at 2021-10-16 17:41:00

Replying to [comment:456 gh-tobiasdiez]:
> Replying to [comment:445 mkoeppe]:
> > The problem is that in our case, adding the lock file locks versions that (1) are *not the same* as the ones in the Sage distribution, 
> 
> Maybe a shift in viewpoint might be helpful to see how pipenv helps. Sagelib (things in `src`) declares its dependencies in form of `install_requires`. Currently, sage-the-distrubition is one way to provide a certain set of packages that satisfy the version constraints. The newly added pipfile.lock specifies another set of packages that also satisfy the constraints. If sagelib is indeed configured correctly, then it should work with both sets. So you can see the added github workflow as a test that the install_requires constraints are correct.

I don't find this convincing. A checked-in `Pipfile.lock` is just the result of resolving the declared version constraints (as of some point in the past) against what was available on the index at some some point in the past.

When the workflow fails, it will mean just one thing: Constraints were updated and Pipfile.lock was not updated (-> maintenance burden).

It's more valuable to test on GH Actions whether the declared version constraints resolve *at the current time* to a set of versions that work correctly. If this fails, it is clear that the constraints declared in `install_requires` are not correct.


---

Comment by mkoeppe created at 2021-10-16 17:43:59

By the way, see `SAGE_ROOT/pkgs/sagemath-standard/tox.ini` for test environments for several ways to provision a venv. Looking at it, I am also reminded that we actually have two sets of Pipenv


---

Comment by @tobiasdiez created at 2021-10-16 19:41:53

Replying to [comment:457 mkoeppe]:
> Replying to [comment:454 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[d4d8236](https://git.sagemath.org/sage.git/commit/?id=d4d8236d91cf864744d7a7dee4710732b10a2b72)||`I give up on sage-env...`||
> 
> You forgot to use sage-env-config etc. as per comment:443

I tried it locally and couldn't determine which other scripts are needed to run first. To be honest, I'm tired of the try and error play (especially since it only replace a couple of very easy to understand export statements).


---

Comment by mkoeppe created at 2021-10-16 20:05:51

You can also just use `sage -sh` to run something in the environment, like it's explained in the instructions of `SAGE_ROOT/pkgs/sagemath-standard/tox.ini`


---

Comment by @tobiasdiez created at 2021-10-16 20:17:11

Replying to [comment:458 mkoeppe]:
> When the workflow fails, it will mean just one thing: Constraints were updated and Pipfile.lock was not updated (-> maintenance burden).
> It's more valuable to test on GH Actions whether the declared version constraints resolve *at the current time* to a set of versions that work correctly. If this fails, it is clear that the constraints declared in `install_requires` are not correct.

I guess it depends on what you want to test (and when you want to run the workflow):
- Test that the changes in the actual code (`src`) don't break the doctests (i.e run on push). In this case, you want to keep the environment fixed (since otherwise the workflow may fail due to newly released versions on pypi). 
- Test that sage works with the newest versions of packages compatible with the install_require constraints. In this case, you probably want to run the workflow manually, before release or in certain interval. Of course, in this case one should ignore the committed pipfile.lock.

My initial motivation was the first use case (as an alternative/replacement for the patchbots), but you are right the second case is important as well. For this reason, I've now added the possibility to run the workflow in manually in "update" mode in which case the pipfile.lock is ignored. Note that the latter still needs a committed pipfile lock at the moment due to the problems described above (https://trac.sagemath.org/ticket/30922).


---

Comment by git created at 2021-10-16 20:17:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-16 20:19:31

Replying to [comment:461 mkoeppe]:
> You can also just use `sage -sh` to run something in the environment, like it's explained in the instructions of `SAGE_ROOT/pkgs/sagemath-standard/tox.ini`

I tried this as well, but then other things get messed up (e.g. PATH, which Python is used etc). What I would like to have and what is needed here is a `sage-build-env` in which only the build-related environment variables are changed.


---

Comment by @tobiasdiez created at 2021-10-16 20:22:33

By the way, the "update" mode is only available after this ticket is merged due to a security constraint by github ("To trigger the workflow_dispatch event, your workflow must be in the default branch.").


---

Comment by mkoeppe created at 2021-10-16 21:10:54

I think all the troubles that you are having with the environment are the result of using tox to build the SAGE_LOCAL but then not activating the tox environment.
A way out of this is to go through #31535


---

Comment by git created at 2021-10-17 09:27:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-17 17:45:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-17 18:12:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-17 20:53:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 09:38:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 11:51:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 12:15:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 12:27:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-18 23:20:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-18 23:26:59

Replying to [comment:466 mkoeppe]:
> I think all the troubles that you are having with the environment are the result of using tox to build the SAGE_LOCAL but then not activating the tox environment.
> A way out of this is to go through #31535
> 

It was actually something strange going on on my system. After make distclean I could run sage-env locally and then also in the github action. Sorry for the confusion and thanks for your help.

The update mode was a bit more work than I'd liked but its running now. See https://github.com/sagemath/sagetrac-mirror/runs/3926515272?check_suite_focus=true for an example output. It can be activated by running the workflow manually from the github interface (after it is merged into the default branch).


---

Comment by git created at 2021-10-21 07:49:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-11-18 12:26:16

Anything left to do here or is it good to go?


---

Comment by jhpalmieri created at 2021-11-18 19:33:17

I tried following the instructions in the ticket description, and in particular the block of commands

```
./bootstrap
./configure --enable-editable
make build-local
cd src
mkdir .venv
pipenv install --dev --ignore-pipfile
pipenv run sage-runtests --all
```

The last command fails with

```
Error: the command sage-runtests could not be found within PATH or Pipfile's [scripts].
```



---

Comment by git created at 2021-11-18 22:34:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-11-19 12:49:48

New commits:


---

Comment by @tobiasdiez created at 2021-11-19 12:50:04

Sorry for not testing it after my last merge of the develop branch.

It turned out there is a problem (only reported by pipenv using the `--verbose` flag) during the installation of sage in the virtual environment. In fact, it turns out that this is not related at all to pipenv but a general issue with the installation using build isolution, so I've opened #32904 for this.

For pipenv this can be fixed by running 

```
pipenv run pip install -e . --upgrade --exists-action=i --no-build-isolation
}}} 
after the initial build of the venv. I've changed the ticket description accordingly.


---

Comment by git created at 2021-11-19 12:59:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-19 22:43:14

I don't have any opinion about the code, so I am not the right person to review this, but I did get a lot of doctest failures when following the directions in the ticket:

```
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/env.py  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/superseded.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/cython.py  # 21 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/inline_fortran.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/cachefunc.pyx  # 54 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/session.pyx  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/randstate.pyx  # 25 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/inherit_comparison.pyx  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/sagedoc.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/nested_class.pyx  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/lazy_attribute.pyx  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/sageinspect.py  # 35 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/sage_eval.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/misc/persist.pyx  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/elliptic_curves/ell_rational_field.py  # 21 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/elliptic_curves/lseries_ell.py  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/generic/algebraic_scheme.py  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/generic/homset.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/fano_variety.py  # 137 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/divisor_class.pyx  # 50 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/points.py  # 108 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/library.py  # 74 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/toric_subscheme.py  # 104 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/variety.py  # 229 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/divisor.py  # 234 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/weierstrass.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/weierstrass_covering.py  # 9 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/chow_group.py  # 159 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/homset.py  # 72 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/morphism.py  # 194 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/sheaf/klyachko.py  # 101 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/schemes/toric/sheaf/constructor.py  # 29 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/crypto/classical.py  # 16 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/parallel/decorate.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/graphics.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/contour_plot.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/line.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/arrow.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/tachyon.py  # 24 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/index_face_set.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/platonic.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/base.pyx  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/implicit_surface.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/implicit_plot3d.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/parametric_plot3d.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/plot/plot3d/parametric_surface.pyx  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/manifolds/differentiable/vectorfield.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/manifolds/differentiable/tangent_vector.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/constellation.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/tutorial.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/quickref.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/permutation.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/designs/ext_rep.py  # Killed due to abort
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/posets/posets.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/root_system/weyl_group.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/combinat/matrices/latin.py  # 45 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/lfunctions/zero_sums.pyx  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/lfunctions/lcalc.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/lfunctions/sympow.py  # 10 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/ext/memory_allocator.pxd  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/ext/memory_allocator.pyx  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/doctest/control.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/doctest/forker.py  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/features/__init__.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/benchmark.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/cmdline.py  # 8 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/gap_packages.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/books/judson-abstract-algebra/groups-sage.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/books/judson-abstract-algebra/cyclic-sage.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/books/judson-abstract-algebra/homomorph-sage.py  # 11 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/books/judson-abstract-algebra/sylow-sage.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/algebras/orlik_terao.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/algebras/orlik_solomon.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/repl/interpreter.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/repl/interface_magic.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/repl/ipython_extension.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/repl/load.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/galois_group.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/class_function.py  # 137 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/generic.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/symgp_conjugacy_class.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/permgroup_morphism.py  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/permgroup.py  # 44 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/cubegroup.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/constructor.py  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/permgroup_element.pyx  # 10 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/perm_gps/partn_ref/data_structures.pyx  # 9 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/abelian_gps/dual_abelian_group_element.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/abelian_gps/abelian_group_morphism.py  # 15 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/groups/abelian_gps/abelian_group.py  # 64 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/docs/instancedoc.pyx  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/arith/misc.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/arith/long.pxd  # 14 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/libs/gap/element.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/libs/gap/libgap.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/cpython/dict_del_by_value.pyx  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/cpython/wrapperdescr.pxd  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/cpython/string.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/cpython/cython_metaclass.pyx  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/cpython/getattr.pyx  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modular/abvar/abvar.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modular/arithgroup/congroup_gamma0.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modular/arithgroup/congroup_gammaH.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modular/arithgroup/arithgroup_perm.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modular/modform/constructor.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modular/hecke/submodule.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/functions/other.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/functions/exp_integral.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/functions/generalized.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/functions/piecewise.py  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/binary_code.pyx  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/databases.py  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/linear_code.py  # 22 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/golay_code.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/kasami_codes.pyx  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/two_weight_db.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/code_constructions.py  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/linear_code_no_metric.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/coding/goppa_code.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/integer_ring.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/integer.pyx  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/infinity.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/integer_fake.pxd  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/tate_algebra_ideal.pyx  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/rational_field.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/number_field/galois_group.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/number_field/number_field.py  # 26 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/number_field/number_field_element.pyx  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/number_field/totallyreal_rel.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/polynomial_ring.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/polynomial_element.pyx  # 8 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/ore_polynomial_element.pyx  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/multi_polynomial.pyx  # 8 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/multi_polynomial_ring_base.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/multi_polynomial_ideal.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/polynomial/groebner_fan.py  # 118 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/finite_rings/galois_group.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/finite_rings/element_pari_ffelt.pyx  # 11 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/finite_rings/element_givaro.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/finite_rings/integer_mod_ring.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/finite_rings/integer_mod.pyx  # 4 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/rings/finite_rings/finite_field_givaro.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/graphs/connectivity.pyx  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/graphs/generic_graph.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/graphs/graph_decompositions/fast_digraph.pyx  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/symbolic/expression.pyx  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/symbolic/constants.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/symbolic/pynac.pxi  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/symbolic/integration/integral.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/symbolic/integration/external.py  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/cone_catalog.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/fan_morphism.py  # 92 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/fan.py  # 85 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/toric_plotter.py  # 12 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/lattice_polytope.py  # 196 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/cone.py  # 17 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/fan_isomorphism.py  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/polyhedron/ppl_lattice_polytope.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/polyhedron/base_ZZ.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/polyhedron/backend_normaliz.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/polyhedron/palp_database.py  # 23 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/polyhedron/base.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/geometry/triangulation/element.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/calculus/calculus.py  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modules/free_module_element.pyx  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modules/filtered_vector_space.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modules/with_basis/invariant.py  # 74 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/modules/with_basis/representation.py  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/structure/parent_old.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/structure/element.pyx  # 37 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/structure/factory.pyx  # 8 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/structure/element.pxd  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/structure/parent.pyx  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/categories/primer.py  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/categories/finite_dimensional_modules_with_basis.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/categories/pushout.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/categories/modules_with_basis.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/matrix/matrix1.pyx  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/tachyon.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/expect.py  # 49 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/mwrank.py  # 9 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/ecm.py  # 12 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/qsieve.py  # 7 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/interface.py  # 31 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/gap3.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/gap.py  # 143 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/tests.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage/interfaces/giac.py  # 140 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage_setup/find.py  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 sage_docbuild/__init__.py  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/ja/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/ja/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/ja/tutorial/interfaces.rst  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/ru/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/ru/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/ru/tutorial/interfaces.rst  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/pt/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/pt/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/pt/tutorial/interfaces.rst  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/de/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/de/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/de/tutorial/interfaces.rst  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/fr/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/fr/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/fr/tutorial/interfaces.rst  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/es/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/developer/coding_in_other.rst  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/tutorial/interfaces.rst  # 5 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/constructions/rep_theory.rst  # 18 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/constructions/polynomials.rst  # 13 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/constructions/rings.rst  # 6 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/constructions/linear_algebra.rst  # 3 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/constructions/groups.rst  # 18 doctests failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/thematic_tutorials/coding_theory.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/thematic_tutorials/explicit_methods_in_number_theory/elliptic_curves.rst  # 1 doctest failed
sage -t --warn-long 64.4 --random-seed=60140155690716510157027757823734981182 doc/en/thematic_tutorials/lie/weyl_groups.rst  # 1 doctest failed
```

Some come from

```
pkgconfig.pkgconfig.PackageNotFoundError: fflas-ffpack not found
```

and I also see some instances of errors like

```
File "doc/es/tutorial/tour_groups.rst", line 29, in doc.es.tutorial.tour_groups
Failed example:
    G.random_element()           # random output (resultado aleatorio)
Exception raised:
    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/sage/interfaces/gap.py", line 1155, in _start
        raise OSError("GAP workspace too old")
    OSError: GAP workspace too old

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/sage/interfaces/expect.py", line 492, in _start
        self._expect = SageSpawn(cmd,
      File "sage/interfaces/sagespawn.pyx", line 65, in sage.interfaces.sagespawn.SageSpawn.__init__
        with ContainChildren(silent=True):
      File "sage/interfaces/sagespawn.pyx", line 66, in sage.interfaces.sagespawn.SageSpawn.__init__
        spawn.__init__(self, *args, **kwds)
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/.venv/lib/python3.9/site-packages/pexpect/pty_spawn.py", line 205, in __init__
        self._spawn(command, args, preexec_fn, dimensions)
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/.venv/lib/python3.9/site-packages/pexpect/pty_spawn.py", line 276, in _spawn
        raise ExceptionPexpect('The command was not found or was not ' +
    pexpect.exceptions.ExceptionPexpect: The command was not found or was not executable: gap.

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/sage/interfaces/gap.py", line 654, in _eval_line
        self._start()
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/sage/interfaces/gap.py", line 1166, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/sage/interfaces/expect.py", line 503, in _start
        raise RuntimeError("unable to start %s because the command %r failed: %s\n%s" %
    RuntimeError: unable to start gap because the command 'gap -r -b -p -T -E -m 64m  /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta6/src/sage/ext_data/gap/sage.g' failed: The command was not found or was not executable: gap.
```

I haven't looked at all of the failures to see what else is there.


---

Comment by @tobiasdiez created at 2021-11-20 12:21:45

Thanks for testing!

Some failing tests are to be expected since pipenv is rather different to the existing way to use sage (as part of sage-the-distribution). But I think for the modularization effort this ticket gives a helpful testcase how sage performs in a "pip-installable" environment.

I also had problems with gap (for the github action) and fixed it by manually setting the SAEG_LOCAL env variable. I guess there is potential for improvement as follow-up tickets but I'm not the right person to work on this as I'm not familiar with these parts of sage.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-01-03 12:21:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-12-04 17:52:07

needs a rebase
