# Issue 26808: Compute (degree bounded) minimal model of cdga's

Issue created by migration from https://trac.sagemath.org/ticket/27045

Original creator: mmarco

Original creation time: 2019-01-11 12:45:06

CC:  jhpalmieri tscrim

This ticket compute the minimal model of a cdg-algebra.


---

Comment by mmarco created at 2019-01-11 12:48:09

New commits:


---

Comment by mmarco created at 2019-01-11 12:48:09

Changing type from PLEASE CHANGE to enhancement.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by git created at 2019-01-22 17:32:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-01-23 05:31:42

I don't know how close this is to review, but this version of `cohomology_generators` is much slower than the old one.

Old one:

```
sage: A3.<a,x,y> = GradedCommutativeAlgebra(GF(3), degrees=(1,2,2))
sage: B3 = A3.cdg_algebra(differential={y: a*x})
sage: %timeit B3.cohomology_generators(30)
1 loop, best of 3: 187 ms per loop
sage: A.<a,x,y> = GradedCommutativeAlgebra(QQ, degrees=(1,2,2))
sage: B = A.cdg_algebra(differential={y: a*x})
sage: %timeit B.cohomology_generators(40)
1 loop, best of 3: 553 ms per loop
```

New one:

```
sage: A3.<a,x,y> = GradedCommutativeAlgebra(GF(3), degrees=(1,2,2))
sage: B3 = A3.cdg_algebra(differential={y: a*x})
sage: %timeit B3.cohomology_generators(30)
1 loop, best of 3: 2.3 s per loop
sage: A.<a,x,y> = GradedCommutativeAlgebra(QQ, degrees=(1,2,2))
sage: B = A.cdg_algebra(differential={y: a*x})
sage: %timeit B.cohomology_generators(40)
1 loop, best of 3: 6.32 s per loop
```



---

Comment by mmarco created at 2019-01-23 10:06:35

I am still working on it (I plan to add too the computation of the cohomology algebra, and maybe a test for formality, although I have to consider if that should go on the same ticket or not). 

I didn't notice such a big difference in the timimgs, but maybe that is because I only tested up to relitvely low degrees. Anyways, I don't think it would make sense to keep the old implementation since it doesn't grant to give the right answer (in the sense of not giving a minimal set of generators). I will try to think of another aproach that still grants to give a minimal set of generators, but doesn't get so slow.

BTW, if you would like to review this, I could try to get it to the "needs review" point today or tomorrow, and leave the rest of the work for other tickets.


---

Comment by jhpalmieri created at 2019-01-23 16:54:06

If the new version gives different answers from the old one, you should add some doctests to demonstrate this, and in particular the advantages of the new one.

Don't hurry this on my account; it is not always predictable when I will have time to review a ticket.


---

Comment by tscrim created at 2019-01-23 17:18:46

Another option (and my preference) would be to have an `algorithm` option since they give different results (with different speeds).

I can try to review this when it is ready.


---

Comment by mmarco created at 2019-01-23 17:42:51

My point is that the previous method gave an answer that is "wrong", in the sense of giving a generating system that has redundant elements. If one wants just a generating system, one can use all the cohomology classes up to the given degree. So it only makes sense to provide a specific method to compute a reduced system if it is indeed minimal. Hence the change.

I will add a doctest with an example where the given answer is different from the previous method.


---

Comment by mmarco created at 2019-01-23 17:55:37

In particular, with the old method:



```
sage: A.<e1,e2,e3,e4> = GradedCommutativeAlgebra(QQ)
sage: d = A.differential({e1:e4*e3,e2:e4*e3})
sage: B = A.cdg_algebra(d)
sage: B.cohomology_generators(10)
{1: [e4, e3, -e1 + e2], 2: [e2*e4, e2*e3, e1*e4, e1*e3]}
```


whereas with the new:


```
sage: A.<e1,e2,e3,e4> = GradedCommutativeAlgebra(QQ)
sage: d = A.differential({e1:e4*e3,e2:e4*e3})
sage: B = A.cdg_algebra(d)
sage: B.cohomology_generators(10)
{1: [e4, e3, -e1 + e2], 2: [e2*e4, e2*e3]}
```



Note that `e1*e4 = -e4*(-e1+e2) + e2*e4`


---

Comment by git created at 2019-01-23 18:06:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-01-24 18:49:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-09 09:06:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-14 16:39:42

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2019-02-17 20:44:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-22 09:27:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-03 16:29:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-06 08:58:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-04-06 09:02:52

Changing status from new to needs_review.


---

Comment by mmarco created at 2019-04-06 09:04:44

I think this part is ready for review. When this is ready, I will implement a check for i-formality in another ticket.


---

Comment by tscrim created at 2019-04-06 13:06:45

Some more trivial comments:

- `if len(cohom1)==0:` -> `if not cohom1:`
- doc formatting:
  {{{
        INPUT:

        - ``i`` -- integer (default: `3`); degree to which the result is required
          to induce an isomorphism in cohomology, and the domain is required to be
          minimal

        - ``max_iterations`` -- integer (default: `3`); the number of iterations
          of the method at each degree; if the algorithm does not finish in this
          many iterations at each degree, an error is raised
  }}}
  {{{
        - ``max_degree`` -- integer (default: `3`); degree to which the result is required to
          be isomorphic to self's cohomology
  }}}
  {{{
        - ``codomain`` -- the parent where the images live

        - ``im_gens`` -- a list or tuple with the images of the generators of this ring
  }}}
- typo: `the first cohomology o ``self``.`
- small tweak: `n'th` -> ``n`'th`
- `OUTPUT:` usually starts on a separate paragraph.
- You have some `$` in `minimal_model`'s `ALGORITHM` block. I would also not use `self` in here but instead some other variable name.
- No space after `:wikipedia:`.
- Error messages should start with a lowercase letter (following a general python convention).
- PEP8 says do not put spaces around equals signs when passing as input parameters (e.g., `foo(n=5)` not `foo(n = 5)`. There are also a few other PEP8 operator spacing issues scattered about.
- This should be identically `0`: `sum(0*i for i in im_gens)`, so instead just return the appropriate 0 object (should be `self.codomain().zero()`).


---

Comment by git created at 2019-04-08 11:12:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-04-08 11:13:23

I fixed those comments, and while I were at it, also fixed some other PEP8 complaints.


---

Comment by tscrim created at 2019-04-10 12:56:26

A few other little things that I would like to see fixed before setting a positive review:

`max(self._minimalmodels.keys())` -> `max(self._minimalmodels)`
and `if max_degree in self._minimalmodels.keys():` -> `if max_degree in self._minimalmodels:`.

You still need to fix the docformatting for `minimal_model()` and `cohomology_algebra`.

Another docformatting thing, but less of an issue since it is hidden in `_im_gens_` (but I am picky about these things):

```diff
-        - ``codomain`` - The parent where the images live
+        - ``codomain`` -- the parent where the images live
 
-        - ``im_gens`` - A list or tuple with the images of the generators of this ring.
+        - ``im_gens`` -- a list or tuple with the images of the generators of this ring
```


`im_gens[i]**t[i] for i in range(len(t))` -> im_gens[i]**val for i,val in enumerate(t)`

Your `sum`'s also do not need to create the list, but this is a trivial comment.


```
        if len(cohomgens) == 0:
            raise ValueError("Cohomology ring has no generators")
```

Could this be `if not cohomgens:`? Also, the error message should start with a lowercase letter.


---

Comment by mmarco created at 2019-04-10 13:07:21

What exactly do you mean by fixing the docformatting? The long lines in the results of doctests?


---

Comment by git created at 2019-04-10 13:20:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-04-10 13:52:10

See comment:23. Specifically, the `INPUT:` bullet points are not correctly aligned and should result in an error message when compiling the documentation. Although it would be good to follow the standard conventions (as I understand them) for docstrings too, but I won't strictly enforce that.


---

Comment by mmarco created at 2019-04-10 16:12:54

Wouldn't the testing framework complain if the expected output differs from the actual one by some line breaks?


---

Comment by mmarco created at 2019-05-03 13:29:27

Can you please take a nother look? I think it is pretty much ready.


---

Comment by tscrim created at 2019-05-06 05:11:13

Docbuild errors noted on the patchbot as per comment:29:

```diff
         - ``i`` -- integer (default: `3`); degree to which the result is
-        required to induce an isomorphism in cohomology, and the domain is
-        required to be minimal.
+          required to induce an isomorphism in cohomology, and the domain is
+          required to be minimal
```

and similar.


---

Comment by git created at 2019-05-06 09:31:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-05-06 09:32:17

I think I addressed the complains in the patchbot.
----
New commits:


---

Comment by tscrim created at 2019-05-07 00:55:13

So the patchbots are reporting failures:

```
sage -t --long src/sage/rings/polynomial/multi_polynomial_ideal.py  # 6 doctests failed
```

The 3 main ones seem like they are trivial failures and just need to be updated. Two of the other failures I cannot reproduce, but could always just be marked by `# random` if they are an issue. The last one I cannot reproduce either, but is coming from the fact that `toy:buchberger` does not return a reduced Gröbner basis (and so is construction order dependent). I suspect these were just brittle tests beforehand.


---

Comment by mmarco created at 2019-05-07 12:38:40

Hmmm, that's strange: I get an error message when testing myself:


```
sage -t  src/sage/rings/polynomial/multi_polynomial_ideal.py

...

**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ideal.py", line 2947, in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.elimination_ideal
Failed example:
    I.elimination_ideal([x, z])
Exception raised:
    Traceback (most recent call last):
      File "/home/mmarco/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/mmarco/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.elimination_ideal[4]>", line 1, in <module>
        I.elimination_ideal([x, z])
      File "/home/mmarco/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2024, in elimination_ideal
        return self._elimination_ideal_libsingular(variables)
      File "/home/mmarco/sage/local/lib/python2.7/site-packages/sage/libs/singular/standard_options.py", line 140, in wrapper
        return func(*args, **kwds)
      File "/home/mmarco/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2051, in _elimination_ideal_libsingular
        Is = MPolynomialIdeal(R,self.groebner_basis())
      File "sage/structure/element.pyx", line 489, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4611)
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 502, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4720)
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 394, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2607)
        raise AttributeError(dummy_error_message)
    AttributeError: 'NCPolynomialIdeal' object has no attribute 'groebner_basis'
**********************************************************************

```


But when I run that code inside an interactive session, it works as expected.

I wonder if some of the errors come from the fact that i am developping on a python 3 environment. Seems plausible, since most are due to orderings of the answers in dictionaries.


---

Comment by tscrim created at 2019-05-07 12:54:32

Hmm...I didn't think about testing it on Python3. Frédéric (and likely John as well) will be happy that this works on both versions. I cannot say why it doesn't work by using the doctest runner but is fine in an interactive session. Maybe something is being cached or getting put in the "wrong" order in some set/dict. I can probably look into this more tomorrow.


---

Comment by mmarco created at 2019-05-07 12:58:43

Ok, if that is a big touble, we could remove the `elimination_ideal` method (it is not needed in the final implementation of `cohomology_algebra`, but it is probably good to have it anyways).


---

Comment by tscrim created at 2019-05-08 02:17:11

With Python3, I am getting the other 3 failures reported by the patchbot. So we can ignore those (I am guessing that is a Python3-based patchbot).

I still have no idea about the failure on your doctest run. Which version of Sage are you using to develop this?

I think we should either update the output to match (for the failing tests in `elimination_ideal()`, and I get the same output on both Python versions) or we just put `nc-relations: {...}` for them.


---

Comment by mmarco created at 2019-05-08 13:41:55

Maybe I had something outdated on my sage install. After doing a full rebuild, I get no errors at all.

About the ordering issues in python 3, that is a common problen for all doctests that involve dictionaries... ¿what is the general policy about that?


---

Comment by tscrim created at 2019-05-08 23:23:46

It depends on what the issue is. In this case, it seems the added tests do not differ from Python2 and Python3 (at least on my machine), and from looking at the code, it is fed off to the `SagePrettyPrinter`, so it should be consistent (if it is not, then there is a bug further down). So I think just updating the doctest output is all we need to do.


---

Comment by mmarco created at 2019-05-09 08:33:22

So, just to clarify: you also get errors in a python2 build? 

After fully compiling a sage-python2 environment, I get no errors at all.


---

Comment by tscrim created at 2019-05-09 08:34:53

Yes, that is correct. I get the same 3 errors about output order in `multi_polynomial_ideal.py`.


---

Comment by mmarco created at 2019-05-09 08:55:56

That is strange, I get the same result as the doctests. Have you rebased to the last development version? Or mayb there is something machine dependent there?


---

Comment by tscrim created at 2019-05-09 08:56:48

I am using `8.4.beta4`, so then there is a machine dependency, which is really bad.


---

Comment by tscrim created at 2019-05-09 08:57:39

Well, we can sidestep this problem by what I suggested in commnet:39 (as the nc-relations are not important for the doctest).


---

Comment by git created at 2019-05-09 10:52:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-05-09 10:52:18

If that is the only discrepancy, then I agree that is the best we can do right now. Maybe when we do the final switch to python 3 these glitches will stabilize, and get more predictable doctests.

----
New commits:


---

Comment by tscrim created at 2019-05-09 11:38:11

I wish I did have a better understanding why it is not stable even across our machines, but this will do for now. Lo mira bien a mi.


---

Comment by tscrim created at 2019-05-09 11:38:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-14 12:37:26

Resolution: fixed
