# Issue 34140: Improvements to ImageSet

archive/issues_034140.json:
```json
{
    "body": "CC:  tscrim\n\n(split out from #34340)\n\nIssue created by migration from https://trac.sagemath.org/ticket/34377\n\n",
    "created_at": "2022-08-16T21:30:07Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Improvements to ImageSet",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34140",
    "user": "mkoeppe"
}
```
CC:  tscrim

(split out from #34340)

Issue created by migration from https://trac.sagemath.org/ticket/34377





---

archive/issue_comments_484341.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-16T21:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484341",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484342.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-16T21:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484342",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_484343.json:
```json
{
    "body": "I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise). Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\nThere is also an infinite recursion that seems to be happening:\n\n```\nsrc/sage/categories/sets_cat.py  # 1 doctest failed\n```\n\n\nAlso, calling `len(list(self))` might run for forever if `self` is infinite. I think `list(self)` also does a `__len__` check too. This is also probably related to the infinite recursion above.",
    "created_at": "2022-08-17T01:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484343",
    "user": "tscrim"
}
```

I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise). Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

There is also an infinite recursion that seems to be happening:

```
src/sage/categories/sets_cat.py  # 1 doctest failed
```


Also, calling `len(list(self))` might run for forever if `self` is infinite. I think `list(self)` also does a `__len__` check too. This is also probably related to the infinite recursion above.



---

archive/issue_comments_484344.json:
```json
{
    "body": "Replying to [comment:4 tscrim]:\n> I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise).\n\nYes, I think that's a good idea\n\n> Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\nMapping back is necessary to get an element that is in the correct parent.\nThe comparison is just a safety check there.",
    "created_at": "2022-08-17T01:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484344",
    "user": "mkoeppe"
}
```

Replying to [comment:4 tscrim]:
> I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise).

Yes, I think that's a good idea

> Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

Mapping back is necessary to get an element that is in the correct parent.
The comparison is just a safety check there.



---

archive/issue_comments_484345.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> Replying to [comment:4 tscrim]:\n> > Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n> \n> Mapping back is necessary to get an element that is in the correct parent.\n> The comparison is just a safety check there.\n\nCouldn't we just do `self.codomain()(x)` for this?",
    "created_at": "2022-08-17T01:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484345",
    "user": "tscrim"
}
```

Replying to [comment:5 mkoeppe]:
> Replying to [comment:4 tscrim]:
> > Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.
> 
> Mapping back is necessary to get an element that is in the correct parent.
> The comparison is just a safety check there.

Couldn't we just do `self.codomain()(x)` for this?



---

archive/issue_comments_484346.json:
```json
{
    "body": "If it's an honest `Map`, yes, but this is supposed to work also for `PoorManMap`",
    "created_at": "2022-08-17T01:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484346",
    "user": "mkoeppe"
}
```

If it's an honest `Map`, yes, but this is supposed to work also for `PoorManMap`



---

archive/issue_comments_484347.json:
```json
{
    "body": "Ah, right. Thanks.",
    "created_at": "2022-08-17T01:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484347",
    "user": "tscrim"
}
```

Ah, right. Thanks.



---

archive/issue_comments_484348.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-17T02:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484348",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484349.json:
```json
{
    "body": "Bots are green now",
    "created_at": "2022-08-17T15:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484349",
    "user": "mkoeppe"
}
```

Bots are green now



---

archive/issue_comments_484350.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-17T15:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484350",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484351.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-20T05:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484351",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_484352.json:
```json
{
    "body": "LGTM.",
    "created_at": "2022-08-20T05:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484352",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_484353.json:
```json
{
    "body": "Thanks.",
    "created_at": "2022-08-20T05:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484353",
    "user": "mkoeppe"
}
```

Thanks.



---

archive/issue_comments_484354.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-30T19:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34140#issuecomment-484354",
    "user": "vbraun"
}
```

Resolution: fixed
