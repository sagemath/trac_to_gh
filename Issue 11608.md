# Issue 11608: Creating a polynomial ring over a number field results in a non-unique polynomial ring over the rationals

archive/issues_011608.json:
```json
{
    "body": "Assignee: @robertwb\n\nCC:  @malb\n\nKeywords: non-unique polynomial ring number field\n\nThe problem is the following code in `sage.libs.singular.ring.singular_ring_new`:\n\n```python\n    elif PY_TYPE_CHECK(base_ring, FiniteField_generic):\n        if base_ring.characteristic() <= 2147483629:\n            characteristic = -base_ring.characteristic() # note the negative characteristic\n        else:\n            raise TypeError, \"characteristic must be <= 2147483629.\"\n        # TODO: This is lazy, it should only call Singular stuff not MPolynomial stuff\n        k = MPolynomialRing_libsingular(base_ring.prime_subfield(), 1, base_ring.variable_name(), 'lex')\n        minpoly = base_ring.polynomial()(k.gen())\n        is_extension = True\n\n    elif PY_TYPE_CHECK(base_ring, NumberField) and base_ring.is_absolute():\n        characteristic = 1\n        k = MPolynomialRing_libsingular(RationalField(), 1, base_ring.variable_name(), 'lex')\n        minpoly = base_ring.polynomial()(k.gen())\n        is_extension = True\n```\n\nHence, a multivariate libsingular polynomial ring is constructed without using the (cached) polynomial ring constructor. The comment should rather not be \"This is lazy,...\" but \"This is dangerous, it should only call polynomial ring constructor stuff, not MPolynomial stuff\".\n\nI am trying to find an example in unpatched Sage where this is actually a problem. However, while working at #10667, the non-unique parents led to several hundred doctest errors in elliptic curves.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11780\n\n",
    "created_at": "2011-09-05T13:26:04Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Creating a polynomial ring over a number field results in a non-unique polynomial ring over the rationals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11608",
    "user": "https://github.com/simon-king-jena"
}
```
Assignee: @robertwb

CC:  @malb

Keywords: non-unique polynomial ring number field

The problem is the following code in `sage.libs.singular.ring.singular_ring_new`:

```python
    elif PY_TYPE_CHECK(base_ring, FiniteField_generic):
        if base_ring.characteristic() <= 2147483629:
            characteristic = -base_ring.characteristic() # note the negative characteristic
        else:
            raise TypeError, "characteristic must be <= 2147483629."
        # TODO: This is lazy, it should only call Singular stuff not MPolynomial stuff
        k = MPolynomialRing_libsingular(base_ring.prime_subfield(), 1, base_ring.variable_name(), 'lex')
        minpoly = base_ring.polynomial()(k.gen())
        is_extension = True

    elif PY_TYPE_CHECK(base_ring, NumberField) and base_ring.is_absolute():
        characteristic = 1
        k = MPolynomialRing_libsingular(RationalField(), 1, base_ring.variable_name(), 'lex')
        minpoly = base_ring.polynomial()(k.gen())
        is_extension = True
```

Hence, a multivariate libsingular polynomial ring is constructed without using the (cached) polynomial ring constructor. The comment should rather not be "This is lazy,..." but "This is dangerous, it should only call polynomial ring constructor stuff, not MPolynomial stuff".

I am trying to find an example in unpatched Sage where this is actually a problem. However, while working at #10667, the non-unique parents led to several hundred doctest errors in elliptic curves.

Issue created by migration from https://trac.sagemath.org/ticket/11780





---

archive/issue_comments_130858.json:
```json
{
    "body": "I suggest to call the polynomial ring constructor (which might actually be a little faster, since it is cached) and to catch the `TypeError` that would occur if the resulting ring happens to not be `MPolynomialRing_libsingular`.",
    "created_at": "2011-09-05T13:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130858",
    "user": "https://github.com/simon-king-jena"
}
```

I suggest to call the polynomial ring constructor (which might actually be a little faster, since it is cached) and to catch the `TypeError` that would occur if the resulting ring happens to not be `MPolynomialRing_libsingular`.



---

archive/issue_comments_130859.json:
```json
{
    "body": "I did not run tests yet, and I am not able to provide a doc test that shows that the bug is fixed. But it turns out that the patch that I just attached solves the problem I met while working at #10667, and thus I change it into \"needs review\".\n\nThe problem was as follows. Let `K.<i> = NumberField(x^2+1)`.\n\n* During initialisation of `K['x','y','z']`, by one of the patches in my patch chain, there is also an initialisation of a coercion from the base ring.\n* The construction of the coercion results in a call to `_singular_ring_new`. It constructs a non-unique libsingular version of `QQ[K.variable_name()]`. \n* The construction of `QQ[K.variable_name()]` also involves the registration of a coerce map from `QQ` to `QQ[K.variable_name()]`.\n* Now, one constructs `K['x','y']`. Again, `_singular_ring_new` is called. Again, it creates a *__new__* version of `QQ[K.variable_name()]`, and again it tries to register the coercion. But the coercion is already contained in the global coercion cache. Error.",
    "created_at": "2011-09-05T13:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130859",
    "user": "https://github.com/simon-king-jena"
}
```

I did not run tests yet, and I am not able to provide a doc test that shows that the bug is fixed. But it turns out that the patch that I just attached solves the problem I met while working at #10667, and thus I change it into "needs review".

The problem was as follows. Let `K.<i> = NumberField(x^2+1)`.

* During initialisation of `K['x','y','z']`, by one of the patches in my patch chain, there is also an initialisation of a coercion from the base ring.
* The construction of the coercion results in a call to `_singular_ring_new`. It constructs a non-unique libsingular version of `QQ[K.variable_name()]`. 
* The construction of `QQ[K.variable_name()]` also involves the registration of a coerce map from `QQ` to `QQ[K.variable_name()]`.
* Now, one constructs `K['x','y']`. Again, `_singular_ring_new` is called. Again, it creates a *__new__* version of `QQ[K.variable_name()]`, and again it tries to register the coercion. But the coercion is already contained in the global coercion cache. Error.



---

archive/issue_comments_130860.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-09-05T13:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130860",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_130861.json:
```json
{
    "body": "Why would `PolynomialRing` throw a `TypeError` and `MPolynomialRing_libsingular` would accept these parameters?",
    "created_at": "2011-09-05T14:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130861",
    "user": "https://github.com/malb"
}
```

Why would `PolynomialRing` throw a `TypeError` and `MPolynomialRing_libsingular` would accept these parameters?



---

archive/issue_comments_130862.json:
```json
{
    "body": "Replying to [comment:3 malb]:\n> Why would `PolynomialRing` throw a `TypeError` and `MPolynomialRing_libsingular` would accept these parameters?\n\n\nThe `TypeError` would not be raised by `PolynomialRing`. \n\nI was thinking about future developments. Imaging that someone plays with the polynomial ring constructor, such that a completely different class of polynomial rings would be returned. In that case, the attempt to assign the ring to the cdef variable k of type `MPolynomialRing_libsingular` would result in a `TypeError`.",
    "created_at": "2011-09-05T14:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130862",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:3 malb]:
> Why would `PolynomialRing` throw a `TypeError` and `MPolynomialRing_libsingular` would accept these parameters?


The `TypeError` would not be raised by `PolynomialRing`. 

I was thinking about future developments. Imaging that someone plays with the polynomial ring constructor, such that a completely different class of polynomial rings would be returned. In that case, the attempt to assign the ring to the cdef variable k of type `MPolynomialRing_libsingular` would result in a `TypeError`.



---

archive/issue_comments_130863.json:
```json
{
    "body": "Ah, got it. Thanks, that makes sense. The patch reads good, I haven't applied & tested it though.",
    "created_at": "2011-09-05T14:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130863",
    "user": "https://github.com/malb"
}
```

Ah, got it. Thanks, that makes sense. The patch reads good, I haven't applied & tested it though.



---

archive/issue_comments_130864.json:
```json
{
    "body": "Doctests pass. However, I gave the TypeError thing another thought. If somebody changes the class for polynomials over the base field (prime field or rational field), couldn't that again lead to problems with non-identical parents? I.e. should we cause the TypeError such that future developers will note there's a potential problem?",
    "created_at": "2011-09-05T16:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130864",
    "user": "https://github.com/malb"
}
```

Doctests pass. However, I gave the TypeError thing another thought. If somebody changes the class for polynomials over the base field (prime field or rational field), couldn't that again lead to problems with non-identical parents? I.e. should we cause the TypeError such that future developers will note there's a potential problem?



---

archive/issue_comments_130865.json:
```json
{
    "body": "I fixed another bug caused by a rogue creation of a polynomial ring: It was in the numerator() method of libsingular polynomials.\n\nThe patch, that I updated a few seconds ago, contains a new doctest:\n\n```\n        sage: P.<foo,bar> = ZZ[]\n        sage: Q.<foo,bar> = QQ[]\n        sage: f = Q.random_element()\n        sage: f.numerator().parent() is P\n        True\n```\nThe last answer was `False` in unpatched sage.",
    "created_at": "2011-09-05T17:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130865",
    "user": "https://github.com/simon-king-jena"
}
```

I fixed another bug caused by a rogue creation of a polynomial ring: It was in the numerator() method of libsingular polynomials.

The patch, that I updated a few seconds ago, contains a new doctest:

```
        sage: P.<foo,bar> = ZZ[]
        sage: Q.<foo,bar> = QQ[]
        sage: f = Q.random_element()
        sage: f.numerator().parent() is P
        True
```
The last answer was `False` in unpatched sage.



---

archive/issue_comments_130866.json:
```json
{
    "body": "Replying to [comment:6 malb]:\n> Doctests pass. However, I gave the TypeError thing another thought. If somebody changes the class for polynomials over the base field (prime field or rational field), couldn't that again lead to problems with non-identical parents? I.e. should we cause the TypeError such that future developers will note there's a potential problem?\n\n\nSorry, I saw your answer only now.\n\nYes, on second thought, it seems reasonable to not catch the type error.\n\nI am sorry that our messages crossed (I have updated my patch, it now contains a second fix and one doctest). I will remove catching the type error in a minute.",
    "created_at": "2011-09-05T17:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130866",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:6 malb]:
> Doctests pass. However, I gave the TypeError thing another thought. If somebody changes the class for polynomials over the base field (prime field or rational field), couldn't that again lead to problems with non-identical parents? I.e. should we cause the TypeError such that future developers will note there's a potential problem?


Sorry, I saw your answer only now.

Yes, on second thought, it seems reasonable to not catch the type error.

I am sorry that our messages crossed (I have updated my patch, it now contains a second fix and one doctest). I will remove catching the type error in a minute.



---

archive/issue_comments_130867.json:
```json
{
    "body": "Also, small typo at the end of this line:\n\n```\n # the integers using the (cached) polynomial ring constructor:@@@ \n```\n\n:)",
    "created_at": "2011-09-05T17:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130867",
    "user": "https://github.com/malb"
}
```

Also, small typo at the end of this line:

```
 # the integers using the (cached) polynomial ring constructor:@@@ 
```

:)



---

archive/issue_comments_130868.json:
```json
{
    "body": "I removed the typo (actually it is not a typo but a mark, in order to more easily find the spot that I was working on).\n\nI am still catching the type error, but am re-raising it with an error message that is hopefully clear enough. Well, hopefully nobody will ever see it...",
    "created_at": "2011-09-05T17:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130868",
    "user": "https://github.com/simon-king-jena"
}
```

I removed the typo (actually it is not a typo but a mark, in order to more easily find the spot that I was working on).

I am still catching the type error, but am re-raising it with an error message that is hopefully clear enough. Well, hopefully nobody will ever see it...



---

archive/issue_comments_130869.json:
```json
{
    "body": "The patchbot does not find actual errors (even though the blob is yellow). Review, anyone?",
    "created_at": "2011-09-24T13:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130869",
    "user": "https://github.com/simon-king-jena"
}
```

The patchbot does not find actual errors (even though the blob is yellow). Review, anyone?



---

archive/issue_comments_130870.json:
```json
{
    "body": "Martin, do you think you find the time to complete your review?",
    "created_at": "2011-10-26T19:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130870",
    "user": "https://github.com/simon-king-jena"
}
```

Martin, do you think you find the time to complete your review?



---

archive/issue_comments_130871.json:
```json
{
    "body": "I'll have to rebase, because #11339 (which is merged) creates a conflict.",
    "created_at": "2011-10-28T13:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130871",
    "user": "https://github.com/simon-king-jena"
}
```

I'll have to rebase, because #11339 (which is merged) creates a conflict.



---

archive/issue_comments_130872.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-10-28T13:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130872",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_130873.json:
```json
{
    "body": "Attachment [trac11780_unique_auxiliar_polyring.patch](tarball://root/attachments/some-uuid/ticket11780/trac11780_unique_auxiliar_polyring.patch) by @simon-king-jena created at 2011-10-28 13:49:26\n\nAvoid the creation of a non-unique auxiliary polynomial ring in singular_ring_new and in MPolynomial_libsingular.numerator",
    "created_at": "2011-10-28T13:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130873",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11780_unique_auxiliar_polyring.patch](tarball://root/attachments/some-uuid/ticket11780/trac11780_unique_auxiliar_polyring.patch) by @simon-king-jena created at 2011-10-28 13:49:26

Avoid the creation of a non-unique auxiliary polynomial ring in singular_ring_new and in MPolynomial_libsingular.numerator



---

archive/issue_comments_130874.json:
```json
{
    "body": "Done!",
    "created_at": "2011-10-28T13:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130874",
    "user": "https://github.com/simon-king-jena"
}
```

Done!



---

archive/issue_comments_130875.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-28T13:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130875",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_130876.json:
```json
{
    "body": "This looks fine to me, and all tests pass under 4.8.alpha5.",
    "created_at": "2012-01-01T14:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130876",
    "user": "https://github.com/loefflerd"
}
```

This looks fine to me, and all tests pass under 4.8.alpha5.



---

archive/issue_comments_130877.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-01T14:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130877",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_030992.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-02T20:44:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11608#event-30992"
}
```



---

archive/issue_comments_130878.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-18T08:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11608#issuecomment-130878",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_030993.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-18T08:15:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11608",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11608#event-30993"
}
```
