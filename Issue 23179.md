# Issue 23179: Provide a "sage -ipynb2rst" command

archive/issues_023179.json:
```json
{
    "body": "CC:  vdelecroix slabbe mlapointe\n\nWith jupyter as the default notebook, we need to easily transform an `.ipynb` notebook back into some source code. This ticket adds a `sage -ipynb2rst` command.\n\nA custom template is created to write code blocks as:\n\n\n```\n   sage: # blah\n   ....: # blah\n```\n\n\nand to make mathematics formulas the default role (hence avoiding the clumsy `:math:` notation everywhere).\n\nNote that reviewers have to run `./configure` before `make` to let this ticket work in order to copy `rst_sage.tpl` into the `local/share/sage/ext/nbconvert/` directory.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23416\n\n",
    "created_at": "2017-07-12T21:51:03Z",
    "labels": [
        "notebook",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Provide a \"sage -ipynb2rst\" command",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23179",
    "user": "tmonteil"
}
```
CC:  vdelecroix slabbe mlapointe

With jupyter as the default notebook, we need to easily transform an `.ipynb` notebook back into some source code. This ticket adds a `sage -ipynb2rst` command.

A custom template is created to write code blocks as:


```
   sage: # blah
   ....: # blah
```


and to make mathematics formulas the default role (hence avoiding the clumsy `:math:` notation everywhere).

Note that reviewers have to run `./configure` before `make` to let this ticket work in order to copy `rst_sage.tpl` into the `local/share/sage/ext/nbconvert/` directory.

Issue created by migration from https://trac.sagemath.org/ticket/23416





---

archive/issue_comments_324270.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-12T22:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324270",
    "user": "tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_324271.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-07-12T22:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324271",
    "user": "tmonteil"
}
```

New commits:



---

archive/issue_comments_324272.json:
```json
{
    "body": "Using bash 4.4.12 on Archlinux\n\n```\n$ sage -ipynb2rst measure_simulation.ipynb \n/opt/sage/src/bin/sage-ipynb2rst: ligne 39: erreur de syntaxe pr\u00e8s du symbole inattendu \u00ab ( \u00bb\n/opt/sage/src/bin/sage-ipynb2rst: ligne 39: `        jupyter nbconvert --to rst --RSTExporter.template_path=[\\'$SAGE_EXTCODE/nbconvert/\\'] --RSTExporter.template_file='rst_sage.tpl' --stdout ${1} | sed 's/:math://g' > ${2} ( echo -e '\\n' ; help ) ;;'\n```\n",
    "created_at": "2017-07-15T09:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324272",
    "user": "vdelecroix"
}
```

Using bash 4.4.12 on Archlinux

```
$ sage -ipynb2rst measure_simulation.ipynb 
/opt/sage/src/bin/sage-ipynb2rst: ligne 39: erreur de syntaxe près du symbole inattendu « ( »
/opt/sage/src/bin/sage-ipynb2rst: ligne 39: `        jupyter nbconvert --to rst --RSTExporter.template_path=[\'$SAGE_EXTCODE/nbconvert/\'] --RSTExporter.template_file='rst_sage.tpl' --stdout ${1} | sed 's/:math://g' > ${2} ( echo -e '\n' ; help ) ;;'
```




---

archive/issue_comments_324273.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-16T21:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324273",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324274.json:
```json
{
    "body": "Hmm, i copy/pasted too fast, sorry for the typo, this should work better now.",
    "created_at": "2017-07-16T21:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324274",
    "user": "tmonteil"
}
```

Hmm, i copy/pasted too fast, sorry for the typo, this should work better now.



---

archive/issue_comments_324275.json:
```json
{
    "body": "Changing keywords from \"\" to \"mathexp2018\".",
    "created_at": "2018-05-29T16:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324275",
    "user": "tmonteil"
}
```

Changing keywords from "" to "mathexp2018".



---

archive/issue_comments_324276.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-29T23:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324276",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324277.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-03T18:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324277",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324278.json:
```json
{
    "body": "We could always add improvements, but i am fine with the current behavior for a first version.",
    "created_at": "2018-06-03T18:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324278",
    "user": "tmonteil"
}
```

We could always add improvements, but i am fine with the current behavior for a first version.



---

archive/issue_comments_324279.json:
```json
{
    "body": "Changing keywords from \"mathexp2018\" to \"MathExp2018\".",
    "created_at": "2018-06-03T18:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324279",
    "user": "vdelecroix"
}
```

Changing keywords from "mathexp2018" to "MathExp2018".



---

archive/issue_comments_324280.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-03T19:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324280",
    "user": "slabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_324281.json:
```json
{
    "body": "Thierry, can you add a doctest [here](https://github.com/sagemath/sage/blob/854f9764d14236110b8d7f7b35a7d52017e044f8/src/sage/tests/cmdline.py#L647) in src/sage/tests/cmdline.py please?",
    "created_at": "2018-06-03T19:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324281",
    "user": "slabbe"
}
```

Thierry, can you add a doctest [here](https://github.com/sagemath/sage/blob/854f9764d14236110b8d7f7b35a7d52017e044f8/src/sage/tests/cmdline.py#L647) in src/sage/tests/cmdline.py please?



---

archive/issue_comments_324282.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-03T22:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324282",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324283.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-03T22:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324283",
    "user": "tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_324284.json:
```json
{
    "body": "Done.",
    "created_at": "2018-06-03T22:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324284",
    "user": "tmonteil"
}
```

Done.



---

archive/issue_comments_324285.json:
```json
{
    "body": "Typo: `the header that define` -> `the header that defines`",
    "created_at": "2018-06-04T06:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324285",
    "user": "jdemeyer"
}
```

Typo: `the header that define` -> `the header that defines`



---

archive/issue_comments_324286.json:
```json
{
    "body": "I generally don't like checks of the form\n\n```\n# tests if dependencies are available\npandoc -v > /dev/null 2>&1 || fail 'sage -ipynb2rst requires pandoc; please install it on your system.'\n```\n\nbecause it is not at all obvious that the `jupyter nbconvert` command will correctly execute `pandoc` if and only if that check above works. For example, if the `pandoc` command is configurable (I have no idea whether it is, but it might be), then you are doing the wrong check. Also, maybe `pandoc` fails to run because of a different reason than it not being installed (say, it is missing some library).\n\nSo unless there is a good reason to add that check, I would prefer to remove it.",
    "created_at": "2018-06-04T07:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324286",
    "user": "jdemeyer"
}
```

I generally don't like checks of the form

```
# tests if dependencies are available
pandoc -v > /dev/null 2>&1 || fail 'sage -ipynb2rst requires pandoc; please install it on your system.'
```

because it is not at all obvious that the `jupyter nbconvert` command will correctly execute `pandoc` if and only if that check above works. For example, if the `pandoc` command is configurable (I have no idea whether it is, but it might be), then you are doing the wrong check. Also, maybe `pandoc` fails to run because of a different reason than it not being installed (say, it is missing some library).

So unless there is a good reason to add that check, I would prefer to remove it.



---

archive/issue_comments_324287.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-04T07:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324287",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_324288.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-04T07:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324288",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324289.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-04T07:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324289",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324290.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-04T07:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324290",
    "user": "tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_324291.json:
```json
{
    "body": "Done. Sorry, it seems i cannot refrain to ask for permission ;)",
    "created_at": "2018-06-04T07:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324291",
    "user": "tmonteil"
}
```

Done. Sorry, it seems i cannot refrain to ask for permission ;)



---

archive/issue_comments_324292.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-06-07T21:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324292",
    "user": "slabbe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_324293.json:
```json
{
    "body": "`sage -sws2rst file.sws` puts images into a `file_media` folder. Should we follow the same idea here instead of putting the images in the `.`?",
    "created_at": "2018-06-07T21:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324293",
    "user": "slabbe"
}
```

`sage -sws2rst file.sws` puts images into a `file_media` folder. Should we follow the same idea here instead of putting the images in the `.`?



---

archive/issue_comments_324294.json:
```json
{
    "body": "Why\n\n\n\n\n```\n        sage: L = [\"sage\", \"--ipynb2rst\", input, output]\n        sage: try:\n        ....:     _ = test_executable(['pandoc', '--version'])\n        ....: except OSError:\n        ....:     print('True')\n        ....: else:\n        ....:     _ = test_executable(L)\n        ....:     print(open(output, 'r').read() == t)\n        True\n```\n\n\ninstead of\n\n\n```\nsage: L = [\"sage\", \"--ipynb2rst\", input, output]\nsage: _ = test_executable(L)                     # optional: pandoc\nsage: print(open(output, 'r').read() == t)       # optional: pandoc\nTrue\n```\n\n?",
    "created_at": "2018-06-07T21:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324294",
    "user": "slabbe"
}
```

Why




```
        sage: L = ["sage", "--ipynb2rst", input, output]
        sage: try:
        ....:     _ = test_executable(['pandoc', '--version'])
        ....: except OSError:
        ....:     print('True')
        ....: else:
        ....:     _ = test_executable(L)
        ....:     print(open(output, 'r').read() == t)
        True
```


instead of


```
sage: L = ["sage", "--ipynb2rst", input, output]
sage: _ = test_executable(L)                     # optional: pandoc
sage: print(open(output, 'r').read() == t)       # optional: pandoc
True
```

?



---

archive/issue_comments_324295.json:
```json
{
    "body": "Replying to [comment:20 slabbe]:\n> Why\n> \n> \n> \n> {{{\n>         sage: L = [\"sage\", \"--ipynb2rst\", input, output]\n>         sage: try:\n>         ....:     _ = test_executable(['pandoc', '--version'])\n>         ....: except OSError:\n>         ....:     print('True')\n>         ....: else:\n>         ....:     _ = test_executable(L)\n>         ....:     print(open(output, 'r').read() == t)\n>         True\n> }}}\n> \n> instead of\n> \n> {{{\n> sage: L = [\"sage\", \"--ipynb2rst\", input, output]\n> sage: _ = test_executable(L)                     # optional: pandoc\n> sage: print(open(output, 'r').read() == t)       # optional: pandoc\n> True\n> }}}\n> ?\n\nBecause pandoc is not an optional package but a system dependency, so the doctest will never be run (unless someone explicitely ask for it).",
    "created_at": "2018-06-07T22:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324295",
    "user": "tmonteil"
}
```

Replying to [comment:20 slabbe]:
> Why
> 
> 
> 
> {{{
>         sage: L = ["sage", "--ipynb2rst", input, output]
>         sage: try:
>         ....:     _ = test_executable(['pandoc', '--version'])
>         ....: except OSError:
>         ....:     print('True')
>         ....: else:
>         ....:     _ = test_executable(L)
>         ....:     print(open(output, 'r').read() == t)
>         True
> }}}
> 
> instead of
> 
> {{{
> sage: L = ["sage", "--ipynb2rst", input, output]
> sage: _ = test_executable(L)                     # optional: pandoc
> sage: print(open(output, 'r').read() == t)       # optional: pandoc
> True
> }}}
> ?

Because pandoc is not an optional package but a system dependency, so the doctest will never be run (unless someone explicitely ask for it).



---

archive/issue_comments_324296.json:
```json
{
    "body": "Replying to [comment:21 tmonteil]:\n> Replying to [comment:20 slabbe]:\n> > Why\n> > \n> > \n> > \n> > {{{\n> >         sage: L = [\"sage\", \"--ipynb2rst\", input, output]\n> >         sage: try:\n> >         ....:     _ = test_executable(['pandoc', '--version'])\n> >         ....: except OSError:\n> >         ....:     print('True')\n> >         ....: else:\n> >         ....:     _ = test_executable(L)\n> >         ....:     print(open(output, 'r').read() == t)\n> >         True\n> > }}}\n> > \n> > instead of\n> > \n> > {{{\n> > sage: L = [\"sage\", \"--ipynb2rst\", input, output]\n> > sage: _ = test_executable(L)                     # optional: pandoc\n> > sage: print(open(output, 'r').read() == t)       # optional: pandoc\n> > True\n> > }}}\n> > ?\n> \n> Because pandoc is not an optional package but a system dependency, so the doctest will never be run (unless someone explicitely ask for it).\n\nyou can add `has_pandoc` in `sage.doctest.external` so that it can be properly detected (see also #25305).",
    "created_at": "2018-06-08T15:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324296",
    "user": "vdelecroix"
}
```

Replying to [comment:21 tmonteil]:
> Replying to [comment:20 slabbe]:
> > Why
> > 
> > 
> > 
> > {{{
> >         sage: L = ["sage", "--ipynb2rst", input, output]
> >         sage: try:
> >         ....:     _ = test_executable(['pandoc', '--version'])
> >         ....: except OSError:
> >         ....:     print('True')
> >         ....: else:
> >         ....:     _ = test_executable(L)
> >         ....:     print(open(output, 'r').read() == t)
> >         True
> > }}}
> > 
> > instead of
> > 
> > {{{
> > sage: L = ["sage", "--ipynb2rst", input, output]
> > sage: _ = test_executable(L)                     # optional: pandoc
> > sage: print(open(output, 'r').read() == t)       # optional: pandoc
> > True
> > }}}
> > ?
> 
> Because pandoc is not an optional package but a system dependency, so the doctest will never be run (unless someone explicitely ask for it).

you can add `has_pandoc` in `sage.doctest.external` so that it can be properly detected (see also #25305).



---

archive/issue_comments_324297.json:
```json
{
    "body": "Why not. Then, i will wait the next beta to avoid useless rebasing mess.",
    "created_at": "2018-06-08T18:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324297",
    "user": "tmonteil"
}
```

Why not. Then, i will wait the next beta to avoid useless rebasing mess.



---

archive/issue_comments_324298.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-02T16:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324298",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_324299.json:
```json
{
    "body": "Changing keywords from \"MathExp2018\" to \"MathExp2018, days94\".",
    "created_at": "2018-07-02T16:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324299",
    "user": "tmonteil"
}
```

Changing keywords from "MathExp2018" to "MathExp2018, days94".



---

archive/issue_comments_324300.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-07-02T16:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324300",
    "user": "tmonteil"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_324301.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-04T19:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324301",
    "user": "slabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_324302.json:
```json
{
    "body": "Changing keywords from \"MathExp2018, days94\" to \"MathExp2018, days94, thursdaysbdx\".",
    "created_at": "2018-07-05T09:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324302",
    "user": "slabbe"
}
```

Changing keywords from "MathExp2018, days94" to "MathExp2018, days94, thursdaysbdx".



---

archive/issue_comments_324303.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-07-08T13:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-324303",
    "user": "vbraun"
}
```

Resolution: fixed
