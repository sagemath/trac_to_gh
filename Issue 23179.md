# Issue 23179: Provide a "sage -ipynb2rst" command

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2017-07-12 21:51:03

CC:  vdelecroix slabbe mlapointe

With jupyter as the default notebook, we need to easily transform an `.ipynb` notebook back into some source code. This ticket adds a `sage -ipynb2rst` command.

A custom template is created to write code blocks as:


```
   sage: # blah
   ....: # blah
```


and to make mathematics formulas the default role (hence avoiding the clumsy `:math:` notation everywhere).

Note that reviewers have to run `./configure` before `make` to let this ticket work in order to copy `rst_sage.tpl` into the `local/share/sage/ext/nbconvert/` directory.


---

Comment by tmonteil created at 2017-07-12 22:11:38

Changing status from new to needs_review.


---

Comment by tmonteil created at 2017-07-12 22:11:38

New commits:


---

Comment by vdelecroix created at 2017-07-15 09:51:17

Using bash 4.4.12 on Archlinux

```
$ sage -ipynb2rst measure_simulation.ipynb 
/opt/sage/src/bin/sage-ipynb2rst: ligne 39: erreur de syntaxe près du symbole inattendu « ( »
/opt/sage/src/bin/sage-ipynb2rst: ligne 39: `        jupyter nbconvert --to rst --RSTExporter.template_path=[\'$SAGE_EXTCODE/nbconvert/\'] --RSTExporter.template_file='rst_sage.tpl' --stdout ${1} | sed 's/:math://g' > ${2} ( echo -e '\n' ; help ) ;;'
```



---

Comment by git created at 2017-07-16 21:14:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2017-07-16 21:17:34

Hmm, i copy/pasted too fast, sorry for the typo, this should work better now.


---

Comment by tmonteil created at 2018-05-29 16:58:52

Changing keywords from "" to "mathexp2018".


---

Comment by git created at 2018-05-29 23:10:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-03 18:14:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-06-03 18:27:24

We could always add improvements, but i am fine with the current behavior for a first version.


---

Comment by vdelecroix created at 2018-06-03 18:38:40

Changing keywords from "mathexp2018" to "MathExp2018".


---

Comment by slabbe created at 2018-06-03 19:40:45

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2018-06-03 19:40:45

Thierry, can you add a doctest [here](https://github.com/sagemath/sage/blob/854f9764d14236110b8d7f7b35a7d52017e044f8/src/sage/tests/cmdline.py#L647) in src/sage/tests/cmdline.py please?


---

Comment by git created at 2018-06-03 22:13:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-06-03 22:13:57

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2018-06-03 22:13:57

Done.


---

Comment by jdemeyer created at 2018-06-04 06:58:28

Typo: `the header that define` -> `the header that defines`


---

Comment by jdemeyer created at 2018-06-04 07:03:34

I generally don't like checks of the form

```
# tests if dependencies are available
pandoc -v > /dev/null 2>&1 || fail 'sage -ipynb2rst requires pandoc; please install it on your system.'
```

because it is not at all obvious that the `jupyter nbconvert` command will correctly execute `pandoc` if and only if that check above works. For example, if the `pandoc` command is configurable (I have no idea whether it is, but it might be), then you are doing the wrong check. Also, maybe `pandoc` fails to run because of a different reason than it not being installed (say, it is missing some library).

So unless there is a good reason to add that check, I would prefer to remove it.


---

Comment by jdemeyer created at 2018-06-04 07:03:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-04 07:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-04 07:29:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-06-04 07:35:18

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2018-06-04 07:35:18

Done. Sorry, it seems i cannot refrain to ask for permission ;)


---

Comment by slabbe created at 2018-06-07 21:09:14

Changing status from needs_review to needs_info.


---

Comment by slabbe created at 2018-06-07 21:09:14

`sage -sws2rst file.sws` puts images into a `file_media` folder. Should we follow the same idea here instead of putting the images in the `.`?


---

Comment by slabbe created at 2018-06-07 21:17:19

Why




```
        sage: L = ["sage", "--ipynb2rst", input, output]
        sage: try:
        ....:     _ = test_executable(['pandoc', '--version'])
        ....: except OSError:
        ....:     print('True')
        ....: else:
        ....:     _ = test_executable(L)
        ....:     print(open(output, 'r').read() == t)
        True
```


instead of


```
sage: L = ["sage", "--ipynb2rst", input, output]
sage: _ = test_executable(L)                     # optional: pandoc
sage: print(open(output, 'r').read() == t)       # optional: pandoc
True
```

?


---

Comment by tmonteil created at 2018-06-07 22:17:05

Replying to [comment:20 slabbe]:
> Why
> 
> 
> 
> {{{
>         sage: L = ["sage", "--ipynb2rst", input, output]
>         sage: try:
>         ....:     _ = test_executable(['pandoc', '--version'])
>         ....: except OSError:
>         ....:     print('True')
>         ....: else:
>         ....:     _ = test_executable(L)
>         ....:     print(open(output, 'r').read() == t)
>         True
> }}}
> 
> instead of
> 
> {{{
> sage: L = ["sage", "--ipynb2rst", input, output]
> sage: _ = test_executable(L)                     # optional: pandoc
> sage: print(open(output, 'r').read() == t)       # optional: pandoc
> True
> }}}
> ?

Because pandoc is not an optional package but a system dependency, so the doctest will never be run (unless someone explicitely ask for it).


---

Comment by vdelecroix created at 2018-06-08 15:19:22

Replying to [comment:21 tmonteil]:
> Replying to [comment:20 slabbe]:
> > Why
> > 
> > 
> > 
> > {{{
> >         sage: L = ["sage", "--ipynb2rst", input, output]
> >         sage: try:
> >         ....:     _ = test_executable(['pandoc', '--version'])
> >         ....: except OSError:
> >         ....:     print('True')
> >         ....: else:
> >         ....:     _ = test_executable(L)
> >         ....:     print(open(output, 'r').read() == t)
> >         True
> > }}}
> > 
> > instead of
> > 
> > {{{
> > sage: L = ["sage", "--ipynb2rst", input, output]
> > sage: _ = test_executable(L)                     # optional: pandoc
> > sage: print(open(output, 'r').read() == t)       # optional: pandoc
> > True
> > }}}
> > ?
> 
> Because pandoc is not an optional package but a system dependency, so the doctest will never be run (unless someone explicitely ask for it).

you can add `has_pandoc` in `sage.doctest.external` so that it can be properly detected (see also #25305).


---

Comment by tmonteil created at 2018-06-08 18:58:29

Why not. Then, i will wait the next beta to avoid useless rebasing mess.


---

Comment by git created at 2018-07-02 16:25:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-07-02 16:27:03

Changing keywords from "MathExp2018" to "MathExp2018, days94".


---

Comment by tmonteil created at 2018-07-02 16:27:03

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2018-07-04 19:44:22

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2018-07-05 09:00:56

Changing keywords from "MathExp2018, days94" to "MathExp2018, days94, thursdaysbdx".


---

Comment by vbraun created at 2018-07-08 13:05:34

Resolution: fixed
