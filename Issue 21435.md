# Issue 21435: Race condition in pkg_resources

archive/issues_021435.json:
```json
{
    "body": "CC:  embray\n\nJust like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.\n\nExample:\n\n```\n[backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4\n[pytz-2016.4.p0] Traceback (most recent call last):\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/bin/pip\", line 9, in <module>\n[pytz-2016.4.p0]     load_entry_point('pip==8.1.2', 'console_scripts', 'pip')()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 542, in load_entry_point\n[pytz-2016.4.p0]     return get_distribution(dist).load_entry_point(group, name)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2569, in load_entry_point\n[pytz-2016.4.p0]     return ep.load()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2229, in load\n[pytz-2016.4.p0]     return self.resolve()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2235, in resolve\n[pytz-2016.4.p0]     module = __import__(self.module_name, fromlist=['__name__'], level=0)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/__init__.py\", line 14, in <module>\n[pytz-2016.4.p0]     from pip.utils import get_installed_distributions, get_prog\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/utils/__init__.py\", line 27, in <module>\n[pytz-2016.4.p0]     from pip._vendor import pkg_resources\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 2927, in <module>\n[pytz-2016.4.p0]     @_call_aside\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 2913, in _call_aside\n[pytz-2016.4.p0]     f(*args, **kwargs)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 2940, in _initialize_master_working_set\n[pytz-2016.4.p0]     working_set = WorkingSet._build_master()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 626, in _build_master\n[pytz-2016.4.p0]     ws = cls()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 619, in __init__\n[pytz-2016.4.p0]     self.add_entry(entry)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 675, in add_entry\n[pytz-2016.4.p0]     for dist in find_distributions(entry, True):\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1942, in find_eggs_in_zip\n[pytz-2016.4.p0]     if metadata.has_metadata('PKG-INFO'):\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1463, in has_metadata\n[pytz-2016.4.p0]     return self.egg_info and self._has(self._fn(self.egg_info, name))\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1824, in _has\n[pytz-2016.4.p0]     return zip_path in self.zipinfo or zip_path in self._index()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1704, in zipinfo\n[pytz-2016.4.p0]     return self._zip_manifests.load(self.loader.archive)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1644, in load\n[pytz-2016.4.p0]     mtime = os.stat(path).st_mtime\n[pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'\n```\n\nPossibly, this race condition only happens while *uninstalling* a package.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21672\n\n",
    "created_at": "2016-10-09T18:21:02Z",
    "labels": [
        "build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Race condition in pkg_resources",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21435",
    "user": "jdemeyer"
}
```
CC:  embray

Just like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.

Example:

```
[backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4
[pytz-2016.4.p0] Traceback (most recent call last):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/bin/pip", line 9, in <module>
[pytz-2016.4.p0]     load_entry_point('pip==8.1.2', 'console_scripts', 'pip')()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 542, in load_entry_point
[pytz-2016.4.p0]     return get_distribution(dist).load_entry_point(group, name)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2569, in load_entry_point
[pytz-2016.4.p0]     return ep.load()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2229, in load
[pytz-2016.4.p0]     return self.resolve()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2235, in resolve
[pytz-2016.4.p0]     module = __import__(self.module_name, fromlist=['__name__'], level=0)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/__init__.py", line 14, in <module>
[pytz-2016.4.p0]     from pip.utils import get_installed_distributions, get_prog
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/utils/__init__.py", line 27, in <module>
[pytz-2016.4.p0]     from pip._vendor import pkg_resources
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2927, in <module>
[pytz-2016.4.p0]     @_call_aside
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2913, in _call_aside
[pytz-2016.4.p0]     f(*args, **kwargs)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2940, in _initialize_master_working_set
[pytz-2016.4.p0]     working_set = WorkingSet._build_master()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 626, in _build_master
[pytz-2016.4.p0]     ws = cls()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 619, in __init__
[pytz-2016.4.p0]     self.add_entry(entry)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 675, in add_entry
[pytz-2016.4.p0]     for dist in find_distributions(entry, True):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1942, in find_eggs_in_zip
[pytz-2016.4.p0]     if metadata.has_metadata('PKG-INFO'):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1463, in has_metadata
[pytz-2016.4.p0]     return self.egg_info and self._has(self._fn(self.egg_info, name))
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1824, in _has
[pytz-2016.4.p0]     return zip_path in self.zipinfo or zip_path in self._index()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1704, in zipinfo
[pytz-2016.4.p0]     return self._zip_manifests.load(self.loader.archive)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1644, in load
[pytz-2016.4.p0]     mtime = os.stat(path).st_mtime
[pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'
```

Possibly, this race condition only happens while *uninstalling* a package.

Issue created by migration from https://trac.sagemath.org/ticket/21672





---

archive/issue_comments_297474.json:
```json
{
    "body": "I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster). Although I did a `make distclean` and the Sage build went without problems, so it might not be related.",
    "created_at": "2016-10-09T18:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297474",
    "user": "tscrim"
}
```

I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster). Although I did a `make distclean` and the Sage build went without problems, so it might not be related.



---

archive/issue_comments_297475.json:
```json
{
    "body": "Replying to [comment:1 tscrim]:\n> I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster).\n\nThe building of Python packages now involves uninstalling the packages first. See #21441.\n\n> Although I did a `make distclean` and the Sage build went without problems, so it might not be related.\n\nOr it further proves my hypothesis that the problems happen only while *uninstalling* a package. If you do `make distclean` first, there is nothing to uninstall.",
    "created_at": "2016-10-10T06:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297475",
    "user": "jdemeyer"
}
```

Replying to [comment:1 tscrim]:
> I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster).

The building of Python packages now involves uninstalling the packages first. See #21441.

> Although I did a `make distclean` and the Sage build went without problems, so it might not be related.

Or it further proves my hypothesis that the problems happen only while *uninstalling* a package. If you do `make distclean` first, there is nothing to uninstall.



---

archive/issue_comments_297476.json:
```json
{
    "body": "I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.  It was never really designed to be run in parallel like this.  Previously this was achieved in a patch sage has for setuptools (which impacted locking around easy_install).  With easy_install the situation was much more severe, and could cause broken installation.  I don't think pip has many problems surrounding installation, but I can see how it could break like this during uninstallation.\n\nJeroen is right that this specific issue was egg-related.  I don't know if there are other similar issues that could occur though even without eggs.",
    "created_at": "2016-10-10T14:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297476",
    "user": "embray"
}
```

I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.  It was never really designed to be run in parallel like this.  Previously this was achieved in a patch sage has for setuptools (which impacted locking around easy_install).  With easy_install the situation was much more severe, and could cause broken installation.  I don't think pip has many problems surrounding installation, but I can see how it could break like this during uninstallation.

Jeroen is right that this specific issue was egg-related.  I don't know if there are other similar issues that could occur though even without eggs.



---

archive/issue_comments_297477.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n> I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.\n\nOr a\n\n```\ntry:\n    ...\nexcept OSError:\n    pass\n```\n\nin the right place. But then you have to understand the code better.",
    "created_at": "2016-10-10T14:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297477",
    "user": "jdemeyer"
}
```

Replying to [comment:4 embray]:
> I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.

Or a

```
try:
    ...
except OSError:
    pass
```

in the right place. But then you have to understand the code better.



---

archive/issue_comments_297478.json:
```json
{
    "body": "I specifically meant without patching anything (i.e. something at the level of `sage-pip-install`).  Though a patch that can submitted upstream would be good too.",
    "created_at": "2016-10-10T15:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297478",
    "user": "embray"
}
```

I specifically meant without patching anything (i.e. something at the level of `sage-pip-install`).  Though a patch that can submitted upstream would be good too.



---

archive/issue_comments_297479.json:
```json
{
    "body": "Good, I'm glad this was caught. On an incremental build from 7.4.beta6 to 7.4.rc0 I guess I had to type `make` close to 10 times before Sage and the docs were built. I assumed perhaps a `slow` download connection interfered with parallel building. But this seems much more reasonable.\n----\nNew commits:",
    "created_at": "2016-10-10T23:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297479",
    "user": "strogdon"
}
```

Good, I'm glad this was caught. On an incremental build from 7.4.beta6 to 7.4.rc0 I guess I had to type `make` close to 10 times before Sage and the docs were built. I assumed perhaps a `slow` download connection interfered with parallel building. But this seems much more reasonable.
----
New commits:



---

archive/issue_comments_297480.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-11T07:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297480",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_297481.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-11T07:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297481",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_297482.json:
```json
{
    "body": "This patch seems to fix the issues within Sage. Erik, what do you think?",
    "created_at": "2016-10-11T07:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297482",
    "user": "jdemeyer"
}
```

This patch seems to fix the issues within Sage. Erik, what do you think?



---

archive/issue_comments_297483.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-10-11T08:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297483",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_297484.json:
```json
{
    "body": "Any idea how to interpret this traceback?\n\n```\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2913, in _call_aside\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2940, in _initialize_master_working_set\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 626, in _build_master\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 619, in __init__\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 675, in add_entry\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1942, in find_eggs_in_zip\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1463, in has_metadata\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1824, in _has\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1704, in zipinfo\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1644, in load\n[python_openid-2.2.5.p0] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/pathlib2-2.1.0-py2.7.egg'\n```\n\n\nWhy does it refer to files in `build/bdist.linux-x86_64/egg/pkg_resources`? Where is that place?",
    "created_at": "2016-10-11T08:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297484",
    "user": "jdemeyer"
}
```

Any idea how to interpret this traceback?

```
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2913, in _call_aside
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2940, in _initialize_master_working_set
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 626, in _build_master
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 619, in __init__
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 675, in add_entry
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1942, in find_eggs_in_zip
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1463, in has_metadata
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1824, in _has
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1704, in zipinfo
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1644, in load
[python_openid-2.2.5.p0] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/pathlib2-2.1.0-py2.7.egg'
```


Why does it refer to files in `build/bdist.linux-x86_64/egg/pkg_resources`? Where is that place?



---

archive/issue_comments_297485.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-11T08:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297485",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_297486.json:
```json
{
    "body": "Answering my own question:\n\n```\n>>> import pkg_resources\n>>> pkg_resources.__file__\n'/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools-24.0.2-py2.7.egg/pkg_resources/__init__.pyc'\n```\n\n\nSo `setuptools` also has a copy of `pkg_resources` (inside an egg, so `find` doesn't find it and tracebacks are hard to interpret)",
    "created_at": "2016-10-11T08:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297486",
    "user": "jdemeyer"
}
```

Answering my own question:

```
>>> import pkg_resources
>>> pkg_resources.__file__
'/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools-24.0.2-py2.7.egg/pkg_resources/__init__.pyc'
```


So `setuptools` also has a copy of `pkg_resources` (inside an egg, so `find` doesn't find it and tracebacks are hard to interpret)



---

archive/issue_comments_297487.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-11T08:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297487",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_297488.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-11T09:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297488",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_297489.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-10-11T11:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297489",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_297490.json:
```json
{
    "body": "OK, I needed a few iterations to get this right. But now it seems to work.\n\nThe way I tested this:\n\n1. Build `sage-7.4.beta2` (the last version before #20218).\n\n2. Build `sage-7.4.beta6` (the last version before #21441).\n\n3. Build this branch with lots of processes.",
    "created_at": "2016-10-11T11:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297490",
    "user": "jdemeyer"
}
```

OK, I needed a few iterations to get this right. But now it seems to work.

The way I tested this:

1. Build `sage-7.4.beta2` (the last version before #20218).

2. Build `sage-7.4.beta6` (the last version before #21441).

3. Build this branch with lots of processes.



---

archive/issue_comments_297491.json:
```json
{
    "body": "I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.\n\n`pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.",
    "created_at": "2016-10-11T12:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297491",
    "user": "jdemeyer"
}
```

I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.

`pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.



---

archive/issue_comments_297492.json:
```json
{
    "body": "Regarding the last comment, this kind of code is problematic (example taken from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`):\n\n```python\ntry:\n    from certifi import where\nexcept ImportError:\n    def where():\n        \"\"\"Return the preferred certificate bundle.\"\"\"\n        # vendored bundle inside Requests\n        return os.path.join(os.path.dirname(__file__), 'cacert.pem')\n```\n\n\nIt is possible that one `pip` instance runs `from certifi import where` while another `pip` instance uninstalls `certifi` at the same time.",
    "created_at": "2016-10-11T12:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297492",
    "user": "jdemeyer"
}
```

Regarding the last comment, this kind of code is problematic (example taken from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`):

```python
try:
    from certifi import where
except ImportError:
    def where():
        """Return the preferred certificate bundle."""
        # vendored bundle inside Requests
        return os.path.join(os.path.dirname(__file__), 'cacert.pem')
```


It is possible that one `pip` instance runs `from certifi import where` while another `pip` instance uninstalls `certifi` at the same time.



---

archive/issue_comments_297493.json:
```json
{
    "body": "Right--my problem with this approach to fixing it is that I don't think pip was meant to run in parallel at all--much less when it's also uninstalling things.\n\nSprinkling the code with ignored `OSError`s in various places is probably not a solution that will be accepted upstream, where one would instead want more careful design to allow parallel execution in a consistent manner.\n\nThat said, if this works around the issue for our purposes for now I'm fine with it.  The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.",
    "created_at": "2016-10-11T12:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297493",
    "user": "embray"
}
```

Right--my problem with this approach to fixing it is that I don't think pip was meant to run in parallel at all--much less when it's also uninstalling things.

Sprinkling the code with ignored `OSError`s in various places is probably not a solution that will be accepted upstream, where one would instead want more careful design to allow parallel execution in a consistent manner.

That said, if this works around the issue for our purposes for now I'm fine with it.  The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.



---

archive/issue_comments_297494.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-10-11T12:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297494",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_297495.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.\n> \n> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.\n\nRight.  This is why I was suggesting a lock around pip itself.  Especially an \"uninstall\" lock--don't let any other pip run if one pip is uninstalling.",
    "created_at": "2016-10-11T12:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297495",
    "user": "embray"
}
```

Replying to [comment:19 jdemeyer]:
> I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.
> 
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

Right.  This is why I was suggesting a lock around pip itself.  Especially an "uninstall" lock--don't let any other pip run if one pip is uninstalling.



---

archive/issue_comments_297496.json:
```json
{
    "body": "Replying to [comment:21 embray]:\n> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.\n\nThat doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.",
    "created_at": "2016-10-11T12:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297496",
    "user": "jdemeyer"
}
```

Replying to [comment:21 embray]:
> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.



---

archive/issue_comments_297497.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.\n\nI am currently trying to determine how serious this is. If it's just a few places (which is what I would guess), then we can patch those to always use the vendored package.",
    "created_at": "2016-10-11T13:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297497",
    "user": "jdemeyer"
}
```

Replying to [comment:19 jdemeyer]:
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

I am currently trying to determine how serious this is. If it's just a few places (which is what I would guess), then we can patch those to always use the vendored package.



---

archive/issue_comments_297498.json:
```json
{
    "body": "Replying to [comment:22 embray]:\n> Right.  This is why I was suggesting a lock around pip itself.  Especially an \"uninstall\" lock--don't let any other pip run if one pip is uninstalling.\n\nI don't like that since it would slow down parallel builds.\n\nOf course, if it's the only feasible solution, we should go for that.",
    "created_at": "2016-10-11T13:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297498",
    "user": "jdemeyer"
}
```

Replying to [comment:22 embray]:
> Right.  This is why I was suggesting a lock around pip itself.  Especially an "uninstall" lock--don't let any other pip run if one pip is uninstalling.

I don't like that since it would slow down parallel builds.

Of course, if it's the only feasible solution, we should go for that.



---

archive/issue_comments_297499.json:
```json
{
    "body": "I mean, of course the ideal solution would be if pip could run sensibly in parallel, but that might be intractable for some of the reasons you've raised.  It might not have much impact--uninstalling, after all, is little more than removing some directories--probably most of the overhead is just in process startup/shutdown.",
    "created_at": "2016-10-11T13:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297499",
    "user": "embray"
}
```

I mean, of course the ideal solution would be if pip could run sensibly in parallel, but that might be intractable for some of the reasons you've raised.  It might not have much impact--uninstalling, after all, is little more than removing some directories--probably most of the overhead is just in process startup/shutdown.



---

archive/issue_comments_297500.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Replying to [comment:21 embray]:\n> > The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.\n> \n> That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.\n\nRight, so you would have to handle OSError in there too in some sensible way.",
    "created_at": "2016-10-11T13:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297500",
    "user": "embray"
}
```

Replying to [comment:23 jdemeyer]:
> Replying to [comment:21 embray]:
> > The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.
> 
> That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.

Right, so you would have to handle OSError in there too in some sensible way.



---

archive/issue_comments_297501.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.\n\nTo solve this issue, I see 3 posssible solutions:\n\n1. Ensure that `sys.path` only contains the Python standard library directories (in particular, not `site-packages`) while running `pip`.\n\n2. Change the vendored code inside `pip` to not import any non-vendored libraries. For example, the code from [comment:20] could be changed to just define `def where()` unconditionally.\n\n3. Implement a locking mechanism while running `pip` (which would immediately solve all race conditions with `pip` but would slow down a parallel build).\n\nErik, what is your opinion?",
    "created_at": "2016-10-11T15:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297501",
    "user": "jdemeyer"
}
```

Replying to [comment:19 jdemeyer]:
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

To solve this issue, I see 3 posssible solutions:

1. Ensure that `sys.path` only contains the Python standard library directories (in particular, not `site-packages`) while running `pip`.

2. Change the vendored code inside `pip` to not import any non-vendored libraries. For example, the code from [comment:20] could be changed to just define `def where()` unconditionally.

3. Implement a locking mechanism while running `pip` (which would immediately solve all race conditions with `pip` but would slow down a parallel build).

Erik, what is your opinion?



---

archive/issue_comments_297502.json:
```json
{
    "body": "!#3 is my favorite as I've probably already expressed.  But it's also harder/more work, but do-able.  So for now I like a combination of !#1 and !#2.  For !#2 I wonder if it wouldn't be worth adding a global flag somewhere to pip that explicitly prevents it from using any non-vendored libs, as that would be a solution that might be worth offering upstream.",
    "created_at": "2016-10-11T15:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297502",
    "user": "embray"
}
```

!#3 is my favorite as I've probably already expressed.  But it's also harder/more work, but do-able.  So for now I like a combination of !#1 and !#2.  For !#2 I wonder if it wouldn't be worth adding a global flag somewhere to pip that explicitly prevents it from using any non-vendored libs, as that would be a solution that might be worth offering upstream.



---

archive/issue_comments_297503.json:
```json
{
    "body": "Replying to [comment:29 embray]:\n> So for now I like a combination of !#1 and !#2.\n\nI don't quite understand what you mean with \"combination\". Either solution individually fixes the problem.",
    "created_at": "2016-10-11T18:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297503",
    "user": "jdemeyer"
}
```

Replying to [comment:29 embray]:
> So for now I like a combination of !#1 and !#2.

I don't quite understand what you mean with "combination". Either solution individually fixes the problem.



---

archive/issue_comments_297504.json:
```json
{
    "body": "I have an idea to implement !#1. I'll see if I can make it work.",
    "created_at": "2016-10-12T08:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297504",
    "user": "jdemeyer"
}
```

I have an idea to implement !#1. I'll see if I can make it work.



---

archive/issue_comments_297505.json:
```json
{
    "body": "After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.",
    "created_at": "2016-10-12T08:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297505",
    "user": "embray"
}
```

After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.



---

archive/issue_comments_297506.json:
```json
{
    "body": "Replying to [comment:21 embray]:\n> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.\n\nI looked into this a bit more and I honestly think that the current places where I added `OSError` are optimal. Putting the exception handling to a lower level might not necessarily make sense. For example, I don't know if every instance of `os.listdir()` should be guarded by a `except OSError`.\n\nThat being said, if you have a very concrete proposal on how to structure the exception handling, I'm listening.",
    "created_at": "2016-10-12T09:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297506",
    "user": "jdemeyer"
}
```

Replying to [comment:21 embray]:
> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

I looked into this a bit more and I honestly think that the current places where I added `OSError` are optimal. Putting the exception handling to a lower level might not necessarily make sense. For example, I don't know if every instance of `os.listdir()` should be guarded by a `except OSError`.

That being said, if you have a very concrete proposal on how to structure the exception handling, I'm listening.



---

archive/issue_comments_297507.json:
```json
{
    "body": "Okay--you've spent more time playing with it than I have so I trust your judgment on that.  It's still a terrible patch but that's not your fault--again it just goes back to pip not being designed for this in the first place.",
    "created_at": "2016-10-12T09:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297507",
    "user": "embray"
}
```

Okay--you've spent more time playing with it than I have so I trust your judgment on that.  It's still a terrible patch but that's not your fault--again it just goes back to pip not being designed for this in the first place.



---

archive/issue_comments_297508.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-12T09:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297508",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_297509.json:
```json
{
    "body": "Replying to [comment:32 embray]:\n> After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.\n\nSee my last commit. I have not fully tested this yet.",
    "created_at": "2016-10-12T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297509",
    "user": "jdemeyer"
}
```

Replying to [comment:32 embray]:
> After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.

See my last commit. I have not fully tested this yet.



---

archive/issue_comments_297510.json:
```json
{
    "body": "Looking at some `strace` outputs, `pkg_resources` is totally crazy.\n\nWhen doing `import pkg_resources`, it attempts to open the file `/usr/local/src/sage-git/local/lib/python2.7/site-packages/zope.py` 81 times (failing 81 times).\n\nSimilarly, it tries to open `/usr/local/src/sage-git/local/lib/python2.7/site-packages/mpl_toolkits.py` 45 times (failing 45 times).\n\nI guess this is related to the fact that these define special `.pth` files:\n\n```\n$ ls -l local/lib/python2.7/site-packages/*.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 314 Oct 12 12:23 local/lib/python2.7/site-packages/configparser-3.5.0-py2.7-nspkg.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 256 Sep 23 14:41 local/lib/python2.7/site-packages/easy-install.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 323 Oct 12 12:20 local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-nspkg.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 299 Oct 12 12:16 local/lib/python2.7/site-packages/zope.interface-4.2.0-py2.7-nspkg.pth\n```\n",
    "created_at": "2016-10-12T11:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297510",
    "user": "jdemeyer"
}
```

Looking at some `strace` outputs, `pkg_resources` is totally crazy.

When doing `import pkg_resources`, it attempts to open the file `/usr/local/src/sage-git/local/lib/python2.7/site-packages/zope.py` 81 times (failing 81 times).

Similarly, it tries to open `/usr/local/src/sage-git/local/lib/python2.7/site-packages/mpl_toolkits.py` 45 times (failing 45 times).

I guess this is related to the fact that these define special `.pth` files:

```
$ ls -l local/lib/python2.7/site-packages/*.pth
-rw-r--r-- 1 jdemeyer jdemeyer 314 Oct 12 12:23 local/lib/python2.7/site-packages/configparser-3.5.0-py2.7-nspkg.pth
-rw-r--r-- 1 jdemeyer jdemeyer 256 Sep 23 14:41 local/lib/python2.7/site-packages/easy-install.pth
-rw-r--r-- 1 jdemeyer jdemeyer 323 Oct 12 12:20 local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-nspkg.pth
-rw-r--r-- 1 jdemeyer jdemeyer 299 Oct 12 12:16 local/lib/python2.7/site-packages/zope.interface-4.2.0-py2.7-nspkg.pth
```




---

archive/issue_comments_297511.json:
```json
{
    "body": "So `pkg_resources` actually *imports* `mpl_toolkit` and `zope` (and those are the only 2 packages that it imports from `site-packages` apart from `pkg_resources` itself). That's bad since it is yet another race condition.\n\nI'm starting to believe you that we should go for the lock.",
    "created_at": "2016-10-12T11:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297511",
    "user": "jdemeyer"
}
```

So `pkg_resources` actually *imports* `mpl_toolkit` and `zope` (and those are the only 2 packages that it imports from `site-packages` apart from `pkg_resources` itself). That's bad since it is yet another race condition.

I'm starting to believe you that we should go for the lock.



---

archive/issue_comments_297512.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-12T11:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297512",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_297513.json:
```json
{
    "body": "OK, I give up.\n\nThis is a much bigger can of worms than I originally anticipated.\n\nI'll look into the lock.",
    "created_at": "2016-10-12T12:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297513",
    "user": "jdemeyer"
}
```

OK, I give up.

This is a much bigger can of worms than I originally anticipated.

I'll look into the lock.



---

archive/issue_comments_297514.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-12T13:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297514",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_297515.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-10-12T13:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297515",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_297516.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-12T22:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297516",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_297517.json:
```json
{
    "body": "Three things:\n\n1) If we want to implement the locking mechanism in Python (makes sense to me) might as\nwell reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.  This would further the (ideal, to me) goal of having fewer shell scripts, and would be less confusing.\n\n2) As implemented this is not at all portable, and of course portable file-locking is hard to get right.  I propose that we vendor the [fasteners](https://pypi.python.org/pypi/fasteners) module which already provides a more portable and well-tested file lock.\n\n3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.\n\nSince I have experience with the fasteners module I can take that over if you want.",
    "created_at": "2016-10-13T09:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297517",
    "user": "embray"
}
```

Three things:

1) If we want to implement the locking mechanism in Python (makes sense to me) might as
well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.  This would further the (ideal, to me) goal of having fewer shell scripts, and would be less confusing.

2) As implemented this is not at all portable, and of course portable file-locking is hard to get right.  I propose that we vendor the [fasteners](https://pypi.python.org/pypi/fasteners) module which already provides a more portable and well-tested file lock.

3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

Since I have experience with the fasteners module I can take that over if you want.



---

archive/issue_comments_297518.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-13T09:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297518",
    "user": "embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_297519.json:
```json
{
    "body": "Sounds good to me but would be nice to do on another ticket so that we can release 7.4",
    "created_at": "2016-10-13T09:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297519",
    "user": "vbraun"
}
```

Sounds good to me but would be nice to do on another ticket so that we can release 7.4



---

archive/issue_comments_297520.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-13T09:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297520",
    "user": "vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_297521.json:
```json
{
    "body": "Is there some rush?  I can work on this now.  And I imagine you're going to do another RC right?",
    "created_at": "2016-10-13T09:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297521",
    "user": "embray"
}
```

Is there some rush?  I can work on this now.  And I imagine you're going to do another RC right?



---

archive/issue_comments_297522.json:
```json
{
    "body": "Replying to [comment:46 embray]:\n> 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.\n\nThat's exactly what I did.",
    "created_at": "2016-10-13T12:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297522",
    "user": "jdemeyer"
}
```

Replying to [comment:46 embray]:
> 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

That's exactly what I did.



---

archive/issue_comments_297523.json:
```json
{
    "body": "Replying to [comment:49 jdemeyer]:\n> Replying to [comment:46 embray]:\n> > 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.\n> \n> That's exactly what I did.\n\nYeah, I see that now.  I think what I meant is if using `fasteners` there isn't one built in so you have to hand-roll it with two locks, but that's simple enough.",
    "created_at": "2016-10-13T12:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297523",
    "user": "embray"
}
```

Replying to [comment:49 jdemeyer]:
> Replying to [comment:46 embray]:
> > 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.
> 
> That's exactly what I did.

Yeah, I see that now.  I think what I meant is if using `fasteners` there isn't one built in so you have to hand-roll it with two locks, but that's simple enough.



---

archive/issue_comments_297524.json:
```json
{
    "body": "Replying to [comment:46 embray]:\n> Three things:\n> \n> 1) If we want to implement the locking mechanism in Python (makes sense to me) might as\n> well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.\n\n1. I don't see the problem with having an additional script. Even if you would implement `sage-pip-install` in Python, I would be in favour of having two scripts because you may want to run `pip` without `sage-pip-install`.\n\n2. Perhaps we might be able to push the locking of pip upstream, but that's not going to happen for `sage-pip-install`.\n\n3. Didn't you mention that you wanted to get rid of `sage-pip-install` anyway in the future?\n\n> This would further the (ideal, to me) goal of having fewer shell scripts\n\nI don't think that having few scripts should be a goal by itself.",
    "created_at": "2016-10-13T12:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297524",
    "user": "jdemeyer"
}
```

Replying to [comment:46 embray]:
> Three things:
> 
> 1) If we want to implement the locking mechanism in Python (makes sense to me) might as
> well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.

1. I don't see the problem with having an additional script. Even if you would implement `sage-pip-install` in Python, I would be in favour of having two scripts because you may want to run `pip` without `sage-pip-install`.

2. Perhaps we might be able to push the locking of pip upstream, but that's not going to happen for `sage-pip-install`.

3. Didn't you mention that you wanted to get rid of `sage-pip-install` anyway in the future?

> This would further the (ideal, to me) goal of having fewer shell scripts

I don't think that having few scripts should be a goal by itself.



---

archive/issue_comments_297525.json:
```json
{
    "body": "Replying to [comment:46 embray]:\n> 2) As implemented this is not at all portable\n\nWell, it is portable to most UNIX-like operating systems. I don't think that there is a system on which Sage runs which does not have `flock(2)`. We use it for our patch to setuptools and nobody ever complained about that.\n\nThat being said, I am not *against* using fasteners, but I agree with Volker that it's something which can be done in the future.",
    "created_at": "2016-10-13T12:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297525",
    "user": "jdemeyer"
}
```

Replying to [comment:46 embray]:
> 2) As implemented this is not at all portable

Well, it is portable to most UNIX-like operating systems. I don't think that there is a system on which Sage runs which does not have `flock(2)`. We use it for our patch to setuptools and nobody ever complained about that.

That being said, I am not *against* using fasteners, but I agree with Volker that it's something which can be done in the future.



---

archive/issue_comments_297526.json:
```json
{
    "body": "Since this has come up before with setuptools, what if instead of making this lock script pip-specific we just make it general?  After all, there's virtually nothing in it specific to pip.",
    "created_at": "2016-10-13T14:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297526",
    "user": "embray"
}
```

Since this has come up before with setuptools, what if instead of making this lock script pip-specific we just make it general?  After all, there's virtually nothing in it specific to pip.



---

archive/issue_comments_297527.json:
```json
{
    "body": "Replying to [comment:53 embray]:\n> After all, there's virtually nothing in it specific to pip.\n\nWell, there are still various mentions of `pip` in that file (including the lock filename). And what will you do with the call\n\n```\nload_entry_point('pip', 'console_scripts', 'pip')()\n```\n",
    "created_at": "2016-10-13T14:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297527",
    "user": "jdemeyer"
}
```

Replying to [comment:53 embray]:
> After all, there's virtually nothing in it specific to pip.

Well, there are still various mentions of `pip` in that file (including the lock filename). And what will you do with the call

```
load_entry_point('pip', 'console_scripts', 'pip')()
```




---

archive/issue_comments_297528.json:
```json
{
    "body": "Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.",
    "created_at": "2016-10-14T07:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297528",
    "user": "embray"
}
```

Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.



---

archive/issue_comments_297529.json:
```json
{
    "body": "Replying to [comment:55 embray]:\n> Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.\n\nOf course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.",
    "created_at": "2016-10-14T08:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297529",
    "user": "jdemeyer"
}
```

Replying to [comment:55 embray]:
> Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.

Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.



---

archive/issue_comments_297530.json:
```json
{
    "body": "Another relevant question: is this locking something that would have a chance to get accepted upstream (of course, not with this implementation and we would need to support Windows too)?\n\nSince the race conditions seem to be mostly in `pkg_resources` (part of `setuptools`), I guess that would be the most natural place to implement the locking.",
    "created_at": "2016-10-14T08:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297530",
    "user": "jdemeyer"
}
```

Another relevant question: is this locking something that would have a chance to get accepted upstream (of course, not with this implementation and we would need to support Windows too)?

Since the race conditions seem to be mostly in `pkg_resources` (part of `setuptools`), I guess that would be the most natural place to implement the locking.



---

archive/issue_comments_297531.json:
```json
{
    "body": "I don't know. I leave it your hands.",
    "created_at": "2016-10-14T09:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297531",
    "user": "embray"
}
```

I don't know. I leave it your hands.



---

archive/issue_comments_297532.json:
```json
{
    "body": "Replying to [comment:56 jdemeyer]:\n> Replying to [comment:55 embray]:\n> > Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.\n> \n> Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.\n\nI'm barely talking about anything more than making the first argument the script (where the \"SHARED\" thing really ought to be a simple flag like `-s`) the string that you hard-code as \"pip\".",
    "created_at": "2016-10-14T09:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297532",
    "user": "embray"
}
```

Replying to [comment:56 jdemeyer]:
> Replying to [comment:55 embray]:
> > Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.
> 
> Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.

I'm barely talking about anything more than making the first argument the script (where the "SHARED" thing really ought to be a simple flag like `-s`) the string that you hard-code as "pip".



---

archive/issue_comments_297533.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-15T10:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297533",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_297534.json:
```json
{
    "body": "It seems like this issue puts using `pip` to install packages at odds with building in parallel. So should we not use `pip` so much, or do we not care about the speed of building that much? (I'm not complaining about the fix here at all, but I'm wondering about its consequences.)",
    "created_at": "2016-10-18T19:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297534",
    "user": "jhpalmieri"
}
```

It seems like this issue puts using `pip` to install packages at odds with building in parallel. So should we not use `pip` so much, or do we not care about the speed of building that much? (I'm not complaining about the fix here at all, but I'm wondering about its consequences.)



---

archive/issue_comments_297535.json:
```json
{
    "body": "Replying to [comment:61 jhpalmieri]:\n> or do we not care about the speed of building that much?\n\nI do care but this problem really needed fixing. I honestly tried hard to fix it by different means (look at the comments on this ticket) but I did not manage. But yes, it is certainly a regression.",
    "created_at": "2016-10-18T20:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297535",
    "user": "jdemeyer"
}
```

Replying to [comment:61 jhpalmieri]:
> or do we not care about the speed of building that much?

I do care but this problem really needed fixing. I honestly tried hard to fix it by different means (look at the comments on this ticket) but I did not manage. But yes, it is certainly a regression.



---

archive/issue_comments_297536.json:
```json
{
    "body": "So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)",
    "created_at": "2016-10-18T21:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297536",
    "user": "jhpalmieri"
}
```

So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)



---

archive/issue_comments_297537.json:
```json
{
    "body": "Replying to [comment:63 jhpalmieri]:\n> So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)\n\nI would rather focus on fixing the problem at the level of `pip`. I still think that option 1. of [comment:28] should be possible to implement.",
    "created_at": "2016-10-19T06:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21435",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21435#issuecomment-297537",
    "user": "jdemeyer"
}
```

Replying to [comment:63 jhpalmieri]:
> So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)

I would rather focus on fixing the problem at the level of `pip`. I still think that option 1. of [comment:28] should be possible to implement.
