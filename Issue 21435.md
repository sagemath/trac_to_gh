# Issue 21435: Race condition in pkg_resources

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-10-09 18:21:02

CC:  embray

Just like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.

Example:

```
[backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4
[pytz-2016.4.p0] Traceback (most recent call last):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/bin/pip", line 9, in <module>
[pytz-2016.4.p0]     load_entry_point('pip==8.1.2', 'console_scripts', 'pip')()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 542, in load_entry_point
[pytz-2016.4.p0]     return get_distribution(dist).load_entry_point(group, name)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2569, in load_entry_point
[pytz-2016.4.p0]     return ep.load()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2229, in load
[pytz-2016.4.p0]     return self.resolve()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2235, in resolve
[pytz-2016.4.p0]     module = __import__(self.module_name, fromlist=['__name__'], level=0)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/__init__.py", line 14, in <module>
[pytz-2016.4.p0]     from pip.utils import get_installed_distributions, get_prog
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/utils/__init__.py", line 27, in <module>
[pytz-2016.4.p0]     from pip._vendor import pkg_resources
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2927, in <module>
[pytz-2016.4.p0]     `@`_call_aside
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2913, in _call_aside
[pytz-2016.4.p0]     f(*args, **kwargs)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2940, in _initialize_master_working_set
[pytz-2016.4.p0]     working_set = WorkingSet._build_master()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 626, in _build_master
[pytz-2016.4.p0]     ws = cls()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 619, in __init__
[pytz-2016.4.p0]     self.add_entry(entry)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 675, in add_entry
[pytz-2016.4.p0]     for dist in find_distributions(entry, True):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1942, in find_eggs_in_zip
[pytz-2016.4.p0]     if metadata.has_metadata('PKG-INFO'):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1463, in has_metadata
[pytz-2016.4.p0]     return self.egg_info and self._has(self._fn(self.egg_info, name))
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1824, in _has
[pytz-2016.4.p0]     return zip_path in self.zipinfo or zip_path in self._index()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1704, in zipinfo
[pytz-2016.4.p0]     return self._zip_manifests.load(self.loader.archive)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1644, in load
[pytz-2016.4.p0]     mtime = os.stat(path).st_mtime
[pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'
```

Possibly, this race condition only happens while _uninstalling_ a package.


---

Comment by tscrim created at 2016-10-09 18:58:48

I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to _build_ a bunch of pip packages (e.g. alabaster). Although I did a `make distclean` and the Sage build went without problems, so it might not be related.


---

Comment by jdemeyer created at 2016-10-10 06:01:53

Replying to [comment:1 tscrim]:
> I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to _build_ a bunch of pip packages (e.g. alabaster).

The building of Python packages now involves uninstalling the packages first. See #21441.

> Although I did a `make distclean` and the Sage build went without problems, so it might not be related.

Or it further proves my hypothesis that the problems happen only while _uninstalling_ a package. If you do `make distclean` first, there is nothing to uninstall.


---

Comment by embray created at 2016-10-10 14:51:03

I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.  It was never really designed to be run in parallel like this.  Previously this was achieved in a patch sage has for setuptools (which impacted locking around easy_install).  With easy_install the situation was much more severe, and could cause broken installation.  I don't think pip has many problems surrounding installation, but I can see how it could break like this during uninstallation.

Jeroen is right that this specific issue was egg-related.  I don't know if there are other similar issues that could occur though even without eggs.


---

Comment by jdemeyer created at 2016-10-10 14:59:15

Replying to [comment:4 embray]:
> I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.

Or a

```
try:
    ...
except OSError:
    pass
```

in the right place. But then you have to understand the code better.


---

Comment by embray created at 2016-10-10 15:29:11

I specifically meant without patching anything (i.e. something at the level of `sage-pip-install`).  Though a patch that can submitted upstream would be good too.


---

Comment by strogdon created at 2016-10-10 23:37:46

Good, I'm glad this was caught. On an incremental build from 7.4.beta6 to 7.4.rc0 I guess I had to type `make` close to 10 times before Sage and the docs were built. I assumed perhaps a `slow` download connection interfered with parallel building. But this seems much more reasonable.
----
New commits:


---

Comment by git created at 2016-10-11 07:43:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-10-11 07:46:41

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-11 07:46:41

This patch seems to fix the issues within Sage. Erik, what do you think?


---

Comment by jdemeyer created at 2016-10-11 08:11:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-10-11 08:25:22

Any idea how to interpret this traceback?

```
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2913, in _call_aside
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2940, in _initialize_master_working_set
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 626, in _build_master
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 619, in __init__
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 675, in add_entry
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1942, in find_eggs_in_zip
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1463, in has_metadata
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1824, in _has
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1704, in zipinfo
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1644, in load
[python_openid-2.2.5.p0] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/pathlib2-2.1.0-py2.7.egg'
```


Why does it refer to files in `build/bdist.linux-x86_64/egg/pkg_resources`? Where is that place?


---

Comment by git created at 2016-10-11 08:25:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-10-11 08:29:08

Answering my own question:

```
>>> import pkg_resources
>>> pkg_resources.__file__
'/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools-24.0.2-py2.7.egg/pkg_resources/__init__.pyc'
```


So `setuptools` also has a copy of `pkg_resources` (inside an egg, so `find` doesn't find it and tracebacks are hard to interpret)


---

Comment by git created at 2016-10-11 08:36:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-10-11 09:12:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-10-11 11:55:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-11 11:55:39

OK, I needed a few iterations to get this right. But now it seems to work.

The way I tested this:

1. Build `sage-7.4.beta2` (the last version before #20218).

2. Build `sage-7.4.beta6` (the last version before #21441).

3. Build this branch with lots of processes.


---

Comment by jdemeyer created at 2016-10-11 12:23:31

I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.

`pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.


---

Comment by jdemeyer created at 2016-10-11 12:36:05

Regarding the last comment, this kind of code is problematic (example taken from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`):

```python
try:
    from certifi import where
except ImportError:
    def where():
        """Return the preferred certificate bundle."""
        # vendored bundle inside Requests
        return os.path.join(os.path.dirname(__file__), 'cacert.pem')
```


It is possible that one `pip` instance runs `from certifi import where` while another `pip` instance uninstalls `certifi` at the same time.


---

Comment by embray created at 2016-10-11 12:38:25

Right--my problem with this approach to fixing it is that I don't think pip was meant to run in parallel at all--much less when it's also uninstalling things.

Sprinkling the code with ignored `OSError`s in various places is probably not a solution that will be accepted upstream, where one would instead want more careful design to allow parallel execution in a consistent manner.

That said, if this works around the issue for our purposes for now I'm fine with it.  The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.


---

Comment by embray created at 2016-10-11 12:38:25

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-10-11 12:41:44

Replying to [comment:19 jdemeyer]:
> I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.
> 
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

Right.  This is why I was suggesting a lock around pip itself.  Especially an "uninstall" lock--don't let any other pip run if one pip is uninstalling.


---

Comment by jdemeyer created at 2016-10-11 12:59:37

Replying to [comment:21 embray]:
> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.


---

Comment by jdemeyer created at 2016-10-11 13:01:03

Replying to [comment:19 jdemeyer]:
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

I am currently trying to determine how serious this is. If it's just a few places (which is what I would guess), then we can patch those to always use the vendored package.


---

Comment by jdemeyer created at 2016-10-11 13:05:25

Replying to [comment:22 embray]:
> Right.  This is why I was suggesting a lock around pip itself.  Especially an "uninstall" lock--don't let any other pip run if one pip is uninstalling.

I don't like that since it would slow down parallel builds.

Of course, if it's the only feasible solution, we should go for that.


---

Comment by embray created at 2016-10-11 13:31:24

I mean, of course the ideal solution would be if pip could run sensibly in parallel, but that might be intractable for some of the reasons you've raised.  It might not have much impact--uninstalling, after all, is little more than removing some directories--probably most of the overhead is just in process startup/shutdown.


---

Comment by embray created at 2016-10-11 13:33:03

Replying to [comment:23 jdemeyer]:
> Replying to [comment:21 embray]:
> > The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.
> 
> That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.

Right, so you would have to handle OSError in there too in some sensible way.


---

Comment by jdemeyer created at 2016-10-11 15:23:02

Replying to [comment:19 jdemeyer]:
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

To solve this issue, I see 3 posssible solutions:

1. Ensure that `sys.path` only contains the Python standard library directories (in particular, not `site-packages`) while running `pip`.

2. Change the vendored code inside `pip` to not import any non-vendored libraries. For example, the code from [comment:20] could be changed to just define `def where()` unconditionally.

3. Implement a locking mechanism while running `pip` (which would immediately solve all race conditions with `pip` but would slow down a parallel build).

Erik, what is your opinion?


---

Comment by embray created at 2016-10-11 15:45:27

!#3 is my favorite as I've probably already expressed.  But it's also harder/more work, but do-able.  So for now I like a combination of !#1 and !#2.  For !#2 I wonder if it wouldn't be worth adding a global flag somewhere to pip that explicitly prevents it from using any non-vendored libs, as that would be a solution that might be worth offering upstream.


---

Comment by jdemeyer created at 2016-10-11 18:20:52

Replying to [comment:29 embray]:
> So for now I like a combination of !#1 and !#2.

I don't quite understand what you mean with "combination". Either solution individually fixes the problem.


---

Comment by jdemeyer created at 2016-10-12 08:13:03

I have an idea to implement !#1. I'll see if I can make it work.


---

Comment by embray created at 2016-10-12 08:48:40

After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.


---

Comment by jdemeyer created at 2016-10-12 09:15:46

Replying to [comment:21 embray]:
> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

I looked into this a bit more and I honestly think that the current places where I added `OSError` are optimal. Putting the exception handling to a lower level might not necessarily make sense. For example, I don't know if every instance of `os.listdir()` should be guarded by a `except OSError`.

That being said, if you have a very concrete proposal on how to structure the exception handling, I'm listening.


---

Comment by embray created at 2016-10-12 09:35:30

Okay--you've spent more time playing with it than I have so I trust your judgment on that.  It's still a terrible patch but that's not your fault--again it just goes back to pip not being designed for this in the first place.


---

Comment by git created at 2016-10-12 09:52:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-10-12 09:57:03

Replying to [comment:32 embray]:
> After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.

See my last commit. I have not fully tested this yet.


---

Comment by jdemeyer created at 2016-10-12 11:31:27

Looking at some `strace` outputs, `pkg_resources` is totally crazy.

When doing `import pkg_resources`, it attempts to open the file `/usr/local/src/sage-git/local/lib/python2.7/site-packages/zope.py` 81 times (failing 81 times).

Similarly, it tries to open `/usr/local/src/sage-git/local/lib/python2.7/site-packages/mpl_toolkits.py` 45 times (failing 45 times).

I guess this is related to the fact that these define special `.pth` files:

```
$ ls -l local/lib/python2.7/site-packages/*.pth
-rw-r--r-- 1 jdemeyer jdemeyer 314 Oct 12 12:23 local/lib/python2.7/site-packages/configparser-3.5.0-py2.7-nspkg.pth
-rw-r--r-- 1 jdemeyer jdemeyer 256 Sep 23 14:41 local/lib/python2.7/site-packages/easy-install.pth
-rw-r--r-- 1 jdemeyer jdemeyer 323 Oct 12 12:20 local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-nspkg.pth
-rw-r--r-- 1 jdemeyer jdemeyer 299 Oct 12 12:16 local/lib/python2.7/site-packages/zope.interface-4.2.0-py2.7-nspkg.pth
```



---

Comment by jdemeyer created at 2016-10-12 11:48:08

So `pkg_resources` actually _imports_ `mpl_toolkit` and `zope` (and those are the only 2 packages that it imports from `site-packages` apart from `pkg_resources` itself). That's bad since it is yet another race condition.

I'm starting to believe you that we should go for the lock.


---

Comment by git created at 2016-10-12 11:49:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-10-12 12:11:44

OK, I give up.

This is a much bigger can of worms than I originally anticipated.

I'll look into the lock.


---

Comment by git created at 2016-10-12 13:49:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-10-12 13:50:15

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-10-12 22:13:43

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-10-13 09:03:31

Three things:

1) If we want to implement the locking mechanism in Python (makes sense to me) might as
well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.  This would further the (ideal, to me) goal of having fewer shell scripts, and would be less confusing.

2) As implemented this is not at all portable, and of course portable file-locking is hard to get right.  I propose that we vendor the [fasteners](https://pypi.python.org/pypi/fasteners) module which already provides a more portable and well-tested file lock.

3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

Since I have experience with the fasteners module I can take that over if you want.


---

Comment by embray created at 2016-10-13 09:03:31

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-10-13 09:36:01

Sounds good to me but would be nice to do on another ticket so that we can release 7.4


---

Comment by vbraun created at 2016-10-13 09:36:01

Changing status from needs_work to positive_review.


---

Comment by embray created at 2016-10-13 09:42:43

Is there some rush?  I can work on this now.  And I imagine you're going to do another RC right?


---

Comment by jdemeyer created at 2016-10-13 12:25:10

Replying to [comment:46 embray]:
> 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

That's exactly what I did.


---

Comment by embray created at 2016-10-13 12:29:41

Replying to [comment:49 jdemeyer]:
> Replying to [comment:46 embray]:
> > 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.
> 
> That's exactly what I did.

Yeah, I see that now.  I think what I meant is if using `fasteners` there isn't one built in so you have to hand-roll it with two locks, but that's simple enough.


---

Comment by jdemeyer created at 2016-10-13 12:34:30

Replying to [comment:46 embray]:
> Three things:
> 
> 1) If we want to implement the locking mechanism in Python (makes sense to me) might as
> well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.

1. I don't see the problem with having an additional script. Even if you would implement `sage-pip-install` in Python, I would be in favour of having two scripts because you may want to run `pip` without `sage-pip-install`.

2. Perhaps we might be able to push the locking of pip upstream, but that's not going to happen for `sage-pip-install`.

3. Didn't you mention that you wanted to get rid of `sage-pip-install` anyway in the future?

> This would further the (ideal, to me) goal of having fewer shell scripts

I don't think that having few scripts should be a goal by itself.


---

Comment by jdemeyer created at 2016-10-13 12:41:14

Replying to [comment:46 embray]:
> 2) As implemented this is not at all portable

Well, it is portable to most UNIX-like operating systems. I don't think that there is a system on which Sage runs which does not have `flock(2)`. We use it for our patch to setuptools and nobody ever complained about that.

That being said, I am not _against_ using fasteners, but I agree with Volker that it's something which can be done in the future.


---

Comment by embray created at 2016-10-13 14:32:50

Since this has come up before with setuptools, what if instead of making this lock script pip-specific we just make it general?  After all, there's virtually nothing in it specific to pip.


---

Comment by jdemeyer created at 2016-10-13 14:44:05

Replying to [comment:53 embray]:
> After all, there's virtually nothing in it specific to pip.

Well, there are still various mentions of `pip` in that file (including the lock filename). And what will you do with the call

```
load_entry_point('pip', 'console_scripts', 'pip')()
```



---

Comment by embray created at 2016-10-14 07:38:43

Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.


---

Comment by jdemeyer created at 2016-10-14 08:45:17

Replying to [comment:55 embray]:
> Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.

Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.


---

Comment by jdemeyer created at 2016-10-14 08:50:19

Another relevant question: is this locking something that would have a chance to get accepted upstream (of course, not with this implementation and we would need to support Windows too)?

Since the race conditions seem to be mostly in `pkg_resources` (part of `setuptools`), I guess that would be the most natural place to implement the locking.


---

Comment by embray created at 2016-10-14 09:20:47

I don't know. I leave it your hands.


---

Comment by embray created at 2016-10-14 09:24:22

Replying to [comment:56 jdemeyer]:
> Replying to [comment:55 embray]:
> > Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.
> 
> Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.

I'm barely talking about anything more than making the first argument the script (where the "SHARED" thing really ought to be a simple flag like `-s`) the string that you hard-code as "pip".


---

Comment by vbraun created at 2016-10-15 10:25:17

Resolution: fixed


---

Comment by jhpalmieri created at 2016-10-18 19:01:54

It seems like this issue puts using `pip` to install packages at odds with building in parallel. So should we not use `pip` so much, or do we not care about the speed of building that much? (I'm not complaining about the fix here at all, but I'm wondering about its consequences.)


---

Comment by jdemeyer created at 2016-10-18 20:11:34

Replying to [comment:61 jhpalmieri]:
> or do we not care about the speed of building that much?

I do care but this problem really needed fixing. I honestly tried hard to fix it by different means (look at the comments on this ticket) but I did not manage. But yes, it is certainly a regression.


---

Comment by jhpalmieri created at 2016-10-18 21:16:44

So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)


---

Comment by jdemeyer created at 2016-10-19 06:47:45

Replying to [comment:63 jhpalmieri]:
> So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)

I would rather focus on fixing the problem at the level of `pip`. I still think that option 1. of [comment:28] should be possible to implement.
