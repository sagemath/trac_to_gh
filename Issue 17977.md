# Issue 17977: Bug in volume computation of polyhedron

Issue created by migration from https://trac.sagemath.org/ticket/18214

Original creator: vdelecroix

Original creation time: 2015-04-15 22:58:27

CC:  jipilab moritz @tom111


```
sage: polytopes.dodecahedron(base_ring=RDF).volume()
Traceback (most recent call last):
...
ZeroDivisionError: input matrix must be nonsingular
```



---

Comment by vdelecroix created at 2015-04-16 14:44:59

Changing keywords from "" to "bug".


---

Comment by chapoton created at 2016-08-17 19:29:48

Here is a proposal for a solution. In case of inexact base ring, I introduce a non-zero epsilon constant, to take care of approximate equality of points. Maybe this could become a parameter.
----
New commits:


---

Comment by chapoton created at 2016-08-17 19:29:48

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-08-17 19:37:34

I think you also need to change method `PointConfiguration.contained_simplex`.

And that epsilon should indeed be customizable. And when `PointConfiguration` is called from `Polyhedron_RDF`, it should use the epsilons from `Polyhedron_RDF._is_zero` etc.


---

Comment by mkoeppe created at 2016-08-17 19:39:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-11-22 10:34:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-28 19:17:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-28 19:17:16

New commits:


---

Comment by vbraun created at 2018-11-03 10:45:50

Is this still reproducable? I get

```
sage: polytopes.dodecahedron(base_ring=RDF).volume()
6.4520359589542045
```



---

Comment by vdelecroix created at 2018-11-03 13:51:25

Replying to [comment:13 vbraun]:
> Is this still reproducable? I get
> {{{
> sage: polytopes.dodecahedron(base_ring=RDF).volume()
> 6.4520359589542045
> }}}

On my computer it is.


---

Comment by chapoton created at 2018-11-03 20:45:14

patchbot petitbonum is seeing this as a random failure:

```
./sage -t --long --warn-long 54.5 src/sage/geometry/polyhedron/library.py
...
sage: ico.volume()
...
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/geometry/triangulation/point_configuration.py", line 1994, in facets_of_simplex
        normals = span.inverse().columns()
      File "sage/matrix/matrix2.pyx", line 8854, in sage.matrix.matrix2.Matrix.inverse (build/cythonized/sage/matrix/matrix2.c:71887)
        return ~self
      File "sage/matrix/matrix_double_dense.pyx", line 466, in sage.matrix.matrix_double_dense.Matrix_double_dense.__invert__ (build/cythonized/sage/matrix/matrix_double_dense.c:6026)
        raise ZeroDivisionError("input matrix must be nonsingular")
    ZeroDivisionError: input matrix must be nonsingular
```



---

Comment by dimpase created at 2019-01-14 17:43:38

Replying to [comment:14 vdelecroix]:
> Replying to [comment:13 vbraun]:
> > Is this still reproducable? I get
> > {{{
> > sage: polytopes.dodecahedron(base_ring=RDF).volume()
> > 6.4520359589542045
> > }}}
> 
> On my computer it is.

Also reproducible on my Google CE host, with 8 Xeon CPUs:
$ uname -a
Linux linux 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 GNU/Linux


---

Comment by dimpase created at 2019-01-14 17:53:43

with random test order I get more errors like this:

```
...
File "src/sage/geometry/polyhedron/library.py", line 1158, in sage.geometry.polyhedron.library.Polytopes.truncated_dodecahedron
Failed example:
    td = polytopes.truncated_dodecahedron(exact=False)
Expected:
    doctest:warning
    ...
    UserWarning: This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.
Got:
    <BLANKLINE>
...
2 items had failures:
   1 of   9 in sage.geometry.polyhedron.library.Polytopes.truncated_dodecahedron
   1 of   7 in sage.geometry.polyhedron.library.Polytopes.truncated_icosidodecahedron
    [196 tests, 2 failures, 9.83 s]
----------------------------------------------------------------------
sage -t src/sage/geometry/polyhedron/library.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 10.0 seconds
    cpu time: 7.9 seconds
    cumulative wall time: 9.8 seconds
dimpase@linux:~/sage$ ./sage -tp --randorder 127 src/sage/geometry/polyhedron/library.py
```



---

Comment by vbraun created at 2019-01-14 19:11:09

Degenerate polyhedra over floating-point numbers aren't really supported; Usually you are lucky and numerical errors triangulate your faces. But if you are unlucky then numerical fuzz leads to inconsistent incidence relations where a point is on both (or neither) side of a plane. Just adding fuzzy zero is afaik not enough.


---

Comment by dimpase created at 2019-01-14 21:39:44

This seems to be state of the art: https://dl.acm.org/citation.cfm?id=3194656

Surely, naive triangulation approach is doomed to fail...
Should we just mark the corresponding tests are "known bug" and move on?


---

Comment by dimpase created at 2019-01-14 21:47:53

And here is the code: https://github.com/GeomScale/volume_approximation (it's C++).


---

Comment by dimpase created at 2019-01-14 22:13:33

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-01-14 22:13:33

see #27056 for a follow-up
----
New commits:


---

Comment by chapoton created at 2019-01-15 16:11:57

ok


---

Comment by chapoton created at 2019-01-15 16:11:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-23 15:39:21

Resolution: fixed
