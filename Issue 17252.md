# Issue 17252: remove redundant factorial() from rings/arith.py

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2014-12-12 17:28:57

CC:  kcrisman nthiery

The `rings` version apparently gets overwritten on import. One should provide the much slower algorithms `gmp` and `pari` from that version.

It's a defect because the `reference/misc/sage/rings/arith.html` documentation makes users expect the `algorithm` keyword to work but

```
sage: y=factorial(10^6,algorithm='gmp')
---------------------------------------------------------------------------
...
TypeError: __call__() got an unexpected keyword argument 'algorithm'
```



---

Comment by rws created at 2014-12-13 09:09:04

Timing comparison:
 * (timeit) 10<sup>3</sup>!: sympy: 3.38 µs, ginac: 11.6 µs, gmp: 11.8 µs, pari: 22.4 µs
 * (time) 10<sup>6</sup>!: sympy: 10s, ginac: 200 ms, gmp: 190 ms, pari: 410 ms 
Here, sympy caches the result (or the computation), so subsequent calls with the same argument are fast. In contrast, the other programs always use 0.2-0.4 seconds per call to factorial(10<sup>6</sup>) so, by wrapping in a `@`cached function, they would be as fast as sympy in followup calls.

This clearly shows sympy is not up to it, EDIT: and this ticket will speed up many computations 2x.


---

Comment by rws created at 2014-12-13 17:16:49

Replying to [comment:2 rws]:
> Timing comparison
In fact, the `functions/other` version supposedly calling pynac/ginac actually indirectly calls the `rings/arith` version, i.e., gmp.

So, there will be no speed changes with this ticket.

This, however, means also that the problem with passing `algorithm` is due to `Function_factorial` being a `GinacFunction`. Of course, a `GinacFunction` would only use Ginac, so it figures.


---

Comment by rws created at 2014-12-13 17:26:58

It looks like #9240 abandoned GiNaC behaviour for `factorial`. Then why keep this as `GinacFunction` and go through calling `rings.arith.factorial` via `py_factorial_py`?


---

Comment by rws created at 2014-12-14 08:28:30

Found a way to use `algorithm` without abandoning the use of `GinacFunction`.
----
New commits:


---

Comment by rws created at 2014-12-14 08:28:30

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-12-14 09:07:19

If you no longer use the `py_factorial_py` function, it should be deprecated.


---

Comment by rws created at 2014-12-14 10:04:20

Replying to [comment:7 jdemeyer]:
> If you no longer use the `py_factorial_py` function, it should be deprecated.
Sure? It is used by the `py_factorial` doctest.


---

Comment by jdemeyer created at 2014-12-14 10:06:34

If it's only used by doctests, it's not used :-)


---

Comment by rws created at 2014-12-14 10:23:40

Replying to [comment:9 jdemeyer]:
> If it's only used by doctests, it's not used :-)
And remove the doctest?

In the same file there are more such wrappers: `doublefactorial`,`test_binomial`,`py_real_for_doctests` etc.


---

Comment by jdemeyer created at 2014-12-14 15:59:41

Replying to [comment:10 rws]:
> Replying to [comment:9 jdemeyer]:
> > If it's only used by doctests, it's not used :-)
> And remove the doctest?
No, add the deprecation message in the doctest.


---

Comment by jdemeyer created at 2014-12-14 16:53:08

Also, instead of _removing_ the factorial function from `rings/arith.py`, it should be deprecated (or perhaps a lazy import with deprecation).


---

Comment by jdemeyer created at 2014-12-14 16:53:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-12-19 14:34:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-12-19 14:38:08

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 rws]:
> > Replying to [comment:9 jdemeyer]:
> > And remove the doctest?
> No, add the deprecation message in the doctest.
Not possible because only the first message is printed. I removed the doctests.
> Also, instead of _removing_ the factorial function from `rings/arith.py`, it should be deprecated (or perhaps a lazy import with deprecation).
Any import of `factorial` is overwritten by `sage.functions.other.factorial`


---

Comment by rws created at 2014-12-19 14:38:08

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-19 20:44:56

This is overly complicated:

```
    try:
        x_in_ZZ = ZZ(x)
        coercion_success = True
    except TypeError:
        coercion_success = False

    if coercion_success and x_in_ZZ >= 0:
        return ZZ(x).factorial()
    else:
        return py_tgamma(x+1)
```


Why not

```
    try:
        x = ZZ(x)
    except TypeError:
        pass
    else:
        if x >= 0:
            return x.factorial()

    return py_tgamma(x+1)
```

Also: the `:trac:`9240`` syntax should be used in docstrings, not comments in code, so please revert that.


---

Comment by jdemeyer created at 2014-12-19 20:44:56

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-19 21:14:36

I'm not happy with the change of `_eval_` to `__call__`. You cannot expect every function which wants an `algorithm` argument to override `__call__`. Especially now that more and more non-trivial logic is going into the `__call__` method of `BuiltinFunction`.

It might make a lot more sense to move all this `algorithm` stuff to a custom `_evalf_` function, which _does_ support an `algorithm` argument.

In order words: I think the general question of how to handle `algorithm` arguments in symbolic calls should be answered first.


---

Comment by jdemeyer created at 2014-12-19 21:15:06

See also #12289 and #15200.


---

Comment by jdemeyer created at 2014-12-19 21:18:12

Another idea I had which should probably be done first is to make a new class `NumberTheoreticFunction` which would include the `factorial` and `binomial` function. That class could then be customized to use `_evalf_` when given integers as input.


---

Comment by rws created at 2014-12-20 07:28:21

Replying to [comment:19 jdemeyer]:
> Another idea I had which should probably be done first is to make a new class `NumberTheoreticFunction` which would include the `factorial` and `binomial` function. That class could then be customized to use `_evalf_` when given integers as input.
When adding the missing `rising/falling/sub/multi_factorial` there is already the case for a separate file containing functions mainly defined over the integers---or two, one for number theoretic, the other combinatorial entries. So maybe not `NumberTheoreticFunction` but `ZZDomainFunction` in the file `number_theoretic.py`?


---

Comment by jdemeyer created at 2014-12-20 09:06:59

I don't like `ZZDomainFunction` (why `Domain`?), what do you think of `IntegerFunction`? And the new file is certainly a very good idea.


---

Comment by rws created at 2014-12-20 09:42:30

Replying to [comment:21 jdemeyer]:
> I don't like `ZZDomainFunction` (why `Domain`?), what do you think of `IntegerFunction`? And the new file is certainly a very good idea.
"Given a function f:X→Y, the set X is the domain of f; the set Y is the codomain of f." But `IntegerFunction` seems fine too. I guess I will have to override `BuiltinFunction` methods somehow...


---

Comment by rws created at 2014-12-20 09:58:45

The `algorithm` keyword can be given 1. as `__call__` keyword, or 2. as `n()` keyword. Do I understand you correctly that you don't want to have scenario 1?

EDIT: cannot be, as that would mean `n()` is always needed to get numerics. So `__call__` just hands it to `_evalf_or_eval_()`


---

Comment by jdemeyer created at 2014-12-20 10:55:40

Replying to [comment:23 rws]:
> Do I understand you correctly that you don't want to have scenario 1?

I didn't say that. I just said that I don't want an `algorithm` keyword _only_ for `factorial()`. I don't want a "solution" which needs to treat `factorial()` in a special way.

If you agree with this, please open a new ticket for supporting a more general `algorithm` keyword.


---

Comment by rws created at 2014-12-20 14:32:31

Replying to [comment:24 jdemeyer]:
> If you agree with this, please open a new ticket for supporting a more general `algorithm` keyword.
See #17531.


---

Comment by rws created at 2014-12-20 17:20:42

> ...in the file `number_theoretic.py`?
Rather in `combinatorial.py`...


---

Comment by jdemeyer created at 2014-12-20 18:16:27

If we agree on the class `IntegerFunction`, then the file probably should be `integerfunction.py` also.


---

Comment by jdemeyer created at 2014-12-20 18:18:09

A different bug concerning `factorial`:

```
sage: parent(factorial(QQ(4)))
Integer Ring
```

I think this should respect the parent and return a element of `QQ`.


---

Comment by rws created at 2014-12-25 17:05:41


```
sage -t --long src/sage/combinat/partition.py  # 3 doctests failed
sage -t --long src/sage/combinat/skew_tableau.py  # 5 doctests failed
sage -t --long src/sage/combinat/permutation.py  # 2 doctests failed
sage -t --long src/sage/combinat/six_vertex_model.py  # 1 doctest failed
sage -t --long src/sage/combinat/sloane_functions.py  # 5 doctests failed
sage -t --long src/sage/combinat/alternating_sign_matrix.py  # 5 doctests failed
```

Still, some odd doctest errors but basically ready for review. EDIT: Also, some doctests missing in `integer_function.py`.
----
New commits:


---

Comment by rws created at 2014-12-25 17:05:41

Changing status from needs_work to needs_review.


---

Comment by rws created at 2014-12-25 17:05:41

Changing keywords from "" to "integer symbolic function".


---

Comment by rws created at 2014-12-28 10:39:15

> Still, some odd doctest errors...
They turned out to be more resilient than I thought. A plea for help: https://groups.google.com/forum/?hl=en#!topic/sage-devel/6wVipX3JPGU


---

Comment by git created at 2014-12-28 15:05:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-12-28 15:07:54

It seems that python ints returned by functions.factorial exposed several bugs in combinat.


---

Comment by git created at 2014-12-28 16:07:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-31 16:31:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-12-31 18:46:20

I'm not completely sure about changing the test in `finite_enumerated_sets` to also allow for `int`'s as the (untrained) user might unexpectedly do a division and get 0 but is expecting a fraction. I think the better solution is to actually change the output of the `cardinality` to be in `ZZ`, and I'll be happy to make this change. (In fact, I think a doctest in that file is going to fail because of this change.)


---

Comment by rws created at 2015-01-22 06:56:34

Replying to [comment:36 tscrim]:
> I'm not completely sure about changing the test in `finite_enumerated_sets` to also allow for `int`'s as the (untrained) user might unexpectedly do a division and get 0 but is expecting a fraction. I think the better solution is to actually change the output of the `cardinality` to be in `ZZ`, and I'll be happy to make this change. (In fact, I think a doctest in that file is going to fail because of this change.)

Sorry to have been unresponsive. Please go ahead with your plan. Can I consider my code part to be reviewed with this?


---

Comment by git created at 2015-02-02 17:04:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2015-02-03 03:46:58

> I didn't say that. I just said that I don't want an algorithm keyword only for factorial(). I don't want a "solution" which needs to treat factorial() in a special way.

Hmm.  After thinking about this, I would like to suggest that `factorial` is a pretty special example.  It's not a typical function of this type (even if we do make it like `gamma` in the end.  It certainly shouldn't be in `.n()` since we want integer output from the algorithms (right?).


---

Comment by rws created at 2015-03-05 10:28:01

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-03-18 06:51:02

Can this slowdown be explained?
> {{{
> sage: from sage.rings.arith import factorial as arith_factorial
> sage: %timeit arith_factorial(10)
> 1000000 loops, best of 3: 474 ns per loop
> sage: %timeit factorial(10)
> 1000000 loops, best of 3: 1.02 µs per loop
> }}}


---

Comment by rws created at 2016-07-19 08:21:49

To summarize:
 * the "arith" version moved to `src/sage/arith/misc.py`
 * the use of `py_factorial_py` cannot be deprecated so doctests using it must be deleted right away (adding the deprecation message in the doctest is not possible because only the first message is printed)
 * deprecating the "arith" version will not print a deprecation message for interactive users because (as the ticket states the arith version apparently gets overwritten on import). Maybe the deprecation shows if one imports directly from arith
 * do not use `__call__` to catch `algorithm`, use `_evalf_`
 * the general question of how to handle algorithm arguments in symbolic calls should be answered first, meaning no special solution just for factorial. Having an abstract `IntegerFunction` in `functions/integerfunction.py` is the idea. The ticket #17531 would deal with this, but has unexpected pitfalls.


---

Comment by rws created at 2016-09-22 07:37:57

In order to make some progress on the original issue I removed the demand to replace `arith/factorial` by `function/factorial`. This ticket is now entirely about `factorial(algorithm=)`. See #21560 for the negative integer argument issue.


---

Comment by rws created at 2016-12-29 08:09:49

Changing status from needs_work to needs_review.


---

Comment by rws created at 2016-12-29 08:09:49

Jeroen, are you still reviewer of this ticket?
----
New commits:


---

Comment by rws created at 2018-03-03 16:13:32

I think we are coming to the conclusion that functions with additional keywords (other than `hold`) need to be implemented as global interface function + symbolic specialization pair. This split has proven beneficial to #24554 as well. Whether the global interfaces all reside in `arith/` or in `function/` may have to be decided, or maybe not.


---

Comment by rws created at 2018-03-03 16:13:32

Changing status from needs_review to needs_work.


---

Comment by rws created at 2018-03-16 07:31:06

The issue was moot because the `algorithm` keyword is only supported in the `arith/` version of `factorial/` so just import it.


---

Comment by rws created at 2018-03-16 07:31:06

Changing status from needs_work to positive_review.


---

Comment by vdelecroix created at 2018-05-18 17:16:26

Resolution: wontfix


---

Comment by vdelecroix created at 2018-05-18 17:16:26

closing positively reviewed duplicates
