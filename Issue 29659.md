# Issue 29659: fix make download

Issue created by migration from https://trac.sagemath.org/ticket/29896

Original creator: dimpase

Original creation time: 2020-06-18 20:55:16

CC:  saliola mkoeppe mjo slelievre vbraun

This is broken, as reported on 
https://groups.google.com/d/msg/sage-devel/KA8tI5GsFX4/1KIV2iuIBwAJ




---

Comment by jhpalmieri created at 2020-06-19 23:52:51

One option:

```diff
diff --git a/Makefile b/Makefile
index 822d1d316f..74863704b1 100644
--- a/Makefile
+++ b/Makefile
@@ -61,9 +61,9 @@ buildbot-python3:
        $(MAKE)
 
 # Preemptively download all standard upstream source tarballs.
-download:
+download: build/make/Makefile
        export SAGE_ROOT=$$(pwd) && \
-       export PATH=$$SAGE_ROOT/src/bin:$$PATH && \
+       export PATH=$$SAGE_ROOT/build/bin:$$SAGE_ROOT/src/bin:$$PATH && \
        ./src/bin/sage-download-upstream
 
 dist: build/make/Makefile
```

Then (after #29316) users will be warned that they have to run `./configure` first. For me, if I've run `./configure`, this modified version of `make download` works.


---

Comment by jhpalmieri created at 2020-06-20 16:13:20

Although there is another issue: `make download` says that it downloads the standard upstream source tarballs, but it actually downloads tarballs for standard, optional, and experimental (after querying) packages. At least one of the experimental database packages is pretty big, so maybe we don't want to do this. With #20104, we could do this:

```diff
diff --git a/src/bin/sage-download-upstream b/src/bin/sage-download-upstream
index c5d9afe31e..226806ab7d 100755
--- a/src/bin/sage-download-upstream
+++ b/src/bin/sage-download-upstream
@@ -1,8 +1,8 @@
 #!/usr/bin/env bash
 
-for pkg in $SAGE_ROOT/build/pkgs/*
+for pkg in `sage --package list :standard:`
 do
-    if [ -d $pkg ]; then
+    if [ -d $SAGE_ROOT/build/pkgs/$pkg ]; then
         sage-spkg -d `basename $pkg`
     fi
 done
```



---

Comment by jhpalmieri created at 2020-06-20 16:18:43

I could also imagine trying to use the results from `./configure` to decide which packages to download, which to skip because they are already available from the system. But if someone wants to download once and then distribute to colleagues on a thumb drive, it's a good idea to have all of the standard packages.


---

Comment by jhpalmieri created at 2020-07-15 21:40:18

Should this be using the same logic as `make dist` to determine what to download?


---

Comment by mjo created at 2020-07-18 00:30:44

Replying to [comment:7 jhpalmieri]:
> Should this be using the same logic as `make dist` to determine what to download?

That's my instinct. We probably don't need both `make download-for-sdist` and `make download` in that case.


---

Comment by mkoeppe created at 2020-11-01 19:32:34

The branch "fixes" `make download` (and also cleans up `src/bin/` a bit more, on top of #30846 and similar earlier tickets).

I don't use this myself, so I don't know what is the best way to proceed regarding "standard" vs. "all" vs. "configured" packages. Perhaps they should be 3 different make targets.
----
New commits:


---

Comment by slelievre created at 2020-11-18 15:14:39

In case that is relevant to the present ticket: our release manager
says: "If there were a command-line switch to download all standard
+ optional + experimental packages then I could test that..." (i.e.
test they all download properly, to avoid missing upstream tarballs
on our download mirrors after package upgrade tickets get merged).


---

Comment by slelievre created at 2020-11-18 15:14:39

Changing keywords from "" to "download".


---

Comment by slelievre created at 2020-11-18 15:14:39

Changing priority from minor to major.


---

Comment by git created at 2020-11-18 22:31:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-11-18 22:31:24

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-11-18 22:48:39

No longer depends on #30846


---

Comment by git created at 2020-11-19 18:02:46

(pushed to wrong ticket)


---

Comment by git created at 2020-11-19 18:03:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-11-19 19:00:32

Actually best to go through #30865, `sage -package download :all:`


---

Comment by dimpase created at 2020-11-21 22:13:35

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-12-29 08:00:47

Resolution: duplicate
