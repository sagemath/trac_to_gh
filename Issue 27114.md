# Issue 27114: Refuse to configure building gfortran on Linux unless explicitly requested

archive/issues_027114.json:
```json
{
    "body": "CC:  @jdemeyer @dimpase @vbraun @jhpalmieri @orlitzky @kiwifb\n\nThere have been a spate of reports of issues like #26996 all stemming from people trying to build Sage on Linux systems that do not already have a supported Fortran compiler installed (but easily could).\n\nThe problem *only* occurs when trying to install the gfortran SPKG on Linux, and the fact that it's come up so frequently is alarming, as there should not be any good reason for people to be compiling gfortrans just for Sage.\n\nThere is discussion on #27054 about recommending it as a prerequisite.  I would go one step further and just fail--with a helpful error message-at `./configure` time, at least on platforms like Cygwin and most Linux distributions, to just install the system's fortran compiler, unless a flag is given to explicitly request it.  Because there's very rarely any good reason for someone to be wasting their time on that just to build Sage, and it seems many people have been doing so unwarily for a long time.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27351\n\n",
    "created_at": "2019-02-25T12:54:07Z",
    "labels": [
        "packages: optional",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Refuse to configure building gfortran on Linux unless explicitly requested",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27114",
    "user": "@embray"
}
```
CC:  @jdemeyer @dimpase @vbraun @jhpalmieri @orlitzky @kiwifb

There have been a spate of reports of issues like #26996 all stemming from people trying to build Sage on Linux systems that do not already have a supported Fortran compiler installed (but easily could).

The problem *only* occurs when trying to install the gfortran SPKG on Linux, and the fact that it's come up so frequently is alarming, as there should not be any good reason for people to be compiling gfortrans just for Sage.

There is discussion on #27054 about recommending it as a prerequisite.  I would go one step further and just fail--with a helpful error message-at `./configure` time, at least on platforms like Cygwin and most Linux distributions, to just install the system's fortran compiler, unless a flag is given to explicitly request it.  Because there's very rarely any good reason for someone to be wasting their time on that just to build Sage, and it seems many people have been doing so unwarily for a long time.

Issue created by migration from https://trac.sagemath.org/ticket/27351





---

archive/issue_comments_381851.json:
```json
{
    "body": "I don't think that #26996 should be used as a reason. That's a bug in the build system, that we could just fix independently.\n\nI'm not saying that this ticket by itself is a bad idea, just that #26996 is not a good reason for it.",
    "created_at": "2019-02-25T12:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381851",
    "user": "@jdemeyer"
}
```

I don't think that #26996 should be used as a reason. That's a bug in the build system, that we could just fix independently.

I'm not saying that this ticket by itself is a bad idea, just that #26996 is not a good reason for it.



---

archive/issue_comments_381852.json:
```json
{
    "body": "It's a good idea to make it fail on !Linux/Cygwin/Homebrew/FreeBSD.",
    "created_at": "2019-02-25T13:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381852",
    "user": "@dimpase"
}
```

It's a good idea to make it fail on !Linux/Cygwin/Homebrew/FreeBSD.



---

archive/issue_comments_381853.json:
```json
{
    "body": "Replying to [comment:1 jdemeyer]:\n> I don't think that #26996 should be used as a reason. That's a bug in the build system, that we could just fix independently.\n> \n> I'm not saying that this ticket by itself is a bad idea, just that #26996 is not a good reason for it.\n\nI agree, that's not the motivation at all.  My point was that it happened to expose the fact that a *lot* of people, more than I'd imagined was the case, were trying (and in the past, presumably, succeeding) to build gfortran when it wasn't really necessary for them to.",
    "created_at": "2019-02-25T13:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381853",
    "user": "@embray"
}
```

Replying to [comment:1 jdemeyer]:
> I don't think that #26996 should be used as a reason. That's a bug in the build system, that we could just fix independently.
> 
> I'm not saying that this ticket by itself is a bad idea, just that #26996 is not a good reason for it.

I agree, that's not the motivation at all.  My point was that it happened to expose the fact that a *lot* of people, more than I'd imagined was the case, were trying (and in the past, presumably, succeeding) to build gfortran when it wasn't really necessary for them to.



---

archive/issue_comments_381854.json:
```json
{
    "body": "Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.",
    "created_at": "2019-03-25T10:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381854",
    "user": "@embray"
}
```

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.



---

archive/issue_comments_381855.json:
```json
{
    "body": "Instead of refusing to build it, I think we should in general suggest a list of system packages to install, at the end of the `configure` run, similar to #26964.\n\nI have revised the ticket description accordingly.",
    "created_at": "2020-02-09T22:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381855",
    "user": "@mkoeppe"
}
```

Instead of refusing to build it, I think we should in general suggest a list of system packages to install, at the end of the `configure` run, similar to #26964.

I have revised the ticket description accordingly.



---

archive/issue_comments_381856.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-05T04:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381856",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_381857.json:
```json
{
    "body": "The code on this branch is roughly what I have in mind for this functionality. Doesn't quite work yet.",
    "created_at": "2020-03-05T04:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381857",
    "user": "@mkoeppe"
}
```

The code on this branch is roughly what I have in mind for this functionality. Doesn't quite work yet.



---

archive/issue_comments_381858.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-06T03:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381858",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381859.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-06T03:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381859",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_381860.json:
```json
{
    "body": "I'd be fine with completely reworking the package summary at the end of configure (the currently existing one that prints out every package name).\n\nI think this could be done much more clearly, ending with a list of suggested system packages to install as you describe.",
    "created_at": "2020-03-06T09:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381860",
    "user": "@embray"
}
```

I'd be fine with completely reworking the package summary at the end of configure (the currently existing one that prints out every package name).

I think this could be done much more clearly, ending with a list of suggested system packages to install as you describe.



---

archive/issue_comments_381861.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> I'd be fine with completely reworking the package summary at the end of configure (the currently existing one that prints out every package name).\n> \n> I think this could be done much more clearly, ending with a list of suggested system packages to install as you describe.\n\nWe reworked it recently in #28788. Further ideas for improvement - please on a new ticket.\nThe present ticket is ready and needs review.",
    "created_at": "2020-03-06T16:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381861",
    "user": "@mkoeppe"
}
```

Replying to [comment:13 embray]:
> I'd be fine with completely reworking the package summary at the end of configure (the currently existing one that prints out every package name).
> 
> I think this could be done much more clearly, ending with a list of suggested system packages to install as you describe.

We reworked it recently in #28788. Further ideas for improvement - please on a new ticket.
The present ticket is ready and needs review.



---

archive/issue_comments_381862.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-08T20:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381862",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381863.json:
```json
{
    "body": "Needs review...",
    "created_at": "2020-03-09T21:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381863",
    "user": "@mkoeppe"
}
```

Needs review...



---

archive/issue_comments_381864.json:
```json
{
    "body": "In a brand new tarball on an Ubuntu virtual machine:\n\n```\nconfigure: Hint: The following SPKGs did not find equivalent system packages:\nconfigure:   arb boost boost_cropped cbc eclib fplll gfan givaro glpk gp2c lcalc libatomic_ops libsemigroups nauty pari pari_elldata pari_galdata pari_galpol pari_nftables pari_seadata pari_seadata_small planarity sqlite tachyon zeromq\nchecking for the package system in use... debian\n./configure: line 30473: build/bin/sage-get-system-packages: No such file or directory\nconfigure: No equivalent system packages for debian are known to Sage\n```\n",
    "created_at": "2020-03-09T21:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381864",
    "user": "@jhpalmieri"
}
```

In a brand new tarball on an Ubuntu virtual machine:

```
configure: Hint: The following SPKGs did not find equivalent system packages:
configure:   arb boost boost_cropped cbc eclib fplll gfan givaro glpk gp2c lcalc libatomic_ops libsemigroups nauty pari pari_elldata pari_galdata pari_galpol pari_nftables pari_seadata pari_seadata_small planarity sqlite tachyon zeromq
checking for the package system in use... debian
./configure: line 30473: build/bin/sage-get-system-packages: No such file or directory
configure: No equivalent system packages for debian are known to Sage
```




---

archive/issue_comments_381865.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-09T21:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381865",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381866.json:
```json
{
    "body": "What about embray's suggestion to fail on some platforms if gfortran is not installed? I worry that many users will run `make` without first running `./configure`, so the messages printed here will get lost.\n\nI wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. (As a side note, it annoys me that `make distclean` also runs `./configure`.)",
    "created_at": "2020-03-10T20:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381866",
    "user": "@jhpalmieri"
}
```

What about embray's suggestion to fail on some platforms if gfortran is not installed? I worry that many users will run `make` without first running `./configure`, so the messages printed here will get lost.

I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. (As a side note, it annoys me that `make distclean` also runs `./configure`.)



---

archive/issue_comments_381867.json:
```json
{
    "body": "I don't see any message being printed on OS X with homebrew. Is this intentional? I guess so, since there aren't any files `build/pkgs/*/distros/homebrew`. Is that correct?\n\nBy the way, not related to this ticket, but is there a better place to put files like `build/pkgs/arch.txt`? In a directory `build/pkgs/DISTROS` or `build/distros`?",
    "created_at": "2020-03-10T20:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381867",
    "user": "@jhpalmieri"
}
```

I don't see any message being printed on OS X with homebrew. Is this intentional? I guess so, since there aren't any files `build/pkgs/*/distros/homebrew`. Is that correct?

By the way, not related to this ticket, but is there a better place to put files like `build/pkgs/arch.txt`? In a directory `build/pkgs/DISTROS` or `build/distros`?



---

archive/issue_comments_381868.json:
```json
{
    "body": "Replying to [comment:19 jhpalmieri]:\n> What about embray's suggestion to fail on some platforms if gfortran is not installed? \n\nI prefer the milder solution - warning instead of error - for this ticket.\n\n> I worry that many users will run `make` without first running `./configure`, so the messages printed here will get lost.\n\nGood point. \n\n> I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. \n\nI wouldn't mind making this change. Separate ticket?\n\n> (As a side note, it annoys me that `make distclean` also runs `./configure`.)\n\nRight.",
    "created_at": "2020-03-10T21:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381868",
    "user": "@mkoeppe"
}
```

Replying to [comment:19 jhpalmieri]:
> What about embray's suggestion to fail on some platforms if gfortran is not installed? 

I prefer the milder solution - warning instead of error - for this ticket.

> I worry that many users will run `make` without first running `./configure`, so the messages printed here will get lost.

Good point. 

> I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. 

I wouldn't mind making this change. Separate ticket?

> (As a side note, it annoys me that `make distclean` also runs `./configure`.)

Right.



---

archive/issue_comments_381869.json:
```json
{
    "body": "Replying to [comment:20 jhpalmieri]:\n> I don't see any message being printed on OS X with homebrew. Is this intentional? I guess so, since there aren't any files `build/pkgs/*/distros/homebrew`. Is that correct?\n\nThat's right, this needs to be done. That would be a follow up ticket of #29104.\n\n> By the way, not related to this ticket, but is there a better place to put files like `build/pkgs/arch.txt`? In a directory `build/pkgs/DISTROS` or `build/distros`?\n\nYes, in #29124 (Add script packages build/pkgs/_prereq, build/pkgs/_toolchain, build/pkgs/_bootstrap) I plan to move these files to a better location.",
    "created_at": "2020-03-10T21:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381869",
    "user": "@mkoeppe"
}
```

Replying to [comment:20 jhpalmieri]:
> I don't see any message being printed on OS X with homebrew. Is this intentional? I guess so, since there aren't any files `build/pkgs/*/distros/homebrew`. Is that correct?

That's right, this needs to be done. That would be a follow up ticket of #29104.

> By the way, not related to this ticket, but is there a better place to put files like `build/pkgs/arch.txt`? In a directory `build/pkgs/DISTROS` or `build/distros`?

Yes, in #29124 (Add script packages build/pkgs/_prereq, build/pkgs/_toolchain, build/pkgs/_bootstrap) I plan to move these files to a better location.



---

archive/issue_comments_381870.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> Replying to [comment:19 jhpalmieri]:\n> > I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. \n> \n> I wouldn't mind making this change. Separate ticket?\n\nYes.\n \n> > (As a side note, it annoys me that `make distclean` also runs `./configure`.)\n>\n> Right.\n\nThis is now #29310.",
    "created_at": "2020-03-10T22:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381870",
    "user": "@jhpalmieri"
}
```

Replying to [comment:21 mkoeppe]:
> Replying to [comment:19 jhpalmieri]:
> > I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. 
> 
> I wouldn't mind making this change. Separate ticket?

Yes.
 
> > (As a side note, it annoys me that `make distclean` also runs `./configure`.)
>
> Right.

This is now #29310.



---

archive/issue_comments_381871.json:
```json
{
    "body": "This looks okay to me as a first step. We should do more to highlight the messages, at least by encouraging people to run `./configure` and read what it says.",
    "created_at": "2020-03-10T22:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381871",
    "user": "@jhpalmieri"
}
```

This looks okay to me as a first step. We should do more to highlight the messages, at least by encouraging people to run `./configure` and read what it says.



---

archive/issue_comments_381872.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-10T22:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381872",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_381873.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-03-10T22:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381873",
    "user": "@mkoeppe"
}
```

Thanks!



---

archive/issue_comments_381874.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-11T23:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27114#issuecomment-381874",
    "user": "@vbraun"
}
```

Resolution: fixed
