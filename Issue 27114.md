# Issue 27114: Refuse to configure building gfortran on Linux unless explicitly requested

Issue created by migration from https://trac.sagemath.org/ticket/27351

Original creator: embray

Original creation time: 2019-02-25 12:54:07

CC:  jdemeyer dimpase vbraun jhpalmieri mjo fbissey

There have been a spate of reports of issues like #26996 all stemming from people trying to build Sage on Linux systems that do not already have a supported Fortran compiler installed (but easily could).

The problem _only_ occurs when trying to install the gfortran SPKG on Linux, and the fact that it's come up so frequently is alarming, as there should not be any good reason for people to be compiling gfortrans just for Sage.

There is discussion on #27054 about recommending it as a prerequisite.  I would go one step further and just fail--with a helpful error message-at `./configure` time, at least on platforms like Cygwin and most Linux distributions, to just install the system's fortran compiler, unless a flag is given to explicitly request it.  Because there's very rarely any good reason for someone to be wasting their time on that just to build Sage, and it seems many people have been doing so unwarily for a long time.


---

Comment by jdemeyer created at 2019-02-25 12:58:12

I don't think that #26996 should be used as a reason. That's a bug in the build system, that we could just fix independently.

I'm not saying that this ticket by itself is a bad idea, just that #26996 is not a good reason for it.


---

Comment by dimpase created at 2019-02-25 13:02:22

It's a good idea to make it fail on !Linux/Cygwin/Homebrew/FreeBSD.


---

Comment by embray created at 2019-02-25 13:13:22

Replying to [comment:1 jdemeyer]:
> I don't think that #26996 should be used as a reason. That's a bug in the build system, that we could just fix independently.
> 
> I'm not saying that this ticket by itself is a bad idea, just that #26996 is not a good reason for it.

I agree, that's not the motivation at all.  My point was that it happened to expose the fact that a _lot_ of people, more than I'd imagined was the case, were trying (and in the past, presumably, succeeding) to build gfortran when it wasn't really necessary for them to.


---

Comment by embray created at 2019-03-25 10:44:36

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.


---

Comment by mkoeppe created at 2020-02-09 22:13:05

Instead of refusing to build it, I think we should in general suggest a list of system packages to install, at the end of the `configure` run, similar to #26964.

I have revised the ticket description accordingly.


---

Comment by git created at 2020-03-05 04:51:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-05 04:53:12

The code on this branch is roughly what I have in mind for this functionality. Doesn't quite work yet.


---

Comment by git created at 2020-03-06 03:22:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-06 03:28:00

Changing status from new to needs_review.


---

Comment by embray created at 2020-03-06 09:16:43

I'd be fine with completely reworking the package summary at the end of configure (the currently existing one that prints out every package name).

I think this could be done much more clearly, ending with a list of suggested system packages to install as you describe.


---

Comment by mkoeppe created at 2020-03-06 16:37:40

Replying to [comment:13 embray]:
> I'd be fine with completely reworking the package summary at the end of configure (the currently existing one that prints out every package name).
> 
> I think this could be done much more clearly, ending with a list of suggested system packages to install as you describe.

We reworked it recently in #28788. Further ideas for improvement - please on a new ticket.
The present ticket is ready and needs review.


---

Comment by git created at 2020-03-08 20:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-09 21:24:53

Needs review...


---

Comment by jhpalmieri created at 2020-03-09 21:56:31

In a brand new tarball on an Ubuntu virtual machine:

```
configure: Hint: The following SPKGs did not find equivalent system packages:
configure:   arb boost boost_cropped cbc eclib fplll gfan givaro glpk gp2c lcalc libatomic_ops libsemigroups nauty pari pari_elldata pari_galdata pari_galpol pari_nftables pari_seadata pari_seadata_small planarity sqlite tachyon zeromq
checking for the package system in use... debian
./configure: line 30473: build/bin/sage-get-system-packages: No such file or directory
configure: No equivalent system packages for debian are known to Sage
```



---

Comment by git created at 2020-03-09 21:58:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-03-10 20:26:08

What about embray's suggestion to fail on some platforms if gfortran is not installed? I worry that many users will run `make` without first running `./configure`, so the messages printed here will get lost.

I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. (As a side note, it annoys me that `make distclean` also runs `./configure`.)


---

Comment by jhpalmieri created at 2020-03-10 20:33:29

I don't see any message being printed on OS X with homebrew. Is this intentional? I guess so, since there aren't any files `build/pkgs/*/distros/homebrew`. Is that correct?

By the way, not related to this ticket, but is there a better place to put files like `build/pkgs/arch.txt`? In a directory `build/pkgs/DISTROS` or `build/distros`?


---

Comment by mkoeppe created at 2020-03-10 21:06:22

Replying to [comment:19 jhpalmieri]:
> What about embray's suggestion to fail on some platforms if gfortran is not installed? 

I prefer the milder solution - warning instead of error - for this ticket.

> I worry that many users will run `make` without first running `./configure`, so the messages printed here will get lost.

Good point. 

> I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. 

I wouldn't mind making this change. Separate ticket?

> (As a side note, it annoys me that `make distclean` also runs `./configure`.)

Right.


---

Comment by mkoeppe created at 2020-03-10 21:09:00

Replying to [comment:20 jhpalmieri]:
> I don't see any message being printed on OS X with homebrew. Is this intentional? I guess so, since there aren't any files `build/pkgs/*/distros/homebrew`. Is that correct?

That's right, this needs to be done. That would be a follow up ticket of #29104.

> By the way, not related to this ticket, but is there a better place to put files like `build/pkgs/arch.txt`? In a directory `build/pkgs/DISTROS` or `build/distros`?

Yes, in #29124 (Add script packages build/pkgs/_prereq, build/pkgs/_toolchain, build/pkgs/_bootstrap) I plan to move these files to a better location.


---

Comment by jhpalmieri created at 2020-03-10 22:31:11

Replying to [comment:21 mkoeppe]:
> Replying to [comment:19 jhpalmieri]:
> > I wouldn't object if Sage converted to the more standard `./configure; make` procedure, but we're not there yet. On a separate ticket, we should at least encourage this workflow. 
> 
> I wouldn't mind making this change. Separate ticket?

Yes.
 
> > (As a side note, it annoys me that `make distclean` also runs `./configure`.)
>
> Right.

This is now #29310.


---

Comment by jhpalmieri created at 2020-03-10 22:32:01

This looks okay to me as a first step. We should do more to highlight the messages, at least by encouraging people to run `./configure` and read what it says.


---

Comment by jhpalmieri created at 2020-03-10 22:32:01

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-10 22:36:52

Thanks!


---

Comment by vbraun created at 2020-03-11 23:46:25

Resolution: fixed
