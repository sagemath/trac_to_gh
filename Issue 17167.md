# Issue 17167: long time doctests in multi-line code not detected

Issue created by migration from https://trac.sagemath.org/ticket/17404

Original creator: dkrenn

Original creation time: 2014-11-26 15:43:03

CC:  mjo

Keywords: doctest, multiline code, long time

When having a file `long-doctest-bug.py` with a function

```
def f(t):
    """
    TESTS::

        sage: f(2)
        sage: f(3)  # long time
        sage: [f(4),
        ....: ]  # long time
        sage: [f(5),  # long time
        ....: ]
        
    """
    print "sleep", t
    sleep(t)
```

and doctesting it with `sage -t long-doctest-bug.py`, the line containing `f(4)` is tested as well:

```
Running doctests with ID 2014-11-26-16-34-55-f22cca2c.
Doctesting 1 file.
sage -t long-doctest-bug.py
**********************************************************************
File "long-doctest-bug.py", line 5, in long-doctest-bug.f
Failed example:
    f(2)
Expected nothing
Got:
    sleep 2
**********************************************************************
File "long-doctest-bug.py", line 7, in long-doctest-bug.f
Failed example:
    [f(4),
    ]  # long time
Expected nothing
Got:
    sleep 4
    [None]
**********************************************************************
1 item had failures:
   2 of   3 in long-doctest-bug.f
    [2 tests, 2 failures, 6.01 s]
----------------------------------------------------------------------
sage -t long-doctest-bug.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 6.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 6.0 seconds
```


Anyhow, note that it works when `# long time` is put at the end of the first line, which can look weird.


---

Comment by jdemeyer created at 2014-11-26 18:33:08

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-11-26 18:33:08

Feature, not a bug.

Requiring doctest tags to be on the first line makes them much easier to see.


---

Comment by dkrenn created at 2014-11-26 21:38:07

Changing type from defect to enhancement.


---

Comment by dkrenn created at 2014-11-26 21:38:07

Replying to [comment:1 jdemeyer]:
> Feature, not a bug.

Ok. It's now an enhancement...

> Requiring doctest tags to be on the first line makes them much easier to see.

I'm not happy with this. Comments within one code statement can be confusing.
IMHO both should work, i.e., putting "# long time" in the first line as well as in the last line (or even in any line at the end).

This would also support the following: When writing doctests I often start with a one-liner. Then later, when it works, I'll rewrite it to multiple lines. The current behavior means, I have to change where the comment is.
The reverse situation also happens: You have a multi-line doctest, but then you change it and suddenly it fits into one line. Thus, you now have to move the "# long time" from somewhere in betweeb to the end of the line.


---

Comment by dkrenn created at 2014-11-26 21:38:07

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2021-12-28 19:57:53

At the end of the line makes the most sense to me, but we would probably have to support the comments *anywhere* on the line -- at least initially -- to avoid a massive patch bomb.
