# Issue 18187: The ntl-interface test for flint 2.4.5 is broken

Issue created by migration from https://trac.sagemath.org/ticket/18424

Original creator: fbissey

Original creation time: 2015-05-15 06:52:17

flint 2.4.5 (and 2.4.4 at least) fail its test suite when building the ntl-interface test

```
/make[4]: Entering directory
'/home/laurent/sage-6.6-src/sage-6.6/local/var/tmp/sage/build/flint-2.4.5/src'
   CXX   build/interfaces/test/t-NTL-interface
g++: error: build/interfaces/NTL-interface.o: No such file or directory
Makefile:248: recipe for target 'build/interfaces/test/t-NTL-interface'
failed
make[4]: *** [build/interfaces/test/t-NTL-interface] Error 1
make[4]: Leaving directory
'/home/laurent/sage-6.6-src/sage-6.6/local/var/tmp/sage/build/flint-2.4.5/src'
/bin/sh: 3: build/interfaces/test/t-NTL-interface: not found
Makefile:182: recipe for target 'check' failed
make[3]: *** [check] Error 127
make[3]: Leaving directory
'/home/laurent/sage-6.6-src/sage-6.6/local/var/tmp/sage/build/flint-2.4.5/src'
Error: FLINT failed to pass its test suite.
```

sage-on-gentoo and now Gentoo proper have carried a patch for the issue for some time now. See
https://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/sci-mathematics/flint/files/flint-2.4.4-test.patch?view=markup


---

Comment by fbissey created at 2015-05-15 06:53:55

I will create a branch with the appropriate patch in a couple of hours.


---

Comment by fbissey created at 2015-05-15 07:15:06

New commits:


---

Comment by fbissey created at 2015-05-15 07:15:26

Changing status from new to needs_review.


---

Comment by leif created at 2015-05-15 14:01:09

The proper fix is IMHO not to rename the file, but to add a dependency:

```patch
--- flint-2.4.5/Makefile.in	2015-02-17 15:56:55.000000000 +0100
+++ flint-2.4.5/Makefile.in	2015-05-15 15:41:47.203690000 +0200
@@ -211,7 +211,7 @@
 build/interfaces/NTL-interface.o: interfaces/NTL-interface.cpp NTL-interface.h
 	$(QUIET_CXX) $(CXX) $(CFLAGS) $(INCS) -c $< -o $@;
 
-build/interfaces/test/t-NTL-interface$(EXEEXT): interfaces/test/t-NTL-interface.cpp
+build/interfaces/test/t-NTL-interface$(EXEEXT): interfaces/test/t-NTL-interface.cpp build/interfaces/NTL-interface.o
 	$(QUIET_CXX) $(CXX) $(CFLAGS) $(INCS) $< build/interfaces/NTL-interface.o -o $@ $(LIBS);
 
 print-%:
```


Nice Makefile btw. ... B-)


---

Comment by leif created at 2015-05-15 14:04:32

Pretty embarrassing this already went into a stable Sage release, apparently without anybody even noticing.


---

Comment by leif created at 2015-05-15 14:04:32

Changing priority from major to blocker.


---

Comment by leif created at 2015-05-15 14:17:09

Changing keywords from "" to "NTL-interface.o check".


---

Comment by leif created at 2015-05-15 14:17:09

Changing component from spkg-check to packages: standard.


---

Comment by cremona created at 2015-05-15 15:30:09

Reported upstream yet?


---

Comment by leif created at 2015-05-15 15:33:11

Replying to [comment:7 cremona]:
> Reported upstream yet?

No idea; I can't imagine they haven't meanwhile noticed themselves...  (although not everybody builds the NTL interface)


---

Comment by leif created at 2015-05-15 15:41:53

Looks like the bug was still there:

[https://github.com/wbhart/flint2/blob/trunk/Makefile.in#L234](https://github.com/wbhart/flint2/blob/trunk/Makefile.in#L234)


---

Comment by leif created at 2015-05-15 15:46:08

Replying to [comment:9 leif]:
> Looks like the bug was still there:
> 
> [https://github.com/wbhart/flint2/blob/trunk/Makefile.in#L234](https://github.com/wbhart/flint2/blob/trunk/Makefile.in#L234)

Sorry, misread that.  They just renamed the file, but didn't add a dependency, so it's half-fixed upstream.


---

Comment by leif created at 2015-05-15 16:33:53

There's no corresponding issue on github I could comment on, just the commit by the author of the Gentoo patch.


---

Comment by fbissey created at 2015-05-15 19:18:13

Actually the patch is originally mine. The name on the patch is the guy who committed it to the main tree. I found my original bug report for it with some explanations.
https://bugs.gentoo.org/show_bug.cgi?id=516028

I didn't report it upstream because I couldn't reproduce it from a plain upstream tarball. By default upstream builds static stuff and if you do that there is no problem. Originally it wasn't present in sage either, I'd have to check but at some point we must have stopped building static libraries or objects in flint. It only happens when you build shared libraries exclusively.


---

Comment by leif created at 2015-05-15 19:28:32

Replying to [comment:12 fbissey]:
> I didn't report it upstream because I couldn't reproduce it from a plain upstream tarball. By default upstream builds static stuff and if you do that there is no problem. Originally it wasn't present in sage either, I'd have to check but at some point we must have stopped building static libraries or objects in flint. It only happens when you build shared libraries exclusively.

```
commit 6f2750ed7bfb5caf1be3b47ead442e402b667db4
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Thu Oct 2 15:18:09 2014 +0100

    Never build static library

```

Who else...




I'll polish my patch a bit since `t-NTL-interface$(EXEEXT)` should also depend on `$(LIBS)` (and the trailing semicolon doesn't make sense either), then submit it upstream I think.


---

Comment by leif created at 2015-05-16 12:52:46

Replying to [comment:13 leif]:
> I'll polish my patch a bit since `t-NTL-interface$(EXEEXT)` should also depend on `$(LIBS)` (and the trailing semicolon doesn't make sense either), then submit it upstream I think.

Ah, no, `$(LIBS)` contains chains of `-L/path/to/foo -lfoo`, so it should -- if at all explicitly -- depend on `library`.  (But `t-NTL-interface` is made in a rule which in turn already depends on `library`, namely `check`, so we don't really have to add it.)


---

Comment by vbraun created at 2015-05-17 10:24:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-17 10:34:01

Resolution: fixed


---

Comment by leif created at 2015-05-20 12:28:26

FWIW, a proper fix is now in trunk, so we can remove the patch on the next upgrade.
