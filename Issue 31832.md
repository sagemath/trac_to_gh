# Issue 31832: Upgrade jupyterlab to 3.0.x

Issue created by migration from https://trac.sagemath.org/ticket/32069

Original creator: mkoeppe

Original creation time: 2021-06-27 21:25:40

CC:  slelievre @jcamp0x2a dimpase egourgoulhon

#30246 added jupyterlab 2.2.x as an optional package as part of Meta-ticket #30399.

The 3.0 series has been out since December 2020. https://pypi.org/project/jupyterlab/#history 
Current as of June 2021 is 3.0.16.


---

Comment by mkoeppe created at 2021-06-27 23:23:16

Last 10 new commits:


---

Comment by mkoeppe created at 2021-06-27 23:23:16

Changing status from new to needs_review.


---

Comment by git created at 2021-07-06 19:26:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by slelievre created at 2021-07-27 20:58:25

JupyterLab 3.1.0 was released.

- https://github.com/jupyterlab/jupyterlab/releases/tag/v3.1.0


---

Comment by mkoeppe created at 2021-08-12 05:03:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-09-14 01:31:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-09-14 01:34:30

New commits:


---

Comment by git created at 2021-09-14 01:39:00

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-09-14 02:05:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-14 02:05:51

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-09-17 18:23:49

On `debian-bullseye` (https://github.com/mkoeppe/sage/runs/3594020610?check_suite_focus=true)

```
Error:  ==== ERROR IN LOG FILE artifacts/logs-commit-be4c7c8fe60812ff2bb6a0725d9041b2c7687980-tox-docker-debian-bullseye-maximal/logs/pkgs/jupyterlab_widgets-2.0.log ====
-�\�|�/�-�\�|�/�-�An error occurred.
ValueError: 
"@jupyter-widgets/jupyterlab-manager@2.0.0" is not compatible with the current JupyterLab
Conflicting Dependencies:
JupyterLab                        Extension       Package
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/application
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/logconsole
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/mainmenu
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/notebook
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/rendermime
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/rendermime-interfaces
>=6.1.11 <6.2.0                   >=5.0.0 <6.0.0  @jupyterlab/services
>=3.1.11 <3.2.0                   >=2.0.0 <3.0.0  @jupyterlab/settingregistry
See the log file for details:  /tmp/jupyterlab-debug-lp7xrnhx.log
Error installing jupyter-widgets extension into jupyterlab ... exiting
```



---

Comment by mkoeppe created at 2021-09-17 18:24:45

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-12-04 20:37:41

apparently we should aim for version 3.2.4, as my experiment shows.


---

Comment by egourgoulhon created at 2022-03-04 23:50:40

I've just made a few experiments with jupyterlab 3.3.10; it seems to work well with Sage 9.5.
Basically, here is what I did in a Sage 9.5 root directory on Ubuntu 20.04:

```
./sage -i install jupyterlab_widgets         # => installed jupyterlab 2.2.10
./sage -sh
(sage-sh) pip install --upgrade jupyterlab   # => installed jupyterlab 3.3.10
(sage-sh) pip install --upgrade jupyterlab_widgets
(sage-sh) pip install ipympl                 # required for %matplotlib widget
(sage-sh) exit
./sage -n jupyterlab
```

Then jupyterlab 3.3.10 opens in the browser and everything seems to work well. In particular, ``@`interact` works, as well as threejs animations, both tested via https://github.com/egourgoulhon/SageMathTest/blob/master/Notebooks/test_interact.ipynb. The interactive Matplotlib display has been tested with the notebook https://github.com/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display_latex.ipynb, where `%matplotlib notebook` had to be replaced with `%matplotlib widget`, outside the scope of `%display latex`. 

Is the issue with Debian bullseye mentioned in comment:18 still there with jupyterlab 3.3 ? Otherwise, what prevents jupyterlab 3.3 to go into Sage 9.6?


---

Comment by mkoeppe created at 2022-03-05 00:29:05

Replying to [comment:26 egourgoulhon]:
> Is the issue with Debian bullseye mentioned in comment:18 still there with jupyterlab 3.3?

Likely outdated, we'll have to test this.

> Otherwise, what prevents jupyterlab 3.3 to go into Sage 9.6?

Nothing really; if this does not require updates of packages that regular ipython/jupyter uses, then this is fine.


---

Comment by git created at 2022-03-05 00:44:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-05 00:44:54

Here's an attempt to update it (untested)


---

Comment by mkoeppe created at 2022-03-05 00:56:52

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-05 00:57:14

Tested very briefly on macOS, seems to work


---

Comment by egourgoulhon created at 2022-03-05 13:22:57

After pulling the ticket branch in Sage 9.6.beta3 and running make, the command

```
./sage -i jupyterlab_widgets
```

failed, telling that jupyter-packaging-0.11.1.tar.gz is not found on the mirrors:

```
[jupyter_packaging-0.11.1] Fastest mirror: http://www-ftp.lip6.fr/pub/math/sagemath/
[jupyter_packaging-0.11.1] http://www-ftp.lip6.fr/pub/math/sagemath/spkg/upstream/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz
[jupyter_packaging-0.11.1] [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[jupyter_packaging-0.11.1] ERROR [transfer|run:135]: [Errno socket error] [Errno 404] Not Found: '//www-ftp.lip6.fr/pub/math/sagemath/spkg/upstream/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz'
[jupyter_packaging-0.11.1] https://mirror.lyrahosting.com/sagemath/spkg/upstream/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz
[jupyter_packaging-0.11.1] [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[jupyter_packaging-0.11.1] ERROR [transfer|run:135]: [Errno socket error] [Errno 404] Not Found: '//mirror.lyrahosting.com/sagemath/spkg/upstream/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz'
[jupyter_packaging-0.11.1] http://ftp.rediris.es/mirror/sagemath/spkg/upstream/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz
...
[jupyter_packaging-0.11.1] sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
[jupyter_packaging-0.11.1] ************************************************************************
[jupyter_packaging-0.11.1] ************************************************************************
[jupyter_packaging-0.11.1] Error downloading jupyter-packaging-0.11.1.tar.gz
[jupyter_packaging-0.11.1] ************************************************************************
[jupyter_packaging-0.11.1] Please email sage-devel (http://groups.google.com/group/sage-devel)
[jupyter_packaging-0.11.1] explaining the problem and including the log files
[jupyter_packaging-0.11.1]   /home/eric/sage/9.6.develop/logs/pkgs/jupyter_packaging-0.11.1.log
[jupyter_packaging-0.11.1] and
[jupyter_packaging-0.11.1]   /home/eric/sage/9.6.develop/config.log
[jupyter_packaging-0.11.1] Describe your computer, operating system, etc.
[jupyter_packaging-0.11.1] ************************************************************************
make[2]: *** [Makefile:2765 : jupyter_packaging-SAGE_VENV-no-deps] Erreur 1
make[1]: *** [Makefile:2765 : /home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/var/lib/sage/installed/jupyter_packaging-0.11.1] Erreur 2
make[1] : on quitte le répertoire « /home/eric/sage/9.6.develop/build/make »

real	0m40.555s
user	0m0.367s
sys	0m0.104s
***************************************************************
Error building Sage.
```



---

Comment by dimpase created at 2022-03-05 14:28:36

run

```
./configure --enable-download-from-upstream-url
```


then it will be picked up by make etc.

This is the standard way to review package updates - unless you want to download package tarballs manually.


---

Comment by egourgoulhon created at 2022-03-05 15:08:56

Replying to [comment:36 dimpase]:
> run
> {{{
> ./configure --enable-download-from-upstream-url
> }}}
> 
> then it will be picked up by make etc.
> 

Thanks! I did it, then run make and again `./sage -i jupyterlab_widgets`, but still get the same error...


---

Comment by egourgoulhon created at 2022-03-05 15:25:05

More precisely, the option `--enable-download-from-upstream-url` is taken into account but the download from upstream fails:

```
[jupyter_packaging-0.11.1] Attempting to download from https://pypi.io/packages/source/j/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz
[jupyter_packaging-0.11.1] [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[jupyter_packaging-0.11.1] ERROR [transfer|run:135]: [Errno socket error] [Errno socket error] [Errno socket error] [Errno 404] Not Found: '//files.pythonhosted.org/packages/source/j/jupyter_packaging/jupyter-packaging-0.11.1.tar.gz'
```



---

Comment by mkoeppe created at 2022-03-05 18:01:31

Thanks for testing! Looks like the tarball filename pattern has changed, I'll fix it


---

Comment by git created at 2022-03-05 18:05:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-05 18:59:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-05 19:06:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-05 19:07:08

Added some more variants.


---

Comment by egourgoulhon created at 2022-03-05 20:10:22

Thanks for the update. There is no longer any issue with `jupyter_packaging`, but `./sage -i jupyterlab_widgets` fails now in the build of `ipyml`:

```
[ipympl-0.8.8] Attempting to download from https://pypi.io/packages/source/i/ipympl/ipympl-0.8.8.tar.gz
[ipympl-0.8.8] [......................................................................]
[ipympl-0.8.8] ipympl-0.8.8
[ipympl-0.8.8] ====================================================
[ipympl-0.8.8] Setting up build directory for ipympl-0.8.8
[ipympl-0.8.8] Finished extraction
[ipympl-0.8.8] No patch files found in ../patches
[ipympl-0.8.8] ****************************************************
[ipympl-0.8.8] Host system:
[ipympl-0.8.8] Linux cartan 5.13.0-30-generic #33~20.04.1-Ubuntu SMP Mon Feb 7 14:25:10 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
[ipympl-0.8.8] ****************************************************
[ipympl-0.8.8] C compiler: gcc
[ipympl-0.8.8] C compiler version:
[ipympl-0.8.8] Using built-in specs.
[ipympl-0.8.8] COLLECT_GCC=gcc
[ipympl-0.8.8] COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/9/lto-wrapper
[ipympl-0.8.8] OFFLOAD_TARGET_NAMES=nvptx-none:hsa
[ipympl-0.8.8] OFFLOAD_TARGET_DEFAULT=1
[ipympl-0.8.8] Target: x86_64-linux-gnu
[ipympl-0.8.8] Configured with: ../src/configure -v --with-pkgversion='Ubuntu 9.3.0-17ubuntu1~20.04' --with-bugurl=file:///usr/share/doc/gcc-9/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++,gm2 --prefix=/usr --with-gcc-major-version-only --program-suffix=-9 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none=/build/gcc-9-HskZEa/gcc-9-9.3.0/debian/tmp-nvptx/usr,hsa --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
[ipympl-0.8.8] Thread model: posix
[ipympl-0.8.8] gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04) 
[ipympl-0.8.8] ****************************************************
[ipympl-0.8.8] Package 'ipympl' is currently not installed
[ipympl-0.8.8] No legacy uninstaller found for 'ipympl'; nothing to do
[ipympl-0.8.8] Installing ipympl-0.8.8
[ipympl-0.8.8] Processing /home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/var/tmp/sage/build/ipympl-0.8.8/src
[ipympl-0.8.8]   Preparing metadata (pyproject.toml): started
[ipympl-0.8.8]   Running command Preparing metadata (pyproject.toml)
[ipympl-0.8.8]   Traceback (most recent call last):
[ipympl-0.8.8]     File "/home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 363, in <module>
[ipympl-0.8.8]       main()
[ipympl-0.8.8]     File "/home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 345, in main
[ipympl-0.8.8]       json_out['return_val'] = hook(**hook_input['kwargs'])
[ipympl-0.8.8]     File "/home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 164, in prepare_metadata_for_build_wheel
[ipympl-0.8.8]       return hook(metadata_directory, config_settings)
[ipympl-0.8.8]     File "/home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/setuptools/build_meta.py", line 174, in prepare_metadata_for_build_wheel
[ipympl-0.8.8]       self.run_setup()
[ipympl-0.8.8]     File "/home/eric/sage/9.6.develop/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/setuptools/build_meta.py", line 158, in run_setup
[ipympl-0.8.8]       exec(compile(code, __file__, 'exec'), locals())
[ipympl-0.8.8]     File "setup.py", line 41, in <module>
[ipympl-0.8.8]       cmdclass = create_cmdclass('jsdeps', data_files_spec=data_files_spec)
[ipympl-0.8.8]   TypeError: 'NoneType' object is not callable
[ipympl-0.8.8]   error: subprocess-exited-with-error
```



---

Comment by git created at 2022-03-05 21:57:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-05 21:59:28

Thanks for testing! Here's a new version


---

Comment by git created at 2022-03-05 22:01:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-05 22:02:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-05 22:02:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-05 22:03:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-05 22:04:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-05 22:05:43

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2022-03-06 10:05:18

Works like a charm now. Thank you!
I've also tested the new notebook interfaces `nbclassic` and `retrolab`. Thanks for having added them!


---

Comment by egourgoulhon created at 2022-03-06 10:05:18

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-03-06 10:36:58

The issue of `%matplotlib widget` being inoperative within the scope of `%display latex` is tracked in #33469. This is not specific to jupyterlab: it also happens with jupyter.


---

Comment by egourgoulhon created at 2022-03-06 10:50:44

Changing keywords from "" to "jupyterlab".


---

Comment by mkoeppe created at 2022-03-06 16:46:59

Thanks for testing!


---

Comment by vbraun created at 2022-03-09 23:38:24

Resolution: fixed
