# Issue 24984: If gcc is built, 'make' and then 'make' again rebuilds packages needlessly

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2018-04-21 02:59:30

CC:  â€‹jdemeyer embray

On OS X, if 'make' runs successfully, then running 'make' again should do nothing, but in fact it builds many packages: patch, pkgconf, zlib, yasm, ....  I think that what is happening is that when gcc is required, the top-level configure file gets modified in the middle of the first make process (just before building gcc?), so the second make process sees a new configure file, runs it again, and something then triggers these rebuilds.


---

Comment by jhpalmieri created at 2018-04-22 23:55:20

jdemeyer, embray: you're the experts on the build system. Any ideas what would cause this?


---

Comment by jdemeyer created at 2018-04-23 07:22:46

See #24703


---

Comment by jdemeyer created at 2018-04-23 07:23:46

The problem is the dependencies of GCC. Everything that gets built _after_ GCC is safe.


---

Comment by jdemeyer created at 2018-04-23 10:43:22

This could be fixed by moving the toolchain stuff from `build/make/deps` to the top-level `Makefile`.


---

Comment by git created at 2018-04-23 13:57:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-04-23 14:54:51

I'm a little confused about `configure` being rebuilt in the middle of the process, and I have to wonder if that has something to do with #25188.


---

Comment by jdemeyer created at 2018-04-23 15:01:30

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-04-23 16:03:05

Replying to [comment:8 embray]:
> I'm a little confused about `configure` being rebuilt in the middle of the process, and I have to wonder if that has something to do with #25188.

But #25188 hasn't been merged yet, and this behavior happens with at least 8.2.rc3, maybe earlier. Or are you hoping that #25188 might fix it?


---

Comment by jhpalmieri created at 2018-04-23 19:00:13

For the record, applying #25188 does not help here. The branch here fixes the problem, so I am happy with it. Erik, any objections?


---

Comment by jhpalmieri created at 2018-04-24 17:16:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-04-28 11:29:44

Ticket doesn't work for me, various packages fail before gcc finishes compiling. Pretty clear dependency problem. If you review this ticket, make sure to check the log of a full (not: incremental) parallel build for anything but gcc dependencies being built before gcc finishes.


---

Comment by vbraun created at 2018-04-28 11:29:44

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2018-04-28 15:13:23

Do you have your `install.log` somewhere?

I did test it in a parallel build from scratch and it worked.


---

Comment by jdemeyer created at 2018-04-28 15:14:58

Also: what is the exact command that you run? Is it `make` or `make build` or ...?


---

Comment by vbraun created at 2018-04-28 15:24:03

Buildbots always run `make start`
* http://build.sagemath.org/#/builders/29/builds/23
* http://build.sagemath.org/#/builders/8/builds/19


---

Comment by jhpalmieri created at 2018-04-28 15:40:28

Replying to [comment:13 vbraun]:
> Ticket doesn't work for me, various packages fail before gcc finishes compiling. Pretty clear dependency problem. If you review this ticket, make sure to check the log of a full (not: incremental) parallel build for anything but gcc dependencies being built before gcc finishes.

Of course I did this with a full build. The issue is that I used `make` (which I believe works) versus `make start` (which does not). To be honest, I don't understand the purpose of all of the make targets, and in particular `make start`. What does it do that is not accomplished by `make` or `make all`? Can we just get rid of it (= make it do the same thing as `make all`)?


---

Comment by jhpalmieri created at 2018-04-28 15:45:23

A related (and serious) question: if I want to review a ticket like this, how many of the `make` targets should I test? `make start` (for example) is not documented anywhere; should it be good enough to focus on the ones documented in the [installation guide](http://doc.sagemath.org/html/en/installation/source.html#make-targets)?


---

Comment by vbraun created at 2018-04-29 12:00:53

I don't mind removing old targets but maybe not on this ticket. Though I don't see the problem with supporting multiple targets, just make sure that they all depend on building Sage, and document what they have to depend on. What might help would be a consistent naming scheme for internal makefile targets...


---

Comment by git created at 2018-04-30 07:34:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-04-30 10:58:46

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2018-04-30 15:03:44

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2018-04-30 19:06:35

One effect of this is that `.BUILDSTART` can get rewritten in the middle of the build process, so inaccurate timings are reported at the end. I think this can be dealt with on another ticket, but it should be dealt with.

So for other tickets:

- only write `.BUILDSTART` once, even if we build gcc.
- possibly remove some `make` targets.
- document at least some of the others. The buildbots should not be using `make` targets that are undocumented.

(I still don't know why anyone would ever use `make start` instead of `make`: what is the difference between these?)


---

Comment by vbraun created at 2018-04-30 23:10:16

At least when I set up the buildbot, `make start` would build sage and then test that it starts.


---

Comment by jhpalmieri created at 2018-05-01 00:07:45

I don't know if they have changed since you set it up, but now both targets `all` and `start` contain `$(MAKE) '$(STARTED)'` (for example in 8.2.rc4). The only difference seems to be that `make all` does `$(MAKE) doc all-sage` while `make start` does `$(MAKE) all-sage`. I think it would be better to use `make all` (= `make`) instead of `make start`.


---

Comment by vbraun created at 2018-05-08 17:27:57

Resolution: fixed
