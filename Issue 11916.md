# Issue 11916: Make use of PALP for different dimensions

Issue created by migration from Trac.

Original creator: novoselt

Original creation time: 2011-11-26 17:22:06

Assignee: mhampton

CC:  vbraun

Keywords: toric

In #12055 Volker made several copies of PALP for working with different dimensions. This patch exposes this functionality in Sage.

No attempt is made so far to pick the appropriate dimension automatically, since it is not entirely trivial and can have unpleasant consequences (some of the PALP other limits change automatically with dimension). However users can call `lattice_polytope.set_palp_dimension` function to make a global choice for their session.


---

Comment by novoselt created at 2011-11-26 17:26:57

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-11-26 17:55:28

Sounds good, I'll try to review it.

For the record, I'm writing 
  * A lattice polytope class based on PPL
  * Support for accessing the PALP database files through cws.x though an iterator with customizable polytope class as output
I do have it working but I need to clean up the patches. The current state is as always on my bitbucket repo:
https://bitbucket.org/vbraun/mq-for-sage-toric-varieties/src/f1c83df616d8/trac_xxxx_palp_database.patch


---

Comment by novoselt created at 2011-11-26 18:27:53

Looks nice! For the record, I still think that instead of tuples of vectors for, say, vertices, it would be nice to return a container from #11400, which is supposed to be "a customizable tuple with extra features but without performance penalty" ;-)


---

Comment by ncohen created at 2011-12-10 19:49:36

(I added a dependency on #12055 in the ticket's description, +cc me) `:-)`


---

Comment by novoselt created at 2012-03-07 22:00:27

Works great on Sage-5.0.beta7, as expected ;-)


---

Attachment

Fixed whitespaces.


---

Comment by novoselt created at 2012-03-27 17:35:29

I've deleted dependencies to help the patchbot in testing - the current development release already has everything necessary.


---

Comment by vbraun created at 2012-05-02 15:39:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2012-05-02 15:39:27

Looks good!


---

Comment by jdemeyer created at 2012-05-04 11:05:37

On OS X 10.4 PPC as well as OS X 10.6 x86_64, I get:

```
sage -t  --long -force_lib devel/sage/sage/geometry/lattice_polytope.py
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/devel/sage-main/sage/geometry/lattice_polytope.py", line 4896:
    sage: LatticePolytope(identity_matrix(8))
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_117[4]>", line 1, in <module>
        LatticePolytope(identity_matrix(Integer(8)))###line 4896:
    sage: LatticePolytope(identity_matrix(8))
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 291, in LatticePolytope
        return LatticePolytopeClass(data, desc, compute_vertices, copy_vertices, n)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 457, in __init__
        self._compute_dim(compute_vertices=True)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 663, in _compute_dim
        compute_vertices=True)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 291, in LatticePolytope
        return LatticePolytopeClass(data, desc, compute_vertices, copy_vertices, n)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 457, in __init__
        self._compute_dim(compute_vertices=True)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 657, in _compute_dim
        self._vertices = read_palp_matrix(self.poly_x("v"))
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 2661, in poly_x
        return self._palp("poly.x -f" + keys, reduce_dimension)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.1.beta0/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 1024, in _palp
        self, self.vertices(), result)
    ValueError: Error executing "poly-11d.x -fv" for the given polytope!

    Polytope: A lattice polytope: 7-dimensional, 8 vertices.
    Vertices:
    [ 0 -1 -1 -1 -1 -1 -1 -1]
    [ 0  1  0  0  0  0  0  0]
    [ 0  0  1  0  0  0  0  0]
    [ 0  0  0  1  0  0  0  0]
    [ 0  0  0  0  1  0  0  0]
    [ 0  0  0  0  0  1  0  0]
    [ 0  0  0  0  0  0  1  0]
    Output:
    increase POLY_Dmax!

**********************************************************************
```



---

Comment by jdemeyer created at 2012-05-04 11:05:37

Changing status from positive_review to needs_work.


---

Comment by novoselt created at 2012-05-04 14:34:20

This means that dimension adjustments during compilation of PALP didn't work. Volker, can you figure out why not? Sage code did what it was supposed to do.


---

Comment by vbraun created at 2012-05-04 16:17:05

OSX sed doesn't understand `\s` (whitespace). Hence the spkg-install fails to change `POLY_Dmax`...


---

Comment by vbraun created at 2012-05-04 16:26:19

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2012-05-04 16:26:19

Updated spkg uses the more portable `[This is the Trac macro *:space:* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#:space:-macro)` instead. This is the only change that needs review. I tested it on bsd.math and it works on OSX.


---

Comment by vbraun created at 2012-05-04 16:26:44

spkg diff for review purposes only


---

Attachment

Hi Jeroen,

Does it work on that machine now?


---

Comment by jdemeyer created at 2012-05-18 21:50:24

I prefer for somebody to review the package first, then I'll test.


---

Comment by novoselt created at 2012-05-18 22:00:25

Changing status from needs_review to positive_review.


---

Comment by novoselt created at 2012-05-18 22:00:25

OK, the package works fine for me under Linux and the change is reasonable.


---

Comment by jdemeyer created at 2012-06-02 12:04:57

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-06-02 12:04:57

This seems to fail on `hawk` (OpenSolaris 06.2009-32):

```
sage -t  --long -force_lib devel/sage/sage/geometry/lattice_polytope.py
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/devel/sage-main/sage/geometry/lattice_polytope.py", line 4896:
    sage: LatticePolytope(identity_matrix(8))
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_117[4]>", line 1, in <module>
        LatticePolytope(identity_matrix(Integer(8)))###line 4896:
    sage: LatticePolytope(identity_matrix(8))
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 291, in LatticePolytope
        return LatticePolytopeClass(data, desc, compute_vertices, copy_vertices, n)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 457, in __init__
        self._compute_dim(compute_vertices=True)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 663, in _compute_dim
        compute_vertices=True)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 291, in LatticePolytope
        return LatticePolytopeClass(data, desc, compute_vertices, copy_vertices, n)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 457, in __init__
        self._compute_dim(compute_vertices=True)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 657, in _compute_dim
        self._vertices = read_palp_matrix(self.poly_x("v"))
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 2661, in poly_x
        return self._palp("poly.x -f" + keys, reduce_dimension)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.1.beta2/local/lib/python/site-packages/sage/geometry/lattice_polytope.py", line 1024, in _palp
        self, self.vertices(), result)
    ValueError: Error executing "poly-11d.x -fv" for the given polytope!
    Polytope: A lattice polytope: 7-dimensional, 8 vertices.
    Vertices:
    [ 0 -1 -1 -1 -1 -1 -1 -1]
    [ 0  1  0  0  0  0  0  0]
    [ 0  0  1  0  0  0  0  0]
    [ 0  0  0  1  0  0  0  0]
    [ 0  0  0  0  1  0  0  0]
    [ 0  0  0  0  0  1  0  0]
    [ 0  0  0  0  0  0  1  0]
    Output:
    increase POLY_Dmax!

**********************************************************************
```



---

Comment by novoselt created at 2012-06-04 16:03:40

Volker, this seems like the same problem as before. Is spacing different in different files that it is necessary to use regular expressions for it?


---

Comment by vbraun created at 2012-06-04 16:08:13

I'm looking into this as we speak. I don't have an account on hawk but the same thing failed on mark/skynet.


---

Comment by vbraun created at 2012-06-04 16:45:52

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2012-06-04 16:45:52

I've updated to the latest upstream version and dumbed down the regexp to modify `POLY_Dmax` even further. I've tested it on bsd (OSX) and mark (Sun Solaris) and both work now.


---

Attachment

for review purposes only


---

Comment by novoselt created at 2012-06-05 12:08:48

Detection of errors in PALP output is currently achieved by looking for exclamation signs, the new version dropped it, which is unfortunate. I'll need to come up with a patch that fixes it.


---

Comment by novoselt created at 2012-06-05 12:08:48

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2012-06-05 12:42:16

Changing status from needs_work to needs_review.


---

Attachment

Positive review to Volker's new spkg, my new patch needs review: it just looks for more substrings indicating an error.


---

Comment by vbraun created at 2012-06-11 16:25:47

Looks good to me and passes all doctests!

Apply trac_12088_palp_dimension.patch, trac_12088_extend_PALP_error_detetion.patch


---

Comment by vbraun created at 2012-06-11 16:25:47

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-18 10:20:05

Could you please make all files in `src/` world-readable (mode 0644 or 0755)?


---

Comment by jdemeyer created at 2012-06-18 10:20:13

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2012-06-18 10:30:02

Ok, done. The `sage -pkg` still doesn't do that automatically? Should I patch it in?

I'll set this ticket back to positive review since there isn't anything new to review.


---

Comment by vbraun created at 2012-06-18 10:30:02

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2012-06-18 10:33:24

Replying to [comment:26 vbraun]:
> Ok, done. The `sage -pkg` still doesn't do that automatically? Should I patch it in?
I would be in favor of adding a check and warning during `sage -pkg` (just like we check `hg status` currently) in case of files with weird permissions (essentially, anything which isn't 0644 or 0755).


---

Comment by jdemeyer created at 2012-06-18 10:34:15

Such a change would need to be on top of #13113 obviously.


---

Comment by jdemeyer created at 2012-06-18 22:11:24

Resolution: fixed
