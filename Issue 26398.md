# Issue 26398: Major extensions to local components code

Issue created by migration from https://trac.sagemath.org/ticket/26635

Original creator: davidloeffler

Original creation time: 2018-11-04 17:38:20

Keywords: local-components

Some while ago, I contributed to Sage some code for computing the local component (at a given prime) of the automorphic representation attached to a modular form, based on algorithms from a paper I wrote with Jared Weinstein.

The existing implementation is incomplete in several ways:
- it throws an error if the given modular form doesn't have minimal level at p among its character twists;
- if the local component is supercuspidal, induced from a character of a ramified quadratic extension, then it doesn't completely compute the character, it just returns a string saying which extension it comes from;
- in supercuspidal 2-adic cases where the level is divisible by 64, it fails because a certain quotient group that comes up in the computation isn't cyclic.

I have now reworked the code to fill in all of the above gaps. It should now work for all newforms and all primes, with the exception of certain nasty 2-adic cases where no nice parametrisation exists.


---

Comment by davidloeffler created at 2018-11-04 17:45:28

Changing status from new to needs_review.


---

Comment by davidloeffler created at 2018-11-04 17:45:28

New commits:


---

Comment by git created at 2018-11-04 22:02:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2018-11-04 22:04:09

I just committed a fix for some minor coding-style violations picked up by the patchbot.


---

Comment by git created at 2021-04-28 22:46:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2021-04-28 22:47:51

I hopefully fixed the merge failure and a couple of deprecation warnings.  There seems to be one actual doctest failure:


```
File "src/sage/modular/local_comp/local_comp.py", line 704, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters
Failed example:
    Newforms(DirichletGroup(64, QQ).1, 2, names='a')[0].local_component(2).characters() # long time
Expected:
    [
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> -1/4*a0, 4*s + 1 |--> -1, -1 |--> 1, 2 |--> 1,
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> -1/4*a0, 4*s + 1 |--> 1, -1 |--> 1, 2 |--> 1
    ]
Got:
    [
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> 1/2*a0, 4*s + 1 |--> 1, -1 |--> 1, 2 |--> 1,
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> 1/2*a0, 4*s + 1 |--> -1, -1 |--> 1, 2 |--> 1
    ]
```



---

Comment by roed created at 2021-04-28 22:48:34

Nope, merge still failed.  I'll try a more recent version of Sage soon.


---

Comment by davidloeffler created at 2021-04-29 09:22:46

Nice to see some movement on this at long last, thanks for taking a look at it! The doctest failure looks harmless to me, my guess is that Sage has changed its mind about which generator to use for the coeff field of the newform. Let me know if you have trouble getting the merge to work, I can have a go myself (if I still remember how).


---

Comment by git created at 2021-04-30 08:43:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-30 08:47:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2021-04-30 08:47:23

I got the merge to work (and have adjusted the doctest to what's currently returned).  I'll try to read through the code soon, and let you know if I have questions!


---

Comment by davidloeffler created at 2021-05-01 08:05:21

I checked about the failing long doctest. It is indeed unrelated to the code at hand, and arises because sage is using a random algorithm to choose a generator of the coeff field of the newform. Shall we just flag it as # random?


---

Comment by git created at 2021-05-05 15:55:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-05 15:56:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-05 16:01:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2021-05-05 16:05:51

Changing status from needs_review to positive_review.


---

Comment by roed created at 2021-05-05 16:05:51

I read through the code and it looks good.  I made various minor changes to better conform to Sage's style guide.  The one substantive change I made was to move the line `t = self.discrete_log(n, p)` outside a loop.

I'm going to give this a positive review now, but we should keep an eye on the patchbot results.  I'm also hopeful that I can help with improving speed eventually using #26849 (which still needs work).  Finally, what's the theoretical status on the missing 2-adic cases?

I'm sorry this took so long to get reviewed!


---

Comment by davidloeffler created at 2021-05-05 17:08:41

Thanks for the review! 

Your ticket for p-adic unit groups looks interesting & obviously it would be nice to unify it with the local-component code; but I doubt it would lead to much of a speed increase. In local-component computations, the computation time is overwhelmingly dominated by computing modular-symbol spaces and Hecke operators on them. The smoothchar.py stuff is just there to give a user-friendly way of interacting with the results of the modsym computation, it is computationally trivial in itself.


---

Comment by vbraun created at 2021-05-11 22:12:17

PDF docs don't build


---

Comment by vbraun created at 2021-05-11 22:12:17

Changing status from positive_review to needs_work.


---

Comment by davidloeffler created at 2021-05-13 11:59:32

Replying to [comment:22 vbraun]:
> PDF docs don't build

Volker: I cannot reproduce this failure on my machine (since pdf doc building doesn't work on my system for unrelated reasons). Can you post the relevant log file?


---

Comment by davidloeffler created at 2021-05-13 12:47:37

Wait, I found the error: exactly two characters missing in a single docstring in `smoothchar.py`. Testing, will upload shortly.


---

Comment by davidloeffler created at 2021-05-13 12:59:12

Changing status from needs_work to positive_review.


---

Comment by davidloeffler created at 2021-05-13 12:59:12

Right, that should fix it. Given the microscopic size of the change, I presume it is valid to reinstate the positive review.
----
New commits:


---

Comment by roed created at 2021-05-13 16:24:55

Yep, I agree with the positive review.


---

Comment by vbraun created at 2021-06-06 13:19:33

Resolution: fixed
