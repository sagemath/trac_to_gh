# Issue 26398: Major extensions to local components code

archive/issues_026398.json:
```json
{
    "body": "Keywords: local-components\n\nSome while ago, I contributed to Sage some code for computing the local component (at a given prime) of the automorphic representation attached to a modular form, based on algorithms from a paper I wrote with Jared Weinstein.\n\nThe existing implementation is incomplete in several ways:\n- it throws an error if the given modular form doesn't have minimal level at p among its character twists;\n- if the local component is supercuspidal, induced from a character of a ramified quadratic extension, then it doesn't completely compute the character, it just returns a string saying which extension it comes from;\n- in supercuspidal 2-adic cases where the level is divisible by 64, it fails because a certain quotient group that comes up in the computation isn't cyclic.\n\nI have now reworked the code to fill in all of the above gaps. It should now work for all newforms and all primes, with the exception of certain nasty 2-adic cases where no nice parametrisation exists. In particular, with the new code the following example works, fulfilling a request from Ariel Pacetti:\n\n```\nsage: E = EllipticCurve(\"575c1\")\nsage: Pi = E.newform().local_component(5)\nsage: Pi.characters()\n[\nCharacter of Q_5*, of level 1, mapping 2 |--> 1/2*a, 5 |--> 1/2*a + 2,\nCharacter of Q_5*, of level 1, mapping 2 |--> -1/2*a, 5 |--> -1/2*a + 2\n]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/26635\n\n",
    "closed_at": "2021-06-06T13:19:33Z",
    "created_at": "2018-11-04T17:38:20Z",
    "labels": [
        "component: modular forms"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Major extensions to local components code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26398",
    "user": "https://github.com/loefflerd"
}
```
Keywords: local-components

Some while ago, I contributed to Sage some code for computing the local component (at a given prime) of the automorphic representation attached to a modular form, based on algorithms from a paper I wrote with Jared Weinstein.

The existing implementation is incomplete in several ways:
- it throws an error if the given modular form doesn't have minimal level at p among its character twists;
- if the local component is supercuspidal, induced from a character of a ramified quadratic extension, then it doesn't completely compute the character, it just returns a string saying which extension it comes from;
- in supercuspidal 2-adic cases where the level is divisible by 64, it fails because a certain quotient group that comes up in the computation isn't cyclic.

I have now reworked the code to fill in all of the above gaps. It should now work for all newforms and all primes, with the exception of certain nasty 2-adic cases where no nice parametrisation exists. In particular, with the new code the following example works, fulfilling a request from Ariel Pacetti:

```
sage: E = EllipticCurve("575c1")
sage: Pi = E.newform().local_component(5)
sage: Pi.characters()
[
Character of Q_5*, of level 1, mapping 2 |--> 1/2*a, 5 |--> 1/2*a + 2,
Character of Q_5*, of level 1, mapping 2 |--> -1/2*a, 5 |--> -1/2*a + 2
]
```

Issue created by migration from https://trac.sagemath.org/ticket/26635





---

archive/issue_comments_371306.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-04T17:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371306",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_371307.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-11-04T17:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371307",
    "user": "https://github.com/loefflerd"
}
```

New commits:



---

archive/issue_comments_371308.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-04T22:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371308",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371309.json:
```json
{
    "body": "I just committed a fix for some minor coding-style violations picked up by the patchbot.",
    "created_at": "2018-11-04T22:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371309",
    "user": "https://github.com/loefflerd"
}
```

I just committed a fix for some minor coding-style violations picked up by the patchbot.



---

archive/issue_comments_371310.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-28T22:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371310",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371311.json:
```json
{
    "body": "I hopefully fixed the merge failure and a couple of deprecation warnings.  There seems to be one actual doctest failure:\n\n```\nFile \"src/sage/modular/local_comp/local_comp.py\", line 704, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters\nFailed example:\n    Newforms(DirichletGroup(64, QQ).1, 2, names='a')[0].local_component(2).characters() # long time\nExpected:\n    [\n    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> -1/4*a0, 4*s + 1 |--> -1, -1 |--> 1, 2 |--> 1,\n    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> -1/4*a0, 4*s + 1 |--> 1, -1 |--> 1, 2 |--> 1\n    ]\nGot:\n    [\n    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> 1/2*a0, 4*s + 1 |--> 1, -1 |--> 1, 2 |--> 1,\n    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> 1/2*a0, 4*s + 1 |--> -1, -1 |--> 1, 2 |--> 1\n    ]\n```",
    "created_at": "2021-04-28T22:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371311",
    "user": "https://github.com/roed314"
}
```

I hopefully fixed the merge failure and a couple of deprecation warnings.  There seems to be one actual doctest failure:

```
File "src/sage/modular/local_comp/local_comp.py", line 704, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters
Failed example:
    Newforms(DirichletGroup(64, QQ).1, 2, names='a')[0].local_component(2).characters() # long time
Expected:
    [
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> -1/4*a0, 4*s + 1 |--> -1, -1 |--> 1, 2 |--> 1,
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> -1/4*a0, 4*s + 1 |--> 1, -1 |--> 1, 2 |--> 1
    ]
Got:
    [
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> 1/2*a0, 4*s + 1 |--> 1, -1 |--> 1, 2 |--> 1,
    Character of unramified extension Q_2(s)* (s^2 + s + 1 = 0), of level 3, mapping s |--> 1, 2*s + 1 |--> 1/2*a0, 4*s + 1 |--> -1, -1 |--> 1, 2 |--> 1
    ]
```



---

archive/issue_comments_371312.json:
```json
{
    "body": "Nope, merge still failed.  I'll try a more recent version of Sage soon.",
    "created_at": "2021-04-28T22:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371312",
    "user": "https://github.com/roed314"
}
```

Nope, merge still failed.  I'll try a more recent version of Sage soon.



---

archive/issue_comments_371313.json:
```json
{
    "body": "Nice to see some movement on this at long last, thanks for taking a look at it! The doctest failure looks harmless to me, my guess is that Sage has changed its mind about which generator to use for the coeff field of the newform. Let me know if you have trouble getting the merge to work, I can have a go myself (if I still remember how).",
    "created_at": "2021-04-29T09:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371313",
    "user": "https://github.com/loefflerd"
}
```

Nice to see some movement on this at long last, thanks for taking a look at it! The doctest failure looks harmless to me, my guess is that Sage has changed its mind about which generator to use for the coeff field of the newform. Let me know if you have trouble getting the merge to work, I can have a go myself (if I still remember how).



---

archive/issue_comments_371314.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-30T08:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371314",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371315.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-30T08:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371315",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371316.json:
```json
{
    "body": "I got the merge to work (and have adjusted the doctest to what's currently returned).  I'll try to read through the code soon, and let you know if I have questions!",
    "created_at": "2021-04-30T08:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371316",
    "user": "https://github.com/roed314"
}
```

I got the merge to work (and have adjusted the doctest to what's currently returned).  I'll try to read through the code soon, and let you know if I have questions!



---

archive/issue_comments_371317.json:
```json
{
    "body": "I checked about the failing long doctest. It is indeed unrelated to the code at hand, and arises because sage is using a random algorithm to choose a generator of the coeff field of the newform. Shall we just flag it as # random?",
    "created_at": "2021-05-01T08:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371317",
    "user": "https://github.com/loefflerd"
}
```

I checked about the failing long doctest. It is indeed unrelated to the code at hand, and arises because sage is using a random algorithm to choose a generator of the coeff field of the newform. Shall we just flag it as # random?



---

archive/issue_comments_371318.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-05T15:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371318",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371319.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-05T15:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371319",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371320.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-05T16:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371320",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371321.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-05T16:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371321",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_371322.json:
```json
{
    "body": "I read through the code and it looks good.  I made various minor changes to better conform to Sage's style guide.  The one substantive change I made was to move the line `t = self.discrete_log(n, p)` outside a loop.\n\nI'm going to give this a positive review now, but we should keep an eye on the patchbot results.  I'm also hopeful that I can help with improving speed eventually using #26849 (which still needs work).  Finally, what's the theoretical status on the missing 2-adic cases?\n\nI'm sorry this took so long to get reviewed!",
    "created_at": "2021-05-05T16:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371322",
    "user": "https://github.com/roed314"
}
```

I read through the code and it looks good.  I made various minor changes to better conform to Sage's style guide.  The one substantive change I made was to move the line `t = self.discrete_log(n, p)` outside a loop.

I'm going to give this a positive review now, but we should keep an eye on the patchbot results.  I'm also hopeful that I can help with improving speed eventually using #26849 (which still needs work).  Finally, what's the theoretical status on the missing 2-adic cases?

I'm sorry this took so long to get reviewed!



---

archive/issue_comments_371323.json:
```json
{
    "body": "Thanks for the review! \n\nYour ticket for p-adic unit groups looks interesting & obviously it would be nice to unify it with the local-component code; but I doubt it would lead to much of a speed increase. In local-component computations, the computation time is overwhelmingly dominated by computing modular-symbol spaces and Hecke operators on them. The smoothchar.py stuff is just there to give a user-friendly way of interacting with the results of the modsym computation, it is computationally trivial in itself.",
    "created_at": "2021-05-05T17:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371323",
    "user": "https://github.com/loefflerd"
}
```

Thanks for the review! 

Your ticket for p-adic unit groups looks interesting & obviously it would be nice to unify it with the local-component code; but I doubt it would lead to much of a speed increase. In local-component computations, the computation time is overwhelmingly dominated by computing modular-symbol spaces and Hecke operators on them. The smoothchar.py stuff is just there to give a user-friendly way of interacting with the results of the modsym computation, it is computationally trivial in itself.



---

archive/issue_events_066070.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-05-10T11:02:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26398#event-66070"
}
```



---

archive/issue_comments_371324.json:
```json
{
    "body": "PDF docs don't build",
    "created_at": "2021-05-11T22:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371324",
    "user": "https://github.com/vbraun"
}
```

PDF docs don't build



---

archive/issue_comments_371325.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-05-11T22:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371325",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_371326.json:
```json
{
    "body": "Replying to [comment:22 vbraun]:\n> PDF docs don't build\n\n\nVolker: I cannot reproduce this failure on my machine (since pdf doc building doesn't work on my system for unrelated reasons). Can you post the relevant log file?",
    "created_at": "2021-05-13T11:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371326",
    "user": "https://github.com/loefflerd"
}
```

Replying to [comment:22 vbraun]:
> PDF docs don't build


Volker: I cannot reproduce this failure on my machine (since pdf doc building doesn't work on my system for unrelated reasons). Can you post the relevant log file?



---

archive/issue_comments_371327.json:
```json
{
    "body": "Wait, I found the error: exactly two characters missing in a single docstring in `smoothchar.py`. Testing, will upload shortly.",
    "created_at": "2021-05-13T12:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371327",
    "user": "https://github.com/loefflerd"
}
```

Wait, I found the error: exactly two characters missing in a single docstring in `smoothchar.py`. Testing, will upload shortly.



---

archive/issue_comments_371328.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-05-13T12:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371328",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_371329.json:
```json
{
    "body": "Right, that should fix it. Given the microscopic size of the change, I presume it is valid to reinstate the positive review.\n\n---\nNew commits:",
    "created_at": "2021-05-13T12:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371329",
    "user": "https://github.com/loefflerd"
}
```

Right, that should fix it. Given the microscopic size of the change, I presume it is valid to reinstate the positive review.

---
New commits:



---

archive/issue_comments_371330.json:
```json
{
    "body": "Yep, I agree with the positive review.",
    "created_at": "2021-05-13T16:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371330",
    "user": "https://github.com/roed314"
}
```

Yep, I agree with the positive review.



---

archive/issue_events_066071.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-06T13:19:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26398#event-66071"
}
```



---

archive/issue_comments_371331.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26398#issuecomment-371331",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
