# Issue 29566: Upgrade setuptools, pip (2020-06)

Issue created by migration from https://trac.sagemath.org/ticket/29803

Original creator: mkoeppe

Original creation time: 2020-06-05 04:52:32

CC:  vbraun chapoton saraedum slelievre fbissey dimpase jhpalmieri




---

Comment by mkoeppe created at 2020-06-05 05:07:23

New commits:


---

Comment by mkoeppe created at 2020-06-05 17:26:40

pip installation fails, for example on ubuntu-bionic-standard (https://github.com/mkoeppe/sage/runs/741110905)

```
     Preparing wheel metadata: finished with status 'error'
ERROR: Command errored out with exit status 1: /sage/local/bin/python3 /sage/local/var/tmp/sage/build/pip-20.1.1/src/src/pip/_vendor/pep517/_in_process.py prepare_metadata_for_build_wheel /tmp/tmp32gsdf31 Check the logs for full command output.
```



---

Comment by mkoeppe created at 2020-06-05 17:50:23

Seems we need to add the `wheel` package


---

Comment by git created at 2020-06-05 18:44:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-05 18:52:03

Tests run at https://github.com/mkoeppe/sage/pull/36/checks


---

Comment by mkoeppe created at 2020-06-05 21:59:48

On `debian-bullseye-standard`:

```
  [pkgconfig-1.5.1]     File "/usr/lib/python3.7/importlib/__init__.py", line 127, in import_module
  [pkgconfig-1.5.1]       return _bootstrap._gcd_import(name[level:], package, level)
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 1006, in _gcd_import
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 983, in _find_and_load
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 953, in _find_and_load_unlocked
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 1006, in _gcd_import
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 983, in _find_and_load
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 953, in _find_and_load_unlocked
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 1006, in _gcd_import
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 983, in _find_and_load
  [pkgconfig-1.5.1]     File "<frozen importlib._bootstrap>", line 965, in _find_and_load_unlocked
  [pkgconfig-1.5.1]   ModuleNotFoundError: No module named 'poetry'
```



---

Comment by mkoeppe created at 2020-06-05 22:05:44

pkgconfig is at the most current version. Looks like giving it a modern setuptools causes it to demand more.


---

Comment by mkoeppe created at 2020-06-05 22:16:45

poetry, of course, has a LONG list of additional dependencies... https://github.com/python-poetry/poetry/blob/master/pyproject.toml


---

Comment by mkoeppe created at 2020-06-05 22:25:36

We will postpone adding poetry to #29810 and instead patch `pkgconfig` so it installs more prosaically using `setuptools`.


---

Comment by mkoeppe created at 2020-06-05 22:26:03

https://github.com/matze/pkgconfig/commits/master


---

Comment by mkoeppe created at 2020-06-05 22:48:58

See #28883 for the last `pkgconfig` update, which commented on the issues with `poetry` already.


---

Comment by git created at 2020-06-05 22:53:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-05 23:03:13

Tests run again at â€‹https://github.com/mkoeppe/sage/pull/36/checks


---

Comment by mkoeppe created at 2020-06-06 16:40:34

Several failures (for example in https://github.com/mkoeppe/sage/runs/744000563):

```
  [entrypoints-0.3]   ModuleNotFoundError: No module named 'flit'
  [testpath-0.4.2]   ModuleNotFoundError: No module named 'flit'
  [zope_interface-4.6.0]   ImportError: cannot import name 'Feature' from 'setuptools' (/sage/local/lib/python3.7/site-packages/setuptools/__init__.py)
  [terminado-0.8.1]   ModuleNotFoundError: No module named 'flit'
```



---

Comment by mkoeppe created at 2020-06-06 17:09:38

Possible that `zope_interface` can be removed (#29754)


---

Comment by mkoeppe created at 2020-06-06 17:13:39

`entrypoints` is current, https://pypi.org/project/testpath/ can be upgraded to 0.4.4, https://pypi.org/project/terminado/ to 0.8.3


---

Comment by git created at 2020-06-06 17:39:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-06 18:18:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-06 18:23:16

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-06 20:14:59

Builds fine on `homebrew-macos-standard`. Ready for review.


---

Comment by dimpase created at 2020-06-12 18:41:29

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-12 18:41:29

lgtm


---

Comment by mkoeppe created at 2020-06-12 18:55:25

Thanks!


---

Comment by vbraun created at 2020-06-27 09:26:17

Resolution: fixed


---

Comment by jhpalmieri created at 2020-07-02 00:29:34

Not a big deal, but I'm curious: with `pip`, why only the change to set `versions=3`, instead of removing the loop `for vers in $versions ...` and replacing `$vers` with `3` in `spkg-install.in`?


---

Comment by mkoeppe created at 2020-07-02 18:13:11

I like to keep diffs minimal. Also minor uncertainty what the python binary will be called when python 4.0 comes out...


---

Comment by jhpalmieri created at 2020-07-13 22:18:03

I _think_ that this ticket is leading to the following messages in the `sagetex` install log:

```
Successfully built sagetex
Installing collected packages: sagetex
  Created temporary directory: /private/var/folders/cp/n8wtqs490tq5psknff1hv9qr0000gn/T/pip-unpacked-wheel-hw7nz29q
  *** Error compiling '/private/var/folders/cp/n8wtqs490tq5psknff1hv9qr0000gn/T/pip-unpacked-wheel-hw7nz29q/sagetex-3.4.data/data/share/texmf/tex/latex/sagetex/extractsagecode.py'...
    File "/private/var/folders/cp/n8wtqs490tq5psknff1hv9qr0000gn/T/pip-unpacked-wheel-hw7nz29q/sagetex-3.4.data/data/share/texmf/tex/latex/sagetex/extractsagecode.py", line 48
      except getopt.GetoptError, err:
                               ^
  SyntaxError: invalid syntax
  
  *** Error compiling '/private/var/folders/cp/n8wtqs490tq5psknff1hv9qr0000gn/T/pip-unpacked-wheel-hw7nz29q/sagetex-3.4.data/data/share/texmf/tex/latex/sagetex/makestatic.py'...
    File "/private/var/folders/cp/n8wtqs490tq5psknff1hv9qr0000gn/T/pip-unpacked-wheel-hw7nz29q/sagetex-3.4.data/data/share/texmf/tex/latex/sagetex/makestatic.py", line 48
      except getopt.GetoptError, err:
                               ^
  SyntaxError: invalid syntax
  

Successfully installed sagetex-3.4
Removed build tracker: '/private/var/folders/cp/n8wtqs490tq5psknff1hv9qr0000gn/T/pip-req-tracker-3d0gjhof'
Removing old SageTex version(s)

real	0m3.793s
user	0m1.162s
sys	0m0.458s
Copying package files from temporary location /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta3/local/var/tmp/sage/build/sagetex-3.4/inst to /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta3/local
Successfully installed sagetex-3.4
Deleting temporary build directory
/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta3/local/var/tmp/sage/build/sagetex-3.4
Finished installing sagetex-3.4.spkg
```

Is it the new `wheel` package?

(This is on OS X using the system Python, version 3.7.7.)


---

Comment by mkoeppe created at 2020-07-14 04:29:27

pip likes to install via `bdist_wheel` now. Something is getting compiled that was not compiled before. 

I think it reveals that the sagetex code is not compatible with python 3.


---

Comment by dimpase created at 2020-07-14 12:12:39

I am going to make a new release of sagetex soon.


---

Comment by jhpalmieri created at 2020-07-14 16:54:15

Replying to [comment:36 dimpase]:
> I am going to make a new release of sagetex soon.

Good, that should take care of it. I'm surprised that sagetex still works, given these syntax errors.


---

Comment by dimpase created at 2020-07-14 17:49:34

probably it's from some file that we normally didn't install, or perhaps it was using some compatibility kludge that is now gone.
