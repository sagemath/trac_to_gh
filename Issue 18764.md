# Issue 18764: Conic diagonalization fails on some base fields

archive/issues_018764.json:
```json
{
    "body": "CC:  @mstreng\n\nThe function `sage.schemes.plane_conics.con_field.ProjectiveConic_field.hom()` with codomain argument `Y` given fails on base fields for which sage doesn't know how to simplify fractions of polynomials. Consequently `diagonalization()` fails for cases that I need to implement #6881.\n\nMy current workaround is to, in case of characteristic 0, convert the fraction `q` to a symbolic expression and back. I'm not sure if this is mathematically okay, and this still leaves infinite fields of positive characteristic.\n\nBut is it really necessary for `diagonalization()` to check if the found matrix transformation gives the required morphism?\n\n**Example:**\n\n\n```python\nsage: K = FractionField(PolynomialRing(QQ, 't')); (t,) = K.gens(); C = Conic(K, [1/2,0, 1, 2, 0, 3])\nsage: C.diagonalization()\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-2-c3844e29eb5c> in <module>()\n----> 1 C.diagonalization()\n\n/home/lennart/sage-build/sage-6.7/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.pyc in diagonalization(self, names)\n    339         D, T = self.diagonal_matrix()\n    340         con = Conic(D, names = names)\n--> 341         return con, con.hom(T, self), self.hom(T.inverse(), con)\n    342 \n    343     def gens(self):\n\n/home/lennart/sage-build/sage-6.7/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.pyc in hom(self, x, Y)\n    656                     raise ValueError(\"The matrix x (= %s) does not define a \" \\\n    657                                       \"map from self (= %s) to Y (= %s)\" % \\\n--> 658                                       (x, self, Y))\n    659             x = Sequence(x*vector(self.ambient_space().gens()))\n    660             return self.Hom(Y)(x, check = False)\n\nValueError: The matrix x (= [ 1  0 -1]\n[ 0  1  0]\n[ 0  0  1]) does not define a map from self (= Projective Conic Curve over Fraction Field of Univariate Polynomial Ring in t over Rational Field defined by 1/2*x^2 + 2*y^2 + 5/2*z^2) to Y (= Projective C\nonic Curve over Fraction Field of Univariate Polynomial Ring in t over Rational Field defined by 1/2*x^2 + 2*y^2 + x*z + 3*z^2)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19001\n\n",
    "created_at": "2015-08-07T22:17:12Z",
    "labels": [
        "algebraic geometry",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "Conic diagonalization fails on some base fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18764",
    "user": "@lennartack"
}
```
CC:  @mstreng

The function `sage.schemes.plane_conics.con_field.ProjectiveConic_field.hom()` with codomain argument `Y` given fails on base fields for which sage doesn't know how to simplify fractions of polynomials. Consequently `diagonalization()` fails for cases that I need to implement #6881.

My current workaround is to, in case of characteristic 0, convert the fraction `q` to a symbolic expression and back. I'm not sure if this is mathematically okay, and this still leaves infinite fields of positive characteristic.

But is it really necessary for `diagonalization()` to check if the found matrix transformation gives the required morphism?

**Example:**


```python
sage: K = FractionField(PolynomialRing(QQ, 't')); (t,) = K.gens(); C = Conic(K, [1/2,0, 1, 2, 0, 3])
sage: C.diagonalization()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-2-c3844e29eb5c> in <module>()
----> 1 C.diagonalization()

/home/lennart/sage-build/sage-6.7/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.pyc in diagonalization(self, names)
    339         D, T = self.diagonal_matrix()
    340         con = Conic(D, names = names)
--> 341         return con, con.hom(T, self), self.hom(T.inverse(), con)
    342 
    343     def gens(self):

/home/lennart/sage-build/sage-6.7/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.pyc in hom(self, x, Y)
    656                     raise ValueError("The matrix x (= %s) does not define a " \
    657                                       "map from self (= %s) to Y (= %s)" % \
--> 658                                       (x, self, Y))
    659             x = Sequence(x*vector(self.ambient_space().gens()))
    660             return self.Hom(Y)(x, check = False)

ValueError: The matrix x (= [ 1  0 -1]
[ 0  1  0]
[ 0  0  1]) does not define a map from self (= Projective Conic Curve over Fraction Field of Univariate Polynomial Ring in t over Rational Field defined by 1/2*x^2 + 2*y^2 + 5/2*z^2) to Y (= Projective C
onic Curve over Fraction Field of Univariate Polynomial Ring in t over Rational Field defined by 1/2*x^2 + 2*y^2 + x*z + 3*z^2)
```


Issue created by migration from https://trac.sagemath.org/ticket/19001





---

archive/issue_comments_256191.json:
```json
{
    "body": "Changing type from enhancement to defect.",
    "created_at": "2015-08-07T22:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256191",
    "user": "@lennartack"
}
```

Changing type from enhancement to defect.



---

archive/issue_comments_256192.json:
```json
{
    "body": "Replying to [comment:1 lackermans]:\nReally a defect, as we shouldn't throw a ValueError for something that can't be computed.",
    "created_at": "2015-08-07T22:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256192",
    "user": "@lennartack"
}
```

Replying to [comment:1 lackermans]:
Really a defect, as we shouldn't throw a ValueError for something that can't be computed.



---

archive/issue_comments_256193.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2015-08-17T16:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256193",
    "user": "@mstreng"
}
```

Changing priority from minor to major.



---

archive/issue_comments_256194.json:
```json
{
    "body": "This is a serious bug in `hom`, giving incorrect information to the user. That needs to be fixed, independently of what it means for the diagonalization method, and for all fields once and for all. I removed the workaround (which only works for certain fields) from the ticket description.\n\nAs a temporary workaround: avoid giving `Y` to `hom` in conics, and use `diagonal_matrix()` directly instead of `diagonalization()`.",
    "created_at": "2015-08-17T16:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256194",
    "user": "@mstreng"
}
```

This is a serious bug in `hom`, giving incorrect information to the user. That needs to be fixed, independently of what it means for the diagonalization method, and for all fields once and for all. I removed the workaround (which only works for certain fields) from the ticket description.

As a temporary workaround: avoid giving `Y` to `hom` in conics, and use `diagonal_matrix()` directly instead of `diagonalization()`.



---

archive/issue_comments_256195.json:
```json
{
    "body": "I'm writing a patch",
    "created_at": "2015-08-18T12:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256195",
    "user": "@mstreng"
}
```

I'm writing a patch



---

archive/issue_comments_256196.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-08-18T12:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256196",
    "user": "@mstreng"
}
```

New commits:



---

archive/issue_comments_256197.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-08-18T12:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256197",
    "user": "@mstreng"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_256198.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-11T17:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256198",
    "user": "@lennartack"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_256199.json:
```json
{
    "body": "You need to put your real name as reviewer.",
    "created_at": "2015-12-13T15:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256199",
    "user": "@tscrim"
}
```

You need to put your real name as reviewer.



---

archive/issue_comments_256200.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> You need to put your real name as reviewer.\nOk.",
    "created_at": "2015-12-14T12:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256200",
    "user": "@lennartack"
}
```

Replying to [comment:8 tscrim]:
> You need to put your real name as reviewer.
Ok.



---

archive/issue_comments_256201.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-22T19:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18764#issuecomment-256201",
    "user": "@vbraun"
}
```

Resolution: fixed
