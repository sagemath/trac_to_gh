# Issue 23104: port lcalc to C++11

Issue created by migration from https://trac.sagemath.org/ticket/23341

Original creator: dimpase

Original creation time: 2017-06-29 23:04:58

CC:  fbissey

porting lcalc to C++11
    
    * "using namespace std;" need an include with stuff from std:: before it
    
    * "typeof" is a gcc extension - C++11 has "decltype" instead
    
    * plain C must not be compiled with C++ compiler - thus a makefile change


---

Comment by fbissey created at 2017-06-29 23:06:16

Can you rebase on 8.0.rc0? Your branch shows up in red.


---

Comment by dimpase created at 2017-06-29 23:08:02

this is needed for building lcalc with `-std=c++11`.
(tested so far with clang 4.0.1 on Linux, with `stdlib=libc++`)

Only the top commit is of interest. Perhaps it can be based on rc0 indeed. But I need sleep now :-)


---

Comment by fbissey created at 2017-06-29 23:30:43

OK :)

The next question is how to ensure that the compiler then uses c++11. lcalc doesn't have a configure script so we cannot do it there.  At the very least `spkg-install` will need to insert `-std=c++11` in `CXXFLAGS` to make sure you are always using c++11.


---

Comment by git created at 2017-06-30 06:46:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-06-30 07:30:09

the other problem here is an incorrect building of lcalc extension. Here C++ is compiled with a C compiler, which is patently wrong.
Any idea how this can be fixed?

```
[sagelib-8.0.rc0] [  4/323] clang -fno-strict-aliasing -OPT:Olimit=0 -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/mnt/opt/Sage/sage-clang/local/lib/python2.7/site-packages/cypari2 -I/mnt/opt/Sage/sage-clang/local/lib/python2.7/site-packages/cysignals -I/mnt/opt/Sage/sage-clang/local/include -I/mnt/opt/Sage/sage-clang/local/include/python2.7 -I/mnt/opt/Sage/sage-clang/local/lib/python2.7/site-packages/numpy/core/include -I/mnt/opt/Sage/sage-clang/src -I/mnt/opt/Sage/sage-clang/src/sage/ext -I/mnt/opt/Sage/sage-clang/src/build/cythonized -I/mnt/opt/Sage/sage-clang/src/build/cythonized/sage/ext -I/mnt/opt/Sage/sage-clang/local/include/python2.7 -c /mnt/opt/Sage/sage-clang/src/build/cythonized/sage/libs/lcalc/lcalc_Lfunction.cpp -o build/temp.linux-x86_64-2.7/mnt/opt/Sage/sage-clang/src/build/cythonized/sage/libs/lcalc/lcalc_Lfunction.o -fno-strict-aliasing -O3 -ffast-math
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/src/build/cythonized/sage/libs/lcalc/lcalc_Lfunction.cpp:505:
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/src/sage/libs/lcalc/lcalc_sage.h:1:
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/local/include/libLfunction/L.h:34:
[sagelib-8.0.rc0] In file included from /usr/lib/gcc/x86_64-pc-linux-gnu/6.3.0/include/g++-v6/backward/strstream:50:
[sagelib-8.0.rc0] /usr/lib/gcc/x86_64-pc-linux-gnu/6.3.0/include/g++-v6/backward/backward_warning.h:32:2: warning: This file includes at least one deprecated or antiquated header which   may be removed without further notice at a future date. Please use a   non-deprecated interface with equivalent functionality instead. For a   listing of replacement headers and interfaces, consult the file   backward_warning.h. To disable this warning use -Wno-deprecated. [-W#warnings]
[sagelib-8.0.rc0] #warning \
[sagelib-8.0.rc0]  ^
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/src/build/cythonized/sage/libs/lcalc/lcalc_Lfunction.cpp:505:
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/src/sage/libs/lcalc/lcalc_sage.h:1:
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/local/include/libLfunction/L.h:40:
[sagelib-8.0.rc0] In file included from /mnt/opt/Sage/sage-clang/local/include/libLfunction/Lglobals.h:48:
[sagelib-8.0.rc0] /mnt/opt/Sage/sage-clang/local/include/libLfunction/Lcommon.h:71:8: error: expected ';' in 'for' statement specifier
[sagelib-8.0.rc0]                 loop(i,this->N,N) coeffs[i]=zero;
[sagelib-8.0.rc0                       ^
...
```



---

Comment by dimpase created at 2017-06-30 07:31:43

Replying to [comment:3 fbissey]:
> OK :)
> 
> The next question is how to ensure that the compiler then uses c++11. lcalc doesn't have a configure script so we cannot do it there.  At the very least `spkg-install` will need to insert `-std=c++11` in `CXXFLAGS` to make sure you are always using c++11.

We may assume that all the C++ compilers we care about support `-std=c++11`, right?
So this may be an independent of clang tickets thing?


---

Comment by dimpase created at 2017-06-30 07:35:00

Jeroen, do you know to force the use of C++ compiler here (with proper use of CXXFLAGS, too) ?


---

Comment by dimpase created at 2017-06-30 07:35:00

Changing type from PLEASE CHANGE to defect.


---

Comment by dimpase created at 2017-06-30 07:35:00

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by fbissey created at 2017-06-30 07:35:21

Changing type from defect to PLEASE CHANGE.


---

Comment by fbissey created at 2017-06-30 07:35:21

Replying to [comment:5 dimpase]:
> the other problem here is an incorrect building of lcalc extension. Here C++ is compiled with a C compiler, which is patently wrong.
> Any idea how this can be fixed?

Yes. This is https://bugs.python.org/issue1222585 the patch needed for that is included in the gentoo patch tarball for python.


---

Comment by fbissey created at 2017-06-30 07:35:21

Changing component from packages: standard to PLEASE CHANGE.


---

Comment by fbissey created at 2017-06-30 07:36:34

Replying to [comment:6 dimpase]:
> We may assume that all the C++ compilers we care about support `-std=c++11`, right?
> So this may be an independent of clang tickets thing?

Definitely. This shouldn't depend on #12426.


---

Comment by dimpase created at 2017-06-30 07:38:14

Replying to [comment:8 fbissey]:
> Replying to [comment:5 dimpase]:
> > the other problem here is an incorrect building of lcalc extension. Here C++ is compiled with a C compiler, which is patently wrong.
> > Any idea how this can be fixed?
> 
> Yes. This is https://bugs.python.org/issue1222585 the patch needed for that is included in the gentoo patch tarball for python.

Is there a Sage ticket for this already?


---

Comment by fbissey created at 2017-06-30 07:40:10

Replying to [comment:10 dimpase]:
> Replying to [comment:8 fbissey]:
> > Replying to [comment:5 dimpase]:
> > > the other problem here is an incorrect building of lcalc extension. Here C++ is compiled with a C compiler, which is patently wrong.
> > > Any idea how this can be fixed?
> > 
> > Yes. This is https://bugs.python.org/issue1222585 the patch needed for that is included in the gentoo patch tarball for python.
> 
> Is there a Sage ticket for this already?

I don't think so. But it comes up regularly.


---

Comment by jdemeyer created at 2017-06-30 08:34:36

How urgent is this? It might be possible to drop the `lcalc` package completely in favour of PARI/GP. However, the timeframe for this might be in the order on months (mainly because I don't know enough mathematically about L-functions).


---

Comment by fbissey created at 2017-06-30 08:39:02

Replying to [comment:12 jdemeyer]:
> How urgent is this? It might be possible to drop the `lcalc` package completely in favour of PARI/GP. However, the timeframe for this might be in the order on months (mainly because I don't know enough mathematically about L-functions).

I think Dima started this with the view of compiling sage with `-std=c++11`. If that's what he is doing, getting https://bugs.python.org/issue1222585 in would be more pressing in my opinion.


---

Comment by dimpase created at 2017-06-30 09:11:27

Replying to [comment:13 fbissey]:
> Replying to [comment:12 jdemeyer]:
> > How urgent is this? It might be possible to drop the `lcalc` package completely in favour of PARI/GP. However, the timeframe for this might be in the order on months (mainly because I don't know enough mathematically about L-functions).
> 
> I think Dima started this with the view of compiling sage with `-std=c++11`.

indeed, and as a part of the clang porting effort too - it's just too much trouble to have different packages with different `c++xy` IMHO, especially if one depends on the another, they better be on the same `xy`...
 


> If that's what he is doing, getting https://bugs.python.org/issue1222585 in would be more pressing in my opinion.

I'll see how it flies with these patches, and open a ticket.


---

Comment by fbissey created at 2017-06-30 09:13:45

Replying to [comment:14 dimpase]:
> I'll see how it flies with these patches, and open a ticket.
> 

For info Gentoo's python includes those. sage-on-gentoo has been compiled using these patches to distutils for almost as long as it existed.


---

Comment by dimpase created at 2017-06-30 10:45:30

For the life of me, I don't understand why the patch [21_all_distutils_c++.patch](http://users.ox.ac.uk/~coml0531/sage/21_all_distutils_c++.patch)
from https://dev.gentoo.org/~floppym/python/python-gentoo-patches-2.7.13-0.tar.xz
does not apply if I place it in `build/pkgs/python2/patches/`: all the files etc are as they should be, yet I get

```
[python2-2.7.13.p1] Applying patches from ../patches...
[python2-2.7.13.p1] Applying ../patches/2.6.5-FD_SETSIZE.patch
[python2-2.7.13.p1] patching file Modules/selectmodule.c
[python2-2.7.13.p1] Applying ../patches/21_all_distutils_c++.patch
[python2-2.7.13.p1] can't find file to patch at input line 5
[python2-2.7.13.p1] Perhaps you used the wrong -p or --strip option?
[python2-2.7.13.p1] The text leading up to this was:
[python2-2.7.13.p1] --------------------------
[python2-2.7.13.p1] |https://bugs.python.org/issue1222585
[python2-2.7.13.p1] |
[python2-2.7.13.p1] |--- Lib/_osx_support.py
[python2-2.7.13.p1] |+++ Lib/_osx_support.py
[python2-2.7.13.p1] --------------------------
[python2-2.7.13.p1] File to patch: 
...
```


Seems to be the right format, the right paths to files, yet this...


---

Comment by fbissey created at 2017-06-30 10:53:06

Check the patch directory levels with another patch there may be one directory to many in the Gentoo patch compared to what sage's automatic patching needs.


---

Comment by dimpase created at 2017-06-30 10:59:35

Replying to [comment:17 fbissey]:
> Check the patch directory levels with another patch there may be one directory to many in the Gentoo patch compared to what sage's automatic patching needs.

no, it's not the case as far as I can see (and I've been stuck with it for an hour already, just not yet ready to apply it by hand...)


---

Comment by fbissey created at 2017-06-30 11:18:49

Just checked you need to _add_ one directory level to the gentoo patch. That is

```
--- Lib/_osx_support.py
+++ Lib/_osx_support.py
```

needs to become 

```
--- a/Lib/_osx_support.py
+++ b/Lib/_osx_support.py
```

and so on...


---

Comment by dimpase created at 2017-06-30 11:30:31

Replying to [comment:19 fbissey]:
> Just checked you need to _add_ one directory level to the gentoo patch. That is
> {{{
> --- Lib/_osx_support.py
> +++ Lib/_osx_support.py
> }}}
> needs to become 
> {{{
> --- a/Lib/_osx_support.py
> +++ b/Lib/_osx_support.py
> }}}
> and so on...

Oh, thanks, I've been blind...


---

Comment by dimpase created at 2017-07-01 23:49:03

Replying to [comment:3 fbissey]:
> OK :)
> 
> The next question is how to ensure that the compiler then uses c++11. lcalc doesn't have a configure script so we cannot do it there.  At the very least `spkg-install` will need to insert `-std=c++11` in `CXXFLAGS` to make sure you are always using c++11.

Somehow I cannot manage to achieve this; 
it all works if I do

```
CXXFLAGS="-std=c++11" ./sage -f lcalc
```

but somehow does not work if I put into spkg-install

```
$MAKE CXXFLAGS="-std=c++11"
```


some evil Makefile magic that escapes me here. :-(


---

Comment by fbissey created at 2017-07-01 23:52:33

Most other `spkg-install` do something like

```
CXXFLAGS="-std=c++11 ${CXXFLAGS}"
export CXXFLAGS
$MAKE
```



---

Comment by dimpase created at 2017-07-01 23:58:26

Replying to [comment:22 fbissey]:
> Most other `spkg-install` do something like
> {{{
> CXXFLAGS="-std=c++11 ${CXXFLAGS}"
> export CXXFLAGS
> $MAKE
> }}}

no difference, it still does not work. It might be due to the Makefile modifying
CXXFLAGS: it does

```
CXXFLAGS := -O3 $(OPENMP_FLAG) $(PREPROCESSOR_DEFINE) $(MACHINE_SPECIFIC_FLAGS) $(EXTRA) $(CXXFLAGS)
```



---

Comment by dimpase created at 2017-07-02 00:17:13

I don't know:

* bash bug? (version 4.4.12(1))
* make bug? (4.2.1)

will try on something older...


---

Comment by fbissey created at 2017-07-02 01:36:50

logs please.


---

Comment by rws created at 2017-07-02 07:34:17

Changing component from PLEASE CHANGE to number theory.


---

Comment by rws created at 2017-07-02 07:34:17

I'm willing to do some bulk C++11 work, as I did with Pynac. Is there a public lcalc repo?


---

Comment by rws created at 2017-07-02 07:34:17

Changing type from PLEASE CHANGE to enhancement.


---

Comment by dimpase created at 2017-07-02 07:38:39

this is the branch, as here are the results of running 

```
./sage -f lcalc
```

http://users.ox.ac.uk/~coml0531/sage/lcalc-1.23.p16.log

vs the result of running

```
CXXFLAGS="-std=c++11" ./sage -f lcalc
```

http://users.ox.ac.uk/~coml0531/sage/externalCXXFLAGS_lcalc-1.23.p16.log

As you see in the 1st log CXXFLAGS are ignored.
Tested on Fedora25 as well as on Gentoo.
What am I missing?!!

PS. F25 bash is 4.3.43(1)-release, and make is 4.1.


---

Comment by dimpase created at 2017-07-02 07:41:17

Replying to [comment:26 rws]:
> I'm willing to do some bulk C++11 work, as I did with Pynac. Is there a public lcalc repo?

It's done here, the problem which remains is to fight the makefile madness

There will be more similar C++ "fun" for gfan (I have a patch, but it produces lots of test errors), giac... I'll cc you on these tickets as they appear.


---

Comment by fbissey created at 2017-07-02 07:44:40

Replying to [comment:26 rws]:
> I'm willing to do some bulk C++11 work, as I did with Pynac. Is there a public lcalc repo?

No.


---

Comment by dimpase created at 2017-07-02 07:52:32

let us make one on github.


---

Comment by rws created at 2017-07-02 07:55:13

Replying to [comment:28 dimpase]:
> There will be more similar C++ "fun" for gfan (I have a patch, but it produces lots of test errors), giac... I'll cc you on these tickets as they appear.

Note BTW there is gfan-0.6 now.


---

Comment by dimpase created at 2017-07-02 07:59:47

in fact, a lcalc repo is here : https://code.google.com/archive/p/l-calc/

last commit is from 2014, but it's newer than what we use, 
see http://oto.math.uwaterloo.ca/~mrubinst/L_function_public/CODE/


---

Comment by rws created at 2017-07-02 08:08:08

I just did one for gfan: https://github.com/rwst/gfan06


---

Comment by fbissey created at 2017-07-02 08:31:30

This is quite peculiar. Looking more closely, even the section for OS X in spkg-install, doesn't work properly

```
if [ "$UNAME" = "Darwin" ]; then
    export LDFLAGS="$LDFLAGS -Wl,-headerpad_max_install_names"
fi
```

we still get the right thing because there is darwin section in the makefile but the `export` above doesn't work.


---

Comment by dimpase created at 2017-07-03 09:43:41

Replying to [comment:32 dimpase]:
> in fact, a lcalc repo is here : https://code.google.com/archive/p/l-calc/
> 
> last commit is from 2014, but it's newer than what we use, 
> see http://oto.math.uwaterloo.ca/~mrubinst/L_function_public/CODE/

I've imported the code.google (hg) repo into git, here:
https://github.com/dimpase/lcalc

I'll try merging Sage's changes there.


---

Comment by rws created at 2017-07-03 13:09:46

That repo code is different enough and `clang-check` gives lots of errors. If we do this together, how to coordinate?


---

Comment by dimpase created at 2017-07-03 13:17:51

Replying to [comment:36 rws]:
> That repo code is different enough and `clang-check` gives lots of errors. If we do this together, how to coordinate?

If you like to take the lead on this, please go ahead---I have my hands full with other things.


---

Comment by rws created at 2017-07-03 13:20:07

Replying to [comment:37 dimpase]:
> If you like to take the lead on this, please go ahead---I have my hands full with other things.

NP. Actual code changes will go in a PR.


---

Comment by rws created at 2017-07-03 15:04:09

Replying to [comment:38 rws]:
> NP. Actual code changes will go in a PR.

https://github.com/dimpase/lcalc/pull/1

Please review. I haven't worked on upgrading the Sage package, nor have I tested functionality.


---

Comment by jdemeyer created at 2017-09-22 12:05:59

Two questions about this ticket:

1. Is it about lcalc itself, Sage modules using lcalc, or both?

2. Instead of porting lcalc to C++11, is it an option to force `-std=c++98` instead?


---

Comment by jdemeyer created at 2017-09-22 12:14:31

Hmm, maybe it's not a matter of porting to C++*11*, but just porting to proper C++ instead. At least `src/sage/libs/lcalc/lcalc_Lfunction.pyx` doesn't compile with `-std=c++98` either: it requires either `-std=gnu++98` or `-std=gnu++11`.


---

Comment by jdemeyer created at 2017-09-22 13:34:41

Replying to [comment:13 fbissey]:
> I think Dima started this with the view of compiling sage with `-std=c++11`. If that's what he is doing, getting https://bugs.python.org/issue1222585 in would be more pressing in my opinion.

I created #7028 for that.


---

Comment by dimpase created at 2017-09-24 20:02:42

There is one more thing to add here; there is a macro `double(x)` defined in `include/Lcommon.h`, which does not seem to be used anywhere, and which causes havoc sometimes, e.g. if I try building with gcc on FreeBSD (due to cephes present)

Anyway, hey, redefining a language keyword, yuck...


---

Comment by rws created at 2017-10-07 16:06:10

Because of what I logged in my comments in #23898 it looks like current lcalc does not compile on OpenSuSE systems with system gcc-5.3.1. A patch is at #23898#comment:39.


---

Comment by rws created at 2018-02-19 16:06:22

Replying to [comment:43 dimpase]:
> There is one more thing to add here; there is a macro `double(x)` defined in `include/Lcommon.h`, which does not seem to be used anywhere, and which causes havoc sometimes, e.g. if I try building with gcc on FreeBSD (due to cephes present)

This is outcommented in the github lcalc version which also, with the above PR, passes clang-check. It looks like an improvement. OTOH this ticket seems no longer pressing, as the Sage version compiles with clang too.

The attempt to replace Sage's lcalc with Pari (#24532) was dropped, so maybe it's an idea to at least upgrade it to the github version?


---

Comment by dimpase created at 2018-02-21 14:43:05

I am all for it, but I'm a bit lost here. What stage are we at?


---

Comment by rws created at 2018-02-21 15:03:40

Replying to [comment:46 dimpase]:
> What stage are we at? 

This is the first ticket that mentions the 2014 version at all I think.


---

Comment by rws created at 2018-02-21 15:18:03

There is mention in #11321#comment:8 but this is only because patches were sent upstream.


---

Comment by rws created at 2018-02-21 15:32:15

The github version defines itself in `CHANGE.LOG` and `include/cmdline.h` as v. 1.3, so we might stick to that and add something. I mean with that the name of the tarball later distributed, not our Sage patchlevel. I personally prefer ISO dates like 20180223 whenever possible.


---

Comment by jdemeyer created at 2018-02-21 15:38:33

Replying to [comment:49 rws]:
> I personally prefer ISO dates like 20180223 whenever possible.

What does the date refer to? If you are packaging something which does not have a naturally defined date, I wouldn't use a date. For packages created from a git repo, better use a git commit hash.


---

Comment by rws created at 2018-02-21 15:40:30

Replying to [comment:50 jdemeyer]:
> For packages created from a git repo, better use a git commit hash.

That's fine too.


---

Comment by rws created at 2018-02-22 10:04:27

The changes to install the package without patches are now added to
https://github.com/dimpase/lcalc/pull/1
which eventually needs a review. ATM Sage does NOT build with it as compilation of the Cython module fails.

One problem worked around was that the use of FP type (double,mpfr,etc..) can be given to make but is not fixed in a header like with conf.h in other packages. I have hardcoded the type used until now (double) but this is an issue.


---

Comment by dimpase created at 2018-02-22 11:12:59

I've just looked at the pull request again - do you see my comments there?


---

Comment by rws created at 2018-02-22 13:58:05

Replying to [comment:53 dimpase]:
> I've just looked at the pull request again - do you see my comments there?

Yes, I have answered there.


---

Comment by rws created at 2018-02-22 14:44:04

I opened #24280 with the changes on the Sage side. Testing yields mostly tolerance exceeded but also some different values that need a look.


---

Comment by dimpase created at 2018-02-22 20:20:08

Replying to [comment:55 rws]:
> I opened #24280 with the changes on the Sage side. Testing yields mostly tolerance exceeded but also some different values that need a look.

seems to be wrong reference, what is the correct ticket?


---

Comment by rws created at 2018-02-23 06:30:43

Please see #24820.


---

Comment by chapoton created at 2018-02-24 12:46:35

Changing keywords from "" to "lcalc".


---

Comment by @timokau created at 2018-07-10 12:12:18

The ntl upgrade (#25532) depends on this. Is there a reason this (or #24820) isn't needs_review?


---

Comment by rws created at 2018-07-10 12:45:10

Replying to [comment:59 gh-timokau]:
> The ntl upgrade (#25532) depends on this. Is there a reason this (or #24820) isn't needs_review?

I think #24820 is the newer attempt. It would be necessary to agree that either the Hardy-Z function is not defined for complex argument or lcalc is unable to compute the case. As I said in #24820, I have no idea about the usefulness of complex argument results. Do you?


---

Comment by jdemeyer created at 2018-07-10 12:50:19

Replying to [comment:59 gh-timokau]:
> The ntl upgrade (#25532) depends on this.

As I said on that ticket, the dependency itself could be considered a bug. It is probably easier to remove the dependency than fixing lcalc.


---

Comment by @timokau created at 2018-07-10 14:42:25

Replying to [comment:60 rws]:
> Replying to [comment:59 gh-timokau]:
> > The ntl upgrade (#25532) depends on this. Is there a reason this (or #24820) isn't needs_review?
> 
> I think #24820 is the newer attempt. It would be necessary to agree that either the Hardy-Z function is not defined for complex argument or lcalc is unable to compute the case. As I said in #24820, I have no idea about the usefulness of complex argument results. Do you?

Unfortunately I don't :/

Replying to [comment:61 jdemeyer]:
> Replying to [comment:59 gh-timokau]:
> > The ntl upgrade (#25532) depends on this.
> 
> As I said on that ticket, the dependency itself could be considered a bug. It is probably easier to remove the dependency than fixing lcalc.

At least that would fix #25532. Isn't the dependency there for a reason?


---

Comment by fbissey created at 2018-10-31 00:56:22

I think it is time we move forward with this again. I think this ticket should also include the matching patch from arch in sagelib https://git.archlinux.org/svntogit/community.git/plain/trunk/sagemath-lcalc-c++11.patch?h=packages/sagemath&id=0e31ae526ab7c6b5c0bfacb3f8b1c4fd490035aa so that we really are just using C++11 and allow us to make progress on #25532.

Any objections to moving forward with what we have now?


---

Comment by fbissey created at 2018-10-31 20:32:49

Yes this need the extra patch from arch I quoted. Otherwise sage's compilation fails because lcalc is no using construct that don't exist in gnu++98.


---

Comment by fbissey created at 2018-10-31 22:37:48

Last call for patches. Please someone review. It would be good to have this in the next beta and be able to move on to #25532 and get it all done for 8.5.
----
New commits:


---

Comment by fbissey created at 2018-10-31 22:37:48

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-11-13 07:13:57

Anyone interested in reviewing this?


---

Comment by jdemeyer created at 2018-11-13 09:41:42

1. Can you add some rationale for the changes to `Makefile`?

2. I wouldn't make style changes such as

```diff
-		loop(i,this->N,N)
-			coeffs[i]=zero;
+		loop(i,this->N,N) coeffs[i]=zero;
```



---

Comment by jdemeyer created at 2018-11-13 09:42:11

Replying to [comment:65 fbissey]:
> It would be good to have this in the next beta and be able to move on to #25532

As I mentioned multiple times, I don't really think that #25532 must depend on this.


---

Comment by jdemeyer created at 2018-11-13 09:42:50

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2018-11-13 09:50:11

Replying to [comment:68 jdemeyer]:
> Replying to [comment:65 fbissey]:
> > It would be good to have this in the next beta and be able to move on to #25532
> 
> As I mentioned multiple times, I don't really think that #25532 must depend on this.

Well, I tried to see if I could up ntl separately in sage-on-gentoo and sage wouldn't compile. It could be that I can tweak ntl's configuration to be compatible (at possible cost in ntl internal) but I'd rather get rid of the last bit of sage that is c++11 resistant (I think) and go with the natural flow again.


---

Comment by jdemeyer created at 2018-11-13 09:57:07

Minor nitpick: wouldn't it be cleaner to replace `decltype(m) i=(m)` by `auto i = (m)`?


---

Comment by fbissey created at 2018-11-13 10:00:31

Replying to [comment:71 jdemeyer]:
> Minor nitpick: wouldn't it be cleaner to replace `decltype(m) i=(m)` by `auto i = (m)`?

It has indeed a better feel. A bit too late in the day for me to do any changes (safely), I'll go through your reviews in the morning.


---

Comment by jdemeyer created at 2018-11-13 10:02:25

Replying to [comment:72 fbissey]:
> A bit too late in the day for me

You chose to live on the wrong side of the world :-)


---

Comment by fbissey created at 2018-11-13 10:06:17

Replying to [comment:73 jdemeyer]:
> Replying to [comment:72 fbissey]:
> > A bit too late in the day for me
> 
> You chose to live on the wrong side of the world :-)

Well it feels like it will be a nice summer. And not too hot, like our australian neighbors :-) but I really need to get some sleep now.


---

Comment by jdemeyer created at 2018-11-13 10:19:31

In your `Makefile` patch, the rule `$(CC) $(CFLAGS) $(INCLUDEFILES) -c cmdline.c` is just the standard build rule for `.c` files (modulo the typo `$(CFLAGS)`->`$(CCFLAGS)`). So it might be better to just restore the comment.


---

Comment by fbissey created at 2018-11-13 22:26:59

OK some comments on the review from Jeroen which made me dig a bit deeper on the Makefile. I must say I adopted a slightly different approach in sage-on-gentoo so I don't have the same patch, but some of lesson learnt will definitely apply.

* the original makefile defines CC as as g++ so that has to go.
* Non standard flags like CCFLAGS are used, so Dima tried to use appropriate flags for both C and C++ compilers. And it also differentiate C and C++ flags which wasn't done before because even regular C code was passed to the C++ compiler.
* The downside of using CFLAGS and CXXFLAGS inside the makefile is that regular options passed from the sage build system may need care if we want to inject them. That's a sage-on-gentoo difference I use `MYCXXFLAGS` so I can include whatever other flags we pass without worry.
* Jeroen points out the standard rule for `.c` file should be used for `cmdline.c` except that the current patch erroneously define the rule as using CXXFLAGS instead of CFLAGS. Oopsie.

Point of difference with sage-on-gentoo: because pari headers are included in two files with `#include "pari.h"` the makefile has to define the location of pari headers and so do any code that include these headers. Decided that it was not worth it and patched to have `#include "pari/pari.h"` which is more sane and means that we don't have to worry about adding non standard includes. That means that I cut an extra bit of the makefile too. If people think that's a good idea I'll include that change in sage too.


---

Comment by jdemeyer created at 2018-11-14 06:35:18

Replying to [comment:76 fbissey]:
> because pari headers are included in two files with `#include "pari.h"` the makefile has to define the location of pari headers and so do any code that include these headers. Decided that it was not worth it and patched to have `#include "pari/pari.h"` which is more sane and means that we don't have to worry about adding non standard includes. That means that I cut an extra bit of the makefile too. If people think that's a good idea I'll include that change in sage too.

That makes sense to me.


---

Comment by git created at 2018-11-14 21:58:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-11-14 22:00:28

All right back to review.


---

Comment by fbissey created at 2018-11-14 22:00:28

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-11-14 22:31:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-11-14 22:33:38

So many patches! It is hard to figure if the thing you patch was introduced by another patch :P


---

Comment by dimpase created at 2018-11-17 13:18:08

This appears to work with clang 6.0.1, a good sign.


---

Comment by fbissey created at 2018-11-21 00:55:08

Replying to [comment:82 dimpase]:
> This appears to work with clang 6.0.1, a good sign.

I have checked clang-6 and gcc-8.2. Now if someone would put a kind review.

Although Dima, I kept the patch name "using_namespace_std.patch` but there is hardly any of that in there. Just removing GNU-ism. Did you have more stuff to do in mind?


---

Comment by dimpase created at 2018-11-21 11:01:45

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-11-21 11:01:45

OK


---

Comment by @timokau created at 2018-11-21 11:09:21

Thank you `@`fbissey for pushing this forward, happy to have one less patch to apply :)


---

Comment by vbraun created at 2018-11-22 13:13:07

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-11-22 13:13:07

On some machines this fails with:

```
make libLfunction.so
make[5]: Entering directory '/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/lcalc-1.23.p17/src/src'
g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc
In file included from ../include/Lglobals.h:48:0,
                 from Lglobals.cc:23:
../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':
../include/Lcommon.h:71:8: error: 'i' does not name a type
   loop(i,this->N,N)
        ^
../include/Lcommon.h:51:30: note: in definition of macro 'loop'
 #define loop(i,m,n) for(auto i=(m); i!=(n); i++)
                              ^
```

I guess the -std=c11 is missing in the gcc invocation...


---

Comment by fbissey created at 2018-11-22 17:58:46

Of course I tested with compilers that default to C++11 or C++14 so that would make sense. Will fix ASAP.


---

Comment by fbissey created at 2018-11-22 20:52:55

`lcalc` has both `spkg-build` and `spkg-install`, the `-std=c++11` was only added to `spkg-install` which explains the result. I am going to further inspect those for improvement.


---

Comment by git created at 2018-11-22 21:04:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-11-22 21:05:25

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-11-22 21:05:25

Back to need review.


---

Comment by dimpase created at 2018-11-22 21:22:13

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-11-22 21:22:13

over to the bots!


---

Comment by fbissey created at 2018-11-23 01:06:57

Replying to [comment:91 dimpase]:
> over to the bots!

Thank you Dima. Once we have closure here, I would appreciate if you could push the review button on #25532 for the ntl upgrade.


---

Comment by vbraun created at 2018-11-23 21:42:05

Resolution: fixed
