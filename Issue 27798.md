# Issue 27798: py3 fix in misc/functional.py

Issue created by migration from https://trac.sagemath.org/ticket/28035

Original creator: jhpalmieri

Original creation time: 2019-06-21 04:45:45

CC:  chapoton

The `round` function in `sage/misc/functional.py` fails several tests with Python 3. The output is supposed to be double-precision, so we just convert the input to a `float` first.



---

Comment by jhpalmieri created at 2019-06-21 04:48:45

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-06-21 04:48:45

Is this the right approach? We could put a `try ... except` block instead: something like

```
try:
    x = builtins.round(x, ndigits)
except TypeError:
    x = builtins.round(float(x), ndigits)
```

----
New commits:


---

Comment by @mwageringel created at 2019-06-27 20:05:49

#25827 seems to be related.


---

Comment by jhpalmieri created at 2019-06-27 20:24:30

Replying to [comment:3 gh-mwageringel]:
> #25827 seems to be related.

Yes, although #25827 is broader in scope, with some questions that need answering. This change is much more focused.


---

Comment by @mwageringel created at 2019-06-28 06:19:19

Ok, fair enough. It looks like this should work for now. Converting to float seems to be what is happening in Python 2 as well, as a naïve test shows:

```
sage: from six.moves import builtins
sage: builtins.round(i, 2)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-8b1e2e3412b1> in <module>()
----> 1 builtins.round(i, Integer(2))

/Applications/SageMath/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__float__ (build/cythonized/sage/symbolic/expression.cpp:11079)()
   1426                     raise
   1427             except TypeError:
-> 1428                 raise TypeError("unable to simplify to float approximation")
   1429         return ret
   1430

TypeError: unable to simplify to float approximation
```

In the long run, this should probably be changed, so that classes can implement a custom `__round__()` without converting to float, such as matrices. However, currently nothing in Sage implements `__round__()` – so this seems to be something #25827 will deal with. (Only rings/rational defines it, but it is essentially broken with Python 3.)

I do not quite feel competent enough to set this to positive though, so hopefully someone more knowledgeable can help.


---

Comment by chapoton created at 2019-07-02 12:55:12

ok, good enough for me.


---

Comment by chapoton created at 2019-07-02 12:55:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-05 12:02:48

Resolution: fixed
