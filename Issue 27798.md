# Issue 27798: py3 fix in misc/functional.py

archive/issues_027798.json:
```json
{
    "body": "CC:  @fchapoton\n\nThe `round` function in `sage/misc/functional.py` fails several tests with Python 3. The output is supposed to be double-precision, so we just convert the input to a `float` first.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28035\n\n",
    "created_at": "2019-06-21T04:45:45Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "py3 fix in misc/functional.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27798",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @fchapoton

The `round` function in `sage/misc/functional.py` fails several tests with Python 3. The output is supposed to be double-precision, so we just convert the input to a `float` first.


Issue created by migration from https://trac.sagemath.org/ticket/28035





---

archive/issue_comments_392212.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-21T04:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392212",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_392213.json:
```json
{
    "body": "Is this the right approach? We could put a `try ... except` block instead: something like\n\n```\ntry:\n    x = builtins.round(x, ndigits)\nexcept TypeError:\n    x = builtins.round(float(x), ndigits)\n```\n\n----\nNew commits:",
    "created_at": "2019-06-21T04:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392213",
    "user": "https://github.com/jhpalmieri"
}
```

Is this the right approach? We could put a `try ... except` block instead: something like

```
try:
    x = builtins.round(x, ndigits)
except TypeError:
    x = builtins.round(float(x), ndigits)
```

----
New commits:



---

archive/issue_comments_392214.json:
```json
{
    "body": "#25827 seems to be related.",
    "created_at": "2019-06-27T20:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392214",
    "user": "https://github.com/mwageringel"
}
```

#25827 seems to be related.



---

archive/issue_comments_392215.json:
```json
{
    "body": "Replying to [comment:3 gh-mwageringel]:\n> #25827 seems to be related.\n\nYes, although #25827 is broader in scope, with some questions that need answering. This change is much more focused.",
    "created_at": "2019-06-27T20:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392215",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:3 gh-mwageringel]:
> #25827 seems to be related.

Yes, although #25827 is broader in scope, with some questions that need answering. This change is much more focused.



---

archive/issue_comments_392216.json:
```json
{
    "body": "Ok, fair enough. It looks like this should work for now. Converting to float seems to be what is happening in Python 2 as well, as a na\u00efve test shows:\n\n```\nsage: from six.moves import builtins\nsage: builtins.round(i, 2)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-8b1e2e3412b1> in <module>()\n----> 1 builtins.round(i, Integer(2))\n\n/Applications/SageMath/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__float__ (build/cythonized/sage/symbolic/expression.cpp:11079)()\n   1426                     raise\n   1427             except TypeError:\n-> 1428                 raise TypeError(\"unable to simplify to float approximation\")\n   1429         return ret\n   1430\n\nTypeError: unable to simplify to float approximation\n```\n\nIn the long run, this should probably be changed, so that classes can implement a custom `__round__()` without converting to float, such as matrices. However, currently nothing in Sage implements `__round__()` \u2013 so this seems to be something #25827 will deal with. (Only rings/rational defines it, but it is essentially broken with Python 3.)\n\nI do not quite feel competent enough to set this to positive though, so hopefully someone more knowledgeable can help.",
    "created_at": "2019-06-28T06:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392216",
    "user": "https://github.com/mwageringel"
}
```

Ok, fair enough. It looks like this should work for now. Converting to float seems to be what is happening in Python 2 as well, as a naïve test shows:

```
sage: from six.moves import builtins
sage: builtins.round(i, 2)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-8b1e2e3412b1> in <module>()
----> 1 builtins.round(i, Integer(2))

/Applications/SageMath/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__float__ (build/cythonized/sage/symbolic/expression.cpp:11079)()
   1426                     raise
   1427             except TypeError:
-> 1428                 raise TypeError("unable to simplify to float approximation")
   1429         return ret
   1430

TypeError: unable to simplify to float approximation
```

In the long run, this should probably be changed, so that classes can implement a custom `__round__()` without converting to float, such as matrices. However, currently nothing in Sage implements `__round__()` – so this seems to be something #25827 will deal with. (Only rings/rational defines it, but it is essentially broken with Python 3.)

I do not quite feel competent enough to set this to positive though, so hopefully someone more knowledgeable can help.



---

archive/issue_comments_392217.json:
```json
{
    "body": "ok, good enough for me.",
    "created_at": "2019-07-02T12:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392217",
    "user": "https://github.com/fchapoton"
}
```

ok, good enough for me.



---

archive/issue_comments_392218.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-02T12:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392218",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_392219.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-05T12:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27798#issuecomment-392219",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_025794.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-07-05T12:02:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27798",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27798#event-25794"
}
```
