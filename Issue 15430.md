# Issue 15430: Time anomaly in finding orders of points on an elliptic curve over a finite field

Issue created by migration from https://trac.sagemath.org/ticket/15667

Original creator: cremona

Original creation time: 2014-01-13 14:12:24

CC:  victor defeo

Keywords: point order finite field

See https://groups.google.com/forum/#!searchin/sage-support/anomaly|sort:relevance|spell:true/sage-support/PzrQ6kUzSJg/m99x--9TS-oJ

The upshot is that when computing the order of a point on an elliptic curve whose cardinality has not yet been computed, there are cases where that cardinality could be computed very quickly first, which would be much faster than using BSGS methods for the order.  Specifically, this is the case for curves with j-invariants 0 and 1728 over any finite field.

From the mailing list contribution by Victor Miller:

Consider the following:

```
def NextProgression(n,a,q):
    p = next_prime(n)
    while (p%q) != a:
        p = next_prime(p+1)
    return p
```


```
def Test(n,compute=False):
    p = NextProgression(n,2,3)
    print "found prime=",p
    F.<u> = GF(p^2)
    print "Found field"
    E = EllipticCurve(F,[0,1])
    if compute:
        NN = E.order()
        print "Found Elliptic Curve of order ",NN
    P = E.random_point()
    Q = E.random_point()
    print "Found points"
    nP = P.order()
    print "Found order of P"
    nQ = Q.order()
    print "Found order of Q"
    N = lcm(nP,nQ)
    return E,P,Q,N
```


```
time E,P,Q,n = Test(2^25)
        	
found prime= 33554501
Found field
Found points
Found order of P
Found order of Q
Time: CPU 10.52 s, Wall: 10.77 s
```


compared with

```
time E,P,Q,n = Test(2^25,compute=True)
 
found prime= 33554501
Found field
Found Elliptic Curve of order  1125904604468004
Found points
Found order of P
Found order of Q
Time: CPU 0.17 s, Wall: 0.18 s
```



---

Comment by cremona created at 2014-01-13 14:47:42

Changing status from new to needs_review.


---

Comment by cremona created at 2014-01-13 14:47:42

New commits:


---

Comment by jpflori created at 2014-02-21 20:16:14

Nice addition.
(I just resolved a trivial conflict whence the new branch.)
----
New commits:


---

Comment by jpflori created at 2014-02-21 20:16:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-02-22 07:32:36

Doctest failure:

```
**********************************************************************
File "src/sage/groups/generic.py", line 77, in sage.groups.generic
Failed example:
    linear_relation(P,Q,'+')
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.groups.generic[26]>", line 1, in <module>
        linear_relation(P,Q,'+')
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/groups/generic.py", line 996, in linear_relation
        n = P.order()
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_point.py", line 3528, in order
        N = generic.order_from_multiple(self, M, plist, operation='+')
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/groups/generic.py", line 1103, in order_from_multiple
        assert multiple(P,M,operation=operation) == identity
    AssertionError
```



---

Comment by cremona created at 2014-02-22 13:55:27

I will look into this since not only is the current patch mine, so is the code and doctest which fail.  Sorry!


---

Comment by cremona created at 2014-02-22 14:15:37

Preliminary diagnosis: the elliptic curve E in the report is defined over `GF(3^6)` and has j-invariant 0=1728.  The special case code to give the cardinality in this case starts at line 574 of `sage/schemes/elliptic_curves/ell_finite_field.py`, which I wrote in 2008.  The code incorrectly gives group order 703 while it is in fact

```
 sage: F.<a>=GF(3^6,'a')
sage: E = EllipticCurve([a^5 + 2*a^3 + 2*a^2 + 2*a, a^4 + a^3 + 2*a + 1])
sage: E.cardinality_exhaustive()
784
```

compared with

```
sage: F.<a>=GF(3^6,'a')
sage: E = EllipticCurve([a^5 + 2*a^3 + 2*a^2 + 2*a, a^4 + a^3 + 2*a + 1])
sage: E.cardinality()
703
```



---

Comment by jpflori created at 2014-02-24 10:03:33

My bad as well, I just tested the schemes folder.


---

Comment by cremona created at 2014-02-24 14:52:20

Changing status from positive_review to needs_review.


---

Comment by cremona created at 2014-02-24 14:52:20

New commits:


---

Comment by cremona created at 2014-02-24 14:54:54

I fixed this: there was indeed a bug in the case j=0=1728 over `GF(3^d)` with d even.  I went back to my student's MSc thesis (unpublished). A doctest has been added for this, and I did test the entire library ;)

Please re-review.  If you like I can put the MSc dissertation somewhere, though the write-up is not quite of publishable quality.


---

Comment by jpflori created at 2014-02-24 15:01:13

I'll review it, I was rewriting down the changes of variables (and ending up with different changes though the result should hopefully be the same).
I'll be interested in seeing the thesis to double check computations.

And maybe it would be worth adding a little more doctests for such special elliptic curves.
(Or maybe test random curves with such j-invariants over small finite fields and compare directly with cardinality_exhaustive.)


---

Comment by jpflori created at 2014-02-24 16:48:04

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2014-02-24 16:48:04

Hum, I forgot that 4 == 1, I indeed get the same formulas.
I've checked a bunch of curves and it looks fine.

I also checked all tests pass this time...


---

Comment by cremona created at 2014-02-24 16:54:25

Thanks.  See

http://homepages.warwick.ac.uk/staff/J.E.Cremona/theses/KT-MSc.pdf

I though I had done lots of random and systematic tests when I first wrote this, but clearly I did not do it properly.  I think it was just a case of switching two cases over, probably caused by mynotation and Kimi's being different.


---

Comment by vbraun created at 2014-03-05 14:18:40

Resolution: fixed
