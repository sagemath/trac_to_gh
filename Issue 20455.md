# Issue 20455: Add sage-apply-patches helper script for use in spkg-install scripts

archive/issues_020455.json:
```json
{
    "body": "This adds a new script to `build/bin` called `sage-apply-patches` which implements the same code that is copy/pasted through many of the `spkg-install` scripts (albeit often inconsistently).  It also updates those `spkg-install`s to use it where appropriate.\n\nI'm not attached to any of the details of how the script works--the implementation was designed mostly to make it easiest to automatically replace the existing repeated code snippet with minimal effort.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20692\n\n",
    "created_at": "2016-05-27T11:33:29Z",
    "labels": [
        "component: build",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Add sage-apply-patches helper script for use in spkg-install scripts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20455",
    "user": "https://github.com/embray"
}
```
This adds a new script to `build/bin` called `sage-apply-patches` which implements the same code that is copy/pasted through many of the `spkg-install` scripts (albeit often inconsistently).  It also updates those `spkg-install`s to use it where appropriate.

I'm not attached to any of the details of how the script works--the implementation was designed mostly to make it easiest to automatically replace the existing repeated code snippet with minimal effort.

Issue created by migration from https://trac.sagemath.org/ticket/20692





---

archive/issue_comments_281669.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-27T11:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281669",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_281670.json:
```json
{
    "body": "Seems I have to undust my `bash` scripting skills...\n\nWhy is it an error if there are no patches to apply? I would remove\n\n```\nif [[ -r \"${patches[0]}\" ]]; then\nelse\n    >&2 echo \"No patch files found in $patchdir\"\n    exit 1\nfi\n```\n\nand just apply all patches, which may be the empty set.",
    "created_at": "2016-05-27T15:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281670",
    "user": "https://github.com/jdemeyer"
}
```

Seems I have to undust my `bash` scripting skills...

Why is it an error if there are no patches to apply? I would remove

```
if [[ -r "${patches[0]}" ]]; then
else
    >&2 echo "No patch files found in $patchdir"
    exit 1
fi
```

and just apply all patches, which may be the empty set.



---

archive/issue_comments_281671.json:
```json
{
    "body": "A minor thing: I would prefer to remove the `-pNUM` option. It's better if we consistently use `-p1` in all cases. That's also how `git` generates its patches.",
    "created_at": "2016-05-27T15:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281671",
    "user": "https://github.com/jdemeyer"
}
```

A minor thing: I would prefer to remove the `-pNUM` option. It's better if we consistently use `-p1` in all cases. That's also how `git` generates its patches.



---

archive/issue_comments_281672.json:
```json
{
    "body": "I don't get this:\n\n```\nand it is assumed that the patches are being applied from\nthe root of the package source\n```\n",
    "created_at": "2016-05-27T15:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281672",
    "user": "https://github.com/jdemeyer"
}
```

I don't get this:

```
and it is assumed that the patches are being applied from
the root of the package source
```




---

archive/issue_comments_281673.json:
```json
{
    "body": "Why not always use the option `--no-backup-if-mismatch` instead of only for PARI?",
    "created_at": "2016-05-27T15:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281673",
    "user": "https://github.com/jdemeyer"
}
```

Why not always use the option `--no-backup-if-mismatch` instead of only for PARI?



---

archive/issue_comments_281674.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-27T15:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281674",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281675.json:
```json
{
    "body": "Following up on [comment:2]: it's very useful to support an empty set of patches. For example, when upgrading a package, it can happen that all patches need to be removed. You don't want that to break the build. That is also the reason why many packages have code to apply patches when they don't have patches. I would not remove such code since it allows easily adding a new patch. Ideally, every `spkg-install` script would call `spkg-apply-patches`.",
    "created_at": "2016-05-27T15:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281675",
    "user": "https://github.com/jdemeyer"
}
```

Following up on [comment:2]: it's very useful to support an empty set of patches. For example, when upgrading a package, it can happen that all patches need to be removed. You don't want that to break the build. That is also the reason why many packages have code to apply patches when they don't have patches. I would not remove such code since it allows easily adding a new patch. Ideally, every `spkg-install` script would call `spkg-apply-patches`.



---

archive/issue_comments_281676.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Following up on [comment:2]: it's very useful to support an empty set of patches. For example, when upgrading a package, it can happen that all patches need to be removed. You don't want that to break the build. That is also the reason why many packages have code to apply patches when they don't have patches. I would not remove such code since it allows easily adding a new patch. Ideally, every `spkg-install` script would call `spkg-apply-patches`.\n\nI guess I was thinking it was wasteful to call a process (especially on Windows where process creation is much slower) when it's not needed.  Granted, when this was inline in every script it didn't require a process creation (more on that in a followup).  I think if someone wants to add a patch to a package they should explicitly add `spkg-appy-patches` as well.  If they forget to do that, well, then they clearly didn't test that their patch applies at build time :)\n\nAs for it being an error when no patches are found, I have no strong feelings.  I liked that it was explicit, but it could just as will either print a message, or go completely silent.\n\n> A minor thing: I would prefer to remove the -pNUM option. It's better if we consistently use -p1 in all cases. That's also how git generates its patches.\n\nThat's fine by me.  I think there was one case, maybe two where it was needed, but it would be just as easy to update those patch files and keep things consistent throughout.\n\n> Why not always use the option `--no-backup-if-mismatch` instead of only for PARI?\n\nI figured maybe there was a reason to prefer to keep backups in general.  Would be fine with me to apply in general though.  Previously there was one other case where additional arguments had to be passed to `patch`, but then I realized that package had no patches anymore.\n\n> I don't get this:\n   and it is assumed that the patches are being applied from\n   the root of the package source\n\nMeaning the patches are applied after `cd`-ing into the upstream source, hence the default path to search for patches being `../patches`.  No reason it has to be that way but it was the most minimal change from the existing code.",
    "created_at": "2016-05-27T16:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281676",
    "user": "https://github.com/embray"
}
```

Replying to [comment:7 jdemeyer]:
> Following up on [comment:2]: it's very useful to support an empty set of patches. For example, when upgrading a package, it can happen that all patches need to be removed. You don't want that to break the build. That is also the reason why many packages have code to apply patches when they don't have patches. I would not remove such code since it allows easily adding a new patch. Ideally, every `spkg-install` script would call `spkg-apply-patches`.

I guess I was thinking it was wasteful to call a process (especially on Windows where process creation is much slower) when it's not needed.  Granted, when this was inline in every script it didn't require a process creation (more on that in a followup).  I think if someone wants to add a patch to a package they should explicitly add `spkg-appy-patches` as well.  If they forget to do that, well, then they clearly didn't test that their patch applies at build time :)

As for it being an error when no patches are found, I have no strong feelings.  I liked that it was explicit, but it could just as will either print a message, or go completely silent.

> A minor thing: I would prefer to remove the -pNUM option. It's better if we consistently use -p1 in all cases. That's also how git generates its patches.

That's fine by me.  I think there was one case, maybe two where it was needed, but it would be just as easy to update those patch files and keep things consistent throughout.

> Why not always use the option `--no-backup-if-mismatch` instead of only for PARI?

I figured maybe there was a reason to prefer to keep backups in general.  Would be fine with me to apply in general though.  Previously there was one other case where additional arguments had to be passed to `patch`, but then I realized that package had no patches anymore.

> I don't get this:
   and it is assumed that the patches are being applied from
   the root of the package source

Meaning the patches are applied after `cd`-ing into the upstream source, hence the default path to search for patches being `../patches`.  No reason it has to be that way but it was the most minimal change from the existing code.



---

archive/issue_comments_281677.json:
```json
{
    "body": "An alternative I considered to adding a new script was to create a little library of functions that is sourced in every spkg-install.  It would include `sage-apply-patches` reimplemented as a function, along with a few other bits that are repeated a lot.  This would save on process creations too.\n\nI'd still be happy to revisit that idea too if it sounds good, but right now I just wanted to focus on the patch thing since that's what was irking me specifically :)",
    "created_at": "2016-05-27T16:06:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281677",
    "user": "https://github.com/embray"
}
```

An alternative I considered to adding a new script was to create a little library of functions that is sourced in every spkg-install.  It would include `sage-apply-patches` reimplemented as a function, along with a few other bits that are repeated a lot.  This would save on process creations too.

I'd still be happy to revisit that idea too if it sounds good, but right now I just wanted to focus on the patch thing since that's what was irking me specifically :)



---

archive/issue_comments_281678.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> I guess I was thinking it was wasteful to call a process (especially on Windows where process creation is much slower) when it's not needed.\n\nHow much slower is it really? Surely it's negligible compared to the time to build Sage.\n\n> I think if someone wants to add a patch to a package they should explicitly add `spkg-appy-patches` as well.\n\nThat's really annoying. Please keep the call to `spkg-apply-patches` even when there are no patches.",
    "created_at": "2016-05-28T20:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281678",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 embray]:
> I guess I was thinking it was wasteful to call a process (especially on Windows where process creation is much slower) when it's not needed.

How much slower is it really? Surely it's negligible compared to the time to build Sage.

> I think if someone wants to add a patch to a package they should explicitly add `spkg-appy-patches` as well.

That's really annoying. Please keep the call to `spkg-apply-patches` even when there are no patches.



---

archive/issue_comments_281679.json:
```json
{
    "body": "If you feel that strongly about it. I think it's pointless.  Especially considering that it was already inconsistent.  Instead you should be asking me to put `sage-apply-patches` in every `spkg-install` that didn't have it before :)",
    "created_at": "2016-05-30T08:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281679",
    "user": "https://github.com/embray"
}
```

If you feel that strongly about it. I think it's pointless.  Especially considering that it was already inconsistent.  Instead you should be asking me to put `sage-apply-patches` in every `spkg-install` that didn't have it before :)



---

archive/issue_comments_281680.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> Instead you should be asking me to put `sage-apply-patches` in every `spkg-install` that didn't have it before :)\n\nWell, that's essentially what I wrote in [comment:7].\n\nAnd yes, I feel strongly about because I don't want to always add/remove the call to `spkg-apply-patches` depending on whether or not the number of patches to apply equals zero.\n\nDetail: for consistency, I would prefer the script to be called `spkg-apply-patches` instead of `sage-apply-patches`.",
    "created_at": "2016-05-30T09:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281680",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 embray]:
> Instead you should be asking me to put `sage-apply-patches` in every `spkg-install` that didn't have it before :)

Well, that's essentially what I wrote in [comment:7].

And yes, I feel strongly about because I don't want to always add/remove the call to `spkg-apply-patches` depending on whether or not the number of patches to apply equals zero.

Detail: for consistency, I would prefer the script to be called `spkg-apply-patches` instead of `sage-apply-patches`.



---

archive/issue_comments_281681.json:
```json
{
    "body": "What would that be consistent with?  Every other script in `build/bin` starts with `sage-`.  In fact very nearly every, if not every executable installed by sage starts with `sage-` which is good and consistent, and completely free of potential for overlap with anything else.",
    "created_at": "2016-05-30T09:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281681",
    "user": "https://github.com/embray"
}
```

What would that be consistent with?  Every other script in `build/bin` starts with `sage-`.  In fact very nearly every, if not every executable installed by sage starts with `sage-` which is good and consistent, and completely free of potential for overlap with anything else.



---

archive/issue_comments_281682.json:
```json
{
    "body": "Consistent with `spkg-install`, `spkg-check`, `spkg-src`. Basically, anything related to building Sage packages.",
    "created_at": "2016-05-30T09:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281682",
    "user": "https://github.com/jdemeyer"
}
```

Consistent with `spkg-install`, `spkg-check`, `spkg-src`. Basically, anything related to building Sage packages.



---

archive/issue_comments_281683.json:
```json
{
    "body": "Those scripts are only ever in spkg directories though and are specific to each spkg. They are not in bin/ paths added to `$PATH`.  This is a helper script used in installation like the rest in build/bin, all of which (sensibly) start with `sage-`.\n\nI'm probably also going to add a `sage-spkg-python` (or something, I don't care what it's called) that will be exec'd by the `spkg-install` for most Python packages since the vast majority of them are cookie-cutter anyways (especially if you also want to have every one of them calling `whatever-apply-patches` by default).  This would be to provide a solution for #16897 which also calls out this fact.  (I think it's important for every package to have a file called `spkg-install`, but it's fine if its sole function is to call some other generic script).",
    "created_at": "2016-05-30T09:53:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281683",
    "user": "https://github.com/embray"
}
```

Those scripts are only ever in spkg directories though and are specific to each spkg. They are not in bin/ paths added to `$PATH`.  This is a helper script used in installation like the rest in build/bin, all of which (sensibly) start with `sage-`.

I'm probably also going to add a `sage-spkg-python` (or something, I don't care what it's called) that will be exec'd by the `spkg-install` for most Python packages since the vast majority of them are cookie-cutter anyways (especially if you also want to have every one of them calling `whatever-apply-patches` by default).  This would be to provide a solution for #16897 which also calls out this fact.  (I think it's important for every package to have a file called `spkg-install`, but it's fine if its sole function is to call some other generic script).



---

archive/issue_comments_281684.json:
```json
{
    "body": "For the record: I just wanted to comment over the name, I'm not going to reject this patch over such bikeshedding.",
    "created_at": "2016-05-30T09:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281684",
    "user": "https://github.com/jdemeyer"
}
```

For the record: I just wanted to comment over the name, I'm not going to reject this patch over such bikeshedding.



---

archive/issue_comments_281685.json:
```json
{
    "body": "While I am OK with the stuff as it is, I have a bold suggestion for further work: may be it should be put in `sage-spkg` and always be run. We already leave it when there is no patches anymore. What would be the overhead of always running it?",
    "created_at": "2016-05-30T10:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281685",
    "user": "https://github.com/kiwifb"
}
```

While I am OK with the stuff as it is, I have a bold suggestion for further work: may be it should be put in `sage-spkg` and always be run. We already leave it when there is no patches anymore. What would be the overhead of always running it?



---

archive/issue_comments_281686.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> may be it should be put in `sage-spkg` and always be run.\n\nNot easily. We need to guess in which source directory to run the script. Usually, it's `src` but not always.",
    "created_at": "2016-05-30T10:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281686",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 fbissey]:
> may be it should be put in `sage-spkg` and always be run.

Not easily. We need to guess in which source directory to run the script. Usually, it's `src` but not always.



---

archive/issue_comments_281687.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:17 fbissey]:\n> > may be it should be put in `sage-spkg` and always be run.\n> \n> Not easily. We need to guess in which source directory to run the script. Usually, it's `src` but not always.\n\nTricky. I didn't remember we had those outliers.",
    "created_at": "2016-05-30T11:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281687",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 fbissey]:
> > may be it should be put in `sage-spkg` and always be run.
> 
> Not easily. We need to guess in which source directory to run the script. Usually, it's `src` but not always.

Tricky. I didn't remember we had those outliers.



---

archive/issue_comments_281688.json:
```json
{
    "body": "Let me think about that a bit more though.  If it were done in `sage-spkg` it would do away with the need for a separate script entirely, and would cut down that much more on the duplication which is what I want.\n\nOne possibility would be to rewrite the patch files to include the source directory in the paths, but that could be annoying and error-prone.  The other would be to standardize `src`.  I knew there were outliers but I never looked into why.  Is there really no way those could be changed?",
    "created_at": "2016-05-30T11:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281688",
    "user": "https://github.com/embray"
}
```

Let me think about that a bit more though.  If it were done in `sage-spkg` it would do away with the need for a separate script entirely, and would cut down that much more on the duplication which is what I want.

One possibility would be to rewrite the patch files to include the source directory in the paths, but that could be annoying and error-prone.  The other would be to standardize `src`.  I knew there were outliers but I never looked into why.  Is there really no way those could be changed?



---

archive/issue_comments_281689.json:
```json
{
    "body": "`sage-spkg` contains the following:\n\n\n```\n     # Strip file extension from the archive file and hope (as per\n     # automake standards) that this is the same as the directory name\n     # inside; move the directory to \"src\".  (This goes wrong for\n     # upstream package archives that have been renamed to appease some\n     # other Sage script, such as \"latte-int\", whose archive is renamed\n     # to \"latte_int\".)\n     mv \"$(echo \"$PKG_NAME_UPSTREAM\" | sed 's/\\.zip$//g;s/\\.tgz$//g;s/\\.tar\\.    gz$//g;s/\\.tar\\.xz$//g;s/\\.tar\\.lz$//g;s/\\.tar\\.bz2$//g;s/\\.tar$//g')\"* src\n```\n\n\nMaybe this should be redone.  There are a number of ways it might be done differently.  One possibility is that it could be made `sage-uncompress-spkg`'s job to always extract to `src`.  It could handle checking for the top-level directory in the archive and extracting it instead as `src`.  For those handful of packages (are there any? I suspect probably...) that don't have a top-level directory it would create `src` and extract all the archive contents into it.",
    "created_at": "2016-05-30T11:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281689",
    "user": "https://github.com/embray"
}
```

`sage-spkg` contains the following:


```
     # Strip file extension from the archive file and hope (as per
     # automake standards) that this is the same as the directory name
     # inside; move the directory to "src".  (This goes wrong for
     # upstream package archives that have been renamed to appease some
     # other Sage script, such as "latte-int", whose archive is renamed
     # to "latte_int".)
     mv "$(echo "$PKG_NAME_UPSTREAM" | sed 's/\.zip$//g;s/\.tgz$//g;s/\.tar\.    gz$//g;s/\.tar\.xz$//g;s/\.tar\.lz$//g;s/\.tar\.bz2$//g;s/\.tar$//g')"* src
```


Maybe this should be redone.  There are a number of ways it might be done differently.  One possibility is that it could be made `sage-uncompress-spkg`'s job to always extract to `src`.  It could handle checking for the top-level directory in the archive and extracting it instead as `src`.  For those handful of packages (are there any? I suspect probably...) that don't have a top-level directory it would create `src` and extract all the archive contents into it.



---

archive/issue_comments_281690.json:
```json
{
    "body": "This is getting out of the original scope (and I am sorry to have started it) but it would be a good idea to have something more robust for unpacking in a standard folder. May be we should just get this in now and move that idea to another ticket?",
    "created_at": "2016-05-30T11:38:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281690",
    "user": "https://github.com/kiwifb"
}
```

This is getting out of the original scope (and I am sorry to have started it) but it would be a good idea to have something more robust for unpacking in a standard folder. May be we should just get this in now and move that idea to another ticket?



---

archive/issue_comments_281691.json:
```json
{
    "body": "Replying to [comment:22 fbissey]:\n> This is getting out of the original scope (and I am sorry to have started it) but it would be a good idea to have something more robust for unpacking in a standard folder. May be we should just get this in now and move that idea to another ticket?\n\nI was going to suggest the same.  Though I might address the subject of extracting to a standard location before coming back to and reworking this ticket.  I've gone through the list of spkgs that *don't* wind up with their sources in `src` and in each case there's no good reason really, except that the hack above doesn't work for it (or the last time the file was touched predates that hack).\n\nI think a patch to `sage-uncompress-spkg` would be a good idea and I'll put something to that effect in a separate ticket.",
    "created_at": "2016-05-30T11:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281691",
    "user": "https://github.com/embray"
}
```

Replying to [comment:22 fbissey]:
> This is getting out of the original scope (and I am sorry to have started it) but it would be a good idea to have something more robust for unpacking in a standard folder. May be we should just get this in now and move that idea to another ticket?

I was going to suggest the same.  Though I might address the subject of extracting to a standard location before coming back to and reworking this ticket.  I've gone through the list of spkgs that *don't* wind up with their sources in `src` and in each case there's no good reason really, except that the hack above doesn't work for it (or the last time the file was touched predates that hack).

I think a patch to `sage-uncompress-spkg` would be a good idea and I'll put something to that effect in a separate ticket.



---

archive/issue_comments_281692.json:
```json
{
    "body": "I think #20721, or something like it, should be a prerequisite to this ticket (or any like it depending on how much I end up reworking this).",
    "created_at": "2016-05-30T17:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281692",
    "user": "https://github.com/embray"
}
```

I think #20721, or something like it, should be a prerequisite to this ticket (or any like it depending on how much I end up reworking this).



---

archive/issue_comments_281693.json:
```json
{
    "body": "#20837 cleans up the handful of spkgs that don't conform to a format where calling `patch -p1 < ../patches/*.patch` should work from within the source root.\n\nThen we can move forward on appling `sage-apply-patches` by default on all spkgs.",
    "created_at": "2016-06-16T15:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281693",
    "user": "https://github.com/embray"
}
```

#20837 cleans up the handful of spkgs that don't conform to a format where calling `patch -p1 < ../patches/*.patch` should work from within the source root.

Then we can move forward on appling `sage-apply-patches` by default on all spkgs.



---

archive/issue_comments_281694.json:
```json
{
    "body": "What remains to be done for this ticket?\nWould be good to use this for #20892.",
    "created_at": "2016-06-28T04:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281694",
    "user": "https://github.com/mkoeppe"
}
```

What remains to be done for this ticket?
Would be good to use this for #20892.



---

archive/issue_comments_281695.json:
```json
{
    "body": "Mainly: `sage-apply-patches` needs to be changed to fail quietly if no patches are found (I think I already did this; might still be on a local branch)\n\nThen remove all, or almost all calls to `sage-apply-patches` from individual `spkg-install` scripts, and instead call it on all packages as a standard step in `sage-spkg`.\n\nI can get this done soon.",
    "created_at": "2016-06-28T08:49:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281695",
    "user": "https://github.com/embray"
}
```

Mainly: `sage-apply-patches` needs to be changed to fail quietly if no patches are found (I think I already did this; might still be on a local branch)

Then remove all, or almost all calls to `sage-apply-patches` from individual `spkg-install` scripts, and instead call it on all packages as a standard step in `sage-spkg`.

I can get this done soon.



---

archive/issue_comments_281696.json:
```json
{
    "body": "Strange, I thought I rebased this.  Maybe I just forgot to push.",
    "created_at": "2016-07-04T09:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281696",
    "user": "https://github.com/embray"
}
```

Strange, I thought I rebased this.  Maybe I just forgot to push.



---

archive/issue_comments_281697.json:
```json
{
    "body": "Turns out the patches for MathJax needed a bit more tweaking, as they were not uniform with the other packages.",
    "created_at": "2016-07-04T10:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281697",
    "user": "https://github.com/embray"
}
```

Turns out the patches for MathJax needed a bit more tweaking, as they were not uniform with the other packages.



---

archive/issue_comments_281698.json:
```json
{
    "body": "Should there be a way to control the order in which patches are applied?\nFor example Debian uses a file \"series\" that controls this. See for example #20901, for which I'd like to lift the patches from debian.",
    "created_at": "2016-07-07T05:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281698",
    "user": "https://github.com/mkoeppe"
}
```

Should there be a way to control the order in which patches are applied?
For example Debian uses a file "series" that controls this. See for example #20901, for which I'd like to lift the patches from debian.



---

archive/issue_comments_281699.json:
```json
{
    "body": "Could we just prefix the patch filenames with numbers?",
    "created_at": "2016-07-07T09:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281699",
    "user": "https://github.com/embray"
}
```

Could we just prefix the patch filenames with numbers?



---

archive/issue_comments_281700.json:
```json
{
    "body": "Replying to [comment:32 embray]:\n> Could we just prefix the patch filenames with numbers?\n+1 that's the easiest way to get order.",
    "created_at": "2016-07-07T10:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281700",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:32 embray]:
> Could we just prefix the patch filenames with numbers?
+1 that's the easiest way to get order.



---

archive/issue_comments_281701.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-16T13:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281701",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_281702.json:
```json
{
    "body": "Last I poked at this not all the dependencies were satisfied.  Now they are, and I have rebased the branch again on develop.\n\nJust did a test build of this on Linux and everything (modulo optional packages which were not tested) works, but YMMV?",
    "created_at": "2016-08-16T13:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281702",
    "user": "https://github.com/embray"
}
```

Last I poked at this not all the dependencies were satisfied.  Now they are, and I have rebased the branch again on develop.

Just did a test build of this on Linux and everything (modulo optional packages which were not tested) works, but YMMV?



---

archive/issue_comments_281703.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-16T13:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281703",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281704.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-16T13:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281704",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281705.json:
```json
{
    "body": "This should still depend on #21103.",
    "created_at": "2016-08-16T13:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281705",
    "user": "https://github.com/jdemeyer"
}
```

This should still depend on #21103.



---

archive/issue_comments_281706.json:
```json
{
    "body": "Note that I might look at #21103 and this ticket, but not right now since I'm working on #20218 and #21256.",
    "created_at": "2016-08-16T13:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281706",
    "user": "https://github.com/jdemeyer"
}
```

Note that I might look at #21103 and this ticket, but not right now since I'm working on #20218 and #21256.



---

archive/issue_comments_281707.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> An alternative I considered to adding a new script was to create a little library of functions that is sourced in every spkg-install.  It would include `sage-apply-patches` reimplemented as a function, along with a few other bits that are repeated a lot.  This would save on process creations too.\n> \n> I'd still be happy to revisit that idea too if it sounds good, but right now I just wanted to focus on the patch thing since that's what was irking me specifically :)\n\n+1  (You're not the first suggesting this...)",
    "created_at": "2016-08-27T17:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281707",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 embray]:
> An alternative I considered to adding a new script was to create a little library of functions that is sourced in every spkg-install.  It would include `sage-apply-patches` reimplemented as a function, along with a few other bits that are repeated a lot.  This would save on process creations too.
> 
> I'd still be happy to revisit that idea too if it sounds good, but right now I just wanted to focus on the patch thing since that's what was irking me specifically :)

+1  (You're not the first suggesting this...)



---

archive/issue_comments_281708.json:
```json
{
    "body": "P.S.:  The main problem to that time was that (legacy) spkgs didn't depend on the Sage version, so we would have had to add fall-backs first (if the script to source from wasn't available).\n\nError-handling (i.e., the messages) is another thing that should be standardized.",
    "created_at": "2016-08-27T17:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281708",
    "user": "https://github.com/nexttime"
}
```

P.S.:  The main problem to that time was that (legacy) spkgs didn't depend on the Sage version, so we would have had to add fall-backs first (if the script to source from wasn't available).

Error-handling (i.e., the messages) is another thing that should be standardized.



---

archive/issue_comments_281709.json:
```json
{
    "body": "Sounds good--I'll revisit that later in a separate ticket.  As it is this is a step in the right direction since it just standardizes the \"apply patches (if any)\" step across all spkgs.",
    "created_at": "2016-08-29T10:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281709",
    "user": "https://github.com/embray"
}
```

Sounds good--I'll revisit that later in a separate ticket.  As it is this is a step in the right direction since it just standardizes the "apply patches (if any)" step across all spkgs.



---

archive/issue_comments_281710.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2016-10-14T12:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281710",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_281711.json:
```json
{
    "body": "Rebased this yet again, incorporating changes for new packages that were added or updated.  Did a build/test of this branch on Linux and everything looks fine.\n\nI'm clearing the old milestone--will leave it to the release manager to set an appropriate one.",
    "created_at": "2016-10-14T12:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281711",
    "user": "https://github.com/embray"
}
```

Rebased this yet again, incorporating changes for new packages that were added or updated.  Did a build/test of this branch on Linux and everything looks fine.

I'm clearing the old milestone--will leave it to the release manager to set an appropriate one.



---

archive/issue_comments_281712.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-10-14T12:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281712",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281713.json:
```json
{
    "body": "From reading the documentation in `sage-apply-patches`, I don't quite understand the meaning of the `[-d patch-subdir]` and `[patch-dir]` arguments. Are these arguments related? If yes, why is it not just 1 argument?",
    "created_at": "2016-10-14T12:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281713",
    "user": "https://github.com/jdemeyer"
}
```

From reading the documentation in `sage-apply-patches`, I don't quite understand the meaning of the `[-d patch-subdir]` and `[patch-dir]` arguments. Are these arguments related? If yes, why is it not just 1 argument?



---

archive/issue_comments_281714.json:
```json
{
    "body": "In `build/pkgs/openblas/spkg-install`, you make a non-trivial change. Why that?",
    "created_at": "2016-10-14T13:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281714",
    "user": "https://github.com/jdemeyer"
}
```

In `build/pkgs/openblas/spkg-install`, you make a non-trivial change. Why that?



---

archive/issue_comments_281715.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2016-10-14T13:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281715",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_281716.json:
```json
{
    "body": "Also, you are deleting `rubiks` patches...",
    "created_at": "2016-10-14T13:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281716",
    "user": "https://github.com/jdemeyer"
}
```

Also, you are deleting `rubiks` patches...



---

archive/issue_comments_281717.json:
```json
{
    "body": "And since you rewrote `git` history anyway, you might as well squash everything to 1 commit.",
    "created_at": "2016-10-14T13:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281717",
    "user": "https://github.com/jdemeyer"
}
```

And since you rewrote `git` history anyway, you might as well squash everything to 1 commit.



---

archive/issue_comments_281718.json:
```json
{
    "body": "The change in openblas is a mistake made in resolving a merge conflict; will revert.",
    "created_at": "2016-10-14T13:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281718",
    "user": "https://github.com/embray"
}
```

The change in openblas is a mistake made in resolving a merge conflict; will revert.



---

archive/issue_comments_281719.json:
```json
{
    "body": "Replying to [comment:44 jdemeyer]:\n> From reading the documentation in `sage-apply-patches`, I don't quite understand the meaning of the `[-d patch-subdir]` and `[patch-dir]` arguments. Are these arguments related? If yes, why is it not just 1 argument?\n\nI think earlier, before #20837, it was more necessary to have separate arguments.  But I still kind of like it as is.\n\nThe assumption here is that there is a standard root for patches to a package with *may* have subdirectories.  The reason it's useful to have separate arguments is that `spkg-install` scripts don't need to care where the patch root is, but sometimes it's useful to select subdirectories within it from which to apply other patches.\n\nI'm open to other ideas though.",
    "created_at": "2016-10-14T13:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281719",
    "user": "https://github.com/embray"
}
```

Replying to [comment:44 jdemeyer]:
> From reading the documentation in `sage-apply-patches`, I don't quite understand the meaning of the `[-d patch-subdir]` and `[patch-dir]` arguments. Are these arguments related? If yes, why is it not just 1 argument?

I think earlier, before #20837, it was more necessary to have separate arguments.  But I still kind of like it as is.

The assumption here is that there is a standard root for patches to a package with *may* have subdirectories.  The reason it's useful to have separate arguments is that `spkg-install` scripts don't need to care where the patch root is, but sometimes it's useful to select subdirectories within it from which to apply other patches.

I'm open to other ideas though.



---

archive/issue_comments_281720.json:
```json
{
    "body": "Replying to [comment:46 jdemeyer]:\n> Also, you are deleting `rubiks` patches...\n\nLooks like that's left over from before #21103--it wasn't intentional.  What's odd is that everything worked fine without them so now I question whether they're even necessary but I won't think about that for now.",
    "created_at": "2016-10-14T13:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281720",
    "user": "https://github.com/embray"
}
```

Replying to [comment:46 jdemeyer]:
> Also, you are deleting `rubiks` patches...

Looks like that's left over from before #21103--it wasn't intentional.  What's odd is that everything worked fine without them so now I question whether they're even necessary but I won't think about that for now.



---

archive/issue_comments_281721.json:
```json
{
    "body": "As you probably know, I absolutely hate needless complexity. I see no reason to have two arguments doing essentially the same thing. In your current branch, both kinds of arguments are used, but all use cases could be done with either the `-d patch-subdir` argument or the `patch-dir` argument. So just pick one.",
    "created_at": "2016-10-14T14:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281721",
    "user": "https://github.com/jdemeyer"
}
```

As you probably know, I absolutely hate needless complexity. I see no reason to have two arguments doing essentially the same thing. In your current branch, both kinds of arguments are used, but all use cases could be done with either the `-d patch-subdir` argument or the `patch-dir` argument. So just pick one.



---

archive/issue_comments_281722.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-14T14:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281722",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_281723.json:
```json
{
    "body": "I reverted the accidental changes and squashed.  I also want to add documentation about this to the developer docs for maintaining packages.",
    "created_at": "2016-10-14T14:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281723",
    "user": "https://github.com/embray"
}
```

I reverted the accidental changes and squashed.  I also want to add documentation about this to the developer docs for maintaining packages.



---

archive/issue_comments_281724.json:
```json
{
    "body": "Replying to [comment:51 jdemeyer]:\n> As you probably know, I absolutely hate needless complexity. I see no reason to have two arguments doing essentially the same thing. In your current branch, both kinds of arguments are used, but all use cases could be done with either the `-d patch-subdir` argument or the `patch-dir` argument. So just pick one.\n\nI see what you mean about using it inconsistently--well really there's one case of that in singular.  There's a reason for that though.  The way the `spkg-install` for singular is written (talk about \"needless complexity\") is it has a bunch of sub-routine that executes in a loop.  Before each subroutine it cd's in to the `src/` directory (of the *singular* sources, so from the point of view of `spkg-install` that's `src/src` which is different from the default assumption made in `sage-apply-patches`.  \n\nReally if I were using `sage-apply-patches` as I intended here, it should call `sage-apply-patches -d debug \"$PATCH\"` :)  (though it looks like I `cd ..` first, so I guess the `$PATCH` part can go away, maybe...)",
    "created_at": "2016-10-14T14:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281724",
    "user": "https://github.com/embray"
}
```

Replying to [comment:51 jdemeyer]:
> As you probably know, I absolutely hate needless complexity. I see no reason to have two arguments doing essentially the same thing. In your current branch, both kinds of arguments are used, but all use cases could be done with either the `-d patch-subdir` argument or the `patch-dir` argument. So just pick one.

I see what you mean about using it inconsistently--well really there's one case of that in singular.  There's a reason for that though.  The way the `spkg-install` for singular is written (talk about "needless complexity") is it has a bunch of sub-routine that executes in a loop.  Before each subroutine it cd's in to the `src/` directory (of the *singular* sources, so from the point of view of `spkg-install` that's `src/src` which is different from the default assumption made in `sage-apply-patches`.  

Really if I were using `sage-apply-patches` as I intended here, it should call `sage-apply-patches -d debug "$PATCH"` :)  (though it looks like I `cd ..` first, so I guess the `$PATCH` part can go away, maybe...)



---

archive/issue_comments_281725.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-14T14:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281725",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_281726.json:
```json
{
    "body": "As for the arguments I think I'll leave them as is.  As of now the `patch-dir` argument is not used explicitly which is *good*, as it implies uniformity across the `spkg-installs` (previously there was less uniformity and I think both use cases were used).\n\nThat said, it would be more work now to remove it than to leave it as is, as it is completely harmless.  And not having it limits the script's applicability to other problems that may arise in the future.  I do not think it is \"needless complexity\".",
    "created_at": "2016-10-14T14:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281726",
    "user": "https://github.com/embray"
}
```

As for the arguments I think I'll leave them as is.  As of now the `patch-dir` argument is not used explicitly which is *good*, as it implies uniformity across the `spkg-installs` (previously there was less uniformity and I think both use cases were used).

That said, it would be more work now to remove it than to leave it as is, as it is completely harmless.  And not having it limits the script's applicability to other problems that may arise in the future.  I do not think it is "needless complexity".



---

archive/issue_comments_281727.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2016-10-14T14:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281727",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_281728.json:
```json
{
    "body": "Replying to [comment:56 embray]:\n> As for the arguments I think I'll leave them as is.  As of now the `patch-dir` argument is not used explicitly which is *good*, as it implies uniformity across the `spkg-installs` (previously there was less uniformity and I think both use cases were used).\n> \n> That said, it would be more work now to remove it than to leave it as is, as it is completely harmless.  And not having it limits the script's applicability to other problems that may arise in the future.  I do not think it is \"needless complexity\".\n\n(FWIW if I were to choose one to remove it would be `patch-dir` since now it's not used.)\n\nAlso setting back to needs_work because I still need to update the documentation.",
    "created_at": "2016-10-14T14:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281728",
    "user": "https://github.com/embray"
}
```

Replying to [comment:56 embray]:
> As for the arguments I think I'll leave them as is.  As of now the `patch-dir` argument is not used explicitly which is *good*, as it implies uniformity across the `spkg-installs` (previously there was less uniformity and I think both use cases were used).
> 
> That said, it would be more work now to remove it than to leave it as is, as it is completely harmless.  And not having it limits the script's applicability to other problems that may arise in the future.  I do not think it is "needless complexity".

(FWIW if I were to choose one to remove it would be `patch-dir` since now it's not used.)

Also setting back to needs_work because I still need to update the documentation.



---

archive/issue_comments_281729.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-10-14T14:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281729",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281730.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-17T11:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_281731.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-10-17T11:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281731",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281732.json:
```json
{
    "body": "Rebased again, and updated the docs.  Can we please move forward on merging this before I have to rebase again?  If you *really* want to change something about `sage-apply-patches` we can do that separately, but this works now as-is.",
    "created_at": "2016-10-17T11:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281732",
    "user": "https://github.com/embray"
}
```

Rebased again, and updated the docs.  Can we please move forward on merging this before I have to rebase again?  If you *really* want to change something about `sage-apply-patches` we can do that separately, but this works now as-is.



---

archive/issue_comments_281733.json:
```json
{
    "body": "Note to self: double-check `fricas`, `frobby`, `gap3`, `gfan`, `scipoptsuite`",
    "created_at": "2016-10-18T08:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281733",
    "user": "https://github.com/jdemeyer"
}
```

Note to self: double-check `fricas`, `frobby`, `gap3`, `gfan`, `scipoptsuite`



---

archive/issue_comments_281734.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-10-18T10:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281734",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281735.json:
```json
{
    "body": "This conflicts with #17254. I suggest that you merge that branch.",
    "created_at": "2016-10-18T10:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281735",
    "user": "https://github.com/jdemeyer"
}
```

This conflicts with #17254. I suggest that you merge that branch.



---

archive/issue_comments_281736.json:
```json
{
    "body": "Also, since you have to change this branch anyway: could you remove the line `echo \"Applying Sage-specific patches\"` from `sage-spkg`? That is not needed since `sage-apply-patches` is sufficiently verbose. That message could actually be confusing if there are no patches to apply.",
    "created_at": "2016-10-18T10:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281736",
    "user": "https://github.com/jdemeyer"
}
```

Also, since you have to change this branch anyway: could you remove the line `echo "Applying Sage-specific patches"` from `sage-spkg`? That is not needed since `sage-apply-patches` is sufficiently verbose. That message could actually be confusing if there are no patches to apply.



---

archive/issue_comments_281737.json:
```json
{
    "body": "Another detail: the `pushd`/`popd` is also verbose:\n\n```\n[gsl-2.1] Finished extraction\n[gsl-2.1] Applying Sage-specific patches\n[gsl-2.1] /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1/src /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1\n[gsl-2.1] No patch files found in ../patches\n[gsl-2.1] /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1\n[gsl-2.1] ****************************************************\n```\n\nThis should be silenced",
    "created_at": "2016-10-18T11:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281737",
    "user": "https://github.com/jdemeyer"
}
```

Another detail: the `pushd`/`popd` is also verbose:

```
[gsl-2.1] Finished extraction
[gsl-2.1] Applying Sage-specific patches
[gsl-2.1] /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1/src /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1
[gsl-2.1] No patch files found in ../patches
[gsl-2.1] /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1
[gsl-2.1] ****************************************************
```

This should be silenced



---

archive/issue_comments_281738.json:
```json
{
    "body": "Some packages still use non-standard patching: #21721",
    "created_at": "2016-10-18T13:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281738",
    "user": "https://github.com/jdemeyer"
}
```

Some packages still use non-standard patching: #21721



---

archive/issue_comments_281739.json:
```json
{
    "body": "In `build/pkgs/scipoptsuite/spkg-install`, you are still using both directory arguments:\n\n```\nsage-apply-patches -d scip $SPKGDIR/patches || exit 1\n```\n\nThis could be\n\n```\nsage-apply-patches \"$SPKGDIR/patches/scip\" || exit $?\n```\n",
    "created_at": "2016-10-18T13:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281739",
    "user": "https://github.com/jdemeyer"
}
```

In `build/pkgs/scipoptsuite/spkg-install`, you are still using both directory arguments:

```
sage-apply-patches -d scip $SPKGDIR/patches || exit 1
```

This could be

```
sage-apply-patches "$SPKGDIR/patches/scip" || exit $?
```




---

archive/issue_comments_281740.json:
```json
{
    "body": "`gap3` had more issues, so I created a separate ticket: #21722",
    "created_at": "2016-10-18T14:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281740",
    "user": "https://github.com/jdemeyer"
}
```

`gap3` had more issues, so I created a separate ticket: #21722



---

archive/issue_comments_281741.json:
```json
{
    "body": "All dependencies are merged now, so please rebase to latest `7.5.beta1`.",
    "created_at": "2016-10-31T21:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281741",
    "user": "https://github.com/jdemeyer"
}
```

All dependencies are merged now, so please rebase to latest `7.5.beta1`.



---

archive/issue_comments_281742.json:
```json
{
    "body": "All dependencies are not merged now....",
    "created_at": "2016-11-07T13:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281742",
    "user": "https://github.com/embray"
}
```

All dependencies are not merged now....



---

archive/issue_comments_281743.json:
```json
{
    "body": "Replying to [comment:71 embray]:\n> All dependencies are not merged now....\n\nNo, because I added two dependencies which would otherwise conflict.",
    "created_at": "2016-11-07T13:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281743",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:71 embray]:
> All dependencies are not merged now....

No, because I added two dependencies which would otherwise conflict.



---

archive/issue_comments_281744.json:
```json
{
    "body": "You could just merge those two dependencies in this branch.",
    "created_at": "2016-11-07T13:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281744",
    "user": "https://github.com/jdemeyer"
}
```

You could just merge those two dependencies in this branch.



---

archive/issue_comments_281745.json:
```json
{
    "body": "needs rebasing",
    "created_at": "2016-11-18T01:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281745",
    "user": "https://github.com/mkoeppe"
}
```

needs rebasing



---

archive/issue_comments_281746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-11-21T14:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_281747.json:
```json
{
    "body": "Rebased again.",
    "created_at": "2016-11-21T14:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281747",
    "user": "https://github.com/embray"
}
```

Rebased again.



---

archive/issue_comments_281748.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-11-21T14:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281748",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_281749.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-11-21T14:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281749",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_281750.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-21T14:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281750",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281751.json:
```json
{
    "body": "Sorry--misclicked.",
    "created_at": "2016-11-21T14:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281751",
    "user": "https://github.com/embray"
}
```

Sorry--misclicked.



---

archive/issue_comments_281752.json:
```json
{
    "body": "Please fix [comment:63], [comment:64], [comment:66]. Those are trivial things which can easily be fixed.",
    "created_at": "2016-11-22T16:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281752",
    "user": "https://github.com/jdemeyer"
}
```

Please fix [comment:63], [comment:64], [comment:66]. Those are trivial things which can easily be fixed.



---

archive/issue_comments_281753.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-22T16:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281753",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281754.json:
```json
{
    "body": "The way `sage-apply-patches` is being invoked in scipoptsuite/spkg-install is actually exactly how those options are meant to be used but whatever.",
    "created_at": "2016-11-23T10:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281754",
    "user": "https://github.com/embray"
}
```

The way `sage-apply-patches` is being invoked in scipoptsuite/spkg-install is actually exactly how those options are meant to be used but whatever.



---

archive/issue_comments_281755.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-11-23T10:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_281756.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-11-23T10:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281756",
    "user": "https://github.com/embray"
}
```

New commits:



---

archive/issue_comments_281757.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-23T10:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281757",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281758.json:
```json
{
    "body": "I have no further objections. I'm currently building Sage from scratch with this branch. If this works fine, I will set this to positive_review (hoping that there are no conflicts).",
    "created_at": "2016-11-23T14:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281758",
    "user": "https://github.com/jdemeyer"
}
```

I have no further objections. I'm currently building Sage from scratch with this branch. If this works fine, I will set this to positive_review (hoping that there are no conflicts).



---

archive/issue_comments_281759.json:
```json
{
    "body": "Awesome, thanks!",
    "created_at": "2016-11-23T15:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281759",
    "user": "https://github.com/embray"
}
```

Awesome, thanks!



---

archive/issue_comments_281760.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-23T21:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281760",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_281761.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2016-11-24T23:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281761",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_281762.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-11-24T23:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281762",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_281763.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-11-29T09:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281763",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_281764.json:
```json
{
    "body": "Rebased.",
    "created_at": "2016-11-29T09:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281764",
    "user": "https://github.com/embray"
}
```

Rebased.



---

archive/issue_comments_281765.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-11-29T09:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281765",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_281766.json:
```json
{
    "body": "I fixed a minor bikeshed: I prefer no newline after `./configure` in\n\n```\n./configure ...\n\nif [ $? -ne 0 ]; then\n    ...\nfi\n```\n\nIt makes it more clear that the `if` really belongs with the `./configure`.\n\nI don't know if you intentionally added a newline there in `build/pkgs/cysignals/spkg-install`, but I removed it now. I also squashed the commits together.\n----\nNew commits:",
    "created_at": "2016-11-29T11:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281766",
    "user": "https://github.com/jdemeyer"
}
```

I fixed a minor bikeshed: I prefer no newline after `./configure` in

```
./configure ...

if [ $? -ne 0 ]; then
    ...
fi
```

It makes it more clear that the `if` really belongs with the `./configure`.

I don't know if you intentionally added a newline there in `build/pkgs/cysignals/spkg-install`, but I removed it now. I also squashed the commits together.
----
New commits:



---

archive/issue_comments_281767.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-30T19:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281767",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_281768.json:
```json
{
    "body": "Finally merged, thanks Erik!",
    "created_at": "2016-12-02T06:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281768",
    "user": "https://github.com/jdemeyer"
}
```

Finally merged, thanks Erik!



---

archive/issue_comments_281769.json:
```json
{
    "body": "Hooray!\n*pours you a champagne*",
    "created_at": "2016-12-02T10:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20455#issuecomment-281769",
    "user": "https://github.com/embray"
}
```

Hooray!
*pours you a champagne*
