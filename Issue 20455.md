# Issue 20455: Add sage-apply-patches helper script for use in spkg-install scripts

Issue created by migration from https://trac.sagemath.org/ticket/20692

Original creator: embray

Original creation time: 2016-05-27 11:33:29

This adds a new script to `build/bin` called `sage-apply-patches` which implements the same code that is copy/pasted through many of the `spkg-install` scripts (albeit often inconsistently).  It also updates those `spkg-install`s to use it where appropriate.

I'm not attached to any of the details of how the script works--the implementation was designed mostly to make it easiest to automatically replace the existing repeated code snippet with minimal effort.


---

Comment by embray created at 2016-05-27 11:33:43

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-05-27 15:06:28

Seems I have to undust my `bash` scripting skills...

Why is it an error if there are no patches to apply? I would remove

```
if [[ -r "${patches[0]}" ]]; then
else
    >&2 echo "No patch files found in $patchdir"
    exit 1
fi
```

and just apply all patches, which may be the empty set.


---

Comment by jdemeyer created at 2016-05-27 15:07:49

A minor thing: I would prefer to remove the `-pNUM` option. It's better if we consistently use `-p1` in all cases. That's also how `git` generates its patches.


---

Comment by jdemeyer created at 2016-05-27 15:10:59

I don't get this:

```
and it is assumed that the patches are being applied from
the root of the package source
```



---

Comment by jdemeyer created at 2016-05-27 15:11:35

Why not always use the option `--no-backup-if-mismatch` instead of only for PARI?


---

Comment by jdemeyer created at 2016-05-27 15:12:18

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-05-27 15:17:10

Following up on [comment:2]: it's very useful to support an empty set of patches. For example, when upgrading a package, it can happen that all patches need to be removed. You don't want that to break the build. That is also the reason why many packages have code to apply patches when they don't have patches. I would not remove such code since it allows easily adding a new patch. Ideally, every `spkg-install` script would call `spkg-apply-patches`.


---

Comment by embray created at 2016-05-27 16:04:59

Replying to [comment:7 jdemeyer]:
> Following up on [comment:2]: it's very useful to support an empty set of patches. For example, when upgrading a package, it can happen that all patches need to be removed. You don't want that to break the build. That is also the reason why many packages have code to apply patches when they don't have patches. I would not remove such code since it allows easily adding a new patch. Ideally, every `spkg-install` script would call `spkg-apply-patches`.

I guess I was thinking it was wasteful to call a process (especially on Windows where process creation is much slower) when it's not needed.  Granted, when this was inline in every script it didn't require a process creation (more on that in a followup).  I think if someone wants to add a patch to a package they should explicitly add `spkg-appy-patches` as well.  If they forget to do that, well, then they clearly didn't test that their patch applies at build time :)

As for it being an error when no patches are found, I have no strong feelings.  I liked that it was explicit, but it could just as will either print a message, or go completely silent.

> A minor thing: I would prefer to remove the -pNUM option. It's better if we consistently use -p1 in all cases. That's also how git generates its patches.

That's fine by me.  I think there was one case, maybe two where it was needed, but it would be just as easy to update those patch files and keep things consistent throughout.

> Why not always use the option `--no-backup-if-mismatch` instead of only for PARI?

I figured maybe there was a reason to prefer to keep backups in general.  Would be fine with me to apply in general though.  Previously there was one other case where additional arguments had to be passed to `patch`, but then I realized that package had no patches anymore.

> I don't get this:
   and it is assumed that the patches are being applied from
   the root of the package source

Meaning the patches are applied after `cd`-ing into the upstream source, hence the default path to search for patches being `../patches`.  No reason it has to be that way but it was the most minimal change from the existing code.


---

Comment by embray created at 2016-05-27 16:06:44

An alternative I considered to adding a new script was to create a little library of functions that is sourced in every spkg-install.  It would include `sage-apply-patches` reimplemented as a function, along with a few other bits that are repeated a lot.  This would save on process creations too.

I'd still be happy to revisit that idea too if it sounds good, but right now I just wanted to focus on the patch thing since that's what was irking me specifically :)


---

Comment by jdemeyer created at 2016-05-28 20:53:52

Replying to [comment:8 embray]:
> I guess I was thinking it was wasteful to call a process (especially on Windows where process creation is much slower) when it's not needed.

How much slower is it really? Surely it's negligible compared to the time to build Sage.

> I think if someone wants to add a patch to a package they should explicitly add `spkg-appy-patches` as well.

That's really annoying. Please keep the call to `spkg-apply-patches` even when there are no patches.


---

Comment by embray created at 2016-05-30 08:57:54

If you feel that strongly about it. I think it's pointless.  Especially considering that it was already inconsistent.  Instead you should be asking me to put `sage-apply-patches` in every `spkg-install` that didn't have it before :)


---

Comment by jdemeyer created at 2016-05-30 09:10:22

Replying to [comment:11 embray]:
> Instead you should be asking me to put `sage-apply-patches` in every `spkg-install` that didn't have it before :)

Well, that's essentially what I wrote in [comment:7].

And yes, I feel strongly about because I don't want to always add/remove the call to `spkg-apply-patches` depending on whether or not the number of patches to apply equals zero.

Detail: for consistency, I would prefer the script to be called `spkg-apply-patches` instead of `sage-apply-patches`.


---

Comment by embray created at 2016-05-30 09:40:08

What would that be consistent with?  Every other script in `build/bin` starts with `sage-`.  In fact very nearly every, if not every executable installed by sage starts with `sage-` which is good and consistent, and completely free of potential for overlap with anything else.


---

Comment by jdemeyer created at 2016-05-30 09:46:52

Consistent with `spkg-install`, `spkg-check`, `spkg-src`. Basically, anything related to building Sage packages.


---

Comment by embray created at 2016-05-30 09:53:05

Those scripts are only ever in spkg directories though and are specific to each spkg. They are not in bin/ paths added to `$PATH`.  This is a helper script used in installation like the rest in build/bin, all of which (sensibly) start with `sage-`.

I'm probably also going to add a `sage-spkg-python` (or something, I don't care what it's called) that will be exec'd by the `spkg-install` for most Python packages since the vast majority of them are cookie-cutter anyways (especially if you also want to have every one of them calling `whatever-apply-patches` by default).  This would be to provide a solution for #16897 which also calls out this fact.  (I think it's important for every package to have a file called `spkg-install`, but it's fine if its sole function is to call some other generic script).


---

Comment by jdemeyer created at 2016-05-30 09:56:33

For the record: I just wanted to comment over the name, I'm not going to reject this patch over such bikeshedding.


---

Comment by fbissey created at 2016-05-30 10:31:18

While I am OK with the stuff as it is, I have a bold suggestion for further work: may be it should be put in `sage-spkg` and always be run. We already leave it when there is no patches anymore. What would be the overhead of always running it?


---

Comment by jdemeyer created at 2016-05-30 10:33:53

Replying to [comment:17 fbissey]:
> may be it should be put in `sage-spkg` and always be run.

Not easily. We need to guess in which source directory to run the script. Usually, it's `src` but not always.


---

Comment by fbissey created at 2016-05-30 11:06:50

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 fbissey]:
> > may be it should be put in `sage-spkg` and always be run.
> 
> Not easily. We need to guess in which source directory to run the script. Usually, it's `src` but not always.

Tricky. I didn't remember we had those outliers.


---

Comment by embray created at 2016-05-30 11:18:58

Let me think about that a bit more though.  If it were done in `sage-spkg` it would do away with the need for a separate script entirely, and would cut down that much more on the duplication which is what I want.

One possibility would be to rewrite the patch files to include the source directory in the paths, but that could be annoying and error-prone.  The other would be to standardize `src`.  I knew there were outliers but I never looked into why.  Is there really no way those could be changed?


---

Comment by embray created at 2016-05-30 11:31:15

`sage-spkg` contains the following:


```
     # Strip file extension from the archive file and hope (as per
     # automake standards) that this is the same as the directory name
     # inside; move the directory to "src".  (This goes wrong for
     # upstream package archives that have been renamed to appease some
     # other Sage script, such as "latte-int", whose archive is renamed
     # to "latte_int".)
     mv "$(echo "$PKG_NAME_UPSTREAM" | sed 's/\.zip$//g;s/\.tgz$//g;s/\.tar\.    gz$//g;s/\.tar\.xz$//g;s/\.tar\.lz$//g;s/\.tar\.bz2$//g;s/\.tar$//g')"* src
```


Maybe this should be redone.  There are a number of ways it might be done differently.  One possibility is that it could be made `sage-uncompress-spkg`'s job to always extract to `src`.  It could handle checking for the top-level directory in the archive and extracting it instead as `src`.  For those handful of packages (are there any? I suspect probably...) that don't have a top-level directory it would create `src` and extract all the archive contents into it.


---

Comment by fbissey created at 2016-05-30 11:38:08

This is getting out of the original scope (and I am sorry to have started it) but it would be a good idea to have something more robust for unpacking in a standard folder. May be we should just get this in now and move that idea to another ticket?


---

Comment by embray created at 2016-05-30 11:48:15

Replying to [comment:22 fbissey]:
> This is getting out of the original scope (and I am sorry to have started it) but it would be a good idea to have something more robust for unpacking in a standard folder. May be we should just get this in now and move that idea to another ticket?

I was going to suggest the same.  Though I might address the subject of extracting to a standard location before coming back to and reworking this ticket.  I've gone through the list of spkgs that *don't* wind up with their sources in `src` and in each case there's no good reason really, except that the hack above doesn't work for it (or the last time the file was touched predates that hack).

I think a patch to `sage-uncompress-spkg` would be a good idea and I'll put something to that effect in a separate ticket.


---

Comment by embray created at 2016-05-30 17:14:02

I think #20721, or something like it, should be a prerequisite to this ticket (or any like it depending on how much I end up reworking this).


---

Comment by embray created at 2016-06-16 15:20:10

#20837 cleans up the handful of spkgs that don't conform to a format where calling `patch -p1 < ../patches/*.patch` should work from within the source root.

Then we can move forward on appling `sage-apply-patches` by default on all spkgs.


---

Comment by mkoeppe created at 2016-06-28 04:02:15

What remains to be done for this ticket?
Would be good to use this for #20892.


---

Comment by embray created at 2016-06-28 08:49:05

Mainly: `sage-apply-patches` needs to be changed to fail quietly if no patches are found (I think I already did this; might still be on a local branch)

Then remove all, or almost all calls to `sage-apply-patches` from individual `spkg-install` scripts, and instead call it on all packages as a standard step in `sage-spkg`.

I can get this done soon.


---

Comment by embray created at 2016-07-04 09:32:20

Strange, I thought I rebased this.  Maybe I just forgot to push.


---

Comment by embray created at 2016-07-04 10:25:24

Turns out the patches for MathJax needed a bit more tweaking, as they were not uniform with the other packages.


---

Comment by mkoeppe created at 2016-07-07 05:10:22

Should there be a way to control the order in which patches are applied?
For example Debian uses a file "series" that controls this. See for example #20901, for which I'd like to lift the patches from debian.


---

Comment by embray created at 2016-07-07 09:58:51

Could we just prefix the patch filenames with numbers?


---

Comment by fbissey created at 2016-07-07 10:01:36

Replying to [comment:32 embray]:
> Could we just prefix the patch filenames with numbers?
+1 that's the easiest way to get order.


---

Comment by git created at 2016-08-16 13:25:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-08-16 13:27:42

Last I poked at this not all the dependencies were satisfied.  Now they are, and I have rebased the branch again on develop.

Just did a test build of this on Linux and everything (modulo optional packages which were not tested) works, but YMMV?


---

Comment by embray created at 2016-08-16 13:27:51

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-08-16 13:28:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-08-16 13:28:44

This should still depend on #21103.


---

Comment by jdemeyer created at 2016-08-16 13:29:35

Note that I might look at #21103 and this ticket, but not right now since I'm working on #20218 and #21256.


---

Comment by leif created at 2016-08-27 17:50:41

Replying to [comment:9 embray]:
> An alternative I considered to adding a new script was to create a little library of functions that is sourced in every spkg-install.  It would include `sage-apply-patches` reimplemented as a function, along with a few other bits that are repeated a lot.  This would save on process creations too.
> 
> I'd still be happy to revisit that idea too if it sounds good, but right now I just wanted to focus on the patch thing since that's what was irking me specifically :)

+1  (You're not the first suggesting this...)


---

Comment by leif created at 2016-08-27 17:57:34

P.S.:  The main problem to that time was that (legacy) spkgs didn't depend on the Sage version, so we would have had to add fall-backs first (if the script to source from wasn't available).

Error-handling (i.e., the messages) is another thing that should be standardized.


---

Comment by embray created at 2016-08-29 10:47:31

Sounds good--I'll revisit that later in a separate ticket.  As it is this is a step in the right direction since it just standardizes the "apply patches (if any)" step across all spkgs.


---

Comment by git created at 2016-10-14 12:29:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2016-10-14 12:31:14

Rebased this yet again, incorporating changes for new packages that were added or updated.  Did a build/test of this branch on Linux and everything looks fine.

I'm clearing the old milestone--will leave it to the release manager to set an appropriate one.


---

Comment by embray created at 2016-10-14 12:31:14

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-14 12:59:50

From reading the documentation in `sage-apply-patches`, I don't quite understand the meaning of the `[-d patch-subdir]` and `[patch-dir]` arguments. Are these arguments related? If yes, why is it not just 1 argument?


---

Comment by jdemeyer created at 2016-10-14 13:05:43

In `build/pkgs/openblas/spkg-install`, you make a non-trivial change. Why that?


---

Comment by jdemeyer created at 2016-10-14 13:05:43

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2016-10-14 13:40:03

Also, you are deleting `rubiks` patches...


---

Comment by jdemeyer created at 2016-10-14 13:41:13

And since you rewrote `git` history anyway, you might as well squash everything to 1 commit.


---

Comment by embray created at 2016-10-14 13:51:15

The change in openblas is a mistake made in resolving a merge conflict; will revert.


---

Comment by embray created at 2016-10-14 13:55:24

Replying to [comment:44 jdemeyer]:
> From reading the documentation in `sage-apply-patches`, I don't quite understand the meaning of the `[-d patch-subdir]` and `[patch-dir]` arguments. Are these arguments related? If yes, why is it not just 1 argument?

I think earlier, before #20837, it was more necessary to have separate arguments.  But I still kind of like it as is.

The assumption here is that there is a standard root for patches to a package with _may_ have subdirectories.  The reason it's useful to have separate arguments is that `spkg-install` scripts don't need to care where the patch root is, but sometimes it's useful to select subdirectories within it from which to apply other patches.

I'm open to other ideas though.


---

Comment by embray created at 2016-10-14 13:57:05

Replying to [comment:46 jdemeyer]:
> Also, you are deleting `rubiks` patches...

Looks like that's left over from before #21103--it wasn't intentional.  What's odd is that everything worked fine without them so now I question whether they're even necessary but I won't think about that for now.


---

Comment by jdemeyer created at 2016-10-14 14:02:26

As you probably know, I absolutely hate needless complexity. I see no reason to have two arguments doing essentially the same thing. In your current branch, both kinds of arguments are used, but all use cases could be done with either the `-d patch-subdir` argument or the `patch-dir` argument. So just pick one.


---

Comment by git created at 2016-10-14 14:09:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-10-14 14:11:56

I reverted the accidental changes and squashed.  I also want to add documentation about this to the developer docs for maintaining packages.


---

Comment by embray created at 2016-10-14 14:19:05

Replying to [comment:51 jdemeyer]:
> As you probably know, I absolutely hate needless complexity. I see no reason to have two arguments doing essentially the same thing. In your current branch, both kinds of arguments are used, but all use cases could be done with either the `-d patch-subdir` argument or the `patch-dir` argument. So just pick one.

I see what you mean about using it inconsistently--well really there's one case of that in singular.  There's a reason for that though.  The way the `spkg-install` for singular is written (talk about "needless complexity") is it has a bunch of sub-routine that executes in a loop.  Before each subroutine it cd's in to the `src/` directory (of the _singular_ sources, so from the point of view of `spkg-install` that's `src/src` which is different from the default assumption made in `sage-apply-patches`.  

Really if I were using `sage-apply-patches` as I intended here, it should call `sage-apply-patches -d debug "$PATCH"` :)  (though it looks like I `cd ..` first, so I guess the `$PATCH` part can go away, maybe...)


---

Comment by git created at 2016-10-14 14:25:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-10-14 14:30:55

As for the arguments I think I'll leave them as is.  As of now the `patch-dir` argument is not used explicitly which is _good_, as it implies uniformity across the `spkg-installs` (previously there was less uniformity and I think both use cases were used).

That said, it would be more work now to remove it than to leave it as is, as it is completely harmless.  And not having it limits the script's applicability to other problems that may arise in the future.  I do not think it is "needless complexity".


---

Comment by embray created at 2016-10-14 14:31:08

Changing status from needs_info to needs_review.


---

Comment by embray created at 2016-10-14 14:43:58

Replying to [comment:56 embray]:
> As for the arguments I think I'll leave them as is.  As of now the `patch-dir` argument is not used explicitly which is _good_, as it implies uniformity across the `spkg-installs` (previously there was less uniformity and I think both use cases were used).
> 
> That said, it would be more work now to remove it than to leave it as is, as it is completely harmless.  And not having it limits the script's applicability to other problems that may arise in the future.  I do not think it is "needless complexity".

(FWIW if I were to choose one to remove it would be `patch-dir` since now it's not used.)

Also setting back to needs_work because I still need to update the documentation.


---

Comment by embray created at 2016-10-14 14:43:58

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-10-17 11:48:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-10-17 11:51:02

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-10-17 11:51:02

Rebased again, and updated the docs.  Can we please move forward on merging this before I have to rebase again?  If you _really_ want to change something about `sage-apply-patches` we can do that separately, but this works now as-is.


---

Comment by jdemeyer created at 2016-10-18 08:43:36

Note to self: double-check `fricas`, `frobby`, `gap3`, `gfan`, `scipoptsuite`


---

Comment by jdemeyer created at 2016-10-18 10:33:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-10-18 10:33:22

This conflicts with #17254. I suggest that you merge that branch.


---

Comment by jdemeyer created at 2016-10-18 10:35:07

Also, since you have to change this branch anyway: could you remove the line `echo "Applying Sage-specific patches"` from `sage-spkg`? That is not needed since `sage-apply-patches` is sufficiently verbose. That message could actually be confusing if there are no patches to apply.


---

Comment by jdemeyer created at 2016-10-18 11:32:09

Another detail: the `pushd`/`popd` is also verbose:

```
[gsl-2.1] Finished extraction
[gsl-2.1] Applying Sage-specific patches
[gsl-2.1] /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1/src /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1
[gsl-2.1] No patch files found in ../patches
[gsl-2.1] /usr/local/src/sage-git/local/var/tmp/sage/build/gsl-2.1
[gsl-2.1] ****************************************************
```

This should be silenced


---

Comment by jdemeyer created at 2016-10-18 13:29:51

Some packages still use non-standard patching: #21721


---

Comment by jdemeyer created at 2016-10-18 13:34:01

In `build/pkgs/scipoptsuite/spkg-install`, you are still using both directory arguments:

```
sage-apply-patches -d scip $SPKGDIR/patches || exit 1
```

This could be

```
sage-apply-patches "$SPKGDIR/patches/scip" || exit $?
```



---

Comment by jdemeyer created at 2016-10-18 14:47:01

`gap3` had more issues, so I created a separate ticket: #21722


---

Comment by jdemeyer created at 2016-10-31 21:09:44

All dependencies are merged now, so please rebase to latest `7.5.beta1`.


---

Comment by embray created at 2016-11-07 13:34:41

All dependencies are not merged now....


---

Comment by jdemeyer created at 2016-11-07 13:42:07

Replying to [comment:71 embray]:
> All dependencies are not merged now....

No, because I added two dependencies which would otherwise conflict.


---

Comment by jdemeyer created at 2016-11-07 13:42:23

You could just merge those two dependencies in this branch.


---

Comment by mkoeppe created at 2016-11-18 01:23:04

needs rebasing


---

Comment by git created at 2016-11-21 14:58:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-11-21 14:58:25

Rebased again.


---

Comment by embray created at 2016-11-21 14:58:25

Changing status from needs_work to positive_review.


---

Comment by embray created at 2016-11-21 14:58:35

Changing status from positive_review to needs_work.


---

Comment by embray created at 2016-11-21 14:58:46

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-11-21 14:58:46

Sorry--misclicked.


---

Comment by jdemeyer created at 2016-11-22 16:04:56

Please fix [comment:63], [comment:64], [comment:66]. Those are trivial things which can easily be fixed.


---

Comment by jdemeyer created at 2016-11-22 16:04:56

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-11-23 10:53:37

The way `sage-apply-patches` is being invoked in scipoptsuite/spkg-install is actually exactly how those options are meant to be used but whatever.


---

Comment by git created at 2016-11-23 10:55:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-11-23 10:55:27

New commits:


---

Comment by embray created at 2016-11-23 10:55:27

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-11-23 14:16:02

I have no further objections. I'm currently building Sage from scratch with this branch. If this works fine, I will set this to positive_review (hoping that there are no conflicts).


---

Comment by embray created at 2016-11-23 15:01:46

Awesome, thanks!


---

Comment by jdemeyer created at 2016-11-23 21:59:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-11-24 23:43:21

Merge conflict


---

Comment by vbraun created at 2016-11-24 23:43:21

Changing status from positive_review to needs_work.


---

Comment by git created at 2016-11-29 09:42:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-11-29 09:42:48

Rebased.


---

Comment by embray created at 2016-11-29 09:42:48

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2016-11-29 11:21:21

I fixed a minor bikeshed: I prefer no newline after `./configure` in

```
./configure ...

if [ $? -ne 0 ]; then
    ...
fi
```

It makes it more clear that the `if` really belongs with the `./configure`.

I don't know if you intentionally added a newline there in `build/pkgs/cysignals/spkg-install`, but I removed it now. I also squashed the commits together.
----
New commits:


---

Comment by vbraun created at 2016-11-30 19:36:11

Resolution: fixed


---

Comment by jdemeyer created at 2016-12-02 06:05:59

Finally merged, thanks Erik!


---

Comment by embray created at 2016-12-02 10:37:29

Hooray!
*pours you a champagne*
