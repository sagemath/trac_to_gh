# Issue 29870: Fix docstring failures in designs.balanced_incomplete_block_design with use_LJCR=True

Issue created by migration from https://trac.sagemath.org/ticket/30107

Original creator: @Ivo-Maffei

Original creation time: 2020-07-10 21:46:38

CC:  dimpase

Keywords: bibd, LJCR

The use of `use_LJCR=True` in `designs.balanced_incomplete_block_design` give rise to a few issues.
1. The returned object has type `IncidenceStructure` instead of `BalancedIncompleteBlockDesign`
2. A `URLError` exception is raised

An example for 2 is:

```
sage: designs.balanced_incomplete_block_design(85,7,1,use_LJCR=True)
Traceback (most recent call last):
...
URLError: <urlopen error unknown url type: https>
```


In addition to the above, the docstring tests that are meant to test the use of `use_LJCR=True` are not actually testing the LJCR online database.


---

Comment by @Ivo-Maffei created at 2020-07-10 22:26:23

I tried looking for an entry in the LJCR database that gets used by Sage, but I can't find one.
I run the code


```
sage: for v in range(100):
....:     for k in range(v):
....:         D = designs.balanced_incomplete_block_design(v,k,1,use_LJCR=True, existence=True)
....:         if D == 3:
....:             print(v,k)
```

where I changed the `balanced_incomplete_block_design` function to return 3 instead of `True` if the LJCR database was used.

I didn't obtain any results. So I think that the LJCR database is actually never used.

On a side note, to fix the `URLError` I swapped the url to use http instead of https. I don't think there is a security issue in retrieving values for Sage, yet you never know how Sage might get used. Hence, I believe the issue should be fixed at the level of `urllib` (the python library used for the request).
I don't have the knowledge to fix it myself, though.
----
New commits:


---

Comment by dimpase created at 2020-07-11 10:25:37

to see the errors (before this branch), run

```
./sage -tp --optional=build,dochtml,memlimit,internet,sage src/sage/combinat/designs/
```

In particular I see

```
sage -t --warn-long 81.5 src/sage/combinat/designs/bibd.py
**********************************************************************
File "src/sage/combinat/designs/bibd.py", line 157, in sage.combinat.designs.bibd.balanced_incomplete_block_design
Failed example:
    B                                                              # optional - internet
Expected:
    Incidence structure with 66 points and 143 blocks
Got:
    (66,6,1)-Balanced Incomplete Block Design
**********************************************************************
File "src/sage/combinat/designs/bibd.py", line 161, in sage.combinat.designs.bibd.balanced_incomplete_block_design
Failed example:
    designs.balanced_incomplete_block_design(66, 6, 1, use_LJCR=True)  # optional - internet
Expected:
    Incidence structure with 66 points and 143 blocks
Got:
    (66,6,1)-Balanced Incomplete Block Design
**********************************************************************
```



---

Comment by dimpase created at 2020-07-11 10:33:51

With your branch, all the tests as in comment:3 pass. However, I can revert your change https->http as follows and still have all the tests pass.


```diff
--- a/src/sage/combinat/designs/covering_design.py
+++ b/src/sage/combinat/designs/covering_design.py
@@ -521,7 +521,7 @@ def best_known_covering_design_www(v, k, t, verbose=False):
     k = int(k)
     t = int(t)
     param = "?v=%s&k=%s&t=%s" % (v, k, t)
-    url = "http://ljcr.dmgordon.org/cover/get_cover.php" + param
+    url = "https://ljcr.dmgordon.org/cover/get_cover.php" + param
     if verbose:
         print("Looking up the bounds at %s" % url)
 
```


It appears that in your Sage's python URLlib is broken. Of course it should be able to handle https. Tell me more about your `./sage --python`. Do you build it, or use one from OS?


---

Comment by dimpase created at 2020-07-11 10:36:55

Is this otherwise ready for review?


---

Comment by @Ivo-Maffei created at 2020-07-11 15:39:01

I'm not sure where the python software I have comes from.
If it can help I have the following output

```
% sage --python
Python 3.7.3 (default, May  6 2020, 12:19:52) 
[Clang 11.0.3 (clang-1103.0.32.59)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
```


Actually the full traceback when I get the `URLError` is the following:

```
URLError                                  Traceback (most recent call last)
<ipython-input-1-aace303dd913> in <module>()
----> 1 designs.balanced_incomplete_block_design(Integer(85),Integer(7),Integer(1),use_LJCR=True)

/Users/ivomaffei/sage/local/lib/python3.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3675)()
    351             True
    352         """
--> 353         return self.get_object()(*args, **kwds)
    354 
    355     def __repr__(self):

/Users/ivomaffei/sage/local/lib/python3.7/site-packages/sage/combinat/designs/bibd.py in balanced_incomplete_block_design(v, k, lambd, existence, use_LJCR)
    253         values_in_db = False
    254         try:
--> 255             B = best_known_covering_design_www(v, k, 2)
    256             values_in_db = True
    257         except ValueError:

/Users/ivomaffei/sage/local/lib/python3.7/site-packages/sage/combinat/designs/covering_design.py in best_known_covering_design_www(v, k, t, verbose)
    526         print("Looking up the bounds at %s" % url)
    527 
--> 528     f = urlopen(url)
    529     try:
    530         s = bytes_to_str(f.read())

/Users/ivomaffei/sage/local/lib/python3.7/urllib/request.py in urlopen(url, data, timeout, cafile, capath, cadefault, context)
    220     else:
    221         opener = _opener
--> 222     return opener.open(url, data, timeout)
    223 
    224 def install_opener(opener):

/Users/ivomaffei/sage/local/lib/python3.7/urllib/request.py in open(self, fullurl, data, timeout)
    523             req = meth(req)
    524 
--> 525         response = self._open(req, data)
    526 
    527         # post-process response

/Users/ivomaffei/sage/local/lib/python3.7/urllib/request.py in _open(self, req, data)
    546 
    547         return self._call_chain(self.handle_open, 'unknown',
--> 548                                 'unknown_open', req)
    549 
    550     def error(self, proto, *args):

/Users/ivomaffei/sage/local/lib/python3.7/urllib/request.py in _call_chain(self, chain, kind, meth_name, *args)
    501         for handler in handlers:
    502             func = getattr(handler, meth_name)
--> 503             result = func(*args)
    504             if result is not None:
    505                 return result

/Users/ivomaffei/sage/local/lib/python3.7/urllib/request.py in unknown_open(self, req)
   1385     def unknown_open(self, req):
   1386         type = req.type
-> 1387         raise URLError('unknown url type: %s' % type)
   1388 
   1389 def parse_keqv_list(l):

URLError: <urlopen error unknown url type: https>
```


So it seems the issues lies in the python shipped with sage.

Apart from the above, I would like to substitute the parameters of the docstring test as at the moment they are not testing the LJCR database. However, I can't find any set of parameters for which the LJCR database is actually used by sage.


---

Comment by slelievre created at 2020-07-11 22:50:37

Seems you built or installed Sage without OpenSSL.


---

Comment by @Ivo-Maffei created at 2020-07-12 10:17:17

I use macOS which ships with LibreSSL and sort of "redirect" all OpenSSL commands to LibreSSL, i.e.

```
% openssl version
LibreSSL 2.8.3
```


I looked back at the installation guide (https://doc.sagemath.org/html/en/installation/source.html#prerequisites) and it seems that OpenSSL is recommended but not strictly required.
I personally, would like to avoid the need to install OpenSSL systemwide.

If OpenSSL is actually required (as it seems in this case), then the installation guide should be changed.
Moreover, reading both the "Install from Source Code" and "Install from Pre-built Binaries" sections I have another doubt:
the former states that it is not possible to distribute OpenSSL with Sage, yet the latter doesn't mention OpenSSL under the macOS section, so that section would also need to change.


---

Comment by dimpase created at 2020-07-12 10:49:08

We have had long discussions on OpenSSL, you can check sage-devel...

Well, thanks to Apple for breaking Python on macOS, what can I say.

You can install Homebrew Python3, so it will live in /usr/local, 
or use something like docker to test on unbroken Python, or build Sage's Python
by configuring with `--with-system-python=no` (and then you'd also need to first install Sage's openssl and pyopenssl packages)

Anyhow, just revert the change https->http, so that I can set this ticket to positive review.


---

Comment by git created at 2020-07-12 11:00:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-07-12 11:02:49

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-07-12 11:03:09

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-07-12 11:03:09

lgtm


---

Comment by slelievre created at 2020-07-12 18:22:10

Changing status from positive_review to needs_work.


---

Comment by slelievre created at 2020-07-12 18:22:10

Some more suggestions if you care. Otherwise just set back to positive review.

Remove this commented-out print (debugging leftover?)

```
        #print("LJCR with params {}, {}, 1".format(v,k))
```


Remove space before question mark:

```
-            # Is it a BIBD or just a good covering ?
+            # Is it a BIBD or just a good covering?
```


Add space around `//`:

```
-            expected_n_of_blocks = binomial(v, 2)//binomial(k, 2)
+            expected_n_of_blocks = binomial(v, 2) // binomial(k, 2)
```


Use f-strings and lowercase.

```
-                raise EmptySetError("There exists no ({},{},{})-BIBD".format(v, k, lambd))
+                raise EmptySetError(f"there exists no ({v},{k},{lambd})-BIBD")
```



---

Comment by slelievre created at 2020-07-12 18:47:30

After the class `BalancedIncompleteBlockDesign`,
an alias `BIBD = BalancedIncompleteBlockDesign`
could help shorten many long lines.


---

Comment by git created at 2020-07-12 22:22:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @Ivo-Maffei created at 2020-07-12 22:23:23

Changing status from needs_work to needs_review.


---

Comment by @Ivo-Maffei created at 2020-07-12 22:23:23

I fixed the suggested formatting and rebased the branch on 9.2.beta5


---

Comment by slelievre created at 2020-07-12 22:33:07

Looks good to me if the patchbot is happy.


---

Comment by slelievre created at 2020-07-13 08:39:14

Regarding OpenSSL for Sage on macOS, you can fix
your Sage installation using fix_mac_sage.

- https://github.com/3-manifolds/fix_mac_sage/


---

Comment by slelievre created at 2020-07-13 08:47:43

Bots are happy. Positive review.

Regarding the minor warnings:
- Pycodestyle complains about "multiple statements on one line".
  Those are not from this ticket, so they could be dealt with elsewhere.
- Pyflakes complains about the f-string, maybe it still wants py2 and py3 compatible code.


---

Comment by slelievre created at 2020-07-13 08:47:43

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2020-07-15 01:33:37

The "multiple statements on one line" are fixed at #30131.


---

Comment by git created at 2020-07-15 09:02:44

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-07-15 09:02:44

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by @Ivo-Maffei created at 2020-07-15 09:06:54

I merged the tickets because there was a merge conflict


---

Comment by dimpase created at 2020-07-15 10:21:53

coudln't

```
+    elif x <= 66:
+        t,u = 30*s+11, x-55
+    elif x <= 96:
+        t,u = 30*s+11, x-55
+    elif x <= 121:
+        t,u = 30*s+11, x-55
```

be simplified to

```
+    elif x <= 121:
+        t,u = 30*s+11, x-55
```


?


---

Comment by git created at 2020-07-15 11:51:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-07-17 08:46:23

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-07-17 08:46:23

OK, good


---

Comment by vbraun created at 2020-07-28 22:34:19

Resolution: fixed
