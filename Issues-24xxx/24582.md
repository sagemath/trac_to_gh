# Issue 24582: py3: fixes to sage.structure.sage_object

archive/issues_024345.json:
```json
{
    "assignees": [],
    "body": "Along with some related fixes to `sage.misc.explain_pickle` (which otherwise still has many failures on Python 3 due mostly to string/bytes differences).\n\nMost of these fixes have to do with pickling, especially minor differences in the API of the `pickle` module.\n\nCC:  @jdemeyer\n\nBranch/Commit: **[`d0f4a71`](https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton**\n\nAuthor: **Erik Bray**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24582_\n\n",
    "closed_at": "2018-06-29T22:34:05Z",
    "created_at": "2018-01-22T13:12:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: fixes to sage.structure.sage_object",
    "type": "issue",
    "updated_at": "2018-06-29T22:34:05Z",
    "url": "https://github.com/sagemath/sage/issues/24582",
    "user": "https://github.com/embray"
}
```
Along with some related fixes to `sage.misc.explain_pickle` (which otherwise still has many failures on Python 3 due mostly to string/bytes differences).

Most of these fixes have to do with pickling, especially minor differences in the API of the `pickle` module.

CC:  @jdemeyer

Branch/Commit: **[`d0f4a71`](https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347)**

Reviewer: **Frédéric Chapoton**

Author: **Erik Bray**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/24582_





---

archive/issue_events_340438.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-22T13:12:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340438"
}
```



---

archive/issue_events_340439.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-22T13:12:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340439"
}
```



---

archive/issue_events_340440.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-22T13:12:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340440"
}
```



---

archive/issue_events_340441.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-22T13:12:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340441"
}
```



---

archive/issue_comments_372573.json:
```json
{
    "body": "Commit: **[`b9bec31`](https://github.com/sagemath/sagetrac-mirror/commit/b9bec315533c5a7a7d600090c21699310a1a78ca)**",
    "created_at": "2018-01-22T13:12:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372573",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`b9bec31`](https://github.com/sagemath/sagetrac-mirror/commit/b9bec315533c5a7a7d600090c21699310a1a78ca)**



---

archive/issue_comments_372574.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cdb7cdffa417c27bec8cbc2a2efa91d59c8ba42a\">cdb7cdf</a></td><td><code>Some pickling/unpickling fixes:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5c163810ec7a4dcfe4bcf51cb5df14bc4b31ac4f\">5c16381</a></td><td><code>Fix several tests in this module.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3be9d8687e71e3a5e47b53b4d3ee7d96a2417884\">3be9d86</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b9bec315533c5a7a7d600090c21699310a1a78ca\">b9bec31</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr></table>\n",
    "created_at": "2018-01-22T13:12:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372574",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:1"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cdb7cdffa417c27bec8cbc2a2efa91d59c8ba42a">cdb7cdf</a></td><td><code>Some pickling/unpickling fixes:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5c163810ec7a4dcfe4bcf51cb5df14bc4b31ac4f">5c16381</a></td><td><code>Fix several tests in this module.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3be9d8687e71e3a5e47b53b4d3ee7d96a2417884">3be9d86</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b9bec315533c5a7a7d600090c21699310a1a78ca">b9bec31</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr></table>




---

archive/issue_events_340442.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-22T13:14:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340442"
}
```



---

archive/issue_comments_372575.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI haven't looked in detail, but I wonder if `SageUnpickler` could be written to work for both Python 2 and Python 3.",
    "created_at": "2018-02-13T19:35:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372575",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

I haven't looked in detail, but I wonder if `SageUnpickler` could be written to work for both Python 2 and Python 3.



---

archive/issue_comments_372576.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\ngreen bot",
    "created_at": "2018-02-14T08:47:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372576",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:5" align="right">comment:5</div>

green bot



---

archive/issue_comments_372577.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jdemeyer](#comment:4):\n> I haven't looked in detail, but I wonder if `SageUnpickler` could be written to work for both Python 2 and Python 3.\n\n*probably* not, since in Python 2 the `cPickle.Unpickler` class has some oddities, and in particular its `find_globals` attribute has some strange behavior.  But I agree it might be worth a try...",
    "created_at": "2018-02-14T15:46:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372577",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jdemeyer](#comment:4):
> I haven't looked in detail, but I wonder if `SageUnpickler` could be written to work for both Python 2 and Python 3.

*probably* not, since in Python 2 the `cPickle.Unpickler` class has some oddities, and in particular its `find_globals` attribute has some strange behavior.  But I agree it might be worth a try...



---

archive/issue_comments_372578.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOh I remember now, the only reason the tests for `SageUnpickler` even work on Python 2 is that it's subclassing the pure Python implementation in that case, which is less strange but also slower.\n\nBut perhaps I could make a single `SageUnpickler` class that delegates to the preferred underlying implementation.",
    "created_at": "2018-02-14T16:05:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372578",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Oh I remember now, the only reason the tests for `SageUnpickler` even work on Python 2 is that it's subclassing the pure Python implementation in that case, which is less strange but also slower.

But perhaps I could make a single `SageUnpickler` class that delegates to the preferred underlying implementation.



---

archive/issue_comments_372579.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nMaybe it is time to start moving forward here again ?",
    "created_at": "2018-03-11T12:38:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372579",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:8" align="right">comment:8</div>

Maybe it is time to start moving forward here again ?



---

archive/issue_comments_372580.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIn python3-sage, trying to run `./sage -t src/sage/combinat/necklace.py`:\n\n```\nFile \"src/sage/combinat/necklace.py\", line 104, in sage.combinat.necklace.Necklaces_evaluation.__init__\nFailed example:\n    N == loads(dumps(N))\nException raised:\n    Traceback (most recent call last):\n      File \"sage/structure/sage_object.pyx\", line 1456, in sage.structure.sage_object.unpickle_global (build/cythonized/sage/structure/sage_object.c:15713)\n    ModuleNotFoundError: No module named '__builtin__'\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 548, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 958, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.necklace.Necklaces_evaluation.__init__[1]>\", line 1, in <module>\n        N == loads(dumps(N))\n      File \"sage/structure/sage_object.pyx\", line 1557, in sage.structure.sage_object.loads (build/cythonized/sage/structure/sage_object.c:16726)\n      File \"sage/structure/sage_object.pyx\", line 1504, in sage.structure.sage_object.SageUnpickler.find_class (build/cythonized/sage/structure/sage_object.c:15991)\n      File \"sage/structure/sage_object.pyx\", line 1458, in sage.structure.sage_object.unpickle_global (build/cythonized/sage/structure/sage_object.c:15759)\n      File \"sage/structure/sage_object.pyx\", line 1445, in sage.structure.sage_object.unpickle_global.error (build/cythonized/sage/structure/sage_object.c:15321)\n    ImportError: cannot import getattr from __builtin__, call register_unpickle_override('__builtin__', 'getattr', ...) to fix this\n```",
    "created_at": "2018-03-11T12:40:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372580",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:9" align="right">comment:9</div>

In python3-sage, trying to run `./sage -t src/sage/combinat/necklace.py`:

```
File "src/sage/combinat/necklace.py", line 104, in sage.combinat.necklace.Necklaces_evaluation.__init__
Failed example:
    N == loads(dumps(N))
Exception raised:
    Traceback (most recent call last):
      File "sage/structure/sage_object.pyx", line 1456, in sage.structure.sage_object.unpickle_global (build/cythonized/sage/structure/sage_object.c:15713)
    ModuleNotFoundError: No module named '__builtin__'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 548, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 958, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.necklace.Necklaces_evaluation.__init__[1]>", line 1, in <module>
        N == loads(dumps(N))
      File "sage/structure/sage_object.pyx", line 1557, in sage.structure.sage_object.loads (build/cythonized/sage/structure/sage_object.c:16726)
      File "sage/structure/sage_object.pyx", line 1504, in sage.structure.sage_object.SageUnpickler.find_class (build/cythonized/sage/structure/sage_object.c:15991)
      File "sage/structure/sage_object.pyx", line 1458, in sage.structure.sage_object.unpickle_global (build/cythonized/sage/structure/sage_object.c:15759)
      File "sage/structure/sage_object.pyx", line 1445, in sage.structure.sage_object.unpickle_global.error (build/cythonized/sage/structure/sage_object.c:15321)
    ImportError: cannot import getattr from __builtin__, call register_unpickle_override('__builtin__', 'getattr', ...) to fix this
```



---

archive/issue_comments_372581.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI think I fixed that issue, but I forget what the cause was (I don't think it's related to this ticket).\n\nI started working on a `SageUnpickler` class that could work on Python 2 and 3 but it was a bit tricky, and I got sidetracked.  I'll take another shot at it though--it's certainly doable.",
    "created_at": "2018-03-12T14:08:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372581",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

I think I fixed that issue, but I forget what the cause was (I don't think it's related to this ticket).

I started working on a `SageUnpickler` class that could work on Python 2 and 3 but it was a bit tricky, and I got sidetracked.  I'll take another shot at it though--it's certainly doable.



---

archive/issue_comments_372582.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@embray](#comment:10):\n> I think I fixed that issue, but I forget what the cause was (I don't think it's related to this ticket).\n\nI remember now. It *is* related to this.  On Python 3 we generally want to pass `fix_imports=False`.  This is a trick that makes pickles created on Python 3 loadable on Python 2.  Problem is, then it *isn't* loadable on Python 3.  So at least by default we want to disable that (though we may want to accept it as an option on Python 3...)",
    "created_at": "2018-03-12T14:13:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372582",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@embray](#comment:10):
> I think I fixed that issue, but I forget what the cause was (I don't think it's related to this ticket).

I remember now. It *is* related to this.  On Python 3 we generally want to pass `fix_imports=False`.  This is a trick that makes pickles created on Python 3 loadable on Python 2.  Problem is, then it *isn't* loadable on Python 3.  So at least by default we want to disable that (though we may want to accept it as an option on Python 3...)



---

archive/issue_comments_372583.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThat, or we just use the most recent pickle protocol on Python 3--if a pickle only needs to be loadable on Python 3 then there's no reason to use protocol version=2.  But maybe we should add an option on Sage's `dumps()` option to make pickles compatible with Python 2, in which case it would use `protocol=2` and `fix_imports=True`.",
    "created_at": "2018-03-12T14:15:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372583",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

That, or we just use the most recent pickle protocol on Python 3--if a pickle only needs to be loadable on Python 3 then there's no reason to use protocol version=2.  But maybe we should add an option on Sage's `dumps()` option to make pickles compatible with Python 2, in which case it would use `protocol=2` and `fix_imports=True`.



---

archive/issue_comments_372584.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAlso, is there a reason the pickle-related functions live in `sage.structure.sage_object`?  Although the `SageObject` class has `.dumps()` and `.loads()` methods those are just wrappers for the `dumps()` and `loads()` functions.\n\nISTM the pickle-specific utilities should live elsewhere.",
    "created_at": "2018-03-12T14:21:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372584",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

Also, is there a reason the pickle-related functions live in `sage.structure.sage_object`?  Although the `SageObject` class has `.dumps()` and `.loads()` methods those are just wrappers for the `dumps()` and `loads()` functions.

ISTM the pickle-specific utilities should live elsewhere.



---

archive/issue_comments_372585.json:
```json
{
    "body": "Dependencies: **#25153**",
    "created_at": "2018-04-12T15:27:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372585",
    "user": "https://github.com/embray"
}
```

Dependencies: **#25153**



---

archive/issue_comments_372586.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nFurther work on this should probably incorporate #25153, if that ticket is accepted.",
    "created_at": "2018-04-12T15:27:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372586",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

Further work on this should probably incorporate #25153, if that ticket is accepted.



---

archive/issue_events_340443.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340443"
}
```



---

archive/issue_events_340444.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340444"
}
```



---

archive/issue_events_340445.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-04T06:49:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340445"
}
```



---

archive/issue_events_340446.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-04T06:49:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340446"
}
```



---

archive/issue_comments_372587.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nbranch does not apply",
    "created_at": "2018-06-04T06:49:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372587",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:16" align="right">comment:16</div>

branch does not apply



---

archive/issue_comments_372588.json:
```json
{
    "body": "Changed dependencies from **#25153** to none",
    "created_at": "2018-06-11T18:12:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372588",
    "user": "https://github.com/fchapoton"
}
```

Changed dependencies from **#25153** to none



---

archive/issue_comments_372589.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nMaybe this one should be given a rather high priority, no ?\n\nI see many pickling failures in the python3 doctests.",
    "created_at": "2018-06-20T18:25:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372589",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:18" align="right">comment:18</div>

Maybe this one should be given a rather high priority, no ?

I see many pickling failures in the python3 doctests.



---

archive/issue_comments_372590.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nYes, I keep picking up work on this at like...the end of the day, getting distracted by something else, and forgetting it again.  I need to re-implement the `SageUnpickler` class to work on both Python 2 and 3, which is not hard, I just...have to do it.\n\nNow that #25153 is closed that helps too.",
    "created_at": "2018-06-21T12:57:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372590",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

Yes, I keep picking up work on this at like...the end of the day, getting distracted by something else, and forgetting it again.  I need to re-implement the `SageUnpickler` class to work on both Python 2 and 3, which is not hard, I just...have to do it.

Now that #25153 is closed that helps too.



---

archive/issue_comments_372591.json:
```json
{
    "body": "Changed commit from **[`b9bec31`](https://github.com/sagemath/sagetrac-mirror/commit/b9bec315533c5a7a7d600090c21699310a1a78ca)** to **[`bbcd4b2`](https://github.com/sagemath/sagetrac-mirror/commit/bbcd4b2be8e533da0ecf7e89f30921b8184e1e94)**",
    "created_at": "2018-06-22T09:10:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372591",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b9bec31`](https://github.com/sagemath/sagetrac-mirror/commit/b9bec315533c5a7a7d600090c21699310a1a78ca)** to **[`bbcd4b2`](https://github.com/sagemath/sagetrac-mirror/commit/bbcd4b2be8e533da0ecf7e89f30921b8184e1e94)**



---

archive/issue_comments_372592.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a1e51214c3b3e57193b4d266a93c183cb22a558\">9a1e512</a></td><td><code>Some pickling/unpickling fixes:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1f7bab6ada6cd7bc9f544675d6edefa055c354da\">1f7bab6</a></td><td><code>Fix several tests in this module.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dee1576f8e3f531a86665e5bc63ffd4a94de12fe\">dee1576</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bbcd4b2be8e533da0ecf7e89f30921b8184e1e94\">bbcd4b2</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr></table>\n",
    "created_at": "2018-06-22T09:10:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372592",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a1e51214c3b3e57193b4d266a93c183cb22a558">9a1e512</a></td><td><code>Some pickling/unpickling fixes:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1f7bab6ada6cd7bc9f544675d6edefa055c354da">1f7bab6</a></td><td><code>Fix several tests in this module.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dee1576f8e3f531a86665e5bc63ffd4a94de12fe">dee1576</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bbcd4b2be8e533da0ecf7e89f30921b8184e1e94">bbcd4b2</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr></table>




---

archive/issue_comments_372593.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nSo far just rebased on #25153.  Going to look into refactoring `SageUnpickler` now.",
    "created_at": "2018-06-22T09:11:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372593",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

So far just rebased on #25153.  Going to look into refactoring `SageUnpickler` now.



---

archive/issue_comments_372594.json:
```json
{
    "body": "Changed commit from **[`bbcd4b2`](https://github.com/sagemath/sagetrac-mirror/commit/bbcd4b2be8e533da0ecf7e89f30921b8184e1e94)** to **[`1bbf457`](https://github.com/sagemath/sagetrac-mirror/commit/1bbf4573b61fdd034db9a9b4276153817f58d377)**",
    "created_at": "2018-06-22T09:44:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372594",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`bbcd4b2`](https://github.com/sagemath/sagetrac-mirror/commit/bbcd4b2be8e533da0ecf7e89f30921b8184e1e94)** to **[`1bbf457`](https://github.com/sagemath/sagetrac-mirror/commit/1bbf4573b61fdd034db9a9b4276153817f58d377)**



---

archive/issue_comments_372595.json:
```json
{
    "body": "<div id=\"comment:22\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/687357681bd019c0a08662b17f606837ba315222\">6873576</a></td><td><code>Some pickling/unpickling fixes:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/deaab79198c0ef3a82095a48351a9a500d8466b6\">deaab79</a></td><td><code>Fix several tests in this module.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/faf0c86642ca4dfe01f58449ce86e26ab580845a\">faf0c86</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1bbf4573b61fdd034db9a9b4276153817f58d377\">1bbf457</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr></table>\n",
    "created_at": "2018-06-22T09:44:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372595",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/687357681bd019c0a08662b17f606837ba315222">6873576</a></td><td><code>Some pickling/unpickling fixes:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/deaab79198c0ef3a82095a48351a9a500d8466b6">deaab79</a></td><td><code>Fix several tests in this module.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/faf0c86642ca4dfe01f58449ce86e26ab580845a">faf0c86</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1bbf4573b61fdd034db9a9b4276153817f58d377">1bbf457</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr></table>




---

archive/issue_comments_372596.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/25321fc59e3bec97c0727d59c854211e10ce9b56\">25321fc</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90c8361ace22f95c50edc42a78b2faa37662fa62\">90c8361</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/615b75e567508e54f343d0e63bfeb3f82aa89a97\">615b75e</a></td><td><code>Repackaged Sage-specific pickling/unpickling behavior in SagePickle and</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0014f29a346244db089f9ce9fb2b486d4c0f94d3\">0014f29</a></td><td><code>on Python 2 the return values of these methods is the Pickler object itself which, while useful for chaining</code></td></tr></table>\n",
    "created_at": "2018-06-22T13:55:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372596",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/25321fc59e3bec97c0727d59c854211e10ce9b56">25321fc</a></td><td><code>miscellaneous cleanup; some PEP-8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90c8361ace22f95c50edc42a78b2faa37662fa62">90c8361</a></td><td><code>SageUnpickler didn't work for Python since cPickle.Unpickle is not a class</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/615b75e567508e54f343d0e63bfeb3f82aa89a97">615b75e</a></td><td><code>Repackaged Sage-specific pickling/unpickling behavior in SagePickle and</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0014f29a346244db089f9ce9fb2b486d4c0f94d3">0014f29</a></td><td><code>on Python 2 the return values of these methods is the Pickler object itself which, while useful for chaining</code></td></tr></table>




---

archive/issue_comments_372597.json:
```json
{
    "body": "Changed commit from **[`1bbf457`](https://github.com/sagemath/sagetrac-mirror/commit/1bbf4573b61fdd034db9a9b4276153817f58d377)** to **[`0014f29`](https://github.com/sagemath/sagetrac-mirror/commit/0014f29a346244db089f9ce9fb2b486d4c0f94d3)**",
    "created_at": "2018-06-22T13:55:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372597",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1bbf457`](https://github.com/sagemath/sagetrac-mirror/commit/1bbf4573b61fdd034db9a9b4276153817f58d377)** to **[`0014f29`](https://github.com/sagemath/sagetrac-mirror/commit/0014f29a346244db089f9ce9fb2b486d4c0f94d3)**



---

archive/issue_comments_372598.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nOk, I reworked `SageUnpickler` so that it works on both Python 2 and 3 (most of the Python-specific differences are pushed down to a `_BaseUnpickler` class that bracketed by an `IF PY_MAJOR_VERSION == 2` statement in the Cython code).\n\nFor symmetry's sake I also added a `SagePickler` class which encapsulates the default pickling behavior we want (for now, always use pickle protocol 2, with `fix_imports=True` on Python 3).  The intent is to have the best possible pickle compatibility between Python 2 and 3.  This is hard to test though--to do so we might have to make a few sample pickles (enough to test things like import fixups and str/bytes issues but not as many as comprehensive as the old picklejar) on both Python 2 and 3 and ensure that they can be loaded.",
    "created_at": "2018-06-22T14:01:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372598",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Ok, I reworked `SageUnpickler` so that it works on both Python 2 and 3 (most of the Python-specific differences are pushed down to a `_BaseUnpickler` class that bracketed by an `IF PY_MAJOR_VERSION == 2` statement in the Cython code).

For symmetry's sake I also added a `SagePickler` class which encapsulates the default pickling behavior we want (for now, always use pickle protocol 2, with `fix_imports=True` on Python 3).  The intent is to have the best possible pickle compatibility between Python 2 and 3.  This is hard to test though--to do so we might have to make a few sample pickles (enough to test things like import fixups and str/bytes issues but not as many as comprehensive as the old picklejar) on both Python 2 and 3 and ensure that they can be loaded.



---

archive/issue_events_340447.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-06-22T14:01:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340447"
}
```



---

archive/issue_events_340448.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-06-22T14:01:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340448"
}
```



---

archive/issue_comments_372599.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\ndoc does not build\n\n```\ndocstring of sage.misc.persist.SageUnpickler:21: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n```\n\nmaybe because of\n\n```\n+      `pickle.Unpickler constructor.\n```",
    "created_at": "2018-06-25T08:45:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372599",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:25" align="right">comment:25</div>

doc does not build

```
docstring of sage.misc.persist.SageUnpickler:21: WARNING: Inline interpreted text or phrase reference start-string without end-string.
```

maybe because of

```
+      `pickle.Unpickler constructor.
```



---

archive/issue_events_340449.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-25T08:45:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340449"
}
```



---

archive/issue_events_340450.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-25T08:45:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340450"
}
```



---

archive/issue_comments_372600.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI was afraid of that.  I need to get better about testing the doc build when I add any significant quantity of docstrings...",
    "created_at": "2018-06-25T09:16:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372600",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

I was afraid of that.  I need to get better about testing the doc build when I add any significant quantity of docstrings...



---

archive/issue_comments_372601.json:
```json
{
    "body": "<div id=\"comment:27\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/259ea80aa5a5c6c9f9d3a6fb9f8ad5e901155f3f\">259ea80</a></td><td><code>on Python 2 the return values of these methods is the Pickler object itself which, while useful for chaining</code></td></tr></table>\n",
    "created_at": "2018-06-25T09:21:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372601",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:27"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/259ea80aa5a5c6c9f9d3a6fb9f8ad5e901155f3f">259ea80</a></td><td><code>on Python 2 the return values of these methods is the Pickler object itself which, while useful for chaining</code></td></tr></table>




---

archive/issue_comments_372602.json:
```json
{
    "body": "Changed commit from **[`0014f29`](https://github.com/sagemath/sagetrac-mirror/commit/0014f29a346244db089f9ce9fb2b486d4c0f94d3)** to **[`259ea80`](https://github.com/sagemath/sagetrac-mirror/commit/259ea80aa5a5c6c9f9d3a6fb9f8ad5e901155f3f)**",
    "created_at": "2018-06-25T09:21:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372602",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0014f29`](https://github.com/sagemath/sagetrac-mirror/commit/0014f29a346244db089f9ce9fb2b486d4c0f94d3)** to **[`259ea80`](https://github.com/sagemath/sagetrac-mirror/commit/259ea80aa5a5c6c9f9d3a6fb9f8ad5e901155f3f)**



---

archive/issue_events_340451.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-06-25T10:03:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340451"
}
```



---

archive/issue_events_340452.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-06-25T10:03:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340452"
}
```



---

archive/issue_comments_372603.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nDocs work now.",
    "created_at": "2018-06-25T10:03:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372603",
    "user": "https://github.com/embray"
}
```

<div id="comment:28" align="right">comment:28</div>

Docs work now.



---

archive/issue_comments_372604.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\npyflakes plugin is not happy",
    "created_at": "2018-06-25T12:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372604",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:29" align="right">comment:29</div>

pyflakes plugin is not happy



---

archive/issue_events_340453.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-25T14:54:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340453"
}
```



---

archive/issue_events_340454.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-25T14:54:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340454"
}
```



---

archive/issue_comments_372605.json:
```json
{
    "body": "Changed commit from **[`259ea80`](https://github.com/sagemath/sagetrac-mirror/commit/259ea80aa5a5c6c9f9d3a6fb9f8ad5e901155f3f)** to **[`94f12b4`](https://github.com/sagemath/sagetrac-mirror/commit/94f12b4b87e80088fee0d2b4408932e7887c4148)**",
    "created_at": "2018-06-25T15:43:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372605",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`259ea80`](https://github.com/sagemath/sagetrac-mirror/commit/259ea80aa5a5c6c9f9d3a6fb9f8ad5e901155f3f)** to **[`94f12b4`](https://github.com/sagemath/sagetrac-mirror/commit/94f12b4b87e80088fee0d2b4408932e7887c4148)**



---

archive/issue_comments_372606.json:
```json
{
    "body": "<div id=\"comment:31\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/94f12b4b87e80088fee0d2b4408932e7887c4148\">94f12b4</a></td><td><code>removed unused import</code></td></tr></table>\n",
    "created_at": "2018-06-25T15:43:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372606",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/94f12b4b87e80088fee0d2b4408932e7887c4148">94f12b4</a></td><td><code>removed unused import</code></td></tr></table>




---

archive/issue_events_340455.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-06-25T15:44:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340455"
}
```



---

archive/issue_events_340456.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-06-25T15:44:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340456"
}
```



---

archive/issue_comments_372607.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nDo we know if this fixes some/most/all of the python3 pickling issues ?",
    "created_at": "2018-06-26T07:19:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372607",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:33" align="right">comment:33</div>

Do we know if this fixes some/most/all of the python3 pickling issues ?



---

archive/issue_comments_372608.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nThis does not fix the pickle issue with python 3, though the error changes. \nMy touchstone file is `./sage -t src/sage/combinat/interval_posets.py`\nand there:\n\n```\n   Failure in _test_elements\n    The following tests failed: _test_elements\n      Failure in _test_pickling:\n      Traceback (most recent call last):\n        File \"sage/misc/persist.pyx\", line 540, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5187)\n          __import__(module)\n      ModuleNotFoundError: No module named '__builtin__'\n    <BLANKLINE>\n      During handling of the above exception, another exception occurred:\n    <BLANKLINE>\n      Traceback (most recent call last):\n        File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/sage_unittest.py\", line 294, in run\n          test_method(tester = tester)\n        File \"sage/structure/sage_object.pyx\", line 683, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5024)\n          tester.assertEqual(loads(dumps(self)), self)\n        File \"sage/misc/persist.pyx\", line 960, in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7648)\n          return unpickler.load()\n        File \"sage/misc/persist.pyx\", line 736, in sage.misc.persist._BaseUnpickler.find_class (build/cythonized/sage/misc/persist.c:6386)\n          return unpickle_global(module, name)\n        File \"sage/misc/persist.pyx\", line 542, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5232)\n          error()\n        File \"sage/misc/persist.pyx\", line 529, in sage.misc.persist.unpickle_global.error (build/cythonized/sage/misc/persist.c:4797)\n          raise ImportError(\"cannot import {1} from {0}, call \"\n      ImportError: cannot import getattr from __builtin__, call register_unpickle_override('__builtin__', 'getattr', ...) to fix this\n```",
    "created_at": "2018-06-27T07:00:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372608",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:34" align="right">comment:34</div>

This does not fix the pickle issue with python 3, though the error changes. 
My touchstone file is `./sage -t src/sage/combinat/interval_posets.py`
and there:

```
   Failure in _test_elements
    The following tests failed: _test_elements
      Failure in _test_pickling:
      Traceback (most recent call last):
        File "sage/misc/persist.pyx", line 540, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5187)
          __import__(module)
      ModuleNotFoundError: No module named '__builtin__'
    <BLANKLINE>
      During handling of the above exception, another exception occurred:
    <BLANKLINE>
      Traceback (most recent call last):
        File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/sage_unittest.py", line 294, in run
          test_method(tester = tester)
        File "sage/structure/sage_object.pyx", line 683, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5024)
          tester.assertEqual(loads(dumps(self)), self)
        File "sage/misc/persist.pyx", line 960, in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7648)
          return unpickler.load()
        File "sage/misc/persist.pyx", line 736, in sage.misc.persist._BaseUnpickler.find_class (build/cythonized/sage/misc/persist.c:6386)
          return unpickle_global(module, name)
        File "sage/misc/persist.pyx", line 542, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5232)
          error()
        File "sage/misc/persist.pyx", line 529, in sage.misc.persist.unpickle_global.error (build/cythonized/sage/misc/persist.c:4797)
          raise ImportError("cannot import {1} from {0}, call "
      ImportError: cannot import getattr from __builtin__, call register_unpickle_override('__builtin__', 'getattr', ...) to fix this
```



---

archive/issue_comments_372609.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nThis certainly lays the groundwork to fix issues like that, but I'll have a look at whatever's going on there.\n\nThe above issue is that it's creating pickles with Python 2 backwards-compatibility (the `fix_imports=True` argument to `pickle.dumps`).  However, the reverse should also work when loading such pickles on Python 3.",
    "created_at": "2018-06-27T12:14:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372609",
    "user": "https://github.com/embray"
}
```

<div id="comment:35" align="right">comment:35</div>

This certainly lays the groundwork to fix issues like that, but I'll have a look at whatever's going on there.

The above issue is that it's creating pickles with Python 2 backwards-compatibility (the `fix_imports=True` argument to `pickle.dumps`).  However, the reverse should also work when loading such pickles on Python 3.



---

archive/issue_comments_372610.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nAhah, I think I see the problem.  The `fix_imports` stuff is actually implemented as the base implementation of `find_class` which we outright override.  For it to work we still need to call the base class's `find_class`.",
    "created_at": "2018-06-27T12:27:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372610",
    "user": "https://github.com/embray"
}
```

<div id="comment:36" align="right">comment:36</div>

Ahah, I think I see the problem.  The `fix_imports` stuff is actually implemented as the base implementation of `find_class` which we outright override.  For it to work we still need to call the base class's `find_class`.



---

archive/issue_comments_372611.json:
```json
{
    "body": "<div id=\"comment:37\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347\">d0f4a71</a></td><td><code>turns out the Unpickler.find_class method in the base class actually does something on Python 3: It's where all the fix_imports stuff is impemented, so must call it to support that</code></td></tr></table>\n",
    "created_at": "2018-06-27T13:25:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372611",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:37"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347">d0f4a71</a></td><td><code>turns out the Unpickler.find_class method in the base class actually does something on Python 3: It's where all the fix_imports stuff is impemented, so must call it to support that</code></td></tr></table>




---

archive/issue_comments_372612.json:
```json
{
    "body": "Changed commit from **[`94f12b4`](https://github.com/sagemath/sagetrac-mirror/commit/94f12b4b87e80088fee0d2b4408932e7887c4148)** to **[`d0f4a71`](https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347)**",
    "created_at": "2018-06-27T13:25:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372612",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`94f12b4`](https://github.com/sagemath/sagetrac-mirror/commit/94f12b4b87e80088fee0d2b4408932e7887c4148)** to **[`d0f4a71`](https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347)**



---

archive/issue_comments_372613.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nThis should fix it.  I confirmed that `./sage -t src/sage/combinat/interval_posets.py` works (as should other tests plagued by the same problem).",
    "created_at": "2018-06-27T13:25:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372613",
    "user": "https://github.com/embray"
}
```

<div id="comment:38" align="right">comment:38</div>

This should fix it.  I confirmed that `./sage -t src/sage/combinat/interval_posets.py` works (as should other tests plagued by the same problem).



---

archive/issue_comments_372614.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2018-06-27T19:35:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372614",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton**



---

archive/issue_events_340457.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-27T19:35:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340457"
}
```



---

archive/issue_events_340458.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-27T19:35:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340458"
}
```



---

archive/issue_comments_372615.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nI am ready to give it a try.",
    "created_at": "2018-06-27T19:35:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372615",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:39" align="right">comment:39</div>

I am ready to give it a try.



---

archive/issue_comments_372616.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/sage-structure-sage_object](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/sage-structure-sage_object)** to **[`d0f4a71`](https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347)**",
    "created_at": "2018-06-29T22:34:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24582#issuecomment-372616",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/python3/sage-structure-sage_object](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/sage-structure-sage_object)** to **[`d0f4a71`](https://github.com/sagemath/sagetrac-mirror/commit/d0f4a71867a8acf5056f188192a3633b607c9347)**



---

archive/issue_events_340459.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-29T22:34:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340459"
}
```



---

archive/issue_events_340460.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "8052b7fab2594b80ad608e363561059fa4ea1a20",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-06-29T22:34:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24582",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24582#event-340460"
}
```
