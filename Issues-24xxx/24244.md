# Issue 24244: Fast check for C long

archive/issues_024007.json:
```json
{
    "body": "Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`.\n\nThe goal of these functions is to provide a single place to check for integers and convert them to a C `long` (at least in Cython code, where performance matters most). Various places in Sage check for integers in different ways. First of all, this is an inconsistency which should be fixed.\n\nIn Python 3, the types `int`/`long` are changed, so many of the existing checks will need to be changed anyway. So we might as well provide one function which should be able to replace most of these checks. And ideally, we want to do this without losing too much performance. For that reason, I avoid `PyLong_FromLong` in favour of a hand-written implementation.\n\nThe function `pyobject_to_long` has signature\n\n```\ncdef bint integer_check_long(x, long* value, int* err)\n```\nIt does several things: first of all, it checks whether `x` is \"integer-like\". This means that it is either a Python `int` or `long`, a Sage `Integer` or it supports `__index__`. The return value of the function is whether or not it is an integer. If it is an integer, it tries to convert the value to a C `long` and stores it in `*value`. Errors are passed through the `*err` variable.\n\nThis interface looks overcomplicated on first sight, but the complexity is needed to support the various use cases of this function. Also note that it is an `inline` function, so the compiler should be able to optimize away the unused variables.\n\nUse case 1: a function can take different kinds of input and want to check whether the input is an integer. Typically, this would be done with a long `if` chain like\n\n```\nif isinstance(x, ...):\n    ...\nelif isinstance(x, ...):\n    ...\nelif integer_check_long(x, &value, &err):\n    # Process value and err as needed\nelif isinstance(x, ...):\n    ...\n```\n\nUse case 2: convert an integer to a C `long` purely for performance. In this case, you want to treat overflow the same as the input not being an integer:\n\n```\ncdef int err = -1\ninteger_check_long(x, &value, &err)\nif err == 0:\n    # Conversion successful, use value\n```\n\n**Branch:** [70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Jeroen Demeyer\n\n**Dependencies:** #24252\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24244\n\n",
    "closed_at": "2017-12-13T17:38:17Z",
    "created_at": "2017-11-19T19:03:19Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fast check for C long",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24244",
    "user": "https://github.com/jdemeyer"
}
```
Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`.

The goal of these functions is to provide a single place to check for integers and convert them to a C `long` (at least in Cython code, where performance matters most). Various places in Sage check for integers in different ways. First of all, this is an inconsistency which should be fixed.

In Python 3, the types `int`/`long` are changed, so many of the existing checks will need to be changed anyway. So we might as well provide one function which should be able to replace most of these checks. And ideally, we want to do this without losing too much performance. For that reason, I avoid `PyLong_FromLong` in favour of a hand-written implementation.

The function `pyobject_to_long` has signature

```
cdef bint integer_check_long(x, long* value, int* err)
```
It does several things: first of all, it checks whether `x` is "integer-like". This means that it is either a Python `int` or `long`, a Sage `Integer` or it supports `__index__`. The return value of the function is whether or not it is an integer. If it is an integer, it tries to convert the value to a C `long` and stores it in `*value`. Errors are passed through the `*err` variable.

This interface looks overcomplicated on first sight, but the complexity is needed to support the various use cases of this function. Also note that it is an `inline` function, so the compiler should be able to optimize away the unused variables.

Use case 1: a function can take different kinds of input and want to check whether the input is an integer. Typically, this would be done with a long `if` chain like

```
if isinstance(x, ...):
    ...
elif isinstance(x, ...):
    ...
elif integer_check_long(x, &value, &err):
    # Process value and err as needed
elif isinstance(x, ...):
    ...
```

Use case 2: convert an integer to a C `long` purely for performance. In this case, you want to treat overflow the same as the input not being an integer:

```
cdef int err = -1
integer_check_long(x, &value, &err)
if err == 0:
    # Conversion successful, use value
```

**Branch:** [70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)

**Reviewer:** Travis Scrimshaw

**Author:** Jeroen Demeyer

**Dependencies:** #24252

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/24244





---

archive/issue_comments_461022.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/fast_check_for_c_long](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fast_check_for_c_long)",
    "created_at": "2017-11-19T20:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461022",
    "user": "https://github.com/jdemeyer"
}
```


**Branch:** [u/jdemeyer/fast_check_for_c_long](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fast_check_for_c_long)



---

archive/issue_comments_461023.json:
```json
{
    "body": "**Commit:** [dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d](https://github.com/sagemath/sagetrac-mirror/commit/dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d)",
    "created_at": "2017-11-20T09:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461023",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Commit:** [dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d](https://github.com/sagemath/sagetrac-mirror/commit/dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d)



---

archive/issue_comments_461024.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eeee3de396e314f33cd4c907be4999b115f96c84\">eeee3de</a></td><td><code>Move long.pxd to arith</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d\">dd27cd5</a></td><td><code>New function integer_check_long()</code></td></tr></table>\n",
    "created_at": "2017-11-20T09:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eeee3de396e314f33cd4c907be4999b115f96c84">eeee3de</a></td><td><code>Move long.pxd to arith</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d">dd27cd5</a></td><td><code>New function integer_check_long()</code></td></tr></table>




---

archive/issue_comments_461025.json:
```json
{
    "body": "**Dependencies:** #24245",
    "created_at": "2017-11-20T09:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461025",
    "user": "https://github.com/jdemeyer"
}
```


**Dependencies:** #24245



---

archive/issue_comments_461026.json:
```json
{
    "body": "**Changing commit** from \"[dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d](https://github.com/sagemath/sagetrac-mirror/commit/dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d)\" to \"[b1ea838fc07baf8d6247a15f8db067ade9596e4a](https://github.com/sagemath/sagetrac-mirror/commit/b1ea838fc07baf8d6247a15f8db067ade9596e4a)\".",
    "created_at": "2017-11-20T10:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461026",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d](https://github.com/sagemath/sagetrac-mirror/commit/dd27cd5b59823f5f5ff7c1a80d0afc962c29dc7d)" to "[b1ea838fc07baf8d6247a15f8db067ade9596e4a](https://github.com/sagemath/sagetrac-mirror/commit/b1ea838fc07baf8d6247a15f8db067ade9596e4a)".



---

archive/issue_comments_461027.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b1ea838fc07baf8d6247a15f8db067ade9596e4a\">b1ea838</a></td><td><code>New functions integer_check_long() and integer_check_long_py()</code></td></tr></table>\n",
    "created_at": "2017-11-20T10:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461027",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b1ea838fc07baf8d6247a15f8db067ade9596e4a">b1ea838</a></td><td><code>New functions integer_check_long() and integer_check_long_py()</code></td></tr></table>




---

archive/issue_comments_461028.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2017-11-20T10:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461028",
    "user": "https://github.com/jdemeyer"
}
```


**Changing status** from new to needs_review.



---

archive/issue_comments_461029.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2017-11-20T16:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461029",
    "user": "https://github.com/jdemeyer"
}
```


**Changing status** from needs_review to needs_work.



---

archive/issue_comments_461030.json:
```json
{
    "body": "**Changing dependencies** from \"#24245\" to \"#24252\".",
    "created_at": "2017-11-20T16:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461030",
    "user": "https://github.com/jdemeyer"
}
```


**Changing dependencies** from "#24245" to "#24252".



---

archive/issue_comments_461031.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bb114c91736f48e5854613ae438377ed7f032b7e\">bb114c9</a></td><td><code>Fake Integer interface</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4d76bc133b7b93cf3a3baaad782caedee692ae0a\">4d76bc1</a></td><td><code>New functions integer_check_long() and integer_check_long_py()</code></td></tr></table>\n",
    "created_at": "2017-11-20T18:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bb114c91736f48e5854613ae438377ed7f032b7e">bb114c9</a></td><td><code>Fake Integer interface</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4d76bc133b7b93cf3a3baaad782caedee692ae0a">4d76bc1</a></td><td><code>New functions integer_check_long() and integer_check_long_py()</code></td></tr></table>




---

archive/issue_comments_461032.json:
```json
{
    "body": "**Changing commit** from \"[b1ea838fc07baf8d6247a15f8db067ade9596e4a](https://github.com/sagemath/sagetrac-mirror/commit/b1ea838fc07baf8d6247a15f8db067ade9596e4a)\" to \"[4d76bc133b7b93cf3a3baaad782caedee692ae0a](https://github.com/sagemath/sagetrac-mirror/commit/4d76bc133b7b93cf3a3baaad782caedee692ae0a)\".",
    "created_at": "2017-11-20T18:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461032",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[b1ea838fc07baf8d6247a15f8db067ade9596e4a](https://github.com/sagemath/sagetrac-mirror/commit/b1ea838fc07baf8d6247a15f8db067ade9596e4a)" to "[4d76bc133b7b93cf3a3baaad782caedee692ae0a](https://github.com/sagemath/sagetrac-mirror/commit/4d76bc133b7b93cf3a3baaad782caedee692ae0a)".



---

archive/issue_comments_461033.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2017-11-20T18:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461033",
    "user": "https://github.com/jdemeyer"
}
```


**Changing status** from needs_work to needs_review.



---

archive/issue_comments_461034.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think it would be better if `integer_check_long` and `integer_check_long_py` returned the error and `0` if it was completely successful. Then `pyobject_to_long` would then interpret the error using the `enum` and do the correct Python error raising. I feel like you are basically doing this, but in a roundabout way by passing `err`.",
    "created_at": "2017-11-20T23:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461034",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:9'></a>
I think it would be better if `integer_check_long` and `integer_check_long_py` returned the error and `0` if it was completely successful. Then `pyobject_to_long` would then interpret the error using the `enum` and do the correct Python error raising. I feel like you are basically doing this, but in a roundabout way by passing `err`.



---

archive/issue_comments_461035.json:
```json
{
    "body": "<a id='comment:10'></a>\nAlso, in #24248, you do not even use the return `bint` of `integer_check_long_py`.",
    "created_at": "2017-11-20T23:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461035",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:10'></a>
Also, in #24248, you do not even use the return `bint` of `integer_check_long_py`.



---

archive/issue_comments_461036.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,36 @@\n-Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`. This will help porting to Python 3 without losing too much performance.\n+Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`.\n+\n+The goal of these functions is to provide a single place to check for integers and convert them to a C `long` (at least in Cython code, where performance matters most). Various places in Sage check for integers in different ways. First of all, this is an inconsistency which should be fixed.\n+\n+In Python 3, the types `int`/`long` are changed, so many of the existing checks will need to be changed anyway. So we might as well provide one function which should be able to replace most of these checks. And ideally, we want to do this without losing too much performance. For that reason, I avoid `PyLong_FromLong` in favour of a hand-written implementation.\n+\n+The function `pyobject_to_long` has signature\n+\n+```\n+cdef bint integer_check_long(x, long* value, int* err)\n+```\n+It does several things: first of all, it checks whether `x` is \"integer-like\". This means that it is either a Python `int` or `long`, a Sage `Integer` or it supports `__index__`. The return value of the function is whether or not it is an integer. If it is an integer, it tries to convert the value to a C `long` and stores it in `*value`. Errors are passed through the `*err` variable.\n+\n+This interface looks overcomplicated on first sight, but the complexity is needed to support the various use cases of this function. Also note that it is an `inline` function, so the compiler should be able to optimize away the unused variables.\n+\n+Use case 1: a function can take different kinds of input and want to check whether the input is an integer. Typically, this would be done with a long `if` chain like\n+\n+```\n+if isinstance(x, ...):\n+    ...\n+elif isinstance(x, ...):\n+    ...\n+elif integer_check_long(x, &value, &err):\n+    # Process value and err as needed\n+elif isinstance(x, ...):\n+    ...\n+```\n+\n+Use case 2: convert an integer to a C `long` purely for performance. In this case, you want to treat overflow the same as the input not being an integer:\n+\n+```\n+cdef int err = -1\n+integer_check_long(x, &value, &err)\n+if err == 0:\n+    # Conversion successful, use value\n+```\n``````\n",
    "created_at": "2017-11-21T08:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461036",
    "user": "https://github.com/jdemeyer"
}
```


**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,36 @@
-Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`. This will help porting to Python 3 without losing too much performance.
+Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`.
+
+The goal of these functions is to provide a single place to check for integers and convert them to a C `long` (at least in Cython code, where performance matters most). Various places in Sage check for integers in different ways. First of all, this is an inconsistency which should be fixed.
+
+In Python 3, the types `int`/`long` are changed, so many of the existing checks will need to be changed anyway. So we might as well provide one function which should be able to replace most of these checks. And ideally, we want to do this without losing too much performance. For that reason, I avoid `PyLong_FromLong` in favour of a hand-written implementation.
+
+The function `pyobject_to_long` has signature
+
+```
+cdef bint integer_check_long(x, long* value, int* err)
+```
+It does several things: first of all, it checks whether `x` is "integer-like". This means that it is either a Python `int` or `long`, a Sage `Integer` or it supports `__index__`. The return value of the function is whether or not it is an integer. If it is an integer, it tries to convert the value to a C `long` and stores it in `*value`. Errors are passed through the `*err` variable.
+
+This interface looks overcomplicated on first sight, but the complexity is needed to support the various use cases of this function. Also note that it is an `inline` function, so the compiler should be able to optimize away the unused variables.
+
+Use case 1: a function can take different kinds of input and want to check whether the input is an integer. Typically, this would be done with a long `if` chain like
+
+```
+if isinstance(x, ...):
+    ...
+elif isinstance(x, ...):
+    ...
+elif integer_check_long(x, &value, &err):
+    # Process value and err as needed
+elif isinstance(x, ...):
+    ...
+```
+
+Use case 2: convert an integer to a C `long` purely for performance. In this case, you want to treat overflow the same as the input not being an integer:
+
+```
+cdef int err = -1
+integer_check_long(x, &value, &err)
+if err == 0:
+    # Conversion successful, use value
+```
``````




---

archive/issue_comments_461037.json:
```json
{
    "body": "**Changing commit** from \"[4d76bc133b7b93cf3a3baaad782caedee692ae0a](https://github.com/sagemath/sagetrac-mirror/commit/4d76bc133b7b93cf3a3baaad782caedee692ae0a)\" to \"[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)\".",
    "created_at": "2017-11-21T09:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461037",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[4d76bc133b7b93cf3a3baaad782caedee692ae0a](https://github.com/sagemath/sagetrac-mirror/commit/4d76bc133b7b93cf3a3baaad782caedee692ae0a)" to "[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)".



---

archive/issue_comments_461038.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f\">70592a8</a></td><td><code>Fix compiler warning</code></td></tr></table>\n",
    "created_at": "2017-11-21T09:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461038",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f">70592a8</a></td><td><code>Fix compiler warning</code></td></tr></table>




---

archive/issue_comments_461039.json:
```json
{
    "body": "<a id='comment:13'></a>\nUse case 2 could just become:\n\n```\nif integer_check_long(x, &value) == 0:\n    # Conversion successful, use value\n```\nwhich feels much more natural to me.\n\nHowever, I agree that use case 1 is a bit more of a hassle because you could not subsequently assign the error message (this wouldn't be a problem in, e.g., C because of the looser syntax rules). Although you can get around this by expanding out the `elif` as an `else-if` (but it looks fugly). Do you have a specific case where this does come up?",
    "created_at": "2017-11-22T05:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461039",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:13'></a>
Use case 2 could just become:

```
if integer_check_long(x, &value) == 0:
    # Conversion successful, use value
```
which feels much more natural to me.

However, I agree that use case 1 is a bit more of a hassle because you could not subsequently assign the error message (this wouldn't be a problem in, e.g., C because of the looser syntax rules). Although you can get around this by expanding out the `elif` as an `else-if` (but it looks fugly). Do you have a specific case where this does come up?



---

archive/issue_comments_461040.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [tscrim](#comment%3A13):\n> Use case 2 could just become:\n> \n> ```\n> if integer_check_long(x, &value) == 0:\n>     # Conversion successful, use value\n> ```\n> which feels much more natural to me.\n\n\nSure, I can simplify use case 1 and use case 2 individually. But I see no way to simplify things in such a way that both use cases still work. Alternatively, I could simply add another layer for use case 2 and make a new function\n> \n> ```\n> if integer_check_long_no_overflow(x, &value):\n>     # Conversion successful, use value\n> ```\n\n\nFinally, let me stress that this complexity shouldn't affect performance since we are dealing with `inline` functions and compilers are good at optimization.",
    "created_at": "2017-11-22T07:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461040",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:14'></a>
Replying to [tscrim](#comment%3A13):
> Use case 2 could just become:
> 
> ```
> if integer_check_long(x, &value) == 0:
>     # Conversion successful, use value
> ```
> which feels much more natural to me.


Sure, I can simplify use case 1 and use case 2 individually. But I see no way to simplify things in such a way that both use cases still work. Alternatively, I could simply add another layer for use case 2 and make a new function
> 
> ```
> if integer_check_long_no_overflow(x, &value):
>     # Conversion successful, use value
> ```


Finally, let me stress that this complexity shouldn't affect performance since we are dealing with `inline` functions and compilers are good at optimization.



---

archive/issue_comments_461041.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [tscrim](#comment%3A13):\n> Do you have a specific case where this does come up?\n\n\nI don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.",
    "created_at": "2017-11-22T08:09:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461041",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:15'></a>
Replying to [tscrim](#comment%3A13):
> Do you have a specific case where this does come up?


I don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.



---

archive/issue_comments_461042.json:
```json
{
    "body": "<a id='comment:16'></a>\nLet me know what you would suggest to do with this ticket.",
    "created_at": "2017-11-22T08:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461042",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:16'></a>
Let me know what you would suggest to do with this ticket.



---

archive/issue_comments_461043.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2017-11-22T22:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461043",
    "user": "https://github.com/tscrim"
}
```


**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_461044.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [jdemeyer](#comment%3A15):\n> Replying to [tscrim](#comment%3A13):\n> > Do you have a specific case where this does come up?\n\n> \n> I don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.\n\n\nDo you have a place on a future ticket where use case 1 applies? I see use case 2 on #24247 and this one:\n\n```python\n            if integer_check_long_py(right, &value, &err):\n                if not err:\n                    return (<Element>left)._pow_long(value)\n                else:\n                    return (<Element>left)._pow_int(right)\n```\nwhich could be simplified to\n\n```python\n            err = integer_check_long_py(right, &value):\n            if not err:\n                return (<Element>left)._pow_long(value)\n            elif err == ERR_OVERFLOW:\n                return (<Element>left)._pow_int(right)\n```\n\nHowever, if you see a clear benefit to take on the more complicated function description and return values, then you can set this to a positive review. I just am thinking a little bit about the potential future maintenance of this function (I also don't think there will be any [noticeable] performance difference) and the places where it is used.",
    "created_at": "2017-11-22T22:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461044",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:17'></a>
Replying to [jdemeyer](#comment%3A15):
> Replying to [tscrim](#comment%3A13):
> > Do you have a specific case where this does come up?

> 
> I don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.


Do you have a place on a future ticket where use case 1 applies? I see use case 2 on #24247 and this one:

```python
            if integer_check_long_py(right, &value, &err):
                if not err:
                    return (<Element>left)._pow_long(value)
                else:
                    return (<Element>left)._pow_int(right)
```
which could be simplified to

```python
            err = integer_check_long_py(right, &value):
            if not err:
                return (<Element>left)._pow_long(value)
            elif err == ERR_OVERFLOW:
                return (<Element>left)._pow_int(right)
```

However, if you see a clear benefit to take on the more complicated function description and return values, then you can set this to a positive review. I just am thinking a little bit about the potential future maintenance of this function (I also don't think there will be any [noticeable] performance difference) and the places where it is used.



---

archive/issue_comments_461045.json:
```json
{
    "body": "<a id='comment:18'></a>\nHere is a concrete proposal: we keep the complicated signature for now (if anything, simply to prevent conflicts with current tickets depending on this one). Once we have a clearer idea on how these functions are used, we can revisit and change things if needed.",
    "created_at": "2017-11-23T09:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461045",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:18'></a>
Here is a concrete proposal: we keep the complicated signature for now (if anything, simply to prevent conflicts with current tickets depending on this one). Once we have a clearer idea on how these functions are used, we can revisit and change things if needed.



---

archive/issue_comments_461046.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [tscrim](#comment%3A17):\n> I also don't think there will be any [noticeable] performance difference\n\n\nFun observation: compiler warnings can be used to get data on how the compiler is able to optimize the code. For example, in #24247 I'm writing essentially\n\n```\n        cdef long value\n        cdef int err\n        if integer_check_long(y, &value, &err):\n            if not err:\n                return (<Element>x)._pow_long(value)\n```\nIn this case, the compiler *does not give a warning* that `err` and `value` might be uninitialized. This means that the compiler is able to inline and optimize all code paths of `integer_check_long` to prove that `err` and `value` are set to a known value whenever they are accessed in the code snippet above.",
    "created_at": "2017-11-23T09:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461046",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:19'></a>
Replying to [tscrim](#comment%3A17):
> I also don't think there will be any [noticeable] performance difference


Fun observation: compiler warnings can be used to get data on how the compiler is able to optimize the code. For example, in #24247 I'm writing essentially

```
        cdef long value
        cdef int err
        if integer_check_long(y, &value, &err):
            if not err:
                return (<Element>x)._pow_long(value)
```
In this case, the compiler *does not give a warning* that `err` and `value` might be uninitialized. This means that the compiler is able to inline and optimize all code paths of `integer_check_long` to prove that `err` and `value` are set to a known value whenever they are accessed in the code snippet above.



---

archive/issue_comments_461047.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2017-11-23T09:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461047",
    "user": "https://github.com/jdemeyer"
}
```


**Changing status** from needs_review to positive_review.



---

archive/issue_comments_461048.json:
```json
{
    "body": "<a id='comment:21'></a>\nOh, I just saw this from #24293 (I don't look at every ticket opened...)\n\nAs for \"integer_fake\" is there maybe a name for it that better reflects its purpose\"?  I was thinking something like \"integer_proto\" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.  \"integer_fake\" to me sounds like something for testing, or some other odd purpose.",
    "created_at": "2017-11-28T15:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461048",
    "user": "https://github.com/embray"
}
```


<a id='comment:21'></a>
Oh, I just saw this from #24293 (I don't look at every ticket opened...)

As for "integer_fake" is there maybe a name for it that better reflects its purpose"?  I was thinking something like "integer_proto" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.  "integer_fake" to me sounds like something for testing, or some other odd purpose.



---

archive/issue_comments_461049.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [embray](#comment%3A21):\n> As for \"integer_fake\" is there maybe a name for it that better reflects its purpose\"?  I was thinking something like \"integer_proto\" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.\n\n\nI think that `integer_fake` or `integer_proto` are equally meaningless. What would \"prototype\" mean in this context? I don't mind changing the name, but I'm not convinced with `integer_proto` either.\n\n> \"integer_fake\" to me sounds like something for testing, or some other odd purpose.\n\n\n\"odd purpose\" totally applies here :-)",
    "created_at": "2017-11-28T15:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461049",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:22'></a>
Replying to [embray](#comment%3A21):
> As for "integer_fake" is there maybe a name for it that better reflects its purpose"?  I was thinking something like "integer_proto" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.


I think that `integer_fake` or `integer_proto` are equally meaningless. What would "prototype" mean in this context? I don't mind changing the name, but I'm not convinced with `integer_proto` either.

> "integer_fake" to me sounds like something for testing, or some other odd purpose.


"odd purpose" totally applies here :-)



---

archive/issue_comments_461050.json:
```json
{
    "body": "<a id='comment:23'></a>\nThinking more about it, I actually like how the name sounds like it should not be used. `integer_proto` sounds too official somehow.",
    "created_at": "2017-11-28T16:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461050",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:23'></a>
Thinking more about it, I actually like how the name sounds like it should not be used. `integer_proto` sounds too official somehow.



---

archive/issue_comments_461051.json:
```json
{
    "body": "<a id='comment:24'></a>\nWhen I read `proto`(`type`), my first thought was the prototype design pattern, but that's right, in C it is called prototyping. However, since this is only mimicking that, I think `fake` is a little more accurate as to the class's purpose.",
    "created_at": "2017-11-29T00:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461051",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:24'></a>
When I read `proto`(`type`), my first thought was the prototype design pattern, but that's right, in C it is called prototyping. However, since this is only mimicking that, I think `fake` is a little more accurate as to the class's purpose.



---

archive/issue_comments_461052.json:
```json
{
    "body": "<a id='comment:25'></a>\nI mean, it *should* be used, just for a specific narrow case.  Alright I won't push on it; just something called \"fake\" is a little jarring to me to see outside of, say, test code.",
    "created_at": "2017-11-29T09:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461052",
    "user": "https://github.com/embray"
}
```


<a id='comment:25'></a>
I mean, it *should* be used, just for a specific narrow case.  Alright I won't push on it; just something called "fake" is a little jarring to me to see outside of, say, test code.



---

archive/issue_comments_461053.json:
```json
{
    "body": "<a id='comment:26'></a>\nBTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.",
    "created_at": "2017-11-29T09:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461053",
    "user": "https://github.com/embray"
}
```


<a id='comment:26'></a>
BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.



---

archive/issue_comments_461054.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [embray](#comment%3A26):\n> BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.\n\n\nThanks!",
    "created_at": "2017-11-29T09:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461054",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:27'></a>
Replying to [embray](#comment%3A26):
> BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.


Thanks!



---

archive/issue_comments_461055.json:
```json
{
    "body": "<a id='comment:28'></a>\nOkay okay, what about \"integer_decl\", since it's basically a forward declaration IIUC.",
    "created_at": "2017-11-29T09:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461055",
    "user": "https://github.com/embray"
}
```


<a id='comment:28'></a>
Okay okay, what about "integer_decl", since it's basically a forward declaration IIUC.



---

archive/issue_comments_461056.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [embray](#comment%3A28):\n> Okay okay, what about \"integer_decl\", since it's basically a forward declaration IIUC.\n\n\nIt's a fake forward declaration which shouldn't be used.",
    "created_at": "2017-12-05T10:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461056",
    "user": "https://github.com/jdemeyer"
}
```


<a id='comment:29'></a>
Replying to [embray](#comment%3A28):
> Okay okay, what about "integer_decl", since it's basically a forward declaration IIUC.


It's a fake forward declaration which shouldn't be used.



---

archive/issue_events_069831.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-13T17:38:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24244#event-69831"
}
```




---

archive/issue_comments_461057.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/fast_check_for_c_long](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fast_check_for_c_long)\" to \"[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)\".",
    "created_at": "2017-12-13T17:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461057",
    "user": "https://github.com/vbraun"
}
```


**Changing branch** from "[u/jdemeyer/fast_check_for_c_long](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fast_check_for_c_long)" to "[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)".



---

archive/issue_comments_461058.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2017-12-13T17:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461058",
    "user": "https://github.com/vbraun"
}
```


**Resolution:** fixed



---

archive/issue_comments_461059.json:
```json
{
    "body": "**Changing branch** from \"[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)\" to \"[u/jmantysalo/70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/70592a850d7677928592c022760d6183bd81364f)\".",
    "created_at": "2018-04-24T17:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461059",
    "user": "https://github.com/jm58660"
}
```


**Changing branch** from "[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)" to "[u/jmantysalo/70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/70592a850d7677928592c022760d6183bd81364f)".



---

archive/issue_comments_461060.json:
```json
{
    "body": "**Changing branch** from \"[u/jmantysalo/70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/70592a850d7677928592c022760d6183bd81364f)\" to \"[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)\".",
    "created_at": "2018-04-24T17:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461060",
    "user": "https://github.com/jm58660"
}
```


**Changing branch** from "[u/jmantysalo/70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/70592a850d7677928592c022760d6183bd81364f)" to "[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)".



---

archive/issue_comments_461061.json:
```json
{
    "body": "<a id='comment:32'></a>\nArghs, my typo.",
    "created_at": "2018-04-24T17:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461061",
    "user": "https://github.com/jm58660"
}
```


<a id='comment:32'></a>
Arghs, my typo.



---

archive/issue_comments_461062.json:
```json
{
    "body": "**Changing commit** from \"[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)\" to \"\".",
    "created_at": "2018-04-24T17:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24244#issuecomment-461062",
    "user": "https://github.com/jm58660"
}
```


**Changing commit** from "[70592a850d7677928592c022760d6183bd81364f](https://github.com/sagemath/sagetrac-mirror/commit/70592a850d7677928592c022760d6183bd81364f)" to "".
