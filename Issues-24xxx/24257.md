# Issue 24257: py3: change how remove_unicode_u is applied in the output checker

archive/issues_024020.json:
```json
{
    "body": "I explained this more in the commit message, but in short I realized that I don't like how the doctest output checker applies `remove_unicode_u`.  It was applying it the \"actual output\" strings on both Python 2 and Python 3.  Really what we want is to leave the output strings alone on Python 2, since an unexpected unicode string in the output could represent a test failure.  Likewise it doesn't make sense to apply on Python 3 since we should never see u-prefixed strings in the actual output on Python 3.\n\nInstead, we just want to strip u-prefixed strings from the desired output, and on Python 3 only, so that tests that expect some `str.__repr__()` pass the same on both Python 2 and 3.  Python 2 tests that *explicitly* expect unicode will also pass on Python 3 since Python 3 `str``s are already unicode.\n\nFor tests that should expect bytes we can use the `b*` prefix and similarly strip `b*` prefixes from the desired output on Python 2, but I haven't actually hit too many cases like that yet so I will address that separately.\n\nCC:  @fchapoton\n\nBranch/Commit: 6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24257\n\n",
    "closed_at": "2017-12-13T17:38:23Z",
    "created_at": "2017-11-21T12:12:50Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: change how remove_unicode_u is applied in the output checker",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24257",
    "user": "https://github.com/embray"
}
```
I explained this more in the commit message, but in short I realized that I don't like how the doctest output checker applies `remove_unicode_u`.  It was applying it the "actual output" strings on both Python 2 and Python 3.  Really what we want is to leave the output strings alone on Python 2, since an unexpected unicode string in the output could represent a test failure.  Likewise it doesn't make sense to apply on Python 3 since we should never see u-prefixed strings in the actual output on Python 3.

Instead, we just want to strip u-prefixed strings from the desired output, and on Python 3 only, so that tests that expect some `str.__repr__()` pass the same on both Python 2 and 3.  Python 2 tests that *explicitly* expect unicode will also pass on Python 3 since Python 3 `str``s are already unicode.

For tests that should expect bytes we can use the `b*` prefix and similarly strip `b*` prefixes from the desired output on Python 2, but I haven't actually hit too many cases like that yet so I will address that separately.

CC:  @fchapoton

Branch/Commit: 6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24257





---

archive/issue_comments_459092.json:
```json
{
    "body": "<a id='comment:1'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|\n|[21eed98](https://git.sagemath.org/sage.git/commit/?id=21eed988b64ba40c46f191afa66e5263bdb494bf)|`Change how stripping of unicode u'' prefixed strings in doctests is handled`|",
    "created_at": "2017-11-21T12:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459092",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                             |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|
|[21eed98](https://git.sagemath.org/sage.git/commit/?id=21eed988b64ba40c46f191afa66e5263bdb494bf)|`Change how stripping of unicode u'' prefixed strings in doctests is handled`|



---

archive/issue_comments_459093.json:
```json
{
    "body": "Changing commit from \"4f3027d691a2d936cae8c27a5fbf2c65a3334857\" to \"21eed988b64ba40c46f191afa66e5263bdb494bf\"",
    "created_at": "2017-11-21T12:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4f3027d691a2d936cae8c27a5fbf2c65a3334857" to "21eed988b64ba40c46f191afa66e5263bdb494bf"



---

archive/issue_comments_459094.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-21T12:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459094",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_459095.json:
```json
{
    "body": "<a id='comment:3'></a>\nErik, it seems that the patchbot for Cygwin misbehaves, sending many \"red\" status.\n\nhttps://patchbot.sagemath.org/ticket/?machine=CYGWIN_NT-10.0&machine=2017-04-01%2020:47&machine=x86_64&machine=2.8.0(0.309/5/3)&machine=windows-10-prof&status=open",
    "created_at": "2017-11-21T12:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459095",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
Erik, it seems that the patchbot for Cygwin misbehaves, sending many "red" status.

https://patchbot.sagemath.org/ticket/?machine=CYGWIN_NT-10.0&machine=2017-04-01%2020:47&machine=x86_64&machine=2.8.0(0.309/5/3)&machine=windows-10-prof&status=open



---

archive/issue_comments_459096.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-21T14:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459096",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_459097.json:
```json
{
    "body": "<a id='comment:4'></a>\nmany failing doctests",
    "created_at": "2017-11-21T14:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459097",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
many failing doctests



---

archive/issue_comments_459098.json:
```json
{
    "body": "<a id='comment:5'></a>\nI suspect that what this has revealed is actually many cases where the existing Python 3 work made backwards-incompatible changes in Sage as to what types of strings are returned by various functions.\n\nWhich was kind of the point of the change--I don't like that we were brushing `str` vs. `unicode` differences on Python 2 under the rug. But if you agree, then what we can do is go and fix this issues now that we have a list of relevant failures...",
    "created_at": "2017-11-21T15:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459098",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
I suspect that what this has revealed is actually many cases where the existing Python 3 work made backwards-incompatible changes in Sage as to what types of strings are returned by various functions.

Which was kind of the point of the change--I don't like that we were brushing `str` vs. `unicode` differences on Python 2 under the rug. But if you agree, then what we can do is go and fix this issues now that we have a list of relevant failures...



---

archive/issue_comments_459099.json:
```json
{
    "body": "Changing commit from \"21eed988b64ba40c46f191afa66e5263bdb494bf\" to \"6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe\"",
    "created_at": "2017-11-27T16:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459099",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "21eed988b64ba40c46f191afa66e5263bdb494bf" to "6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe"



---

archive/issue_comments_459100.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|\n|[6a9e6cb](https://git.sagemath.org/sage.git/commit/?id=6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe)|`Remove 'from __future__ import unicode_literals from some modules.`|",
    "created_at": "2017-11-27T16:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459100",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
|[6a9e6cb](https://git.sagemath.org/sage.git/commit/?id=6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe)|`Remove 'from __future__ import unicode_literals from some modules.`|



---

archive/issue_comments_459101.json:
```json
{
    "body": "<a id='comment:7'></a>\nI pushed some changes to fix the tests that were broken by this change, though perhaps these changes should be moved to a separate ticket if anyone cares (I don't really).\n\nBasically I removed `from __future__ import unicode_literals` from a few modules, as this tends to actually cause more trouble than it's worth (there's often this temptation when first starting a port of a large project to Python 3 to start using `unicode` everywhere even on Python 2, but this actually ends up breaking a lot of things for Python 2 with minimal benefit to the Python 3 port; so really it's best to use `unicode` in Python 3 only in narrow cases where it makes sense to).\n\nI then restored `u''` literals to some of the expected test outputs.  Again, particularly in the doctest module where it makes sense to find unicode strings, since we are treating test inputs and outputs as unicode.",
    "created_at": "2017-11-27T16:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459101",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
I pushed some changes to fix the tests that were broken by this change, though perhaps these changes should be moved to a separate ticket if anyone cares (I don't really).

Basically I removed `from __future__ import unicode_literals` from a few modules, as this tends to actually cause more trouble than it's worth (there's often this temptation when first starting a port of a large project to Python 3 to start using `unicode` everywhere even on Python 2, but this actually ends up breaking a lot of things for Python 2 with minimal benefit to the Python 3 port; so really it's best to use `unicode` in Python 3 only in narrow cases where it makes sense to).

I then restored `u''` literals to some of the expected test outputs.  Again, particularly in the doctest module where it makes sense to find unicode strings, since we are treating test inputs and outputs as unicode.



---

archive/issue_comments_459102.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-27T16:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459102",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459103.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [embray](#comment%3A7):\n> Basically I removed `from __future__ import unicode_literals` from a few modules\n\n\nFor the record: the `unicode_literals` in `src/sage/repl/ipython_kernel/widgets.py` is totally intentional. It is the right thing to do since `ipywidgets` (like most of Jupyter) uses mostly `unicode` internally.",
    "created_at": "2017-11-28T10:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459103",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [embray](#comment%3A7):
> Basically I removed `from __future__ import unicode_literals` from a few modules


For the record: the `unicode_literals` in `src/sage/repl/ipython_kernel/widgets.py` is totally intentional. It is the right thing to do since `ipywidgets` (like most of Jupyter) uses mostly `unicode` internally.



---

archive/issue_comments_459104.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-28T10:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459104",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_459105.json:
```json
{
    "body": "<a id='comment:9'></a>\nMinor comment: I would move the `PY2` check up and replace\n\n```\nif ok or ('u\"' not in want and \"u'\" not in want)\n```\nto\n\n```\nif ok or six.PY2 or ('u\"' not in want and \"u'\" not in want):\n```",
    "created_at": "2017-11-28T10:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459105",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Minor comment: I would move the `PY2` check up and replace

```
if ok or ('u"' not in want and "u'" not in want)
```
to

```
if ok or six.PY2 or ('u"' not in want and "u'" not in want):
```



---

archive/issue_comments_459106.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [jdemeyer](#comment%3A8):\n> Replying to [embray](#comment%3A7):\n> > Basically I removed `from __future__ import unicode_literals` from a few modules\n\n> \n> For the record: the `unicode_literals` in `src/sage/repl/ipython_kernel/widgets.py` is totally intentional. It is the right thing to do since `ipywidgets` (like most of Jupyter) uses mostly `unicode` internally.\n\n\nOkay, good to know.  Not saying there's no use for it--it's just better to not use it in general.",
    "created_at": "2017-11-28T10:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459106",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Replying to [jdemeyer](#comment%3A8):
> Replying to [embray](#comment%3A7):
> > Basically I removed `from __future__ import unicode_literals` from a few modules

> 
> For the record: the `unicode_literals` in `src/sage/repl/ipython_kernel/widgets.py` is totally intentional. It is the right thing to do since `ipywidgets` (like most of Jupyter) uses mostly `unicode` internally.


Okay, good to know.  Not saying there's no use for it--it's just better to not use it in general.



---

archive/issue_comments_459107.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-28T10:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459107",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459108.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [jdemeyer](#comment%3A9):\n> Minor comment: I would move the `PY2` check up and replace\n> \n> ```\n> if ok or ('u\"' not in want and \"u'\" not in want)\n> ```\n> to\n> \n> ```\n> if ok or six.PY2 or ('u\"' not in want and \"u'\" not in want):\n> ```\n\n\nI agree that makes a little more sense, but considering that I really want to follow this up quickly with #24258 it's not worth bothering with.",
    "created_at": "2017-11-28T10:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459108",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
Replying to [jdemeyer](#comment%3A9):
> Minor comment: I would move the `PY2` check up and replace
> 
> ```
> if ok or ('u"' not in want and "u'" not in want)
> ```
> to
> 
> ```
> if ok or six.PY2 or ('u"' not in want and "u'" not in want):
> ```


I agree that makes a little more sense, but considering that I really want to follow this up quickly with #24258 it's not worth bothering with.



---

archive/issue_comments_459109.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [embray](#comment%3A11):\n> I agree that makes a little more sense, but considering that I really want to follow this up quickly with #24258 it's not worth bothering with.\n\n\n+1",
    "created_at": "2017-11-28T10:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459109",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [embray](#comment%3A11):
> I agree that makes a little more sense, but considering that I really want to follow this up quickly with #24258 it's not worth bothering with.


+1



---

archive/issue_comments_459110.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-11-28T10:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459110",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_459111.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-28T10:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459111",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459112.json:
```json
{
    "body": "<a id='comment:14'></a>\nThanks.",
    "created_at": "2017-11-28T11:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459112",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
Thanks.



---

archive/issue_comments_459113.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-13T17:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459113",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_459114.json:
```json
{
    "body": "Changing branch from \"u/embray/python3/unicode-repr-fixups\" to \"6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe\"",
    "created_at": "2017-12-13T17:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24257#issuecomment-459114",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/python3/unicode-repr-fixups" to "6a9e6cbd7d6b02cc11b37b8beddfb8ed2f5a55fe"



---

archive/issue_events_061417.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-13T17:38:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24257",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24257#event-61417"
}
```
