# Issue 24681: Fix Cython tracebacks on Python 3

archive/issues_024444.json:
```json
{
    "body": "I've been getting to the bottom of why tracebacks aren't displaying Cython sources on Python 3.  The problem turns out to be multi-faceted, and fixing it right would also mean fixing some things in general, since the way it works now is a hack.\n\nBasically, the only reason it works at all on Python 2, is that the `linecache` module on Python 2 has some code which, given a relative filename (with an extension unrecognized by the import system) like `sage/rings/integer.pyx`, it will search for this file under all `sys.path` entries and, if found, read the source lines from that file.\n\nThis, in turn, only works for Sage because we actually install the `.pyx` sources in the sage package.\n\nThis does not work in Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.\n\nThe simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.\n\n**Upstream**:\n\n- https://bugs.python.org/issue32797\n- https://github.com/python/cpython/pull/6653\n\nUpstream: Reported upstream. No feedback yet.\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Jeroen Demeyer, Erik Bray\n\nBranch: 1a9225f70f8a49428d1874a47252a46791d3746d\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24681\n\n",
    "closed_at": "2018-06-17T22:15:21Z",
    "created_at": "2018-02-07T11:15:43Z",
    "labels": [
        "component: cython",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Fix Cython tracebacks on Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24681",
    "user": "https://github.com/embray"
}
```
I've been getting to the bottom of why tracebacks aren't displaying Cython sources on Python 3.  The problem turns out to be multi-faceted, and fixing it right would also mean fixing some things in general, since the way it works now is a hack.

Basically, the only reason it works at all on Python 2, is that the `linecache` module on Python 2 has some code which, given a relative filename (with an extension unrecognized by the import system) like `sage/rings/integer.pyx`, it will search for this file under all `sys.path` entries and, if found, read the source lines from that file.

This, in turn, only works for Sage because we actually install the `.pyx` sources in the sage package.

This does not work in Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.

The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.

**Upstream**:

- https://bugs.python.org/issue32797
- https://github.com/python/cpython/pull/6653

Upstream: Reported upstream. No feedback yet.

Reviewer: Frédéric Chapoton

Author: Jeroen Demeyer, Erik Bray

Branch: 1a9225f70f8a49428d1874a47252a46791d3746d

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24681





---

archive/issue_comments_468569.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,6 +8,6 @@\n \n Now, clearly there are a number of different ways we could hack around this at different levels, possibly involving monkey-patching either the `inspect` module or the `linecache` module (we already do the former). But it might be nice to fix this more systematically.\n \n-First of all, it comes as a bit of a surprise to me that there's no option in Cython to include a copy of a Cython module's pyx source in the compile module (e.g. accessible via a `__cython_source__` attribute or something like that).  I think that could be a nice feature to have for introspection purposes (e.g. it would also make getting the source from a inline-compiled Cython code easier).  If we wanted to do this it would be easy to do even without patching Cython, but it might be a nice feature to upstream.  Though I'd be surprised if this hasn't been suggested before, which makes me wonder if/why it was rejected.  The only reason I can think of from the Sage perspective is bloat.  Sage's Cython sources are nearly 10MB, but that's still nothing by modern standards, and the current situation requires having the sources anyways.\n+First of all, it comes as a bit of a surprise to me that there's no option in Cython to include a copy of a Cython module's pyx source in the compile module (e.g. accessible via a `__cython_source__` attribute or something like that).  I think that could be a nice feature to have for introspection purposes (e.g. it would also make getting the source from a inline-compiled Cython code easier).  If we wanted to do this it might be possible to do even without patching Cython, but it might be a nice feature to upstream.  Though I'd be surprised if this hasn't been suggested before, which makes me wonder if/why it was rejected.  The only reason I can think of from the Sage perspective is bloat.  Sage's Cython sources are nearly 10MB, but that's still nothing by modern standards, and the current situation requires having the sources anyways.\n \n The second element to this would be a `sys.path_hooks` entry that handles extension modules but, instead of returning `ExtensionFileLoader` returns a simple subclass thereof that knows how to recognize and handle Cython modules.\n``````\n",
    "created_at": "2018-02-07T11:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468569",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,6 +8,6 @@
 
 Now, clearly there are a number of different ways we could hack around this at different levels, possibly involving monkey-patching either the `inspect` module or the `linecache` module (we already do the former). But it might be nice to fix this more systematically.
 
-First of all, it comes as a bit of a surprise to me that there's no option in Cython to include a copy of a Cython module's pyx source in the compile module (e.g. accessible via a `__cython_source__` attribute or something like that).  I think that could be a nice feature to have for introspection purposes (e.g. it would also make getting the source from a inline-compiled Cython code easier).  If we wanted to do this it would be easy to do even without patching Cython, but it might be a nice feature to upstream.  Though I'd be surprised if this hasn't been suggested before, which makes me wonder if/why it was rejected.  The only reason I can think of from the Sage perspective is bloat.  Sage's Cython sources are nearly 10MB, but that's still nothing by modern standards, and the current situation requires having the sources anyways.
+First of all, it comes as a bit of a surprise to me that there's no option in Cython to include a copy of a Cython module's pyx source in the compile module (e.g. accessible via a `__cython_source__` attribute or something like that).  I think that could be a nice feature to have for introspection purposes (e.g. it would also make getting the source from a inline-compiled Cython code easier).  If we wanted to do this it might be possible to do even without patching Cython, but it might be a nice feature to upstream.  Though I'd be surprised if this hasn't been suggested before, which makes me wonder if/why it was rejected.  The only reason I can think of from the Sage perspective is bloat.  Sage's Cython sources are nearly 10MB, but that's still nothing by modern standards, and the current situation requires having the sources anyways.
 
 The second element to this would be a `sys.path_hooks` entry that handles extension modules but, instead of returning `ExtensionFileLoader` returns a simple subclass thereof that knows how to recognize and handle Cython modules.
``````




---

archive/issue_comments_468570.json:
```json
{
    "body": "<a id='comment:2'></a>Here's a Python 3 *only* rough prototype of how this might work, in this case via simply installing the `.pyx` files alongside the compiled modules.  Doing anything like inlining the source code in the compiled modules looks like it will be trickier than I thought without some modification to Cython.\n\nThis instead recognizes Cython modules by looking for `.pyx` files associated with extension modules.  It then wraps such modules with a `CythonModule` class which has a `__cython_source__` property which can read in the sources.  Unfortunately this doesn't yet handle reading sources from `.pxd` files, but that could probably be added with a bit of elbow grease.\n\nUnfortunately, about 80% of this patch is some very general machinery that I needed just to get Python's import system to handle a new module suffix (in fact, this would even be necessary to override the handling of already known suffixes).  This used to be easier to do in Python 2--I've done it before relatively painlessly.  But the new import system made that otherwise simple use case much more difficult--I've raised this issue with the python-ideas mailing list.  In the meantime my workaround is fine, but an added complication I would have wished to have avoided...\n\n---\nNew commits:",
    "created_at": "2018-02-07T18:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468570",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Here's a Python 3 *only* rough prototype of how this might work, in this case via simply installing the `.pyx` files alongside the compiled modules.  Doing anything like inlining the source code in the compiled modules looks like it will be trickier than I thought without some modification to Cython.

This instead recognizes Cython modules by looking for `.pyx` files associated with extension modules.  It then wraps such modules with a `CythonModule` class which has a `__cython_source__` property which can read in the sources.  Unfortunately this doesn't yet handle reading sources from `.pxd` files, but that could probably be added with a bit of elbow grease.

Unfortunately, about 80% of this patch is some very general machinery that I needed just to get Python's import system to handle a new module suffix (in fact, this would even be necessary to override the handling of already known suffixes).  This used to be easier to do in Python 2--I've done it before relatively painlessly.  But the new import system made that otherwise simple use case much more difficult--I've raised this issue with the python-ideas mailing list.  In the meantime my workaround is fine, but an added complication I would have wished to have avoided...

---
New commits:



---

archive/issue_comments_468571.json:
```json
{
    "body": "Changing branch from \"\" to \"u/embray/python3/cython-source-prototype\"",
    "created_at": "2018-02-07T18:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468571",
    "user": "https://github.com/embray"
}
```

Changing branch from "" to "u/embray/python3/cython-source-prototype"



---

archive/issue_comments_468572.json:
```json
{
    "body": "Changing commit from \"\" to \"3388b6606e30c3d3c0fad1566b74c790772dfe1d\"",
    "created_at": "2018-02-07T18:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468572",
    "user": "https://github.com/embray"
}
```

Changing commit from "" to "3388b6606e30c3d3c0fad1566b74c790772dfe1d"



---

archive/issue_comments_468573.json:
```json
{
    "body": "Changing commit from \"3388b6606e30c3d3c0fad1566b74c790772dfe1d\" to \"8b63abe731c510f0de9ef0e3ab9a0bda3669dce1\"",
    "created_at": "2018-02-07T18:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468573",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3388b6606e30c3d3c0fad1566b74c790772dfe1d" to "8b63abe731c510f0de9ef0e3ab9a0bda3669dce1"



---

archive/issue_comments_468574.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-07T18:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468575.json:
```json
{
    "body": "<a id='comment:4'></a>I have pretty good contacts with Cython upstream (according to github, I am the number 6 Cython contributor). So if you want to propose something, there is a good chance that it will be accepted.\n\nFrom your description, it seems that the simplest solution would be to add a custom `__loader__` for Cython modules.\n\n---\nNew commits:",
    "created_at": "2018-02-07T18:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468575",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>I have pretty good contacts with Cython upstream (according to github, I am the number 6 Cython contributor). So if you want to propose something, there is a good chance that it will be accepted.

From your description, it seems that the simplest solution would be to add a custom `__loader__` for Cython modules.

---
New commits:



---

archive/issue_comments_468576.json:
```json
{
    "body": "Replying to [ticket:24681 embray]:\n> In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`\n\n\nWhich module object? How does the mapping traceback -> module work?",
    "created_at": "2018-02-07T19:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468576",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:24681 embray]:
> In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`


Which module object? How does the mapping traceback -> module work?



---

archive/issue_comments_468577.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [jdemeyer](#comment%3A4):\n> I have pretty good contacts with Cython upstream (according to github, I am the number 6 Cython contributor). So if you want to propose something, there is a good chance that it will be accepted.\n> \n> From your description, it seems that the simplest solution would be to add a custom `__loader__` for Cython modules.\n\n\nI haven't tried it yet, but that might work if the `__loader__` were just pre-baked into the extension module.  It would definitely be preferable to the import system hacks here.  I'll probably give that a try, but I wanted to see if we could make it work without patching Cython first.",
    "created_at": "2018-02-07T19:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468577",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Replying to [jdemeyer](#comment%3A4):
> I have pretty good contacts with Cython upstream (according to github, I am the number 6 Cython contributor). So if you want to propose something, there is a good chance that it will be accepted.
> 
> From your description, it seems that the simplest solution would be to add a custom `__loader__` for Cython modules.


I haven't tried it yet, but that might work if the `__loader__` were just pre-baked into the extension module.  It would definitely be preferable to the import system hacks here.  I'll probably give that a try, but I wanted to see if we could make it work without patching Cython first.



---

archive/issue_comments_468578.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [jdemeyer](#comment%3A5):\n> Replying to [ticket:24681 embray]:\n> > In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`\n\n> \n> Which module object? How does the mapping traceback -> module work?\n\n\nUltimately `inspect.findsource`, which is used in formatting the traceback, goes through `linecache` to get the source lines for a file.  Well, if you look at how [linecache.updatecache](https://github.com/python/cpython/blob/3.6/Lib/linecache.py#L94) is implemented, it's funny--if it's passed a real filename then it will just read the source code directly out of the filename.  The filename, in this case, is coming from the traceback frame's code object.  However, as in our old friend #24097, since the Cython module's hard-coded path is a relative path, this actually fails unless you happen to be in the right directory.  It then goes on to try going through the module's `__loader__` if it has one...",
    "created_at": "2018-02-07T19:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468578",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Replying to [jdemeyer](#comment%3A5):
> Replying to [ticket:24681 embray]:
> > In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`

> 
> Which module object? How does the mapping traceback -> module work?


Ultimately `inspect.findsource`, which is used in formatting the traceback, goes through `linecache` to get the source lines for a file.  Well, if you look at how [linecache.updatecache](https://github.com/python/cpython/blob/3.6/Lib/linecache.py#L94) is implemented, it's funny--if it's passed a real filename then it will just read the source code directly out of the filename.  The filename, in this case, is coming from the traceback frame's code object.  However, as in our old friend #24097, since the Cython module's hard-coded path is a relative path, this actually fails unless you happen to be in the right directory.  It then goes on to try going through the module's `__loader__` if it has one...



---

archive/issue_comments_468579.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [embray](#comment%3A6):\n> I wanted to see if we could make it work without patching Cython first.\n\n\nWhy? If we can do it with just a Cython patch, that would be ideal because then everybody benefits, not just Sage.",
    "created_at": "2018-02-07T19:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468579",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [embray](#comment%3A6):
> I wanted to see if we could make it work without patching Cython first.


Why? If we can do it with just a Cython patch, that would be ideal because then everybody benefits, not just Sage.



---

archive/issue_comments_468580.json:
```json
{
    "body": "<a id='comment:9'></a>FYI: the traceback frame for Cython code is manually constructed by Cython itself (exceptions from C code typically have no \"frame\"). So if anything needs to be changed there, that can easily be done.",
    "created_at": "2018-02-07T19:35:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468580",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>FYI: the traceback frame for Cython code is manually constructed by Cython itself (exceptions from C code typically have no "frame"). So if anything needs to be changed there, that can easily be done.



---

archive/issue_comments_468581.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [jdemeyer](#comment%3A8):\n> Replying to [embray](#comment%3A6):\n> > I wanted to see if we could make it work without patching Cython first.\n\n> \n> Why? If we can do it with just a Cython patch, that would be ideal because then everybody benefits, not just Sage.\n\n\nOh, agree completely. I just didn't want to, as a first pass, *depend* on one without knowing when such a patch would be available in an official release. Or, at the time of writing, I wasn't even sure if it was a good idea (just because it surprised me that such a feature didn't already exit).",
    "created_at": "2018-02-08T08:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468581",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Replying to [jdemeyer](#comment%3A8):
> Replying to [embray](#comment%3A6):
> > I wanted to see if we could make it work without patching Cython first.

> 
> Why? If we can do it with just a Cython patch, that would be ideal because then everybody benefits, not just Sage.


Oh, agree completely. I just didn't want to, as a first pass, *depend* on one without knowing when such a patch would be available in an official release. Or, at the time of writing, I wasn't even sure if it was a good idea (just because it surprised me that such a feature didn't already exit).



---

archive/issue_comments_468582.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [embray](#comment%3A6):\n> Replying to [jdemeyer](#comment%3A4):\n> > I have pretty good contacts with Cython upstream (according to github, I am the number 6 Cython contributor). So if you want to propose something, there is a good chance that it will be accepted.\n> > \n> > From your description, it seems that the simplest solution would be to add a custom `__loader__` for Cython modules.\n\n> \n> I haven't tried it yet, but that might work if the `__loader__` were just pre-baked into the extension module.  It would definitely be preferable to the import system hacks here.  I'll probably give that a try, but I wanted to see if we could make it work without patching Cython first.\n\n\nIn retrospect, I don't know if this will work after all.  It's the import system itself that constructs `module` objects and assigns to their `__loader__` attribute (with the loader that was used to load the module code in the first place).  So I do't know that it's possible for a module to come with `__loader__` already in its namespace and not just have it overridden.  So it might be necessary to have some import hooks after all if we wanted to provide a custom loader for Cython modules.\n\nThat said, it would still be possible to provide better introspection of Cython modules if the Cython sources were (optionally) baked into the module somewhere, and that's a separate issue and easy to add to Cython.",
    "created_at": "2018-02-08T09:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468582",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Replying to [embray](#comment%3A6):
> Replying to [jdemeyer](#comment%3A4):
> > I have pretty good contacts with Cython upstream (according to github, I am the number 6 Cython contributor). So if you want to propose something, there is a good chance that it will be accepted.
> > 
> > From your description, it seems that the simplest solution would be to add a custom `__loader__` for Cython modules.

> 
> I haven't tried it yet, but that might work if the `__loader__` were just pre-baked into the extension module.  It would definitely be preferable to the import system hacks here.  I'll probably give that a try, but I wanted to see if we could make it work without patching Cython first.


In retrospect, I don't know if this will work after all.  It's the import system itself that constructs `module` objects and assigns to their `__loader__` attribute (with the loader that was used to load the module code in the first place).  So I do't know that it's possible for a module to come with `__loader__` already in its namespace and not just have it overridden.  So it might be necessary to have some import hooks after all if we wanted to provide a custom loader for Cython modules.

That said, it would still be possible to provide better introspection of Cython modules if the Cython sources were (optionally) baked into the module somewhere, and that's a separate issue and easy to add to Cython.



---

archive/issue_comments_468583.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [jdemeyer](#comment%3A9):\n> FYI: the traceback frame for Cython code is manually constructed by Cython itself (exceptions from C code typically have no \"frame\"). So if anything needs to be changed there, that can easily be done.\n\n\nNo, I don't think anything needs to be done there (modulo the issue about filename paths, but that's somewhat orthogonal).",
    "created_at": "2018-02-08T09:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468583",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Replying to [jdemeyer](#comment%3A9):
> FYI: the traceback frame for Cython code is manually constructed by Cython itself (exceptions from C code typically have no "frame"). So if anything needs to be changed there, that can easily be done.


No, I don't think anything needs to be done there (modulo the issue about filename paths, but that's somewhat orthogonal).



---

archive/issue_comments_468584.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [embray](#comment%3A11):\n> In retrospect, I don't know if this will work after all.  It's the import system itself that constructs `module` objects and assigns to their `__loader__` attribute (with the loader that was used to load the module code in the first place).  So I do't know that it's possible for a module to come with `__loader__` already in its namespace and not just have it overridden.\n\n\nI'll have a look. Isn't the `__loader__` just an entry in the module dict? Surely that dict can be changed.",
    "created_at": "2018-02-08T09:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468584",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [embray](#comment%3A11):
> In retrospect, I don't know if this will work after all.  It's the import system itself that constructs `module` objects and assigns to their `__loader__` attribute (with the loader that was used to load the module code in the first place).  So I do't know that it's possible for a module to come with `__loader__` already in its namespace and not just have it overridden.


I'll have a look. Isn't the `__loader__` just an entry in the module dict? Surely that dict can be changed.



---

archive/issue_comments_468585.json:
```json
{
    "body": "<a id='comment:14'></a>Simple fix which works for me on a sample project:\n\n```\ndel globals()[\"__loader__\"]\n```\nIt still requires that the sources can be found in `sys.path`.\n\nI'm not saying that this is the perfect solution, but it gives a starting point that playing with `__loader__` works. Now I'll try to implement a custom `__loader__`.",
    "created_at": "2018-02-08T09:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468585",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Simple fix which works for me on a sample project:

```
del globals()["__loader__"]
```
It still requires that the sources can be found in `sys.path`.

I'm not saying that this is the perfect solution, but it gives a starting point that playing with `__loader__` works. Now I'll try to implement a custom `__loader__`.



---

archive/issue_comments_468586.json:
```json
{
    "body": "<a id='comment:15'></a>To my surprise, the import system actually does not, by default override `__loader__` if it's already in the module: https://github.com/python/cpython/blob/3.6/Lib/importlib/_bootstrap.py#L504 \n\nSo I guess you could just put whatever you want in a module's `__loader__` attribute.  That is, unless that function is called with `override=True`, and it's not entirely clear to me in what context that would happen, or if this behavior is even documented.  In other words, I'm not sure if there's well-defined behavior for this.",
    "created_at": "2018-02-08T10:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468586",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>To my surprise, the import system actually does not, by default override `__loader__` if it's already in the module: https://github.com/python/cpython/blob/3.6/Lib/importlib/_bootstrap.py#L504 

So I guess you could just put whatever you want in a module's `__loader__` attribute.  That is, unless that function is called with `override=True`, and it's not entirely clear to me in what context that would happen, or if this behavior is even documented.  In other words, I'm not sure if there's well-defined behavior for this.



---

archive/issue_comments_468587.json:
```json
{
    "body": "<a id='comment:16'></a>Got it to work!\n\n```\ndef error():\n    raise RuntimeError(\"traceback testing\")\n\n\nfrom importlib.machinery import ExtensionFileLoader\n\nclass CythonExtensionLoader(ExtensionFileLoader):\n    def __init__(self, name):\n        self.name = name\n\n    @property\n    def path(self):\n        return __file__\n\n    def get_source(self, fullname):\n        print(\"get_source({}) called\".format(fullname))\n        with open(\"/usr/local/src/sage-config/local/src/cyloader/cyloader/loader.pyx\") as f:\n            return f.read()\n\n\n__loader__ = CythonExtensionLoader(__name__)\n```\nBy setting a Cython-aware `__loader__` when the module is initialized, we can fix its `get_source` method to do what we want. Calling `error()` does display the source in the traceback.",
    "created_at": "2018-02-08T10:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468587",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Got it to work!

```
def error():
    raise RuntimeError("traceback testing")


from importlib.machinery import ExtensionFileLoader

class CythonExtensionLoader(ExtensionFileLoader):
    def __init__(self, name):
        self.name = name

    @property
    def path(self):
        return __file__

    def get_source(self, fullname):
        print("get_source({}) called".format(fullname))
        with open("/usr/local/src/sage-config/local/src/cyloader/cyloader/loader.pyx") as f:
            return f.read()


__loader__ = CythonExtensionLoader(__name__)
```
By setting a Cython-aware `__loader__` when the module is initialized, we can fix its `get_source` method to do what we want. Calling `error()` does display the source in the traceback.



---

archive/issue_comments_468588.json:
```json
{
    "body": "<a id='comment:17'></a>I see, there is actually some better documentation on this here: https://docs.python.org/3/reference/import.html?highlight=_init_module_attrs#loading\n\nAll the attributes set by the import system are set *before* the module is actually executed.  When the module is executed it can, of course, put whatever it wants in its own namespace, including overriding anything the import system put there.",
    "created_at": "2018-02-08T10:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468588",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>I see, there is actually some better documentation on this here: https://docs.python.org/3/reference/import.html?highlight=_init_module_attrs#loading

All the attributes set by the import system are set *before* the module is actually executed.  When the module is executed it can, of course, put whatever it wants in its own namespace, including overriding anything the import system put there.



---

archive/issue_comments_468589.json:
```json
{
    "body": "<a id='comment:18'></a>Nice! I wouldn't have thought that would work, but I'm glad it does.  A real implementation might also consider wrapping whatever `__loader__` is already there.\n\nNow it would be nice to add a flag to Cython to include the source code in the module, but in the meantime my prototype, which just installs the .pyx files alongside the extension modules, could also work.",
    "created_at": "2018-02-08T10:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468589",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>Nice! I wouldn't have thought that would work, but I'm glad it does.  A real implementation might also consider wrapping whatever `__loader__` is already there.

Now it would be nice to add a flag to Cython to include the source code in the module, but in the meantime my prototype, which just installs the .pyx files alongside the extension modules, could also work.



---

archive/issue_comments_468590.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [embray](#comment%3A17):\n> All the attributes set by the import system are set *before* the module is actually executed.\n\n\nNo, that's not the case. In my first attempt, I tried to simply change the `__class__` of the existing `__loader__`. But there is no existing `__loader__` when the extension module is being initialized.\n\n[PEP 489](https://www.python.org/dev/peps/pep-0489/) is certainly relevant here, but Cython does not fully support that yet.",
    "created_at": "2018-02-08T10:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468590",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Replying to [embray](#comment%3A17):
> All the attributes set by the import system are set *before* the module is actually executed.


No, that's not the case. In my first attempt, I tried to simply change the `__class__` of the existing `__loader__`. But there is no existing `__loader__` when the extension module is being initialized.

[PEP 489](https://www.python.org/dev/peps/pep-0489/) is certainly relevant here, but Cython does not fully support that yet.



---

archive/issue_comments_468591.json:
```json
{
    "body": "<a id='comment:20'></a>Hmm, my solution only works in IPython so far, not in plain Python.",
    "created_at": "2018-02-08T10:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468591",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Hmm, my solution only works in IPython so far, not in plain Python.



---

archive/issue_comments_468592.json:
```json
{
    "body": "<a id='comment:21'></a>The Python REPL uses the default `excepthook` to display exceptions. When it cannot find the file, it does something strange: it essentially tries `os.path.join(path, basename)` where `path` loops over the `sys.path` entries and `basename` is the last part(!) of the filename in the traceback. This goes back to\n\n```\ncommit 7169dbb76dcd1d25f2989eb00da33d05c3d6279b\nAuthor: Guido van Rossum <guido@python.org>\nDate:   Wed Feb 26 15:17:59 1992 +0000\n\n    Move printing of filename and lineno to tb_displayline.\n    Search sys.path if the filename isn't found.\n    Include osdefs.h.\n```",
    "created_at": "2018-02-08T11:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468592",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>The Python REPL uses the default `excepthook` to display exceptions. When it cannot find the file, it does something strange: it essentially tries `os.path.join(path, basename)` where `path` loops over the `sys.path` entries and `basename` is the last part(!) of the filename in the traceback. This goes back to

```
commit 7169dbb76dcd1d25f2989eb00da33d05c3d6279b
Author: Guido van Rossum <guido@python.org>
Date:   Wed Feb 26 15:17:59 1992 +0000

    Move printing of filename and lineno to tb_displayline.
    Search sys.path if the filename isn't found.
    Include osdefs.h.
```



---

archive/issue_comments_468593.json:
```json
{
    "body": "<a id='comment:22'></a>But I guess we care more IPython than Python, so I'm just going to ignore the plain Python REPL for now.",
    "created_at": "2018-02-08T11:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468593",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>But I guess we care more IPython than Python, so I'm just going to ignore the plain Python REPL for now.



---

archive/issue_comments_468594.json:
```json
{
    "body": "<a id='comment:23'></a>And the overriding of `__loader__` won't work with pxd files: there is no way for the `get_source()` method to know the filename that it should return the sources for.",
    "created_at": "2018-02-08T11:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468594",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>And the overriding of `__loader__` won't work with pxd files: there is no way for the `get_source()` method to know the filename that it should return the sources for.



---

archive/issue_comments_468595.json:
```json
{
    "body": "<a id='comment:24'></a>OK, new and super-simple solution which just reverts the Python 3 behaviour to the Python 2 behaviour:\n\n```\nclass DeletedAttribute(object):\n    def __get__(self, instance, owner):\n        raise AttributeError\n\n\nfrom importlib.machinery import ExtensionFileLoader\nExtensionFileLoader.get_source = DeletedAttribute()\n```\n\nIt effectively removes the `get_source` attribute from `ExtensionFileLoader`. This causes the `linecache` module to continuing searching for the source file as in Python 2.",
    "created_at": "2018-02-08T11:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468595",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>OK, new and super-simple solution which just reverts the Python 3 behaviour to the Python 2 behaviour:

```
class DeletedAttribute(object):
    def __get__(self, instance, owner):
        raise AttributeError


from importlib.machinery import ExtensionFileLoader
ExtensionFileLoader.get_source = DeletedAttribute()
```

It effectively removes the `get_source` attribute from `ExtensionFileLoader`. This causes the `linecache` module to continuing searching for the source file as in Python 2.



---

archive/issue_comments_468596.json:
```json
{
    "body": "Changing branch from \"u/embray/python3/cython-source-prototype\" to \"u/jdemeyer/python3/cython-source-prototype\"",
    "created_at": "2018-02-08T13:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468596",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/embray/python3/cython-source-prototype" to "u/jdemeyer/python3/cython-source-prototype"



---

archive/issue_comments_468597.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-08T13:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468598.json:
```json
{
    "body": "Changing commit from \"8b63abe731c510f0de9ef0e3ab9a0bda3669dce1\" to \"1a9225f70f8a49428d1874a47252a46791d3746d\"",
    "created_at": "2018-02-08T13:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468598",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8b63abe731c510f0de9ef0e3ab9a0bda3669dce1" to "1a9225f70f8a49428d1874a47252a46791d3746d"



---

archive/issue_comments_468599.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,8 +6,4 @@\n \n That said, that still wouldn't fix things for Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.\n \n-Now, clearly there are a number of different ways we could hack around this at different levels, possibly involving monkey-patching either the `inspect` module or the `linecache` module (we already do the former). But it might be nice to fix this more systematically.\n-\n-First of all, it comes as a bit of a surprise to me that there's no option in Cython to include a copy of a Cython module's pyx source in the compile module (e.g. accessible via a `__cython_source__` attribute or something like that).  I think that could be a nice feature to have for introspection purposes (e.g. it would also make getting the source from a inline-compiled Cython code easier).  If we wanted to do this it might be possible to do even without patching Cython, but it might be a nice feature to upstream.  Though I'd be surprised if this hasn't been suggested before, which makes me wonder if/why it was rejected.  The only reason I can think of from the Sage perspective is bloat.  Sage's Cython sources are nearly 10MB, but that's still nothing by modern standards, and the current situation requires having the sources anyways.\n-\n-The second element to this would be a `sys.path_hooks` entry that handles extension modules but, instead of returning `ExtensionFileLoader` returns a simple subclass thereof that knows how to recognize and handle Cython modules.\n+The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.\n``````\n",
    "created_at": "2018-02-08T13:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468599",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,8 +6,4 @@
 
 That said, that still wouldn't fix things for Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.
 
-Now, clearly there are a number of different ways we could hack around this at different levels, possibly involving monkey-patching either the `inspect` module or the `linecache` module (we already do the former). But it might be nice to fix this more systematically.
-
-First of all, it comes as a bit of a surprise to me that there's no option in Cython to include a copy of a Cython module's pyx source in the compile module (e.g. accessible via a `__cython_source__` attribute or something like that).  I think that could be a nice feature to have for introspection purposes (e.g. it would also make getting the source from a inline-compiled Cython code easier).  If we wanted to do this it might be possible to do even without patching Cython, but it might be a nice feature to upstream.  Though I'd be surprised if this hasn't been suggested before, which makes me wonder if/why it was rejected.  The only reason I can think of from the Sage perspective is bloat.  Sage's Cython sources are nearly 10MB, but that's still nothing by modern standards, and the current situation requires having the sources anyways.
-
-The second element to this would be a `sys.path_hooks` entry that handles extension modules but, instead of returning `ExtensionFileLoader` returns a simple subclass thereof that knows how to recognize and handle Cython modules.
+The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.
``````




---

archive/issue_comments_468600.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer, Erik Bray\"",
    "created_at": "2018-02-08T13:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468600",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer, Erik Bray"



---

archive/issue_comments_468601.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-08T13:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468601",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468602.json:
```json
{
    "body": "<a id='comment:28'></a>The approach with the custom `__loader__` can never work because it cannot differentiate between the `.pyx` file and other files. It assumes that one module has one source file, which is generally not the case for Cython.\n\nSo I propose this simple but effective solution of monkey-patching `ExtensionFileLoader`.",
    "created_at": "2018-02-08T13:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468602",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>The approach with the custom `__loader__` can never work because it cannot differentiate between the `.pyx` file and other files. It assumes that one module has one source file, which is generally not the case for Cython.

So I propose this simple but effective solution of monkey-patching `ExtensionFileLoader`.



---

archive/issue_comments_468603.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,5 @@\n That said, that still wouldn't fix things for Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.\n \n The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.\n+\n+**Upstream**: https://bugs.python.org/issue32797\n``````\n",
    "created_at": "2018-02-08T13:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468603",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,5 @@
 That said, that still wouldn't fix things for Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.
 
 The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.
+
+**Upstream**: https://bugs.python.org/issue32797
``````




---

archive/issue_comments_468604.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Reported upstream. No feedback yet.\"",
    "created_at": "2018-02-08T13:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468604",
    "user": "https://github.com/jdemeyer"
}
```

Changing upstream from "N/A" to "Reported upstream. No feedback yet."



---

archive/issue_comments_468605.json:
```json
{
    "body": "<a id='comment:30'></a>Regardless of the upstream Python or Cython bug, could you accept this as a working-but-improvable solution?",
    "created_at": "2018-02-09T17:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468605",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>Regardless of the upstream Python or Cython bug, could you accept this as a working-but-improvable solution?



---

archive/issue_comments_468606.json:
```json
{
    "body": "<a id='comment:31'></a>No, I'm -1 on this, I don't think it's a good solution even if it happens to work.  If this were urgent I'd say \"sure\", but we have time and flexibility here to come up with a better solution.",
    "created_at": "2018-02-12T17:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468606",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>No, I'm -1 on this, I don't think it's a good solution even if it happens to work.  If this were urgent I'd say "sure", but we have time and flexibility here to come up with a better solution.



---

archive/issue_comments_468607.json:
```json
{
    "body": "<a id='comment:32'></a>It is an interesting question concerning the split of some modules between a .pyx and a .pxd.  In most cases only the .pyx is relevant or interesting, but some functions are implemented in the .pxd file.  This is more rare, however.",
    "created_at": "2018-02-12T17:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468607",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>It is an interesting question concerning the split of some modules between a .pyx and a .pxd.  In most cases only the .pyx is relevant or interesting, but some functions are implemented in the .pxd file.  This is more rare, however.



---

archive/issue_events_062137.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-13T15:46:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24681#event-62137"
}
```



---

archive/issue_comments_468608.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [embray](#comment%3A31):\n> No, I'm -1 on this, I don't think it's a good solution even if it happens to work.\n\n\nCan you at least say why you think that it's not a good solution?\n\nI guess that you would like to use `__loader__.get_source()` but that won't work, see [comment:28].",
    "created_at": "2018-02-13T15:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468608",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>Replying to [embray](#comment%3A31):
> No, I'm -1 on this, I don't think it's a good solution even if it happens to work.


Can you at least say why you think that it's not a good solution?

I guess that you would like to use `__loader__.get_source()` but that won't work, see [comment:28].



---

archive/issue_comments_468609.json:
```json
{
    "body": "<a id='comment:34'></a>I mean it's obviously a hack, and an ugly one at that.  This also doesn't solve the issue of multiple source files any better. I think we really need to think about how to handle that case well--I think it will require rethinking some things in Cython. \n\nThat said, having even just a hack for this is could still be very useful for debugging issues in Python 3, so I've changed my mind and don't really have a problem giving this a try for now as long as we open a new ticket to track this issue (or leave this ticket open and create a new ticket for the workaround).",
    "created_at": "2018-02-14T15:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468609",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>I mean it's obviously a hack, and an ugly one at that.  This also doesn't solve the issue of multiple source files any better. I think we really need to think about how to handle that case well--I think it will require rethinking some things in Cython. 

That said, having even just a hack for this is could still be very useful for debugging issues in Python 3, so I've changed my mind and don't really have a problem giving this a try for now as long as we open a new ticket to track this issue (or leave this ticket open and create a new ticket for the workaround).



---

archive/issue_comments_468610.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [embray](#comment%3A34):\n> This also doesn't solve the issue of multiple source files any better.\n\n\nIn what way does it not solve that problem? The whole reason not to use `__loader__.get_source()` is precisely to support multiple source files from the same module.",
    "created_at": "2018-02-14T15:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468610",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>Replying to [embray](#comment%3A34):
> This also doesn't solve the issue of multiple source files any better.


In what way does it not solve that problem? The whole reason not to use `__loader__.get_source()` is precisely to support multiple source files from the same module.



---

archive/issue_comments_468611.json:
```json
{
    "body": "<a id='comment:36'></a>I must be missing something, but how do we support that case currently?  E.g. if some module has a `.pxd` and a `.pyx`, and some function in that module is implemented in one of those source files but not the other, how do we currently load the source for that function from the correct source file?",
    "created_at": "2018-03-12T15:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468611",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>I must be missing something, but how do we support that case currently?  E.g. if some module has a `.pxd` and a `.pyx`, and some function in that module is implemented in one of those source files but not the other, how do we currently load the source for that function from the correct source file?



---

archive/issue_comments_468612.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [embray](#comment%3A36):\n> how do we currently load the source for that function from the correct source file?\n\n\nThe traceback contains the source filename:\n\n```\nsage: try:\n....:     1/0\n....: except ZeroDivisionError as E:\n....:     tb = sys.exc_info()[2]\nsage: tb.tb_next.tb_frame.f_code.co_filename\n'sage/rings/integer.pyx'\n```",
    "created_at": "2018-03-12T18:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468612",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Replying to [embray](#comment%3A36):
> how do we currently load the source for that function from the correct source file?


The traceback contains the source filename:

```
sage: try:
....:     1/0
....: except ZeroDivisionError as E:
....:     tb = sys.exc_info()[2]
sage: tb.tb_next.tb_frame.f_code.co_filename
'sage/rings/integer.pyx'
```



---

archive/issue_comments_468613.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [embray](#comment%3A31):\n> No, I'm -1 on this, I don't think it's a good solution even if it happens to work.\n\n\nAn ugly/hackish solution is still better than no solution at all.\n\nI simply don't see a better solution, not even in theory.",
    "created_at": "2018-03-14T19:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468613",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>Replying to [embray](#comment%3A31):
> No, I'm -1 on this, I don't think it's a good solution even if it happens to work.


An ugly/hackish solution is still better than no solution at all.

I simply don't see a better solution, not even in theory.



---

archive/issue_comments_468614.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [jdemeyer](#comment%3A37):\n> Replying to [embray](#comment%3A36):\n> > how do we currently load the source for that function from the correct source file?\n\n> \n> The traceback contains the source filename:\n\n\nI see--that's those fake Cython hacked frames with fake code objects.  I didn't realize that would include the correct filename even for functions defined in `.pxd` file but apparently it does.\n\n> An ugly/hackish solution is still better than no solution at all.\n\n\nI agree, as long as we open a new ticket--either a separate ticket from this one for the hack solution, or a new ticket for tracking the issue (I'd prefer the former since closing this ticket means closing some valuable discussion).\n\n> I simply don't see a better solution, not even in theory.\n\n\nI still have some ideas about this, but it would require modification to Cython for sure.\n\nAdditionally (and much longer term) a very large part of the problem is the Python Loader API's assumption that a module has a single source file.  It seems the assumption is that \"for extension modules sure there may be many source files, but it's not useful for Python-level introspection to be able to return them\".  Sure, for normal extension modules.  But the Cython case obviously disproves that in general.  I think this is worth taking up but that's not going to help anytime soon.",
    "created_at": "2018-03-26T10:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468614",
    "user": "https://github.com/embray"
}
```

<a id='comment:39'></a>Replying to [jdemeyer](#comment%3A37):
> Replying to [embray](#comment%3A36):
> > how do we currently load the source for that function from the correct source file?

> 
> The traceback contains the source filename:


I see--that's those fake Cython hacked frames with fake code objects.  I didn't realize that would include the correct filename even for functions defined in `.pxd` file but apparently it does.

> An ugly/hackish solution is still better than no solution at all.


I agree, as long as we open a new ticket--either a separate ticket from this one for the hack solution, or a new ticket for tracking the issue (I'd prefer the former since closing this ticket means closing some valuable discussion).

> I simply don't see a better solution, not even in theory.


I still have some ideas about this, but it would require modification to Cython for sure.

Additionally (and much longer term) a very large part of the problem is the Python Loader API's assumption that a module has a single source file.  It seems the assumption is that "for extension modules sure there may be many source files, but it's not useful for Python-level introspection to be able to return them".  Sure, for normal extension modules.  But the Cython case obviously disproves that in general.  I think this is worth taking up but that's not going to help anytime soon.



---

archive/issue_comments_468615.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [embray](#comment%3A39):\n> I still have some ideas about this, but it would require modification to Cython for sure.\n\n\nIt is possible to explain what you are thinking of?",
    "created_at": "2018-03-26T12:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468615",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>Replying to [embray](#comment%3A39):
> I still have some ideas about this, but it would require modification to Cython for sure.


It is possible to explain what you are thinking of?



---

archive/issue_comments_468616.json:
```json
{
    "body": "<a id='comment:41'></a>I could try to explain but it's still a bit hand-wavey at the moment.  It also comes back around to the issue of subclassing the function type.",
    "created_at": "2018-03-26T12:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468616",
    "user": "https://github.com/embray"
}
```

<a id='comment:41'></a>I could try to explain but it's still a bit hand-wavey at the moment.  It also comes back around to the issue of subclassing the function type.



---

archive/issue_comments_468617.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,9 +2,9 @@\n \n Basically, the only reason it works at all on Python 2, is that the `linecache` module on Python 2 has some code which, given a relative filename (with an extension unrecognized by the import system) like `sage/rings/integer.pyx`, it will search for this file under all `sys.path` entries and, if found, read the source lines from that file.\n \n-This, in turn, only works for Sage because a) We tend to keep the Sage source code around via `SAGE_SRC`--itself kind of a hack. If Sage were installed like a normal Python package you wouldn't have this.  Instead we append `SAGE_SRC` to `sys.path` when importing Sage.  This works, but it's not something we *really* want to be doing.  A slightly better alternative might be to actually install the `.pyx` sources in the sage package.\n+This, in turn, only works for Sage because we actually install the `.pyx` sources in the sage package.\n \n-That said, that still wouldn't fix things for Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.\n+This does not work in Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.\n \n The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.\n \n``````\n",
    "created_at": "2018-04-24T15:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468617",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,9 +2,9 @@
 
 Basically, the only reason it works at all on Python 2, is that the `linecache` module on Python 2 has some code which, given a relative filename (with an extension unrecognized by the import system) like `sage/rings/integer.pyx`, it will search for this file under all `sys.path` entries and, if found, read the source lines from that file.
 
-This, in turn, only works for Sage because a) We tend to keep the Sage source code around via `SAGE_SRC`--itself kind of a hack. If Sage were installed like a normal Python package you wouldn't have this.  Instead we append `SAGE_SRC` to `sys.path` when importing Sage.  This works, but it's not something we *really* want to be doing.  A slightly better alternative might be to actually install the `.pyx` sources in the sage package.
+This, in turn, only works for Sage because we actually install the `.pyx` sources in the sage package.
 
-That said, that still wouldn't fix things for Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.
+This does not work in Python 3.  In `linecache.updatecache`, before it tries the `sys.path` search, it checks if the module object has a `__loader__`, and calls its `get_source()` method if it exists.  On Python 2 this isn't a problem since modules don't necessarily have a `__loader__`, and in particular extension modules don't.  But on the reworked import system in Python 3, pretty much every module has a `__loader__`--in the case of extension modules an `ExtensionFileLoader`.  But the built-in `ExtensionFileLoader` of course knows nothing about Cython so its `get_source()` method just returns `None`.  `linecache.updatecache` assumes this is correct (why would the loader lie?) and returns.
 
 The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.
 
``````




---

archive/issue_events_062138.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-04-24T15:00:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24681#event-62138"
}
```



---

archive/issue_events_062139.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-04-24T15:00:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24681#event-62139"
}
```



---

archive/issue_comments_468618.json:
```json
{
    "body": "<a id='comment:43'></a>Ping? Having this in Sage would help with the Python 3 porting effort...",
    "created_at": "2018-06-14T19:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468618",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>Ping? Having this in Sage would help with the Python 3 porting effort...



---

archive/issue_comments_468619.json:
```json
{
    "body": "<a id='comment:44'></a>If you prefer instead to add the Python patch from https://github.com/python/cpython/pull/6653 that would obviously be fine for me too.",
    "created_at": "2018-06-15T11:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468619",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>If you prefer instead to add the Python patch from https://github.com/python/cpython/pull/6653 that would obviously be fine for me too.



---

archive/issue_comments_468620.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,4 +8,7 @@\n \n The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.\n \n-**Upstream**: https://bugs.python.org/issue32797\n+**Upstream**:\n+\n+- https://bugs.python.org/issue32797\n+- https://github.com/python/cpython/pull/6653\n``````\n",
    "created_at": "2018-06-15T11:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468620",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,4 +8,7 @@
 
 The simplest way to fix this is to remove the `get_source()` method from the `ExtensionFileLoader` class. This way, Python 3 works the same way as Python 2.
 
-**Upstream**: https://bugs.python.org/issue32797
+**Upstream**:
+
+- https://bugs.python.org/issue32797
+- https://github.com/python/cpython/pull/6653
``````




---

archive/issue_comments_468621.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-15T18:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468621",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468622.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2018-06-15T18:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468622",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "" to "Frédéric Chapoton"



---

archive/issue_comments_468623.json:
```json
{
    "body": "<a id='comment:45'></a>Bot is green.. ok, let it be.",
    "created_at": "2018-06-15T18:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468623",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:45'></a>Bot is green.. ok, let it be.



---

archive/issue_events_062140.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-17T22:15:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24681#event-62140"
}
```



---

archive/issue_comments_468624.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/python3/cython-source-prototype\" to \"1a9225f70f8a49428d1874a47252a46791d3746d\"",
    "created_at": "2018-06-17T22:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468624",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/python3/cython-source-prototype" to "1a9225f70f8a49428d1874a47252a46791d3746d"



---

archive/issue_comments_468625.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-17T22:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468625",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_468626.json:
```json
{
    "body": "<a id='comment:47'></a>Follow up in #31420.",
    "created_at": "2021-09-07T06:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468626",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:47'></a>Follow up in #31420.



---

archive/issue_comments_468627.json:
```json
{
    "body": "Changing commit from \"1a9225f70f8a49428d1874a47252a46791d3746d\" to \"\"",
    "created_at": "2021-09-07T06:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24681#issuecomment-468627",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "1a9225f70f8a49428d1874a47252a46791d3746d" to ""
