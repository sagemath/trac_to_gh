# Issue 24655: Automatically build  docker images with CircleCI/GitLab CI

archive/issues_024418.json:
```json
{
    "body": "It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n\nThis ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n\nI implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n\nSee also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n\n---\n\nHere are some numbers and screenshots (click on the screenshots to go to the real pages):\n\n### [GitLab](GitLab) CI\n\nIf I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n\n<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n\nRecycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n* **32** minutes for `build-from-latest:\n  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n  * a few minutes running through all the fast stages of the Dockerfile.\n  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n\nWith some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n\n<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n\n### CircleCI\n\nIt typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n\n<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n\nRecycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n\n<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n\n### Docker Hub\n\nA push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n\n<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n\n---\n\nHere are some things that we need to test before merging this:\n\n* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653\n* [x] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c\n\n---\n\nAfter this ticket has been merged, the following steps are necessary:\n\n* ~~Setup an account for sagemath on Circle CI.~~\n* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n\nTo see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n\n---\n\n\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n\nPS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n\nCC:  @roed314 @embray @nthiery @mkoeppe @jdemeyer @hivert\n\nKeywords: docker, CI\n\nReviewer: Erik Bray\n\nAuthor: Julian R\u00fcth\n\nBranch: ac6201a942aa19b6181c463cac8e9588e92b3d8a\n\nDependencies: #25161, #25160\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24655\n\n",
    "closed_at": "2018-08-25T11:01:30Z",
    "created_at": "2018-02-04T18:42:45Z",
    "labels": [
        "component: distribution",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Automatically build  docker images with CircleCI/GitLab CI",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24655",
    "user": "https://github.com/saraedum"
}
```
It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹

This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.

I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.

See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)

---

Here are some numbers and screenshots (click on the screenshots to go to the real pages):

### [GitLab](GitLab) CI

If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.

<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>

Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
* **32** minutes for `build-from-latest:
  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
  * a few minutes running through all the fast stages of the Dockerfile.
  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)

With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.

<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>

### CircleCI

It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 

<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>

Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.

<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>

### Docker Hub

A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.

<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>

---

Here are some things that we need to test before merging this:

* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653
* [x] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c

---

After this ticket has been merged, the following steps are necessary:

* ~~Setup an account for sagemath on Circle CI.~~
* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).

To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.

---

¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.

PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.

CC:  @roed314 @embray @nthiery @mkoeppe @jdemeyer @hivert

Keywords: docker, CI

Reviewer: Erik Bray

Author: Julian Rüth

Branch: ac6201a942aa19b6181c463cac8e9588e92b3d8a

Dependencies: #25161, #25160

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24655





---

archive/issue_comments_364257.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,6 +14,8 @@\n \n See also https://github.com/sagemath/docker-images/issues/13.\n \n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n \u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n \n Author: Julian R\u00fcth\n``````\n",
    "created_at": "2018-02-04T18:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364257",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,6 +14,8 @@
 
 See also https://github.com/sagemath/docker-images/issues/13.
 
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
 ¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
 
 Author: Julian Rüth
``````




---

archive/issue_comments_364258.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2018-02-04T19:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364258",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_364259.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) can also be used to update the README on Docker Hub automatically.\n+\n+Steps that need to be taken for this to work:\n+\n+* Replace all occurences of `saraedum` with `sagemath` in this branch.\n+* Merge this ticket (i.e., the content of https://github.com/saraedum/sage/tree/gitlabci)\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+See also https://github.com/sagemath/docker-images/issues/13.\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-02-04T19:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364259",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,24 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) can also be used to update the README on Docker Hub automatically.
+
+Steps that need to be taken for this to work:
+
+* Replace all occurences of `saraedum` with `sagemath` in this branch.
+* Merge this ticket (i.e., the content of https://github.com/saraedum/sage/tree/gitlabci)
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+See also https://github.com/sagemath/docker-images/issues/13.
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364260.json:
```json
{
    "body": "<a id='comment:4'></a>I haven't played much with [GitLab](GitLab) CI and CircleCI, so can't really comment on the details for now. But +1 for the general idea. That would be very helpful.",
    "created_at": "2018-02-04T21:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364260",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:4'></a>I haven't played much with [GitLab](GitLab) CI and CircleCI, so can't really comment on the details for now. But +1 for the general idea. That would be very helpful.



---

archive/issue_comments_364261.json:
```json
{
    "body": "<a id='comment:5'></a>Adding Matthias who did setup continuous integration for various Sage packages (including https://github.com/sagemath/sage_sample).",
    "created_at": "2018-02-04T21:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364261",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:5'></a>Adding Matthias who did setup continuous integration for various Sage packages (including https://github.com/sagemath/sage_sample).



---

archive/issue_comments_364262.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-04T21:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364262",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364263.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-04T21:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364263",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364264.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-16T20:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364264",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364265.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-17T13:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364265",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364266.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-17T17:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364266",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364267.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-18T22:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364267",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364268.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-26T08:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364269.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,29 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-02-26T08:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364269",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,29 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364270.json:
```json
{
    "body": "Attachment [gitlab.png](tarball://root/attachments/some-uuid/ticket24655/gitlab.png) by @saraedum created at 2018-02-26 08:39:35\n\nscreenshot",
    "created_at": "2018-02-26T08:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364270",
    "user": "https://github.com/saraedum"
}
```

Attachment [gitlab.png](tarball://root/attachments/some-uuid/ticket24655/gitlab.png) by @saraedum created at 2018-02-26 08:39:35

screenshot



---

archive/issue_comments_364271.json:
```json
{
    "body": "screenshot",
    "created_at": "2018-02-26T08:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364271",
    "user": "https://github.com/saraedum"
}
```

screenshot



---

archive/issue_comments_364272.json:
```json
{
    "body": "Attachment [circleci.png](tarball://root/attachments/some-uuid/ticket24655/circleci.png) by @saraedum created at 2018-02-26 08:40:07\n\nscreenshot",
    "created_at": "2018-02-26T08:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364272",
    "user": "https://github.com/saraedum"
}
```

Attachment [circleci.png](tarball://root/attachments/some-uuid/ticket24655/circleci.png) by @saraedum created at 2018-02-26 08:40:07

screenshot



---

archive/issue_comments_364273.json:
```json
{
    "body": "Attachment [circleci-rebuild.png](tarball://root/attachments/some-uuid/ticket24655/circleci-rebuild.png) by @saraedum created at 2018-02-26 08:40:20\n\nscreenshot",
    "created_at": "2018-02-26T08:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364273",
    "user": "https://github.com/saraedum"
}
```

Attachment [circleci-rebuild.png](tarball://root/attachments/some-uuid/ticket24655/circleci-rebuild.png) by @saraedum created at 2018-02-26 08:40:20

screenshot



---

archive/issue_comments_364274.json:
```json
{
    "body": "Attachment [dockerhub.png](tarball://root/attachments/some-uuid/ticket24655/dockerhub.png) by @saraedum created at 2018-02-26 08:42:22\n\nscreenshot",
    "created_at": "2018-02-26T08:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364274",
    "user": "https://github.com/saraedum"
}
```

Attachment [dockerhub.png](tarball://root/attachments/some-uuid/ticket24655/dockerhub.png) by @saraedum created at 2018-02-26 08:42:22

screenshot



---

archive/issue_comments_364275.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,58 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. Much of the time is spent uploading the docker images. We could probably bring this down a bit by not uploading the `sagemath-dev` image on branches where it is not really useful.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page:\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-02-26T08:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364275",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,58 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. Much of the time is spent uploading the docker images. We could probably bring this down a bit by not uploading the `sagemath-dev` image on branches where it is not really useful.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page:
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364276.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-26T08:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364276",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_364277.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,66 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. This roughly breaks down as:\n+* 30 minutes for `build-from-latest`:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild)\n+  * 10 minutes to copy the files locally for the `sagemath` and `sagemath-dev` image\n+  * the rest of the time is split between pulling the `sagemath-dev` image from Docker Hub and pushing the `sagemath` image and the `sagemath-dev` image to [GitLab](GitLab) registry.\n+* 3 - 10 minutes for each test (run in parallel,) much of which is spent in downloading the `sagemath` image from the [GitLab](GitLab) registry.\n+* 13 minutes for the publishing to Docker Hub, half of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly.\n+\n+With some tricks we could probably bring this down to 35 minutes (see CircleCI below) but we won't get this down to 25 without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually. We could probably save 5 minutes by not pushing the `sagemath-dev` image as it is usually not needed. Another 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 25 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page:\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-02-26T12:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364277",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,66 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. This roughly breaks down as:
+* 30 minutes for `build-from-latest`:
+  * 6 minutes for the actual build (most of which is spent in the docbuild)
+  * 10 minutes to copy the files locally for the `sagemath` and `sagemath-dev` image
+  * the rest of the time is split between pulling the `sagemath-dev` image from Docker Hub and pushing the `sagemath` image and the `sagemath-dev` image to [GitLab](GitLab) registry.
+* 3 - 10 minutes for each test (run in parallel,) much of which is spent in downloading the `sagemath` image from the [GitLab](GitLab) registry.
+* 13 minutes for the publishing to Docker Hub, half of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly.
+
+With some tricks we could probably bring this down to 35 minutes (see CircleCI below) but we won't get this down to 25 without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually. We could probably save 5 minutes by not pushing the `sagemath-dev` image as it is usually not needed. Another 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 25 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page:
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364278.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-26T12:24:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364278",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364279.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,66 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. This roughly breaks down as:\n+* 30 minutes for `build-from-latest`:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild)\n+  * 10 minutes to copy the files locally for the `sagemath` and `sagemath-dev` image\n+  * the rest of the time is split between pulling the `sagemath-dev` image from Docker Hub and pushing the `sagemath` image and the `sagemath-dev` image to [GitLab](GitLab) registry.\n+* 3 - 10 minutes for each test (run in parallel,) much of which is spent in downloading the `sagemath` image from the [GitLab](GitLab) registry.\n+* 13 minutes for the publishing to Docker Hub, half of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly.\n+\n+With some tricks we could probably bring this down to 35 minutes (see CircleCI below) but we won't get this down to 25 without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually. We could probably save 5 minutes by not pushing the `sagemath-dev` image as it is usually not needed. Another 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 25 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-02-26T12:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364279",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,66 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. This roughly breaks down as:
+* 30 minutes for `build-from-latest`:
+  * 6 minutes for the actual build (most of which is spent in the docbuild)
+  * 10 minutes to copy the files locally for the `sagemath` and `sagemath-dev` image
+  * the rest of the time is split between pulling the `sagemath-dev` image from Docker Hub and pushing the `sagemath` image and the `sagemath-dev` image to [GitLab](GitLab) registry.
+* 3 - 10 minutes for each test (run in parallel,) much of which is spent in downloading the `sagemath` image from the [GitLab](GitLab) registry.
+* 13 minutes for the publishing to Docker Hub, half of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly.
+
+With some tricks we could probably bring this down to 35 minutes (see CircleCI below) but we won't get this down to 25 without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually. We could probably save 5 minutes by not pushing the `sagemath-dev` image as it is usually not needed. Another 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 25 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364280.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-26T14:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364281.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-02-26T14:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_364282.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-26T15:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364283.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-26T17:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364283",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364284.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,66 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. This roughly breaks down as:\n+* 30 minutes for `build-from-latest`:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild)\n+  * 10 minutes to copy the files locally for the `sagemath` and `sagemath-dev` image\n+  * the rest of the time is split between pulling the `sagemath-dev` image from Docker Hub and pushing the `sagemath` image and the `sagemath-dev` image to [GitLab](GitLab) registry.\n+* 3 - 10 minutes for each test (run in parallel,) much of which is spent in downloading the `sagemath` image from the [GitLab](GitLab) registry.\n+* 13 minutes for the publishing to Docker Hub, half of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly.\n+\n+With some tricks we could probably bring this down to 35 minutes (see CircleCI below) but we won't get this down to 25 without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually. We could probably save 5 minutes by not pushing the `sagemath-dev` image as it is usually not needed. Another 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 25 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath:develop.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev:develop.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-02-26T20:57:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364284",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,66 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to less than 50 minutes. This roughly breaks down as:
+* 30 minutes for `build-from-latest`:
+  * 6 minutes for the actual build (most of which is spent in the docbuild)
+  * 10 minutes to copy the files locally for the `sagemath` and `sagemath-dev` image
+  * the rest of the time is split between pulling the `sagemath-dev` image from Docker Hub and pushing the `sagemath` image and the `sagemath-dev` image to [GitLab](GitLab) registry.
+* 3 - 10 minutes for each test (run in parallel,) much of which is spent in downloading the `sagemath` image from the [GitLab](GitLab) registry.
+* 13 minutes for the publishing to Docker Hub, half of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly.
+
+With some tricks we could probably bring this down to 35 minutes (see CircleCI below) but we won't get this down to 25 without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes usually. We could probably save 5 minutes by not pushing the `sagemath-dev` image as it is usually not needed. Another 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 25 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath:develop.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev:develop.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364285.json:
```json
{
    "body": "<a id='comment:23'></a>Maybe my microrelease image is missing something essential? I get a lot of inspection related doctest errors: https://gitlab.com/saraedum/sage/-/jobs/54609045",
    "created_at": "2018-02-27T13:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364285",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:23'></a>Maybe my microrelease image is missing something essential? I get a lot of inspection related doctest errors: https://gitlab.com/saraedum/sage/-/jobs/54609045



---

archive/issue_comments_364286.json:
```json
{
    "body": "<a id='comment:24'></a>\n```\nsage -t src/doc/common/conf.py  # 1 doctest failed\nsage -t src/sage/arith/long.pxd  # 9 doctests failed\nsage -t src/sage/cpython/cython_metaclass.pyx  # 4 doctests failed\nsage -t src/sage/cpython/getattr.pyx  # 4 doctests failed\nsage -t src/sage/cpython/wrapperdescr.pxd  # 6 doctests failed\nsage -t src/sage/docs/instancedoc.pyx  # 4 doctests failed\nsage -t src/sage/ext/cdefs.pxi  # 1 doctest failed\nsage -t src/sage/ext/memory_allocator.pyx  # 2 doctests failed\nsage -t src/sage/ext/stdsage.pxi  # 1 doctest failed\nsage -t src/sage/libs/gap/util.pyx  # 2 doctests failed\nsage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed\nsage -t src/sage/misc/cachefunc.pyx  # 54 doctests failed\nsage -t src/sage/misc/cython.py  # 17 doctests failed\nsage -t src/sage/misc/cython_c.pyx  # 1 doctest failed\nsage -t src/sage/misc/inherit_comparison.pyx  # 5 doctests failed\nsage -t src/sage/misc/lazy_attribute.pyx  # 3 doctests failed\nsage -t src/sage/misc/nested_class.pyx  # 6 doctests failed\nsage -t src/sage/misc/sagedoc.py  # 6 doctests failed\nsage -t src/sage/misc/sageinspect.py  # 31 doctests failed\nsage -t src/sage/misc/session.pyx  # 2 doctests failed\nsage -t src/sage/misc/superseded.py  # 2 doctests failed\nsage -t src/sage/parallel/decorate.py  # 2 doctests failed\nsage -t src/sage/repl/ipython_extension.py  # 1 doctest failed\nsage -t src/sage/repl/load.py  # 2 doctests failed\nsage -t src/sage/rings/integer_fake.pxd  # 1 doctest failed\nsage -t src/sage/structure/element.pxd  # 1 doctest failed\nsage -t src/sage/structure/element.pyx  # 38 doctests failed\nsage -t src/sage/structure/factory.pyx  # 8 doctests failed\nsage -t src/sage/tests/cmdline.py  # 4 doctests failed\n```",
    "created_at": "2018-03-01T09:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364286",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:24'></a>
```
sage -t src/doc/common/conf.py  # 1 doctest failed
sage -t src/sage/arith/long.pxd  # 9 doctests failed
sage -t src/sage/cpython/cython_metaclass.pyx  # 4 doctests failed
sage -t src/sage/cpython/getattr.pyx  # 4 doctests failed
sage -t src/sage/cpython/wrapperdescr.pxd  # 6 doctests failed
sage -t src/sage/docs/instancedoc.pyx  # 4 doctests failed
sage -t src/sage/ext/cdefs.pxi  # 1 doctest failed
sage -t src/sage/ext/memory_allocator.pyx  # 2 doctests failed
sage -t src/sage/ext/stdsage.pxi  # 1 doctest failed
sage -t src/sage/libs/gap/util.pyx  # 2 doctests failed
sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
sage -t src/sage/misc/cachefunc.pyx  # 54 doctests failed
sage -t src/sage/misc/cython.py  # 17 doctests failed
sage -t src/sage/misc/cython_c.pyx  # 1 doctest failed
sage -t src/sage/misc/inherit_comparison.pyx  # 5 doctests failed
sage -t src/sage/misc/lazy_attribute.pyx  # 3 doctests failed
sage -t src/sage/misc/nested_class.pyx  # 6 doctests failed
sage -t src/sage/misc/sagedoc.py  # 6 doctests failed
sage -t src/sage/misc/sageinspect.py  # 31 doctests failed
sage -t src/sage/misc/session.pyx  # 2 doctests failed
sage -t src/sage/misc/superseded.py  # 2 doctests failed
sage -t src/sage/parallel/decorate.py  # 2 doctests failed
sage -t src/sage/repl/ipython_extension.py  # 1 doctest failed
sage -t src/sage/repl/load.py  # 2 doctests failed
sage -t src/sage/rings/integer_fake.pxd  # 1 doctest failed
sage -t src/sage/structure/element.pxd  # 1 doctest failed
sage -t src/sage/structure/element.pyx  # 38 doctests failed
sage -t src/sage/structure/factory.pyx  # 8 doctests failed
sage -t src/sage/tests/cmdline.py  # 4 doctests failed
```



---

archive/issue_comments_364287.json:
```json
{
    "body": "<a id='comment:25'></a>Making good progress\u2026\n\n```\nsage -t src/doc/common/conf.py  # 1 doctest failed\nsage -t src/sage/misc/cython.py  # 5 doctests failed\nsage -t src/sage/misc/sagedoc.py  # 4 doctests failed\n```",
    "created_at": "2018-03-04T09:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364287",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:25'></a>Making good progress…

```
sage -t src/doc/common/conf.py  # 1 doctest failed
sage -t src/sage/misc/cython.py  # 5 doctests failed
sage -t src/sage/misc/sagedoc.py  # 4 doctests failed
```



---

archive/issue_comments_364288.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-03-04T15:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_364289.json:
```json
{
    "body": "<a id='comment:27'></a>Julian walked me through this last week and it is very good stuff and I'm +1 on it.\n\nMy one concern is that by including the CI configuration files directly in the main Sage repo, it may be difficult to update things quickly if/when they break.  In the long term I'd much prefer it if Sage's 'master' branch were used more like other projects typically do, as a fast-moving development branch where we can easily push changes quickly if need be, particularly for the CI config, for which perhaps we could make a special dispensation.\n\nIn the meantime, perhaps the CI builds should be based on a \"ci\" branch of Sage which, most of the time, would just be kept up to date with `develop`, but that we could also commit to more frequently *if needed*.\n\nIs this still needs_review, or should it be needs_work?",
    "created_at": "2018-03-05T10:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364289",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>Julian walked me through this last week and it is very good stuff and I'm +1 on it.

My one concern is that by including the CI configuration files directly in the main Sage repo, it may be difficult to update things quickly if/when they break.  In the long term I'd much prefer it if Sage's 'master' branch were used more like other projects typically do, as a fast-moving development branch where we can easily push changes quickly if need be, particularly for the CI config, for which perhaps we could make a special dispensation.

In the meantime, perhaps the CI builds should be based on a "ci" branch of Sage which, most of the time, would just be kept up to date with `develop`, but that we could also commit to more frequently *if needed*.

Is this still needs_review, or should it be needs_work?



---

archive/issue_comments_364290.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-05T12:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364291.json:
```json
{
    "body": "<a id='comment:29'></a>I see your concerns but I think it has to be in the main branch to be useful. If we have it on a separate branch, how would I use it if I want it on my branch? Merge it in and then in the end force push a version without CI?\n\nThis actually needs review. I am tweaking this in a few places to make it run faster and produce smaller images but I am not planning on making any substantial changes anymore.",
    "created_at": "2018-03-05T12:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364291",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:29'></a>I see your concerns but I think it has to be in the main branch to be useful. If we have it on a separate branch, how would I use it if I want it on my branch? Merge it in and then in the end force push a version without CI?

This actually needs review. I am tweaking this in a few places to make it run faster and produce smaller images but I am not planning on making any substantial changes anymore.



---

archive/issue_comments_364292.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-05T18:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364293.json:
```json
{
    "body": "<a id='comment:32'></a>New commits:",
    "created_at": "2018-03-05T18:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364293",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:32'></a>New commits:



---

archive/issue_comments_364294.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-05T18:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364294",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364295.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,67 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* 20 minutes for `build-from-latest:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath:develop.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev:develop.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-03-05T18:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364295",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,67 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* 20 minutes for `build-from-latest:
+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath:develop.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev:develop.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 36 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364296.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-05T20:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364296",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364297.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,67 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* 20 minutes for `build-from-latest:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath:develop.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev:develop.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 4 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-03-06T13:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364297",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,67 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* 20 minutes for `build-from-latest:
+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath:develop.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev:develop.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 4 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364298.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:29 saraedum]:\n> I see your concerns but I think it has to be in the main branch to be useful. If we have it on a separate branch, how would I use it if I want it on my branch? Merge it in and then in the end force push a version without CI?\n\n\nMy point was that Sage's \"develop\" branch moves at a slow pace as it currently does, but we have a separate branch (synced regularly to the current \"develop\") that is allowed to move faster, more like how most projects use \"master\".\n\nSo it wouldn't just be for continuous integration.  That is, the CI stuff would still be in the main branch, but we would have a separate development branch from \"develop\" that can be a bit more agile, accept merge requests, etc.",
    "created_at": "2018-03-07T09:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364298",
    "user": "https://github.com/embray"
}
```

<a id='comment:38'></a>Replying to [comment:29 saraedum]:
> I see your concerns but I think it has to be in the main branch to be useful. If we have it on a separate branch, how would I use it if I want it on my branch? Merge it in and then in the end force push a version without CI?


My point was that Sage's "develop" branch moves at a slow pace as it currently does, but we have a separate branch (synced regularly to the current "develop") that is allowed to move faster, more like how most projects use "master".

So it wouldn't just be for continuous integration.  That is, the CI stuff would still be in the main branch, but we would have a separate development branch from "develop" that can be a bit more agile, accept merge requests, etc.



---

archive/issue_comments_364299.json:
```json
{
    "body": "<a id='comment:39'></a>\n```diff\ndiff --git a/Makefile b/Makefile\nindex 9245745..468302b 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -68,6 +68,7 @@ misc-clean:\n \trm -f build/make/Makefile build/make/Makefile-auto\n \trm -f .BUILDSTART\n \n+# TODO: What is a \"bdist\"? A binary distribution?\n bdist-clean: clean\n \t$(MAKE) misc-clean\n```\n\nYes--this just does `misc-clean` but also cleans up `$SAGE_LOCAL/var/tmp/sage/build`.  I think you can just remove this TODO note unless you had some specific intentions here.",
    "created_at": "2018-03-07T10:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364299",
    "user": "https://github.com/embray"
}
```

<a id='comment:39'></a>
```diff
diff --git a/Makefile b/Makefile
index 9245745..468302b 100644
--- a/Makefile
+++ b/Makefile
@@ -68,6 +68,7 @@ misc-clean:
 	rm -f build/make/Makefile build/make/Makefile-auto
 	rm -f .BUILDSTART
 
+# TODO: What is a "bdist"? A binary distribution?
 bdist-clean: clean
 	$(MAKE) misc-clean
```

Yes--this just does `misc-clean` but also cleans up `$SAGE_LOCAL/var/tmp/sage/build`.  I think you can just remove this TODO note unless you had some specific intentions here.



---

archive/issue_comments_364300.json:
```json
{
    "body": "<a id='comment:40'></a>\n```diff\n+\t@# We need src/sage/, src/doc/common, src/doc/en/introspect for introspection with \"??\"\n```\n\nI believe since #24690 this is no longer true, at least with regard to `src/sage`.  Actually you might be able to get away with completely deleting `src/sage` since it's basically duplicated in `$SAGE_LOCAL/lib/python2.7/site-packages/sage`.  Though it's possible there's some small tests that will still fail without it--worth a try.\n\nThat said, it might not be much of an issue if the `rdfind` stuff works.",
    "created_at": "2018-03-07T10:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364300",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'></a>
```diff
+	@# We need src/sage/, src/doc/common, src/doc/en/introspect for introspection with "??"
```

I believe since #24690 this is no longer true, at least with regard to `src/sage`.  Actually you might be able to get away with completely deleting `src/sage` since it's basically duplicated in `$SAGE_LOCAL/lib/python2.7/site-packages/sage`.  Though it's possible there's some small tests that will still fail without it--worth a try.

That said, it might not be much of an issue if the `rdfind` stuff works.



---

archive/issue_comments_364301.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:38 embray]:\n> Replying to [comment:29 saraedum]:\n> > I see your concerns but I think it has to be in the main branch to be useful. If we have it on a separate branch, how would I use it if I want it on my branch? Merge it in and then in the end force push a version without CI?\n\n> My point was that Sage's \"develop\" branch moves at a slow pace as it currently does, but we have a separate branch (synced regularly to the current \"develop\") that is allowed to move faster, more like how most projects use \"master\".\n\n> So it wouldn't just be for continuous integration.  That is, the CI stuff would still be in the main branch, but we would have a separate development branch from \"develop\" that can be a bit more agile, accept merge requests, etc.\nOk. I am not exactly sure what you are proposing with regards to this ticket. I would not mind a develop branch that moves at a faster pace however.",
    "created_at": "2018-03-07T10:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364301",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:41'></a>Replying to [comment:38 embray]:
> Replying to [comment:29 saraedum]:
> > I see your concerns but I think it has to be in the main branch to be useful. If we have it on a separate branch, how would I use it if I want it on my branch? Merge it in and then in the end force push a version without CI?

> My point was that Sage's "develop" branch moves at a slow pace as it currently does, but we have a separate branch (synced regularly to the current "develop") that is allowed to move faster, more like how most projects use "master".

> So it wouldn't just be for continuous integration.  That is, the CI stuff would still be in the main branch, but we would have a separate development branch from "develop" that can be a bit more agile, accept merge requests, etc.
Ok. I am not exactly sure what you are proposing with regards to this ticket. I would not mind a develop branch that moves at a faster pace however.



---

archive/issue_comments_364302.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:39 embray]:\n> {{{\n> #!diff\n> diff --git a/Makefile b/Makefile\n> index 9245745..468302b 100644\n> --- a/Makefile\n> +++ b/Makefile\n> `@``@` -68,6 +68,7 `@``@` misc-clean:\n>  \trm -f build/make/Makefile build/make/Makefile-auto\n>  \trm -f .BUILDSTART\n>  \n> +# TODO: What is a \"bdist\"? A binary distribution?\n>  bdist-clean: clean\n>  \t$(MAKE) misc-clean\n> }}}\n> \n> Yes--this just does `misc-clean` but also cleans up `$SAGE_LOCAL/var/tmp/sage/build`.  I think you can just remove this TODO note unless you had some specific intentions here.\n\n\nI would like to document what this is good for. So\u2026what is the use case for this target?",
    "created_at": "2018-03-07T10:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364302",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:42'></a>Replying to [comment:39 embray]:
> {{{
> #!diff
> diff --git a/Makefile b/Makefile
> index 9245745..468302b 100644
> --- a/Makefile
> +++ b/Makefile
> `@``@` -68,6 +68,7 `@``@` misc-clean:
>  	rm -f build/make/Makefile build/make/Makefile-auto
>  	rm -f .BUILDSTART
>  
> +# TODO: What is a "bdist"? A binary distribution?
>  bdist-clean: clean
>  	$(MAKE) misc-clean
> }}}
> 
> Yes--this just does `misc-clean` but also cleans up `$SAGE_LOCAL/var/tmp/sage/build`.  I think you can just remove this TODO note unless you had some specific intentions here.


I would like to document what this is good for. So…what is the use case for this target?



---

archive/issue_comments_364303.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:42 saraedum]:\n> I would like to document what this is good for. So\u2026what is the use case for this target?\n\n\nIt seems clear to me that it cleans up all build artifacts in preparation for a binary release.  But you might want to ask Volker.",
    "created_at": "2018-03-07T10:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364303",
    "user": "https://github.com/embray"
}
```

<a id='comment:43'></a>Replying to [comment:42 saraedum]:
> I would like to document what this is good for. So…what is the use case for this target?


It seems clear to me that it cleans up all build artifacts in preparation for a binary release.  But you might want to ask Volker.



---

archive/issue_comments_364304.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:40 embray]:\n> {{{\n> #!diff\n> +\t`@`# We need src/sage/, src/doc/common, src/doc/en/introspect for introspection with \"??\"\n> }}}\n> \n> I believe since #24690 this is no longer true, at least with regard to `src/sage`.  Actually you might be able to get away with completely deleting `src/sage` since it's basically duplicated in `$SAGE_LOCAL/lib/python2.7/site-packages/sage`.  Though it's possible there's some small tests that will still fail without it--worth a try.\n> \n> That said, it might not be much of an issue if the `rdfind` stuff works.\n\nIt does not make a real difference with rdfind. Yes, it really seems that it is not needed for introspection anymore. I'll adapt the comment.",
    "created_at": "2018-03-07T10:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364304",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:44'></a>Replying to [comment:40 embray]:
> {{{
> #!diff
> +	`@`# We need src/sage/, src/doc/common, src/doc/en/introspect for introspection with "??"
> }}}
> 
> I believe since #24690 this is no longer true, at least with regard to `src/sage`.  Actually you might be able to get away with completely deleting `src/sage` since it's basically duplicated in `$SAGE_LOCAL/lib/python2.7/site-packages/sage`.  Though it's possible there's some small tests that will still fail without it--worth a try.
> 
> That said, it might not be much of an issue if the `rdfind` stuff works.

It does not make a real difference with rdfind. Yes, it really seems that it is not needed for introspection anymore. I'll adapt the comment.



---

archive/issue_comments_364305.json:
```json
{
    "body": "<a id='comment:45'></a>Is somebody using `micro_release` at the moment? It is way more aggressive now, so this might break some workflows. Who should I ask about this? \u2026 I'll write an email to sage-devel.",
    "created_at": "2018-03-07T10:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364305",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:45'></a>Is somebody using `micro_release` at the moment? It is way more aggressive now, so this might break some workflows. Who should I ask about this? … I'll write an email to sage-devel.



---

archive/issue_comments_364306.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-08T08:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364306",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364307.json:
```json
{
    "body": "<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-18T18:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364307",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364308.json:
```json
{
    "body": "<a id='comment:49'></a>I fixed the conflicts with develop. This needs review again.",
    "created_at": "2018-03-18T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364308",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:49'></a>I fixed the conflicts with develop. This needs review again.



---

archive/issue_comments_364309.json:
```json
{
    "body": "<a id='comment:50'></a>Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?",
    "created_at": "2018-03-20T11:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364309",
    "user": "https://github.com/embray"
}
```

<a id='comment:50'></a>Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?



---

archive/issue_comments_364310.json:
```json
{
    "body": "<a id='comment:51'></a>Perhaps you can clarify something for me.  I'm reading the documentation at https://docs.gitlab.com/ce/ci/docker/using_docker_build.html and at https://docs.gitlab.com/ce/ci/docker/using_docker_images.html (just to better understand some aspects of this), and the documentation *starts out* saying \"Install GitLab Runner, etc...\".  But just to be clear, this will work on GitLab-provided runners as well, right?  We don't necessarily have to be running our own in order for docker-in-docker to work?  (Not that we wouldn't want to be running our own runners anyways, but it would be disconcerting if that were necessary for this configuration to work properly at all).\n\nRelatedly, I don't understand this comment at all:\n\n```\n# We use docker-in-docker to build our docker images.  It can be faster to\n# expose your outer docker daemon by mounting /var/run/docker.sock to\n# /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret\n# variable to unix:///var/run/docker.sock\n```\n\nWhy would you set `DOCKER_HOST` as a secret?\n\nForgive me if these are annoying questions--I'm just trying to understand how this all works so that I can continue to help with it in the future.",
    "created_at": "2018-03-20T12:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364310",
    "user": "https://github.com/embray"
}
```

<a id='comment:51'></a>Perhaps you can clarify something for me.  I'm reading the documentation at https://docs.gitlab.com/ce/ci/docker/using_docker_build.html and at https://docs.gitlab.com/ce/ci/docker/using_docker_images.html (just to better understand some aspects of this), and the documentation *starts out* saying "Install GitLab Runner, etc...".  But just to be clear, this will work on GitLab-provided runners as well, right?  We don't necessarily have to be running our own in order for docker-in-docker to work?  (Not that we wouldn't want to be running our own runners anyways, but it would be disconcerting if that were necessary for this configuration to work properly at all).

Relatedly, I don't understand this comment at all:

```
# We use docker-in-docker to build our docker images.  It can be faster to
# expose your outer docker daemon by mounting /var/run/docker.sock to
# /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret
# variable to unix:///var/run/docker.sock
```

Why would you set `DOCKER_HOST` as a secret?

Forgive me if these are annoying questions--I'm just trying to understand how this all works so that I can continue to help with it in the future.



---

archive/issue_comments_364311.json:
```json
{
    "body": "<a id='comment:52'></a>I don't understand why you made this change:\n\n```diff\ndiff --git a/src/.gitignore b/src/.gitignore\ndeleted file mode 100644\nindex e85aa7f..00000000\n--- a/src/.gitignore\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-/.cython_version\n-/build\n-/Makefile\n-/bin/sage-env-config\n```\n\nYou simultaneously added the same ignores to the top-level `.gitignore` but it's not clear to me why.  I think it's pretty normal to have directory-specific `.gitignore`s and I think that one was fine as it was, unless there was some specific reason.",
    "created_at": "2018-03-20T12:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364311",
    "user": "https://github.com/embray"
}
```

<a id='comment:52'></a>I don't understand why you made this change:

```diff
diff --git a/src/.gitignore b/src/.gitignore
deleted file mode 100644
index e85aa7f..00000000
--- a/src/.gitignore
+++ /dev/null
@@ -1,4 +0,0 @@
-/.cython_version
-/build
-/Makefile
-/bin/sage-env-config
```

You simultaneously added the same ignores to the top-level `.gitignore` but it's not clear to me why.  I think it's pretty normal to have directory-specific `.gitignore`s and I think that one was fine as it was, unless there was some specific reason.



---

archive/issue_comments_364312.json:
```json
{
    "body": "<a id='comment:53'></a>One more annoying nitpick, but in `docker/README.md` can we wrap the lines, please?",
    "created_at": "2018-03-20T12:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364312",
    "user": "https://github.com/embray"
}
```

<a id='comment:53'></a>One more annoying nitpick, but in `docker/README.md` can we wrap the lines, please?



---

archive/issue_comments_364313.json:
```json
{
    "body": "<a id='comment:54'></a>It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.\n\nOn a similar note, I was confused by the documentation for `.ci/test-jupyter.sh` where it reads:\n\n```\n# Usage: ./test-jupyter.sh sage-jupyter-image [host]\n```\n\nThis gave me the impression that it should be used verbatim like `./test-jupyter.sh sage-jupyter-image`--as if there were actually an image called \"sage-jupyter-image\".  This might be clearer if it were documented in a more GNU-like style just as `./test-jupyter.sh IMAGE-NAME [HOST]`, making it clear that the first argument is the name (or hash for that matter) of some Docker image, not necessarily a *specific* image.\n\nI haven't looked at how all the other scripts are documented yet, but I would do them similarly.",
    "created_at": "2018-03-20T12:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364313",
    "user": "https://github.com/embray"
}
```

<a id='comment:54'></a>It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.

On a similar note, I was confused by the documentation for `.ci/test-jupyter.sh` where it reads:

```
# Usage: ./test-jupyter.sh sage-jupyter-image [host]
```

This gave me the impression that it should be used verbatim like `./test-jupyter.sh sage-jupyter-image`--as if there were actually an image called "sage-jupyter-image".  This might be clearer if it were documented in a more GNU-like style just as `./test-jupyter.sh IMAGE-NAME [HOST]`, making it clear that the first argument is the name (or hash for that matter) of some Docker image, not necessarily a *specific* image.

I haven't looked at how all the other scripts are documented yet, but I would do them similarly.



---

archive/issue_comments_364314.json:
```json
{
    "body": "<a id='comment:55'></a>Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?",
    "created_at": "2018-03-20T12:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364314",
    "user": "https://github.com/embray"
}
```

<a id='comment:55'></a>Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?



---

archive/issue_comments_364315.json:
```json
{
    "body": "<a id='comment:56'></a>(Since I'm asking for lots of little things, to be clear, I'm happy to make some of the requested changes myself--I just want to clarify some of them with you first.)",
    "created_at": "2018-03-20T12:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364315",
    "user": "https://github.com/embray"
}
```

<a id='comment:56'></a>(Since I'm asking for lots of little things, to be clear, I'm happy to make some of the requested changes myself--I just want to clarify some of them with you first.)



---

archive/issue_comments_364316.json:
```json
{
    "body": "<a id='comment:57'></a>Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.",
    "created_at": "2018-03-20T12:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364316",
    "user": "https://github.com/embray"
}
```

<a id='comment:57'></a>Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.



---

archive/issue_comments_364317.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:50 embray]:\n> Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?\n\n\nOk. Fixed.",
    "created_at": "2018-03-23T22:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364317",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:58'></a>Replying to [comment:50 embray]:
> Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?


Ok. Fixed.



---

archive/issue_comments_364318.json:
```json
{
    "body": "<a id='comment:59'></a>Replying to [comment:51 embray]:\n> Perhaps you can clarify something for me.  I'm reading the documentation at https://docs.gitlab.com/ce/ci/docker/using_docker_build.html and at https://docs.gitlab.com/ce/ci/docker/using_docker_images.html (just to better understand some aspects of this), and the documentation *starts out* saying \"Install GitLab Runner, etc...\".  But just to be clear, this will work on GitLab-provided runners as well, right?  We don't necessarily have to be running our own in order for docker-in-docker to work?  (Not that we wouldn't want to be running our own runners anyways, but it would be disconcerting if that were necessary for this configuration to work properly at all).\n\nYes, it works nicely with the provisioned runners out of the box.\n\n> Relatedly, I don't understand this comment at all:\n> \n> ```\n> # We use docker-in-docker to build our docker images.  It can be faster to\n> # expose your outer docker daemon by mounting /var/run/docker.sock to\n> # /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret\n> # variable to unix:///var/run/docker.sock\n> ```\n> \n> Why would you set `DOCKER_HOST` as a secret?\n\nEnvironment variables that are injected into the scripts that are described in `.gitlab-ci.yml` are called secrets in [GitLab](GitLab). They are not necessarily \"secret\". The `docker` docker image detects whether there is a host called `docker` and then assumes that this host is running `docker:dind` (or something similar.) You can disable this behaviour by explicitly setting `DOCKER_HOST`.\n\n> Forgive me if these are annoying questions--I'm just trying to understand how this all works so that I can continue to help with it in the future.\n\nNo worries at all. This is all a bit confusing.",
    "created_at": "2018-03-23T22:44:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364318",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:59'></a>Replying to [comment:51 embray]:
> Perhaps you can clarify something for me.  I'm reading the documentation at https://docs.gitlab.com/ce/ci/docker/using_docker_build.html and at https://docs.gitlab.com/ce/ci/docker/using_docker_images.html (just to better understand some aspects of this), and the documentation *starts out* saying "Install GitLab Runner, etc...".  But just to be clear, this will work on GitLab-provided runners as well, right?  We don't necessarily have to be running our own in order for docker-in-docker to work?  (Not that we wouldn't want to be running our own runners anyways, but it would be disconcerting if that were necessary for this configuration to work properly at all).

Yes, it works nicely with the provisioned runners out of the box.

> Relatedly, I don't understand this comment at all:
> 
> ```
> # We use docker-in-docker to build our docker images.  It can be faster to
> # expose your outer docker daemon by mounting /var/run/docker.sock to
> # /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret
> # variable to unix:///var/run/docker.sock
> ```
> 
> Why would you set `DOCKER_HOST` as a secret?

Environment variables that are injected into the scripts that are described in `.gitlab-ci.yml` are called secrets in [GitLab](GitLab). They are not necessarily "secret". The `docker` docker image detects whether there is a host called `docker` and then assumes that this host is running `docker:dind` (or something similar.) You can disable this behaviour by explicitly setting `DOCKER_HOST`.

> Forgive me if these are annoying questions--I'm just trying to understand how this all works so that I can continue to help with it in the future.

No worries at all. This is all a bit confusing.



---

archive/issue_comments_364319.json:
```json
{
    "body": "<a id='comment:60'></a>Replying to [comment:52 embray]:\n> I don't understand why you made this change:\n> \n> \n> ```\n> #!diff\n> diff --git a/src/.gitignore b/src/.gitignore\n> deleted file mode 100644\n> index e85aa7f..00000000\n> --- a/src/.gitignore\n> +++ /dev/null\n> @@ -1,4 +0,0 @@\n> -/.cython_version\n> -/build\n> -/Makefile\n> -/bin/sage-env-config\n> ```\n> \n> You simultaneously added the same ignores to the top-level `.gitignore` but it's not clear to me why.  I think it's pretty normal to have directory-specific `.gitignore`s and I think that one was fine as it was, unless there was some specific reason.\n\n\nI want these files to be part of `.dockerignore`. I symlinked `.dockerignore` to `.gitignore` in the root directory. However, docker does not support `.dockerignore` files in subdirectories, so I had to move these rules down.",
    "created_at": "2018-03-23T22:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364319",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:60'></a>Replying to [comment:52 embray]:
> I don't understand why you made this change:
> 
> 
> ```
> #!diff
> diff --git a/src/.gitignore b/src/.gitignore
> deleted file mode 100644
> index e85aa7f..00000000
> --- a/src/.gitignore
> +++ /dev/null
> @@ -1,4 +0,0 @@
> -/.cython_version
> -/build
> -/Makefile
> -/bin/sage-env-config
> ```
> 
> You simultaneously added the same ignores to the top-level `.gitignore` but it's not clear to me why.  I think it's pretty normal to have directory-specific `.gitignore`s and I think that one was fine as it was, unless there was some specific reason.


I want these files to be part of `.dockerignore`. I symlinked `.dockerignore` to `.gitignore` in the root directory. However, docker does not support `.dockerignore` files in subdirectories, so I had to move these rules down.



---

archive/issue_comments_364320.json:
```json
{
    "body": "<a id='comment:61'></a>Replying to [comment:53 embray]:\n> One more annoying nitpick, but in `docker/README.md` can we wrap the lines, please?\n\nNo :) I added a comment to the README about this.",
    "created_at": "2018-03-23T22:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364320",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:61'></a>Replying to [comment:53 embray]:
> One more annoying nitpick, but in `docker/README.md` can we wrap the lines, please?

No :) I added a comment to the README about this.



---

archive/issue_comments_364321.json:
```json
{
    "body": "<a id='comment:62'></a>Replying to [comment:54 embray]:\n> It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.\n\nI had this originally but then removed it. It's a bit annoying to build both images because you need to upload the full image to dockerhub (dockerhub does not detect shared layers between repositories it seems.) The \"docker run\" string is more complicated anyway, since you need the port forwarding. Do you think what it says in the README is not sufficient for people to just copy and paste it? he command should work on all POSIX shells I think.\n\n> On a similar note, I was confused by the documentation for `.ci/test-jupyter.sh` where it reads:\n> \n> \n> ```\n> # Usage: ./test-jupyter.sh sage-jupyter-image [host]\n> ```\n> \n> This gave me the impression that it should be used verbatim like `./test-jupyter.sh sage-jupyter-image`--as if there were actually an image called \"sage-jupyter-image\".  This might be clearer if it were documented in a more GNU-like style just as `./test-jupyter.sh IMAGE-NAME [HOST]`, making it clear that the first argument is the name (or hash for that matter) of some Docker image, not necessarily a *specific* image.\n> \n> I haven't looked at how all the other scripts are documented yet, but I would do them similarly.\nOk. Fixed.",
    "created_at": "2018-03-23T22:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364321",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:62'></a>Replying to [comment:54 embray]:
> It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.

I had this originally but then removed it. It's a bit annoying to build both images because you need to upload the full image to dockerhub (dockerhub does not detect shared layers between repositories it seems.) The "docker run" string is more complicated anyway, since you need the port forwarding. Do you think what it says in the README is not sufficient for people to just copy and paste it? he command should work on all POSIX shells I think.

> On a similar note, I was confused by the documentation for `.ci/test-jupyter.sh` where it reads:
> 
> 
> ```
> # Usage: ./test-jupyter.sh sage-jupyter-image [host]
> ```
> 
> This gave me the impression that it should be used verbatim like `./test-jupyter.sh sage-jupyter-image`--as if there were actually an image called "sage-jupyter-image".  This might be clearer if it were documented in a more GNU-like style just as `./test-jupyter.sh IMAGE-NAME [HOST]`, making it clear that the first argument is the name (or hash for that matter) of some Docker image, not necessarily a *specific* image.
> 
> I haven't looked at how all the other scripts are documented yet, but I would do them similarly.
Ok. Fixed.



---

archive/issue_comments_364322.json:
```json
{
    "body": "<a id='comment:63'></a>Replying to [comment:55 embray]:\n> Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?\n\nIf I understood correctly, `sagemath-develop` is referring to Sage's `develop` branch. My thinking was to use something that can not get confused with an existing term in Sage. Also, my `sagemath` images are continuing what the existing `sagemath` images do. But the `sagemath-dev` images are not really related to the `sagemath-develop` images. I am open to replacing `dev` with something else.",
    "created_at": "2018-03-23T22:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364322",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:63'></a>Replying to [comment:55 embray]:
> Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?

If I understood correctly, `sagemath-develop` is referring to Sage's `develop` branch. My thinking was to use something that can not get confused with an existing term in Sage. Also, my `sagemath` images are continuing what the existing `sagemath` images do. But the `sagemath-dev` images are not really related to the `sagemath-develop` images. I am open to replacing `dev` with something else.



---

archive/issue_comments_364323.json:
```json
{
    "body": "<a id='comment:64'></a>Replying to [comment:57 embray]:\n> Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.\n\nIt's inside the `docker/` directory so you usually won't see it. It's also .gitignore-d (but not .dockerignore-d!). I don't have a very strong opinion on this but I would need to change a bunch of things in my local setup here (not part of this ticket) if I changed this.",
    "created_at": "2018-03-23T22:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364323",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:64'></a>Replying to [comment:57 embray]:
> Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.

It's inside the `docker/` directory so you usually won't see it. It's also .gitignore-d (but not .dockerignore-d!). I don't have a very strong opinion on this but I would need to change a bunch of things in my local setup here (not part of this ticket) if I changed this.



---

archive/issue_comments_364324.json:
```json
{
    "body": "<a id='comment:65'></a>Replying to [comment:56 embray]:\n> (Since I'm asking for lots of little things, to be clear, I'm happy to make some of the requested changes myself--I just want to clarify some of them with you first.)\n\nYour comments are very much appreciated. I think it's easier for me to fix things as I work with these files all the time. But feel free to push your own changes of course.",
    "created_at": "2018-03-23T23:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364324",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:65'></a>Replying to [comment:56 embray]:
> (Since I'm asking for lots of little things, to be clear, I'm happy to make some of the requested changes myself--I just want to clarify some of them with you first.)

Your comments are very much appreciated. I think it's easier for me to fix things as I work with these files all the time. But feel free to push your own changes of course.



---

archive/issue_comments_364325.json:
```json
{
    "body": "<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-23T23:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364326.json:
```json
{
    "body": "<a id='comment:69'></a>I am now getting\n\n```\nStep 40/42 : RUN make build\n ---> Running in 9605e7f7ecf4\nbuild/make/Makefile --stop\nmake: build/make/Makefile: Command not found\nMakefile:20: recipe for target 'all-build' failed\n```\n\nHas anything changed in Sage recently that could cause this?",
    "created_at": "2018-03-23T23:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364326",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:69'></a>I am now getting

```
Step 40/42 : RUN make build
 ---> Running in 9605e7f7ecf4
build/make/Makefile --stop
make: build/make/Makefile: Command not found
Makefile:20: recipe for target 'all-build' failed
```

Has anything changed in Sage recently that could cause this?



---

archive/issue_comments_364327.json:
```json
{
    "body": "<a id='comment:70'></a>Replying to [comment:59 saraedum]:\n> Replying to [comment:51 embray]:\n> > Relatedly, I don't understand this comment at all:\n> > \n> > ```\n> > # We use docker-in-docker to build our docker images.  It can be faster to\n> > # expose your outer docker daemon by mounting /var/run/docker.sock to\n> > # /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret\n> > # variable to unix:///var/run/docker.sock\n> > ```\n> > \n> > Why would you set `DOCKER_HOST` as a secret?\n\n> Environment variables that are injected into the scripts that are described in `.gitlab-ci.yml` are called secrets in [GitLab](GitLab). They are not necessarily \"secret\". The `docker` docker image detects whether there is a host called `docker` and then assumes that this host is running `docker:dind` (or something similar.) You can disable this behaviour by explicitly setting `DOCKER_HOST`.\n\nOkay, thanks for clarifying the \"secrets\" thing.  That was definitely confusing me.\n\nI still had to stare at this for a while though to understand what was meant.  In particular I didn't understand exactly what `services:` meant (now I do), and it was also unclear to me that `docker:dind` was just the name of a Docker image (where `dind` is the tag indicating the Docker-in-Docker image).  I also didn't fully understand the implications of what \"Docker-in-Docker\" meant.  I mean, I've installed the Docker client inside a container before and linked it to my outer Docker engine via a socket before, and I thought that's all that was meant by \"Docker-in-Docker\".\n\nIt's clearer to me now what this means, but maybe this should be documented somewhere more clearly, like in the Readme, instead of burying it here.  In fact, is there any advantage to using docker-in-docker specifically over setting `DOCKER_HOST` like you explain here?",
    "created_at": "2018-03-28T14:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364327",
    "user": "https://github.com/embray"
}
```

<a id='comment:70'></a>Replying to [comment:59 saraedum]:
> Replying to [comment:51 embray]:
> > Relatedly, I don't understand this comment at all:
> > 
> > ```
> > # We use docker-in-docker to build our docker images.  It can be faster to
> > # expose your outer docker daemon by mounting /var/run/docker.sock to
> > # /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret
> > # variable to unix:///var/run/docker.sock
> > ```
> > 
> > Why would you set `DOCKER_HOST` as a secret?

> Environment variables that are injected into the scripts that are described in `.gitlab-ci.yml` are called secrets in [GitLab](GitLab). They are not necessarily "secret". The `docker` docker image detects whether there is a host called `docker` and then assumes that this host is running `docker:dind` (or something similar.) You can disable this behaviour by explicitly setting `DOCKER_HOST`.

Okay, thanks for clarifying the "secrets" thing.  That was definitely confusing me.

I still had to stare at this for a while though to understand what was meant.  In particular I didn't understand exactly what `services:` meant (now I do), and it was also unclear to me that `docker:dind` was just the name of a Docker image (where `dind` is the tag indicating the Docker-in-Docker image).  I also didn't fully understand the implications of what "Docker-in-Docker" meant.  I mean, I've installed the Docker client inside a container before and linked it to my outer Docker engine via a socket before, and I thought that's all that was meant by "Docker-in-Docker".

It's clearer to me now what this means, but maybe this should be documented somewhere more clearly, like in the Readme, instead of burying it here.  In fact, is there any advantage to using docker-in-docker specifically over setting `DOCKER_HOST` like you explain here?



---

archive/issue_comments_364328.json:
```json
{
    "body": "<a id='comment:71'></a>Replying to [comment:61 saraedum]:\n> Replying to [comment:53 embray]:\n> > One more annoying nitpick, but in `docker/README.md` can we wrap the lines, please?\n\n> No :) I added a comment to the README about this.\n\nUgh, that sucks, but okay.",
    "created_at": "2018-03-28T14:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364328",
    "user": "https://github.com/embray"
}
```

<a id='comment:71'></a>Replying to [comment:61 saraedum]:
> Replying to [comment:53 embray]:
> > One more annoying nitpick, but in `docker/README.md` can we wrap the lines, please?

> No :) I added a comment to the README about this.

Ugh, that sucks, but okay.



---

archive/issue_comments_364329.json:
```json
{
    "body": "<a id='comment:72'></a>Replying to [comment:60 saraedum]:\n> I want these files to be part of `.dockerignore`. I symlinked `.dockerignore` to `.gitignore` in the root directory. However, docker does not support `.dockerignore` files in subdirectories, so I had to move these rules down.\n\n\nI see; that's too bad.  Something about it doesn't sit right with me.  For example I feel like, although it's convenient to symlink `.gitignore` to `.dockerignore` (as there are many patterns in the former we would also want to apply to the latter), I could envision a scenario where we don't want them to be exactly the same.\n\nWe can try it for now though, since I don't have an immediate argument against it.",
    "created_at": "2018-03-28T15:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364329",
    "user": "https://github.com/embray"
}
```

<a id='comment:72'></a>Replying to [comment:60 saraedum]:
> I want these files to be part of `.dockerignore`. I symlinked `.dockerignore` to `.gitignore` in the root directory. However, docker does not support `.dockerignore` files in subdirectories, so I had to move these rules down.


I see; that's too bad.  Something about it doesn't sit right with me.  For example I feel like, although it's convenient to symlink `.gitignore` to `.dockerignore` (as there are many patterns in the former we would also want to apply to the latter), I could envision a scenario where we don't want them to be exactly the same.

We can try it for now though, since I don't have an immediate argument against it.



---

archive/issue_comments_364330.json:
```json
{
    "body": "<a id='comment:73'></a>Replying to [comment:62 saraedum]:\n> Replying to [comment:54 embray]:\n> > It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.\n\n> I had this originally but then removed it. It's a bit annoying to build both images because you need to upload the full image to dockerhub (dockerhub does not detect shared layers between repositories it seems.) The \"docker run\" string is more complicated anyway, since you need the port forwarding. Do you think what it says in the README is not sufficient for people to just copy and paste it? he command should work on all POSIX shells I think.\n\nNicolas might be interested in chiming in here, but even as an \"expert\" I've personally found the `sagemath-jupyter` image to be useful, as a way to quickly fire up a notebook (since I don't use the notebook much personally, but I do sometimes need to test things in it).  I don't want to have to look up the correct command line every time I do.\n\nIt's weird what you say about Docker having to re-upload the intermediate images.  I don't think I've observed that before myself, but maybe I just wasn't paying attention.\n\nI don't think we need to make the `sagemath-jupyter` for every build though--only for releases should be sufficient.  So what if we at least kept a build target for it in the Dockerfile (or even in a separate Dockerfile if it's more convenient?) and only build/push those images for final release versions?",
    "created_at": "2018-03-28T15:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364330",
    "user": "https://github.com/embray"
}
```

<a id='comment:73'></a>Replying to [comment:62 saraedum]:
> Replying to [comment:54 embray]:
> > It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.

> I had this originally but then removed it. It's a bit annoying to build both images because you need to upload the full image to dockerhub (dockerhub does not detect shared layers between repositories it seems.) The "docker run" string is more complicated anyway, since you need the port forwarding. Do you think what it says in the README is not sufficient for people to just copy and paste it? he command should work on all POSIX shells I think.

Nicolas might be interested in chiming in here, but even as an "expert" I've personally found the `sagemath-jupyter` image to be useful, as a way to quickly fire up a notebook (since I don't use the notebook much personally, but I do sometimes need to test things in it).  I don't want to have to look up the correct command line every time I do.

It's weird what you say about Docker having to re-upload the intermediate images.  I don't think I've observed that before myself, but maybe I just wasn't paying attention.

I don't think we need to make the `sagemath-jupyter` for every build though--only for releases should be sufficient.  So what if we at least kept a build target for it in the Dockerfile (or even in a separate Dockerfile if it's more convenient?) and only build/push those images for final release versions?



---

archive/issue_comments_364331.json:
```json
{
    "body": "<a id='comment:74'></a>Replying to [comment:63 saraedum]:\n> Replying to [comment:55 embray]:\n> > Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?\n\n> If I understood correctly, `sagemath-develop` is referring to Sage's `develop` branch. My thinking was to use something that can not get confused with an existing term in Sage. Also, my `sagemath` images are continuing what the existing `sagemath` images do. But the `sagemath-dev` images are not really related to the `sagemath-develop` images. I am open to replacing `dev` with something else.\n\nI must be confused about the nomenclature then.  I'll re-review everything but I assumed `sagemath-dev` was equivalent to builds from the `develop` branch.  Clearly, if I'm wrong, then I must be missing something crucial.  If they're not really related though a different name (maybe even a different Docker repository for them--e.g. a `sagemath-dev` repository) might be good.",
    "created_at": "2018-03-28T15:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364331",
    "user": "https://github.com/embray"
}
```

<a id='comment:74'></a>Replying to [comment:63 saraedum]:
> Replying to [comment:55 embray]:
> > Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?

> If I understood correctly, `sagemath-develop` is referring to Sage's `develop` branch. My thinking was to use something that can not get confused with an existing term in Sage. Also, my `sagemath` images are continuing what the existing `sagemath` images do. But the `sagemath-dev` images are not really related to the `sagemath-develop` images. I am open to replacing `dev` with something else.

I must be confused about the nomenclature then.  I'll re-review everything but I assumed `sagemath-dev` was equivalent to builds from the `develop` branch.  Clearly, if I'm wrong, then I must be missing something crucial.  If they're not really related though a different name (maybe even a different Docker repository for them--e.g. a `sagemath-dev` repository) might be good.



---

archive/issue_comments_364332.json:
```json
{
    "body": "<a id='comment:75'></a>Replying to [comment:64 saraedum]:\n> Replying to [comment:57 embray]:\n> > Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.\n\n> It's inside the `docker/` directory so you usually won't see it. It's also .gitignore-d (but not .dockerignore-d!). I don't have a very strong opinion on this but I would need to change a bunch of things in my local setup here (not part of this ticket) if I changed this.\nI think personally I would basically never want to see it (e.g. with ls).  If I didn't know what it was for it'd just confuse me.  I'm not sure what else you would need to change?  I'm not going to insist on it if it's a huge pain but I'm confused as to why it would be.",
    "created_at": "2018-03-28T15:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364332",
    "user": "https://github.com/embray"
}
```

<a id='comment:75'></a>Replying to [comment:64 saraedum]:
> Replying to [comment:57 embray]:
> > Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.

> It's inside the `docker/` directory so you usually won't see it. It's also .gitignore-d (but not .dockerignore-d!). I don't have a very strong opinion on this but I would need to change a bunch of things in my local setup here (not part of this ticket) if I changed this.
I think personally I would basically never want to see it (e.g. with ls).  If I didn't know what it was for it'd just confuse me.  I'm not sure what else you would need to change?  I'm not going to insist on it if it's a huge pain but I'm confused as to why it would be.



---

archive/issue_comments_364333.json:
```json
{
    "body": "<a id='comment:76'></a>Replying to [comment:69 saraedum]:\n> I am now getting\n> \n> ```\n> Step 40/42 : RUN make build\n>  ---> Running in 9605e7f7ecf4\n> build/make/Makefile --stop\n> make: build/make/Makefile: Command not found\n> Makefile:20: recipe for target 'all-build' failed\n> ```\n> \n> Has anything changed in Sage recently that could cause this?\n\n\nNot that I can think of.  It might be something to do with your environment.  The relevant line from the top-level `Makefile` is:\n\n```\n     $(MAKE) build/make/Makefile --stop\n```\n\nso you would get this error if the `$(MAKE)` variable were somehow set to empty.",
    "created_at": "2018-03-28T15:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364333",
    "user": "https://github.com/embray"
}
```

<a id='comment:76'></a>Replying to [comment:69 saraedum]:
> I am now getting
> 
> ```
> Step 40/42 : RUN make build
>  ---> Running in 9605e7f7ecf4
> build/make/Makefile --stop
> make: build/make/Makefile: Command not found
> Makefile:20: recipe for target 'all-build' failed
> ```
> 
> Has anything changed in Sage recently that could cause this?


Not that I can think of.  It might be something to do with your environment.  The relevant line from the top-level `Makefile` is:

```
     $(MAKE) build/make/Makefile --stop
```

so you would get this error if the `$(MAKE)` variable were somehow set to empty.



---

archive/issue_comments_364334.json:
```json
{
    "body": "<a id='comment:77'></a>Still confused about `sagemath-dev` even after re-reviewing.  The point of `sagemath-develop`, at least originally, was supposed to be more or less the same thing--it would be built from the latest `develop` branch *and* contain most/all build artifacts (and is hence a bit fatter than the normal `sagemath` image, by ~2GB).",
    "created_at": "2018-03-28T15:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364334",
    "user": "https://github.com/embray"
}
```

<a id='comment:77'></a>Still confused about `sagemath-dev` even after re-reviewing.  The point of `sagemath-develop`, at least originally, was supposed to be more or less the same thing--it would be built from the latest `develop` branch *and* contain most/all build artifacts (and is hence a bit fatter than the normal `sagemath` image, by ~2GB).



---

archive/issue_comments_364335.json:
```json
{
    "body": "<a id='comment:78'></a>\n```\n+# 1) Restore the git checkout ARTIFACT_BASE was built from, recorded in\n+#    docker/commit. (Or go directly to FETCH_HEAD if there is no history to\n+#    restore.)\n```\n\nMaybe here explicitly mention something like \"*unless* ARTIFACT_BASE=source-clean\".  I think that's what the parenthetical statement is referring to, but I had to go around in circles a few times to understand that (since by default `ARTIFACT_BASE=source-clean` :)  It says that in the message that gets echo'd later on, but the connection isn't obvious at first.",
    "created_at": "2018-03-28T15:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364335",
    "user": "https://github.com/embray"
}
```

<a id='comment:78'></a>
```
+# 1) Restore the git checkout ARTIFACT_BASE was built from, recorded in
+#    docker/commit. (Or go directly to FETCH_HEAD if there is no history to
+#    restore.)
```

Maybe here explicitly mention something like "*unless* ARTIFACT_BASE=source-clean".  I think that's what the parenthetical statement is referring to, but I had to go around in circles a few times to understand that (since by default `ARTIFACT_BASE=source-clean` :)  It says that in the message that gets echo'd later on, but the connection isn't obvious at first.



---

archive/issue_comments_364336.json:
```json
{
    "body": "<a id='comment:79'></a>In the Dockerfile section for `sagemath-dev` it has\n\n```\n+CMD [\"bash\"]\n```\n\nI've usually found it convenient (even for the -devel image) to just start straight into the sage shell like `/home/sage/sage/sage -sh` or something.  But maybe for debugging purposes it's just a well not to.  I'm not sure.",
    "created_at": "2018-03-28T16:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364336",
    "user": "https://github.com/embray"
}
```

<a id='comment:79'></a>In the Dockerfile section for `sagemath-dev` it has

```
+CMD ["bash"]
```

I've usually found it convenient (even for the -devel image) to just start straight into the sage shell like `/home/sage/sage/sage -sh` or something.  But maybe for debugging purposes it's just a well not to.  I'm not sure.



---

archive/issue_comments_364337.json:
```json
{
    "body": "<a id='comment:80'></a>In `pull-gitlab.sh` you have:\n\n```\n+# The variable $DOCKER_IMAGE is set to the full name of the pulled image;\n+# source this script to use it.\n```\n\nthat's rather awkward to me.  Perhaps this script could output the image name at the end (perhaps silencing the other commands, or piping them to stderr or something).  Or better still, maybe `DOCKER_IMAGE` could be set somewhere else, since the way it's pieced together in that script doesn't seem all that directly to the script itself.\n\n(The general principle I'm going on with these scripts is that even though they're written for and used primarily by the CI systems, for testing and development purposes I'd rather they work in some \"normal\", unsurprising way as much as possible.)",
    "created_at": "2018-03-28T16:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364337",
    "user": "https://github.com/embray"
}
```

<a id='comment:80'></a>In `pull-gitlab.sh` you have:

```
+# The variable $DOCKER_IMAGE is set to the full name of the pulled image;
+# source this script to use it.
```

that's rather awkward to me.  Perhaps this script could output the image name at the end (perhaps silencing the other commands, or piping them to stderr or something).  Or better still, maybe `DOCKER_IMAGE` could be set somewhere else, since the way it's pieced together in that script doesn't seem all that directly to the script itself.

(The general principle I'm going on with these scripts is that even though they're written for and used primarily by the CI systems, for testing and development purposes I'd rather they work in some "normal", unsurprising way as much as possible.)



---

archive/issue_comments_364338.json:
```json
{
    "body": "<a id='comment:81'></a>Replying to [comment:58 saraedum]:\n> Replying to [comment:50 embray]:\n> > Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?\n\n> \n> Ok. Fixed.\n\n\nI think you missed one here:\n\n```\n+            # Build docker images\n+            . .ci/build-docker.sh\n```",
    "created_at": "2018-03-28T16:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364338",
    "user": "https://github.com/embray"
}
```

<a id='comment:81'></a>Replying to [comment:58 saraedum]:
> Replying to [comment:50 embray]:
> > Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?

> 
> Ok. Fixed.


I think you missed one here:

```
+            # Build docker images
+            . .ci/build-docker.sh
```



---

archive/issue_comments_364339.json:
```json
{
    "body": "<a id='comment:82'></a>Okay--I think I've finally mostly understood all of this :)  The walkthrough you gave me earlier certainly helped, but when it came to the details I still had a bit to go through.\n\nThank you again for your Herculean effort on this.  Other than the numerous, but minor comments above (plus figuring out why `$(MAKE)` broke for you) I think we're pretty close...  I'm excited to launch this.",
    "created_at": "2018-03-28T16:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364339",
    "user": "https://github.com/embray"
}
```

<a id='comment:82'></a>Okay--I think I've finally mostly understood all of this :)  The walkthrough you gave me earlier certainly helped, but when it came to the details I still had a bit to go through.

Thank you again for your Herculean effort on this.  Other than the numerous, but minor comments above (plus figuring out why `$(MAKE)` broke for you) I think we're pretty close...  I'm excited to launch this.



---

archive/issue_comments_364340.json:
```json
{
    "body": "<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-28T16:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364340",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364341.json:
```json
{
    "body": "<a id='comment:84'></a>Replying to [comment:70 embray]:\n> Replying to [comment:59 saraedum]:\n> > Replying to [comment:51 embray]:\n> > > Relatedly, I don't understand this comment at all:\n> > > \n> > > ```\n> > > # We use docker-in-docker to build our docker images.  It can be faster to\n> > > # expose your outer docker daemon by mounting /var/run/docker.sock to\n> > > # /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret\n> > > # variable to unix:///var/run/docker.sock\n> > > ```\n> > > \n> > > Why would you set `DOCKER_HOST` as a secret?\n\n> > Environment variables that are injected into the scripts that are described in `.gitlab-ci.yml` are called secrets in [GitLab](GitLab). They are not necessarily \"secret\". The `docker` docker image detects whether there is a host called `docker` and then assumes that this host is running `docker:dind` (or something similar.) You can disable this behaviour by explicitly setting `DOCKER_HOST`.\n> \n> Okay, thanks for clarifying the \"secrets\" thing.  That was definitely confusing me.\n> \n> I still had to stare at this for a while though to understand what was meant.  In particular I didn't understand exactly what `services:` meant (now I do), and it was also unclear to me that `docker:dind` was just the name of a Docker image (where `dind` is the tag indicating the Docker-in-Docker image).  I also didn't fully understand the implications of what \"Docker-in-Docker\" meant.  I mean, I've installed the Docker client inside a container before and linked it to my outer Docker engine via a socket before, and I thought that's all that was meant by \"Docker-in-Docker\".\n> \n> It's clearer to me now what this means, but maybe this should be documented somewhere more clearly, like in the Readme, instead of burying it here.  In fact, is there any advantage to using docker-in-docker specifically over setting `DOCKER_HOST` like you explain here?\n\n\nI extended the section about docker:dind. Do you think that's enough? The section could go into the README but then again it's absolutely standard in the [GitLab](GitLab) CI world.",
    "created_at": "2018-03-28T16:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364341",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:84'></a>Replying to [comment:70 embray]:
> Replying to [comment:59 saraedum]:
> > Replying to [comment:51 embray]:
> > > Relatedly, I don't understand this comment at all:
> > > 
> > > ```
> > > # We use docker-in-docker to build our docker images.  It can be faster to
> > > # expose your outer docker daemon by mounting /var/run/docker.sock to
> > > # /var/run/docker.sock and setting DOCKER_HOST in Settings -> CI/CD -> Secret
> > > # variable to unix:///var/run/docker.sock
> > > ```
> > > 
> > > Why would you set `DOCKER_HOST` as a secret?

> > Environment variables that are injected into the scripts that are described in `.gitlab-ci.yml` are called secrets in [GitLab](GitLab). They are not necessarily "secret". The `docker` docker image detects whether there is a host called `docker` and then assumes that this host is running `docker:dind` (or something similar.) You can disable this behaviour by explicitly setting `DOCKER_HOST`.
> 
> Okay, thanks for clarifying the "secrets" thing.  That was definitely confusing me.
> 
> I still had to stare at this for a while though to understand what was meant.  In particular I didn't understand exactly what `services:` meant (now I do), and it was also unclear to me that `docker:dind` was just the name of a Docker image (where `dind` is the tag indicating the Docker-in-Docker image).  I also didn't fully understand the implications of what "Docker-in-Docker" meant.  I mean, I've installed the Docker client inside a container before and linked it to my outer Docker engine via a socket before, and I thought that's all that was meant by "Docker-in-Docker".
> 
> It's clearer to me now what this means, but maybe this should be documented somewhere more clearly, like in the Readme, instead of burying it here.  In fact, is there any advantage to using docker-in-docker specifically over setting `DOCKER_HOST` like you explain here?


I extended the section about docker:dind. Do you think that's enough? The section could go into the README but then again it's absolutely standard in the [GitLab](GitLab) CI world.



---

archive/issue_comments_364342.json:
```json
{
    "body": "<a id='comment:85'></a>Replying to [comment:72 embray]:\n> Replying to [comment:60 saraedum]:\n> > I want these files to be part of `.dockerignore`. I symlinked `.dockerignore` to `.gitignore` in the root directory. However, docker does not support `.dockerignore` files in subdirectories, so I had to move these rules down.\n\n> \n> I see; that's too bad.  Something about it doesn't sit right with me.  For example I feel like, although it's convenient to symlink `.gitignore` to `.dockerignore` (as there are many patterns in the former we would also want to apply to the latter), I could envision a scenario where we don't want them to be exactly the same.\n> \n> We can try it for now though, since I don't have an immediate argument against it.\n\n\nI am also not perfectly happy with it. But I also don't want to maintain a .dockerignore unless people widely use and care about this.",
    "created_at": "2018-03-28T16:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364342",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:85'></a>Replying to [comment:72 embray]:
> Replying to [comment:60 saraedum]:
> > I want these files to be part of `.dockerignore`. I symlinked `.dockerignore` to `.gitignore` in the root directory. However, docker does not support `.dockerignore` files in subdirectories, so I had to move these rules down.

> 
> I see; that's too bad.  Something about it doesn't sit right with me.  For example I feel like, although it's convenient to symlink `.gitignore` to `.dockerignore` (as there are many patterns in the former we would also want to apply to the latter), I could envision a scenario where we don't want them to be exactly the same.
> 
> We can try it for now though, since I don't have an immediate argument against it.


I am also not perfectly happy with it. But I also don't want to maintain a .dockerignore unless people widely use and care about this.



---

archive/issue_comments_364343.json:
```json
{
    "body": "<a id='comment:86'></a>Replying to [comment:73 embray]:\n> Replying to [comment:62 saraedum]:\n> > Replying to [comment:54 embray]:\n> > > It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.\n\n> > I had this originally but then removed it. It's a bit annoying to build both images because you need to upload the full image to dockerhub (dockerhub does not detect shared layers between repositories it seems.) The \"docker run\" string is more complicated anyway, since you need the port forwarding. Do you think what it says in the README is not sufficient for people to just copy and paste it? he command should work on all POSIX shells I think.\n> \n> Nicolas might be interested in chiming in here, but even as an \"expert\" I've personally found the `sagemath-jupyter` image to be useful, as a way to quickly fire up a notebook (since I don't use the notebook much personally, but I do sometimes need to test things in it).  I don't want to have to look up the correct command line every time I do.\n> \n> It's weird what you say about Docker having to re-upload the intermediate images.  I don't think I've observed that before myself, but maybe I just wasn't paying attention.\n> \n> I don't think we need to make the `sagemath-jupyter` for every build though--only for releases should be sufficient.  So what if we at least kept a build target for it in the Dockerfile (or even in a separate Dockerfile if it's more convenient?) and only build/push those images for final release versions?\n\n\nI would like to have the releases and non-releases produce the same output if possible. It makes breaking things much harder. If people want to try something out, they should click on a binder link (see #24842.) I believe that's much more convenient anyway. I don't see having to lookup a command as a problem but I might be missing something here: You need to do something about binding the ports anyway, so the casual docker user (me too actually) needs to lookup the docker run command anyway?",
    "created_at": "2018-03-28T16:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364343",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:86'></a>Replying to [comment:73 embray]:
> Replying to [comment:62 saraedum]:
> > Replying to [comment:54 embray]:
> > > It looks like in the Dockerfile you've done away with the build for the `sagemath-jupyter` image.  I've always been somewhat split on my feelings about it, but I think in general it has been useful.  It's nice having an image whose default command is just the correct thing to start up the Notebook, because I've had users mess that up before and get confused (e.g. you have to make sure to pass `--ip='*'` and get the quoting right as well.

> > I had this originally but then removed it. It's a bit annoying to build both images because you need to upload the full image to dockerhub (dockerhub does not detect shared layers between repositories it seems.) The "docker run" string is more complicated anyway, since you need the port forwarding. Do you think what it says in the README is not sufficient for people to just copy and paste it? he command should work on all POSIX shells I think.
> 
> Nicolas might be interested in chiming in here, but even as an "expert" I've personally found the `sagemath-jupyter` image to be useful, as a way to quickly fire up a notebook (since I don't use the notebook much personally, but I do sometimes need to test things in it).  I don't want to have to look up the correct command line every time I do.
> 
> It's weird what you say about Docker having to re-upload the intermediate images.  I don't think I've observed that before myself, but maybe I just wasn't paying attention.
> 
> I don't think we need to make the `sagemath-jupyter` for every build though--only for releases should be sufficient.  So what if we at least kept a build target for it in the Dockerfile (or even in a separate Dockerfile if it's more convenient?) and only build/push those images for final release versions?


I would like to have the releases and non-releases produce the same output if possible. It makes breaking things much harder. If people want to try something out, they should click on a binder link (see #24842.) I believe that's much more convenient anyway. I don't see having to lookup a command as a problem but I might be missing something here: You need to do something about binding the ports anyway, so the casual docker user (me too actually) needs to lookup the docker run command anyway?



---

archive/issue_comments_364344.json:
```json
{
    "body": "<a id='comment:87'></a>Replying to [comment:84 saraedum]:\n> I extended the section about docker:dind. Do you think that's enough? The section could go into the README but then again it's absolutely standard in the GitLab CI world.\n\n\nThank you--that's much clearer now, I think.  I would still lean towards explaining this in the Readme, because what's bog standard in GitLab CI, I would think, is at this point virtually unknown to almost everyone else who works on Sage (including me).  Maybe with a link to https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor which helped me understand this.\n\nI say that because this actually impacts how one configures their runner and/or their CI settings, and they're more likely to find it sooner in the README--most people aren't going to want to dig into the details of the `.gitlab-ci.yaml` if they don't have to.",
    "created_at": "2018-03-28T16:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364344",
    "user": "https://github.com/embray"
}
```

<a id='comment:87'></a>Replying to [comment:84 saraedum]:
> I extended the section about docker:dind. Do you think that's enough? The section could go into the README but then again it's absolutely standard in the GitLab CI world.


Thank you--that's much clearer now, I think.  I would still lean towards explaining this in the Readme, because what's bog standard in GitLab CI, I would think, is at this point virtually unknown to almost everyone else who works on Sage (including me).  Maybe with a link to https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor which helped me understand this.

I say that because this actually impacts how one configures their runner and/or their CI settings, and they're more likely to find it sooner in the README--most people aren't going to want to dig into the details of the `.gitlab-ci.yaml` if they don't have to.



---

archive/issue_comments_364345.json:
```json
{
    "body": "<a id='comment:88'></a>Replying to [comment:74 embray]:\n> Replying to [comment:63 saraedum]:\n> > Replying to [comment:55 embray]:\n> > > Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?\n\n> > If I understood correctly, `sagemath-develop` is referring to Sage's `develop` branch. My thinking was to use something that can not get confused with an existing term in Sage. Also, my `sagemath` images are continuing what the existing `sagemath` images do. But the `sagemath-dev` images are not really related to the `sagemath-develop` images. I am open to replacing `dev` with something else.\n> \n> I must be confused about the nomenclature then.  I'll re-review everything but I assumed `sagemath-dev` was equivalent to builds from the `develop` branch.  Clearly, if I'm wrong, then I must be missing something crucial.  If they're not really related though a different name (maybe even a different Docker repository for them--e.g. a `sagemath-dev` repository) might be good.\n\n\nYes, I think you misunderstood that part. The dev images are about the build artifacts being intact. I don't discriminate branches (except for building from scratch for master/develop and building from develop's sagemath-dev image for everyone else.)",
    "created_at": "2018-03-28T16:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364345",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:88'></a>Replying to [comment:74 embray]:
> Replying to [comment:63 saraedum]:
> > Replying to [comment:55 embray]:
> > > Since we already use the name `sagemath-develop` on DockerHub for the development images, could we go ahead and do the same here (so we don't end up with `sagemath-develop` and `sagemath-dev`)?  I don't see the advantage of dropping four letters here, unless for some reason it would be really annoying to change this name at this point?

> > If I understood correctly, `sagemath-develop` is referring to Sage's `develop` branch. My thinking was to use something that can not get confused with an existing term in Sage. Also, my `sagemath` images are continuing what the existing `sagemath` images do. But the `sagemath-dev` images are not really related to the `sagemath-develop` images. I am open to replacing `dev` with something else.
> 
> I must be confused about the nomenclature then.  I'll re-review everything but I assumed `sagemath-dev` was equivalent to builds from the `develop` branch.  Clearly, if I'm wrong, then I must be missing something crucial.  If they're not really related though a different name (maybe even a different Docker repository for them--e.g. a `sagemath-dev` repository) might be good.


Yes, I think you misunderstood that part. The dev images are about the build artifacts being intact. I don't discriminate branches (except for building from scratch for master/develop and building from develop's sagemath-dev image for everyone else.)



---

archive/issue_comments_364346.json:
```json
{
    "body": "<a id='comment:89'></a>Replying to [comment:75 embray]:\n> Replying to [comment:64 saraedum]:\n> > Replying to [comment:57 embray]:\n> > > Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.\n\n> > It's inside the `docker/` directory so you usually won't see it. It's also .gitignore-d (but not .dockerignore-d!). I don't have a very strong opinion on this but I would need to change a bunch of things in my local setup here (not part of this ticket) if I changed this.\n> I think personally I would basically never want to see it (e.g. with ls).  If I didn't know what it was for it'd just confuse me.  I'm not sure what else you would need to change?  I'm not going to insist on it if it's a huge pain but I'm confused as to why it would be.\n\nIt breaks my existing incremental builds on other branches because they expect it to be called `commit`. I really don't mind renaming it though.",
    "created_at": "2018-03-28T16:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364346",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:89'></a>Replying to [comment:75 embray]:
> Replying to [comment:64 saraedum]:
> > Replying to [comment:57 embray]:
> > > Can we rename the little `commit` stamp file generated by the `Dockerfile` to `.commit`, so it's hidden by default?  I can't imagine we'd normally care about seeing that.

> > It's inside the `docker/` directory so you usually won't see it. It's also .gitignore-d (but not .dockerignore-d!). I don't have a very strong opinion on this but I would need to change a bunch of things in my local setup here (not part of this ticket) if I changed this.
> I think personally I would basically never want to see it (e.g. with ls).  If I didn't know what it was for it'd just confuse me.  I'm not sure what else you would need to change?  I'm not going to insist on it if it's a huge pain but I'm confused as to why it would be.

It breaks my existing incremental builds on other branches because they expect it to be called `commit`. I really don't mind renaming it though.



---

archive/issue_comments_364347.json:
```json
{
    "body": "<a id='comment:90'></a>Replying to [comment:86 saraedum]:\n> I would like to have the releases and non-releases produce the same output if possible. It makes breaking things much harder. If people want to try something out, they should click on a binder link (see #24842.) I believe that's much more convenient anyway. I don't see having to lookup a command as a problem but I might be missing something here: You need to do something about binding the ports anyway, so the casual docker user (me too actually) needs to lookup the docker run command anyway?\n\n\nThat's a fair point, but I still think `docker run -p <local-port>:<container-port> <image-name>` is easier to remember (I used to have to look up how `-p` works but not usually anymore) than `docker run -p 127.0.0.1:8888:8888 sagemath/sagemath sage -notebook=jupyter --no-browser --ip='*' --port=8888`, which is definitely more than I can remember.\n\nI agree about releases and non-releases having much of the same output, but in this case it's really just a convenience layer for casual users, who are mostly only going to be concerned about final releases.",
    "created_at": "2018-03-28T16:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364347",
    "user": "https://github.com/embray"
}
```

<a id='comment:90'></a>Replying to [comment:86 saraedum]:
> I would like to have the releases and non-releases produce the same output if possible. It makes breaking things much harder. If people want to try something out, they should click on a binder link (see #24842.) I believe that's much more convenient anyway. I don't see having to lookup a command as a problem but I might be missing something here: You need to do something about binding the ports anyway, so the casual docker user (me too actually) needs to lookup the docker run command anyway?


That's a fair point, but I still think `docker run -p <local-port>:<container-port> <image-name>` is easier to remember (I used to have to look up how `-p` works but not usually anymore) than `docker run -p 127.0.0.1:8888:8888 sagemath/sagemath sage -notebook=jupyter --no-browser --ip='*' --port=8888`, which is definitely more than I can remember.

I agree about releases and non-releases having much of the same output, but in this case it's really just a convenience layer for casual users, who are mostly only going to be concerned about final releases.



---

archive/issue_comments_364348.json:
```json
{
    "body": "<a id='comment:91'></a>I remember when I first took over maintenance of the sage Docker images I was skeptical about `sagemath-jupyter` as well, which was already there before me.  I had pretty much the same skepticism about it.  But now that I've personally found it useful my mind is changed.",
    "created_at": "2018-03-28T16:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364348",
    "user": "https://github.com/embray"
}
```

<a id='comment:91'></a>I remember when I first took over maintenance of the sage Docker images I was skeptical about `sagemath-jupyter` as well, which was already there before me.  I had pretty much the same skepticism about it.  But now that I've personally found it useful my mind is changed.



---

archive/issue_comments_364349.json:
```json
{
    "body": "<a id='comment:92'></a>Replying to [comment:77 embray]:\n> Still confused about `sagemath-dev` even after re-reviewing.  The point of `sagemath-develop`, at least originally, was supposed to be more or less the same thing--it would be built from the latest `develop` branch *and* contain most/all build artifacts (and is hence a bit fatter than the normal `sagemath` image, by ~2GB).\n\n\nI don't really understand the confusion. But I should totally improve the documentation if it is unclear. I build `sagemath` and `sagemath-dev` for every branch, not only for `develop`. The `sagemath-dev` image has the build artifacts, the `sagemath` image does not. So, `sagemath-dev` is not related to the `develop` branch. But it includes the build artifacts in the same way that `sagemath-develop` apparently did.",
    "created_at": "2018-03-28T16:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364349",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:92'></a>Replying to [comment:77 embray]:
> Still confused about `sagemath-dev` even after re-reviewing.  The point of `sagemath-develop`, at least originally, was supposed to be more or less the same thing--it would be built from the latest `develop` branch *and* contain most/all build artifacts (and is hence a bit fatter than the normal `sagemath` image, by ~2GB).


I don't really understand the confusion. But I should totally improve the documentation if it is unclear. I build `sagemath` and `sagemath-dev` for every branch, not only for `develop`. The `sagemath-dev` image has the build artifacts, the `sagemath` image does not. So, `sagemath-dev` is not related to the `develop` branch. But it includes the build artifacts in the same way that `sagemath-develop` apparently did.



---

archive/issue_comments_364350.json:
```json
{
    "body": "<a id='comment:93'></a>Replying to [comment:79 embray]:\n> In the Dockerfile section for `sagemath-dev` it has\n> \n> \n> ```\n> +CMD [\"bash\"]\n> ```\n> \n> I've usually found it convenient (even for the -devel image) to just start straight into the sage shell like `/home/sage/sage/sage -sh` or something.  But maybe for debugging purposes it's just a well not to.  I'm not sure.\n\n\nMaybe it has improved, but I really dislike how `sage -sh` screws with the environment. I find it really confusing unless you understand well what it is doing exactly. I'd rather keep the bash as it is.",
    "created_at": "2018-03-28T16:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364350",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:93'></a>Replying to [comment:79 embray]:
> In the Dockerfile section for `sagemath-dev` it has
> 
> 
> ```
> +CMD ["bash"]
> ```
> 
> I've usually found it convenient (even for the -devel image) to just start straight into the sage shell like `/home/sage/sage/sage -sh` or something.  But maybe for debugging purposes it's just a well not to.  I'm not sure.


Maybe it has improved, but I really dislike how `sage -sh` screws with the environment. I find it really confusing unless you understand well what it is doing exactly. I'd rather keep the bash as it is.



---

archive/issue_comments_364351.json:
```json
{
    "body": "<a id='comment:94'></a>Replying to [comment:81 embray]:\n> Replying to [comment:58 saraedum]:\n> > Replying to [comment:50 embray]:\n> > > Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?\n\n> > \n> > Ok. Fixed.\n  \n> \n> I think you missed one here:\n> \n> \n> ```\n> +            # Build docker images\n> +            . .ci/build-docker.sh\n> ```\nThanks. Fixed :)",
    "created_at": "2018-03-28T16:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364351",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:94'></a>Replying to [comment:81 embray]:
> Replying to [comment:58 saraedum]:
> > Replying to [comment:50 embray]:
> > > Maybe just a minor nitpick, but I noticed that you have all these shared scripts like `describe-system.sh` and so on, and that in both the circle-ci and gitlab configurations you *source* a lot of these scripts instead of just running them.  A few of them export some environment variables, so it that case the sourcing makes sense, but why for the others, that don't modify the environment?

> > 
> > Ok. Fixed.
  
> 
> I think you missed one here:
> 
> 
> ```
> +            # Build docker images
> +            . .ci/build-docker.sh
> ```
Thanks. Fixed :)



---

archive/issue_comments_364352.json:
```json
{
    "body": "<a id='comment:95'></a>Replying to [comment:80 embray]:\n> In `pull-gitlab.sh` you have:\n> \n> \n> ```\n> +# The variable $DOCKER_IMAGE is set to the full name of the pulled image;\n> +# source this script to use it.\n> ```\n> \n> that's rather awkward to me.  Perhaps this script could output the image name at the end (perhaps silencing the other commands, or piping them to stderr or something).  Or better still, maybe `DOCKER_IMAGE` could be set somewhere else, since the way it's pieced together in that script doesn't seem all that directly to the script itself.\n> \n> (The general principle I'm going on with these scripts is that even though they're written for and used primarily by the CI systems, for testing and development purposes I'd rather they work in some \"normal\", unsurprising way as much as possible.)\n\n\nI just tried to build it outside and did not like the result. Would you want to try to come up with something here?",
    "created_at": "2018-03-28T17:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364352",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:95'></a>Replying to [comment:80 embray]:
> In `pull-gitlab.sh` you have:
> 
> 
> ```
> +# The variable $DOCKER_IMAGE is set to the full name of the pulled image;
> +# source this script to use it.
> ```
> 
> that's rather awkward to me.  Perhaps this script could output the image name at the end (perhaps silencing the other commands, or piping them to stderr or something).  Or better still, maybe `DOCKER_IMAGE` could be set somewhere else, since the way it's pieced together in that script doesn't seem all that directly to the script itself.
> 
> (The general principle I'm going on with these scripts is that even though they're written for and used primarily by the CI systems, for testing and development purposes I'd rather they work in some "normal", unsurprising way as much as possible.)


I just tried to build it outside and did not like the result. Would you want to try to come up with something here?



---

archive/issue_comments_364353.json:
```json
{
    "body": "<a id='comment:96'></a>Replying to [comment:90 embray]:\n> Replying to [comment:86 saraedum]:\n> > I would like to have the releases and non-releases produce the same output if possible. It makes breaking things much harder. If people want to try something out, they should click on a binder link (see #24842.) I believe that's much more convenient anyway. I don't see having to lookup a command as a problem but I might be missing something here: You need to do something about binding the ports anyway, so the casual docker user (me too actually) needs to lookup the docker run command anyway?\n\n> \n> That's a fair point, but I still think `docker run -p <local-port>:<container-port> <image-name>` is easier to remember (I used to have to look up how `-p` works but not usually anymore) than `docker run -p 127.0.0.1:8888:8888 sagemath/sagemath sage -notebook=jupyter --no-browser --ip='*' --port=8888`, which is definitely more than I can remember.\n> \n> I agree about releases and non-releases having much of the same output, but in this case it's really just a convenience layer for casual users, who are mostly only going to be concerned about final releases.\n\nLet me try to come up with an easier solution for this without creating an extra repository.",
    "created_at": "2018-03-28T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364353",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:96'></a>Replying to [comment:90 embray]:
> Replying to [comment:86 saraedum]:
> > I would like to have the releases and non-releases produce the same output if possible. It makes breaking things much harder. If people want to try something out, they should click on a binder link (see #24842.) I believe that's much more convenient anyway. I don't see having to lookup a command as a problem but I might be missing something here: You need to do something about binding the ports anyway, so the casual docker user (me too actually) needs to lookup the docker run command anyway?

> 
> That's a fair point, but I still think `docker run -p <local-port>:<container-port> <image-name>` is easier to remember (I used to have to look up how `-p` works but not usually anymore) than `docker run -p 127.0.0.1:8888:8888 sagemath/sagemath sage -notebook=jupyter --no-browser --ip='*' --port=8888`, which is definitely more than I can remember.
> 
> I agree about releases and non-releases having much of the same output, but in this case it's really just a convenience layer for casual users, who are mostly only going to be concerned about final releases.

Let me try to come up with an easier solution for this without creating an extra repository.



---

archive/issue_comments_364354.json:
```json
{
    "body": "<a id='comment:97'></a>Ok. It's getting hard to keep track of all the threads here. I think I addressed everything you mentioned. Let me know if you think that something is missing.",
    "created_at": "2018-03-28T17:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364354",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:97'></a>Ok. It's getting hard to keep track of all the threads here. I think I addressed everything you mentioned. Let me know if you think that something is missing.



---

archive/issue_comments_364355.json:
```json
{
    "body": "<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-28T17:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364356.json:
```json
{
    "body": "<a id='comment:99'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-28T17:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364356",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:99'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364357.json:
```json
{
    "body": "<a id='comment:100'></a>Replying to [comment:87 embray]:\n> Replying to [comment:84 saraedum]:\n> > I extended the section about docker:dind. Do you think that's enough? The section could go into the README but then again it's absolutely standard in the GitLab CI world.\n\n> \n> Thank you--that's much clearer now, I think.  I would still lean towards explaining this in the Readme, because what's bog standard in GitLab CI, I would think, is at this point virtually unknown to almost everyone else who works on Sage (including me).  Maybe with a link to https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor which helped me understand this.\n> \n> I say that because this actually impacts how one configures their runner and/or their CI settings, and they're more likely to find it sooner in the README--most people aren't going to want to dig into the details of the `.gitlab-ci.yaml` if they don't have to.\n\n\nOh, missed that one. So, the thing here is really that it does not affect you at all if you just use gitlab.com. If you provision your own runners you need to make them `--privileged`. If you care a lot about caching and speed and don't use a cloud service, then you might want to do the DOCKER_HOST thing. I only mention it there to say that there's a way to disable docker:dind if you don't want it for some reason.\n\n---\nNew commits:",
    "created_at": "2018-03-28T17:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364357",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:100'></a>Replying to [comment:87 embray]:
> Replying to [comment:84 saraedum]:
> > I extended the section about docker:dind. Do you think that's enough? The section could go into the README but then again it's absolutely standard in the GitLab CI world.

> 
> Thank you--that's much clearer now, I think.  I would still lean towards explaining this in the Readme, because what's bog standard in GitLab CI, I would think, is at this point virtually unknown to almost everyone else who works on Sage (including me).  Maybe with a link to https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor which helped me understand this.
> 
> I say that because this actually impacts how one configures their runner and/or their CI settings, and they're more likely to find it sooner in the README--most people aren't going to want to dig into the details of the `.gitlab-ci.yaml` if they don't have to.


Oh, missed that one. So, the thing here is really that it does not affect you at all if you just use gitlab.com. If you provision your own runners you need to make them `--privileged`. If you care a lot about caching and speed and don't use a cloud service, then you might want to do the DOCKER_HOST thing. I only mention it there to say that there's a way to disable docker:dind if you don't want it for some reason.

---
New commits:



---

archive/issue_comments_364358.json:
```json
{
    "body": "<a id='comment:101'></a>Replying to [comment:97 saraedum]:\n> Ok. It's getting hard to keep track of all the threads here. I think I addressed everything you mentioned. Let me know if you think that something is missing.\n\n\nHeh, yeah, sorry. I thought of maybe putting a TODO list in the ticket description or something.  I'll touch back on this tomorrow and see if I can summarize whatever remaining issues there are.",
    "created_at": "2018-03-28T17:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364358",
    "user": "https://github.com/embray"
}
```

<a id='comment:101'></a>Replying to [comment:97 saraedum]:
> Ok. It's getting hard to keep track of all the threads here. I think I addressed everything you mentioned. Let me know if you think that something is missing.


Heh, yeah, sorry. I thought of maybe putting a TODO list in the ticket description or something.  I'll touch back on this tomorrow and see if I can summarize whatever remaining issues there are.



---

archive/issue_comments_364359.json:
```json
{
    "body": "<a id='comment:102'></a>Replying to [comment:101 embray]:\n> Replying to [comment:97 saraedum]:\n> > Ok. It's getting hard to keep track of all the threads here. I think I addressed everything you mentioned. Let me know if you think that something is missing.\n  \n> \n> Heh, yeah, sorry. I thought of maybe putting a TODO list in the ticket description or something.  I'll touch back on this tomorrow and see if I can summarize whatever remaining issues there are.\n\n\nI find the \"work issues\" to be a good place to collect such things.",
    "created_at": "2018-03-28T18:02:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364359",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:102'></a>Replying to [comment:101 embray]:
> Replying to [comment:97 saraedum]:
> > Ok. It's getting hard to keep track of all the threads here. I think I addressed everything you mentioned. Let me know if you think that something is missing.
  
> 
> Heh, yeah, sorry. I thought of maybe putting a TODO list in the ticket description or something.  I'll touch back on this tomorrow and see if I can summarize whatever remaining issues there are.


I find the "work issues" to be a good place to collect such things.



---

archive/issue_comments_364360.json:
```json
{
    "body": "<a id='comment:103'></a>Replying to [comment:92 saraedum]:\n> I don't really understand the confusion. But I should totally improve the documentation if it is unclear. I build `sagemath` and `sagemath-dev` for every branch, not only for `develop`. The `sagemath-dev` image has the build artifacts, the `sagemath` image does not. So, `sagemath-dev` is not related to the `develop` branch. But it includes the build artifacts in the same way that `sagemath-develop` apparently did.\n\n\nJust throwing a random thought: what about `sagemath-build`? But `sagemath-dev` may be the right thing if you see it as the closest analogs of `xxx-dev` packages in debian&co.",
    "created_at": "2018-03-29T05:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364360",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:103'></a>Replying to [comment:92 saraedum]:
> I don't really understand the confusion. But I should totally improve the documentation if it is unclear. I build `sagemath` and `sagemath-dev` for every branch, not only for `develop`. The `sagemath-dev` image has the build artifacts, the `sagemath` image does not. So, `sagemath-dev` is not related to the `develop` branch. But it includes the build artifacts in the same way that `sagemath-develop` apparently did.


Just throwing a random thought: what about `sagemath-build`? But `sagemath-dev` may be the right thing if you see it as the closest analogs of `xxx-dev` packages in debian&co.



---

archive/issue_comments_364361.json:
```json
{
    "body": "<a id='comment:4'></a>No strong opinion for `sagemath-jupyter`. The docker command to start it (with port forwarding) can be reconstruted without doc lookup by someone who has some familiarity with docker. The full command requires both sagemath and jupyter familiarity.\n\nHaving a jupyter image explicitly bring attention that our image is \"jupyter ready\"; on the other hand, it may be confusing suggesting that our base image is not.",
    "created_at": "2018-03-29T05:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364361",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:4'></a>No strong opinion for `sagemath-jupyter`. The docker command to start it (with port forwarding) can be reconstruted without doc lookup by someone who has some familiarity with docker. The full command requires both sagemath and jupyter familiarity.

Having a jupyter image explicitly bring attention that our image is "jupyter ready"; on the other hand, it may be confusing suggesting that our base image is not.



---

archive/issue_comments_364362.json:
```json
{
    "body": "<a id='comment:5'></a>No strong opinion on `sage -sh` either. The only important feature is that, for binder use but also beyond, the commands `jupyter`, `gap`, `singular`, ... be in the path and work.\n\nThanks for all the work!",
    "created_at": "2018-03-29T05:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364362",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:5'></a>No strong opinion on `sage -sh` either. The only important feature is that, for binder use but also beyond, the commands `jupyter`, `gap`, `singular`, ... be in the path and work.

Thanks for all the work!



---

archive/issue_comments_364363.json:
```json
{
    "body": "<a id='comment:106'></a>Replying to [comment:103 nthiery]:\n> Replying to [comment:92 saraedum]:\n> > I don't really understand the confusion. But I should totally improve the documentation if it is unclear. I build `sagemath` and `sagemath-dev` for every branch, not only for `develop`. The `sagemath-dev` image has the build artifacts, the `sagemath` image does not. So, `sagemath-dev` is not related to the `develop` branch. But it includes the build artifacts in the same way that `sagemath-develop` apparently did.\n\n> \n> Just throwing a random thought: what about `sagemath-build`? But `sagemath-dev` may be the right thing if you see it as the closest analogs of `xxx-dev` packages in debian&co.\n\nIt's only an analogue in the sense that it contains the things that developers usually care about. I think that `-dev` is good for people who are randomly looking for a sagemath image on docker (and know about the nomenclature in Debian,\u2026): with the `-dev` they should know immediately that that's not what they need. I don't mind `-build` but I don't find it as obvious in that regard.",
    "created_at": "2018-03-29T11:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364363",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:106'></a>Replying to [comment:103 nthiery]:
> Replying to [comment:92 saraedum]:
> > I don't really understand the confusion. But I should totally improve the documentation if it is unclear. I build `sagemath` and `sagemath-dev` for every branch, not only for `develop`. The `sagemath-dev` image has the build artifacts, the `sagemath` image does not. So, `sagemath-dev` is not related to the `develop` branch. But it includes the build artifacts in the same way that `sagemath-develop` apparently did.

> 
> Just throwing a random thought: what about `sagemath-build`? But `sagemath-dev` may be the right thing if you see it as the closest analogs of `xxx-dev` packages in debian&co.

It's only an analogue in the sense that it contains the things that developers usually care about. I think that `-dev` is good for people who are randomly looking for a sagemath image on docker (and know about the nomenclature in Debian,…): with the `-dev` they should know immediately that that's not what they need. I don't mind `-build` but I don't find it as obvious in that regard.



---

archive/issue_comments_364364.json:
```json
{
    "body": "<a id='comment:8'></a>Then maybe we should just delete the old `sagemath-develop` image from Dockerhub so that there's no confusion, though I don't know why we can't just reuse the name for the new images as well.  I'm still not convinced it doesn't already serve the same purpose.  I'm fine either way as long as Dockerhub will let me delete the old one.  Whatever the outcome all I don't want is for there to be a \"sagemath-dev\" *and* a \"sagemath-develop\" on there.",
    "created_at": "2018-03-30T13:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364364",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Then maybe we should just delete the old `sagemath-develop` image from Dockerhub so that there's no confusion, though I don't know why we can't just reuse the name for the new images as well.  I'm still not convinced it doesn't already serve the same purpose.  I'm fine either way as long as Dockerhub will let me delete the old one.  Whatever the outcome all I don't want is for there to be a "sagemath-dev" *and* a "sagemath-develop" on there.



---

archive/issue_comments_364365.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-02T22:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364365",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364366.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-04T21:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364366",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364367.json:
```json
{
    "body": "<a id='comment:111'></a>Replying to [comment:105 nthiery]:\n> No strong opinion on `sage -sh` either. The only important feature is that, for binder use but also beyond, the commands `jupyter`, `gap`, `singular`, ... be in the path and work.\n\n\nnthiery: I would like to automatically test that this is the case. So actually what's the requirement here? How does binder run this image?",
    "created_at": "2018-04-04T21:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364367",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:111'></a>Replying to [comment:105 nthiery]:
> No strong opinion on `sage -sh` either. The only important feature is that, for binder use but also beyond, the commands `jupyter`, `gap`, `singular`, ... be in the path and work.


nthiery: I would like to automatically test that this is the case. So actually what's the requirement here? How does binder run this image?



---

archive/issue_comments_364368.json:
```json
{
    "body": "<a id='comment:2'></a>It's nothing special about binder per se--rather, it's what the current Docker image does.  It sets the default environment so that, for example, `$SAGE_LOCAL/bin` is on the PATH, so all commands installed as part of Sage \"just work\".\n\nI had to remind myself exactly how this works though.  It does not start the container with `sage -sh` like I suggested previously.  I think I ran into some problems with that as well.  However, my solution does take many of the environment variables that result from running `sage -sh` and sets them by default in the container:\n\nhttps://github.com/sagemath/docker-images/commit/acbfc7d54d435cf11b6325e93eab2c3dfe9ee48c#diff-9cf7721d3a01b10049e0d9f6e29e4058R45\n\nI think it would be good to keep something like this.  Actually, it's very important for binder to work correctly since it also ensures that it's running the Jupyter installed with Sage.",
    "created_at": "2018-04-05T10:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364368",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>It's nothing special about binder per se--rather, it's what the current Docker image does.  It sets the default environment so that, for example, `$SAGE_LOCAL/bin` is on the PATH, so all commands installed as part of Sage "just work".

I had to remind myself exactly how this works though.  It does not start the container with `sage -sh` like I suggested previously.  I think I ran into some problems with that as well.  However, my solution does take many of the environment variables that result from running `sage -sh` and sets them by default in the container:

https://github.com/sagemath/docker-images/commit/acbfc7d54d435cf11b6325e93eab2c3dfe9ee48c#diff-9cf7721d3a01b10049e0d9f6e29e4058R45

I think it would be good to keep something like this.  Actually, it's very important for binder to work correctly since it also ensures that it's running the Jupyter installed with Sage.



---

archive/issue_comments_364369.json:
```json
{
    "body": "<a id='comment:3'></a>I think there might still be some little details I'm not personally happy with and I have some doubts still about some naming issues.  However, if/when this is working for you I'd like to get it merged so we can go ahead and start playing with it, and then fuss about the details later.  I think we should also coordinate with Volker on this--I think it would be nice if he can allow us to push changes to develop just on the CI stuff on an as-needed basis without having to necessarily go through a full CI cycle with the buildbots, since this obviously doesn't affect any of the existing continuous integration process.",
    "created_at": "2018-04-05T10:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364369",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I think there might still be some little details I'm not personally happy with and I have some doubts still about some naming issues.  However, if/when this is working for you I'd like to get it merged so we can go ahead and start playing with it, and then fuss about the details later.  I think we should also coordinate with Volker on this--I think it would be nice if he can allow us to push changes to develop just on the CI stuff on an as-needed basis without having to necessarily go through a full CI cycle with the buildbots, since this obviously doesn't affect any of the existing continuous integration process.



---

archive/issue_comments_364370.json:
```json
{
    "body": "<a id='comment:114'></a>Replying to [comment:112 embray]:\n> It's nothing special about binder per se--rather, it's what the current Docker image does.  It sets the default environment so that, for example, `$SAGE_LOCAL/bin` is on the PATH, so all commands installed as part of Sage \"just work\".\n> \n> I had to remind myself exactly how this works though.  It does not start the container with `sage -sh` like I suggested previously.  I think I ran into some problems with that as well.  However, my solution does take many of the environment variables that result from running `sage -sh` and sets them by default in the container:\n> \n> https://github.com/sagemath/docker-images/commit/acbfc7d54d435cf11b6325e93eab2c3dfe9ee48c#diff-9cf7721d3a01b10049e0d9f6e29e4058R45\n> \n> I think it would be good to keep something like this.  Actually, it's very important for binder to work correctly since it also ensures that it's running the Jupyter installed with Sage.\n\n\nOk. But how is that different from just setting the entrypoint to `sage -sh` like I do currently?",
    "created_at": "2018-04-06T21:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364370",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:114'></a>Replying to [comment:112 embray]:
> It's nothing special about binder per se--rather, it's what the current Docker image does.  It sets the default environment so that, for example, `$SAGE_LOCAL/bin` is on the PATH, so all commands installed as part of Sage "just work".
> 
> I had to remind myself exactly how this works though.  It does not start the container with `sage -sh` like I suggested previously.  I think I ran into some problems with that as well.  However, my solution does take many of the environment variables that result from running `sage -sh` and sets them by default in the container:
> 
> https://github.com/sagemath/docker-images/commit/acbfc7d54d435cf11b6325e93eab2c3dfe9ee48c#diff-9cf7721d3a01b10049e0d9f6e29e4058R45
> 
> I think it would be good to keep something like this.  Actually, it's very important for binder to work correctly since it also ensures that it's running the Jupyter installed with Sage.


Ok. But how is that different from just setting the entrypoint to `sage -sh` like I do currently?



---

archive/issue_comments_364371.json:
```json
{
    "body": "<a id='comment:6'></a>embray, there is now a shortcut to start jupyter with the usual arguments: `docker run -p8888:8888 sagemath/sagemath:latest sage-jupyter`\n\nDo you think that's good enough?",
    "created_at": "2018-04-06T22:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364371",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>embray, there is now a shortcut to start jupyter with the usual arguments: `docker run -p8888:8888 sagemath/sagemath:latest sage-jupyter`

Do you think that's good enough?



---

archive/issue_comments_364372.json:
```json
{
    "body": "<a id='comment:117'></a>> Ok. But how is that different from just setting the entrypoint to `sage -sh` like I do currently?\n\n\n\nWill it work if someone does something like `docker run -ti gap` ?",
    "created_at": "2018-04-08T05:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364372",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:117'></a>> Ok. But how is that different from just setting the entrypoint to `sage -sh` like I do currently?



Will it work if someone does something like `docker run -ti gap` ?



---

archive/issue_comments_364373.json:
```json
{
    "body": "<a id='comment:118'></a>>  nthiery: I would like to automatically test that this is the case. So\n>  actually what's the requirement here? How does binder run this image?\n\n\nBinder just runs the docker image with appropriate port forwarding,\nand then launches in the container the command 'jupyter notebook' from\nthe path, with the port flag and a few others. At some stage, it was\ninstead calling directly the command `jupyter-notebook` but presumably\nthis is no more the case.\n\nThe specific requirements are there:\n\nhttps://mybinder.readthedocs.io/en/latest/dockerfile.html#preparing-your-dockerfile\n\nNotes:\n\n- We enforced the notebook=5 with with a pip install in our previous\n  docker image. Since #24168, merged in 8.1, the notebook has been\n  upgraded to v5, so the pip install should not be needed anymore.\n\n- Items 4 and 5 do not apply to Sage's docker image; instead they are\n  about the (essentially trivial) Dockerfile's that authors of\n  binder-enabled repositories will write.\n\n  Btw: Item 5 is new in the documentation; and seems optional at this\n  stage.",
    "created_at": "2018-04-08T06:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364373",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:118'></a>>  nthiery: I would like to automatically test that this is the case. So
>  actually what's the requirement here? How does binder run this image?


Binder just runs the docker image with appropriate port forwarding,
and then launches in the container the command 'jupyter notebook' from
the path, with the port flag and a few others. At some stage, it was
instead calling directly the command `jupyter-notebook` but presumably
this is no more the case.

The specific requirements are there:

https://mybinder.readthedocs.io/en/latest/dockerfile.html#preparing-your-dockerfile

Notes:

- We enforced the notebook=5 with with a pip install in our previous
  docker image. Since #24168, merged in 8.1, the notebook has been
  upgraded to v5, so the pip install should not be needed anymore.

- Items 4 and 5 do not apply to Sage's docker image; instead they are
  about the (essentially trivial) Dockerfile's that authors of
  binder-enabled repositories will write.

  Btw: Item 5 is new in the documentation; and seems optional at this
  stage.



---

archive/issue_comments_364374.json:
```json
{
    "body": "<a id='comment:119'></a>Replying to [comment:114 saraedum]:\n> Replying to [comment:112 embray]:\n> > It's nothing special about binder per se--rather, it's what the current Docker image does.  It sets the default environment so that, for example, `$SAGE_LOCAL/bin` is on the PATH, so all commands installed as part of Sage \"just work\".\n> > \n> > I had to remind myself exactly how this works though.  It does not start the container with `sage -sh` like I suggested previously.  I think I ran into some problems with that as well.  However, my solution does take many of the environment variables that result from running `sage -sh` and sets them by default in the container:\n> > \n> > https://github.com/sagemath/docker-images/commit/acbfc7d54d435cf11b6325e93eab2c3dfe9ee48c#diff-9cf7721d3a01b10049e0d9f6e29e4058R45\n> > \n> > I think it would be good to keep something like this.  Actually, it's very important for binder to work correctly since it also ensures that it's running the Jupyter installed with Sage.\n\n> \n> Ok. But how is that different from just setting the entrypoint to `sage -sh` like I do currently?\n\n\nIIRC it's a little less invasive and works for more use cases.  I can't remember though exactly why I didn't put `sage -sh` in the entrypoint.  I know I tried that and it had various problems.",
    "created_at": "2018-04-09T09:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364374",
    "user": "https://github.com/embray"
}
```

<a id='comment:119'></a>Replying to [comment:114 saraedum]:
> Replying to [comment:112 embray]:
> > It's nothing special about binder per se--rather, it's what the current Docker image does.  It sets the default environment so that, for example, `$SAGE_LOCAL/bin` is on the PATH, so all commands installed as part of Sage "just work".
> > 
> > I had to remind myself exactly how this works though.  It does not start the container with `sage -sh` like I suggested previously.  I think I ran into some problems with that as well.  However, my solution does take many of the environment variables that result from running `sage -sh` and sets them by default in the container:
> > 
> > https://github.com/sagemath/docker-images/commit/acbfc7d54d435cf11b6325e93eab2c3dfe9ee48c#diff-9cf7721d3a01b10049e0d9f6e29e4058R45
> > 
> > I think it would be good to keep something like this.  Actually, it's very important for binder to work correctly since it also ensures that it's running the Jupyter installed with Sage.

> 
> Ok. But how is that different from just setting the entrypoint to `sage -sh` like I do currently?


IIRC it's a little less invasive and works for more use cases.  I can't remember though exactly why I didn't put `sage -sh` in the entrypoint.  I know I tried that and it had various problems.



---

archive/issue_comments_364375.json:
```json
{
    "body": "<a id='comment:0'></a>Just a random thought: this might be calling for an equivalent of conda's `source activate` to setup sage's environment variables without having to run a subshell as in `sage -sh`.",
    "created_at": "2018-04-09T09:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364375",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:0'></a>Just a random thought: this might be calling for an equivalent of conda's `source activate` to setup sage's environment variables without having to run a subshell as in `sage -sh`.



---

archive/issue_comments_364376.json:
```json
{
    "body": "<a id='comment:1'></a>I agree--I think that was the main problem here--that `sage -sh` ran a subshell.",
    "created_at": "2018-04-09T09:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364376",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>I agree--I think that was the main problem here--that `sage -sh` ran a subshell.



---

archive/issue_comments_364377.json:
```json
{
    "body": "<a id='comment:122'></a>Replying to [comment:121 embray]:\n> I agree--I think that was the main problem here--that `sage -sh` ran a subshell.\n\n\nWhy is that a problem?",
    "created_at": "2018-04-09T10:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364377",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:122'></a>Replying to [comment:121 embray]:
> I agree--I think that was the main problem here--that `sage -sh` ran a subshell.


Why is that a problem?



---

archive/issue_comments_364378.json:
```json
{
    "body": "<a id='comment:123'></a>Replying to [comment:121 embray]:\n> I agree--I think that was the main problem here--that `sage -sh` ran a subshell.\n\n\nSo this runs a shell but then spawns the argument with `exec` so there is no additional process created if that's what you would like to avoid.",
    "created_at": "2018-04-09T10:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364378",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:123'></a>Replying to [comment:121 embray]:
> I agree--I think that was the main problem here--that `sage -sh` ran a subshell.


So this runs a shell but then spawns the argument with `exec` so there is no additional process created if that's what you would like to avoid.



---

archive/issue_comments_364379.json:
```json
{
    "body": "<a id='comment:4'></a>I think my main motivation was just ensure that the environment by default has Sage on the `$PATH`, as well as any other environment variables needed at runtime for software installed by Sage.  But I admit I can't remember why I also didn't just essentially make `sage -sh` the entrypoint.  I think it was partly because of what you yourself said in terms of it changing too much of the default environment.  I'm pretty sure I tried that at first and something didn't work right, but since I can't remember what it was I'd say go for it and give it a try anyways.\n\nBut I do agree with Nicolas that something like a `source sage-activate` would be good to have in Sage, to just modify the existing environment without going into a subshell (and a `deactivate` would be nice to have as well).  We could handle that in another issue though...",
    "created_at": "2018-04-09T13:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364379",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I think my main motivation was just ensure that the environment by default has Sage on the `$PATH`, as well as any other environment variables needed at runtime for software installed by Sage.  But I admit I can't remember why I also didn't just essentially make `sage -sh` the entrypoint.  I think it was partly because of what you yourself said in terms of it changing too much of the default environment.  I'm pretty sure I tried that at first and something didn't work right, but since I can't remember what it was I'd say go for it and give it a try anyways.

But I do agree with Nicolas that something like a `source sage-activate` would be good to have in Sage, to just modify the existing environment without going into a subshell (and a `deactivate` would be nice to have as well).  We could handle that in another issue though...



---

archive/issue_comments_364380.json:
```json
{
    "body": "<a id='comment:5'></a>Sometimes my builds on [GitLab](GitLab) hang. Apparently during the step of uploading build artifacts. The problem is that the log has already exceeded 3MB at that point so I can't see what was the actual build error. It would be nice of somehow dropping the boring parts from the log in GitLab\u2026",
    "created_at": "2018-04-12T18:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364380",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Sometimes my builds on [GitLab](GitLab) hang. Apparently during the step of uploading build artifacts. The problem is that the log has already exceeded 3MB at that point so I can't see what was the actual build error. It would be nice of somehow dropping the boring parts from the log in GitLab…



---

archive/issue_comments_364381.json:
```json
{
    "body": "<a id='comment:6'></a>Since the build hangs during docbuild, I have a feeling that #25161 might be to blame.",
    "created_at": "2018-04-13T13:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364381",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>Since the build hangs during docbuild, I have a feeling that #25161 might be to blame.



---

archive/issue_comments_364382.json:
```json
{
    "body": "<a id='comment:7'></a>Could I see a link to one of the builds that hanged?  Also how much of the logs are we outputting?  We could certainly add a less verbose log option.  Most of the logs are written to files anyways, so if we needed to do some post-mortem debugging we can just look in the files, and avoid writing so much to stdout.",
    "created_at": "2018-04-13T14:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364382",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Could I see a link to one of the builds that hanged?  Also how much of the logs are we outputting?  We could certainly add a less verbose log option.  Most of the logs are written to files anyways, so if we needed to do some post-mortem debugging we can just look in the files, and avoid writing so much to stdout.



---

archive/issue_comments_364383.json:
```json
{
    "body": "<a id='comment:8'></a>Here's an example of a build that timed out: https://gitlab.com/saraedum/sage/-/jobs/62689653\nEverything interesting is missing in this log. [GitLab](GitLab) limits logs to about 4MB, so I had to cut the build log after 3MB. We can only download the log files when there was no timeout\u2026\n\nI'll try to make this work better in case of timeouts. I'll report back when I know what's the last thing that happens before the timeout.",
    "created_at": "2018-04-13T16:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364383",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:8'></a>Here's an example of a build that timed out: https://gitlab.com/saraedum/sage/-/jobs/62689653
Everything interesting is missing in this log. [GitLab](GitLab) limits logs to about 4MB, so I had to cut the build log after 3MB. We can only download the log files when there was no timeout…

I'll try to make this work better in case of timeouts. I'll report back when I know what's the last thing that happens before the timeout.



---

archive/issue_comments_364384.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-04-13T19:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364384",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_364385.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-13T19:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364385",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364386.json:
```json
{
    "body": "<a id='comment:1'></a>Last 10 new commits:\n|                                                                                                                                          |                                                                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|\n|[0936a5d](https://git.sagemath.org/sage.git/commit?id=0936a5de140a5fa3f6f9e0f5960702bfc4a16702)|`Merge remote-tracking branch 'trac/u/saraedum/sphinxbuild-stack' into u/saraedum/gitlabci`|\n|[3f0c2f0](https://git.sagemath.org/sage.git/commit?id=3f0c2f0c50cc700d28bb179867ef5474ebfa6f40)|`Add doctest for #25160`|\n|[0477b3c](https://git.sagemath.org/sage.git/commit?id=0477b3c52728e39271bb19210458f64fe62a22d5)|`Check for errors before ignoring output`|\n|[6b80d72](https://git.sagemath.org/sage.git/commit?id=6b80d72310842b1803ec095899aa936471d030fc)|`Merge remote-tracking branch 'trac/u/saraedum/sphinxbuild-stack' into u/saraedum/gitlabci`|\n|[ca66c03](https://git.sagemath.org/sage.git/commit?id=ca66c033e2d3023c5d51f0206954ed3e5c3aa3c6)|`Revert \"Check for errors before ignoring output\"`|\n|[42993c9](https://git.sagemath.org/sage.git/commit?id=42993c9140f0c721ae9b72c03331a466c4505402)|`Merge remote-tracking branch 'trac/u/saraedum/sphinxbuild-stack' into u/saraedum/gitlabci`|\n|[6aade39](https://git.sagemath.org/sage.git/commit?id=6aade395c5bb9cf92118c317942a7398f22ad08b)|`Silence docker pull`|\n|[93a7ba6](https://git.sagemath.org/sage.git/commit?id=93a7ba6f9f07e6076bed9002a58b62a1f3c3beec)|`Silence apt-get`|\n|[158af15](https://git.sagemath.org/sage.git/commit?id=158af15bf74e2604c6d3606867f0b6143bfe58ef)|`Silence setup.py`|\n|[3c78351](https://git.sagemath.org/sage.git/commit?id=3c78351fdcbfe93c2c353d0aef23bc2e976d7e17)|`Ignore much more useless chatter in sphinx build`|\n---\nNew commits:",
    "created_at": "2018-04-13T19:47:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364386",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>Last 10 new commits:
|                                                                                                                                          |                                                                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
|[0936a5d](https://git.sagemath.org/sage.git/commit?id=0936a5de140a5fa3f6f9e0f5960702bfc4a16702)|`Merge remote-tracking branch 'trac/u/saraedum/sphinxbuild-stack' into u/saraedum/gitlabci`|
|[3f0c2f0](https://git.sagemath.org/sage.git/commit?id=3f0c2f0c50cc700d28bb179867ef5474ebfa6f40)|`Add doctest for #25160`|
|[0477b3c](https://git.sagemath.org/sage.git/commit?id=0477b3c52728e39271bb19210458f64fe62a22d5)|`Check for errors before ignoring output`|
|[6b80d72](https://git.sagemath.org/sage.git/commit?id=6b80d72310842b1803ec095899aa936471d030fc)|`Merge remote-tracking branch 'trac/u/saraedum/sphinxbuild-stack' into u/saraedum/gitlabci`|
|[ca66c03](https://git.sagemath.org/sage.git/commit?id=ca66c033e2d3023c5d51f0206954ed3e5c3aa3c6)|`Revert "Check for errors before ignoring output"`|
|[42993c9](https://git.sagemath.org/sage.git/commit?id=42993c9140f0c721ae9b72c03331a466c4505402)|`Merge remote-tracking branch 'trac/u/saraedum/sphinxbuild-stack' into u/saraedum/gitlabci`|
|[6aade39](https://git.sagemath.org/sage.git/commit?id=6aade395c5bb9cf92118c317942a7398f22ad08b)|`Silence docker pull`|
|[93a7ba6](https://git.sagemath.org/sage.git/commit?id=93a7ba6f9f07e6076bed9002a58b62a1f3c3beec)|`Silence apt-get`|
|[158af15](https://git.sagemath.org/sage.git/commit?id=158af15bf74e2604c6d3606867f0b6143bfe58ef)|`Silence setup.py`|
|[3c78351](https://git.sagemath.org/sage.git/commit?id=3c78351fdcbfe93c2c353d0aef23bc2e976d7e17)|`Ignore much more useless chatter in sphinx build`|
---
New commits:



---

archive/issue_comments_364387.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-13T20:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364387",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364388.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-14T10:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364388",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364389.json:
```json
{
    "body": "<a id='comment:4'></a>Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. I did not manage to create swap space inside docker, so we can only use (single core) GCE runners at the moment. Also we can not build from scratch (i.e., master & develop) on [GitLab](GitLab) anymore with shared runners.\n\nWe should maybe create a sage group on gitlab where developers get access to more powerful runners. Maybe something we can talk about in Cernay.",
    "created_at": "2018-04-14T10:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364389",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. I did not manage to create swap space inside docker, so we can only use (single core) GCE runners at the moment. Also we can not build from scratch (i.e., master & develop) on [GitLab](GitLab) anymore with shared runners.

We should maybe create a sage group on gitlab where developers get access to more powerful runners. Maybe something we can talk about in Cernay.



---

archive/issue_comments_364390.json:
```json
{
    "body": "<a id='comment:5'></a>Anyway, this needs review again. It seems to work fine on [GitLab](GitLab) CI & CircleCI at the moment.\n\nYou can see recent [GitLab](GitLab) pipelines here: https://gitlab.com/saraedum/sage/pipelines (note the \"stuck\" tasks because there are no shared runners that provide enough HDD & RAM for build-from-clean.)\n\nYou can also see the CircleCI runs here: https://circleci.com/gh/saraedum/sage (build-from-clean works fine here.)",
    "created_at": "2018-04-14T10:28:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364390",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Anyway, this needs review again. It seems to work fine on [GitLab](GitLab) CI & CircleCI at the moment.

You can see recent [GitLab](GitLab) pipelines here: https://gitlab.com/saraedum/sage/pipelines (note the "stuck" tasks because there are no shared runners that provide enough HDD & RAM for build-from-clean.)

You can also see the CircleCI runs here: https://circleci.com/gh/saraedum/sage (build-from-clean works fine here.)



---

archive/issue_comments_364391.json:
```json
{
    "body": "<a id='comment:6'></a>I'd be hesitant to move forward on this if it can't build the docs from scratch anymore (though maybe it's not actually that big a problem...?)\n\nThat said, I don't want to hold this up any longer.  I just wonder exactly what the plan is for \"bootstrapping\" the whole system if it can't build a working Sage image from scratch.\n\nAlso, have you tried using serial doc build?  I seem to recall that ends up using less RAM, but takes longer of course...",
    "created_at": "2018-04-19T12:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364391",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>I'd be hesitant to move forward on this if it can't build the docs from scratch anymore (though maybe it's not actually that big a problem...?)

That said, I don't want to hold this up any longer.  I just wonder exactly what the plan is for "bootstrapping" the whole system if it can't build a working Sage image from scratch.

Also, have you tried using serial doc build?  I seem to recall that ends up using less RAM, but takes longer of course...



---

archive/issue_comments_364392.json:
```json
{
    "body": "<a id='comment:137'></a>Replying to [comment:134 saraedum]:\n> Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. \n\n\nAh, I see what you're saying.  If the docs are built in serial that might be *just* enough, but even with just 2 process 2GB is not currently enough.  I'm doing a little analysis of the doc build memory usage, and in the reference docs the manifolds docs take by far the longest, and by themselves chew up to ~800MB for the docbuild process alone, not to mention the couple of instances of maxima it spins up.  Meanwhile the combinat docs are some of the most memory-hungry and consume nearly 1.5 GB, so that alone would be enough to run afoul of a 2GB limit.\n\nI know this has been looked at a lot before, but I must believe there's something we can do to more tightly limit memory usage of the docbuilds...",
    "created_at": "2018-04-19T14:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364392",
    "user": "https://github.com/embray"
}
```

<a id='comment:137'></a>Replying to [comment:134 saraedum]:
> Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. 


Ah, I see what you're saying.  If the docs are built in serial that might be *just* enough, but even with just 2 process 2GB is not currently enough.  I'm doing a little analysis of the doc build memory usage, and in the reference docs the manifolds docs take by far the longest, and by themselves chew up to ~800MB for the docbuild process alone, not to mention the couple of instances of maxima it spins up.  Meanwhile the combinat docs are some of the most memory-hungry and consume nearly 1.5 GB, so that alone would be enough to run afoul of a 2GB limit.

I know this has been looked at a lot before, but I must believe there's something we can do to more tightly limit memory usage of the docbuilds...



---

archive/issue_comments_364393.json:
```json
{
    "body": "<a id='comment:138'></a>Replying to [comment:136 embray]:\n> I'd be hesitant to move forward on this if it can't build the docs from scratch anymore (though maybe it's not actually that big a problem...?)\n\nYes, I also don't really like to go ahead like that. It works on Circle and if you provide your own runners also on [GitLab](GitLab). But let me try a bit harder to make this work on GitLab's own shared runners again\u2026\n\n> That said, I don't want to hold this up any longer.  I just wonder exactly what the plan is for \"bootstrapping\" the whole system if it can't build a working Sage image from scratch.\n\nWe can bootstrap from CircleCI, or from my [GitLab](GitLab) runners that run on Google Compute Engine.\n\n> Also, have you tried using serial doc build?  I seem to recall that ends up using less RAM, but takes longer of course...\n\nI am building serial (MAKE=make -j1) already.",
    "created_at": "2018-04-19T19:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364393",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:138'></a>Replying to [comment:136 embray]:
> I'd be hesitant to move forward on this if it can't build the docs from scratch anymore (though maybe it's not actually that big a problem...?)

Yes, I also don't really like to go ahead like that. It works on Circle and if you provide your own runners also on [GitLab](GitLab). But let me try a bit harder to make this work on GitLab's own shared runners again…

> That said, I don't want to hold this up any longer.  I just wonder exactly what the plan is for "bootstrapping" the whole system if it can't build a working Sage image from scratch.

We can bootstrap from CircleCI, or from my [GitLab](GitLab) runners that run on Google Compute Engine.

> Also, have you tried using serial doc build?  I seem to recall that ends up using less RAM, but takes longer of course...

I am building serial (MAKE=make -j1) already.



---

archive/issue_comments_364394.json:
```json
{
    "body": "<a id='comment:139'></a>Replying to [comment:137 embray]:\n> Replying to [comment:134 saraedum]:\n> > Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. \n\n> \n> Ah, I see what you're saying.  If the docs are built in serial that might be *just* enough, but even with just 2 process 2GB is not currently enough.  I'm doing a little analysis of the doc build memory usage, and in the reference docs the manifolds docs take by far the longest, and by themselves chew up to ~800MB for the docbuild process alone, not to mention the couple of instances of maxima it spins up.  Meanwhile the combinat docs are some of the most memory-hungry and consume nearly 1.5 GB, so that alone would be enough to run afoul of a 2GB limit.\n> \n> I know this has been looked at a lot before, but I must believe there's something we can do to more tightly limit memory usage of the docbuilds...\n\nSo the actual problem seems to come from tachyon invocations.",
    "created_at": "2018-04-19T19:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364394",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:139'></a>Replying to [comment:137 embray]:
> Replying to [comment:134 saraedum]:
> > Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. 

> 
> Ah, I see what you're saying.  If the docs are built in serial that might be *just* enough, but even with just 2 process 2GB is not currently enough.  I'm doing a little analysis of the doc build memory usage, and in the reference docs the manifolds docs take by far the longest, and by themselves chew up to ~800MB for the docbuild process alone, not to mention the couple of instances of maxima it spins up.  Meanwhile the combinat docs are some of the most memory-hungry and consume nearly 1.5 GB, so that alone would be enough to run afoul of a 2GB limit.
> 
> I know this has been looked at a lot before, but I must believe there's something we can do to more tightly limit memory usage of the docbuilds...

So the actual problem seems to come from tachyon invocations.



---

archive/issue_comments_364395.json:
```json
{
    "body": "<a id='comment:140'></a>Replying to [comment:139 saraedum]:\n> Replying to [comment:137 embray]:\n> > Replying to [comment:134 saraedum]:\n> > > Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. \n\n> > \n> > Ah, I see what you're saying.  If the docs are built in serial that might be *just* enough, but even with just 2 process 2GB is not currently enough.  I'm doing a little analysis of the doc build memory usage, and in the reference docs the manifolds docs take by far the longest, and by themselves chew up to ~800MB for the docbuild process alone, not to mention the couple of instances of maxima it spins up.  Meanwhile the combinat docs are some of the most memory-hungry and consume nearly 1.5 GB, so that alone would be enough to run afoul of a 2GB limit.\n> > \n> > I know this has been looked at a lot before, but I must believe there's something we can do to more tightly limit memory usage of the docbuilds...\n\n> So the actual problem seems to come from tachyon invocations.\nSo, I guess that's probably not true. The problem surfaces when the docbuild runs `os.fork` to spawn the tachyon process. The fork itself should be quite lightweight, so how can it be that actually `fork` fails and not something inside tachyon after the fork?",
    "created_at": "2018-04-19T19:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364395",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:140'></a>Replying to [comment:139 saraedum]:
> Replying to [comment:137 embray]:
> > Replying to [comment:134 saraedum]:
> > > Apparently, [GitLab](GitLab) has downgraded their digitalocean runners from 4GB of RAM to only 2GB. That's not enough to build the documentation. 

> > 
> > Ah, I see what you're saying.  If the docs are built in serial that might be *just* enough, but even with just 2 process 2GB is not currently enough.  I'm doing a little analysis of the doc build memory usage, and in the reference docs the manifolds docs take by far the longest, and by themselves chew up to ~800MB for the docbuild process alone, not to mention the couple of instances of maxima it spins up.  Meanwhile the combinat docs are some of the most memory-hungry and consume nearly 1.5 GB, so that alone would be enough to run afoul of a 2GB limit.
> > 
> > I know this has been looked at a lot before, but I must believe there's something we can do to more tightly limit memory usage of the docbuilds...

> So the actual problem seems to come from tachyon invocations.
So, I guess that's probably not true. The problem surfaces when the docbuild runs `os.fork` to spawn the tachyon process. The fork itself should be quite lightweight, so how can it be that actually `fork` fails and not something inside tachyon after the fork?



---

archive/issue_comments_364396.json:
```json
{
    "body": "<a id='comment:1'></a>Though the fork is cheap, there could be an overcommit policy that's causing the trouble\u2026 https://stackoverflow.com/a/13329386/812379",
    "created_at": "2018-04-19T20:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364396",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>Though the fork is cheap, there could be an overcommit policy that's causing the trouble… https://stackoverflow.com/a/13329386/812379



---

archive/issue_comments_364397.json:
```json
{
    "body": "<a id='comment:2'></a>The serial runner might curiously be the culprit here. Somewhere in the sphinx build we seem to be leaking memory. Here I am plotting the memory usage in a serial build just before the call to `sphinxbuild()`:\n\n```\n[manifolds] process.memory_info()[0]): 280907776\n[dynamics ] process.memory_info()[0]): 349028352\n[polynomia] process.memory_info()[0]): 365514752\n[repl     ] process.memory_info()[0]): 375050240\n[tensor_fr] process.memory_info()[0]): 375050240\n[combinat ] process.memory_info()[0]): 382959616\n[plot3d   ] process.memory_info()[0]): 1632706560\n```\n\nAnd here is the same if I run this through the pool but with just one process:\n\n```\n[manifolds] process.memory_info()[0]): 230350848\n[dynamics ] process.memory_info()[0]): 191688704\n[polynomia] process.memory_info()[0]): 210935808\n[repl     ] process.memory_info()[0]): 176205824\n[tensor_fr] process.memory_info()[0]): 163934208\n[combinat ] process.memory_info()[0]): 517341184\n[plot3d   ] process.memory_info()[0]): 170418176\n```\n\nBtw, I am running `./sage -docbuild en/reference inventory` here but that's probably not that important.",
    "created_at": "2018-04-19T21:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364397",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'></a>The serial runner might curiously be the culprit here. Somewhere in the sphinx build we seem to be leaking memory. Here I am plotting the memory usage in a serial build just before the call to `sphinxbuild()`:

```
[manifolds] process.memory_info()[0]): 280907776
[dynamics ] process.memory_info()[0]): 349028352
[polynomia] process.memory_info()[0]): 365514752
[repl     ] process.memory_info()[0]): 375050240
[tensor_fr] process.memory_info()[0]): 375050240
[combinat ] process.memory_info()[0]): 382959616
[plot3d   ] process.memory_info()[0]): 1632706560
```

And here is the same if I run this through the pool but with just one process:

```
[manifolds] process.memory_info()[0]): 230350848
[dynamics ] process.memory_info()[0]): 191688704
[polynomia] process.memory_info()[0]): 210935808
[repl     ] process.memory_info()[0]): 176205824
[tensor_fr] process.memory_info()[0]): 163934208
[combinat ] process.memory_info()[0]): 517341184
[plot3d   ] process.memory_info()[0]): 170418176
```

Btw, I am running `./sage -docbuild en/reference inventory` here but that's probably not that important.



---

archive/issue_comments_364398.json:
```json
{
    "body": "<a id='comment:144'></a>Replying to [comment:141 saraedum]:\n> Though the fork is cheap, there could be an overcommit policy that's causing the trouble\u2026 https://stackoverflow.com/a/13329386/812379\n\nThe overcommit policy is set to 50% overcommit which isn't that much if you only have 2GB and no swap.",
    "created_at": "2018-04-19T21:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364398",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:144'></a>Replying to [comment:141 saraedum]:
> Though the fork is cheap, there could be an overcommit policy that's causing the trouble… https://stackoverflow.com/a/13329386/812379

The overcommit policy is set to 50% overcommit which isn't that much if you only have 2GB and no swap.



---

archive/issue_comments_364399.json:
```json
{
    "body": "<a id='comment:145'></a>Replying to [comment:141 saraedum]:\n> Though the fork is cheap, there could be an overcommit policy that's causing the trouble\u2026 https://stackoverflow.com/a/13329386/812379\n\n\nThat's certainly one thing I was wondering:  Is the limit for the runners on virtual memory, or actual resident memory?",
    "created_at": "2018-04-20T13:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364399",
    "user": "https://github.com/embray"
}
```

<a id='comment:145'></a>Replying to [comment:141 saraedum]:
> Though the fork is cheap, there could be an overcommit policy that's causing the trouble… https://stackoverflow.com/a/13329386/812379


That's certainly one thing I was wondering:  Is the limit for the runners on virtual memory, or actual resident memory?



---

archive/issue_comments_364400.json:
```json
{
    "body": "<a id='comment:146'></a>Replying to [comment:142 saraedum]:\n> The serial runner might curiously be the culprit here. Somewhere in the sphinx build we seem to be leaking memory. Here I am plotting the memory usage in a serial build just before the call to `sphinxbuild()`:\n\n\nYes, there are definitely some big memory leaks in the doc build.  I think Florent spent a lot of time trying to track some of those down, but I don't know if we ever made any progress.  I'm going to start looking into it now because, well, I personally haven't tried and I'm curious.\n\nI know it's not during the individual docbuilds:  For example, some of the docs still use a lot of memory for their builds--mostly for holding their huge doctrees (e.g. manifolds uses >1GB for this).  I would also like to try to reduce this if possible (maybe even splitting up some of the huger docs like manifolds into smaller subdocs).  But either way, the individual docbuilds release most of the memory they eat up when they're done, so that's not where the leak is.  But after the inventories are *merged*, by which I mean this part in `ReferenceBuilder._wrapper`:\n\n```\n 506             # The html refman must be build at the end to ensure correct\n 507             # merging of indexes and inventories.\n 508             # Sphinx is run here in the current process (not in a\n 509             # subprocess) and the IntersphinxCache gets populated to be\n 510             # used for the second pass of the reference manual and for\n 511             # the other documents.\n 512             getattr(DocBuilder(self.name, lang), format)(*args, **kwds)\n```\n\nit chews up about a gigabyte alone, and never releases it.  I thought at first this might be the `InventoryCache` itself, but no that only appears to be about `~50MB` in size by my accounting.  So there's some other big objects that hang around when they really shouldn't anymore.",
    "created_at": "2018-04-20T13:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364400",
    "user": "https://github.com/embray"
}
```

<a id='comment:146'></a>Replying to [comment:142 saraedum]:
> The serial runner might curiously be the culprit here. Somewhere in the sphinx build we seem to be leaking memory. Here I am plotting the memory usage in a serial build just before the call to `sphinxbuild()`:


Yes, there are definitely some big memory leaks in the doc build.  I think Florent spent a lot of time trying to track some of those down, but I don't know if we ever made any progress.  I'm going to start looking into it now because, well, I personally haven't tried and I'm curious.

I know it's not during the individual docbuilds:  For example, some of the docs still use a lot of memory for their builds--mostly for holding their huge doctrees (e.g. manifolds uses >1GB for this).  I would also like to try to reduce this if possible (maybe even splitting up some of the huger docs like manifolds into smaller subdocs).  But either way, the individual docbuilds release most of the memory they eat up when they're done, so that's not where the leak is.  But after the inventories are *merged*, by which I mean this part in `ReferenceBuilder._wrapper`:

```
 506             # The html refman must be build at the end to ensure correct
 507             # merging of indexes and inventories.
 508             # Sphinx is run here in the current process (not in a
 509             # subprocess) and the IntersphinxCache gets populated to be
 510             # used for the second pass of the reference manual and for
 511             # the other documents.
 512             getattr(DocBuilder(self.name, lang), format)(*args, **kwds)
```

it chews up about a gigabyte alone, and never releases it.  I thought at first this might be the `InventoryCache` itself, but no that only appears to be about `~50MB` in size by my accounting.  So there's some other big objects that hang around when they really shouldn't anymore.



---

archive/issue_comments_364401.json:
```json
{
    "body": "<a id='comment:147'></a>Replying to [comment:142 saraedum]:\n> The serial runner might curiously be the culprit here. Somewhere in the sphinx build we seem to be leaking memory. Here I am plotting the memory usage in a serial build just before the call to `sphinxbuild()`:\n\n\nInteresting--that might be a different leak than the one I'm looking at then.  When the individual doc inventories are built in subprocesses they manage not to leak too much ~~(this despite the fact that subprocesses are being reused for each task (`maxtasksperchild=None`)~~ oops I take that back, it uses `maxtasksperchild=1`",
    "created_at": "2018-04-20T13:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364401",
    "user": "https://github.com/embray"
}
```

<a id='comment:147'></a>Replying to [comment:142 saraedum]:
> The serial runner might curiously be the culprit here. Somewhere in the sphinx build we seem to be leaking memory. Here I am plotting the memory usage in a serial build just before the call to `sphinxbuild()`:


Interesting--that might be a different leak than the one I'm looking at then.  When the individual doc inventories are built in subprocesses they manage not to leak too much ~~(this despite the fact that subprocesses are being reused for each task (`maxtasksperchild=None`)~~ oops I take that back, it uses `maxtasksperchild=1`



---

archive/issue_comments_364402.json:
```json
{
    "body": "<a id='comment:8'></a>A few of the larger objects hanging around attached to `app.env` after the reference doc inventories build:\n\n* app.env.todo_all_todos (~600 MB)\n* app.env.intersphinx_inventory (~50 MB)\n* app.env.intersphinx_cache (~50 MB)\n\nthat is, assuming my recursive getsizeof function is even right (though I think it has a bug somewhere because it actually goes haywire in `app.env.longtitles`--I don't even know what that object is so it requires some exploration...)",
    "created_at": "2018-04-20T14:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364402",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>A few of the larger objects hanging around attached to `app.env` after the reference doc inventories build:

* app.env.todo_all_todos (~600 MB)
* app.env.intersphinx_inventory (~50 MB)
* app.env.intersphinx_cache (~50 MB)

that is, assuming my recursive getsizeof function is even right (though I think it has a bug somewhere because it actually goes haywire in `app.env.longtitles`--I don't even know what that object is so it requires some exploration...)



---

archive/issue_comments_364403.json:
```json
{
    "body": "<a id='comment:9'></a>I forget--is there a reason we *don't* run `runsphinx()` in a subprocess?  Because `sphinx.cmdline.main()` wasn't really ever meant to be invoked as an API in a larger script, and it leaves around all kinds of global state.  Just for example:\n\n* the `logging` module's root logger hangs on to a reference the Sphinx app\n* the `matplotlib.sphinxext.plot_directive.setup` function holds on to a reference to the app for some reason\n\nand there might be other examples.",
    "created_at": "2018-04-20T15:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364403",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>I forget--is there a reason we *don't* run `runsphinx()` in a subprocess?  Because `sphinx.cmdline.main()` wasn't really ever meant to be invoked as an API in a larger script, and it leaves around all kinds of global state.  Just for example:

* the `logging` module's root logger hangs on to a reference the Sphinx app
* the `matplotlib.sphinxext.plot_directive.setup` function holds on to a reference to the app for some reason

and there might be other examples.



---

archive/issue_comments_364404.json:
```json
{
    "body": "<a id='comment:0'></a>There's also quite a lot of Sage-related objects left in memory after the docbuild.",
    "created_at": "2018-04-20T15:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364404",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>There's also quite a lot of Sage-related objects left in memory after the docbuild.



---

archive/issue_comments_364405.json:
```json
{
    "body": "<a id='comment:1'></a>Not right now, but next week I think I will do some refactoring of the docbuild process a bit to ensure that `runsphinx()` is *always* run in a subprocess.  I think that will have a big impact at least in terms of keeping memory leaks under control.\n\nI have some other thoughts I want to try out--that might go quite deep--in terms of keeping doctree sizes under better control too.  But that will probably be a longer effort.",
    "created_at": "2018-04-20T16:44:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364405",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>Not right now, but next week I think I will do some refactoring of the docbuild process a bit to ensure that `runsphinx()` is *always* run in a subprocess.  I think that will have a big impact at least in terms of keeping memory leaks under control.

I have some other thoughts I want to try out--that might go quite deep--in terms of keeping doctree sizes under better control too.  But that will probably be a longer effort.



---

archive/issue_comments_364406.json:
```json
{
    "body": "<a id='comment:2'></a>Thanks for investigating improvements to our Sphinx build! I am adding Florent and Jeroen in CC.\n\nAt Sage Days 77, Florent and a sphinx developper had done some extensive analysis of the memory footprint of Sphinx. IIRC, there was a lot of useless information that was kept in the doctrees; and also some memory abuse that could not be explained, pointing to some plausible bug/leak in Sphinx itself. Also, IIRC, they had come to the conclusion that using Sphinx's built-in parallelisation was not out of reach. An aspect of it is that, instead of manually splitting our reference manual in smaller and smaller chunks we could tentatively revert back to a single document and let Sphinx play its magic.\n\nBut that's from the top of my head from two years ago; I'll let Florent comment and dig up notes from SD77.",
    "created_at": "2018-04-21T08:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364406",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:2'></a>Thanks for investigating improvements to our Sphinx build! I am adding Florent and Jeroen in CC.

At Sage Days 77, Florent and a sphinx developper had done some extensive analysis of the memory footprint of Sphinx. IIRC, there was a lot of useless information that was kept in the doctrees; and also some memory abuse that could not be explained, pointing to some plausible bug/leak in Sphinx itself. Also, IIRC, they had come to the conclusion that using Sphinx's built-in parallelisation was not out of reach. An aspect of it is that, instead of manually splitting our reference manual in smaller and smaller chunks we could tentatively revert back to a single document and let Sphinx play its magic.

But that's from the top of my head from two years ago; I'll let Florent comment and dig up notes from SD77.



---

archive/issue_comments_364407.json:
```json
{
    "body": "<a id='comment:153'></a>Replying to [comment:149 embray]:\n> I forget--is there a reason we *don't* run `runsphinx()` in a subprocess?  Because `sphinx.cmdline.main()` wasn't really ever meant to be invoked as an API in a larger script, and it leaves around all kinds of global state. [...]\n\nThat's what Debian does btw. \nhttps://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch\n\nI think this behaviour was originally introduced in #14204. I am not completely sure, but it seems to me that the idea was to initialize `sage.all` once and then use multiprocessing's Pool to fork the individual builds. I think that it's fine to call the `main` of sphinx in that way. The problem I think is that this broke when (embray I suppose?) introduced the special case for single-threaded builds. So, I guess we need to fork once to control the RAM the docbuild uses.\nIs the serial build still necessary on cygwin?",
    "created_at": "2018-04-21T09:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364407",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:153'></a>Replying to [comment:149 embray]:
> I forget--is there a reason we *don't* run `runsphinx()` in a subprocess?  Because `sphinx.cmdline.main()` wasn't really ever meant to be invoked as an API in a larger script, and it leaves around all kinds of global state. [...]

That's what Debian does btw. 
https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch

I think this behaviour was originally introduced in #14204. I am not completely sure, but it seems to me that the idea was to initialize `sage.all` once and then use multiprocessing's Pool to fork the individual builds. I think that it's fine to call the `main` of sphinx in that way. The problem I think is that this broke when (embray I suppose?) introduced the special case for single-threaded builds. So, I guess we need to fork once to control the RAM the docbuild uses.
Is the serial build still necessary on cygwin?



---

archive/issue_comments_364408.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-21T10:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364408",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364409.json:
```json
{
    "body": "<a id='comment:5'></a>The build from scratch on [GitLab](GitLab) CI works again btw. It takes a bit more than 10h\u2026",
    "created_at": "2018-04-21T10:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364409",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>The build from scratch on [GitLab](GitLab) CI works again btw. It takes a bit more than 10h…



---

archive/issue_comments_364410.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-22T23:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364410",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364411.json:
```json
{
    "body": "<a id='comment:158'></a>Replying to [comment:153 saraedum]:\n> Replying to [comment:149 embray]:\n> > I forget--is there a reason we *don't* run `runsphinx()` in a subprocess?  Because `sphinx.cmdline.main()` wasn't really ever meant to be invoked as an API in a larger script, and it leaves around all kinds of global state. [...]\n\n> That's what Debian does btw. \n> https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch\n> \n> I think this behaviour was originally introduced in #14204. I am not completely sure, but it seems to me that the idea was to initialize `sage.all` once and then use multiprocessing's Pool to fork the individual builds. I think that it's fine to call the `main` of sphinx in that way. The problem I think is that this broke when (embray I suppose?) introduced the special case for single-threaded builds. So, I guess we need to fork once to control the RAM the docbuild uses.\n> Is the serial build still necessary on cygwin?\n\n\nYes, in #21389 I changed things so that `SAGE_NUM_THREADS=1` meant that *no* subprocesses were created during the docuild.  Originally that was motivated by need for Cygwin, but I don't believe that's necessary anymore (all the fork-related bugs *that I know of*) appear to be fixed.  I also now recognize that this is not good behavior.  As I wrote above, there's an enormous amount of global state that `runsphinx()` leaves around, and trying to clean it all up manually would be very difficult, so it should always be run in a subprocess.\n\nLikewise, simply in the process of building the docs, there is also a lot of global state left in Sage (cached values and the like) which it turns out can eat up a lot of memory, especially after some of the larger docs (like manifolds).  This is likewise difficult to manually clean up.\n\nEven a reversion of #21389 wouldn't fully fix the issue though since there are other parts of the docbuild that call `runsphinx()` without calling it in a subprocess, and those are responsible for quite a bit of unnecessary memory leakage currently (even in parallel doc builds).  So I intend to fix that.\n\nWe can follow up on the docbuild discussion elsewhere though, since other than its impact on CI the details of that are orthogonal to this ticket.",
    "created_at": "2018-04-23T15:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364411",
    "user": "https://github.com/embray"
}
```

<a id='comment:158'></a>Replying to [comment:153 saraedum]:
> Replying to [comment:149 embray]:
> > I forget--is there a reason we *don't* run `runsphinx()` in a subprocess?  Because `sphinx.cmdline.main()` wasn't really ever meant to be invoked as an API in a larger script, and it leaves around all kinds of global state. [...]

> That's what Debian does btw. 
> https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch
> 
> I think this behaviour was originally introduced in #14204. I am not completely sure, but it seems to me that the idea was to initialize `sage.all` once and then use multiprocessing's Pool to fork the individual builds. I think that it's fine to call the `main` of sphinx in that way. The problem I think is that this broke when (embray I suppose?) introduced the special case for single-threaded builds. So, I guess we need to fork once to control the RAM the docbuild uses.
> Is the serial build still necessary on cygwin?


Yes, in #21389 I changed things so that `SAGE_NUM_THREADS=1` meant that *no* subprocesses were created during the docuild.  Originally that was motivated by need for Cygwin, but I don't believe that's necessary anymore (all the fork-related bugs *that I know of*) appear to be fixed.  I also now recognize that this is not good behavior.  As I wrote above, there's an enormous amount of global state that `runsphinx()` leaves around, and trying to clean it all up manually would be very difficult, so it should always be run in a subprocess.

Likewise, simply in the process of building the docs, there is also a lot of global state left in Sage (cached values and the like) which it turns out can eat up a lot of memory, especially after some of the larger docs (like manifolds).  This is likewise difficult to manually clean up.

Even a reversion of #21389 wouldn't fully fix the issue though since there are other parts of the docbuild that call `runsphinx()` without calling it in a subprocess, and those are responsible for quite a bit of unnecessary memory leakage currently (even in parallel doc builds).  So I intend to fix that.

We can follow up on the docbuild discussion elsewhere though, since other than its impact on CI the details of that are orthogonal to this ticket.



---

archive/issue_comments_364412.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-25T12:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364412",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364413.json:
```json
{
    "body": "<a id='comment:1'></a>So, I think this is really ready for review again.\n\n---\nNew commits:",
    "created_at": "2018-04-25T12:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364413",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>So, I think this is really ready for review again.

---
New commits:



---

archive/issue_comments_364414.json:
```json
{
    "body": "<a id='comment:2'></a>The patchbot complains about \"print\" but that one is actually in an awk script and not in Python, so it's fine.",
    "created_at": "2018-04-27T14:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364414",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'></a>The patchbot complains about "print" but that one is actually in an awk script and not in Python, so it's fine.



---

archive/issue_comments_364415.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-27T14:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364415",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364416.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-27T14:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364416",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_364417.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-27T14:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364417",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364418.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2018-04-27T14:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364418",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_364419.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-27T14:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364419",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_364420.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-27T14:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364420",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364421.json:
```json
{
    "body": "<a id='comment:8'></a>LGTM.  Let's move forward.",
    "created_at": "2018-04-28T22:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364421",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>LGTM.  Let's move forward.



---

archive/issue_comments_364422.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-28T22:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364422",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364423.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-05-02T18:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364423",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_364424.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-05-02T18:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364424",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_364425.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-02T18:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364425",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364426.json:
```json
{
    "body": "<a id='comment:1'></a>erik: I pushed a minor cleanup. Please have a look :)",
    "created_at": "2018-05-02T19:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364426",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>erik: I pushed a minor cleanup. Please have a look :)



---

archive/issue_comments_364427.json:
```json
{
    "body": "<a id='comment:2'></a>Can you just squash the last commit into the previous one?",
    "created_at": "2018-05-02T19:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364427",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Can you just squash the last commit into the previous one?



---

archive/issue_comments_364428.json:
```json
{
    "body": "<a id='comment:3'></a>The problem is that I had already merged this into another branch. Let's see how unhappy git is about me squashing this.",
    "created_at": "2018-05-02T21:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364428",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>The problem is that I had already merged this into another branch. Let's see how unhappy git is about me squashing this.



---

archive/issue_comments_364429.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-02T21:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364429",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364430.json:
```json
{
    "body": "<a id='comment:5'></a>Ok. Seems to handle that fine by now.\n  \n---\nNew commits:",
    "created_at": "2018-05-02T21:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364430",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Ok. Seems to handle that fine by now.
  
---
New commits:



---

archive/issue_comments_364431.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-02T22:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364431",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_364432.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-03T18:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364432",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364433.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-04T15:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364433",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_364434.json:
```json
{
    "body": "<a id='comment:8'></a>Ok. Tested that everything works on [GitLab](GitLab) CI and CircleCI. The build (from scratch) on CircleCI barely finished a few minutes before it hits the time limit of five hours but I don't think there's much that I can do to speed things up. (I could try to seed a ccache with files from a previous but I have a feeling that to help with a build from scratch I need the ccache to be huge. I am not sure whether CircleCI lets me do that much network I/O and whether it would be fast enough.)",
    "created_at": "2018-05-04T15:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364434",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:8'></a>Ok. Tested that everything works on [GitLab](GitLab) CI and CircleCI. The build (from scratch) on CircleCI barely finished a few minutes before it hits the time limit of five hours but I don't think there's much that I can do to speed things up. (I could try to seed a ccache with files from a previous but I have a feeling that to help with a build from scratch I need the ccache to be huge. I am not sure whether CircleCI lets me do that much network I/O and whether it would be fast enough.)



---

archive/issue_comments_364435.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-04T15:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364435",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364436.json:
```json
{
    "body": "<a id='comment:0'></a>Perhaps at some point we could experiment with setting up [sccache](https://github.com/mozilla/sccache) for Sage",
    "created_at": "2018-05-07T14:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364436",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>Perhaps at some point we could experiment with setting up [sccache](https://github.com/mozilla/sccache) for Sage



---

archive/issue_comments_364437.json:
```json
{
    "body": "<a id='comment:1'></a>Interesting. I did not know sccache.\n\nSince we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.",
    "created_at": "2018-05-13T16:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364437",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>Interesting. I did not know sccache.

Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.



---

archive/issue_comments_364438.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-13T18:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364438",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364439.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-14T13:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364439",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_364440.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-14T13:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_062077.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-05-14T13:42:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24655#event-62077"
}
```



---

archive/issue_comments_364441.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2018-05-14T13:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364441",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_364442.json:
```json
{
    "body": "<a id='comment:6'></a>It looks like the Docker images for 8.2 haven't been built yet, or are you doing that now?  If not I will just build them from my existing scripts (that should have been done already...)",
    "created_at": "2018-05-14T16:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364442",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>It looks like the Docker images for 8.2 haven't been built yet, or are you doing that now?  If not I will just build them from my existing scripts (that should have been done already...)



---

archive/issue_comments_364443.json:
```json
{
    "body": "<a id='comment:7'></a>Great, the Docker build is failing now due to #23519.  This explains why my automated builds stopped working yet again (I hadn't had a chance to investigate).  Fortunately there's a workaround that I can apply easily enough...",
    "created_at": "2018-05-14T16:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364443",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Great, the Docker build is failing now due to #23519.  This explains why my automated builds stopped working yet again (I hadn't had a chance to investigate).  Fortunately there's a workaround that I can apply easily enough...



---

archive/issue_comments_364444.json:
```json
{
    "body": "<a id='comment:188'></a>Replying to [comment:181 saraedum]:\n> Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.\n\nI'm building both actually.",
    "created_at": "2018-05-15T06:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364444",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:188'></a>Replying to [comment:181 saraedum]:
> Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.

I'm building both actually.



---

archive/issue_comments_364445.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,67 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* 20 minutes for `build-from-latest:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/saraedum/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.\n+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.\n+* Increase the time limet on [GitLab](GitLab) (to 4 hours) or provide our own runners.\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-05-15T08:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364445",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,67 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* 20 minutes for `build-from-latest:
+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page (note that the badges on the actual page are currently broken because they refer to pages in the sagemath/ namespace that does not exist yet.) The current sizes are ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath.svg) and ![](https://img.shields.io/microbadger/image-size/saraedum/sagemath-dev.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/saraedum/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup repositories on Docker Hub for sagemath/sagemath, sagemath/sagemath-cli, sagemath/sagemath-dev to automatically build our github repository.
+* Setup sagemath/sagemath on [GitLab](GitLab) to mirror our github repository.
+* Increase the time limet on [GitLab](GitLab) (to 4 hours) or provide our own runners.
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/saraedum/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364446.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-15T08:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364446",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364447.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-15T08:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364447",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364448.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-15T08:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364448",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364449.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-15T08:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364449",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364450.json:
```json
{
    "body": "<a id='comment:194'></a>Replying to [comment:188 saraedum]:\n> Replying to [comment:181 saraedum]:\n> > Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.\n\n> I'm building both actually.\nI pushed both (they are much smaller than the one from the old setup, so I hope it's ok that I replaced yours.) gitlab is building 8.3.beta1 currently.",
    "created_at": "2018-05-15T09:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364450",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:194'></a>Replying to [comment:188 saraedum]:
> Replying to [comment:181 saraedum]:
> > Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.

> I'm building both actually.
I pushed both (they are much smaller than the one from the old setup, so I hope it's ok that I replaced yours.) gitlab is building 8.3.beta1 currently.



---

archive/issue_comments_364451.json:
```json
{
    "body": "<a id='comment:195'></a>Replying to [comment:194 saraedum]:\n> Replying to [comment:188 saraedum]:\n> > Replying to [comment:181 saraedum]:\n> > > Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.\n\n> > I'm building both actually.\n> I pushed both (they are much smaller than the one from the old setup, so I hope it's ok that I replaced yours.) gitlab is building 8.3.beta1 currently.\n\n\nI'm a little concerned about that.  Does that include the sagemath-jupyter image?  People are using that.",
    "created_at": "2018-05-15T10:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364451",
    "user": "https://github.com/embray"
}
```

<a id='comment:195'></a>Replying to [comment:194 saraedum]:
> Replying to [comment:188 saraedum]:
> > Replying to [comment:181 saraedum]:
> > > Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.

> > I'm building both actually.
> I pushed both (they are much smaller than the one from the old setup, so I hope it's ok that I replaced yours.) gitlab is building 8.3.beta1 currently.


I'm a little concerned about that.  Does that include the sagemath-jupyter image?  People are using that.



---

archive/issue_comments_364452.json:
```json
{
    "body": "<a id='comment:196'></a>Replying to [comment:195 embray]:\n> Replying to [comment:194 saraedum]:\n> > Replying to [comment:188 saraedum]:\n> > > Replying to [comment:181 saraedum]:\n> > > > Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.\n\n> > > I'm building both actually.\n> > I pushed both (they are much smaller than the one from the old setup, so I hope it's ok that I replaced yours.) gitlab is building 8.3.beta1 currently.\n\n> \n> I'm a little concerned about that.  Does that include the sagemath-jupyter image?  People are using that.\n\n\nThe sagemath/sagemath image does contain jupyter. I did not touch the sagemath-jupyter images but I'll create a README there to point people to the main repository.",
    "created_at": "2018-05-18T21:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364452",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:196'></a>Replying to [comment:195 embray]:
> Replying to [comment:194 saraedum]:
> > Replying to [comment:188 saraedum]:
> > > Replying to [comment:181 saraedum]:
> > > > Since we did not manage to get this into 8.2, I'll manually update our docker images to 8.2 and 8.3beta0.

> > > I'm building both actually.
> > I pushed both (they are much smaller than the one from the old setup, so I hope it's ok that I replaced yours.) gitlab is building 8.3.beta1 currently.

> 
> I'm a little concerned about that.  Does that include the sagemath-jupyter image?  People are using that.


The sagemath/sagemath image does contain jupyter. I did not touch the sagemath-jupyter images but I'll create a README there to point people to the main repository.



---

archive/issue_comments_364453.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-19T12:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364453",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364454.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-20T21:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364454",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364455.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-20T21:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364455",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_364456.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-20T21:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364456",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364457.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-20T22:34:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364457",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364458.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-21T00:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364458",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364459.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,64 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* 20 minutes for `build-from-latest:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/sagemath/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-05-21T12:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364459",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,64 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* 20 minutes for `build-from-latest:
+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/sagemath/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364460.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,64 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* 20 minutes for `build-from-latest:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-05-21T12:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364460",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,64 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* 20 minutes for `build-from-latest:
+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364461.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-21T14:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364461",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364462.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-22T20:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364462",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364463.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,64 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* 20 minutes for `build-from-latest:\n+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg)\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-05-23T11:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364463",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,64 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's nice to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as test runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with four threads, it takes about 3 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18022699>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 35 minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* 20 minutes for `build-from-latest:
+  * 6 minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * 5 minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* 2 - 12 minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* 5 minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about 4 hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/195>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about 25 minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/sage/203>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg)
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on  Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364464.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-24T22:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364465.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-28T12:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364466.json:
```json
{
    "body": "<a id='comment:2'></a>I created the 8.2 and 8.3.beta* releases with this and it seems to work fine at the moment.",
    "created_at": "2018-05-30T15:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364466",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'></a>I created the 8.2 and 8.3.beta* releases with this and it seems to work fine at the moment.



---

archive/issue_comments_364467.json:
```json
{
    "body": "<a id='comment:3'></a>So where are we at with this now?  I've seen there's been a lot of continued activity from you on the ticket but I haven't followed what it was all about.  Just minor fixes or anything major to know?",
    "created_at": "2018-05-31T12:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364467",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>So where are we at with this now?  I've seen there's been a lot of continued activity from you on the ticket but I haven't followed what it was all about.  Just minor fixes or anything major to know?



---

archive/issue_comments_364468.json:
```json
{
    "body": "<a id='comment:4'></a>There's nothing really major that has changed. The CircleCI setup looks a bit different now but on the inside its mostly the same. Here's a changelog of sorts since you gave it positive_review last:\n\n* I had set SAGE_NUM_THREADS/MAKEOPTS from the host that ran the `docker build` commands not from inside the actual docker containers; the specs of these two machines are sometimes very different on CircleCI. That's fixed now.\n* I worked around some docker build bug related to caching and multi-stage builds. I don't really understand what's the problem there but it works now.\n* Most of the changes are to make builds for git tags work on CircleCI.\n* I started using these images for actual Sage development and found some minor issues in the git setup inside the sagemath-dev image.\n* I fixed the pip/openssl issue.\n\nSo\u2026does it work? It works fine for building from scratch. I've done that for 8.2 and all the betas since then. It also worked for building on top of the latest beta but I have not tested that in all the possible combinations (say, changing SPKGs and things like that) this time. As nobody knows about that latter feature yet, nobody is going to be upset if it doesn't work ;) I certainly want to use this heavily so I'll fix problems right away.",
    "created_at": "2018-05-31T12:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364468",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>There's nothing really major that has changed. The CircleCI setup looks a bit different now but on the inside its mostly the same. Here's a changelog of sorts since you gave it positive_review last:

* I had set SAGE_NUM_THREADS/MAKEOPTS from the host that ran the `docker build` commands not from inside the actual docker containers; the specs of these two machines are sometimes very different on CircleCI. That's fixed now.
* I worked around some docker build bug related to caching and multi-stage builds. I don't really understand what's the problem there but it works now.
* Most of the changes are to make builds for git tags work on CircleCI.
* I started using these images for actual Sage development and found some minor issues in the git setup inside the sagemath-dev image.
* I fixed the pip/openssl issue.

So…does it work? It works fine for building from scratch. I've done that for 8.2 and all the betas since then. It also worked for building on top of the latest beta but I have not tested that in all the possible combinations (say, changing SPKGs and things like that) this time. As nobody knows about that latter feature yet, nobody is going to be upset if it doesn't work ;) I certainly want to use this heavily so I'll fix problems right away.



---

archive/issue_comments_364469.json:
```json
{
    "body": "<a id='comment:5'></a>Let me check if I changed anything since your last review that is not exclusively docker related\u2026",
    "created_at": "2018-05-31T12:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364469",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Let me check if I changed anything since your last review that is not exclusively docker related…



---

archive/issue_comments_364470.json:
```json
{
    "body": "<a id='comment:6'></a>This has changed since you reviewed it last, so nothing \"dangerous\" I'd say:\n\n```\n .ci/build-docker.sh           |  26 +++++++++++---------------\n .ci/describe-system.sh        |  14 ++++++--------\n .ci/setup-make-parallelity.sh |  66 ++++++++++++++++++++++--------------------------------------------\n .ci/test-dev.sh               |   4 ++--\n .ci/test-jupyter.sh           |   5 +++--\n .ci/update-env.sh             |   6 +-----\n .circleci/before-script.sh    |  26 --------------------------\n .circleci/config.yml          | 100 +++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------\n .gitlab-ci.yml                |  19 ++++++++++++-------\n docker/Dockerfile             |  83 ++++++++++++++++++++++++++++++++++++-----------------------------------------------\n docker/README.md              |   7 +++----\n 11 files changed, 135 insertions(+), 221 deletions(-)\n```",
    "created_at": "2018-05-31T12:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364470",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>This has changed since you reviewed it last, so nothing "dangerous" I'd say:

```
 .ci/build-docker.sh           |  26 +++++++++++---------------
 .ci/describe-system.sh        |  14 ++++++--------
 .ci/setup-make-parallelity.sh |  66 ++++++++++++++++++++++--------------------------------------------
 .ci/test-dev.sh               |   4 ++--
 .ci/test-jupyter.sh           |   5 +++--
 .ci/update-env.sh             |   6 +-----
 .circleci/before-script.sh    |  26 --------------------------
 .circleci/config.yml          | 100 +++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------
 .gitlab-ci.yml                |  19 ++++++++++++-------
 docker/Dockerfile             |  83 ++++++++++++++++++++++++++++++++++++-----------------------------------------------
 docker/README.md              |   7 +++----
 11 files changed, 135 insertions(+), 221 deletions(-)
```



---

archive/issue_comments_364471.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks for the summary.  \n\nThough the amount of minor tweaks this has continued to need seems to confirm my feeling that there should really be a way to get these changes into `develop` faster, somehow, or use a branch other than `develop` for CI purposes (but that is regularly reset to the latest `develop` as soon as any necessary changes are merged into `develop`...)  I don't know if you have any ideas about that.\n\nLike, what if CircleCI, or [GitLab](GitLab) changes something, or Docker changes something that has to be worked around (something that has happened to me plenty of times already)?  We don't want to have all CI break until the next beta in `develop`...",
    "created_at": "2018-05-31T14:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364471",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Thanks for the summary.  

Though the amount of minor tweaks this has continued to need seems to confirm my feeling that there should really be a way to get these changes into `develop` faster, somehow, or use a branch other than `develop` for CI purposes (but that is regularly reset to the latest `develop` as soon as any necessary changes are merged into `develop`...)  I don't know if you have any ideas about that.

Like, what if CircleCI, or [GitLab](GitLab) changes something, or Docker changes something that has to be worked around (something that has happened to me plenty of times already)?  We don't want to have all CI break until the next beta in `develop`...



---

archive/issue_comments_364472.json:
```json
{
    "body": "<a id='comment:218'></a>Replying to [comment:217 embray]:\n> Thanks for the summary.  \n> \n> Though the amount of minor tweaks this has continued to need seems to confirm my feeling that there should really be a way to get these changes into `develop` faster, somehow, or use a branch other than `develop` for CI purposes (but that is regularly reset to the latest `develop` as soon as any necessary changes are merged into `develop`...)  I don't know if you have any ideas about that.\n> \n> Like, what if CircleCI, or [GitLab](GitLab) changes something, or Docker changes something that has to be worked around (something that has happened to me plenty of times already)?  We don't want to have all CI break until the next beta in `develop`...\n\n\nI see your point but I don't have a good answer. As long as nobody is relying on this, we can just stop the builds on CircleCI/GitLab until the fix is in develop. Then it is going to work again once people merge in the latest develop. That's not great, sure.\n\nI think this whole problem is a bit similar to the `git trac` issue that we had when we migrated to `git`. We decided to put the predecessor of the `git trac` command into the sage repository which was a bad idea as it wasn't stable and when you went back to an old branch you got the old broken tooling.  Now that `git trac` is stable and hardly ever changes we could put it back into the main repository (I am not proposing that, just saying.) So the hope here could be that once people start to use this actively, the main problems have been sorted out already.\n\nThe fundamental problem is that I don't see how to take this out of the repository in any way that is even remotely supported by the CIs that we are planning to use. conda-forge has the tooling (conda-smithy) outside of the individual repositories but you have to say \"`@`conda-forge-admin please rerender\" all the time to make the tooling upgrade itself in your pull request. It's annoying, it would mean that we would need a trac bot to do this rerendering of the CI related files, and it makes the diffs hard to read as they are filled with CI related changes all the time.\n\nThe other option would be to only have a minimal hook call in the repository and then have that trigger actual pipelines somewhere else on that commit and report back through bots. It's a lot of work and I don't think we would want to maintain that kind of infrastructure.\n\nLong story short. I fear we have to use the CIs the way they're intended to be used.\n\nThe other issue that you're sort of raising for me is whether develop should be pushed to more frequently. I would love to see a marge-bot or something similar that merges in things automatically; but this goes beyond the focus of this ticket I think.",
    "created_at": "2018-05-31T22:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364472",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:218'></a>Replying to [comment:217 embray]:
> Thanks for the summary.  
> 
> Though the amount of minor tweaks this has continued to need seems to confirm my feeling that there should really be a way to get these changes into `develop` faster, somehow, or use a branch other than `develop` for CI purposes (but that is regularly reset to the latest `develop` as soon as any necessary changes are merged into `develop`...)  I don't know if you have any ideas about that.
> 
> Like, what if CircleCI, or [GitLab](GitLab) changes something, or Docker changes something that has to be worked around (something that has happened to me plenty of times already)?  We don't want to have all CI break until the next beta in `develop`...


I see your point but I don't have a good answer. As long as nobody is relying on this, we can just stop the builds on CircleCI/GitLab until the fix is in develop. Then it is going to work again once people merge in the latest develop. That's not great, sure.

I think this whole problem is a bit similar to the `git trac` issue that we had when we migrated to `git`. We decided to put the predecessor of the `git trac` command into the sage repository which was a bad idea as it wasn't stable and when you went back to an old branch you got the old broken tooling.  Now that `git trac` is stable and hardly ever changes we could put it back into the main repository (I am not proposing that, just saying.) So the hope here could be that once people start to use this actively, the main problems have been sorted out already.

The fundamental problem is that I don't see how to take this out of the repository in any way that is even remotely supported by the CIs that we are planning to use. conda-forge has the tooling (conda-smithy) outside of the individual repositories but you have to say "`@`conda-forge-admin please rerender" all the time to make the tooling upgrade itself in your pull request. It's annoying, it would mean that we would need a trac bot to do this rerendering of the CI related files, and it makes the diffs hard to read as they are filled with CI related changes all the time.

The other option would be to only have a minimal hook call in the repository and then have that trigger actual pipelines somewhere else on that commit and report back through bots. It's a lot of work and I don't think we would want to maintain that kind of infrastructure.

Long story short. I fear we have to use the CIs the way they're intended to be used.

The other issue that you're sort of raising for me is whether develop should be pushed to more frequently. I would love to see a marge-bot or something similar that merges in things automatically; but this goes beyond the focus of this ticket I think.



---

archive/issue_comments_364473.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-01T00:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364473",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364474.json:
```json
{
    "body": "<a id='comment:0'></a>Hm\u2026we could run a script that is contained in an environment variable. That way we could inject whatever behaviour into every CI run from the outside, e.g., to display a warning that something is broken at the moment and instructions on how to work around.",
    "created_at": "2018-06-01T13:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364474",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:0'></a>Hm…we could run a script that is contained in an environment variable. That way we could inject whatever behaviour into every CI run from the outside, e.g., to display a warning that something is broken at the moment and instructions on how to work around.



---

archive/issue_comments_364475.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-01T14:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364475",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364476.json:
```json
{
    "body": "<a id='comment:2'></a>What about something like this (last commit). I have not tested it yet but do you think that's a good idea?",
    "created_at": "2018-06-01T14:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364476",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'></a>What about something like this (last commit). I have not tested it yet but do you think that's a good idea?



---

archive/issue_comments_364477.json:
```json
{
    "body": "<a id='comment:3'></a>> I see your point but I don't have a good answer. As long as nobody is relying on this, we can just stop the builds on CircleCI/GitLab until the fix is in develop. Then it is going to work again once people merge in the latest develop. That's not great, sure.\n\n\n\"as long as nobody is relying on this\" yeah, but we want them to rely on it; perhaps even exclusively long term :)\n\nFortunately, I think once this is in more use it will also force, or at least encourage a change in Sage's development process to be more like a \"normal\" project.",
    "created_at": "2018-06-01T21:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364477",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>> I see your point but I don't have a good answer. As long as nobody is relying on this, we can just stop the builds on CircleCI/GitLab until the fix is in develop. Then it is going to work again once people merge in the latest develop. That's not great, sure.


"as long as nobody is relying on this" yeah, but we want them to rely on it; perhaps even exclusively long term :)

Fortunately, I think once this is in more use it will also force, or at least encourage a change in Sage's development process to be more like a "normal" project.



---

archive/issue_comments_364478.json:
```json
{
    "body": "<a id='comment:224'></a>Replying to [comment:222 saraedum]:\n> What about something like this (last commit). I have not tested it yet but do you think that's a good idea?\n\n\nDefinitely makes me uh, a bit nervous but okay :)  It could be useful to have and is at least better than nothing as a short-term solution to this problem (if it even does become more than a hypothetical problem).",
    "created_at": "2018-06-01T21:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364478",
    "user": "https://github.com/embray"
}
```

<a id='comment:224'></a>Replying to [comment:222 saraedum]:
> What about something like this (last commit). I have not tested it yet but do you think that's a good idea?


Definitely makes me uh, a bit nervous but okay :)  It could be useful to have and is at least better than nothing as a short-term solution to this problem (if it even does become more than a hypothetical problem).



---

archive/issue_comments_364479.json:
```json
{
    "body": "<a id='comment:5'></a>I am not sure this is the right location to report on this. Maybe the README about our Docker image on dockerhub should contain some information on where to report issues?\n\nAnyway, I am having trouble with using binder with the docker image for [SageMath](SageMath) 8.2 as currently posted on dockerhub compared to that for 8.1.\n\nNamely, when binder launches Jupyter, its working directory is `/home/sage/sage`, instead of `/home/sage` as before. This means in particular that all the notebooks and files that are copied over from the github repository with the usual `COPY . ${HOME}` are not accessible anymore.\n\nShould WORK_DIR be reset to ${HOME} at the end of the Dockerfile?",
    "created_at": "2018-06-04T16:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364479",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:5'></a>I am not sure this is the right location to report on this. Maybe the README about our Docker image on dockerhub should contain some information on where to report issues?

Anyway, I am having trouble with using binder with the docker image for [SageMath](SageMath) 8.2 as currently posted on dockerhub compared to that for 8.1.

Namely, when binder launches Jupyter, its working directory is `/home/sage/sage`, instead of `/home/sage` as before. This means in particular that all the notebooks and files that are copied over from the github repository with the usual `COPY . ${HOME}` are not accessible anymore.

Should WORK_DIR be reset to ${HOME} at the end of the Dockerfile?



---

archive/issue_comments_364480.json:
```json
{
    "body": "<a id='comment:6'></a>nthiery: You are right, we should mention that bugs should be reported on trac as usual. I am not sure whether `COPY . ${HOME}` is the usual thing. I usually do `COPY --chown=sage:sage . .`. I don't know, should we reset WORKDIR to HOME? Or should it be the place where Sage is installed. Let's reset it to HOME, so we don't break scripts that used to work with the 8.1 image. (This breaks compatibility with 8.2 images but anyway\u2026)",
    "created_at": "2018-06-05T10:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364480",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>nthiery: You are right, we should mention that bugs should be reported on trac as usual. I am not sure whether `COPY . ${HOME}` is the usual thing. I usually do `COPY --chown=sage:sage . .`. I don't know, should we reset WORKDIR to HOME? Or should it be the place where Sage is installed. Let's reset it to HOME, so we don't break scripts that used to work with the 8.1 image. (This breaks compatibility with 8.2 images but anyway…)



---

archive/issue_comments_364481.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-05T10:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364481",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364482.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-05T10:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364482",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364483.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-05T10:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364483",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364484.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-05T10:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364485.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-05T10:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364485",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364486.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-05T10:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364486",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364487.json:
```json
{
    "body": "<a id='comment:3'></a>I pushed a new 8.2 image with the WORKDIR set to `/home/sage`. Both `sage` and `sage-jupyter` still work, so I hope that this doesn't break anything.\n\n---\nNew commits:",
    "created_at": "2018-06-05T11:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364487",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>I pushed a new 8.2 image with the WORKDIR set to `/home/sage`. Both `sage` and `sage-jupyter` still work, so I hope that this doesn't break anything.

---
New commits:



---

archive/issue_comments_364488.json:
```json
{
    "body": "<a id='comment:4'></a>embray: The monkey patching seems to work. So this needs review again.",
    "created_at": "2018-06-05T11:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364488",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>embray: The monkey patching seems to work. So this needs review again.



---

archive/issue_comments_364489.json:
```json
{
    "body": "<a id='comment:235'></a>Replying to [comment:233 saraedum]:\n> I pushed a new 8.2 image with the WORKDIR set to `/home/sage`. Both `sage` and `sage-jupyter` still work, so I hope that this doesn't break anything.\n\n\nThanks!\n\nI have a problem though: since binder already downloaded an image with tag 8.2, it won't redownload the new version. Is there a way to add an alias tag such as 8.2-1 ?\n\nThanks!",
    "created_at": "2018-06-05T13:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364489",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:235'></a>Replying to [comment:233 saraedum]:
> I pushed a new 8.2 image with the WORKDIR set to `/home/sage`. Both `sage` and `sage-jupyter` still work, so I hope that this doesn't break anything.


Thanks!

I have a problem though: since binder already downloaded an image with tag 8.2, it won't redownload the new version. Is there a way to add an alias tag such as 8.2-1 ?

Thanks!



---

archive/issue_comments_364490.json:
```json
{
    "body": "<a id='comment:236'></a>Replying to [comment:226 saraedum]:\n> nthiery: You are right, we should mention that bugs should be reported on trac as usual. I am not sure whether `COPY . ${HOME}` is the usual thing. I usually do `COPY --chown=sage:sage . .`.\n\n\nIIRC, the binder doc suggests `COPY . ${HOME}`; in [sage-binder-env](https://github.com/sagemath/sage-binder-env/), I am indeed adding `--chown=sage:sage`.\n\n> I don't know, should we reset WORKDIR to HOME? Or should it be the place where Sage is installed. Let's reset it to HOME, so we don't break scripts that used to work with the 8.1 image. (This breaks compatibility with 8.2 images but anyway\u2026)\n\n\nI would tend to see the location of the sage install (and in general which ever software is installed) as an implementation detail; but this may be a bias from my use cases of the image!",
    "created_at": "2018-06-05T13:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364490",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:236'></a>Replying to [comment:226 saraedum]:
> nthiery: You are right, we should mention that bugs should be reported on trac as usual. I am not sure whether `COPY . ${HOME}` is the usual thing. I usually do `COPY --chown=sage:sage . .`.


IIRC, the binder doc suggests `COPY . ${HOME}`; in [sage-binder-env](https://github.com/sagemath/sage-binder-env/), I am indeed adding `--chown=sage:sage`.

> I don't know, should we reset WORKDIR to HOME? Or should it be the place where Sage is installed. Let's reset it to HOME, so we don't break scripts that used to work with the 8.1 image. (This breaks compatibility with 8.2 images but anyway…)


I would tend to see the location of the sage install (and in general which ever software is installed) as an implementation detail; but this may be a bias from my use cases of the image!



---

archive/issue_comments_364491.json:
```json
{
    "body": "<a id='comment:237'></a>Replying to [comment:235 nthiery]:\n> Replying to [comment:233 saraedum]:\n> > I pushed a new 8.2 image with the WORKDIR set to `/home/sage`. Both `sage` and `sage-jupyter` still work, so I hope that this doesn't break anything.\n\n> \n> Thanks!\n> \n> I have a problem though: since binder already downloaded an image with tag 8.2, it won't redownload the new version. Is there a way to add an alias tag such as 8.2-1 ?\n\nStrange, I had been curious about this a while back and had tried whether binder would check for image upgrades and it actually did. Have you changed something in the repository? I think you need to make some change so it rebuilds your Dockerfile. If it rebuilds it should pull the latest version. Anyway, to work around your specific problem, you could also just use `latest` instead of `8.2` which is the latest released stable version.",
    "created_at": "2018-06-07T07:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364491",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:237'></a>Replying to [comment:235 nthiery]:
> Replying to [comment:233 saraedum]:
> > I pushed a new 8.2 image with the WORKDIR set to `/home/sage`. Both `sage` and `sage-jupyter` still work, so I hope that this doesn't break anything.

> 
> Thanks!
> 
> I have a problem though: since binder already downloaded an image with tag 8.2, it won't redownload the new version. Is there a way to add an alias tag such as 8.2-1 ?

Strange, I had been curious about this a while back and had tried whether binder would check for image upgrades and it actually did. Have you changed something in the repository? I think you need to make some change so it rebuilds your Dockerfile. If it rebuilds it should pull the latest version. Anyway, to work around your specific problem, you could also just use `latest` instead of `8.2` which is the latest released stable version.



---

archive/issue_comments_364492.json:
```json
{
    "body": "<a id='comment:8'></a>Alas, tried again, and it did not work. Also binder explicitly forbids  using \"latest\". No luck!",
    "created_at": "2018-06-07T14:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364492",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:8'></a>Alas, tried again, and it did not work. Also binder explicitly forbids  using "latest". No luck!



---

archive/issue_comments_364493.json:
```json
{
    "body": "<a id='comment:9'></a>Just tried, putting a hash into the Dockerfile worked for me `FROM sagemath/sagemath`@`sha256:e933509b105f36b9b7de892af847ade7753e058c5d9e0c0f280f591b85ad996d`",
    "created_at": "2018-06-09T10:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364493",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:9'></a>Just tried, putting a hash into the Dockerfile worked for me `FROM sagemath/sagemath`@`sha256:e933509b105f36b9b7de892af847ade7753e058c5d9e0c0f280f591b85ad996d`



---

archive/issue_comments_364494.json:
```json
{
    "body": "<a id='comment:0'></a>Ah yes, good point. Thanks for the tip, that worked!",
    "created_at": "2018-06-10T07:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364494",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:0'></a>Ah yes, good point. Thanks for the tip, that worked!



---

archive/issue_comments_364495.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-11T06:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364495",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364496.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-19T12:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364496",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364497.json:
```json
{
    "body": "<a id='comment:243'></a>Replying to [comment:234 saraedum]:\n> embray: The monkey patching seems to work. So this needs review again.\n\n\nWait, what monkey patching?  I've been AFK for 2 weeks so I'm not sure what you're referring to anymore :)",
    "created_at": "2018-06-20T08:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364497",
    "user": "https://github.com/embray"
}
```

<a id='comment:243'></a>Replying to [comment:234 saraedum]:
> embray: The monkey patching seems to work. So this needs review again.


Wait, what monkey patching?  I've been AFK for 2 weeks so I'm not sure what you're referring to anymore :)



---

archive/issue_comments_364498.json:
```json
{
    "body": "<a id='comment:244'></a>Replying to [comment:243 embray]:\n> Replying to [comment:234 saraedum]:\n> > embray: The monkey patching seems to work. So this needs review again.\n\n> \n> Wait, what monkey patching?  I've been AFK for 2 weeks so I'm not sure what you're referring to anymore :)\n\n\nI was refering to the injection of a bash script into the CI run through environment variables with that. Sorry the term is probably not appropriate here.",
    "created_at": "2018-06-20T18:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364498",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:244'></a>Replying to [comment:243 embray]:
> Replying to [comment:234 saraedum]:
> > embray: The monkey patching seems to work. So this needs review again.

> 
> Wait, what monkey patching?  I've been AFK for 2 weeks so I'm not sure what you're referring to anymore :)


I was refering to the injection of a bash script into the CI run through environment variables with that. Sorry the term is probably not appropriate here.



---

archive/issue_comments_364499.json:
```json
{
    "body": "<a id='comment:5'></a>Ah right, that.  Well, I've never *seen* \"monkey-patch\" used that way before, nor have I even seen that trick used before, but I suppose \"monkey-patch\" isn't a bad term for it :)",
    "created_at": "2018-06-22T14:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364499",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Ah right, that.  Well, I've never *seen* "monkey-patch" used that way before, nor have I even seen that trick used before, but I suppose "monkey-patch" isn't a bad term for it :)



---

archive/issue_comments_364500.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-26T09:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364500",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364501.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-03T11:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364501",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364502.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-04T15:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364502",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364503.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-04T15:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364503",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364504.json:
```json
{
    "body": "<a id='comment:0'></a>How is this coming along?  Should I review this again and/or set positive review?\n\nI have the gitlab/trac bot more or less ready to start work too.",
    "created_at": "2018-07-04T16:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364504",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>How is this coming along?  Should I review this again and/or set positive review?

I have the gitlab/trac bot more or less ready to start work too.



---

archive/issue_comments_364505.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-05T15:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364505",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364506.json:
```json
{
    "body": "<a id='comment:2'></a>Yes, this is definitely ready for review. If you are happy with it, I would run a full set of tests before we really set it to positive review. But I am using this all the time myself and it seems to be sufficiently stable to be useful.",
    "created_at": "2018-07-05T15:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364506",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'></a>Yes, this is definitely ready for review. If you are happy with it, I would run a full set of tests before we really set it to positive review. But I am using this all the time myself and it seems to be sufficiently stable to be useful.



---

archive/issue_comments_364507.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-05T15:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364507",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364508.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-05T15:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364508",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364509.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-09T04:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364509",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364510.json:
```json
{
    "body": "<a id='comment:6'></a>What's the status of the Circle-CI builds?  Looking at https://circleci.com/gh/saraedum/sage it hasn't updated in a month and the last 2 builds were failures.",
    "created_at": "2018-07-10T12:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364510",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>What's the status of the Circle-CI builds?  Looking at https://circleci.com/gh/saraedum/sage it hasn't updated in a month and the last 2 builds were failures.



---

archive/issue_comments_364511.json:
```json
{
    "body": "<a id='comment:7'></a>Also, what's up with the latest 3 builds on https://gitlab.com/saraedum/sage/pipelines ?  It just says they got stuck/timed out, but with no log to show for it.",
    "created_at": "2018-07-10T12:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364511",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Also, what's up with the latest 3 builds on https://gitlab.com/saraedum/sage/pipelines ?  It just says they got stuck/timed out, but with no log to show for it.



---

archive/issue_comments_364512.json:
```json
{
    "body": "<a id='comment:258'></a>Replying to [comment:256 embray]:\n> What's the status of the Circle-CI builds?  Looking at https://circleci.com/gh/saraedum/sage it hasn't updated in a month and the last 2 builds were failures.\n\n\nThe builds failed because \"build-from-clean\" does not work anymore (Sage takes too much time now to build.) I have not tried the build-from-latest for a bit. If everything else looks good to you I would run a test of every scenario that I can think of, including these CircleCI builds.",
    "created_at": "2018-07-10T12:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364512",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:258'></a>Replying to [comment:256 embray]:
> What's the status of the Circle-CI builds?  Looking at https://circleci.com/gh/saraedum/sage it hasn't updated in a month and the last 2 builds were failures.


The builds failed because "build-from-clean" does not work anymore (Sage takes too much time now to build.) I have not tried the build-from-latest for a bit. If everything else looks good to you I would run a test of every scenario that I can think of, including these CircleCI builds.



---

archive/issue_comments_364513.json:
```json
{
    "body": "<a id='comment:259'></a>Replying to [comment:257 embray]:\n> Also, what's up with the latest 3 builds on https://gitlab.com/saraedum/sage/pipelines ?  It just says they got stuck/timed out, but with no log to show for it.\n\n\nThe runners are currently down because the credit card linked to the google cloud account expired. The owner is working on fixing that. The build-from-clean only works with non-shared runners because Sage takes too long to build. The build-from-latest still works with shared runners.",
    "created_at": "2018-07-10T12:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364513",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:259'></a>Replying to [comment:257 embray]:
> Also, what's up with the latest 3 builds on https://gitlab.com/saraedum/sage/pipelines ?  It just says they got stuck/timed out, but with no log to show for it.


The runners are currently down because the credit card linked to the google cloud account expired. The owner is working on fixing that. The build-from-clean only works with non-shared runners because Sage takes too long to build. The build-from-latest still works with shared runners.



---

archive/issue_comments_364514.json:
```json
{
    "body": "<a id='comment:0'></a>I wish there was some way to see exactly which runner a pipeline ran on.  I can't find anything to that effect, but you'd think one would want to know, especially if there were failures (especially since some failures can depend on the runner).",
    "created_at": "2018-07-10T13:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364514",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>I wish there was some way to see exactly which runner a pipeline ran on.  I can't find anything to that effect, but you'd think one would want to know, especially if there were failures (especially since some failures can depend on the runner).



---

archive/issue_comments_364515.json:
```json
{
    "body": "<a id='comment:261'></a>Replying to [comment:260 embray]:\n> I wish there was some way to see exactly which runner a pipeline ran on.  I can't find anything to that effect, but you'd think one would want to know, especially if there were failures (especially since some failures can depend on the runner).\n\n\n\nThe first line  of the log says which runner it ran on exactly. I also print the specs of the runner in the logs.",
    "created_at": "2018-07-10T13:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364515",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:261'></a>Replying to [comment:260 embray]:
> I wish there was some way to see exactly which runner a pipeline ran on.  I can't find anything to that effect, but you'd think one would want to know, especially if there were failures (especially since some failures can depend on the runner).



The first line  of the log says which runner it ran on exactly. I also print the specs of the runner in the logs.



---

archive/issue_comments_364516.json:
```json
{
    "body": "<a id='comment:2'></a>Right, I see that now, and it works fine on successful builds.  It's just odd that there's no output for the recent failures.  Is that just because it can't even contact the runner?",
    "created_at": "2018-07-10T13:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364516",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Right, I see that now, and it works fine on successful builds.  It's just odd that there's no output for the recent failures.  Is that just because it can't even contact the runner?



---

archive/issue_comments_364517.json:
```json
{
    "body": "<a id='comment:3'></a>Yes, here's an example where build-from-clean failed but still provided the runner info: https://gitlab.com/saraedum/sage/-/jobs/79424547\n\nIs slelievre providing this runner?",
    "created_at": "2018-07-10T13:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364517",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>Yes, here's an example where build-from-clean failed but still provided the runner info: https://gitlab.com/saraedum/sage/-/jobs/79424547

Is slelievre providing this runner?



---

archive/issue_comments_364518.json:
```json
{
    "body": "<a id='comment:4'></a>Instead of having `build-from-clean` rely on runners tagged \"do\" (which I understand stands for Digital Ocean, though out of context I just read it as the word \"do\"), maybe let's have a tag like \"big\" or \"fat\" indicating \"big enough to build sage from scratch\", since in principle such a runner could be hosted anywhere (in fact I will probably set one up on our [OpenStack](OpenStack) infrastructure ASAP).",
    "created_at": "2018-07-10T13:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364518",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Instead of having `build-from-clean` rely on runners tagged "do" (which I understand stands for Digital Ocean, though out of context I just read it as the word "do"), maybe let's have a tag like "big" or "fat" indicating "big enough to build sage from scratch", since in principle such a runner could be hosted anywhere (in fact I will probably set one up on our [OpenStack](OpenStack) infrastructure ASAP).



---

archive/issue_comments_364519.json:
```json
{
    "body": "<a id='comment:265'></a>Replying to [comment:264 embray]:\n> Instead of having `build-from-clean` rely on runners tagged \"do\" (which I understand stands for Digital Ocean, though out of context I just read it as the word \"do\"), maybe let's have a tag like \"big\" or \"fat\" indicating \"big enough to build sage from scratch\", since in principle such a runner could be hosted anywhere (in fact I will probably set one up on our [OpenStack](OpenStack) infrastructure ASAP).\n\n\nAmusingly, moments after I posted this, said [OpenStack](OpenStack) infrastructure where I am currently working on multiple VMs, went down completely.  As if their internet uplink was killed or something.  Completely unreachable.",
    "created_at": "2018-07-10T13:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364519",
    "user": "https://github.com/embray"
}
```

<a id='comment:265'></a>Replying to [comment:264 embray]:
> Instead of having `build-from-clean` rely on runners tagged "do" (which I understand stands for Digital Ocean, though out of context I just read it as the word "do"), maybe let's have a tag like "big" or "fat" indicating "big enough to build sage from scratch", since in principle such a runner could be hosted anywhere (in fact I will probably set one up on our [OpenStack](OpenStack) infrastructure ASAP).


Amusingly, moments after I posted this, said [OpenStack](OpenStack) infrastructure where I am currently working on multiple VMs, went down completely.  As if their internet uplink was killed or something.  Completely unreachable.



---

archive/issue_comments_364520.json:
```json
{
    "body": "<a id='comment:6'></a>I think you're right. The original idea was that \"build-from-clean\" worked for the free shared runners provided by gitlab.com that were tagged as \"do\". This is not reliably the case anymore so we should change that tag.",
    "created_at": "2018-07-10T16:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364520",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>I think you're right. The original idea was that "build-from-clean" worked for the free shared runners provided by gitlab.com that were tagged as "do". This is not reliably the case anymore so we should change that tag.



---

archive/issue_comments_364521.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-11T04:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364521",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364522.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-11T08:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364522",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364523.json:
```json
{
    "body": "<a id='comment:0'></a>embray: I am not sure how we want to do the review on this one. I could do full tests of all the relevant scenarios today and tomorrow. The problem is: If during your review you find things that you want to see changed, then I have to go through the whole testing process again.\n\nThe alternative is: You review the current state, and I do the full test just before we set this to positive review.\n\nThe first option is more straightforward probably. But it only works if you think that there ane not going to be relevant changes necessary. (I am not sure how familiar you are with the current state of this ticket.)",
    "created_at": "2018-07-11T09:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364523",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:0'></a>embray: I am not sure how we want to do the review on this one. I could do full tests of all the relevant scenarios today and tomorrow. The problem is: If during your review you find things that you want to see changed, then I have to go through the whole testing process again.

The alternative is: You review the current state, and I do the full test just before we set this to positive review.

The first option is more straightforward probably. But it only works if you think that there ane not going to be relevant changes necessary. (I am not sure how familiar you are with the current state of this ticket.)



---

archive/issue_comments_364524.json:
```json
{
    "body": "<a id='comment:271'></a>Replying to [comment:263 embray]:\n> Yes, here's an example where build-from-clean failed but still provided the runner info: https://gitlab.com/saraedum/sage/-/jobs/79424547\n> \n> Is slelievre providing this runner?  \n\nYes, the one he's running say \"slelievre\" in the first line. Mine say \"jrueth\".",
    "created_at": "2018-07-11T09:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364524",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:271'></a>Replying to [comment:263 embray]:
> Yes, here's an example where build-from-clean failed but still provided the runner info: https://gitlab.com/saraedum/sage/-/jobs/79424547
> 
> Is slelievre providing this runner?  

Yes, the one he's running say "slelievre" in the first line. Mine say "jrueth".



---

archive/issue_comments_364525.json:
```json
{
    "body": "<a id='comment:272'></a>Replying to [comment:270 saraedum]:\n> embray: I am not sure how we want to do the review on this one. I could do full tests of all the relevant scenarios today and tomorrow. The problem is: If during your review you find things that you want to see changed, then I have to go through the whole testing process again.\n> \n> The alternative is: You review the current state, and I do the full test just before we set this to positive review.\n> \n> The first option is more straightforward probably. But it only works if you think that there ane not going to be relevant changes necessary. (I am not sure how familiar you are with the current state of this ticket.)\n\n\nI'm mostly caught up on it--it is a *lot* though.  As far as I'm concerned it's \"positive review\".  While I believe there are still areas we'll want to improve a lot of it comes down to computing resources (and other related issues like continuing to improve the resource usage of the doc build, for which I have ideas but haven't had a chance to try them yet).\n\nOtherwise I believe you that it works, and I'd like to be able to start using it right away, so it's a provisional Positive Review from me.  My only remaining question is: Do we want to go ahead now and bring this work up on sage-devel and ask others to weight in?  Or would that be too disruptive overall?  (If nothing else we'll need to get Volker to at least agree to merge it.)",
    "created_at": "2018-07-11T10:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364525",
    "user": "https://github.com/embray"
}
```

<a id='comment:272'></a>Replying to [comment:270 saraedum]:
> embray: I am not sure how we want to do the review on this one. I could do full tests of all the relevant scenarios today and tomorrow. The problem is: If during your review you find things that you want to see changed, then I have to go through the whole testing process again.
> 
> The alternative is: You review the current state, and I do the full test just before we set this to positive review.
> 
> The first option is more straightforward probably. But it only works if you think that there ane not going to be relevant changes necessary. (I am not sure how familiar you are with the current state of this ticket.)


I'm mostly caught up on it--it is a *lot* though.  As far as I'm concerned it's "positive review".  While I believe there are still areas we'll want to improve a lot of it comes down to computing resources (and other related issues like continuing to improve the resource usage of the doc build, for which I have ideas but haven't had a chance to try them yet).

Otherwise I believe you that it works, and I'd like to be able to start using it right away, so it's a provisional Positive Review from me.  My only remaining question is: Do we want to go ahead now and bring this work up on sage-devel and ask others to weight in?  Or would that be too disruptive overall?  (If nothing else we'll need to get Volker to at least agree to merge it.)



---

archive/issue_comments_364526.json:
```json
{
    "body": "<a id='comment:3'></a>I think we should also approach companies like Google, Digital Ocean, Microsoft, etc. (and what about for OSX??) to see if we can get some donated resources from them for this purpose.  I don't think it's outside the realm of possibility, especially with a decent proposal (this would definitely fall under OpenDreamKit work I think).  But that's something we can work on in parallel.",
    "created_at": "2018-07-11T11:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364526",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I think we should also approach companies like Google, Digital Ocean, Microsoft, etc. (and what about for OSX??) to see if we can get some donated resources from them for this purpose.  I don't think it's outside the realm of possibility, especially with a decent proposal (this would definitely fall under OpenDreamKit work I think).  But that's something we can work on in parallel.



---

archive/issue_comments_364527.json:
```json
{
    "body": "<a id='comment:274'></a>Replying to [comment:272 embray]:\n> Replying to [comment:270 saraedum]:\n> > embray: I am not sure how we want to do the review on this one. I could do full tests of all the relevant scenarios today and tomorrow. The problem is: If during your review you find things that you want to see changed, then I have to go through the whole testing process again.\n> > \n> > The alternative is: You review the current state, and I do the full test just before we set this to positive review.\n> > \n> > The first option is more straightforward probably. But it only works if you think that there ane not going to be relevant changes necessary. (I am not sure how familiar you are with the current state of this ticket.)\n\n> \n> I'm mostly caught up on it--it is a *lot* though.  As far as I'm concerned it's \"positive review\".  While I believe there are still areas we'll want to improve a lot of it comes down to computing resources (and other related issues like continuing to improve the resource usage of the doc build, for which I have ideas but haven't had a chance to try them yet).\n\n\n> Otherwise I believe you that it works, and I'd like to be able to start using it right away, so it's a provisional Positive Review from me.\nGreat. Let me test that everything works then. And improving resource usage of the build would be quite amazing. Let me know if I can support you in any way there.\n\n> My only remaining question is: Do we want to go ahead now and bring this work up on sage-devel and ask others to weight in?  Or would that be too disruptive overall?  (If nothing else we'll need to get Volker to at least agree to merge it.)\n\nI don't think we need general consent from or discussion on sage-devel. For me this ticket is only about automatically building docker images to publish them on our Docker Hub account more conveniently. It's not about replacing the patchbot, migrating to [GitLab](GitLab), or anything like that.\n\nAt the same time this can of course be a first step towards more important changes, most promimently for me the binder ticket #24842. I'll put that one up for discussion on sage-devel once it's ready.",
    "created_at": "2018-07-11T11:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364527",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:274'></a>Replying to [comment:272 embray]:
> Replying to [comment:270 saraedum]:
> > embray: I am not sure how we want to do the review on this one. I could do full tests of all the relevant scenarios today and tomorrow. The problem is: If during your review you find things that you want to see changed, then I have to go through the whole testing process again.
> > 
> > The alternative is: You review the current state, and I do the full test just before we set this to positive review.
> > 
> > The first option is more straightforward probably. But it only works if you think that there ane not going to be relevant changes necessary. (I am not sure how familiar you are with the current state of this ticket.)

> 
> I'm mostly caught up on it--it is a *lot* though.  As far as I'm concerned it's "positive review".  While I believe there are still areas we'll want to improve a lot of it comes down to computing resources (and other related issues like continuing to improve the resource usage of the doc build, for which I have ideas but haven't had a chance to try them yet).


> Otherwise I believe you that it works, and I'd like to be able to start using it right away, so it's a provisional Positive Review from me.
Great. Let me test that everything works then. And improving resource usage of the build would be quite amazing. Let me know if I can support you in any way there.

> My only remaining question is: Do we want to go ahead now and bring this work up on sage-devel and ask others to weight in?  Or would that be too disruptive overall?  (If nothing else we'll need to get Volker to at least agree to merge it.)

I don't think we need general consent from or discussion on sage-devel. For me this ticket is only about automatically building docker images to publish them on our Docker Hub account more conveniently. It's not about replacing the patchbot, migrating to [GitLab](GitLab), or anything like that.

At the same time this can of course be a first step towards more important changes, most promimently for me the binder ticket #24842. I'll put that one up for discussion on sage-devel once it's ready.



---

archive/issue_comments_364528.json:
```json
{
    "body": "<a id='comment:275'></a>Replying to [comment:273 embray]:\n> I think we should also approach companies like Google, Digital Ocean, Microsoft, etc. (and what about for OSX??) to see if we can get some donated resources from them for this purpose.  I don't think it's outside the realm of possibility, especially with a decent proposal (this would definitely fall under OpenDreamKit work I think).  But that's something we can work on in parallel.\n\nCould you create a trac ticket to keep track of this? Or an issue on the ODK github account?",
    "created_at": "2018-07-11T11:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364528",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:275'></a>Replying to [comment:273 embray]:
> I think we should also approach companies like Google, Digital Ocean, Microsoft, etc. (and what about for OSX??) to see if we can get some donated resources from them for this purpose.  I don't think it's outside the realm of possibility, especially with a decent proposal (this would definitely fall under OpenDreamKit work I think).  But that's something we can work on in parallel.

Could you create a trac ticket to keep track of this? Or an issue on the ODK github account?



---

archive/issue_comments_364529.json:
```json
{
    "body": "<a id='comment:277'></a>Replying to [comment:275 saraedum]:\n> Replying to [comment:273 embray]:\n> > I think we should also approach companies like Google, Digital Ocean, Microsoft, etc. (and what about for OSX??) to see if we can get some donated resources from them for this purpose.  I don't think it's outside the realm of possibility, especially with a decent proposal (this would definitely fall under OpenDreamKit work I think).  But that's something we can work on in parallel.\n\n> Could you create a trac ticket to keep track of this? Or an issue on the ODK github account?\n\nSpeaking of which, I was going to ask if you saw my messages on Zulip.  But it appears to be down (and I'm afraid I might have broken it, somehow, by trying to log in): https://zulip.sagemath.org/\n\nBut I believe this could fall under [D3.8](https://github.com/OpenDreamKit/OpenDreamKit/issues/67)",
    "created_at": "2018-07-11T11:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364529",
    "user": "https://github.com/embray"
}
```

<a id='comment:277'></a>Replying to [comment:275 saraedum]:
> Replying to [comment:273 embray]:
> > I think we should also approach companies like Google, Digital Ocean, Microsoft, etc. (and what about for OSX??) to see if we can get some donated resources from them for this purpose.  I don't think it's outside the realm of possibility, especially with a decent proposal (this would definitely fall under OpenDreamKit work I think).  But that's something we can work on in parallel.

> Could you create a trac ticket to keep track of this? Or an issue on the ODK github account?

Speaking of which, I was going to ask if you saw my messages on Zulip.  But it appears to be down (and I'm afraid I might have broken it, somehow, by trying to log in): https://zulip.sagemath.org/

But I believe this could fall under [D3.8](https://github.com/OpenDreamKit/OpenDreamKit/issues/67)



---

archive/issue_comments_364530.json:
```json
{
    "body": "<a id='comment:278'></a>Replying to [comment:277 embray]:\n> \n> Speaking of which, I was going to ask if you saw my messages on Zulip.  But it appears to be down (and I'm afraid I might have broken it, somehow, by trying to log in): https://zulip.sagemath.org/\n\n\nI've upgraded zulip to the most recent version and restarted the server; it seems to be working now.",
    "created_at": "2018-07-11T17:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364530",
    "user": "https://github.com/roed314"
}
```

<a id='comment:278'></a>Replying to [comment:277 embray]:
> 
> Speaking of which, I was going to ask if you saw my messages on Zulip.  But it appears to be down (and I'm afraid I might have broken it, somehow, by trying to log in): https://zulip.sagemath.org/


I've upgraded zulip to the most recent version and restarted the server; it seems to be working now.



---

archive/issue_comments_364531.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,64 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* Setup an account for sagemath on Circle CI.\n+* Add Docker Hub credentials on Circle CI or [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-12T07:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364531",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,64 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* Setup an account for sagemath on Circle CI.
+* Add Docker Hub credentials on Circle CI or [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364532.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-16T09:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364532",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364533.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,73 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [ ] build-from-clean works in the sagemath namespace on [GitLab](GitLab)\n+* [ ] build-from-clean works in a user namespace on CircleCI\n+* [ ] build-from-latest works in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-16T09:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364533",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,73 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [ ] build-from-clean works in the sagemath namespace on [GitLab](GitLab)
+* [ ] build-from-clean works in a user namespace on CircleCI
+* [ ] build-from-latest works in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364534.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,73 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [ ] build-from-clean works in the sagemath namespace on [GitLab](GitLab)\n+* [ ] build-from-clean works in a user namespace on CircleCI\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-16T09:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364534",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,73 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [ ] build-from-clean works in the sagemath namespace on [GitLab](GitLab)
+* [ ] build-from-clean works in a user namespace on CircleCI
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364535.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,75 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab)\n+* [ ] build-from-clean works in the sagemath namespace, building from master on [GitLab](GitLab)\n+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab)\n+* [ ] build-from-clean works in a user namespace on CircleCI\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-16T09:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364535",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,75 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab)
+* [ ] build-from-clean works in the sagemath namespace, building from master on [GitLab](GitLab)
+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab)
+* [ ] build-from-clean works in a user namespace on CircleCI
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364536.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [ ] build-from-clean works in a user namespace on CircleCI\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-16T09:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364536",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [ ] build-from-clean works in a user namespace on CircleCI
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364537.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [ ] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-16T09:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364537",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [ ] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364538.json:
```json
{
    "body": "<a id='comment:6'></a>> [ ] build-from-clean works in a user namespace on CircleCI, \u200bhttps://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7\n\n>\n> [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)?\n\n>\n> [ ] build-from-latest works and is fast in a user namespace on CircleCI\n\n\nIn this case what do you mean by \"user namespace\"?  You mean like, a personal fork?  I could try that.  Would I need to set up a self-provided runner?  I can do that too (and should practice that anyways).",
    "created_at": "2018-07-16T10:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364538",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>> [ ] build-from-clean works in a user namespace on CircleCI, ​https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7

>
> [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)?

>
> [ ] build-from-latest works and is fast in a user namespace on CircleCI


In this case what do you mean by "user namespace"?  You mean like, a personal fork?  I could try that.  Would I need to set up a self-provided runner?  I can do that too (and should practice that anyways).



---

archive/issue_comments_364539.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [-] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-16T10:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364539",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes about **??** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about  minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [ ] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [ ] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [-] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364540.json:
```json
{
    "body": "<a id='comment:288'></a>Replying to [comment:286 embray]:\n> > [ ] build-from-clean works in a user namespace on CircleCI, \u200bhttps://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7\n\n> >\n> > [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)?\n\n> >\n> > [ ] build-from-latest works and is fast in a user namespace on CircleCI\n\n> \n> In this case what do you mean by \"user namespace\"?  You mean like, a personal fork?  I could try that.\n\nYes, I mean the typical use case for personal forks. More specifically, I meant the case where we are uploading to a docker hub account that is not the sagemath account. You might want to wait until https://gitlab.com/saraedum/sage/pipelines/25831675 has completed (so the sagemath/sagemath-dev:develop image has been upgraded), otherwise it won't be fast. Once that has happened, a branch that contains the changes in this ticket should build automatically on any [GitLab](GitLab) fork without further setup.\n\n> Would I need to set up a self-provided runner?  I can do that too (and should practice that anyways).\n\nNo, you don't need private runners for this. The free shared runners should be sufficient.",
    "created_at": "2018-07-16T10:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364540",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:288'></a>Replying to [comment:286 embray]:
> > [ ] build-from-clean works in a user namespace on CircleCI, ​https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7

> >
> > [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)?

> >
> > [ ] build-from-latest works and is fast in a user namespace on CircleCI

> 
> In this case what do you mean by "user namespace"?  You mean like, a personal fork?  I could try that.

Yes, I mean the typical use case for personal forks. More specifically, I meant the case where we are uploading to a docker hub account that is not the sagemath account. You might want to wait until https://gitlab.com/saraedum/sage/pipelines/25831675 has completed (so the sagemath/sagemath-dev:develop image has been upgraded), otherwise it won't be fast. Once that has happened, a branch that contains the changes in this ticket should build automatically on any [GitLab](GitLab) fork without further setup.

> Would I need to set up a self-provided runner?  I can do that too (and should practice that anyways).

No, you don't need private runners for this. The free shared runners should be sufficient.



---

archive/issue_comments_364541.json:
```json
{
    "body": "<a id='comment:289'></a>Replying to [comment:288 saraedum]:\n> Replying to [comment:286 embray]:\n> > > [ ] build-from-clean works in a user namespace on CircleCI, \u200bhttps://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7\n\n> > >\n> > > [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)?\n\n> > >\n> > > [ ] build-from-latest works and is fast in a user namespace on CircleCI\n\n> > \n> > In this case what do you mean by \"user namespace\"?  You mean like, a personal fork?  I could try that.\n\n> Yes, I mean the typical use case for personal forks. More specifically, I meant the case where we are uploading to a docker hub account that is not the sagemath account. You might want to wait until https://gitlab.com/saraedum/sage/pipelines/25831675 has completed (so the sagemath/sagemath-dev:develop image has been upgraded), otherwise it won't be fast. Once that has happened, a branch that contains the changes in this ticket should build automatically on any [GitLab](GitLab) fork without further setup.\n\nWhat about circle-ci?  For that surely I'd at least have to enable it in my repository?",
    "created_at": "2018-07-16T10:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364541",
    "user": "https://github.com/embray"
}
```

<a id='comment:289'></a>Replying to [comment:288 saraedum]:
> Replying to [comment:286 embray]:
> > > [ ] build-from-clean works in a user namespace on CircleCI, ​https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7

> > >
> > > [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)?

> > >
> > > [ ] build-from-latest works and is fast in a user namespace on CircleCI

> > 
> > In this case what do you mean by "user namespace"?  You mean like, a personal fork?  I could try that.

> Yes, I mean the typical use case for personal forks. More specifically, I meant the case where we are uploading to a docker hub account that is not the sagemath account. You might want to wait until https://gitlab.com/saraedum/sage/pipelines/25831675 has completed (so the sagemath/sagemath-dev:develop image has been upgraded), otherwise it won't be fast. Once that has happened, a branch that contains the changes in this ticket should build automatically on any [GitLab](GitLab) fork without further setup.

What about circle-ci?  For that surely I'd at least have to enable it in my repository?



---

archive/issue_comments_364542.json:
```json
{
    "body": "<a id='comment:0'></a>Yes, once the `sagemath/sagemath-dev:develop` has been upgraded, it should work by simply enabling it in your repository with no further configuration.",
    "created_at": "2018-07-16T10:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364542",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:0'></a>Yes, once the `sagemath/sagemath-dev:develop` has been upgraded, it should work by simply enabling it in your repository with no further configuration.



---

archive/issue_comments_364543.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T06:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364543",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **??** - **??** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364544.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T06:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364544",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364545.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T06:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364545",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab)
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364546.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **??** minutes for `build-from-latest:\n+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T06:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364546",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **??** minutes for `build-from-latest:
+  * **??** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [ ] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364547.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **32** minutes for `build-from-latest:\n+  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653\n+* [ ] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T07:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364547",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **32** minutes for `build-from-latest:
+  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653
+* [ ] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364548.json:
```json
{
    "body": "<a id='comment:6'></a>Everything relevant works. However, strangely, when \"building from latest\", the resulting images have different sizes on CircleCI and GitLab CI:\n\nsagemath: 611MB vs 635MB\n\nsagemath-dev: 4GB vs 2GB\n\nThe dev images are not relevant in this case but still this is unfortunate. More importantly I would like to understand why these are different in size as the docker builds should be the same on both platforms.",
    "created_at": "2018-07-17T07:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364548",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>Everything relevant works. However, strangely, when "building from latest", the resulting images have different sizes on CircleCI and GitLab CI:

sagemath: 611MB vs 635MB

sagemath-dev: 4GB vs 2GB

The dev images are not relevant in this case but still this is unfortunate. More importantly I would like to understand why these are different in size as the docker builds should be the same on both platforms.



---

archive/issue_comments_364549.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **32** minutes for `build-from-latest:\n+  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653\n+* [?] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T07:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364549",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **32** minutes for `build-from-latest:
+  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653
+* [?] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364550.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-17T11:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364550",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364551.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-17T11:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364551",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364552.json:
```json
{
    "body": "<a id='comment:300'></a>Replying to [comment:296 saraedum]:\n> Everything relevant works. However, strangely, when \"building from latest\", the resulting images have different sizes on CircleCI and GitLab CI:\n> \n> sagemath: 611MB vs 635MB\n\nThis is due to a difference in docker daemon version. I don't know what's the difference between the two images but I know tell CircleCI to build using the latest stable version and both are 635MB in size.\n\n> sagemath-dev: 4GB vs 2GB\n\nThis is a known bug in docker on aufs (that CircleCI is using.) There's isn't really anything we can do about it.",
    "created_at": "2018-07-17T11:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364552",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:300'></a>Replying to [comment:296 saraedum]:
> Everything relevant works. However, strangely, when "building from latest", the resulting images have different sizes on CircleCI and GitLab CI:
> 
> sagemath: 611MB vs 635MB

This is due to a difference in docker daemon version. I don't know what's the difference between the two images but I know tell CircleCI to build using the latest stable version and both are 635MB in size.

> sagemath-dev: 4GB vs 2GB

This is a known bug in docker on aufs (that CircleCI is using.) There's isn't really anything we can do about it.



---

archive/issue_comments_364553.json:
```json
{
    "body": "<a id='comment:1'></a>embray: I'll set this to positive review once I released 8.3rc2 as a final check.",
    "created_at": "2018-07-17T11:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364553",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>embray: I'll set this to positive review once I released 8.3rc2 as a final check.



---

archive/issue_comments_364554.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)\u00b9\n \n+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.\n+\n+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.\n+\n+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)\n+\n+---\n+\n+Here are some numbers and screenshots (click on the screenshots to go to the real pages):\n+\n+### [GitLab](GitLab) CI\n+\n+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.\n+\n+<img src=\"gitlab.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:\n+* **32** minutes for `build-from-latest:\n+  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)\n+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)\n+  * a few minutes running through all the fast stages of the Dockerfile.\n+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)\n+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)\n+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)\n+\n+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere\u2026I don't see a sustainable way of doing this with the current SPKG system.\n+\n+<img src=\"gitlab-rebuild.png\" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>\n+\n+### CircleCI\n+\n+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. \n+\n+<img src=\"circleci.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.\n+\n+<img src=\"circleci-rebuild.png\" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>\n+\n+### Docker Hub\n+\n+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.\n+\n+<img src=\"dockerhub.png\" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>\n+\n+---\n+\n+Here are some things that we need to test before merging this:\n+\n+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229\n+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675\n+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.\n+* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653\n+* [x] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c\n+\n+---\n+\n+After this ticket has been merged, the following steps are necessary:\n+\n+* ~~Setup an account for sagemath on Circle CI.~~\n+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).\n+\n+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.\n+\n+---\n+\n+\u00b9: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.\n+\n+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.\n \n Author: Julian R\u00fcth\n \n``````\n",
    "created_at": "2018-07-17T11:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364554",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+It would be nice to update our docker images automatically through continuous integration services. Of course it's good to have these images up-to-date without manual intervention but this is also convenient as a starting point for people who want to use CI for their own branches of Sage (besides the patchbot.)¹
 
+This ticket proposes recipes for [GitLab](GitLab) CI and CircleCI to build our docker images automatically. On the respective websites, the CI can be configured to push automatically to the Docker Hub. A webhook (on github) updates the README on Docker Hub automatically.
+
+I implemented this for both [GitLab](GitLab) CI and CircleCI. I think [GitLab](GitLab) CI is more relevant in the long  run, also it's open source and people can provision their own machines as runners. CircleCI at the same time works out of the box for Sage without private test runners and it also allows for easier debugging as you can logon to the machine running your tests with SSH. I tried to share most code between the two implementations.
+
+See also https://github.com/sagemath/docker-images/issues/13 and https://github.com/sagemath/sage-binder-env/issues/3 for a followup (automatically provide jupyter notebooks for easier review.)
+
+---
+
+Here are some numbers and screenshots (click on the screenshots to go to the real pages):
+
+### [GitLab](GitLab) CI
+
+If I provision my own runner from Google Cloud with two threads, it takes about 5 hours to build Sage from scratch, run rudimentary tests on the docker images, and upload them to Docker Hub and GitLab's registry.
+
+<img src="gitlab.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **??** minutes (on GitLab's free shared runners with two threads.) This roughly breaks down as:
+* **32** minutes for `build-from-latest:
+  * **10** minutes for the actual build (most of which is spent in the docbuild; caused by a known Sphinx bug to some extent)
+  * **??** minutes are spent pulling the sagemath-dev image from Docker Hub (this usually goes away if you provision your own runners and expose the host's docker daemon by setting `DOCKER_HOST`.)
+  * a few minutes running through all the fast stages of the Dockerfile.
+  * a few minutes to push the resulting images to GitLab's registry. (using GitLab's `cache`, this could probably be improved, at least for runners that we provision ourselves.)
+* **5** - **15** minutes for each test (run in parallel,); the relevant test is `test-dev.sh` which spents 6 minutes in the actual docbuild (just as in `build-from-latest`) and some 5 minutes to pull the sagemath-dev image from the [GitLab](GitLab) registry. (That part should go away with a provisioned runner that exposes the host's docker daemon.)
+* **??** minutes for the publishing to Docker Hub, most of which is spent pulling the images from the [GitLab](GitLab) registry, and the other half pushing them to Docker Hub roughly. (Again, exposing the host's docker daemon would probably cut that time in half.)
+
+With some tricks we could probably bring this down to 25 minutes (see CircleCI below) but we won't get this down to this without giving up on the CI being split up into different stages (as is for technical reasons necessary for CircleCI.) To go well below that, we would need to pull binary packages from somewhere…I don't see a sustainable way of doing this with the current SPKG system.
+
+<img src="gitlab-rebuild.png" width=640, center, link=https://gitlab.com/saraedum/sage/pipelines/18026318>
+
+### CircleCI
+
+It typically takes almost **5** hours to build Sage from scratch on CircleCI, run rudimentary tests on the docker images, and upload them to Docker Hub. 
+
+<img src="circleci.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+Recycling the build artifacts from the last run on the develop branch brings this down to about **30** minutes usually. 5 minutes could be saved by not testing the `sagemath-dev` and probably another minute or two if we do not build it at all. To go significantly below 15 minutes is probably hard with the huge sage-the-distribution (7GB uncompressed/2GB compressed) that we have to pull every time at the moment.
+
+<img src="circleci-rebuild.png" width=640, center, link=https://circleci.com/gh/saraedum/workflows/sage>
+
+### Docker Hub
+
+A push to github updates the README on the Docker Hub page. The current sizes are ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath/latest.svg) and ![](https://img.shields.io/microbadger/image-size/sagemath/sagemath-dev/latest.svg); unfortunately MicroBadger is somewhat unstable so these numbers are incorrectly reported as 0 sometimes.
+
+<img src="dockerhub.png" width=640, center, link=https://hub.docker.com/r/sagemath/sagemath>
+
+---
+
+Here are some things that we need to test before merging this:
+
+* [x] build-from-clean works in the sagemath namespace, building a tag on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831229
+* [x] build-from-clean works in the sagemath namespace, building from develop on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25831675
+* [x] build-from-clean works in a user namespace on CircleCI, https://circleci.com/workflow-run/4ae6af8c-2212-4724-a865-a401be4bd8b7; this does not work reliably as it often times out after 5 hours. If we can manage to use more packages from the system, then we should be able to move this below CircleCI's time limit.
+* [x] build-from-latest works and is fast in a user namespace on [GitLab](GitLab), https://gitlab.com/saraedum/sage/pipelines/25894653
+* [x] build-from-latest works and is fast in a user namespace on CircleCI, https://circleci.com/workflow-run/5bad5fe0-f817-4174-b0b4-de7d1be3b01c
+
+---
+
+After this ticket has been merged, the following steps are necessary:
+
+* ~~Setup an account for sagemath on Circle CI.~~
+* Add Docker Hub credentials on ~~Circle CI or~~ [GitLab](GitLab).
+
+To see a demo of what the result looks like, go to https://hub.docker.com/r/sagemath/sagemath/. The CircleCI runs can be seen here https://circleci.com/gh/saraedum/sage, and the [GitLab](GitLab) CI runs are here https://gitlab.com/saraedum/sage/pipelines.
+
+---
+
+¹: I want to run unit tests of an external Sage package, https://github.com/swewers/MCLF. Being able to build a custom docker image which contains some not-yet-merged tickets makes this much easier.
+
+PS: Long-term one could imagine this to be the first step to replace the patchbot with a solution that we do not have to maintain so much ourselves, such as gitlab-runners. This is of course outside of the scope of this ticket but having a bunch of working CI files in our repository might inspire people to script some other tasks in a reproducible and standardized way.
 
 Author: Julian Rüth
 
``````




---

archive/issue_comments_364555.json:
```json
{
    "body": "<a id='comment:3'></a>There's a problem with these Docker images, which is that it's impossible to install optional packages, which is a thing people are going to want to be able to do.  This is a problem, of course, because being able to install optional packages means at least having some minimal build toolchain available in the image.\n\nI suppose they could `apt-get install` that after the fact, if desired (though this needs to be documented somehow).  But then there's the problem that `/home/sage/sage` is thoroughly stripped down, and does not have `configure`, `build/make/Makefile`, or anything else required for `sage -i` to work at a minimum.  This leads to the unhelpful error message \n\n```\n/home/sage/sage/src/bin/sage: line 353: make: command not found\n```\n\nor even if you `sudo apt-get install make`:\n\n```\nmake: *** No rule to make target 'all-toolchain'.  Stop.\n```\n\nI'm not sure what we do about this.",
    "created_at": "2018-07-23T14:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364555",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>There's a problem with these Docker images, which is that it's impossible to install optional packages, which is a thing people are going to want to be able to do.  This is a problem, of course, because being able to install optional packages means at least having some minimal build toolchain available in the image.

I suppose they could `apt-get install` that after the fact, if desired (though this needs to be documented somehow).  But then there's the problem that `/home/sage/sage` is thoroughly stripped down, and does not have `configure`, `build/make/Makefile`, or anything else required for `sage -i` to work at a minimum.  This leads to the unhelpful error message 

```
/home/sage/sage/src/bin/sage: line 353: make: command not found
```

or even if you `sudo apt-get install make`:

```
make: *** No rule to make target 'all-toolchain'.  Stop.
```

I'm not sure what we do about this.



---

archive/issue_comments_364556.json:
```json
{
    "body": "<a id='comment:304'></a>Replying to [comment:300 saraedum]:\n> Replying to [comment:296 saraedum]:\n> > Everything relevant works. However, strangely, when \"building from latest\", the resulting images have different sizes on CircleCI and GitLab CI:\n> > \n> > sagemath: 611MB vs 635MB\n\n> This is due to a difference in docker daemon version. I don't know what's the difference between the two images but I know tell CircleCI to build using the latest stable version and both are 635MB in size.\n> \n> > sagemath-dev: 4GB vs 2GB\n\n> This is a known bug in docker on aufs (that CircleCI is using.) There's isn't really anything we can do about it.\n\nThanks for researching and making note of it.  What a pain.  I wish Docker would like, stabilize :)\n\nDo you know if this issue has been brought up with CircleCI?",
    "created_at": "2018-07-23T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364556",
    "user": "https://github.com/embray"
}
```

<a id='comment:304'></a>Replying to [comment:300 saraedum]:
> Replying to [comment:296 saraedum]:
> > Everything relevant works. However, strangely, when "building from latest", the resulting images have different sizes on CircleCI and GitLab CI:
> > 
> > sagemath: 611MB vs 635MB

> This is due to a difference in docker daemon version. I don't know what's the difference between the two images but I know tell CircleCI to build using the latest stable version and both are 635MB in size.
> 
> > sagemath-dev: 4GB vs 2GB

> This is a known bug in docker on aufs (that CircleCI is using.) There's isn't really anything we can do about it.

Thanks for researching and making note of it.  What a pain.  I wish Docker would like, stabilize :)

Do you know if this issue has been brought up with CircleCI?



---

archive/issue_comments_364557.json:
```json
{
    "body": "<a id='comment:305'></a>Replying to [comment:303 embray]:\n> There's a problem with these Docker images, which is that it's impossible to install optional packages, which is a thing people are going to want to be able to do.  This is a problem, of course, because being able to install optional packages means at least having some minimal build toolchain available in the image.\n> \n> I suppose they could `apt-get install` that after the fact, if desired (though this needs to be documented somehow).  But then there's the problem that `/home/sage/sage` is thoroughly stripped down, and does not have `configure`, `build/make/Makefile`, or anything else required for `sage -i` to work at a minimum.  This leads to the unhelpful error message \n> \n> \n> ```\n> /home/sage/sage/src/bin/sage: line 353: make: command not found\n> ```\n> \n> or even if you `sudo apt-get install make`:\n> \n> \n> ```\n> make: *** No rule to make target 'all-toolchain'.  Stop.\n> ```\n> \n> I'm not sure what we do about this.\n\n\nNo clue really. `sage -pip` works afaik, so that's good enough for some I think.\n\nI am not sure who would want to install more packages. Since you need to add a bunch of build dependencies, we could consider pointing people to the dev images instead maybe? Actually many optional dependencies should already be detected by the features framework so they could be installed through `apt-get`?",
    "created_at": "2018-07-24T13:43:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364557",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:305'></a>Replying to [comment:303 embray]:
> There's a problem with these Docker images, which is that it's impossible to install optional packages, which is a thing people are going to want to be able to do.  This is a problem, of course, because being able to install optional packages means at least having some minimal build toolchain available in the image.
> 
> I suppose they could `apt-get install` that after the fact, if desired (though this needs to be documented somehow).  But then there's the problem that `/home/sage/sage` is thoroughly stripped down, and does not have `configure`, `build/make/Makefile`, or anything else required for `sage -i` to work at a minimum.  This leads to the unhelpful error message 
> 
> 
> ```
> /home/sage/sage/src/bin/sage: line 353: make: command not found
> ```
> 
> or even if you `sudo apt-get install make`:
> 
> 
> ```
> make: *** No rule to make target 'all-toolchain'.  Stop.
> ```
> 
> I'm not sure what we do about this.


No clue really. `sage -pip` works afaik, so that's good enough for some I think.

I am not sure who would want to install more packages. Since you need to add a bunch of build dependencies, we could consider pointing people to the dev images instead maybe? Actually many optional dependencies should already be detected by the features framework so they could be installed through `apt-get`?



---

archive/issue_comments_364558.json:
```json
{
    "body": "<a id='comment:306'></a>Replying to [comment:305 saraedum]:\n> Replying to [comment:303 embray]:\n> > There's a problem with these Docker images, which is that it's impossible to install optional packages, which is a thing people are going to want to be able to do.  This is a problem, of course, because being able to install optional packages means at least having some minimal build toolchain available in the image.\n> > \n> > I suppose they could `apt-get install` that after the fact, if desired (though this needs to be documented somehow).  But then there's the problem that `/home/sage/sage` is thoroughly stripped down, and does not have `configure`, `build/make/Makefile`, or anything else required for `sage -i` to work at a minimum.  This leads to the unhelpful error message \n> > \n> > \n> > ```\n> > /home/sage/sage/src/bin/sage: line 353: make: command not found\n> > ```\n> > \n> > or even if you `sudo apt-get install make`:\n> > \n> > \n> > ```\n> > make: *** No rule to make target 'all-toolchain'.  Stop.\n> > ```\n> > \n> > I'm not sure what we do about this.\n\n> \n> No clue really. `sage -pip` works afaik, so that's good enough for some I think.\n\n\nNot for anything that's installed with `sage -i`\n\n> I am not sure who would want to install more packages. Since you need to add a bunch of build dependencies, we could consider pointing people to the dev images instead maybe?\n\n\nFor now that's what I've done, and what I suppose we can continue to do for now.  Installing optional packages works for the dev images.\n\n> Actually many optional dependencies should already be detected by the features framework so they could be installed through `apt-get`?\n\n\nYes, that's something we should work on separately.  There should be a framework for optional packages such that we can easily supply the distro-specific commands to install any dependencies needed for optional packages.  For the docker images (or any other Sage installed on debian or ubuntu) this would of course be the appropriate `apt-get` command.  For other distros it might supply the correct package names to pass to emerge, yum, etc.  This info could come from a distro-specific config file, that we can either maintain in the Sage repo directly, or that could be provided as a patch by downstream distributors.\n\nFor this to work we also need to include, at a minimum, the `build/make/Makefile` in the installed Sage as well.  Anyways, I don't think that's something we should do for this ticket.  Just something to consider.",
    "created_at": "2018-07-24T15:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364558",
    "user": "https://github.com/embray"
}
```

<a id='comment:306'></a>Replying to [comment:305 saraedum]:
> Replying to [comment:303 embray]:
> > There's a problem with these Docker images, which is that it's impossible to install optional packages, which is a thing people are going to want to be able to do.  This is a problem, of course, because being able to install optional packages means at least having some minimal build toolchain available in the image.
> > 
> > I suppose they could `apt-get install` that after the fact, if desired (though this needs to be documented somehow).  But then there's the problem that `/home/sage/sage` is thoroughly stripped down, and does not have `configure`, `build/make/Makefile`, or anything else required for `sage -i` to work at a minimum.  This leads to the unhelpful error message 
> > 
> > 
> > ```
> > /home/sage/sage/src/bin/sage: line 353: make: command not found
> > ```
> > 
> > or even if you `sudo apt-get install make`:
> > 
> > 
> > ```
> > make: *** No rule to make target 'all-toolchain'.  Stop.
> > ```
> > 
> > I'm not sure what we do about this.

> 
> No clue really. `sage -pip` works afaik, so that's good enough for some I think.


Not for anything that's installed with `sage -i`

> I am not sure who would want to install more packages. Since you need to add a bunch of build dependencies, we could consider pointing people to the dev images instead maybe?


For now that's what I've done, and what I suppose we can continue to do for now.  Installing optional packages works for the dev images.

> Actually many optional dependencies should already be detected by the features framework so they could be installed through `apt-get`?


Yes, that's something we should work on separately.  There should be a framework for optional packages such that we can easily supply the distro-specific commands to install any dependencies needed for optional packages.  For the docker images (or any other Sage installed on debian or ubuntu) this would of course be the appropriate `apt-get` command.  For other distros it might supply the correct package names to pass to emerge, yum, etc.  This info could come from a distro-specific config file, that we can either maintain in the Sage repo directly, or that could be provided as a patch by downstream distributors.

For this to work we also need to include, at a minimum, the `build/make/Makefile` in the installed Sage as well.  Anyways, I don't think that's something we should do for this ticket.  Just something to consider.



---

archive/issue_comments_364559.json:
```json
{
    "body": "<a id='comment:307'></a>Replying to [comment:301 saraedum]:\n> embray: I'll set this to positive review once I released 8.3rc2 as a final check.\n\n\n+1",
    "created_at": "2018-07-24T15:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364559",
    "user": "https://github.com/embray"
}
```

<a id='comment:307'></a>Replying to [comment:301 saraedum]:
> embray: I'll set this to positive review once I released 8.3rc2 as a final check.


+1



---

archive/issue_comments_364560.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-25T10:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364560",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364561.json:
```json
{
    "body": "<a id='comment:9'></a>The 8.3rc2 release worked fine, so we can finally set this to positive review.",
    "created_at": "2018-07-26T11:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364561",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:9'></a>The 8.3rc2 release worked fine, so we can finally set this to positive review.



---

archive/issue_comments_364562.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-26T11:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364562",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364563.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-07-28T11:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364563",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_364564.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-07-28T11:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364564",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_364565.json:
```json
{
    "body": "<a id='comment:1'></a>No need to set this back to needs review after a trivial merge with trac/develop.",
    "created_at": "2018-07-29T10:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364565",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>No need to set this back to needs review after a trivial merge with trac/develop.



---

archive/issue_comments_364566.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-29T10:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364566",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364567.json:
```json
{
    "body": "<a id='comment:2'></a>+1",
    "created_at": "2018-07-30T16:35:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364567",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>+1



---

archive/issue_comments_364568.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-08-03T12:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_364569.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-08-03T12:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364569",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_364570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-03T12:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364570",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364571.json:
```json
{
    "body": "<a id='comment:4'></a>(trivial merge)",
    "created_at": "2018-08-03T12:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364571",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>(trivial merge)



---

archive/issue_comments_364572.json:
```json
{
    "body": "<a id='comment:5'></a>Btw., I just published 8.3 on sagemath/sagemath and sagemath/sagemath-dev.",
    "created_at": "2018-08-03T19:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364572",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Btw., I just published 8.3 on sagemath/sagemath and sagemath/sagemath-dev.



---

archive/issue_comments_364573.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-08-05T16:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364573",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_364574.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-08-05T16:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_364575.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-05T16:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364575",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364576.json:
```json
{
    "body": "<a id='comment:7'></a>Back to positive review after a trivial merge. (vbraun: I am merging in develop as this triggers automatic builds of our docker images on gitlab.com.)",
    "created_at": "2018-08-05T16:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364576",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:7'></a>Back to positive review after a trivial merge. (vbraun: I am merging in develop as this triggers automatic builds of our docker images on gitlab.com.)



---

archive/issue_comments_364577.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-08-07T19:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364577",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_364578.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-08-07T19:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364578",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_364579.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-16T22:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364579",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364580.json:
```json
{
    "body": "<a id='comment:0'></a>embray, I have a feeling that the build now hangs more frequently than it used to. I have now seen this twice locally and I had CI machines time out after 12 hours of trying to build Sage. (I checked locally that nothing was happening anymore in the background.)",
    "created_at": "2018-08-17T02:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364580",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:0'></a>embray, I have a feeling that the build now hangs more frequently than it used to. I have now seen this twice locally and I had CI machines time out after 12 hours of trying to build Sage. (I checked locally that nothing was happening anymore in the background.)



---

archive/issue_comments_364581.json:
```json
{
    "body": "<a id='comment:1'></a>I can't imagine why.  Nobody else has reported builds hanging.  I'm not sure what you mean in this case by \"the build\", because there's nothing special about the way sage is being built ist here?\n\n\nThis ticket has gone on too long.  Let's see if we can get Volker to merge it and then we can continue tweaking from there.  It might also help if you could squash down some of the massive commit history into something a little easier to digest, but I know that can be daunting in its own right...",
    "created_at": "2018-08-17T11:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364581",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>I can't imagine why.  Nobody else has reported builds hanging.  I'm not sure what you mean in this case by "the build", because there's nothing special about the way sage is being built ist here?


This ticket has gone on too long.  Let's see if we can get Volker to merge it and then we can continue tweaking from there.  It might also help if you could squash down some of the massive commit history into something a little easier to digest, but I know that can be daunting in its own right...



---

archive/issue_comments_364582.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-17T11:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364582",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364583.json:
```json
{
    "body": "<a id='comment:2'></a>Also, can you tell where the builds have been hanging? \n\nThey've been some tinkering with Docker Hub lately, and I know they have some planned downtime coming up.",
    "created_at": "2018-08-17T12:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364583",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Also, can you tell where the builds have been hanging? 

They've been some tinkering with Docker Hub lately, and I know they have some planned downtime coming up.



---

archive/issue_comments_364584.json:
```json
{
    "body": "<a id='comment:3'></a>I'm a little confused by the latest jobs on https://gitlab.com/saraedum/sage/pipelines\n\nThe last three jobs were all building the exact same commit: https://gitlab.com/saraedum/sage/commit/3af7c5006c0a9b3583f2bb2041c815c607b2f3f2\n\nBut one was triggered on an update to the \"develop\" branch, one was triggered on an update to a \"build-from-latest\" branch (what's that about?--apologies if I've already asked), and one was triggered by the new 8.4.beta1 tag.  Although, the way Sage is currently developed, updates to the \"develop\" branch always coincide with new tags as well.  I don't like that, but for now it's superfluous to trigger builds on new tags.\n\nAlso, with the two that failed, it looks like I was right about it being something to do with Docker Hub, but I could be misreading the logs.  I'm not sure if that's what you're referring to though.",
    "created_at": "2018-08-17T12:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364584",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I'm a little confused by the latest jobs on https://gitlab.com/saraedum/sage/pipelines

The last three jobs were all building the exact same commit: https://gitlab.com/saraedum/sage/commit/3af7c5006c0a9b3583f2bb2041c815c607b2f3f2

But one was triggered on an update to the "develop" branch, one was triggered on an update to a "build-from-latest" branch (what's that about?--apologies if I've already asked), and one was triggered by the new 8.4.beta1 tag.  Although, the way Sage is currently developed, updates to the "develop" branch always coincide with new tags as well.  I don't like that, but for now it's superfluous to trigger builds on new tags.

Also, with the two that failed, it looks like I was right about it being something to do with Docker Hub, but I could be misreading the logs.  I'm not sure if that's what you're referring to though.



---

archive/issue_comments_364585.json:
```json
{
    "body": "<a id='comment:4'></a>The latest Circle-CI build, however, timed out at\n\n```\n ---> 3753d48ddd74\nStep 68/76 : RUN if [ x\"$ARTIFACT_BASE\" != x\"source-clean\" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi\n ---> Running in ea5237ee3bbd\nBuild timedout\n```\n\nI have no idea what any of that means.\n\n(As an aside, I find it annoying that Circle-CI will show you the beginning of the log, but you have to download the full log to see the end.  On [GitLab](GitLab) it will also truncate the log, but it shows the *end* of the log first, which is almost always more useful when it comes to diagnosing problems.  I wonder if that's at all configurable on Circle...)",
    "created_at": "2018-08-17T12:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364585",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>The latest Circle-CI build, however, timed out at

```
 ---> 3753d48ddd74
Step 68/76 : RUN if [ x"$ARTIFACT_BASE" != x"source-clean" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi
 ---> Running in ea5237ee3bbd
Build timedout
```

I have no idea what any of that means.

(As an aside, I find it annoying that Circle-CI will show you the beginning of the log, but you have to download the full log to see the end.  On [GitLab](GitLab) it will also truncate the log, but it shows the *end* of the log first, which is almost always more useful when it comes to diagnosing problems.  I wonder if that's at all configurable on Circle...)



---

archive/issue_comments_364586.json:
```json
{
    "body": "<a id='comment:325'></a>Replying to [comment:322 embray]:\n> Also, can you tell where the builds have been hanging? \n\nUnfortunately I don't really know. My top showed a python2 process that did not do anything anymore but that apparently was the only thing that make was waiting for. I did not investigate further.\n\nOn [GitLab](GitLab) I could not see where it hung because we truncate the logs ourselves and we were already in that portion.\n\n> They've been some tinkering with Docker Hub lately, and I know they have some planned downtime coming up.\n\nYes, that explains some of the errors when pushing images in the end. But that's not what I have been refering to here.",
    "created_at": "2018-08-17T12:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364586",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:325'></a>Replying to [comment:322 embray]:
> Also, can you tell where the builds have been hanging? 

Unfortunately I don't really know. My top showed a python2 process that did not do anything anymore but that apparently was the only thing that make was waiting for. I did not investigate further.

On [GitLab](GitLab) I could not see where it hung because we truncate the logs ourselves and we were already in that portion.

> They've been some tinkering with Docker Hub lately, and I know they have some planned downtime coming up.

Yes, that explains some of the errors when pushing images in the end. But that's not what I have been refering to here.



---

archive/issue_comments_364587.json:
```json
{
    "body": "<a id='comment:326'></a>Replying to [comment:323 embray]:\n> I'm a little confused by the latest jobs on https://gitlab.com/saraedum/sage/pipelines\n> \n> The last three jobs were all building the exact same commit: https://gitlab.com/saraedum/sage/commit/3af7c5006c0a9b3583f2bb2041c815c607b2f3f2\n\nYes, that's fine. I pushed one to a branch (that's not called develop and not called master) to see if the build-from-latest still works. However, due to quite a bit of SPKG changes, the build timed out in the 3h time limit that is in place for build-from-latest (we use the public shared gitlab runners, and they enforce that time limit.)\n\nThe other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.\n\nAs a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of \"docker build\". But since \"docker build\" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.",
    "created_at": "2018-08-17T12:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364587",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:326'></a>Replying to [comment:323 embray]:
> I'm a little confused by the latest jobs on https://gitlab.com/saraedum/sage/pipelines
> 
> The last three jobs were all building the exact same commit: https://gitlab.com/saraedum/sage/commit/3af7c5006c0a9b3583f2bb2041c815c607b2f3f2

Yes, that's fine. I pushed one to a branch (that's not called develop and not called master) to see if the build-from-latest still works. However, due to quite a bit of SPKG changes, the build timed out in the 3h time limit that is in place for build-from-latest (we use the public shared gitlab runners, and they enforce that time limit.)

The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.

As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of "docker build". But since "docker build" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.



---

archive/issue_comments_364588.json:
```json
{
    "body": "<a id='comment:327'></a>Replying to [comment:324 embray]:\n> The latest Circle-CI build, however, timed out at\n> \n> \n> ```\n>  ---> 3753d48ddd74\n> Step 68/76 : RUN if [ x\"$ARTIFACT_BASE\" != x\"source-clean\" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi\n>  ---> Running in ea5237ee3bbd\n> Build timedout\n> ```\n\nYes, build-from-clean times out on CircleCI. That's a known and documented issue.\n\n> (As an aside, I find it annoying that Circle-CI will show you the beginning of the log, but you have to download the full log to see the end.  On [GitLab](GitLab) it will also truncate the log, but it shows the *end* of the log first, which is almost always more useful when it comes to diagnosing problems.  I wonder if that's at all configurable on Circle...)\n\nNo, it can't be configured and it's a common complaint about CircleCI.",
    "created_at": "2018-08-17T12:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364588",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:327'></a>Replying to [comment:324 embray]:
> The latest Circle-CI build, however, timed out at
> 
> 
> ```
>  ---> 3753d48ddd74
> Step 68/76 : RUN if [ x"$ARTIFACT_BASE" != x"source-clean" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi
>  ---> Running in ea5237ee3bbd
> Build timedout
> ```

Yes, build-from-clean times out on CircleCI. That's a known and documented issue.

> (As an aside, I find it annoying that Circle-CI will show you the beginning of the log, but you have to download the full log to see the end.  On [GitLab](GitLab) it will also truncate the log, but it shows the *end* of the log first, which is almost always more useful when it comes to diagnosing problems.  I wonder if that's at all configurable on Circle...)

No, it can't be configured and it's a common complaint about CircleCI.



---

archive/issue_comments_364589.json:
```json
{
    "body": "<a id='comment:328'></a>Replying to [comment:321 embray]:\n> I can't imagine why.  Nobody else has reported builds hanging.  I'm not sure what you mean in this case by \"the build\", because there's nothing special about the way sage is being built ist here?\n> \n> \n> This ticket has gone on too long.  Let's see if we can get Volker to merge it and then we can continue tweaking from there.  It might also help if you could squash down some of the massive commit history into something a little easier to digest, but I know that can be daunting in its own right...\n\n\nI prefer not to squash the commits just because it's a lot of work. I am trying to write meaningful commit messages so if somebody really looks at the commit history some day it should be possible to make sense out of it.\n\nBut, yeah, let's get this back to positive review.",
    "created_at": "2018-08-17T12:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364589",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:328'></a>Replying to [comment:321 embray]:
> I can't imagine why.  Nobody else has reported builds hanging.  I'm not sure what you mean in this case by "the build", because there's nothing special about the way sage is being built ist here?
> 
> 
> This ticket has gone on too long.  Let's see if we can get Volker to merge it and then we can continue tweaking from there.  It might also help if you could squash down some of the massive commit history into something a little easier to digest, but I know that can be daunting in its own right...


I prefer not to squash the commits just because it's a lot of work. I am trying to write meaningful commit messages so if somebody really looks at the commit history some day it should be possible to make sense out of it.

But, yeah, let's get this back to positive review.



---

archive/issue_comments_364590.json:
```json
{
    "body": "<a id='comment:9'></a>I spent some time reading through the log of the recent Circle-CI build that timed out, and that was at least edifying, to understand better step-by-step what the process is.  You've walked me through it a few times but it's still...complicated, to say the least.\n\nI'm still not clear on what these timeouts you're referring to are, then, if it's not anything I could see on the recent builds...",
    "created_at": "2018-08-17T12:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364590",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>I spent some time reading through the log of the recent Circle-CI build that timed out, and that was at least edifying, to understand better step-by-step what the process is.  You've walked me through it a few times but it's still...complicated, to say the least.

I'm still not clear on what these timeouts you're referring to are, then, if it's not anything I could see on the recent builds...



---

archive/issue_comments_364591.json:
```json
{
    "body": "<a id='comment:330'></a>Replying to [comment:327 saraedum]:\n> Replying to [comment:324 embray]:\n> > The latest Circle-CI build, however, timed out at\n> > \n> > \n> > ```\n> >  ---> 3753d48ddd74\n> > Step 68/76 : RUN if [ x\"$ARTIFACT_BASE\" != x\"source-clean\" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi\n> >  ---> Running in ea5237ee3bbd\n> > Build timedout\n> > ```\n\n> Yes, build-from-clean times out on CircleCI. That's a known and documented issue.\n\nIs it?  I see your note in the Dockerfile about it making the images too big, but not about it timing out.  If it's a known issue then shouldn't we just disable it for now?",
    "created_at": "2018-08-17T12:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364591",
    "user": "https://github.com/embray"
}
```

<a id='comment:330'></a>Replying to [comment:327 saraedum]:
> Replying to [comment:324 embray]:
> > The latest Circle-CI build, however, timed out at
> > 
> > 
> > ```
> >  ---> 3753d48ddd74
> > Step 68/76 : RUN if [ x"$ARTIFACT_BASE" != x"source-clean" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi
> >  ---> Running in ea5237ee3bbd
> > Build timedout
> > ```

> Yes, build-from-clean times out on CircleCI. That's a known and documented issue.

Is it?  I see your note in the Dockerfile about it making the images too big, but not about it timing out.  If it's a known issue then shouldn't we just disable it for now?



---

archive/issue_comments_364592.json:
```json
{
    "body": "<a id='comment:331'></a>Replying to [comment:326 saraedum]:\n> The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.\n> \n> As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of \"docker build\". But since \"docker build\" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.\n\n\nI still feel like we ought to be able to work around that somehow.  I don't see why we would want to do two complete build-from-cleans of the same exact commit just so they wind up with different tags on Docker Hub.\n\nI know you've thought about this more than I have so I'm probably missing something.  But my thinking is that until and unless Sage's \"develop\" branch is decoupled from its tags (something I think should happen but is not the case for now), we should edit the `.gitlab-ci.yml` and `.circleci/config.yml` to really only do build-from-clean on the `develop` branch (not even master).  If we want to then tag an image with a version number, we can take the current commit ID on develop, do `git describe --tags <commit id>`, and get the associated tag name.  Then use that to tag the image.",
    "created_at": "2018-08-17T13:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364592",
    "user": "https://github.com/embray"
}
```

<a id='comment:331'></a>Replying to [comment:326 saraedum]:
> The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.
> 
> As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of "docker build". But since "docker build" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.


I still feel like we ought to be able to work around that somehow.  I don't see why we would want to do two complete build-from-cleans of the same exact commit just so they wind up with different tags on Docker Hub.

I know you've thought about this more than I have so I'm probably missing something.  But my thinking is that until and unless Sage's "develop" branch is decoupled from its tags (something I think should happen but is not the case for now), we should edit the `.gitlab-ci.yml` and `.circleci/config.yml` to really only do build-from-clean on the `develop` branch (not even master).  If we want to then tag an image with a version number, we can take the current commit ID on develop, do `git describe --tags <commit id>`, and get the associated tag name.  Then use that to tag the image.



---

archive/issue_comments_364593.json:
```json
{
    "body": "<a id='comment:332'></a>Replying to [comment:331 embray]:\n> Replying to [comment:326 saraedum]:\n> > The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.\n> > \n> > As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of \"docker build\". But since \"docker build\" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.\n\n> \n> I still feel like we ought to be able to work around that somehow.  I don't see why we would want to do two complete build-from-cleans of the same exact commit just so they wind up with different tags on Docker Hub.\n\nIt's a bit weird, I agree. But that's how people do that on [GitLab](GitLab) CI. And usually builds don't take five hours, so it doesn't matter.\n\n> I know you've thought about this more than I have so I'm probably missing something.  But my thinking is that until and unless Sage's \"develop\" branch is decoupled from its tags (something I think should happen but is not the case for now), we should edit the `.gitlab-ci.yml` and `.circleci/config.yml` to really only do build-from-clean on the `develop` branch (not even master).  If we want to then tag an image with a version number, we can take the current commit ID on develop, do `git describe --tags <commit id>`, and get the associated tag name.  Then use that to tag the image.\n\n\nThis would break if the branch and the tag are not pushed at the same time. Also, it's reasonable that you don't want to push all tags but just protected tags, e.g., I don't want to push the tags that I just use to check that building from tags actually works.\n\nIn short, I see your point but I'd rather leave it the way it is.",
    "created_at": "2018-08-17T13:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364593",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:332'></a>Replying to [comment:331 embray]:
> Replying to [comment:326 saraedum]:
> > The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.
> > 
> > As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of "docker build". But since "docker build" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.

> 
> I still feel like we ought to be able to work around that somehow.  I don't see why we would want to do two complete build-from-cleans of the same exact commit just so they wind up with different tags on Docker Hub.

It's a bit weird, I agree. But that's how people do that on [GitLab](GitLab) CI. And usually builds don't take five hours, so it doesn't matter.

> I know you've thought about this more than I have so I'm probably missing something.  But my thinking is that until and unless Sage's "develop" branch is decoupled from its tags (something I think should happen but is not the case for now), we should edit the `.gitlab-ci.yml` and `.circleci/config.yml` to really only do build-from-clean on the `develop` branch (not even master).  If we want to then tag an image with a version number, we can take the current commit ID on develop, do `git describe --tags <commit id>`, and get the associated tag name.  Then use that to tag the image.


This would break if the branch and the tag are not pushed at the same time. Also, it's reasonable that you don't want to push all tags but just protected tags, e.g., I don't want to push the tags that I just use to check that building from tags actually works.

In short, I see your point but I'd rather leave it the way it is.



---

archive/issue_comments_364594.json:
```json
{
    "body": "<a id='comment:333'></a>Replying to [comment:330 embray]:\n> Replying to [comment:327 saraedum]:\n> > Replying to [comment:324 embray]:\n> > > The latest Circle-CI build, however, timed out at\n> > > \n> > > \n> > > ```\n> > >  ---> 3753d48ddd74\n> > > Step 68/76 : RUN if [ x\"$ARTIFACT_BASE\" != x\"source-clean\" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi\n> > >  ---> Running in ea5237ee3bbd\n> > > Build timedout\n> > > ```\n\n> > Yes, build-from-clean times out on CircleCI. That's a known and documented issue.\n> \n> Is it?  I see your note in the Dockerfile about it making the images too big, but not about it timing out.  If it's a known issue then shouldn't we just disable it for now?\n\n\nIt's in the CircleCI configuration file:\n\n```\n# To make the build time not too excessive, we seed the build cache with\n# sagemath/sagemath-dev:develop. When basic SPKGs change, this does not help much,\n# still the full build does usually not exceed CircleCI's limits for open\n# source projcets (five hours on 2 vCPUs as of early 2018.)\n# You might want to try to build locally or with GitLab CI, see\n# `.gitlab-ci.yml` for more options.\n```",
    "created_at": "2018-08-17T13:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364594",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:333'></a>Replying to [comment:330 embray]:
> Replying to [comment:327 saraedum]:
> > Replying to [comment:324 embray]:
> > > The latest Circle-CI build, however, timed out at
> > > 
> > > 
> > > ```
> > >  ---> 3753d48ddd74
> > > Step 68/76 : RUN if [ x"$ARTIFACT_BASE" != x"source-clean" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi
> > >  ---> Running in ea5237ee3bbd
> > > Build timedout
> > > ```

> > Yes, build-from-clean times out on CircleCI. That's a known and documented issue.
> 
> Is it?  I see your note in the Dockerfile about it making the images too big, but not about it timing out.  If it's a known issue then shouldn't we just disable it for now?


It's in the CircleCI configuration file:

```
# To make the build time not too excessive, we seed the build cache with
# sagemath/sagemath-dev:develop. When basic SPKGs change, this does not help much,
# still the full build does usually not exceed CircleCI's limits for open
# source projcets (five hours on 2 vCPUs as of early 2018.)
# You might want to try to build locally or with GitLab CI, see
# `.gitlab-ci.yml` for more options.
```



---

archive/issue_comments_364595.json:
```json
{
    "body": "<a id='comment:334'></a>Replying to [comment:333 saraedum]:\n> Replying to [comment:330 embray]:\n> > Replying to [comment:327 saraedum]:\n> > > Replying to [comment:324 embray]:\n> > > > The latest Circle-CI build, however, timed out at\n> > > > \n> > > > \n> > > > ```\n> > > >  ---> 3753d48ddd74\n> > > > Step 68/76 : RUN if [ x\"$ARTIFACT_BASE\" != x\"source-clean\" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi\n> > > >  ---> Running in ea5237ee3bbd\n> > > > Build timedout\n> > > > ```\n\n> > > Yes, build-from-clean times out on CircleCI. That's a known and documented issue.\n> > \n> > Is it?  I see your note in the Dockerfile about it making the images too big, but not about it timing out.  If it's a known issue then shouldn't we just disable it for now?\n\n> \n> It's in the CircleCI configuration file:\n> \n> ```\n> # To make the build time not too excessive, we seed the build cache with\n> # sagemath/sagemath-dev:develop. When basic SPKGs change, this does not help much,\n> # still the full build does usually not exceed CircleCI's limits for open\n> # source projcets (five hours on 2 vCPUs as of early 2018.)\n> # You might want to try to build locally or with GitLab CI, see\n> # `.gitlab-ci.yml` for more options.\n> ```\n\n\nBut it says the wrong thing ouch.",
    "created_at": "2018-08-17T13:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364595",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:334'></a>Replying to [comment:333 saraedum]:
> Replying to [comment:330 embray]:
> > Replying to [comment:327 saraedum]:
> > > Replying to [comment:324 embray]:
> > > > The latest Circle-CI build, however, timed out at
> > > > 
> > > > 
> > > > ```
> > > >  ---> 3753d48ddd74
> > > > Step 68/76 : RUN if [ x"$ARTIFACT_BASE" != x"source-clean" ]; then         mkdir -p $HOME/patch         && find . -type f > $HOME/make-fast-rebuild-clean.manifest         && cat $HOME/make-fast-rebuild-clean.manifest $HOME/artifact-base.manifest | sort | uniq -u > $HOME/obsolete         && find . -type f -cnewer $HOME/artifact-base.manifest > $HOME/modified         && tar -cJf $HOME/patch/modified.tar.xz -T $HOME/modified         && cat $HOME/obsolete $HOME/modified | xz > $HOME/patch/modified.xz         && rm -rf $SAGE_ROOT         && mkdir -p $SAGE_ROOT         && mv $HOME/patch $SAGE_ROOT/;     fi
> > > >  ---> Running in ea5237ee3bbd
> > > > Build timedout
> > > > ```

> > > Yes, build-from-clean times out on CircleCI. That's a known and documented issue.
> > 
> > Is it?  I see your note in the Dockerfile about it making the images too big, but not about it timing out.  If it's a known issue then shouldn't we just disable it for now?

> 
> It's in the CircleCI configuration file:
> 
> ```
> # To make the build time not too excessive, we seed the build cache with
> # sagemath/sagemath-dev:develop. When basic SPKGs change, this does not help much,
> # still the full build does usually not exceed CircleCI's limits for open
> # source projcets (five hours on 2 vCPUs as of early 2018.)
> # You might want to try to build locally or with GitLab CI, see
> # `.gitlab-ci.yml` for more options.
> ```


But it says the wrong thing ouch.



---

archive/issue_comments_364596.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-08-17T13:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_364597.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-08-17T13:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_364598.json:
```json
{
    "body": "<a id='comment:336'></a>Replying to [comment:332 saraedum]:\n> Replying to [comment:331 embray]:\n> > Replying to [comment:326 saraedum]:\n> > > The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.\n> > > \n> > > As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of \"docker build\". But since \"docker build\" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.\n\n> > \n> > I still feel like we ought to be able to work around that somehow.  I don't see why we would want to do two complete build-from-cleans of the same exact commit just so they wind up with different tags on Docker Hub.\n\n> It's a bit weird, I agree. But that's how people do that on [GitLab](GitLab) CI. And usually builds don't take five hours, so it doesn't matter.\n\nUsually...\n\n> > I know you've thought about this more than I have so I'm probably missing something.  But my thinking is that until and unless Sage's \"develop\" branch is decoupled from its tags (something I think should happen but is not the case for now), we should edit the `.gitlab-ci.yml` and `.circleci/config.yml` to really only do build-from-clean on the `develop` branch (not even master).  If we want to then tag an image with a version number, we can take the current commit ID on develop, do `git describe --tags <commit id>`, and get the associated tag name.  Then use that to tag the image.\n\n> \n> This would break if the branch and the tag are not pushed at the same time. Also, it's reasonable that you don't want to push all tags but just protected tags, e.g., I don't want to push the tags that I just use to check that building from tags actually works.\n> \n> In short, I see your point but I'd rather leave it the way it is.\n\n\nWhy not build *just* the tags then?",
    "created_at": "2018-08-17T13:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364598",
    "user": "https://github.com/embray"
}
```

<a id='comment:336'></a>Replying to [comment:332 saraedum]:
> Replying to [comment:331 embray]:
> > Replying to [comment:326 saraedum]:
> > > The other two runs are one build-from-clean for the develop branch and one build-from-clean for the 8.4.beta1 tag. That's intentional and how [GitLab](GitLab) CI works. The rules don't determine that there are several triggers that come from the same commit. CircleCI does that and it is imho very annoying to work around.
> > > 
> > > As a result, the develop and the 8.4.beta1 tag on docker hub do not come from the same run of "docker build". But since "docker build" should be reproducible anyway (in particular if we build-from-clean) I don't see this as a problem apart from the wasted resources.

> > 
> > I still feel like we ought to be able to work around that somehow.  I don't see why we would want to do two complete build-from-cleans of the same exact commit just so they wind up with different tags on Docker Hub.

> It's a bit weird, I agree. But that's how people do that on [GitLab](GitLab) CI. And usually builds don't take five hours, so it doesn't matter.

Usually...

> > I know you've thought about this more than I have so I'm probably missing something.  But my thinking is that until and unless Sage's "develop" branch is decoupled from its tags (something I think should happen but is not the case for now), we should edit the `.gitlab-ci.yml` and `.circleci/config.yml` to really only do build-from-clean on the `develop` branch (not even master).  If we want to then tag an image with a version number, we can take the current commit ID on develop, do `git describe --tags <commit id>`, and get the associated tag name.  Then use that to tag the image.

> 
> This would break if the branch and the tag are not pushed at the same time. Also, it's reasonable that you don't want to push all tags but just protected tags, e.g., I don't want to push the tags that I just use to check that building from tags actually works.
> 
> In short, I see your point but I'd rather leave it the way it is.


Why not build *just* the tags then?



---

archive/issue_comments_364599.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-17T13:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364599",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364600.json:
```json
{
    "body": "<a id='comment:8'></a>Back to positive review. Only a minor documentation change.\n\nSo, I would not disable the CircleCI builds as it does not do any harm:\n\n* We won't configure CircleCI on our sagemath github repository (because it does not work reliably and we are building on [GitLab](GitLab) CI anyway.) so there is not going to be confusing messages there.\n* If somebody has a clone of our repo and CircleCI enabled, then these builds only happen if they push to master or develop or if they push a tag (something people usually don't do in forks).\n* Finally, it sometimes works. It really seems to be about how much load is on the actual machine that runs your docker container. I've seen builds complete after 4:59 or sometimes after 4:45. If we dropped a standard SPKG (python 2 eventually?) or Cython 2.9.0 or the next GCC is compiling faster for some reason, the builds are going to work reliably.\n\nThat said, #26085 should comunicate such things more clearly in the actual CI output.",
    "created_at": "2018-08-17T13:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364600",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:8'></a>Back to positive review. Only a minor documentation change.

So, I would not disable the CircleCI builds as it does not do any harm:

* We won't configure CircleCI on our sagemath github repository (because it does not work reliably and we are building on [GitLab](GitLab) CI anyway.) so there is not going to be confusing messages there.
* If somebody has a clone of our repo and CircleCI enabled, then these builds only happen if they push to master or develop or if they push a tag (something people usually don't do in forks).
* Finally, it sometimes works. It really seems to be about how much load is on the actual machine that runs your docker container. I've seen builds complete after 4:59 or sometimes after 4:45. If we dropped a standard SPKG (python 2 eventually?) or Cython 2.9.0 or the next GCC is compiling faster for some reason, the builds are going to work reliably.

That said, #26085 should comunicate such things more clearly in the actual CI output.



---

archive/issue_comments_364601.json:
```json
{
    "body": "<a id='comment:339'></a>Replying to [comment:336 embray]:\n> Why not build *just* the tags then?\n\n\nI would need some logic that decides whether this tag is a \"develop\" or a \"latest\" tag. And maybe even have to decide whether this is really \"later\" than what's currently there. It's certainly doable but I don't see enough of an advantage really.",
    "created_at": "2018-08-17T13:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364601",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:339'></a>Replying to [comment:336 embray]:
> Why not build *just* the tags then?


I would need some logic that decides whether this tag is a "develop" or a "latest" tag. And maybe even have to decide whether this is really "later" than what's currently there. It's certainly doable but I don't see enough of an advantage really.



---

archive/issue_comments_364602.json:
```json
{
    "body": "<a id='comment:340'></a>Replying to [comment:339 saraedum]:\n> Replying to [comment:336 embray]:\n> > Why not build *just* the tags then?\n\n> \n> I would need some logic that decides whether this tag is a \"develop\" or a \"latest\" tag. And maybe even have to decide whether this is really \"later\" than what's currently there. It's certainly doable but I don't see enough of an advantage really.\n\n\nI'm not sure what you mean by this.  Don't we have to do that anyways, somewhere, based on the version?",
    "created_at": "2018-08-17T14:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364602",
    "user": "https://github.com/embray"
}
```

<a id='comment:340'></a>Replying to [comment:339 saraedum]:
> Replying to [comment:336 embray]:
> > Why not build *just* the tags then?

> 
> I would need some logic that decides whether this tag is a "develop" or a "latest" tag. And maybe even have to decide whether this is really "later" than what's currently there. It's certainly doable but I don't see enough of an advantage really.


I'm not sure what you mean by this.  Don't we have to do that anyways, somewhere, based on the version?



---

archive/issue_comments_364603.json:
```json
{
    "body": "<a id='comment:341'></a>Replying to [comment:340 embray]:\n> Replying to [comment:339 saraedum]:\n> > Replying to [comment:336 embray]:\n> > > Why not build *just* the tags then?\n\n> > \n> > I would need some logic that decides whether this tag is a \"develop\" or a \"latest\" tag. And maybe even have to decide whether this is really \"later\" than what's currently there. It's certainly doable but I don't see enough of an advantage really.\n\n> \n> I'm not sure what you mean by this.  Don't we have to do that anyways, somewhere, based on the version?\n\n\nNo, the master branch pushes to the \"latest\" tag, the develop branch pushes to the \"develop\" tag. Or, was that not your question maybe?",
    "created_at": "2018-08-17T14:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364603",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:341'></a>Replying to [comment:340 embray]:
> Replying to [comment:339 saraedum]:
> > Replying to [comment:336 embray]:
> > > Why not build *just* the tags then?

> > 
> > I would need some logic that decides whether this tag is a "develop" or a "latest" tag. And maybe even have to decide whether this is really "later" than what's currently there. It's certainly doable but I don't see enough of an advantage really.

> 
> I'm not sure what you mean by this.  Don't we have to do that anyways, somewhere, based on the version?


No, the master branch pushes to the "latest" tag, the develop branch pushes to the "develop" tag. Or, was that not your question maybe?



---

archive/issue_comments_364604.json:
```json
{
    "body": "<a id='comment:2'></a>I just don't see why we should build the exact same thing up to three times every time there's a release.  I looked at what happened when 8.3 was released and that added up to more than 15 hours worth of building (some of it was because push-dockerhub-dev took 2.5 hours??)--all the exact same thing--three times.\n\nI don't know why we need to use the git branch/tag that happens to be being built to determine which docker-tag to push.\n\nEvery time 'develop' is updated a tag is created, and every time the tag is for a final release, 'master' also gets updated.  I don't like this process or the branch names but for now it is what it is.  Thus, it's only necessary to trigger a build-from-clean when a tag is created.  With docker you can re-tag the same image as many times as you want and push it to Docker Hub, and that can be done depending on what the version number in the tag is.\n\nSo what I'm proposing is to have one build, when a tag is created, with some `<version>` then,\n\n1. Tag the image `sagemath:<version>`; push\n2. If the version ends with `.betaN` or `.rcN`, re-tag the image `sagemath:develop`; push\n3. Else re-tag the image `sagemath:latest`; push\n\nOne build resulting in 2 docker-tags for the same image, each time.\n\nI think, theoretically, the way you do things currently makes sense, and might make sense to revert to at some point, but practically-speaking, right now, I don't see why we should do build-from-clean for anything but tags.",
    "created_at": "2018-08-17T14:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364604",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>I just don't see why we should build the exact same thing up to three times every time there's a release.  I looked at what happened when 8.3 was released and that added up to more than 15 hours worth of building (some of it was because push-dockerhub-dev took 2.5 hours??)--all the exact same thing--three times.

I don't know why we need to use the git branch/tag that happens to be being built to determine which docker-tag to push.

Every time 'develop' is updated a tag is created, and every time the tag is for a final release, 'master' also gets updated.  I don't like this process or the branch names but for now it is what it is.  Thus, it's only necessary to trigger a build-from-clean when a tag is created.  With docker you can re-tag the same image as many times as you want and push it to Docker Hub, and that can be done depending on what the version number in the tag is.

So what I'm proposing is to have one build, when a tag is created, with some `<version>` then,

1. Tag the image `sagemath:<version>`; push
2. If the version ends with `.betaN` or `.rcN`, re-tag the image `sagemath:develop`; push
3. Else re-tag the image `sagemath:latest`; push

One build resulting in 2 docker-tags for the same image, each time.

I think, theoretically, the way you do things currently makes sense, and might make sense to revert to at some point, but practically-speaking, right now, I don't see why we should do build-from-clean for anything but tags.



---

archive/issue_comments_364605.json:
```json
{
    "body": "<a id='comment:343'></a>Replying to [comment:342 embray]:\n> So what I'm proposing is to have one build, when a tag is created, with some `<version>` then,\n> \n> 1. Tag the image `sagemath:<version>`; push\n> 2. If the version ends with `.betaN` or `.rcN`, re-tag the image `sagemath:develop`; push\n  \nThat's not correct, all tags should go to sagemath:develop.\n\n> 3. Else re-tag the image `sagemath:latest`; push\n> \n> One build resulting in 2 docker-tags for the same image, each time.\n> \n> I think, theoretically, the way you do things currently makes sense, and might make sense to revert to at some point, but practically-speaking, right now, I don't see why we should do build-from-clean for anything but tags.\n\n\nIs it really an issue? It's a couple of hours of build time every week but it would be hardcoding knowledge about our release process which I don't like. Also, I'd like to add the release manager's integration branch to the list of build-from-clean at some point (though they should not go to the docker hub maybe) and then we'd need that one again anyway.",
    "created_at": "2018-08-23T16:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364605",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:343'></a>Replying to [comment:342 embray]:
> So what I'm proposing is to have one build, when a tag is created, with some `<version>` then,
> 
> 1. Tag the image `sagemath:<version>`; push
> 2. If the version ends with `.betaN` or `.rcN`, re-tag the image `sagemath:develop`; push
  
That's not correct, all tags should go to sagemath:develop.

> 3. Else re-tag the image `sagemath:latest`; push
> 
> One build resulting in 2 docker-tags for the same image, each time.
> 
> I think, theoretically, the way you do things currently makes sense, and might make sense to revert to at some point, but practically-speaking, right now, I don't see why we should do build-from-clean for anything but tags.


Is it really an issue? It's a couple of hours of build time every week but it would be hardcoding knowledge about our release process which I don't like. Also, I'd like to add the release manager's integration branch to the list of build-from-clean at some point (though they should not go to the docker hub maybe) and then we'd need that one again anyway.



---

archive/issue_comments_364606.json:
```json
{
    "body": "<a id='comment:4'></a>Also, there are some annoying races here (the following situation has happened to me when we worked with preemptible runners a lot.) With your proposed model the following could happen:\n\n1. Create git-tag 9.0.\n2. The CI fails for some reason, say a timeout pushing to docker hub.\n3. Create git-tag 9.1.beta0\n4. The CI pushes to sagemath:9.1.beta0 and sagemath:develop\n5. Somebody realizes that the sagemath:9.0 build is missing and presses \"retry\" in the CI.\n6. The CI pushes to sagemath:9.0, sagemath:latest, and sagemath:develop. Now sagemath:develop is not the latest beta.\n\nThis can't happen if you have develop branch \u2192 develop docker-tag; git-tag \u2192 docker-tag.",
    "created_at": "2018-08-23T16:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364606",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>Also, there are some annoying races here (the following situation has happened to me when we worked with preemptible runners a lot.) With your proposed model the following could happen:

1. Create git-tag 9.0.
2. The CI fails for some reason, say a timeout pushing to docker hub.
3. Create git-tag 9.1.beta0
4. The CI pushes to sagemath:9.1.beta0 and sagemath:develop
5. Somebody realizes that the sagemath:9.0 build is missing and presses "retry" in the CI.
6. The CI pushes to sagemath:9.0, sagemath:latest, and sagemath:develop. Now sagemath:develop is not the latest beta.

This can't happen if you have develop branch → develop docker-tag; git-tag → docker-tag.



---

archive/issue_events_062078.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-25T11:01:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24655#event-62078"
}
```



---

archive/issue_comments_364607.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-25T11:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364607",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_364608.json:
```json
{
    "body": "<a id='comment:6'></a>Somehow [7d85dc796](https://github.com/sagemath/sage/commit/7d85dc796c58c3de57401bc22d3587b94e205091) (\"Something related to the sphinxbuild seems to be leaking memory\") causes the docbuild to segfault on nix. Since the docbuild is running on 4 cores, as far as I can see the commit shouldn't actually change anything. Any idea?\n\n```\n[algebras ] loading pickled environment... not yet created\n[algebras ] building [inventory]: targets for 67 source files that are out of date\n[algebras ] updating environment: 67 added, 0 changed, 0 removed\n[algebras ] The HTML pages are in share/doc/sage/inventory/en/reference/algebras.\nBuild finished. The built documents can be found in /build/share/doc/sage/inventory/en/reference/algebras\n[combinat ] loading pickled environment... not yet created\n[combinat ] building [inventory]: targets for 367 source files that are out of date\n[combinat ] updating environment: 367 added, 0 changed, 0 removed\nError building the documentation.\nTraceback (most recent call last):\n  File \"/nix/store/9lvgqr20r7j7b6a4fmhw6n82spd9rafq-python-2.7.15-env/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/nix/store/9lvgqr20r7j7b6a4fmhw6n82spd9rafq-python-2.7.15-env/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 1712, in main\n    builder()\n  File \"/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 334, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 529, in _wrapper\n    build_many(build_ref_doc, L)\n  File \"/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 283, in build_many\n    ret = x.get(99999)\n  File \"/nix/store/9lvgqr20r7j7b6a4fmhw6n82spd9rafq-python-2.7.15-env/lib/python2.7/multiprocessing/pool.py\", line 572, in get\n    raise self._value\nException: ('Non-exception during docbuild: Segmentation fault', SignalError('Segmentation fault',))\n```",
    "created_at": "2018-08-29T11:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364608",
    "user": "https://github.com/timokau"
}
```

<a id='comment:6'></a>Somehow [7d85dc796](https://github.com/sagemath/sage/commit/7d85dc796c58c3de57401bc22d3587b94e205091) ("Something related to the sphinxbuild seems to be leaking memory") causes the docbuild to segfault on nix. Since the docbuild is running on 4 cores, as far as I can see the commit shouldn't actually change anything. Any idea?

```
[algebras ] loading pickled environment... not yet created
[algebras ] building [inventory]: targets for 67 source files that are out of date
[algebras ] updating environment: 67 added, 0 changed, 0 removed
[algebras ] The HTML pages are in share/doc/sage/inventory/en/reference/algebras.
Build finished. The built documents can be found in /build/share/doc/sage/inventory/en/reference/algebras
[combinat ] loading pickled environment... not yet created
[combinat ] building [inventory]: targets for 367 source files that are out of date
[combinat ] updating environment: 367 added, 0 changed, 0 removed
Error building the documentation.
Traceback (most recent call last):
  File "/nix/store/9lvgqr20r7j7b6a4fmhw6n82spd9rafq-python-2.7.15-env/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/nix/store/9lvgqr20r7j7b6a4fmhw6n82spd9rafq-python-2.7.15-env/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1712, in main
    builder()
  File "/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 334, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 529, in _wrapper
    build_many(build_ref_doc, L)
  File "/nix/store/yyarqmdxj1dmp65qv7mwm3sfrdlwmg8v-python2.7-sagelib-8.4.beta2/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 283, in build_many
    ret = x.get(99999)
  File "/nix/store/9lvgqr20r7j7b6a4fmhw6n82spd9rafq-python-2.7.15-env/lib/python2.7/multiprocessing/pool.py", line 572, in get
    raise self._value
Exception: ('Non-exception during docbuild: Segmentation fault', SignalError('Segmentation fault',))
```



---

archive/issue_comments_364609.json:
```json
{
    "body": "<a id='comment:7'></a>I agree that it shouldn't change anything. Can you get more details on the segfault in sphinx?",
    "created_at": "2018-08-29T12:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364609",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:7'></a>I agree that it shouldn't change anything. Can you get more details on the segfault in sphinx?



---

archive/issue_comments_364610.json:
```json
{
    "body": "<a id='comment:348'></a>Replying to [comment:347 saraedum]:\n> I agree that it shouldn't change anything. Can you get more details on the segfault in sphinx?\n\n\nYet for some reason the documentation built fine on 8.2.beta1 and still builds if I revert that commit. Really weird.\n\nI don't know, what kind of detail are you looking for? Do you happen to know how I can convince python/sphinx to give me a useful stacktrace?",
    "created_at": "2018-08-29T13:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364610",
    "user": "https://github.com/timokau"
}
```

<a id='comment:348'></a>Replying to [comment:347 saraedum]:
> I agree that it shouldn't change anything. Can you get more details on the segfault in sphinx?


Yet for some reason the documentation built fine on 8.2.beta1 and still builds if I revert that commit. Really weird.

I don't know, what kind of detail are you looking for? Do you happen to know how I can convince python/sphinx to give me a useful stacktrace?



---

archive/issue_comments_364611.json:
```json
{
    "body": "<a id='comment:9'></a>What's the motivation for all these changes to the docbuilder?\n\nPlease see https://groups.google.com/forum/#!topic/sage-packaging/VU4h8IWGFLA",
    "created_at": "2018-10-20T09:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364611",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>What's the motivation for all these changes to the docbuilder?

Please see https://groups.google.com/forum/#!topic/sage-packaging/VU4h8IWGFLA



---

archive/issue_comments_364612.json:
```json
{
    "body": "<a id='comment:0'></a>We were running out of RAM on CI machines while building the docs IIRC.",
    "created_at": "2018-10-20T12:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364612",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:0'></a>We were running out of RAM on CI machines while building the docs IIRC.



---

archive/issue_comments_364613.json:
```json
{
    "body": "<a id='comment:351'></a>Replying to [comment:350 saraedum]:\n> We were running out of RAM on CI machines while building the docs IIRC.\n\n\nIs that related to logging somehow? See also #26667.",
    "created_at": "2018-11-09T10:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364613",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:351'></a>Replying to [comment:350 saraedum]:
> We were running out of RAM on CI machines while building the docs IIRC.


Is that related to logging somehow? See also #26667.



---

archive/issue_comments_364614.json:
```json
{
    "body": "<a id='comment:2'></a>Seriously, yet another thing in Sage broken by this ticket...",
    "created_at": "2018-11-09T10:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364614",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Seriously, yet another thing in Sage broken by this ticket...



---

archive/issue_comments_364615.json:
```json
{
    "body": "<a id='comment:3'></a>That's not really helpful.",
    "created_at": "2018-11-09T12:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364615",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>That's not really helpful.



---

archive/issue_comments_364616.json:
```json
{
    "body": "<a id='comment:354'></a>Replying to [comment:351 jdemeyer]:\n> Replying to [comment:350 saraedum]:\n> > We were running out of RAM on CI machines while building the docs IIRC.\n\n> \n> Is that related to logging somehow? See also #26667.\n\nNo, the logging issues made us exceed stdout limits on CI systems. We are now truncating the output there. It would be nice if we could try to keep the output to stdout as small as reasonably possible as this makes the CI output much easier to work with but I see that this one was too extreme.",
    "created_at": "2018-11-09T12:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364616",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:354'></a>Replying to [comment:351 jdemeyer]:
> Replying to [comment:350 saraedum]:
> > We were running out of RAM on CI machines while building the docs IIRC.

> 
> Is that related to logging somehow? See also #26667.

No, the logging issues made us exceed stdout limits on CI systems. We are now truncating the output there. It would be nice if we could try to keep the output to stdout as small as reasonably possible as this makes the CI output much easier to work with but I see that this one was too extreme.



---

archive/issue_comments_364617.json:
```json
{
    "body": "<a id='comment:5'></a>I don't think it was \"too extreme\".  I think, perhaps more reasonably, there should be an option for verbosity level.  My general preference is somewhere between *zero* output or a small status progress message until and unless something goes wrong.  Detailed logs can go to files, which are more useful to have for debugging anyways (on pipelines the only inconvenience there is that I can't see the log \"at-a-glance\" on the web UI, but we have artifact downloads for that...)",
    "created_at": "2018-11-09T12:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364617",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>I don't think it was "too extreme".  I think, perhaps more reasonably, there should be an option for verbosity level.  My general preference is somewhere between *zero* output or a small status progress message until and unless something goes wrong.  Detailed logs can go to files, which are more useful to have for debugging anyways (on pipelines the only inconvenience there is that I can't see the log "at-a-glance" on the web UI, but we have artifact downloads for that...)



---

archive/issue_comments_364618.json:
```json
{
    "body": "<a id='comment:6'></a>I like the idea of just logging the more verbose stuff into a file. It should be printed to stdout on failure though, otherwise debugging a CI failure is annoying.",
    "created_at": "2018-11-09T19:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364618",
    "user": "https://github.com/timokau"
}
```

<a id='comment:6'></a>I like the idea of just logging the more verbose stuff into a file. It should be printed to stdout on failure though, otherwise debugging a CI failure is annoying.



---

archive/issue_comments_364619.json:
```json
{
    "body": "<a id='comment:7'></a>You probably know about this, but try \"make V=0\" in the sage build. Everything will go into logs only and you can print them on error.",
    "created_at": "2018-11-09T20:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24655#issuecomment-364619",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>You probably know about this, but try "make V=0" in the sage build. Everything will go into logs only and you can print them on error.
