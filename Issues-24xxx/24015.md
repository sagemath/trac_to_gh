# Issue 24015: fix libhomfly on OSX

archive/issues_023778.json:
```json
{
    "body": "as reported on [sage-devel ](https://groups.google.com/d/msg/sage-devel/bOG0Xg2HmvU/m1DsYpFwAQAJ) linking on OSX fails with \"duplicate symbol\" errors.\n\n```\n[libhomfly-1.0r2] libtool: link: cc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libhomfly.0.dylib  .libs/bound.o .libs/control.o .libs/dllink.o .libs/homfly.o .libs/knot.o .libs/model.o .libs/order.o .libs/poly.o   -lgc -L/Volumes/Sage/sage/local/lib  -g -O2 -Wl,-rpath -Wl,/Volumes/Sage/sage/local/lib   -install_name  /Volumes/Sage/sage/local/lib/libhomfly.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module -Wl,-exported_symbols_list,.libs/libhomfly-symbols.expsym\n[libhomfly-1.0r2] duplicate symbol _first in:\n[libhomfly-1.0r2]     .libs/bound.o\n[libhomfly-1.0r2]     .libs/control.o\n[libhomfly-1.0r2] duplicate symbol _list in:\n[libhomfly-1.0r2]     .libs/bound.o\n[libhomfly-1.0r2]     .libs/control.o\n...\n```\n\nthere is also an error in poly.c, where a non-void function returns nothing.\nThis is trivially fixed by\n\n```\ndiff --git a/lib/poly.c b/lib/poly.c\nindex 48e9a68..307d1de 100644\n--- a/lib/poly.c\n+++ b/lib/poly.c\n@@ -76,7 +76,7 @@ char *p_show(Poly *p)\n   {\n     fprintf(stream, \"0\");\n     fclose(stream);\n-    return;\n+    return NULL;\n   }\n \n   for (first = 1, pt = p->term, pend = pt+p->len; pt != pend; ++pt)\n```\n\n\n---\nAs it was being fixed, more problems were uncovered, and then a pesky GC bug, that went away after adding an explicit `GC_INIT()` call.\n\nIt appears that all is fixed by https://github.com/miguelmarco/libhomfly/pull/11\n\nthe (official!) tarball is here: \nhttps://github.com/miguelmarco/libhomfly/releases/download/1.02r4/libhomfly-1.02r4.tar.gz\n\nCC:  @embray @miguelmarco\n\nUpstream: Completely fixed; Fix reported upstream\n\nReviewer: Jeroen Demeyer\n\nAuthor: Dima Pasechnik\n\nBranch: f3349e0fa9584b4a37918fed0cd370bb1a3f4cbf\n\nCommit: f3349e0fa9584b4a37918fed0cd370bb1a3f4cbf\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24015\n\n",
    "closed_at": "2017-12-11T01:02:54Z",
    "created_at": "2017-10-11T22:25:30Z",
    "labels": [
        "component: packages: optional",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "fix libhomfly on OSX",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24015",
    "user": "https://github.com/dimpase"
}
```
as reported on [sage-devel ](https://groups.google.com/d/msg/sage-devel/bOG0Xg2HmvU/m1DsYpFwAQAJ) linking on OSX fails with "duplicate symbol" errors.

```
[libhomfly-1.0r2] libtool: link: cc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libhomfly.0.dylib  .libs/bound.o .libs/control.o .libs/dllink.o .libs/homfly.o .libs/knot.o .libs/model.o .libs/order.o .libs/poly.o   -lgc -L/Volumes/Sage/sage/local/lib  -g -O2 -Wl,-rpath -Wl,/Volumes/Sage/sage/local/lib   -install_name  /Volumes/Sage/sage/local/lib/libhomfly.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module -Wl,-exported_symbols_list,.libs/libhomfly-symbols.expsym
[libhomfly-1.0r2] duplicate symbol _first in:
[libhomfly-1.0r2]     .libs/bound.o
[libhomfly-1.0r2]     .libs/control.o
[libhomfly-1.0r2] duplicate symbol _list in:
[libhomfly-1.0r2]     .libs/bound.o
[libhomfly-1.0r2]     .libs/control.o
...
```

there is also an error in poly.c, where a non-void function returns nothing.
This is trivially fixed by

```
diff --git a/lib/poly.c b/lib/poly.c
index 48e9a68..307d1de 100644
--- a/lib/poly.c
+++ b/lib/poly.c
@@ -76,7 +76,7 @@ char *p_show(Poly *p)
   {
     fprintf(stream, "0");
     fclose(stream);
-    return;
+    return NULL;
   }
 
   for (first = 1, pt = p->term, pend = pt+p->len; pt != pend; ++pt)
```


---
As it was being fixed, more problems were uncovered, and then a pesky GC bug, that went away after adding an explicit `GC_INIT()` call.

It appears that all is fixed by https://github.com/miguelmarco/libhomfly/pull/11

the (official!) tarball is here: 
https://github.com/miguelmarco/libhomfly/releases/download/1.02r4/libhomfly-1.02r4.tar.gz

CC:  @embray @miguelmarco

Upstream: Completely fixed; Fix reported upstream

Reviewer: Jeroen Demeyer

Author: Dima Pasechnik

Branch: f3349e0fa9584b4a37918fed0cd370bb1a3f4cbf

Commit: f3349e0fa9584b4a37918fed0cd370bb1a3f4cbf

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24015





---

archive/issue_comments_332738.json:
```json
{
    "body": "<a id='comment:2'></a>I have a fix for the C code madness, now onto some cython trouble, hopefully minor:\n\n```\nsage -t --warn-long 231.9 src/sage/libs/homfly.pyx\n**********************************************************************\nFile \"src/sage/libs/homfly.pyx\", line 65, in sage.libs.homfly.homfly_polynomial_string\nFailed example:\n    from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly\nException raised:\n    Traceback (most recent call last):\n      File \"/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.homfly.homfly_polynomial_string[0]>\", line 1, in <module>\n        from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly\n    ImportError: dlopen(/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/libs/homfly.so, 2): Symbol not found: _fmemopen\n      Referenced from: /Volumes/Sage/sage/local/lib/libhomfly.0.dylib\n      Expected in: flat namespace\n     in /Volumes/Sage/sage/local/lib/libhomfly.0.dylib\n**********************************************************************\n```",
    "created_at": "2017-10-12T09:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332738",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>I have a fix for the C code madness, now onto some cython trouble, hopefully minor:

```
sage -t --warn-long 231.9 src/sage/libs/homfly.pyx
**********************************************************************
File "src/sage/libs/homfly.pyx", line 65, in sage.libs.homfly.homfly_polynomial_string
Failed example:
    from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly
Exception raised:
    Traceback (most recent call last):
      File "/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.homfly.homfly_polynomial_string[0]>", line 1, in <module>
        from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly
    ImportError: dlopen(/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/libs/homfly.so, 2): Symbol not found: _fmemopen
      Referenced from: /Volumes/Sage/sage/local/lib/libhomfly.0.dylib
      Expected in: flat namespace
     in /Volumes/Sage/sage/local/lib/libhomfly.0.dylib
**********************************************************************
```



---

archive/issue_comments_332739.json:
```json
{
    "body": "<a id='comment:3'></a>duh, there is no `fmemopen` on OSX, as simple as this...",
    "created_at": "2017-10-12T09:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332739",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>duh, there is no `fmemopen` on OSX, as simple as this...



---

archive/issue_comments_332740.json:
```json
{
    "body": "<a id='comment:4'></a>C changes proposed to upstream: https://github.com/miguelmarco/libhomfly/pull/8",
    "created_at": "2017-10-12T09:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332740",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>C changes proposed to upstream: https://github.com/miguelmarco/libhomfly/pull/8



---

archive/issue_comments_332741.json:
```json
{
    "body": "<a id='comment:5'></a>still, for OSX we need to update GC to a very recent version, see https://github.com/miguelmarco/libhomfly/pull/8 for details.",
    "created_at": "2017-10-20T18:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332741",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>still, for OSX we need to update GC to a very recent version, see https://github.com/miguelmarco/libhomfly/pull/8 for details.



---

archive/issue_comments_332742.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-06T09:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332742",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_332743.json:
```json
{
    "body": "<a id='comment:6'></a>the last remaining problem was the lack of `GC_INIT()` call in the library (something that is apparently not needed on Linux, but the docs\nsay that that some platforms might need it...)\n\nWith https://github.com/miguelmarco/libhomfly/pull/11\nit is all fixed, also on the current Sage's GC version on OSX.\n\n---\nNew commits:",
    "created_at": "2017-12-06T09:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332743",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>the last remaining problem was the lack of `GC_INIT()` call in the library (something that is apparently not needed on Linux, but the docs
say that that some platforms might need it...)

With https://github.com/miguelmarco/libhomfly/pull/11
it is all fixed, also on the current Sage's GC version on OSX.

---
New commits:



---

archive/issue_events_061041.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-12-06T09:50:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24015#event-61041"
}
```



---

archive/issue_comments_332744.json:
```json
{
    "body": "<a id='comment:7'></a>NB: the tarball is just a proof of concept, corresponding to commit b68b5b2aac2e89b17312208080562f5754d3da2d\non https://github.com/dimpase/libhomfly\n\nOnce the upstream is done with merging, we should get the official tarball...",
    "created_at": "2017-12-06T09:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332744",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>NB: the tarball is just a proof of concept, corresponding to commit b68b5b2aac2e89b17312208080562f5754d3da2d
on https://github.com/dimpase/libhomfly

Once the upstream is done with merging, we should get the official tarball...



---

archive/issue_comments_332745.json:
```json
{
    "body": "<a id='comment:8'></a>I made a new release upstream. It is https://github.com/miguelmarco/libhomfly/releases/tag/1.02r4\n\nThe tarball is at\nhttps://github.com/miguelmarco/libhomfly/archive/1.02r4.tar.gz",
    "created_at": "2017-12-06T11:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332745",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:8'></a>I made a new release upstream. It is https://github.com/miguelmarco/libhomfly/releases/tag/1.02r4

The tarball is at
https://github.com/miguelmarco/libhomfly/archive/1.02r4.tar.gz



---

archive/issue_comments_332746.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-06T12:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_332747.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-06T12:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332747",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_332748.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-06T12:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_332749.json:
```json
{
    "body": "<a id='comment:12'></a>I had to update the tarball from github by running `autoreconf -if` and re-tarring then.\n\nShould all be ready now.",
    "created_at": "2017-12-06T12:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332749",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>I had to update the tarball from github by running `autoreconf -if` and re-tarring then.

Should all be ready now.



---

archive/issue_comments_332750.json:
```json
{
    "body": "<a id='comment:13'></a>One little detail about `GC_INIT()`: it is not needed on the current Boehm GC master at https://github.com/ivmai/bdwgc, but is needed on few releases (7.4 and 7.6), as well as on the current Sage's version of GC.\n\nNo it builds with `SAGE_CHECK=yes`, and all the relevant Sage tests pass, too, on OSX 10.12 as well as on Linux.",
    "created_at": "2017-12-06T17:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332750",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>One little detail about `GC_INIT()`: it is not needed on the current Boehm GC master at https://github.com/ivmai/bdwgc, but is needed on few releases (7.4 and 7.6), as well as on the current Sage's version of GC.

No it builds with `SAGE_CHECK=yes`, and all the relevant Sage tests pass, too, on OSX 10.12 as well as on Linux.



---

archive/issue_comments_332751.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-07T17:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_332752.json:
```json
{
    "body": "<a id='comment:15'></a>OK, so now even the tarball is official!",
    "created_at": "2017-12-07T17:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332752",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>OK, so now even the tarball is official!



---

archive/issue_comments_332753.json:
```json
{
    "body": "<a id='comment:16'></a>I think we need a menu choice saying \"Fixes fully merged in the current upstream release\". :-)",
    "created_at": "2017-12-07T17:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332753",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>I think we need a menu choice saying "Fixes fully merged in the current upstream release". :-)



---

archive/issue_comments_332754.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-08T16:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332754",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061042.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:02:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24015#event-61042"
}
```



---

archive/issue_comments_332755.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24015#issuecomment-332755",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
