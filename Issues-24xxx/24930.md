# Issue 24930: py3: some cmp removal in pyx files

archive/issues_024693.json:
```json
{
    "body": "part of #16537\n\nKeywords: python3, richcmp\n\nBranch/Commit: 47c7694486866fad2c7bebd7127a7239864a6b04\n\nReviewer: Travis Scrimshaw, Jeroen Demeyer\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24930\n\n",
    "closed_at": "2018-03-22T19:23:35Z",
    "created_at": "2018-03-08T19:27:42Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: some cmp removal in pyx files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24930",
    "user": "https://github.com/fchapoton"
}
```
part of #16537

Keywords: python3, richcmp

Branch/Commit: 47c7694486866fad2c7bebd7127a7239864a6b04

Reviewer: Travis Scrimshaw, Jeroen Demeyer

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24930





---

archive/issue_comments_369015.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2018-03-08T19:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369015",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_369016.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-08T19:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369016",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369017.json:
```json
{
    "body": "Changing keywords from \"\" to \"python3, richcmp\".",
    "created_at": "2018-03-08T19:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369017",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "" to "python3, richcmp".



---

archive/issue_comments_369018.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-08T23:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369018",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_369019.json:
```json
{
    "body": "<a id='comment:4'></a>LGTM.",
    "created_at": "2018-03-08T23:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369019",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>LGTM.



---

archive/issue_comments_369020.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-03-09T08:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369020",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_369021.json:
```json
{
    "body": "<a id='comment:6'></a>1. In `__richcmp__`, you really should deal with the case of different classes. Typically, this is done by adding\n\n```\nif not isinstance(other, TheClassThatYouWant):\n    return NotImplemented\n```\nOtherwise, things might break sooner or later (see #19628 for an example of such breakage).\n\n2. Once you did check the class with `isinstance()`, you can do a cast. So replace\n\n```\ncdef TheClassThatYouWant x = other\n```\nby\n\n```\nx = <TheClassThatYouWant>other\n```\n(you can still add `cdef TheClassThatYouWant` but that is redundant).\n\n3. In the light of Cython 0.28, I would prefer to see\n\n```\ndef __richcmp__(TheClassThatYouWant self, other, int op)\n    ...\n```\ninstead of\n\n```\ndef __richcmp__(self, other, int op)\n    cdef TheClassThatYouWant s = self\n```\nIdeally, Cython should know that `self` is of type `TheClassThatYouWant`. But this is not the case due to a Cython bug which is fixed in version 0.28.",
    "created_at": "2018-03-09T09:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369021",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>1. In `__richcmp__`, you really should deal with the case of different classes. Typically, this is done by adding

```
if not isinstance(other, TheClassThatYouWant):
    return NotImplemented
```
Otherwise, things might break sooner or later (see #19628 for an example of such breakage).

2. Once you did check the class with `isinstance()`, you can do a cast. So replace

```
cdef TheClassThatYouWant x = other
```
by

```
x = <TheClassThatYouWant>other
```
(you can still add `cdef TheClassThatYouWant` but that is redundant).

3. In the light of Cython 0.28, I would prefer to see

```
def __richcmp__(TheClassThatYouWant self, other, int op)
    ...
```
instead of

```
def __richcmp__(self, other, int op)
    cdef TheClassThatYouWant s = self
```
Ideally, Cython should know that `self` is of type `TheClassThatYouWant`. But this is not the case due to a Cython bug which is fixed in version 0.28.



---

archive/issue_comments_369022.json:
```json
{
    "body": "<a id='comment:7'></a>4. I believe that the code in `intlist.pyx` is actually wrong. The second argument to `rich_to_bool()` must be -1, 0 or 1. If you want to support other integers, you need `rich_to_bool_sgn()`.",
    "created_at": "2018-03-09T09:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369022",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>4. I believe that the code in `intlist.pyx` is actually wrong. The second argument to `rich_to_bool()` must be -1, 0 or 1. If you want to support other integers, you need `rich_to_bool_sgn()`.



---

archive/issue_comments_369023.json:
```json
{
    "body": "<a id='comment:8'></a>FWIW this was my fix for intlist from my Python 3 branch:\n\n```diff\ndiff --git a/src/sage/stats/intlist.pyx b/src/sage/stats/intlist.pyx\nindex 6076475..c6d3f8f 100644\n--- a/src/sage/stats/intlist.pyx\n+++ b/src/sage/stats/intlist.pyx\n@@ -32,6 +32,7 @@ from libc.string cimport memcpy\n from cysignals.memory cimport sig_malloc, sig_free\n from cysignals.signals cimport sig_on, sig_off\n\n+from sage.structure.richcmp import rich_to_bool\n from sage.rings.integer import Integer\n from sage.finance.time_series cimport TimeSeries\n from cpython.bytes cimport PyBytes_FromStringAndSize, PyBytes_AsString\n@@ -116,7 +117,7 @@ cdef class IntList:\n             for i in range(self._length):\n                 self._values[i] = values[i]\n\n-    def __cmp__(self, _other):\n+    def __richcmp__(left, right, op):\n         \"\"\"\n         Compare self and other.  This has the same semantics\n         as list comparison.\n@@ -133,19 +134,22 @@ cdef class IntList:\n             sage: w == w\n             True\n         \"\"\"\n-        cdef IntList other\n+        cdef IntList l, r\n         cdef Py_ssize_t c, i\n         cdef int d\n-        if not isinstance(_other, IntList):\n-            _other = IntList(_other)\n-        other = _other\n-        for i in range(min(self._length, other._length)):\n-            d = self._values[i] - other._values[i]\n-            if d: return -1 if d < 0 else 1\n-        c = self._length - other._length\n-        if c < 0: return -1\n-        elif c > 0: return 1\n-        return 0\n+        if not isinstance(right, IntList):\n+            right = IntList(right)\n+        l, r = left, right\n+        for i in range(min(l._length, r._length)):\n+            d = l._values[i] - r._values[i]\n+            if d:\n+                return rich_to_bool(op, -1 if d < 0 else 1)\n+        c = l._length - r._length\n+        if c < 0:\n+            return rich_to_bool(op, -1)\n+        elif c > 0:\n+            return rich_to_bool(op, +1)\n+        return rich_to_bool(op, 0)\n```",
    "created_at": "2018-03-09T10:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369023",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>FWIW this was my fix for intlist from my Python 3 branch:

```diff
diff --git a/src/sage/stats/intlist.pyx b/src/sage/stats/intlist.pyx
index 6076475..c6d3f8f 100644
--- a/src/sage/stats/intlist.pyx
+++ b/src/sage/stats/intlist.pyx
@@ -32,6 +32,7 @@ from libc.string cimport memcpy
 from cysignals.memory cimport sig_malloc, sig_free
 from cysignals.signals cimport sig_on, sig_off

+from sage.structure.richcmp import rich_to_bool
 from sage.rings.integer import Integer
 from sage.finance.time_series cimport TimeSeries
 from cpython.bytes cimport PyBytes_FromStringAndSize, PyBytes_AsString
@@ -116,7 +117,7 @@ cdef class IntList:
             for i in range(self._length):
                 self._values[i] = values[i]

-    def __cmp__(self, _other):
+    def __richcmp__(left, right, op):
         """
         Compare self and other.  This has the same semantics
         as list comparison.
@@ -133,19 +134,22 @@ cdef class IntList:
             sage: w == w
             True
         """
-        cdef IntList other
+        cdef IntList l, r
         cdef Py_ssize_t c, i
         cdef int d
-        if not isinstance(_other, IntList):
-            _other = IntList(_other)
-        other = _other
-        for i in range(min(self._length, other._length)):
-            d = self._values[i] - other._values[i]
-            if d: return -1 if d < 0 else 1
-        c = self._length - other._length
-        if c < 0: return -1
-        elif c > 0: return 1
-        return 0
+        if not isinstance(right, IntList):
+            right = IntList(right)
+        l, r = left, right
+        for i in range(min(l._length, r._length)):
+            d = l._values[i] - r._values[i]
+            if d:
+                return rich_to_bool(op, -1 if d < 0 else 1)
+        c = l._length - r._length
+        if c < 0:
+            return rich_to_bool(op, -1)
+        elif c > 0:
+            return rich_to_bool(op, +1)
+        return rich_to_bool(op, 0)
```



---

archive/issue_comments_369024.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-09T18:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369025.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-09T18:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369025",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_369026.json:
```json
{
    "body": "<a id='comment:11'></a>There is an rc of Cython 0.28 (#24111), so you might as well wait for that.",
    "created_at": "2018-03-11T10:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369026",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>There is an rc of Cython 0.28 (#24111), so you might as well wait for that.



---

archive/issue_comments_369027.json:
```json
{
    "body": "<a id='comment:12'></a>Well, time is flying, and there is no really good reason to wait..",
    "created_at": "2018-03-11T19:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369027",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>Well, time is flying, and there is no really good reason to wait..



---

archive/issue_comments_369028.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-13T14:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369028",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_369029.json:
```json
{
    "body": "<a id='comment:14'></a>It looks good to me--we can revisit some of the `__richcmp__ -> __eq__` rewrites once we can fully depend on Cython 0.28.",
    "created_at": "2018-03-13T14:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369029",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>It looks good to me--we can revisit some of the `__richcmp__ -> __eq__` rewrites once we can fully depend on Cython 0.28.



---

archive/issue_events_062573.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-22T19:23:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24930#event-62573"
}
```



---

archive/issue_comments_369030.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-22T19:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24930#issuecomment-369030",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
