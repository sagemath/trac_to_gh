# Issue 24343: py3: miscellaneous fixes to sage.doctest

archive/issues_024106.json:
```json
{
    "body": "These are most of the fixes I've made so far to the `sage.doctest` package.  It's probably not exhaustive, but these are at least the main bug fixes that were needed to get it working (and for its own self-tests to pass, though that also requires fixes in other modules).\n\nCC:  @fchapoton\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nBranch: 2155133fa6f901ac92ea0ba46ee5ea403ee4f18f\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24343\n\n",
    "closed_at": "2018-03-21T06:19:01Z",
    "created_at": "2017-12-08T11:41:31Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: miscellaneous fixes to sage.doctest",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24343",
    "user": "https://github.com/embray"
}
```
These are most of the fixes I've made so far to the `sage.doctest` package.  It's probably not exhaustive, but these are at least the main bug fixes that were needed to get it working (and for its own self-tests to pass, though that also requires fixes in other modules).

CC:  @fchapoton

Reviewer: Jeroen Demeyer

Author: Erik Bray

Branch: 2155133fa6f901ac92ea0ba46ee5ea403ee4f18f

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24343





---

archive/issue_comments_359381.json:
```json
{
    "body": "<a id='comment:1'></a>This won't be \"ready for review\" I think until some of its dependencies are dealt with first, but in the meantime if you want to try using these fixes it should prove helpful.",
    "created_at": "2017-12-08T11:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359381",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>This won't be "ready for review" I think until some of its dependencies are dealt with first, but in the meantime if you want to try using these fixes it should prove helpful.



---

archive/issue_comments_359382.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-17T09:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359382",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_359383.json:
```json
{
    "body": "<a id='comment:3'></a>does not apply",
    "created_at": "2018-01-23T15:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359383",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>does not apply



---

archive/issue_comments_359384.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2018-02-12T14:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359384",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_359385.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2018-02-12T14:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359385",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_359386.json:
```json
{
    "body": "<a id='comment:6'></a>Working on rebasing this.  This used to have all tests passing on Python 3, and still appears to there, but breaks some things on Python 2 now (I think it used to work there but now I'm not sure, it's been too long).",
    "created_at": "2018-02-12T16:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359386",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Working on rebasing this.  This used to have all tests passing on Python 3, and still appears to there, but breaks some things on Python 2 now (I think it used to work there but now I'm not sure, it's been too long).



---

archive/issue_comments_359387.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-12T17:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359387",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_359388.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-12T17:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359388",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_359389.json:
```json
{
    "body": "<a id='comment:8'></a>This has all the tests passing on Python 2, as well as on Python 3 *except* for a test that was added recently to `FileDocTestSource.create_doctests` (the \"bitness\" test).  I'll worry about that later; it's not really a substantive failure.",
    "created_at": "2018-02-12T17:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359389",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>This has all the tests passing on Python 2, as well as on Python 3 *except* for a test that was added recently to `FileDocTestSource.create_doctests` (the "bitness" test).  I'll worry about that later; it's not really a substantive failure.



---

archive/issue_comments_359390.json:
```json
{
    "body": "<a id='comment:9'></a>There is a lot of stuff happening in this branch. I would appreciate if this could be split up in smaller independent pieces, especially where you are making structural changes.",
    "created_at": "2018-02-13T08:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359390",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>There is a lot of stuff happening in this branch. I would appreciate if this could be split up in smaller independent pieces, especially where you are making structural changes.



---

archive/issue_comments_359391.json:
```json
{
    "body": "<a id='comment:10'></a>When trying to use this branch in python3 to doctest a file, I get lots and lots of trivial doctests failures, typically like this one:\n\n```\nFile \"src/sage/combinat/yang_baxter_graph.py\", line 576, in sage.combinat.yang_baxter_graph.YangBaxterGraph_partition.__init__\nFailed example:\n    Y = YangBaxterGraph(partition=[3,2,1]); Y\nExpected:\n    Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)\nGot:\n    b'Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)'\n```",
    "created_at": "2018-02-15T13:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359391",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>When trying to use this branch in python3 to doctest a file, I get lots and lots of trivial doctests failures, typically like this one:

```
File "src/sage/combinat/yang_baxter_graph.py", line 576, in sage.combinat.yang_baxter_graph.YangBaxterGraph_partition.__init__
Failed example:
    Y = YangBaxterGraph(partition=[3,2,1]); Y
Expected:
    Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)
Got:
    b'Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)'
```



---

archive/issue_comments_359392.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 chapoton]:\n> When trying to use this branch in python3 to doctest a file, I get lots and lots of trivial doctests failures, typically like this one:\n> \n> ```\n> File \"src/sage/combinat/yang_baxter_graph.py\", line 576, in sage.combinat.yang_baxter_graph.YangBaxterGraph_partition.__init__\n> Failed example:\n>     Y = YangBaxterGraph(partition=[3,2,1]); Y\n> Expected:\n>     Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)\n> Got:\n>     b'Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)'\n> ```\n\n\nThat's likely. This is related to `sage.repl.rich_ouput.backend_test`.  I have fixes to that coming in a separate ticket.",
    "created_at": "2018-02-15T15:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359392",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Replying to [comment:10 chapoton]:
> When trying to use this branch in python3 to doctest a file, I get lots and lots of trivial doctests failures, typically like this one:
> 
> ```
> File "src/sage/combinat/yang_baxter_graph.py", line 576, in sage.combinat.yang_baxter_graph.YangBaxterGraph_partition.__init__
> Failed example:
>     Y = YangBaxterGraph(partition=[3,2,1]); Y
> Expected:
>     Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)
> Got:
>     b'Yang-Baxter graph of [3, 2, 1], with top vertex (0, 1, 0, 2, 1, 0)'
> ```


That's likely. This is related to `sage.repl.rich_ouput.backend_test`.  I have fixes to that coming in a separate ticket.



---

archive/issue_comments_359393.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:9 jdemeyer]:\n> There is a lot of stuff happening in this branch. I would appreciate if this could be split up in smaller independent pieces, especially where you are making structural changes.\n\n\nYou are welcome to look at the [individual commits](https://git.sagemath.org/sage.git/log?q=e6cae6d88dc018f6421a91fc4d9e073ab138644e..7dd7f9af21846d5d4d98815eff3cc409327dc793&h=7dd7f9af21846d5d4d98815eff3cc409327dc793&qt=range) if that would be easier.",
    "created_at": "2018-02-15T15:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359393",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Replying to [comment:9 jdemeyer]:
> There is a lot of stuff happening in this branch. I would appreciate if this could be split up in smaller independent pieces, especially where you are making structural changes.


You are welcome to look at the [individual commits](https://git.sagemath.org/sage.git/log?q=e6cae6d88dc018f6421a91fc4d9e073ab138644e..7dd7f9af21846d5d4d98815eff3cc409327dc793&h=7dd7f9af21846d5d4d98815eff3cc409327dc793&qt=range) if that would be easier.



---

archive/issue_comments_359394.json:
```json
{
    "body": "<a id='comment:13'></a>FWIW I opened this ticket *two months ago* and actually was using these fixes well before I opened the ticket to run the tests on Python 3, with consistent success (in that the test framework completes test runs and correctly reports passes and failures).",
    "created_at": "2018-02-15T16:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359394",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>FWIW I opened this ticket *two months ago* and actually was using these fixes well before I opened the ticket to run the tests on Python 3, with consistent success (in that the test framework completes test runs and correctly reports passes and failures).



---

archive/issue_comments_359395.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:12 embray]:\n> You are welcome to look at the individual commits if that would be easier.\n\n\nThe question is: am I supposed to review individual commits or the branch as a whole? I'm fine with doing either of those two extremes but rather not a mixture (I don't want to *look* at individual commits when you want me to *review* the branch as a whole).",
    "created_at": "2018-02-15T16:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359395",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:12 embray]:
> You are welcome to look at the individual commits if that would be easier.


The question is: am I supposed to review individual commits or the branch as a whole? I'm fine with doing either of those two extremes but rather not a mixture (I don't want to *look* at individual commits when you want me to *review* the branch as a whole).



---

archive/issue_comments_359396.json:
```json
{
    "body": "<a id='comment:15'></a>...and if you really want me to review individual commits, I would prefer to split this over multiple tickets.",
    "created_at": "2018-02-15T16:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359396",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>...and if you really want me to review individual commits, I would prefer to split this over multiple tickets.



---

archive/issue_comments_359397.json:
```json
{
    "body": "<a id='comment:16'></a>I'm not sure what the distinction is.  There are literally thousands of things that need to be fixed for Python 3. Grouping up large sets of fixes on a per-module or per-package basis should get things done more quickly and with fewer merge problems, than if they were spread across multiple tickets of \"miscellaneous fixes 1\", \"miscellaneous fixes 2\", etc.\n\nI'm pretty frustrated (and I believe Fr\u00e9d\u00e9ric is too) that I've actually already fixed like 50% of the tests on Python 3 but have all the work squirreled away in my private branch, often resulting in duplicate effort (e.g. #24739).  And the biggest bottleneck now is just the rate at which I can open logical tickets.\n\nIf you want to review some set of changes I don't see what difference it makes for you.",
    "created_at": "2018-02-15T16:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359397",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>I'm not sure what the distinction is.  There are literally thousands of things that need to be fixed for Python 3. Grouping up large sets of fixes on a per-module or per-package basis should get things done more quickly and with fewer merge problems, than if they were spread across multiple tickets of "miscellaneous fixes 1", "miscellaneous fixes 2", etc.

I'm pretty frustrated (and I believe Frédéric is too) that I've actually already fixed like 50% of the tests on Python 3 but have all the work squirreled away in my private branch, often resulting in duplicate effort (e.g. #24739).  And the biggest bottleneck now is just the rate at which I can open logical tickets.

If you want to review some set of changes I don't see what difference it makes for you.



---

archive/issue_comments_359398.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 embray]:\n> Grouping up large sets of fixes on a per-module or per-package basis should get things done more quickly and with fewer merge problems, than if they were spread across multiple tickets of \"miscellaneous fixes 1\", \"miscellaneous fixes 2\", etc.\n\n\nMy opinion is the opposite. I find it easier to deal with many small isolated tickets instead of single large tickets. Mainly because it will allow easy things to pass immediately.\n\nSpeaking of frustration... I find your refusal to split up tickets frustrating. I'm not even asking you to split up the tickets. I'm asking for permission to split up your tickets.",
    "created_at": "2018-02-15T16:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359398",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:16 embray]:
> Grouping up large sets of fixes on a per-module or per-package basis should get things done more quickly and with fewer merge problems, than if they were spread across multiple tickets of "miscellaneous fixes 1", "miscellaneous fixes 2", etc.


My opinion is the opposite. I find it easier to deal with many small isolated tickets instead of single large tickets. Mainly because it will allow easy things to pass immediately.

Speaking of frustration... I find your refusal to split up tickets frustrating. I'm not even asking you to split up the tickets. I'm asking for permission to split up your tickets.



---

archive/issue_comments_359399.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 embray]:\n> I'm not sure what the distinction is.\n\n\nThe distinction is mainly whether the commits are logically/functionally independent or not. If you have a first commit which is broken and then commit 2 and commit 3 to fix issues with the first commit, it makes no sense to review by commit. If on the other hand, every commit fixes a single issue, it does make sense to review by commit.",
    "created_at": "2018-02-15T16:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359399",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:16 embray]:
> I'm not sure what the distinction is.


The distinction is mainly whether the commits are logically/functionally independent or not. If you have a first commit which is broken and then commit 2 and commit 3 to fix issues with the first commit, it makes no sense to review by commit. If on the other hand, every commit fixes a single issue, it does make sense to review by commit.



---

archive/issue_comments_359400.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 jdemeyer]:\n> Replying to [comment:16 embray]:\n> > Grouping up large sets of fixes on a per-module or per-package basis should get things done more quickly and with fewer merge problems, than if they were spread across multiple tickets of \"miscellaneous fixes 1\", \"miscellaneous fixes 2\", etc.\n\n> \n> My opinion is the opposite. I find it easier to deal with many small isolated tickets instead of single large tickets. Mainly because it will allow easy things to pass immediately.\n> \n> Speaking of frustration... I find your refusal to split up tickets frustrating. I'm not even asking you to split up the tickets. I'm asking for permission to split up your tickets.\n\n\nHey, if *you're* willing to do it be my guest.  I don't see what you'd want to spend the time.",
    "created_at": "2018-02-15T16:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359400",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Replying to [comment:17 jdemeyer]:
> Replying to [comment:16 embray]:
> > Grouping up large sets of fixes on a per-module or per-package basis should get things done more quickly and with fewer merge problems, than if they were spread across multiple tickets of "miscellaneous fixes 1", "miscellaneous fixes 2", etc.

> 
> My opinion is the opposite. I find it easier to deal with many small isolated tickets instead of single large tickets. Mainly because it will allow easy things to pass immediately.
> 
> Speaking of frustration... I find your refusal to split up tickets frustrating. I'm not even asking you to split up the tickets. I'm asking for permission to split up your tickets.


Hey, if *you're* willing to do it be my guest.  I don't see what you'd want to spend the time.



---

archive/issue_comments_359401.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 jdemeyer]:\n> Replying to [comment:16 embray]:\n> > I'm not sure what the distinction is.\n\n> \n> The distinction is mainly whether the commits are logically/functionally independent or not. If you have a first commit which is broken and then commit 2 and commit 3 to fix issues with the first commit, it makes no sense to review by commit. If on the other hand, every commit fixes a single issue, it does make sense to review by commit.\n\n\nThat isn't really the case here.  I believe there might be 1 or 2 fixup commits added late to this branch because it wasn't passing on Python 2, but those are actually worth keeping as separate commits since I felt they called out specific Python 2/3 differences that were worth making note of.\n\nYou should know by now that I know how to use rebase effectively and usually try to organize my commits in a logical fashion, and also that I frequently write detailed commit messages about what is being changed and why.  I really don't understand why you care.  If it were me I would just look at the changes--make note of any specific ones I want to comment on, and that's that.\n\nOr just even glance over briefly to make sure nothing stands out, and then give you the benefit of the doubt.  You don't have to scrutinize every single change everyone makes.  Nobody has time for that.",
    "created_at": "2018-02-15T16:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359401",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 embray]:
> > I'm not sure what the distinction is.

> 
> The distinction is mainly whether the commits are logically/functionally independent or not. If you have a first commit which is broken and then commit 2 and commit 3 to fix issues with the first commit, it makes no sense to review by commit. If on the other hand, every commit fixes a single issue, it does make sense to review by commit.


That isn't really the case here.  I believe there might be 1 or 2 fixup commits added late to this branch because it wasn't passing on Python 2, but those are actually worth keeping as separate commits since I felt they called out specific Python 2/3 differences that were worth making note of.

You should know by now that I know how to use rebase effectively and usually try to organize my commits in a logical fashion, and also that I frequently write detailed commit messages about what is being changed and why.  I really don't understand why you care.  If it were me I would just look at the changes--make note of any specific ones I want to comment on, and that's that.

Or just even glance over briefly to make sure nothing stands out, and then give you the benefit of the doubt.  You don't have to scrutinize every single change everyone makes.  Nobody has time for that.



---

archive/issue_comments_359402.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 embray]:\n> You don't have to scrutinize every single change everyone makes.\n\n\nI almost feel bad to say that I am trying to do exactly that.",
    "created_at": "2018-02-15T16:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359402",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [comment:20 embray]:
> You don't have to scrutinize every single change everyone makes.


I almost feel bad to say that I am trying to do exactly that.



---

archive/issue_comments_359403.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 jdemeyer]:\n> Replying to [comment:20 embray]:\n> > You don't have to scrutinize every single change everyone makes.\n\n> \n> I almost feel bad to say that I am trying to do exactly that. \n\n\nAnd I appreciate that, because your scrutiny promotes a high level of quality.  But I don't know how you then find time for much else.  I'm a strong proponent of careful code review, but sometimes you also have to pick your battles, or trust other people to review things.  I used to review every single line change to Astropy when we started the project, but as it grew there was no way I could keep up, especially as large modules grew in which different people had more expertise, and I learned to trust them to do their best in terms of quality assurance.  I still give most changes a glance over in case there are *specific* issues I'm concerned about.\n\nAnyways, you do what you want, and believe it or not I try my best to keep my changes reasonably atomic and logical (though this becomes difficult when making mass sets of minor fixes).  And I'll do what I can to make things easier.  I just wish I understood your process better and why you find it helpful to review a whole branch versus individual commits.\n\nTo me, looking over the full merge commit is obviously the first pass, and if there are individual changes I have more questions about I'll often drill more into the history of that file to find the individual commit where that change was made.\n\nI agree this becomes more difficult if there are lots of commits combined that affect multiple files simultaneously.  I wouldn't often combine changes like that into a single ticket (hence why I broke up #24740 and #24741, and considered actually breaking the latter into two more tickets).  In this case, however, all the changes are fairly small an localized.",
    "created_at": "2018-02-15T16:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359403",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 embray]:
> > You don't have to scrutinize every single change everyone makes.

> 
> I almost feel bad to say that I am trying to do exactly that. 


And I appreciate that, because your scrutiny promotes a high level of quality.  But I don't know how you then find time for much else.  I'm a strong proponent of careful code review, but sometimes you also have to pick your battles, or trust other people to review things.  I used to review every single line change to Astropy when we started the project, but as it grew there was no way I could keep up, especially as large modules grew in which different people had more expertise, and I learned to trust them to do their best in terms of quality assurance.  I still give most changes a glance over in case there are *specific* issues I'm concerned about.

Anyways, you do what you want, and believe it or not I try my best to keep my changes reasonably atomic and logical (though this becomes difficult when making mass sets of minor fixes).  And I'll do what I can to make things easier.  I just wish I understood your process better and why you find it helpful to review a whole branch versus individual commits.

To me, looking over the full merge commit is obviously the first pass, and if there are individual changes I have more questions about I'll often drill more into the history of that file to find the individual commit where that change was made.

I agree this becomes more difficult if there are lots of commits combined that affect multiple files simultaneously.  I wouldn't often combine changes like that into a single ticket (hence why I broke up #24740 and #24741, and considered actually breaking the latter into two more tickets).  In this case, however, all the changes are fairly small an localized.



---

archive/issue_comments_359404.json:
```json
{
    "body": "<a id='comment:23'></a>To put things more constructively, if you can give me some idea how you prefer to see changes logically split into individual tickets, I can certainly keep that in mind in the future.\n\nIt's just that for the Python 3 fixes there are so many thousands of little changes, I thought it would be simplest (and least likely to produce conflicts) to group together large sets of small fixes by package, or in some cases by individual module.\n\nObviously if I require some more substantive change (such as new features) I can, and have, made separate tickets for that.  Beyond that I'm not really sure.",
    "created_at": "2018-02-15T17:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359404",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>To put things more constructively, if you can give me some idea how you prefer to see changes logically split into individual tickets, I can certainly keep that in mind in the future.

It's just that for the Python 3 fixes there are so many thousands of little changes, I thought it would be simplest (and least likely to produce conflicts) to group together large sets of small fixes by package, or in some cases by individual module.

Obviously if I require some more substantive change (such as new features) I can, and have, made separate tickets for that.  Beyond that I'm not really sure.



---

archive/issue_comments_359405.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 embray]:\n> To put things more constructively, if you can give me some idea how you prefer to see changes logically split into individual tickets, I can certainly keep that in mind in the future.\n\n\nBroadly speaking, there are 3 level of changes:\n\n1. Small isolated changes and basic clean-up, e.g. adding `str/bytes` conversion, using `with(open())`, fixing imports, style changes.\n\n2. Non-trivial changes which do not change user-visible functionality, i.e. refactoring.\n\n3. Changes to user-visible functionality.\n\nFor me, a ticket should ideally work on precisely one of these levels. Level 1 changes can be mostly approved on sight. If a ticket consists of 80% level 1 changes and 20% level 2 changes, then it can be hard to understand the level 2 changes because the many level 1 changes are just distracting the diff.\n\n> large sets of small fixes\n\n\nIMHO, this ticket contains several non-small (level 2 in my above classification) changes.",
    "created_at": "2018-02-16T14:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359405",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:23 embray]:
> To put things more constructively, if you can give me some idea how you prefer to see changes logically split into individual tickets, I can certainly keep that in mind in the future.


Broadly speaking, there are 3 level of changes:

1. Small isolated changes and basic clean-up, e.g. adding `str/bytes` conversion, using `with(open())`, fixing imports, style changes.

2. Non-trivial changes which do not change user-visible functionality, i.e. refactoring.

3. Changes to user-visible functionality.

For me, a ticket should ideally work on precisely one of these levels. Level 1 changes can be mostly approved on sight. If a ticket consists of 80% level 1 changes and 20% level 2 changes, then it can be hard to understand the level 2 changes because the many level 1 changes are just distracting the diff.

> large sets of small fixes


IMHO, this ticket contains several non-small (level 2 in my above classification) changes.



---

archive/issue_comments_359406.json:
```json
{
    "body": "<a id='comment:25'></a>does not apply",
    "created_at": "2018-02-19T07:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359406",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>does not apply



---

archive/issue_comments_359407.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-19T07:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359407",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_359408.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-19T10:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359408",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_359409.json:
```json
{
    "body": "<a id='comment:27'></a>New commits:",
    "created_at": "2018-02-19T10:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359409",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>New commits:



---

archive/issue_comments_359410.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-19T13:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359410",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_359411.json:
```json
{
    "body": "<a id='comment:29'></a>Can you justify this change:\n\n```diff\n-        from six.moves.queue import Empty\n-        try:\n-            self.result = self.result_queue.get(block=False)\n-        except Empty:\n-            self.result = (0, DictAsObject(dict(err='noresult')))\n-        del self.result_queue\n-\n-        self.outtmpfile.seek(0)\n-        self.output = self.outtmpfile.read()\n-        del self.outtmpfile\n+        if self.result_queue is not None:\n+            from six.moves.queue import Empty\n+            try:\n+                self.result = self.result_queue.get(block=False)\n+            except Empty:\n+                self.result = (0, DictAsObject(dict(err='noresult')))\n+\n+            self.result_queue = None\n+\n+        if self.outtmpfile is not None:\n+            self.outtmpfile.seek(0)\n+            self.output = bytes_to_str(self.outtmpfile.read())\n+            self.outtmpfile.close()\n+            self.outtmpfile = None\n```\nWhat was wrong with the old code?",
    "created_at": "2018-02-19T13:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359411",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Can you justify this change:

```diff
-        from six.moves.queue import Empty
-        try:
-            self.result = self.result_queue.get(block=False)
-        except Empty:
-            self.result = (0, DictAsObject(dict(err='noresult')))
-        del self.result_queue
-
-        self.outtmpfile.seek(0)
-        self.output = self.outtmpfile.read()
-        del self.outtmpfile
+        if self.result_queue is not None:
+            from six.moves.queue import Empty
+            try:
+                self.result = self.result_queue.get(block=False)
+            except Empty:
+                self.result = (0, DictAsObject(dict(err='noresult')))
+
+            self.result_queue = None
+
+        if self.outtmpfile is not None:
+            self.outtmpfile.seek(0)
+            self.output = bytes_to_str(self.outtmpfile.read())
+            self.outtmpfile.close()
+            self.outtmpfile = None
```
What was wrong with the old code?



---

archive/issue_comments_359412.json:
```json
{
    "body": "<a id='comment:30'></a>I don't remember exactly, but I'm sure there was a good reason.  Certainly I know that I didn't like that the old code was *deleting* attributes rather than setting them to `None`.  I believe there were reasons (e.g. related to repeated calls of the same method) that it was saner to set these attributes to `None` when they were finished being used rather than deleting them.",
    "created_at": "2018-02-19T13:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359412",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>I don't remember exactly, but I'm sure there was a good reason.  Certainly I know that I didn't like that the old code was *deleting* attributes rather than setting them to `None`.  I believe there were reasons (e.g. related to repeated calls of the same method) that it was saner to set these attributes to `None` when they were finished being used rather than deleting them.



---

archive/issue_comments_359413.json:
```json
{
    "body": "<a id='comment:31'></a>git history was rewritten in #24772, so this should be rebased.",
    "created_at": "2018-02-23T15:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359413",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>git history was rewritten in #24772, so this should be rebased.



---

archive/issue_comments_359414.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-23T15:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359414",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_359415.json:
```json
{
    "body": "<a id='comment:32'></a>Yeah, I was about to take care of that.",
    "created_at": "2018-02-23T15:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359415",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Yeah, I was about to take care of that.



---

archive/issue_comments_359416.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-23T15:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359416",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_359417.json:
```json
{
    "body": "<a id='comment:33'></a>Just took Jeroen's branch and rebased on top of #24772.\n\nIs there anything more that still needs to be discussed on this?\n\n---\nNew commits:",
    "created_at": "2018-02-23T15:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359417",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>Just took Jeroen's branch and rebased on top of #24772.

Is there anything more that still needs to be discussed on this?

---
New commits:



---

archive/issue_comments_359418.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 embray]:\n> Is there anything more that still needs to be discussed on this?\n\n\nProbably yes. I haven't really looked in detail.",
    "created_at": "2018-02-23T16:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359418",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Replying to [comment:33 embray]:
> Is there anything more that still needs to be discussed on this?


Probably yes. I haven't really looked in detail.



---

archive/issue_comments_359419.json:
```json
{
    "body": "<a id='comment:35'></a>Probably?  I'll note again that this has been working for me for months now. Maybe take a leap of faith so that we can get this in and others can finally start testing against Python 3.",
    "created_at": "2018-02-27T16:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359419",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'></a>Probably?  I'll note again that this has been working for me for months now. Maybe take a leap of faith so that we can get this in and others can finally start testing against Python 3.



---

archive/issue_comments_359420.json:
```json
{
    "body": "<a id='comment:36'></a>As I said, I barely looked at this. And I prefer to do that after the dependencies have been merged.",
    "created_at": "2018-02-27T16:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359420",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>As I said, I barely looked at this. And I prefer to do that after the dependencies have been merged.



---

archive/issue_comments_359421.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:33 embray]:\n> Just took Jeroen's branch and rebased on top of #24772.\n\n\nThe change that I mentioned in [comment:29] is gone. Was that intentional? In any case, I would prefer *not* to add it back if there is no reason.\n\nFor ease of reviewing, I'm rebasing your branch on 8.2.beta7 (there are no conflicts, it's a trivial rebase). The 3 commits are independent and I did reorder them.",
    "created_at": "2018-03-07T09:32:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359421",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>Replying to [comment:33 embray]:
> Just took Jeroen's branch and rebased on top of #24772.


The change that I mentioned in [comment:29] is gone. Was that intentional? In any case, I would prefer *not* to add it back if there is no reason.

For ease of reviewing, I'm rebasing your branch on 8.2.beta7 (there are no conflicts, it's a trivial rebase). The 3 commits are independent and I did reorder them.



---

archive/issue_comments_359422.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-07T09:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359422",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_359423.json:
```json
{
    "body": "<a id='comment:41'></a>I'm moving the commit about `atexit` to #24922 because I want to add something.",
    "created_at": "2018-03-07T09:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359423",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>I'm moving the commit about `atexit` to #24922 because I want to add something.



---

archive/issue_comments_359424.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-07T09:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359424",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_359425.json:
```json
{
    "body": "<a id='comment:43'></a>I didn't mean to delete it, and there was at least one good reason for it which is that deleting attributes off objects is just ugly when you can set them to None instead.\n\nI'm reworking some of this code elsewhere so I'm not going to worry about it though.\n\n---\nNew commits:",
    "created_at": "2018-03-07T09:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359425",
    "user": "https://github.com/embray"
}
```

<a id='comment:43'></a>I didn't mean to delete it, and there was at least one good reason for it which is that deleting attributes off objects is just ugly when you can set them to None instead.

I'm reworking some of this code elsewhere so I'm not going to worry about it though.

---
New commits:



---

archive/issue_comments_359426.json:
```json
{
    "body": "<a id='comment:44'></a>This added call to `save_result_output` is causing breakage:\n\n```diff\n+        # Save any result output so far before we kill the process off\n+        self.save_result_output()\n```\n\n```\nsage -t --long src/sage/doctest/forker.py\n**********************************************************************\nFile \"src/sage/doctest/forker.py\", line 2104, in sage.doctest.forker.DocTestWorker.save_result_output\nFailed example:\n    W.kill()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 556, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 966, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.doctest.forker.DocTestWorker.save_result_output[14]>\", line 1, in <module>\n        W.kill()\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2176, in kill\n        self.save_result_output()\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2114, in save_result_output\n        self.result = self.result_queue.get(block=False)\n    AttributeError: 'DocTestWorker' object has no attribute 'result_queue'\n**********************************************************************\n```\nNow I see that you needed [comment:29] to fix that breakage but why did you need to add a call to `save_result_output` in `kill()`? All doctests pass when I remove that.",
    "created_at": "2018-03-07T10:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359426",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>This added call to `save_result_output` is causing breakage:

```diff
+        # Save any result output so far before we kill the process off
+        self.save_result_output()
```

```
sage -t --long src/sage/doctest/forker.py
**********************************************************************
File "src/sage/doctest/forker.py", line 2104, in sage.doctest.forker.DocTestWorker.save_result_output
Failed example:
    W.kill()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 556, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 966, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.doctest.forker.DocTestWorker.save_result_output[14]>", line 1, in <module>
        W.kill()
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2176, in kill
        self.save_result_output()
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2114, in save_result_output
        self.result = self.result_queue.get(block=False)
    AttributeError: 'DocTestWorker' object has no attribute 'result_queue'
**********************************************************************
```
Now I see that you needed [comment:29] to fix that breakage but why did you need to add a call to `save_result_output` in `kill()`? All doctests pass when I remove that.



---

archive/issue_comments_359427.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-07T10:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359427",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_359428.json:
```json
{
    "body": "<a id='comment:45'></a>https://git.sagemath.org/sage.git/commit/?id=2203ca27445e7db09cdf97b34896b6d8ea6eb670",
    "created_at": "2018-03-07T10:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359428",
    "user": "https://github.com/embray"
}
```

<a id='comment:45'></a>https://git.sagemath.org/sage.git/commit/?id=2203ca27445e7db09cdf97b34896b6d8ea6eb670



---

archive/issue_comments_359429.json:
```json
{
    "body": "<a id='comment:46'></a>Does Python 3 no longer support the `\"a\"` mode in `fdopen()`? I consider that a bug. It might not matter for the doctesting framework, but the `\"w\"` and `\"a\"` options are not equivalent, especially when multiple processes write to the same file.",
    "created_at": "2018-03-07T10:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359429",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>Does Python 3 no longer support the `"a"` mode in `fdopen()`? I consider that a bug. It might not matter for the doctesting framework, but the `"w"` and `"a"` options are not equivalent, especially when multiple processes write to the same file.



---

archive/issue_comments_359430.json:
```json
{
    "body": "<a id='comment:47'></a>Why are you wrapping all `close()` calls in a `try`/`except` block? If a file fails to close for some reason, that's a genuine error.",
    "created_at": "2018-03-07T10:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359430",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>Why are you wrapping all `close()` calls in a `try`/`except` block? If a file fails to close for some reason, that's a genuine error.



---

archive/issue_comments_359431.json:
```json
{
    "body": "<a id='comment:48'></a>I don't recall why the change from \"w\" to \"a\" mode.  Maybe there was a reason, but in this case it seems I didn't document it. You you can try removing it and see.  Maybe I was thinking about https://bugs.python.org/issue20082",
    "created_at": "2018-03-07T11:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359431",
    "user": "https://github.com/embray"
}
```

<a id='comment:48'></a>I don't recall why the change from "w" to "a" mode.  Maybe there was a reason, but in this case it seems I didn't document it. You you can try removing it and see.  Maybe I was thinking about https://bugs.python.org/issue20082



---

archive/issue_comments_359432.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:47 jdemeyer]:\n> Why are you wrapping all `close()` calls in a `try`/`except` block? If a file fails to close for some reason, that's a genuine error.\n\n\nNot \"all\".  Those are in `__del__` methods, where you can't assume the files are still even open.",
    "created_at": "2018-03-07T11:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359432",
    "user": "https://github.com/embray"
}
```

<a id='comment:49'></a>Replying to [comment:47 jdemeyer]:
> Why are you wrapping all `close()` calls in a `try`/`except` block? If a file fails to close for some reason, that's a genuine error.


Not "all".  Those are in `__del__` methods, where you can't assume the files are still even open.



---

archive/issue_comments_359433.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:45 embray]:\n> https://git.sagemath.org/sage.git/commit/?id=2203ca27445e7db09cdf97b34896b6d8ea6eb670\n\n\nI guess you mean this sentence from the commit message:\n> Note that `DocTestWorker.kill()` now calls `sage_results_output` [sic], which ensures that the `DocTestWorker.outtmpfile` is closed.\n\n\nWhy not simply call `self.outtmpfile.close()` in `kill`?",
    "created_at": "2018-03-07T11:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359433",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>Replying to [comment:45 embray]:
> https://git.sagemath.org/sage.git/commit/?id=2203ca27445e7db09cdf97b34896b6d8ea6eb670


I guess you mean this sentence from the commit message:
> Note that `DocTestWorker.kill()` now calls `sage_results_output` [sic], which ensures that the `DocTestWorker.outtmpfile` is closed.


Why not simply call `self.outtmpfile.close()` in `kill`?



---

archive/issue_comments_359434.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 embray]:\n> Not \"all\".  Those are in `__del__` methods, where you can't assume the files are still even open.\n\n\nEven if the file is already closed, Python allows closing an already-closed file:\n\n```\n>>> f = open(\"/dev/null\")\n>>> f.close()\n>>> f.close()\n```",
    "created_at": "2018-03-07T11:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359434",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>Replying to [comment:49 embray]:
> Not "all".  Those are in `__del__` methods, where you can't assume the files are still even open.


Even if the file is already closed, Python allows closing an already-closed file:

```
>>> f = open("/dev/null")
>>> f.close()
>>> f.close()
```



---

archive/issue_comments_359435.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:48 embray]:\n> I don't recall why the change from \"w\" to \"a\" mode.  Maybe there was a reason, but in this case it seems I didn't document it. You you can try removing it and see.  Maybe I was thinking about https://bugs.python.org/issue20082\n\n\nNo, it's worse than that:\n\n```\nPython 3.6.1 (default, Feb 19 2018, 09:57:52) \n[GCC 4.9.4] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import os\n>>> os.fdopen(2, \"a\")\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/usr/local/src/sage-config/local/lib/python3.6/os.py\", line 1015, in fdopen\n    return io.open(fd, *args, **kwargs)\nOSError: [Errno 29] Illegal seek\n```",
    "created_at": "2018-03-07T11:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359435",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>Replying to [comment:48 embray]:
> I don't recall why the change from "w" to "a" mode.  Maybe there was a reason, but in this case it seems I didn't document it. You you can try removing it and see.  Maybe I was thinking about https://bugs.python.org/issue20082


No, it's worse than that:

```
Python 3.6.1 (default, Feb 19 2018, 09:57:52) 
[GCC 4.9.4] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import os
>>> os.fdopen(2, "a")
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/local/src/sage-config/local/lib/python3.6/os.py", line 1015, in fdopen
    return io.open(fd, *args, **kwargs)
OSError: [Errno 29] Illegal seek
```



---

archive/issue_comments_359436.json:
```json
{
    "body": "<a id='comment:53'></a>(end of review for now)",
    "created_at": "2018-03-07T11:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359436",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>(end of review for now)



---

archive/issue_comments_359437.json:
```json
{
    "body": "<a id='comment:54'></a>Well, you could try removing it and see. I probably had a reason.",
    "created_at": "2018-03-07T11:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359437",
    "user": "https://github.com/embray"
}
```

<a id='comment:54'></a>Well, you could try removing it and see. I probably had a reason.



---

archive/issue_comments_359438.json:
```json
{
    "body": "<a id='comment:55'></a>Replying to [comment:52 jdemeyer]:\n> Replying to [comment:48 embray]:\n> > I don't recall why the change from \"w\" to \"a\" mode.  Maybe there was a reason, but in this case it seems I didn't document it. You you can try removing it and see.  Maybe I was thinking about https://bugs.python.org/issue20082\n\n> \n> No, it's worse than that:\n> \n> ```\n> Python 3.6.1 (default, Feb 19 2018, 09:57:52) \n> [GCC 4.9.4] on linux\n> Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n> >>> import os\n> >>> os.fdopen(2, \"a\")\n> Traceback (most recent call last):\n>   File \"<stdin>\", line 1, in <module>\n>   File \"/usr/local/src/sage-config/local/lib/python3.6/os.py\", line 1015, in fdopen\n>     return io.open(fd, *args, **kwargs)\n> OSError: [Errno 29] Illegal seek\n> ```\n\n\nAh, right, this is https://bugs.python.org/issue27805",
    "created_at": "2018-03-07T11:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359438",
    "user": "https://github.com/embray"
}
```

<a id='comment:55'></a>Replying to [comment:52 jdemeyer]:
> Replying to [comment:48 embray]:
> > I don't recall why the change from "w" to "a" mode.  Maybe there was a reason, but in this case it seems I didn't document it. You you can try removing it and see.  Maybe I was thinking about https://bugs.python.org/issue20082

> 
> No, it's worse than that:
> 
> ```
> Python 3.6.1 (default, Feb 19 2018, 09:57:52) 
> [GCC 4.9.4] on linux
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import os
> >>> os.fdopen(2, "a")
> Traceback (most recent call last):
>   File "<stdin>", line 1, in <module>
>   File "/usr/local/src/sage-config/local/lib/python3.6/os.py", line 1015, in fdopen
>     return io.open(fd, *args, **kwargs)
> OSError: [Errno 29] Illegal seek
> ```


Ah, right, this is https://bugs.python.org/issue27805



---

archive/issue_comments_359439.json:
```json
{
    "body": "<a id='comment:56'></a>I still think whether it's needed or not, it's really ugly to just assign attributes to objects, and then delete them later, and have to do `hasattr(obj, attr)` on it when you could just set those attributes to `None` when they're not needed anymore.  Maybe this is some deeply-ingrained Java-ism, but I think deleting attributes is in most cases an anti-pattern.",
    "created_at": "2018-03-07T11:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359439",
    "user": "https://github.com/embray"
}
```

<a id='comment:56'></a>I still think whether it's needed or not, it's really ugly to just assign attributes to objects, and then delete them later, and have to do `hasattr(obj, attr)` on it when you could just set those attributes to `None` when they're not needed anymore.  Maybe this is some deeply-ingrained Java-ism, but I think deleting attributes is in most cases an anti-pattern.



---

archive/issue_comments_359440.json:
```json
{
    "body": "<a id='comment:57'></a>That said, I think maybe the `kill()` calls from [2203ca27](https://git.sagemath.org/sage.git/commit/?id=2203ca27445e7db09cdf97b34896b6d8ea6eb670) can be removed.  I tried taking all that stuff and out I don't get any ResourceWarnings.  So it's possible that while they did something at one time, additional fixes elsewhere rendered it unnecessary.",
    "created_at": "2018-03-07T11:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359440",
    "user": "https://github.com/embray"
}
```

<a id='comment:57'></a>That said, I think maybe the `kill()` calls from [2203ca27](https://git.sagemath.org/sage.git/commit/?id=2203ca27445e7db09cdf97b34896b6d8ea6eb670) can be removed.  I tried taking all that stuff and out I don't get any ResourceWarnings.  So it's possible that while they did something at one time, additional fixes elsewhere rendered it unnecessary.



---

archive/issue_comments_359441.json:
```json
{
    "body": "<a id='comment:58'></a>Same with the try/except around the close calls.  I don't seem to have made note of a specific reason for them.",
    "created_at": "2018-03-07T11:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359441",
    "user": "https://github.com/embray"
}
```

<a id='comment:58'></a>Same with the try/except around the close calls.  I don't seem to have made note of a specific reason for them.



---

archive/issue_comments_359442.json:
```json
{
    "body": "<a id='comment:59'></a>Okay, I removed a few of the changes you pointed out that don't appear to be necessary.  Other than that I wouldn't mess with anything else.\n\n---\nNew commits:",
    "created_at": "2018-03-07T11:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359442",
    "user": "https://github.com/embray"
}
```

<a id='comment:59'></a>Okay, I removed a few of the changes you pointed out that don't appear to be necessary.  Other than that I wouldn't mess with anything else.

---
New commits:



---

archive/issue_comments_359443.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-07T11:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359443",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_359444.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-07T11:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359444",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_359445.json:
```json
{
    "body": "<a id='comment:60'></a>Hold on, I thought I removed all those try/excepts...",
    "created_at": "2018-03-07T11:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359445",
    "user": "https://github.com/embray"
}
```

<a id='comment:60'></a>Hold on, I thought I removed all those try/excepts...



---

archive/issue_comments_359446.json:
```json
{
    "body": "<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-07T11:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359446",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_359447.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-07T11:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359447",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_359448.json:
```json
{
    "body": "<a id='comment:62'></a>Okay.",
    "created_at": "2018-03-07T11:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359448",
    "user": "https://github.com/embray"
}
```

<a id='comment:62'></a>Okay.



---

archive/issue_comments_359449.json:
```json
{
    "body": "<a id='comment:63'></a>OK, that seems good on first sight. The last commit (changing the `sleep()` time) is probably no longer needed. I guess you added it because `kill()` did more stuff and needed more time.\n\nAnd let me just think whether the change of `open()` mode from `\"a\"` to `\"w\"` could cause trouble...",
    "created_at": "2018-03-07T14:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359449",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:63'></a>OK, that seems good on first sight. The last commit (changing the `sleep()` time) is probably no longer needed. I guess you added it because `kill()` did more stuff and needed more time.

And let me just think whether the change of `open()` mode from `"a"` to `"w"` could cause trouble...



---

archive/issue_comments_359450.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-08T08:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359450",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_359451.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-03-13T20:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359451",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_359452.json:
```json
{
    "body": "<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-03-13T20:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359452",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_359453.json:
```json
{
    "body": "<a id='comment:66'></a>Sorry, hopefully not too late to append to this ticket.  This little fix should have been here, and I think got lost somewhere along the way.",
    "created_at": "2018-03-13T20:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359453",
    "user": "https://github.com/embray"
}
```

<a id='comment:66'></a>Sorry, hopefully not too late to append to this ticket.  This little fix should have been here, and I think got lost somewhere along the way.



---

archive/issue_comments_359454.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-13T20:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359454",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061560.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-21T06:19:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24343#event-61560"
}
```



---

archive/issue_comments_359455.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-21T06:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359455",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_359456.json:
```json
{
    "body": "<a id='comment:69'></a>I think some of the stuff I ended up removing from this was needed after all.  It might not have shown up either because:\n\na) I was originally testing with a debug build of Python which always displays `ResourceWarning`s by default (a non-debug build does not)\n\nb) Some of it might have been particular to Cygwin, but I switched mostly to testing on Linux later on.",
    "created_at": "2018-04-06T14:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24343#issuecomment-359456",
    "user": "https://github.com/embray"
}
```

<a id='comment:69'></a>I think some of the stuff I ended up removing from this was needed after all.  It might not have shown up either because:

a) I was originally testing with a debug build of Python which always displays `ResourceWarning`s by default (a non-debug build does not)

b) Some of it might have been particular to Cygwin, but I switched mostly to testing on Linux later on.
