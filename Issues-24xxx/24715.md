# Issue 24715: [WIP] Always use dynamic classes for elements

archive/issues_024478.json:
```json
{
    "assignees": [],
    "body": "Use dynamic classes, both for Python and Cython classes.\n\nCC:  @nthiery @tscrim\n\nBranch/Commit: **[u/jdemeyer/always_use_dynamic_classes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/always_use_dynamic_classes) @ [`ebee325`](https://github.com/sagemath/sagetrac-mirror/commit/ebee3258fec86d616c9875344b9cc63102d5f65b)**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **categories**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24715_\n\n",
    "created_at": "2018-02-12T13:33:52Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20categories",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "[WIP] Always use dynamic classes for elements",
    "type": "issue",
    "updated_at": "2022-12-29T01:40:48Z",
    "url": "https://github.com/sagemath/sage/issues/24715",
    "user": "https://github.com/jdemeyer"
}
```
Use dynamic classes, both for Python and Cython classes.

CC:  @nthiery @tscrim

Branch/Commit: **[u/jdemeyer/always_use_dynamic_classes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/always_use_dynamic_classes) @ [`ebee325`](https://github.com/sagemath/sagetrac-mirror/commit/ebee3258fec86d616c9875344b9cc63102d5f65b)**

Author: **Jeroen Demeyer**

Component: **categories**

_Issue created by migration from https://trac.sagemath.org/ticket/24715_





---

archive/issue_events_343754.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:33:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343754"
}
```



---

archive/issue_events_343755.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:33:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20categories",
    "label_color": "0000ff",
    "label_name": "c: categories",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343755"
}
```



---

archive/issue_events_343756.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:33:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343756"
}
```



---

archive/issue_events_343757.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:33:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343757"
}
```



---

archive/issue_comments_375576.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+Use dynamic classes, both for Python and Cython classes.\n``````\n",
    "created_at": "2018-02-12T13:40:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375576",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+Use dynamic classes, both for Python and Cython classes.
``````




---

archive/issue_comments_375577.json:
```json
{
    "body": "Branch: **[u/jdemeyer/always_use_dynamic_classes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/always_use_dynamic_classes)**",
    "created_at": "2018-02-12T13:43:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375577",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/always_use_dynamic_classes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/always_use_dynamic_classes)**



---

archive/issue_comments_375578.json:
```json
{
    "body": "Commit: **[`ebee325`](https://github.com/sagemath/sagetrac-mirror/commit/ebee3258fec86d616c9875344b9cc63102d5f65b)**",
    "created_at": "2018-02-12T13:48:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375578",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`ebee325`](https://github.com/sagemath/sagetrac-mirror/commit/ebee3258fec86d616c9875344b9cc63102d5f65b)**



---

archive/issue_comments_375579.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis is the basic idea. But this leads to a million (well, a lot) doctest failures of the form\n\n```\nsage -t src/sage/rings/finite_rings/element_pari_ffelt.pyx\n**********************************************************************\nFile \"src/sage/rings/finite_rings/element_pari_ffelt.pyx\", line 100, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt\nFailed example:\n    type(a)\nExpected:\n    <type 'sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt'>\nGot:\n    <class 'sage.rings.finite_rings.finite_field_pari_ffelt.FiniteField_pari_ffelt_with_category.element_class'>\n**********************************************************************\n```\nThese are clearly desired doctest failures.\n\nSecond, many parents still hardcode the element type. For example, even with this patch:\n\n```\nsage: type(ZZ.one())\n<type 'sage.rings.integer.Integer'>\nsage: type(RR.one())\n<type 'sage.rings.real_mpfr.RealNumber'>\n```\nFixing those is obviously outside the scope of this ticket.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ebee3258fec86d616c9875344b9cc63102d5f65b\"><code>ebee325</code></a></td><td><code>Always use dynamic classes</code></td></tr></table>\n",
    "created_at": "2018-02-12T13:48:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375579",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

This is the basic idea. But this leads to a million (well, a lot) doctest failures of the form

```
sage -t src/sage/rings/finite_rings/element_pari_ffelt.pyx
**********************************************************************
File "src/sage/rings/finite_rings/element_pari_ffelt.pyx", line 100, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt
Failed example:
    type(a)
Expected:
    <type 'sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt'>
Got:
    <class 'sage.rings.finite_rings.finite_field_pari_ffelt.FiniteField_pari_ffelt_with_category.element_class'>
**********************************************************************
```
These are clearly desired doctest failures.

Second, many parents still hardcode the element type. For example, even with this patch:

```
sage: type(ZZ.one())
<type 'sage.rings.integer.Integer'>
sage: type(RR.one())
<type 'sage.rings.real_mpfr.RealNumber'>
```
Fixing those is obviously outside the scope of this ticket.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ebee3258fec86d616c9875344b9cc63102d5f65b"><code>ebee325</code></a></td><td><code>Always use dynamic classes</code></td></tr></table>




---

archive/issue_events_343758.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:49:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343758"
}
```



---

archive/issue_comments_375580.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nSetting to needs_review just for the patchbot.",
    "created_at": "2018-02-12T13:49:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375580",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Setting to needs_review just for the patchbot.



---

archive/issue_events_343759.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:50:44Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "title_is": "Always use dynamic classes for elements",
    "title_was": "Always use dynamic classes",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343759"
}
```



---

archive/issue_comments_375581.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nInteresting fact: `combinat` already uses dynamic classes for almost everything. Only doctest failures in `combinat`:\n\n```\nsage -t src/sage/combinat/crystals/tensor_product_element.pyx\n**********************************************************************\nFile \"src/sage/combinat/crystals/tensor_product_element.pyx\", line 752, in sage.combinat.crystals.tensor_product_element.CrystalOfTableauxElement.__init__\nFailed example:\n    type(t[0])\nExpected:\n    <... 'sage.combinat.crystals.letters.Crystal_of_letters_type_A_element'>\nGot:\n    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>\n**********************************************************************\nFile \"src/sage/combinat/crystals/tensor_product_element.pyx\", line 755, in sage.combinat.crystals.tensor_product_element.CrystalOfTableauxElement.__init__\nFailed example:\n    type(t[1])\nExpected:\n    <... 'sage.combinat.crystals.letters.Crystal_of_letters_type_A_element'>\nGot:\n    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>\n**********************************************************************\n```",
    "created_at": "2018-02-12T13:57:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375581",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Interesting fact: `combinat` already uses dynamic classes for almost everything. Only doctest failures in `combinat`:

```
sage -t src/sage/combinat/crystals/tensor_product_element.pyx
**********************************************************************
File "src/sage/combinat/crystals/tensor_product_element.pyx", line 752, in sage.combinat.crystals.tensor_product_element.CrystalOfTableauxElement.__init__
Failed example:
    type(t[0])
Expected:
    <... 'sage.combinat.crystals.letters.Crystal_of_letters_type_A_element'>
Got:
    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>
**********************************************************************
File "src/sage/combinat/crystals/tensor_product_element.pyx", line 755, in sage.combinat.crystals.tensor_product_element.CrystalOfTableauxElement.__init__
Failed example:
    type(t[1])
Expected:
    <... 'sage.combinat.crystals.letters.Crystal_of_letters_type_A_element'>
Got:
    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>
**********************************************************************
```



---

archive/issue_comments_375582.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nFrom a quick look at the current patchbot reports:\n\n- There seems to be a very non-trivial side effect when wrapping `Integer` (see the `categories/examples/infinite_enumerated_sets.py`).\n- The failures in `categories/sets_cat.py` and `sets/cartesian_product.py` I believe are connected with the previous point.\n- We are getting `TypeError`s being raised in `modular/btquotients/pautomorphicform.py`.\n- Coercion has broken in `rings/polynomial/polynomial_ring.py` coming from this check:\n\n  ```python\n                    # Over ZZ, only allow coercion from any ZZ['x']\n                    # implementation to the default FLINT implementation\n                    if self.element_class is not Polynomial_integer_dense_flint:\n                        return None\n  ```\n  It would need to become `issubclass`, which means a slight speed penalty, but a necessary one.\n- I think the failures in `libs/coxeter3/coxeter_group.py` and `libs/coxeter3/coxeter.pyx` are from this ticket, but I haven't verified locally.\n- This uncovered a bad import: A doctest in `structure.misc` is importing `is_extension_type` from `structure.parent`: `from sage.structure.parent import is_extension_type`.\n- Something is going wrong in `structure/list_clone.pyx` with pickling.\n\nThe rest look like trivial failures a la [comment:3](#comment:3).\n\nI am also somewhat worried about speed regressions overall.",
    "created_at": "2018-02-13T01:33:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375582",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:7" align="right">comment:7</div>

From a quick look at the current patchbot reports:

- There seems to be a very non-trivial side effect when wrapping `Integer` (see the `categories/examples/infinite_enumerated_sets.py`).
- The failures in `categories/sets_cat.py` and `sets/cartesian_product.py` I believe are connected with the previous point.
- We are getting `TypeError`s being raised in `modular/btquotients/pautomorphicform.py`.
- Coercion has broken in `rings/polynomial/polynomial_ring.py` coming from this check:

  ```python
                    # Over ZZ, only allow coercion from any ZZ['x']
                    # implementation to the default FLINT implementation
                    if self.element_class is not Polynomial_integer_dense_flint:
                        return None
  ```
  It would need to become `issubclass`, which means a slight speed penalty, but a necessary one.
- I think the failures in `libs/coxeter3/coxeter_group.py` and `libs/coxeter3/coxeter.pyx` are from this ticket, but I haven't verified locally.
- This uncovered a bad import: A doctest in `structure.misc` is importing `is_extension_type` from `structure.parent`: `from sage.structure.parent import is_extension_type`.
- Something is going wrong in `structure/list_clone.pyx` with pickling.

The rest look like trivial failures a la [comment:3](#comment:3).

I am also somewhat worried about speed regressions overall.



---

archive/issue_events_343760.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-23T16:39:54Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "title_is": "[WIP] Always use dynamic classes for elements",
    "title_was": "Always use dynamic classes for elements",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343760"
}
```



---

archive/issue_comments_375583.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think this would cause speed regression in every `cpdef` call. Whenever a type is subclasses, `cpdef` must take the slow codepath in order to check if it's been overridden. I haven't checked if cython actually does that, but this should even be the case if the subclass is an extension type, since the `cpdef` on the super doesn't know what kind of shenanigans have been played (the subtype might have grown an instance dict and the method might be overridden by a function in there).\n\nDefinitely worth checking!\n\nIt may be worth saying something about the benefits of making this chance, so that those can be weighed against the draw-backs.",
    "created_at": "2019-01-23T17:36:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375583",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:9" align="right">comment:9</div>

I think this would cause speed regression in every `cpdef` call. Whenever a type is subclasses, `cpdef` must take the slow codepath in order to check if it's been overridden. I haven't checked if cython actually does that, but this should even be the case if the subclass is an extension type, since the `cpdef` on the super doesn't know what kind of shenanigans have been played (the subtype might have grown an instance dict and the method might be overridden by a function in there).

Definitely worth checking!

It may be worth saying something about the benefits of making this chance, so that those can be weighed against the draw-backs.



---

archive/issue_comments_375584.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@nbruin](#comment:9):\n> I think this would cause speed regression in every `cpdef` call.\n\nThat is why I created #27090: Cython only checks for `cpdef` overrides in Python classes.",
    "created_at": "2019-01-23T21:05:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375584",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@nbruin](#comment:9):
> I think this would cause speed regression in every `cpdef` call.

That is why I created #27090: Cython only checks for `cpdef` overrides in Python classes.



---

archive/issue_comments_375585.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jdemeyer](#comment:10):\n> That is why I created #27090: Cython only checks for `cpdef` overrides in Python classes.\n\nI figured as much. Do make sure to include a test that confirms this behaviour, because if you'd rely on this, you'd be relying in a flaw in cython that is liable to be fixed in a future version. Given the positive side-effect of the flaw, I can imagine that the cython devs would be willing to include a pragma to revert to the old behaviour if it comes to that, but we'd have to know to prod them for it.\n\nIf we don't test it we'll probably suffer a hard to measure but possibly in some cases significant performance regression with some future cython upgrade.",
    "created_at": "2019-01-23T21:23:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375585",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jdemeyer](#comment:10):
> That is why I created #27090: Cython only checks for `cpdef` overrides in Python classes.

I figured as much. Do make sure to include a test that confirms this behaviour, because if you'd rely on this, you'd be relying in a flaw in cython that is liable to be fixed in a future version. Given the positive side-effect of the flaw, I can imagine that the cython devs would be willing to include a pragma to revert to the old behaviour if it comes to that, but we'd have to know to prod them for it.

If we don't test it we'll probably suffer a hard to measure but possibly in some cases significant performance regression with some future cython upgrade.



---

archive/issue_comments_375586.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@nbruin](#comment:11):\n> If we don't test it we'll probably suffer a hard to measure but possibly in some cases significant performance regression with some future cython upgrade.\n\nIf it helps: I discussed this with the Cython devs in person at an OpenDreamKit workshop and the current behavior was a deliberate choice, not an implementation accident which will gratuitously be changed. Of course, as usual there are no guarantees...",
    "created_at": "2019-01-23T21:36:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24715#issuecomment-375586",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@nbruin](#comment:11):
> If we don't test it we'll probably suffer a hard to measure but possibly in some cases significant performance regression with some future cython upgrade.

If it helps: I discussed this with the Cython devs in person at an OpenDreamKit workshop and the current behavior was a deliberate choice, not an implementation accident which will gratuitously be changed. Of course, as usual there are no guarantees...



---

archive/issue_events_343761.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2021-12-01T01:03:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343761"
}
```



---

archive/issue_events_343762.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2021-12-01T01:03:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343762"
}
```



---

archive/issue_events_343763.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:40:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24715",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24715#event-343763"
}
```
