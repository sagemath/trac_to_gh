# Issue 24705: Do not hardcode the C++ stdlib in setup.py

archive/issues_024468.json:
```json
{
    "body": "sage build with the following flags still uses libstdc++ for some cythonized so files:\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++ --stdlib=libc++\"\nexport CXXFLAGS=\"$CXXFLAGS --stdlib=libc++\"\nexport LDFLAGS=\"$LDFLAGS -lc++ --stdlib=libc++\"\n```\n\n```\n> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so\n\tlinux-vdso.so.1 (0x00007ffc8f3f1000)\n\tlibntl.so.33 => /home/ralf/sage/local/lib/libntl.so.33 (0x00007f823f6d7000)\n\tlibgmp.so.23 => /home/ralf/sage/local/lib/libgmp.so.23 (0x00007f823f448000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f823f14b000)\n\tlibstdc++.so.6 => /usr/lib64/libstdc++.so.6 (0x00007f823edc2000)\n\tlibpython2.7.so.1.0 => /home/ralf/sage/local/lib/libpython2.7.so.1.0 (0x00007f823e9d8000)\n\tlibpari-gmp-2.10.so.0 => /home/ralf/sage/local/lib/libpari-gmp-2.10.so.0 (0x00007f823def9000)\n\tlibgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f823dce2000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f823dac5000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f823d724000)\n\tlibgf2x.so.1 => /home/ralf/sage/local/lib/libgf2x.so.1 (0x00007f823d501000)\n\tlibc++.so.1 => /usr/lib64/libc++.so.1 (0x00007f823ff05000)\n\tlibc++abi.so.1 => /usr/lib64/libc++abi.so.1 (0x00007f823fec2000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f823fdd6000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f823d2fd000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007f823d0fa000)\n```\n\n\nCC:  @kiwifb simonking @jdemeyer\n\nBranch: u/rws/do_not_hardcode_the_c___stdlib_in_setup_py\n\nCommit: 0e4016e97ff33a4ca0197e0242716c420a24685b\n\nResolution: wontfix\n\nIssue created by migration from https://trac.sagemath.org/ticket/24705\n\n",
    "closed_at": "2018-02-12T13:17:37Z",
    "created_at": "2018-02-10T15:22:43Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Do not hardcode the C++ stdlib in setup.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24705",
    "user": "https://github.com/rwst"
}
```
sage build with the following flags still uses libstdc++ for some cythonized so files:

```
export CC="clang"
export CXX="clang++ --stdlib=libc++"
export CXXFLAGS="$CXXFLAGS --stdlib=libc++"
export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
```

```
> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so
	linux-vdso.so.1 (0x00007ffc8f3f1000)
	libntl.so.33 => /home/ralf/sage/local/lib/libntl.so.33 (0x00007f823f6d7000)
	libgmp.so.23 => /home/ralf/sage/local/lib/libgmp.so.23 (0x00007f823f448000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f823f14b000)
	libstdc++.so.6 => /usr/lib64/libstdc++.so.6 (0x00007f823edc2000)
	libpython2.7.so.1.0 => /home/ralf/sage/local/lib/libpython2.7.so.1.0 (0x00007f823e9d8000)
	libpari-gmp-2.10.so.0 => /home/ralf/sage/local/lib/libpari-gmp-2.10.so.0 (0x00007f823def9000)
	libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f823dce2000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f823dac5000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f823d724000)
	libgf2x.so.1 => /home/ralf/sage/local/lib/libgf2x.so.1 (0x00007f823d501000)
	libc++.so.1 => /usr/lib64/libc++.so.1 (0x00007f823ff05000)
	libc++abi.so.1 => /usr/lib64/libc++abi.so.1 (0x00007f823fec2000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f823fdd6000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f823d2fd000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007f823d0fa000)
```


CC:  @kiwifb simonking @jdemeyer

Branch: u/rws/do_not_hardcode_the_c___stdlib_in_setup_py

Commit: 0e4016e97ff33a4ca0197e0242716c420a24685b

Resolution: wontfix

Issue created by migration from https://trac.sagemath.org/ticket/24705





---

archive/issue_comments_463239.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [ntl-10.3.0.log](tarball://root/attachments/some-uuid/ticket24705/ntl-10.3.0.log) by @rwst created at 2018-02-10 15:26:52\n\nsagelib is the culprit. It has libstdc++ hardcoded:\n\n```\n../logs/pkgs/sagelib-8.2.beta5.log:[212/474] [211/474] clang++ -pthread -shared -L/home/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/ntl/ntl_ZZ_pX.o -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -lntl -lgmp -lm -lstdc++ -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/libs/ntl/ntl_ZZ_pX.so -lpari\n```",
    "created_at": "2018-02-10T15:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463239",
    "user": "https://github.com/rwst"
}
```

<a id='comment:1'></a>
Attachment [ntl-10.3.0.log](tarball://root/attachments/some-uuid/ticket24705/ntl-10.3.0.log) by @rwst created at 2018-02-10 15:26:52

sagelib is the culprit. It has libstdc++ hardcoded:

```
../logs/pkgs/sagelib-8.2.beta5.log:[212/474] [211/474] clang++ -pthread -shared -L/home/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/ntl/ntl_ZZ_pX.o -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -lntl -lgmp -lm -lstdc++ -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/libs/ntl/ntl_ZZ_pX.so -lpari
```



---

archive/issue_events_078548.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "rename": {
        "from": "NTL build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so",
        "to": "sagelib build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24705#event-78548"
}
```



---

archive/issue_comments_463240.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis is the relevant part of `src/setup.py`:\n\n```\n        # Libraries: add stdc++ if needed and sort them\n        libs = kwds.get('libraries', [])\n        if cplusplus:\n            libs = libs + ['stdc++']\n```",
    "created_at": "2018-02-11T06:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463240",
    "user": "https://github.com/rwst"
}
```

<a id='comment:3'></a>
This is the relevant part of `src/setup.py`:

```
        # Libraries: add stdc++ if needed and sort them
        libs = kwds.get('libraries', [])
        if cplusplus:
            libs = libs + ['stdc++']
```



---

archive/issue_comments_463241.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+sagelib build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so\n \n ```\n ralf@ark:~/sage/pynac> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so\n``````\n",
    "created_at": "2018-02-11T06:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463241",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,4 @@
+sagelib build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so
 
 ```
 ralf@ark:~/sage/pynac> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so
``````




---

archive/issue_events_078549.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "rename": {
        "from": "sagelib build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so",
        "to": "Do not hardcode the C++ stdlib in setup.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24705#event-78549"
}
```



---

archive/issue_comments_463242.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt seems best to add `\"--stdlib=libc++\"`(else the libstdc++ is linked) only if it is already in CFLAGS. See also #24705. \n\nTesting this manually works, except for `element_givaro.pyx` which still gets compiled without the `\"--stdlib=libc++\"` directive.",
    "created_at": "2018-02-11T07:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463242",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>
It seems best to add `"--stdlib=libc++"`(else the libstdc++ is linked) only if it is already in CFLAGS. See also #24705. 

Testing this manually works, except for `element_givaro.pyx` which still gets compiled without the `"--stdlib=libc++"` directive.



---

archive/issue_comments_463243.json:
```json
{
    "body": "<a id='comment:5'></a>\nNever mind, I got it compiled, yeah, now testing.",
    "created_at": "2018-02-11T07:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463243",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>
Never mind, I got it compiled, yeah, now testing.



---

archive/issue_comments_463244.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [rws](#comment%3A4):\n> It seems best to add `\"--stdlib=libc++\"`(else the libstdc++ is linked) only if it is already in CFLAGS. See also #24705. \n\n\nDo you mean #24707?",
    "created_at": "2018-02-11T08:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463244",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Replying to [rws](#comment%3A4):
> It seems best to add `"--stdlib=libc++"`(else the libstdc++ is linked) only if it is already in CFLAGS. See also #24705. 


Do you mean #24707?



---

archive/issue_comments_463245.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [rws](#comment%3A3):\n> This is the relevant part of `src/setup.py`:\n> \n> ```\n>         # Libraries: add stdc++ if needed and sort them\n>         libs = kwds.get('libraries', [])\n>         if cplusplus:\n>             libs = libs + ['stdc++']\n> ```\n\n\nSorry, I don't get it: What would you replace it with, so that the sage library will not use `libstdc++` if `--stdlib=libc++` is provided?",
    "created_at": "2018-02-11T13:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463245",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
Replying to [rws](#comment%3A3):
> This is the relevant part of `src/setup.py`:
> 
> ```
>         # Libraries: add stdc++ if needed and sort them
>         libs = kwds.get('libraries', [])
>         if cplusplus:
>             libs = libs + ['stdc++']
> ```


Sorry, I don't get it: What would you replace it with, so that the sage library will not use `libstdc++` if `--stdlib=libc++` is provided?



---

archive/issue_comments_463246.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [SimonKing](#comment%3A10):\n> Replying to [rws](#comment%3A3):\n> > This is the relevant part of `src/setup.py`:\n> > \n> > ```\n> >         # Libraries: add stdc++ if needed and sort them\n> >         libs = kwds.get('libraries', [])\n> >         if cplusplus:\n> >             libs = libs + ['stdc++']\n> > ```\n\n> \n> Sorry, I don't get it: What would you replace it with, so that the sage library will not use `libstdc++` if `--stdlib=libc++` is provided?\n\n\nAt the moment we're still experimenting with flags, see #24707#comment:9. But I already think that the line above needs to be changed to `libs = libs + ['c++']` in order to get `-lc++` in the link command.",
    "created_at": "2018-02-11T14:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463246",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>
Replying to [SimonKing](#comment%3A10):
> Replying to [rws](#comment%3A3):
> > This is the relevant part of `src/setup.py`:
> > 
> > ```
> >         # Libraries: add stdc++ if needed and sort them
> >         libs = kwds.get('libraries', [])
> >         if cplusplus:
> >             libs = libs + ['stdc++']
> > ```

> 
> Sorry, I don't get it: What would you replace it with, so that the sage library will not use `libstdc++` if `--stdlib=libc++` is provided?


At the moment we're still experimenting with flags, see #24707#comment:9. But I already think that the line above needs to be changed to `libs = libs + ['c++']` in order to get `-lc++` in the link command.



---

archive/issue_comments_463247.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [rws](#comment%3A11):\n> At the moment we're still experimenting with flags, see #24707#comment:9. But I already think that the line above needs to be changed to `libs = libs + ['c++']` in order to get `-lc++` in the link command.\n\n\nBut certainly not unconditionally. Or do we want to build with `-lc++` when using gcc?",
    "created_at": "2018-02-11T14:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463247",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
Replying to [rws](#comment%3A11):
> At the moment we're still experimenting with flags, see #24707#comment:9. But I already think that the line above needs to be changed to `libs = libs + ['c++']` in order to get `-lc++` in the link command.


But certainly not unconditionally. Or do we want to build with `-lc++` when using gcc?



---

archive/issue_comments_463248.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [SimonKing](#comment%3A12):\n> But certainly not unconditionally. Or do we want to build with `-lc++` when using gcc?\n\n\nOf course (EDIT: not).",
    "created_at": "2018-02-11T14:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463248",
    "user": "https://github.com/rwst"
}
```

<a id='comment:13'></a>
Replying to [SimonKing](#comment%3A12):
> But certainly not unconditionally. Or do we want to build with `-lc++` when using gcc?


Of course (EDIT: not).



---

archive/issue_comments_463249.json:
```json
{
    "body": "Changing branch from \"\" to \"u/rws/do_not_hardcode_the_c___stdlib_in_setup_py\"",
    "created_at": "2018-02-11T16:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463249",
    "user": "https://github.com/rwst"
}
```

Changing branch from "" to "u/rws/do_not_hardcode_the_c___stdlib_in_setup_py"



---

archive/issue_comments_463250.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis still doesn't catch all ways to smuggle `-lstdc++` in the cython file linking stage of sagelib.\n\n---\nNew commits:\n|                                                                                                                                          |                                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[0e4016e](https://github.com/sagemath/sagetrac-mirror/commit/0e4016e97ff33a4ca0197e0242716c420a24685b)|`24705: Do not hardcode the C++ stdlib in setup.py`|",
    "created_at": "2018-02-11T16:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463250",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>
This still doesn't catch all ways to smuggle `-lstdc++` in the cython file linking stage of sagelib.

---
New commits:
|                                                                                                                                          |                                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[0e4016e](https://github.com/sagemath/sagetrac-mirror/commit/0e4016e97ff33a4ca0197e0242716c420a24685b)|`24705: Do not hardcode the C++ stdlib in setup.py`|



---

archive/issue_comments_463251.json:
```json
{
    "body": "Changing commit from \"\" to \"0e4016e97ff33a4ca0197e0242716c420a24685b\"",
    "created_at": "2018-02-11T16:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463251",
    "user": "https://github.com/rwst"
}
```

Changing commit from "" to "0e4016e97ff33a4ca0197e0242716c420a24685b"



---

archive/issue_comments_463252.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,14 @@\n-sagelib build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so\n+sage build with the following flags still uses libstdc++ for some cythonized so files:\n \n ```\n-ralf@ark:~/sage/pynac> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so\n+export CC=\"clang\"\n+export CXX=\"clang++ --stdlib=libc++\"\n+export CXXFLAGS=\"$CXXFLAGS --stdlib=libc++\"\n+export LDFLAGS=\"$LDFLAGS -lc++ --stdlib=libc++\"\n+```\n+\n+```\n+> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so\n \tlinux-vdso.so.1 (0x00007ffc8f3f1000)\n \tlibntl.so.33 => /home/ralf/sage/local/lib/libntl.so.33 (0x00007f823f6d7000)\n \tlibgmp.so.23 => /home/ralf/sage/local/lib/libgmp.so.23 (0x00007f823f448000)\n``````\n",
    "created_at": "2018-02-11T16:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463252",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,14 @@
-sagelib build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so
+sage build with the following flags still uses libstdc++ for some cythonized so files:
 
 ```
-ralf@ark:~/sage/pynac> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so
+export CC="clang"
+export CXX="clang++ --stdlib=libc++"
+export CXXFLAGS="$CXXFLAGS --stdlib=libc++"
+export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
+```
+
+```
+> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so
 	linux-vdso.so.1 (0x00007ffc8f3f1000)
 	libntl.so.33 => /home/ralf/sage/local/lib/libntl.so.33 (0x00007f823f6d7000)
 	libgmp.so.23 => /home/ralf/sage/local/lib/libgmp.so.23 (0x00007f823f448000)
``````




---

archive/issue_comments_463253.json:
```json
{
    "body": "<a id='comment:17'></a>\nAttachment [sagelib-8.2.beta5.log](tarball://root/attachments/some-uuid/ticket24705/sagelib-8.2.beta5.log) by @simon-king-jena created at 2018-02-11 20:34:50\n\nI did\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++ --stdlib=libc++\nexport CXXFLAGS=\"$CXXFLAGS -I/usr/include/libcxxabi/ --stdlib=libc++\"\nexport LDFLAGS=\"$LDFLAGS -lc++ --stdlib=libc++\"\nmake build\n```\nThe build process goes pretty far, however it hangs (for an hour or so) in sagelib. See the attached log.",
    "created_at": "2018-02-11T20:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463253",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>
Attachment [sagelib-8.2.beta5.log](tarball://root/attachments/some-uuid/ticket24705/sagelib-8.2.beta5.log) by @simon-king-jena created at 2018-02-11 20:34:50

I did

```
export CC="clang"
export CXX="clang++ --stdlib=libc++
export CXXFLAGS="$CXXFLAGS -I/usr/include/libcxxabi/ --stdlib=libc++"
export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
make build
```
The build process goes pretty far, however it hangs (for an hour or so) in sagelib. See the attached log.



---

archive/issue_comments_463254.json:
```json
{
    "body": "<a id='comment:18'></a>\nI am a bit late to this party - sorry. I don't have this problem at all with my clang configured to use libc++ by default. Is it possible to have `readelf -d /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so` on the object initially posted?",
    "created_at": "2018-02-12T04:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463254",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:18'></a>
I am a bit late to this party - sorry. I don't have this problem at all with my clang configured to use libc++ by default. Is it possible to have `readelf -d /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so` on the object initially posted?



---

archive/issue_events_078550.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T07:11:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24705#event-78550"
}
```



---

archive/issue_comments_463255.json:
```json
{
    "body": "<a id='comment:19'></a>\nSo this ticket is wontfix. Use these flags:\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++\"\nexport CLANG_DEFAULT_CXX_STDLIB=\"libc++\"\n```",
    "created_at": "2018-02-12T07:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463255",
    "user": "https://github.com/rwst"
}
```

<a id='comment:19'></a>
So this ticket is wontfix. Use these flags:

```
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
```



---

archive/issue_comments_463256.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-12T07:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463256",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_463257.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-12T07:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463257",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463258.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-02-12T07:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463258",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_463259.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [rws](#comment%3A19):\n> So this ticket is wontfix. Use these flags:\n> \n> ```\n> export CC=\"clang\"\n> export CXX=\"clang++\"\n> export CLANG_DEFAULT_CXX_STDLIB=\"libc++\"\n> ```\n\n\nDo you claim that this is enough to override what is written in setup.py???\n\nRecall that Sage's setup.py forces usage of `libstdc++` and not `libc++`.",
    "created_at": "2018-02-12T07:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463259",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>
Replying to [rws](#comment%3A19):
> So this ticket is wontfix. Use these flags:
> 
> ```
> export CC="clang"
> export CXX="clang++"
> export CLANG_DEFAULT_CXX_STDLIB="libc++"
> ```


Do you claim that this is enough to override what is written in setup.py???

Recall that Sage's setup.py forces usage of `libstdc++` and not `libc++`.



---

archive/issue_comments_463260.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [SimonKing](#comment%3A21):\n> Do you claim that this is enough to override what is written in setup.py???\n\n\nPlease let me first test whether the given flags are enough to let the branch from #24710 build on ubuntu. Or do you even claim that with your flags scipy will build without modifications?",
    "created_at": "2018-02-12T07:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463260",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>
Replying to [SimonKing](#comment%3A21):
> Do you claim that this is enough to override what is written in setup.py???


Please let me first test whether the given flags are enough to let the branch from #24710 build on ubuntu. Or do you even claim that with your flags scipy will build without modifications?



---

archive/issue_comments_463261.json:
```json
{
    "body": "<a id='comment:23'></a>\n`setup.py` adds `-lstdc++` to the flags used for linking but that can still be discarded by the compiler driver used. I can build sage with clang without altering `setup.py` so you should be able to. I am glad that Ralph found that environment variable.",
    "created_at": "2018-02-12T07:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463261",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:23'></a>
`setup.py` adds `-lstdc++` to the flags used for linking but that can still be discarded by the compiler driver used. I can build sage with clang without altering `setup.py` so you should be able to. I am glad that Ralph found that environment variable.



---

archive/issue_comments_463262.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [SimonKing](#comment%3A22):\n> Replying to [SimonKing](#comment%3A21):\n> > Do you claim that this is enough to override what is written in setup.py???\n\n> \n> Please let me first test whether the given flags are enough to let the branch from #24710 build on ubuntu. Or do you even claim that with your flags scipy will build without modifications?\n\n\nI do not make such claims without testing first.",
    "created_at": "2018-02-12T07:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463262",
    "user": "https://github.com/rwst"
}
```

<a id='comment:24'></a>
Replying to [SimonKing](#comment%3A22):
> Replying to [SimonKing](#comment%3A21):
> > Do you claim that this is enough to override what is written in setup.py???

> 
> Please let me first test whether the given flags are enough to let the branch from #24710 build on ubuntu. Or do you even claim that with your flags scipy will build without modifications?


I do not make such claims without testing first.



---

archive/issue_comments_463263.json:
```json
{
    "body": "Attachment [giac-1.4.9.45.p1.log](tarball://root/attachments/some-uuid/ticket24705/giac-1.4.9.45.p1.log) by @simon-king-jena created at 2018-02-12 09:15:00",
    "created_at": "2018-02-12T09:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463263",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [giac-1.4.9.45.p1.log](tarball://root/attachments/some-uuid/ticket24705/giac-1.4.9.45.p1.log) by @simon-king-jena created at 2018-02-12 09:15:00



---

archive/issue_comments_463264.json:
```json
{
    "body": "<a id='comment:25'></a>\nI just tried with the branch from #24710 and with the flags stated in[comment:19](#comment%3A19). But giac fails to build, see attachment:giac-1.4.9.45.p1.log",
    "created_at": "2018-02-12T09:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463264",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>
I just tried with the branch from #24710 and with the flags stated in[comment:19](#comment%3A19). But giac fails to build, see attachment:giac-1.4.9.45.p1.log



---

archive/issue_comments_463265.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [SimonKing](#comment%3A25):\n> I just tried with the branch from #24710 and with the flags stated in[comment:19](#comment%3A19). But giac fails to build, see attachment:giac-1.4.9.45.p1.log\n\n\nIt looks like you need #24696",
    "created_at": "2018-02-12T09:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463265",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:26'></a>
Replying to [SimonKing](#comment%3A25):
> I just tried with the branch from #24710 and with the flags stated in[comment:19](#comment%3A19). But giac fails to build, see attachment:giac-1.4.9.45.p1.log


It looks like you need #24696



---

archive/issue_comments_463266.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [fbissey](#comment%3A26):\n> Replying to [SimonKing](#comment%3A25):\n> > I just tried with the branch from #24710 and with the flags stated in[comment:19](#comment%3A19). But giac fails to build, see attachment:giac-1.4.9.45.p1.log\n\n> \n> It looks like you need #24696\n\n\nOK, trying again with #24710 and #24696",
    "created_at": "2018-02-12T09:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463266",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'></a>
Replying to [fbissey](#comment%3A26):
> Replying to [SimonKing](#comment%3A25):
> > I just tried with the branch from #24710 and with the flags stated in[comment:19](#comment%3A19). But giac fails to build, see attachment:giac-1.4.9.45.p1.log

> 
> It looks like you need #24696


OK, trying again with #24710 and #24696



---

archive/issue_comments_463267.json:
```json
{
    "body": "<a id='comment:28'></a>\nHooray, it builds now! I didn't run tests though. Anyway, to summarize what I did on ubuntu:\n\n- install clang, clang-dev, libc++abi-dev\n- checkout/merge #24710 and #24696\n- \n  {{{\nexport CC=\"clang\"\nexport CXX=\"clang++\"\nexport CLANG_DEFAULT_CXX_STDLIB=\"libc++\"\n  }}}\n- make\n\nSo, your finding out about `CLANG_DEFAULT_CXX_STDLIB` was great!\n\nSide-remarks:\n\n- I did not have the impression that building Sage with clang was faster than with gcc.\n- I will now do some small timings to see about the performance of the code generated by clang vs. gcc.",
    "created_at": "2018-02-12T10:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463267",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'></a>
Hooray, it builds now! I didn't run tests though. Anyway, to summarize what I did on ubuntu:

- install clang, clang-dev, libc++abi-dev
- checkout/merge #24710 and #24696
- 
  {{{
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
  }}}
- make

So, your finding out about `CLANG_DEFAULT_CXX_STDLIB` was great!

Side-remarks:

- I did not have the impression that building Sage with clang was faster than with gcc.
- I will now do some small timings to see about the performance of the code generated by clang vs. gcc.



---

archive/issue_comments_463268.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2018-02-12T10:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463268",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_463269.json:
```json
{
    "body": "<a id='comment:29'></a>\nI just realise that using #24710 was supposed to be not needed (it was closed as invalid).\n\nAnyway, a data point concerning timings, after installing meataxe:\n- With gcc\n  {{{\nsage: M = random_matrix(GF(9,'x'), 5000)\nsage: type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: N = random_matrix(GF(9,'x'), 5000)\nsage: %timeit _=M-N\n10 loops, best of 3: 20.5 ms per loop\nsage: %timeit _=M*N\n1 loop, best of 3: 46.5 s per loop\n  }}}\n- With clang:\n  {{{\nsage: M = random_matrix(GF(9,'x'), 5000)\nsage: type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: N = random_matrix(GF(9,'x'), 5000)\nsage: %timeit _=M-N\n10 loops, best of 3: 20.5 ms per loop\nsage: %timeit _=M*N\n1 loop, best of 3: 53.2 s per loop\n  }}}\n\nSince meataxe is heavily used in the computations that I *really* care about (group cohomology), I am not so happy about a slow-down of almost 15%. So, probably I won't use clang in my computations. Nonetheless, it is good for portability that clang can also be used on ubuntu.",
    "created_at": "2018-02-12T11:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463269",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'></a>
I just realise that using #24710 was supposed to be not needed (it was closed as invalid).

Anyway, a data point concerning timings, after installing meataxe:
- With gcc
  {{{
sage: M = random_matrix(GF(9,'x'), 5000)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: N = random_matrix(GF(9,'x'), 5000)
sage: %timeit _=M-N
10 loops, best of 3: 20.5 ms per loop
sage: %timeit _=M*N
1 loop, best of 3: 46.5 s per loop
  }}}
- With clang:
  {{{
sage: M = random_matrix(GF(9,'x'), 5000)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: N = random_matrix(GF(9,'x'), 5000)
sage: %timeit _=M-N
10 loops, best of 3: 20.5 ms per loop
sage: %timeit _=M*N
1 loop, best of 3: 53.2 s per loop
  }}}

Since meataxe is heavily used in the computations that I *really* care about (group cohomology), I am not so happy about a slow-down of almost 15%. So, probably I won't use clang in my computations. Nonetheless, it is good for portability that clang can also be used on ubuntu.



---

archive/issue_comments_463270.json:
```json
{
    "body": "<a id='comment:30'></a>\nI get several segfaults when testing sage.homology. Is that to be expected?",
    "created_at": "2018-02-12T11:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463270",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
I get several segfaults when testing sage.homology. Is that to be expected?



---

archive/issue_comments_463271.json:
```json
{
    "body": "<a id='comment:31'></a>\nShould this ticket be closed?",
    "created_at": "2018-02-12T11:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463271",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
Should this ticket be closed?



---

archive/issue_comments_463272.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [jdemeyer](#comment%3A31):\n> Should this ticket be closed?\n\n\nI think so. Certainly the test failure should be for a different ticket.",
    "created_at": "2018-02-12T12:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463272",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>
Replying to [jdemeyer](#comment%3A31):
> Should this ticket be closed?


I think so. Certainly the test failure should be for a different ticket.



---

archive/issue_events_078551.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T13:17:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24705#event-78551"
}
```



---

archive/issue_comments_463273.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-02-12T13:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24705#issuecomment-463273",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: wontfix
