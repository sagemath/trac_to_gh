# Issue 24232: Simplifications in calculus on manifolds via the expression tree

archive/issues_023995.json:
```json
{
    "assignees": [],
    "body": "This ticket performs a full reimplementation of the functions\n- `sage.manifolds.utilities.simplify_sqrt_real` \n- `sage.manifolds.utilities.simplify_abs_trig`\nwhich are involved in calculus on manifolds (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/utilities.html#sage.manifolds.utilities.simplify_chain_real)). Instead of manipulating string representations of symbolic expressions, as previously, this ticket is based on direct manipulations of the expression tree, via the introduction of two subclasses of [ExpressionTreeWalker](http://doc.sagemath.org/html/en/reference/calculus/sage/symbolic/expression_conversions.html#sage.symbolic.expression_conversions.ExpressionTreeWalker).\n\nRegarding the functionalities, the code in this ticket leads to the same improvements as those described in #24199, which was based on string manipulations.\n\nCC:  @rwst @tscrim @rll2021 @man74cio\n\nKeywords: **manifold calculus**\n\nBranch/Commit: **[`ec105bb`](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)**\n\nReviewer: **Travis Scrimshaw, Ralf Stephan, Richard L Lozes**\n\nAuthor: **Eric Gourgoulhon**\n\nComponent: **geometry**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24232_\n\n",
    "closed_at": "2017-12-11T01:02:03Z",
    "created_at": "2017-11-17T11:10:07Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20geometry",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/c%3A%20manifolds",
        "https://github.com/sagemath/sage/labels/c%3A%20calculus"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Simplifications in calculus on manifolds via the expression tree",
    "type": "issue",
    "updated_at": "2017-12-11T01:02:03Z",
    "url": "https://github.com/sagemath/sage/issues/24232",
    "user": "https://github.com/egourgoulhon"
}
```
This ticket performs a full reimplementation of the functions
- `sage.manifolds.utilities.simplify_sqrt_real` 
- `sage.manifolds.utilities.simplify_abs_trig`
which are involved in calculus on manifolds (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/utilities.html#sage.manifolds.utilities.simplify_chain_real)). Instead of manipulating string representations of symbolic expressions, as previously, this ticket is based on direct manipulations of the expression tree, via the introduction of two subclasses of [ExpressionTreeWalker](http://doc.sagemath.org/html/en/reference/calculus/sage/symbolic/expression_conversions.html#sage.symbolic.expression_conversions.ExpressionTreeWalker).

Regarding the functionalities, the code in this ticket leads to the same improvements as those described in #24199, which was based on string manipulations.

CC:  @rwst @tscrim @rll2021 @man74cio

Keywords: **manifold calculus**

Branch/Commit: **[`ec105bb`](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)**

Reviewer: **Travis Scrimshaw, Ralf Stephan, Richard L Lozes**

Author: **Eric Gourgoulhon**

Component: **geometry**

_Issue created by migration from https://trac.sagemath.org/ticket/24232_





---

archive/issue_events_333256.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:10:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333256"
}
```



---

archive/issue_events_333257.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:10:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "c: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333257"
}
```



---

archive/issue_events_333258.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:10:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333258"
}
```



---

archive/issue_events_333259.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:10:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333259"
}
```



---

archive/issue_events_333260.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:10:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20manifolds",
    "label_color": "0000ff",
    "label_name": "c: manifolds",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333260"
}
```



---

archive/issue_events_333261.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:10:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20calculus",
    "label_color": "0000ff",
    "label_name": "c: calculus",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333261"
}
```



---

archive/issue_comments_366631.json:
```json
{
    "body": "Commit: **[`7e5baa5`](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)**",
    "created_at": "2017-11-17T11:15:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366631",
    "user": "https://github.com/egourgoulhon"
}
```

Commit: **[`7e5baa5`](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)**



---

archive/issue_events_333262.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:15:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333262"
}
```



---

archive/issue_comments_366632.json:
```json
{
    "body": "Branch: **[public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)**",
    "created_at": "2017-11-17T11:15:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366632",
    "user": "https://github.com/egourgoulhon"
}
```

Branch: **[public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)**



---

archive/issue_comments_366633.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b\"><code>7e5baa5</code></a></td><td><code>Reimplement simplifications in calculus on manifolds via the expression tree</code></td></tr></table>\n",
    "created_at": "2017-11-17T11:15:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366633",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b"><code>7e5baa5</code></a></td><td><code>Reimplement simplifications in calculus on manifolds via the expression tree</code></td></tr></table>




---

archive/issue_comments_366634.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nQuick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:\n\n```python\n    def __init__(self, ex):\n        r\"\"\"\n        Construct a SimplifySqrtReal object.\n\n        TESTS::\n\n            sage: from sage.manifolds.utilities import SimplifySqrtReal\n            sage: s = SimplifySqrtReal(1+sqrt((x+1)^2))\n            sage: type(s)\n            <class 'sage.manifolds.utilities.SimplifySqrtReal'>\n\n        \"\"\"\n        ExpressionTreeWalker.__init__(self, ex)\n```\nMoreover, the test does not feel so useful, so I would just delete the whole thing.",
    "created_at": "2017-11-17T13:12:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366634",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:2" align="right">comment:2</div>

Quick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:

```python
    def __init__(self, ex):
        r"""
        Construct a SimplifySqrtReal object.

        TESTS::

            sage: from sage.manifolds.utilities import SimplifySqrtReal
            sage: s = SimplifySqrtReal(1+sqrt((x+1)^2))
            sage: type(s)
            <class 'sage.manifolds.utilities.SimplifySqrtReal'>

        """
        ExpressionTreeWalker.__init__(self, ex)
```
Moreover, the test does not feel so useful, so I would just delete the whole thing.



---

archive/issue_comments_366635.json:
```json
{
    "body": "Changed commit from **[`7e5baa5`](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)** to **[`61d97c2`](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)**",
    "created_at": "2017-11-17T16:31:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366635",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7e5baa5`](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)** to **[`61d97c2`](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)**



---

archive/issue_comments_366636.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8\"><code>61d97c2</code></a></td><td><code>Remove unnecessary `__init__` and slightly change in the treatment of 1/sqrt(...)</code></td></tr></table>\n",
    "created_at": "2017-11-17T16:31:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366636",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8"><code>61d97c2</code></a></td><td><code>Remove unnecessary `__init__` and slightly change in the treatment of 1/sqrt(...)</code></td></tr></table>




---

archive/issue_comments_366637.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@tscrim](#comment:2):\n> Quick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:\n\n>\n> Moreover, the test does not feel so useful, so I would just delete the whole thing.\n\nThank you for pointing this. You are of course perfectly right! The above commit suppresses the `__init__`'s. Moreover, it changes slightly the way `pow(x,-1/2)` is dealt with: the inverse is now taken at the very end of the simplification. This is more coherent and, on some tests I've performed, this leads to slightly better results.",
    "created_at": "2017-11-17T16:39:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366637",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@tscrim](#comment:2):
> Quick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:

>
> Moreover, the test does not feel so useful, so I would just delete the whole thing.

Thank you for pointing this. You are of course perfectly right! The above commit suppresses the `__init__`'s. Moreover, it changes slightly the way `pow(x,-1/2)` is dealt with: the inverse is now taken at the very end of the simplification. This is more coherent and, on some tests I've performed, this leads to slightly better results.



---

archive/issue_comments_366638.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nLGTM as far as I can tell. Ralf, do you have any comments/suggestions?",
    "created_at": "2017-11-17T21:48:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366638",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

LGTM as far as I can tell. Ralf, do you have any comments/suggestions?



---

archive/issue_comments_366639.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-11-17T21:48:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366639",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_366640.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nSorry coming late. The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.\n\nSo, for me this is good and, as the other reviewers and patchbots are happy, positive.",
    "created_at": "2017-11-18T07:23:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366640",
    "user": "https://github.com/rwst"
}
```

<div id="comment:6" align="right">comment:6</div>

Sorry coming late. The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.

So, for me this is good and, as the other reviewers and patchbots are happy, positive.



---

archive/issue_events_333263.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333263"
}
```



---

archive/issue_events_333264.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333264"
}
```



---

archive/issue_events_333265.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333265"
}
```



---

archive/issue_events_333266.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333266"
}
```



---

archive/issue_comments_366641.json:
```json
{
    "body": "Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Ralf Stephan**",
    "created_at": "2017-11-18T07:23:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366641",
    "user": "https://github.com/rwst"
}
```

Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Ralf Stephan**



---

archive/issue_comments_366642.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@rwst](#comment:6):\n> ...but instead simply call the walker in a loop as long as the result is different from the original.\n\nEven better would be to set a flag when you change something and loop as long as the flag is set. If you define the walker class inside the function that calls it you don't even need to make the flag global.",
    "created_at": "2017-11-18T07:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366642",
    "user": "https://github.com/rwst"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@rwst](#comment:6):
> ...but instead simply call the walker in a loop as long as the result is different from the original.

Even better would be to set a flag when you change something and loop as long as the flag is set. If you define the walker class inside the function that calls it you don't even need to make the flag global.



---

archive/issue_comments_366643.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@rwst](#comment:6):\n> Sorry coming late.\n\nWell, showing up in a ticket less than 24 h after its creation is not what I would call late ;-)\nThank you for your feedback!\n\n> The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. \n\nIf I understand correctly (which is not guaranteed...), this would change the ordering of simplification. Take for instance the expression\n\n```\nex = sqrt(a + sqrt(b))\n```\nwhere `a` and `b` are potentially complicated expressions. As it is currently, the walker will simplify first `sqrt(b)` (to `c` say) and then `sqrt(a+c)`. If we call the walker in a loop as long as the outcome changes, it will first try to simplify `sqrt(a + sqrt(b))`, leaving `sqrt(b)` as it is. In the second round only, it will try to simplify `sqrt(b)`. Am I correct? If yes, this would mean that the current version simplifies nested sqrt's from the innermost one to the outermost one, while the loop version will do the opposite. For other type of operations, this may be equivalent, but simplifications are more likely to succeed if we start from the smaller parts, i.e. the innermost ones, like `sqrt(b)`. Do you agree?\n\n>However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.\n> \n\nI've seen it is #24236. This will be very useful, thank you!",
    "created_at": "2017-11-18T17:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366643",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@rwst](#comment:6):
> Sorry coming late.

Well, showing up in a ticket less than 24 h after its creation is not what I would call late ;-)
Thank you for your feedback!

> The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. 

If I understand correctly (which is not guaranteed...), this would change the ordering of simplification. Take for instance the expression

```
ex = sqrt(a + sqrt(b))
```
where `a` and `b` are potentially complicated expressions. As it is currently, the walker will simplify first `sqrt(b)` (to `c` say) and then `sqrt(a+c)`. If we call the walker in a loop as long as the outcome changes, it will first try to simplify `sqrt(a + sqrt(b))`, leaving `sqrt(b)` as it is. In the second round only, it will try to simplify `sqrt(b)`. Am I correct? If yes, this would mean that the current version simplifies nested sqrt's from the innermost one to the outermost one, while the loop version will do the opposite. For other type of operations, this may be equivalent, but simplifications are more likely to succeed if we start from the smaller parts, i.e. the innermost ones, like `sqrt(b)`. Do you agree?

>However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.
> 

I've seen it is #24236. This will be very useful, thank you!



---

archive/issue_comments_366644.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\n> If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.\n\nDepends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.",
    "created_at": "2017-11-19T07:18:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366644",
    "user": "https://github.com/rwst"
}
```

<div id="comment:9" align="right">comment:9</div>

> If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.

Depends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.



---

archive/issue_comments_366645.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@rwst](#comment:9):\n> > If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.\n\n> \n> Depends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.\n\nThanks for your answer. However, I am afraid I still don't understand; when you suggest to not call the walker from within the walker, this amounts to suppress these lines:\n\n```\n                if 'sqrt(' in str(argum):\n                    argum = self(argum)  # treatment of nested sqrt's\n```\ncorrect?\nThen in the example of [comment:8](#comment:8), how are we going to reach first `sqrt(b)`? To be depth-first, it seems to me that some recursion is required, as in the above  `self(argum)`.",
    "created_at": "2017-11-19T10:51:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366645",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@rwst](#comment:9):
> > If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.

> 
> Depends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.

Thanks for your answer. However, I am afraid I still don't understand; when you suggest to not call the walker from within the walker, this amounts to suppress these lines:

```
                if 'sqrt(' in str(argum):
                    argum = self(argum)  # treatment of nested sqrt's
```
correct?
Then in the example of [comment:8](#comment:8), how are we going to reach first `sqrt(b)`? To be depth-first, it seems to me that some recursion is required, as in the above  `self(argum)`.



---

archive/issue_comments_366646.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe recursion is provided by the superclasses of the walker.",
    "created_at": "2017-11-20T09:48:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366646",
    "user": "https://github.com/rwst"
}
```

<div id="comment:11" align="right">comment:11</div>

The recursion is provided by the superclasses of the walker.



---

archive/issue_comments_366647.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@rwst](#comment:11):\n> The recursion is provided by the superclasses of the walker.\n\nNo, it does not seem to be the case, because of the `return simpl` in line 190 of https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/manifolds/utilities.py?id=0c7b9ea177eeb653de9a2987ea60920acaa96d88\n\nConsider for instance the following example; with the current version, we have\n\n```\nsage: from sage.manifolds.utilities import SimplifySqrtReal\nsage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()\nsqrt(abs(x) + 1)\n```\nwhich is correct, given we have no sign assumption on `x`. Now, if we replace `argum = self(argum)` in line 170 of the above file by `pass`, we get\n\n```\nsage: from sage.manifolds.utilities import SimplifySqrtReal\nsage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()\nsqrt(x + 1)\n```\nwhich is a wrong result; it shows that only the outermost `sqrt` has been treated, by passing its argument (i.e. `1 + sqrt(x^2)`) to `radcan`, which has oversimplified it to `x + 1`. Even if we call the walker in a loop until no change happens, there is no way that the `x + 1` get transformed to `abs(x) + 1`. Am I missing something?",
    "created_at": "2017-11-20T13:20:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366647",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@rwst](#comment:11):
> The recursion is provided by the superclasses of the walker.

No, it does not seem to be the case, because of the `return simpl` in line 190 of https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/manifolds/utilities.py?id=0c7b9ea177eeb653de9a2987ea60920acaa96d88

Consider for instance the following example; with the current version, we have

```
sage: from sage.manifolds.utilities import SimplifySqrtReal
sage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()
sqrt(abs(x) + 1)
```
which is correct, given we have no sign assumption on `x`. Now, if we replace `argum = self(argum)` in line 170 of the above file by `pass`, we get

```
sage: from sage.manifolds.utilities import SimplifySqrtReal
sage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()
sqrt(x + 1)
```
which is a wrong result; it shows that only the outermost `sqrt` has been treated, by passing its argument (i.e. `1 + sqrt(x^2)`) to `radcan`, which has oversimplified it to `x + 1`. Even if we call the walker in a loop until no change happens, there is no way that the `x + 1` get transformed to `abs(x) + 1`. Am I missing something?



---

archive/issue_comments_366648.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nFirst, it was nonsense from me to say the walker should not call itself. I forgot that this is done all the time by walkers. Also I naively gave you a solution idea from a different case. Then my dislike just boils down to the usage of `str()`. The first usage could be replaced with `...has(sqrt(w0)) or ... has(1/sqrt(w0))` with `w0=SR.wild()`. You test on top of the function for `w0^(1/2)` and later using `str` for `w0^(1/2)` and `w0^(-1/2)` but you can replace it all with `...match(w0^(1/2))` and `...match(w0^(-1/2))`.\n\nI'm sorry that my directions were so completely off this time and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.",
    "created_at": "2017-11-20T14:17:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366648",
    "user": "https://github.com/rwst"
}
```

<div id="comment:13" align="right">comment:13</div>

First, it was nonsense from me to say the walker should not call itself. I forgot that this is done all the time by walkers. Also I naively gave you a solution idea from a different case. Then my dislike just boils down to the usage of `str()`. The first usage could be replaced with `...has(sqrt(w0)) or ... has(1/sqrt(w0))` with `w0=SR.wild()`. You test on top of the function for `w0^(1/2)` and later using `str` for `w0^(1/2)` and `w0^(-1/2)` but you can replace it all with `...match(w0^(1/2))` and `...match(w0^(-1/2))`.

I'm sorry that my directions were so completely off this time and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.



---

archive/issue_comments_366649.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@rwst](#comment:13):\n> I'm sorry that my directions were so completely off this time \n\nNo problem at all.\n\n> and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.\n\nThank you for your suggestion! I am just implementing the wildcard solution at the moment.",
    "created_at": "2017-11-20T15:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366649",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@rwst](#comment:13):
> I'm sorry that my directions were so completely off this time 

No problem at all.

> and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.

Thank you for your suggestion! I am just implementing the wildcard solution at the moment.



---

archive/issue_comments_366650.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@egourgoulhon](#comment:14):\n\n> Thank you for your suggestion! I am just implementing the wildcard solution at the moment. \n\nHence the needs_work status.",
    "created_at": "2017-11-20T16:10:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366650",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@egourgoulhon](#comment:14):

> Thank you for your suggestion! I am just implementing the wildcard solution at the moment. 

Hence the needs_work status.



---

archive/issue_events_333267.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-20T16:10:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333267"
}
```



---

archive/issue_events_333268.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-20T16:10:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333268"
}
```



---

archive/issue_comments_366651.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4\"><code>ec105bb</code></a></td><td><code>Use of wildcards for pattern search in simplifications regarding calculus on manifolds</code></td></tr></table>\n",
    "created_at": "2017-11-21T10:42:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366651",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4"><code>ec105bb</code></a></td><td><code>Use of wildcards for pattern search in simplifications regarding calculus on manifolds</code></td></tr></table>




---

archive/issue_comments_366652.json:
```json
{
    "body": "Changed commit from **[`61d97c2`](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)** to **[`ec105bb`](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)**",
    "created_at": "2017-11-21T10:42:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366652",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`61d97c2`](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)** to **[`ec105bb`](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)**



---

archive/issue_comments_366653.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThe last commit gets rid of any string manipulation in `SimplifySqrtReal` and `SimplifyAbsTrig`, following the suggestion in [comment:13](#comment:13).",
    "created_at": "2017-11-21T10:45:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366653",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:17" align="right">comment:17</div>

The last commit gets rid of any string manipulation in `SimplifySqrtReal` and `SimplifyAbsTrig`, following the suggestion in [comment:13](#comment:13).



---

archive/issue_events_333269.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-21T10:45:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333269"
}
```



---

archive/issue_events_333270.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-21T10:45:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333270"
}
```



---

archive/issue_comments_366654.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nBuilds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.\nSo far, randomly selected worksheets complete successfully and correctly.\n\nMy only residual concern is that from an architectural perspective, these corrections and optimizations reflect less than adequate functionality in the main Sage simplification chain. Logically, it appears the changes should go live there, but practically, they must remain inside manifolds/utilities.py. \n\nI should add that the code is now easy to comprehend.",
    "created_at": "2017-11-21T18:09:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366654",
    "user": "https://github.com/rll2021"
}
```

<div id="comment:18" align="right">comment:18</div>

Builds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.
So far, randomly selected worksheets complete successfully and correctly.

My only residual concern is that from an architectural perspective, these corrections and optimizations reflect less than adequate functionality in the main Sage simplification chain. Logically, it appears the changes should go live there, but practically, they must remain inside manifolds/utilities.py. 

I should add that the code is now easy to comprehend.



---

archive/issue_events_333271.json:
```json
{
    "actor": "https://github.com/rll2021",
    "created_at": "2017-11-21T18:09:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333271"
}
```



---

archive/issue_events_333272.json:
```json
{
    "actor": "https://github.com/rll2021",
    "created_at": "2017-11-21T18:09:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333272"
}
```



---

archive/issue_comments_366655.json:
```json
{
    "body": "Changed reviewer from **Travis Scrimshaw, Ralf Stephan** to **Travis Scrimshaw, Ralf Stephan, Richard L Lozes**",
    "created_at": "2017-11-21T18:09:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366655",
    "user": "https://github.com/rll2021"
}
```

Changed reviewer from **Travis Scrimshaw, Ralf Stephan** to **Travis Scrimshaw, Ralf Stephan, Richard L Lozes**



---

archive/issue_comments_366656.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@rll2021](#comment:18):\n> Builds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.\n> So far, randomly selected worksheets complete successfully and correctly.\n> \n\nThank you for these extra tests. \n\nThank you all for the comments, suggestions and the review!",
    "created_at": "2017-11-22T15:01:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366656",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@rll2021](#comment:18):
> Builds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.
> So far, randomly selected worksheets complete successfully and correctly.
> 

Thank you for these extra tests. 

Thank you all for the comments, suggestions and the review!



---

archive/issue_events_333273.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:02:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333273"
}
```



---

archive/issue_events_333274.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d92697baa0b85afa0c3832add863512ec2b1a38f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-12-11T01:02:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24232#event-333274"
}
```



---

archive/issue_comments_366657.json:
```json
{
    "body": "Changed branch from **[public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)** to **[`ec105bb`](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)**",
    "created_at": "2017-12-11T01:02:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24232#issuecomment-366657",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)** to **[`ec105bb`](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)**
