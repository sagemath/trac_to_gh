# Issue 24232: Simplifications in calculus on manifolds via the expression tree

archive/issues_023995.json:
```json
{
    "body": "This ticket performs a full reimplementation of the functions\n- `sage.manifolds.utilities.simplify_sqrt_real` \n- `sage.manifolds.utilities.simplify_abs_trig`\nwhich are involved in calculus on manifolds (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/utilities.html#sage.manifolds.utilities.simplify_chain_real)). Instead of manipulating string representations of symbolic expressions, as previously, this ticket is based on direct manipulations of the expression tree, via the introduction of two subclasses of [ExpressionTreeWalker](http://doc.sagemath.org/html/en/reference/calculus/sage/symbolic/expression_conversions.html#sage.symbolic.expression_conversions.ExpressionTreeWalker).\n\nRegarding the functionalities, the code in this ticket leads to the same improvements as those described in #24199, which was based on string manipulations.\n\n**CC:**  @rwst @tscrim @rll2021 @man74cio\n\n**Keywords:** manifold calculus\n\n**Branch/Commit:** [ec105bbb42a97c9ac2bff745112688c655a0ecb4](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)\n\n**Reviewer:** Travis Scrimshaw, Ralf Stephan, Richard L Lozes\n\n**Author:** Eric Gourgoulhon\n\nIssue created by migration from https://trac.sagemath.org/ticket/24232\n\n",
    "closed_at": "2017-12-11T01:02:03Z",
    "created_at": "2017-11-17T11:10:07Z",
    "labels": [
        "component: geometry",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Simplifications in calculus on manifolds via the expression tree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24232",
    "user": "https://github.com/egourgoulhon"
}
```
This ticket performs a full reimplementation of the functions
- `sage.manifolds.utilities.simplify_sqrt_real` 
- `sage.manifolds.utilities.simplify_abs_trig`
which are involved in calculus on manifolds (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/utilities.html#sage.manifolds.utilities.simplify_chain_real)). Instead of manipulating string representations of symbolic expressions, as previously, this ticket is based on direct manipulations of the expression tree, via the introduction of two subclasses of [ExpressionTreeWalker](http://doc.sagemath.org/html/en/reference/calculus/sage/symbolic/expression_conversions.html#sage.symbolic.expression_conversions.ExpressionTreeWalker).

Regarding the functionalities, the code in this ticket leads to the same improvements as those described in #24199, which was based on string manipulations.

**CC:**  @rwst @tscrim @rll2021 @man74cio

**Keywords:** manifold calculus

**Branch/Commit:** [ec105bbb42a97c9ac2bff745112688c655a0ecb4](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)

**Reviewer:** Travis Scrimshaw, Ralf Stephan, Richard L Lozes

**Author:** Eric Gourgoulhon

Issue created by migration from https://trac.sagemath.org/ticket/24232





---

archive/issue_comments_370849.json:
```json
{
    "body": "**Commit:** [7e5baa5a956794176c965cd5555c83e79d37b20b](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)",
    "created_at": "2017-11-17T11:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370849",
    "user": "https://github.com/egourgoulhon"
}
```

**Commit:** [7e5baa5a956794176c965cd5555c83e79d37b20b](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)



---

archive/issue_events_219147.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-17T11:15:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219147"
}
```



---

archive/issue_comments_370850.json:
```json
{
    "body": "**Branch:** [public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)",
    "created_at": "2017-11-17T11:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370850",
    "user": "https://github.com/egourgoulhon"
}
```

**Branch:** [public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)



---

archive/issue_comments_370851.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b\">7e5baa5</a></td><td><code>Reimplement simplifications in calculus on manifolds via the expression tree</code></td></tr></table>\n",
    "created_at": "2017-11-17T11:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370851",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b">7e5baa5</a></td><td><code>Reimplement simplifications in calculus on manifolds via the expression tree</code></td></tr></table>




---

archive/issue_comments_370852.json:
```json
{
    "body": "<a id='comment:2'></a>\nQuick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:\n\n```python\n    def __init__(self, ex):\n        r\"\"\"\n        Construct a SimplifySqrtReal object.\n\n        TESTS::\n\n            sage: from sage.manifolds.utilities import SimplifySqrtReal\n            sage: s = SimplifySqrtReal(1+sqrt((x+1)^2))\n            sage: type(s)\n            <class 'sage.manifolds.utilities.SimplifySqrtReal'>\n\n        \"\"\"\n        ExpressionTreeWalker.__init__(self, ex)\n```\nMoreover, the test does not feel so useful, so I would just delete the whole thing.",
    "created_at": "2017-11-17T13:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370852",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
Quick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:

```python
    def __init__(self, ex):
        r"""
        Construct a SimplifySqrtReal object.

        TESTS::

            sage: from sage.manifolds.utilities import SimplifySqrtReal
            sage: s = SimplifySqrtReal(1+sqrt((x+1)^2))
            sage: type(s)
            <class 'sage.manifolds.utilities.SimplifySqrtReal'>

        """
        ExpressionTreeWalker.__init__(self, ex)
```
Moreover, the test does not feel so useful, so I would just delete the whole thing.



---

archive/issue_comments_370853.json:
```json
{
    "body": "**Changing commit** from \"[7e5baa5a956794176c965cd5555c83e79d37b20b](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)\" to \"[61d97c242aaa27f446d58af4e15fbe6d16dfe3f8](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)\".",
    "created_at": "2017-11-17T16:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370853",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7e5baa5a956794176c965cd5555c83e79d37b20b](https://github.com/sagemath/sagetrac-mirror/commit/7e5baa5a956794176c965cd5555c83e79d37b20b)" to "[61d97c242aaa27f446d58af4e15fbe6d16dfe3f8](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)".



---

archive/issue_comments_370854.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8\">61d97c2</a></td><td><code>Remove unnecessary `__init__` and slightly change in the treatment of 1/sqrt(...)</code></td></tr></table>\n",
    "created_at": "2017-11-17T16:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370854",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8">61d97c2</a></td><td><code>Remove unnecessary `__init__` and slightly change in the treatment of 1/sqrt(...)</code></td></tr></table>




---

archive/issue_comments_370855.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [tscrim](#comment%3A2):\n> Quick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:\n\n>\n> Moreover, the test does not feel so useful, so I would just delete the whole thing.\n\n\nThank you for pointing this. You are of course perfectly right! The above commit suppresses the `__init__`'s. Moreover, it changes slightly the way `pow(x,-1/2)` is dealt with: the inverse is now taken at the very end of the simplification. This is more coherent and, on some tests I've performed, this leads to slightly better results.",
    "created_at": "2017-11-17T16:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370855",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:4'></a>
Replying to [tscrim](#comment%3A2):
> Quick comment, these methods are unnecessary as `__init__` will be naturally inherited and so, this would help keep possible bugs out:

>
> Moreover, the test does not feel so useful, so I would just delete the whole thing.


Thank you for pointing this. You are of course perfectly right! The above commit suppresses the `__init__`'s. Moreover, it changes slightly the way `pow(x,-1/2)` is dealt with: the inverse is now taken at the very end of the simplification. This is more coherent and, on some tests I've performed, this leads to slightly better results.



---

archive/issue_comments_370856.json:
```json
{
    "body": "<a id='comment:5'></a>\nLGTM as far as I can tell. Ralf, do you have any comments/suggestions?",
    "created_at": "2017-11-17T21:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370856",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
LGTM as far as I can tell. Ralf, do you have any comments/suggestions?



---

archive/issue_comments_370857.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2017-11-17T21:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370857",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_370858.json:
```json
{
    "body": "<a id='comment:6'></a>\nSorry coming late. The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.\n\nSo, for me this is good and, as the other reviewers and patchbots are happy, positive.",
    "created_at": "2017-11-18T07:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370858",
    "user": "https://github.com/rwst"
}
```

<a id='comment:6'></a>
Sorry coming late. The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.

So, for me this is good and, as the other reviewers and patchbots are happy, positive.



---

archive/issue_events_219148.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219148"
}
```



---

archive/issue_events_219149.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219149"
}
```



---

archive/issue_events_219150.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219150"
}
```



---

archive/issue_events_219151.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-11-18T07:23:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219151"
}
```



---

archive/issue_comments_370859.json:
```json
{
    "body": "**Changing reviewer** from \"Travis Scrimshaw\" to \"Travis Scrimshaw, Ralf Stephan\".",
    "created_at": "2017-11-18T07:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370859",
    "user": "https://github.com/rwst"
}
```

**Changing reviewer** from "Travis Scrimshaw" to "Travis Scrimshaw, Ralf Stephan".



---

archive/issue_comments_370860.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [rws](#comment%3A6):\n> ...but instead simply call the walker in a loop as long as the result is different from the original.\n\n\nEven better would be to set a flag when you change something and loop as long as the flag is set. If you define the walker class inside the function that calls it you don't even need to make the flag global.",
    "created_at": "2017-11-18T07:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370860",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>
Replying to [rws](#comment%3A6):
> ...but instead simply call the walker in a loop as long as the result is different from the original.


Even better would be to set a flag when you change something and loop as long as the flag is set. If you define the walker class inside the function that calls it you don't even need to make the flag global.



---

archive/issue_comments_370861.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [rws](#comment%3A6):\n> Sorry coming late.\n\n\nWell, showing up in a ticket less than 24 h after its creation is not what I would call late ;-)\nThank you for your feedback!\n\n> The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. \n\n\nIf I understand correctly (which is not guaranteed...), this would change the ordering of simplification. Take for instance the expression\n\n```\nex = sqrt(a + sqrt(b))\n```\nwhere `a` and `b` are potentially complicated expressions. As it is currently, the walker will simplify first `sqrt(b)` (to `c` say) and then `sqrt(a+c)`. If we call the walker in a loop as long as the outcome changes, it will first try to simplify `sqrt(a + sqrt(b))`, leaving `sqrt(b)` as it is. In the second round only, it will try to simplify `sqrt(b)`. Am I correct? If yes, this would mean that the current version simplifies nested sqrt's from the innermost one to the outermost one, while the loop version will do the opposite. For other type of operations, this may be equivalent, but simplifications are more likely to succeed if we start from the smaller parts, i.e. the innermost ones, like `sqrt(b)`. Do you agree?\n\n>However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.\n> \n\n\nI've seen it is #24236. This will be very useful, thank you!",
    "created_at": "2017-11-18T17:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370861",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>
Replying to [rws](#comment%3A6):
> Sorry coming late.


Well, showing up in a ticket less than 24 h after its creation is not what I would call late ;-)
Thank you for your feedback!

> The tree walking is done and documented well except it would enhance the code somewhat to not call the walker from within the walker, but instead simply call the walker in a loop as long as the result is different from the original. This is still efficient. 


If I understand correctly (which is not guaranteed...), this would change the ordering of simplification. Take for instance the expression

```
ex = sqrt(a + sqrt(b))
```
where `a` and `b` are potentially complicated expressions. As it is currently, the walker will simplify first `sqrt(b)` (to `c` say) and then `sqrt(a+c)`. If we call the walker in a loop as long as the outcome changes, it will first try to simplify `sqrt(a + sqrt(b))`, leaving `sqrt(b)` as it is. In the second round only, it will try to simplify `sqrt(b)`. Am I correct? If yes, this would mean that the current version simplifies nested sqrt's from the innermost one to the outermost one, while the loop version will do the opposite. For other type of operations, this may be equivalent, but simplifications are more likely to succeed if we start from the smaller parts, i.e. the innermost ones, like `sqrt(b)`. Do you agree?

>However note in this case that the most efficient way to compare expressions structurally is to call `ex1._gobj.is_equal(ex2._gobj)` in a Cython file. Still fast in Python is `(ex1-ex2).is_trivial_zero()`. I'll open a ticket that exposes `is_equal` for Python users.
> 


I've seen it is #24236. This will be very useful, thank you!



---

archive/issue_comments_370862.json:
```json
{
    "body": "<a id='comment:9'></a>\n> If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.\n\n\nDepends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.",
    "created_at": "2017-11-19T07:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370862",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>
> If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.


Depends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.



---

archive/issue_comments_370863.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [rws](#comment%3A9):\n> > If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.\n\n> \n> Depends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.\n\n\nThanks for your answer. However, I am afraid I still don't understand; when you suggest to not call the walker from within the walker, this amounts to suppress these lines:\n\n```\n                if 'sqrt(' in str(argum):\n                    argum = self(argum)  # treatment of nested sqrt's\n```\ncorrect?\nThen in the example of [comment:8](#comment%3A8), how are we going to reach first `sqrt(b)`? To be depth-first, it seems to me that some recursion is required, as in the above  `self(argum)`.",
    "created_at": "2017-11-19T10:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370863",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>
Replying to [rws](#comment%3A9):
> > If I understand correctly (which is not guaranteed...), this would change the ordering of simplification.

> 
> Depends on the type of walker which is depth-first with any `ExpressionTreeWalker` as I understand, so the outcome would be actually the same.


Thanks for your answer. However, I am afraid I still don't understand; when you suggest to not call the walker from within the walker, this amounts to suppress these lines:

```
                if 'sqrt(' in str(argum):
                    argum = self(argum)  # treatment of nested sqrt's
```
correct?
Then in the example of [comment:8](#comment%3A8), how are we going to reach first `sqrt(b)`? To be depth-first, it seems to me that some recursion is required, as in the above  `self(argum)`.



---

archive/issue_comments_370864.json:
```json
{
    "body": "<a id='comment:11'></a>\nThe recursion is provided by the superclasses of the walker.",
    "created_at": "2017-11-20T09:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370864",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>
The recursion is provided by the superclasses of the walker.



---

archive/issue_comments_370865.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [rws](#comment%3A11):\n> The recursion is provided by the superclasses of the walker.\n\nNo, it does not seem to be the case, because of the `return simpl` in line 190 of https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/manifolds/utilities.py?id=0c7b9ea177eeb653de9a2987ea60920acaa96d88\n\nConsider for instance the following example; with the current version, we have\n\n```\nsage: from sage.manifolds.utilities import SimplifySqrtReal\nsage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()\nsqrt(abs(x) + 1)\n```\nwhich is correct, given we have no sign assumption on `x`. Now, if we replace `argum = self(argum)` in line 170 of the above file by `pass`, we get\n\n```\nsage: from sage.manifolds.utilities import SimplifySqrtReal\nsage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()\nsqrt(x + 1)\n```\nwhich is a wrong result; it shows that only the outermost `sqrt` has been treated, by passing its argument (i.e. `1 + sqrt(x^2)`) to `radcan`, which has oversimplified it to `x + 1`. Even if we call the walker in a loop until no change happens, there is no way that the `x + 1` get transformed to `abs(x) + 1`. Am I missing something?",
    "created_at": "2017-11-20T13:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370865",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>
Replying to [rws](#comment%3A11):
> The recursion is provided by the superclasses of the walker.

No, it does not seem to be the case, because of the `return simpl` in line 190 of https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/manifolds/utilities.py?id=0c7b9ea177eeb653de9a2987ea60920acaa96d88

Consider for instance the following example; with the current version, we have

```
sage: from sage.manifolds.utilities import SimplifySqrtReal
sage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()
sqrt(abs(x) + 1)
```
which is correct, given we have no sign assumption on `x`. Now, if we replace `argum = self(argum)` in line 170 of the above file by `pass`, we get

```
sage: from sage.manifolds.utilities import SimplifySqrtReal
sage: SimplifySqrtReal(sqrt(1 + sqrt(x^2)))()
sqrt(x + 1)
```
which is a wrong result; it shows that only the outermost `sqrt` has been treated, by passing its argument (i.e. `1 + sqrt(x^2)`) to `radcan`, which has oversimplified it to `x + 1`. Even if we call the walker in a loop until no change happens, there is no way that the `x + 1` get transformed to `abs(x) + 1`. Am I missing something?



---

archive/issue_comments_370866.json:
```json
{
    "body": "<a id='comment:13'></a>\nFirst, it was nonsense from me to say the walker should not call itself. I forgot that this is done all the time by walkers. Also I naively gave you a solution idea from a different case. Then my dislike just boils down to the usage of `str()`. The first usage could be replaced with `...has(sqrt(w0)) or ... has(1/sqrt(w0))` with `w0=SR.wild()`. You test on top of the function for `w0^(1/2)` and later using `str` for `w0^(1/2)` and `w0^(-1/2)` but you can replace it all with `...match(w0^(1/2))` and `...match(w0^(-1/2))`.\n\nI'm sorry that my directions were so completely off this time and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.",
    "created_at": "2017-11-20T14:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370866",
    "user": "https://github.com/rwst"
}
```

<a id='comment:13'></a>
First, it was nonsense from me to say the walker should not call itself. I forgot that this is done all the time by walkers. Also I naively gave you a solution idea from a different case. Then my dislike just boils down to the usage of `str()`. The first usage could be replaced with `...has(sqrt(w0)) or ... has(1/sqrt(w0))` with `w0=SR.wild()`. You test on top of the function for `w0^(1/2)` and later using `str` for `w0^(1/2)` and `w0^(-1/2)` but you can replace it all with `...match(w0^(1/2))` and `...match(w0^(-1/2))`.

I'm sorry that my directions were so completely off this time and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.



---

archive/issue_comments_370867.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [rws](#comment%3A13):\n> I'm sorry that my directions were so completely off this time \n\n\nNo problem at all.\n\n> and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.\n\n\nThank you for your suggestion! I am just implementing the wildcard solution at the moment.",
    "created_at": "2017-11-20T15:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370867",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:14'></a>
Replying to [rws](#comment%3A13):
> I'm sorry that my directions were so completely off this time 


No problem at all.

> and that I also forgot to tell about GiNaC/Pynac pattern matching, which of course is faster than any Python solution because expressions are wrapped C++ objects.


Thank you for your suggestion! I am just implementing the wildcard solution at the moment.



---

archive/issue_comments_370868.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [egourgoulhon](#comment%3A14):\n\n> Thank you for your suggestion! I am just implementing the wildcard solution at the moment. \n\n\nHence the needs_work status.",
    "created_at": "2017-11-20T16:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370868",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:15'></a>
Replying to [egourgoulhon](#comment%3A14):

> Thank you for your suggestion! I am just implementing the wildcard solution at the moment. 


Hence the needs_work status.



---

archive/issue_events_219152.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-20T16:10:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219152"
}
```



---

archive/issue_events_219153.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-20T16:10:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219153"
}
```



---

archive/issue_comments_370869.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4\">ec105bb</a></td><td><code>Use of wildcards for pattern search in simplifications regarding calculus on manifolds</code></td></tr></table>\n",
    "created_at": "2017-11-21T10:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370869",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4">ec105bb</a></td><td><code>Use of wildcards for pattern search in simplifications regarding calculus on manifolds</code></td></tr></table>




---

archive/issue_comments_370870.json:
```json
{
    "body": "**Changing commit** from \"[61d97c242aaa27f446d58af4e15fbe6d16dfe3f8](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)\" to \"[ec105bbb42a97c9ac2bff745112688c655a0ecb4](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)\".",
    "created_at": "2017-11-21T10:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370870",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[61d97c242aaa27f446d58af4e15fbe6d16dfe3f8](https://github.com/sagemath/sagetrac-mirror/commit/61d97c242aaa27f446d58af4e15fbe6d16dfe3f8)" to "[ec105bbb42a97c9ac2bff745112688c655a0ecb4](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)".



---

archive/issue_comments_370871.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe last commit gets rid of any string manipulation in `SimplifySqrtReal` and `SimplifyAbsTrig`, following the suggestion in [comment:13](#comment%3A13).",
    "created_at": "2017-11-21T10:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370871",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>
The last commit gets rid of any string manipulation in `SimplifySqrtReal` and `SimplifyAbsTrig`, following the suggestion in [comment:13](#comment%3A13).



---

archive/issue_events_219154.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-21T10:45:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219154"
}
```



---

archive/issue_events_219155.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2017-11-21T10:45:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219155"
}
```



---

archive/issue_comments_370872.json:
```json
{
    "body": "<a id='comment:18'></a>\nBuilds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.\nSo far, randomly selected worksheets complete successfully and correctly.\n\nMy only residual concern is that from an architectural perspective, these corrections and optimizations reflect less than adequate functionality in the main Sage simplification chain. Logically, it appears the changes should go live there, but practically, they must remain inside manifolds/utilities.py. \n\nI should add that the code is now easy to comprehend.",
    "created_at": "2017-11-21T18:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370872",
    "user": "https://github.com/rll2021"
}
```

<a id='comment:18'></a>
Builds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.
So far, randomly selected worksheets complete successfully and correctly.

My only residual concern is that from an architectural perspective, these corrections and optimizations reflect less than adequate functionality in the main Sage simplification chain. Logically, it appears the changes should go live there, but practically, they must remain inside manifolds/utilities.py. 

I should add that the code is now easy to comprehend.



---

archive/issue_events_219156.json:
```json
{
    "actor": "https://github.com/rll2021",
    "created_at": "2017-11-21T18:09:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219156"
}
```



---

archive/issue_events_219157.json:
```json
{
    "actor": "https://github.com/rll2021",
    "created_at": "2017-11-21T18:09:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219157"
}
```



---

archive/issue_comments_370873.json:
```json
{
    "body": "**Changing reviewer** from \"Travis Scrimshaw, Ralf Stephan\" to \"Travis Scrimshaw, Ralf Stephan, Richard L Lozes\".",
    "created_at": "2017-11-21T18:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370873",
    "user": "https://github.com/rll2021"
}
```

**Changing reviewer** from "Travis Scrimshaw, Ralf Stephan" to "Travis Scrimshaw, Ralf Stephan, Richard L Lozes".



---

archive/issue_comments_370874.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [rllozes](#comment%3A18):\n> Builds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.\n> So far, randomly selected worksheets complete successfully and correctly.\n> \n\n\nThank you for these extra tests. \n\nThank you all for the comments, suggestions and the review!",
    "created_at": "2017-11-22T15:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370874",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:19'></a>
Replying to [rllozes](#comment%3A18):
> Builds and tests cleanly atop 8.1.rc0 on an OpenSUSE 42.2 system.
> So far, randomly selected worksheets complete successfully and correctly.
> 


Thank you for these extra tests. 

Thank you all for the comments, suggestions and the review!



---

archive/issue_events_219158.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:02:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219158"
}
```



---

archive/issue_events_219159.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:02:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24232#event-219159"
}
```



---

archive/issue_comments_370875.json:
```json
{
    "body": "**Changing branch** from \"[public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)\" to \"[ec105bbb42a97c9ac2bff745112688c655a0ecb4](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)\".",
    "created_at": "2017-12-11T01:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24232#issuecomment-370875",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/manifolds/simplif_tree-24232](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/simplif_tree-24232)" to "[ec105bbb42a97c9ac2bff745112688c655a0ecb4](https://github.com/sagemath/sagetrac-mirror/commit/ec105bbb42a97c9ac2bff745112688c655a0ecb4)".
