# Issue 24647: Stricter locking around sage-rebase on Cygwin

archive/issues_024410.json:
```json
{
    "assignees": [],
    "body": "In #23397 I added a file lock around running `sage-rebase.sh` at the end of every package install on Cygwin, in an effort to reduce errors when multiple packages run `sage-rebase.sh` simultaneously during parallel builds.\n\nUnfortunately, it seems this was not enough--it's possible to get errors during parallel builds if `sage-rebase.sh` is run during the build/installation of some packages.\n\nSo with this change (on Cygwin only of course) all build processes obtain a shared lock on `rebase.lock`, and then `sage-rebase.sh` is run under an exclusive lock.\n\nThis unfortunately slows down parallel builds--for any N packages being built simultaneously, all packages in that set have to wait whichever one takes the longest to build.  But I think this is a necessary sacrifice in order for the builds to not run into this problem.  In the future it may be possible to make this more fine-grained; after all it isn't strictly necessary to run `rebase` for every package (only those that install DLLs).\n\nKeywords: **rebase**\n\nBranch: **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)**\n\nReviewer: **Emmanuel Charpentier**\n\nAuthor: **Erik Bray**\n\nComponent: **porting: Cygwin**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24647_\n\n",
    "closed_at": "2018-03-21T06:18:51Z",
    "created_at": "2018-02-02T15:01:20Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Stricter locking around sage-rebase on Cygwin",
    "type": "issue",
    "updated_at": "2018-03-21T17:01:24Z",
    "url": "https://github.com/sagemath/sage/issues/24647",
    "user": "https://github.com/embray"
}
```
In #23397 I added a file lock around running `sage-rebase.sh` at the end of every package install on Cygwin, in an effort to reduce errors when multiple packages run `sage-rebase.sh` simultaneously during parallel builds.

Unfortunately, it seems this was not enough--it's possible to get errors during parallel builds if `sage-rebase.sh` is run during the build/installation of some packages.

So with this change (on Cygwin only of course) all build processes obtain a shared lock on `rebase.lock`, and then `sage-rebase.sh` is run under an exclusive lock.

This unfortunately slows down parallel builds--for any N packages being built simultaneously, all packages in that set have to wait whichever one takes the longest to build.  But I think this is a necessary sacrifice in order for the builds to not run into this problem.  In the future it may be possible to make this more fine-grained; after all it isn't strictly necessary to run `rebase` for every package (only those that install DLLs).

Keywords: **rebase**

Branch: **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)**

Reviewer: **Emmanuel Charpentier**

Author: **Erik Bray**

Component: **porting: Cygwin**

_Issue created by migration from https://trac.sagemath.org/ticket/24647_





---

archive/issue_events_341270.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T15:01:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341270"
}
```



---

archive/issue_events_341271.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T15:01:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341271"
}
```



---

archive/issue_events_341272.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T15:01:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341272"
}
```



---

archive/issue_events_341273.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T15:01:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341273"
}
```



---

archive/issue_events_341274.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T15:01:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341274"
}
```



---

archive/issue_comments_373884.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nDoes Cygwin support `/dev/fd`? That might be a simpler solution to deal with locks from a file descriptor.",
    "created_at": "2018-02-02T15:18:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373884",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

Does Cygwin support `/dev/fd`? That might be a simpler solution to deal with locks from a file descriptor.



---

archive/issue_comments_373885.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nIt does, but I'm not exactly sure what you're proposing.  This is reasonably simple as-is and less platform-dependent.",
    "created_at": "2018-02-02T15:40:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373885",
    "user": "https://github.com/embray"
}
```

<div id="comment:3" align="right">comment:3</div>

It does, but I'm not exactly sure what you're proposing.  This is reasonably simple as-is and less platform-dependent.



---

archive/issue_comments_373886.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n In #23397 I added a file lock around running `sage-rebase.sh` at the end of every package install on Cygwin, in an effort to reduce errors when multiple packages run `sage-rebase.sh` simultaneously during parallel builds.\n \n-Unfortunately, it seems this was not enough--it's possible to get errors during parallel builds of `sage-rebase.sh` is run during the build/installation of some packages.\n+Unfortunately, it seems this was not enough--it's possible to get errors during parallel builds if `sage-rebase.sh` is run during the build/installation of some packages.\n \n So with this change (on Cygwin only of course) all build processes obtain a shared lock on `rebase.lock`, and then `sage-rebase.sh` is run under an exclusive lock.\n \n``````\n",
    "created_at": "2018-03-09T13:34:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373886",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 In #23397 I added a file lock around running `sage-rebase.sh` at the end of every package install on Cygwin, in an effort to reduce errors when multiple packages run `sage-rebase.sh` simultaneously during parallel builds.
 
-Unfortunately, it seems this was not enough--it's possible to get errors during parallel builds of `sage-rebase.sh` is run during the build/installation of some packages.
+Unfortunately, it seems this was not enough--it's possible to get errors during parallel builds if `sage-rebase.sh` is run during the build/installation of some packages.
 
 So with this change (on Cygwin only of course) all build processes obtain a shared lock on `rebase.lock`, and then `sage-rebase.sh` is run under an exclusive lock.
 
``````




---

archive/issue_events_341275.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2018-03-12T09:43:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341275"
}
```



---

archive/issue_events_341276.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2018-03-12T09:43:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341276"
}
```



---

archive/issue_comments_373887.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n\n[BTW: I had to edit `call :READREGISTRY HKEY_LOCAL_MACHINE\\SOFTWARE\\Cygwin\\setup rootdir` to `call :READREGISTRY HKEY_CURRENT_USER\\SOFTWARE\\Cygwin\\setup rootdir` : I have no admin rights on the machine I'm trying this on...).\n\nThis happened twice. A third attempt worked after waiting about 20 minutes. Go figure...\n\nThis should probably documented at least in the information message (`\"Now waiting for the rebase lock. This might be long...\"`) and possibly in the [Cygwin port page](https://trac.sagemath.org/wiki/Cygwin64Port).\n\n==> tentatively `needs_work`\n\n[ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.",
    "created_at": "2018-03-12T09:43:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373887",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:5" align="right">comment:5</div>

I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.

[BTW: I had to edit `call :READREGISTRY HKEY_LOCAL_MACHINE\SOFTWARE\Cygwin\setup rootdir` to `call :READREGISTRY HKEY_CURRENT_USER\SOFTWARE\Cygwin\setup rootdir` : I have no admin rights on the machine I'm trying this on...).

This happened twice. A third attempt worked after waiting about 20 minutes. Go figure...

This should probably documented at least in the information message (`"Now waiting for the rebase lock. This might be long..."`) and possibly in the [Cygwin port page](https://trac.sagemath.org/wiki/Cygwin64Port).

==> tentatively `needs_work`

[ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.



---

archive/issue_comments_373888.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@EmmanuelCharpentier](#comment:5):\n> [ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.\n\nThat's what this is trying to resolve.",
    "created_at": "2018-03-12T13:03:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373888",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@EmmanuelCharpentier](#comment:5):
> [ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.

That's what this is trying to resolve.



---

archive/issue_comments_373889.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@EmmanuelCharpentier](#comment:5):\n> I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n\nI think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...",
    "created_at": "2018-03-12T13:06:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373889",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@EmmanuelCharpentier](#comment:5):
> I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.

I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...



---

archive/issue_comments_373890.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI think I might see the problem.  It's the same reason I added an explicit `echo \"Waiting for rebase lock\"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.",
    "created_at": "2018-03-12T13:18:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373890",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

I think I might see the problem.  It's the same reason I added an explicit `echo "Waiting for rebase lock"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.



---

archive/issue_comments_373891.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@embray](#comment:7):\n> Replying to [@EmmanuelCharpentier](#comment:5):\n> > I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n\n> \n> I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...\n\nRegarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.",
    "created_at": "2018-03-12T13:48:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373891",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@embray](#comment:7):
> Replying to [@EmmanuelCharpentier](#comment:5):
> > I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.

> 
> I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...

Regarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.



---

archive/issue_comments_373892.json:
```json
{
    "body": "Attachment: **[dochtml.log.gz](https://github.com/sagemath/sage/files/ticket24647/dochtml.log.gz)**\n\nLog of two attempts to make the documentation with MAKE==\"make -j4\"",
    "created_at": "2018-03-12T16:07:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373892",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Attachment: **[dochtml.log.gz](https://github.com/sagemath/sage/files/ticket24647/dochtml.log.gz)**

Log of two attempts to make the documentation with MAKE=="make -j4"



---

archive/issue_comments_373893.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@embray](#comment:9):\n> Replying to [@embray](#comment:7):\n> > Replying to [@EmmanuelCharpentier](#comment:5):\n> > > I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n\n> > \n> > I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...\n\n> \n> Regarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.\n\nThat would be a problem of delay.\n\nSo this might be related : I can't finish make (with MAKE=\"make -j4\") on this machine ; it fails reporting a timeout in a forked process. See the uploaded log.\n\nI'll unset MAKE and try to finish this one.",
    "created_at": "2018-03-12T16:10:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373893",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@embray](#comment:9):
> Replying to [@embray](#comment:7):
> > Replying to [@EmmanuelCharpentier](#comment:5):
> > > I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.

> > 
> > I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...

> 
> Regarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.

That would be a problem of delay.

So this might be related : I can't finish make (with MAKE="make -j4") on this machine ; it fails reporting a timeout in a forked process. See the uploaded log.

I'll unset MAKE and try to finish this one.



---

archive/issue_comments_373894.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI can't seem to reproduce the problem of the output hanging, but I feel like I have seen it before, but I don't remember in exactly what context.",
    "created_at": "2018-03-12T16:42:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373894",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

I can't seem to reproduce the problem of the output hanging, but I feel like I have seen it before, but I don't remember in exactly what context.



---

archive/issue_comments_373895.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@EmmanuelCharpentier](#comment:10):\n\n[ Snip... ]\n\n> I'll unset MAKE and try to finish this one.\n\nA serial make finished successfully un abouy 15 minutes (the last unsuccesful attempt to parallel make (which was only for docs) took 23 minutes).\n\nFWIW, my various attempts to parallel make took about 22h30min of registered computing time, not that far of the 27h12min and some change needed by my previous serial building of 8.2.beta5(IIRC).\n\nThe elapsed time was much longer, sice I didn't attend to all the build and discovered errors after coming back to my office after ( night | lunch | another night ).\n\nAt least on my present machine, parallel building seems currently a losing proposition.\n\nI also noticed a strong tendency to trashing (a coexistent Chrome window completely stopped responding several times...) : 8 GB RAM might be insufficient for safely building sage on 4 threads...",
    "created_at": "2018-03-12T16:44:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373895",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@EmmanuelCharpentier](#comment:10):

[ Snip... ]

> I'll unset MAKE and try to finish this one.

A serial make finished successfully un abouy 15 minutes (the last unsuccesful attempt to parallel make (which was only for docs) took 23 minutes).

FWIW, my various attempts to parallel make took about 22h30min of registered computing time, not that far of the 27h12min and some change needed by my previous serial building of 8.2.beta5(IIRC).

The elapsed time was much longer, sice I didn't attend to all the build and discovered errors after coming back to my office after ( night | lunch | another night ).

At least on my present machine, parallel building seems currently a losing proposition.

I also noticed a strong tendency to trashing (a coexistent Chrome window completely stopped responding several times...) : 8 GB RAM might be insufficient for safely building sage on 4 threads...



---

archive/issue_comments_373896.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda",
    "created_at": "2018-03-12T18:36:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373896",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda



---

archive/issue_comments_373897.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@embray](#comment:8):\n> I think I might see the problem.  It's the same reason I added an explicit `echo \"Waiting for rebase lock\"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.\n\nIn retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...",
    "created_at": "2018-03-12T18:46:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373897",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@embray](#comment:8):
> I think I might see the problem.  It's the same reason I added an explicit `echo "Waiting for rebase lock"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.

In retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...



---

archive/issue_comments_373898.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.",
    "created_at": "2018-03-12T18:53:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373898",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.



---

archive/issue_comments_373899.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26f2603455b8b2b13e2e60d9e7110b8dc690b086\"><code>26f2603</code></a></td><td><code>Adds a couple new features to sage-flock borrowed from the standard flock command:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7bfda9556cd619d24b193b15f02803b621860374\"><code>7bfda95</code></a></td><td><code>Stricter locking around sage-rebase on Cygwin</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898\"><code>188b546</code></a></td><td><code>Ensure that SAGE_LOCAL/var/lock actually exists</code></td></tr></table>\n",
    "created_at": "2018-03-12T19:02:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373899",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26f2603455b8b2b13e2e60d9e7110b8dc690b086"><code>26f2603</code></a></td><td><code>Adds a couple new features to sage-flock borrowed from the standard flock command:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7bfda9556cd619d24b193b15f02803b621860374"><code>7bfda95</code></a></td><td><code>Stricter locking around sage-rebase on Cygwin</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898"><code>188b546</code></a></td><td><code>Ensure that SAGE_LOCAL/var/lock actually exists</code></td></tr></table>




---

archive/issue_comments_373900.json:
```json
{
    "body": "Changed commit from **[`2f009ef`](https://github.com/sagemath/sagetrac-mirror/commit/2f009ef30842c65fa67fcf0afc2d7e3e27ad5305)** to **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)**",
    "created_at": "2018-03-12T19:02:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373900",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2f009ef`](https://github.com/sagemath/sagetrac-mirror/commit/2f009ef30842c65fa67fcf0afc2d7e3e27ad5305)** to **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)**



---

archive/issue_comments_373901.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nGonna start a fresh build from scratch with `make -j4`.",
    "created_at": "2018-03-12T19:02:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373901",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Gonna start a fresh build from scratch with `make -j4`.



---

archive/issue_comments_373902.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@embray](#comment:13):\n> I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda\n\nFrom this list, I can only suspect Google Chrome, if that is akin to the \"Google Desktop\" listed.\n\nBut since is a machine configured by our (somewhat parano\u00efd) administrators, I might well have, for example, an antivirus running in the background and invisible to me.\n\nCare for a full install log (I'd have to send it directly to you, since it woould be about 2.1 MB gzipped...) ?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26f2603455b8b2b13e2e60d9e7110b8dc690b086\"><code>26f2603</code></a></td><td><code>Adds a couple new features to sage-flock borrowed from the standard flock command:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7bfda9556cd619d24b193b15f02803b621860374\"><code>7bfda95</code></a></td><td><code>Stricter locking around sage-rebase on Cygwin</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898\"><code>188b546</code></a></td><td><code>Ensure that SAGE_LOCAL/var/lock actually exists</code></td></tr></table>\n",
    "created_at": "2018-03-12T19:05:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373902",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@embray](#comment:13):
> I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda

From this list, I can only suspect Google Chrome, if that is akin to the "Google Desktop" listed.

But since is a machine configured by our (somewhat parano√Ød) administrators, I might well have, for example, an antivirus running in the background and invisible to me.

Care for a full install log (I'd have to send it directly to you, since it woould be about 2.1 MB gzipped...) ?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26f2603455b8b2b13e2e60d9e7110b8dc690b086"><code>26f2603</code></a></td><td><code>Adds a couple new features to sage-flock borrowed from the standard flock command:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7bfda9556cd619d24b193b15f02803b621860374"><code>7bfda95</code></a></td><td><code>Stricter locking around sage-rebase on Cygwin</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898"><code>188b546</code></a></td><td><code>Ensure that SAGE_LOCAL/var/lock actually exists</code></td></tr></table>




---

archive/issue_comments_373903.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@embray](#comment:15):\n> I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.\n\nCurrent state :\n\n```\n$ ls -lR sage/local/var/lock/\nsage/local/var/lock/:\ntotal 0\n-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock\n-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock\n```",
    "created_at": "2018-03-12T19:07:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373903",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@embray](#comment:15):
> I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.

Current state :

```
$ ls -lR sage/local/var/lock/
sage/local/var/lock/:
total 0
-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock
-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock
```



---

archive/issue_events_341277.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2018-03-12T19:29:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341277"
}
```



---

archive/issue_events_341278.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2018-03-12T19:29:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341278"
}
```



---

archive/issue_comments_373904.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nSorry, I didn't see the last part at first...\n\nReplying to [@embray](#comment:14):\n\n[ Snip... ]\n\n> In retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...\n\nI agree with you : I'm starting to suppose that my \"work\" machine's configuration (out of my control) is even *worse* than Windows...\n\nI'll try to setup a fresh Windows VM on a sane (i. e. Linux) machine and reproduce the issues. If so, I'll re-open.",
    "created_at": "2018-03-12T19:29:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373904",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:20" align="right">comment:20</div>

Sorry, I didn't see the last part at first...

Replying to [@embray](#comment:14):

[ Snip... ]

> In retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...

I agree with you : I'm starting to suppose that my "work" machine's configuration (out of my control) is even *worse* than Windows...

I'll try to setup a fresh Windows VM on a sane (i. e. Linux) machine and reproduce the issues. If so, I'll re-open.



---

archive/issue_comments_373905.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@EmmanuelCharpentier](#comment:19):\n> Replying to [@embray](#comment:15):\n> > I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.\n\n> \n> Current state :\n> \n> ```\n> $ ls -lR sage/local/var/lock/\n> sage/local/var/lock/:\n> total 0\n> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock\n> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock\n> ```\n\nIt would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch.  If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).",
    "created_at": "2018-03-12T20:17:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373905",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@EmmanuelCharpentier](#comment:19):
> Replying to [@embray](#comment:15):
> > I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.

> 
> Current state :
> 
> ```
> $ ls -lR sage/local/var/lock/
> sage/local/var/lock/:
> total 0
> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock
> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock
> ```

It would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch.  If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).



---

archive/issue_comments_373906.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@embray](#comment:21):\n\n[ Snip... ]\n\n> It would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch. \n\nI'll try to do this eventually, but I won't be able to do this in the next two weeks at a minimum, at least on my problematic machine.\n\n> If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).\n\nThat's what I did anyway...",
    "created_at": "2018-03-13T09:33:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373906",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@embray](#comment:21):

[ Snip... ]

> It would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch. 

I'll try to do this eventually, but I won't be able to do this in the next two weeks at a minimum, at least on my problematic machine.

> If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).

That's what I did anyway...



---

archive/issue_comments_373907.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@embray](#comment:17):\n> Gonna start a fresh build from scratch with `make -j4`.\n\nHow did this went ?",
    "created_at": "2018-03-13T09:35:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373907",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@embray](#comment:17):
> Gonna start a fresh build from scratch with `make -j4`.

How did this went ?



---

archive/issue_comments_373908.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@EmmanuelCharpentier](#comment:23):\n> Replying to [@embray](#comment:17):\n> > Gonna start a fresh build from scratch with `make -j4`.\n\n> \n> How did this went ?\n\nIn retrospect, maybe the times you got aren't so unreasonable after all:\n\n```\nreal    361m29.365s\nuser    313m46.310s\nsys     162m22.775s\nSage build/upgrade complete!\n```\n\nThat's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).\n\nI'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.\n\nI also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.",
    "created_at": "2018-03-13T10:59:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373908",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@EmmanuelCharpentier](#comment:23):
> Replying to [@embray](#comment:17):
> > Gonna start a fresh build from scratch with `make -j4`.

> 
> How did this went ?

In retrospect, maybe the times you got aren't so unreasonable after all:

```
real    361m29.365s
user    313m46.310s
sys     162m22.775s
Sage build/upgrade complete!
```

That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).

I'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.

I also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.



---

archive/issue_comments_373909.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@embray](#comment:24):\n> Replying to [@EmmanuelCharpentier](#comment:23):\n> > Replying to [@embray](#comment:17):\n> > > Gonna start a fresh build from scratch with `make -j4`.\n\n> > \n> > How did this went ?\n\n> \n> In retrospect, maybe the times you got aren't so unreasonable after all:\n> \n> ```\n> real    361m29.365s\n> user    313m46.310s\n> sys     162m22.775s\n> Sage build/upgrade complete!\n> ```\n> \n> That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).\n\nThe times I quoted were for attempts to *parallel* build... So my times are still unacceptably high.\n\nYour hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with \"CYGWIN=detect_bloda\" didn't show anything. But I'll retry this after a cold start...\n\nI'll also try a fresh build on a VM. As already told, this will have to wait a bit...\n\nBTW, something else bothers me : the discrepancy between wall time and CPU time. From the (serial) `testlong.log` I ran after completing the build :\n\n```\nTotal time for all tests: 63115.2 seconds\n    cpu time: 17746.2 seconds\n    cumulative wall time: 45802.2 seconds\n```\n\nand this is displayed below the call :\n\n```\nreal    1074m14,375s\nuser    687m47,318s\nsys     247m32,749s\n```\n\nNotes :\n* A bit less than 18 hours for the tests is a bit long in the tooth...\n* I get the two errors already reported (killing a process takes more than 4 seconds, unicode error in the doctest framework) plus a new one :\n\n```\nsage -t --long --warn-long 209.2 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 786, in sage.structure.coerce\n_actions.IntegerMulAction._repr_name_\nFailed example:\n    IntegerMulAction(ZZ, GF5)\nExpected:\n    Left Integer Multiplication by Integer Ring on Finite Field of size 5\nGot:\n    Left Integer Multiplication by Integer Ring on Finite Field of size 1\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.IntegerMulAction._repr_name_\n    [143 tests, 1 failure, 11.83 s]\n```\n\nCare for a formal bug report ?\n\n> I'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.\n> \n> I also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.",
    "created_at": "2018-03-13T15:45:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373909",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@embray](#comment:24):
> Replying to [@EmmanuelCharpentier](#comment:23):
> > Replying to [@embray](#comment:17):
> > > Gonna start a fresh build from scratch with `make -j4`.

> > 
> > How did this went ?

> 
> In retrospect, maybe the times you got aren't so unreasonable after all:
> 
> ```
> real    361m29.365s
> user    313m46.310s
> sys     162m22.775s
> Sage build/upgrade complete!
> ```
> 
> That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).

The times I quoted were for attempts to *parallel* build... So my times are still unacceptably high.

Your hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with "CYGWIN=detect_bloda" didn't show anything. But I'll retry this after a cold start...

I'll also try a fresh build on a VM. As already told, this will have to wait a bit...

BTW, something else bothers me : the discrepancy between wall time and CPU time. From the (serial) `testlong.log` I ran after completing the build :

```
Total time for all tests: 63115.2 seconds
    cpu time: 17746.2 seconds
    cumulative wall time: 45802.2 seconds
```

and this is displayed below the call :

```
real    1074m14,375s
user    687m47,318s
sys     247m32,749s
```

Notes :
* A bit less than 18 hours for the tests is a bit long in the tooth...
* I get the two errors already reported (killing a process takes more than 4 seconds, unicode error in the doctest framework) plus a new one :

```
sage -t --long --warn-long 209.2 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 786, in sage.structure.coerce
_actions.IntegerMulAction._repr_name_
Failed example:
    IntegerMulAction(ZZ, GF5)
Expected:
    Left Integer Multiplication by Integer Ring on Finite Field of size 5
Got:
    Left Integer Multiplication by Integer Ring on Finite Field of size 1
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.IntegerMulAction._repr_name_
    [143 tests, 1 failure, 11.83 s]
```

Care for a formal bug report ?

> I'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.
> 
> I also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.



---

archive/issue_comments_373910.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@EmmanuelCharpentier](#comment:25):\n> Replying to [@embray](#comment:24):\n> > Replying to [@EmmanuelCharpentier](#comment:23):\n> > > Replying to [@embray](#comment:17):\n> > > > Gonna start a fresh build from scratch with `make -j4`.\n\n> > > \n> > > How did this went ?\n\n> > \n> > In retrospect, maybe the times you got aren't so unreasonable after all:\n> > \n> > ```\n> > real    361m29.365s\n> > user    313m46.310s\n> > sys     162m22.775s\n> > Sage build/upgrade complete!\n> > ```\n> > \n> > That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).\n\n> \n> The times I quoted were for attempts to *parallel* build... So my times are still unacceptably high.\n> \n> Your hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with \"CYGWIN=detect_bloda\" didn't show anything. But I'll retry this after a cold start...\n\nI'm pretty sure `CYGWIN=detect_bloda` is deprecated / doesn't do anything anymore.",
    "created_at": "2018-03-13T18:45:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373910",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@EmmanuelCharpentier](#comment:25):
> Replying to [@embray](#comment:24):
> > Replying to [@EmmanuelCharpentier](#comment:23):
> > > Replying to [@embray](#comment:17):
> > > > Gonna start a fresh build from scratch with `make -j4`.

> > > 
> > > How did this went ?

> > 
> > In retrospect, maybe the times you got aren't so unreasonable after all:
> > 
> > ```
> > real    361m29.365s
> > user    313m46.310s
> > sys     162m22.775s
> > Sage build/upgrade complete!
> > ```
> > 
> > That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).

> 
> The times I quoted were for attempts to *parallel* build... So my times are still unacceptably high.
> 
> Your hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with "CYGWIN=detect_bloda" didn't show anything. But I'll retry this after a cold start...

I'm pretty sure `CYGWIN=detect_bloda` is deprecated / doesn't do anything anymore.



---

archive/issue_comments_373911.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI just ran a `make ptestlong` and I also got the coerce_actions failure, though the same module passed when run on its own.  Seems like some kind of caching issue maybe--worth investigating.",
    "created_at": "2018-03-13T21:08:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373911",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

I just ran a `make ptestlong` and I also got the coerce_actions failure, though the same module passed when run on its own.  Seems like some kind of caching issue maybe--worth investigating.



---

archive/issue_comments_373912.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI ran it again and now it's failing consistently, even though it passed once before.\n\nAnyways, that's a separate issue from this--I'll open a ticket for it.",
    "created_at": "2018-03-13T21:11:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373912",
    "user": "https://github.com/embray"
}
```

<div id="comment:28" align="right">comment:28</div>

I ran it again and now it's failing consistently, even though it passed once before.

Anyways, that's a separate issue from this--I'll open a ticket for it.



---

archive/issue_comments_373913.json:
```json
{
    "body": "Reviewer: **Eric Charpentier**",
    "created_at": "2018-03-17T08:08:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373913",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Eric Charpentier**



---

archive/issue_comments_373914.json:
```json
{
    "body": "Changed reviewer from **Eric Charpentier** to **Emmanuel Charpentier**",
    "created_at": "2018-03-17T08:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373914",
    "user": "https://github.com/fchapoton"
}
```

Changed reviewer from **Eric Charpentier** to **Emmanuel Charpentier**



---

archive/issue_events_341279.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-21T06:18:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341279"
}
```



---

archive/issue_events_341280.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a89a12ad270b69aef97a41fb2c00b151c2a47f97",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-03-21T06:18:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24647#event-341280"
}
```



---

archive/issue_comments_373915.json:
```json
{
    "body": "Changed branch from **[u/embray/cygwin/more-rebase-locks](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/more-rebase-locks)** to **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)**",
    "created_at": "2018-03-21T06:18:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373915",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/cygwin/more-rebase-locks](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/more-rebase-locks)** to **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)**



---

archive/issue_comments_373916.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nHeh, oh no!  This has me confused for a moment.",
    "created_at": "2018-03-21T17:01:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373916",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Heh, oh no!  This has me confused for a moment.



---

archive/issue_comments_373917.json:
```json
{
    "body": "Changed commit from **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)** to none",
    "created_at": "2018-03-21T17:01:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24647#issuecomment-373917",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`188b546`](https://github.com/sagemath/sagetrac-mirror/commit/188b546d4a7e13ab5b567072d34e0afcd476e898)** to none
