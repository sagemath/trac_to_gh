# Issue 24536: find_local_maximum/minimum() fails with expressions containing complex numbers

archive/issues_024299.json:
```json
{
    "body": "```\nsage: find_local_maximum(abs(x+I),-1,1)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-f0919e050ec5> in <module>()\n----> 1 find_local_maximum(abs(x+I),-Integer(1),Integer(1))\n\n/home/ralf/sage/src/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3703)()\n    352             True\n    353         \"\"\"\n--> 354         return self.get_object()(*args, **kwds)\n    355 \n    356     def __repr__(self):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/numerical/optimize.pyc in find_local_maximum(f, a, b, tol, maxfun)\n    143     \"\"\"\n    144     try:\n--> 145         return f.find_local_maximum(a=a, b=b, tol=tol, maxfun=maxfun)\n    146     except AttributeError:\n    147         pass\n\n/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_maximum (build/cythonized/sage/symbolic/expression.cpp:66056)()\n  11680             (0.561090323458081..., 0.857926501456...)\n  11681         \"\"\"\n> 11682         minval, x = (-self).find_local_minimum(a, b, var=var, tol=tol,\n  11683                                                      maxfun=maxfun)\n  11684         return -minval, x\n\n/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_minimum (build/cythonized/sage/symbolic/expression.cpp:66379)()\n  11739         if var is None:\n  11740             var = self.default_variable()\n> 11741         return find_local_minimum(self._fast_float_(var),\n  11742                                         a=a, b=b, tol=tol, maxfun=maxfun )\n  11743 \n\n/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._fast_float_ (build/cythonized/sage/symbolic/expression.cpp:66543)()\n  11762         \"\"\"\n  11763         from sage.symbolic.expression_conversions import fast_float\n> 11764         return fast_float(self, *vars)\n  11765 \n  11766     def _fast_callable_(self, etb):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in fast_float(ex, *vars)\n   1572         1.4142135623730951\n   1573     \"\"\"\n-> 1574     return FastFloatConverter(ex, *vars)()\n   1575 \n   1576 #################\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    215             if getattr(self, 'use_fake_div', False) and (operator is _operator.mul or operator is mul_vararg):\n    216                 div = self.get_fake_div(ex)\n--> 217                 return self.arithmetic(div, div.operator())\n    218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)\n   1513         operands = ex.operands()\n   1514         if operator is _operator.neg:\n-> 1515             return operator(self(operands[0]))\n   1516 \n   1517         from sage.rings.all import Rational\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    224             return self.tuple(ex)\n    225         else:\n--> 226             return self.composition(ex, operator)\n    227 \n    228     def get_fake_div(self, ex):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)\n   1547         \"\"\"\n   1548         f = operator\n-> 1549         g = [self(_) for _ in ex.operands()]\n   1550         try:\n   1551             return f(*g)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    216                 div = self.get_fake_div(ex)\n    217                 return self.arithmetic(div, div.operator())\n--> 218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n    220             return self.relation(ex, operator)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)\n   1519             from sage.functions.all import sqrt\n   1520             return sqrt(self(operands[0]))\n-> 1521         fops = map(self, operands)\n   1522         if operator == add_vararg:\n   1523             operator = _operator.add\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    206         except TypeError as err:\n    207             if 'self must be a numeric expression' not in err.args:\n--> 208                 raise err\n    209 \n    210         operator = ex.operator()\n\nTypeError: unable to coerce to a real number\n```\nThe rethrown error comes from an attempt to do `float(I)`.\n\nThe find_local functions use `FastFloatConverter` to compute values.\n\nAssignee: @orlitzky\n\nCC:  @orlitzky\n\nBranch/Commit: 1fe579508146d7b20dda6aac2c4beeca6d335870\n\nReviewer: Matthias Koeppe\n\nAuthor: Michael Orlitzky\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24536\n\n",
    "closed_at": "2022-03-12T15:11:19Z",
    "created_at": "2018-01-14T07:02:56Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "find_local_maximum/minimum() fails with expressions containing complex numbers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24536",
    "user": "https://github.com/rwst"
}
```
```
sage: find_local_maximum(abs(x+I),-1,1)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-f0919e050ec5> in <module>()
----> 1 find_local_maximum(abs(x+I),-Integer(1),Integer(1))

/home/ralf/sage/src/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3703)()
    352             True
    353         """
--> 354         return self.get_object()(*args, **kwds)
    355 
    356     def __repr__(self):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/numerical/optimize.pyc in find_local_maximum(f, a, b, tol, maxfun)
    143     """
    144     try:
--> 145         return f.find_local_maximum(a=a, b=b, tol=tol, maxfun=maxfun)
    146     except AttributeError:
    147         pass

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_maximum (build/cythonized/sage/symbolic/expression.cpp:66056)()
  11680             (0.561090323458081..., 0.857926501456...)
  11681         """
> 11682         minval, x = (-self).find_local_minimum(a, b, var=var, tol=tol,
  11683                                                      maxfun=maxfun)
  11684         return -minval, x

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_minimum (build/cythonized/sage/symbolic/expression.cpp:66379)()
  11739         if var is None:
  11740             var = self.default_variable()
> 11741         return find_local_minimum(self._fast_float_(var),
  11742                                         a=a, b=b, tol=tol, maxfun=maxfun )
  11743 

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._fast_float_ (build/cythonized/sage/symbolic/expression.cpp:66543)()
  11762         """
  11763         from sage.symbolic.expression_conversions import fast_float
> 11764         return fast_float(self, *vars)
  11765 
  11766     def _fast_callable_(self, etb):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in fast_float(ex, *vars)
   1572         1.4142135623730951
   1573     """
-> 1574     return FastFloatConverter(ex, *vars)()
   1575 
   1576 #################

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    215             if getattr(self, 'use_fake_div', False) and (operator is _operator.mul or operator is mul_vararg):
    216                 div = self.get_fake_div(ex)
--> 217                 return self.arithmetic(div, div.operator())
    218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)
   1513         operands = ex.operands()
   1514         if operator is _operator.neg:
-> 1515             return operator(self(operands[0]))
   1516 
   1517         from sage.rings.all import Rational

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    224             return self.tuple(ex)
    225         else:
--> 226             return self.composition(ex, operator)
    227 
    228     def get_fake_div(self, ex):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
   1547         """
   1548         f = operator
-> 1549         g = [self(_) for _ in ex.operands()]
   1550         try:
   1551             return f(*g)

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)
   1519             from sage.functions.all import sqrt
   1520             return sqrt(self(operands[0]))
-> 1521         fops = map(self, operands)
   1522         if operator == add_vararg:
   1523             operator = _operator.add

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    206         except TypeError as err:
    207             if 'self must be a numeric expression' not in err.args:
--> 208                 raise err
    209 
    210         operator = ex.operator()

TypeError: unable to coerce to a real number
```
The rethrown error comes from an attempt to do `float(I)`.

The find_local functions use `FastFloatConverter` to compute values.

Assignee: @orlitzky

CC:  @orlitzky

Branch/Commit: 1fe579508146d7b20dda6aac2c4beeca6d335870

Reviewer: Matthias Koeppe

Author: Michael Orlitzky

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24536





---

archive/issue_comments_362121.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n \\`\\`\\`\n sage: from sage.symbolic.expression_conversions import FastFloatConverter\n-sage: f = FastFloatConverter(I)\n+sage: f = FastFloatConverter(x + I)\n /home/ralf/sage/src/bin/sage-ipython:1: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\n See http://trac.sagemath.org/5930 for details.\n   #!/usr/bin/env python\n@@ -15,6 +15,7 @@\n \n TypeError: unable to coerce to a real number\n \\`\\`\\`\n+There is an expression() call somewhere intending substitution which should be replaced in this ticket, as well.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-01-14T07:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362121",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,6 @@
 \`\`\`
 sage: from sage.symbolic.expression_conversions import FastFloatConverter
-sage: f = FastFloatConverter(I)
+sage: f = FastFloatConverter(x + I)
 /home/ralf/sage/src/bin/sage-ipython:1: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
 See http://trac.sagemath.org/5930 for details.
   #!/usr/bin/env python
@@ -15,6 +15,7 @@
 
 TypeError: unable to coerce to a real number
 \`\`\`
+There is an expression() call somewhere intending substitution which should be replaced in this ticket, as well.
 
 Comment: 1
 
```




---

archive/issue_comments_362122.json:
```json
{
    "body": "<a id='comment:2'></a>Apparently \"Float\" literally means Python (real) \"float\" not floating-point. Of course then expressions containing `I` raise errors, even if the outcome is real. The original case was the usage by `find_local_maximum`---so that never worked, and the restriction was undocumented.",
    "created_at": "2018-01-14T07:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362122",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>Apparently "Float" literally means Python (real) "float" not floating-point. Of course then expressions containing `I` raise errors, even if the outcome is real. The original case was the usage by `find_local_maximum`---so that never worked, and the restriction was undocumented.



---

archive/issue_comments_362123.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,106 @@\n+\\`\\`\\`\n+sage: find_local_maximum(abs(x+I),-1,1)\n+---------------------------------------------------------------------------\n+TypeError                                 Traceback (most recent call last)\n+<ipython-input-3-f0919e050ec5> in <module>()\n+----> 1 find_local_maximum(abs(x+I),-Integer(1),Integer(1))\n \n+/home/ralf/sage/src/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3703)()\n+    352             True\n+    353         \"\"\"\n+--> 354         return self.get_object()(*args, **kwds)\n+    355 \n+    356     def __repr__(self):\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/numerical/optimize.pyc in find_local_maximum(f, a, b, tol, maxfun)\n+    143     \"\"\"\n+    144     try:\n+--> 145         return f.find_local_maximum(a=a, b=b, tol=tol, maxfun=maxfun)\n+    146     except AttributeError:\n+    147         pass\n+\n+/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_maximum (build/cythonized/sage/symbolic/expression.cpp:66056)()\n+  11680             (0.561090323458081..., 0.857926501456...)\n+  11681         \"\"\"\n+> 11682         minval, x = (-self).find_local_minimum(a, b, var=var, tol=tol,\n+  11683                                                      maxfun=maxfun)\n+  11684         return -minval, x\n+\n+/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_minimum (build/cythonized/sage/symbolic/expression.cpp:66379)()\n+  11739         if var is None:\n+  11740             var = self.default_variable()\n+> 11741         return find_local_minimum(self._fast_float_(var),\n+  11742                                         a=a, b=b, tol=tol, maxfun=maxfun )\n+  11743 \n+\n+/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._fast_float_ (build/cythonized/sage/symbolic/expression.cpp:66543)()\n+  11762         \"\"\"\n+  11763         from sage.symbolic.expression_conversions import fast_float\n+> 11764         return fast_float(self, *vars)\n+  11765 \n+  11766     def _fast_callable_(self, etb):\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in fast_float(ex, *vars)\n+   1572         1.4142135623730951\n+   1573     \"\"\"\n+-> 1574     return FastFloatConverter(ex, *vars)()\n+   1575 \n+   1576 #################\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n+    215             if getattr(self, 'use_fake_div', False) and (operator is _operator.mul or operator is mul_vararg):\n+    216                 div = self.get_fake_div(ex)\n+--> 217                 return self.arithmetic(div, div.operator())\n+    218             return self.arithmetic(ex, operator)\n+    219         elif operator in relation_operators:\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)\n+   1513         operands = ex.operands()\n+   1514         if operator is _operator.neg:\n+-> 1515             return operator(self(operands[0]))\n+   1516 \n+   1517         from sage.rings.all import Rational\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n+    224             return self.tuple(ex)\n+    225         else:\n+--> 226             return self.composition(ex, operator)\n+    227 \n+    228     def get_fake_div(self, ex):\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)\n+   1547         \"\"\"\n+   1548         f = operator\n+-> 1549         g = [self(_) for _ in ex.operands()]\n+   1550         try:\n+   1551             return f(*g)\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n+    216                 div = self.get_fake_div(ex)\n+    217                 return self.arithmetic(div, div.operator())\n+--> 218             return self.arithmetic(ex, operator)\n+    219         elif operator in relation_operators:\n+    220             return self.relation(ex, operator)\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)\n+   1519             from sage.functions.all import sqrt\n+   1520             return sqrt(self(operands[0]))\n+-> 1521         fops = map(self, operands)\n+   1522         if operator == add_vararg:\n+   1523             operator = _operator.add\n+\n+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n+    206         except TypeError as err:\n+    207             if 'self must be a numeric expression' not in err.args:\n+--> 208                 raise err\n+    209 \n+    210         operator = ex.operator()\n+\n+TypeError: unable to coerce to a real number\n+\\`\\`\\`\n+The rethrown error comes from an attempt to do \\`float(I)\\`.\n+\n+The find_local functions use \\`FastFloatConverter\\` to compute values.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-01-14T07:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362123",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,106 @@
+\`\`\`
+sage: find_local_maximum(abs(x+I),-1,1)
+---------------------------------------------------------------------------
+TypeError                                 Traceback (most recent call last)
+<ipython-input-3-f0919e050ec5> in <module>()
+----> 1 find_local_maximum(abs(x+I),-Integer(1),Integer(1))
 
+/home/ralf/sage/src/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3703)()
+    352             True
+    353         """
+--> 354         return self.get_object()(*args, **kwds)
+    355 
+    356     def __repr__(self):
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/numerical/optimize.pyc in find_local_maximum(f, a, b, tol, maxfun)
+    143     """
+    144     try:
+--> 145         return f.find_local_maximum(a=a, b=b, tol=tol, maxfun=maxfun)
+    146     except AttributeError:
+    147         pass
+
+/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_maximum (build/cythonized/sage/symbolic/expression.cpp:66056)()
+  11680             (0.561090323458081..., 0.857926501456...)
+  11681         """
+> 11682         minval, x = (-self).find_local_minimum(a, b, var=var, tol=tol,
+  11683                                                      maxfun=maxfun)
+  11684         return -minval, x
+
+/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.find_local_minimum (build/cythonized/sage/symbolic/expression.cpp:66379)()
+  11739         if var is None:
+  11740             var = self.default_variable()
+> 11741         return find_local_minimum(self._fast_float_(var),
+  11742                                         a=a, b=b, tol=tol, maxfun=maxfun )
+  11743 
+
+/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._fast_float_ (build/cythonized/sage/symbolic/expression.cpp:66543)()
+  11762         """
+  11763         from sage.symbolic.expression_conversions import fast_float
+> 11764         return fast_float(self, *vars)
+  11765 
+  11766     def _fast_callable_(self, etb):
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in fast_float(ex, *vars)
+   1572         1.4142135623730951
+   1573     """
+-> 1574     return FastFloatConverter(ex, *vars)()
+   1575 
+   1576 #################
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
+    215             if getattr(self, 'use_fake_div', False) and (operator is _operator.mul or operator is mul_vararg):
+    216                 div = self.get_fake_div(ex)
+--> 217                 return self.arithmetic(div, div.operator())
+    218             return self.arithmetic(ex, operator)
+    219         elif operator in relation_operators:
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)
+   1513         operands = ex.operands()
+   1514         if operator is _operator.neg:
+-> 1515             return operator(self(operands[0]))
+   1516 
+   1517         from sage.rings.all import Rational
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
+    224             return self.tuple(ex)
+    225         else:
+--> 226             return self.composition(ex, operator)
+    227 
+    228     def get_fake_div(self, ex):
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
+   1547         """
+   1548         f = operator
+-> 1549         g = [self(_) for _ in ex.operands()]
+   1550         try:
+   1551             return f(*g)
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
+    216                 div = self.get_fake_div(ex)
+    217                 return self.arithmetic(div, div.operator())
+--> 218             return self.arithmetic(ex, operator)
+    219         elif operator in relation_operators:
+    220             return self.relation(ex, operator)
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)
+   1519             from sage.functions.all import sqrt
+   1520             return sqrt(self(operands[0]))
+-> 1521         fops = map(self, operands)
+   1522         if operator == add_vararg:
+   1523             operator = _operator.add
+
+/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
+    206         except TypeError as err:
+    207             if 'self must be a numeric expression' not in err.args:
+--> 208                 raise err
+    209 
+    210         operator = ex.operator()
+
+TypeError: unable to coerce to a real number
+\`\`\`
+The rethrown error comes from an attempt to do \`float(I)\`.
+
+The find_local functions use \`FastFloatConverter\` to compute values.
 
 Comment: 1
 
```




---

archive/issue_comments_362124.json:
```json
{
    "body": "<a id='comment:4'></a>The documentation of `fast_float` states\n\n```\ndef fast_float(ex, *vars):\n    \"\"\"\n    Returns an object which provides fast floating point evaluation of\n    the symbolic expression *ex*.\n```\nbut\n\n```\nsage: from sage.symbolic.expression_conversions import fast_float\nsage: ff = fast_float(abs(x+I))\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py:1574: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\nSee http://trac.sagemath.org/5930 for details.\n  return FastFloatConverter(ex, *vars)()\n```\ngives the ticket error.",
    "created_at": "2018-01-14T07:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362124",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>The documentation of `fast_float` states

```
def fast_float(ex, *vars):
    """
    Returns an object which provides fast floating point evaluation of
    the symbolic expression *ex*.
```
but

```
sage: from sage.symbolic.expression_conversions import fast_float
sage: ff = fast_float(abs(x+I))
/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py:1574: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
See http://trac.sagemath.org/5930 for details.
  return FastFloatConverter(ex, *vars)()
```
gives the ticket error.



---

archive/issue_comments_362125.json:
```json
{
    "body": "<a id='comment:5'></a>Relevant: #5572. Somewhat related: #13559, #16899.",
    "created_at": "2018-01-14T07:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362125",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>Relevant: #5572. Somewhat related: #13559, #16899.



---

archive/issue_comments_362126.json:
```json
{
    "body": "<a id='comment:6'></a>Note that changing the call from `find_local_maximum(abs(x+I),-1,1)` to\n\n```\nfind_local_maximum(lambda x: abs(x+I),-1,1)\n```\n\nThen everything works fine.",
    "created_at": "2019-02-13T14:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362126",
    "user": "https://github.com/johanrosenkilde"
}
```

<a id='comment:6'></a>Note that changing the call from `find_local_maximum(abs(x+I),-1,1)` to

```
find_local_maximum(lambda x: abs(x+I),-1,1)
```

Then everything works fine.



---

archive/issue_events_061873.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-22T00:52:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24536#event-61873"
}
```



---

archive/issue_comments_362127.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2021-07-22T00:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362127",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_362128.json:
```json
{
    "body": "<a id='comment:8'></a>The fix for this will be similar to the one in #8450. After #32234, we're using `fast_callable()` on these expressions with `domain=float`, which converts all *intermediate* expression-evaluation results to `float`. Obviously that causes problems with the `x+I` in `abs(x+I)`. To work around that, we can probably just run the computation with `domain=CDF` and then convert the answer to `float` if its imaginary part is small enough. (But we don't want to return NaN if the end result has a nontrivial imaginary part, like we do when plotting.)",
    "created_at": "2021-07-29T13:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362128",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:8'></a>The fix for this will be similar to the one in #8450. After #32234, we're using `fast_callable()` on these expressions with `domain=float`, which converts all *intermediate* expression-evaluation results to `float`. Obviously that causes problems with the `x+I` in `abs(x+I)`. To work around that, we can probably just run the computation with `domain=CDF` and then convert the answer to `float` if its imaginary part is small enough. (But we don't want to return NaN if the end result has a nontrivial imaginary part, like we do when plotting.)



---

archive/issue_comments_362129.json:
```json
{
    "body": "Set assignee to @orlitzky.",
    "created_at": "2021-07-29T13:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362129",
    "user": "https://github.com/orlitzky"
}
```

Set assignee to @orlitzky.



---

archive/issue_comments_362130.json:
```json
{
    "body": "<a id='comment:9'></a>I'll deal with it once the prereqs start to settle.",
    "created_at": "2021-07-29T13:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362130",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:9'></a>I'll deal with it once the prereqs start to settle.



---

archive/issue_comments_362131.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-07-29T13:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362131",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_events_061874.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-09T21:26:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24536#event-61874"
}
```



---

archive/issue_events_061875.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-09T21:26:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24536#event-61875"
}
```



---

archive/issue_events_061876.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24536#event-61876"
}
```



---

archive/issue_events_061877.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24536#event-61877"
}
```



---

archive/issue_comments_362132.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-24T17:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362132",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_362133.json:
```json
{
    "body": "<a id='comment:13'></a>As promised, I've factored out a superclass of the `FastCallablePlotWrapper` that won't ignore complex results and will instead raise an error. This is more suitable for functions like `find_root()` and `find_local_minimum()` where a complex result can't really be ignored.\n\nThose two functions (and the \"maximum\" alias) have been updated, but I'm sure there are others where the same strategy can easily be applied.\n\n---\nNew commits:",
    "created_at": "2022-02-24T17:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362133",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>As promised, I've factored out a superclass of the `FastCallablePlotWrapper` that won't ignore complex results and will instead raise an error. This is more suitable for functions like `find_root()` and `find_local_minimum()` where a complex result can't really be ignored.

Those two functions (and the "maximum" alias) have been updated, but I'm sure there are others where the same strategy can easily be applied.

---
New commits:



---

archive/issue_comments_362134.json:
```json
{
    "body": "<a id='comment:14'></a>\n```\n+      * ``CDF`` has none of the other issues, because ``CDF`` has its\n+        own specialized interpreter, a lexicographic ordering (for\n+        min/max),\n```\n\nShould we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:\n\n```\nsage: CDF(1+2*I) < CDF(1-2*I)\nFalse\nsage: complex(1+2*I) < complex(1-2*I)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-3575b3aa8341> in <module>\n----> 1 complex(Integer(1)+Integer(2)*I) < complex(Integer(1)-Integer(2)*I)\n\nTypeError: '<' not supported between instances of 'complex' and 'complex'\n```",
    "created_at": "2022-02-24T18:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362134",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
```
+      * ``CDF`` has none of the other issues, because ``CDF`` has its
+        own specialized interpreter, a lexicographic ordering (for
+        min/max),
```

Should we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:

```
sage: CDF(1+2*I) < CDF(1-2*I)
False
sage: complex(1+2*I) < complex(1-2*I)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-3575b3aa8341> in <module>
----> 1 complex(Integer(1)+Integer(2)*I) < complex(Integer(1)-Integer(2)*I)

TypeError: '<' not supported between instances of 'complex' and 'complex'
```



---

archive/issue_comments_362135.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 mkoeppe]:\n> \n> Should we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:\n\n\nI wonder why it was added? Someone had to go to the trouble. In any case, we'd have to find some other solution for these wrappers if the ordering was removed. Right now we're fortunate that CDF reasonably handles everything that people want to do with real numbers, so long as the imaginary parts are small.",
    "created_at": "2022-02-24T18:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362135",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>Replying to [comment:14 mkoeppe]:
> 
> Should we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:


I wonder why it was added? Someone had to go to the trouble. In any case, we'd have to find some other solution for these wrappers if the ordering was removed. Right now we're fortunate that CDF reasonably handles everything that people want to do with real numbers, so long as the imaginary parts are small.



---

archive/issue_comments_362136.json:
```json
{
    "body": "<a id='comment:16'></a>I think it's just a leftover of python 2 semantics in which everything could be compared with everything",
    "created_at": "2022-02-24T18:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362136",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>I think it's just a leftover of python 2 semantics in which everything could be compared with everything



---

archive/issue_comments_362137.json:
```json
{
    "body": "<a id='comment:17'></a>Similar issue for number field elements - in ticket #20028",
    "created_at": "2022-02-25T06:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362137",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Similar issue for number field elements - in ticket #20028



---

archive/issue_comments_362138.json:
```json
{
    "body": "<a id='comment:18'></a>I've opened #33417",
    "created_at": "2022-02-25T18:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362138",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>I've opened #33417



---

archive/issue_comments_362139.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-25T22:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362139",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362140.json:
```json
{
    "body": "<a id='comment:20'></a>Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?",
    "created_at": "2022-02-26T17:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362140",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?



---

archive/issue_comments_362141.json:
```json
{
    "body": "<a id='comment:21'></a>I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:\n\n```\n+        from sage.ext.fast_callable import FastCallableFloatWrapper\n+        f = self._plot_fast_callable(var)\n+        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)\n```\nIs this needed?",
    "created_at": "2022-02-26T17:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362141",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:

```
+        from sage.ext.fast_callable import FastCallableFloatWrapper
+        f = self._plot_fast_callable(var)
+        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)
```
Is this needed?



---

archive/issue_comments_362142.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 mkoeppe]:\n> I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:\n> \n> ```\n> +        from sage.ext.fast_callable import FastCallableFloatWrapper\n> +        f = self._plot_fast_callable(var)\n> +        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)\n> ```\n> Is this needed?\n\n\nThe `_plot_fast_callable()` method returns only a fast-callable over CDF, not a wrapper. When plotting, the wrapper is added during `setup_for_eval_on_grid()` to support fast-callables that don't arise from `expr.plot()`. Given that, if `_plot_fast_callable()` returned a wrapper, 'we would eventually try to wrap it twice during `expr.plot()`.",
    "created_at": "2022-02-26T21:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362142",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:22'></a>Replying to [comment:21 mkoeppe]:
> I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:
> 
> ```
> +        from sage.ext.fast_callable import FastCallableFloatWrapper
> +        f = self._plot_fast_callable(var)
> +        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)
> ```
> Is this needed?


The `_plot_fast_callable()` method returns only a fast-callable over CDF, not a wrapper. When plotting, the wrapper is added during `setup_for_eval_on_grid()` to support fast-callables that don't arise from `expr.plot()`. Given that, if `_plot_fast_callable()` returned a wrapper, 'we would eventually try to wrap it twice during `expr.plot()`.



---

archive/issue_comments_362143.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:20 mkoeppe]:\n> Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?\n\n\nSo you're not satisfied with solving easy problems all day? =)\n\nIt's awkward, and I'm open to suggestions.\n\nI think the original name that I chose for the plotting wrapper was `FastCallableOutputWrapper`, which is more or less what it does. It wraps a fast-callable, and converts its output to... something else. But I was already aware that this ticket was going to require a different wrapping behavior. Since the behavior of the plot wrapper (returning `NaN` when it gets a complex answer) is so unique to plotting, I settled on `FastCallablePlotWrapper`.\n\nThe class for this ticket then sits beneath an abstract `FastCallableOutputWrapper` in my head. Unlike the plot wrapper, it doesn't do anything unusual during conversion, so it would rightly sit beside sibling classes such as `FastCallableComplexWrapper` or `FastCallableIntWrapper`.\n\nI thought about naming this class `FastCallableFloatOutputWrapper`, and maybe that's a better choice, since \"Plot\" isn't what the \"Plot\" wrapper outputs. It's just so looooooooong.",
    "created_at": "2022-02-26T21:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362143",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:23'></a>Replying to [comment:20 mkoeppe]:
> Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?


So you're not satisfied with solving easy problems all day? =)

It's awkward, and I'm open to suggestions.

I think the original name that I chose for the plotting wrapper was `FastCallableOutputWrapper`, which is more or less what it does. It wraps a fast-callable, and converts its output to... something else. But I was already aware that this ticket was going to require a different wrapping behavior. Since the behavior of the plot wrapper (returning `NaN` when it gets a complex answer) is so unique to plotting, I settled on `FastCallablePlotWrapper`.

The class for this ticket then sits beneath an abstract `FastCallableOutputWrapper` in my head. Unlike the plot wrapper, it doesn't do anything unusual during conversion, so it would rightly sit beside sibling classes such as `FastCallableComplexWrapper` or `FastCallableIntWrapper`.

I thought about naming this class `FastCallableFloatOutputWrapper`, and maybe that's a better choice, since "Plot" isn't what the "Plot" wrapper outputs. It's just so looooooooong.



---

archive/issue_comments_362144.json:
```json
{
    "body": "<a id='comment:24'></a>In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?",
    "created_at": "2022-02-26T22:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362144",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?



---

archive/issue_comments_362145.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 mkoeppe]:\n> In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?\n\n\nHow about `UnembedFloatFromCDF` and `UnembedPlotFloatFromCDF`?\n\nFor now we could also do `UnembedFloatFromCDF(nan_on_error=<bool>)` to cover both cases, but then if the class hierarchy is ever extended upwards or laterally, the `nan_on_error` parameter isn't going to be consistent.",
    "created_at": "2022-02-27T15:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362145",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:25'></a>Replying to [comment:24 mkoeppe]:
> In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?


How about `UnembedFloatFromCDF` and `UnembedPlotFloatFromCDF`?

For now we could also do `UnembedFloatFromCDF(nan_on_error=<bool>)` to cover both cases, but then if the class hierarchy is ever extended upwards or laterally, the `nan_on_error` parameter isn't going to be consistent.



---

archive/issue_comments_362146.json:
```json
{
    "body": "<a id='comment:26'></a>So this should be `CDF.coerce_map_from(float).section()`?",
    "created_at": "2022-02-27T17:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362146",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>So this should be `CDF.coerce_map_from(float).section()`?



---

archive/issue_comments_362147.json:
```json
{
    "body": "<a id='comment:27'></a>NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html",
    "created_at": "2022-02-27T18:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362147",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html



---

archive/issue_comments_362148.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:26 mkoeppe]:\n> So this should be `CDF.coerce_map_from(float).section()`?\n\n\nIn spirit, but with a tolerance, so that the the underlying routine doesn't crash when numerical issues cause a `0.0000000000001*I` to appear. Additionally, in the plotting class, we choose to return `nan` upon encountering a complex result so that the corresponding point is \"skipped.\"",
    "created_at": "2022-02-27T18:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362148",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:28'></a>Replying to [comment:26 mkoeppe]:
> So this should be `CDF.coerce_map_from(float).section()`?


In spirit, but with a tolerance, so that the the underlying routine doesn't crash when numerical issues cause a `0.0000000000001*I` to appear. Additionally, in the plotting class, we choose to return `nan` upon encountering a complex result so that the corresponding point is "skipped."



---

archive/issue_comments_362149.json:
```json
{
    "body": "<a id='comment:29'></a>Yes, so we would have a signaling and a non-signaling version of it",
    "created_at": "2022-02-27T18:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362149",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>Yes, so we would have a signaling and a non-signaling version of it



---

archive/issue_comments_362150.json:
```json
{
    "body": "<a id='comment:30'></a>Some more random facts:\n\n```\nsage: numpy.real(complex(CDF(1,1)))\n1.0\nsage: numpy.real(CDF(1,1))\n<built-in method real of sage.rings.complex_double.ComplexDoubleElement object at 0x1526bc8c0>\n```\n:(",
    "created_at": "2022-02-27T18:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362150",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>Some more random facts:

```
sage: numpy.real(complex(CDF(1,1)))
1.0
sage: numpy.real(CDF(1,1))
<built-in method real of sage.rings.complex_double.ComplexDoubleElement object at 0x1526bc8c0>
```
:(



---

archive/issue_comments_362151.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:27 mkoeppe]:\n> NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html\n\n\nThat would basically work here, although I think it might be slower to go from CDF through numpy and back. The main downside to that though is that the error message will be thrown deep in some plotting or optimization routine when it receives a complex number. In the current branch I've chosen to raise an error immediately, in the wrapper, \"ValueError: complex fast-callable function result...\" that is usually going to better explain the problem.",
    "created_at": "2022-02-27T18:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362151",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:31'></a>Replying to [comment:27 mkoeppe]:
> NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html


That would basically work here, although I think it might be slower to go from CDF through numpy and back. The main downside to that though is that the error message will be thrown deep in some plotting or optimization routine when it receives a complex number. In the current branch I've chosen to raise an error immediately, in the wrapper, "ValueError: complex fast-callable function result..." that is usually going to better explain the problem.



---

archive/issue_comments_362152.json:
```json
{
    "body": "<a id='comment:32'></a>I didn't mean to say that we should use this numpy function. Just collecting existing idioms and interfaces.\n\nI was looking for a name for this operation (\"convert to float if close to a real number, NaN otherwise) - and so far haven't found anything in Python, NumPy, C++ reference, ...",
    "created_at": "2022-02-27T18:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362152",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>I didn't mean to say that we should use this numpy function. Just collecting existing idioms and interfaces.

I was looking for a name for this operation ("convert to float if close to a real number, NaN otherwise) - and so far haven't found anything in Python, NumPy, C++ reference, ...



---

archive/issue_comments_362153.json:
```json
{
    "body": "<a id='comment:33'></a>I guess one would need to figure out what complex infinities should convert to.",
    "created_at": "2022-02-27T18:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362153",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>I guess one would need to figure out what complex infinities should convert to.



---

archive/issue_comments_362154.json:
```json
{
    "body": "<a id='comment:34'></a>Also relevant: https://docs.python.org/3/library/cmath.html#cmath.isclose (which accepts both `rel_tol` and `abs_tol`). \"The IEEE 754 special values of NaN, inf, and -inf will be handled according to IEEE rules. Specifically, [...] inf and -inf are only considered close to themselves.\" - this forgets to talk about complex infinities.",
    "created_at": "2022-02-27T18:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362154",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Also relevant: https://docs.python.org/3/library/cmath.html#cmath.isclose (which accepts both `rel_tol` and `abs_tol`). "The IEEE 754 special values of NaN, inf, and -inf will be handled according to IEEE rules. Specifically, [...] inf and -inf are only considered close to themselves." - this forgets to talk about complex infinities.



---

archive/issue_comments_362155.json:
```json
{
    "body": "<a id='comment:35'></a>Not sure how well developed the built-in `complex` type is:\n\n```\nsage: cmath.inf + float(1e-16)*cmath.infj\n(nan+infj)\n```\n??",
    "created_at": "2022-02-27T18:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362155",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Not sure how well developed the built-in `complex` type is:

```
sage: cmath.inf + float(1e-16)*cmath.infj
(nan+infj)
```
??



---

archive/issue_comments_362156.json:
```json
{
    "body": "<a id='comment:36'></a>OK that's https://bugs.python.org/issue25453, open since 2015",
    "created_at": "2022-02-27T19:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362156",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>OK that's https://bugs.python.org/issue25453, open since 2015



---

archive/issue_comments_362157.json:
```json
{
    "body": "<a id='comment:37'></a>Here's another one:\n\n```\nsage: cmath.rect(math.inf, 0)\n(inf+0j)\nsage: cmath.rect(1, math.pi/4)\n(0.7071067811865476+0.7071067811865475j)\nsage: cmath.rect(math.inf, math.pi/4)\n(inf+infj)\nsage: cmath.rect(math.inf, pi/2)\n(inf+infj)                             # What?\nsage: cmath.rect(math.inf, 2*pi)\n(inf-infj)                             # Help?!\n```\nhttps://docs.python.org/3/library/cmath.html#cmath.rect",
    "created_at": "2022-02-27T19:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362157",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Here's another one:

```
sage: cmath.rect(math.inf, 0)
(inf+0j)
sage: cmath.rect(1, math.pi/4)
(0.7071067811865476+0.7071067811865475j)
sage: cmath.rect(math.inf, math.pi/4)
(inf+infj)
sage: cmath.rect(math.inf, pi/2)
(inf+infj)                             # What?
sage: cmath.rect(math.inf, 2*pi)
(inf-infj)                             # Help?!
```
https://docs.python.org/3/library/cmath.html#cmath.rect



---

archive/issue_comments_362158.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-28T15:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362158",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362159.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-03T06:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362159",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_362160.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:23 mjo]:\n> Replying to [comment:20 mkoeppe]:\n> > Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?\n\n> \n> So you're not satisfied with solving easy problems all day? =)\n> \n> It's awkward, and I'm open to suggestions.\n\n\nLet's postpone this to another ticket. The current branch certainly does what it promises, the implementation looks fine, and tests pass.",
    "created_at": "2022-03-03T06:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362160",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Replying to [comment:23 mjo]:
> Replying to [comment:20 mkoeppe]:
> > Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?

> 
> So you're not satisfied with solving easy problems all day? =)
> 
> It's awkward, and I'm open to suggestions.


Let's postpone this to another ticket. The current branch certainly does what it promises, the implementation looks fine, and tests pass.



---

archive/issue_comments_362161.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-03-06T23:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362161",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_362162.json:
```json
{
    "body": "<a id='comment:40'></a>On OSX:\n\n```\n**********************************************************************\nFile \"src/doc/de/thematische_anleitungen/sage_gymnasium.rst\", line 534, in doc.de.thematische_anleitungen.sage_gymnasium\nFailed example:\n    find_root(f, 0.5, 5)\nExpected:\n    0.6299605249475858\nGot:\n    0.6299605249475857\n**********************************************************************\n1 item had failures:\n   1 of 294 in doc.de.thematische_anleitungen.sage_gymnasium\n    [207 tests, 1 failure, 5.86 s]\n**********************************************************************\n```",
    "created_at": "2022-03-06T23:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362162",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:40'></a>On OSX:

```
**********************************************************************
File "src/doc/de/thematische_anleitungen/sage_gymnasium.rst", line 534, in doc.de.thematische_anleitungen.sage_gymnasium
Failed example:
    find_root(f, 0.5, 5)
Expected:
    0.6299605249475858
Got:
    0.6299605249475857
**********************************************************************
1 item had failures:
   1 of 294 in doc.de.thematische_anleitungen.sage_gymnasium
    [207 tests, 1 failure, 5.86 s]
**********************************************************************
```



---

archive/issue_comments_362163.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-08T23:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362163",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_362164.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-08T23:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362164",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_362165.json:
```json
{
    "body": "<a id='comment:42'></a>Untested (no macOS), but that should take care of it.",
    "created_at": "2022-03-08T23:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362165",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:42'></a>Untested (no macOS), but that should take care of it.



---

archive/issue_comments_362166.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-08T23:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362166",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061878.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-12T15:11:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24536#event-61878"
}
```



---

archive/issue_comments_362167.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-12T15:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24536",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24536#issuecomment-362167",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
