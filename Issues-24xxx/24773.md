# Issue 24773: Delayed/Conditional Substitution

archive/issues_024536.json:
```json
{
    "body": "Mathematica (see http://reference.wolfram.com/language/ref/RuleDelayed.html) has a very useful feature called delayed rule. Instead of a static rule, a function is invoked which decides looking at the argument how the actual substitution should be carried out. This is a useful feature when simplifying some symbolic expressions.\n\nThis ticket shall implement such a delayed substitution in [SageMath](SageMath).\n\nCC:  @dkrenn @behackl @rwst\n\nBranch/Commit: 224476ec9e346efb53c4dd60918c6483eae369b2\n\nReviewer: Daniel Krenn, Ralf Stephan\n\nAuthor: Clemens Heuberger\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24773\n\n",
    "closed_at": "2018-02-25T20:00:28Z",
    "created_at": "2018-02-19T12:47:09Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Delayed/Conditional Substitution",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24773",
    "user": "https://github.com/cheuberg"
}
```
Mathematica (see http://reference.wolfram.com/language/ref/RuleDelayed.html) has a very useful feature called delayed rule. Instead of a static rule, a function is invoked which decides looking at the argument how the actual substitution should be carried out. This is a useful feature when simplifying some symbolic expressions.

This ticket shall implement such a delayed substitution in [SageMath](SageMath).

CC:  @dkrenn @behackl @rwst

Branch/Commit: 224476ec9e346efb53c4dd60918c6483eae369b2

Reviewer: Daniel Krenn, Ralf Stephan

Author: Clemens Heuberger

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24773





---

archive/issue_comments_470675.json:
```json
{
    "body": "Changing branch from \"\" to \"u/cheuberg/delayed-substitution\"",
    "created_at": "2018-02-19T13:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470675",
    "user": "https://github.com/cheuberg"
}
```

Changing branch from "" to "u/cheuberg/delayed-substitution"



---

archive/issue_comments_470676.json:
```json
{
    "body": "Changing commit from \"\" to \"55818942d0f68722ce228a465427131860a761b6\"",
    "created_at": "2018-02-19T13:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470676",
    "user": "https://github.com/cheuberg"
}
```

Changing commit from "" to "55818942d0f68722ce228a465427131860a761b6"



---

archive/issue_comments_470677.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-19T13:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470677",
    "user": "https://github.com/cheuberg"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470678.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2018-02-19T13:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470678",
    "user": "https://github.com/cheuberg"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_470679.json:
```json
{
    "body": "<a id='comment:3'></a>LGTM, but I want to raise the following to be discussed: the name `delayed_substitution` of the method. The other substitute-methods are called `substitute*`, so maybe an `substitute_delayed` would fit more into this scheme. However, I do not have a strong opinion on this topic.\n\nThe first basic Mathematica example is\n\n```\n{x, x, x} /. x :> RandomReal[]\n```\nso maybe adding this example as well could be a benefit.",
    "created_at": "2018-02-19T13:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470679",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:3'></a>LGTM, but I want to raise the following to be discussed: the name `delayed_substitution` of the method. The other substitute-methods are called `substitute*`, so maybe an `substitute_delayed` would fit more into this scheme. However, I do not have a strong opinion on this topic.

The first basic Mathematica example is

```
{x, x, x} /. x :> RandomReal[]
```
so maybe adding this example as well could be a benefit.



---

archive/issue_comments_470680.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-02-19T13:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470680",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_470681.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Daniel Krenn\"",
    "created_at": "2018-02-19T13:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470681",
    "user": "https://github.com/dkrenn"
}
```

Changing reviewer from "" to "Daniel Krenn"



---

archive/issue_comments_470682.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 dkrenn]:\n> LGTM, but I want to raise the following to be discussed: the name `delayed_substitution` of the method. The other substitute-methods are called `substitute*`, so maybe an `substitute_delayed` would fit more into this scheme. \n\n\nAgree, mostly because it makes it easier to be found by TAB completion.",
    "created_at": "2018-02-19T13:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470682",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>Replying to [comment:3 dkrenn]:
> LGTM, but I want to raise the following to be discussed: the name `delayed_substitution` of the method. The other substitute-methods are called `substitute*`, so maybe an `substitute_delayed` would fit more into this scheme. 


Agree, mostly because it makes it easier to be found by TAB completion.



---

archive/issue_comments_470683.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-19T15:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470683",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470684.json:
```json
{
    "body": "Changing commit from \"55818942d0f68722ce228a465427131860a761b6\" to \"d2b835c21e54e71a84cafcc5ca7702f99ccf29b3\"",
    "created_at": "2018-02-19T15:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "55818942d0f68722ce228a465427131860a761b6" to "d2b835c21e54e71a84cafcc5ca7702f99ccf29b3"



---

archive/issue_comments_470685.json:
```json
{
    "body": "<a id='comment:6'></a>I renamed the method as suggested.\n\nConcerning the Mathematica example: I have two problems with that example. The first being that a list is not a symbolic expression. So we would need something like\n\n```\nsage: var('a b c')\nsage: e1 = a*x + b*x + c*x\n```\nBut then, it does not work as expected:\n\n```\nsage: e1.substitution_delayed(x, lambda d: random())\n0.7859203112304044*a + 0.7859203112304044*b + 0.7859203112304044*c\n```\n\nThe reason is that the code proposed here tries to do the job with as little effort as possible. This means that first, I look for all matches of the pattern:\n\n```\nsage: e1.find(x)\n[x]\n```\nAnd then, I simply replace all occurrences.\n\nOne possibility would be:\n\n```\nsage: var('a b c x y z')\nsage: w = SR.wild(0)\nsage: e2 = a*sin(x) + b*sin(y) + c*sin(z)\nsage: e2.substitution_delayed(sin(w), lambda d: random())\n0.9299473549632423*a + 0.1776245598330548*b + 0.5870609216512541*c\n```",
    "created_at": "2018-02-19T16:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470685",
    "user": "https://github.com/cheuberg"
}
```

<a id='comment:6'></a>I renamed the method as suggested.

Concerning the Mathematica example: I have two problems with that example. The first being that a list is not a symbolic expression. So we would need something like

```
sage: var('a b c')
sage: e1 = a*x + b*x + c*x
```
But then, it does not work as expected:

```
sage: e1.substitution_delayed(x, lambda d: random())
0.7859203112304044*a + 0.7859203112304044*b + 0.7859203112304044*c
```

The reason is that the code proposed here tries to do the job with as little effort as possible. This means that first, I look for all matches of the pattern:

```
sage: e1.find(x)
[x]
```
And then, I simply replace all occurrences.

One possibility would be:

```
sage: var('a b c x y z')
sage: w = SR.wild(0)
sage: e2 = a*sin(x) + b*sin(y) + c*sin(z)
sage: e2.substitution_delayed(sin(w), lambda d: random())
0.9299473549632423*a + 0.1776245598330548*b + 0.5870609216512541*c
```



---

archive/issue_comments_470686.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-02-19T17:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470686",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_470687.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 cheuberg]:\n> Concerning the Mathematica example: I have two problems with that example. The first being that a list is not a symbolic expression. So we would need something like\n> \n> ```\n> sage: var('a b c')\n> sage: e1 = a*x + b*x + c*x\n> ```\n> But then, [...]\n\n\nOk, I understand. Then I suggest to skip this example completely to not get confused.",
    "created_at": "2018-02-20T13:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470687",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:8'></a>Replying to [comment:6 cheuberg]:
> Concerning the Mathematica example: I have two problems with that example. The first being that a list is not a symbolic expression. So we would need something like
> 
> ```
> sage: var('a b c')
> sage: e1 = a*x + b*x + c*x
> ```
> But then, [...]


Ok, I understand. Then I suggest to skip this example completely to not get confused.



---

archive/issue_comments_470688.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-20T13:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470688",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470689.json:
```json
{
    "body": "<a id='comment:10'></a>I think this is badly missing documentation. I just read the docstring and have absolutely no clue what this is about.\n\nWhat does the \"delayed\" in the name refer to? How does this differ from `subs` or `subs_expr`? Can you add an example which is actually meant to explain what this method does?",
    "created_at": "2018-02-20T14:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470689",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>I think this is badly missing documentation. I just read the docstring and have absolutely no clue what this is about.

What does the "delayed" in the name refer to? How does this differ from `subs` or `subs_expr`? Can you add an example which is actually meant to explain what this method does?



---

archive/issue_comments_470690.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-02-20T14:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470690",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_470691.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-20T17:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470692.json:
```json
{
    "body": "Changing commit from \"d2b835c21e54e71a84cafcc5ca7702f99ccf29b3\" to \"224476ec9e346efb53c4dd60918c6483eae369b2\"",
    "created_at": "2018-02-20T17:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470692",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d2b835c21e54e71a84cafcc5ca7702f99ccf29b3" to "224476ec9e346efb53c4dd60918c6483eae369b2"



---

archive/issue_comments_470693.json:
```json
{
    "body": "<a id='comment:12'></a>I have added an example and some more explanation.",
    "created_at": "2018-02-20T17:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470693",
    "user": "https://github.com/cheuberg"
}
```

<a id='comment:12'></a>I have added an example and some more explanation.



---

archive/issue_comments_470694.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-20T17:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470694",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_470695.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-24T07:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470695",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470696.json:
```json
{
    "body": "Changing reviewer from \"Daniel Krenn\" to \"Daniel Krenn, Ralf Stephan\"",
    "created_at": "2018-02-24T07:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470696",
    "user": "https://github.com/rwst"
}
```

Changing reviewer from "Daniel Krenn" to "Daniel Krenn, Ralf Stephan"



---

archive/issue_comments_470697.json:
```json
{
    "body": "<a id='comment:13'></a>I think it's worth to have. LGTM too.",
    "created_at": "2018-02-24T07:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470697",
    "user": "https://github.com/rwst"
}
```

<a id='comment:13'></a>I think it's worth to have. LGTM too.



---

archive/issue_events_062297.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-25T20:00:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24773#event-62297"
}
```



---

archive/issue_comments_470698.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-25T20:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470698",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_470699.json:
```json
{
    "body": "Changing branch from \"u/cheuberg/delayed-substitution\" to \"224476ec9e346efb53c4dd60918c6483eae369b2\"",
    "created_at": "2018-02-25T20:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24773#issuecomment-470699",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/cheuberg/delayed-substitution" to "224476ec9e346efb53c4dd60918c6483eae369b2"
