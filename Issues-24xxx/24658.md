# Issue 24658: Don't call Maxima with no-variable symbolic relation tests

archive/issues_024421.json:
```json
{
    "body": "In the case a relation without variables is to be decided, the procedure is to use Pynac, then RIF and, if it cannot be decided, Maxima. This is fine with expressions containing variables as Maxima can do some proofs. Expressions without variables are handled poorly as the example shows:\n\n```\nsage: val = pi - 2286635172367940241408/1029347477390786609545*sqrt(2)\nsage: bool(val>0)\nTrue\n\n(%i2) is (%pi-(1116521080257783321*2^(23/2))/1029347477390786609545>0);\n(%o2)                                true\n```\n\nThis ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return False.\n\nCC:  simonking\n\nBranch/Commit: e78e84bfcd13292e30969c2be007e71337810c87\n\nReviewer: Simon King, Matthias Koeppe\n\nAuthor: Ralf Stephan\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24658\n\n",
    "closed_at": "2020-08-20T22:23:28Z",
    "created_at": "2018-02-05T07:36:58Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Don't call Maxima with no-variable symbolic relation tests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24658",
    "user": "https://github.com/rwst"
}
```
In the case a relation without variables is to be decided, the procedure is to use Pynac, then RIF and, if it cannot be decided, Maxima. This is fine with expressions containing variables as Maxima can do some proofs. Expressions without variables are handled poorly as the example shows:

```
sage: val = pi - 2286635172367940241408/1029347477390786609545*sqrt(2)
sage: bool(val>0)
True

(%i2) is (%pi-(1116521080257783321*2^(23/2))/1029347477390786609545>0);
(%o2)                                true
```

This ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return False.

CC:  simonking

Branch/Commit: e78e84bfcd13292e30969c2be007e71337810c87

Reviewer: Simon King, Matthias Koeppe

Author: Ralf Stephan

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24658





---

archive/issue_comments_364631.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2018-02-05T08:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364631",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_364632.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-05T08:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364632",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_364633.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -9,7 +9,7 @@\n (%o2)                                true\n \\`\\`\\`\n \n-This ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return Unknown.\n+This ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return False.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-02-05T08:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364633",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -9,7 +9,7 @@
 (%o2)                                true
 \`\`\`
 
-This ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return Unknown.
+This ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return False.
 
 Comment: 1
 
```




---

archive/issue_comments_364634.json:
```json
{
    "body": "<a id='comment:5'></a>It should be easy to review (after all, it is just working around a short-coming of maxima), and to me it looks good. However, I do not feel particularly confident about symbolic expressions (which I normally try to avoid by all means).\n\nAlso, I wonder about that change:\n\n```diff\ndiff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx\nindex 7130898..0f943d9 100644\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -2612,7 +2612,7 @@ cdef class Expression(CommutativeRingElement):\n         The :meth:`~sage.structure.element.Element.is_zero` method\n         is more capable::\n \n-            sage: t = pi + (pi - 1)*pi - pi^2\n+            sage: t = pi + x*pi + (pi - 1 - x)*pi - pi^2\n             sage: t.is_trivial_zero()\n             False\n             sage: t.is_zero()\n```\nWhy did you change it? Apparently in order to have a variable in it. So, without the variable, `t.is_trivial_zero()` would return `True`, right? Which somehow makes sense, actually. I believe one should retain *both* tests, to show-case that Sage can now detect some more expressions which **are** trivially zero.",
    "created_at": "2018-02-05T09:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364634",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>It should be easy to review (after all, it is just working around a short-coming of maxima), and to me it looks good. However, I do not feel particularly confident about symbolic expressions (which I normally try to avoid by all means).

Also, I wonder about that change:

```diff
diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
index 7130898..0f943d9 100644
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -2612,7 +2612,7 @@ cdef class Expression(CommutativeRingElement):
         The :meth:`~sage.structure.element.Element.is_zero` method
         is more capable::
 
-            sage: t = pi + (pi - 1)*pi - pi^2
+            sage: t = pi + x*pi + (pi - 1 - x)*pi - pi^2
             sage: t.is_trivial_zero()
             False
             sage: t.is_zero()
```
Why did you change it? Apparently in order to have a variable in it. So, without the variable, `t.is_trivial_zero()` would return `True`, right? Which somehow makes sense, actually. I believe one should retain *both* tests, to show-case that Sage can now detect some more expressions which **are** trivially zero.



---

archive/issue_comments_364635.json:
```json
{
    "body": "<a id='comment:6'></a>PS: Also I think that in the new test `val = pi - 2286635172367940241408/1029347477390786609545*sqrt(2)` (which actually comes out of Ramanujan's formula for pi) the ticket number should be mentioned.",
    "created_at": "2018-02-05T09:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364635",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>PS: Also I think that in the new test `val = pi - 2286635172367940241408/1029347477390786609545*sqrt(2)` (which actually comes out of Ramanujan's formula for pi) the ticket number should be mentioned.



---

archive/issue_comments_364636.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 SimonKing]:\n> Also, I wonder about that change:\n> \n> ```\n> #!diff\n> diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx\n> index 7130898..0f943d9 100644\n> --- a/src/sage/symbolic/expression.pyx\n> +++ b/src/sage/symbolic/expression.pyx\n> @@ -2612,7 +2612,7 @@ cdef class Expression(CommutativeRingElement):\n>          The :meth:`~sage.structure.element.Element.is_zero` method\n>          is more capable::\n>  \n> -            sage: t = pi + (pi - 1)*pi - pi^2\n> +            sage: t = pi + x*pi + (pi - 1 - x)*pi - pi^2\n>              sage: t.is_trivial_zero()\n>              False\n>              sage: t.is_zero()\n> ```\n> Why did you change it?\n\n\nBecause getting what we want (avoid Maxima numeric) and keeping the doctest would need more involved code, basically checking if there are constants, if so substituting them for variables, and then calling Maxima with that. Note that the changed result is not wrong so I'll add it again.",
    "created_at": "2018-02-05T10:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364636",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>Replying to [comment:5 SimonKing]:
> Also, I wonder about that change:
> 
> ```
> #!diff
> diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
> index 7130898..0f943d9 100644
> --- a/src/sage/symbolic/expression.pyx
> +++ b/src/sage/symbolic/expression.pyx
> @@ -2612,7 +2612,7 @@ cdef class Expression(CommutativeRingElement):
>          The :meth:`~sage.structure.element.Element.is_zero` method
>          is more capable::
>  
> -            sage: t = pi + (pi - 1)*pi - pi^2
> +            sage: t = pi + x*pi + (pi - 1 - x)*pi - pi^2
>              sage: t.is_trivial_zero()
>              False
>              sage: t.is_zero()
> ```
> Why did you change it?


Because getting what we want (avoid Maxima numeric) and keeping the doctest would need more involved code, basically checking if there are constants, if so substituting them for variables, and then calling Maxima with that. Note that the changed result is not wrong so I'll add it again.



---

archive/issue_comments_364637.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-05T10:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364637",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364638.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:5 SimonKing]:\n> So, without the variable, `t.is_trivial_zero()` would return `True`, right? Which somehow makes sense, actually. I believe one should retain *both* tests, to show-case that Sage can now detect some more expressions which **are** trivially zero.\n\n\nNo `is_trivial_zero` test for trivial zero, i.e., `0`.",
    "created_at": "2018-02-05T10:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364638",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>Replying to [comment:5 SimonKing]:
> So, without the variable, `t.is_trivial_zero()` would return `True`, right? Which somehow makes sense, actually. I believe one should retain *both* tests, to show-case that Sage can now detect some more expressions which **are** trivially zero.


No `is_trivial_zero` test for trivial zero, i.e., `0`.



---

archive/issue_comments_364639.json:
```json
{
    "body": "<a id='comment:10'></a>Hm. `(pi + (pi - 1)*pi - pi^2).is_zero()` returning False goes to far, IMHO.\n\nIf I understand correctly, the underlying bug is in Maxima's test for positivity/negativity. Is there a corresponding bug in Maxima's test for being zero as well? If it isn't, then I guess one should return to using Maxima for `is_zero`.",
    "created_at": "2018-02-05T10:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364639",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>Hm. `(pi + (pi - 1)*pi - pi^2).is_zero()` returning False goes to far, IMHO.

If I understand correctly, the underlying bug is in Maxima's test for positivity/negativity. Is there a corresponding bug in Maxima's test for being zero as well? If it isn't, then I guess one should return to using Maxima for `is_zero`.



---

archive/issue_comments_364640.json:
```json
{
    "body": "<a id='comment:11'></a>Or, alternatively, `is_zero()` (but not `is_trivial_zero()`) should be cleverer in using RIF:\n\n```\nsage: RIF(pi + (pi - 1)*pi - pi^2)>0\nFalse\nsage: RIF(pi + (pi - 1)*pi - pi^2)<0\nFalse\nsage: RIF(pi + (pi - 1)*pi - pi^2)==0\nFalse\nsage: RIF(pi + (pi - 1)*pi - pi^2).is_NaN()\nFalse\n```\n\nThus, we have a real **number** (it is not !NaN) that is neither positive nor negative, and thus it would make sense to treat it as zero, although RIF is careful enough to not assert that it actually *is* zero.\n\nOr prepend it by a simplification?\n\n```\nsage: RIF((pi + (pi - 1)*pi - pi^2).simplify_full()).is_zero()\nTrue\n```\n\nAfter all, presumably `is_zero()` is supposed to invest more work into testing than `is_trivial_zero()`.",
    "created_at": "2018-02-05T10:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364640",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>Or, alternatively, `is_zero()` (but not `is_trivial_zero()`) should be cleverer in using RIF:

```
sage: RIF(pi + (pi - 1)*pi - pi^2)>0
False
sage: RIF(pi + (pi - 1)*pi - pi^2)<0
False
sage: RIF(pi + (pi - 1)*pi - pi^2)==0
False
sage: RIF(pi + (pi - 1)*pi - pi^2).is_NaN()
False
```

Thus, we have a real **number** (it is not !NaN) that is neither positive nor negative, and thus it would make sense to treat it as zero, although RIF is careful enough to not assert that it actually *is* zero.

Or prepend it by a simplification?

```
sage: RIF((pi + (pi - 1)*pi - pi^2).simplify_full()).is_zero()
True
```

After all, presumably `is_zero()` is supposed to invest more work into testing than `is_trivial_zero()`.



---

archive/issue_comments_364641.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 SimonKing]:\n> Thus, we have a real **number** (it is not !NaN) that is neither positive nor negative, and thus it would make sense to treat it as zero, although RIF is careful enough to not assert that it actually *is* zero.\n\n\nYour own example (`val`) above would then be treated as zero too.\n\n> Or prepend it by a simplification?\n\n\nThat is probably best. One can always construct cases that need long time like `((pi+1)^10000 - pi*(pi+1)^9999 - (pi+1)^9999).simplify_full()`.",
    "created_at": "2018-02-05T13:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364641",
    "user": "https://github.com/rwst"
}
```

<a id='comment:12'></a>Replying to [comment:11 SimonKing]:
> Thus, we have a real **number** (it is not !NaN) that is neither positive nor negative, and thus it would make sense to treat it as zero, although RIF is careful enough to not assert that it actually *is* zero.


Your own example (`val`) above would then be treated as zero too.

> Or prepend it by a simplification?


That is probably best. One can always construct cases that need long time like `((pi+1)^10000 - pi*(pi+1)^9999 - (pi+1)^9999).simplify_full()`.



---

archive/issue_comments_364642.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-05T14:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364643.json:
```json
{
    "body": "<a id='comment:14'></a>OK, this looks fine in symbolics, there may be failing doctests elsewhere.",
    "created_at": "2018-02-05T14:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364643",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>OK, this looks fine in symbolics, there may be failing doctests elsewhere.



---

archive/issue_comments_364644.json:
```json
{
    "body": "<a id='comment:15'></a>There is a doctest in manifolds that relies on `-arctanh(1/2) + 1/2*log(3) == 0`. That should be resolved by implementing more special values for `atanh`. Surprise, I thought we had them all.",
    "created_at": "2018-02-05T14:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364644",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>There is a doctest in manifolds that relies on `-arctanh(1/2) + 1/2*log(3) == 0`. That should be resolved by implementing more special values for `atanh`. Surprise, I thought we had them all.



---

archive/issue_comments_364645.json:
```json
{
    "body": "<a id='comment:16'></a>Maxima cannot simplify `arctanh(1/2) - 1/2*log(3)`. The question is do we formulate the doctest differently, or do we implement rewrite of inverse hyperbolic expressions, e.g. for integer and rational number arguments, either immediately or inside `simplify_full`.",
    "created_at": "2018-02-05T14:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364645",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>Maxima cannot simplify `arctanh(1/2) - 1/2*log(3)`. The question is do we formulate the doctest differently, or do we implement rewrite of inverse hyperbolic expressions, e.g. for integer and rational number arguments, either immediately or inside `simplify_full`.



---

archive/issue_comments_364646.json:
```json
{
    "body": "<a id='comment:17'></a>The new Pynac has the atanh simpifications and so we depend on that upgrade to fix the manifolds doctest fail.",
    "created_at": "2018-02-06T09:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364646",
    "user": "https://github.com/rwst"
}
```

<a id='comment:17'></a>The new Pynac has the atanh simpifications and so we depend on that upgrade to fix the manifolds doctest fail.



---

archive/issue_comments_364647.json:
```json
{
    "body": "<a id='comment:18'></a>This one is serious because it does happen only when doctesting, and `bool(SR(...))` does not seem to be involved directly.\n\n```\nFile \"src/sage/structure/parent.pyx\", line 1514, in sage.structure.parent.Parent.hom._is_coercion_cached\nFailed example:\n    R._is_coercion_cached(QQ)\nExpected:\n    False\nGot:\n    True\n```\nIt goes away if I replace `QQ` with `QQbar`. I think that the coercion cache is not really erased with creation of a new parent, and the additional call to `test_relation` in this ticket fills it with something. There are doctest calls to `bool(SR(...))` that happen before that doctest in `parent.pyx`, let's see...",
    "created_at": "2018-02-06T15:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364647",
    "user": "https://github.com/rwst"
}
```

<a id='comment:18'></a>This one is serious because it does happen only when doctesting, and `bool(SR(...))` does not seem to be involved directly.

```
File "src/sage/structure/parent.pyx", line 1514, in sage.structure.parent.Parent.hom._is_coercion_cached
Failed example:
    R._is_coercion_cached(QQ)
Expected:
    False
Got:
    True
```
It goes away if I replace `QQ` with `QQbar`. I think that the coercion cache is not really erased with creation of a new parent, and the additional call to `test_relation` in this ticket fills it with something. There are doctest calls to `bool(SR(...))` that happen before that doctest in `parent.pyx`, let's see...



---

archive/issue_comments_364648.json:
```json
{
    "body": "<a id='comment:19'></a>Got it, it comes from the doctest `sqrt(2) in CC` in line 1051 of `pynac.pyx`. How can I turn off that it influences the doctest in line 1514?",
    "created_at": "2018-02-06T15:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364648",
    "user": "https://github.com/rwst"
}
```

<a id='comment:19'></a>Got it, it comes from the doctest `sqrt(2) in CC` in line 1051 of `pynac.pyx`. How can I turn off that it influences the doctest in line 1514?



---

archive/issue_comments_364649.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 rws]:\n> Got it, it comes from the doctest `sqrt(2) in CC` in line 1051 of `parent.pyx`. How can I turn off that it influences the doctest in line 1514?",
    "created_at": "2018-02-06T15:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364649",
    "user": "https://github.com/rwst"
}
```

<a id='comment:20'></a>Replying to [comment:19 rws]:
> Got it, it comes from the doctest `sqrt(2) in CC` in line 1051 of `parent.pyx`. How can I turn off that it influences the doctest in line 1514?



---

archive/issue_comments_364650.json:
```json
{
    "body": "<a id='comment:21'></a>I meant to write `parent.pyx`.",
    "created_at": "2018-02-06T15:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364650",
    "user": "https://github.com/rwst"
}
```

<a id='comment:21'></a>I meant to write `parent.pyx`.



---

archive/issue_comments_364651.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:18 rws]:\n> This one is serious because it does happen only when doctesting, and `bool(SR(...))` does not seem to be involved directly.\n> \n> ```\n> File \"src/sage/structure/parent.pyx\", line 1514, in sage.structure.parent.Parent.hom._is_coercion_cached\n> Failed example:\n>     R._is_coercion_cached(QQ)\n> Expected:\n>     False\n> Got:\n>     True\n> ```\n\n\n`._is_coercion_cached()` is related with `self._coerce_from_hash`. I think it would be a good idea to create a single underscore method that allows to clear `self._coerce_from_hash` and `self._convert_from_hash`. Proposed name: `_clear_coerce_caches`.\n\nFor sanity, I think it would make sense to open a separate ticket for it, which I will do in a few minutes. Then, you can use the new ticket as a dependency and add a `._clear_coerce_caches()` in front of any test that requires a pristine state of the coercion cache.",
    "created_at": "2018-02-06T15:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364651",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>Replying to [comment:18 rws]:
> This one is serious because it does happen only when doctesting, and `bool(SR(...))` does not seem to be involved directly.
> 
> ```
> File "src/sage/structure/parent.pyx", line 1514, in sage.structure.parent.Parent.hom._is_coercion_cached
> Failed example:
>     R._is_coercion_cached(QQ)
> Expected:
>     False
> Got:
>     True
> ```


`._is_coercion_cached()` is related with `self._coerce_from_hash`. I think it would be a good idea to create a single underscore method that allows to clear `self._coerce_from_hash` and `self._convert_from_hash`. Proposed name: `_clear_coerce_caches`.

For sanity, I think it would make sense to open a separate ticket for it, which I will do in a few minutes. Then, you can use the new ticket as a dependency and add a `._clear_coerce_caches()` in front of any test that requires a pristine state of the coercion cache.



---

archive/issue_comments_364652.json:
```json
{
    "body": "<a id='comment:24'></a>Aha, I just found that `Parent.init_coerce(False)` would do the job. However, it is a cdef method and hence cannot be directly called.",
    "created_at": "2018-02-06T16:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364652",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>Aha, I just found that `Parent.init_coerce(False)` would do the job. However, it is a cdef method and hence cannot be directly called.



---

archive/issue_comments_364653.json:
```json
{
    "body": "<a id='comment:26'></a>If you rely on patchbots for review the pynac upgrade needs to be merged by the maintainer first.\n\n---\nNew commits:",
    "created_at": "2018-02-07T07:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364653",
    "user": "https://github.com/rwst"
}
```

<a id='comment:26'></a>If you rely on patchbots for review the pynac upgrade needs to be merged by the maintainer first.

---
New commits:



---

archive/issue_comments_364654.json:
```json
{
    "body": "<a id='comment:27'></a>The manifolds test passes now so we trigger the sleeping patchbots.",
    "created_at": "2018-02-19T07:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364654",
    "user": "https://github.com/rwst"
}
```

<a id='comment:27'></a>The manifolds test passes now so we trigger the sleeping patchbots.



---

archive/issue_comments_364655.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-19T07:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364655",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_364656.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-19T07:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364656",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_062082.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-02-24T20:04:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62082"
}
```



---

archive/issue_comments_364657.json:
```json
{
    "body": "<a id='comment:30'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364657",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_062083.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62083"
}
```



---

archive/issue_events_062084.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62084"
}
```



---

archive/issue_comments_364658.json:
```json
{
    "body": "<a id='comment:31'></a>Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364658",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_events_062085.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62085"
}
```



---

archive/issue_events_062086.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62086"
}
```



---

archive/issue_comments_364659.json:
```json
{
    "body": "<a id='comment:32'></a>Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364659",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Ticket retargeted after milestone closed



---

archive/issue_events_062087.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62087"
}
```



---

archive/issue_events_062088.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62088"
}
```



---

archive/issue_events_062089.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62089"
}
```



---

archive/issue_events_062090.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62090"
}
```



---

archive/issue_comments_364660.json:
```json
{
    "body": "<a id='comment:33'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364660",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_364661.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-15T21:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364661",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364662.json:
```json
{
    "body": "<a id='comment:34'></a>This is a clear improvement.",
    "created_at": "2020-08-15T21:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364662",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>This is a clear improvement.



---

archive/issue_comments_364663.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-20T22:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24658#issuecomment-364663",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_062091.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-20T22:23:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24658",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24658#event-62091"
}
```
