# Issue 24468: Fix unpickling old pickles of MeatAxe matrices

archive/issues_024231.json:
```json
{
    "assignees": [],
    "body": "By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:\n\n```\nsage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense\nsage: MS = MatrixSpace(GF(2), 1, 2)\nsage: M = Matrix_gfpn_dense(MS, [1,1])\nsage: MS2 = MatrixSpace(GF(2), 2, 2)\nsage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])\nsage: M == M[0:1]\nTrue\nsage: M == M2[0:1]\nFalse\nsage: M.parent()\nFull MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2\nsage: M2[0:1].parent()\nFull MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)\nsage: _ == __\nFalse\n```\n\nOf course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...\n\nCC:  @jplab @tscrim @videlec\n\nBranch/Commit: **[`1bc5815`](https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367)**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Simon King**\n\nComponent: **linear algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24468_\n\n",
    "closed_at": "2018-01-14T10:14:20Z",
    "created_at": "2018-01-03T21:56:14Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix unpickling old pickles of MeatAxe matrices",
    "type": "issue",
    "updated_at": "2018-01-14T10:14:20Z",
    "url": "https://github.com/sagemath/sage/issues/24468",
    "user": "https://github.com/simon-king-jena"
}
```
By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:

```
sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense
sage: MS = MatrixSpace(GF(2), 1, 2)
sage: M = Matrix_gfpn_dense(MS, [1,1])
sage: MS2 = MatrixSpace(GF(2), 2, 2)
sage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])
sage: M == M[0:1]
True
sage: M == M2[0:1]
False
sage: M.parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2
sage: M2[0:1].parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)
sage: _ == __
False
```

Of course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...

CC:  @jplab @tscrim @videlec

Branch/Commit: **[`1bc5815`](https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367)**

Reviewer: **Jeroen Demeyer**

Author: **Simon King**

Component: **linear algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/24468_





---

archive/issue_events_340561.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-03T21:56:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340561"
}
```



---

archive/issue_events_340562.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-03T21:56:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "c: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340562"
}
```



---

archive/issue_events_340563.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-03T21:56:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340563"
}
```



---

archive/issue_events_340564.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-03T21:56:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340564"
}
```



---

archive/issue_comments_370385.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nRelated problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.",
    "created_at": "2018-01-04T00:37:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370385",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.



---

archive/issue_comments_370386.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI guess the `matrix` constructor should be provided with an `implementation` keyword, too.\n\nTwo matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:\n\n```\nsage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')\nsage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')\nsage: R3 = PolynomialRing(ZZ,'x',implementation='singular')\nsage: R3\nMultivariate Polynomial Ring in x over Integer Ring\nsage: R1\nUnivariate Polynomial Ring in x over Integer Ring (using NTL)\nsage: R1.has_coerce_map_from(R2)\nFalse\nsage: R2.has_coerce_map_from(R1)\nTrue\nsage: R3.has_coerce_map_from(R1)\nTrue\nsage: R3.has_coerce_map_from(R2)\nTrue\nsage: R1.has_coerce_map_from(R3)\nFalse\nsage: R2.has_coerce_map_from(R3)\nFalse\n```",
    "created_at": "2018-01-04T00:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370386",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

I guess the `matrix` constructor should be provided with an `implementation` keyword, too.

Two matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:

```
sage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')
sage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')
sage: R3 = PolynomialRing(ZZ,'x',implementation='singular')
sage: R3
Multivariate Polynomial Ring in x over Integer Ring
sage: R1
Univariate Polynomial Ring in x over Integer Ring (using NTL)
sage: R1.has_coerce_map_from(R2)
False
sage: R2.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R2)
True
sage: R1.has_coerce_map_from(R3)
False
sage: R2.has_coerce_map_from(R3)
False
```



---

archive/issue_comments_370387.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@simon-king-jena](#comment:1):\n> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.\n\nTo be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).\n\nSo, I suggest one should deal with this ticket as follows:\n\n- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.\n- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.\n- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.",
    "created_at": "2018-01-04T00:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370387",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@simon-king-jena](#comment:1):
> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.

To be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).

So, I suggest one should deal with this ticket as follows:

- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.
- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.
- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.



---

archive/issue_comments_370388.json:
```json
{
    "body": "Dependencies: **#24359**",
    "created_at": "2018-01-04T01:27:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370388",
    "user": "https://github.com/simon-king-jena"
}
```

Dependencies: **#24359**



---

archive/issue_comments_370389.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Because of 23706, comparison of matrices got broken.\n+Because of #23706, comparison of matrices got broken.\n \n Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.\n \n``````\n",
    "created_at": "2018-01-04T01:27:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370389",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Because of 23706, comparison of matrices got broken.
+Because of #23706, comparison of matrices got broken.
 
 Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.
 
``````




---

archive/issue_comments_370390.json:
```json
{
    "body": "Branch: **[u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)**",
    "created_at": "2018-01-04T01:33:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370390",
    "user": "https://github.com/simon-king-jena"
}
```

Branch: **[u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)**



---

archive/issue_comments_370391.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI added #24359 as a dependency, because it affects some tests happening in the file that I modified.\n\nThe new test passes, and I suppose it is ready for review!\n\n---\nLast 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/228bb6fec0c31815f44bb496004af4e2759469fe\"><code>228bb6f</code></a></td><td><code>Explain how to initialise the use of meataxe library functions</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/86d14cd7a972d5899179e87fc81332eca75458bc\"><code>86d14cd</code></a></td><td><code>Fix SPKG.txt for meataxe</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3c47bcfb250266eed2aa8a94a52774055f592039\"><code>3c47bcf</code></a></td><td><code>quote SPKG_LOCAL in meataxe spkg-install</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0fb61b47bf64cce86c46653f6b68d7c1641b5002\"><code>0fb61b4</code></a></td><td><code>Use the sdh_* functions in meataxe spkg-install</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8c0216bb2429a580989434fb0b00ef5fec83c56b\"><code>8c0216b</code></a></td><td><code>Updated meataxe checksums</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6339d94043f5eef2dbd485284683ec7b0e20269b\"><code>6339d94</code></a></td><td><code>Remove unneeded lines from meataxe's spkg-install</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/13e2c7618938a58212e7bb6d52c61694c0c01ef2\"><code>13e2c76</code></a></td><td><code>Fix makefile syntax in meataxe tarball</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/94fafb744acfb9b4f5fefd3e25b633b878966bac\"><code>94fafb7</code></a></td><td><code>Fixing meataxe for systems with unsigned 'char'</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7ad7b08e10ff08791139eee81a3e40c2641b0135\"><code>7ad7b08</code></a></td><td><code>Fix a race condition in meataxe test suite</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/423271a9a67bf66e5844f056bb4ba8976f01c2b2\"><code>423271a</code></a></td><td><code>Merge branch 't/24359/turn_meataxe_into_a_dynamic_library' into t/24468/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces</code></td></tr></table>\n",
    "created_at": "2018-01-04T01:34:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370391",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

I added #24359 as a dependency, because it affects some tests happening in the file that I modified.

The new test passes, and I suppose it is ready for review!

---
Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/228bb6fec0c31815f44bb496004af4e2759469fe"><code>228bb6f</code></a></td><td><code>Explain how to initialise the use of meataxe library functions</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/86d14cd7a972d5899179e87fc81332eca75458bc"><code>86d14cd</code></a></td><td><code>Fix SPKG.txt for meataxe</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3c47bcfb250266eed2aa8a94a52774055f592039"><code>3c47bcf</code></a></td><td><code>quote SPKG_LOCAL in meataxe spkg-install</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0fb61b47bf64cce86c46653f6b68d7c1641b5002"><code>0fb61b4</code></a></td><td><code>Use the sdh_* functions in meataxe spkg-install</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8c0216bb2429a580989434fb0b00ef5fec83c56b"><code>8c0216b</code></a></td><td><code>Updated meataxe checksums</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6339d94043f5eef2dbd485284683ec7b0e20269b"><code>6339d94</code></a></td><td><code>Remove unneeded lines from meataxe's spkg-install</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/13e2c7618938a58212e7bb6d52c61694c0c01ef2"><code>13e2c76</code></a></td><td><code>Fix makefile syntax in meataxe tarball</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/94fafb744acfb9b4f5fefd3e25b633b878966bac"><code>94fafb7</code></a></td><td><code>Fixing meataxe for systems with unsigned 'char'</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7ad7b08e10ff08791139eee81a3e40c2641b0135"><code>7ad7b08</code></a></td><td><code>Fix a race condition in meataxe test suite</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/423271a9a67bf66e5844f056bb4ba8976f01c2b2"><code>423271a</code></a></td><td><code>Merge branch 't/24359/turn_meataxe_into_a_dynamic_library' into t/24468/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces</code></td></tr></table>




---

archive/issue_comments_370392.json:
```json
{
    "body": "Commit: **[`423271a`](https://github.com/sagemath/sagetrac-mirror/commit/423271a9a67bf66e5844f056bb4ba8976f01c2b2)**",
    "created_at": "2018-01-04T01:34:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370392",
    "user": "https://github.com/simon-king-jena"
}
```

Commit: **[`423271a`](https://github.com/sagemath/sagetrac-mirror/commit/423271a9a67bf66e5844f056bb4ba8976f01c2b2)**



---

archive/issue_comments_370393.json:
```json
{
    "body": "Author: **Simon King**",
    "created_at": "2018-01-04T01:34:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370393",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Simon King**



---

archive/issue_events_340565.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-04T01:34:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340565"
}
```



---

archive/issue_comments_370394.json:
```json
{
    "body": "Changed commit from **[`423271a`](https://github.com/sagemath/sagetrac-mirror/commit/423271a9a67bf66e5844f056bb4ba8976f01c2b2)** to **[`f910d1c`](https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)**",
    "created_at": "2018-01-04T01:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370394",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`423271a`](https://github.com/sagemath/sagetrac-mirror/commit/423271a9a67bf66e5844f056bb4ba8976f01c2b2)** to **[`f910d1c`](https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)**



---

archive/issue_comments_370395.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6\"><code>f910d1c</code></a></td><td><code>Use compatible implementation for MatrixSpace in mtx_unpickle</code></td></tr></table>\n",
    "created_at": "2018-01-04T01:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370395",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6"><code>f910d1c</code></a></td><td><code>Use compatible implementation for MatrixSpace in mtx_unpickle</code></td></tr></table>




---

archive/issue_comments_370396.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nOops, I forgot to commit the actual changes for this ticket.\n\nDone now.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6\"><code>f910d1c</code></a></td><td><code>Use compatible implementation for MatrixSpace in mtx_unpickle</code></td></tr></table>\n",
    "created_at": "2018-01-04T01:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370396",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:8" align="right">comment:8</div>

Oops, I forgot to commit the actual changes for this ticket.

Done now.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6"><code>f910d1c</code></a></td><td><code>Use compatible implementation for MatrixSpace in mtx_unpickle</code></td></tr></table>




---

archive/issue_comments_370397.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nYou should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\nAs you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).\n\n```\nsage: M1 = MatrixSpace(GF(2), 1, implementation='generic')\nsage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')\nsage: M1 == M2\nFalse\nsage: M1.one() == M2.one()\nFalse\n```\nA reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.",
    "created_at": "2018-01-04T10:09:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370397",
    "user": "https://github.com/videlec"
}
```

<div id="comment:9" align="right">comment:9</div>

You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

As you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).

```
sage: M1 = MatrixSpace(GF(2), 1, implementation='generic')
sage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')
sage: M1 == M2
False
sage: M1.one() == M2.one()
False
```
A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.



---

archive/issue_comments_370398.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@videlec](#comment:9):\n> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\nFair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.",
    "created_at": "2018-01-04T10:14:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370398",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@videlec](#comment:9):
> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.



---

archive/issue_comments_370399.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@simon-king-jena](#comment:10):\n> Replying to [@videlec](#comment:9):\n> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\n> \n> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.\n\nDefinitely!\n\nWhat do you think about coercion? (certainly for later ticket)",
    "created_at": "2018-01-04T10:19:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370399",
    "user": "https://github.com/videlec"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@simon-king-jena](#comment:10):
> Replying to [@videlec](#comment:9):
> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

> 
> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.

Definitely!

What do you think about coercion? (certainly for later ticket)



---

archive/issue_comments_370400.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@videlec](#comment:9):\n> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.\n\nIt would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.",
    "created_at": "2018-01-04T10:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370400",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@videlec](#comment:9):
> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.

It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.



---

archive/issue_comments_370401.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@simon-king-jena](#comment:12):\n> Replying to [@videlec](#comment:9):\n> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.\n\n> \n> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.\n\nNice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).",
    "created_at": "2018-01-04T10:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370401",
    "user": "https://github.com/videlec"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@simon-king-jena](#comment:12):
> Replying to [@videlec](#comment:9):
> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.

> 
> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.

Nice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).



---

archive/issue_comments_370402.json:
```json
{
    "body": "Changed branch from **[u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)** to **[u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)**",
    "created_at": "2018-01-04T21:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370402",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)** to **[u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)**



---

archive/issue_comments_370403.json:
```json
{
    "body": "Changed dependencies from **#24359** to none",
    "created_at": "2018-01-04T21:43:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370403",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#24359** to none



---

archive/issue_comments_370404.json:
```json
{
    "body": "Changed commit from **[`f910d1c`](https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)** to **[`1bc5815`](https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367)**",
    "created_at": "2018-01-04T21:43:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370404",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`f910d1c`](https://github.com/sagemath/sagetrac-mirror/commit/f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)** to **[`1bc5815`](https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367)**



---

archive/issue_comments_370405.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nRemoved the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367\"><code>1bc5815</code></a></td><td><code>Use compatible implementation for MatrixSpace in mtx_unpickle</code></td></tr></table>\n",
    "created_at": "2018-01-04T21:43:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370405",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Removed the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367"><code>1bc5815</code></a></td><td><code>Use compatible implementation for MatrixSpace in mtx_unpickle</code></td></tr></table>




---

archive/issue_comments_370406.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThis branch doesn't really correspond to the topic of the ticket. What am I missing?",
    "created_at": "2018-01-05T12:55:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370406",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

This branch doesn't really correspond to the topic of the ticket. What am I missing?



---

archive/issue_events_340566.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-05T12:55:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340566"
}
```



---

archive/issue_events_340567.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-05T12:55:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340567"
}
```



---

archive/issue_comments_370407.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@jdemeyer](#comment:16):\n> This branch doesn't really correspond to the topic of the ticket. What am I missing?\n\nWhen I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of \"old pickles of meataxe matrices won't unpickle in the right matrix space\". And that's what is being fixed.\n\nI'll change the ticket title and description accordingly.",
    "created_at": "2018-01-05T13:01:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370407",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@jdemeyer](#comment:16):
> This branch doesn't really correspond to the topic of the ticket. What am I missing?

When I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of "old pickles of meataxe matrices won't unpickle in the right matrix space". And that's what is being fixed.

I'll change the ticket title and description accordingly.



---

archive/issue_comments_370408.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,4 @@\n-Because of #23706, comparison of matrices got broken.\n-\n-Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.\n-\n-Example:\n+By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:\n \n ```\n sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense\n@@ -22,7 +18,4 @@\n False\n ```\n \n-Potential ways to proceed:\n-- One could argue that it is a wrong usage, and close this ticket as invalid.\n-- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.\n-- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__` \n+Of course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...\n``````\n",
    "created_at": "2018-01-05T13:05:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370408",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,4 @@
-Because of #23706, comparison of matrices got broken.
-
-Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.
-
-Example:
+By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:
 
 ```
 sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense
@@ -22,7 +18,4 @@
 False
 ```
 
-Potential ways to proceed:
-- One could argue that it is a wrong usage, and close this ticket as invalid.
-- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.
-- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__` 
+Of course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...
``````




---

archive/issue_events_340568.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-05T13:05:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340568"
}
```



---

archive/issue_events_340569.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-05T13:05:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340569"
}
```



---

archive/issue_events_340570.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-01-05T13:05:49Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "title_is": "Fix unpickling old pickles of MeatAxe matrices",
    "title_was": "Fix comparison of matrices that live in equivalent matrix spaces",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340570"
}
```



---

archive/issue_comments_370409.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2018-01-08T14:22:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370409",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_340571.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-08T14:22:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340571"
}
```



---

archive/issue_events_340572.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-08T14:22:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340572"
}
```



---

archive/issue_events_340573.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-14T10:14:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340573"
}
```



---

archive/issue_events_340574.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "229926a2fe2931842e24bda7af3515e1ce5d0345",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-01-14T10:14:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24468#event-340574"
}
```



---

archive/issue_comments_370410.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)** to **[`1bc5815`](https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367)**",
    "created_at": "2018-01-14T10:14:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24468#issuecomment-370410",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces)** to **[`1bc5815`](https://github.com/sagemath/sagetrac-mirror/commit/1bc5815e7121fd1b4d6f58c300e7eabc0148e367)**
