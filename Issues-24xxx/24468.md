# Issue 24468: Fix unpickling old pickles of MeatAxe matrices

archive/issues_024231.json:
```json
{
    "body": "By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:\n\n```\nsage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense\nsage: MS = MatrixSpace(GF(2), 1, 2)\nsage: M = Matrix_gfpn_dense(MS, [1,1])\nsage: MS2 = MatrixSpace(GF(2), 2, 2)\nsage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])\nsage: M == M[0:1]\nTrue\nsage: M == M2[0:1]\nFalse\nsage: M.parent()\nFull MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2\nsage: M2[0:1].parent()\nFull MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)\nsage: _ == __\nFalse\n```\n\nOf course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...\n\nCC:  @jplab @tscrim @videlec\n\nBranch/Commit: 1bc5815e7121fd1b4d6f58c300e7eabc0148e367\n\nReviewer: Jeroen Demeyer\n\nAuthor: Simon King\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24468\n\n",
    "closed_at": "2018-01-14T10:14:20Z",
    "created_at": "2018-01-03T21:56:14Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Fix unpickling old pickles of MeatAxe matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24468",
    "user": "https://github.com/simon-king-jena"
}
```
By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:

```
sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense
sage: MS = MatrixSpace(GF(2), 1, 2)
sage: M = Matrix_gfpn_dense(MS, [1,1])
sage: MS2 = MatrixSpace(GF(2), 2, 2)
sage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])
sage: M == M[0:1]
True
sage: M == M2[0:1]
False
sage: M.parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2
sage: M2[0:1].parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)
sage: _ == __
False
```

Of course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...

CC:  @jplab @tscrim @videlec

Branch/Commit: 1bc5815e7121fd1b4d6f58c300e7eabc0148e367

Reviewer: Jeroen Demeyer

Author: Simon King

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24468





---

archive/issue_comments_463176.json:
```json
{
    "body": "<a id='comment:1'></a>\nRelated problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.",
    "created_at": "2018-01-04T00:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463176",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.



---

archive/issue_comments_463177.json:
```json
{
    "body": "<a id='comment:2'></a>\nI guess the `matrix` constructor should be provided with an `implementation` keyword, too.\n\nTwo matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:\n\n```\nsage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')\nsage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')\nsage: R3 = PolynomialRing(ZZ,'x',implementation='singular')\nsage: R3\nMultivariate Polynomial Ring in x over Integer Ring\nsage: R1\nUnivariate Polynomial Ring in x over Integer Ring (using NTL)\nsage: R1.has_coerce_map_from(R2)\nFalse\nsage: R2.has_coerce_map_from(R1)\nTrue\nsage: R3.has_coerce_map_from(R1)\nTrue\nsage: R3.has_coerce_map_from(R2)\nTrue\nsage: R1.has_coerce_map_from(R3)\nFalse\nsage: R2.has_coerce_map_from(R3)\nFalse\n```",
    "created_at": "2018-01-04T00:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463177",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
I guess the `matrix` constructor should be provided with an `implementation` keyword, too.

Two matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:

```
sage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')
sage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')
sage: R3 = PolynomialRing(ZZ,'x',implementation='singular')
sage: R3
Multivariate Polynomial Ring in x over Integer Ring
sage: R1
Univariate Polynomial Ring in x over Integer Ring (using NTL)
sage: R1.has_coerce_map_from(R2)
False
sage: R2.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R2)
True
sage: R1.has_coerce_map_from(R3)
False
sage: R2.has_coerce_map_from(R3)
False
```



---

archive/issue_comments_463178.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [SimonKing](#comment%3A1):\n> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.\n\n\nTo be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).\n\nSo, I suggest one should deal with this ticket as follows:\n\n- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.\n- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.\n- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.",
    "created_at": "2018-01-04T00:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463178",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Replying to [SimonKing](#comment%3A1):
> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.


To be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).

So, I suggest one should deal with this ticket as follows:

- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.
- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.
- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.



---

archive/issue_comments_463179.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#24359\"",
    "created_at": "2018-01-04T01:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463179",
    "user": "https://github.com/simon-king-jena"
}
```

Changing dependencies from "" to "#24359"



---

archive/issue_comments_463180.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Because of 23706, comparison of matrices got broken.\n+Because of #23706, comparison of matrices got broken.\n \n Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.\n \n``````\n",
    "created_at": "2018-01-04T01:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463180",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Because of 23706, comparison of matrices got broken.
+Because of #23706, comparison of matrices got broken.
 
 Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.
 
``````




---

archive/issue_comments_463181.json:
```json
{
    "body": "Changing branch from \"\" to \"u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces\"",
    "created_at": "2018-01-04T01:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463181",
    "user": "https://github.com/simon-king-jena"
}
```

Changing branch from "" to "u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces"



---

archive/issue_comments_463182.json:
```json
{
    "body": "<a id='comment:6'></a>\nI added #24359 as a dependency, because it affects some tests happening in the file that I modified.\n\nThe new test passes, and I suppose it is ready for review!\n\n---\nLast 10 new commits:\n|                                                                                                                                          |                                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|\n|[228bb6f](https://git.sagemath.org/sage.git/commit?id=228bb6fec0c31815f44bb496004af4e2759469fe)|`Explain how to initialise the use of meataxe library functions`|\n|[86d14cd](https://git.sagemath.org/sage.git/commit?id=86d14cd7a972d5899179e87fc81332eca75458bc)|`Fix SPKG.txt for meataxe`|\n|[3c47bcf](https://git.sagemath.org/sage.git/commit?id=3c47bcfb250266eed2aa8a94a52774055f592039)|`quote SPKG_LOCAL in meataxe spkg-install`|\n|[0fb61b4](https://git.sagemath.org/sage.git/commit?id=0fb61b47bf64cce86c46653f6b68d7c1641b5002)|`Use the sdh_* functions in meataxe spkg-install`|\n|[8c0216b](https://git.sagemath.org/sage.git/commit?id=8c0216bb2429a580989434fb0b00ef5fec83c56b)|`Updated meataxe checksums`|\n|[6339d94](https://git.sagemath.org/sage.git/commit?id=6339d94043f5eef2dbd485284683ec7b0e20269b)|`Remove unneeded lines from meataxe's spkg-install`|\n|[13e2c76](https://git.sagemath.org/sage.git/commit?id=13e2c7618938a58212e7bb6d52c61694c0c01ef2)|`Fix makefile syntax in meataxe tarball`|\n|[94fafb7](https://git.sagemath.org/sage.git/commit?id=94fafb744acfb9b4f5fefd3e25b633b878966bac)|`Fixing meataxe for systems with unsigned 'char'`|\n|[7ad7b08](https://git.sagemath.org/sage.git/commit?id=7ad7b08e10ff08791139eee81a3e40c2641b0135)|`Fix a race condition in meataxe test suite`|\n|[423271a](https://git.sagemath.org/sage.git/commit?id=423271a9a67bf66e5844f056bb4ba8976f01c2b2)|`Merge branch 't/24359/turn_meataxe_into_a_dynamic_library' into t/24468/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces`|",
    "created_at": "2018-01-04T01:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463182",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
I added #24359 as a dependency, because it affects some tests happening in the file that I modified.

The new test passes, and I suppose it is ready for review!

---
Last 10 new commits:
|                                                                                                                                          |                                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
|[228bb6f](https://git.sagemath.org/sage.git/commit?id=228bb6fec0c31815f44bb496004af4e2759469fe)|`Explain how to initialise the use of meataxe library functions`|
|[86d14cd](https://git.sagemath.org/sage.git/commit?id=86d14cd7a972d5899179e87fc81332eca75458bc)|`Fix SPKG.txt for meataxe`|
|[3c47bcf](https://git.sagemath.org/sage.git/commit?id=3c47bcfb250266eed2aa8a94a52774055f592039)|`quote SPKG_LOCAL in meataxe spkg-install`|
|[0fb61b4](https://git.sagemath.org/sage.git/commit?id=0fb61b47bf64cce86c46653f6b68d7c1641b5002)|`Use the sdh_* functions in meataxe spkg-install`|
|[8c0216b](https://git.sagemath.org/sage.git/commit?id=8c0216bb2429a580989434fb0b00ef5fec83c56b)|`Updated meataxe checksums`|
|[6339d94](https://git.sagemath.org/sage.git/commit?id=6339d94043f5eef2dbd485284683ec7b0e20269b)|`Remove unneeded lines from meataxe's spkg-install`|
|[13e2c76](https://git.sagemath.org/sage.git/commit?id=13e2c7618938a58212e7bb6d52c61694c0c01ef2)|`Fix makefile syntax in meataxe tarball`|
|[94fafb7](https://git.sagemath.org/sage.git/commit?id=94fafb744acfb9b4f5fefd3e25b633b878966bac)|`Fixing meataxe for systems with unsigned 'char'`|
|[7ad7b08](https://git.sagemath.org/sage.git/commit?id=7ad7b08e10ff08791139eee81a3e40c2641b0135)|`Fix a race condition in meataxe test suite`|
|[423271a](https://git.sagemath.org/sage.git/commit?id=423271a9a67bf66e5844f056bb4ba8976f01c2b2)|`Merge branch 't/24359/turn_meataxe_into_a_dynamic_library' into t/24468/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces`|



---

archive/issue_comments_463183.json:
```json
{
    "body": "Changing commit from \"\" to \"423271a9a67bf66e5844f056bb4ba8976f01c2b2\"",
    "created_at": "2018-01-04T01:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463183",
    "user": "https://github.com/simon-king-jena"
}
```

Changing commit from "" to "423271a9a67bf66e5844f056bb4ba8976f01c2b2"



---

archive/issue_comments_463184.json:
```json
{
    "body": "Changing author from \"\" to \"Simon King\"",
    "created_at": "2018-01-04T01:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463184",
    "user": "https://github.com/simon-king-jena"
}
```

Changing author from "" to "Simon King"



---

archive/issue_comments_463185.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-04T01:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463185",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_463186.json:
```json
{
    "body": "Changing commit from \"423271a9a67bf66e5844f056bb4ba8976f01c2b2\" to \"f910d1c2c40688dd71a97aeb4025d2ccc0178ef6\"",
    "created_at": "2018-01-04T01:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "423271a9a67bf66e5844f056bb4ba8976f01c2b2" to "f910d1c2c40688dd71a97aeb4025d2ccc0178ef6"



---

archive/issue_comments_463187.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[f910d1c](https://git.sagemath.org/sage.git/commit/?id=f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)|`Use compatible implementation for MatrixSpace in mtx_unpickle`|",
    "created_at": "2018-01-04T01:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463187",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[f910d1c](https://git.sagemath.org/sage.git/commit/?id=f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)|`Use compatible implementation for MatrixSpace in mtx_unpickle`|



---

archive/issue_comments_463188.json:
```json
{
    "body": "<a id='comment:8'></a>\nOops, I forgot to commit the actual changes for this ticket.\n\nDone now.\n\n---\nNew commits:\n|                                                                                                                                          |                                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[f910d1c](https://git.sagemath.org/sage.git/commit?id=f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)|`Use compatible implementation for MatrixSpace in mtx_unpickle`|",
    "created_at": "2018-01-04T01:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463188",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Oops, I forgot to commit the actual changes for this ticket.

Done now.

---
New commits:
|                                                                                                                                          |                                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[f910d1c](https://git.sagemath.org/sage.git/commit?id=f910d1c2c40688dd71a97aeb4025d2ccc0178ef6)|`Use compatible implementation for MatrixSpace in mtx_unpickle`|



---

archive/issue_comments_463189.json:
```json
{
    "body": "<a id='comment:9'></a>\nYou should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\nAs you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).\n\n```\nsage: M1 = MatrixSpace(GF(2), 1, implementation='generic')\nsage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')\nsage: M1 == M2\nFalse\nsage: M1.one() == M2.one()\nFalse\n```\nA reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.",
    "created_at": "2018-01-04T10:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463189",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>
You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

As you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).

```
sage: M1 = MatrixSpace(GF(2), 1, implementation='generic')
sage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')
sage: M1 == M2
False
sage: M1.one() == M2.one()
False
```
A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.



---

archive/issue_comments_463190.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [vdelecroix](#comment%3A9):\n> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\n\nFair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.",
    "created_at": "2018-01-04T10:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463190",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
Replying to [vdelecroix](#comment%3A9):
> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.


Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.



---

archive/issue_comments_463191.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [SimonKing](#comment%3A10):\n> Replying to [vdelecroix](#comment%3A9):\n> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\n> \n> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.\n\n\nDefinitely!\n\nWhat do you think about coercion? (certainly for later ticket)",
    "created_at": "2018-01-04T10:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463191",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
Replying to [SimonKing](#comment%3A10):
> Replying to [vdelecroix](#comment%3A9):
> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

> 
> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.


Definitely!

What do you think about coercion? (certainly for later ticket)



---

archive/issue_comments_463192.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [vdelecroix](#comment%3A9):\n> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.\n\n\nIt would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.",
    "created_at": "2018-01-04T10:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463192",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
Replying to [vdelecroix](#comment%3A9):
> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.


It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.



---

archive/issue_comments_463193.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [SimonKing](#comment%3A12):\n> Replying to [vdelecroix](#comment%3A9):\n> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.\n\n> \n> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.\n\n\nNice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).",
    "created_at": "2018-01-04T10:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463193",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>
Replying to [SimonKing](#comment%3A12):
> Replying to [vdelecroix](#comment%3A9):
> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.

> 
> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.


Nice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).



---

archive/issue_comments_463194.json:
```json
{
    "body": "Changing branch from \"u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces\" to \"u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces\"",
    "created_at": "2018-01-04T21:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463194",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/SimonKing/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces" to "u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces"



---

archive/issue_comments_463195.json:
```json
{
    "body": "Changing dependencies from \"#24359\" to \"\"",
    "created_at": "2018-01-04T21:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463195",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#24359" to ""



---

archive/issue_comments_463196.json:
```json
{
    "body": "Changing commit from \"f910d1c2c40688dd71a97aeb4025d2ccc0178ef6\" to \"1bc5815e7121fd1b4d6f58c300e7eabc0148e367\"",
    "created_at": "2018-01-04T21:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463196",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "f910d1c2c40688dd71a97aeb4025d2ccc0178ef6" to "1bc5815e7121fd1b4d6f58c300e7eabc0148e367"



---

archive/issue_comments_463197.json:
```json
{
    "body": "<a id='comment:15'></a>\nRemoved the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.\n\n---\nNew commits:\n|                                                                                                                                          |                                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[1bc5815](https://git.sagemath.org/sage.git/commit?id=1bc5815e7121fd1b4d6f58c300e7eabc0148e367)|`Use compatible implementation for MatrixSpace in mtx_unpickle`|",
    "created_at": "2018-01-04T21:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463197",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Removed the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.

---
New commits:
|                                                                                                                                          |                                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[1bc5815](https://git.sagemath.org/sage.git/commit?id=1bc5815e7121fd1b4d6f58c300e7eabc0148e367)|`Use compatible implementation for MatrixSpace in mtx_unpickle`|



---

archive/issue_comments_463198.json:
```json
{
    "body": "<a id='comment:16'></a>\nThis branch doesn't really correspond to the topic of the ticket. What am I missing?",
    "created_at": "2018-01-05T12:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463198",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
This branch doesn't really correspond to the topic of the ticket. What am I missing?



---

archive/issue_comments_463199.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-01-05T12:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463199",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_463200.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [jdemeyer](#comment%3A16):\n> This branch doesn't really correspond to the topic of the ticket. What am I missing?\n\n\nWhen I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of \"old pickles of meataxe matrices won't unpickle in the right matrix space\". And that's what is being fixed.\n\nI'll change the ticket title and description accordingly.",
    "created_at": "2018-01-05T13:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463200",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>
Replying to [jdemeyer](#comment%3A16):
> This branch doesn't really correspond to the topic of the ticket. What am I missing?


When I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of "old pickles of meataxe matrices won't unpickle in the right matrix space". And that's what is being fixed.

I'll change the ticket title and description accordingly.



---

archive/issue_comments_463201.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,4 @@\n-Because of #23706, comparison of matrices got broken.\n-\n-Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.\n-\n-Example:\n+By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:\n \n ```\n sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense\n@@ -22,7 +18,4 @@\n False\n ```\n \n-Potential ways to proceed:\n-- One could argue that it is a wrong usage, and close this ticket as invalid.\n-- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.\n-- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__` \n+Of course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...\n``````\n",
    "created_at": "2018-01-05T13:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463201",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,4 @@
-Because of #23706, comparison of matrices got broken.
-
-Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.
-
-Example:
+By #23706, each matrix space MS prescribes an implementation. It is important that each matrix whose parent is MS uses that implementation, for otherwise comparison breaks, as in the following example:
 
 ```
 sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense
@@ -22,7 +18,4 @@
 False
 ```
 
-Potential ways to proceed:
-- One could argue that it is a wrong usage, and close this ticket as invalid.
-- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.
-- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__` 
+Of course, the above example is a wrong usage. However, the helper function `mtx_unpickle` would incorrectly create a `Matrix_gfpn_dense` in a generic matrix space. The (new) purpose of this ticket is to fix it...
``````




---

archive/issue_comments_463202.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-01-05T13:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463202",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_463203.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2018-01-08T14:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463203",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_463204.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-08T14:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463204",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463205.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-14T10:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463205",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061762.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-14T10:14:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24468#event-61762"
}
```



---

archive/issue_comments_463206.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces\" to \"1bc5815e7121fd1b4d6f58c300e7eabc0148e367\"",
    "created_at": "2018-01-14T10:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24468#issuecomment-463206",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/fix_comparison_of_matrices_that_live_in_equivalent_matrix_spaces" to "1bc5815e7121fd1b4d6f58c300e7eabc0148e367"
