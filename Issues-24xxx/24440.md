# Issue 24440: Infinite loop from converting to QQbar

archive/issues_024203.json:
```json
{
    "body": "```\nsage: QQbar(tanh(pi + 0.1))\n\n/home/ralf/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9406)()\n    915         if mor is not None:\n    916             if no_extra_args:\n--> 917                 return mor._call_(x)\n    918             else:\n    919                 return mor._call_with_args(x, args, kwds)\n\n/home/ralf/sage/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4972)()\n    153                 print(type(C), C)\n    154                 print(type(C._element_constructor), C._element_constructor)\n--> 155             raise\n    156 \n    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):\n\n/home/ralf/sage/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4840)()\n    148         cdef Parent C = self._codomain\n    149         try:\n--> 150             return C._element_constructor(x)\n    151         except Exception:\n    152             if print_warnings:\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in _element_constructor_(self, x)\n   1138             return AlgebraicNumber(x._descr)\n   1139         elif hasattr(x, '_algebraic_'):\n-> 1140             return x._algebraic_(QQbar)\n   1141         return AlgebraicNumber(x)\n   1142 \n\n/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:12139)()\n   1477         \"\"\"\n   1478         from sage.symbolic.expression_conversions import algebraic\n-> 1479         return algebraic(self, field)\n   1480 \n   1481     def __hash__(self):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in algebraic(ex, field)\n   1046         0\n   1047     \"\"\"\n-> 1048     return AlgebraicConverter(field)(ex)\n   1049 \n   1050 ##############\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    224             return self.tuple(ex)\n    225         else:\n--> 226             return self.composition(ex, operator)\n    227 \n    228     def get_fake_div(self, ex):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)\n    987                 res = -QQbar.zeta(4)*(exp_ia - ~exp_ia)/(exp_ia + ~exp_ia)\n    988         elif func_name in ['sinh', 'cosh', 'tanh']:\n--> 989             exp_a = exp(operand)._algebraic_(QQbar)\n    990             if func_name == 'sinh':\n    991                 res = (exp_a - ~exp_a)/2\n\n/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:12139)()\n   1477         \"\"\"\n   1478         from sage.symbolic.expression_conversions import algebraic\n-> 1479         return algebraic(self, field)\n   1480 \n   1481     def __hash__(self):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in algebraic(ex, field)\n   1046         0\n   1047     \"\"\"\n-> 1048     return AlgebraicConverter(field)(ex)\n   1049 \n   1050 ##############\n\n... last 6 frames repeated, from the frame below ...\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    216                 div = self.get_fake_div(ex)\n    217                 return self.arithmetic(div, div.operator())\n--> 218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n    220             return self.relation(ex, operator)\n\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\nIt seems that only `pi` as constant will trigger it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24440\n\n",
    "closed_at": "2018-05-08T17:27:55Z",
    "created_at": "2017-12-28T15:48:02Z",
    "labels": [
        "component: basic arithmetic",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Infinite loop from converting to QQbar",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24440",
    "user": "https://github.com/rwst"
}
```
```
sage: QQbar(tanh(pi + 0.1))

/home/ralf/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9406)()
    915         if mor is not None:
    916             if no_extra_args:
--> 917                 return mor._call_(x)
    918             else:
    919                 return mor._call_with_args(x, args, kwds)

/home/ralf/sage/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4972)()
    153                 print(type(C), C)
    154                 print(type(C._element_constructor), C._element_constructor)
--> 155             raise
    156 
    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/ralf/sage/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4840)()
    148         cdef Parent C = self._codomain
    149         try:
--> 150             return C._element_constructor(x)
    151         except Exception:
    152             if print_warnings:

/home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in _element_constructor_(self, x)
   1138             return AlgebraicNumber(x._descr)
   1139         elif hasattr(x, '_algebraic_'):
-> 1140             return x._algebraic_(QQbar)
   1141         return AlgebraicNumber(x)
   1142 

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:12139)()
   1477         """
   1478         from sage.symbolic.expression_conversions import algebraic
-> 1479         return algebraic(self, field)
   1480 
   1481     def __hash__(self):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in algebraic(ex, field)
   1046         0
   1047     """
-> 1048     return AlgebraicConverter(field)(ex)
   1049 
   1050 ##############

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    224             return self.tuple(ex)
    225         else:
--> 226             return self.composition(ex, operator)
    227 
    228     def get_fake_div(self, ex):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
    987                 res = -QQbar.zeta(4)*(exp_ia - ~exp_ia)/(exp_ia + ~exp_ia)
    988         elif func_name in ['sinh', 'cosh', 'tanh']:
--> 989             exp_a = exp(operand)._algebraic_(QQbar)
    990             if func_name == 'sinh':
    991                 res = (exp_a - ~exp_a)/2

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:12139)()
   1477         """
   1478         from sage.symbolic.expression_conversions import algebraic
-> 1479         return algebraic(self, field)
   1480 
   1481     def __hash__(self):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in algebraic(ex, field)
   1046         0
   1047     """
-> 1048     return AlgebraicConverter(field)(ex)
   1049 
   1050 ##############

... last 6 frames repeated, from the frame below ...

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

RuntimeError: maximum recursion depth exceeded in __instancecheck__
```
It seems that only `pi` as constant will trigger it.

Issue created by migration from https://trac.sagemath.org/ticket/24440





---

archive/issue_comments_338614.json:
```json
{
    "body": "Changing component from symbolics to basic arithmetic.",
    "created_at": "2018-02-02T09:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338614",
    "user": "https://github.com/rwst"
}
```

Changing component from symbolics to basic arithmetic.



---

archive/issue_comments_338615.json:
```json
{
    "body": "Also `QQbar(sin(I*pi/7))` crashes (with or without `hold=True`) but differently. Finally,\n\n```\nsage: QQbar(sinh(I*pi/7.,hold=True))\n...\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)\n    976             # Coerce (not convert, see #22571) arg to a rational\n    977             arg = operand.imag()/(2*ex.parent().pi())\n--> 978             rat_arg = QQ.coerce(arg.pyobject())\n    979             res = QQbar.zeta(rat_arg.denom())**rat_arg.numer()\n    980         elif func_name in ['sin', 'cos', 'tan']:\n...\nTypeError: no canonical coercion from Real Field with 53 bits of precision to Rational Field\n```",
    "created_at": "2018-02-09T07:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338615",
    "user": "https://github.com/rwst"
}
```

Also `QQbar(sin(I*pi/7))` crashes (with or without `hold=True`) but differently. Finally,

```
sage: QQbar(sinh(I*pi/7.,hold=True))
...
/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
    976             # Coerce (not convert, see #22571) arg to a rational
    977             arg = operand.imag()/(2*ex.parent().pi())
--> 978             rat_arg = QQ.coerce(arg.pyobject())
    979             res = QQbar.zeta(rat_arg.denom())**rat_arg.numer()
    980         elif func_name in ['sin', 'cos', 'tan']:
...
TypeError: no canonical coercion from Real Field with 53 bits of precision to Rational Field
```



---

archive/issue_comments_338616.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-09T07:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338616",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_338617.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-09T07:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338617",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_338618.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-28T20:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338618",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338619.json:
```json
{
    "body": "Thanks.",
    "created_at": "2018-04-29T03:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338619",
    "user": "https://github.com/rwst"
}
```

Thanks.



---

archive/issue_events_061731.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-08T17:27:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24440#event-61731"
}
```



---

archive/issue_comments_338620.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-08T17:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24440#issuecomment-338620",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
