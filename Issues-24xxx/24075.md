# Issue 24075: doctest failure in  schemes/elliptic_curves/heegner.py

archive/issues_023838.json:
```json
{
    "body": "On sage 8.1.beta8 several people got\n\n```\nsage -t --long src/sage/schemes/elliptic_curves/heegner.py\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/heegner.py\", line 6622, in\nsage.schemes.elliptic_curves.heegner.heegner_index\nFailed example:\n     E.heegner_index(-8)\nExpected:\n     Traceback (most recent call last):\n     ...\n     RuntimeError: ...\nGot:\n     1.00000?\n**********************************************************************\n```\n\nSee original report on [the sage-release thread](https://groups.google.com/forum/#!topic/sage-release/r920G2EVTBU).\n\nIssue created by migration from https://trac.sagemath.org/ticket/24075\n\n",
    "closed_at": "2017-10-25T06:58:14Z",
    "created_at": "2017-10-20T08:39:07Z",
    "labels": [
        "component: elliptic curves",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "doctest failure in  schemes/elliptic_curves/heegner.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24075",
    "user": "https://github.com/videlec"
}
```
On sage 8.1.beta8 several people got

```
sage -t --long src/sage/schemes/elliptic_curves/heegner.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/heegner.py", line 6622, in
sage.schemes.elliptic_curves.heegner.heegner_index
Failed example:
     E.heegner_index(-8)
Expected:
     Traceback (most recent call last):
     ...
     RuntimeError: ...
Got:
     1.00000?
**********************************************************************
```

See original report on [the sage-release thread](https://groups.google.com/forum/#!topic/sage-release/r920G2EVTBU).

Issue created by migration from https://trac.sagemath.org/ticket/24075





---

archive/issue_comments_333525.json:
```json
{
    "body": "This test uses the elliptic curve with Cremona label 274627a1 which is in the optional database, and has rank 1.  Anyone running the test without the database will be computing the rank and that cannot be done using defaults (i.e. just doing E.rank()) as the generator is quite large.  Those people seeing this fault probably have the database installed, so that the rank is set to 1 when te curve is created.\n\nWe can switch the test to a curve of conductor >400000, or manually set its rank to 1 using E._set_rank().  Or we can make this test optional on have the large database installed.",
    "created_at": "2017-10-20T08:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333525",
    "user": "https://github.com/JohnCremona"
}
```

This test uses the elliptic curve with Cremona label 274627a1 which is in the optional database, and has rank 1.  Anyone running the test without the database will be computing the rank and that cannot be done using defaults (i.e. just doing E.rank()) as the generator is quite large.  Those people seeing this fault probably have the database installed, so that the rank is set to 1 when te curve is created.

We can switch the test to a curve of conductor >400000, or manually set its rank to 1 using E._set_rank().  Or we can make this test optional on have the large database installed.



---

archive/issue_comments_333526.json:
```json
{
    "body": "Changing component from documentation to elliptic curves.",
    "created_at": "2017-10-20T09:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333526",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from documentation to elliptic curves.



---

archive/issue_comments_333527.json:
```json
{
    "body": "Nice analysis. So this is caused by #23962.\n\nI would like to use a different curve which is not in any database.",
    "created_at": "2017-10-20T09:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333527",
    "user": "https://github.com/jdemeyer"
}
```

Nice analysis. So this is caused by #23962.

I would like to use a different curve which is not in any database.



---

archive/issue_comments_333528.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Nice analysis. So this is caused by #23962.\n> \n> I would like to use a different curve which is not in any database.\n\n\nI'll try to come up with one -- it should have rank 1 but E.rank() should fail to give that.",
    "created_at": "2017-10-20T09:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333528",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:4 jdemeyer]:
> Nice analysis. So this is caused by #23962.
> 
> I would like to use a different curve which is not in any database.


I'll try to come up with one -- it should have rank 1 but E.rank() should fail to give that.



---

archive/issue_comments_333529.json:
```json
{
    "body": "Try this:\n\n```\nsage: E = EllipticCurve([1,-1,0,-1228,-16267])\nsage: E.conductor()\n99982889\nsage: E.heegner_index(-8)\nUnable to compute the rank with certainty (lower bound=0).\nThis could be because Sha(E/Q)[2] is nontrivial.\nTry calling something like two_descent(second_limit=13) on the\ncurve then trying this command again.  You could also try rank\nwith only_use_mwrank=False.\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-3-367e86799b13> in <module>()\n----> 1 E.heegner_index(-Integer(8))\n\n/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/heegner.pyc in heegner_index(self, D, min_p, prec, descent_second_limit, verbose_mwrank, check_rank)\n   6522         raise ArithmeticError(\"Discriminant (=%s) must be a fundamental discriminant that satisfies the Heegner hypothesis.\"%D)\n   6523 \n-> 6524     if check_rank and self.rank() >= 2:\n   6525         return rings.infinity\n   6526 \n\n/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in rank(self, use_database, verbose, only_use_mwrank, algorithm, proof)\n   2120                     print(\"with only_use_mwrank=False.\")\n   2121                     del E.__mwrank_curve\n-> 2122                     raise RuntimeError('Rank not provably correct.')\n   2123                 else:\n   2124                     misc.verbose(\"Warning -- rank not proven correct\", level=1)\n\nRuntimeError: Rank not provably correct.\nsage: E.heegner_index(-8, descent_second_limit=16, check_rank=False)\n2.00000?\n```\n\nI only put the conductor line in to show that this is beyond the database.  (Sorry, it is in Stein-Watkins.)  Note that the correct Heegner index is 2 not 1 as in the other example.\n\nI'll look for an example outside SW if you want but not right now.",
    "created_at": "2017-10-20T10:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333529",
    "user": "https://github.com/JohnCremona"
}
```

Try this:

```
sage: E = EllipticCurve([1,-1,0,-1228,-16267])
sage: E.conductor()
99982889
sage: E.heegner_index(-8)
Unable to compute the rank with certainty (lower bound=0).
This could be because Sha(E/Q)[2] is nontrivial.
Try calling something like two_descent(second_limit=13) on the
curve then trying this command again.  You could also try rank
with only_use_mwrank=False.
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-3-367e86799b13> in <module>()
----> 1 E.heegner_index(-Integer(8))

/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/heegner.pyc in heegner_index(self, D, min_p, prec, descent_second_limit, verbose_mwrank, check_rank)
   6522         raise ArithmeticError("Discriminant (=%s) must be a fundamental discriminant that satisfies the Heegner hypothesis."%D)
   6523 
-> 6524     if check_rank and self.rank() >= 2:
   6525         return rings.infinity
   6526 

/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in rank(self, use_database, verbose, only_use_mwrank, algorithm, proof)
   2120                     print("with only_use_mwrank=False.")
   2121                     del E.__mwrank_curve
-> 2122                     raise RuntimeError('Rank not provably correct.')
   2123                 else:
   2124                     misc.verbose("Warning -- rank not proven correct", level=1)

RuntimeError: Rank not provably correct.
sage: E.heegner_index(-8, descent_second_limit=16, check_rank=False)
2.00000?
```

I only put the conductor line in to show that this is beyond the database.  (Sorry, it is in Stein-Watkins.)  Note that the correct Heegner index is 2 not 1 as in the other example.

I'll look for an example outside SW if you want but not right now.



---

archive/issue_comments_333530.json:
```json
{
    "body": "BTW even if the huge SW database is installed this function would not be affected, so this example should be good.  Finding examples is not that easy: E should have rank 1 and the quadratic twist used rank 0.  At least one of those ranks should fail to be computed by default but succeed with the additional parameters given.\n\nIf people are happy with the new example I already posted, it would be great if someone else would make the patch; I'll review it.  It need not be a blocker though, surely?",
    "created_at": "2017-10-20T13:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333530",
    "user": "https://github.com/JohnCremona"
}
```

BTW even if the huge SW database is installed this function would not be affected, so this example should be good.  Finding examples is not that easy: E should have rank 1 and the quadratic twist used rank 0.  At least one of those ranks should fail to be computed by default but succeed with the additional parameters given.

If people are happy with the new example I already posted, it would be great if someone else would make the patch; I'll review it.  It need not be a blocker though, surely?



---

archive/issue_comments_333531.json:
```json
{
    "body": "It definitely is a blocker: an optional package is breaking a doctest.",
    "created_at": "2017-10-20T13:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333531",
    "user": "https://github.com/videlec"
}
```

It definitely is a blocker: an optional package is breaking a doctest.



---

archive/issue_comments_333532.json:
```json
{
    "body": "branch done\n\n---\nNew commits:",
    "created_at": "2017-10-20T19:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333532",
    "user": "https://github.com/fchapoton"
}
```

branch done

---
New commits:



---

archive/issue_comments_333533.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-20T19:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333533",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_333534.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-23T10:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333534",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_333535.json:
```json
{
    "body": "This worked for me on a system with the optional database attached.  I assume that the patchbots are testing with that -- I cannot interpret the variety of results various patchbots get but since the issue was to have an example which behaves the right way even with the optional database, this looks good.",
    "created_at": "2017-10-23T10:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333535",
    "user": "https://github.com/JohnCremona"
}
```

This worked for me on a system with the optional database attached.  I assume that the patchbots are testing with that -- I cannot interpret the variety of results various patchbots get but since the issue was to have an example which behaves the right way even with the optional database, this looks good.



---

archive/issue_comments_333536.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-10-23T10:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333536",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_061148.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-25T06:58:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24075#event-61148"
}
```



---

archive/issue_comments_333537.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-25T06:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333537",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_333538.json:
```json
{
    "body": "Hi John, \n\nJust in case you want to have some help interpreting failing patchbots sometime in the future: on #23832 there is a list of known failures for patchbots, there is also a link to it called \"metaticket for patchbot failures\" on trac.sagemath.org .The reason we considered this ticket a blocker is because it was also causing patchbots to fail and thereby hindering the sage development process.",
    "created_at": "2017-10-25T14:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333538",
    "user": "https://github.com/koffie"
}
```

Hi John, 

Just in case you want to have some help interpreting failing patchbots sometime in the future: on #23832 there is a list of known failures for patchbots, there is also a link to it called "metaticket for patchbot failures" on trac.sagemath.org .The reason we considered this ticket a blocker is because it was also causing patchbots to fail and thereby hindering the sage development process.



---

archive/issue_comments_333539.json:
```json
{
    "body": "Note also that some patchbots are run with optional packages and some are not... the information is somewhere hidden in the log\n\n```\nUsing --optional=ccache,gdb,mpir,python2,sage\n```\nversus\n\n```\nUsing --optional=4ti2,autotools,benzene,bliss,boost,buckygen,cmake,coxeter3,cryptominisat,csdp,d3js,database_jones_numfield,database_kohel,database_mutation_class,database_odlyzko_zeta,database_pari,database_stein_watkins,database_stein_watkins_mini,database_symbolic_data,deformation,dot2tex,frobby,gambit,gap_jupyter,gp2c,igraph,latte_int,libbraiding,libhomfly,libogg,lidia,lrslib,mcqd,meataxe,mpfrcx,mpir,nose,notedown,openssl,ore_algebra,pandoc_attributes,pandocfilters,pari_jupyter,plantri,pysingular,python2,python_igraph,pyx,qhull,saclib,sage,scons,singular_jupyter,sirocco,tdlib,termcap,tides,topcom\n```",
    "created_at": "2017-10-25T15:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333539",
    "user": "https://github.com/videlec"
}
```

Note also that some patchbots are run with optional packages and some are not... the information is somewhere hidden in the log

```
Using --optional=ccache,gdb,mpir,python2,sage
```
versus

```
Using --optional=4ti2,autotools,benzene,bliss,boost,buckygen,cmake,coxeter3,cryptominisat,csdp,d3js,database_jones_numfield,database_kohel,database_mutation_class,database_odlyzko_zeta,database_pari,database_stein_watkins,database_stein_watkins_mini,database_symbolic_data,deformation,dot2tex,frobby,gambit,gap_jupyter,gp2c,igraph,latte_int,libbraiding,libhomfly,libogg,lidia,lrslib,mcqd,meataxe,mpfrcx,mpir,nose,notedown,openssl,ore_algebra,pandoc_attributes,pandocfilters,pari_jupyter,plantri,pysingular,python2,python_igraph,pyx,qhull,saclib,sage,scons,singular_jupyter,sirocco,tdlib,termcap,tides,topcom
```



---

archive/issue_comments_333540.json:
```json
{
    "body": "OK, thanks both.",
    "created_at": "2017-10-25T15:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24075#issuecomment-333540",
    "user": "https://github.com/JohnCremona"
}
```

OK, thanks both.
