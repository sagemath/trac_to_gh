# Issue 24425: Fix inherently failing random_expr doctest

archive/issues_024188.json:
```json
{
    "body": "The docs for `random_expr` read:\n\n```\n  This function will often raise an error because it tries to create\n  an erroneous expression (such as a division by zero).\n```\nIt has the following doctest:\n\n```\n        sage: from sage.symbolic.random_tests import *\n        sage: set_random_seed(53)\n        sage: random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random\n        (v1^(0.97134084277 + 0.195868299334*I)/csc(-pi + v1^2 + v3) + sgn(1/\n...\n```\nDespite having a random seed the test run changes with every new builtin function introduced in `sage/functions` because the global function list changes. That's why the test was marked random. The problem however is that the test can even raise an error, as the docs state above. The\"`random`\" keyword does not catch this, and it would make the test useless anyway. \n\nTests are meant to test the functionality of the associated code so the test and perhaps `random_expr` should be rewritten such that it allows a test that does not change with a changed global function list.\n\nReviewer: Marc Mezzarobba\n\nAuthor: Ralf Stephan\n\nBranch: a17755c56a524033d3075a737f4a08facd012dbb\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24425\n\n",
    "closed_at": "2018-06-02T16:11:52Z",
    "created_at": "2017-12-24T07:25:10Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Fix inherently failing random_expr doctest",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24425",
    "user": "https://github.com/rwst"
}
```
The docs for `random_expr` read:

```
  This function will often raise an error because it tries to create
  an erroneous expression (such as a division by zero).
```
It has the following doctest:

```
        sage: from sage.symbolic.random_tests import *
        sage: set_random_seed(53)
        sage: random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random
        (v1^(0.97134084277 + 0.195868299334*I)/csc(-pi + v1^2 + v3) + sgn(1/
...
```
Despite having a random seed the test run changes with every new builtin function introduced in `sage/functions` because the global function list changes. That's why the test was marked random. The problem however is that the test can even raise an error, as the docs state above. The"`random`" keyword does not catch this, and it would make the test useless anyway. 

Tests are meant to test the functionality of the associated code so the test and perhaps `random_expr` should be rewritten such that it allows a test that does not change with a changed global function list.

Reviewer: Marc Mezzarobba

Author: Ralf Stephan

Branch: a17755c56a524033d3075a737f4a08facd012dbb

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24425





---

archive/issue_comments_360595.json:
```json
{
    "body": "<a id='comment:1'></a>The lazy_import is not even necessary for trigger.",
    "created_at": "2017-12-24T07:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360595",
    "user": "https://github.com/rwst"
}
```

<a id='comment:1'></a>The lazy_import is not even necessary for trigger.



---

archive/issue_comments_360596.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -47,7 +47,7 @@\n ```\n The reason why the doctest fails is that, despite fixing the random seed, the functions and symbols picked by `random_expr` are different. This, at some point in the buildup of the expression, leads to the sub-expression `kronecker_delta(-0.6165326641917295 + 0.15117833554974136*I, e)` which immediately evaluates to `0`. The `0` progresses eventually into a denominator, causing the error. `random_expr` is not written to avoid such errors if they happen, nor does it avoid other exceptions thrown. The author of the doctest apparently just chose a random seed that happens to not throw errors.\n \n-Of course the actual bug is that `random_expr` changes behaviour when unrelated code is changed.\n+A fix that filters out zero divisions and intended exceptions thrown from code in `functions` before returning the expression would be the  best solution (but it doesn't handle runtime errors from Pynac).\n \n Comment: 1\n \n``````\n",
    "created_at": "2017-12-24T08:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360596",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -47,7 +47,7 @@
 ```
 The reason why the doctest fails is that, despite fixing the random seed, the functions and symbols picked by `random_expr` are different. This, at some point in the buildup of the expression, leads to the sub-expression `kronecker_delta(-0.6165326641917295 + 0.15117833554974136*I, e)` which immediately evaluates to `0`. The `0` progresses eventually into a denominator, causing the error. `random_expr` is not written to avoid such errors if they happen, nor does it avoid other exceptions thrown. The author of the doctest apparently just chose a random seed that happens to not throw errors.
 
-Of course the actual bug is that `random_expr` changes behaviour when unrelated code is changed.
+A fix that filters out zero divisions and intended exceptions thrown from code in `functions` before returning the expression would be the  best solution (but it doesn't handle runtime errors from Pynac).
 
 Comment: 1
 
``````




---

archive/issue_comments_360597.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+The docs for `random_expr` read:\n \n+```\n+  This function will often raise an error because it tries to create\n+  an erroneous expression (such as a division by zero).\n+```\n+It has the following doctest:\n+\n+```\n+        sage: from sage.symbolic.random_tests import *\n+        sage: set_random_seed(53)\n+        sage: random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random\n+        (v1^(0.97134084277 + 0.195868299334*I)/csc(-pi + v1^2 + v3) + sgn(1/\n+...\n+```\n+Despite having a random seed the test run changes with every new builtin function introduced in `sage/functions` because the global function list changes. That's why the test was marked random. The problem however is that the test can even raise an error, as the docs state above. The\"`random`\" keyword does not catch this, and it would make the test useless anyway. \n+\n+Tests are meant to test the functionality of the associated code so the test and perhaps `random_expr` should be rewritten such that it allows a test that does not change with a changed global function list.\n \n Comment: 1\n \n``````\n",
    "created_at": "2017-12-26T07:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360597",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
+The docs for `random_expr` read:
 
+```
+  This function will often raise an error because it tries to create
+  an erroneous expression (such as a division by zero).
+```
+It has the following doctest:
+
+```
+        sage: from sage.symbolic.random_tests import *
+        sage: set_random_seed(53)
+        sage: random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random
+        (v1^(0.97134084277 + 0.195868299334*I)/csc(-pi + v1^2 + v3) + sgn(1/
+...
+```
+Despite having a random seed the test run changes with every new builtin function introduced in `sage/functions` because the global function list changes. That's why the test was marked random. The problem however is that the test can even raise an error, as the docs state above. The"`random`" keyword does not catch this, and it would make the test useless anyway. 
+
+Tests are meant to test the functionality of the associated code so the test and perhaps `random_expr` should be rewritten such that it allows a test that does not change with a changed global function list.
 
 Comment: 1
 
``````




---

archive/issue_comments_360598.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2017-12-26T08:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360598",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_360599.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-26T08:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360599",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_360600.json:
```json
{
    "body": "<a id='comment:6'></a>I don't fully understand the context, but the change looks reasonable and really unlikely to break anything\u2014and this ticket has been languishing for months.",
    "created_at": "2018-06-01T12:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360600",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:6'></a>I don't fully understand the context, but the change looks reasonable and really unlikely to break anythingâ€”and this ticket has been languishing for months.



---

archive/issue_comments_360601.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-01T12:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360601",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061708.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-02T16:11:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24425#event-61708"
}
```



---

archive/issue_comments_360602.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-02T16:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360602",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_360603.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks. Oddly enough, #24212 depends on this.",
    "created_at": "2018-06-02T16:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24425#issuecomment-360603",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>Thanks. Oddly enough, #24212 depends on this.
