# Issue 24313: py3: fixes to sage.misc.temporary_file

archive/issues_024076.json:
```json
{
    "assignees": [],
    "body": "This updates the `atomic_write` context manager to work in both \"text\" and \"binary\" modes on Python 3, and fixes a few of the module's tests so that they pass on Python 3.\n\nBranch/Commit: **[d7d7614](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer**\n\nAuthor: **Erik Bray**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24313_\n\n",
    "closed_at": "2018-02-09T08:03:59Z",
    "created_at": "2017-12-01T15:37:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20python3",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: fixes to sage.misc.temporary_file",
    "type": "issue",
    "updated_at": "2018-02-09T08:03:59Z",
    "url": "https://github.com/sagemath/sage/issues/24313",
    "user": "https://github.com/embray"
}
```
This updates the `atomic_write` context manager to work in both "text" and "binary" modes on Python 3, and fixes a few of the module's tests so that they pass on Python 3.

Branch/Commit: **[d7d7614](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)**

Reviewer: **Frédéric Chapoton, Jeroen Demeyer**

Author: **Erik Bray**

_Issue created by migration from https://trac.sagemath.org/ticket/24313_





---

archive/issue_events_307699.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T15:37:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307699"
}
```



---

archive/issue_events_307700.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T15:37:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20python3",
    "label_color": "000080",
    "label_name": "component: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307700"
}
```



---

archive/issue_events_307701.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T15:37:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307701"
}
```



---

archive/issue_events_307702.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T15:37:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307702"
}
```



---

archive/issue_events_307703.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T15:37:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307703"
}
```



---

archive/issue_comments_370739.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nCould you cook up doctests for\n- usage of `binary`\n- usage of `encoding`\n- checking that `binary=True` is ignored when an encoding is provided",
    "created_at": "2017-12-04T10:14:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370739",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'>Comment 2:</a>
Could you cook up doctests for
- usage of `binary`
- usage of `encoding`
- checking that `binary=True` is ignored when an encoding is provided



---

archive/issue_comments_370740.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nInstead of the `encoding` argument, I would rather allow arbitrary `**kwds`.",
    "created_at": "2017-12-04T10:35:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370740",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'>Comment 3:</a>
Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.



---

archive/issue_events_307704.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-04T10:35:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307704"
}
```



---

archive/issue_events_307705.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-04T10:35:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307705"
}
```



---

archive/issue_comments_370741.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nReplying to [@jdemeyer](#comment%3A3):\n> Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.\n\nCould you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter (it should, which I think is a defect, but it doesn't).  It also requires special handling depending on whether on Python 2 or 3 anyways.\n\n+1 to adding more tests though.",
    "created_at": "2017-12-04T13:31:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370741",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'>Comment 4:</a>
Replying to [@jdemeyer](#comment%3A3):
> Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter (it should, which I think is a defect, but it doesn't).  It also requires special handling depending on whether on Python 2 or 3 anyways.

+1 to adding more tests though.



---

archive/issue_comments_370742.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@embray](#comment%3A4):\n> Replying to [@jdemeyer](#comment%3A3):\n> > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.\n\n> \n> Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.\n\n1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.\n\n2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.\n\n3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.",
    "created_at": "2017-12-04T13:43:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370742",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@embray](#comment%3A4):
> Replying to [@jdemeyer](#comment%3A3):
> > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

> 
> Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.

1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.

2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.



---

archive/issue_comments_370743.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@jdemeyer](#comment%3A5):\n> Replying to [@embray](#comment%3A4):\n> > Replying to [@jdemeyer](#comment%3A3):\n> > > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.\n\n> > \n> > Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.\n\n> \n> 1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.\n\nCan you suggest some need for anything besides universal newline handling in text mode?\n\n> 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.\n\n*only* in text mode.  If you want to be able to support text and binary modes that needs to be done explicitly.  With normal `io.open` this would be done with a mode string, but that's not really applicable for `atomic_write`.\n\nI do agree there's no reason to supply the `locale.getpreferredencoding()`.  I thought that made the code and the intent clearer by explicitly stating what the default is rather than relying on the underlying implementation, but I could remove this if this is the only sticking point.\n\n> 3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.\n\nIt really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write` (which I'm trying to still trying to keep as restricted as possible to meet its narrow use case).",
    "created_at": "2017-12-04T14:19:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370743",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@jdemeyer](#comment%3A5):
> Replying to [@embray](#comment%3A4):
> > Replying to [@jdemeyer](#comment%3A3):
> > > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

> > 
> > Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.

> 
> 1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.

Can you suggest some need for anything besides universal newline handling in text mode?

> 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

*only* in text mode.  If you want to be able to support text and binary modes that needs to be done explicitly.  With normal `io.open` this would be done with a mode string, but that's not really applicable for `atomic_write`.

I do agree there's no reason to supply the `locale.getpreferredencoding()`.  I thought that made the code and the intent clearer by explicitly stating what the default is rather than relying on the underlying implementation, but I could remove this if this is the only sticking point.

> 3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.

It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write` (which I'm trying to still trying to keep as restricted as possible to meet its narrow use case).



---

archive/issue_comments_370744.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nReplying to [@embray](#comment%3A6):\n> Can you suggest some need for anything besides universal newline handling in text mode?\n\nThere is no need currently. But I think it is nice design to allow arbitrary arguments. It is narrow-minded to disallow something just because there is currently no use case.\n\n> > 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.\n\n> \n> *only* in text mode.\n\nOf course... what's your point? How would you use `encoding` in binary mode? I don't get what you are trying to say...\n\n> It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write`\n\nI don't really agree with that. If you are providing an API dealing with files, it makes sense to have an API which is close to what `open()` provides. And explicitly passing `**kwds` does exactly that. It makes it explicit that you're just providing a wrapper around `open()` and `TemporaryFile()`.",
    "created_at": "2017-12-04T15:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370744",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
Replying to [@embray](#comment%3A6):
> Can you suggest some need for anything besides universal newline handling in text mode?

There is no need currently. But I think it is nice design to allow arbitrary arguments. It is narrow-minded to disallow something just because there is currently no use case.

> > 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

> 
> *only* in text mode.

Of course... what's your point? How would you use `encoding` in binary mode? I don't get what you are trying to say...

> It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write`

I don't really agree with that. If you are providing an API dealing with files, it makes sense to have an API which is close to what `open()` provides. And explicitly passing `**kwds` does exactly that. It makes it explicit that you're just providing a wrapper around `open()` and `TemporaryFile()`.



---

archive/issue_comments_370745.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\n>  If you are providing an API dealing with files, it makes sense to have an API which is close to what open() provides.\n\nNot necessarily.  `atomic_write` is not a generic file opening function.  It has only one purpose which is to write files in a narrow context.  Many of the arguments you might pass `open()` don't make sense.  If it did one might have written it that way in the first place, but you (I think?) didn't and for good reason.\n\nRight now this is only adding the bare minimum necessary to achieve the required goals--not exploding the API footprint.",
    "created_at": "2017-12-04T16:45:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370745",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'>Comment 8:</a>
>  If you are providing an API dealing with files, it makes sense to have an API which is close to what open() provides.

Not necessarily.  `atomic_write` is not a generic file opening function.  It has only one purpose which is to write files in a narrow context.  Many of the arguments you might pass `open()` don't make sense.  If it did one might have written it that way in the first place, but you (I think?) didn't and for good reason.

Right now this is only adding the bare minimum necessary to achieve the required goals--not exploding the API footprint.



---

archive/issue_comments_370746.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nAlso again, I'll note, that `TemporaryFile` does not accept all the arguments that `open` does in the first place (in particular it does not accept an argument for encoding error handling--which I would consider an upstream defect).",
    "created_at": "2017-12-04T16:46:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370746",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'>Comment 9:</a>
Also again, I'll note, that `TemporaryFile` does not accept all the arguments that `open` does in the first place (in particular it does not accept an argument for encoding error handling--which I would consider an upstream defect).



---

archive/issue_comments_370747.json:
```json
{
    "body": "Changed commit from **[bccdf94](https://github.com/sagemath/sagetrac-mirror/commit/bccdf943830707bf200e6ddd6a8a00da54205744)** to **[589e7a2](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)**",
    "created_at": "2018-01-17T09:38:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370747",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[bccdf94](https://github.com/sagemath/sagetrac-mirror/commit/bccdf943830707bf200e6ddd6a8a00da54205744)** to **[589e7a2](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)**



---

archive/issue_comments_370748.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13\">589e7a2</a></td><td><code>Slight reworking of the arguments to atomic_write:</code></td></tr></table>\n",
    "created_at": "2018-01-17T09:38:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370748",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'>Comment 10:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13">589e7a2</a></td><td><code>Slight reworking of the arguments to atomic_write:</code></td></tr></table>




---

archive/issue_comments_370749.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nPart of the problem here was the use of `tempfile.TemporaryFile`, which is incompatible with Jeroen's request (and in thinking about this I think the stdlib is buggy here--`TemporaryFile` should accept arbitrary kwargs to pass to `io.open`, in fact, it doesn't accept an *errors* argument which is just annoying).\n\nI reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.",
    "created_at": "2018-01-17T09:41:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370749",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'>Comment 11:</a>
Part of the problem here was the use of `tempfile.TemporaryFile`, which is incompatible with Jeroen's request (and in thinking about this I think the stdlib is buggy here--`TemporaryFile` should accept arbitrary kwargs to pass to `io.open`, in fact, it doesn't accept an *errors* argument which is just annoying).

I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.



---

archive/issue_events_307706.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-17T09:41:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307706"
}
```



---

archive/issue_events_307707.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-17T09:41:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307707"
}
```



---

archive/issue_comments_370750.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad\">9a4d548</a></td><td><code>Slight correction to this docstring.</code></td></tr></table>\n",
    "created_at": "2018-01-17T09:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370750",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:12'>Comment 12:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad">9a4d548</a></td><td><code>Slight correction to this docstring.</code></td></tr></table>




---

archive/issue_comments_370751.json:
```json
{
    "body": "Changed commit from **[589e7a2](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)** to **[9a4d548](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)**",
    "created_at": "2018-01-17T09:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370751",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[589e7a2](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)** to **[9a4d548](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)**



---

archive/issue_comments_370752.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nLooks good to me. Jeroen, your opinion ?",
    "created_at": "2018-01-22T16:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370752",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'>Comment 13:</a>
Looks good to me. Jeroen, your opinion ?



---

archive/issue_events_307708.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-22T20:42:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307708"
}
```



---

archive/issue_events_307709.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-22T20:42:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307709"
}
```



---

archive/issue_comments_370753.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@embray](#comment%3A11):\n> I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.\n\nThat's not actually what the patch does... I see `tmp_filename()` which is Sage-specific thing.\n\nAnd it's crucial that the temporary file is created in the same directory as the destination file, otherwise the move is not guaranteed to be atomic. In fact it would be good to add the doctests which shows that the file in indeed created in the right directory.",
    "created_at": "2018-01-22T20:42:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370753",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@embray](#comment%3A11):
> I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.

That's not actually what the patch does... I see `tmp_filename()` which is Sage-specific thing.

And it's crucial that the temporary file is created in the same directory as the destination file, otherwise the move is not guaranteed to be atomic. In fact it would be good to add the doctests which shows that the file in indeed created in the right directory.



---

archive/issue_comments_370754.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nI see what you're saying--originally I did use `mkstemp` directly but then saw `tmp_filename` and thought to use that, neglecting the point about the directory.  I don't think I'll add a test for that though because as long as it's implemented correctly then that's tautological (but it would be helpful if that were documented).",
    "created_at": "2018-01-23T11:20:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370754",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'>Comment 15:</a>
I see what you're saying--originally I did use `mkstemp` directly but then saw `tmp_filename` and thought to use that, neglecting the point about the directory.  I don't think I'll add a test for that though because as long as it's implemented correctly then that's tautological (but it would be helpful if that were documented).



---

archive/issue_comments_370755.json:
```json
{
    "body": "Changed commit from **[9a4d548](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)** to **[c2bf3b9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)**",
    "created_at": "2018-01-23T11:27:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370755",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9a4d548](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)** to **[c2bf3b9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)**



---

archive/issue_comments_370756.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9\">c2bf3b9</a></td><td><code>Actually use mkstemp directly instead of tmp_filename; create the tempfile in the same directory as the target file</code></td></tr></table>\n",
    "created_at": "2018-01-23T11:27:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370756",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:16'>Comment 16:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9">c2bf3b9</a></td><td><code>Actually use mkstemp directly instead of tmp_filename; create the tempfile in the same directory as the target file</code></td></tr></table>




---

archive/issue_events_307710.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T11:28:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307710"
}
```



---

archive/issue_events_307711.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T11:28:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307711"
}
```



---

archive/issue_comments_370757.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nOK, I am essentially happy with this now. Just a few minor points:\n\n1. in the docs, use <code>\\`\\`**kwargs\\`\\`</code> instead of <code>\\`\\`kwargs\\`\\`</code>.\n\n2. add a test for `**kwargs`\n\n2. add a test for *invalid* `**kwargs`",
    "created_at": "2018-01-23T15:54:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370757",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
OK, I am essentially happy with this now. Just a few minor points:

1. in the docs, use <code>\`\`**kwargs\`\`</code> instead of <code>\`\`kwargs\`\`</code>.

2. add a test for `**kwargs`

2. add a test for *invalid* `**kwargs`



---

archive/issue_events_307712.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-24T13:09:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307712"
}
```



---

archive/issue_events_307713.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-24T13:09:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307713"
}
```



---

archive/issue_comments_370758.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nSounds good--will do.",
    "created_at": "2018-01-26T16:28:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370758",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'>Comment 20:</a>
Sounds good--will do.



---

archive/issue_comments_370759.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242\">5df54d4</a></td><td><code>Address some review comments:</code></td></tr></table>\n",
    "created_at": "2018-01-31T17:29:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370759",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:21'>Comment 21:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242">5df54d4</a></td><td><code>Address some review comments:</code></td></tr></table>




---

archive/issue_comments_370760.json:
```json
{
    "body": "Changed commit from **[c2bf3b9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)** to **[5df54d4](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)**",
    "created_at": "2018-01-31T17:29:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370760",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c2bf3b9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)** to **[5df54d4](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)**



---

archive/issue_events_307714.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-31T17:37:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307714"
}
```



---

archive/issue_events_307715.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-31T17:37:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307715"
}
```



---

archive/issue_comments_370761.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nI think this should do it.",
    "created_at": "2018-01-31T17:37:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370761",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'>Comment 22:</a>
I think this should do it.



---

archive/issue_comments_370762.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nthe import of locale seems no longer needed",
    "created_at": "2018-02-04T19:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370762",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'>Comment 23:</a>
the import of locale seems no longer needed



---

archive/issue_comments_370763.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/sage-misc-tempfile)** to **[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)**",
    "created_at": "2018-02-05T09:43:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370763",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/embray/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/sage-misc-tempfile)** to **[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)**



---

archive/issue_comments_370764.json:
```json
{
    "body": "Changed commit from **[5df54d4](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)** to **[d8170e6](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)**",
    "created_at": "2018-02-05T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370764",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5df54d4](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)** to **[d8170e6](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)**



---

archive/issue_comments_370765.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523\">d8170e6</a></td><td><code>Don't import locale</code></td></tr></table>\n",
    "created_at": "2018-02-05T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370765",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:25'>Comment 25:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523">d8170e6</a></td><td><code>Don't import locale</code></td></tr></table>




---

archive/issue_comments_370766.json:
```json
{
    "body": "Changed commit from **[d8170e6](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)** to **[d7d7614](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)**",
    "created_at": "2018-02-05T09:47:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370766",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d8170e6](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)** to **[d7d7614](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)**



---

archive/issue_comments_370767.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4\">d7d7614</a></td><td><code>Catch all exceptions from io.open()</code></td></tr></table>\n",
    "created_at": "2018-02-05T09:47:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370767",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:26'>Comment 26:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4">d7d7614</a></td><td><code>Catch all exceptions from io.open()</code></td></tr></table>




---

archive/issue_comments_370768.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nI added 2 tiny fixes. If you agree, you (Erik or Fr\u00e9d\u00e9ric) can set it to positive_review.",
    "created_at": "2018-02-05T09:48:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370768",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'>Comment 27:</a>
I added 2 tiny fixes. If you agree, you (Erik or Frédéric) can set it to positive_review.



---

archive/issue_comments_370769.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer**",
    "created_at": "2018-02-05T09:48:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370769",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Frédéric Chapoton, Jeroen Demeyer**



---

archive/issue_events_307716.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-05T13:02:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307716"
}
```



---

archive/issue_events_307717.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-05T13:02:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307717"
}
```



---

archive/issue_comments_370770.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)** to **[d7d7614](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)**",
    "created_at": "2018-02-09T08:03:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370770",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)** to **[d7d7614](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)**



---

archive/issue_events_307718.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-09T08:03:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307718"
}
```



---

archive/issue_events_307719.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "38e8a65eec4c6cb182db49a4cd37da7ade52350e",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-02-09T08:03:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-307719"
}
```
