# Issue 24313: py3: fixes to sage.misc.temporary_file

archive/issues_024076.json:
```json
{
    "body": "This updates the `atomic_write` context manager to work in both \"text\" and \"binary\" modes on Python 3, and fixes a few of the module's tests so that they pass on Python 3.\n\n**Branch/Commit:** [d7d7614c73854be5bf155f789485d4fae90edff4](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)\n\n**Reviewer:** Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer\n\n**Author:** Erik Bray\n\nIssue created by migration from https://trac.sagemath.org/ticket/24313\n\n",
    "closed_at": "2018-02-09T08:03:59Z",
    "created_at": "2017-12-01T15:37:26Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "title": "py3: fixes to sage.misc.temporary_file",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/24313",
    "user": "https://github.com/embray"
}
```
This updates the `atomic_write` context manager to work in both "text" and "binary" modes on Python 3, and fixes a few of the module's tests so that they pass on Python 3.

**Branch/Commit:** [d7d7614c73854be5bf155f789485d4fae90edff4](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)

**Reviewer:** Frédéric Chapoton, Jeroen Demeyer

**Author:** Erik Bray

Issue created by migration from https://trac.sagemath.org/ticket/24313





---

archive/issue_events_215859.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T15:37:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215859"
}
```



---

archive/issue_comments_370605.json:
```json
{
    "body": "<a id='comment:2'></a>\nCould you cook up doctests for\n- usage of `binary`\n- usage of `encoding`\n- checking that `binary=True` is ignored when an encoding is provided",
    "created_at": "2017-12-04T10:14:27Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370605",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>
Could you cook up doctests for
- usage of `binary`
- usage of `encoding`
- checking that `binary=True` is ignored when an encoding is provided



---

archive/issue_comments_370606.json:
```json
{
    "body": "<a id='comment:3'></a>\nInstead of the `encoding` argument, I would rather allow arbitrary `**kwds`.",
    "created_at": "2017-12-04T10:35:41Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370606",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.



---

archive/issue_events_215860.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-04T10:35:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215860"
}
```



---

archive/issue_events_215861.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-04T10:35:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215861"
}
```



---

archive/issue_comments_370607.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [jdemeyer](#comment%3A3):\n> Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.\n\nCould you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter (it should, which I think is a defect, but it doesn't).  It also requires special handling depending on whether on Python 2 or 3 anyways.\n\n+1 to adding more tests though.",
    "created_at": "2017-12-04T13:31:08Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370607",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Replying to [jdemeyer](#comment%3A3):
> Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter (it should, which I think is a defect, but it doesn't).  It also requires special handling depending on whether on Python 2 or 3 anyways.

+1 to adding more tests though.



---

archive/issue_comments_370608.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [embray](#comment%3A4):\n> Replying to [jdemeyer](#comment%3A3):\n> > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.\n\n> \n> Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.\n\n1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.\n\n2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.\n\n3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.",
    "created_at": "2017-12-04T13:43:52Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370608",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Replying to [embray](#comment%3A4):
> Replying to [jdemeyer](#comment%3A3):
> > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

> 
> Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.

1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.

2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.



---

archive/issue_comments_370609.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A5):\n> Replying to [embray](#comment%3A4):\n> > Replying to [jdemeyer](#comment%3A3):\n> > > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.\n\n> > \n> > Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.\n\n> \n> 1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.\n\nCan you suggest some need for anything besides universal newline handling in text mode?\n\n> 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.\n\n*only* in text mode.  If you want to be able to support text and binary modes that needs to be done explicitly.  With normal `io.open` this would be done with a mode string, but that's not really applicable for `atomic_write`.\n\nI do agree there's no reason to supply the `locale.getpreferredencoding()`.  I thought that made the code and the intent clearer by explicitly stating what the default is rather than relying on the underlying implementation, but I could remove this if this is the only sticking point.\n\n> 3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.\n\nIt really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write` (which I'm trying to still trying to keep as restricted as possible to meet its narrow use case).",
    "created_at": "2017-12-04T14:19:17Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370609",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A5):
> Replying to [embray](#comment%3A4):
> > Replying to [jdemeyer](#comment%3A3):
> > > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

> > 
> > Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does *not* accept all the same arguments as the latter.

> 
> 1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.

Can you suggest some need for anything besides universal newline handling in text mode?

> 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

*only* in text mode.  If you want to be able to support text and binary modes that needs to be done explicitly.  With normal `io.open` this would be done with a mode string, but that's not really applicable for `atomic_write`.

I do agree there's no reason to supply the `locale.getpreferredencoding()`.  I thought that made the code and the intent clearer by explicitly stating what the default is rather than relying on the underlying implementation, but I could remove this if this is the only sticking point.

> 3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.

It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write` (which I'm trying to still trying to keep as restricted as possible to meet its narrow use case).



---

archive/issue_comments_370610.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [embray](#comment%3A6):\n> Can you suggest some need for anything besides universal newline handling in text mode?\n\nThere is no need currently. But I think it is nice design to allow arbitrary arguments. It is narrow-minded to disallow something just because there is currently no use case.\n\n> > 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.\n\n> \n> *only* in text mode.\n\nOf course... what's your point? How would you use `encoding` in binary mode? I don't get what you are trying to say...\n\n> It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write`\n\nI don't really agree with that. If you are providing an API dealing with files, it makes sense to have an API which is close to what `open()` provides. And explicitly passing `**kwds` does exactly that. It makes it explicit that you're just providing a wrapper around `open()` and `TemporaryFile()`.",
    "created_at": "2017-12-04T15:57:45Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370610",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [embray](#comment%3A6):
> Can you suggest some need for anything besides universal newline handling in text mode?

There is no need currently. But I think it is nice design to allow arbitrary arguments. It is narrow-minded to disallow something just because there is currently no use case.

> > 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

> 
> *only* in text mode.

Of course... what's your point? How would you use `encoding` in binary mode? I don't get what you are trying to say...

> It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write`

I don't really agree with that. If you are providing an API dealing with files, it makes sense to have an API which is close to what `open()` provides. And explicitly passing `**kwds` does exactly that. It makes it explicit that you're just providing a wrapper around `open()` and `TemporaryFile()`.



---

archive/issue_comments_370611.json:
```json
{
    "body": "<a id='comment:8'></a>\n>  If you are providing an API dealing with files, it makes sense to have an API which is close to what open() provides.\n\nNot necessarily.  `atomic_write` is not a generic file opening function.  It has only one purpose which is to write files in a narrow context.  Many of the arguments you might pass `open()` don't make sense.  If it did one might have written it that way in the first place, but you (I think?) didn't and for good reason.\n\nRight now this is only adding the bare minimum necessary to achieve the required goals--not exploding the API footprint.",
    "created_at": "2017-12-04T16:45:14Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370611",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
>  If you are providing an API dealing with files, it makes sense to have an API which is close to what open() provides.

Not necessarily.  `atomic_write` is not a generic file opening function.  It has only one purpose which is to write files in a narrow context.  Many of the arguments you might pass `open()` don't make sense.  If it did one might have written it that way in the first place, but you (I think?) didn't and for good reason.

Right now this is only adding the bare minimum necessary to achieve the required goals--not exploding the API footprint.



---

archive/issue_comments_370612.json:
```json
{
    "body": "<a id='comment:9'></a>\nAlso again, I'll note, that `TemporaryFile` does not accept all the arguments that `open` does in the first place (in particular it does not accept an argument for encoding error handling--which I would consider an upstream defect).",
    "created_at": "2017-12-04T16:46:08Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370612",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Also again, I'll note, that `TemporaryFile` does not accept all the arguments that `open` does in the first place (in particular it does not accept an argument for encoding error handling--which I would consider an upstream defect).



---

archive/issue_comments_370613.json:
```json
{
    "body": "**Changing commit** from \"[bccdf943830707bf200e6ddd6a8a00da54205744](https://github.com/sagemath/sagetrac-mirror/commit/bccdf943830707bf200e6ddd6a8a00da54205744)\" to \"[589e7a2b6012f99542760fac2ddedb034cfbbd13](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)\".",
    "created_at": "2018-01-17T09:38:24Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370613",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[bccdf943830707bf200e6ddd6a8a00da54205744](https://github.com/sagemath/sagetrac-mirror/commit/bccdf943830707bf200e6ddd6a8a00da54205744)" to "[589e7a2b6012f99542760fac2ddedb034cfbbd13](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)".



---

archive/issue_comments_370614.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13\">589e7a2</a></td><td><code>Slight reworking of the arguments to atomic_write:</code></td></tr></table>\n",
    "created_at": "2018-01-17T09:38:24Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370614",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13">589e7a2</a></td><td><code>Slight reworking of the arguments to atomic_write:</code></td></tr></table>




---

archive/issue_comments_370615.json:
```json
{
    "body": "<a id='comment:11'></a>\nPart of the problem here was the use of `tempfile.TemporaryFile`, which is incompatible with Jeroen's request (and in thinking about this I think the stdlib is buggy here--`TemporaryFile` should accept arbitrary kwargs to pass to `io.open`, in fact, it doesn't accept an *errors* argument which is just annoying).\n\nI reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.",
    "created_at": "2018-01-17T09:41:10Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370615",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
Part of the problem here was the use of `tempfile.TemporaryFile`, which is incompatible with Jeroen's request (and in thinking about this I think the stdlib is buggy here--`TemporaryFile` should accept arbitrary kwargs to pass to `io.open`, in fact, it doesn't accept an *errors* argument which is just annoying).

I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.



---

archive/issue_events_215862.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-17T09:41:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215862"
}
```



---

archive/issue_events_215863.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-17T09:41:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215863"
}
```



---

archive/issue_comments_370616.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad\">9a4d548</a></td><td><code>Slight correction to this docstring.</code></td></tr></table>\n",
    "created_at": "2018-01-17T09:43:11Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370616",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad">9a4d548</a></td><td><code>Slight correction to this docstring.</code></td></tr></table>




---

archive/issue_comments_370617.json:
```json
{
    "body": "**Changing commit** from \"[589e7a2b6012f99542760fac2ddedb034cfbbd13](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)\" to \"[9a4d5481aa418e4c8d273c4f919b64491ac892ad](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)\".",
    "created_at": "2018-01-17T09:43:11Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[589e7a2b6012f99542760fac2ddedb034cfbbd13](https://github.com/sagemath/sagetrac-mirror/commit/589e7a2b6012f99542760fac2ddedb034cfbbd13)" to "[9a4d5481aa418e4c8d273c4f919b64491ac892ad](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)".



---

archive/issue_comments_370618.json:
```json
{
    "body": "<a id='comment:13'></a>\nLooks good to me. Jeroen, your opinion ?",
    "created_at": "2018-01-22T16:15:29Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370618",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>
Looks good to me. Jeroen, your opinion ?



---

archive/issue_events_215864.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-22T20:42:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215864"
}
```



---

archive/issue_events_215865.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-22T20:42:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215865"
}
```



---

archive/issue_comments_370619.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [embray](#comment%3A11):\n> I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.\n\nThat's not actually what the patch does... I see `tmp_filename()` which is Sage-specific thing.\n\nAnd it's crucial that the temporary file is created in the same directory as the destination file, otherwise the move is not guaranteed to be atomic. In fact it would be good to add the doctests which shows that the file in indeed created in the right directory.",
    "created_at": "2018-01-22T20:42:35Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370619",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [embray](#comment%3A11):
> I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.

That's not actually what the patch does... I see `tmp_filename()` which is Sage-specific thing.

And it's crucial that the temporary file is created in the same directory as the destination file, otherwise the move is not guaranteed to be atomic. In fact it would be good to add the doctests which shows that the file in indeed created in the right directory.



---

archive/issue_comments_370620.json:
```json
{
    "body": "<a id='comment:15'></a>\nI see what you're saying--originally I did use `mkstemp` directly but then saw `tmp_filename` and thought to use that, neglecting the point about the directory.  I don't think I'll add a test for that though because as long as it's implemented correctly then that's tautological (but it would be helpful if that were documented).",
    "created_at": "2018-01-23T11:20:30Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370620",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
I see what you're saying--originally I did use `mkstemp` directly but then saw `tmp_filename` and thought to use that, neglecting the point about the directory.  I don't think I'll add a test for that though because as long as it's implemented correctly then that's tautological (but it would be helpful if that were documented).



---

archive/issue_comments_370621.json:
```json
{
    "body": "**Changing commit** from \"[9a4d5481aa418e4c8d273c4f919b64491ac892ad](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)\" to \"[c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)\".",
    "created_at": "2018-01-23T11:27:53Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370621",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9a4d5481aa418e4c8d273c4f919b64491ac892ad](https://github.com/sagemath/sagetrac-mirror/commit/9a4d5481aa418e4c8d273c4f919b64491ac892ad)" to "[c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)".



---

archive/issue_comments_370622.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9\">c2bf3b9</a></td><td><code>Actually use mkstemp directly instead of tmp_filename; create the tempfile in the same directory as the target file</code></td></tr></table>\n",
    "created_at": "2018-01-23T11:27:53Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370622",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9">c2bf3b9</a></td><td><code>Actually use mkstemp directly instead of tmp_filename; create the tempfile in the same directory as the target file</code></td></tr></table>




---

archive/issue_events_215866.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T11:28:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215866"
}
```



---

archive/issue_events_215867.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T11:28:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215867"
}
```



---

archive/issue_comments_370623.json:
```json
{
    "body": "<a id='comment:18'></a>\nOK, I am essentially happy with this now. Just a few minor points:\n\n1. in the docs, use <code>\\`\\`**kwargs\\`\\`</code> instead of <code>\\`\\`kwargs\\`\\`</code>.\n\n2. add a test for `**kwargs`\n\n2. add a test for *invalid* `**kwargs`",
    "created_at": "2018-01-23T15:54:24Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370623",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
OK, I am essentially happy with this now. Just a few minor points:

1. in the docs, use <code>\`\`**kwargs\`\`</code> instead of <code>\`\`kwargs\`\`</code>.

2. add a test for `**kwargs`

2. add a test for *invalid* `**kwargs`



---

archive/issue_events_215868.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-24T13:09:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215868"
}
```



---

archive/issue_events_215869.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-24T13:09:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215869"
}
```



---

archive/issue_comments_370624.json:
```json
{
    "body": "<a id='comment:20'></a>\nSounds good--will do.",
    "created_at": "2018-01-26T16:28:00Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370624",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
Sounds good--will do.



---

archive/issue_comments_370625.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242\">5df54d4</a></td><td><code>Address some review comments:</code></td></tr></table>\n",
    "created_at": "2018-01-31T17:29:13Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242">5df54d4</a></td><td><code>Address some review comments:</code></td></tr></table>




---

archive/issue_comments_370626.json:
```json
{
    "body": "**Changing commit** from \"[c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)\" to \"[5df54d44777b6855ed6c127c6eb7b65211bc9242](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)\".",
    "created_at": "2018-01-31T17:29:13Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370626",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9](https://github.com/sagemath/sagetrac-mirror/commit/c2bf3b9585787fa1cbc40982d6fa4dfa9cfa32a9)" to "[5df54d44777b6855ed6c127c6eb7b65211bc9242](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)".



---

archive/issue_events_215870.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-31T17:37:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215870"
}
```



---

archive/issue_events_215871.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-31T17:37:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215871"
}
```



---

archive/issue_comments_370627.json:
```json
{
    "body": "<a id='comment:22'></a>\nI think this should do it.",
    "created_at": "2018-01-31T17:37:32Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370627",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
I think this should do it.



---

archive/issue_comments_370628.json:
```json
{
    "body": "<a id='comment:23'></a>\nthe import of locale seems no longer needed",
    "created_at": "2018-02-04T19:09:35Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370628",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>
the import of locale seems no longer needed



---

archive/issue_comments_370629.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/sage-misc-tempfile)\" to \"[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)\".",
    "created_at": "2018-02-05T09:43:16Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370629",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/embray/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/sage-misc-tempfile)" to "[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)".



---

archive/issue_comments_370630.json:
```json
{
    "body": "**Changing commit** from \"[5df54d44777b6855ed6c127c6eb7b65211bc9242](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)\" to \"[d8170e6038b71ff7e75060cfda5a2558bf1c6523](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)\".",
    "created_at": "2018-02-05T09:43:39Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370630",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5df54d44777b6855ed6c127c6eb7b65211bc9242](https://github.com/sagemath/sagetrac-mirror/commit/5df54d44777b6855ed6c127c6eb7b65211bc9242)" to "[d8170e6038b71ff7e75060cfda5a2558bf1c6523](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)".



---

archive/issue_comments_370631.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523\">d8170e6</a></td><td><code>Don't import locale</code></td></tr></table>\n",
    "created_at": "2018-02-05T09:43:39Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370631",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523">d8170e6</a></td><td><code>Don't import locale</code></td></tr></table>




---

archive/issue_comments_370632.json:
```json
{
    "body": "**Changing commit** from \"[d8170e6038b71ff7e75060cfda5a2558bf1c6523](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)\" to \"[d7d7614c73854be5bf155f789485d4fae90edff4](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)\".",
    "created_at": "2018-02-05T09:47:29Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370632",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[d8170e6038b71ff7e75060cfda5a2558bf1c6523](https://github.com/sagemath/sagetrac-mirror/commit/d8170e6038b71ff7e75060cfda5a2558bf1c6523)" to "[d7d7614c73854be5bf155f789485d4fae90edff4](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)".



---

archive/issue_comments_370633.json:
```json
{
    "body": "<a id='comment:26'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4\">d7d7614</a></td><td><code>Catch all exceptions from io.open()</code></td></tr></table>\n",
    "created_at": "2018-02-05T09:47:29Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370633",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4">d7d7614</a></td><td><code>Catch all exceptions from io.open()</code></td></tr></table>




---

archive/issue_comments_370634.json:
```json
{
    "body": "<a id='comment:27'></a>\nI added 2 tiny fixes. If you agree, you (Erik or Fr\u00e9d\u00e9ric) can set it to positive_review.",
    "created_at": "2018-02-05T09:48:31Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370634",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>
I added 2 tiny fixes. If you agree, you (Erik or Frédéric) can set it to positive_review.



---

archive/issue_comments_370635.json:
```json
{
    "body": "**Reviewer:** Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer",
    "created_at": "2018-02-05T09:48:31Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370635",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Frédéric Chapoton, Jeroen Demeyer



---

archive/issue_events_215872.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-05T13:02:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215872"
}
```



---

archive/issue_events_215873.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-05T13:02:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215873"
}
```



---

archive/issue_comments_370636.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)\" to \"[d7d7614c73854be5bf155f789485d4fae90edff4](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)\".",
    "created_at": "2018-02-09T08:03:59Z",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24313#issuecomment-370636",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/python3/sage-misc-tempfile](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/sage-misc-tempfile)" to "[d7d7614c73854be5bf155f789485d4fae90edff4](https://github.com/sagemath/sagetrac-mirror/commit/d7d7614c73854be5bf155f789485d4fae90edff4)".



---

archive/issue_events_215874.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-09T08:03:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215874"
}
```



---

archive/issue_events_215875.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "38e8a65eec4c6cb182db49a4cd37da7ade52350e",
    "created_at": "2018-02-09T08:03:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24313",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24313#event-215875"
}
```
