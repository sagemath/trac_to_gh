# Issue 24772: Encoding fixes to the doctest module

archive/issues_024535.json:
```json
{
    "body": "\n\nCC:  @embray\n\nBranch/Commit: bf6cf97ada80f3d70a07cd416a53acd2453b6d88\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nDependencies: #24771\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24772\n\n",
    "closed_at": "2018-02-26T23:58:14Z",
    "created_at": "2018-02-19T10:00:17Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Encoding fixes to the doctest module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24772",
    "user": "https://github.com/jdemeyer"
}
```


CC:  @embray

Branch/Commit: bf6cf97ada80f3d70a07cd416a53acd2453b6d88

Reviewer: Jeroen Demeyer

Author: Erik Bray

Dependencies: #24771

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24772





---

archive/issue_comments_470653.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/24772\"",
    "created_at": "2018-02-19T10:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470653",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/24772"



---

archive/issue_comments_470654.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470654",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470655.json:
```json
{
    "body": "Changing commit from \"\" to \"dcff893007aff8e5bde44025801eb358acdefdad\"",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470655",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "dcff893007aff8e5bde44025801eb358acdefdad"



---

archive/issue_comments_470656.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470656",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_470657.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-19T10:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470657",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470658.json:
```json
{
    "body": "<a id='comment:3'></a>About\n\n```diff\n+            if not isinstance(got, six.text_type):\n+                # On Python 3 got should already be unicode text, but on Python\n+                # 2 it is not.  For comparison's sake we want the unicode text\n+                # decoded from UTF-8. If there was some error such that the\n+                # output is so malformed that it does not even decode from\n+                # UTF-8 at all there will be an error in the test framework\n+                # here. But this shouldn't happen at all, so we want it to be\n+                # understood as an error in the test framework, and no some\n+                # subtle error in the code under test.\n+                got = got.decode(locale.getpreferredencoding())\n```\nIn the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?\n\nAlso a typo: \"no some\" -> \"not some\"",
    "created_at": "2018-02-19T10:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470658",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>About

```diff
+            if not isinstance(got, six.text_type):
+                # On Python 3 got should already be unicode text, but on Python
+                # 2 it is not.  For comparison's sake we want the unicode text
+                # decoded from UTF-8. If there was some error such that the
+                # output is so malformed that it does not even decode from
+                # UTF-8 at all there will be an error in the test framework
+                # here. But this shouldn't happen at all, so we want it to be
+                # understood as an error in the test framework, and no some
+                # subtle error in the code under test.
+                got = got.decode(locale.getpreferredencoding())
```
In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?

Also a typo: "no some" -> "not some"



---

archive/issue_comments_470659.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-19T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470659",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_470660.json:
```json
{
    "body": "Changing commit from \"dcff893007aff8e5bde44025801eb358acdefdad\" to \"34876abb4119f6b5382797d065be23b830fd7762\"",
    "created_at": "2018-02-19T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "dcff893007aff8e5bde44025801eb358acdefdad" to "34876abb4119f6b5382797d065be23b830fd7762"



---

archive/issue_comments_470661.json:
```json
{
    "body": "<a id='comment:5'></a>I fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.",
    "created_at": "2018-02-19T13:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470661",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>I fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.



---

archive/issue_comments_470662.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [jdemeyer](#comment%3A3):\n> About\n> \n> ```\n> #!diff\n> +            if not isinstance(got, six.text_type):\n> +                # On Python 3 got should already be unicode text, but on Python\n> +                # 2 it is not.  For comparison's sake we want the unicode text\n> +                # decoded from UTF-8. If there was some error such that the\n> +                # output is so malformed that it does not even decode from\n> +                # UTF-8 at all there will be an error in the test framework\n> +                # here. But this shouldn't happen at all, so we want it to be\n> +                # understood as an error in the test framework, and no some\n> +                # subtle error in the code under test.\n> +                got = got.decode(locale.getpreferredencoding())\n> ```\n> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?\n\n\nI think the use of \"UTF-8\" in the comment is an artifact--I'm using it as a placeholder for \"whatever the correct encoding is\".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.",
    "created_at": "2018-02-19T13:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470662",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Replying to [jdemeyer](#comment%3A3):
> About
> 
> ```
> #!diff
> +            if not isinstance(got, six.text_type):
> +                # On Python 3 got should already be unicode text, but on Python
> +                # 2 it is not.  For comparison's sake we want the unicode text
> +                # decoded from UTF-8. If there was some error such that the
> +                # output is so malformed that it does not even decode from
> +                # UTF-8 at all there will be an error in the test framework
> +                # here. But this shouldn't happen at all, so we want it to be
> +                # understood as an error in the test framework, and no some
> +                # subtle error in the code under test.
> +                got = got.decode(locale.getpreferredencoding())
> ```
> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?


I think the use of "UTF-8" in the comment is an artifact--I'm using it as a placeholder for "whatever the correct encoding is".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.



---

archive/issue_comments_470663.json:
```json
{
    "body": "<a id='comment:7'></a>It seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.",
    "created_at": "2018-02-23T14:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470663",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>It seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.



---

archive/issue_comments_470664.json:
```json
{
    "body": "Changing commit from \"34876abb4119f6b5382797d065be23b830fd7762\" to \"bf6cf97ada80f3d70a07cd416a53acd2453b6d88\"",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470664",
    "user": "https://github.com/embray"
}
```

Changing commit from "34876abb4119f6b5382797d065be23b830fd7762" to "bf6cf97ada80f3d70a07cd416a53acd2453b6d88"



---

archive/issue_comments_470665.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/24772\" to \"u/embray/python3/ticket-24772\"",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470665",
    "user": "https://github.com/embray"
}
```

Changing branch from "u/jdemeyer/ticket/24772" to "u/embray/python3/ticket-24772"



---

archive/issue_comments_470666.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470666",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_470667.json:
```json
{
    "body": "<a id='comment:8'></a>I just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.\n\nSetting \"positive review\" assuming you agree.\n\n---\nNew commits:",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470667",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>I just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.

Setting "positive review" assuming you agree.

---
New commits:



---

archive/issue_comments_470668.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [embray](#comment%3A8):\n> Setting \"positive review\" assuming you agree.\n\n\nThat was my only complaint, so yes I agree.",
    "created_at": "2018-02-23T15:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470668",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [embray](#comment%3A8):
> Setting "positive review" assuming you agree.


That was my only complaint, so yes I agree.



---

archive/issue_comments_470669.json:
```json
{
    "body": "<a id='comment:10'></a>Reviewer name...",
    "created_at": "2018-02-25T00:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470669",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>Reviewer name...



---

archive/issue_comments_470670.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-02-25T00:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470670",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_470671.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2018-02-25T11:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470671",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_470672.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-25T11:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470672",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_470673.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-26T23:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470673",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_470674.json:
```json
{
    "body": "Changing branch from \"u/embray/python3/ticket-24772\" to \"bf6cf97ada80f3d70a07cd416a53acd2453b6d88\"",
    "created_at": "2018-02-26T23:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-470674",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/python3/ticket-24772" to "bf6cf97ada80f3d70a07cd416a53acd2453b6d88"



---

archive/issue_events_062296.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-26T23:58:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24772#event-62296"
}
```
