# Issue 24772: Encoding fixes to the doctest module

archive/issues_024535.json:
```json
{
    "body": "\n\n**CC:**  @embray\n\n**Branch/Commit:** [bf6cf97ada80f3d70a07cd416a53acd2453b6d88](https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88)\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Erik Bray\n\n**Dependencies:** #24771\n\nIssue created by migration from https://trac.sagemath.org/ticket/24772\n\n",
    "closed_at": "2018-02-26T23:58:14Z",
    "created_at": "2018-02-19T10:00:17Z",
    "labels": [
        "component: doctest framework",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Encoding fixes to the doctest module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24772",
    "user": "https://github.com/jdemeyer"
}
```


**CC:**  @embray

**Branch/Commit:** [bf6cf97ada80f3d70a07cd416a53acd2453b6d88](https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88)

**Reviewer:** Jeroen Demeyer

**Author:** Erik Bray

**Dependencies:** #24771

Issue created by migration from https://trac.sagemath.org/ticket/24772





---

archive/issue_comments_449755.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/ticket/24772](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/24772)",
    "created_at": "2018-02-19T10:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449755",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/ticket/24772](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/24772)



---

archive/issue_comments_449756.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449756",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_449757.json:
```json
{
    "body": "**Commit:** [dcff893007aff8e5bde44025801eb358acdefdad](https://github.com/sagemath/sagetrac-mirror/commit/dcff893007aff8e5bde44025801eb358acdefdad)",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449757",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [dcff893007aff8e5bde44025801eb358acdefdad](https://github.com/sagemath/sagetrac-mirror/commit/dcff893007aff8e5bde44025801eb358acdefdad)



---

archive/issue_comments_449758.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3eb2db6efc3409265b2b887fe3befb5fa2cc1b29\">3eb2db6</a></td><td><code>Miscellaneous fixes to tests in the doctest module.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/51e20d952d2f294662f47f1a6e52c62ea8617d6b\">51e20d9</a></td><td><code>A few other miscellaneous fixes to the doctests tests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/878a62b4a9d266ecccab6e6b0cdd1c6044e2ef1d\">878a62b</a></td><td><code>This exception reads 'utf-8' on Python 3 and 'utf8' on Python 2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1ba0e67b8d92a19607541cf6dfee887980f3a145\">1ba0e67</a></td><td><code>Fix various minor encoding issues</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dcff893007aff8e5bde44025801eb358acdefdad\">dcff893</a></td><td><code>Correct some encoding issues on Python 2.</code></td></tr></table>\n",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449758",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3eb2db6efc3409265b2b887fe3befb5fa2cc1b29">3eb2db6</a></td><td><code>Miscellaneous fixes to tests in the doctest module.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/51e20d952d2f294662f47f1a6e52c62ea8617d6b">51e20d9</a></td><td><code>A few other miscellaneous fixes to the doctests tests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/878a62b4a9d266ecccab6e6b0cdd1c6044e2ef1d">878a62b</a></td><td><code>This exception reads 'utf-8' on Python 3 and 'utf8' on Python 2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1ba0e67b8d92a19607541cf6dfee887980f3a145">1ba0e67</a></td><td><code>Fix various minor encoding issues</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dcff893007aff8e5bde44025801eb358acdefdad">dcff893</a></td><td><code>Correct some encoding issues on Python 2.</code></td></tr></table>




---

archive/issue_comments_449759.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2018-02-19T10:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449759",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_449760.json:
```json
{
    "body": "<a id='comment:3'></a>\nAbout\n\n```diff\n+            if not isinstance(got, six.text_type):\n+                # On Python 3 got should already be unicode text, but on Python\n+                # 2 it is not.  For comparison's sake we want the unicode text\n+                # decoded from UTF-8. If there was some error such that the\n+                # output is so malformed that it does not even decode from\n+                # UTF-8 at all there will be an error in the test framework\n+                # here. But this shouldn't happen at all, so we want it to be\n+                # understood as an error in the test framework, and no some\n+                # subtle error in the code under test.\n+                got = got.decode(locale.getpreferredencoding())\n```\nIn the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?\n\nAlso a typo: \"no some\" -> \"not some\"",
    "created_at": "2018-02-19T10:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449760",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
About

```diff
+            if not isinstance(got, six.text_type):
+                # On Python 3 got should already be unicode text, but on Python
+                # 2 it is not.  For comparison's sake we want the unicode text
+                # decoded from UTF-8. If there was some error such that the
+                # output is so malformed that it does not even decode from
+                # UTF-8 at all there will be an error in the test framework
+                # here. But this shouldn't happen at all, so we want it to be
+                # understood as an error in the test framework, and no some
+                # subtle error in the code under test.
+                got = got.decode(locale.getpreferredencoding())
```
In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?

Also a typo: "no some" -> "not some"



---

archive/issue_comments_449761.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/12ff3be331475a61fa4925b5e89898409c7f732d\">12ff3be</a></td><td><code>Fix various minor encoding issues</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/34876abb4119f6b5382797d065be23b830fd7762\">34876ab</a></td><td><code>Correct some encoding issues on Python 2.</code></td></tr></table>\n",
    "created_at": "2018-02-19T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/12ff3be331475a61fa4925b5e89898409c7f732d">12ff3be</a></td><td><code>Fix various minor encoding issues</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/34876abb4119f6b5382797d065be23b830fd7762">34876ab</a></td><td><code>Correct some encoding issues on Python 2.</code></td></tr></table>




---

archive/issue_comments_449762.json:
```json
{
    "body": "**Changing commit** from \"[dcff893007aff8e5bde44025801eb358acdefdad](https://github.com/sagemath/sagetrac-mirror/commit/dcff893007aff8e5bde44025801eb358acdefdad)\" to \"[34876abb4119f6b5382797d065be23b830fd7762](https://github.com/sagemath/sagetrac-mirror/commit/34876abb4119f6b5382797d065be23b830fd7762)\".",
    "created_at": "2018-02-19T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449762",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[dcff893007aff8e5bde44025801eb358acdefdad](https://github.com/sagemath/sagetrac-mirror/commit/dcff893007aff8e5bde44025801eb358acdefdad)" to "[34876abb4119f6b5382797d065be23b830fd7762](https://github.com/sagemath/sagetrac-mirror/commit/34876abb4119f6b5382797d065be23b830fd7762)".



---

archive/issue_comments_449763.json:
```json
{
    "body": "<a id='comment:5'></a>\nI fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.",
    "created_at": "2018-02-19T13:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449763",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
I fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.



---

archive/issue_comments_449764.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A3):\n> About\n> \n> ```diff\n> +            if not isinstance(got, six.text_type):\n> +                # On Python 3 got should already be unicode text, but on Python\n> +                # 2 it is not.  For comparison's sake we want the unicode text\n> +                # decoded from UTF-8. If there was some error such that the\n> +                # output is so malformed that it does not even decode from\n> +                # UTF-8 at all there will be an error in the test framework\n> +                # here. But this shouldn't happen at all, so we want it to be\n> +                # understood as an error in the test framework, and no some\n> +                # subtle error in the code under test.\n> +                got = got.decode(locale.getpreferredencoding())\n> ```\n> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?\n\n\nI think the use of \"UTF-8\" in the comment is an artifact--I'm using it as a placeholder for \"whatever the correct encoding is\".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.",
    "created_at": "2018-02-19T13:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449764",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A3):
> About
> 
> ```diff
> +            if not isinstance(got, six.text_type):
> +                # On Python 3 got should already be unicode text, but on Python
> +                # 2 it is not.  For comparison's sake we want the unicode text
> +                # decoded from UTF-8. If there was some error such that the
> +                # output is so malformed that it does not even decode from
> +                # UTF-8 at all there will be an error in the test framework
> +                # here. But this shouldn't happen at all, so we want it to be
> +                # understood as an error in the test framework, and no some
> +                # subtle error in the code under test.
> +                got = got.decode(locale.getpreferredencoding())
> ```
> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?


I think the use of "UTF-8" in the comment is an artifact--I'm using it as a placeholder for "whatever the correct encoding is".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.



---

archive/issue_comments_449765.json:
```json
{
    "body": "<a id='comment:7'></a>\nIt seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.",
    "created_at": "2018-02-23T14:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449765",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
It seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.



---

archive/issue_comments_449766.json:
```json
{
    "body": "**Changing commit** from \"[34876abb4119f6b5382797d065be23b830fd7762](https://github.com/sagemath/sagetrac-mirror/commit/34876abb4119f6b5382797d065be23b830fd7762)\" to \"[bf6cf97ada80f3d70a07cd416a53acd2453b6d88](https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88)\".",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449766",
    "user": "https://github.com/embray"
}
```

**Changing commit** from "[34876abb4119f6b5382797d065be23b830fd7762](https://github.com/sagemath/sagetrac-mirror/commit/34876abb4119f6b5382797d065be23b830fd7762)" to "[bf6cf97ada80f3d70a07cd416a53acd2453b6d88](https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88)".



---

archive/issue_comments_449767.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/ticket/24772](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/24772)\" to \"[u/embray/python3/ticket-24772](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/ticket-24772)\".",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449767",
    "user": "https://github.com/embray"
}
```

**Changing branch** from "[u/jdemeyer/ticket/24772](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/24772)" to "[u/embray/python3/ticket-24772](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/ticket-24772)".



---

archive/issue_comments_449768.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449768",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to positive_review.



---

archive/issue_comments_449769.json:
```json
{
    "body": "<a id='comment:8'></a>\nI just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.\n\nSetting \"positive review\" assuming you agree.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88\">bf6cf97</a></td><td><code>Correct some encoding issues on Python 2.</code></td></tr></table>\n",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449769",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
I just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.

Setting "positive review" assuming you agree.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88">bf6cf97</a></td><td><code>Correct some encoding issues on Python 2.</code></td></tr></table>




---

archive/issue_comments_449770.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [embray](#comment%3A8):\n> Setting \"positive review\" assuming you agree.\n\n\nThat was my only complaint, so yes I agree.",
    "created_at": "2018-02-23T15:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449770",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [embray](#comment%3A8):
> Setting "positive review" assuming you agree.


That was my only complaint, so yes I agree.



---

archive/issue_comments_449771.json:
```json
{
    "body": "<a id='comment:10'></a>\nReviewer name...",
    "created_at": "2018-02-25T00:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449771",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
Reviewer name...



---

archive/issue_comments_449772.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2018-02-25T00:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449772",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_449773.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2018-02-25T11:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449773",
    "user": "https://github.com/fchapoton"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_449774.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2018-02-25T11:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449774",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from needs_work to positive_review.



---

archive/issue_comments_449775.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/python3/ticket-24772](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/ticket-24772)\" to \"[bf6cf97ada80f3d70a07cd416a53acd2453b6d88](https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88)\".",
    "created_at": "2018-02-26T23:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-449775",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/embray/python3/ticket-24772](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/ticket-24772)" to "[bf6cf97ada80f3d70a07cd416a53acd2453b6d88](https://github.com/sagemath/sagetrac-mirror/commit/bf6cf97ada80f3d70a07cd416a53acd2453b6d88)".



---

archive/issue_events_071154.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-26T23:58:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24772#event-71154"
}
```
