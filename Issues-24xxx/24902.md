# Issue 24902: optional package deformation fails to build

archive/issues_024665.json:
```json
{
    "body": "On archlinux\n\n```\n/usr/bin/ld: -r and -pie may not be used together\n```\n\nSee the more complete log [attachment:deformation-d05941b.log].\n\nUpstream report: https://github.com/jpflori/pydeformation/issues/5\n\nA patch is provided in #24575.\n\n**CC:**  jpflori\n\n**Resolution:** wontfix\n\nIssue created by migration from https://trac.sagemath.org/ticket/24902\n\n",
    "closed_at": "2018-05-18T17:16:26Z",
    "created_at": "2018-03-05T16:47:42Z",
    "labels": [
        "component: packages: optional",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "optional package deformation fails to build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24902",
    "user": "https://github.com/videlec"
}
```
On archlinux

```
/usr/bin/ld: -r and -pie may not be used together
```

See the more complete log [attachment:deformation-d05941b.log].

Upstream report: https://github.com/jpflori/pydeformation/issues/5

A patch is provided in #24575.

**CC:**  jpflori

**Resolution:** wontfix

Issue created by migration from https://trac.sagemath.org/ticket/24902





---

archive/issue_comments_475358.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,4 +4,4 @@\n /usr/bin/ld: -r and -pie may not be used together\n ```\n \n-See the more complete log at XXX\n+See the more complete log [attachment:deformation-d05941b.log].\n``````\n",
    "created_at": "2018-03-05T16:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475358",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,4 +4,4 @@
 /usr/bin/ld: -r and -pie may not be used together
 ```
 
-See the more complete log at XXX
+See the more complete log [attachment:deformation-d05941b.log].
``````




---

archive/issue_comments_475359.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [deformation-d05941b.log](tarball://root/attachments/some-uuid/ticket24902/deformation-d05941b.log) by @videlec created at 2018-03-05 16:48:38",
    "created_at": "2018-03-05T16:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475359",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>
Attachment [deformation-d05941b.log](tarball://root/attachments/some-uuid/ticket24902/deformation-d05941b.log) by @videlec created at 2018-03-05 16:48:38



---

archive/issue_comments_475360.json:
```json
{
    "body": "<a id='comment:2'></a>\nFlint had that issue some time ago. This is caused by the hardening of the toolchain. Look at what has been done for flint here\n[https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch](https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch). Basically you give `-r` directly to the compiler but don't pass it directly to the linker as you would with `-Wl,-r`.",
    "created_at": "2018-03-05T20:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475360",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>
Flint had that issue some time ago. This is caused by the hardening of the toolchain. Look at what has been done for flint here
[https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch](https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch). Basically you give `-r` directly to the compiler but don't pass it directly to the linker as you would with `-Wl,-r`.



---

archive/issue_comments_475361.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe culprit is this line\n\n```\nMakefile.subdirs:       $(QUIET_CC) $(CC) $(ABI_FLAG) -Wl,-r $^ -o $@ -nostdlib\n```\nChange `-Wl,-r` to plain `-r` should get you in business. Can someone also please update `SPKG.txt` with upstream location? Where did you get that tarball from? Has it been processed before being put on the mirror?",
    "created_at": "2018-03-06T01:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475361",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>
The culprit is this line

```
Makefile.subdirs:       $(QUIET_CC) $(CC) $(ABI_FLAG) -Wl,-r $^ -o $@ -nostdlib
```
Change `-Wl,-r` to plain `-r` should get you in business. Can someone also please update `SPKG.txt` with upstream location? Where did you get that tarball from? Has it been processed before being put on the mirror?



---

archive/issue_comments_475362.json:
```json
{
    "body": "<a id='comment:5'></a>\nA patch is provided in #24575, should I move it here?",
    "created_at": "2018-03-08T10:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475362",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>
A patch is provided in #24575, should I move it here?



---

archive/issue_comments_475363.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [vdelecroix](#comment%3A5):\n> A patch is provided in #24575, should I move it here?",
    "created_at": "2018-03-08T10:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475363",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>
Replying to [vdelecroix](#comment%3A5):
> A patch is provided in #24575, should I move it here?



---

archive/issue_comments_475364.json:
```json
{
    "body": "<a id='comment:7'></a>\nNo need we can just mark this ticket as a \"duplicate\" of #24575.",
    "created_at": "2018-03-08T10:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475364",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>
No need we can just mark this ticket as a "duplicate" of #24575.



---

archive/issue_events_071105.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-08T10:47:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24902#event-71105"
}
```



---

archive/issue_comments_475365.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,3 +5,5 @@\n ```\n \n See the more complete log [attachment:deformation-d05941b.log].\n+\n+A patch is provided in #24575.\n``````\n",
    "created_at": "2018-03-08T10:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475365",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,3 +5,5 @@
 ```
 
 See the more complete log [attachment:deformation-d05941b.log].
+
+A patch is provided in #24575.
``````




---

archive/issue_comments_475366.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-03-08T10:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475366",
    "user": "https://github.com/videlec"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_475367.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,4 +6,6 @@\n \n See the more complete log [attachment:deformation-d05941b.log].\n \n+Upstream report: https://github.com/jpflori/pydeformation/issues/5\n+\n A patch is provided in #24575.\n``````\n",
    "created_at": "2018-03-08T10:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475367",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,4 +6,6 @@
 
 See the more complete log [attachment:deformation-d05941b.log].
 
+Upstream report: https://github.com/jpflori/pydeformation/issues/5
+
 A patch is provided in #24575.
``````




---

archive/issue_comments_475368.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-03-11T17:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475368",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_475369.json:
```json
{
    "body": "**Resolution:** wontfix",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475369",
    "user": "https://github.com/videlec"
}
```

**Resolution:** wontfix



---

archive/issue_comments_475370.json:
```json
{
    "body": "<a id='comment:12'></a>\nclosing positively reviewed duplicates",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24902#issuecomment-475370",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>
closing positively reviewed duplicates



---

archive/issue_events_071106.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24902",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24902#event-71106"
}
```
