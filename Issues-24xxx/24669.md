# Issue 24669: Re-enable threads on OpenBLAS

archive/issues_024432.json:
```json
{
    "body": "It was disabled in #22021 to work around some deadlocks that were occurring, and still further problems were reported in #23933.\n\nBut these issues appear to be fixed as of OpenBLAS 0.2.20 which Sage is now on.  It would be good if more people can test this though (especially on OSX).\n\nThis also includes a patch for Cygwin without which this change renders openblas broken on Cygwin.  This will resolve issues like #22822 (of course, it doesn't actually fix the Cygwin openblas package if it gets used by mistake, but that will be fixed too if upstream accepts my patch).\n\nAssignee: @embray\n\nKeywords: openblas cygwin\n\nReviewer: Volker Braun, Julian R\u00fcth\n\nAuthor: Erik Bray\n\nBranch: 2b52932cd8979cb0e06bd3fc91184cb8bc06ac25\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24669\n\n",
    "closed_at": "2018-08-09T21:28:00Z",
    "created_at": "2018-02-06T11:07:40Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Re-enable threads on OpenBLAS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24669",
    "user": "https://github.com/embray"
}
```
It was disabled in #22021 to work around some deadlocks that were occurring, and still further problems were reported in #23933.

But these issues appear to be fixed as of OpenBLAS 0.2.20 which Sage is now on.  It would be good if more people can test this though (especially on OSX).

This also includes a patch for Cygwin without which this change renders openblas broken on Cygwin.  This will resolve issues like #22822 (of course, it doesn't actually fix the Cygwin openblas package if it gets used by mistake, but that will be fixed too if upstream accepts my patch).

Assignee: @embray

Keywords: openblas cygwin

Reviewer: Volker Braun, Julian RÃ¼th

Author: Erik Bray

Branch: 2b52932cd8979cb0e06bd3fc91184cb8bc06ac25

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24669





---

archive/issue_comments_342289.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-06T16:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342289",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342290.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2018-02-06T16:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342290",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_342291.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-06T16:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342291",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_342292.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-06T20:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342292",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342293.json:
```json
{
    "body": "<a id='comment:4'></a>Thanks--this fix will be nice to have.",
    "created_at": "2018-04-09T09:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342293",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Thanks--this fix will be nice to have.



---

archive/issue_events_062102.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24669#event-62102"
}
```



---

archive/issue_comments_342294.json:
```json
{
    "body": "<a id='comment:6'></a>Breaks the testsuite\n\n```\n$ SAGE_CHECK=yes sage -p openblas\n[...]\ngfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o cblat1 cblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran \ngfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o zblat1 zblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran \n../libopenblas_haswell-r0.2.20.a: file not recognized: File truncated\ncollect2: error: ld returned 1 exit status\nmake[1]: *** [Makefile:138: cblat1] Error 1\n```",
    "created_at": "2018-05-10T14:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342294",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>Breaks the testsuite

```
$ SAGE_CHECK=yes sage -p openblas
[...]
gfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o cblat1 cblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran 
gfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o zblat1 zblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran 
../libopenblas_haswell-r0.2.20.a: file not recognized: File truncated
collect2: error: ld returned 1 exit status
make[1]: *** [Makefile:138: cblat1] Error 1
```



---

archive/issue_comments_342295.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-10T14:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342295",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_342296.json:
```json
{
    "body": "<a id='comment:7'></a>I'm not convinced yet that that has anything to do with this patch (especially considering it was [accepted upstream](https://github.com/xianyi/OpenBLAS/pull/1450).",
    "created_at": "2018-05-11T14:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342296",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I'm not convinced yet that that has anything to do with this patch (especially considering it was [accepted upstream](https://github.com/xianyi/OpenBLAS/pull/1450).



---

archive/issue_comments_342297.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-11T15:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_342298.json:
```json
{
    "body": "<a id='comment:9'></a>Well, I was able to reproduce it so I guess I'm convinced now :) But I don't see any obvious mechanism by which this would cause such an issue...",
    "created_at": "2018-05-11T15:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342298",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Well, I was able to reproduce it so I guess I'm convinced now :) But I don't see any obvious mechanism by which this would cause such an issue...



---

archive/issue_comments_342299.json:
```json
{
    "body": "<a id='comment:10'></a>I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342299",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_events_062103.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:47:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24669#event-62103"
}
```



---

archive/issue_events_062104.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:47:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24669#event-62104"
}
```



---

archive/issue_comments_342300.json:
```json
{
    "body": "<a id='comment:11'></a>For what it's worth, threads are not disabled in nix's openblas and all our tests (sage and other packages) pass.",
    "created_at": "2018-08-04T12:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342300",
    "user": "https://github.com/timokau"
}
```

<a id='comment:11'></a>For what it's worth, threads are not disabled in nix's openblas and all our tests (sage and other packages) pass.



---

archive/issue_comments_342301.json:
```json
{
    "body": "<a id='comment:12'></a>Yeah, I'm not sure why this is causing problems when running the test suite.  I suspect it's also an upstream issue though, or an oddity in how we run the tests; there should be no problem normally for enabling threads...\n\nI just haven't bothered to look into this yet, but this really should be fixed.",
    "created_at": "2018-08-06T14:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342301",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Yeah, I'm not sure why this is causing problems when running the test suite.  I suspect it's also an upstream issue though, or an oddity in how we run the tests; there should be no problem normally for enabling threads...

I just haven't bothered to look into this yet, but this really should be fixed.



---

archive/issue_comments_342302.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2018-08-06T14:47:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342302",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_342303.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-06T15:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342303",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_342304.json:
```json
{
    "body": "<a id='comment:15'></a>Rebased on 8.4.beta0; not that there was a merge conflict or anything (it's a very simple change), but just because the original commit was pretty old...",
    "created_at": "2018-08-06T15:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342304",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Rebased on 8.4.beta0; not that there was a merge conflict or anything (it's a very simple change), but just because the original commit was pretty old...



---

archive/issue_comments_342305.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-06T16:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342305",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342306.json:
```json
{
    "body": "<a id='comment:17'></a>Turns out the answer was quite simple:  We also just had to remove `USE_THREAD=0` from the `spkg-check` script :|",
    "created_at": "2018-08-06T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342306",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>Turns out the answer was quite simple:  We also just had to remove `USE_THREAD=0` from the `spkg-check` script :|



---

archive/issue_comments_342307.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-06T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342307",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_342308.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-07T17:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342308",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_062105.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-09T21:28:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24669#event-62105"
}
```



---

archive/issue_comments_342309.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-09T21:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342309",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_342310.json:
```json
{
    "body": "<a id='comment:20'></a>I believe that this broke `sage -tp` on some machines, see #26118.",
    "created_at": "2018-08-24T14:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24669#issuecomment-342310",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:20'></a>I believe that this broke `sage -tp` on some machines, see #26118.
