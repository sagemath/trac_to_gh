# Issue 24517: random failure in sage/geometry/cone.py

archive/issues_024280.json:
```json
{
    "assignees": [],
    "body": "Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n\n```\n        sage: K = random_cone(min_ambient_dim=3, # long time\n        ....:                 max_ambient_dim=3, # long time\n        ....:                 min_rays=7)        # long time\n```\n\nSometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n\nThe code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.\n\nPatchbot reports:\n\n- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n\n- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)\n\nCC:  @orlitzky\n\nBranch/Commit: **[2683d07](https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton**\n\nAuthor: **Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24517_\n\n",
    "closed_at": "2018-02-01T19:13:37Z",
    "created_at": "2018-01-11T16:06:45Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "random failure in sage/geometry/cone.py",
    "type": "issue",
    "updated_at": "2018-02-01T19:13:37Z",
    "url": "https://github.com/sagemath/sage/issues/24517",
    "user": "https://github.com/videlec"
}
```
Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.

```
        sage: K = random_cone(min_ambient_dim=3, # long time
        ....:                 max_ambient_dim=3, # long time
        ....:                 min_rays=7)        # long time
```

Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.

The code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.

Patchbot reports:

- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)

- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)

CC:  @orlitzky

Branch/Commit: **[2683d07](https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711)**

Reviewer: **Frédéric Chapoton**

Author: **Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/24517_





---

archive/issue_events_321564.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-01-11T16:06:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321564"
}
```



---

archive/issue_events_321565.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-01-11T16:06:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "component: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321565"
}
```



---

archive/issue_events_321566.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-01-11T16:06:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321566"
}
```



---

archive/issue_events_321567.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-01-11T16:06:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321567"
}
```



---

archive/issue_comments_373875.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nThis traceback line\n\n```\n#8  __pyx_f_4sage_3ext_6memory_alloc_error (__pyx_v_size=__pyx_v_size@entry=8) at build/cythonized/sage/ext/memory.c:1169\n```\nshows that it is happening because of lack of memory. So either this particular patchbot is low on memory or this doctest does something which requires lots of memory.\n\nNow this out-of-memory situation is not gracefully handled. I could change the code to `raise MemoryError` instead of crashing, but that won't solve the underlying issue that it is running out of memory.",
    "created_at": "2018-01-11T16:26:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373875",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">Comment 1</div>

This traceback line

```
#8  __pyx_f_4sage_3ext_6memory_alloc_error (__pyx_v_size=__pyx_v_size@entry=8) at build/cythonized/sage/ext/memory.c:1169
```
shows that it is happening because of lack of memory. So either this particular patchbot is low on memory or this doctest does something which requires lots of memory.

Now this out-of-memory situation is not gracefully handled. I could change the code to `raise MemoryError` instead of crashing, but that won't solve the underlying issue that it is running out of memory.



---

archive/issue_comments_373876.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nquasar is 8G memory (though tests are run in parallel). For me these are two problems:\n- the crash when doctesting\n- the fact that the `random_cone` method is not careful with the size of the generated cone\n\nWhich one do you want to deal with on this ticket?",
    "created_at": "2018-01-11T16:30:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373876",
    "user": "https://github.com/videlec"
}
```

<div id="comment:2" align="right">Comment 2</div>

quasar is 8G memory (though tests are run in parallel). For me these are two problems:
- the crash when doctesting
- the fact that the `random_cone` method is not careful with the size of the generated cone

Which one do you want to deal with on this ticket?



---

archive/issue_comments_373877.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nReplying to [@videlec](#comment%3A2):\n> quasar is 8G memory (though tests are run in parallel). For me these are two problems:\n> - the crash when doctesting\n> - the fact that the `random_cone` method is not careful with the size of the generated cone\n> \n> Which one do you want to deal with on this ticket?\n\nThe last one.",
    "created_at": "2018-01-11T16:32:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373877",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">Comment 3</div>

Replying to [@videlec](#comment%3A2):
> quasar is 8G memory (though tests are run in parallel). For me these are two problems:
> - the crash when doctesting
> - the fact that the `random_cone` method is not careful with the size of the generated cone
> 
> Which one do you want to deal with on this ticket?

The last one.



---

archive/issue_comments_373878.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nI would argue not to the fix the first issue. It happened in `Rational.__new__()`. If there is not enough space for that, then surely stuff will break anyway sooner or later. Second, adding error checking would mean adding `sig_on()` and `sig_off()` which causes some loss of performance every time that a new `Rational` is created.",
    "created_at": "2018-01-11T16:36:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373878",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">Comment 4</div>

I would argue not to the fix the first issue. It happened in `Rational.__new__()`. If there is not enough space for that, then surely stuff will break anyway sooner or later. Second, adding error checking would mean adding `sig_on()` and `sig_off()` which causes some loss of performance every time that a new `Rational` is created.



---

archive/issue_events_321568.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-16T22:57:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "component: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321568"
}
```



---

archive/issue_events_321569.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-16T22:57:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321569"
}
```



---

archive/issue_events_321570.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-16T22:57:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321570"
}
```



---

archive/issue_events_321571.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-16T22:57:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321571"
}
```



---

archive/issue_comments_373879.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,9 @@\n-Sometimes, patchbot reports a `sig_error() without sig_on()` when tests are run on `sage/geometry/cone.py`.\n+Sometimes, patchbot report error with the `random_cone` test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n \n-See:\n+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n+\n+Patchbot reports:\n+\n+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n \n - [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)\n``````\n",
    "created_at": "2018-01-16T22:57:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373879",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,9 @@
-Sometimes, patchbot reports a `sig_error() without sig_on()` when tests are run on `sage/geometry/cone.py`.
+Sometimes, patchbot report error with the `random_cone` test in `src/sage/geometry/cone.py`. The cause is running out of memory.
 
-See:
+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.
+
+Patchbot reports:
+
+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)
 
 - [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)
``````




---

archive/issue_comments_373880.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n-Sometimes, patchbot report error with the `random_cone` test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n+Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n+\n+```\n+        sage: K = random_cone(min_ambient_dim=3, # long time\n+        ....:                 max_ambient_dim=3, # long time\n+        ....:                 min_rays=7)        # long time\n+```\n \n Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n \n``````\n",
    "created_at": "2018-01-16T23:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373880",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,10 @@
-Sometimes, patchbot report error with the `random_cone` test in `src/sage/geometry/cone.py`. The cause is running out of memory.
+Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.
+
+```
+        sage: K = random_cone(min_ambient_dim=3, # long time
+        ....:                 max_ambient_dim=3, # long time
+        ....:                 min_rays=7)        # long time
+```
 
 Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.
 
``````




---

archive/issue_comments_373881.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,6 +8,8 @@\n \n Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n \n+The code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.\n+\n Patchbot reports:\n \n - [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n``````\n",
    "created_at": "2018-01-16T23:12:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373881",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,6 +8,8 @@
 
 Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.
 
+The code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.
+
 Patchbot reports:
 
 - [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)
``````




---

archive/issue_comments_373882.json:
```json
{
    "body": "Branch: **[u/jdemeyer/random_failure_in_sage_geometry_cone_py](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/random_failure_in_sage_geometry_cone_py)**",
    "created_at": "2018-01-16T23:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373882",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/random_failure_in_sage_geometry_cone_py](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/random_failure_in_sage_geometry_cone_py)**



---

archive/issue_comments_373883.json:
```json
{
    "body": "Commit: **[e633459](https://github.com/sagemath/sagetrac-mirror/commit/e6334598576c96a65dc6a6ca34d794cd37dea049)**",
    "created_at": "2018-01-16T23:16:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373883",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[e633459](https://github.com/sagemath/sagetrac-mirror/commit/e6334598576c96a65dc6a6ca34d794cd37dea049)**



---

archive/issue_comments_373884.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e6334598576c96a65dc6a6ca34d794cd37dea049\">e633459</a></td><td><code>Bound number of rays in doctest</code></td></tr></table>\n",
    "created_at": "2018-01-16T23:16:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373884",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9" align="right">Comment 9</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e6334598576c96a65dc6a6ca34d794cd37dea049">e633459</a></td><td><code>Bound number of rays in doctest</code></td></tr></table>




---

archive/issue_comments_373885.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2018-01-16T23:16:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373885",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_events_321572.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-16T23:16:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321572"
}
```



---

archive/issue_comments_373886.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nThis test shouldn't generate a cone with an unbounded number of rays. The `random_cone` method is capable of \"resetting\" itself, and this test is meant to check that \"reset\" behavior.\n\nIf I want a random cone in three dimensions with 7 extreme rays, I will start generating random rays and adding them to my cone, starting with the trivial cone. But eventually, what will likely happen is that I'll wind up with all of `R^3`, which needs only six generators. At that point, the approach is doomed: if I generate more rays and add them to `R^3`, I still get `R^3`. So what can be done? Throw it out and start over!\n\nThere do exist cones in `R^3` with 7 extreme rays, it just takes some luck to find them using the approach that `random_cone` takes. So this test ensures that we will throw out a \"doomed\" cone and start over when we arrive at one.\n\nThe test should succeed as soon as it gets 7 rays, and not an unbounded number. Instead, I think there's probably a little bit of memory that isn't getting freed when we throw out the old, doomed random cone and start over.\n\nDo I need some trick like `K = None` when we're going to loop?",
    "created_at": "2018-01-16T23:42:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373886",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:11" align="right">Comment 11</div>

This test shouldn't generate a cone with an unbounded number of rays. The `random_cone` method is capable of "resetting" itself, and this test is meant to check that "reset" behavior.

If I want a random cone in three dimensions with 7 extreme rays, I will start generating random rays and adding them to my cone, starting with the trivial cone. But eventually, what will likely happen is that I'll wind up with all of `R^3`, which needs only six generators. At that point, the approach is doomed: if I generate more rays and add them to `R^3`, I still get `R^3`. So what can be done? Throw it out and start over!

There do exist cones in `R^3` with 7 extreme rays, it just takes some luck to find them using the approach that `random_cone` takes. So this test ensures that we will throw out a "doomed" cone and start over when we arrive at one.

The test should succeed as soon as it gets 7 rays, and not an unbounded number. Instead, I think there's probably a little bit of memory that isn't getting freed when we throw out the old, doomed random cone and start over.

Do I need some trick like `K = None` when we're going to loop?



---

archive/issue_comments_373887.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nTo be specific, we loop until the random cone (in progress) K \"is valid\",\n\n```\nif is_valid(K):\n    # Loop if we don't have a valid cone.\n    return K\n```\n\nBut that will be true as soon as this is true,\n\n```\nall([\n    K.nrays() >= min_rays,\n    K.nrays() <= max_rays or max_rays is None,\n    K.is_solid() == solid or solid is None,\n    K.is_strictly_convex() == strictly_convex or strictly_convex is None\n])\n```\n\nAnd in this case, since everything but `min_rays` is `None`, all we need is `K.nrays() >= min_rays`. Since we add them one-at-a-time, I would hope that we always get 7.",
    "created_at": "2018-01-16T23:52:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373887",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:12" align="right">Comment 12</div>

To be specific, we loop until the random cone (in progress) K "is valid",

```
if is_valid(K):
    # Loop if we don't have a valid cone.
    return K
```

But that will be true as soon as this is true,

```
all([
    K.nrays() >= min_rays,
    K.nrays() <= max_rays or max_rays is None,
    K.is_solid() == solid or solid is None,
    K.is_strictly_convex() == strictly_convex or strictly_convex is None
])
```

And in this case, since everything but `min_rays` is `None`, all we need is `K.nrays() >= min_rays`. Since we add them one-at-a-time, I would hope that we always get 7.



---

archive/issue_comments_373888.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nAaaaaaaaand nevermind. The default for `max_rays` is `None`, which is a priori fine. The random cone generation works like I said it does above: if you try to add a million rays, you'll usually get to the sixth or seventh before you've got all of `R^3`, and then the whole thing will restart.\n\nBut there's this little snippet, which tries to construct a decent number of starting rays before we begin to generate and add them one at a time:\n\n```\nr = random_min_max(min_rays, max_rays)\nrays = [L.random_element() for i in range(r)]\n```\n\nI would bet that the problem is right there, where we can generate a huge list of random rays, even if rays 7 through N will get thrown out as being redundant.\n\nI think that's a bug in my implementation.",
    "created_at": "2018-01-17T00:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373888",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:13" align="right">Comment 13</div>

Aaaaaaaaand nevermind. The default for `max_rays` is `None`, which is a priori fine. The random cone generation works like I said it does above: if you try to add a million rays, you'll usually get to the sixth or seventh before you've got all of `R^3`, and then the whole thing will restart.

But there's this little snippet, which tries to construct a decent number of starting rays before we begin to generate and add them one at a time:

```
r = random_min_max(min_rays, max_rays)
rays = [L.random_element() for i in range(r)]
```

I would bet that the problem is right there, where we can generate a huge list of random rays, even if rays 7 through N will get thrown out as being redundant.

I think that's a bug in my implementation.



---

archive/issue_comments_373889.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nProposed fix: replace,\n\n```\nrays = [L.random_element() for i in range(r)]\n```\n\nwith\n\n```\nrays = [L.random_element() for i in range(min_rays)]\n```\n\nThat will be a tiny bit slower in some cases, but far more sane when `max_rays` is `None`.\n\nIt will take me a day or two to build sage (it's been a while), so you have plenty of time to let me know if that does the trick =)",
    "created_at": "2018-01-17T00:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373889",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:14" align="right">Comment 14</div>

Proposed fix: replace,

```
rays = [L.random_element() for i in range(r)]
```

with

```
rays = [L.random_element() for i in range(min_rays)]
```

That will be a tiny bit slower in some cases, but far more sane when `max_rays` is `None`.

It will take me a day or two to build sage (it's been a while), so you have plenty of time to let me know if that does the trick =)



---

archive/issue_comments_373890.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8bba3491d8d9cdff1b2b7d3a0bd9459ec5514436\">8bba349</a></td><td><code>Start with \"min_rays\" rays in random_cone()</code></td></tr></table>\n",
    "created_at": "2018-01-17T13:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373890",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15" align="right">Comment 15</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8bba3491d8d9cdff1b2b7d3a0bd9459ec5514436">8bba349</a></td><td><code>Start with "min_rays" rays in random_cone()</code></td></tr></table>




---

archive/issue_comments_373891.json:
```json
{
    "body": "Changed commit from **[e633459](https://github.com/sagemath/sagetrac-mirror/commit/e6334598576c96a65dc6a6ca34d794cd37dea049)** to **[8bba349](https://github.com/sagemath/sagetrac-mirror/commit/8bba3491d8d9cdff1b2b7d3a0bd9459ec5514436)**",
    "created_at": "2018-01-17T13:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373891",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e633459](https://github.com/sagemath/sagetrac-mirror/commit/e6334598576c96a65dc6a6ca34d794cd37dea049)** to **[8bba349](https://github.com/sagemath/sagetrac-mirror/commit/8bba3491d8d9cdff1b2b7d3a0bd9459ec5514436)**



---

archive/issue_comments_373892.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nI tried to fix it using your suggestion. Needs review.",
    "created_at": "2018-01-17T13:17:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373892",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">Comment 16</div>

I tried to fix it using your suggestion. Needs review.



---

archive/issue_comments_373893.json:
```json
{
    "body": "Changed commit from **[8bba349](https://github.com/sagemath/sagetrac-mirror/commit/8bba3491d8d9cdff1b2b7d3a0bd9459ec5514436)** to **[6f9be50](https://github.com/sagemath/sagetrac-mirror/commit/6f9be50a05a2ed71fff5634fd207b326a59887c4)**",
    "created_at": "2018-01-18T18:24:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373893",
    "user": "https://github.com/orlitzky"
}
```

Changed commit from **[8bba349](https://github.com/sagemath/sagetrac-mirror/commit/8bba3491d8d9cdff1b2b7d3a0bd9459ec5514436)** to **[6f9be50](https://github.com/sagemath/sagetrac-mirror/commit/6f9be50a05a2ed71fff5634fd207b326a59887c4)**



---

archive/issue_comments_373894.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/random_failure_in_sage_geometry_cone_py](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/random_failure_in_sage_geometry_cone_py)** to **[u/mjo/ticket/24517](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/24517)**",
    "created_at": "2018-01-18T18:24:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373894",
    "user": "https://github.com/orlitzky"
}
```

Changed branch from **[u/jdemeyer/random_failure_in_sage_geometry_cone_py](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/random_failure_in_sage_geometry_cone_py)** to **[u/mjo/ticket/24517](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/24517)**



---

archive/issue_comments_373895.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nI think we should keep your original fix, too, and specify `max_rays=9` in the test. The code for `max_rays=None` should not go insane, obviously, but the test case shouldn't loop more than is necessary either.\n\nI also added an \"if\" statement to retain the original behavior when `max_rays` is not `None`. There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. `max_rays=1000000` in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if `min_rays=1` and `max_rays=1000` in a thousand-dimensional space. If we pick `r=500` in that case, we're much better off generating 500 random rays at the start.\n\nIn any case, this shouldn't cause problems for the test suite any longer.\n\nI didn't notice the rest of your comment changes before working on this, but it looks like they all followed from the `r` -> `min_rays` change, which is now only conditional, so please let me know if there's any other comment fix I should pull.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6f9be50a05a2ed71fff5634fd207b326a59887c4\">6f9be50</a></td><td><code>Trac #24517: improve random_cone() performance when max_rays is None.</code></td></tr></table>\n",
    "created_at": "2018-01-18T18:24:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373895",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:17" align="right">Comment 17</div>

I think we should keep your original fix, too, and specify `max_rays=9` in the test. The code for `max_rays=None` should not go insane, obviously, but the test case shouldn't loop more than is necessary either.

I also added an "if" statement to retain the original behavior when `max_rays` is not `None`. There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. `max_rays=1000000` in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if `min_rays=1` and `max_rays=1000` in a thousand-dimensional space. If we pick `r=500` in that case, we're much better off generating 500 random rays at the start.

In any case, this shouldn't cause problems for the test suite any longer.

I didn't notice the rest of your comment changes before working on this, but it looks like they all followed from the `r` -> `min_rays` change, which is now only conditional, so please let me know if there's any other comment fix I should pull.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6f9be50a05a2ed71fff5634fd207b326a59887c4">6f9be50</a></td><td><code>Trac #24517: improve random_cone() performance when max_rays is None.</code></td></tr></table>




---

archive/issue_comments_373896.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a7954f91d3266fbaf8476fa699d6027604148afe\">a7954f9</a></td><td><code>Trac #24517: drop an erroneous claim from a random_cone() comment.</code></td></tr></table>\n",
    "created_at": "2018-01-18T18:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373896",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18" align="right">Comment 18</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a7954f91d3266fbaf8476fa699d6027604148afe">a7954f9</a></td><td><code>Trac #24517: drop an erroneous claim from a random_cone() comment.</code></td></tr></table>




---

archive/issue_comments_373897.json:
```json
{
    "body": "Changed commit from **[6f9be50](https://github.com/sagemath/sagetrac-mirror/commit/6f9be50a05a2ed71fff5634fd207b326a59887c4)** to **[a7954f9](https://github.com/sagemath/sagetrac-mirror/commit/a7954f91d3266fbaf8476fa699d6027604148afe)**",
    "created_at": "2018-01-18T18:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373897",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[6f9be50](https://github.com/sagemath/sagetrac-mirror/commit/6f9be50a05a2ed71fff5634fd207b326a59887c4)** to **[a7954f9](https://github.com/sagemath/sagetrac-mirror/commit/a7954f91d3266fbaf8476fa699d6027604148afe)**



---

archive/issue_comments_373898.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nI can squash that later, I wasn't thinking straight when I wrote the comment.",
    "created_at": "2018-01-18T18:31:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373898",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:19" align="right">Comment 19</div>

I can squash that later, I wasn't thinking straight when I wrote the comment.



---

archive/issue_comments_373899.json:
```json
{
    "body": "Changed commit from **[a7954f9](https://github.com/sagemath/sagetrac-mirror/commit/a7954f91d3266fbaf8476fa699d6027604148afe)** to **[1991f6f](https://github.com/sagemath/sagetrac-mirror/commit/1991f6fb4f69f449780769189492702b3d8db945)**",
    "created_at": "2018-01-18T20:50:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373899",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[a7954f9](https://github.com/sagemath/sagetrac-mirror/commit/a7954f91d3266fbaf8476fa699d6027604148afe)** to **[1991f6f](https://github.com/sagemath/sagetrac-mirror/commit/1991f6fb4f69f449780769189492702b3d8db945)**



---

archive/issue_comments_373900.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1991f6fb4f69f449780769189492702b3d8db945\">1991f6f</a></td><td><code>Trac #24517: simplify the random_cone() performance fix in 6f9be50.</code></td></tr></table>\n",
    "created_at": "2018-01-18T20:50:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373900",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20" align="right">Comment 20</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1991f6fb4f69f449780769189492702b3d8db945">1991f6f</a></td><td><code>Trac #24517: simplify the random_cone() performance fix in 6f9be50.</code></td></tr></table>




---

archive/issue_comments_373901.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\n> There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. max_rays=1000000 in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if min_rays=1 and max_rays=1000 in a thousand-dimensional space. If we pick r=500 in that case, we're much better off generating 500 random rays at the start. \n\n\\\\\nI think I was able to address both of these in the latest commit. Naturally, there's some other side-effect -- more predictability when you ask for more than `2*dim` rays -- but that's an edge case and I think it's better to have the implementation less crashy.",
    "created_at": "2018-01-18T20:53:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373901",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:21" align="right">Comment 21</div>

> There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. max_rays=1000000 in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if min_rays=1 and max_rays=1000 in a thousand-dimensional space. If we pick r=500 in that case, we're much better off generating 500 random rays at the start. 

\\
I think I was able to address both of these in the latest commit. Naturally, there's some other side-effect -- more predictability when you ask for more than `2*dim` rays -- but that's an edge case and I think it's better to have the implementation less crashy.



---

archive/issue_events_321573.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-18T21:36:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321573"
}
```



---

archive/issue_events_321574.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-18T21:36:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321574"
}
```



---

archive/issue_comments_373902.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nReplying to [@orlitzky](#comment%3A17):\n> I think we should keep your original fix, too, and specify `max_rays=9` in the test.\n\nWhy? You convinced me that it was not the right fix and I agreed with you :-)\n\nNote that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.",
    "created_at": "2018-01-18T21:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373902",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">Comment 22</div>

Replying to [@orlitzky](#comment%3A17):
> I think we should keep your original fix, too, and specify `max_rays=9` in the test.

Why? You convinced me that it was not the right fix and I agreed with you :-)

Note that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.



---

archive/issue_comments_373903.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nAlso: use normal plain text syntax, not Sphinx syntax like <code>:trac:\\`24517\\`</code> in comments.",
    "created_at": "2018-01-18T21:38:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373903",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">Comment 23</div>

Also: use normal plain text syntax, not Sphinx syntax like <code>:trac:\`24517\`</code> in comments.



---

archive/issue_comments_373904.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nReplying to [@jdemeyer](#comment%3A22):\n> Replying to [@orlitzky](#comment%3A17):\n> > I think we should keep your original fix, too, and specify `max_rays=9` in the test.\n\n> \n> Why? You convinced me that it was not the right fix and I agreed with you :-)\n> \n> Note that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.\n\nIt's just faster for the poor folks who run ptestlong. I saw about a 5 second average improvement with `max_rays=9`, mentioned at the bottom of the commit message.\n\nThe problem with leaving it unbounded is that you wind up looping...\n\n1. A random, large upper bound is chosen.\n2. We choose `r` between 7 and that large number; also generally large.\n3. We try to attain `r` rays, by adding one at a time...\n4. We wind up with the full space, and GOTO 1.\n\nWith `max_rays=9`, the picture is only a little different:\n\n1. We choose `r` between 7 and 9 (much more reasonable!)\n2. We try to attain `r` rays, by adding one at a time...\n3. We usually wind up with the full space and GOTO 1, but, more often than before we can achieve 7, 8, or 9 rays.\n\nIn the second scenario, you don't have to get lucky and choose a small random number.",
    "created_at": "2018-01-18T22:12:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373904",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:24" align="right">Comment 24</div>

Replying to [@jdemeyer](#comment%3A22):
> Replying to [@orlitzky](#comment%3A17):
> > I think we should keep your original fix, too, and specify `max_rays=9` in the test.

> 
> Why? You convinced me that it was not the right fix and I agreed with you :-)
> 
> Note that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.

It's just faster for the poor folks who run ptestlong. I saw about a 5 second average improvement with `max_rays=9`, mentioned at the bottom of the commit message.

The problem with leaving it unbounded is that you wind up looping...

1. A random, large upper bound is chosen.
2. We choose `r` between 7 and that large number; also generally large.
3. We try to attain `r` rays, by adding one at a time...
4. We wind up with the full space, and GOTO 1.

With `max_rays=9`, the picture is only a little different:

1. We choose `r` between 7 and 9 (much more reasonable!)
2. We try to attain `r` rays, by adding one at a time...
3. We usually wind up with the full space and GOTO 1, but, more often than before we can achieve 7, 8, or 9 rays.

In the second scenario, you don't have to get lucky and choose a small random number.



---

archive/issue_comments_373905.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5740814745244aa50e3844cb89f1063529934202\">5740814</a></td><td><code>Trac #24517: improve random_cone() performance when max_rays is None.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7f5ceefdfa53e9a2f030479384e844f7d7dc2a8c\">7f5ceef</a></td><td><code>Trac #24517: simplify the random_cone() performance fix in 5ff0391.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7bbe362b425368340e59271c6cf48a6c0240e1c8\">7bbe362</a></td><td><code>Trac #24517: remove RST markup from non-docstring random_cone() comments.</code></td></tr></table>\n",
    "created_at": "2018-01-22T20:47:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373905",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25" align="right">Comment 25</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5740814745244aa50e3844cb89f1063529934202">5740814</a></td><td><code>Trac #24517: improve random_cone() performance when max_rays is None.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7f5ceefdfa53e9a2f030479384e844f7d7dc2a8c">7f5ceef</a></td><td><code>Trac #24517: simplify the random_cone() performance fix in 5ff0391.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7bbe362b425368340e59271c6cf48a6c0240e1c8">7bbe362</a></td><td><code>Trac #24517: remove RST markup from non-docstring random_cone() comments.</code></td></tr></table>




---

archive/issue_comments_373906.json:
```json
{
    "body": "Changed commit from **[1991f6f](https://github.com/sagemath/sagetrac-mirror/commit/1991f6fb4f69f449780769189492702b3d8db945)** to **[7bbe362](https://github.com/sagemath/sagetrac-mirror/commit/7bbe362b425368340e59271c6cf48a6c0240e1c8)**",
    "created_at": "2018-01-22T20:47:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373906",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[1991f6f](https://github.com/sagemath/sagetrac-mirror/commit/1991f6fb4f69f449780769189492702b3d8db945)** to **[7bbe362](https://github.com/sagemath/sagetrac-mirror/commit/7bbe362b425368340e59271c6cf48a6c0240e1c8)**



---

archive/issue_comments_373907.json:
```json
{
    "body": "Changed commit from **[7bbe362](https://github.com/sagemath/sagetrac-mirror/commit/7bbe362b425368340e59271c6cf48a6c0240e1c8)** to **[2683d07](https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711)**",
    "created_at": "2018-01-22T20:50:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373907",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[7bbe362](https://github.com/sagemath/sagetrac-mirror/commit/7bbe362b425368340e59271c6cf48a6c0240e1c8)** to **[2683d07](https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711)**



---

archive/issue_comments_373908.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ca2b0f925e62e03d011b55a5003ae2ae2cc3e342\">ca2b0f9</a></td><td><code>Trac #24517: simplify the recent random_cone() performance fix.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711\">2683d07</a></td><td><code>Trac #24517: remove RST markup from non-docstring random_cone() comments.</code></td></tr></table>\n",
    "created_at": "2018-01-22T20:50:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373908",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26" align="right">Comment 26</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ca2b0f925e62e03d011b55a5003ae2ae2cc3e342">ca2b0f9</a></td><td><code>Trac #24517: simplify the recent random_cone() performance fix.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711">2683d07</a></td><td><code>Trac #24517: remove RST markup from non-docstring random_cone() comments.</code></td></tr></table>




---

archive/issue_comments_373909.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nTrying to mention a commit hash during `rebase -i` is not working out for me...\n\nI'll put the original test case back if you like, but I think it's making an already-long test even longer for not much benefit.",
    "created_at": "2018-01-22T20:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373909",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:27" align="right">Comment 27</div>

Trying to mention a commit hash during `rebase -i` is not working out for me...

I'll put the original test case back if you like, but I think it's making an already-long test even longer for not much benefit.



---

archive/issue_events_321575.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2018-01-22T20:52:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321575"
}
```



---

archive/issue_events_321576.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2018-01-22T20:52:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321576"
}
```



---

archive/issue_comments_373910.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nlooks good to me. Jeroen, do you agree ?",
    "created_at": "2018-01-27T12:33:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373910",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:29" align="right">Comment 29</div>

looks good to me. Jeroen, do you agree ?



---

archive/issue_events_321577.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-29T16:31:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321577"
}
```



---

archive/issue_events_321578.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-29T16:31:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321578"
}
```



---

archive/issue_comments_373911.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2018-01-29T16:31:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373911",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton**



---

archive/issue_comments_373912.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nI am setting this to positive. If there are any objections, please shout out loud.",
    "created_at": "2018-01-29T16:31:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373912",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:30" align="right">Comment 30</div>

I am setting this to positive. If there are any objections, please shout out loud.



---

archive/issue_comments_373913.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nNo objections here...",
    "created_at": "2018-01-29T16:40:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373913",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">Comment 31</div>

No objections here...



---

archive/issue_comments_373914.json:
```json
{
    "body": "Changed branch from **[u/mjo/ticket/24517](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/24517)** to **[2683d07](https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711)**",
    "created_at": "2018-02-01T19:13:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24517#issuecomment-373914",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mjo/ticket/24517](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/24517)** to **[2683d07](https://github.com/sagemath/sagetrac-mirror/commit/2683d071d904469a01ce3949dacff8768f8df711)**



---

archive/issue_events_321579.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-01T19:13:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321579"
}
```



---

archive/issue_events_321580.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "ed50684b298d02445a35603d61f8531da70ad90f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-02-01T19:13:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24517",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24517#event-321580"
}
```
