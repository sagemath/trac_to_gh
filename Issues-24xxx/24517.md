# Issue 24517: random failure in sage/geometry/cone.py

archive/issues_024280.json:
```json
{
    "body": "Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n\n```\n        sage: K = random_cone(min_ambient_dim=3, # long time\n        ....:                 max_ambient_dim=3, # long time\n        ....:                 min_rays=7)        # long time\n```\n\nSometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n\nThe code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.\n\nPatchbot reports:\n\n- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n\n- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)\n\nCC:  @orlitzky\n\nBranch/Commit: 2683d071d904469a01ce3949dacff8768f8df711\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24517\n\n",
    "closed_at": "2018-02-01T19:13:37Z",
    "created_at": "2018-01-11T16:06:45Z",
    "labels": [
        "component: doctest coverage",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "random failure in sage/geometry/cone.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24517",
    "user": "https://github.com/videlec"
}
```
Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.

```
        sage: K = random_cone(min_ambient_dim=3, # long time
        ....:                 max_ambient_dim=3, # long time
        ....:                 min_rays=7)        # long time
```

Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.

The code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.

Patchbot reports:

- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)

- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)

CC:  @orlitzky

Branch/Commit: 2683d071d904469a01ce3949dacff8768f8df711

Reviewer: Frédéric Chapoton

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24517





---

archive/issue_comments_361838.json:
```json
{
    "body": "<a id='comment:1'></a>This traceback line\n\n```\n#8  __pyx_f_4sage_3ext_6memory_alloc_error (__pyx_v_size=__pyx_v_size@entry=8) at build/cythonized/sage/ext/memory.c:1169\n```\nshows that it is happening because of lack of memory. So either this particular patchbot is low on memory or this doctest does something which requires lots of memory.\n\nNow this out-of-memory situation is not gracefully handled. I could change the code to `raise MemoryError` instead of crashing, but that won't solve the underlying issue that it is running out of memory.",
    "created_at": "2018-01-11T16:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361838",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>This traceback line

```
#8  __pyx_f_4sage_3ext_6memory_alloc_error (__pyx_v_size=__pyx_v_size@entry=8) at build/cythonized/sage/ext/memory.c:1169
```
shows that it is happening because of lack of memory. So either this particular patchbot is low on memory or this doctest does something which requires lots of memory.

Now this out-of-memory situation is not gracefully handled. I could change the code to `raise MemoryError` instead of crashing, but that won't solve the underlying issue that it is running out of memory.



---

archive/issue_comments_361839.json:
```json
{
    "body": "<a id='comment:2'></a>quasar is 8G memory (though tests are run in parallel). For me these are two problems:\n- the crash when doctesting\n- the fact that the `random_cone` method is not careful with the size of the generated cone\n\nWhich one do you want to deal with on this ticket?",
    "created_at": "2018-01-11T16:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361839",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>quasar is 8G memory (though tests are run in parallel). For me these are two problems:
- the crash when doctesting
- the fact that the `random_cone` method is not careful with the size of the generated cone

Which one do you want to deal with on this ticket?



---

archive/issue_comments_361840.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 vdelecroix]:\n> quasar is 8G memory (though tests are run in parallel). For me these are two problems:\n> - the crash when doctesting\n> - the fact that the `random_cone` method is not careful with the size of the generated cone\n> \n> Which one do you want to deal with on this ticket?\n\n\nThe last one.",
    "created_at": "2018-01-11T16:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361840",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Replying to [comment:2 vdelecroix]:
> quasar is 8G memory (though tests are run in parallel). For me these are two problems:
> - the crash when doctesting
> - the fact that the `random_cone` method is not careful with the size of the generated cone
> 
> Which one do you want to deal with on this ticket?


The last one.



---

archive/issue_comments_361841.json:
```json
{
    "body": "<a id='comment:4'></a>I would argue not to the fix the first issue. It happened in `Rational.__new__()`. If there is not enough space for that, then surely stuff will break anyway sooner or later. Second, adding error checking would mean adding `sig_on()` and `sig_off()` which causes some loss of performance every time that a new `Rational` is created.",
    "created_at": "2018-01-11T16:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361841",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>I would argue not to the fix the first issue. It happened in `Rational.__new__()`. If there is not enough space for that, then surely stuff will break anyway sooner or later. Second, adding error checking would mean adding `sig_on()` and `sig_off()` which causes some loss of performance every time that a new `Rational` is created.



---

archive/issue_comments_361842.json:
```json
{
    "body": "Changing component from documentation to doctest coverage.",
    "created_at": "2018-01-16T22:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361842",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from documentation to doctest coverage.



---

archive/issue_comments_361843.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-01-16T22:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361843",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_361844.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,10 @@\n-Sometimes, patchbot reports a `sig_error() without sig_on()` when tests are run on `sage/geometry/cone.py`.\n+Sometimes, patchbot report error with the `random_cone` test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n \n-See:\n+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n+\n+Patchbot reports:\n+\n+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n \n - [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)\n \n``````\n",
    "created_at": "2018-01-16T22:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361844",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,10 @@
-Sometimes, patchbot reports a `sig_error() without sig_on()` when tests are run on `sage/geometry/cone.py`.
+Sometimes, patchbot report error with the `random_cone` test in `src/sage/geometry/cone.py`. The cause is running out of memory.
 
-See:
+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.
+
+Patchbot reports:
+
+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)
 
 - [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)
 
``````




---

archive/issue_comments_361845.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n \n+```\n+        sage: K = random_cone(min_ambient_dim=3, # long time\n+        ....:                 max_ambient_dim=3, # long time\n+        ....:                 min_rays=7)        # long time\n+```\n+\n+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n+\n+Patchbot reports:\n+\n+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n+\n+- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-01-16T23:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361845",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.
 
+```
+        sage: K = random_cone(min_ambient_dim=3, # long time
+        ....:                 max_ambient_dim=3, # long time
+        ....:                 min_rays=7)        # long time
+```
+
+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.
+
+Patchbot reports:
+
+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)
+
+- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)
 
 Comment: 1
 
``````




---

archive/issue_comments_361846.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,20 @@\n+Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.\n \n+```\n+        sage: K = random_cone(min_ambient_dim=3, # long time\n+        ....:                 max_ambient_dim=3, # long time\n+        ....:                 min_rays=7)        # long time\n+```\n+\n+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.\n+\n+The code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.\n+\n+Patchbot reports:\n+\n+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)\n+\n+- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-01-16T23:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361846",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,20 @@
+Sometimes, patchbot report errord with the following test in `src/sage/geometry/cone.py`. The cause is running out of memory.
 
+```
+        sage: K = random_cone(min_ambient_dim=3, # long time
+        ....:                 max_ambient_dim=3, # long time
+        ....:                 min_rays=7)        # long time
+```
+
+Sometimes, the test simply gives a `MemoryError` and sometimes a more severe crash, like `sig_error() without sig_on()`.
+
+The code seems to generate a random cone with a random unbounded(!) number of rays until it finds a good cone. This is obviously asking for trouble.
+
+Patchbot reports:
+
+- [https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02](https://patchbot.sagemath.org/log/24549/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-01-16%2019:07:02)
+
+- [quasar 2018-01-11%2015:44:33](https://patchbot.sagemath.org/log/24511/Ubuntu/16.04/x86_64/4.4.0-104-generic/quasar/2018-01-11%2015:44:33?short)
 
 Comment: 1
 
``````




---

archive/issue_comments_361847.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-16T23:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361847",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_361848.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-16T23:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361848",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_361849.json:
```json
{
    "body": "<a id='comment:11'></a>This test shouldn't generate a cone with an unbounded number of rays. The `random_cone` method is capable of \"resetting\" itself, and this test is meant to check that \"reset\" behavior.\n\nIf I want a random cone in three dimensions with 7 extreme rays, I will start generating random rays and adding them to my cone, starting with the trivial cone. But eventually, what will likely happen is that I'll wind up with all of `R^3`, which needs only six generators. At that point, the approach is doomed: if I generate more rays and add them to `R^3`, I still get `R^3`. So what can be done? Throw it out and start over!\n\nThere do exist cones in `R^3` with 7 extreme rays, it just takes some luck to find them using the approach that `random_cone` takes. So this test ensures that we will throw out a \"doomed\" cone and start over when we arrive at one.\n\nThe test should succeed as soon as it gets 7 rays, and not an unbounded number. Instead, I think there's probably a little bit of memory that isn't getting freed when we throw out the old, doomed random cone and start over.\n\nDo I need some trick like `K = None` when we're going to loop?",
    "created_at": "2018-01-16T23:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361849",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:11'></a>This test shouldn't generate a cone with an unbounded number of rays. The `random_cone` method is capable of "resetting" itself, and this test is meant to check that "reset" behavior.

If I want a random cone in three dimensions with 7 extreme rays, I will start generating random rays and adding them to my cone, starting with the trivial cone. But eventually, what will likely happen is that I'll wind up with all of `R^3`, which needs only six generators. At that point, the approach is doomed: if I generate more rays and add them to `R^3`, I still get `R^3`. So what can be done? Throw it out and start over!

There do exist cones in `R^3` with 7 extreme rays, it just takes some luck to find them using the approach that `random_cone` takes. So this test ensures that we will throw out a "doomed" cone and start over when we arrive at one.

The test should succeed as soon as it gets 7 rays, and not an unbounded number. Instead, I think there's probably a little bit of memory that isn't getting freed when we throw out the old, doomed random cone and start over.

Do I need some trick like `K = None` when we're going to loop?



---

archive/issue_comments_361850.json:
```json
{
    "body": "<a id='comment:12'></a>To be specific, we loop until the random cone (in progress) K \"is valid\",\n\n```\nif is_valid(K):\n    # Loop if we don't have a valid cone.\n    return K\n```\n\nBut that will be true as soon as this is true,\n\n```\nall([\n    K.nrays() >= min_rays,\n    K.nrays() <= max_rays or max_rays is None,\n    K.is_solid() == solid or solid is None,\n    K.is_strictly_convex() == strictly_convex or strictly_convex is None\n])\n```\n\nAnd in this case, since everything but `min_rays` is `None`, all we need is `K.nrays() >= min_rays`. Since we add them one-at-a-time, I would hope that we always get 7.",
    "created_at": "2018-01-16T23:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361850",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:12'></a>To be specific, we loop until the random cone (in progress) K "is valid",

```
if is_valid(K):
    # Loop if we don't have a valid cone.
    return K
```

But that will be true as soon as this is true,

```
all([
    K.nrays() >= min_rays,
    K.nrays() <= max_rays or max_rays is None,
    K.is_solid() == solid or solid is None,
    K.is_strictly_convex() == strictly_convex or strictly_convex is None
])
```

And in this case, since everything but `min_rays` is `None`, all we need is `K.nrays() >= min_rays`. Since we add them one-at-a-time, I would hope that we always get 7.



---

archive/issue_comments_361851.json:
```json
{
    "body": "<a id='comment:13'></a>Aaaaaaaaand nevermind. The default for `max_rays` is `None`, which is a priori fine. The random cone generation works like I said it does above: if you try to add a million rays, you'll usually get to the sixth or seventh before you've got all of `R^3`, and then the whole thing will restart.\n\nBut there's this little snippet, which tries to construct a decent number of starting rays before we begin to generate and add them one at a time:\n\n```\nr = random_min_max(min_rays, max_rays)\nrays = [L.random_element() for i in range(r)]\n```\n\nI would bet that the problem is right there, where we can generate a huge list of random rays, even if rays 7 through N will get thrown out as being redundant.\n\nI think that's a bug in my implementation.",
    "created_at": "2018-01-17T00:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361851",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>Aaaaaaaaand nevermind. The default for `max_rays` is `None`, which is a priori fine. The random cone generation works like I said it does above: if you try to add a million rays, you'll usually get to the sixth or seventh before you've got all of `R^3`, and then the whole thing will restart.

But there's this little snippet, which tries to construct a decent number of starting rays before we begin to generate and add them one at a time:

```
r = random_min_max(min_rays, max_rays)
rays = [L.random_element() for i in range(r)]
```

I would bet that the problem is right there, where we can generate a huge list of random rays, even if rays 7 through N will get thrown out as being redundant.

I think that's a bug in my implementation.



---

archive/issue_comments_361852.json:
```json
{
    "body": "<a id='comment:14'></a>Proposed fix: replace,\n\n```\nrays = [L.random_element() for i in range(r)]\n```\n\nwith\n\n```\nrays = [L.random_element() for i in range(min_rays)]\n```\n\nThat will be a tiny bit slower in some cases, but far more sane when `max_rays` is `None`.\n\nIt will take me a day or two to build sage (it's been a while), so you have plenty of time to let me know if that does the trick =)",
    "created_at": "2018-01-17T00:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361852",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:14'></a>Proposed fix: replace,

```
rays = [L.random_element() for i in range(r)]
```

with

```
rays = [L.random_element() for i in range(min_rays)]
```

That will be a tiny bit slower in some cases, but far more sane when `max_rays` is `None`.

It will take me a day or two to build sage (it's been a while), so you have plenty of time to let me know if that does the trick =)



---

archive/issue_comments_361853.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-17T13:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361853",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_361854.json:
```json
{
    "body": "<a id='comment:16'></a>I tried to fix it using your suggestion. Needs review.",
    "created_at": "2018-01-17T13:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361854",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>I tried to fix it using your suggestion. Needs review.



---

archive/issue_comments_361855.json:
```json
{
    "body": "<a id='comment:17'></a>I think we should keep your original fix, too, and specify `max_rays=9` in the test. The code for `max_rays=None` should not go insane, obviously, but the test case shouldn't loop more than is necessary either.\n\nI also added an \"if\" statement to retain the original behavior when `max_rays` is not `None`. There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. `max_rays=1000000` in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if `min_rays=1` and `max_rays=1000` in a thousand-dimensional space. If we pick `r=500` in that case, we're much better off generating 500 random rays at the start.\n\nIn any case, this shouldn't cause problems for the test suite any longer.\n\nI didn't notice the rest of your comment changes before working on this, but it looks like they all followed from the `r` -> `min_rays` change, which is now only conditional, so please let me know if there's any other comment fix I should pull.\n\n---\nNew commits:",
    "created_at": "2018-01-18T18:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361855",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:17'></a>I think we should keep your original fix, too, and specify `max_rays=9` in the test. The code for `max_rays=None` should not go insane, obviously, but the test case shouldn't loop more than is necessary either.

I also added an "if" statement to retain the original behavior when `max_rays` is not `None`. There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. `max_rays=1000000` in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if `min_rays=1` and `max_rays=1000` in a thousand-dimensional space. If we pick `r=500` in that case, we're much better off generating 500 random rays at the start.

In any case, this shouldn't cause problems for the test suite any longer.

I didn't notice the rest of your comment changes before working on this, but it looks like they all followed from the `r` -> `min_rays` change, which is now only conditional, so please let me know if there's any other comment fix I should pull.

---
New commits:



---

archive/issue_comments_361856.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-18T18:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361856",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361857.json:
```json
{
    "body": "<a id='comment:19'></a>I can squash that later, I wasn't thinking straight when I wrote the comment.",
    "created_at": "2018-01-18T18:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361857",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:19'></a>I can squash that later, I wasn't thinking straight when I wrote the comment.



---

archive/issue_comments_361858.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-18T20:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361858",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361859.json:
```json
{
    "body": "<a id='comment:21'></a>> There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. max_rays=1000000 in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if min_rays=1 and max_rays=1000 in a thousand-dimensional space. If we pick r=500 in that case, we're much better off generating 500 random rays at the start. \n\n\\\\\nI think I was able to address both of these in the latest commit. Naturally, there's some other side-effect -- more predictability when you ask for more than `2*dim` rays -- but that's an edge case and I think it's better to have the implementation less crashy.",
    "created_at": "2018-01-18T20:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361859",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:21'></a>> There's a trade-off here; namely that the user can still cause himself pain and suffering by specifying e.g. max_rays=1000000 in a three-dimensional space (basically, the problem in this ticket). On the other hand, we would like to avoid generating rays and checking the cone's validity one ray at a time if min_rays=1 and max_rays=1000 in a thousand-dimensional space. If we pick r=500 in that case, we're much better off generating 500 random rays at the start. 

\\
I think I was able to address both of these in the latest commit. Naturally, there's some other side-effect -- more predictability when you ask for more than `2*dim` rays -- but that's an edge case and I think it's better to have the implementation less crashy.



---

archive/issue_comments_361860.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-01-18T21:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361860",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_361861.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:17 mjo]:\n> I think we should keep your original fix, too, and specify `max_rays=9` in the test.\n\n\nWhy? You convinced me that it was not the right fix and I agreed with you :-)\n\nNote that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.",
    "created_at": "2018-01-18T21:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361861",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replying to [comment:17 mjo]:
> I think we should keep your original fix, too, and specify `max_rays=9` in the test.


Why? You convinced me that it was not the right fix and I agreed with you :-)

Note that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.



---

archive/issue_comments_361862.json:
```json
{
    "body": "<a id='comment:23'></a>Also: use normal plain text syntax, not Sphinx syntax like `:trac:`24517`` in comments.",
    "created_at": "2018-01-18T21:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361862",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Also: use normal plain text syntax, not Sphinx syntax like `:trac:`24517`` in comments.



---

archive/issue_comments_361863.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 jdemeyer]:\n> Replying to [comment:17 mjo]:\n> > I think we should keep your original fix, too, and specify `max_rays=9` in the test.\n\n> \n> Why? You convinced me that it was not the right fix and I agreed with you :-)\n> \n> Note that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.\n\n\nIt's just faster for the poor folks who run ptestlong. I saw about a 5 second average improvement with `max_rays=9`, mentioned at the bottom of the commit message.\n\nThe problem with leaving it unbounded is that you wind up looping...\n\n1. A random, large upper bound is chosen.\n2. We choose `r` between 7 and that large number; also generally large.\n3. We try to attain `r` rays, by adding one at a time...\n4. We wind up with the full space, and GOTO 1.\n\nWith `max_rays=9`, the picture is only a little different:\n\n1. We choose `r` between 7 and 9 (much more reasonable!)\n2. We try to attain `r` rays, by adding one at a time...\n3. We usually wind up with the full space and GOTO 1, but, more often than before we can achieve 7, 8, or 9 rays.\n\nIn the second scenario, you don't have to get lucky and choose a small random number.",
    "created_at": "2018-01-18T22:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361863",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:24'></a>Replying to [comment:22 jdemeyer]:
> Replying to [comment:17 mjo]:
> > I think we should keep your original fix, too, and specify `max_rays=9` in the test.

> 
> Why? You convinced me that it was not the right fix and I agreed with you :-)
> 
> Note that without `max_rays=9` the number of rays won't get very large anyway since the `while` loop which adds rays will early abort once we reach the full space. In a 3-dimensional space it would be quite unlikely already to have even 10 rays not spanning the whole space. So I do think that my original fix was sufficient. And also a better test because there is no need to artificially limit the number of rays.


It's just faster for the poor folks who run ptestlong. I saw about a 5 second average improvement with `max_rays=9`, mentioned at the bottom of the commit message.

The problem with leaving it unbounded is that you wind up looping...

1. A random, large upper bound is chosen.
2. We choose `r` between 7 and that large number; also generally large.
3. We try to attain `r` rays, by adding one at a time...
4. We wind up with the full space, and GOTO 1.

With `max_rays=9`, the picture is only a little different:

1. We choose `r` between 7 and 9 (much more reasonable!)
2. We try to attain `r` rays, by adding one at a time...
3. We usually wind up with the full space and GOTO 1, but, more often than before we can achieve 7, 8, or 9 rays.

In the second scenario, you don't have to get lucky and choose a small random number.



---

archive/issue_comments_361864.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-22T20:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361864",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_361865.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-22T20:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361865",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_361866.json:
```json
{
    "body": "<a id='comment:27'></a>Trying to mention a commit hash during `rebase -i` is not working out for me...\n\nI'll put the original test case back if you like, but I think it's making an already-long test even longer for not much benefit.",
    "created_at": "2018-01-22T20:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361866",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:27'></a>Trying to mention a commit hash during `rebase -i` is not working out for me...

I'll put the original test case back if you like, but I think it's making an already-long test even longer for not much benefit.



---

archive/issue_comments_361867.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-01-22T20:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361867",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_361868.json:
```json
{
    "body": "<a id='comment:29'></a>looks good to me. Jeroen, do you agree ?",
    "created_at": "2018-01-27T12:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361868",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:29'></a>looks good to me. Jeroen, do you agree ?



---

archive/issue_comments_361869.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-29T16:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361869",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_361870.json:
```json
{
    "body": "<a id='comment:30'></a>I am setting this to positive. If there are any objections, please shout out loud.",
    "created_at": "2018-01-29T16:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361870",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:30'></a>I am setting this to positive. If there are any objections, please shout out loud.



---

archive/issue_comments_361871.json:
```json
{
    "body": "<a id='comment:31'></a>No objections here...",
    "created_at": "2018-01-29T16:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361871",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>No objections here...



---

archive/issue_comments_361872.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-01T19:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24517#issuecomment-361872",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061834.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-01T19:13:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24517",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24517#event-61834"
}
```
