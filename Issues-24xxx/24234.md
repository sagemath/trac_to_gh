# Issue 24234: py3: restore_atexit context manager

archive/issues_023997.json:
```json
{
    "assignees": [],
    "body": "Adds a context manager that can save and restore the state of the `atexit` module.\n\nThis functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.\n\nUpstream issue: https://bugs.python.org/issue32082\n\nCC:  @fchapoton @jdemeyer\n\nBranch/Commit: **[`481f3b0`](https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027)**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Erik Bray**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24234_\n\n",
    "closed_at": "2018-01-14T10:14:38Z",
    "created_at": "2017-11-17T14:07:43Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: restore_atexit context manager",
    "type": "issue",
    "updated_at": "2018-01-14T10:14:38Z",
    "url": "https://github.com/sagemath/sage/issues/24234",
    "user": "https://github.com/embray"
}
```
Adds a context manager that can save and restore the state of the `atexit` module.

This functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.

Upstream issue: https://bugs.python.org/issue32082

CC:  @fchapoton @jdemeyer

Branch/Commit: **[`481f3b0`](https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027)**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Jeroen Demeyer**

Author: **Erik Bray**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/24234_





---

archive/issue_events_333284.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-17T14:07:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333284"
}
```



---

archive/issue_events_333285.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-17T14:07:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "0000b0",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333285"
}
```



---

archive/issue_events_333286.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-17T14:07:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333286"
}
```



---

archive/issue_events_333287.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-17T14:07:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333287"
}
```



---

archive/issue_events_333288.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-17T14:07:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333288"
}
```



---

archive/issue_comments_366665.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHaven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.",
    "created_at": "2017-11-17T17:04:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366665",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.



---

archive/issue_comments_366666.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nBy the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.",
    "created_at": "2017-11-17T17:11:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366666",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.



---

archive/issue_comments_366667.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@jdemeyer](#comment%3A3):\n> Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.\n\nIf you say so--I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.  I'm not sure how I feel about `sage.cpython` for this.",
    "created_at": "2017-11-20T09:24:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366667",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@jdemeyer](#comment%3A3):
> Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.

If you say so--I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.  I'm not sure how I feel about `sage.cpython` for this.



---

archive/issue_comments_366668.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jdemeyer](#comment%3A4):\n> By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.\n\nWriting a function to return a list would be easy.  The problem is that mutating that list would either have no effect, or would have to be propagated back to the internal array of callbacks.  So I think that would be a no-go.  Instead you'd probably want to have a function that returns a tuple since it's immutable, and also provide a function for setting the sequence of callbacks directly.\n\nI'd say normally this goes against how the module is intended to be used, but if nothing else, as this case demonstrates, it may be useful for testing purposes to be able to do this through underscored methods as was the case in Python 2.  I'll bring it up...",
    "created_at": "2017-11-20T09:29:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366668",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jdemeyer](#comment%3A4):
> By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.

Writing a function to return a list would be easy.  The problem is that mutating that list would either have no effect, or would have to be propagated back to the internal array of callbacks.  So I think that would be a no-go.  Instead you'd probably want to have a function that returns a tuple since it's immutable, and also provide a function for setting the sequence of callbacks directly.

I'd say normally this goes against how the module is intended to be used, but if nothing else, as this case demonstrates, it may be useful for testing purposes to be able to do this through underscored methods as was the case in Python 2.  I'll bring it up...



---

archive/issue_comments_366669.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAdded an upstream report as well, but even if my idea, or something like it is accepted it will likely be at least until Python 3.7 that we could rely on it, so for now my code, or something like it, will serve as a workaround.",
    "created_at": "2017-11-20T09:58:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366669",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Added an upstream report as well, but even if my idea, or something like it is accepted it will likely be at least until Python 3.7 that we could rely on it, so for now my code, or something like it, will serve as a workaround.



---

archive/issue_comments_366670.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,3 +5,5 @@\n This is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.\n \n We might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.\n+\n+Upstream issue: https://bugs.python.org/issue32082\n``````\n",
    "created_at": "2017-11-20T09:58:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366670",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,3 +5,5 @@
 This is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.
 
 We might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.
+
+Upstream issue: https://bugs.python.org/issue32082
``````




---

archive/issue_comments_366671.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2017-11-20T09:58:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366671",
    "user": "https://github.com/embray"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_366672.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@embray](#comment%3A7):\n> for now my code, or something like it, will serve as a workaround.\n\nSure.",
    "created_at": "2017-11-20T13:52:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366672",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@embray](#comment%3A7):
> for now my code, or something like it, will serve as a workaround.

Sure.



---

archive/issue_comments_366673.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@embray](#comment%3A5):\n> I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.\n\nIt makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).",
    "created_at": "2017-11-20T13:57:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366673",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@embray](#comment%3A5):
> I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.

It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).



---

archive/issue_events_333289.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-20T14:02:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333289"
}
```



---

archive/issue_events_333290.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-20T14:02:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333290"
}
```



---

archive/issue_comments_366674.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2017-11-20T14:02:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366674",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_366675.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.",
    "created_at": "2017-11-20T14:02:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366675",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.



---

archive/issue_comments_366676.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nAlternatively, you could implement everything in one Cython file which is always compiled but which uses different internal logic depending on the Python version.",
    "created_at": "2017-11-20T14:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366676",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Alternatively, you could implement everything in one Cython file which is always compiled but which uses different internal logic depending on the Python version.



---

archive/issue_comments_366677.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.",
    "created_at": "2017-11-20T14:09:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366677",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.



---

archive/issue_comments_366678.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment%3A9):\n> Replying to [@embray](#comment%3A5):\n> > I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.\n\n> \n> It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).\n\nI don't really think about it that way, but it's not worth arguing over.",
    "created_at": "2017-11-20T14:55:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366678",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment%3A9):
> Replying to [@embray](#comment%3A5):
> > I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.

> 
> It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).

I don't really think about it that way, but it's not worth arguing over.



---

archive/issue_comments_366679.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@jdemeyer](#comment%3A10):\n> I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.\n\nAh, I didn't know about `OptionalExtension`.  The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that (or something equivalent that might come up even if I moved it).",
    "created_at": "2017-11-20T14:56:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366679",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@jdemeyer](#comment%3A10):
> I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.

Ah, I didn't know about `OptionalExtension`.  The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that (or something equivalent that might come up even if I moved it).



---

archive/issue_comments_366680.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jdemeyer](#comment%3A12):\n> I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.\n\nYeah, that might be fine too.  I would prefix those with an underscore but otherwise that makes sense.",
    "created_at": "2017-11-20T14:59:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366680",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jdemeyer](#comment%3A12):
> I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.

Yeah, that might be fine too.  I would prefix those with an underscore but otherwise that makes sense.



---

archive/issue_comments_366681.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@embray](#comment%3A14):\n> The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that\n\nCython is clever enough to deal with that. Extensions which are explicitly listed take precedence over extensions specified by a glob pattern. See for example\n\n```python\n    # Compile this with -Os because it works around a bug with\n    # GCC-4.7.3 + Cython 0.19 on Itanium, see Trac #14452. Moreover, it\n    # actually results in faster code than -O3.\n    Extension('sage.structure.element',\n              sources = ['sage/structure/element.pyx'],\n              extra_compile_args=[\"-Os\"]),\n\n    Extension('*', ['sage/structure/*.pyx']),\n```",
    "created_at": "2017-11-21T16:05:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366681",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@embray](#comment%3A14):
> The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that

Cython is clever enough to deal with that. Extensions which are explicitly listed take precedence over extensions specified by a glob pattern. See for example

```python
    # Compile this with -Os because it works around a bug with
    # GCC-4.7.3 + Cython 0.19 on Itanium, see Trac #14452. Moreover, it
    # actually results in faster code than -O3.
    Extension('sage.structure.element',
              sources = ['sage/structure/element.pyx'],
              extra_compile_args=["-Os"]),

    Extension('*', ['sage/structure/*.pyx']),
```



---

archive/issue_comments_366682.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOkay, I'll rework it that way then.  I will keep the `_py3` naming scheme though.",
    "created_at": "2017-11-21T16:56:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366682",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Okay, I'll rework it that way then.  I will keep the `_py3` naming scheme though.



---

archive/issue_comments_366683.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/34ef6dc08de5f11a74e83c6707d6dd4f5e2563be\"><code>34ef6dc</code></a></td><td><code>Add HAVE_GMPY2 compile-time constant</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/158d984a1263978ce941172c775238afbc32ad65\"><code>158d984</code></a></td><td><code>Force absolute import in have_module()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2\"><code>7f06e71</code></a></td><td><code>Fix documentation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ac146c17ccabbaf53918f874f516909041e82c5\"><code>3ac146c</code></a></td><td><code>Add a Cython compile-time constant for Python major version.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a4d63ae62cbfdf9fa4de777fb8357067efa69178\"><code>a4d63ae</code></a></td><td><code>Adds a context manager that can save and restore the state of the atexit</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/00394d3ffbb920ea04ba788cf080955a0d3bb01b\"><code>00394d3</code></a></td><td><code>Move to sage.cpython.atexit</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/83f207f02f0f269356b02f124b76827b6e9d6ad6\"><code>83f207f</code></a></td><td><code>Prevent segfault if the module state is somehow missing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/df21bb45a9626f6f20bce16619b3a17f9b97bb94\"><code>df21bb4</code></a></td><td><code>Deduplicate aspects of the implementation by splitting platform-specific bits into helper functions.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/01d5963f14761476e8eb242a36a7ebe795f3ce49\"><code>01d5963</code></a></td><td><code>The previous refactoring simplified things enough that it made more sense (and is ultimately more efficient) to combine both implementations into a single Cython module.</code></td></tr></table>\n",
    "created_at": "2017-12-01T17:04:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366683",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/34ef6dc08de5f11a74e83c6707d6dd4f5e2563be"><code>34ef6dc</code></a></td><td><code>Add HAVE_GMPY2 compile-time constant</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/158d984a1263978ce941172c775238afbc32ad65"><code>158d984</code></a></td><td><code>Force absolute import in have_module()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2"><code>7f06e71</code></a></td><td><code>Fix documentation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ac146c17ccabbaf53918f874f516909041e82c5"><code>3ac146c</code></a></td><td><code>Add a Cython compile-time constant for Python major version.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a4d63ae62cbfdf9fa4de777fb8357067efa69178"><code>a4d63ae</code></a></td><td><code>Adds a context manager that can save and restore the state of the atexit</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/00394d3ffbb920ea04ba788cf080955a0d3bb01b"><code>00394d3</code></a></td><td><code>Move to sage.cpython.atexit</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/83f207f02f0f269356b02f124b76827b6e9d6ad6"><code>83f207f</code></a></td><td><code>Prevent segfault if the module state is somehow missing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/df21bb45a9626f6f20bce16619b3a17f9b97bb94"><code>df21bb4</code></a></td><td><code>Deduplicate aspects of the implementation by splitting platform-specific bits into helper functions.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/01d5963f14761476e8eb242a36a7ebe795f3ce49"><code>01d5963</code></a></td><td><code>The previous refactoring simplified things enough that it made more sense (and is ultimately more efficient) to combine both implementations into a single Cython module.</code></td></tr></table>




---

archive/issue_comments_366684.json:
```json
{
    "body": "Changed commit from **[`7eb3f6b`](https://github.com/sagemath/sagetrac-mirror/commit/7eb3f6baf494e1288428700b11d70efd64e3d3a6)** to **[`01d5963`](https://github.com/sagemath/sagetrac-mirror/commit/01d5963f14761476e8eb242a36a7ebe795f3ce49)**",
    "created_at": "2017-12-01T17:04:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366684",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7eb3f6b`](https://github.com/sagemath/sagetrac-mirror/commit/7eb3f6baf494e1288428700b11d70efd64e3d3a6)** to **[`01d5963`](https://github.com/sagemath/sagetrac-mirror/commit/01d5963f14761476e8eb242a36a7ebe795f3ce49)**



---

archive/issue_comments_366685.json:
```json
{
    "body": "Dependencies: **#24246**",
    "created_at": "2017-12-01T17:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366685",
    "user": "https://github.com/embray"
}
```

Dependencies: **#24246**



---

archive/issue_comments_366686.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nMoved to `sage.cpython.atexit` and did some of the suggested refactoring.  At the end it ended up not being particularly useful (especially now that we have #24246) to split the Python 3 implementation off to a separate module, so I ended up recombining everything into a single Cython module.",
    "created_at": "2017-12-01T17:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366686",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

Moved to `sage.cpython.atexit` and did some of the suggested refactoring.  At the end it ended up not being particularly useful (especially now that we have #24246) to split the Python 3 implementation off to a separate module, so I ended up recombining everything into a single Cython module.



---

archive/issue_events_333291.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T17:05:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333291"
}
```



---

archive/issue_events_333292.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-01T17:05:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333292"
}
```



---

archive/issue_comments_366687.json:
```json
{
    "body": "Changed commit from **[`01d5963`](https://github.com/sagemath/sagetrac-mirror/commit/01d5963f14761476e8eb242a36a7ebe795f3ce49)** to **[`b5c0510`](https://github.com/sagemath/sagetrac-mirror/commit/b5c0510940c57543d587878613e17bdc956f64b3)**",
    "created_at": "2017-12-01T17:09:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366687",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`01d5963`](https://github.com/sagemath/sagetrac-mirror/commit/01d5963f14761476e8eb242a36a7ebe795f3ce49)** to **[`b5c0510`](https://github.com/sagemath/sagetrac-mirror/commit/b5c0510940c57543d587878613e17bdc956f64b3)**



---

archive/issue_comments_366688.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b5c0510940c57543d587878613e17bdc956f64b3\"><code>b5c0510</code></a></td><td><code>Meant to revert this</code></td></tr></table>\n",
    "created_at": "2017-12-01T17:09:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366688",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b5c0510940c57543d587878613e17bdc956f64b3"><code>b5c0510</code></a></td><td><code>Meant to revert this</code></td></tr></table>




---

archive/issue_comments_366689.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nGiven a positive review I'll also squash the commits into something more coherent.",
    "created_at": "2017-12-01T17:09:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366689",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Given a positive review I'll also squash the commits into something more coherent.



---

archive/issue_comments_366690.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nOverall, this looks good. There are various details to be fixed though:\n\n1. The title still says \"A home for miscellaneous context managers.\"\n\n2. You import `six` but don't use it.\n\n3. The doc of `restore_atexit` is misformatted. The correct format is\n\n```\n    EXAMPLES:\n\n    For this example...\n\n    ...of the ``atexit`` state::\n\n        sage: import atexit\n```\n\n4. I would move the comment \"# These are helper functions...\" outside of the `IF` block. There is also a typo: implements -> implementations.\n\n5. I find it mildly ugly that the signature of the helper functions is different in the Python 2 and Python 3 versions (`cdef inline list` vs. `def`) Since performance doesn't really matter here, I would make all functions simply Python (`def`) functions. Then they can be imported as usual.\n\n6. I think the doctest would be more clear by adding some `print` statements showing the list of registered handlers in appropriate places. Something like\n\n```\nsage: print(\"Initial exitfuncs: {}\".format(_get_exithandlers()))\n```\n\n7. Add a comment above `ctypedef struct atexit_callback:` that you are copying the internal structures of the `atexit` module, see `Modules/atexitmodule.c` in the Python sources.\n\n8. The Python 3 version of `_set_exithandlers` says \"Replace the list of exit handlers...\" but doesn't it instead *append* to the existing list?\n\n9. Add a test with an empty `restore_atexit():` context:\n\n```\nwith restore_atexit():\n    pass\n```\nshowing that the list of registered functions is the same before and after. That would have caught 8.",
    "created_at": "2017-12-01T19:45:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366690",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Overall, this looks good. There are various details to be fixed though:

1. The title still says "A home for miscellaneous context managers."

2. You import `six` but don't use it.

3. The doc of `restore_atexit` is misformatted. The correct format is

```
    EXAMPLES:

    For this example...

    ...of the ``atexit`` state::

        sage: import atexit
```

4. I would move the comment "# These are helper functions..." outside of the `IF` block. There is also a typo: implements -> implementations.

5. I find it mildly ugly that the signature of the helper functions is different in the Python 2 and Python 3 versions (`cdef inline list` vs. `def`) Since performance doesn't really matter here, I would make all functions simply Python (`def`) functions. Then they can be imported as usual.

6. I think the doctest would be more clear by adding some `print` statements showing the list of registered handlers in appropriate places. Something like

```
sage: print("Initial exitfuncs: {}".format(_get_exithandlers()))
```

7. Add a comment above `ctypedef struct atexit_callback:` that you are copying the internal structures of the `atexit` module, see `Modules/atexitmodule.c` in the Python sources.

8. The Python 3 version of `_set_exithandlers` says "Replace the list of exit handlers..." but doesn't it instead *append* to the existing list?

9. Add a test with an empty `restore_atexit():` context:

```
with restore_atexit():
    pass
```
showing that the list of registered functions is the same before and after. That would have caught 8.



---

archive/issue_events_333293.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-01T19:45:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333293"
}
```



---

archive/issue_events_333294.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-01T19:45:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333294"
}
```



---

archive/issue_comments_366691.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI don't agree with all of these, but I'll fix the obvious ones.",
    "created_at": "2017-12-04T10:44:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366691",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">comment:23</div>

I don't agree with all of these, but I'll fix the obvious ones.



---

archive/issue_comments_366692.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jdemeyer](#comment%3A22):\n> 8. The Python 3 version of `_set_exithandlers` says \"Replace the list of exit handlers...\" but doesn't it instead *append* to the existing list?\n\nThat's a good point--it should clear the existing list first.",
    "created_at": "2017-12-04T10:48:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366692",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jdemeyer](#comment%3A22):
> 8. The Python 3 version of `_set_exithandlers` says "Replace the list of exit handlers..." but doesn't it instead *append* to the existing list?

That's a good point--it should clear the existing list first.



---

archive/issue_comments_366693.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0d4c02d28233f78894015fbe4c8af1c4de1a4b38\"><code>0d4c02d</code></a></td><td><code>Minor cleanup</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c7d712f2ccba7ad8d1da7752b20655f680942d6c\"><code>c7d712f</code></a></td><td><code>Fix Python 3 version of _set_exithandlers to clear the exiting handlers first.</code></td></tr></table>\n",
    "created_at": "2017-12-04T11:26:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366693",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0d4c02d28233f78894015fbe4c8af1c4de1a4b38"><code>0d4c02d</code></a></td><td><code>Minor cleanup</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c7d712f2ccba7ad8d1da7752b20655f680942d6c"><code>c7d712f</code></a></td><td><code>Fix Python 3 version of _set_exithandlers to clear the exiting handlers first.</code></td></tr></table>




---

archive/issue_comments_366694.json:
```json
{
    "body": "Changed commit from **[`b5c0510`](https://github.com/sagemath/sagetrac-mirror/commit/b5c0510940c57543d587878613e17bdc956f64b3)** to **[`c7d712f`](https://github.com/sagemath/sagetrac-mirror/commit/c7d712f2ccba7ad8d1da7752b20655f680942d6c)**",
    "created_at": "2017-12-04T11:26:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366694",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b5c0510`](https://github.com/sagemath/sagetrac-mirror/commit/b5c0510940c57543d587878613e17bdc956f64b3)** to **[`c7d712f`](https://github.com/sagemath/sagetrac-mirror/commit/c7d712f2ccba7ad8d1da7752b20655f680942d6c)**



---

archive/issue_events_333295.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-04T11:26:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333295"
}
```



---

archive/issue_events_333296.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-04T11:26:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333296"
}
```



---

archive/issue_comments_366695.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,8 +2,4 @@\n \n This functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.\n \n-This is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.\n-\n-We might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.\n-\n Upstream issue: https://bugs.python.org/issue32082\n``````\n",
    "created_at": "2017-12-04T11:29:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366695",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,8 +2,4 @@
 
 This functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.
 
-This is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.
-
-We might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.
-
 Upstream issue: https://bugs.python.org/issue32082
``````




---

archive/issue_events_333297.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-04T13:05:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333297"
}
```



---

archive/issue_events_333298.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-04T13:05:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333298"
}
```



---

archive/issue_comments_366696.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nTwo more things before a positive review:\n\n1. `def _set_exithandlers(list exithandlers)`: remove `list` typing. We might as well allow arbitrary iterables.\n\n2. Add this new module to the documentation in `src/doc/en/reference/cpython/index.rst`",
    "created_at": "2017-12-04T13:05:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366696",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Two more things before a positive review:

1. `def _set_exithandlers(list exithandlers)`: remove `list` typing. We might as well allow arbitrary iterables.

2. Add this new module to the documentation in `src/doc/en/reference/cpython/index.rst`



---

archive/issue_comments_366697.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI'll add it to the docs but I'd rather otherwise leave the typing as is.  This is an internal function and there's no reason it will ever be passed anything but a list.",
    "created_at": "2017-12-04T13:16:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366697",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

I'll add it to the docs but I'd rather otherwise leave the typing as is.  This is an internal function and there's no reason it will ever be passed anything but a list.



---

archive/issue_events_333299.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:27:24Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333299"
}
```



---

archive/issue_events_333300.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:27:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333300"
}
```



---

archive/issue_comments_366698.json:
```json
{
    "body": "Changed commit from **[`c7d712f`](https://github.com/sagemath/sagetrac-mirror/commit/c7d712f2ccba7ad8d1da7752b20655f680942d6c)** to **[`a666148`](https://github.com/sagemath/sagetrac-mirror/commit/a66614810caefe24c7a68a226ca86001a10bad85)**",
    "created_at": "2018-01-04T15:27:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366698",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[`c7d712f`](https://github.com/sagemath/sagetrac-mirror/commit/c7d712f2ccba7ad8d1da7752b20655f680942d6c)** to **[`a666148`](https://github.com/sagemath/sagetrac-mirror/commit/a66614810caefe24c7a68a226ca86001a10bad85)**



---

archive/issue_events_333301.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-04T15:27:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333301"
}
```



---

archive/issue_events_333302.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-04T15:27:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333302"
}
```



---

archive/issue_comments_366699.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\ndone and done\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a87a017531baccde778bb841b8c3ac8375691811\"><code>a87a017</code></a></td><td><code>Merge branch 'u/embray/python3/restore-atexit' in 8.2.b2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a66614810caefe24c7a68a226ca86001a10bad85\"><code>a666148</code></a></td><td><code>trac 24234 details</code></td></tr></table>\n",
    "created_at": "2018-01-04T15:27:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366699",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:31" align="right">comment:31</div>

done and done

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a87a017531baccde778bb841b8c3ac8375691811"><code>a87a017</code></a></td><td><code>Merge branch 'u/embray/python3/restore-atexit' in 8.2.b2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a66614810caefe24c7a68a226ca86001a10bad85"><code>a666148</code></a></td><td><code>trac 24234 details</code></td></tr></table>




---

archive/issue_comments_366700.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/restore-atexit](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/restore-atexit)** to **[public/24234](https://github.com/sagemath/sagetrac-mirror/tree/public/24234)**",
    "created_at": "2018-01-04T15:27:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366700",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/embray/python3/restore-atexit](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/restore-atexit)** to **[public/24234](https://github.com/sagemath/sagetrac-mirror/tree/public/24234)**



---

archive/issue_comments_366701.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nOh, I forgot about this. Thanks.",
    "created_at": "2018-01-04T16:04:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366701",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Oh, I forgot about this. Thanks.



---

archive/issue_comments_366702.json:
```json
{
    "body": "<div id=\"comment:33\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e79f31acf039e73c3192f79fe311a0e6147402cb\"><code>e79f31a</code></a></td><td><code>Adds a context manager that can save and restore the state of the atexit</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aa67ea91866f13e1a635f94bf390151fb7cadde9\"><code>aa67ea9</code></a></td><td><code>trac 24234 details</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027\"><code>481f3b0</code></a></td><td><code>Fix documentation</code></td></tr></table>\n",
    "created_at": "2018-01-05T09:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366702",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e79f31acf039e73c3192f79fe311a0e6147402cb"><code>e79f31a</code></a></td><td><code>Adds a context manager that can save and restore the state of the atexit</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aa67ea91866f13e1a635f94bf390151fb7cadde9"><code>aa67ea9</code></a></td><td><code>trac 24234 details</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027"><code>481f3b0</code></a></td><td><code>Fix documentation</code></td></tr></table>




---

archive/issue_comments_366703.json:
```json
{
    "body": "Changed commit from **[`a666148`](https://github.com/sagemath/sagetrac-mirror/commit/a66614810caefe24c7a68a226ca86001a10bad85)** to **[`481f3b0`](https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027)**",
    "created_at": "2018-01-05T09:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366703",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a666148`](https://github.com/sagemath/sagetrac-mirror/commit/a66614810caefe24c7a68a226ca86001a10bad85)** to **[`481f3b0`](https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027)**



---

archive/issue_comments_366704.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nRebased, squashed and fixed docbuild issue. Back to patchbot testing.",
    "created_at": "2018-01-05T09:05:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366704",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

Rebased, squashed and fixed docbuild issue. Back to patchbot testing.



---

archive/issue_comments_366705.json:
```json
{
    "body": "Changed dependencies from **#24246** to none",
    "created_at": "2018-01-05T09:05:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366705",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#24246** to none



---

archive/issue_events_333303.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-08T14:24:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333303"
}
```



---

archive/issue_events_333304.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-08T14:24:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333304"
}
```



---

archive/issue_comments_366706.json:
```json
{
    "body": "Changed branch from **[public/24234](https://github.com/sagemath/sagetrac-mirror/tree/public/24234)** to **[`481f3b0`](https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027)**",
    "created_at": "2018-01-14T10:14:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24234#issuecomment-366706",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/24234](https://github.com/sagemath/sagetrac-mirror/tree/public/24234)** to **[`481f3b0`](https://github.com/sagemath/sagetrac-mirror/commit/481f3b0695f915a2382076a7ee5a5b3e03b79027)**



---

archive/issue_events_333305.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-14T10:14:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333305"
}
```



---

archive/issue_events_333306.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a15ce54aa8c93544081966ec5966458239db86be",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-01-14T10:14:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24234",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24234#event-333306"
}
```
