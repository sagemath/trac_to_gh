# Issue 24269: py3: first pass at getting pexpect interfaces working (gap + maxima)

archive/issues_024032.json:
```json
{
    "body": "With these changes, at the very least, I was able to get 1+1 working:\n\n```\nsage: gap('1+1;')\n2\nsage: maxima('1+1;')\n2\n```\n\nHowever, see #24268 for further discussion.\n\nKeywords: gap maxima\n\nBranch/Commit: 057668bcb5c23ecb49c4b908b401ec7d2ae958a0\n\nReviewer: Jeroen Demeyer, Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24269\n\n",
    "closed_at": "2018-05-24T07:10:56Z",
    "created_at": "2017-11-22T16:02:22Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "py3: first pass at getting pexpect interfaces working (gap + maxima)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24269",
    "user": "https://github.com/embray"
}
```
With these changes, at the very least, I was able to get 1+1 working:

```
sage: gap('1+1;')
2
sage: maxima('1+1;')
2
```

However, see #24268 for further discussion.

Keywords: gap maxima

Branch/Commit: 057668bcb5c23ecb49c4b908b401ec7d2ae958a0

Reviewer: Jeroen Demeyer, Frédéric Chapoton

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24269





---

archive/issue_comments_336499.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-27T10:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336499",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336500.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-22T16:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336500",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336501.json:
```json
{
    "body": "<a id='comment:3'></a>Comment in `sagespawn.pyx` is no longer correct. There is also a typo `targt`",
    "created_at": "2018-01-29T14:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336501",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Comment in `sagespawn.pyx` is no longer correct. There is also a typo `targt`



---

archive/issue_comments_336502.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-29T14:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336502",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336503.json:
```json
{
    "body": "<a id='comment:5'></a>Oh right--this commit is actually rather old at this point. I will just update the comment, rebase this, and squash.",
    "created_at": "2018-01-30T11:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336503",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Oh right--this commit is actually rather old at this point. I will just update the comment, rebase this, and squash.



---

archive/issue_comments_336504.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-02T10:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336504",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336505.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-02T10:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336505",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336506.json:
```json
{
    "body": "<a id='comment:7'></a>Fixed the comment in `SagePtyProcess`.  Not super happy with how loosely encodings are being used in the expect interfaces currently, but at the same time the vast majority of the text going in and out of them is ASCII anyways.  This is just a first pass.",
    "created_at": "2018-02-02T10:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336506",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Fixed the comment in `SagePtyProcess`.  Not super happy with how loosely encodings are being used in the expect interfaces currently, but at the same time the vast majority of the text going in and out of them is ASCII anyways.  This is just a first pass.



---

archive/issue_comments_336507.json:
```json
{
    "body": "<a id='comment:8'></a>Looks good to me. But I am a bit surprised by all these added `b` to turn strings to bytes..",
    "created_at": "2018-02-17T15:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336507",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>Looks good to me. But I am a bit surprised by all these added `b` to turn strings to bytes..



---

archive/issue_comments_336508.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-19T17:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336508",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336509.json:
```json
{
    "body": "<a id='comment:10'></a>In principle this commit is good, but I'd to know what your overall strategy is to deal with pexpect interfaces. Right now, it seems that you just plan to add explicit conversions between `bytes` and `str` everywhere. If pexpect only deals with `bytes`, perhaps we should write some specific methods to encode/decode to `str` and use those specific methods?",
    "created_at": "2018-02-20T14:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336509",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>In principle this commit is good, but I'd to know what your overall strategy is to deal with pexpect interfaces. Right now, it seems that you just plan to add explicit conversions between `bytes` and `str` everywhere. If pexpect only deals with `bytes`, perhaps we should write some specific methods to encode/decode to `str` and use those specific methods?



---

archive/issue_comments_336510.json:
```json
{
    "body": "<a id='comment:11'></a>I made #24268 for discussing overall strategy, but as you can see from this ticket and others the strategy I've gone with for now is leaving pexpect to deal in bytes, and sprinkle conversions all around.  I'm not particularly happy with this strategy and fear that it might backfire.\n\nAdding specific methods might not be a bad idea, and I've considered it. The `Expect` class (seemingly inexplicably) has a `_before()` method which just returns the `.before` attribute.  It's used in just a handful of places, and most other interfaces use `self._expect.before` directly.\n\nIt might make more sense to get rid of `Expect._before` but add an `Expect.before` property that wraps `self._expect.before` with the relevant string conversion (and likewise for `after`).  That might be a start in a better direction, anyways...",
    "created_at": "2018-02-20T17:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336510",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>I made #24268 for discussing overall strategy, but as you can see from this ticket and others the strategy I've gone with for now is leaving pexpect to deal in bytes, and sprinkle conversions all around.  I'm not particularly happy with this strategy and fear that it might backfire.

Adding specific methods might not be a bad idea, and I've considered it. The `Expect` class (seemingly inexplicably) has a `_before()` method which just returns the `.before` attribute.  It's used in just a handful of places, and most other interfaces use `self._expect.before` directly.

It might make more sense to get rid of `Expect._before` but add an `Expect.before` property that wraps `self._expect.before` with the relevant string conversion (and likewise for `after`).  That might be a start in a better direction, anyways...



---

archive/issue_comments_336511.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-12T12:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336511",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336512.json:
```json
{
    "body": "<a id='comment:13'></a>Reworked this a bit on top of #24957 which simplifies things a bit, reducing the number of manual `bytes_to_str` calls.",
    "created_at": "2018-03-12T12:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336512",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Reworked this a bit on top of #24957 which simplifies things a bit, reducing the number of manual `bytes_to_str` calls.



---

archive/issue_comments_336513.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-13T15:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336513",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336514.json:
```json
{
    "body": "<a id='comment:15'></a>Added a commit from my big python3 branch that really should have been included here (without it the fixes in this ticket actually crashed at sage startup).",
    "created_at": "2018-03-13T15:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336514",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Added a commit from my big python3 branch that really should have been included here (without it the fixes in this ticket actually crashed at sage startup).



---

archive/issue_comments_336515.json:
```json
{
    "body": "<a id='comment:16'></a>The patchbots report a doctest failure in singular expect interface.",
    "created_at": "2018-03-28T14:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336515",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>The patchbots report a doctest failure in singular expect interface.



---

archive/issue_comments_336516.json:
```json
{
    "body": "<a id='comment:17'></a>There's just a missing line in the doctest I added.",
    "created_at": "2018-03-28T16:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336516",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>There's just a missing line in the doctest I added.



---

archive/issue_comments_336517.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-28T16:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336517",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_061437.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24269#event-61437"
}
```



---

archive/issue_comments_336518.json:
```json
{
    "body": "<a id='comment:20'></a>We should really move on here now..",
    "created_at": "2018-05-17T08:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336518",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:20'></a>We should really move on here now..



---

archive/issue_comments_336519.json:
```json
{
    "body": "<a id='comment:21'></a>Okay? I agree...  Is there anything this still needs?",
    "created_at": "2018-05-17T15:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336519",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>Okay? I agree...  Is there anything this still needs?



---

archive/issue_comments_336520.json:
```json
{
    "body": "<a id='comment:22'></a>For me, its ok. Though I have not tried it with python3.\n\nJeroen, do you have some comments ?",
    "created_at": "2018-05-17T15:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336520",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:22'></a>For me, its ok. Though I have not tried it with python3.

Jeroen, do you have some comments ?



---

archive/issue_comments_336521.json:
```json
{
    "body": "<a id='comment:23'></a>rebased on 8.3.b2\n\n---\nNew commits:",
    "created_at": "2018-05-20T07:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336521",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>rebased on 8.3.b2

---
New commits:



---

archive/issue_comments_336522.json:
```json
{
    "body": "<a id='comment:24'></a>I have checked that this does fix the broken start of sage with py3.",
    "created_at": "2018-05-20T10:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336522",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:24'></a>I have checked that this does fix the broken start of sage with py3.



---

archive/issue_comments_336523.json:
```json
{
    "body": "<a id='comment:25'></a>But not quite doing as well as promised:\n\n```\nsage: gap('1+1;')\n2\nsage: maxima('1+1;')\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)\n   1355                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1356                                         for L in code.split('\\n') if L != ''])\n   1357                 else:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in <listcomp>(.0)\n   1355                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1356                                         for L in code.split('\\n') if L != ''])\n   1357                 else:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)\n    783 \n--> 784         self._synchronize()\n    785 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _synchronize(self)\n    853                 self._expect_expr(timeout=0.5)\n--> 854                 if not s in bytes_to_str(self._before()):\n    855                     self._expect_expr(s,timeout=0.5)\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1556)()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1410)()\n\nTypeError: expected bytes, str found\n\nDuring handling of the above exception, another exception occurred:\n\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-e25f09e1dc17> in <module>()\n----> 1 maxima('1+1;')\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in __call__(self, x, name)\n    278 \n    279         if isinstance(x, string_types):\n--> 280             return cls(self, x, name=name)\n    281         try:\n    282             return self._coerce_from_special_method(x)\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in __init__(self, parent, value, is_name, name)\n   1168             True\n   1169         \"\"\"\n-> 1170         ExpectElement.__init__(self, parent, value, is_name=False, name=None)\n   1171 \n   1172     def display2d(self, onscreen=True):\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)\n   1440         else:\n   1441             try:\n-> 1442                 self._name = parent._create(value, name=name)\n   1443             # Convert ValueError and RuntimeError to TypeError for\n   1444             # coercion to work properly.\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in _create(self, value, name)\n    474     def _create(self, value, name=None):\n    475         name = self._next_var_name() if name is None else name\n--> 476         self.set(name, value)\n    477         return name\n    478 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in set(self, var, value)\n   1013             self._batch(cmd, batchload=True)\n   1014         else:\n-> 1015             self._eval_line(cmd)\n   1016             #self._sendline(cmd)\n   1017             #self._expect_expr()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)\n    793             return repr(a)\n    794         else:\n--> 795             self._sendline(line)\n    796 \n    797         line_echo = self._readline()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _sendline(self, string)\n    654             '9'\n    655         \"\"\"\n--> 656         self._sendstr(string)\n    657         os.write(self._expect.child_fd, os.linesep.encode('ascii'))\n    658 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _sendstr(self, string)\n   1221         \"\"\"\n   1222         if self._expect is None:\n-> 1223             self._start()\n   1224         try:\n   1225             os.write(self._expect.child_fd, str_to_bytes(string))\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _start(self)\n    619 \n    620         \"\"\"\n--> 621         Expect._start(self)\n    622         self._sendline(r\":lisp (defun tex-derivative (x l r) (tex (if $derivabbrev (tex-dabbrev x) (tex-d x '\\\\partial)) l r lop rop ))\")\n    623 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _start(self, alt_message, block_during_init)\n    530             if block_during_init:\n    531                 for X in self.__init_code:\n--> 532                     self.eval(X)\n    533             else:\n    534                 for X in self.__init_code:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)\n   1361         # In particular, do NOT call self._keyboard_interrupt()\n   1362         except TypeError as s:\n-> 1363             raise TypeError('error evaluating \"%s\":\\n%s'%(code,s))\n   1364 \n   1365     ############################################################\n\nTypeError: error evaluating \"display2d : false\":\nexpected bytes, str found\n```",
    "created_at": "2018-05-20T10:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336523",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>But not quite doing as well as promised:

```
sage: gap('1+1;')
2
sage: maxima('1+1;')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1355                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1356                                         for L in code.split('\n') if L != ''])
   1357                 else:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in <listcomp>(.0)
   1355                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1356                                         for L in code.split('\n') if L != ''])
   1357                 else:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)
    783 
--> 784         self._synchronize()
    785 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _synchronize(self)
    853                 self._expect_expr(timeout=0.5)
--> 854                 if not s in bytes_to_str(self._before()):
    855                     self._expect_expr(s,timeout=0.5)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1556)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1410)()

TypeError: expected bytes, str found

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-2-e25f09e1dc17> in <module>()
----> 1 maxima('1+1;')

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    278 
    279         if isinstance(x, string_types):
--> 280             return cls(self, x, name=name)
    281         try:
    282             return self._coerce_from_special_method(x)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in __init__(self, parent, value, is_name, name)
   1168             True
   1169         """
-> 1170         ExpectElement.__init__(self, parent, value, is_name=False, name=None)
   1171 
   1172     def display2d(self, onscreen=True):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1440         else:
   1441             try:
-> 1442                 self._name = parent._create(value, name=name)
   1443             # Convert ValueError and RuntimeError to TypeError for
   1444             # coercion to work properly.

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in _create(self, value, name)
    474     def _create(self, value, name=None):
    475         name = self._next_var_name() if name is None else name
--> 476         self.set(name, value)
    477         return name
    478 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in set(self, var, value)
   1013             self._batch(cmd, batchload=True)
   1014         else:
-> 1015             self._eval_line(cmd)
   1016             #self._sendline(cmd)
   1017             #self._expect_expr()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)
    793             return repr(a)
    794         else:
--> 795             self._sendline(line)
    796 
    797         line_echo = self._readline()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _sendline(self, string)
    654             '9'
    655         """
--> 656         self._sendstr(string)
    657         os.write(self._expect.child_fd, os.linesep.encode('ascii'))
    658 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _sendstr(self, string)
   1221         """
   1222         if self._expect is None:
-> 1223             self._start()
   1224         try:
   1225             os.write(self._expect.child_fd, str_to_bytes(string))

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _start(self)
    619 
    620         """
--> 621         Expect._start(self)
    622         self._sendline(r":lisp (defun tex-derivative (x l r) (tex (if $derivabbrev (tex-dabbrev x) (tex-d x '\\partial)) l r lop rop ))")
    623 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _start(self, alt_message, block_during_init)
    530             if block_during_init:
    531                 for X in self.__init_code:
--> 532                     self.eval(X)
    533             else:
    534                 for X in self.__init_code:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1361         # In particular, do NOT call self._keyboard_interrupt()
   1362         except TypeError as s:
-> 1363             raise TypeError('error evaluating "%s":\n%s'%(code,s))
   1364 
   1365     ############################################################

TypeError: error evaluating "display2d : false":
expected bytes, str found
```



---

archive/issue_comments_336524.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-20T13:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336524",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336525.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-20T17:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336525",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336526.json:
```json
{
    "body": "<a id='comment:28'></a>Well, this used to work.  Let me see if I can fix it again.  There is a follow-up ticket somewhere that makes several more fixes to the expect interfaces.  This was just a small proof of concept change to get the bare minimum working.",
    "created_at": "2018-05-21T12:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336526",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'></a>Well, this used to work.  Let me see if I can fix it again.  There is a follow-up ticket somewhere that makes several more fixes to the expect interfaces.  This was just a small proof of concept change to get the bare minimum working.



---

archive/issue_comments_336527.json:
```json
{
    "body": "<a id='comment:29'></a>I'm going to set this back to my branch.  But I'll incorporate the fixes from pyflakes.",
    "created_at": "2018-05-21T12:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336527",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>I'm going to set this back to my branch.  But I'll incorporate the fixes from pyflakes.



---

archive/issue_comments_336528.json:
```json
{
    "body": "<a id='comment:30'></a>Ok, this should be working again, just at the bare minimum level promised by the original ticket description.\n\n---\nNew commits:",
    "created_at": "2018-05-21T13:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336528",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>Ok, this should be working again, just at the bare minimum level promised by the original ticket description.

---
New commits:



---

archive/issue_comments_336529.json:
```json
{
    "body": "<a id='comment:31'></a>I confirm that this works on python3. Let us wait for the python2-patchbot, and then it will be good to go.",
    "created_at": "2018-05-21T14:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336529",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:31'></a>I confirm that this works on python3. Let us wait for the python2-patchbot, and then it will be good to go.



---

archive/issue_comments_336530.json:
```json
{
    "body": "<a id='comment:32'></a>Huh. Weirdly a commit with the same message as 6c8a6f0 was already merged some time ago, but with different content.  Oh well, the text is still basically accurate...",
    "created_at": "2018-05-21T15:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336530",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Huh. Weirdly a commit with the same message as 6c8a6f0 was already merged some time ago, but with different content.  Oh well, the text is still basically accurate...



---

archive/issue_comments_336531.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-21T15:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336531",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336532.json:
```json
{
    "body": "<a id='comment:34'></a>checked again that it works with py3; now waiting for py2 patchbots",
    "created_at": "2018-05-21T16:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336532",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:34'></a>checked again that it works with py3; now waiting for py2 patchbots



---

archive/issue_comments_336533.json:
```json
{
    "body": "<a id='comment:35'></a>The patchbots report a doctest failure in singular expect interface. As in comment:16 !",
    "created_at": "2018-05-21T16:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336533",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:35'></a>The patchbots report a doctest failure in singular expect interface. As in comment:16 !



---

archive/issue_comments_336534.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-21T17:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336534",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336535.json:
```json
{
    "body": "<a id='comment:37'></a>checked once again that it works with py3; now waiting for py2 patchbots\n\nAlso, for the record,\n\n```\nsage: singular('1+1;')\n2\n```\nworks too.",
    "created_at": "2018-05-21T18:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336535",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:37'></a>checked once again that it works with py3; now waiting for py2 patchbots

Also, for the record,

```
sage: singular('1+1;')
2
```
works too.



---

archive/issue_comments_336536.json:
```json
{
    "body": "<a id='comment:38'></a>ok, let it be",
    "created_at": "2018-05-22T06:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336536",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:38'></a>ok, let it be



---

archive/issue_comments_336537.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-22T06:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336537",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061438.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-24T07:10:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24269#event-61438"
}
```



---

archive/issue_comments_336538.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-24T07:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24269#issuecomment-336538",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
