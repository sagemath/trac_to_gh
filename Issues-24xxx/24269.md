# Issue 24269: py3: first pass at getting pexpect interfaces working (gap + maxima)

archive/issues_024032.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nWith these changes, at the very least, I was able to get 1+1 working:\n\n```\nsage: gap('1+1;')\n2\nsage: maxima('1+1;')\n2\n```\n\nHowever, see #24268 for further discussion.\n\nComponent: **python3**\n\nKeywords: **gap maxima**\n\nAuthor: **Erik Bray**\n\nBranch/Commit: **[`057668b`](https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0)**\n\nReviewer: **Jeroen Demeyer, Fr\u00e9d\u00e9ric Chapoton**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24269_\n\n",
    "closed_at": "2018-05-24T07:10:56Z",
    "created_at": "2017-11-22T16:02:22Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: first pass at getting pexpect interfaces working (gap + maxima)",
    "type": "issue",
    "updated_at": "2018-05-24T07:10:56Z",
    "url": "https://github.com/sagemath/sage/issues/24269",
    "user": "https://github.com/embray"
}
```
<div id="comment:0"></div>

With these changes, at the very least, I was able to get 1+1 working:

```
sage: gap('1+1;')
2
sage: maxima('1+1;')
2
```

However, see #24268 for further discussion.

Component: **python3**

Keywords: **gap maxima**

Author: **Erik Bray**

Branch/Commit: **[`057668b`](https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0)**

Reviewer: **Jeroen Demeyer, Frédéric Chapoton**

_Issue created by migration from https://trac.sagemath.org/ticket/24269_





---

archive/issue_events_333760.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-22T16:02:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333760"
}
```



---

archive/issue_events_333761.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-22T16:02:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "0000b0",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333761"
}
```



---

archive/issue_events_333762.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-22T16:02:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333762"
}
```



---

archive/issue_events_333763.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-22T16:02:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333763"
}
```



---

archive/issue_comments_367304.json:
```json
{
    "body": "Dependencies: **#24222**",
    "created_at": "2017-11-27T10:35:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367304",
    "user": "https://github.com/embray"
}
```

Dependencies: **#24222**



---

archive/issue_events_333764.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-11-27T10:35:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333764"
}
```



---

archive/issue_comments_367305.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b893b4ea9dbccca02eb93a8fcb96305b68af8e91\"><code>b893b4e</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-22T16:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367305",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b893b4ea9dbccca02eb93a8fcb96305b68af8e91"><code>b893b4e</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>




---

archive/issue_comments_367306.json:
```json
{
    "body": "Changed commit from **[`9e76590`](https://github.com/sagemath/sagetrac-mirror/commit/9e76590bcadd83b8a384145445d4ac9f6f9074f0)** to **[`b893b4e`](https://github.com/sagemath/sagetrac-mirror/commit/b893b4ea9dbccca02eb93a8fcb96305b68af8e91)**",
    "created_at": "2018-01-22T16:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367306",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9e76590`](https://github.com/sagemath/sagetrac-mirror/commit/9e76590bcadd83b8a384145445d4ac9f6f9074f0)** to **[`b893b4e`](https://github.com/sagemath/sagetrac-mirror/commit/b893b4ea9dbccca02eb93a8fcb96305b68af8e91)**



---

archive/issue_comments_367307.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2018-01-29T14:19:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367307",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_367308.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nComment in `sagespawn.pyx` is no longer correct. There is also a typo `targt`",
    "created_at": "2018-01-29T14:19:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367308",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Comment in `sagespawn.pyx` is no longer correct. There is also a typo `targt`



---

archive/issue_events_333765.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-29T14:19:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333765"
}
```



---

archive/issue_events_333766.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-29T14:19:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333766"
}
```



---

archive/issue_comments_367309.json:
```json
{
    "body": "Changed dependencies from **#24222** to none",
    "created_at": "2018-01-29T14:19:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367309",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#24222** to none



---

archive/issue_comments_367310.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOh right--this commit is actually rather old at this point. I will just update the comment, rebase this, and squash.",
    "created_at": "2018-01-30T11:35:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367310",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

Oh right--this commit is actually rather old at this point. I will just update the comment, rebase this, and squash.



---

archive/issue_comments_367311.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8c5770b28d8727fc7d12cda2c0159153628e711f\"><code>8c5770b</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>\n",
    "created_at": "2018-02-02T10:21:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367311",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8c5770b28d8727fc7d12cda2c0159153628e711f"><code>8c5770b</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>




---

archive/issue_comments_367312.json:
```json
{
    "body": "Changed commit from **[`b893b4e`](https://github.com/sagemath/sagetrac-mirror/commit/b893b4ea9dbccca02eb93a8fcb96305b68af8e91)** to **[`8c5770b`](https://github.com/sagemath/sagetrac-mirror/commit/8c5770b28d8727fc7d12cda2c0159153628e711f)**",
    "created_at": "2018-02-02T10:21:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367312",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b893b4e`](https://github.com/sagemath/sagetrac-mirror/commit/b893b4ea9dbccca02eb93a8fcb96305b68af8e91)** to **[`8c5770b`](https://github.com/sagemath/sagetrac-mirror/commit/8c5770b28d8727fc7d12cda2c0159153628e711f)**



---

archive/issue_events_333767.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T10:23:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333767"
}
```



---

archive/issue_events_333768.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T10:23:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333768"
}
```



---

archive/issue_comments_367313.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nFixed the comment in `SagePtyProcess`.  Not super happy with how loosely encodings are being used in the expect interfaces currently, but at the same time the vast majority of the text going in and out of them is ASCII anyways.  This is just a first pass.",
    "created_at": "2018-02-02T10:23:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367313",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Fixed the comment in `SagePtyProcess`.  Not super happy with how loosely encodings are being used in the expect interfaces currently, but at the same time the vast majority of the text going in and out of them is ASCII anyways.  This is just a first pass.



---

archive/issue_comments_367314.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nLooks good to me. But I am a bit surprised by all these added `b` to turn strings to bytes..",
    "created_at": "2018-02-17T15:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367314",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:8" align="right">comment:8</div>

Looks good to me. But I am a bit surprised by all these added `b` to turn strings to bytes..



---

archive/issue_comments_367315.json:
```json
{
    "body": "Changed commit from **[`8c5770b`](https://github.com/sagemath/sagetrac-mirror/commit/8c5770b28d8727fc7d12cda2c0159153628e711f)** to **[`afb7643`](https://github.com/sagemath/sagetrac-mirror/commit/afb764397db3bbe00743efbbe43daa465eafd921)**",
    "created_at": "2018-02-19T17:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367315",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8c5770b`](https://github.com/sagemath/sagetrac-mirror/commit/8c5770b28d8727fc7d12cda2c0159153628e711f)** to **[`afb7643`](https://github.com/sagemath/sagetrac-mirror/commit/afb764397db3bbe00743efbbe43daa465eafd921)**



---

archive/issue_comments_367316.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/afb764397db3bbe00743efbbe43daa465eafd921\"><code>afb7643</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>\n",
    "created_at": "2018-02-19T17:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367316",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/afb764397db3bbe00743efbbe43daa465eafd921"><code>afb7643</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>




---

archive/issue_comments_367317.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nIn principle this commit is good, but I'd to know what your overall strategy is to deal with pexpect interfaces. Right now, it seems that you just plan to add explicit conversions between `bytes` and `str` everywhere. If pexpect only deals with `bytes`, perhaps we should write some specific methods to encode/decode to `str` and use those specific methods?",
    "created_at": "2018-02-20T14:11:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367317",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

In principle this commit is good, but I'd to know what your overall strategy is to deal with pexpect interfaces. Right now, it seems that you just plan to add explicit conversions between `bytes` and `str` everywhere. If pexpect only deals with `bytes`, perhaps we should write some specific methods to encode/decode to `str` and use those specific methods?



---

archive/issue_comments_367318.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI made #24268 for discussing overall strategy, but as you can see from this ticket and others the strategy I've gone with for now is leaving pexpect to deal in bytes, and sprinkle conversions all around.  I'm not particularly happy with this strategy and fear that it might backfire.\n\nAdding specific methods might not be a bad idea, and I've considered it. The `Expect` class (seemingly inexplicably) has a `_before()` method which just returns the `.before` attribute.  It's used in just a handful of places, and most other interfaces use `self._expect.before` directly.\n\nIt might make more sense to get rid of `Expect._before` but add an `Expect.before` property that wraps `self._expect.before` with the relevant string conversion (and likewise for `after`).  That might be a start in a better direction, anyways...",
    "created_at": "2018-02-20T17:08:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367318",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

I made #24268 for discussing overall strategy, but as you can see from this ticket and others the strategy I've gone with for now is leaving pexpect to deal in bytes, and sprinkle conversions all around.  I'm not particularly happy with this strategy and fear that it might backfire.

Adding specific methods might not be a bad idea, and I've considered it. The `Expect` class (seemingly inexplicably) has a `_before()` method which just returns the `.before` attribute.  It's used in just a handful of places, and most other interfaces use `self._expect.before` directly.

It might make more sense to get rid of `Expect._before` but add an `Expect.before` property that wraps `self._expect.before` with the relevant string conversion (and likewise for `after`).  That might be a start in a better direction, anyways...



---

archive/issue_comments_367319.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ccb5a7a0cd31e97dfab2d344412808655bb1f9a\"><code>0ccb5a7</code></a></td><td><code>call bytes_to_str from Expect._before(), and add an equivalent Expect._after();</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dae2109f47c3528f4da66cc1a879f9eb918c18dd\"><code>dae2109</code></a></td><td><code>Also supply a wrapper around spawn.readline that incorporates bytes_to_str</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/402879bc5a2c54375509ad549d57199df8833d7a\"><code>402879b</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>\n",
    "created_at": "2018-03-12T12:35:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367319",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ccb5a7a0cd31e97dfab2d344412808655bb1f9a"><code>0ccb5a7</code></a></td><td><code>call bytes_to_str from Expect._before(), and add an equivalent Expect._after();</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dae2109f47c3528f4da66cc1a879f9eb918c18dd"><code>dae2109</code></a></td><td><code>Also supply a wrapper around spawn.readline that incorporates bytes_to_str</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/402879bc5a2c54375509ad549d57199df8833d7a"><code>402879b</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr></table>




---

archive/issue_comments_367320.json:
```json
{
    "body": "Changed commit from **[`afb7643`](https://github.com/sagemath/sagetrac-mirror/commit/afb764397db3bbe00743efbbe43daa465eafd921)** to **[`402879b`](https://github.com/sagemath/sagetrac-mirror/commit/402879bc5a2c54375509ad549d57199df8833d7a)**",
    "created_at": "2018-03-12T12:35:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367320",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`afb7643`](https://github.com/sagemath/sagetrac-mirror/commit/afb764397db3bbe00743efbbe43daa465eafd921)** to **[`402879b`](https://github.com/sagemath/sagetrac-mirror/commit/402879bc5a2c54375509ad549d57199df8833d7a)**



---

archive/issue_comments_367321.json:
```json
{
    "body": "Dependencies: **#24957**",
    "created_at": "2018-03-12T12:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367321",
    "user": "https://github.com/embray"
}
```

Dependencies: **#24957**



---

archive/issue_comments_367322.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReworked this a bit on top of #24957 which simplifies things a bit, reducing the number of manual `bytes_to_str` calls.",
    "created_at": "2018-03-12T12:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367322",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

Reworked this a bit on top of #24957 which simplifies things a bit, reducing the number of manual `bytes_to_str` calls.



---

archive/issue_comments_367323.json:
```json
{
    "body": "Changed commit from **[`402879b`](https://github.com/sagemath/sagetrac-mirror/commit/402879bc5a2c54375509ad549d57199df8833d7a)** to **[`8c44501`](https://github.com/sagemath/sagetrac-mirror/commit/8c44501f8310861a66a32cb8d555243f2519e936)**",
    "created_at": "2018-03-13T15:01:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367323",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`402879b`](https://github.com/sagemath/sagetrac-mirror/commit/402879bc5a2c54375509ad549d57199df8833d7a)** to **[`8c44501`](https://github.com/sagemath/sagetrac-mirror/commit/8c44501f8310861a66a32cb8d555243f2519e936)**



---

archive/issue_comments_367324.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8c44501f8310861a66a32cb8d555243f2519e936\"><code>8c44501</code></a></td><td><code>Additional Python 3 fixes to the Maxima interface:</code></td></tr></table>\n",
    "created_at": "2018-03-13T15:01:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367324",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8c44501f8310861a66a32cb8d555243f2519e936"><code>8c44501</code></a></td><td><code>Additional Python 3 fixes to the Maxima interface:</code></td></tr></table>




---

archive/issue_comments_367325.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAdded a commit from my big python3 branch that really should have been included here (without it the fixes in this ticket actually crashed at sage startup).",
    "created_at": "2018-03-13T15:02:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367325",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

Added a commit from my big python3 branch that really should have been included here (without it the fixes in this ticket actually crashed at sage startup).



---

archive/issue_comments_367326.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThe patchbots report a doctest failure in singular expect interface.",
    "created_at": "2018-03-28T14:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367326",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:16" align="right">comment:16</div>

The patchbots report a doctest failure in singular expect interface.



---

archive/issue_comments_367327.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThere's just a missing line in the doctest I added.",
    "created_at": "2018-03-28T16:38:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367327",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

There's just a missing line in the doctest I added.



---

archive/issue_comments_367328.json:
```json
{
    "body": "Changed commit from **[`8c44501`](https://github.com/sagemath/sagetrac-mirror/commit/8c44501f8310861a66a32cb8d555243f2519e936)** to **[`d59717e`](https://github.com/sagemath/sagetrac-mirror/commit/d59717e1d3716b51b98631279ccd577a375f1b61)**",
    "created_at": "2018-03-28T16:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367328",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8c44501`](https://github.com/sagemath/sagetrac-mirror/commit/8c44501f8310861a66a32cb8d555243f2519e936)** to **[`d59717e`](https://github.com/sagemath/sagetrac-mirror/commit/d59717e1d3716b51b98631279ccd577a375f1b61)**



---

archive/issue_comments_367329.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d59717e1d3716b51b98631279ccd577a375f1b61\"><code>d59717e</code></a></td><td><code>Add missing line to doctest</code></td></tr></table>\n",
    "created_at": "2018-03-28T16:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367329",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d59717e1d3716b51b98631279ccd577a375f1b61"><code>d59717e</code></a></td><td><code>Add missing line to doctest</code></td></tr></table>




---

archive/issue_events_333769.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333769"
}
```



---

archive/issue_events_333770.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333770"
}
```



---

archive/issue_comments_367330.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nWe should really move on here now..",
    "created_at": "2018-05-17T08:47:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367330",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:20" align="right">comment:20</div>

We should really move on here now..



---

archive/issue_comments_367331.json:
```json
{
    "body": "Changed dependencies from **#24957** to none",
    "created_at": "2018-05-17T08:47:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367331",
    "user": "https://github.com/fchapoton"
}
```

Changed dependencies from **#24957** to none



---

archive/issue_comments_367332.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOkay? I agree...  Is there anything this still needs?",
    "created_at": "2018-05-17T15:48:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367332",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Okay? I agree...  Is there anything this still needs?



---

archive/issue_comments_367333.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nFor me, its ok. Though I have not tried it with python3.\n\nJeroen, do you have some comments ?",
    "created_at": "2018-05-17T15:49:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367333",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:22" align="right">comment:22</div>

For me, its ok. Though I have not tried it with python3.

Jeroen, do you have some comments ?



---

archive/issue_comments_367334.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/pexpect-gap-maxima](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/pexpect-gap-maxima)** to **[public/ticket/24269](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/24269)**",
    "created_at": "2018-05-20T07:11:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367334",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/embray/python3/pexpect-gap-maxima](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/pexpect-gap-maxima)** to **[public/ticket/24269](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/24269)**



---

archive/issue_comments_367335.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nrebased on 8.3.b2\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c545cf0667bdea4db4eb6637915e6f9a4d5d78a0\"><code>c545cf0</code></a></td><td><code>Merge branch 'u/embray/python3/pexpect-gap-maxima' in 8.3.b2</code></td></tr></table>\n",
    "created_at": "2018-05-20T07:11:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367335",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:23" align="right">comment:23</div>

rebased on 8.3.b2

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c545cf0667bdea4db4eb6637915e6f9a4d5d78a0"><code>c545cf0</code></a></td><td><code>Merge branch 'u/embray/python3/pexpect-gap-maxima' in 8.3.b2</code></td></tr></table>




---

archive/issue_comments_367336.json:
```json
{
    "body": "Changed commit from **[`d59717e`](https://github.com/sagemath/sagetrac-mirror/commit/d59717e1d3716b51b98631279ccd577a375f1b61)** to **[`c545cf0`](https://github.com/sagemath/sagetrac-mirror/commit/c545cf0667bdea4db4eb6637915e6f9a4d5d78a0)**",
    "created_at": "2018-05-20T07:11:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367336",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[`d59717e`](https://github.com/sagemath/sagetrac-mirror/commit/d59717e1d3716b51b98631279ccd577a375f1b61)** to **[`c545cf0`](https://github.com/sagemath/sagetrac-mirror/commit/c545cf0667bdea4db4eb6637915e6f9a4d5d78a0)**



---

archive/issue_comments_367337.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI have checked that this does fix the broken start of sage with py3.",
    "created_at": "2018-05-20T10:01:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367337",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:24" align="right">comment:24</div>

I have checked that this does fix the broken start of sage with py3.



---

archive/issue_comments_367338.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nBut not quite doing as well as promised:\n\n```\nsage: gap('1+1;')\n2\nsage: maxima('1+1;')\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)\n   1355                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1356                                         for L in code.split('\\n') if L != ''])\n   1357                 else:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in <listcomp>(.0)\n   1355                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1356                                         for L in code.split('\\n') if L != ''])\n   1357                 else:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)\n    783 \n--> 784         self._synchronize()\n    785 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _synchronize(self)\n    853                 self._expect_expr(timeout=0.5)\n--> 854                 if not s in bytes_to_str(self._before()):\n    855                     self._expect_expr(s,timeout=0.5)\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1556)()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1410)()\n\nTypeError: expected bytes, str found\n\nDuring handling of the above exception, another exception occurred:\n\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-e25f09e1dc17> in <module>()\n----> 1 maxima('1+1;')\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in __call__(self, x, name)\n    278 \n    279         if isinstance(x, string_types):\n--> 280             return cls(self, x, name=name)\n    281         try:\n    282             return self._coerce_from_special_method(x)\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in __init__(self, parent, value, is_name, name)\n   1168             True\n   1169         \"\"\"\n-> 1170         ExpectElement.__init__(self, parent, value, is_name=False, name=None)\n   1171 \n   1172     def display2d(self, onscreen=True):\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)\n   1440         else:\n   1441             try:\n-> 1442                 self._name = parent._create(value, name=name)\n   1443             # Convert ValueError and RuntimeError to TypeError for\n   1444             # coercion to work properly.\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in _create(self, value, name)\n    474     def _create(self, value, name=None):\n    475         name = self._next_var_name() if name is None else name\n--> 476         self.set(name, value)\n    477         return name\n    478 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in set(self, var, value)\n   1013             self._batch(cmd, batchload=True)\n   1014         else:\n-> 1015             self._eval_line(cmd)\n   1016             #self._sendline(cmd)\n   1017             #self._expect_expr()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)\n    793             return repr(a)\n    794         else:\n--> 795             self._sendline(line)\n    796 \n    797         line_echo = self._readline()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _sendline(self, string)\n    654             '9'\n    655         \"\"\"\n--> 656         self._sendstr(string)\n    657         os.write(self._expect.child_fd, os.linesep.encode('ascii'))\n    658 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _sendstr(self, string)\n   1221         \"\"\"\n   1222         if self._expect is None:\n-> 1223             self._start()\n   1224         try:\n   1225             os.write(self._expect.child_fd, str_to_bytes(string))\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _start(self)\n    619 \n    620         \"\"\"\n--> 621         Expect._start(self)\n    622         self._sendline(r\":lisp (defun tex-derivative (x l r) (tex (if $derivabbrev (tex-dabbrev x) (tex-d x '\\\\partial)) l r lop rop ))\")\n    623 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _start(self, alt_message, block_during_init)\n    530             if block_during_init:\n    531                 for X in self.__init_code:\n--> 532                     self.eval(X)\n    533             else:\n    534                 for X in self.__init_code:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)\n   1361         # In particular, do NOT call self._keyboard_interrupt()\n   1362         except TypeError as s:\n-> 1363             raise TypeError('error evaluating \"%s\":\\n%s'%(code,s))\n   1364 \n   1365     ############################################################\n\nTypeError: error evaluating \"display2d : false\":\nexpected bytes, str found\n```",
    "created_at": "2018-05-20T10:10:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367338",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:25" align="right">comment:25</div>

But not quite doing as well as promised:

```
sage: gap('1+1;')
2
sage: maxima('1+1;')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1355                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1356                                         for L in code.split('\n') if L != ''])
   1357                 else:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in <listcomp>(.0)
   1355                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1356                                         for L in code.split('\n') if L != ''])
   1357                 else:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)
    783 
--> 784         self._synchronize()
    785 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _synchronize(self)
    853                 self._expect_expr(timeout=0.5)
--> 854                 if not s in bytes_to_str(self._before()):
    855                     self._expect_expr(s,timeout=0.5)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1556)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1410)()

TypeError: expected bytes, str found

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-2-e25f09e1dc17> in <module>()
----> 1 maxima('1+1;')

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    278 
    279         if isinstance(x, string_types):
--> 280             return cls(self, x, name=name)
    281         try:
    282             return self._coerce_from_special_method(x)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in __init__(self, parent, value, is_name, name)
   1168             True
   1169         """
-> 1170         ExpectElement.__init__(self, parent, value, is_name=False, name=None)
   1171 
   1172     def display2d(self, onscreen=True):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1440         else:
   1441             try:
-> 1442                 self._name = parent._create(value, name=name)
   1443             # Convert ValueError and RuntimeError to TypeError for
   1444             # coercion to work properly.

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/interface.py in _create(self, value, name)
    474     def _create(self, value, name=None):
    475         name = self._next_var_name() if name is None else name
--> 476         self.set(name, value)
    477         return name
    478 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in set(self, var, value)
   1013             self._batch(cmd, batchload=True)
   1014         else:
-> 1015             self._eval_line(cmd)
   1016             #self._sendline(cmd)
   1017             #self._expect_expr()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _eval_line(self, line, allow_use_file, wait_for_prompt, reformat, error_check, restart_if_needed)
    793             return repr(a)
    794         else:
--> 795             self._sendline(line)
    796 
    797         line_echo = self._readline()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _sendline(self, string)
    654             '9'
    655         """
--> 656         self._sendstr(string)
    657         os.write(self._expect.child_fd, os.linesep.encode('ascii'))
    658 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _sendstr(self, string)
   1221         """
   1222         if self._expect is None:
-> 1223             self._start()
   1224         try:
   1225             os.write(self._expect.child_fd, str_to_bytes(string))

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/maxima.py in _start(self)
    619 
    620         """
--> 621         Expect._start(self)
    622         self._sendline(r":lisp (defun tex-derivative (x l r) (tex (if $derivabbrev (tex-dabbrev x) (tex-d x '\\partial)) l r lop rop ))")
    623 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in _start(self, alt_message, block_during_init)
    530             if block_during_init:
    531                 for X in self.__init_code:
--> 532                     self.eval(X)
    533             else:
    534                 for X in self.__init_code:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1361         # In particular, do NOT call self._keyboard_interrupt()
   1362         except TypeError as s:
-> 1363             raise TypeError('error evaluating "%s":\n%s'%(code,s))
   1364 
   1365     ############################################################

TypeError: error evaluating "display2d : false":
expected bytes, str found
```



---

archive/issue_comments_367339.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9d984e22009667d7492dd48d8d7e05a4fee40e52\"><code>9d984e2</code></a></td><td><code>just pyflakes fix</code></td></tr></table>\n",
    "created_at": "2018-05-20T13:03:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367339",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9d984e22009667d7492dd48d8d7e05a4fee40e52"><code>9d984e2</code></a></td><td><code>just pyflakes fix</code></td></tr></table>




---

archive/issue_comments_367340.json:
```json
{
    "body": "Changed commit from **[`c545cf0`](https://github.com/sagemath/sagetrac-mirror/commit/c545cf0667bdea4db4eb6637915e6f9a4d5d78a0)** to **[`9d984e2`](https://github.com/sagemath/sagetrac-mirror/commit/9d984e22009667d7492dd48d8d7e05a4fee40e52)**",
    "created_at": "2018-05-20T13:03:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367340",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c545cf0`](https://github.com/sagemath/sagetrac-mirror/commit/c545cf0667bdea4db4eb6637915e6f9a4d5d78a0)** to **[`9d984e2`](https://github.com/sagemath/sagetrac-mirror/commit/9d984e22009667d7492dd48d8d7e05a4fee40e52)**



---

archive/issue_comments_367341.json:
```json
{
    "body": "Changed commit from **[`9d984e2`](https://github.com/sagemath/sagetrac-mirror/commit/9d984e22009667d7492dd48d8d7e05a4fee40e52)** to **[`28b894f`](https://github.com/sagemath/sagetrac-mirror/commit/28b894fb3faeeb3e8a8697dea6615f827697b65e)**",
    "created_at": "2018-05-20T17:58:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367341",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9d984e2`](https://github.com/sagemath/sagetrac-mirror/commit/9d984e22009667d7492dd48d8d7e05a4fee40e52)** to **[`28b894f`](https://github.com/sagemath/sagetrac-mirror/commit/28b894fb3faeeb3e8a8697dea6615f827697b65e)**



---

archive/issue_comments_367342.json:
```json
{
    "body": "<div id=\"comment:27\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/28b894fb3faeeb3e8a8697dea6615f827697b65e\"><code>28b894f</code></a></td><td><code>undo import removal</code></td></tr></table>\n",
    "created_at": "2018-05-20T17:58:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367342",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:27"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/28b894fb3faeeb3e8a8697dea6615f827697b65e"><code>28b894f</code></a></td><td><code>undo import removal</code></td></tr></table>




---

archive/issue_comments_367343.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nWell, this used to work.  Let me see if I can fix it again.  There is a follow-up ticket somewhere that makes several more fixes to the expect interfaces.  This was just a small proof of concept change to get the bare minimum working.",
    "created_at": "2018-05-21T12:10:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367343",
    "user": "https://github.com/embray"
}
```

<div id="comment:28" align="right">comment:28</div>

Well, this used to work.  Let me see if I can fix it again.  There is a follow-up ticket somewhere that makes several more fixes to the expect interfaces.  This was just a small proof of concept change to get the bare minimum working.



---

archive/issue_comments_367344.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI'm going to set this back to my branch.  But I'll incorporate the fixes from pyflakes.",
    "created_at": "2018-05-21T12:19:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367344",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

I'm going to set this back to my branch.  But I'll incorporate the fixes from pyflakes.



---

archive/issue_comments_367345.json:
```json
{
    "body": "Changed branch from **[public/ticket/24269](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/24269)** to **[u/embray/python3/pexpect-gap-maxima](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/pexpect-gap-maxima)**",
    "created_at": "2018-05-21T13:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367345",
    "user": "https://github.com/embray"
}
```

Changed branch from **[public/ticket/24269](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/24269)** to **[u/embray/python3/pexpect-gap-maxima](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/pexpect-gap-maxima)**



---

archive/issue_comments_367346.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nOk, this should be working again, just at the bare minimum level promised by the original ticket description.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3f08a183661403ffde313b97b224536dffe025ab\"><code>3f08a18</code></a></td><td><code>Also supply a wrapper around spawn.readline that incorporates bytes_to_str</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6c8a6f038d2fbab5c25743ba17327f5727e474b5\"><code>6c8a6f0</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4a6a72afe589b0813a2b5fa3d56e5d808b17bc2c\"><code>4a6a72a</code></a></td><td><code>just pyflakes fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d4bcc594280000fe5efa3391717d2abd974dec7\"><code>3d4bcc5</code></a></td><td><code>undo import removal</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/25409dc6bf6c74fc5c0563305007feb8d3e4f8ea\"><code>25409dc</code></a></td><td><code>the base class now provides the expectation that self._prompt is already bytes</code></td></tr></table>\n",
    "created_at": "2018-05-21T13:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367346",
    "user": "https://github.com/embray"
}
```

<div id="comment:30" align="right">comment:30</div>

Ok, this should be working again, just at the bare minimum level promised by the original ticket description.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3f08a183661403ffde313b97b224536dffe025ab"><code>3f08a18</code></a></td><td><code>Also supply a wrapper around spawn.readline that incorporates bytes_to_str</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6c8a6f038d2fbab5c25743ba17327f5727e474b5"><code>6c8a6f0</code></a></td><td><code>Update SagePtyProcess and the Maxima and GAP pexpect interfaces to handle bytes roughly appropriately on Python 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4a6a72afe589b0813a2b5fa3d56e5d808b17bc2c"><code>4a6a72a</code></a></td><td><code>just pyflakes fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d4bcc594280000fe5efa3391717d2abd974dec7"><code>3d4bcc5</code></a></td><td><code>undo import removal</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/25409dc6bf6c74fc5c0563305007feb8d3e4f8ea"><code>25409dc</code></a></td><td><code>the base class now provides the expectation that self._prompt is already bytes</code></td></tr></table>




---

archive/issue_comments_367347.json:
```json
{
    "body": "Changed commit from **[`28b894f`](https://github.com/sagemath/sagetrac-mirror/commit/28b894fb3faeeb3e8a8697dea6615f827697b65e)** to **[`25409dc`](https://github.com/sagemath/sagetrac-mirror/commit/25409dc6bf6c74fc5c0563305007feb8d3e4f8ea)**",
    "created_at": "2018-05-21T13:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367347",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`28b894f`](https://github.com/sagemath/sagetrac-mirror/commit/28b894fb3faeeb3e8a8697dea6615f827697b65e)** to **[`25409dc`](https://github.com/sagemath/sagetrac-mirror/commit/25409dc6bf6c74fc5c0563305007feb8d3e4f8ea)**



---

archive/issue_comments_367348.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI confirm that this works on python3. Let us wait for the python2-patchbot, and then it will be good to go.",
    "created_at": "2018-05-21T14:28:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367348",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:31" align="right">comment:31</div>

I confirm that this works on python3. Let us wait for the python2-patchbot, and then it will be good to go.



---

archive/issue_comments_367349.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nHuh. Weirdly a commit with the same message as 6c8a6f0 was already merged some time ago, but with different content.  Oh well, the text is still basically accurate...",
    "created_at": "2018-05-21T15:05:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367349",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Huh. Weirdly a commit with the same message as 6c8a6f0 was already merged some time ago, but with different content.  Oh well, the text is still basically accurate...



---

archive/issue_comments_367350.json:
```json
{
    "body": "Changed commit from **[`25409dc`](https://github.com/sagemath/sagetrac-mirror/commit/25409dc6bf6c74fc5c0563305007feb8d3e4f8ea)** to **[`df96d07`](https://github.com/sagemath/sagetrac-mirror/commit/df96d07cad7a72216895962e9b642e3830f83fd9)**",
    "created_at": "2018-05-21T15:11:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367350",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`25409dc`](https://github.com/sagemath/sagetrac-mirror/commit/25409dc6bf6c74fc5c0563305007feb8d3e4f8ea)** to **[`df96d07`](https://github.com/sagemath/sagetrac-mirror/commit/df96d07cad7a72216895962e9b642e3830f83fd9)**



---

archive/issue_comments_367351.json:
```json
{
    "body": "<div id=\"comment:33\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/df96d07cad7a72216895962e9b642e3830f83fd9\"><code>df96d07</code></a></td><td><code>Additional Python 3 fixes to the Maxima interface:</code></td></tr></table>\n",
    "created_at": "2018-05-21T15:11:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367351",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/df96d07cad7a72216895962e9b642e3830f83fd9"><code>df96d07</code></a></td><td><code>Additional Python 3 fixes to the Maxima interface:</code></td></tr></table>




---

archive/issue_comments_367352.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nchecked again that it works with py3; now waiting for py2 patchbots",
    "created_at": "2018-05-21T16:09:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367352",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:34" align="right">comment:34</div>

checked again that it works with py3; now waiting for py2 patchbots



---

archive/issue_comments_367353.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nThe patchbots report a doctest failure in singular expect interface. As in [comment:16](#comment%3A16) !",
    "created_at": "2018-05-21T16:28:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367353",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:35" align="right">comment:35</div>

The patchbots report a doctest failure in singular expect interface. As in [comment:16](#comment%3A16) !



---

archive/issue_comments_367354.json:
```json
{
    "body": "Changed commit from **[`df96d07`](https://github.com/sagemath/sagetrac-mirror/commit/df96d07cad7a72216895962e9b642e3830f83fd9)** to **[`057668b`](https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0)**",
    "created_at": "2018-05-21T17:13:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367354",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`df96d07`](https://github.com/sagemath/sagetrac-mirror/commit/df96d07cad7a72216895962e9b642e3830f83fd9)** to **[`057668b`](https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0)**



---

archive/issue_comments_367355.json:
```json
{
    "body": "<div id=\"comment:36\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0\"><code>057668b</code></a></td><td><code>Add missing line to doctest</code></td></tr></table>\n",
    "created_at": "2018-05-21T17:13:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367355",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:36"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0"><code>057668b</code></a></td><td><code>Add missing line to doctest</code></td></tr></table>




---

archive/issue_comments_367356.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nchecked once again that it works with py3; now waiting for py2 patchbots\n\nAlso, for the record,\n\n```\nsage: singular('1+1;')\n2\n```\nworks too.",
    "created_at": "2018-05-21T18:59:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367356",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:37" align="right">comment:37</div>

checked once again that it works with py3; now waiting for py2 patchbots

Also, for the record,

```
sage: singular('1+1;')
2
```
works too.



---

archive/issue_comments_367357.json:
```json
{
    "body": "Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2018-05-22T06:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367357",
    "user": "https://github.com/fchapoton"
}
```

Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Frédéric Chapoton**



---

archive/issue_comments_367358.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nok, let it be",
    "created_at": "2018-05-22T06:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367358",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:38" align="right">comment:38</div>

ok, let it be



---

archive/issue_events_333771.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-22T06:27:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333771"
}
```



---

archive/issue_events_333772.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-22T06:27:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333772"
}
```



---

archive/issue_events_333773.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-24T07:10:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333773"
}
```



---

archive/issue_events_333774.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "76b74053cc50b916d8f0e06841bca38d26cf0690",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-05-24T07:10:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24269#event-333774"
}
```



---

archive/issue_comments_367359.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/pexpect-gap-maxima](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/pexpect-gap-maxima)** to **[`057668b`](https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0)**",
    "created_at": "2018-05-24T07:10:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24269#issuecomment-367359",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/python3/pexpect-gap-maxima](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/pexpect-gap-maxima)** to **[`057668b`](https://github.com/sagemath/sagetrac-mirror/commit/057668bcb5c23ecb49c4b908b401ec7d2ae958a0)**
