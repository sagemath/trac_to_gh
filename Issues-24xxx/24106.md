# Issue 24106: Install packages in temporary root before copying to $SAGE_LOCAL (simplified)

archive/issues_023869.json:
```json
{
    "body": "This is a stripped-down version of the patch in #22509, demonstrating the bare minimum functionality required to support staged installation via `DESTDIR`.  It does not add support for this to all packages as #22509 does.  That will require additional followups.\n\nIn particular, this supports passing a `SAGE_DESTDIR` variable to spkg build scripts.  In the case of packages installed with `make install`, this is passed to `make` as `DESTDIR=$SAGE_DESTDIR`.  Not all packages that use make support this (but most do).  For those that don't this is a no-op. The `sage-spkg` command then takes advantage of this by setting `$SAGE_DESTDIR` to a standard value before running the package build/install scripts.  It then uses the temporary install directory to generate a manifest for the package.  Currently this can be seen in action with the `patch` package (the only package currently using `sdh_make_install`).  With this patch applied:\n\n```\n$ ./sage -f patch\n...\n$ cat local/var/lib/sage/installed/patch-2.7.5\n{\n    \"package_name\": \"patch\",\n    \"package_version\": \"2.7.5\",\n    \"install_date\": \"Wed Oct 25 14:32:16 UTC 2017\",\n    \"system_uname\": \"Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\",\n    \"sage_version\": \"SageMath version 8.1.beta7, Release Date: 2017-10-03\",\n    \"test_result\": \"\",\n    \"files\": [\n        \"bin/patch\",\n        \"share/man/man1/patch.1\"\n    ]\n}\n```\n\nThe installed files are listed relative to `$SAGE_LOCAL`, and does not include empty directories (in a git-like manner).  This is because directories are not typically owned by a single package, only files.  In the rare case where an empty directory needs to be owned by a specific package, a placeholder file should be added to that directory (this is typical in some Linux distributions as well).\n\nThe same could be done easily for Python packages by having `sdh_pip_install` add `--root=${SAGE_DESTDIR}`, but currently that breaks a tiny set of Python packages whose build scripts do not fully support this kind of staged installation, so their case will be addressed separately.\n\n**CC:**  @mkoeppe @jdemeyer jhpalimieri\n\n**Branch/Commit:** [97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039](https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039)\n\n**Reviewer:** Dima Pasechnik, Jeroen Demeyer\n\n**Author:** Erik Bray\n\n**Dependencies:** #24017\n\nIssue created by migration from https://trac.sagemath.org/ticket/24106\n\n",
    "closed_at": "2018-01-20T20:20:20Z",
    "created_at": "2017-10-25T14:52:55Z",
    "labels": [
        "component: build",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Install packages in temporary root before copying to $SAGE_LOCAL (simplified)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24106",
    "user": "https://github.com/embray"
}
```
This is a stripped-down version of the patch in #22509, demonstrating the bare minimum functionality required to support staged installation via `DESTDIR`.  It does not add support for this to all packages as #22509 does.  That will require additional followups.

In particular, this supports passing a `SAGE_DESTDIR` variable to spkg build scripts.  In the case of packages installed with `make install`, this is passed to `make` as `DESTDIR=$SAGE_DESTDIR`.  Not all packages that use make support this (but most do).  For those that don't this is a no-op. The `sage-spkg` command then takes advantage of this by setting `$SAGE_DESTDIR` to a standard value before running the package build/install scripts.  It then uses the temporary install directory to generate a manifest for the package.  Currently this can be seen in action with the `patch` package (the only package currently using `sdh_make_install`).  With this patch applied:

```
$ ./sage -f patch
...
$ cat local/var/lib/sage/installed/patch-2.7.5
{
    "package_name": "patch",
    "package_version": "2.7.5",
    "install_date": "Wed Oct 25 14:32:16 UTC 2017",
    "system_uname": "Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux",
    "sage_version": "SageMath version 8.1.beta7, Release Date: 2017-10-03",
    "test_result": "",
    "files": [
        "bin/patch",
        "share/man/man1/patch.1"
    ]
}
```

The installed files are listed relative to `$SAGE_LOCAL`, and does not include empty directories (in a git-like manner).  This is because directories are not typically owned by a single package, only files.  In the rare case where an empty directory needs to be owned by a specific package, a placeholder file should be added to that directory (this is typical in some Linux distributions as well).

The same could be done easily for Python packages by having `sdh_pip_install` add `--root=${SAGE_DESTDIR}`, but currently that breaks a tiny set of Python packages whose build scripts do not fully support this kind of staged installation, so their case will be addressed separately.

**CC:**  @mkoeppe @jdemeyer jhpalimieri

**Branch/Commit:** [97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039](https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039)

**Reviewer:** Dima Pasechnik, Jeroen Demeyer

**Author:** Erik Bray

**Dependencies:** #24017

Issue created by migration from https://trac.sagemath.org/ticket/24106





---

archive/issue_comments_436463.json:
```json
{
    "body": "<a id='comment:1'></a>\nCC'd people who have already shown interest in this work.",
    "created_at": "2017-10-25T14:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436463",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
CC'd people who have already shown interest in this work.



---

archive/issue_comments_436464.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2017-10-25T14:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436464",
    "user": "https://github.com/embray"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_436465.json:
```json
{
    "body": "<a id='comment:2'></a>\nDepends on #24017 for merge consistency.",
    "created_at": "2017-10-25T14:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436465",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Depends on #24017 for merge consistency.



---

archive/issue_comments_436466.json:
```json
{
    "body": "**Dependencies:** #24017",
    "created_at": "2017-10-25T14:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436466",
    "user": "https://github.com/embray"
}
```

**Dependencies:** #24017



---

archive/issue_comments_436467.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aa61235596bc867ece2e5b2996d54be290157cc7\">aa61235</a></td><td><code>Fix typo in comment</code></td></tr></table>\n",
    "created_at": "2017-10-25T15:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436467",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aa61235596bc867ece2e5b2996d54be290157cc7">aa61235</a></td><td><code>Fix typo in comment</code></td></tr></table>




---

archive/issue_comments_436468.json:
```json
{
    "body": "**Changing commit** from \"[5be15df378dadda50289eb7fd0158eda77583750](https://github.com/sagemath/sagetrac-mirror/commit/5be15df378dadda50289eb7fd0158eda77583750)\" to \"[aa61235596bc867ece2e5b2996d54be290157cc7](https://github.com/sagemath/sagetrac-mirror/commit/aa61235596bc867ece2e5b2996d54be290157cc7)\".",
    "created_at": "2017-10-25T15:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436468",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5be15df378dadda50289eb7fd0158eda77583750](https://github.com/sagemath/sagetrac-mirror/commit/5be15df378dadda50289eb7fd0158eda77583750)" to "[aa61235596bc867ece2e5b2996d54be290157cc7](https://github.com/sagemath/sagetrac-mirror/commit/aa61235596bc867ece2e5b2996d54be290157cc7)".



---

archive/issue_comments_436469.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe patchbot failure is due to #24092 so I'm going to merge that *sigh*",
    "created_at": "2017-10-31T15:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436469",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
The patchbot failure is due to #24092 so I'm going to merge that *sigh*



---

archive/issue_comments_436470.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6dd69fd79f45218a900bd4fb98a98d2ec0480138\">6dd69fd</a></td><td><code>Add pip to brial's dependencies, replace the use of PIP_INSTALL as per #24014.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4d0ad4ef0d35074d389421ef530253614d488398\">4d0ad4e</a></td><td><code>Merge branch 'u/fbissey/brial_pip' into u/embray/build/destdir-2</code></td></tr></table>\n",
    "created_at": "2017-10-31T15:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436470",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6dd69fd79f45218a900bd4fb98a98d2ec0480138">6dd69fd</a></td><td><code>Add pip to brial's dependencies, replace the use of PIP_INSTALL as per #24014.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4d0ad4ef0d35074d389421ef530253614d488398">4d0ad4e</a></td><td><code>Merge branch 'u/fbissey/brial_pip' into u/embray/build/destdir-2</code></td></tr></table>




---

archive/issue_comments_436471.json:
```json
{
    "body": "**Changing commit** from \"[aa61235596bc867ece2e5b2996d54be290157cc7](https://github.com/sagemath/sagetrac-mirror/commit/aa61235596bc867ece2e5b2996d54be290157cc7)\" to \"[4d0ad4ef0d35074d389421ef530253614d488398](https://github.com/sagemath/sagetrac-mirror/commit/4d0ad4ef0d35074d389421ef530253614d488398)\".",
    "created_at": "2017-10-31T15:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436471",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[aa61235596bc867ece2e5b2996d54be290157cc7](https://github.com/sagemath/sagetrac-mirror/commit/aa61235596bc867ece2e5b2996d54be290157cc7)" to "[4d0ad4ef0d35074d389421ef530253614d488398](https://github.com/sagemath/sagetrac-mirror/commit/4d0ad4ef0d35074d389421ef530253614d488398)".



---

archive/issue_comments_436472.json:
```json
{
    "body": "<a id='comment:6'></a>\nWhat is the proof of concept package to test with this ticket? It's not clear to me.",
    "created_at": "2017-11-27T16:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436472",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
What is the proof of concept package to test with this ticket? It's not clear to me.



---

archive/issue_comments_436473.json:
```json
{
    "body": "<a id='comment:7'></a>\nPatch, mainly.",
    "created_at": "2017-11-27T16:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436473",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Patch, mainly.



---

archive/issue_comments_436474.json:
```json
{
    "body": "<a id='comment:8'></a>\nI'm getting a 500 Internal Server Error when clicking the branch on this ticket.",
    "created_at": "2017-11-28T09:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436474",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
I'm getting a 500 Internal Server Error when clicking the branch on this ticket.



---

archive/issue_comments_436475.json:
```json
{
    "body": "<a id='comment:9'></a>\nWhat is `$(pwd)` in this case?\n\n```\nexport SAGE_DESTDIR=\"$(pwd)/inst\"\n```\nCan we be more explicit and write\n\n```\nexport SAGE_DESTDIR=\"${SAGE_BUILD_DIR}/${PKG_NAME}/inst\"\n```",
    "created_at": "2017-11-28T09:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436475",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
What is `$(pwd)` in this case?

```
export SAGE_DESTDIR="$(pwd)/inst"
```
Can we be more explicit and write

```
export SAGE_DESTDIR="${SAGE_BUILD_DIR}/${PKG_NAME}/inst"
```



---

archive/issue_comments_436476.json:
```json
{
    "body": "<a id='comment:10'></a>\nI'd rather wait until #24025 has been merged in a beta before fully reviewing this.",
    "created_at": "2017-11-28T09:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436476",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
I'd rather wait until #24025 has been merged in a beta before fully reviewing this.



---

archive/issue_comments_436477.json:
```json
{
    "body": "<a id='comment:11'></a>\nWell the \"milestone\" for #24025 is set to 8.1, but that is apparently meaningless...",
    "created_at": "2017-11-28T13:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436477",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
Well the "milestone" for #24025 is set to 8.1, but that is apparently meaningless...



---

archive/issue_events_069233.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:27:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24106#event-69233"
}
```



---

archive/issue_comments_436478.json:
```json
{
    "body": "<a id='comment:13'></a>\nwith `ccache` installed, I get a problem with this ticket; it tries to rebuild `ccache`, and at the very end of the installation of `ccache` I get\n\n```\nCopying package files from temporary location /home/dima/Sage/sage-dev/local/var/tmp/sage/build/ccache-3.2.2.p0/inst to /home/dima/Sage/sage-dev/local\ncp: cannot create regular file '/home/dima/Sage/sage-dev/local/bin/ccache': Text file busy\n************************************************************************\nError copying files for ccache.\n************************************************************************\n```\n\nSo probably one needs to somehow uninstall ccache beforehand...",
    "created_at": "2017-12-18T10:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436478",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>
with `ccache` installed, I get a problem with this ticket; it tries to rebuild `ccache`, and at the very end of the installation of `ccache` I get

```
Copying package files from temporary location /home/dima/Sage/sage-dev/local/var/tmp/sage/build/ccache-3.2.2.p0/inst to /home/dima/Sage/sage-dev/local
cp: cannot create regular file '/home/dima/Sage/sage-dev/local/bin/ccache': Text file busy
************************************************************************
Error copying files for ccache.
************************************************************************
```

So probably one needs to somehow uninstall ccache beforehand...



---

archive/issue_comments_436479.json:
```json
{
    "body": "<a id='comment:14'></a>\n1. As mentioned in [comment:9], it would be nice to more explicit here:\n\n```\nexport SAGE_DESTDIR=\"$(pwd)/inst\"\n```\n\n2. It could possibly be a lot more efficient (and also simpler) to *move* instead of *copy* the files from `SAGE_DESTDIR` to `SAGE_LOCAL`. Is there any good reason to keep the files in `SAGE_DESTDIR`?",
    "created_at": "2018-01-05T10:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436479",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
1. As mentioned in [comment:9], it would be nice to more explicit here:

```
export SAGE_DESTDIR="$(pwd)/inst"
```

2. It could possibly be a lot more efficient (and also simpler) to *move* instead of *copy* the files from `SAGE_DESTDIR` to `SAGE_LOCAL`. Is there any good reason to keep the files in `SAGE_DESTDIR`?



---

archive/issue_comments_436480.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2018-01-05T10:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436480",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_436481.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [dimpase](#comment%3A13):\n> `cp: cannot create regular file '/home/dima/Sage/sage-dev/local/bin/ccache': Text file busy`\n\n\nThis is also fixed by moving instead of copying (on my Linux box at least, but that might be POSIX-specified behaviour)",
    "created_at": "2018-01-05T10:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436481",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [dimpase](#comment%3A13):
> `cp: cannot create regular file '/home/dima/Sage/sage-dev/local/bin/ccache': Text file busy`


This is also fixed by moving instead of copying (on my Linux box at least, but that might be POSIX-specified behaviour)



---

archive/issue_comments_436482.json:
```json
{
    "body": "<a id='comment:16'></a>\nOn occasion I've found it useful for debugging purposes to be able to inspect the contents of the destdir.  That said, as long as the system is working correctly, the results can just as easily be inspected directly in `$SAGE_LOCAL`, so I wouldn't be opposed to giving move a try.",
    "created_at": "2018-01-05T12:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436482",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
On occasion I've found it useful for debugging purposes to be able to inspect the contents of the destdir.  That said, as long as the system is working correctly, the results can just as easily be inspected directly in `$SAGE_LOCAL`, so I wouldn't be opposed to giving move a try.



---

archive/issue_comments_436483.json:
```json
{
    "body": "**Changing commit** from \"[4d0ad4ef0d35074d389421ef530253614d488398](https://github.com/sagemath/sagetrac-mirror/commit/4d0ad4ef0d35074d389421ef530253614d488398)\" to \"[c0cb165d227eee2c2c7bd4014acee542a2865051](https://github.com/sagemath/sagetrac-mirror/commit/c0cb165d227eee2c2c7bd4014acee542a2865051)\".",
    "created_at": "2018-01-15T10:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436483",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[4d0ad4ef0d35074d389421ef530253614d488398](https://github.com/sagemath/sagetrac-mirror/commit/4d0ad4ef0d35074d389421ef530253614d488398)" to "[c0cb165d227eee2c2c7bd4014acee542a2865051](https://github.com/sagemath/sagetrac-mirror/commit/c0cb165d227eee2c2c7bd4014acee542a2865051)".



---

archive/issue_comments_436484.json:
```json
{
    "body": "<a id='comment:17'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce7e0a44383eb38ba1d746616d758ae1e12737e2\">ce7e0a4</a></td><td><code>Add the ability to temporarily install to an alternate installation root</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c0cb165d227eee2c2c7bd4014acee542a2865051\">c0cb165</a></td><td><code>Fix typo in comment</code></td></tr></table>\n",
    "created_at": "2018-01-15T10:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce7e0a44383eb38ba1d746616d758ae1e12737e2">ce7e0a4</a></td><td><code>Add the ability to temporarily install to an alternate installation root</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c0cb165d227eee2c2c7bd4014acee542a2865051">c0cb165</a></td><td><code>Fix typo in comment</code></td></tr></table>




---

archive/issue_comments_436485.json:
```json
{
    "body": "<a id='comment:18'></a>\nTurns out this is also broken until and unless at least a few packages get some small updates to their spkg-installs to support this mode of installation.",
    "created_at": "2018-01-15T10:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436485",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
Turns out this is also broken until and unless at least a few packages get some small updates to their spkg-installs to support this mode of installation.



---

archive/issue_comments_436486.json:
```json
{
    "body": "<a id='comment:19'></a>\nwhat are these small updates? are they already in?",
    "created_at": "2018-01-15T11:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436486",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
what are these small updates? are they already in?



---

archive/issue_comments_436487.json:
```json
{
    "body": "<a id='comment:20'></a>\nNo, I'll push them to this branch once I know what they are (i.e. after the build completes successfully).  I think it's small enough for now that it's okay to roll into this.",
    "created_at": "2018-01-15T15:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436487",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
No, I'll push them to this branch once I know what they are (i.e. after the build completes successfully).  I think it's small enough for now that it's okay to roll into this.



---

archive/issue_comments_436488.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [embray](#comment%3A20):\n> No, I'll push them to this branch once I know what they are (i.e. after the build completes successfully).  I think it's small enough for now that it's okay to roll into this.\n\n\nIf it turns out to be more I'll split it out.  This is mostly a matter of some packages that were updated in #24025 that perform a few additional actions on files in `$SAGE_LOCAL` that really should be working on `$SAGE_DESTDIR$SAGE_LOCAL`.",
    "created_at": "2018-01-15T15:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436488",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
Replying to [embray](#comment%3A20):
> No, I'll push them to this branch once I know what they are (i.e. after the build completes successfully).  I think it's small enough for now that it's okay to roll into this.


If it turns out to be more I'll split it out.  This is mostly a matter of some packages that were updated in #24025 that perform a few additional actions on files in `$SAGE_LOCAL` that really should be working on `$SAGE_DESTDIR$SAGE_LOCAL`.



---

archive/issue_comments_436489.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6bc73324b370910856165b7dc3673c227d83db2d\">6bc7332</a></td><td><code>Make $SAGE_DESTDIR explicitly relative to $SAGE_BUILD_DIR, and not whatever</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ed41210d578b395009e76a50e38b1987c0e0fa2d\">ed41210</a></td><td><code>Move files from SAGE_DESTDIR into SAGE_LOCAL instead of copying.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/91dfc131ed8d0b98a87d50c10d16f05cd0df8b1d\">91dfc13</a></td><td><code>ecl: create post-build links in SAGE_DESTDIR instead of directly in SAGE_LOCAL</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/edf5898ef0ca0d40e6d44a6fa613f3f51c330a8b\">edf5898</a></td><td><code>mpfi: perform this sanity check relative to $SAGE_DESTDIR</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1398d1dc63059066819d31491d0335aa1550827c\">1398d1d</a></td><td><code>patch: On Cygwin, ensure the .manifest file is installed relative to $SAGE_DESTDIR</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039\">97ebe8e</a></td><td><code>readline: these post-build steps should be performed relative to $SAGE_DESTDIR</code></td></tr></table>\n",
    "created_at": "2018-01-16T12:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436489",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6bc73324b370910856165b7dc3673c227d83db2d">6bc7332</a></td><td><code>Make $SAGE_DESTDIR explicitly relative to $SAGE_BUILD_DIR, and not whatever</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ed41210d578b395009e76a50e38b1987c0e0fa2d">ed41210</a></td><td><code>Move files from SAGE_DESTDIR into SAGE_LOCAL instead of copying.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/91dfc131ed8d0b98a87d50c10d16f05cd0df8b1d">91dfc13</a></td><td><code>ecl: create post-build links in SAGE_DESTDIR instead of directly in SAGE_LOCAL</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/edf5898ef0ca0d40e6d44a6fa613f3f51c330a8b">edf5898</a></td><td><code>mpfi: perform this sanity check relative to $SAGE_DESTDIR</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1398d1dc63059066819d31491d0335aa1550827c">1398d1d</a></td><td><code>patch: On Cygwin, ensure the .manifest file is installed relative to $SAGE_DESTDIR</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039">97ebe8e</a></td><td><code>readline: these post-build steps should be performed relative to $SAGE_DESTDIR</code></td></tr></table>




---

archive/issue_comments_436490.json:
```json
{
    "body": "**Changing commit** from \"[c0cb165d227eee2c2c7bd4014acee542a2865051](https://github.com/sagemath/sagetrac-mirror/commit/c0cb165d227eee2c2c7bd4014acee542a2865051)\" to \"[97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039](https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039)\".",
    "created_at": "2018-01-16T12:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436490",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[c0cb165d227eee2c2c7bd4014acee542a2865051](https://github.com/sagemath/sagetrac-mirror/commit/c0cb165d227eee2c2c7bd4014acee542a2865051)" to "[97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039](https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039)".



---

archive/issue_comments_436491.json:
```json
{
    "body": "<a id='comment:23'></a>\nI added the aforementioned tweaks.  It's likely others are needed, but these were the minimal fixes I needed for a successful build from scratch.\n\nThe one change that's a bit sketchy is the removal of the \"sanity check\" from patch's `spkg-install`.  I really don't think it's needed at all, but if we really wanted to keep it it would make more sense as a post-install step.\n\n#22509 has a feature of allowing packages to include a `spkg-postinst` script that is run on the package after it's already been fully copied into `$SAGE_LOCAL`.  I left it out of this ticket to keep things simple, but I could add it back in, as it doesn't add very much complexity at all.",
    "created_at": "2018-01-16T12:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436491",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>
I added the aforementioned tweaks.  It's likely others are needed, but these were the minimal fixes I needed for a successful build from scratch.

The one change that's a bit sketchy is the removal of the "sanity check" from patch's `spkg-install`.  I really don't think it's needed at all, but if we really wanted to keep it it would make more sense as a post-install step.

#22509 has a feature of allowing packages to include a `spkg-postinst` script that is run on the package after it's already been fully copied into `$SAGE_LOCAL`.  I left it out of this ticket to keep things simple, but I could add it back in, as it doesn't add very much complexity at all.



---

archive/issue_comments_436492.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2018-01-16T14:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436492",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_436493.json:
```json
{
    "body": "<a id='comment:25'></a>\nLooks good on first sight. Am I right that this affects only packages using `sdh_make_install`?",
    "created_at": "2018-01-16T15:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436493",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
Looks good on first sight. Am I right that this affects only packages using `sdh_make_install`?



---

archive/issue_comments_436494.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [jdemeyer](#comment%3A25):\n> Looks good on first sight. Am I right that this affects only packages using `sdh_make_install`?\n\n\nRight now, yes.  Obviously long-term it will affect all packages (as is the case for the original #22509), but for this ticket those are the only packages that are affected.",
    "created_at": "2018-01-16T16:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436494",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>
Replying to [jdemeyer](#comment%3A25):
> Looks good on first sight. Am I right that this affects only packages using `sdh_make_install`?


Right now, yes.  Obviously long-term it will affect all packages (as is the case for the original #22509), but for this ticket those are the only packages that are affected.



---

archive/issue_comments_436495.json:
```json
{
    "body": "<a id='comment:27'></a>\nIs blocking internet access to unknown ports \"a thing\" in France? I'm in Besan\u00e7on right now and both the university network as well as my hotel network block SSH access (on a non-standard port) to a testing machine that I use for testing build-related tickets such as this one. I'd rather not reinstall Sage from scratch on my laptop, so could you please double-check that `make distclean; make ptest` passes with this ticket applied?",
    "created_at": "2018-01-16T18:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436495",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>
Is blocking internet access to unknown ports "a thing" in France? I'm in Besançon right now and both the university network as well as my hotel network block SSH access (on a non-standard port) to a testing machine that I use for testing build-related tickets such as this one. I'd rather not reinstall Sage from scratch on my laptop, so could you please double-check that `make distclean; make ptest` passes with this ticket applied?



---

archive/issue_comments_436496.json:
```json
{
    "body": "<a id='comment:28'></a>\nI don't think it's \"a thing\" in France any more than it is at any other random network.  I've also had problems at my university with very tight firewalls.",
    "created_at": "2018-01-17T12:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436496",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'></a>
I don't think it's "a thing" in France any more than it is at any other random network.  I've also had problems at my university with very tight firewalls.



---

archive/issue_comments_436497.json:
```json
{
    "body": "<a id='comment:29'></a>\nI feel like I just tested that that works yesterday, but I'll do it one more time....",
    "created_at": "2018-01-17T12:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436497",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>
I feel like I just tested that that works yesterday, but I'll do it one more time....



---

archive/issue_comments_436498.json:
```json
{
    "body": "<a id='comment:30'></a>\nThe recent build failure of this on the Cygwin patchbot appears to be unrelated, though it's not entirely clear to me what happened.  I have a feeling there are still some unresolved race conditions involved in running DLL rebase.",
    "created_at": "2018-01-17T13:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436498",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>
The recent build failure of this on the Cygwin patchbot appears to be unrelated, though it's not entirely clear to me what happened.  I have a feeling there are still some unresolved race conditions involved in running DLL rebase.



---

archive/issue_comments_436499.json:
```json
{
    "body": "<a id='comment:31'></a>\nConfirmed, build from scratch worked, at least on Linux.  I'm going to try on OSX too.  I now have (supposedly) access to an OSX machine to test on, though I haven't actually tried building Sage on it yet...",
    "created_at": "2018-01-17T15:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436499",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>
Confirmed, build from scratch worked, at least on Linux.  I'm going to try on OSX too.  I now have (supposedly) access to an OSX machine to test on, though I haven't actually tried building Sage on it yet...



---

archive/issue_comments_436500.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [embray](#comment%3A31):\n> Confirmed, build from scratch worked, at least on Linux.  I'm going to try on OSX too.  I now have (supposedly) access to an OSX machine to test on, though I haven't actually tried building Sage on it yet...\n\n\nI am using an OSX machine at LRI, trac.lri.fr, to run tests, etc.\nIf it's the same as you mean to use, it's probably better not to try doing it at the same time...\n\nIf you like I can test this branch there, as I'm planning to try the new beta from scratch anyway.",
    "created_at": "2018-01-18T09:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436500",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>
Replying to [embray](#comment%3A31):
> Confirmed, build from scratch worked, at least on Linux.  I'm going to try on OSX too.  I now have (supposedly) access to an OSX machine to test on, though I haven't actually tried building Sage on it yet...


I am using an OSX machine at LRI, trac.lri.fr, to run tests, etc.
If it's the same as you mean to use, it's probably better not to try doing it at the same time...

If you like I can test this branch there, as I'm planning to try the new beta from scratch anyway.



---

archive/issue_comments_436501.json:
```json
{
    "body": "<a id='comment:33'></a>\nPlease do test!",
    "created_at": "2018-01-18T09:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436501",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
Please do test!



---

archive/issue_comments_436502.json:
```json
{
    "body": "<a id='comment:34'></a>\nWorked fine for me on Cygwin locally--whatever went wrong with the patchbot is probably an unrelated fluke.",
    "created_at": "2018-01-18T10:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436502",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
Worked fine for me on Cygwin locally--whatever went wrong with the patchbot is probably an unrelated fluke.



---

archive/issue_comments_436503.json:
```json
{
    "body": "<a id='comment:35'></a>\nit builds on OSX just fine. Any other tests to run?",
    "created_at": "2018-01-19T01:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436503",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>
it builds on OSX just fine. Any other tests to run?



---

archive/issue_comments_436504.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [dimpase](#comment%3A35):\n> it builds on OSX just fine.\n\n\nThanks for checking that!\n\n> Any other tests to run?\n\n\nNot as far as I'm concerned.  It might be nice to get a patch bot to say it's good.  I think I'm going to reconfigure the docker patchbot to run \"unsafe\" tickets.",
    "created_at": "2018-01-19T09:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436504",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>
Replying to [dimpase](#comment%3A35):
> it builds on OSX just fine.


Thanks for checking that!

> Any other tests to run?


Not as far as I'm concerned.  It might be nice to get a patch bot to say it's good.  I think I'm going to reconfigure the docker patchbot to run "unsafe" tickets.



---

archive/issue_comments_436505.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik, Jeroen Demeyer",
    "created_at": "2018-01-19T09:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436505",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Dima Pasechnik, Jeroen Demeyer



---

archive/issue_comments_436506.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-01-19T09:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436506",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_436507.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/build/destdir-2](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-2)\" to \"[97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039](https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039)\".",
    "created_at": "2018-01-20T20:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24106#issuecomment-436507",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/embray/build/destdir-2](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-2)" to "[97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039](https://github.com/sagemath/sagetrac-mirror/commit/97ebe8e6bdeb6ed2db9fd0d2374107b7b5fd8039)".



---

archive/issue_events_069234.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-20T20:20:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24106",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24106#event-69234"
}
```
