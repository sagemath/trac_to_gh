# Issue 24215: Add HAVE_GMPY2 compile-time constant

archive/issues_023978.json:
```json
{
    "body": "In order to optionally include code depending on gmpy2, we introduce a compile-time Cython constant `HAVE_GMPY2`.\n\nCC:  @vinklein\n\nBranch/Commit: 7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2\n\nReviewer: Erik Bray\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24215\n\n",
    "closed_at": "2017-12-11T01:02:26Z",
    "created_at": "2017-11-14T13:08:56Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Add HAVE_GMPY2 compile-time constant",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24215",
    "user": "https://github.com/jdemeyer"
}
```
In order to optionally include code depending on gmpy2, we introduce a compile-time Cython constant `HAVE_GMPY2`.

CC:  @vinklein

Branch/Commit: 7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2

Reviewer: Erik Bray

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24215





---

archive/issue_comments_458071.json:
```json
{
    "body": "<a id='comment:1'></a>I find this too complicated. Having Sage compilation depending on optional packages is awful.\n\nFor example, if I want to compile Sage with gmpy2 support I would have to do:\n1. compile Sage\n2. install gmpy2\n3. recompile Sage\n\nNot mentioning how impredictable this could be in doctesting.",
    "created_at": "2017-11-14T14:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458071",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>I find this too complicated. Having Sage compilation depending on optional packages is awful.

For example, if I want to compile Sage with gmpy2 support I would have to do:
1. compile Sage
2. install gmpy2
3. recompile Sage

Not mentioning how impredictable this could be in doctesting.



---

archive/issue_comments_458072.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 vdelecroix]:\n> I find this too complicated. Having Sage compilation depending on optional packages is awful.\n\n\nWe already do that for several packages (e.g. `bliss`, `coxeter3`) and it works fine. What is the problem really?",
    "created_at": "2017-11-14T15:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458072",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Replying to [comment:1 vdelecroix]:
> I find this too complicated. Having Sage compilation depending on optional packages is awful.


We already do that for several packages (e.g. `bliss`, `coxeter3`) and it works fine. What is the problem really?



---

archive/issue_comments_458073.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:1 vdelecroix]:\n> For example, if I want to compile Sage with gmpy2 support I would have to do:\n> 1. compile Sage\n> 2. install gmpy2\n> 3. recompile Sage\n\n\nTwo steps are sufficient:\n\n1. Install gmpy2\n2. Compile Sage\n\nAgain, this is not different from existing optional packages.",
    "created_at": "2017-11-14T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458073",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Replying to [comment:1 vdelecroix]:
> For example, if I want to compile Sage with gmpy2 support I would have to do:
> 1. compile Sage
> 2. install gmpy2
> 3. recompile Sage


Two steps are sufficient:

1. Install gmpy2
2. Compile Sage

Again, this is not different from existing optional packages.



---

archive/issue_comments_458074.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:1 vdelecroix]:\n> Not mentioning how impredictable this could be in doctesting.\n\n\nUse `# optional - gmpy2`. Again, this is not different from existing optional packages.",
    "created_at": "2017-11-14T15:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458074",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Replying to [comment:1 vdelecroix]:
> Not mentioning how impredictable this could be in doctesting.


Use `# optional - gmpy2`. Again, this is not different from existing optional packages.



---

archive/issue_comments_458075.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 jdemeyer]:\n> Replying to [comment:1 vdelecroix]:\n> > For example, if I want to compile Sage with gmpy2 support I would have to do:\n> > 1. compile Sage\n> > 2. install gmpy2\n> > 3. recompile Sage\n  \n> \n> Two steps are sufficient:\n> \n> 1. Install gmpy2\n> 2. Compile Sage\n> \n> Again, this is not different from existing optional packages.\n\n\n`sage -i gmpy2` before `make`?",
    "created_at": "2017-11-14T15:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458075",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Replying to [comment:3 jdemeyer]:
> Replying to [comment:1 vdelecroix]:
> > For example, if I want to compile Sage with gmpy2 support I would have to do:
> > 1. compile Sage
> > 2. install gmpy2
> > 3. recompile Sage
  
> 
> Two steps are sufficient:
> 
> 1. Install gmpy2
> 2. Compile Sage
> 
> Again, this is not different from existing optional packages.


`sage -i gmpy2` before `make`?



---

archive/issue_comments_458076.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:2 jdemeyer]:\n> Replying to [comment:1 vdelecroix]:\n> > I find this too complicated. Having Sage compilation depending on optional packages is awful.\n\n> \n> We already do that for several packages (e.g. `bliss`, `coxeter3`) and it works fine. What is the problem really?\n\n\nNot exactly. These two examples are handled as optional extensions. It is easy to figure out what is actually changed by their installation. With compilation constant, the distinction is less clear.",
    "created_at": "2017-11-14T15:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458076",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 vdelecroix]:
> > I find this too complicated. Having Sage compilation depending on optional packages is awful.

> 
> We already do that for several packages (e.g. `bliss`, `coxeter3`) and it works fine. What is the problem really?


Not exactly. These two examples are handled as optional extensions. It is easy to figure out what is actually changed by their installation. With compilation constant, the distinction is less clear.



---

archive/issue_comments_458077.json:
```json
{
    "body": "<a id='comment:7'></a>Just as a reminder trac #23024 require pplpy and therefore gmpy2 to be standard package. I am aware that it's not directly linked to the subject but that means we are probably going to make gmpy2 optional then standard again.",
    "created_at": "2017-11-14T15:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458077",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:7'></a>Just as a reminder trac #23024 require pplpy and therefore gmpy2 to be standard package. I am aware that it's not directly linked to the subject but that means we are probably going to make gmpy2 optional then standard again.



---

archive/issue_comments_458078.json:
```json
{
    "body": "<a id='comment:8'></a>Indeed!",
    "created_at": "2017-11-14T15:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458078",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Indeed!



---

archive/issue_comments_458079.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/24215\"",
    "created_at": "2017-11-14T15:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458079",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/24215"



---

archive/issue_comments_458080.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:5 vdelecroix]:\n> `sage -i gmpy2` before `make`?\n\n\nYes, that is what I meant. Although in practice most people will install Sage first and then optional packages.\n\n---\nNew commits:",
    "created_at": "2017-11-14T15:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458080",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [comment:5 vdelecroix]:
> `sage -i gmpy2` before `make`?


Yes, that is what I meant. Although in practice most people will install Sage first and then optional packages.

---
New commits:



---

archive/issue_comments_458081.json:
```json
{
    "body": "Changing commit from \"\" to \"34ef6dc08de5f11a74e83c6707d6dd4f5e2563be\"",
    "created_at": "2017-11-14T15:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458081",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "34ef6dc08de5f11a74e83c6707d6dd4f5e2563be"



---

archive/issue_comments_458082.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-14T15:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458082",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_458083.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:7 vklein]:\n> that means we are probably going to make gmpy2 optional then standard again. \n\n\nFine for me. To be clear: I'm not opposing to make `gmpy2` a standard package. But I am opposed to make it standard *now* just because it will needed by some hypothetical feature in the future.",
    "created_at": "2017-11-14T15:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458083",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:7 vklein]:
> that means we are probably going to make gmpy2 optional then standard again. 


Fine for me. To be clear: I'm not opposing to make `gmpy2` a standard package. But I am opposed to make it standard *now* just because it will needed by some hypothetical feature in the future.



---

archive/issue_comments_458084.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:6 vdelecroix]:\n> With compilation constant, the distinction is less clear.\n\n\nIf you look at the code on #22928, it's really not so bad. Additionally, the `HAVE_GMPY2` constant is something that you can easily grep for to find out what depends on `gmpy2`.",
    "created_at": "2017-11-14T15:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458084",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:6 vdelecroix]:
> With compilation constant, the distinction is less clear.


If you look at the code on #22928, it's really not so bad. Additionally, the `HAVE_GMPY2` constant is something that you can easily grep for to find out what depends on `gmpy2`.



---

archive/issue_comments_458085.json:
```json
{
    "body": "<a id='comment:14'></a>Your `have_module` function modifies the environment\n\n```\nsage: import sys\nsage: 'scipy' in sys.modules\nFalse\nsage: have_module('scipy')\nTrue\nsage: 'scipy' in sys.modules\nTrue\n```\n(see also [#20382 comment 40](https://trac.sagemath.org/ticket/20382#comment:40)). It would better be specified in the doc. Moreover, the function is not testing that a module is *installed* but testing whether you can *load* a given module (that might well correspond to a file in the current directory). According to the specification, this is one false positive (a module not installed) and a wrong negative (a module installed but that can not be loaded).",
    "created_at": "2017-11-15T20:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458085",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>Your `have_module` function modifies the environment

```
sage: import sys
sage: 'scipy' in sys.modules
False
sage: have_module('scipy')
True
sage: 'scipy' in sys.modules
True
```
(see also [#20382 comment 40](https://trac.sagemath.org/ticket/20382#comment:40)). It would better be specified in the doc. Moreover, the function is not testing that a module is *installed* but testing whether you can *load* a given module (that might well correspond to a file in the current directory). According to the specification, this is one false positive (a module not installed) and a wrong negative (a module installed but that can not be loaded).



---

archive/issue_comments_458086.json:
```json
{
    "body": "Changing commit from \"34ef6dc08de5f11a74e83c6707d6dd4f5e2563be\" to \"7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2\"",
    "created_at": "2017-11-16T09:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458086",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "34ef6dc08de5f11a74e83c6707d6dd4f5e2563be" to "7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2"



---

archive/issue_comments_458087.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-16T09:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458087",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458088.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:2 jdemeyer]:\n> Replying to [comment:1 vdelecroix]:\n> > I find this too complicated. Having Sage compilation depending on optional packages is awful.\n\n> \n> We already do that for several packages (e.g. `bliss`, `coxeter3`) and it works fine. What is the problem really?\n\n\nIf anything Sage needs *more* of this sort of thing, with more packages made \"optional\" IMO :)",
    "created_at": "2017-11-20T08:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458088",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 vdelecroix]:
> > I find this too complicated. Having Sage compilation depending on optional packages is awful.

> 
> We already do that for several packages (e.g. `bliss`, `coxeter3`) and it works fine. What is the problem really?


If anything Sage needs *more* of this sort of thing, with more packages made "optional" IMO :)



---

archive/issue_comments_458089.json:
```json
{
    "body": "<a id='comment:17'></a>I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.",
    "created_at": "2017-11-20T09:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458089",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.



---

archive/issue_comments_458090.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 embray]:\n> I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.\n\n\nTo avoid local imports. See [This is the Trac macro *comment:14* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:14-macro).",
    "created_at": "2017-11-20T10:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458090",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>Replying to [comment:17 embray]:
> I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.


To avoid local imports. See [This is the Trac macro *comment:14* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:14-macro).



---

archive/issue_comments_458091.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 embray]:\n> I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.\n\n\n`importlib.import_module` is [almost undocumented](https://docs.python.org/2.7/library/importlib.html), so I'm not convinced that it does the right thing.\n\nOn the other hand, `__import__` has [ample documentation](https://docs.python.org/2.7/library/functions.html#__import__) so I know that it does what I want it to do.",
    "created_at": "2017-11-20T10:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458091",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Replying to [comment:17 embray]:
> I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.


`importlib.import_module` is [almost undocumented](https://docs.python.org/2.7/library/importlib.html), so I'm not convinced that it does the right thing.

On the other hand, `__import__` has [ample documentation](https://docs.python.org/2.7/library/functions.html#__import__) so I know that it does what I want it to do.



---

archive/issue_comments_458092.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 jdemeyer]:\n> Replying to [comment:17 embray]:\n> > I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.\n\n> \n> `importlib.import_module` is [almost undocumented](https://docs.python.org/2.7/library/importlib.html), so I'm not convinced that it does the right thing.\n> \n> On the other hand, `__import__` has [ample documentation](https://docs.python.org/2.7/library/functions.html#__import__) so I know that it does what I want it to do.\n\n\nSee https://docs.python.org/3.6/library/importlib.html#importlib.import_module",
    "created_at": "2017-11-20T10:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458092",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>Replying to [comment:19 jdemeyer]:
> Replying to [comment:17 embray]:
> > I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.

> 
> `importlib.import_module` is [almost undocumented](https://docs.python.org/2.7/library/importlib.html), so I'm not convinced that it does the right thing.
> 
> On the other hand, `__import__` has [ample documentation](https://docs.python.org/2.7/library/functions.html#__import__) so I know that it does what I want it to do.


See https://docs.python.org/3.6/library/importlib.html#importlib.import_module



---

archive/issue_comments_458093.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 embray]:\n> See https://docs.python.org/3.6/library/importlib.html#importlib.import_module\n\n\nAnd how does it handle relative imports in Python 2? That's not documented, but it is documented for `__import__`.",
    "created_at": "2017-11-20T10:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458093",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [comment:20 embray]:
> See https://docs.python.org/3.6/library/importlib.html#importlib.import_module


And how does it handle relative imports in Python 2? That's not documented, but it is documented for `__import__`.



---

archive/issue_comments_458094.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:18 vdelecroix]:\n> Replying to [comment:17 embray]:\n> > I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.\n\n> \n> To avoid local imports. See [This is the Trac macro *comment:14* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:14-macro).\n\n\nIf I understand your point correctly, using `__import__` does not address the problem you're referring to in that comment.  E.g.\n\n```\n>>> import importlib, sys\n>>> 'numpy' in sys.modules\nFalse\n>>> mod = __import__('numpy', {}, {}, [], 0)\n>>> mod\n<module 'numpy' from '/usr/lib/python2.7/site-packages/numpy/__init__.pyc'>\n>>> 'numpy' in sys.modules\nTrue\n```\n\nThis is because (traditionally) inserting the module into `sys.modules` is a job performed by the relevant module `Loader`.  The fact that that happens at all is in a lower level of abstraction than the `import` statement (which calls `__import__`).\n\n`importlib.import_module` is a wrapper around `__import__` that just has more obvious semantics in terms of how dotted module names are handled, and is all around simpler.  The Python 3 docs recommend using it for this kind of purpose over `__import__`.",
    "created_at": "2017-11-20T11:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458094",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Replying to [comment:18 vdelecroix]:
> Replying to [comment:17 embray]:
> > I don't understand why this calls `__import__` with a bunch of a default arguments instead of just using `importlib.import_module`.

> 
> To avoid local imports. See [This is the Trac macro *comment:14* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:14-macro).


If I understand your point correctly, using `__import__` does not address the problem you're referring to in that comment.  E.g.

```
>>> import importlib, sys
>>> 'numpy' in sys.modules
False
>>> mod = __import__('numpy', {}, {}, [], 0)
>>> mod
<module 'numpy' from '/usr/lib/python2.7/site-packages/numpy/__init__.pyc'>
>>> 'numpy' in sys.modules
True
```

This is because (traditionally) inserting the module into `sys.modules` is a job performed by the relevant module `Loader`.  The fact that that happens at all is in a lower level of abstraction than the `import` statement (which calls `__import__`).

`importlib.import_module` is a wrapper around `__import__` that just has more obvious semantics in terms of how dotted module names are handled, and is all around simpler.  The Python 3 docs recommend using it for this kind of purpose over `__import__`.



---

archive/issue_comments_458095.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 embray]:\n> The Python 3 docs\n\n\n...are not relevant since Sage still uses Python 2.\n\nWhat are you pushing so much for `importlib.import_module`? If `__import__` works, why shouldn't we use it?",
    "created_at": "2017-11-20T11:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458095",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Replying to [comment:22 embray]:
> The Python 3 docs


...are not relevant since Sage still uses Python 2.

What are you pushing so much for `importlib.import_module`? If `__import__` works, why shouldn't we use it?



---

archive/issue_comments_458096.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 jdemeyer]:\n> Replying to [comment:22 embray]:\n> > The Python 3 docs\n\n> \n> ...are not relevant since Sage still uses Python 2.\n\n\nFor now...\n \n> What are you pushing so much for `importlib.import_module`? If `__import__` works, why shouldn't we use it?\n\n\nI'm so sorry that the documentation in Python 2 surrounding this is not to your liking.  A lot of the import-related modules that wasn't previously well documented is better documented now in the Python 3 docs simply because that's where the documentation improvements were made, and many of them were not backported I guess (maybe in part because there were so many other changes to the import system).\n\nThe whole point of `import_module` is that it's just simpler and implements to \"obvious\" semantics of import-by-name.  With `__import__` you pass in a mysterious `{}` basically to to force absolute imports, where as with `import_module` it's plain: `import_module('numpy')`.\n\nIn other words, its purpose is to do exactly what you want to do without dealing with the more complicated (and sometimes shifting) sematics of `__import__`.",
    "created_at": "2017-11-20T11:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458096",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 embray]:
> > The Python 3 docs

> 
> ...are not relevant since Sage still uses Python 2.


For now...
 
> What are you pushing so much for `importlib.import_module`? If `__import__` works, why shouldn't we use it?


I'm so sorry that the documentation in Python 2 surrounding this is not to your liking.  A lot of the import-related modules that wasn't previously well documented is better documented now in the Python 3 docs simply because that's where the documentation improvements were made, and many of them were not backported I guess (maybe in part because there were so many other changes to the import system).

The whole point of `import_module` is that it's just simpler and implements to "obvious" semantics of import-by-name.  With `__import__` you pass in a mysterious `{}` basically to to force absolute imports, where as with `import_module` it's plain: `import_module('numpy')`.

In other words, its purpose is to do exactly what you want to do without dealing with the more complicated (and sometimes shifting) sematics of `__import__`.



---

archive/issue_comments_458097.json:
```json
{
    "body": "<a id='comment:25'></a>This is kind of like asking \"why are you using `MyClass()` instead of `inst = MyClass.__new__(); if isinstance(inst, MyClass): inst.__init__()`?\"",
    "created_at": "2017-11-20T11:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458097",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>This is kind of like asking "why are you using `MyClass()` instead of `inst = MyClass.__new__(); if isinstance(inst, MyClass): inst.__init__()`?"



---

archive/issue_comments_458098.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:24 embray]:\n> I'm so sorry that the documentation in Python 2 surrounding this is not to your liking.\n\n\nYou're sounding sarcastic (intentional or not, I have no idea).\n\nBut the point is that documentation is important. The `import` statement maps directly to `__import__` and `__import__` is well documented. So I can be confident with using `__import__` here.\n\nIf you want to use `importlib` and want me to review that, then I will need to read the source code of `importlib`. That is not a disaster, but why should I be forced to do that?",
    "created_at": "2017-11-20T11:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458098",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:24 embray]:
> I'm so sorry that the documentation in Python 2 surrounding this is not to your liking.


You're sounding sarcastic (intentional or not, I have no idea).

But the point is that documentation is important. The `import` statement maps directly to `__import__` and `__import__` is well documented. So I can be confident with using `__import__` here.

If you want to use `importlib` and want me to review that, then I will need to read the source code of `importlib`. That is not a disaster, but why should I be forced to do that?



---

archive/issue_comments_458099.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 jdemeyer]:\n> Replying to [comment:24 embray]:\n> > I'm so sorry that the documentation in Python 2 surrounding this is not to your liking.\n\n> \n> You're sounding sarcastic (intentional or not, I have no idea).\n\n\nYes and no.  I sincerely am sorry, because I understand where you're coming from and I don't think this actually matters much, but I also feel like you're stubbornly sticking to a more complicated way to do a thing because the version of the documentation you looked at wasn't as current-as if documentation is always perfect.  In this case your choice isn't *wrong*--it's just needlessly using a lower-level interface for something that can be doing with a simpler higher level interface.  `importlib.import_module` was explicitly backported to Python 2.7 to help write more forward-compatible code.\n\n> But the point is that documentation is important. The `import` statement maps directly to `__import__` and `__import__` is well documented. So I can be confident with using `__import__` here.\n> \n> If you want to use `importlib` and want me to review that, then I will need to read the source code of `importlib`. That is not a disaster, but why should I be forced to do that?\n\n\nNo, actually, you don't; not any more than you need to read the source code of `__import__` itself.\n\nI'll explain--I think the misunderstanding here is that `importlib` was originally added in Python 3, and small parts of it backported to Python 2.7 to aid with forward compatibility.  So in fact this function does work the same as documented in the current Python 3 docs (though it's implemented slightly differently).  The admonition in the more current docs still applies:  \"**Note:** [`__import__`] is an advanced function that is not needed in everyday Python programming, unlike `importlib.import_module()`.\"\n\nBy all means, leave it as is--as you said it works.  I was just trying to help by pointing out a simpler way...",
    "created_at": "2017-11-20T13:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458099",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>Replying to [comment:26 jdemeyer]:
> Replying to [comment:24 embray]:
> > I'm so sorry that the documentation in Python 2 surrounding this is not to your liking.

> 
> You're sounding sarcastic (intentional or not, I have no idea).


Yes and no.  I sincerely am sorry, because I understand where you're coming from and I don't think this actually matters much, but I also feel like you're stubbornly sticking to a more complicated way to do a thing because the version of the documentation you looked at wasn't as current-as if documentation is always perfect.  In this case your choice isn't *wrong*--it's just needlessly using a lower-level interface for something that can be doing with a simpler higher level interface.  `importlib.import_module` was explicitly backported to Python 2.7 to help write more forward-compatible code.

> But the point is that documentation is important. The `import` statement maps directly to `__import__` and `__import__` is well documented. So I can be confident with using `__import__` here.
> 
> If you want to use `importlib` and want me to review that, then I will need to read the source code of `importlib`. That is not a disaster, but why should I be forced to do that?


No, actually, you don't; not any more than you need to read the source code of `__import__` itself.

I'll explain--I think the misunderstanding here is that `importlib` was originally added in Python 3, and small parts of it backported to Python 2.7 to aid with forward compatibility.  So in fact this function does work the same as documented in the current Python 3 docs (though it's implemented slightly differently).  The admonition in the more current docs still applies:  "**Note:** [`__import__`] is an advanced function that is not needed in everyday Python programming, unlike `importlib.import_module()`."

By all means, leave it as is--as you said it works.  I was just trying to help by pointing out a simpler way...



---

archive/issue_comments_458100.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Erik Bray\"",
    "created_at": "2017-11-20T13:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458100",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "" to "Erik Bray"



---

archive/issue_comments_458101.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-20T13:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458101",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458102.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458102",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_458103.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/24215\" to \"7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2\"",
    "created_at": "2017-12-11T01:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24215#issuecomment-458103",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/ticket/24215" to "7f06e71efb3fdc5f91fcf4b0b3ef761c72d9a8c2"



---

archive/issue_events_061353.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:02:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24215",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24215#event-61353"
}
```
