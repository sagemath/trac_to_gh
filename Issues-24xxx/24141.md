# Issue 24141: Optimizations to Kleber tree

archive/issues_023904.json:
```json
{
    "body": "We are getting more speed out of the Kleber tree by:\n\n- Using the brute force enumeration for \"small\" number of possible branches.\n- Better Python code.\n- Only build the dense Cartan matrix once.\n\n**CC:**  sage-combinat @anneschilling bsalisbury01\n\n**Keywords:** crystals, kleber tree\n\n**Branch/Commit:** [5d30a73e7b767745aefeba90ace1d99eb27a9b6d](https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d)\n\n**Reviewer:** Ben Salisbury\n\n**Author:** Travis Scrimshaw\n\nIssue created by migration from https://trac.sagemath.org/ticket/24141\n\n",
    "closed_at": "2018-02-03T21:22:03Z",
    "created_at": "2017-11-02T08:51:40Z",
    "labels": [
        "component: performance",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Optimizations to Kleber tree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24141",
    "user": "https://github.com/tscrim"
}
```
We are getting more speed out of the Kleber tree by:

- Using the brute force enumeration for "small" number of possible branches.
- Better Python code.
- Only build the dense Cartan matrix once.

**CC:**  sage-combinat @anneschilling bsalisbury01

**Keywords:** crystals, kleber tree

**Branch/Commit:** [5d30a73e7b767745aefeba90ace1d99eb27a9b6d](https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d)

**Reviewer:** Ben Salisbury

**Author:** Travis Scrimshaw

Issue created by migration from https://trac.sagemath.org/ticket/24141





---

archive/issue_comments_437221.json:
```json
{
    "body": "<a id='comment:1'></a>\nBy avoiding the polytopes, I get the following\n\n```\nsage: RC = RiggedConfigurations(['F',4,1], [[3,8]])\nsage: %time RC.kleber_tree()\nCPU times: user 4.94 s, sys: 16 ms, total: 4.96 s\nWall time: 2.78 s\nVirtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)\n```\nin contrast to\n\n```\nsage: RC = RiggedConfigurations(['F',4,1], [[3,8]])\nsage: %time RC.kleber_tree()\nCPU times: user 2min 40s, sys: 340 ms, total: 2min 41s\nWall time: 29 s\nVirtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)\n```\nNote that I am using `normaliz` on a machine with 4 CPUs + 4 hyperthreaded cores, which works very well for getting those initial branchings.",
    "created_at": "2017-11-02T09:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437221",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>
By avoiding the polytopes, I get the following

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time RC.kleber_tree()
CPU times: user 4.94 s, sys: 16 ms, total: 4.96 s
Wall time: 2.78 s
Virtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)
```
in contrast to

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time RC.kleber_tree()
CPU times: user 2min 40s, sys: 340 ms, total: 2min 41s
Wall time: 29 s
Virtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)
```
Note that I am using `normaliz` on a machine with 4 CPUs + 4 hyperthreaded cores, which works very well for getting those initial branchings.



---

archive/issue_comments_437222.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437222",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_437223.json:
```json
{
    "body": "<a id='comment:2'></a>\nBy being better about how often we are creating a dense matrix (in other words, only do it once!), I got some more speed:\n\n```\nsage: RC = RiggedConfigurations(['F',4,1], [[3,8]])\nsage: %time len(RC.kleber_tree())\nCPU times: user 3.58 s, sys: 12 ms, total: 3.59 s\nWall time: 2.08 s\n3395\n```\n\nThere might be a better way to pre-prune in `_children_iter_vector` as I believe the edge roots need to be symmetric as well. So by utilizing the folding, we could further limit the number of cases checked by the virtual Kleber trees. I might do that tomorrow, but it could easily enough go on a followup. This is already a huge speed gain.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/82bc1fb522d3bedabdb639debf88f75d73d60d09\">82bc1fb</a></td><td><code>Initial optimization to avoid polytopes for small number of possible choices.</code></td></tr></table>\n",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437223",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
By being better about how often we are creating a dense matrix (in other words, only do it once!), I got some more speed:

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time len(RC.kleber_tree())
CPU times: user 3.58 s, sys: 12 ms, total: 3.59 s
Wall time: 2.08 s
3395
```

There might be a better way to pre-prune in `_children_iter_vector` as I believe the edge roots need to be symmetric as well. So by utilizing the folding, we could further limit the number of cases checked by the virtual Kleber trees. I might do that tomorrow, but it could easily enough go on a followup. This is already a huge speed gain.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/82bc1fb522d3bedabdb639debf88f75d73d60d09">82bc1fb</a></td><td><code>Initial optimization to avoid polytopes for small number of possible choices.</code></td></tr></table>




---

archive/issue_comments_437224.json:
```json
{
    "body": "**Commit:** [82bc1fb522d3bedabdb639debf88f75d73d60d09](https://github.com/sagemath/sagetrac-mirror/commit/82bc1fb522d3bedabdb639debf88f75d73d60d09)",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437224",
    "user": "https://github.com/tscrim"
}
```

**Commit:** [82bc1fb522d3bedabdb639debf88f75d73d60d09](https://github.com/sagemath/sagetrac-mirror/commit/82bc1fb522d3bedabdb639debf88f75d73d60d09)



---

archive/issue_comments_437225.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,5 @@\n We are getting more speed out of the Kleber tree by:\n \n - Using the brute force enumeration for \"small\" number of possible branches.\n-- Better Python code\n+- Better Python code.\n+- Only build the dense Cartan matrix once.\n``````\n",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437225",
    "user": "https://github.com/tscrim"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,5 @@
 We are getting more speed out of the Kleber tree by:
 
 - Using the brute force enumeration for "small" number of possible branches.
-- Better Python code
+- Better Python code.
+- Only build the dense Cartan matrix once.
``````




---

archive/issue_comments_437226.json:
```json
{
    "body": "**Branch:** [public/combinat/optimize_kleber_trees-24141](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/optimize_kleber_trees-24141)",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437226",
    "user": "https://github.com/tscrim"
}
```

**Branch:** [public/combinat/optimize_kleber_trees-24141](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/optimize_kleber_trees-24141)



---

archive/issue_events_069293.json:
```json
{
    "actor": "https://github.com/bsalisbury1",
    "created_at": "2018-02-02T20:26:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24141#event-69293"
}
```



---

archive/issue_comments_437227.json:
```json
{
    "body": "**Reviewer:** Ben Salisbury",
    "created_at": "2018-02-02T20:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437227",
    "user": "https://github.com/bsalisbury1"
}
```

**Reviewer:** Ben Salisbury



---

archive/issue_comments_437228.json:
```json
{
    "body": "<a id='comment:3'></a>\nEverything looks good to me.",
    "created_at": "2018-02-02T20:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437228",
    "user": "https://github.com/bsalisbury1"
}
```

<a id='comment:3'></a>
Everything looks good to me.



---

archive/issue_comments_437229.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-02-02T20:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437229",
    "user": "https://github.com/bsalisbury1"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_437230.json:
```json
{
    "body": "**Changing commit** from \"[82bc1fb522d3bedabdb639debf88f75d73d60d09](https://github.com/sagemath/sagetrac-mirror/commit/82bc1fb522d3bedabdb639debf88f75d73d60d09)\" to \"[5d30a73e7b767745aefeba90ace1d99eb27a9b6d](https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d)\".",
    "created_at": "2018-02-02T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[82bc1fb522d3bedabdb639debf88f75d73d60d09](https://github.com/sagemath/sagetrac-mirror/commit/82bc1fb522d3bedabdb639debf88f75d73d60d09)" to "[5d30a73e7b767745aefeba90ace1d99eb27a9b6d](https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d)".



---

archive/issue_comments_437231.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d\">5d30a73</a></td><td><code>Merge branch 'develop' into t/24141/public/combinat/optimize_kleber_trees-24141</code></td></tr></table>\n",
    "created_at": "2018-02-02T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437231",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d">5d30a73</a></td><td><code>Merge branch 'develop' into t/24141/public/combinat/optimize_kleber_trees-24141</code></td></tr></table>




---

archive/issue_comments_437232.json:
```json
{
    "body": "**Changing status** from positive_review to needs_review.",
    "created_at": "2018-02-02T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437232",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing status** from positive_review to needs_review.



---

archive/issue_comments_437233.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-02-02T20:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437233",
    "user": "https://github.com/bsalisbury1"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_437234.json:
```json
{
    "body": "**Changing branch** from \"[public/combinat/optimize_kleber_trees-24141](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/optimize_kleber_trees-24141)\" to \"[5d30a73e7b767745aefeba90ace1d99eb27a9b6d](https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d)\".",
    "created_at": "2018-02-03T21:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-437234",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/combinat/optimize_kleber_trees-24141](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/optimize_kleber_trees-24141)" to "[5d30a73e7b767745aefeba90ace1d99eb27a9b6d](https://github.com/sagemath/sagetrac-mirror/commit/5d30a73e7b767745aefeba90ace1d99eb27a9b6d)".



---

archive/issue_events_069294.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-03T21:22:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24141#event-69294"
}
```
