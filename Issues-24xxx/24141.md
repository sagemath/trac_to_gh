# Issue 24141: Optimizations to Kleber tree

archive/issues_023904.json:
```json
{
    "body": "We are getting more speed out of the Kleber tree by:\n\n- Using the brute force enumeration for \"small\" number of possible branches.\n- Better Python code.\n- Only build the dense Cartan matrix once.\n\nCC:  sage-combinat @anneschilling bsalisbury01\n\nKeywords: crystals, kleber tree\n\nBranch/Commit: 5d30a73e7b767745aefeba90ace1d99eb27a9b6d\n\nReviewer: Ben Salisbury\n\nAuthor: Travis Scrimshaw\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24141\n\n",
    "closed_at": "2018-02-03T21:22:03Z",
    "created_at": "2017-11-02T08:51:40Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Optimizations to Kleber tree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24141",
    "user": "https://github.com/tscrim"
}
```
We are getting more speed out of the Kleber tree by:

- Using the brute force enumeration for "small" number of possible branches.
- Better Python code.
- Only build the dense Cartan matrix once.

CC:  sage-combinat @anneschilling bsalisbury01

Keywords: crystals, kleber tree

Branch/Commit: 5d30a73e7b767745aefeba90ace1d99eb27a9b6d

Reviewer: Ben Salisbury

Author: Travis Scrimshaw

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24141





---

archive/issue_comments_334700.json:
```json
{
    "body": "<a id='comment:1'></a>By avoiding the polytopes, I get the following\n\n```\nsage: RC = RiggedConfigurations(['F',4,1], [[3,8]])\nsage: %time RC.kleber_tree()\nCPU times: user 4.94 s, sys: 16 ms, total: 4.96 s\nWall time: 2.78 s\nVirtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)\n```\nin contrast to\n\n```\nsage: RC = RiggedConfigurations(['F',4,1], [[3,8]])\nsage: %time RC.kleber_tree()\nCPU times: user 2min 40s, sys: 340 ms, total: 2min 41s\nWall time: 29 s\nVirtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)\n```\nNote that I am using `normaliz` on a machine with 4 CPUs + 4 hyperthreaded cores, which works very well for getting those initial branchings.",
    "created_at": "2017-11-02T09:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334700",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>By avoiding the polytopes, I get the following

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time RC.kleber_tree()
CPU times: user 4.94 s, sys: 16 ms, total: 4.96 s
Wall time: 2.78 s
Virtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)
```
in contrast to

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time RC.kleber_tree()
CPU times: user 2min 40s, sys: 340 ms, total: 2min 41s
Wall time: 29 s
Virtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)
```
Note that I am using `normaliz` on a machine with 4 CPUs + 4 hyperthreaded cores, which works very well for getting those initial branchings.



---

archive/issue_comments_334701.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334701",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334702.json:
```json
{
    "body": "<a id='comment:2'></a>By being better about how often we are creating a dense matrix (in other words, only do it once!), I got some more speed:\n\n```\nsage: RC = RiggedConfigurations(['F',4,1], [[3,8]])\nsage: %time len(RC.kleber_tree())\nCPU times: user 3.58 s, sys: 12 ms, total: 3.59 s\nWall time: 2.08 s\n3395\n```\n\nThere might be a better way to pre-prune in `_children_iter_vector` as I believe the edge roots need to be symmetric as well. So by utilizing the folding, we could further limit the number of cases checked by the virtual Kleber trees. I might do that tomorrow, but it could easily enough go on a followup. This is already a huge speed gain.\n\n---\nNew commits:",
    "created_at": "2017-11-02T09:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334702",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>By being better about how often we are creating a dense matrix (in other words, only do it once!), I got some more speed:

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time len(RC.kleber_tree())
CPU times: user 3.58 s, sys: 12 ms, total: 3.59 s
Wall time: 2.08 s
3395
```

There might be a better way to pre-prune in `_children_iter_vector` as I believe the edge roots need to be symmetric as well. So by utilizing the folding, we could further limit the number of cases checked by the virtual Kleber trees. I might do that tomorrow, but it could easily enough go on a followup. This is already a huge speed gain.

---
New commits:



---

archive/issue_events_061242.json:
```json
{
    "actor": "https://github.com/bsalisbury1",
    "created_at": "2018-02-02T20:26:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24141#event-61242"
}
```



---

archive/issue_comments_334703.json:
```json
{
    "body": "<a id='comment:3'></a>Everything looks good to me.",
    "created_at": "2018-02-02T20:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334703",
    "user": "https://github.com/bsalisbury1"
}
```

<a id='comment:3'></a>Everything looks good to me.



---

archive/issue_comments_334704.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-02T20:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334704",
    "user": "https://github.com/bsalisbury1"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334705.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-02-02T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334705",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_334706.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-02-02T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334706",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_334707.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-02T20:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334707",
    "user": "https://github.com/bsalisbury1"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334708.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-03T21:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24141#issuecomment-334708",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061243.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-03T21:22:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24141",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24141#event-61243"
}
```
