# Issue 24942: move roots solving of univariate SR polynomial ring

archive/issues_024705.json:
```json
{
    "assignees": [],
    "body": "Move the root finding code of polynomial ring over SR from the generic method `roots` in `rings/polynomial/polynomial_element.pyx` to the specialized `_roots_univariate_polynomial` that has to be put directly in the base ring `SR` (code in `symbolic/ring.pyx`).\n\nDepends on #25022\n\nCC:  @rwst\n\nBranch/Commit: **[u/rws/24942](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24942) @ [`0c791d0`](https://github.com/sagemath/sagetrac-mirror/commit/0c791d057cc5bac4c2d27dd88c385b728445ee18)**\n\nAuthor: **Ralf Stephan**\n\nComponent: **symbolics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24942_\n\n",
    "created_at": "2018-03-10T15:17:22Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "move roots solving of univariate SR polynomial ring",
    "type": "issue",
    "updated_at": "2022-12-29T01:40:48Z",
    "url": "https://github.com/sagemath/sage/issues/24942",
    "user": "https://github.com/videlec"
}
```
Move the root finding code of polynomial ring over SR from the generic method `roots` in `rings/polynomial/polynomial_element.pyx` to the specialized `_roots_univariate_polynomial` that has to be put directly in the base ring `SR` (code in `symbolic/ring.pyx`).

Depends on #25022

CC:  @rwst

Branch/Commit: **[u/rws/24942](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24942) @ [`0c791d0`](https://github.com/sagemath/sagetrac-mirror/commit/0c791d057cc5bac4c2d27dd88c385b728445ee18)**

Author: **Ralf Stephan**

Component: **symbolics**

_Issue created by migration from https://trac.sagemath.org/ticket/24942_





---

archive/issue_events_345068.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-10T15:17:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345068"
}
```



---

archive/issue_events_345069.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-10T15:17:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "c: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345069"
}
```



---

archive/issue_events_345070.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-10T15:17:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345070"
}
```



---

archive/issue_events_345071.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-10T15:17:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345071"
}
```



---

archive/issue_comments_379799.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI'm on it.",
    "created_at": "2018-03-10T16:00:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379799",
    "user": "https://github.com/rwst"
}
```

<div id="comment:1" align="right">comment:1</div>

I'm on it.



---

archive/issue_comments_379800.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\n(I'll review when ready)",
    "created_at": "2018-03-10T16:05:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379800",
    "user": "https://github.com/videlec"
}
```

<div id="comment:2" align="right">comment:2</div>

(I'll review when ready)



---

archive/issue_comments_379801.json:
```json
{
    "body": "Branch: **[u/rws/move_roots_solving_of_univariate_sr_polynomial_ring](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/move_roots_solving_of_univariate_sr_polynomial_ring)**",
    "created_at": "2018-03-10T16:39:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379801",
    "user": "https://github.com/rwst"
}
```

Branch: **[u/rws/move_roots_solving_of_univariate_sr_polynomial_ring](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/move_roots_solving_of_univariate_sr_polynomial_ring)**



---

archive/issue_comments_379802.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAlthough this is a straight move, with addition of two examples, now 3 doctests fail:\n\n```\nFile \"src/sage/symbolic/ring.pyx\", line 227, in sage.symbolic.ring.SymbolicRing._element_constructor_\nFailed example:\n    a + sin(x)\nExpected:\n    I*sqrt(3) + sin(x)\nGot:\n    sin(x) + 1.732050807568878?*I\n```\n\n```\nFile \"src/sage/rings/polynomial/polynomial_element.pyx\", line 7038, in sage.rings.polynomial.polynomial_element.Polynomial.roots\nFailed example:\n    f.roots(SR)\nExpected:\n    [(-I*sqrt(2), 1), (I*sqrt(2), 1)]\nGot:\n    []\n```\n\n```\nFile \"src/sage/rings/polynomial/polynomial_element.pyx\", line 7040, in sage.rings.polynomial.polynomial_element.Polynomial.roots\nFailed example:\n    f.roots(SR, multiplicities=False)\nExpected:\n    [-I*sqrt(2), I*sqrt(2)]\nGot:\n    []\n```\nThere must be some fuzziness on if SR is the base ring, or the ring argument of roots(). \n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fcd9773e97ee97dce435316b0983ebd510938f6c\"><code>fcd9773</code></a></td><td><code>24942: move roots solving of univariate SR polynomial ring</code></td></tr></table>\n",
    "created_at": "2018-03-10T16:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379802",
    "user": "https://github.com/rwst"
}
```

<div id="comment:4" align="right">comment:4</div>

Although this is a straight move, with addition of two examples, now 3 doctests fail:

```
File "src/sage/symbolic/ring.pyx", line 227, in sage.symbolic.ring.SymbolicRing._element_constructor_
Failed example:
    a + sin(x)
Expected:
    I*sqrt(3) + sin(x)
Got:
    sin(x) + 1.732050807568878?*I
```

```
File "src/sage/rings/polynomial/polynomial_element.pyx", line 7038, in sage.rings.polynomial.polynomial_element.Polynomial.roots
Failed example:
    f.roots(SR)
Expected:
    [(-I*sqrt(2), 1), (I*sqrt(2), 1)]
Got:
    []
```

```
File "src/sage/rings/polynomial/polynomial_element.pyx", line 7040, in sage.rings.polynomial.polynomial_element.Polynomial.roots
Failed example:
    f.roots(SR, multiplicities=False)
Expected:
    [-I*sqrt(2), I*sqrt(2)]
Got:
    []
```
There must be some fuzziness on if SR is the base ring, or the ring argument of roots(). 

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fcd9773e97ee97dce435316b0983ebd510938f6c"><code>fcd9773</code></a></td><td><code>24942: move roots solving of univariate SR polynomial ring</code></td></tr></table>




---

archive/issue_comments_379803.json:
```json
{
    "body": "Commit: **[`fcd9773`](https://github.com/sagemath/sagetrac-mirror/commit/fcd9773e97ee97dce435316b0983ebd510938f6c)**",
    "created_at": "2018-03-10T16:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379803",
    "user": "https://github.com/rwst"
}
```

Commit: **[`fcd9773`](https://github.com/sagemath/sagetrac-mirror/commit/fcd9773e97ee97dce435316b0983ebd510938f6c)**



---

archive/issue_comments_379804.json:
```json
{
    "body": "Changed commit from **[`fcd9773`](https://github.com/sagemath/sagetrac-mirror/commit/fcd9773e97ee97dce435316b0983ebd510938f6c)** to **[`d1c2449`](https://github.com/sagemath/sagetrac-mirror/commit/d1c24497ada050999931d60ecb26e499990b2ee6)**",
    "created_at": "2018-03-10T16:56:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379804",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`fcd9773`](https://github.com/sagemath/sagetrac-mirror/commit/fcd9773e97ee97dce435316b0983ebd510938f6c)** to **[`d1c2449`](https://github.com/sagemath/sagetrac-mirror/commit/d1c24497ada050999931d60ecb26e499990b2ee6)**



---

archive/issue_comments_379805.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d1c24497ada050999931d60ecb26e499990b2ee6\"><code>d1c2449</code></a></td><td><code>24942: fix roots() bug</code></td></tr></table>\n",
    "created_at": "2018-03-10T16:56:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379805",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d1c24497ada050999931d60ecb26e499990b2ee6"><code>d1c2449</code></a></td><td><code>24942: fix roots() bug</code></td></tr></table>




---

archive/issue_events_345072.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-10T16:58:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345072"
}
```



---

archive/issue_comments_379806.json:
```json
{
    "body": "Author: **Ralf Stephan**",
    "created_at": "2018-03-10T16:58:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379806",
    "user": "https://github.com/rwst"
}
```

Author: **Ralf Stephan**



---

archive/issue_comments_379807.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nFound and fixed a bug in roots(). Please review.",
    "created_at": "2018-03-10T16:58:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379807",
    "user": "https://github.com/rwst"
}
```

<div id="comment:6" align="right">comment:6</div>

Found and fixed a bug in roots(). Please review.



---

archive/issue_comments_379808.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe following is wrong\n\n```\n-        if hasattr(K, '_roots_univariate_polynomial'):\n+        if hasattr(L, '_roots_univariate_polynomial'):\n```\nYou do want to delegate to the base ring of the polynomial (not to the target for the roots). You can check that at the end of the `roots` code there is\n\n```\nreturn self.change_ring(L).roots(multiplicities=multiplicities, algorithm=algorithm)\n```",
    "created_at": "2018-03-10T17:06:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379808",
    "user": "https://github.com/videlec"
}
```

<div id="comment:7" align="right">comment:7</div>

The following is wrong

```
-        if hasattr(K, '_roots_univariate_polynomial'):
+        if hasattr(L, '_roots_univariate_polynomial'):
```
You do want to delegate to the base ring of the polynomial (not to the target for the roots). You can check that at the end of the `roots` code there is

```
return self.change_ring(L).roots(multiplicities=multiplicities, algorithm=algorithm)
```



---

archive/issue_comments_379809.json:
```json
{
    "body": "Changed branch from **[u/rws/move_roots_solving_of_univariate_sr_polynomial_ring](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/move_roots_solving_of_univariate_sr_polynomial_ring)** to **[u/rws/24942](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24942)**",
    "created_at": "2018-03-11T14:28:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379809",
    "user": "https://github.com/rwst"
}
```

Changed branch from **[u/rws/move_roots_solving_of_univariate_sr_polynomial_ring](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/move_roots_solving_of_univariate_sr_polynomial_ring)** to **[u/rws/24942](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24942)**



---

archive/issue_comments_379810.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nStill missing fixes for QQbar doctest fails.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8908c9f9f67e48b0718b2eb46d666fde19ab2fdc\"><code>8908c9f</code></a></td><td><code>24942: move roots solving of univariate SR polynomial ring</code></td></tr></table>\n",
    "created_at": "2018-03-11T14:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379810",
    "user": "https://github.com/rwst"
}
```

<div id="comment:9" align="right">comment:9</div>

Still missing fixes for QQbar doctest fails.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8908c9f9f67e48b0718b2eb46d666fde19ab2fdc"><code>8908c9f</code></a></td><td><code>24942: move roots solving of univariate SR polynomial ring</code></td></tr></table>




---

archive/issue_comments_379811.json:
```json
{
    "body": "Changed commit from **[`d1c2449`](https://github.com/sagemath/sagetrac-mirror/commit/d1c24497ada050999931d60ecb26e499990b2ee6)** to **[`8908c9f`](https://github.com/sagemath/sagetrac-mirror/commit/8908c9f9f67e48b0718b2eb46d666fde19ab2fdc)**",
    "created_at": "2018-03-11T14:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379811",
    "user": "https://github.com/rwst"
}
```

Changed commit from **[`d1c2449`](https://github.com/sagemath/sagetrac-mirror/commit/d1c24497ada050999931d60ecb26e499990b2ee6)** to **[`8908c9f`](https://github.com/sagemath/sagetrac-mirror/commit/8908c9f9f67e48b0718b2eb46d666fde19ab2fdc)**



---

archive/issue_comments_379812.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI am not sure we want to support the `ring` argument when different from `None`/`SR`. Do you? If so, you should add proper examples.\n\nBTW, in the doctest `(x^2 + x + 1).roots(SR)` the `SR` should not be needed.",
    "created_at": "2018-03-11T14:41:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379812",
    "user": "https://github.com/videlec"
}
```

<div id="comment:10" align="right">comment:10</div>

I am not sure we want to support the `ring` argument when different from `None`/`SR`. Do you? If so, you should add proper examples.

BTW, in the doctest `(x^2 + x + 1).roots(SR)` the `SR` should not be needed.



---

archive/issue_comments_379813.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThere may be some serious inefficiencies involved up to now because the polys that get transferred in the call to SR._roots... have coefficients in SR BUT they are actually embedded algebraic numbers. I need to have a further look.",
    "created_at": "2018-03-11T14:59:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379813",
    "user": "https://github.com/rwst"
}
```

<div id="comment:11" align="right">comment:11</div>

There may be some serious inefficiencies involved up to now because the polys that get transferred in the call to SR._roots... have coefficients in SR BUT they are actually embedded algebraic numbers. I need to have a further look.



---

archive/issue_comments_379814.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAgree with ignoring the ring argument. Here is a problem:\n\n```\nsage: QQbar(sqrt(2)).minpoly().change_ring(SR)\nx^2 - 2\nsage: _.coefficients()\n[x^2 - 2]\n```\nThat is, the result from `change_ring(SR)` has degree 0. Is this expected?",
    "created_at": "2018-03-11T15:19:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379814",
    "user": "https://github.com/rwst"
}
```

<div id="comment:12" align="right">comment:12</div>

Agree with ignoring the ring argument. Here is a problem:

```
sage: QQbar(sqrt(2)).minpoly().change_ring(SR)
x^2 - 2
sage: _.coefficients()
[x^2 - 2]
```
That is, the result from `change_ring(SR)` has degree 0. Is this expected?



---

archive/issue_comments_379815.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@rwst](#comment:12):\n> Agree with ignoring the ring argument. Here is a problem:\n> \n> ```\n> sage: QQbar(sqrt(2)).minpoly().change_ring(SR)\n> x^2 - 2\n> sage: _.coefficients()\n> [x^2 - 2]\n> ```\n> That is, the result from `change_ring(SR)` has degree 0. Is this expected?\n\nAnother bug (mostly disjoint from this ticket)\n\n```\nsage: PSR = SR['x']\nsage: PSR('x^2 - 1').degree()   # fine\n2\nsage: PSR([-1, 0, 1]).degree()  # fine\n2\nsage: PSR(polygen(ZZ)^2 - 1).degree()  # weird!\n0\n```\nI guess that the `_element_constructor` of `PolynomialRing` has to be blame here. The point is that `SR` is able to merge `x^2 - 1` in its base ring so the the constructor get confused. We should special case when the input is a univariate polynomial. But please in another ticket.",
    "created_at": "2018-03-11T15:32:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379815",
    "user": "https://github.com/videlec"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@rwst](#comment:12):
> Agree with ignoring the ring argument. Here is a problem:
> 
> ```
> sage: QQbar(sqrt(2)).minpoly().change_ring(SR)
> x^2 - 2
> sage: _.coefficients()
> [x^2 - 2]
> ```
> That is, the result from `change_ring(SR)` has degree 0. Is this expected?

Another bug (mostly disjoint from this ticket)

```
sage: PSR = SR['x']
sage: PSR('x^2 - 1').degree()   # fine
2
sage: PSR([-1, 0, 1]).degree()  # fine
2
sage: PSR(polygen(ZZ)^2 - 1).degree()  # weird!
0
```
I guess that the `_element_constructor` of `PolynomialRing` has to be blame here. The point is that `SR` is able to merge `x^2 - 1` in its base ring so the the constructor get confused. We should special case when the input is a univariate polynomial. But please in another ticket.



---

archive/issue_comments_379816.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI think I can work around it, and the following:\n\n```\nsage: R.<x> = SR[]\nsage: SR(x^2 + x + 1)\n...\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9671)()\n    918         if mor is not None:\n    919             if no_extra_args:\n--> 920                 return mor._call_(x)\n    921             else:\n    922                 return mor._call_with_args(x, args, kwds)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.ConstantPolynomialSection._call_ (build/cythonized/sage/rings/polynomial/polynomial_element.c:102674)()\n  11117                 return <Element>((<Polynomial>x).constant_coefficient())\n  11118         else:\n> 11119             raise TypeError(\"not a constant polynomial\")\n  11120 \n  11121 cdef class PolynomialBaseringInjection(Morphism):\n\nTypeError: not a constant polynomial\n```",
    "created_at": "2018-03-11T15:35:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379816",
    "user": "https://github.com/rwst"
}
```

<div id="comment:14" align="right">comment:14</div>

I think I can work around it, and the following:

```
sage: R.<x> = SR[]
sage: SR(x^2 + x + 1)
...
/home/ralf/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9671)()
    918         if mor is not None:
    919             if no_extra_args:
--> 920                 return mor._call_(x)
    921             else:
    922                 return mor._call_with_args(x, args, kwds)

/home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.ConstantPolynomialSection._call_ (build/cythonized/sage/rings/polynomial/polynomial_element.c:102674)()
  11117                 return <Element>((<Polynomial>x).constant_coefficient())
  11118         else:
> 11119             raise TypeError("not a constant polynomial")
  11120 
  11121 cdef class PolynomialBaseringInjection(Morphism):

TypeError: not a constant polynomial
```



---

archive/issue_comments_379817.json:
```json
{
    "body": "Changed commit from **[`8908c9f`](https://github.com/sagemath/sagetrac-mirror/commit/8908c9f9f67e48b0718b2eb46d666fde19ab2fdc)** to **[`0c791d0`](https://github.com/sagemath/sagetrac-mirror/commit/0c791d057cc5bac4c2d27dd88c385b728445ee18)**",
    "created_at": "2018-03-11T16:08:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379817",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8908c9f`](https://github.com/sagemath/sagetrac-mirror/commit/8908c9f9f67e48b0718b2eb46d666fde19ab2fdc)** to **[`0c791d0`](https://github.com/sagemath/sagetrac-mirror/commit/0c791d057cc5bac4c2d27dd88c385b728445ee18)**



---

archive/issue_comments_379818.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0c791d057cc5bac4c2d27dd88c385b728445ee18\"><code>0c791d0</code></a></td><td><code>24942: fixes</code></td></tr></table>\n",
    "created_at": "2018-03-11T16:08:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379818",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0c791d057cc5bac4c2d27dd88c385b728445ee18"><code>0c791d0</code></a></td><td><code>24942: fixes</code></td></tr></table>




---

archive/issue_comments_379819.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@videlec](#comment:13):\n> Another bug (mostly disjoint from this ticket)\n\nNot disjoint because I need a special case to work with these polynomials that get thrown at the _roots...() function. Please have a look. Tests pass so far.",
    "created_at": "2018-03-11T16:10:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379819",
    "user": "https://github.com/rwst"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@videlec](#comment:13):
> Another bug (mostly disjoint from this ticket)

Not disjoint because I need a special case to work with these polynomials that get thrown at the _roots...() function. Please have a look. Tests pass so far.



---

archive/issue_comments_379820.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nNote there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).",
    "created_at": "2018-03-11T16:27:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379820",
    "user": "https://github.com/rwst"
}
```

<div id="comment:17" align="right">comment:17</div>

Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).



---

archive/issue_comments_379821.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@rwst](#comment:17):\n> Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).\n\nThe roots code first calls `_roots_univariate_polynomial`. So there must be something wrong.",
    "created_at": "2018-03-11T16:45:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379821",
    "user": "https://github.com/videlec"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@rwst](#comment:17):
> Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).

The roots code first calls `_roots_univariate_polynomial`. So there must be something wrong.



---

archive/issue_comments_379822.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@videlec](#comment:18):\n> Replying to [@rwst](#comment:17):\n> > Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).\n\n> \n> The roots code first calls `_roots_univariate_polynomial`. So there must be something wrong.\n\nNo, the result from `QQbar(I).minpoly()` does not have a `_roots_univariate_polynomial` member.",
    "created_at": "2018-03-11T16:51:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379822",
    "user": "https://github.com/rwst"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@videlec](#comment:18):
> Replying to [@rwst](#comment:17):
> > Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).

> 
> The roots code first calls `_roots_univariate_polynomial`. So there must be something wrong.

No, the result from `QQbar(I).minpoly()` does not have a `_roots_univariate_polynomial` member.



---

archive/issue_comments_379823.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@rwst](#comment:19):\n> Replying to [@videlec](#comment:18):\n> > Replying to [@rwst](#comment:17):\n> > > Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).\n\n> > \n> > The roots code first calls `_roots_univariate_polynomial`. So there must be something wrong.\n\n> \n> No, the result from `QQbar(I).minpoly()` does not have a `_roots_univariate_polynomial` member.\n\n`_roots_univariate_polynomial` is a method of the base ring not of the polynomial. That being said, the code in `radical_expression` would better be changed to\n\n```diff\n- roots = poly.roots(SR, multiplicities=False)\n+ roots = poly.change_ring(SR).roots(multiplicities=False)\n```",
    "created_at": "2018-03-11T16:57:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379823",
    "user": "https://github.com/videlec"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@rwst](#comment:19):
> Replying to [@videlec](#comment:18):
> > Replying to [@rwst](#comment:17):
> > > Note there is a performance hit, `QQbar(I).radical_expression()` now takes 4-5x the time (mostly because code in polynomial_elements.pyx:roots() is executed that was cut short before (`if L is SR` is now missing).

> > 
> > The roots code first calls `_roots_univariate_polynomial`. So there must be something wrong.

> 
> No, the result from `QQbar(I).minpoly()` does not have a `_roots_univariate_polynomial` member.

`_roots_univariate_polynomial` is a method of the base ring not of the polynomial. That being said, the code in `radical_expression` would better be changed to

```diff
- roots = poly.roots(SR, multiplicities=False)
+ roots = poly.change_ring(SR).roots(multiplicities=False)
```



---

archive/issue_comments_379824.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@videlec](#comment:20):\nThat being said, the code in `radical_expression` would better be changed to\n> \n> ```diff\n> - roots = poly.roots(SR, multiplicities=False)\n> + roots = poly.change_ring(SR).roots(multiplicities=False)\n> ```\n\nIs nearly as slow, despite being more correct. I tried converting to SR, or calling `_symbolic_` on the poly but it's even slower. If these are Flint polys, I could put code in Pynac for fast conversion.",
    "created_at": "2018-03-11T17:09:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379824",
    "user": "https://github.com/rwst"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@videlec](#comment:20):
That being said, the code in `radical_expression` would better be changed to
> 
> ```diff
> - roots = poly.roots(SR, multiplicities=False)
> + roots = poly.change_ring(SR).roots(multiplicities=False)
> ```

Is nearly as slow, despite being more correct. I tried converting to SR, or calling `_symbolic_` on the poly but it's even slower. If these are Flint polys, I could put code in Pynac for fast conversion.



---

archive/issue_comments_379825.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@rwst](#comment:21):\n> Replying to [@videlec](#comment:20):\n> That being said, the code in `radical_expression` would better be changed to\n> > \n> > ```diff\n> > - roots = poly.roots(SR, multiplicities=False)\n> > + roots = poly.change_ring(SR).roots(multiplicities=False)\n> > ```\n\n> \n> Is nearly as slow, despite being more correct. I tried converting to SR, or calling `_symbolic_` on the poly but it's even slower. If these are Flint polys, I could put code in Pynac for fast conversion.\n\nConversion from ZZ can already be improved\n\n```\nsage: a = ZZ(23)\nsage: %timeit SR(a)\n100000 loops, best of 3: 3.51 \u00b5s per loop\nsage: %timeit RR(a)\n1000000 loops, best of 3: 218 ns per loop\n```\nwhich is basically the same x15 ratio as in\n\n```\nsage: p = polygen(ZZ)^2 + 1\nsage: %timeit p.change_ring(SR)\n1000 loops, best of 3: 322 \u00b5s per loop\nsage: %timeit p.change_ring(RR)\n100000 loops, best of 3: 12.9 \u00b5s per loop\n```",
    "created_at": "2018-03-11T17:15:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379825",
    "user": "https://github.com/videlec"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@rwst](#comment:21):
> Replying to [@videlec](#comment:20):
> That being said, the code in `radical_expression` would better be changed to
> > 
> > ```diff
> > - roots = poly.roots(SR, multiplicities=False)
> > + roots = poly.change_ring(SR).roots(multiplicities=False)
> > ```

> 
> Is nearly as slow, despite being more correct. I tried converting to SR, or calling `_symbolic_` on the poly but it's even slower. If these are Flint polys, I could put code in Pynac for fast conversion.

Conversion from ZZ can already be improved

```
sage: a = ZZ(23)
sage: %timeit SR(a)
100000 loops, best of 3: 3.51 µs per loop
sage: %timeit RR(a)
1000000 loops, best of 3: 218 ns per loop
```
which is basically the same x15 ratio as in

```
sage: p = polygen(ZZ)^2 + 1
sage: %timeit p.change_ring(SR)
1000 loops, best of 3: 322 µs per loop
sage: %timeit p.change_ring(RR)
100000 loops, best of 3: 12.9 µs per loop
```



---

archive/issue_comments_379826.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI'm able to reduce `SR(a)` to 300ns by simply rearranging the code in `SR._element_constructor()`, see #24952. I'm fighting for my life with Cython to get this implemented however.",
    "created_at": "2018-03-12T09:58:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379826",
    "user": "https://github.com/rwst"
}
```

<div id="comment:23" align="right">comment:23</div>

I'm able to reduce `SR(a)` to 300ns by simply rearranging the code in `SR._element_constructor()`, see #24952. I'm fighting for my life with Cython to get this implemented however.



---

archive/issue_comments_379827.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nNote that speeding up `SR(a)` with #24952 does not affect `change_ring(SR)` timing.",
    "created_at": "2018-03-12T15:45:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379827",
    "user": "https://github.com/rwst"
}
```

<div id="comment:24" align="right">comment:24</div>

Note that speeding up `SR(a)` with #24952 does not affect `change_ring(SR)` timing.



---

archive/issue_comments_379828.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n`p.change_ring(SR)` uses the generic `polynomial_element.pyx:_call_` calling `subs()` while `p.change_ring(RR)` uses the generic `Parent.__call__`. It seems from profiling that thousands of dict queries are done for a single call to `p.change_ring(SR)`. Either way, implementing a dedicated `polynomial_integer_dense_flint.pyx:_symbolic_()` seems to me the optimal way to deal with this.",
    "created_at": "2018-03-12T16:32:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379828",
    "user": "https://github.com/rwst"
}
```

<div id="comment:25" align="right">comment:25</div>

`p.change_ring(SR)` uses the generic `polynomial_element.pyx:_call_` calling `subs()` while `p.change_ring(RR)` uses the generic `Parent.__call__`. It seems from profiling that thousands of dict queries are done for a single call to `p.change_ring(SR)`. Either way, implementing a dedicated `polynomial_integer_dense_flint.pyx:_symbolic_()` seems to me the optimal way to deal with this.



---

archive/issue_comments_379829.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@rwst](#comment:25):\n> `p.change_ring(SR)` uses the generic `polynomial_element.pyx:_call_` calling `subs()` while `p.change_ring(RR)` uses the generic `Parent.__call__`. It seems from profiling that thousands of dict queries are done for a single call to `p.change_ring(SR)`. Either way, implementing a dedicated `polynomial_integer_dense_flint.pyx:_symbolic_()` seems to me the optimal way to deal with this.\n\nThese are different operations. You seem to confuse polynomials with coefficients in SR like `SR['x'].gen()^2 + 1` and the corresponding element of SR `SR.var('x')^2 + 1`.\n\nIf you have a polynomial `p`, the operations `SR(p)` and `p.change_ring(SR)` are different. In the second case, you change the ring of the coefficients. Not the fact that it is a Sage polynomial.",
    "created_at": "2018-03-12T16:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379829",
    "user": "https://github.com/videlec"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@rwst](#comment:25):
> `p.change_ring(SR)` uses the generic `polynomial_element.pyx:_call_` calling `subs()` while `p.change_ring(RR)` uses the generic `Parent.__call__`. It seems from profiling that thousands of dict queries are done for a single call to `p.change_ring(SR)`. Either way, implementing a dedicated `polynomial_integer_dense_flint.pyx:_symbolic_()` seems to me the optimal way to deal with this.

These are different operations. You seem to confuse polynomials with coefficients in SR like `SR['x'].gen()^2 + 1` and the corresponding element of SR `SR.var('x')^2 + 1`.

If you have a polynomial `p`, the operations `SR(p)` and `p.change_ring(SR)` are different. In the second case, you change the ring of the coefficients. Not the fact that it is a Sage polynomial.



---

archive/issue_comments_379830.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@videlec](#comment:22):\n> \n> ```\n> sage: p = polygen(ZZ)^2 + 1\n> sage: %timeit p.change_ring(SR)\n> 1000 loops, best of 3: 322 \u00b5s per loop\n> sage: %timeit p.change_ring(RR)\n> 100000 loops, best of 3: 12.9 \u00b5s per loop\n> ```\n\nThe biggest part (230\u00b5s) of these 300\u00b5s is spent in `Expression.__nonzero__` disproving `x^2 + 1 == 0`. So again, it's calling the wrong function when comparing an expression with zero, that leads to performance issues. You can easily confirm this by inserting `return False` at the start of `Expression.__nonzero__` which brings the time down to 70\u00b5s.",
    "created_at": "2018-03-13T08:44:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379830",
    "user": "https://github.com/rwst"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@videlec](#comment:22):
> 
> ```
> sage: p = polygen(ZZ)^2 + 1
> sage: %timeit p.change_ring(SR)
> 1000 loops, best of 3: 322 µs per loop
> sage: %timeit p.change_ring(RR)
> 100000 loops, best of 3: 12.9 µs per loop
> ```

The biggest part (230µs) of these 300µs is spent in `Expression.__nonzero__` disproving `x^2 + 1 == 0`. So again, it's calling the wrong function when comparing an expression with zero, that leads to performance issues. You can easily confirm this by inserting `return False` at the start of `Expression.__nonzero__` which brings the time down to 70µs.



---

archive/issue_comments_379831.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@rwst](#comment:27):\n> Replying to [@videlec](#comment:22):\n> > \n> > ```\n> > sage: p = polygen(ZZ)^2 + 1\n> > sage: %timeit p.change_ring(SR)\n> > 1000 loops, best of 3: 322 \u00b5s per loop\n> > sage: %timeit p.change_ring(RR)\n> > 100000 loops, best of 3: 12.9 \u00b5s per loop\n> > ```\n\n> \n> The biggest part (230\u00b5s) of these 300\u00b5s is spent in `Expression.__nonzero__` disproving `x^2 + 1 == 0`. So again, it's calling the wrong function when comparing an expression with zero, that leads to performance issues. You can easily confirm this by inserting `return False` at the start of `Expression.__nonzero__` which brings the time down to 70\u00b5s.\n\nWhy on earth the code would you check that `x^2 + 1 == 0`!? You just need to consider the **coefficients**, that is `1`, `0` and `1`. Have you read [comment:25]?",
    "created_at": "2018-03-13T09:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379831",
    "user": "https://github.com/videlec"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@rwst](#comment:27):
> Replying to [@videlec](#comment:22):
> > 
> > ```
> > sage: p = polygen(ZZ)^2 + 1
> > sage: %timeit p.change_ring(SR)
> > 1000 loops, best of 3: 322 µs per loop
> > sage: %timeit p.change_ring(RR)
> > 100000 loops, best of 3: 12.9 µs per loop
> > ```

> 
> The biggest part (230µs) of these 300µs is spent in `Expression.__nonzero__` disproving `x^2 + 1 == 0`. So again, it's calling the wrong function when comparing an expression with zero, that leads to performance issues. You can easily confirm this by inserting `return False` at the start of `Expression.__nonzero__` which brings the time down to 70µs.

Why on earth the code would you check that `x^2 + 1 == 0`!? You just need to consider the **coefficients**, that is `1`, `0` and `1`. Have you read [comment:25]?



---

archive/issue_comments_379832.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@videlec](#comment:28):\n> Have you read [comment:25]?\n\nI have, and I have traced what happens. I will document this clearly and confirmable, but this takes time.",
    "created_at": "2018-03-13T14:13:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379832",
    "user": "https://github.com/rwst"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@videlec](#comment:28):
> Have you read [comment:25]?

I have, and I have traced what happens. I will document this clearly and confirmable, but this takes time.



---

archive/issue_comments_379833.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nPlease see #24965, which we might depend on here.",
    "created_at": "2018-03-13T15:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379833",
    "user": "https://github.com/rwst"
}
```

<div id="comment:30" align="right">comment:30</div>

Please see #24965, which we might depend on here.



---

archive/issue_comments_379834.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@rwst](#comment:12):\n> That is, the result from `change_ring(SR)` has degree 0. Is this expected?\n\nNote that this is the reason `x^2 + 1` is tested as documented in #24965.",
    "created_at": "2018-03-13T15:46:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379834",
    "user": "https://github.com/rwst"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@rwst](#comment:12):
> That is, the result from `change_ring(SR)` has degree 0. Is this expected?

Note that this is the reason `x^2 + 1` is tested as documented in #24965.



---

archive/issue_comments_379835.json:
```json
{
    "body": "Dependencies: **#24965**",
    "created_at": "2018-03-13T16:20:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379835",
    "user": "https://github.com/rwst"
}
```

Dependencies: **#24965**



---

archive/issue_comments_379836.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nIt seems I mentally did put your [comment:13](#comment:13) in a different slot than [comment:12](#comment:12). Anyway, we should depend on the coming fix in #24965 and revert the commit 0c791d0 here.",
    "created_at": "2018-03-13T16:20:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379836",
    "user": "https://github.com/rwst"
}
```

<div id="comment:32" align="right">comment:32</div>

It seems I mentally did put your [comment:13](#comment:13) in a different slot than [comment:12](#comment:12). Anyway, we should depend on the coming fix in #24965 and revert the commit 0c791d0 here.



---

archive/issue_comments_379837.json:
```json
{
    "body": "Changed dependencies from **#24965** to none",
    "created_at": "2018-03-14T06:22:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379837",
    "user": "https://github.com/rwst"
}
```

Changed dependencies from **#24965** to none



---

archive/issue_comments_379838.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@rwst](#comment:32):\n> Anyway, we should depend on the coming fix in #24965 and revert the commit 0c791d0 here.\n\nThis was a cul-de-sac. So the alternative, doing something about the comparison of objects with zero (where the comparison explicitly needs no simplification) looks like an alternative. The problem is outlined in https://trac.sagemath.org/wiki/symbolics/nonzero and #21201 looks like the best start at it.",
    "created_at": "2018-03-14T06:22:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379838",
    "user": "https://github.com/rwst"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@rwst](#comment:32):
> Anyway, we should depend on the coming fix in #24965 and revert the commit 0c791d0 here.

This was a cul-de-sac. So the alternative, doing something about the comparison of objects with zero (where the comparison explicitly needs no simplification) looks like an alternative. The problem is outlined in https://trac.sagemath.org/wiki/symbolics/nonzero and #21201 looks like the best start at it.



---

archive/issue_comments_379839.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nWith #21201 and patching `polynomial_element.pyx` to use special comparison I can get the ring change of [comment:22](#comment:22) down to 90us.",
    "created_at": "2018-03-14T08:12:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379839",
    "user": "https://github.com/rwst"
}
```

<div id="comment:34" align="right">comment:34</div>

With #21201 and patching `polynomial_element.pyx` to use special comparison I can get the ring change of [comment:22](#comment:22) down to 90us.



---

archive/issue_comments_379840.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nActually, moving the code to `SR._roots_univariate_polynomial` is nearly impossible for the following reason. As you can see the code that is now in `roots` uses a silent change of variables with name `vname = 'do_not_use_this_name_in_a_polynomial_coefficient'`. The reason for this is that you want to support\n\n```\nsage: x = polygen(SR)\nsage: (x^3 - SR.var('x')^3).roots()\n[(1/2*x*(I*sqrt(3) - 1), 1), (-1/2*x*(I*sqrt(3) + 1), 1), (x, 1)]\n```\nNow if you convert first to `SR` as a symbolic expression you get 0. Which is certainly not what you want.\n\nMy conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.",
    "created_at": "2018-03-14T10:02:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379840",
    "user": "https://github.com/videlec"
}
```

<div id="comment:35" align="right">comment:35</div>

Actually, moving the code to `SR._roots_univariate_polynomial` is nearly impossible for the following reason. As you can see the code that is now in `roots` uses a silent change of variables with name `vname = 'do_not_use_this_name_in_a_polynomial_coefficient'`. The reason for this is that you want to support

```
sage: x = polygen(SR)
sage: (x^3 - SR.var('x')^3).roots()
[(1/2*x*(I*sqrt(3) - 1), 1), (-1/2*x*(I*sqrt(3) + 1), 1), (x, 1)]
```
Now if you convert first to `SR` as a symbolic expression you get 0. Which is certainly not what you want.

My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.



---

archive/issue_comments_379841.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nThe only intrusion I see is in roots, and well, if you request symbolic output then you need a special case. QQbar could simply convert to SR, and call solve on the resulting expression.",
    "created_at": "2018-03-14T10:59:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379841",
    "user": "https://github.com/rwst"
}
```

<div id="comment:36" align="right">comment:36</div>

The only intrusion I see is in roots, and well, if you request symbolic output then you need a special case. QQbar could simply convert to SR, and call solve on the resulting expression.



---

archive/issue_comments_379842.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@rwst](#comment:36):\n> The only intrusion I see is in roots, and well, if you request symbolic output then you need a special case. QQbar could simply convert to SR, and call solve on the resulting expression.\n\nIt is in `roots` and you can not remove it. It **is** terribly intrusive. All of the following works correctly\n\n```\nsage: x = polygen(ZZ)\nsage: (x^3 - 2).roots(QQ)\n[]\nsage: (x^3 - 2).roots(RR)\n[(1.25992104989487, 1)]\nsage: (x^3 - 2).roots(CC)\n[(1.25992104989487, 1),\n (-0.629960524947437 - 1.09112363597172*I, 1),\n (-0.629960524947437 + 1.09112363597172*I, 1)]\nsage: (x^3 - 2).roots(AA)\n[(1.259921049894873?, 1)]\nsage: (x^3 - 2).roots(QQbar)\n[(1.259921049894873?, 1),\n (-0.6299605249474365? - 1.091123635971722?*I, 1),\n (-0.6299605249474365? + 1.091123635971722?*I, 1)]\n```\nand there is no special casing for them.",
    "created_at": "2018-03-14T11:17:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379842",
    "user": "https://github.com/videlec"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@rwst](#comment:36):
> The only intrusion I see is in roots, and well, if you request symbolic output then you need a special case. QQbar could simply convert to SR, and call solve on the resulting expression.

It is in `roots` and you can not remove it. It **is** terribly intrusive. All of the following works correctly

```
sage: x = polygen(ZZ)
sage: (x^3 - 2).roots(QQ)
[]
sage: (x^3 - 2).roots(RR)
[(1.25992104989487, 1)]
sage: (x^3 - 2).roots(CC)
[(1.25992104989487, 1),
 (-0.629960524947437 - 1.09112363597172*I, 1),
 (-0.629960524947437 + 1.09112363597172*I, 1)]
sage: (x^3 - 2).roots(AA)
[(1.259921049894873?, 1)]
sage: (x^3 - 2).roots(QQbar)
[(1.259921049894873?, 1),
 (-0.6299605249474365? - 1.091123635971722?*I, 1),
 (-0.6299605249474365? + 1.091123635971722?*I, 1)]
```
and there is no special casing for them.



---

archive/issue_comments_379843.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@videlec](#comment:35):\n> My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.\n\nI should have added: unless we go for my solution one in #24965.",
    "created_at": "2018-03-14T11:21:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379843",
    "user": "https://github.com/videlec"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@videlec](#comment:35):
> My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.

I should have added: unless we go for my solution one in #24965.



---

archive/issue_comments_379844.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@videlec](#comment:38):\n> Replying to [@videlec](#comment:35):\n> > My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.\n\n> \n> I should have added: unless we go for my solution one in #24965.\n\nI have no problems with that, but can't contribute much.",
    "created_at": "2018-03-14T12:16:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379844",
    "user": "https://github.com/rwst"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@videlec](#comment:38):
> Replying to [@videlec](#comment:35):
> > My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.

> 
> I should have added: unless we go for my solution one in #24965.

I have no problems with that, but can't contribute much.



---

archive/issue_comments_379845.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@rwst](#comment:39):\n> Replying to [@videlec](#comment:38):\n> > Replying to [@videlec](#comment:35):\n> > > My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.\n\n> > \n> > I should have added: unless we go for my solution one in #24965.\n\n> \n> I have no problems with that, but can't contribute much.\n\nYou can at least give your opinion. \"My\" solution consists in removing three lines of code in `SymbolicRing._coerce_map_from_`\n\n```diff\n--- a/src/sage/symbolic/ring.pyx\n+++ b/src/sage/symbolic/ring.pyx\n@@ -199,9 +199,6 @@ cdef class SymbolicRing(CommutativeRing):\n             if ComplexField(mpfr_prec_min()).has_coerce_map_from(R):\n                 # Almost anything with a coercion into any precision of CC\n                 return R not in (RLF, CLF)\n-            elif is_PolynomialRing(R) or is_MPolynomialRing(R) or is_FractionField(R) or is_LaurentPolynomialRing(R):\n-                base = R.base_ring()\n-                return base is not self and self.has_coerce_map_from(base)\n             elif (R is InfinityRing or R is UnsignedInfinityRing\n                   or is_RealIntervalField(R) or is_ComplexIntervalField(R)\n                   or isinstance(R, RealBallField)\n```",
    "created_at": "2018-03-14T12:20:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379845",
    "user": "https://github.com/videlec"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@rwst](#comment:39):
> Replying to [@videlec](#comment:38):
> > Replying to [@videlec](#comment:35):
> > > My conclusion (for now): SR is terribly intrusive and does not play nicely with anything else from Sage.

> > 
> > I should have added: unless we go for my solution one in #24965.

> 
> I have no problems with that, but can't contribute much.

You can at least give your opinion. "My" solution consists in removing three lines of code in `SymbolicRing._coerce_map_from_`

```diff
--- a/src/sage/symbolic/ring.pyx
+++ b/src/sage/symbolic/ring.pyx
@@ -199,9 +199,6 @@ cdef class SymbolicRing(CommutativeRing):
             if ComplexField(mpfr_prec_min()).has_coerce_map_from(R):
                 # Almost anything with a coercion into any precision of CC
                 return R not in (RLF, CLF)
-            elif is_PolynomialRing(R) or is_MPolynomialRing(R) or is_FractionField(R) or is_LaurentPolynomialRing(R):
-                base = R.base_ring()
-                return base is not self and self.has_coerce_map_from(base)
             elif (R is InfinityRing or R is UnsignedInfinityRing
                   or is_RealIntervalField(R) or is_ComplexIntervalField(R)
                   or isinstance(R, RealBallField)
```



---

archive/issue_comments_379846.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nI see. The main consequence is that some symbolic functions that traditionally supported polynomials as arguments will need a separation into an interface taking all sorts of arguments, and the symbolic function class. Accidentally, for the orthogonal poly functions there is already a ticket that does that (#24554 needing review). For binomial there is already an interface (in arith) and a symbolic function, the only problem being that the import of the symbolic version overwrites the arith version on startup. There is #24178 for that but Jeroen opposed it. The split into global interface / symbolic function is inherently necessary because the symbolic function creation/call code restricts what is allowed as argument (even which kwds may be given), and I get no support to change that.\n\nThe other doctest failures I get are minor. All in all I support this change.",
    "created_at": "2018-03-14T14:17:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379846",
    "user": "https://github.com/rwst"
}
```

<div id="comment:41" align="right">comment:41</div>

I see. The main consequence is that some symbolic functions that traditionally supported polynomials as arguments will need a separation into an interface taking all sorts of arguments, and the symbolic function class. Accidentally, for the orthogonal poly functions there is already a ticket that does that (#24554 needing review). For binomial there is already an interface (in arith) and a symbolic function, the only problem being that the import of the symbolic version overwrites the arith version on startup. There is #24178 for that but Jeroen opposed it. The split into global interface / symbolic function is inherently necessary because the symbolic function creation/call code restricts what is allowed as argument (even which kwds may be given), and I get no support to change that.

The other doctest failures I get are minor. All in all I support this change.



---

archive/issue_comments_379847.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@videlec](#comment:40):\n>... \"My\" solution consists in removing three lines of code in `SymbolicRing._coerce_map_from_`\n\nAre you going to upload a branch with this? What's the plan?",
    "created_at": "2018-03-19T14:48:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379847",
    "user": "https://github.com/rwst"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@videlec](#comment:40):
>... "My" solution consists in removing three lines of code in `SymbolicRing._coerce_map_from_`

Are you going to upload a branch with this? What's the plan?



---

archive/issue_comments_379848.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nSimpler solution is to fix `change_ring` with #24942.",
    "created_at": "2018-03-22T09:13:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379848",
    "user": "https://github.com/videlec"
}
```

<div id="comment:43" align="right">comment:43</div>

Simpler solution is to fix `change_ring` with #24942.



---

archive/issue_comments_379849.json:
```json
{
    "body": "Dependencies: **#25022**",
    "created_at": "2018-03-22T09:13:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24942#issuecomment-379849",
    "user": "https://github.com/videlec"
}
```

Dependencies: **#25022**



---

archive/issue_events_345073.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-22T09:13:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345073"
}
```



---

archive/issue_events_345074.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-03-22T09:13:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345074"
}
```



---

archive/issue_events_345075.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:40:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24942",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24942#event-345075"
}
```
