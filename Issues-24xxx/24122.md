# Issue 24122: Use echelonize instead of echelon_form in a few places

archive/issues_023885.json:
```json
{
    "body": "We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.\n\nWe do this change in `__invert__`, `right_kernel_matrix`, and `_solve_right_nonsingular_square`.\n\nWe also can take advantage of the sparse structure and our knowledge of the augmented matrix [I|A<sup>-1</sup>] when reconstructing the matrix.\n\n\nBranch/Commit: cfbb77680533b3b2badc5177e3a00cea74c7ffa5\n\nReviewer: Vincent Delecroix\n\nAuthor: Travis Scrimshaw\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24122\n\n",
    "closed_at": "2017-12-11T01:03:22Z",
    "created_at": "2017-10-30T00:12:49Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Use echelonize instead of echelon_form in a few places",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24122",
    "user": "https://github.com/tscrim"
}
```
We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.

We do this change in `__invert__`, `right_kernel_matrix`, and `_solve_right_nonsingular_square`.

We also can take advantage of the sparse structure and our knowledge of the augmented matrix [I|A<sup>-1</sup>] when reconstructing the matrix.


Branch/Commit: cfbb77680533b3b2badc5177e3a00cea74c7ffa5

Reviewer: Vincent Delecroix

Author: Travis Scrimshaw

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24122





---

archive/issue_comments_456307.json:
```json
{
    "body": "Changing branch from \"\" to \"public/linear_algebra/echelonize_in_invert-24122\"",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456307",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "" to "public/linear_algebra/echelonize_in_invert-24122"



---

archive/issue_comments_456308.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456308",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_456309.json:
```json
{
    "body": "Changing author from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456309",
    "user": "https://github.com/tscrim"
}
```

Changing author from "" to "Travis Scrimshaw"



---

archive/issue_comments_456310.json:
```json
{
    "body": "<a id='comment:1'></a>Bad branch not based off `develop`. Fixed.",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456310",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>Bad branch not based off `develop`. Fixed.



---

archive/issue_comments_456311.json:
```json
{
    "body": "Changing commit from \"\" to \"d37d983d761414451b5d21ff12b732c5285d159c\"",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456311",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "" to "d37d983d761414451b5d21ff12b732c5285d159c"



---

archive/issue_comments_456312.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-30T00:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_456313.json:
```json
{
    "body": "Changing commit from \"d37d983d761414451b5d21ff12b732c5285d159c\" to \"3990da44ec263e5b6be38529ba56d92f0b761aa2\"",
    "created_at": "2017-10-30T00:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456313",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d37d983d761414451b5d21ff12b732c5285d159c" to "3990da44ec263e5b6be38529ba56d92f0b761aa2"



---

archive/issue_comments_456314.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-31T02:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456314",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456315.json:
```json
{
    "body": "Changing commit from \"3990da44ec263e5b6be38529ba56d92f0b761aa2\" to \"294150fc0e058372cc83be396b188c961536e7a5\"",
    "created_at": "2017-10-31T02:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456315",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3990da44ec263e5b6be38529ba56d92f0b761aa2" to "294150fc0e058372cc83be396b188c961536e7a5"



---

archive/issue_comments_456316.json:
```json
{
    "body": "Changing component from linear algebra to performance.",
    "created_at": "2017-10-31T02:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456316",
    "user": "https://github.com/tscrim"
}
```

Changing component from linear algebra to performance.



---

archive/issue_comments_456317.json:
```json
{
    "body": "<a id='comment:4'></a>This last change nets me ~8% speedup:\n\n```\nsage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)\n10 loops, best of 3: 159 ms per loop\nsage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)\n10 loops, best of 3: 28.6 ms per loop\nsage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)\nThe slowest run took 24.10 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.27 ms per loop\n```\nversus\n\n```\nsage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)\n10 loops, best of 3: 167 ms per loop\nsage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)\n10 loops, best of 3: 30.7 ms per loop\nsage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)\n1000 loops, best of 3: 1.36 ms per loop\n```",
    "created_at": "2017-10-31T02:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456317",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>This last change nets me ~8% speedup:

```
sage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)
10 loops, best of 3: 159 ms per loop
sage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)
10 loops, best of 3: 28.6 ms per loop
sage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)
The slowest run took 24.10 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.27 ms per loop
```
versus

```
sage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)
10 loops, best of 3: 167 ms per loop
sage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)
10 loops, best of 3: 30.7 ms per loop
sage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)
1000 loops, best of 3: 1.36 ms per loop
```



---

archive/issue_comments_456318.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.\n+\n+We also can take advantage of the sparse structure and our knowledge of the augmented matrix [I|A<sup>-1</sup>] when reconstructing the matrix.\n``````\n",
    "created_at": "2017-10-31T02:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456318",
    "user": "https://github.com/tscrim"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.
+
+We also can take advantage of the sparse structure and our knowledge of the augmented matrix [I|A<sup>-1</sup>] when reconstructing the matrix.
``````




---

archive/issue_comments_456319.json:
```json
{
    "body": "<a id='comment:5'></a>Also versus `develop`, which this test is not so good for showing how the first change would improve things as the matrices are relatively tiny:\n\n```\nsage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)\n10 loops, best of 3: 171 ms per loop\nsage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)\n10 loops, best of 3: 30.2 ms per loop\nsage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)\nThe slowest run took 11.65 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.3 ms per loop\n```",
    "created_at": "2017-10-31T02:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456319",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Also versus `develop`, which this test is not so good for showing how the first change would improve things as the matrices are relatively tiny:

```
sage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)
10 loops, best of 3: 171 ms per loop
sage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)
10 loops, best of 3: 30.2 ms per loop
sage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)
The slowest run took 11.65 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.3 ms per loop
```



---

archive/issue_comments_456320.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,6 @@\n We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.\n \n+We do this change in `__invert__`, `right_kernel_matrix`, and `_solve_right_nonsingular_square`.\n+\n We also can take advantage of the sparse structure and our knowledge of the augmented matrix [I|A<sup>-1</sup>] when reconstructing the matrix.\n+\n``````\n",
    "created_at": "2017-11-01T06:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456320",
    "user": "https://github.com/tscrim"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,6 @@
 We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.
 
+We do this change in `__invert__`, `right_kernel_matrix`, and `_solve_right_nonsingular_square`.
+
 We also can take advantage of the sparse structure and our knowledge of the augmented matrix [I|A<sup>-1</sup>] when reconstructing the matrix.
+
``````




---

archive/issue_comments_456321.json:
```json
{
    "body": "Changing commit from \"294150fc0e058372cc83be396b188c961536e7a5\" to \"d6e5a091afd875c1e0c1df0919f1e5b6d3bc553f\"",
    "created_at": "2017-11-01T06:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456321",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "294150fc0e058372cc83be396b188c961536e7a5" to "d6e5a091afd875c1e0c1df0919f1e5b6d3bc553f"



---

archive/issue_comments_456322.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-01T06:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456322",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456323.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-09T00:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456323",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456324.json:
```json
{
    "body": "Changing commit from \"d6e5a091afd875c1e0c1df0919f1e5b6d3bc553f\" to \"cfbb77680533b3b2badc5177e3a00cea74c7ffa5\"",
    "created_at": "2017-11-09T00:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456324",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d6e5a091afd875c1e0c1df0919f1e5b6d3bc553f" to "cfbb77680533b3b2badc5177e3a00cea74c7ffa5"



---

archive/issue_comments_456325.json:
```json
{
    "body": "<a id='comment:9'></a>This is a bit weird\n\n```\n+        for i in range(nrows):\n+            del data[i,i]\n+        data = {(r,c-nrows): data[r,c] for (r,c) in data}\n```\nYou are modifying `data` and then override it. If you can not do the modification inplace, the following looks simpler\n\n```\ndata = {(r,c-nrows): data[r,c] for (r,c) in data if c >= nrows}\n```",
    "created_at": "2017-11-10T19:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456325",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>This is a bit weird

```
+        for i in range(nrows):
+            del data[i,i]
+        data = {(r,c-nrows): data[r,c] for (r,c) in data}
```
You are modifying `data` and then override it. If you can not do the modification inplace, the following looks simpler

```
data = {(r,c-nrows): data[r,c] for (r,c) in data if c >= nrows}
```



---

archive/issue_comments_456326.json:
```json
{
    "body": "<a id='comment:10'></a>Yes, it looks more simple, but it actually takes longer because it has to do the `if` check on every nonzero object. Whereas the version I have just removes objects from the `dict`. I suspect this is more of a micro improvement, but that could be a lot of extra checks for a really big sparse matrix (at least, I have a 62001 x 62001 sparse matrix with 1756951 non-zero entries).\n\nIdeally I would like to modify the data in place and just update the indices, but hash tables are not good for doing that. One of these days, someone (me) should implement another data structure for sparse matrices...",
    "created_at": "2017-11-10T23:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456326",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Yes, it looks more simple, but it actually takes longer because it has to do the `if` check on every nonzero object. Whereas the version I have just removes objects from the `dict`. I suspect this is more of a micro improvement, but that could be a lot of extra checks for a really big sparse matrix (at least, I have a 62001 x 62001 sparse matrix with 1756951 non-zero entries).

Ideally I would like to modify the data in place and just update the indices, but hash tables are not good for doing that. One of these days, someone (me) should implement another data structure for sparse matrices...



---

archive/issue_comments_456327.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2017-11-11T10:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456327",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_456328.json:
```json
{
    "body": "<a id='comment:11'></a>Oh, I see.\n\nNote that for matrices over ZZ or QQ, there is a custom C datatype which is an array of sparse vectors. This is not ideal but already faster than dictionaries in most contexts.",
    "created_at": "2017-11-11T10:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456328",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Oh, I see.

Note that for matrices over ZZ or QQ, there is a custom C datatype which is an array of sparse vectors. This is not ideal but already faster than dictionaries in most contexts.



---

archive/issue_comments_456329.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-12T20:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456329",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_456330.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks for the review.",
    "created_at": "2017-11-12T22:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456330",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Thanks for the review.



---

archive/issue_comments_456331.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456331",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061210.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:03:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24122#event-61210"
}
```



---

archive/issue_comments_456332.json:
```json
{
    "body": "Changing branch from \"public/linear_algebra/echelonize_in_invert-24122\" to \"cfbb77680533b3b2badc5177e3a00cea74c7ffa5\"",
    "created_at": "2017-12-11T01:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24122#issuecomment-456332",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/linear_algebra/echelonize_in_invert-24122" to "cfbb77680533b3b2badc5177e3a00cea74c7ffa5"
