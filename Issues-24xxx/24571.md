# Issue 24571: Orthogonal groups of TorsionQuadraticModules

archive/issues_024334.json:
```json
{
    "body": "If `T` is a torsion quadratic module, then the orthogonal group consists of those group automorphisms that preserve the torsion quadratic form and bilinear form.\n\n- We can derive this from `sage.groups.abelian_gps.abelian_aut.AbelianGroupAutomorphismGroup_generic`#24087.\n- The class should interact well with `FGP_module_homomorphisms`,\n- If `T` is the discrimiant group of an `IntegralLattice` then there should be a coercion from the orthogonal group of the lattice. \n- Of course there `O(T)` must act consistently on elements of `T`.\n\nGenerators are hard to come by though ... \n\nCC:  @tscrim @videlec\n\nReviewer: Travis Scrimshaw\n\nAuthor: Simon Brandhorst\n\nBranch: c4885805e7fe8589975a25d0e7e3587197b7e47f\n\nDependencies: #24036,#24035,#24087,#24521\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24571\n\n",
    "closed_at": "2020-02-26T20:35:39Z",
    "created_at": "2018-01-19T15:44:54Z",
    "labels": [
        "component: group theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Orthogonal groups of TorsionQuadraticModules",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24571",
    "user": "https://github.com/simonbrandhorst"
}
```
If `T` is a torsion quadratic module, then the orthogonal group consists of those group automorphisms that preserve the torsion quadratic form and bilinear form.

- We can derive this from `sage.groups.abelian_gps.abelian_aut.AbelianGroupAutomorphismGroup_generic`#24087.
- The class should interact well with `FGP_module_homomorphisms`,
- If `T` is the discrimiant group of an `IntegralLattice` then there should be a coercion from the orthogonal group of the lattice. 
- Of course there `O(T)` must act consistently on elements of `T`.

Generators are hard to come by though ... 

CC:  @tscrim @videlec

Reviewer: Travis Scrimshaw

Author: Simon Brandhorst

Branch: c4885805e7fe8589975a25d0e7e3587197b7e47f

Dependencies: #24036,#24035,#24087,#24521

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24571





---

archive/issue_comments_340343.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to group theory.",
    "created_at": "2018-01-24T08:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340343",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing component from PLEASE CHANGE to group theory.



---

archive/issue_comments_340344.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-01-24T08:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340344",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_340345.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-28T08:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340345",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340346.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-29T08:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340346",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340347.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-31T18:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340347",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340348.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-14T09:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340348",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340349.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-14T18:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340349",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340350.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-06T15:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340350",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340351.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-06T15:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340351",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340352.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-07T15:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340352",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340353.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-13T21:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340353",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340354.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-16T06:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340354",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340355.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-16T06:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340356.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-16T08:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340356",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340357.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-16T10:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340357",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340358.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-17T09:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340358",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_061953.json:
```json
{
    "actor": "https://github.com/simonbrandhorst",
    "created_at": "2020-01-08T16:13:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24571#event-61953"
}
```



---

archive/issue_comments_340359.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-08T16:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340359",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340360.json:
```json
{
    "body": "<a id='comment:18'></a>Added a slow brute force fallback to compute the generators.\nIn general one can \"write down\" the generators, but that took me a few thousand lines of code. I'll turn that into an optional package sometimes...\nMeanwhile this should do it. \n\n---\nNew commits:",
    "created_at": "2020-01-08T16:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340360",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:18'></a>Added a slow brute force fallback to compute the generators.
In general one can "write down" the generators, but that took me a few thousand lines of code. I'll turn that into an optional package sometimes...
Meanwhile this should do it. 

---
New commits:



---

archive/issue_comments_340361.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-18T10:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340361",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340362.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-18T10:48:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340362",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340363.json:
```json
{
    "body": "<a id='comment:23'></a>A bunch of little things:\n\nFor the first line of the module, it gets displayed as a title. So could you remove the period/full-stop at the end? Also, I think it should follow title capitalization, but Sage is not so consistent about this...\n\nPEP8 nitpick (just because changes are being done):\n\n```diff\n-return x*self\n+return x * self\n```\nand a few other similar such things.\n\n```diff\n     INPUT:\n \n-        - ``T`` a non degenerate torsion quadratic module.\n+    - ``T`` -- a non degenerate torsion quadratic module\n```\n\n`FqfOrthogonalGroup.__init__` is missing its docstring (and a `TestSuite(foo).run()` call).\n\n```diff\n-if not fqf.invariants() == ambient.domain().gens_orders():\n+if fqf.invariants() != ambient.domain().gens_orders():\n```\n\n```diff\n-        if check:\n-            for g in self.gens():\n-                if not self._preserves_form(g):\n-                    raise ValueError(\"%s does not preserve the quadratic form\"%g)\n+        if check and any(not self._preserves_form(g) for g in self.gens()):\n+            raise ValueError(\"%s does not preserve the quadratic form\"%g)\n```\n\nDo you really want specific type checking here and not subclass\n\n```python\nif not type(x) is GapElement:\n```\ncompared to `if not isinstance(x, GapElement):`?\n\nThe `_preserves_form` could be condensed into an `all()` statement:\n\n```python\nreturn all((gi*f).q() != gi.q() and all((gi*f).b(g[j]*f) != (gi*f).b(g[j]*f)\n                                        for j in range(i+1, len(g)))\n           for i, gi in enumerate(g)\n```\n\n```diff\n-        WARNING:\n+        .. WARNING::\n \n-        This is usually smaller than the orthogonal group of the bilinear form.\n+            This is usually smaller than the orthogonal group of the bilinear form.\n```\n\nI don't understand these lines here:\n\n```python\n        try:\n            gens = [matrix(x*g for x in self.smith_form_gens()) for g in gens]\n        except TypeError:\n            pass\n```\nWhy should it continue without modifying `gens`? It might be good to include this as a comment in the code.",
    "created_at": "2020-02-18T12:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340363",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>A bunch of little things:

For the first line of the module, it gets displayed as a title. So could you remove the period/full-stop at the end? Also, I think it should follow title capitalization, but Sage is not so consistent about this...

PEP8 nitpick (just because changes are being done):

```diff
-return x*self
+return x * self
```
and a few other similar such things.

```diff
     INPUT:
 
-        - ``T`` a non degenerate torsion quadratic module.
+    - ``T`` -- a non degenerate torsion quadratic module
```

`FqfOrthogonalGroup.__init__` is missing its docstring (and a `TestSuite(foo).run()` call).

```diff
-if not fqf.invariants() == ambient.domain().gens_orders():
+if fqf.invariants() != ambient.domain().gens_orders():
```

```diff
-        if check:
-            for g in self.gens():
-                if not self._preserves_form(g):
-                    raise ValueError("%s does not preserve the quadratic form"%g)
+        if check and any(not self._preserves_form(g) for g in self.gens()):
+            raise ValueError("%s does not preserve the quadratic form"%g)
```

Do you really want specific type checking here and not subclass

```python
if not type(x) is GapElement:
```
compared to `if not isinstance(x, GapElement):`?

The `_preserves_form` could be condensed into an `all()` statement:

```python
return all((gi*f).q() != gi.q() and all((gi*f).b(g[j]*f) != (gi*f).b(g[j]*f)
                                        for j in range(i+1, len(g)))
           for i, gi in enumerate(g)
```

```diff
-        WARNING:
+        .. WARNING::
 
-        This is usually smaller than the orthogonal group of the bilinear form.
+            This is usually smaller than the orthogonal group of the bilinear form.
```

I don't understand these lines here:

```python
        try:
            gens = [matrix(x*g for x in self.smith_form_gens()) for g in gens]
        except TypeError:
            pass
```
Why should it continue without modifying `gens`? It might be good to include this as a comment in the code.



---

archive/issue_comments_340364.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-18T14:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340364",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340365.json:
```json
{
    "body": "<a id='comment:25'></a>```\nFile \"src/sage/groups/fqf_orthogonal.py\", line 190, in sage.groups.fqf_orthogonal.FqfOrthogonalGroup.invariant_form\nFailed example:\n    Oq.invariant_form() is T\nExpected:\n    True\nGot:\n    False\n```\nBut in an interactive session I get\n\n```\nsage: q = matrix.diagonal(QQ, [2/3])\n....: T = TorsionQuadraticForm(q)\n....: Oq = T.orthogonal_group()\n....: Oq.invariant_form() is T\n....: \nTrue\n```\nCan you reproduce this behavior? What is going on?",
    "created_at": "2020-02-18T14:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340365",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:25'></a>```
File "src/sage/groups/fqf_orthogonal.py", line 190, in sage.groups.fqf_orthogonal.FqfOrthogonalGroup.invariant_form
Failed example:
    Oq.invariant_form() is T
Expected:
    True
Got:
    False
```
But in an interactive session I get

```
sage: q = matrix.diagonal(QQ, [2/3])
....: T = TorsionQuadraticForm(q)
....: Oq = T.orthogonal_group()
....: Oq.invariant_form() is T
....: 
True
```
Can you reproduce this behavior? What is going on?



---

archive/issue_comments_340366.json:
```json
{
    "body": "<a id='comment:26'></a>You have to create it twice to see it (see lines 71-74 (side note, probably be better to call the `TorsionQuadraticForm` `T` instead of reusing `q`)):\n\n```\nsage: qp = matrix.diagonal(QQ, [2/3])\nsage: Tp = TorsionQuadraticForm(qp)\nsage: Gp = Tp.orthogonal_group()\nsage: Gp.invariant_form() is Tp\nTrue\nsage: q = matrix.diagonal(QQ, [2/3])\nsage: T = TorsionQuadraticForm(q)\nsage: G = DiGraph([[1,2],[2,3]])\nsage: Oq = T.orthogonal_group()\nsage: Oq.invariant_form() is T\nFalse\n```\nSomething is not being set correctly in a cache somewhere:\n\n```\nsage: T is Tp\nFalse\nsage: Oq.invariant_form() is Tp\nTrue\nsage: Oq is Gp\nTrue\n```\nMy solution would be to make the results from `TorsionQuadraticForm` to be `UniqueRepresentation`. Otherwise just weaken the test slightly to be `==` instead of `is` (and make a clear note saying that the result does not have the unique representation property). (Side question: why aren't the (only ambient?) free modules in Sage a `UniqueRepresentation`?)",
    "created_at": "2020-02-19T00:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340366",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>You have to create it twice to see it (see lines 71-74 (side note, probably be better to call the `TorsionQuadraticForm` `T` instead of reusing `q`)):

```
sage: qp = matrix.diagonal(QQ, [2/3])
sage: Tp = TorsionQuadraticForm(qp)
sage: Gp = Tp.orthogonal_group()
sage: Gp.invariant_form() is Tp
True
sage: q = matrix.diagonal(QQ, [2/3])
sage: T = TorsionQuadraticForm(q)
sage: G = DiGraph([[1,2],[2,3]])
sage: Oq = T.orthogonal_group()
sage: Oq.invariant_form() is T
False
```
Something is not being set correctly in a cache somewhere:

```
sage: T is Tp
False
sage: Oq.invariant_form() is Tp
True
sage: Oq is Gp
True
```
My solution would be to make the results from `TorsionQuadraticForm` to be `UniqueRepresentation`. Otherwise just weaken the test slightly to be `==` instead of `is` (and make a clear note saying that the result does not have the unique representation property). (Side question: why aren't the (only ambient?) free modules in Sage a `UniqueRepresentation`?)



---

archive/issue_comments_340367.json:
```json
{
    "body": "<a id='comment:27'></a>My guess is that the creation of ambient free modules predates `UniqueRepresentation` and no one cared enough to change it.\n\nIndeed, it seems that torsion quadratic modules are not uniquely represented while FGP_modules are. But not via `UniqueRepresentation`.\nIn the computation of the orthogonal group we have the call\n\n```\n  Oq =  FqfOrthogonalGroup(ambient, gens, self, check=check)\n```\nwhich returns an instance of `UniqueRepresentation`.\n\n```\nsage: isinstance(Oq,UniqueRepresentation)\nTrue\n```\nTo do that, it uses the hash of `ambient`, `gens` and `self`\nbut `self` is not uniquely determined (`is`) by its hash (only up to `==`). \n\nWe could make FGP_Modules a `UniqueRepresentation` and do the same with `TorsionQuadraticModule`",
    "created_at": "2020-02-19T19:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340367",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:27'></a>My guess is that the creation of ambient free modules predates `UniqueRepresentation` and no one cared enough to change it.

Indeed, it seems that torsion quadratic modules are not uniquely represented while FGP_modules are. But not via `UniqueRepresentation`.
In the computation of the orthogonal group we have the call

```
  Oq =  FqfOrthogonalGroup(ambient, gens, self, check=check)
```
which returns an instance of `UniqueRepresentation`.

```
sage: isinstance(Oq,UniqueRepresentation)
True
```
To do that, it uses the hash of `ambient`, `gens` and `self`
but `self` is not uniquely determined (`is`) by its hash (only up to `==`). 

We could make FGP_Modules a `UniqueRepresentation` and do the same with `TorsionQuadraticModule`



---

archive/issue_comments_340368.json:
```json
{
    "body": "<a id='comment:28'></a>Another option would be to remove the `UniqueRepresentation` from\n`AbelianGroupAutomorphismGroup_gap` which is fine for me.",
    "created_at": "2020-02-19T19:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340368",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:28'></a>Another option would be to remove the `UniqueRepresentation` from
`AbelianGroupAutomorphismGroup_gap` which is fine for me.



---

archive/issue_comments_340369.json:
```json
{
    "body": "<a id='comment:29'></a>I would make them `UniqueRepresentation`s as the coercion framework works a lot better with them, it comes with pickling, and is faster when doing equality testing. It might be sufficient to just do `TorsionQuadraticModule` for this doctest. The `UniqueRepresentation` key only compares things up to `==`, not `is`.",
    "created_at": "2020-02-19T21:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340369",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:29'></a>I would make them `UniqueRepresentation`s as the coercion framework works a lot better with them, it comes with pickling, and is faster when doing equality testing. It might be sufficient to just do `TorsionQuadraticModule` for this doctest. The `UniqueRepresentation` key only compares things up to `==`, not `is`.



---

archive/issue_comments_340370.json:
```json
{
    "body": "<a id='comment:30'></a>How about `CachedRepresentation` instead? Like for symmetric groups?",
    "created_at": "2020-02-19T21:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340370",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:30'></a>How about `CachedRepresentation` instead? Like for symmetric groups?



---

archive/issue_comments_340371.json:
```json
{
    "body": "<a id='comment:31'></a>At the moment I am trying to turn `FGP_Module` into a `UniqueRepresentation` but it breaks a lot of code elsewhere with non-hashable input. So maybe just doing `TorsionQuadraticModule` is okay.",
    "created_at": "2020-02-19T21:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340371",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:31'></a>At the moment I am trying to turn `FGP_Module` into a `UniqueRepresentation` but it breaks a lot of code elsewhere with non-hashable input. So maybe just doing `TorsionQuadraticModule` is okay.



---

archive/issue_comments_340372.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-19T21:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340372",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340373.json:
```json
{
    "body": "<a id='comment:33'></a>For reason to use CachedRepresentation instead of UniqueRepresentation\nI quote its\n\n```\nIn many applications, one wants to combine unique instance and cached\nrepresentation behaviour. This is called *unique representation* behaviour.\nWe have seen above that symmetric groups have a *cached* representation\nbehaviour. However, they do not show the *unique* representation behaviour,\nsince they are equal to groups created in a totally different way, namely to\nsubgroups::\n\n    sage: G = SymmetricGroup(6)\n    sage: G3 = G.subgroup([G((1,2,3,4,5,6)),G((1,2))])\n    sage: G is G3\n    False\n    sage: type(G) == type(G3)\n    False\n    sage: G == G3\n    True\n\n```\nThe same reasoning applies to both `TorsionQuadraticModule` and `AbelianGroupAutomorphismGroup_gap`",
    "created_at": "2020-02-19T22:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340373",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:33'></a>For reason to use CachedRepresentation instead of UniqueRepresentation
I quote its

```
In many applications, one wants to combine unique instance and cached
representation behaviour. This is called *unique representation* behaviour.
We have seen above that symmetric groups have a *cached* representation
behaviour. However, they do not show the *unique* representation behaviour,
since they are equal to groups created in a totally different way, namely to
subgroups::

    sage: G = SymmetricGroup(6)
    sage: G3 = G.subgroup([G((1,2,3,4,5,6)),G((1,2))])
    sage: G is G3
    False
    sage: type(G) == type(G3)
    False
    sage: G == G3
    True

```
The same reasoning applies to both `TorsionQuadraticModule` and `AbelianGroupAutomorphismGroup_gap`



---

archive/issue_comments_340374.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:23 tscrim]:\n> The `_preserves_form` could be condensed into an `all()` statement:\n> \n> ```python\n> return all((gi*f).q() != gi.q() and all((gi*f).b(g[j]*f) != (gi*f).b(g[j]*f)\n>                                         for j in range(i+1, len(g)))\n>            for i, gi in enumerate(g)\n> ```\n\nWhat is the benefit of this? I do not find it more aesthetic. \nIs it faster?",
    "created_at": "2020-02-19T22:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340374",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:34'></a>Replying to [comment:23 tscrim]:
> The `_preserves_form` could be condensed into an `all()` statement:
> 
> ```python
> return all((gi*f).q() != gi.q() and all((gi*f).b(g[j]*f) != (gi*f).b(g[j]*f)
>                                         for j in range(i+1, len(g)))
>            for i, gi in enumerate(g)
> ```

What is the benefit of this? I do not find it more aesthetic. 
Is it faster?



---

archive/issue_comments_340375.json:
```json
{
    "body": "<a id='comment:35'></a>For comment:34: yes, it is faster.\n\nFor comment:33: I don't see that for `TorsionQuadraticModule` or `AbelianGroupAutomorphismGroup_gap`. For the symmetric groups, you can realize, e.g., `S_4` as either the group itself or as the natural subgroup of `S_5`. Since these are the same permutation group, the problem arises from `UniqueRepresentation` as the latter should know it is a subgroup but the former should not. Here, the `AbelianGroupAutomorphismGroup_gap` is created only as a specific (sub)group of automorphisms. The same reasoning holds true for `TorsionQuadraticModule`: it is identified with unique additional data.\n\nFor `FGP_Module`, this is not the case as the same Python class (representing the same module) can be created in different ways that carry different information. So I agree that this should not be a `UniqueRepresentation`.",
    "created_at": "2020-02-19T22:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340375",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:35'></a>For comment:34: yes, it is faster.

For comment:33: I don't see that for `TorsionQuadraticModule` or `AbelianGroupAutomorphismGroup_gap`. For the symmetric groups, you can realize, e.g., `S_4` as either the group itself or as the natural subgroup of `S_5`. Since these are the same permutation group, the problem arises from `UniqueRepresentation` as the latter should know it is a subgroup but the former should not. Here, the `AbelianGroupAutomorphismGroup_gap` is created only as a specific (sub)group of automorphisms. The same reasoning holds true for `TorsionQuadraticModule`: it is identified with unique additional data.

For `FGP_Module`, this is not the case as the same Python class (representing the same module) can be created in different ways that carry different information. So I agree that this should not be a `UniqueRepresentation`.



---

archive/issue_comments_340376.json:
```json
{
    "body": "<a id='comment:36'></a>`UniqueRepresentation`, that is, equality if and only if it is the same object would change the behavior.\n\n```\nsage: q = TorsionQuadraticForm(matrix([2/3]))\nsage: q1 = q.submodule_with_gens([2*q.0])\nsage: q == q1\nTrue\nsage: q is q1\nFalse\n```\nYou can have the same group with different generators.\n\nTo me `any` is twice as slow as a simple for loop.\n\n```\nsage: def test(k):\n....:     for i in range(k):\n....:         if False:\n....:             break\n....:         \nsage: %timeit test(10^9)\n1 loop, best of 5: 18.6 s per loop\nsage: %timeit any(False for i in range(10^9))\n1 loop, best of 5: 43.4 s per loop\nsage: %timeit any(False for i in range(10^5))\nThe slowest run took 4.35 times longer than the fastest. This could mean that an intermediate result is being cached.\n100 loops, best of 5: 3.9 ms per loop\nsage: %timeit any(False for i in range(10^5))\n100 loops, best of 5: 3.88 ms per loop\nsage: %timeit test(10^5)\nThe slowest run took 4.28 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 5: 1.73 ms per loop\nsage: %timeit test(10^5)\n\n```",
    "created_at": "2020-02-20T09:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340376",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:36'></a>`UniqueRepresentation`, that is, equality if and only if it is the same object would change the behavior.

```
sage: q = TorsionQuadraticForm(matrix([2/3]))
sage: q1 = q.submodule_with_gens([2*q.0])
sage: q == q1
True
sage: q is q1
False
```
You can have the same group with different generators.

To me `any` is twice as slow as a simple for loop.

```
sage: def test(k):
....:     for i in range(k):
....:         if False:
....:             break
....:         
sage: %timeit test(10^9)
1 loop, best of 5: 18.6 s per loop
sage: %timeit any(False for i in range(10^9))
1 loop, best of 5: 43.4 s per loop
sage: %timeit any(False for i in range(10^5))
The slowest run took 4.35 times longer than the fastest. This could mean that an intermediate result is being cached.
100 loops, best of 5: 3.9 ms per loop
sage: %timeit any(False for i in range(10^5))
100 loops, best of 5: 3.88 ms per loop
sage: %timeit test(10^5)
The slowest run took 4.28 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 5: 1.73 ms per loop
sage: %timeit test(10^5)

```



---

archive/issue_comments_340377.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:36 sbrandhorst]:\n> `UniqueRepresentation`, that is, equality if and only if it is the same object would change the behavior.\n> \n> ```\n> sage: q = TorsionQuadraticForm(matrix([2/3]))\n> sage: q1 = q.submodule_with_gens([2*q.0])\n> sage: q == q1\n> True\n> sage: q is q1\n> False\n> ```\n> You can have the same group with different generators.\n\n\nI see. I was thinking the extra construction data would make you want to distinguish them via equality. Okay, then using `CachedRepresentation` is good.\n\n> To me `any` is twice as slow as a simple for loop.\n> \n> ```\n> sage: def test(k):\n> ....:     for i in range(k):\n> ....:         if False:\n> ....:             break\n> ....:         \n> sage: %timeit test(10^9)\n> 1 loop, best of 5: 18.6 s per loop\n> sage: %timeit any(False for i in range(10^9))\n> 1 loop, best of 5: 43.4 s per loop\n> sage: %timeit any(False for i in range(10^5))\n> The slowest run took 4.35 times longer than the fastest. This could mean that an intermediate result is being cached.\n> 100 loops, best of 5: 3.9 ms per loop\n> sage: %timeit any(False for i in range(10^5))\n> 100 loops, best of 5: 3.88 ms per loop\n> sage: %timeit test(10^5)\n> The slowest run took 4.28 times longer than the fastest. This could mean that an intermediate result is being cached.\n> 1000 loops, best of 5: 1.73 ms per loop\n> sage: %timeit test(10^5)\n> \n> ```\n\n\nWhen I change it to a non-trivial test, I get nearly the same timings, but with an extra 3ms for the `any` and `all`. So they are essentially the same in any practical scenario. Maybe something has changed in Python3 compared to Python2? I definitely did test this previously and saw a speedup... Oh well. I agree the current code with `for` loops is easier to understand. However, I still recommend using `for i,gi in enumerate(g):`. You may also want to have `g[i]*f` into a separate variable so you are not recomputing it a bunch of times (about 2n<sup>2</sup> times in total in fact).",
    "created_at": "2020-02-20T10:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340377",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:37'></a>Replying to [comment:36 sbrandhorst]:
> `UniqueRepresentation`, that is, equality if and only if it is the same object would change the behavior.
> 
> ```
> sage: q = TorsionQuadraticForm(matrix([2/3]))
> sage: q1 = q.submodule_with_gens([2*q.0])
> sage: q == q1
> True
> sage: q is q1
> False
> ```
> You can have the same group with different generators.


I see. I was thinking the extra construction data would make you want to distinguish them via equality. Okay, then using `CachedRepresentation` is good.

> To me `any` is twice as slow as a simple for loop.
> 
> ```
> sage: def test(k):
> ....:     for i in range(k):
> ....:         if False:
> ....:             break
> ....:         
> sage: %timeit test(10^9)
> 1 loop, best of 5: 18.6 s per loop
> sage: %timeit any(False for i in range(10^9))
> 1 loop, best of 5: 43.4 s per loop
> sage: %timeit any(False for i in range(10^5))
> The slowest run took 4.35 times longer than the fastest. This could mean that an intermediate result is being cached.
> 100 loops, best of 5: 3.9 ms per loop
> sage: %timeit any(False for i in range(10^5))
> 100 loops, best of 5: 3.88 ms per loop
> sage: %timeit test(10^5)
> The slowest run took 4.28 times longer than the fastest. This could mean that an intermediate result is being cached.
> 1000 loops, best of 5: 1.73 ms per loop
> sage: %timeit test(10^5)
> 
> ```


When I change it to a non-trivial test, I get nearly the same timings, but with an extra 3ms for the `any` and `all`. So they are essentially the same in any practical scenario. Maybe something has changed in Python3 compared to Python2? I definitely did test this previously and saw a speedup... Oh well. I agree the current code with `for` loops is easier to understand. However, I still recommend using `for i,gi in enumerate(g):`. You may also want to have `g[i]*f` into a separate variable so you are not recomputing it a bunch of times (about 2n<sup>2</sup> times in total in fact).



---

archive/issue_comments_340378.json:
```json
{
    "body": "<a id='comment:38'></a>Good point.",
    "created_at": "2020-02-20T11:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340378",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:38'></a>Good point.



---

archive/issue_comments_340379.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T11:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340379",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340380.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T11:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340380",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340381.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T19:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340381",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340382.json:
```json
{
    "body": "<a id='comment:42'></a>O.K. it should be ready now.",
    "created_at": "2020-02-20T19:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340382",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:42'></a>O.K. it should be ready now.



---

archive/issue_comments_340383.json:
```json
{
    "body": "<a id='comment:43'></a>Thank you for the changes.\n\nLast time I checked, it (surprisingly) is faster to do\n\n```diff\n-gf = tuple(h*f for h in g)\n+gf = tuple([h*f for h in g])\n```\nHowever, I might not do that because then it doesn't take advantage of short-circuiting and it puts everything in memory. So there is a design choice to be made here. I guess it depends on how often you think it will pass through every element in the list at least once before failing and if `g` is expected to be a \"short\" list (in some appropriate sense of the word). You know more the use-cases than I do. This probably is the correct thing to do, but I just wanted to check that you thought about these things as well.\n\nFinally, this change (2x) should be reverted:\n\n```diff\n-        .. WARNING::\n+        ..WARNING::\n```",
    "created_at": "2020-02-21T02:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340383",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:43'></a>Thank you for the changes.

Last time I checked, it (surprisingly) is faster to do

```diff
-gf = tuple(h*f for h in g)
+gf = tuple([h*f for h in g])
```
However, I might not do that because then it doesn't take advantage of short-circuiting and it puts everything in memory. So there is a design choice to be made here. I guess it depends on how often you think it will pass through every element in the list at least once before failing and if `g` is expected to be a "short" list (in some appropriate sense of the word). You know more the use-cases than I do. This probably is the correct thing to do, but I just wanted to check that you thought about these things as well.

Finally, this change (2x) should be reverted:

```diff
-        .. WARNING::
+        ..WARNING::
```



---

archive/issue_comments_340384.json:
```json
{
    "body": "<a id='comment:44'></a>I guess the common use case is to create a subgroup from some hand-made matrices with `check=True`.\nThen they are tested to preserve the form. If the user did not fuck up, the answer is `True` every time so that the check goes through the whole tuple. \nAre you saying that `gf = tuple(h*f for h in g)` is not expanded in memory?",
    "created_at": "2020-02-21T08:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340384",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:44'></a>I guess the common use case is to create a subgroup from some hand-made matrices with `check=True`.
Then they are tested to preserve the form. If the user did not fuck up, the answer is `True` every time so that the check goes through the whole tuple. 
Are you saying that `gf = tuple(h*f for h in g)` is not expanded in memory?



---

archive/issue_comments_340385.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-21T08:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340385",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340386.json:
```json
{
    "body": "<a id='comment:46'></a>I guess if we want speed, the right thing to do is to make `fgp_element.py` a cython file first.\nBut that is certainly for another ticket.",
    "created_at": "2020-02-21T08:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340386",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:46'></a>I guess if we want speed, the right thing to do is to make `fgp_element.py` a cython file first.
But that is certainly for another ticket.



---

archive/issue_comments_340387.json:
```json
{
    "body": "<a id='comment:47'></a>Fair enough. Thank you. Positive review.",
    "created_at": "2020-02-21T08:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340387",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:47'></a>Fair enough. Thank you. Positive review.



---

archive/issue_comments_340388.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-21T08:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340388",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340389.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-02-22T18:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340389",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_340390.json:
```json
{
    "body": "<a id='comment:48'></a>On python 2:\n\n```\n**********************************************************************\nFile \"src/sage/groups/fqf_orthogonal.py\", line 12, in sage.groups.fqf_orthogonal\nFailed example:\n    T = L.discriminant_group()\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.groups.fqf_orthogonal[1]>\", line 1, in <module>\n        T = L.discriminant_group()\n      File \"sage/misc/cachefunc.pyx\", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)\n        w = self._instance_call(*args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)\n        return self.f(self._instance, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/modules/free_quadratic_module_integer_symmetric.py\", line 808, in discriminant_group\n        D = TorsionQuadraticModule(self.dual_lattice(), self)\n      File \"sage/misc/classcall_metaclass.pyx\", line 334, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)\n        return cls.classcall(cls, *args, **kwds)\n    TypeError: unbound method __classcall__() must be called with TorsionQuadraticModule instance as first argument (got ClasscallMetaclass instance instead)\n**********************************************************************\n```",
    "created_at": "2020-02-22T18:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340390",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:48'></a>On python 2:

```
**********************************************************************
File "src/sage/groups/fqf_orthogonal.py", line 12, in sage.groups.fqf_orthogonal
Failed example:
    T = L.discriminant_group()
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.fqf_orthogonal[1]>", line 1, in <module>
        T = L.discriminant_group()
      File "sage/misc/cachefunc.pyx", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)
        return self.f(self._instance, *args, **kwds)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/modules/free_quadratic_module_integer_symmetric.py", line 808, in discriminant_group
        D = TorsionQuadraticModule(self.dual_lattice(), self)
      File "sage/misc/classcall_metaclass.pyx", line 334, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)
        return cls.classcall(cls, *args, **kwds)
    TypeError: unbound method __classcall__() must be called with TorsionQuadraticModule instance as first argument (got ClasscallMetaclass instance instead)
**********************************************************************
```



---

archive/issue_comments_340391.json:
```json
{
    "body": "<a id='comment:49'></a>`__classcall__` should be an ``@`staticmethod`. Once changed, you can set it back to a positive review.",
    "created_at": "2020-02-23T00:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340391",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:49'></a>`__classcall__` should be an ``@`staticmethod`. Once changed, you can set it back to a positive review.



---

archive/issue_comments_340392.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-24T17:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340392",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340393.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-02-24T17:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340393",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_061954.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-02-26T20:35:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24571#event-61954"
}
```



---

archive/issue_comments_340394.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-26T20:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340394",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_340395.json:
```json
{
    "body": "<a id='comment:53'></a>I am getting\n\n```\nsage -t --long /usr/lib/python3.7/site-packages/sage/groups/fqf_orthogonal.py\n**********************************************************************\nFile \"/usr/lib/python3.7/site-packages/sage/groups/fqf_orthogonal.py\", line 17, in sage.groups.fqf_orthogonal\nFailed example:\n    T.gen(0) * Oq.an_element()\nExpected:\n    (1, 3)\nGot:\n    (0, 3)\n**********************************************************************\n```\nDoes it depends on what gap packages are installed?",
    "created_at": "2020-02-29T02:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340395",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:53'></a>I am getting

```
sage -t --long /usr/lib/python3.7/site-packages/sage/groups/fqf_orthogonal.py
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/groups/fqf_orthogonal.py", line 17, in sage.groups.fqf_orthogonal
Failed example:
    T.gen(0) * Oq.an_element()
Expected:
    (1, 3)
Got:
    (0, 3)
**********************************************************************
```
Does it depends on what gap packages are installed?



---

archive/issue_comments_340396.json:
```json
{
    "body": "<a id='comment:54'></a>Maybe the `Oq.an_element()` call does? One could replace it by a hard coded element.",
    "created_at": "2020-03-01T18:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340396",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:54'></a>Maybe the `Oq.an_element()` call does? One could replace it by a hard coded element.



---

archive/issue_comments_340397.json:
```json
{
    "body": "<a id='comment:55'></a>`an_element` returns the product of the generators.\nNow the generators are produced using the gap function\n`SmallGeneratingSet`.\nI do not know how the function works internally but it seems possible this is where the packages come in.",
    "created_at": "2020-03-04T09:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340397",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:55'></a>`an_element` returns the product of the generators.
Now the generators are produced using the gap function
`SmallGeneratingSet`.
I do not know how the function works internally but it seems possible this is where the packages come in.



---

archive/issue_comments_340398.json:
```json
{
    "body": "<a id='comment:56'></a>This may be difficult to track down unless you know `gap` well. But I probably won't be the only one with a failure - unless I am missing a gap package that is meant to be in the sage's default.",
    "created_at": "2020-03-04T10:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340398",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:56'></a>This may be difficult to track down unless you know `gap` well. But I probably won't be the only one with a failure - unless I am missing a gap package that is meant to be in the sage's default.



---

archive/issue_comments_340399.json:
```json
{
    "body": "<a id='comment:57'></a>Replying to [comment:56 fbissey]:\n> This may be difficult to track down unless you know `gap` well. But I probably won't be the only one with a failure - unless I am missing a gap package that is meant to be in the sage's default.\n\n\nI've go the same error (`(0,3)`, not `(1,3)`), on Fedora 30, x86_64, and the current 9.1.beta6 with gap_packages spkg installed.\n\nThis is not surprising, in fact, as gap_packages contain stuff that speeds up certain GAP algorithms. This test is buggy; it should be not using the call to `an_element`, but something deterministic. I've opened #29282 as a followup",
    "created_at": "2020-03-05T13:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24571#issuecomment-340399",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:57'></a>Replying to [comment:56 fbissey]:
> This may be difficult to track down unless you know `gap` well. But I probably won't be the only one with a failure - unless I am missing a gap package that is meant to be in the sage's default.


I've go the same error (`(0,3)`, not `(1,3)`), on Fedora 30, x86_64, and the current 9.1.beta6 with gap_packages spkg installed.

This is not surprising, in fact, as gap_packages contain stuff that speeds up certain GAP algorithms. This test is buggy; it should be not using the call to `an_element`, but something deterministic. I've opened #29282 as a followup
