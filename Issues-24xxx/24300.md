# Issue 24300: Computation of modular form Hecke matrices is very inefficient

archive/issues_024063.json:
```json
{
    "body": "In order to compute the matrix of T(p) on a modular forms space, we currently compute a q-expansion basis of the space (using modular symbols) up to high enough precision that T(p) can be read off from the q-expansions. If the space is at all large, then we will need huge numbers of q-expansion coefficients to do things this way: to compute T(p) on modular forms, this algorithm will trigger computation of T(r) on modular symbols for all primes r up to about p * (Sturm bound for the space), which is very, very slow. For instance, this computation takes a whole 21 seconds:\n\n```\nsage: C=CuspForms(105, 2)\nsage: time C.hecke_matrix(17)\nCPU times: user 21 s, sys: 327 ms, total: 21.3 s\nWall time: 21.3 s\n\n[ 1/3  2/3 -1/3   ...\n```\nIf you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!\n\nThis is trivially fixable by being more intelligent about how we compute Hecke matrices. The following code computes T(2003) in only about half a second, and only needs modular symbol T(r) for r = 2003 and the primes r < Sturm bound:\n\n```\nsage: A = C.modular_symbols(sign=1)\nsage: time sage.modular.modform.cuspidal_submodule._convert_matrix_from_modsyms(A, A.hecke_matrix(2003))[0]\nCPU times: user 635 ms, sys: 16.5 ms, total: 652 ms\nWall time: 632 ms\n\n[  10/3    -28 -155/3  380/3 ...\n```\n\nBranch/Commit: fe985bc15f32bc8d9e221219ae435d5b59e02046\n\nReviewer: Vincent Delecroix\n\nAuthor: David Loeffler\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24300\n\n",
    "closed_at": "2017-12-25T18:21:44Z",
    "created_at": "2017-11-29T20:00:33Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Computation of modular form Hecke matrices is very inefficient",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24300",
    "user": "https://github.com/loefflerd"
}
```
In order to compute the matrix of T(p) on a modular forms space, we currently compute a q-expansion basis of the space (using modular symbols) up to high enough precision that T(p) can be read off from the q-expansions. If the space is at all large, then we will need huge numbers of q-expansion coefficients to do things this way: to compute T(p) on modular forms, this algorithm will trigger computation of T(r) on modular symbols for all primes r up to about p * (Sturm bound for the space), which is very, very slow. For instance, this computation takes a whole 21 seconds:

```
sage: C=CuspForms(105, 2)
sage: time C.hecke_matrix(17)
CPU times: user 21 s, sys: 327 ms, total: 21.3 s
Wall time: 21.3 s

[ 1/3  2/3 -1/3   ...
```
If you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!

This is trivially fixable by being more intelligent about how we compute Hecke matrices. The following code computes T(2003) in only about half a second, and only needs modular symbol T(r) for r = 2003 and the primes r < Sturm bound:

```
sage: A = C.modular_symbols(sign=1)
sage: time sage.modular.modform.cuspidal_submodule._convert_matrix_from_modsyms(A, A.hecke_matrix(2003))[0]
CPU times: user 635 ms, sys: 16.5 ms, total: 652 ms
Wall time: 632 ms

[  10/3    -28 -155/3  380/3 ...
```

Branch/Commit: fe985bc15f32bc8d9e221219ae435d5b59e02046

Reviewer: Vincent Delecroix

Author: David Loeffler

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24300





---

archive/issue_comments_358927.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -10,7 +10,7 @@\n ```\n If you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!\n \n-This is trivially fixable by being more intelligent about how we compute Hecke matrices; the following code computes T(2003) in only about half a second:\n+This is trivially fixable by being more intelligent about how we compute Hecke matrices. The following code computes T(2003) in only about half a second, and only needs modular symbol T(r) for r = 2003 and the primes r < Sturm bound:\n \n ```\n sage: A = C.modular_symbols(sign=1)\n```\n",
    "created_at": "2017-11-29T20:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358927",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
```diff
--- 
+++ 
@@ -10,7 +10,7 @@
 ```
 If you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!
 
-This is trivially fixable by being more intelligent about how we compute Hecke matrices; the following code computes T(2003) in only about half a second:
+This is trivially fixable by being more intelligent about how we compute Hecke matrices. The following code computes T(2003) in only about half a second, and only needs modular symbol T(r) for r = 2003 and the primes r < Sturm bound:
 
 ```
 sage: A = C.modular_symbols(sign=1)
```




---

archive/issue_comments_358928.json:
```json
{
    "body": "<a id='comment:3'></a>I've uploaded a branch which fixes both this and #21546.\n\n---\nNew commits:",
    "created_at": "2017-12-01T14:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358928",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:3'></a>I've uploaded a branch which fixes both this and #21546.

---
New commits:



---

archive/issue_comments_358929.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-01T14:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358929",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_358930.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-02T10:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358930",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358931.json:
```json
{
    "body": "<a id='comment:6'></a>I just pushed a one-byte docstring formatting change, to keep the patchbot ReST syntax checker happy",
    "created_at": "2017-12-02T10:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358931",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:6'></a>I just pushed a one-byte docstring formatting change, to keep the patchbot ReST syntax checker happy



---

archive/issue_comments_358932.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-12-02T16:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358932",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_358933.json:
```json
{
    "body": "<a id='comment:8'></a>Unfortunately the branch I had previously uploaded had conflicts with other tickets that already have positive review. I've now hand-merged those into the ticket branch.",
    "created_at": "2017-12-02T16:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358933",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:8'></a>Unfortunately the branch I had previously uploaded had conflicts with other tickets that already have positive review. I've now hand-merged those into the ticket branch.



---

archive/issue_comments_358934.json:
```json
{
    "body": "<a id='comment:10'></a>Despite my best efforts, my branch still wouldn't merge with 8.2.beta0 so here is yet another new branch. No change to the actual code, still needs review.\n\n---\nNew commits:",
    "created_at": "2017-12-14T13:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358934",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:10'></a>Despite my best efforts, my branch still wouldn't merge with 8.2.beta0 so here is yet another new branch. No change to the actual code, still needs review.

---
New commits:



---

archive/issue_events_061507.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2017-12-14T13:39:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24300#event-61507"
}
```



---

archive/issue_comments_358935.json:
```json
{
    "body": "<a id='comment:12'></a>For documentation and cross check purposes could you add\n\n```\nsage: ModularForms(17,4).hecke_matrix(2).charpoly()\nx^6 - 16*x^5 + 18*x^4 + 608*x^3 - 1371*x^2 - 4968*x + 7776\n```\nto the documentation of `hecke_polynomial`?",
    "created_at": "2017-12-21T16:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358935",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>For documentation and cross check purposes could you add

```
sage: ModularForms(17,4).hecke_matrix(2).charpoly()
x^6 - 16*x^5 + 18*x^4 + 608*x^3 - 1371*x^2 - 4968*x + 7776
```
to the documentation of `hecke_polynomial`?



---

archive/issue_comments_358936.json:
```json
{
    "body": "<a id='comment:13'></a>and similarly in the cuspidal submodule?",
    "created_at": "2017-12-21T16:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358936",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>and similarly in the cuspidal submodule?



---

archive/issue_comments_358937.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-21T18:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358937",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358938.json:
```json
{
    "body": "<a id='comment:15'></a>Et voil\u00e0.",
    "created_at": "2017-12-21T18:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358938",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:15'></a>Et voilà.



---

archive/issue_comments_358939.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-22T07:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358939",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358940.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks for the review! Can you also mark #21546 as positive review, if you agree that this code fixes that bug as well?",
    "created_at": "2017-12-22T09:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358940",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:17'></a>Thanks for the review! Can you also mark #21546 as positive review, if you agree that this code fixes that bug as well?



---

archive/issue_comments_358941.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-25T18:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24300#issuecomment-358941",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061508.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-25T18:21:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24300",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24300#event-61508"
}
```
