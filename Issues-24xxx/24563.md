# Issue 24563: Workaround for small race condition in parallel doctest runner

archive/issues_024326.json:
```json
{
    "body": "This is hard to reproduce reliably, but can happen if a worker process outlives its deadline and `w.kill()` is called, but the process has exited on its own by the time `killpg()` is called.\n\nI've had this happen a few times on Cygwin where process shutdown tends to take a little longer.\n\nCC:  @jdemeyer\n\nBranch/Commit: 0b72ed55a5261fe632e296b4677faa43f79e5611\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24563\n\n",
    "closed_at": "2018-02-01T19:13:26Z",
    "created_at": "2018-01-19T09:15:17Z",
    "labels": [
        "component: doctest framework",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Workaround for small race condition in parallel doctest runner",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24563",
    "user": "https://github.com/embray"
}
```
This is hard to reproduce reliably, but can happen if a worker process outlives its deadline and `w.kill()` is called, but the process has exited on its own by the time `killpg()` is called.

I've had this happen a few times on Cygwin where process shutdown tends to take a little longer.

CC:  @jdemeyer

Branch/Commit: 0b72ed55a5261fe632e296b4677faa43f79e5611

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24563





---

archive/issue_comments_362582.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-19T09:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362582",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_362583.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-19T21:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362583",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_362584.json:
```json
{
    "body": "<a id='comment:2'></a>Some of the calls to this `kill` method are wrapped already in a `try`/`except Exception` block. So it seems to be a feature that this would raise an exception if the worker is already dead. I would therefore prefer to just wrap the one remaining call to `kill` in a `try`/`except` block.",
    "created_at": "2018-01-19T21:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362584",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Some of the calls to this `kill` method are wrapped already in a `try`/`except Exception` block. So it seems to be a feature that this would raise an exception if the worker is already dead. I would therefore prefer to just wrap the one remaining call to `kill` in a `try`/`except` block.



---

archive/issue_comments_362585.json:
```json
{
    "body": "<a id='comment:3'></a>Maybe a better alternative solution: return a boolean from `kill()` to indicate whether or not `os.kill()` was successful in sending the signal.",
    "created_at": "2018-01-19T21:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362585",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Maybe a better alternative solution: return a boolean from `kill()` to indicate whether or not `os.kill()` was successful in sending the signal.



---

archive/issue_comments_362586.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 jdemeyer]:\n> Maybe a better alternative solution: return a boolean from `kill()` to indicate whether or not `os.kill()` was successful in sending the signal.\n\n\n+1",
    "created_at": "2018-01-22T13:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362586",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Replying to [comment:3 jdemeyer]:
> Maybe a better alternative solution: return a boolean from `kill()` to indicate whether or not `os.kill()` was successful in sending the signal.


+1



---

archive/issue_comments_362587.json:
```json
{
    "body": "<a id='comment:5'></a>~~Although maybe instead of \"successful in sending the signal\" it should be \"successful in sending the signal or is already dead\".  After all what I've written will allow other exceptions to be raised.~~\n\nNo, I changed my mind. I'll do it the way you suggested.",
    "created_at": "2018-01-22T13:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362587",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>~~Although maybe instead of "successful in sending the signal" it should be "successful in sending the signal or is already dead".  After all what I've written will allow other exceptions to be raised.~~

No, I changed my mind. I'll do it the way you suggested.



---

archive/issue_comments_362588.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-22T13:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362588",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362589.json:
```json
{
    "body": "<a id='comment:7'></a>New commits:",
    "created_at": "2018-01-22T13:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362589",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>New commits:



---

archive/issue_comments_362590.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-22T13:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362590",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_362591.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-29T14:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362591",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_362592.json:
```json
{
    "body": "<a id='comment:9'></a>I like how nearly every patchbot is apparently broken...",
    "created_at": "2018-01-30T11:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362592",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>I like how nearly every patchbot is apparently broken...



---

archive/issue_events_061945.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-01T19:13:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24563#event-61945"
}
```



---

archive/issue_comments_362593.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-01T19:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24563",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24563#issuecomment-362593",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
