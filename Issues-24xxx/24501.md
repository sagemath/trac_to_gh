# Issue 24501: Hash of Integer broken on Python 3

archive/issues_024264.json:
```json
{
    "body": "Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.\n\nIn Python 3 something changed subtly about the hash algorithm such that this no longer holds:\n\n```\nsage: hash(int(2^61))\n1\nsage: hash(2^61)\n2305843009213693952\n```\n\nI haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.\n\nBranch/Commit: 248cdd8d0c021056c33c62814cbd04e382ec8f3e\n\nReviewer: Erik Bray\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24501\n\n",
    "closed_at": "2018-01-15T22:29:26Z",
    "created_at": "2018-01-09T15:07:27Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Hash of Integer broken on Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24501",
    "user": "https://github.com/embray"
}
```
Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.

In Python 3 something changed subtly about the hash algorithm such that this no longer holds:

```
sage: hash(int(2^61))
1
sage: hash(2^61)
2305843009213693952
```

I haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.

Branch/Commit: 248cdd8d0c021056c33c62814cbd04e382ec8f3e

Reviewer: Erik Bray

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24501





---

archive/issue_comments_463807.json:
```json
{
    "body": "<a id='comment:1'></a>Relevant: https://bugs.python.org/issue8188",
    "created_at": "2018-01-09T15:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463807",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>Relevant: https://bugs.python.org/issue8188



---

archive/issue_comments_463808.json:
```json
{
    "body": "<a id='comment:2'></a>I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.",
    "created_at": "2018-01-09T15:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463808",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.



---

archive/issue_comments_463809.json:
```json
{
    "body": "<a id='comment:3'></a>I'll have a look",
    "created_at": "2018-01-09T15:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463809",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>I'll have a look



---

archive/issue_comments_463810.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2018-01-09T15:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463810",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_463811.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/hash_of_integer_broken_on_python_3\"",
    "created_at": "2018-01-09T17:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463811",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/hash_of_integer_broken_on_python_3"



---

archive/issue_comments_463812.json:
```json
{
    "body": "Changing commit from \"\" to \"19efd2db979069166ced3cf57c497d2fdd07858f\"",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463812",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "19efd2db979069166ced3cf57c497d2fdd07858f"



---

archive/issue_comments_463813.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463813",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_463814.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463814",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_463815.json:
```json
{
    "body": "<a id='comment:6'></a>Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more \"generic\" I suppose.\n\nI wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.",
    "created_at": "2018-01-09T17:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463815",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more "generic" I suppose.

I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.



---

archive/issue_comments_463816.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 embray]:\n> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.\n\n\nConstant folding is so trivial that it is safe to assume that the compiler knows what to do.",
    "created_at": "2018-01-09T18:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463816",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 embray]:
> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.


Constant folding is so trivial that it is safe to assume that the compiler knows what to do.



---

archive/issue_comments_463817.json:
```json
{
    "body": "<a id='comment:8'></a>It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.",
    "created_at": "2018-01-09T19:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463817",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.



---

archive/issue_comments_463818.json:
```json
{
    "body": "Changing commit from \"19efd2db979069166ced3cf57c497d2fdd07858f\" to \"248cdd8d0c021056c33c62814cbd04e382ec8f3e\"",
    "created_at": "2018-01-09T19:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463818",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "19efd2db979069166ced3cf57c497d2fdd07858f" to "248cdd8d0c021056c33c62814cbd04e382ec8f3e"



---

archive/issue_comments_463819.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-09T19:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463819",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_463820.json:
```json
{
    "body": "<a id='comment:10'></a>Thanks for the quick work on this--looks good to me!",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463820",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Thanks for the quick work on this--looks good to me!



---

archive/issue_comments_463821.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463821",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463822.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Erik Bray\"",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463822",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "" to "Erik Bray"



---

archive/issue_comments_463823.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-15T22:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463823",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061810.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-15T22:29:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24501#event-61810"
}
```



---

archive/issue_comments_463824.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/hash_of_integer_broken_on_python_3\" to \"248cdd8d0c021056c33c62814cbd04e382ec8f3e\"",
    "created_at": "2018-01-15T22:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-463824",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/hash_of_integer_broken_on_python_3" to "248cdd8d0c021056c33c62814cbd04e382ec8f3e"
