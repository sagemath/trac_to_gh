# Issue 24501: Hash of Integer broken on Python 3

archive/issues_024264.json:
```json
{
    "assignees": [],
    "body": "Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.\n\nIn Python 3 something changed subtly about the hash algorithm such that this no longer holds:\n\n```\nsage: hash(int(2^61))\n1\nsage: hash(2^61)\n2305843009213693952\n```\n\nI haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.\n\nBranch/Commit: **[`248cdd8`](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)**\n\nReviewer: **Erik Bray**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24501_\n\n",
    "closed_at": "2018-01-15T22:29:26Z",
    "created_at": "2018-01-09T15:07:27Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Hash of Integer broken on Python 3",
    "type": "issue",
    "updated_at": "2018-01-15T22:29:26Z",
    "url": "https://github.com/sagemath/sage/issues/24501",
    "user": "https://github.com/embray"
}
```
Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.

In Python 3 something changed subtly about the hash algorithm such that this no longer holds:

```
sage: hash(int(2^61))
1
sage: hash(2^61)
2305843009213693952
```

I haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.

Branch/Commit: **[`248cdd8`](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)**

Reviewer: **Erik Bray**

Author: **Jeroen Demeyer**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/24501_





---

archive/issue_events_339392.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-09T15:07:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339392"
}
```



---

archive/issue_events_339393.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-09T15:07:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339393"
}
```



---

archive/issue_events_339394.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-09T15:07:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339394"
}
```



---

archive/issue_events_339395.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-09T15:07:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339395"
}
```



---

archive/issue_comments_370989.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nRelevant: https://bugs.python.org/issue8188",
    "created_at": "2018-01-09T15:10:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370989",
    "user": "https://github.com/embray"
}
```

<div id="comment:1" align="right">comment:1</div>

Relevant: https://bugs.python.org/issue8188



---

archive/issue_comments_370990.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.",
    "created_at": "2018-01-09T15:19:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370990",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">comment:2</div>

I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.



---

archive/issue_comments_370991.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI'll have a look",
    "created_at": "2018-01-09T15:40:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370991",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

I'll have a look



---

archive/issue_comments_370992.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2018-01-09T15:40:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370992",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_370993.json:
```json
{
    "body": "Branch: **[u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)**",
    "created_at": "2018-01-09T17:10:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370993",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)**



---

archive/issue_comments_370994.json:
```json
{
    "body": "Commit: **[`19efd2d`](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)**",
    "created_at": "2018-01-09T17:11:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370994",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`19efd2d`](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)**



---

archive/issue_events_339396.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-01-09T17:11:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339396"
}
```



---

archive/issue_comments_370995.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f\"><code>19efd2d</code></a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-09T17:11:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370995",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f"><code>19efd2d</code></a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>




---

archive/issue_comments_370996.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAh, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more \"generic\" I suppose.\n\nI wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.",
    "created_at": "2018-01-09T17:31:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370996",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more "generic" I suppose.

I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.



---

archive/issue_comments_370997.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@embray](#comment:6):\n> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.\n\nConstant folding is so trivial that it is safe to assume that the compiler knows what to do.",
    "created_at": "2018-01-09T18:53:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370997",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@embray](#comment:6):
> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.

Constant folding is so trivial that it is safe to assume that the compiler knows what to do.



---

archive/issue_comments_370998.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIt seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.",
    "created_at": "2018-01-09T19:04:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370998",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.



---

archive/issue_comments_370999.json:
```json
{
    "body": "Changed commit from **[`19efd2d`](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)** to **[`248cdd8`](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)**",
    "created_at": "2018-01-09T19:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-370999",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`19efd2d`](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)** to **[`248cdd8`](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)**



---

archive/issue_comments_371000.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e\"><code>248cdd8</code></a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-09T19:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-371000",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e"><code>248cdd8</code></a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>




---

archive/issue_comments_371001.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThanks for the quick work on this--looks good to me!",
    "created_at": "2018-01-10T09:39:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-371001",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Thanks for the quick work on this--looks good to me!



---

archive/issue_events_339397.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-10T09:39:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339397"
}
```



---

archive/issue_events_339398.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-10T09:39:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339398"
}
```



---

archive/issue_comments_371002.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2018-01-10T09:39:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-371002",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_events_339399.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-15T22:29:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339399"
}
```



---

archive/issue_events_339400.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4ed9afa8464d4622c6ada57669b0673acc0d1c64",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-01-15T22:29:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24501#event-339400"
}
```



---

archive/issue_comments_371003.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)** to **[`248cdd8`](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)**",
    "created_at": "2018-01-15T22:29:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24501#issuecomment-371003",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)** to **[`248cdd8`](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)**
