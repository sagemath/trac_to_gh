# Issue 24501: Hash of Integer broken on Python 3

archive/issues_024264.json:
```json
{
    "body": "Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.\n\nIn Python 3 something changed subtly about the hash algorithm such that this no longer holds:\n\n```\nsage: hash(int(2^61))\n1\nsage: hash(2^61)\n2305843009213693952\n```\n\nI haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.\n\n**Branch/Commit:** [248cdd8d0c021056c33c62814cbd04e382ec8f3e](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)\n\n**Reviewer:** Erik Bray\n\n**Author:** Jeroen Demeyer\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24501\n\n",
    "closed_at": "2018-01-15T22:29:26Z",
    "created_at": "2018-01-09T15:07:27Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Hash of Integer broken on Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24501",
    "user": "https://github.com/embray"
}
```
Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.

In Python 3 something changed subtly about the hash algorithm such that this no longer holds:

```
sage: hash(int(2^61))
1
sage: hash(2^61)
2305843009213693952
```

I haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.

**Branch/Commit:** [248cdd8d0c021056c33c62814cbd04e382ec8f3e](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)

**Reviewer:** Erik Bray

**Author:** Jeroen Demeyer

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/24501





---

archive/issue_comments_465981.json:
```json
{
    "body": "<a id='comment:1'></a>\nRelevant: https://bugs.python.org/issue8188",
    "created_at": "2018-01-09T15:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465981",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Relevant: https://bugs.python.org/issue8188



---

archive/issue_comments_465982.json:
```json
{
    "body": "<a id='comment:2'></a>\nI see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.",
    "created_at": "2018-01-09T15:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465982",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.



---

archive/issue_comments_465983.json:
```json
{
    "body": "<a id='comment:3'></a>\nI'll have a look",
    "created_at": "2018-01-09T15:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465983",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
I'll have a look



---

archive/issue_comments_465984.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2018-01-09T15:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465984",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_465985.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)",
    "created_at": "2018-01-09T17:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465985",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)



---

archive/issue_comments_465986.json:
```json
{
    "body": "**Commit:** [19efd2db979069166ced3cf57c497d2fdd07858f](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465986",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [19efd2db979069166ced3cf57c497d2fdd07858f](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)



---

archive/issue_comments_465987.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465987",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_465988.json:
```json
{
    "body": "<a id='comment:5'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f\">19efd2d</a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465988",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f">19efd2d</a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>




---

archive/issue_comments_465989.json:
```json
{
    "body": "<a id='comment:6'></a>\nAh, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more \"generic\" I suppose.\n\nI wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.",
    "created_at": "2018-01-09T17:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465989",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more "generic" I suppose.

I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.



---

archive/issue_comments_465990.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [embray](#comment%3A6):\n> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.\n\n\nConstant folding is so trivial that it is safe to assume that the compiler knows what to do.",
    "created_at": "2018-01-09T18:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465990",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [embray](#comment%3A6):
> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.


Constant folding is so trivial that it is safe to assume that the compiler knows what to do.



---

archive/issue_comments_465991.json:
```json
{
    "body": "<a id='comment:8'></a>\nIt seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.",
    "created_at": "2018-01-09T19:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465991",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.



---

archive/issue_comments_465992.json:
```json
{
    "body": "**Changing commit** from \"[19efd2db979069166ced3cf57c497d2fdd07858f](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)\" to \"[248cdd8d0c021056c33c62814cbd04e382ec8f3e](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)\".",
    "created_at": "2018-01-09T19:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[19efd2db979069166ced3cf57c497d2fdd07858f](https://github.com/sagemath/sagetrac-mirror/commit/19efd2db979069166ced3cf57c497d2fdd07858f)" to "[248cdd8d0c021056c33c62814cbd04e382ec8f3e](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)".



---

archive/issue_comments_465993.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e\">248cdd8</a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-09T19:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465993",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e">248cdd8</a></td><td><code>Fix hashing of Integer on Python 3</code></td></tr></table>




---

archive/issue_comments_465994.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks for the quick work on this--looks good to me!",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465994",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Thanks for the quick work on this--looks good to me!



---

archive/issue_comments_465995.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465995",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_465996.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465996",
    "user": "https://github.com/embray"
}
```

**Reviewer:** Erik Bray



---

archive/issue_comments_465997.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2018-01-15T22:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465997",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_070303.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-15T22:29:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24501#event-70303"
}
```



---

archive/issue_comments_465998.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)\" to \"[248cdd8d0c021056c33c62814cbd04e382ec8f3e](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)\".",
    "created_at": "2018-01-15T22:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24501#issuecomment-465998",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/hash_of_integer_broken_on_python_3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/hash_of_integer_broken_on_python_3)" to "[248cdd8d0c021056c33c62814cbd04e382ec8f3e](https://github.com/sagemath/sagetrac-mirror/commit/248cdd8d0c021056c33c62814cbd04e382ec8f3e)".
