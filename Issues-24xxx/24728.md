# Issue 24728: Python 3 fixes to Cython

archive/issues_024491.json:
```json
{
    "body": "1. Fix running the Cython testsuite on Python 3.\n\n2. Fix the issue that unbound methods are unhashable:\n\n```\nsage: hash(Graph.is_long_hole_free)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-41-8a5746117695> in <module>()\n----> 1 hash(getattr(Graph, 'is_long_hole_free'))\n\nTypeError: unhashable type: 'instancemethod'\n```\n\n**Upstream**: https://github.com/cython/cython/pull/2105\n\nCC:  @embray\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton, Fran\u00e7ois Bissey\n\nAuthor: Jeroen Demeyer\n\nBranch: 7187fb9e68f1549aa33984d531af404399cb6e51\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24728\n\n",
    "closed_at": "2018-03-04T23:28:58Z",
    "created_at": "2018-02-14T12:50:19Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Python 3 fixes to Cython",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24728",
    "user": "https://github.com/fchapoton"
}
```
1. Fix running the Cython testsuite on Python 3.

2. Fix the issue that unbound methods are unhashable:

```
sage: hash(Graph.is_long_hole_free)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-41-8a5746117695> in <module>()
----> 1 hash(getattr(Graph, 'is_long_hole_free'))

TypeError: unhashable type: 'instancemethod'
```

**Upstream**: https://github.com/cython/cython/pull/2105

CC:  @embray

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Frédéric Chapoton, François Bissey

Author: Jeroen Demeyer

Branch: 7187fb9e68f1549aa33984d531af404399cb6e51

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24728





---

archive/issue_comments_365835.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to python3.",
    "created_at": "2018-02-14T12:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365835",
    "user": "https://github.com/fchapoton"
}
```

Changing component from PLEASE CHANGE to python3.



---

archive/issue_comments_365836.json:
```json
{
    "body": "<a id='comment:2'></a>If we compare the two lines\n\n```\nfrom sage.graphs.weakly_chordal import is_long_hole_free, is_long_antihole_free, is_weakly_chordal\nfrom sage.graphs.asteroidal_triples import is_asteroidal_triple_free\n```\nBoth are imported from a pyx file, only the first is problematic.\nComparing:\n\n```\nsage: getattr(Graph, \"is_asteroidal_triple_free\")\n<built-in function is_asteroidal_triple_free>\nsage: getattr(Graph, \"is_long_hole_free\")\n<instancemethod is_long_hole_free at 0x7fed5c5758b8>\n```\nand the second one is not hashable. Both come from a \"def\". What is the difference ?",
    "created_at": "2018-02-14T13:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365836",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>If we compare the two lines

```
from sage.graphs.weakly_chordal import is_long_hole_free, is_long_antihole_free, is_weakly_chordal
from sage.graphs.asteroidal_triples import is_asteroidal_triple_free
```
Both are imported from a pyx file, only the first is problematic.
Comparing:

```
sage: getattr(Graph, "is_asteroidal_triple_free")
<built-in function is_asteroidal_triple_free>
sage: getattr(Graph, "is_long_hole_free")
<instancemethod is_long_hole_free at 0x7fed5c5758b8>
```
and the second one is not hashable. Both come from a "def". What is the difference ?



---

archive/issue_comments_365837.json:
```json
{
    "body": "<a id='comment:3'></a>Jeoren, any idea as a cython expert of what could explain the difference in the previous comment ?",
    "created_at": "2018-02-14T16:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365837",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>Jeoren, any idea as a cython expert of what could explain the difference in the previous comment ?



---

archive/issue_comments_365838.json:
```json
{
    "body": "<a id='comment:4'></a>The difference is that `weakly_chordal.pyx` is compiled with `# cython: binding=True` (see the first line of that file).\n\nBut really, `is_asteroidal_triple_free` is broken. It doesn't work as a method:\n\n```\nsage: Graph(5).is_asteroidal_triple_free()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-11-79cc7f0a39a3> in <module>()\n----> 1 Graph(Integer(5)).is_asteroidal_triple_free()\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/graphs/asteroidal_triples.pyx in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6495)()\n     80 from sage.ext.memory_allocator cimport MemoryAllocator\n     81 \n---> 82 def is_asteroidal_triple_free(G, certificate=False):\n     83     \"\"\"\n     84     Test if the input graph is asteroidal triple-free\n\nTypeError: is_asteroidal_triple_free() takes at least 1 positional argument (0 given)\n```\nSo don't take `is_asteroidal_triple_free` as example.",
    "created_at": "2018-02-14T16:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365838",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>The difference is that `weakly_chordal.pyx` is compiled with `# cython: binding=True` (see the first line of that file).

But really, `is_asteroidal_triple_free` is broken. It doesn't work as a method:

```
sage: Graph(5).is_asteroidal_triple_free()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-79cc7f0a39a3> in <module>()
----> 1 Graph(Integer(5)).is_asteroidal_triple_free()

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/graphs/asteroidal_triples.pyx in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6495)()
     80 from sage.ext.memory_allocator cimport MemoryAllocator
     81 
---> 82 def is_asteroidal_triple_free(G, certificate=False):
     83     """
     84     Test if the input graph is asteroidal triple-free

TypeError: is_asteroidal_triple_free() takes at least 1 positional argument (0 given)
```
So don't take `is_asteroidal_triple_free` as example.



---

archive/issue_comments_365839.json:
```json
{
    "body": "<a id='comment:5'></a>In Python 3, an unbound method is just the function:\n\n```\nIn [18]: class X:\n    ...:     def meth(self): return self\n\nIn [19]: X.meth\nOut[19]: <function __main__.X.meth>\n\nIn [20]: type(X.meth)\nOut[20]: function\n```\nSo the fact that Cython gives an `instancemethod` instead of a function might be considered a Cython bug. I'll think about it later.",
    "created_at": "2018-02-14T16:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365839",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>In Python 3, an unbound method is just the function:

```
In [18]: class X:
    ...:     def meth(self): return self

In [19]: X.meth
Out[19]: <function __main__.X.meth>

In [20]: type(X.meth)
Out[20]: function
```
So the fact that Cython gives an `instancemethod` instead of a function might be considered a Cython bug. I'll think about it later.



---

archive/issue_comments_365840.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2018-02-15T10:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365840",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_365841.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-15T10:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365841",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_365842.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -12,6 +12,8 @@\n TypeError: unhashable type: 'instancemethod'\n ```\n \n+**Upstream**: https://github.com/cython/cython/pull/2105\n+\n Comment: 1\n \n Component: PLEASE CHANGE\n```\n",
    "created_at": "2018-02-15T11:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365842",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -12,6 +12,8 @@
 TypeError: unhashable type: 'instancemethod'
 ```
 
+**Upstream**: https://github.com/cython/cython/pull/2105
+
 Comment: 1
 
 Component: PLEASE CHANGE
```




---

archive/issue_comments_365843.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-15T13:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365843",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_365844.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+1. Fix running the Cython testsuite on Python 3.\n \n+2. Fix the issue that unbound methods are unhashable:\n+\n+```\n+sage: hash(Graph.is_long_hole_free)\n+---------------------------------------------------------------------------\n+TypeError                                 Traceback (most recent call last)\n+<ipython-input-41-8a5746117695> in <module>()\n+----> 1 hash(getattr(Graph, 'is_long_hole_free'))\n+\n+TypeError: unhashable type: 'instancemethod'\n+```\n+\n+**Upstream**: https://github.com/cython/cython/pull/2105\n \n Comment: 1\n \n```\n",
    "created_at": "2018-02-15T13:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365844",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,18 @@
+1. Fix running the Cython testsuite on Python 3.
 
+2. Fix the issue that unbound methods are unhashable:
+
+```
+sage: hash(Graph.is_long_hole_free)
+---------------------------------------------------------------------------
+TypeError                                 Traceback (most recent call last)
+<ipython-input-41-8a5746117695> in <module>()
+----> 1 hash(getattr(Graph, 'is_long_hole_free'))
+
+TypeError: unhashable type: 'instancemethod'
+```
+
+**Upstream**: https://github.com/cython/cython/pull/2105
 
 Comment: 1
 
```




---

archive/issue_comments_365845.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-15T13:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365845",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_365846.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-15T14:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365846",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_365847.json:
```json
{
    "body": "<a id='comment:14'></a>To potential reviewers: the dependency on #21509 is just because both tickets add a patch to Cython. If it's hard to review #21509, I could reorganize things. For example, I could put both patches on this ticket and reverse the dependency. Just let me know which pieces of #21509 and #24728 you could give positive review to.",
    "created_at": "2018-02-15T19:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365847",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>To potential reviewers: the dependency on #21509 is just because both tickets add a patch to Cython. If it's hard to review #21509, I could reorganize things. For example, I could put both patches on this ticket and reverse the dependency. Just let me know which pieces of #21509 and #24728 you could give positive review to.



---

archive/issue_comments_365848.json:
```json
{
    "body": "<a id='comment:15'></a>#21509 is stuck for now.\n\nRegardless, the commits from this ticket can still be reviewed. If this ticket gets positive review, I will reorganize the dependency to make this ticket independent from #21509.",
    "created_at": "2018-02-22T16:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365848",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>#21509 is stuck for now.

Regardless, the commits from this ticket can still be reviewed. If this ticket gets positive review, I will reorganize the dependency to make this ticket independent from #21509.



---

archive/issue_comments_365849.json:
```json
{
    "body": "<a id='comment:16'></a>Ok, I am ready to give a positive review here. Please disentangle from #21509.",
    "created_at": "2018-02-26T20:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365849",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>Ok, I am ready to give a positive review here. Please disentangle from #21509.



---

archive/issue_comments_365850.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-27T08:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365850",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_365851.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-27T08:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365851",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_365852.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-27T08:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365852",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_365853.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-04T23:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365853",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_062211.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-04T23:28:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24728#event-62211"
}
```



---

archive/issue_comments_365854.json:
```json
{
    "body": "<a id='comment:21'></a>Sadly, this still does not fix the issue number 2 in the description..\n\nSo, vanilla sage still does not start with python3..",
    "created_at": "2018-03-11T12:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365854",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>Sadly, this still does not fix the issue number 2 in the description..

So, vanilla sage still does not start with python3..



---

archive/issue_comments_365855.json:
```json
{
    "body": "<a id='comment:22'></a>I think you need `./sage -f sagelib`",
    "created_at": "2018-03-11T13:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365855",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>I think you need `./sage -f sagelib`



---

archive/issue_comments_365856.json:
```json
{
    "body": "<a id='comment:23'></a>Ho, is this stronger than `make build` ? ok, I will try.",
    "created_at": "2018-03-11T13:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365856",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>Ho, is this stronger than `make build` ? ok, I will try.



---

archive/issue_comments_365857.json:
```json
{
    "body": "<a id='comment:24'></a>Similar to other packages inside Sage-the-distribution, `./sage -f` forces a complete rebuild of that package, regardless of what was installed before. So `./sage -f sagelib` forces a complete rebuild of the Sage library. In particular, in this ticket we need to run Cython again on the affected file.\n\n`make build` simply builds all of Sage-the-distribution (except doc), but it won't reinstall anything which is already installed.",
    "created_at": "2018-03-11T14:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365857",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Similar to other packages inside Sage-the-distribution, `./sage -f` forces a complete rebuild of that package, regardless of what was installed before. So `./sage -f sagelib` forces a complete rebuild of the Sage library. In particular, in this ticket we need to run Cython again on the affected file.

`make build` simply builds all of Sage-the-distribution (except doc), but it won't reinstall anything which is already installed.



---

archive/issue_comments_365858.json:
```json
{
    "body": "<a id='comment:25'></a>Thanks, it worked. So indeed now sage+python3 does start !",
    "created_at": "2018-03-11T14:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365858",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>Thanks, it worked. So indeed now sage+python3 does start !



---

archive/issue_comments_365859.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 chapoton]:\n> Thanks, it worked. So indeed now sage+python3 does start !\n\n\nSo I guess we should update the `build-python3` target (and actually start using it!)",
    "created_at": "2018-03-11T14:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-365859",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:25 chapoton]:
> Thanks, it worked. So indeed now sage+python3 does start !


So I guess we should update the `build-python3` target (and actually start using it!)
