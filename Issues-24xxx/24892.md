# Issue 24892: Relabelled non-crystallographic finite types should not have an ambient space (yet)

archive/issues_024655.json:
```json
{
    "body": "CC:  @jplab @tscrim\n\nKeywords: days93\n\nNon-crystallographic finite types have an `ambient_space()` that returns `None`, indicating that Sage does not know how to construct it:\n\n```\nsage: CartanType(['I',5]).root_system().ambient_space() is None\nTrue\n```\nHowever, the relabelled finite types assume that it is not `None`, which results in an error:\n\n```\nsage: CartanType(['I',5]).relabel({1:0,2:1}).root_system().ambient_space()\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-3-0f9f382ffb1f> in <module>()\n----> 1 CartanType(['I',Integer(5)]).relabel({Integer(1):Integer(0),Integer(2):Integer(1)}).root_system().ambient_space()\n\n/home/travis/sage-build/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10785)()\n   2012                 return cache[k]\n   2013         except KeyError:\n-> 2014             w = self._instance_call(*args, **kwds)\n   2015             cache[k] = w\n   2016             return w\n\n/home/travis/sage-build/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:10236)()\n   1888             True\n   1889         \"\"\"\n-> 1890         return self.f(self._instance, *args, **kwds)\n   1891 \n   1892     cdef fix_args_kwds(self, tuple args, dict kwds):\n\n/home/travis/sage-build/local/lib/python2.7/site-packages/sage/combinat/root_system/root_system.pyc in ambient_space(self, base_ring)\n    749         if not base_ring.has_coerce_map_from(AmbientSpace.smallest_base_ring(self.cartan_type())):\n    750             return None\n--> 751         return AmbientSpace(self, base_ring)\n    752 \n    753     def coambient_space(self, base_ring=QQ):\n\n/home/travis/sage-build/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1590)()\n    328         \"\"\"\n    329         if cls.classcall is not None:\n--> 330             return cls.classcall(cls, *args, **kwds)\n    331         else:\n    332             # Fast version of type.__call__(cls, *args, **kwds)\n\n/home/travis/sage-build/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6246)()\n   1057                 return self.cache[k]\n   1058         except KeyError:\n-> 1059             w = self.f(*args, **kwds)\n   1060             self.cache[k] = w\n   1061             return w\n\n/home/travis/sage-build/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in __classcall__(cls, *args, **options)\n   1019             True\n   1020         \"\"\"\n-> 1021         instance = typecall(cls, *args, **options)\n   1022         assert isinstance( instance, cls )\n   1023         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:\n\n/home/travis/sage-build/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2040)()\n    495             TypeError: Argument 'cls' has incorrect type (expected type, got classobj)\n    496     \"\"\"\n--> 497     return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n    498 \n    499 # Class for timing::\n\n/home/travis/sage-build/local/lib/python2.7/site-packages/sage/combinat/root_system/ambient_space.pyc in __init__(self, root_system, base_ring, index_set)\n     89         self.root_system = root_system\n     90         if index_set is None:\n---> 91             index_set = tuple(range(0, self.dimension()))\n     92         CombinatorialFreeModule.__init__(self, base_ring,\n     93                                          index_set,\n\n/home/travis/sage-build/local/lib/python2.7/site-packages/sage/combinat/root_system/type_relabel.pyc in dimension(self)\n    425         \"\"\"\n    426         # Can't yet use _dual_space for the base ring (and cartan_type?) is not yet initialized\n--> 427         return self.root_system.cartan_type()._type.root_system().ambient_space().dimension()\n    428 \n    429     @cached_method\n\nAttributeError: 'NoneType' object has no attribute 'dimension'\n```\n\nA proper fix for this issue would be implementing ambient spaces for non-crystallographic finite types, but we hack around this for now by just forbidding the inheritance of the relabel's finite type.\n\nThe original error was found by\n\n```\nsage: p=2; q=2; r=5\nsage: CoxeterMatrix([[1,p,r],[p,1,q],[r,q,1]])\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n...\nAttributeError: 'NoneType' object has no attribute 'dimension'\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24892\n\n",
    "closed_at": "2018-03-19T07:57:46Z",
    "created_at": "2018-03-02T16:24:08Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Relabelled non-crystallographic finite types should not have an ambient space (yet)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24892",
    "user": "https://github.com/videlec"
}
```
CC:  @jplab @tscrim

Keywords: days93

Non-crystallographic finite types have an `ambient_space()` that returns `None`, indicating that Sage does not know how to construct it:

```
sage: CartanType(['I',5]).root_system().ambient_space() is None
True
```
However, the relabelled finite types assume that it is not `None`, which results in an error:

```
sage: CartanType(['I',5]).relabel({1:0,2:1}).root_system().ambient_space()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-3-0f9f382ffb1f> in <module>()
----> 1 CartanType(['I',Integer(5)]).relabel({Integer(1):Integer(0),Integer(2):Integer(1)}).root_system().ambient_space()

/home/travis/sage-build/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10785)()
   2012                 return cache[k]
   2013         except KeyError:
-> 2014             w = self._instance_call(*args, **kwds)
   2015             cache[k] = w
   2016             return w

/home/travis/sage-build/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:10236)()
   1888             True
   1889         """
-> 1890         return self.f(self._instance, *args, **kwds)
   1891 
   1892     cdef fix_args_kwds(self, tuple args, dict kwds):

/home/travis/sage-build/local/lib/python2.7/site-packages/sage/combinat/root_system/root_system.pyc in ambient_space(self, base_ring)
    749         if not base_ring.has_coerce_map_from(AmbientSpace.smallest_base_ring(self.cartan_type())):
    750             return None
--> 751         return AmbientSpace(self, base_ring)
    752 
    753     def coambient_space(self, base_ring=QQ):

/home/travis/sage-build/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1590)()
    328         """
    329         if cls.classcall is not None:
--> 330             return cls.classcall(cls, *args, **kwds)
    331         else:
    332             # Fast version of type.__call__(cls, *args, **kwds)

/home/travis/sage-build/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6246)()
   1057                 return self.cache[k]
   1058         except KeyError:
-> 1059             w = self.f(*args, **kwds)
   1060             self.cache[k] = w
   1061             return w

/home/travis/sage-build/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in __classcall__(cls, *args, **options)
   1019             True
   1020         """
-> 1021         instance = typecall(cls, *args, **options)
   1022         assert isinstance( instance, cls )
   1023         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:

/home/travis/sage-build/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2040)()
    495             TypeError: Argument 'cls' has incorrect type (expected type, got classobj)
    496     """
--> 497     return (<PyTypeObject*>type).tp_call(cls, args, kwds)
    498 
    499 # Class for timing::

/home/travis/sage-build/local/lib/python2.7/site-packages/sage/combinat/root_system/ambient_space.pyc in __init__(self, root_system, base_ring, index_set)
     89         self.root_system = root_system
     90         if index_set is None:
---> 91             index_set = tuple(range(0, self.dimension()))
     92         CombinatorialFreeModule.__init__(self, base_ring,
     93                                          index_set,

/home/travis/sage-build/local/lib/python2.7/site-packages/sage/combinat/root_system/type_relabel.pyc in dimension(self)
    425         """
    426         # Can't yet use _dual_space for the base ring (and cartan_type?) is not yet initialized
--> 427         return self.root_system.cartan_type()._type.root_system().ambient_space().dimension()
    428 
    429     @cached_method

AttributeError: 'NoneType' object has no attribute 'dimension'
```

A proper fix for this issue would be implementing ambient spaces for non-crystallographic finite types, but we hack around this for now by just forbidding the inheritance of the relabel's finite type.

The original error was found by

```
sage: p=2; q=2; r=5
sage: CoxeterMatrix([[1,p,r],[p,1,q],[r,q,1]])
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
...
AttributeError: 'NoneType' object has no attribute 'dimension'
```


Issue created by migration from https://trac.sagemath.org/ticket/24892





---

archive/issue_comments_345403.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-02T22:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345403",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_345404.json:
```json
{
    "body": "Okay, I found the underlying issue and hacked around it. The proper fix can be a followup. See the ticket description.\n\nAlso, you can do a little better for the ticket title. :P\n\n---\nNew commits:",
    "created_at": "2018-03-02T22:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345404",
    "user": "https://github.com/tscrim"
}
```

Okay, I found the underlying issue and hacked around it. The proper fix can be a followup. See the ticket description.

Also, you can do a little better for the ticket title. :P

---
New commits:



---

archive/issue_comments_345405.json:
```json
{
    "body": "I also fixed some issues with the outputs of relabeled types H and I that were related and useful in my debugging.",
    "created_at": "2018-03-02T22:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345405",
    "user": "https://github.com/tscrim"
}
```

I also fixed some issues with the outputs of relabeled types H and I that were related and useful in my debugging.



---

archive/issue_comments_345406.json:
```json
{
    "body": "positive review if patchbot turns green",
    "created_at": "2018-03-03T08:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345406",
    "user": "https://github.com/fchapoton"
}
```

positive review if patchbot turns green



---

archive/issue_comments_345407.json:
```json
{
    "body": "some failing doctests",
    "created_at": "2018-03-03T10:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345407",
    "user": "https://github.com/fchapoton"
}
```

some failing doctests



---

archive/issue_comments_345408.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-03T10:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345408",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_345409.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-03T21:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345409",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_345410.json:
```json
{
    "body": "I added a short-circuiting exemption for super Cartan types (for which there is not really a notion of crystallographic AFAIK, which is why there is no such method for them).",
    "created_at": "2018-03-03T21:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345410",
    "user": "https://github.com/tscrim"
}
```

I added a short-circuiting exemption for super Cartan types (for which there is not really a notion of crystallographic AFAIK, which is why there is no such method for them).



---

archive/issue_comments_345411.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-03T21:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345411",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_345412.json:
```json
{
    "body": "ping",
    "created_at": "2018-03-08T09:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345412",
    "user": "https://github.com/tscrim"
}
```

ping



---

archive/issue_comments_345413.json:
```json
{
    "body": "**ping**",
    "created_at": "2018-03-11T03:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345413",
    "user": "https://github.com/tscrim"
}
```

**ping**



---

archive/issue_comments_345414.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-11T07:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345414",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_345415.json:
```json
{
    "body": "ok",
    "created_at": "2018-03-11T07:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345415",
    "user": "https://github.com/fchapoton"
}
```

ok



---

archive/issue_comments_345416.json:
```json
{
    "body": "Thank you.",
    "created_at": "2018-03-11T07:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345416",
    "user": "https://github.com/tscrim"
}
```

Thank you.



---

archive/issue_events_062511.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-19T07:57:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24892#event-62511"
}
```



---

archive/issue_comments_345417.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-19T07:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24892#issuecomment-345417",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
