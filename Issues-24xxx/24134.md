# Issue 24134: Move real/complex interval fields to new coercion model

archive/issues_024134.json:
```json
{
    "body": "CC:  @tscrim\n\nAlso fix the following:\n\n```\nsage: NF.<a> = QuadraticField(-2)\nsage: CIF(a)\n...\nValueError: can not convert complex algebraic number to real interval\n```\n\nWe also deal with Python 3 compatibility regarding `int`/`long` and `bytes`/`unicode`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24371\n\n",
    "closed_at": "2018-02-15T23:13:40Z",
    "created_at": "2017-12-12T17:07:42Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Move real/complex interval fields to new coercion model",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24134",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @tscrim

Also fix the following:

```
sage: NF.<a> = QuadraticField(-2)
sage: CIF(a)
...
ValueError: can not convert complex algebraic number to real interval
```

We also deal with Python 3 compatibility regarding `int`/`long` and `bytes`/`unicode`.

Issue created by migration from https://trac.sagemath.org/ticket/24371





---

archive/issue_comments_337860.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-14T12:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337860",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337861.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-14T17:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337861",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337862.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-15T12:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337862",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337863.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-15T16:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337863",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337864.json:
```json
{
    "body": "This will conflict with #23739, but note that #23739 is currently stalled.",
    "created_at": "2017-12-15T21:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337864",
    "user": "https://github.com/tscrim"
}
```

This will conflict with #23739, but note that #23739 is currently stalled.



---

archive/issue_comments_337865.json:
```json
{
    "body": "Also, I imagine #24363 is a dependency from looking at the code.",
    "created_at": "2017-12-15T21:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337865",
    "user": "https://github.com/tscrim"
}
```

Also, I imagine #24363 is a dependency from looking at the code.



---

archive/issue_comments_337866.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> Also, I imagine #24363 is a dependency from looking at the code.\n\n\nI don't see why.",
    "created_at": "2017-12-16T08:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337866",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 tscrim]:
> Also, I imagine #24363 is a dependency from looking at the code.


I don't see why.



---

archive/issue_comments_337867.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> This will conflict with #23739, but note that #23739 is currently stalled.\n\n\nI shouldn't be hard to fix #23739 in this ticket.",
    "created_at": "2017-12-16T09:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337867",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 tscrim]:
> This will conflict with #23739, but note that #23739 is currently stalled.


I shouldn't be hard to fix #23739 in this ticket.



---

archive/issue_comments_337868.json:
```json
{
    "body": "I also shortly want to note #15114 here and the discussion from which that ticket spawned at [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/coercion$20interval$20field%7Csort:date/sage-devel/zfg0PhFR_qA/t2SY2cbOCAAJ). I am not saying it needs to get fixed here, but it is a good thing to have in the back of your mind while working on this ticket so that at least things do not get worse in that respect.",
    "created_at": "2017-12-16T10:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337868",
    "user": "https://github.com/koffie"
}
```

I also shortly want to note #15114 here and the discussion from which that ticket spawned at [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/coercion$20interval$20field%7Csort:date/sage-devel/zfg0PhFR_qA/t2SY2cbOCAAJ). I am not saying it needs to get fixed here, but it is a good thing to have in the back of your mind while working on this ticket so that at least things do not get worse in that respect.



---

archive/issue_comments_337869.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> Replying to [comment:10 tscrim]:\n> > Also, I imagine #24363 is a dependency from looking at the code.\n\n> \n> I don't see why.\n\n\nI thought I saw a conflict, but that turns out to not be the case.",
    "created_at": "2017-12-16T12:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337869",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 tscrim]:
> > Also, I imagine #24363 is a dependency from looking at the code.

> 
> I don't see why.


I thought I saw a conflict, but that turns out to not be the case.



---

archive/issue_comments_337870.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-17T20:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337870",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337871.json:
```json
{
    "body": "Replying to [comment:14 mderickx]:\n> I also shortly want to note #15114 here and the discussion from which that ticket spawned at [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/coercion$20interval$20field%7Csort:date/sage-devel/zfg0PhFR_qA/t2SY2cbOCAAJ). I am not saying it needs to get fixed here, but it is a good thing to have in the back of your mind while working on this ticket so that at least things do not get worse in that respect.\n\n\nOK. So with #15114 in mind, this should be a feature and not a bug:\n\n```\nsage: CC.one() + CIF.one()\n...\nTypeError: unsupported operand parent(s) for +: 'Complex Field with 53 bits of precision' and 'Complex Interval Field with 53 bits of precision'\n```",
    "created_at": "2017-12-18T08:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337871",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 mderickx]:
> I also shortly want to note #15114 here and the discussion from which that ticket spawned at [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/coercion$20interval$20field%7Csort:date/sage-devel/zfg0PhFR_qA/t2SY2cbOCAAJ). I am not saying it needs to get fixed here, but it is a good thing to have in the back of your mind while working on this ticket so that at least things do not get worse in that respect.


OK. So with #15114 in mind, this should be a feature and not a bug:

```
sage: CC.one() + CIF.one()
...
TypeError: unsupported operand parent(s) for +: 'Complex Field with 53 bits of precision' and 'Complex Interval Field with 53 bits of precision'
```



---

archive/issue_comments_337872.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-18T14:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337872",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-19T08:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337873",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-19T09:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-19T14:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337876.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-22T12:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337876",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337877.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-22T16:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-22T16:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337878",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337879.json:
```json
{
    "body": "Rebased (trivial conflits only)... Is this ready for review?",
    "created_at": "2018-02-07T14:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337879",
    "user": "https://github.com/mezzarobba"
}
```

Rebased (trivial conflits only)... Is this ready for review?



---

archive/issue_comments_337880.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-07T14:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337880",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337881.json:
```json
{
    "body": "Replying to [comment:29 mmezzarobba]:\n> Is this ready for review?\n\n\nNot sure... I wanted to wait until the dependencies are merged before continuing with this.\n\nIt should be *mostly* done though. If it passes doctests, it might as well be \"needs review\".",
    "created_at": "2018-02-07T19:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337881",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:29 mmezzarobba]:
> Is this ready for review?


Not sure... I wanted to wait until the dependencies are merged before continuing with this.

It should be *mostly* done though. If it passes doctests, it might as well be "needs review".



---

archive/issue_comments_337882.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-09T14:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337882",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337883.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-09T14:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337883",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337884.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-09T14:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337884",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337885.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-09T14:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337885",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337886.json:
```json
{
    "body": "I still need to implement the Python 3 compatibility that I promised.",
    "created_at": "2018-02-09T14:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337886",
    "user": "https://github.com/jdemeyer"
}
```

I still need to implement the Python 3 compatibility that I promised.



---

archive/issue_comments_337887.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-09T16:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337887",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337888.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-09T16:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337888",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337889.json:
```json
{
    "body": "Some comments:\n\n- I know this is slightly outside the purview of this ticket, but perhaps we can rename `ComplexIntervalField_class` to `ComplexIntervalField` and have it inherit from `UniqueRepresentation` in order to get rid of the custom caching. I can also do this if you want.\n- I would do the same for `RealIntervalField_class` except it is an extension class. Do you think there is a benefit for that? We don't even do that for `Rationals`.\n- Why not use ``@`cached_method` for `real_field`, `middle_field`, etc.? They to have `UniqueRepresentation`-like behavior, so do not strictly need to be cached. However, I am assuming they are cached for speed reasons, so doing ``@`cached_method` is the best for repeated use:\n  {{{#!sage\nsage: class Foo(object):\n....:     def __init__(self):\n....:         self._cache2 = None\n....:     `@`cached_method\n....:     def cm(self):\n....:         return 5\n....:     def c1(self):\n....:         try:\n....:             return self._cache1\n....:         except AttributeError:\n....:             self._cache1 = 5\n....:             return self._cache1\n....:     def c2(self):\n....:         if self._cache2 is None:\n....:             self._cache2 = 5\n....:         return self._cache2\nsage: timeit('F = Foo(); F.cm()', number=10000, repeat=20)\n10000 loops, best of 20: 1.53 \u00b5s per loop\nsage: timeit('F = Foo(); F.c1()', number=10000, repeat=20)\n10000 loops, best of 20: 1.39 \u00b5s per loop\nsage: timeit('F = Foo(); F.c2()', number=10000, repeat=20)\n10000 loops, best of 20: 635 ns per loop\nsage: F = Foo()\nsage: timeit('F.cm()', number=10000, repeat=20)\n10000 loops, best of 20: 68.7 ns per loop\nsage: timeit('F.c1()', number=10000, repeat=20)\n10000 loops, best of 20: 121 ns per loop\nsage: timeit('F.c2()', number=10000, repeat=20)\n10000 loops, best of 20: 1.49 \u00b5s per loop\n  }}}\n- Is the `_real_field = real_field` leftover from testing? I think it should be removed altogether.\n- You should replace\n  {{{#!diff\n        return complex_interval.ComplexIntervalFieldElement(self, x, im, **kwds)\n        return self.element_class(self, x, im, **kwds)\n  }}}\n  (in fact, if that is used elsewhere in the file, it should be replaced as well) to pick up the category contributions.\n- Same comment for returning `RealIntervalFieldElement`.\n- Similarly, I would also make this change:\n  {{{#!diff\n     R = RealIntervalField(prec=max(bits+pad, min_prec))\n     if upper is not None:\n         s = (s, upper)\n-    return RealIntervalFieldElement(R, s, base)\n+    return R.element_class(R, s, base)\n }}}\n\nI think it looks good otherwise.",
    "created_at": "2018-02-09T21:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337889",
    "user": "https://github.com/tscrim"
}
```

Some comments:

- I know this is slightly outside the purview of this ticket, but perhaps we can rename `ComplexIntervalField_class` to `ComplexIntervalField` and have it inherit from `UniqueRepresentation` in order to get rid of the custom caching. I can also do this if you want.
- I would do the same for `RealIntervalField_class` except it is an extension class. Do you think there is a benefit for that? We don't even do that for `Rationals`.
- Why not use ``@`cached_method` for `real_field`, `middle_field`, etc.? They to have `UniqueRepresentation`-like behavior, so do not strictly need to be cached. However, I am assuming they are cached for speed reasons, so doing ``@`cached_method` is the best for repeated use:
  {{{#!sage
sage: class Foo(object):
....:     def __init__(self):
....:         self._cache2 = None
....:     `@`cached_method
....:     def cm(self):
....:         return 5
....:     def c1(self):
....:         try:
....:             return self._cache1
....:         except AttributeError:
....:             self._cache1 = 5
....:             return self._cache1
....:     def c2(self):
....:         if self._cache2 is None:
....:             self._cache2 = 5
....:         return self._cache2
sage: timeit('F = Foo(); F.cm()', number=10000, repeat=20)
10000 loops, best of 20: 1.53 µs per loop
sage: timeit('F = Foo(); F.c1()', number=10000, repeat=20)
10000 loops, best of 20: 1.39 µs per loop
sage: timeit('F = Foo(); F.c2()', number=10000, repeat=20)
10000 loops, best of 20: 635 ns per loop
sage: F = Foo()
sage: timeit('F.cm()', number=10000, repeat=20)
10000 loops, best of 20: 68.7 ns per loop
sage: timeit('F.c1()', number=10000, repeat=20)
10000 loops, best of 20: 121 ns per loop
sage: timeit('F.c2()', number=10000, repeat=20)
10000 loops, best of 20: 1.49 µs per loop
  }}}
- Is the `_real_field = real_field` leftover from testing? I think it should be removed altogether.
- You should replace
  {{{#!diff
        return complex_interval.ComplexIntervalFieldElement(self, x, im, **kwds)
        return self.element_class(self, x, im, **kwds)
  }}}
  (in fact, if that is used elsewhere in the file, it should be replaced as well) to pick up the category contributions.
- Same comment for returning `RealIntervalFieldElement`.
- Similarly, I would also make this change:
  {{{#!diff
     R = RealIntervalField(prec=max(bits+pad, min_prec))
     if upper is not None:
         s = (s, upper)
-    return RealIntervalFieldElement(R, s, base)
+    return R.element_class(R, s, base)
 }}}

I think it looks good otherwise.



---

archive/issue_comments_337890.json:
```json
{
    "body": "I consider the proposed changes to unique representation outside the scope of this ticket. This ticket is already reasonably large, let's not add more things. I'll have a look at your other comments.",
    "created_at": "2018-02-09T21:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337890",
    "user": "https://github.com/jdemeyer"
}
```

I consider the proposed changes to unique representation outside the scope of this ticket. This ticket is already reasonably large, let's not add more things. I'll have a look at your other comments.



---

archive/issue_comments_337891.json:
```json
{
    "body": "I guess the `_real_field = real_field` is to avoid #24695 as a dependency?",
    "created_at": "2018-02-09T21:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337891",
    "user": "https://github.com/tscrim"
}
```

I guess the `_real_field = real_field` is to avoid #24695 as a dependency?



---

archive/issue_comments_337892.json:
```json
{
    "body": "We should also do changes of the form in `ComplexIntervalFieldElement`:\n\n```diff\n-return ComplexIntervalFieldElement(self._parent, re, im)\n+return type(self)(self._parent, re, im)\n```\nand similarly for `RealIntervalFieldElement`.",
    "created_at": "2018-02-09T21:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337892",
    "user": "https://github.com/tscrim"
}
```

We should also do changes of the form in `ComplexIntervalFieldElement`:

```diff
-return ComplexIntervalFieldElement(self._parent, re, im)
+return type(self)(self._parent, re, im)
```
and similarly for `RealIntervalFieldElement`.



---

archive/issue_comments_337893.json:
```json
{
    "body": "Replying to [comment:42 tscrim]:\n> I guess the `_real_field = real_field` is to avoid #24695 as a dependency?\n\n\nI wasn't actually aware of that, thanks for the pointer :-)",
    "created_at": "2018-02-09T21:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337893",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:42 tscrim]:
> I guess the `_real_field = real_field` is to avoid #24695 as a dependency?


I wasn't actually aware of that, thanks for the pointer :-)



---

archive/issue_comments_337894.json:
```json
{
    "body": "I guess I kept `_real_field` for compatibility with other \"complex number\" implementations such as\n\n```\nsage: CC._real_field()\nReal Field with 53 bits of precision\n```\n\nWe should probably have a separate ticket to replace `_real_field` by `real_field`: this looks like a useful method, it should not be private.",
    "created_at": "2018-02-12T12:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337894",
    "user": "https://github.com/jdemeyer"
}
```

I guess I kept `_real_field` for compatibility with other "complex number" implementations such as

```
sage: CC._real_field()
Real Field with 53 bits of precision
```

We should probably have a separate ticket to replace `_real_field` by `real_field`: this looks like a useful method, it should not be private.



---

archive/issue_comments_337895.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-12T13:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337895",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337896.json:
```json
{
    "body": "I ended up doing a lot of cleanup. I think I'm using `element_class` everywhere, but don't shoot me if I'm wrong.\n\nNote that currently the category stuff won't be used anyway because the elements are extension types.",
    "created_at": "2018-02-12T13:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337896",
    "user": "https://github.com/jdemeyer"
}
```

I ended up doing a lot of cleanup. I think I'm using `element_class` everywhere, but don't shoot me if I'm wrong.

Note that currently the category stuff won't be used anyway because the elements are extension types.



---

archive/issue_comments_337897.json:
```json
{
    "body": "Thank you for doing the cleanup.\n\nFor changes such as\n\n```diff\n-        cdef ComplexIntervalFieldElement res = self._new()\n+        res = self._new()\n```\naren't we loosing some efficiency? I would think because they are still subclasses of `ComplexIntervalFieldElement`, that Cython would be able to optimize their attribute lookups by not treating them as Python objects? (Of course, we would have to explicitly cast `<ComplexIntervalFieldElement>` to avoid the type-checking-safety-penalty.)\n\nThis goes through the `__call__` (which in this case, bypasses the coercion framework, but normally it wouldn't):\n\n```diff\n-        return complex_interval.ComplexIntervalFieldElement(self, 0, 1)\n+        return self(0, 1)\n```\nI think we are better making a direct call to `self.element_class(self, 0, 1)` since this is not user input.",
    "created_at": "2018-02-13T01:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337897",
    "user": "https://github.com/tscrim"
}
```

Thank you for doing the cleanup.

For changes such as

```diff
-        cdef ComplexIntervalFieldElement res = self._new()
+        res = self._new()
```
aren't we loosing some efficiency? I would think because they are still subclasses of `ComplexIntervalFieldElement`, that Cython would be able to optimize their attribute lookups by not treating them as Python objects? (Of course, we would have to explicitly cast `<ComplexIntervalFieldElement>` to avoid the type-checking-safety-penalty.)

This goes through the `__call__` (which in this case, bypasses the coercion framework, but normally it wouldn't):

```diff
-        return complex_interval.ComplexIntervalFieldElement(self, 0, 1)
+        return self(0, 1)
```
I think we are better making a direct call to `self.element_class(self, 0, 1)` since this is not user input.



---

archive/issue_comments_337898.json:
```json
{
    "body": "Replying to [comment:48 tscrim]:\n> Thank you for doing the cleanup.\n> \n> For changes such as\n> \n> ```diff\n> -        cdef ComplexIntervalFieldElement res = self._new()\n> +        res = self._new()\n> ```\n> aren't we loosing some efficiency?\n\n\nNo, Cython has type inference. Since `_new` is declared as returning a `ComplexIntervalFieldElement`, the declaration `cdef ComplexIntervalFieldElement res` is just redundant.\n\n> This goes through the `__call__` (which in this case, bypasses the coercion framework, but normally it wouldn't):\n> \n> ```diff\n> -        return complex_interval.ComplexIntervalFieldElement(self, 0, 1)\n> +        return self(0, 1)\n> ```\n> I think we are better making a direct call to `self.element_class(self, 0, 1)` since this is not user input.\n\n\nI don't see the problem with using `__call__` here but I can make that change.",
    "created_at": "2018-02-13T06:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337898",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:48 tscrim]:
> Thank you for doing the cleanup.
> 
> For changes such as
> 
> ```diff
> -        cdef ComplexIntervalFieldElement res = self._new()
> +        res = self._new()
> ```
> aren't we loosing some efficiency?


No, Cython has type inference. Since `_new` is declared as returning a `ComplexIntervalFieldElement`, the declaration `cdef ComplexIntervalFieldElement res` is just redundant.

> This goes through the `__call__` (which in this case, bypasses the coercion framework, but normally it wouldn't):
> 
> ```diff
> -        return complex_interval.ComplexIntervalFieldElement(self, 0, 1)
> +        return self(0, 1)
> ```
> I think we are better making a direct call to `self.element_class(self, 0, 1)` since this is not user input.


I don't see the problem with using `__call__` here but I can make that change.



---

archive/issue_comments_337899.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-13T08:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337899",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337900.json:
```json
{
    "body": "Replying to [comment:48 tscrim]:\n> Cython would be able to optimize their attribute lookups by not treating them as Python objects?\n\n\nActually, the relevant attributes are `cdef` attributes, so they cannot even be accessed from Python! So the fact that the code works proves that Cython must be doing type inference.\n\nI changed some `self(...)` calls to `self.element_class(self, ...)`",
    "created_at": "2018-02-13T09:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337900",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:48 tscrim]:
> Cython would be able to optimize their attribute lookups by not treating them as Python objects?


Actually, the relevant attributes are `cdef` attributes, so they cannot even be accessed from Python! So the fact that the code works proves that Cython must be doing type inference.

I changed some `self(...)` calls to `self.element_class(self, ...)`



---

archive/issue_comments_337901.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-13T12:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337901",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_337902.json:
```json
{
    "body": "Replying to [comment:51 jdemeyer]:\n> Replying to [comment:48 tscrim]:\n> > Cython would be able to optimize their attribute lookups by not treating them as Python objects?\n\n> \n> Actually, the relevant attributes are `cdef` attributes, so they cannot even be accessed from Python! So the fact that the code works proves that Cython must be doing type inference.\n\n\nThat is what is happening, e.g.:\n\n```C\n  __pyx_t_1 = ((PyObject *)__pyx_f_4sage_5rings_16complex_interval_27ComplexIntervalFieldE\nlement__new(__pyx_v_self)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 325, __pyx_L1_error)\n  __Pyx_GOTREF(__pyx_t_1);\n  __pyx_v_a00 = ((struct __pyx_obj_4sage_5rings_16complex_interval_ComplexIntervalFieldEle\nment *)__pyx_t_1);\n  __pyx_t_1 = 0;\n```\nI didn't realize that Cython was that smart. :)\n\n> I changed some `self(...)` calls to `self.element_class(self, ...)`\n\n\nThank you. LGTM. (If I wanted to be **really** picky, I would say `self.element_class(self, 1)` should instead use the cached `self.one()`, but `zeta(1)` is almost certainly never called.)",
    "created_at": "2018-02-13T12:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337902",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:51 jdemeyer]:
> Replying to [comment:48 tscrim]:
> > Cython would be able to optimize their attribute lookups by not treating them as Python objects?

> 
> Actually, the relevant attributes are `cdef` attributes, so they cannot even be accessed from Python! So the fact that the code works proves that Cython must be doing type inference.


That is what is happening, e.g.:

```C
  __pyx_t_1 = ((PyObject *)__pyx_f_4sage_5rings_16complex_interval_27ComplexIntervalFieldE
lement__new(__pyx_v_self)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 325, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_a00 = ((struct __pyx_obj_4sage_5rings_16complex_interval_ComplexIntervalFieldEle
ment *)__pyx_t_1);
  __pyx_t_1 = 0;
```
I didn't realize that Cython was that smart. :)

> I changed some `self(...)` calls to `self.element_class(self, ...)`


Thank you. LGTM. (If I wanted to be **really** picky, I would say `self.element_class(self, 1)` should instead use the cached `self.one()`, but `zeta(1)` is almost certainly never called.)



---

archive/issue_comments_337903.json:
```json
{
    "body": "Thanks!",
    "created_at": "2018-02-13T15:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337903",
    "user": "https://github.com/jdemeyer"
}
```

Thanks!



---

archive/issue_comments_337904.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-15T23:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24134#issuecomment-337904",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061626.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-15T23:13:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24134",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24134#event-61626"
}
```
