# Issue 24884: Matrix-related fixes in differential geometry

archive/issues_024647.json:
```json
{
    "body": "These are changes which are needed because of #24742.\n\n1. `src/sage/schemes/riemann_surfaces/riemann_surface.py`: #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly. The fix is easy: pass actual elements of the ring instead of the generator names. This is clearly the right thing to do.\n\n2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does. I also got rid of the evil `try`/`except` block trying to construct a matrix but happily returning a list if that failed.\n\n3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.\n\n**CC:**  @egourgoulhon @tscrim\n\n**Branch/Commit:** [6ae84f147a2209e0396d508c77b4c86e706f3227](https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Jeroen Demeyer, Eric Gourgoulhon\n\nIssue created by migration from https://trac.sagemath.org/ticket/24884\n\n",
    "closed_at": "2018-03-08T00:02:39Z",
    "created_at": "2018-03-02T10:05:23Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "title": "Matrix-related fixes in differential geometry",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/24884",
    "user": "https://github.com/jdemeyer"
}
```
These are changes which are needed because of #24742.

1. `src/sage/schemes/riemann_surfaces/riemann_surface.py`: #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly. The fix is easy: pass actual elements of the ring instead of the generator names. This is clearly the right thing to do.

2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does. I also got rid of the evil `try`/`except` block trying to construct a matrix but happily returning a list if that failed.

3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.

**CC:**  @egourgoulhon @tscrim

**Branch/Commit:** [6ae84f147a2209e0396d508c77b4c86e706f3227](https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227)

**Reviewer:** Travis Scrimshaw

**Author:** Jeroen Demeyer, Eric Gourgoulhon

Issue created by migration from https://trac.sagemath.org/ticket/24884





---

archive/issue_comments_380953.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/matrix_related_fixes_in_differential_geometry)",
    "created_at": "2018-03-02T10:06:22Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380953",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/matrix_related_fixes_in_differential_geometry)



---

archive/issue_comments_380954.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd532ab6734f5a87df0c237f75105c92c1158c3d\">bd532ab</a></td><td><code>Matrix-related fixes in differential geometry</code></td></tr></table>\n",
    "created_at": "2018-03-02T10:11:19Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380954",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd532ab6734f5a87df0c237f75105c92c1158c3d">bd532ab</a></td><td><code>Matrix-related fixes in differential geometry</code></td></tr></table>




---

archive/issue_events_220481.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-02T10:11:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220481"
}
```



---

archive/issue_comments_380955.json:
```json
{
    "body": "**Commit:** [bd532ab6734f5a87df0c237f75105c92c1158c3d](https://github.com/sagemath/sagetrac-mirror/commit/bd532ab6734f5a87df0c237f75105c92c1158c3d)",
    "created_at": "2018-03-02T10:11:19Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380955",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [bd532ab6734f5a87df0c237f75105c92c1158c3d](https://github.com/sagemath/sagetrac-mirror/commit/bd532ab6734f5a87df0c237f75105c92c1158c3d)



---

archive/issue_comments_380956.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,7 @@\n These are changes which are needed because of #24742.\n+\n+1. `src/sage/schemes/riemann_surfaces/riemann_surface.py` are needed because #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly.\n+\n+2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests, not because it's the right thing to do. I also added some documentation to reflect better what the `_get_list()` method does.\n+\n+3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.\n``````\n",
    "created_at": "2018-03-02T10:11:19Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380956",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,7 @@
 These are changes which are needed because of #24742.
+
+1. `src/sage/schemes/riemann_surfaces/riemann_surface.py` are needed because #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly.
+
+2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests, not because it's the right thing to do. I also added some documentation to reflect better what the `_get_list()` method does.
+
+3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.
``````




---

archive/issue_comments_380957.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n These are changes which are needed because of #24742.\n \n-1. `src/sage/schemes/riemann_surfaces/riemann_surface.py` are needed because #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly.\n+1. `src/sage/schemes/riemann_surfaces/riemann_surface.py`: #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly. The fix is easy: pass actual elements of the ring instead of the generator names. This is clearly the right thing to do.\n \n-2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests, not because it's the right thing to do. I also added some documentation to reflect better what the `_get_list()` method does.\n+2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does.\n \n 3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.\n``````\n",
    "created_at": "2018-03-02T10:13:08Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380957",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 These are changes which are needed because of #24742.
 
-1. `src/sage/schemes/riemann_surfaces/riemann_surface.py` are needed because #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly.
+1. `src/sage/schemes/riemann_surfaces/riemann_surface.py`: #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly. The fix is easy: pass actual elements of the ring instead of the generator names. This is clearly the right thing to do.
 
-2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests, not because it's the right thing to do. I also added some documentation to reflect better what the `_get_list()` method does.
+2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does.
 
 3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.
``````




---

archive/issue_comments_380958.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,6 +2,6 @@\n \n 1. `src/sage/schemes/riemann_surfaces/riemann_surface.py`: #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly. The fix is easy: pass actual elements of the ring instead of the generator names. This is clearly the right thing to do.\n \n-2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does.\n+2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does. I also got rid of the evil `try`/`except` block trying to construct a matrix but happily returning a list if that failed.\n \n 3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.\n``````\n",
    "created_at": "2018-03-02T10:14:26Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380958",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,6 +2,6 @@
 
 1. `src/sage/schemes/riemann_surfaces/riemann_surface.py`: #24742 will disallow passing strings to the matrix constructor. It's a rarely used feature and hard to get right properly. The fix is easy: pass actual elements of the ring instead of the generator names. This is clearly the right thing to do.
 
-2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does.
+2. `src/sage/tensor/modules/comp.py`: I needed to change `_get_list()` but I have to say that I don't understand what the code is supposed to do. I wrote the code the way I did mainly to pass doctests. I also added some documentation to reflect better what the `_get_list()` method does. I also got rid of the evil `try`/`except` block trying to construct a matrix but happily returning a list if that failed.
 
 3. `src/sage/manifolds/differentiable/metric.py`: this is a consequence of the change in 2. and it looks like a sensible change.
``````




---

archive/issue_comments_380959.json:
```json
{
    "body": "<a id='comment:5'></a>\nChanges LGTM (Eric, if you see something you do not like, feel free to revert).",
    "created_at": "2018-03-02T22:45:26Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380959",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Changes LGTM (Eric, if you see something you do not like, feel free to revert).



---

archive/issue_comments_380960.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-03-02T22:45:26Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380960",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_events_220482.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-03-02T22:45:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220482"
}
```



---

archive/issue_events_220483.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-03-02T22:45:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220483"
}
```



---

archive/issue_events_220484.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2018-03-02T22:56:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220484"
}
```



---

archive/issue_events_220485.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2018-03-02T22:56:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220485"
}
```



---

archive/issue_comments_380961.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [@tscrim](#comment%3A5):\n> Changes LGTM (Eric, if you see something you do not like, feel free to revert).\n\nHi Travis, I was just looking to the ticket, at the same time as you apparently! The change in the doctest of `src/sage/manifold/differentiable/metric.py` (point 3 in the ticket description) is not desirable: it results from a forced conversion of SymPy to `SR` due to the change in `src/sage/tensor/modules/comp.py` (point 2). Jeroen, the line \n\n```\nreturn matrix(SR, resu)\n```\nforces the conversion of elements of the list `resu` to `SR` elements, while they can actually belong to something else, like SymPy. Is there a good reason for this? Do we have now to explicitly specify the ring as the first argument of `matrix`? Since SymPy elements do not constitute a ring in Sage, one cannot construct a matrix for them. I plan to improve this in the short future, by implementing a ring of SymPy coordinate functions. But for the time being, I would say it is preferable to return a list of SymPy elements instead of a  matrix of `SR` elements.",
    "created_at": "2018-03-02T23:12:44Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380961",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>
Replying to [@tscrim](#comment%3A5):
> Changes LGTM (Eric, if you see something you do not like, feel free to revert).

Hi Travis, I was just looking to the ticket, at the same time as you apparently! The change in the doctest of `src/sage/manifold/differentiable/metric.py` (point 3 in the ticket description) is not desirable: it results from a forced conversion of SymPy to `SR` due to the change in `src/sage/tensor/modules/comp.py` (point 2). Jeroen, the line 

```
return matrix(SR, resu)
```
forces the conversion of elements of the list `resu` to `SR` elements, while they can actually belong to something else, like SymPy. Is there a good reason for this? Do we have now to explicitly specify the ring as the first argument of `matrix`? Since SymPy elements do not constitute a ring in Sage, one cannot construct a matrix for them. I plan to improve this in the short future, by implementing a ring of SymPy coordinate functions. But for the time being, I would say it is preferable to return a list of SymPy elements instead of a  matrix of `SR` elements.



---

archive/issue_comments_380962.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [@egourgoulhon](#comment%3A7):\n> Jeroen, the line \n> \n> ```\n> return matrix(SR, resu)\n> ```\n> forces the conversion of elements of the list `resu` to `SR` elements, while they can actually belong to something else, like SymPy. Is there a good reason for this?\n\nI just did that to be consistent with the documentation. The documentation never said \"return a matrix, except when using the SymPy backend\". I did make an exception for the `str` formatter, because that was documented (not in this method but elsewhere).\n\n> Do we have now to explicitly specify the ring as the first argument of `matrix`?\n\nNo, that won't be required. But again, it's good for consistency that you always get the same kind of object back (a symbolic matrix).\n\n> I would say it is preferable to return a list of SymPy elements instead of a  matrix of `SR` elements.\n\nThat is fine for me, but then SymPy elements should *always* return a list. The main thing that I do not like about the current code is this `try`/`except` block:\n\n```python\n            try:\n                for i in range(self._dim):\n                    for j in range(self._dim):\n                        a = resu[i][j]\n                        if hasattr(a, '_express'):\n                            resu[i][j] = a.expr()\n                resu = matrix(resu)  # for a nicer output\n            except TypeError:\n                pass\n```\nWith this code, you really have no idea whether a matrix or a list will be returned. And if it's a matrix, you don't know over which base ring.\n\nTravis, what do you think?",
    "created_at": "2018-03-03T08:36:10Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380962",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [@egourgoulhon](#comment%3A7):
> Jeroen, the line 
> 
> ```
> return matrix(SR, resu)
> ```
> forces the conversion of elements of the list `resu` to `SR` elements, while they can actually belong to something else, like SymPy. Is there a good reason for this?

I just did that to be consistent with the documentation. The documentation never said "return a matrix, except when using the SymPy backend". I did make an exception for the `str` formatter, because that was documented (not in this method but elsewhere).

> Do we have now to explicitly specify the ring as the first argument of `matrix`?

No, that won't be required. But again, it's good for consistency that you always get the same kind of object back (a symbolic matrix).

> I would say it is preferable to return a list of SymPy elements instead of a  matrix of `SR` elements.

That is fine for me, but then SymPy elements should *always* return a list. The main thing that I do not like about the current code is this `try`/`except` block:

```python
            try:
                for i in range(self._dim):
                    for j in range(self._dim):
                        a = resu[i][j]
                        if hasattr(a, '_express'):
                            resu[i][j] = a.expr()
                resu = matrix(resu)  # for a nicer output
            except TypeError:
                pass
```
With this code, you really have no idea whether a matrix or a list will be returned. And if it's a matrix, you don't know over which base ring.

Travis, what do you think?



---

archive/issue_comments_380963.json:
```json
{
    "body": "<a id='comment:9'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227\">6ae84f1</a></td><td><code>Improve treatment of matrix output in sage.tensor.modules.comp.Components._get_list.</code></td></tr></table>\n",
    "created_at": "2018-03-03T14:12:51Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380963",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:9'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227">6ae84f1</a></td><td><code>Improve treatment of matrix output in sage.tensor.modules.comp.Components._get_list.</code></td></tr></table>




---

archive/issue_comments_380964.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/matrix_related_fixes_in_differential_geometry)\" to \"[public/manifolds/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/matrix_related_fixes_in_differential_geometry)\".",
    "created_at": "2018-03-03T14:12:51Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380964",
    "user": "https://github.com/egourgoulhon"
}
```

**Changing branch** from "[u/jdemeyer/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/matrix_related_fixes_in_differential_geometry)" to "[public/manifolds/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/matrix_related_fixes_in_differential_geometry)".



---

archive/issue_comments_380965.json:
```json
{
    "body": "**Changing commit** from \"[bd532ab6734f5a87df0c237f75105c92c1158c3d](https://github.com/sagemath/sagetrac-mirror/commit/bd532ab6734f5a87df0c237f75105c92c1158c3d)\" to \"[6ae84f147a2209e0396d508c77b4c86e706f3227](https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227)\".",
    "created_at": "2018-03-03T14:12:51Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380965",
    "user": "https://github.com/egourgoulhon"
}
```

**Changing commit** from "[bd532ab6734f5a87df0c237f75105c92c1158c3d](https://github.com/sagemath/sagetrac-mirror/commit/bd532ab6734f5a87df0c237f75105c92c1158c3d)" to "[6ae84f147a2209e0396d508c77b4c86e706f3227](https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227)".



---

archive/issue_events_220486.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2018-03-03T14:12:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220486"
}
```



---

archive/issue_events_220487.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2018-03-03T14:12:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220487"
}
```



---

archive/issue_comments_380966.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [@jdemeyer](#comment%3A8):\n> I just did that to be consistent with the documentation. The documentation never said \"return a matrix, except when using the SymPy backend\". I did make an exception for the `str` formatter, because that was documented (not in this method but elsewhere).\n\nI agree the documentation of the method `_get_list` is pretty poor (but this is a \"private\" (underscored) method). Sorry about this. Note that the class `Components` to which it belongs does not know anything about SR or SymPy: it manipulates only elements of a ring. The SymPy or `str` objects appear only through the output formatter. \n\n> \n> > Do we have now to explicitly specify the ring as the first argument of `matrix`?\n\n> \n> No, that won't be required. But again, it's good for consistency that you always get the same kind of object back (a symbolic matrix).\n\nOK, thanks.\n\n> \n> That is fine for me, but then SymPy elements should *always* return a list. The main thing that I do not like about the current code is this `try`/`except` block:\n> With this code, you really have no idea whether a matrix or a list will be returned. And if it's a matrix, you don't know over which base ring.\n\nI agree, this piece of code was not very good. Actually it pertains to the early time of the SageManifolds project, where the elements stored in `Components` where not guaranteed to belong to any ring. This is no longer the case for the `Components` used in tensor calculus: they all belong to the algebra of scalar fields and, after being processed by `self._output_formatter`, they belong to the ring of chart functions, `sage.manifolds.chart_func.ChartFunctionRing` whatever their internal representation (`SR` or Sympy). I've therefore modified the code of `Components._get_list` to\n\n```\n        if self._nid == 2:\n            # 2-dim case: convert to matrix for a nicer output\n            from sage.matrix.constructor import matrix\n            from sage.structure.element import parent\n            from sage.categories.rings import Rings\n            if parent(resu[0][0]) in Rings():\n                return matrix(resu)\n        return resu\n```\nIn this way, there is no special treatment for strings or whatever else that is not a ring, since the test `if parent(resu[0][0]) in Rings()` will return false in this case. For tensor field components, the treatment is now at the level of `ChartFunctionRing` (there is no longer any reference to the internal representation via `_express` and `expr()`), so it works for both `SR` and SymPy. In particular the doctest in `src/sage/manifolds/differentiable/metric.py` now displays a matrix of SymPy objects, and no longer a list, which is an improvement! Thanks for having triggered it!\n\nI've pushed these changes in the new branch `public/manifolds/matrix_related_fixes_in_differential_geometry`, which is based on your branch (simply one commit ahead). I am attaching it to the ticket.",
    "created_at": "2018-03-03T14:39:24Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380966",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>
Replying to [@jdemeyer](#comment%3A8):
> I just did that to be consistent with the documentation. The documentation never said "return a matrix, except when using the SymPy backend". I did make an exception for the `str` formatter, because that was documented (not in this method but elsewhere).

I agree the documentation of the method `_get_list` is pretty poor (but this is a "private" (underscored) method). Sorry about this. Note that the class `Components` to which it belongs does not know anything about SR or SymPy: it manipulates only elements of a ring. The SymPy or `str` objects appear only through the output formatter. 

> 
> > Do we have now to explicitly specify the ring as the first argument of `matrix`?

> 
> No, that won't be required. But again, it's good for consistency that you always get the same kind of object back (a symbolic matrix).

OK, thanks.

> 
> That is fine for me, but then SymPy elements should *always* return a list. The main thing that I do not like about the current code is this `try`/`except` block:
> With this code, you really have no idea whether a matrix or a list will be returned. And if it's a matrix, you don't know over which base ring.

I agree, this piece of code was not very good. Actually it pertains to the early time of the SageManifolds project, where the elements stored in `Components` where not guaranteed to belong to any ring. This is no longer the case for the `Components` used in tensor calculus: they all belong to the algebra of scalar fields and, after being processed by `self._output_formatter`, they belong to the ring of chart functions, `sage.manifolds.chart_func.ChartFunctionRing` whatever their internal representation (`SR` or Sympy). I've therefore modified the code of `Components._get_list` to

```
        if self._nid == 2:
            # 2-dim case: convert to matrix for a nicer output
            from sage.matrix.constructor import matrix
            from sage.structure.element import parent
            from sage.categories.rings import Rings
            if parent(resu[0][0]) in Rings():
                return matrix(resu)
        return resu
```
In this way, there is no special treatment for strings or whatever else that is not a ring, since the test `if parent(resu[0][0]) in Rings()` will return false in this case. For tensor field components, the treatment is now at the level of `ChartFunctionRing` (there is no longer any reference to the internal representation via `_express` and `expr()`), so it works for both `SR` and SymPy. In particular the doctest in `src/sage/manifolds/differentiable/metric.py` now displays a matrix of SymPy objects, and no longer a list, which is an improvement! Thanks for having triggered it!

I've pushed these changes in the new branch `public/manifolds/matrix_related_fixes_in_differential_geometry`, which is based on your branch (simply one commit ahead). I am attaching it to the ticket.



---

archive/issue_comments_380967.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [@egourgoulhon](#comment%3A10):\n\nAn alternative to\n> \n> ```\n>             if parent(resu[0][0]) in Rings():\n>                 return matrix(resu)\n> ```\n\nis\n\n```\n            R = parent(resu[0][0])\n            if R in Rings():\n                return matrix(R, resu)\n```\nI don't know which form is preferable. Note that in the latter, the ring is passed as the first argument to `matrix`.",
    "created_at": "2018-03-03T16:07:47Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380967",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:11'></a>
Replying to [@egourgoulhon](#comment%3A10):

An alternative to
> 
> ```
>             if parent(resu[0][0]) in Rings():
>                 return matrix(resu)
> ```

is

```
            R = parent(resu[0][0])
            if R in Rings():
                return matrix(R, resu)
```
I don't know which form is preferable. Note that in the latter, the ring is passed as the first argument to `matrix`.



---

archive/issue_comments_380968.json:
```json
{
    "body": "<a id='comment:12'></a>\nIMO, a more ideal form is\n\n```python\n            R = parent(resu[0][0])\n            if R in Rings():\n                return MatrixSpace(R,2)(resu)\n```\nGiven [comment:7](#comment%3A7)\n\n> I plan to improve this in the short future, by implementing a ring of SymPy coordinate functions\n\nI would also add a comment to the code saying to remove the `Rings` check once SymPy coordinate functions are a ring.\n\nI think this also addresses Jeroen's comment about code flow clarity and the code LBTM (B for better). Any other comments Jeroen?",
    "created_at": "2018-03-03T22:05:15Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380968",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
IMO, a more ideal form is

```python
            R = parent(resu[0][0])
            if R in Rings():
                return MatrixSpace(R,2)(resu)
```
Given [comment:7](#comment%3A7)

> I plan to improve this in the short future, by implementing a ring of SymPy coordinate functions

I would also add a comment to the code saying to remove the `Rings` check once SymPy coordinate functions are a ring.

I think this also addresses Jeroen's comment about code flow clarity and the code LBTM (B for better). Any other comments Jeroen?



---

archive/issue_comments_380969.json:
```json
{
    "body": "<a id='comment:13'></a>\nInstead of asking whether the parent is a ring, it seems more sensible to check for a Sage `Element`. i.e. I would suggest to replace\n\n```\nparent(x) in Rings()\n```\nby\n\n```\nisinstance(x, Element)\n```",
    "created_at": "2018-03-04T08:34:01Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380969",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Instead of asking whether the parent is a ring, it seems more sensible to check for a Sage `Element`. i.e. I would suggest to replace

```
parent(x) in Rings()
```
by

```
isinstance(x, Element)
```



---

archive/issue_comments_380970.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [@tscrim](#comment%3A12):\n> IMO, a more ideal form is\n> \n> ```python\n>             R = parent(resu[0][0])\n>             if R in Rings():\n>                 return MatrixSpace(R,2)(resu)\n> ```\n\nWhat if the different elements have different parents? Is there a guarantee that the parent of `resu[0][0]` is the same as the parent of `resu[0][1]`? So `matrix(resu)` will auto-detect the correct parent (using the coercion model) and that looks better.\n\nOf course the same argument could be made for the `isinstance(resu[0][0], Element)` check. But it seems less likely to mix Elements and non-Elements than to mix different parents.",
    "created_at": "2018-03-04T08:45:09Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380970",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [@tscrim](#comment%3A12):
> IMO, a more ideal form is
> 
> ```python
>             R = parent(resu[0][0])
>             if R in Rings():
>                 return MatrixSpace(R,2)(resu)
> ```

What if the different elements have different parents? Is there a guarantee that the parent of `resu[0][0]` is the same as the parent of `resu[0][1]`? So `matrix(resu)` will auto-detect the correct parent (using the coercion model) and that looks better.

Of course the same argument could be made for the `isinstance(resu[0][0], Element)` check. But it seems less likely to mix Elements and non-Elements than to mix different parents.



---

archive/issue_events_220488.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-04T09:17:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220488"
}
```



---

archive/issue_events_220489.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-04T09:17:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220489"
}
```



---

archive/issue_comments_380971.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@tscrim](#comment%3A12):\n> \n> I would also add a comment to the code saying to remove the `Rings` check once SymPy coordinate functions are a ring.\n> \n\nActually, with the latest version, it works with SymPy, i.e. it does generate a matrix, the elements of which are chart functions, which are displayed as SymPy objects when SymPy is used as the symbolic engine (see the matrix containing `x**2` and `y**2` instead of `x^2` and `y^2` in the doctest in `metric.py`).\nThe `Rings` check is then for other possible cases, not involving chart functions (I don't have any precise use case at the moment, except for the `str` output formatter used as illustration in the doctests). SymPy was a problem in the previous version of the code, where the matrix construction was attempted directly at the level of symbolic representations, either `SR` or SymPy. Now the matrix construction is at the (higher) level of chart functions, and, thanks to you IIRC ;-), chart functions now forms a ring, so that the matrix construction always succeeds.",
    "created_at": "2018-03-04T14:35:02Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380971",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'></a>
Replying to [@tscrim](#comment%3A12):
> 
> I would also add a comment to the code saying to remove the `Rings` check once SymPy coordinate functions are a ring.
> 

Actually, with the latest version, it works with SymPy, i.e. it does generate a matrix, the elements of which are chart functions, which are displayed as SymPy objects when SymPy is used as the symbolic engine (see the matrix containing `x**2` and `y**2` instead of `x^2` and `y^2` in the doctest in `metric.py`).
The `Rings` check is then for other possible cases, not involving chart functions (I don't have any precise use case at the moment, except for the `str` output formatter used as illustration in the doctests). SymPy was a problem in the previous version of the code, where the matrix construction was attempted directly at the level of symbolic representations, either `SR` or SymPy. Now the matrix construction is at the (higher) level of chart functions, and, thanks to you IIRC ;-), chart functions now forms a ring, so that the matrix construction always succeeds.



---

archive/issue_comments_380972.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [@jdemeyer](#comment%3A14):\n> \n> What if the different elements have different parents? Is there a guarantee that the parent of `resu[0][0]` is the same as the parent of `resu[0][1]`? So `matrix(resu)` will auto-detect the correct parent (using the coercion model) and that looks better.\n\nOK.\n> \n> Of course the same argument could be made for the `isinstance(resu[0][0], Element)` check. But it seems less likely to mix Elements and non-Elements than to mix different parents.\n\nA priori, all elements of `resu` should have the same parent: this is guaranted if no  output formatter is used: the parent is nothing but the ring on which the `Components` object is constructed. If some output formatter is used, it is likely that its output is of a fixed type, hence giving rise to the same parent (in the extended sense, i.e. the parent default to the Python type if the object has no Sage Parent), like for instance the `str` output formatter. My concern with the `Element` check is that it does not guarantee that the parent is a ring. If it is not, then the matrix construction will fail.",
    "created_at": "2018-03-04T14:47:16Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380972",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>
Replying to [@jdemeyer](#comment%3A14):
> 
> What if the different elements have different parents? Is there a guarantee that the parent of `resu[0][0]` is the same as the parent of `resu[0][1]`? So `matrix(resu)` will auto-detect the correct parent (using the coercion model) and that looks better.

OK.
> 
> Of course the same argument could be made for the `isinstance(resu[0][0], Element)` check. But it seems less likely to mix Elements and non-Elements than to mix different parents.

A priori, all elements of `resu` should have the same parent: this is guaranted if no  output formatter is used: the parent is nothing but the ring on which the `Components` object is constructed. If some output formatter is used, it is likely that its output is of a fixed type, hence giving rise to the same parent (in the extended sense, i.e. the parent default to the Python type if the object has no Sage Parent), like for instance the `str` output formatter. My concern with the `Element` check is that it does not guarantee that the parent is a ring. If it is not, then the matrix construction will fail.



---

archive/issue_events_220490.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-05T11:46:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220490"
}
```



---

archive/issue_events_220491.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-05T11:46:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220491"
}
```



---

archive/issue_comments_380973.json:
```json
{
    "body": "**Changing author** from \"Jeroen Demeyer\" to \"Jeroen Demeyer, Eric Gourgoulhon\".",
    "created_at": "2018-03-05T11:46:06Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380973",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Jeroen Demeyer" to "Jeroen Demeyer, Eric Gourgoulhon".



---

archive/issue_comments_380974.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [@egourgoulhon](#comment%3A17):\n> If it is not, then the matrix construction will fail. \n\nI didn't know that, but you are right. If you ask me, that's a silly artificial restriction.\n\nIn that case, maybe Eric's code is fine. Travis, what do you think?",
    "created_at": "2018-03-05T11:46:06Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380974",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Replying to [@egourgoulhon](#comment%3A17):
> If it is not, then the matrix construction will fail. 

I didn't know that, but you are right. If you ask me, that's a silly artificial restriction.

In that case, maybe Eric's code is fine. Travis, what do you think?



---

archive/issue_comments_380975.json:
```json
{
    "body": "<a id='comment:19'></a>\nMy understanding is that they should all be of the same parent. Yet, I don't hold a stake in this code, so I don't really care either way. I doubt this will ever make a difference in the wild (barring very esoteric uses).",
    "created_at": "2018-03-05T12:04:22Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380975",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>
My understanding is that they should all be of the same parent. Yet, I don't hold a stake in this code, so I don't really care either way. I doubt this will ever make a difference in the wild (barring very esoteric uses).



---

archive/issue_comments_380976.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@tscrim](#comment%3A19):\n> My understanding is that they should all be of the same parent. Yet, I don't hold a stake in this code, so I don't really care either way. I doubt this will ever make a difference in the wild (barring very esoteric uses).\n\nYes, I think it's pretty safe to leave the code in the current state.",
    "created_at": "2018-03-05T16:15:10Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380976",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:20'></a>
Replying to [@tscrim](#comment%3A19):
> My understanding is that they should all be of the same parent. Yet, I don't hold a stake in this code, so I don't really care either way. I doubt this will ever make a difference in the wild (barring very esoteric uses).

Yes, I think it's pretty safe to leave the code in the current state.



---

archive/issue_events_220492.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-06T11:17:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220492"
}
```



---

archive/issue_events_220493.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-06T11:17:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220493"
}
```



---

archive/issue_comments_380977.json:
```json
{
    "body": "<a id='comment:21'></a>\nI'm taking that as positive review :-)",
    "created_at": "2018-03-06T11:17:31Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380977",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
I'm taking that as positive review :-)



---

archive/issue_comments_380978.json:
```json
{
    "body": "**Changing branch** from \"[public/manifolds/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/matrix_related_fixes_in_differential_geometry)\" to \"[6ae84f147a2209e0396d508c77b4c86e706f3227](https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227)\".",
    "created_at": "2018-03-08T00:02:39Z",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24884#issuecomment-380978",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/manifolds/matrix_related_fixes_in_differential_geometry](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/matrix_related_fixes_in_differential_geometry)" to "[6ae84f147a2209e0396d508c77b4c86e706f3227](https://github.com/sagemath/sagetrac-mirror/commit/6ae84f147a2209e0396d508c77b4c86e706f3227)".



---

archive/issue_events_220494.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-08T00:02:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220494"
}
```



---

archive/issue_events_220495.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2b6ad723cb2c531dd6b13346a002e7446e659d9c",
    "created_at": "2018-03-08T00:02:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24884",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24884#event-220495"
}
```
