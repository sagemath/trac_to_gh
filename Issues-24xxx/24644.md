# Issue 24644: Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL

archive/issues_024407.json:
```json
{
    "body": "Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.\n\n**Branch/Commit:** [5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)\n\n**Reviewer:** Julian R\u00fcth\n\n**Author:** Erik Bray\n\nIssue created by migration from https://trac.sagemath.org/ticket/24644\n\n",
    "closed_at": "2018-05-08T17:26:27Z",
    "created_at": "2018-02-02T12:02:13Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "title": "Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/24644",
    "user": "https://github.com/embray"
}
```
Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.

**Branch/Commit:** [5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)

**Reviewer:** Julian Rüth

**Author:** Erik Bray

Issue created by migration from https://trac.sagemath.org/ticket/24644





---

archive/issue_events_218429.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218429"
}
```



---

archive/issue_comments_376340.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e\">56b9905</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>\n",
    "created_at": "2018-02-02T12:11:47Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376340",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e">56b9905</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>




---

archive/issue_comments_376341.json:
```json
{
    "body": "**Changing commit** from \"[45127cba14768900e1da138252664ba8cc71024c](https://github.com/sagemath/sagetrac-mirror/commit/45127cba14768900e1da138252664ba8cc71024c)\" to \"[56b9905bc57b4f038653c17e8105a846a75d044e](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)\".",
    "created_at": "2018-02-02T12:11:47Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376341",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[45127cba14768900e1da138252664ba8cc71024c](https://github.com/sagemath/sagetrac-mirror/commit/45127cba14768900e1da138252664ba8cc71024c)" to "[56b9905bc57b4f038653c17e8105a846a75d044e](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)".



---

archive/issue_events_218430.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:20:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218430"
}
```



---

archive/issue_events_218431.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:20:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218431"
}
```



---

archive/issue_comments_376342.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6\">5a23d19</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>\n",
    "created_at": "2018-02-02T12:23:53Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376342",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6">5a23d19</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>




---

archive/issue_comments_376343.json:
```json
{
    "body": "**Changing commit** from \"[56b9905bc57b4f038653c17e8105a846a75d044e](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)\" to \"[5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)\".",
    "created_at": "2018-02-02T12:23:53Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376343",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[56b9905bc57b4f038653c17e8105a846a75d044e](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)" to "[5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)".



---

archive/issue_comments_376344.json:
```json
{
    "body": "<a id='comment:5'></a>\n(I was doing some JavaScript earlier and got some wires crossed)",
    "created_at": "2018-02-02T12:24:15Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376344",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
(I was doing some JavaScript earlier and got some wires crossed)



---

archive/issue_events_218432.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:24:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218432"
}
```



---

archive/issue_events_218433.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:24:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218433"
}
```



---

archive/issue_events_218434.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-03T09:14:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218434"
}
```



---

archive/issue_events_218435.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-03T09:14:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218435"
}
```



---

archive/issue_comments_376345.json:
```json
{
    "body": "<a id='comment:7'></a>\nIf this is really meant for installations as \"root\", then the installation in `DESTDIR` should already be done under the \"sudo\" user. So I think that this patch actually reverses existing correct behaviour.\n\n=> Proposal: close as wontfix.",
    "created_at": "2018-02-03T09:14:36Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376345",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
If this is really meant for installations as "root", then the installation in `DESTDIR` should already be done under the "sudo" user. So I think that this patch actually reverses existing correct behaviour.

=> Proposal: close as wontfix.



---

archive/issue_comments_376346.json:
```json
{
    "body": "<a id='comment:8'></a>\nNo, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.",
    "created_at": "2018-02-03T09:29:11Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376346",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
No, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.



---

archive/issue_comments_376347.json:
```json
{
    "body": "<a id='comment:9'></a>\nI'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a \"build\" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.\n\nOn Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by \"root\" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.\n\nSo only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.",
    "created_at": "2018-02-05T10:33:57Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376347",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a "build" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.

On Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by "root" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.

So only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.



---

archive/issue_comments_376348.json:
```json
{
    "body": "<a id='comment:10'></a>\nWell, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nBut if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.",
    "created_at": "2018-02-05T12:47:31Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376348",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

But if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.



---

archive/issue_comments_376349.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [embray](#comment%3A10):\n> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nThis is addressed by #21532.",
    "created_at": "2018-03-05T23:15:50Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376349",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
Replying to [embray](#comment%3A10):
> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

This is addressed by #21532.



---

archive/issue_events_218436.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-05T10:24:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218436"
}
```



---

archive/issue_events_218437.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-05T10:24:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218437"
}
```



---

archive/issue_comments_376350.json:
```json
{
    "body": "<a id='comment:13'></a>\nLatest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.",
    "created_at": "2018-04-10T16:26:24Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376350",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Latest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.



---

archive/issue_comments_376351.json:
```json
{
    "body": "**Reviewer:** Julian R\u00fcth",
    "created_at": "2018-04-10T22:49:20Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376351",
    "user": "https://github.com/saraedum"
}
```

**Reviewer:** Julian Rüth



---

archive/issue_events_218438.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-10T22:49:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218438"
}
```



---

archive/issue_events_218439.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-10T22:49:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218439"
}
```



---

archive/issue_events_218440.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218440"
}
```



---

archive/issue_events_218441.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218441"
}
```



---

archive/issue_comments_376352.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/build/destdir-sudo](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-sudo)\" to \"[5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)\".",
    "created_at": "2018-05-08T17:26:27Z",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376352",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/embray/build/destdir-sudo](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-sudo)" to "[5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)".



---

archive/issue_events_218442.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-08T17:26:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218442"
}
```



---

archive/issue_events_218443.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "68e8076fccc978767d7f4d60c3df7de78bb46474",
    "created_at": "2018-05-08T17:26:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-218443"
}
```
