# Issue 24644: Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL

archive/issues_024407.json:
```json
{
    "assignees": [],
    "body": "Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.\n\nBranch/Commit: **[5a23d19](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**\n\nReviewer: **Julian R\u00fcth**\n\nAuthor: **Erik Bray**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24644_\n\n",
    "closed_at": "2018-05-08T17:26:27Z",
    "created_at": "2018-02-02T12:02:13Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL",
    "type": "issue",
    "updated_at": "2018-05-08T17:26:27Z",
    "url": "https://github.com/sagemath/sage/issues/24644",
    "user": "https://github.com/embray"
}
```
Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.

Branch/Commit: **[5a23d19](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**

Reviewer: **Julian Rüth**

Author: **Erik Bray**

_Issue created by migration from https://trac.sagemath.org/ticket/24644_





---

archive/issue_events_323165.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323165"
}
```



---

archive/issue_events_323166.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323166"
}
```



---

archive/issue_events_323167.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323167"
}
```



---

archive/issue_events_323168.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323168"
}
```



---

archive/issue_events_323169.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323169"
}
```



---

archive/issue_comments_376479.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e\">56b9905</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>\n",
    "created_at": "2018-02-02T12:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376479",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:2'>Comment 2:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e">56b9905</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>




---

archive/issue_comments_376480.json:
```json
{
    "body": "Changed commit from **[45127cb](https://github.com/sagemath/sagetrac-mirror/commit/45127cba14768900e1da138252664ba8cc71024c)** to **[56b9905](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)**",
    "created_at": "2018-02-02T12:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376480",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[45127cb](https://github.com/sagemath/sagetrac-mirror/commit/45127cba14768900e1da138252664ba8cc71024c)** to **[56b9905](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)**



---

archive/issue_events_323170.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:20:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323170"
}
```



---

archive/issue_events_323171.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:20:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323171"
}
```



---

archive/issue_comments_376481.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6\">5a23d19</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>\n",
    "created_at": "2018-02-02T12:23:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376481",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:4'>Comment 4:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6">5a23d19</a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>




---

archive/issue_comments_376482.json:
```json
{
    "body": "Changed commit from **[56b9905](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)** to **[5a23d19](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**",
    "created_at": "2018-02-02T12:23:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376482",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[56b9905](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)** to **[5a23d19](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**



---

archive/issue_comments_376483.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\n(I was doing some JavaScript earlier and got some wires crossed)",
    "created_at": "2018-02-02T12:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376483",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'>Comment 5:</a>
(I was doing some JavaScript earlier and got some wires crossed)



---

archive/issue_events_323172.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:24:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323172"
}
```



---

archive/issue_events_323173.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:24:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323173"
}
```



---

archive/issue_events_323174.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-03T09:14:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323174"
}
```



---

archive/issue_events_323175.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-03T09:14:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323175"
}
```



---

archive/issue_comments_376484.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nIf this is really meant for installations as \"root\", then the installation in `DESTDIR` should already be done under the \"sudo\" user. So I think that this patch actually reverses existing correct behaviour.\n\n=> Proposal: close as wontfix.",
    "created_at": "2018-02-03T09:14:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376484",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
If this is really meant for installations as "root", then the installation in `DESTDIR` should already be done under the "sudo" user. So I think that this patch actually reverses existing correct behaviour.

=> Proposal: close as wontfix.



---

archive/issue_comments_376485.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nNo, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.",
    "created_at": "2018-02-03T09:29:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376485",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'>Comment 8:</a>
No, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.



---

archive/issue_comments_376486.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nI'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a \"build\" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.\n\nOn Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by \"root\" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.\n\nSo only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.",
    "created_at": "2018-02-05T10:33:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376486",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'>Comment 9:</a>
I'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a "build" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.

On Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by "root" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.

So only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.



---

archive/issue_comments_376487.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nWell, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nBut if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.",
    "created_at": "2018-02-05T12:47:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376487",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'>Comment 10:</a>
Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

But if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.



---

archive/issue_comments_376488.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nReplying to [@embray](#comment%3A10):\n> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nThis is addressed by #21532.",
    "created_at": "2018-03-05T23:15:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376488",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'>Comment 11:</a>
Replying to [@embray](#comment%3A10):
> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

This is addressed by #21532.



---

archive/issue_events_323176.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-05T10:24:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323176"
}
```



---

archive/issue_events_323177.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-05T10:24:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323177"
}
```



---

archive/issue_comments_376489.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nLatest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.",
    "created_at": "2018-04-10T16:26:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376489",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'>Comment 13:</a>
Latest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.



---

archive/issue_comments_376490.json:
```json
{
    "body": "Reviewer: **Julian R\u00fcth**",
    "created_at": "2018-04-10T22:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376490",
    "user": "https://github.com/saraedum"
}
```

Reviewer: **Julian Rüth**



---

archive/issue_events_323178.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-10T22:49:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323178"
}
```



---

archive/issue_events_323179.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-10T22:49:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323179"
}
```



---

archive/issue_events_323180.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323180"
}
```



---

archive/issue_events_323181.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323181"
}
```



---

archive/issue_comments_376491.json:
```json
{
    "body": "Changed branch from **[u/embray/build/destdir-sudo](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-sudo)** to **[5a23d19](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**",
    "created_at": "2018-05-08T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-376491",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/build/destdir-sudo](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-sudo)** to **[5a23d19](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**



---

archive/issue_events_323182.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-08T17:26:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323182"
}
```



---

archive/issue_events_323183.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "68e8076fccc978767d7f4d60c3df7de78bb46474",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-05-08T17:26:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-323183"
}
```
