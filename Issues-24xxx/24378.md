# Issue 24378: complex_root_of uses inexact index

archive/issues_024141.json:
```json
{
    "body": "When numerically evaluating `complex_root_of(a, k)`, the index `k` is passed as floating-point number:\n\n```\nsage: complex_root_of(x^8-1, 7).n(2)\n---------------------------------------------------------------------------\nIndexError                                Traceback (most recent call last)\n<ipython-input-1-4eba84b7c14c> in <module>()\n----> 1 complex_root_of(x**Integer(8)-Integer(1), Integer(7)).n(Integer(2))\n\n/home/patchbot/sage-patchbot/src/sage/structure/element.pyx in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)()\n    863             0.666666666666667\n    864         \"\"\"\n--> 865         return self.numerical_approx(prec, digits, algorithm)\n    866 \n    867     N = deprecated_function_alias(13055, n)\n\n/home/patchbot/sage-patchbot/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36209)()\n   5818         kwds = {'parent': R, 'algorithm': algorithm}\n   5819         try:\n-> 5820             x = x._convert(kwds)\n   5821         except TypeError: # numerical approximation for real number failed\n   5822             pass          # try again with complex\n\n/home/patchbot/sage-patchbot/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)()\n   1257         sig_on()\n   1258         try:\n-> 1259             res = self._gobj.evalf(0, kwds)\n   1260         finally:\n   1261             sig_off()\n\n/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.pyc in _evalf_(self, poly, index, parent, algorithm)\n   2918         except AttributeError:\n   2919             prec = 53\n-> 2920         sobj = CRootOf(Poly(poly._sympy_()), int(index))\n   2921         return sobj.n(ceil(prec*3/10))._sage_()\n   2922 \n\n/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sympy/polys/rootoftools.pyc in __new__(cls, f, x, index, radicals, expand)\n    130         if index < -degree or index >= degree:\n    131             raise IndexError(\"root index out of [%d, %d] range, got %d\" %\n--> 132                              (-degree, degree - 1, index))\n    133         elif index < 0:\n    134             index += degree\n\nIndexError: root index out of [-8, 7] range, got 8\n```\n\nWhen `gmpy2` is installed, the index is even passed as complex number:\n\n```\nsage -t --long src/sage/functions/other.py\n**********************************************************************\nFile \"src/sage/functions/other.py\", line 2862, in sage.functions.other.Function_crootof\nFailed example:\n    c.n()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 517, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 920, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.functions.other.Function_crootof[1]>\", line 1, in <module>\n        c.n()\n      File \"sage/structure/element.pyx\", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)\n        return self.numerical_approx(prec, digits, algorithm)\n      File \"sage/symbolic/expression.pyx\", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)\n        x = x._convert(kwds)\n      File \"sage/symbolic/expression.pyx\", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)\n        res = self._gobj.evalf(0, kwds)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py\", line 2920, in _evalf_\n        sobj = CRootOf(Poly(poly._sympy_()), int(index))\n      File \"sage/rings/complex_number.pyx\", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)\n        raise TypeError(\"can't convert complex to int; use int(abs(z))\")\n    TypeError: can't convert complex to int; use int(abs(z))\n**********************************************************************\nFile \"src/sage/functions/other.py\", line 2864, in sage.functions.other.Function_crootof\nFailed example:\n    c.n(100)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 517, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 920, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.functions.other.Function_crootof[2]>\", line 1, in <module>\n        c.n(Integer(100))\n      File \"sage/structure/element.pyx\", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)\n        return self.numerical_approx(prec, digits, algorithm)\n      File \"sage/symbolic/expression.pyx\", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)\n        x = x._convert(kwds)\n      File \"sage/symbolic/expression.pyx\", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)\n        res = self._gobj.evalf(0, kwds)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py\", line 2920, in _evalf_\n        sobj = CRootOf(Poly(poly._sympy_()), int(index))\n      File \"sage/rings/complex_number.pyx\", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)\n        raise TypeError(\"can't convert complex to int; use int(abs(z))\")\n    TypeError: can't convert complex to int; use int(abs(z))\n**********************************************************************\nFile \"src/sage/functions/other.py\", line 2866, in sage.functions.other.Function_crootof\nFailed example:\n    (c^6 + c + 1).n(100) < 1e-25\nException raised:\n    Traceback (most recent call last):\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 517, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 920, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.functions.other.Function_crootof[3]>\", line 1, in <module>\n        (c**Integer(6) + c + Integer(1)).n(Integer(100)) < RealNumber('1e-25')\n      File \"sage/structure/element.pyx\", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)\n        return self.numerical_approx(prec, digits, algorithm)\n      File \"sage/symbolic/expression.pyx\", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)\n        x = x._convert(kwds)\n      File \"sage/symbolic/expression.pyx\", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)\n        res = self._gobj.evalf(0, kwds)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py\", line 2920, in _evalf_\n        sobj = CRootOf(Poly(poly._sympy_()), int(index))\n      File \"sage/rings/complex_number.pyx\", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)\n        raise TypeError(\"can't convert complex to int; use int(abs(z))\")\n    TypeError: can't convert complex to int; use int(abs(z))\n**********************************************************************\nFile \"src/sage/functions/other.py\", line 2908, in sage.functions.other.Function_crootof._evalf_\nFailed example:\n    complex_root_of(x^2-2, 1).n()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 517, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 920, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.functions.other.Function_crootof._evalf_[0]>\", line 1, in <module>\n        complex_root_of(x**Integer(2)-Integer(2), Integer(1)).n()\n      File \"sage/structure/element.pyx\", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)\n        return self.numerical_approx(prec, digits, algorithm)\n      File \"sage/symbolic/expression.pyx\", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)\n        x = x._convert(kwds)\n      File \"sage/symbolic/expression.pyx\", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)\n        res = self._gobj.evalf(0, kwds)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py\", line 2920, in _evalf_\n        sobj = CRootOf(Poly(poly._sympy_()), int(index))\n      File \"sage/rings/complex_number.pyx\", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)\n        raise TypeError(\"can't convert complex to int; use int(abs(z))\")\n    TypeError: can't convert complex to int; use int(abs(z))\n**********************************************************************\n2 items had failures:\n   3 of   5 in sage.functions.other.Function_crootof\n   1 of   3 in sage.functions.other.Function_crootof._evalf_\n    [622 tests, 4 failures, 17.27 s]  \nsage -t --long src/sage/interfaces/sympy.py\n**********************************************************************\nFile \"src/sage/interfaces/sympy.py\", line 617, in sage.interfaces.sympy._sympysage_crootof\nFailed example:\n    (sols[0]+1)._sage_().n()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 517, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 920, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.sympy._sympysage_crootof[6]>\", line 1, in <module>\n        (sols[Integer(0)]+Integer(1))._sage_().n()\n      File \"sage/structure/element.pyx\", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)\n        return self.numerical_approx(prec, digits, algorithm)\n      File \"sage/symbolic/expression.pyx\", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)\n        x = x._convert(kwds)\n      File \"sage/symbolic/expression.pyx\", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)\n        res = self._gobj.evalf(0, kwds)\n      File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py\", line 2920, in _evalf_\n        sobj = CRootOf(Poly(poly._sympy_()), int(index))\n      File \"sage/rings/complex_number.pyx\", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)\n        raise TypeError(\"can't convert complex to int; use int(abs(z))\")\n    TypeError: can't convert complex to int; use int(abs(z))\n**********************************************************************\n1 item had failures:\n   1 of   8 in sage.interfaces.sympy._sympysage_crootof\n    [218 tests, 1 failure, 3.27 s]\n```\n\nCC:  @rwst @EmmanuelCharpentier\n\nBranch/Commit: 277a403ef00692247f9853d89322f9a464abd471\n\nReviewer: Jeroen Demeyer\n\nAuthor: Ralf Stephan\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24378\n\n",
    "closed_at": "2017-12-26T09:25:47Z",
    "created_at": "2017-12-15T09:38:20Z",
    "labels": [
        "component: symbolics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "complex_root_of uses inexact index",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24378",
    "user": "https://github.com/jdemeyer"
}
```
When numerically evaluating `complex_root_of(a, k)`, the index `k` is passed as floating-point number:

```
sage: complex_root_of(x^8-1, 7).n(2)
---------------------------------------------------------------------------
IndexError                                Traceback (most recent call last)
<ipython-input-1-4eba84b7c14c> in <module>()
----> 1 complex_root_of(x**Integer(8)-Integer(1), Integer(7)).n(Integer(2))

/home/patchbot/sage-patchbot/src/sage/structure/element.pyx in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)()
    863             0.666666666666667
    864         """
--> 865         return self.numerical_approx(prec, digits, algorithm)
    866 
    867     N = deprecated_function_alias(13055, n)

/home/patchbot/sage-patchbot/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36209)()
   5818         kwds = {'parent': R, 'algorithm': algorithm}
   5819         try:
-> 5820             x = x._convert(kwds)
   5821         except TypeError: # numerical approximation for real number failed
   5822             pass          # try again with complex

/home/patchbot/sage-patchbot/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)()
   1257         sig_on()
   1258         try:
-> 1259             res = self._gobj.evalf(0, kwds)
   1260         finally:
   1261             sig_off()

/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.pyc in _evalf_(self, poly, index, parent, algorithm)
   2918         except AttributeError:
   2919             prec = 53
-> 2920         sobj = CRootOf(Poly(poly._sympy_()), int(index))
   2921         return sobj.n(ceil(prec*3/10))._sage_()
   2922 

/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sympy/polys/rootoftools.pyc in __new__(cls, f, x, index, radicals, expand)
    130         if index < -degree or index >= degree:
    131             raise IndexError("root index out of [%d, %d] range, got %d" %
--> 132                              (-degree, degree - 1, index))
    133         elif index < 0:
    134             index += degree

IndexError: root index out of [-8, 7] range, got 8
```

When `gmpy2` is installed, the index is even passed as complex number:

```
sage -t --long src/sage/functions/other.py
**********************************************************************
File "src/sage/functions/other.py", line 2862, in sage.functions.other.Function_crootof
Failed example:
    c.n()
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.functions.other.Function_crootof[1]>", line 1, in <module>
        c.n()
      File "sage/structure/element.pyx", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)
        return self.numerical_approx(prec, digits, algorithm)
      File "sage/symbolic/expression.pyx", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)
        x = x._convert(kwds)
      File "sage/symbolic/expression.pyx", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)
        res = self._gobj.evalf(0, kwds)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py", line 2920, in _evalf_
        sobj = CRootOf(Poly(poly._sympy_()), int(index))
      File "sage/rings/complex_number.pyx", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)
        raise TypeError("can't convert complex to int; use int(abs(z))")
    TypeError: can't convert complex to int; use int(abs(z))
**********************************************************************
File "src/sage/functions/other.py", line 2864, in sage.functions.other.Function_crootof
Failed example:
    c.n(100)
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.functions.other.Function_crootof[2]>", line 1, in <module>
        c.n(Integer(100))
      File "sage/structure/element.pyx", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)
        return self.numerical_approx(prec, digits, algorithm)
      File "sage/symbolic/expression.pyx", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)
        x = x._convert(kwds)
      File "sage/symbolic/expression.pyx", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)
        res = self._gobj.evalf(0, kwds)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py", line 2920, in _evalf_
        sobj = CRootOf(Poly(poly._sympy_()), int(index))
      File "sage/rings/complex_number.pyx", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)
        raise TypeError("can't convert complex to int; use int(abs(z))")
    TypeError: can't convert complex to int; use int(abs(z))
**********************************************************************
File "src/sage/functions/other.py", line 2866, in sage.functions.other.Function_crootof
Failed example:
    (c^6 + c + 1).n(100) < 1e-25
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.functions.other.Function_crootof[3]>", line 1, in <module>
        (c**Integer(6) + c + Integer(1)).n(Integer(100)) < RealNumber('1e-25')
      File "sage/structure/element.pyx", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)
        return self.numerical_approx(prec, digits, algorithm)
      File "sage/symbolic/expression.pyx", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)
        x = x._convert(kwds)
      File "sage/symbolic/expression.pyx", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)
        res = self._gobj.evalf(0, kwds)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py", line 2920, in _evalf_
        sobj = CRootOf(Poly(poly._sympy_()), int(index))
      File "sage/rings/complex_number.pyx", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)
        raise TypeError("can't convert complex to int; use int(abs(z))")
    TypeError: can't convert complex to int; use int(abs(z))
**********************************************************************
File "src/sage/functions/other.py", line 2908, in sage.functions.other.Function_crootof._evalf_
Failed example:
    complex_root_of(x^2-2, 1).n()
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.functions.other.Function_crootof._evalf_[0]>", line 1, in <module>
        complex_root_of(x**Integer(2)-Integer(2), Integer(1)).n()
      File "sage/structure/element.pyx", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)
        return self.numerical_approx(prec, digits, algorithm)
      File "sage/symbolic/expression.pyx", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)
        x = x._convert(kwds)
      File "sage/symbolic/expression.pyx", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)
        res = self._gobj.evalf(0, kwds)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py", line 2920, in _evalf_
        sobj = CRootOf(Poly(poly._sympy_()), int(index))
      File "sage/rings/complex_number.pyx", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)
        raise TypeError("can't convert complex to int; use int(abs(z))")
    TypeError: can't convert complex to int; use int(abs(z))
**********************************************************************
2 items had failures:
   3 of   5 in sage.functions.other.Function_crootof
   1 of   3 in sage.functions.other.Function_crootof._evalf_
    [622 tests, 4 failures, 17.27 s]  
sage -t --long src/sage/interfaces/sympy.py
**********************************************************************
File "src/sage/interfaces/sympy.py", line 617, in sage.interfaces.sympy._sympysage_crootof
Failed example:
    (sols[0]+1)._sage_().n()
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.sympy._sympysage_crootof[6]>", line 1, in <module>
        (sols[Integer(0)]+Integer(1))._sage_().n()
      File "sage/structure/element.pyx", line 865, in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8131)
        return self.numerical_approx(prec, digits, algorithm)
      File "sage/symbolic/expression.pyx", line 5824, in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:36286)
        x = x._convert(kwds)
      File "sage/symbolic/expression.pyx", line 1259, in sage.symbolic.expression.Expression._convert (build/cythonized/sage/symbolic/expression.cpp:10663)
        res = self._gobj.evalf(0, kwds)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py", line 2920, in _evalf_
        sobj = CRootOf(Poly(poly._sympy_()), int(index))
      File "sage/rings/complex_number.pyx", line 1058, in sage.rings.complex_number.ComplexNumber.__int__ (build/cythonized/sage/rings/complex_number.c:10918)
        raise TypeError("can't convert complex to int; use int(abs(z))")
    TypeError: can't convert complex to int; use int(abs(z))
**********************************************************************
1 item had failures:
   1 of   8 in sage.interfaces.sympy._sympysage_crootof
    [218 tests, 1 failure, 3.27 s]
```

CC:  @rwst @EmmanuelCharpentier

Branch/Commit: 277a403ef00692247f9853d89322f9a464abd471

Reviewer: Jeroen Demeyer

Author: Ralf Stephan

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24378





---

archive/issue_comments_337995.json:
```json
{
    "body": "<a id='comment:4'></a>That exact arguments are made inexact is a bug in itself. But that they are made complex (EDIT: in some machines) is beyond me.\n\n---\nNew commits:",
    "created_at": "2017-12-15T10:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-337995",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>That exact arguments are made inexact is a bug in itself. But that they are made complex (EDIT: in some machines) is beyond me.

---
New commits:



---

archive/issue_comments_337996.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-15T10:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-337996",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337997.json:
```json
{
    "body": "<a id='comment:5'></a>Do you have an idea why this depends on the system?",
    "created_at": "2017-12-15T10:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-337997",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Do you have an idea why this depends on the system?



---

archive/issue_comments_337998.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 rws]:\n> That exact arguments are made inexact is a bug in itself. But that they are made complex (EDIT: in some machines) is beyond me.\n\n\nDo you know where this happens? It seems to me that it is Pynac doing this.",
    "created_at": "2017-12-15T10:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-337998",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Replying to [comment:4 rws]:
> That exact arguments are made inexact is a bug in itself. But that they are made complex (EDIT: in some machines) is beyond me.


Do you know where this happens? It seems to me that it is Pynac doing this.



---

archive/issue_comments_337999.json:
```json
{
    "body": "<a id='comment:8'></a>Some sympy behavior depends on the presence/absence of gmpy2. We had this trouble before the upgrade.",
    "created_at": "2017-12-15T11:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-337999",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Some sympy behavior depends on the presence/absence of gmpy2. We had this trouble before the upgrade.



---

archive/issue_comments_338000.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:4 rws]:\n> That exact arguments are made inexact is a bug in itself.\n\n\nRight, this ticket should just fix that.",
    "created_at": "2017-12-15T11:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338000",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [comment:4 rws]:
> That exact arguments are made inexact is a bug in itself.


Right, this ticket should just fix that.



---

archive/issue_comments_338001.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-15T11:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338001",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_338002.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:10 jdemeyer]:\n> Replying to [comment:4 rws]:\n> > That exact arguments are made inexact is a bug in itself.\n\n> \n> Right, this ticket should just fix that.\n\n\nIndeed `numerical_approximation` of symbolic expression is lazily converting all arguments to the same parent. Which is very wrong when a function is defined on `R x N`.\n\nPerhaps it would be good to add in `_evalf_` the check\n\n```\nif not isinstance(index, numbers.Integral):\n    raise ValueError\n```\n\nThough I am curious about this sympy misbehavior.",
    "created_at": "2017-12-15T11:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338002",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:10 jdemeyer]:
> Replying to [comment:4 rws]:
> > That exact arguments are made inexact is a bug in itself.

> 
> Right, this ticket should just fix that.


Indeed `numerical_approximation` of symbolic expression is lazily converting all arguments to the same parent. Which is very wrong when a function is defined on `R x N`.

Perhaps it would be good to add in `_evalf_` the check

```
if not isinstance(index, numbers.Integral):
    raise ValueError
```

Though I am curious about this sympy misbehavior.



---

archive/issue_comments_338003.json:
```json
{
    "body": "<a id='comment:16'></a>Indeed there is a sympy bug that is now tracked at #24380.",
    "created_at": "2017-12-15T11:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338003",
    "user": "https://github.com/videlec"
}
```

<a id='comment:16'></a>Indeed there is a sympy bug that is now tracked at #24380.



---

archive/issue_comments_338004.json:
```json
{
    "body": "<a id='comment:17'></a>`numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.",
    "created_at": "2017-12-15T11:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338004",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>`numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.



---

archive/issue_comments_338005.json:
```json
{
    "body": "<a id='comment:18'></a>There was indeed a bug in sympy: #24380 needs review!",
    "created_at": "2017-12-15T14:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338005",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>There was indeed a bug in sympy: #24380 needs review!



---

archive/issue_comments_338006.json:
```json
{
    "body": "<a id='comment:19'></a>I suggest accepting my quick fix to resolve the blocker. Meanwhile I'm looking into Pynac.",
    "created_at": "2017-12-16T08:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338006",
    "user": "https://github.com/rwst"
}
```

<a id='comment:19'></a>I suggest accepting my quick fix to resolve the blocker. Meanwhile I'm looking into Pynac.



---

archive/issue_comments_338007.json:
```json
{
    "body": "<a id='comment:20'></a>If your only goal is to resolve the blocker doctest failures, then I think it is better to use `# known bug`. The fact that the index is made floating-point is the real bug, whether it is real or complex is just a small variation.",
    "created_at": "2017-12-16T08:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338007",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>If your only goal is to resolve the blocker doctest failures, then I think it is better to use `# known bug`. The fact that the index is made floating-point is the real bug, whether it is real or complex is just a small variation.



---

archive/issue_comments_338008.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:17 vdelecroix]:\n> `numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.\n\n\nI disagree in this case. The result is exactly what was asked for.",
    "created_at": "2017-12-16T09:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338008",
    "user": "https://github.com/rwst"
}
```

<a id='comment:21'></a>Replying to [comment:17 vdelecroix]:
> `numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.


I disagree in this case. The result is exactly what was asked for.



---

archive/issue_comments_338009.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 rws]:\n> Replying to [comment:17 vdelecroix]:\n> > `numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.\n\n> \n> I disagree in this case. The result is exactly what was asked for.\n\n\nThe problem under discussion is that you have a number specified by an equation like `x^2 - 2 = 0`. Now, you want an numerical approximation of it. I claim that there is not much reason to transform the equation into `1.0 * x^2 - 2.0` for doing that. In particular, this is **not** what the user wants. This kind of conversion is a can of worms. If you want 100 bits of your number, and start by converting the coefficients to floating points with 100 bits of precision you might loose your roots.\n\nNote that in sympy they solve the original equation with appropriate root finding algorithms on rational numbers.",
    "created_at": "2017-12-16T09:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338009",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>Replying to [comment:21 rws]:
> Replying to [comment:17 vdelecroix]:
> > `numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.

> 
> I disagree in this case. The result is exactly what was asked for.


The problem under discussion is that you have a number specified by an equation like `x^2 - 2 = 0`. Now, you want an numerical approximation of it. I claim that there is not much reason to transform the equation into `1.0 * x^2 - 2.0` for doing that. In particular, this is **not** what the user wants. This kind of conversion is a can of worms. If you want 100 bits of your number, and start by converting the coefficients to floating points with 100 bits of precision you might loose your roots.

Note that in sympy they solve the original equation with appropriate root finding algorithms on rational numbers.



---

archive/issue_comments_338010.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 vdelecroix]:\n> Replying to [comment:21 rws]:\n> > Replying to [comment:17 vdelecroix]:\n> > > `numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.\n\n> > \n> > I disagree in this case. The result is exactly what was asked for.\n\n> \n> The problem under discussion is that you have a number specified by an equation like `x^2 - 2 = 0`. Now, you want an numerical approximation of it.\n\n\nNo, that is solving. `N()` just converts symbolic expressions---if they happen to contain symbols you won't get a number, you get an error. `_convert()` helps with that.\n\n> Note that in sympy they solve the original equation with appropriate root finding algorithms on rational numbers.\n\n\nThis has nothing to do with this ticket. This ticket is about losing precision in expressions that can be FP evaluated because they contain no symbols but may contain functions. While the result precision from the function at hand `complex_root_of` is in principle not affected by the exactness of the index there may be existing/future functions where it is. This can be fixed by not FP converting exact function arguments and letting the function itself (i.e. its `evalf` member) decide what to do with exact arguments. I may well be wrong, and the best solution instead is a type database for function arguments...",
    "created_at": "2017-12-16T09:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338010",
    "user": "https://github.com/rwst"
}
```

<a id='comment:23'></a>Replying to [comment:22 vdelecroix]:
> Replying to [comment:21 rws]:
> > Replying to [comment:17 vdelecroix]:
> > > `numerical_approx` is very wrong when evaluating. It converts `x^2 - 2` to `x^2 - 2.0` and hence loosing precision for no good reason.

> > 
> > I disagree in this case. The result is exactly what was asked for.

> 
> The problem under discussion is that you have a number specified by an equation like `x^2 - 2 = 0`. Now, you want an numerical approximation of it.


No, that is solving. `N()` just converts symbolic expressions---if they happen to contain symbols you won't get a number, you get an error. `_convert()` helps with that.

> Note that in sympy they solve the original equation with appropriate root finding algorithms on rational numbers.


This has nothing to do with this ticket. This ticket is about losing precision in expressions that can be FP evaluated because they contain no symbols but may contain functions. While the result precision from the function at hand `complex_root_of` is in principle not affected by the exactness of the index there may be existing/future functions where it is. This can be fixed by not FP converting exact function arguments and letting the function itself (i.e. its `evalf` member) decide what to do with exact arguments. I may well be wrong, and the best solution instead is a type database for function arguments...



---

archive/issue_comments_338011.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 vdelecroix]:\n> Note that in sympy they solve the original equation with appropriate root finding algorithms on rational numbers.\n\n\nYes but we don't do the solving. We let SymPy do it.",
    "created_at": "2017-12-16T09:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338011",
    "user": "https://github.com/rwst"
}
```

<a id='comment:24'></a>Replying to [comment:22 vdelecroix]:
> Note that in sympy they solve the original equation with appropriate root finding algorithms on rational numbers.


Yes but we don't do the solving. We let SymPy do it.



---

archive/issue_comments_338012.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-17T06:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338012",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_338013.json:
```json
{
    "body": "<a id='comment:27'></a>New commits:",
    "created_at": "2017-12-17T06:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338013",
    "user": "https://github.com/rwst"
}
```

<a id='comment:27'></a>New commits:



---

archive/issue_comments_338014.json:
```json
{
    "body": "<a id='comment:28'></a>See #24397 for the fix.",
    "created_at": "2017-12-17T07:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338014",
    "user": "https://github.com/rwst"
}
```

<a id='comment:28'></a>See #24397 for the fix.



---

archive/issue_comments_338015.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-17T08:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338015",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_338016.json:
```json
{
    "body": "<a id='comment:29'></a>You should add the ticket number: `# known bug (Trac #24397)`.",
    "created_at": "2017-12-17T08:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338016",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>You should add the ticket number: `# known bug (Trac #24397)`.



---

archive/issue_comments_338017.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-17T14:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_338018.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-17T14:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338018",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_338019.json:
```json
{
    "body": "<a id='comment:33'></a>Fortunately this can be resolved easily.\n\n---\nNew commits:",
    "created_at": "2017-12-17T15:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338019",
    "user": "https://github.com/rwst"
}
```

<a id='comment:33'></a>Fortunately this can be resolved easily.

---
New commits:



---

archive/issue_comments_338020.json:
```json
{
    "body": "<a id='comment:34'></a>I have added the information to https://github.com/pynac/pynac/wiki/%7C-floating-point-evaluation, but Sage `Function` initialization options need better docs too.",
    "created_at": "2017-12-17T15:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338020",
    "user": "https://github.com/rwst"
}
```

<a id='comment:34'></a>I have added the information to https://github.com/pynac/pynac/wiki/%7C-floating-point-evaluation, but Sage `Function` initialization options need better docs too.



---

archive/issue_comments_338021.json:
```json
{
    "body": "<a id='comment:35'></a>If this fixes the actual underlying issue, could you add\n\n```\nsage: complex_root_of(x^8-1, 7).n(2)\n```\nas a doctest?",
    "created_at": "2017-12-17T20:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338021",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>If this fixes the actual underlying issue, could you add

```
sage: complex_root_of(x^8-1, 7).n(2)
```
as a doctest?



---

archive/issue_comments_338022.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-17T20:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338022",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_338023.json:
```json
{
    "body": "<a id='comment:36'></a>It fixes the issue but there are other problems at super-low precision.",
    "created_at": "2017-12-18T07:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338023",
    "user": "https://github.com/rwst"
}
```

<a id='comment:36'></a>It fixes the issue but there are other problems at super-low precision.



---

archive/issue_comments_338024.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-18T07:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_338025.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-18T07:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338025",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_338026.json:
```json
{
    "body": "<a id='comment:39'></a>The expression `prec*3/10` will behave differently on Python 2 and Python 3. You should either use `//` or `from __future__ import division` such that it works the same on Python 2 and Python 3.",
    "created_at": "2017-12-18T08:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338026",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>The expression `prec*3/10` will behave differently on Python 2 and Python 3. You should either use `//` or `from __future__ import division` such that it works the same on Python 2 and Python 3.



---

archive/issue_comments_338027.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-18T08:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338027",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_338028.json:
```json
{
    "body": "<a id='comment:40'></a>What is the meaning of the factor `3/10` anyway?",
    "created_at": "2017-12-18T08:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338028",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>What is the meaning of the factor `3/10` anyway?



---

archive/issue_comments_338029.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:40 jdemeyer]:\n> What is the meaning of the factor `3/10` anyway?\n\n\nAn approximation to `log(2,10)` (EDITED) which is good enough until about 1000 bits precision.",
    "created_at": "2017-12-18T08:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338029",
    "user": "https://github.com/rwst"
}
```

<a id='comment:41'></a>Replying to [comment:40 jdemeyer]:
> What is the meaning of the factor `3/10` anyway?


An approximation to `log(2,10)` (EDITED) which is good enough until about 1000 bits precision.



---

archive/issue_comments_338030.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 rws]:\n> Replying to [comment:40 jdemeyer]:\n> > What is the meaning of the factor `3/10` anyway?\n\n> \n> An approximation to `log(2,10)` (EDITED) which is good enough until about 1000 bits precision.\n\n\nThen why don't use the actual value `0.3010299956639812`? That avoids the problem with division also.",
    "created_at": "2017-12-18T08:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338030",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>Replying to [comment:41 rws]:
> Replying to [comment:40 jdemeyer]:
> > What is the meaning of the factor `3/10` anyway?

> 
> An approximation to `log(2,10)` (EDITED) which is good enough until about 1000 bits precision.


Then why don't use the actual value `0.3010299956639812`? That avoids the problem with division also.



---

archive/issue_comments_338031.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-18T09:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_338032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-18T09:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338032",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_338033.json:
```json
{
    "body": "<a id='comment:45'></a>Ping?",
    "created_at": "2017-12-20T14:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338033",
    "user": "https://github.com/rwst"
}
```

<a id='comment:45'></a>Ping?



---

archive/issue_comments_338034.json:
```json
{
    "body": "<a id='comment:46'></a>`ceil(prec*log(2,10)))` is terrible. Why not using `0.3010299956639812` as suggested in [This is the Trac macro *comment:42* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:42-macro)? A possible alternative would be\n\n```\nfrom math import log10\nint(prec * log10(2))\n```\nYou definitely do not want to use two symbolic functions here.",
    "created_at": "2017-12-21T16:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338034",
    "user": "https://github.com/videlec"
}
```

<a id='comment:46'></a>`ceil(prec*log(2,10)))` is terrible. Why not using `0.3010299956639812` as suggested in [This is the Trac macro *comment:42* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:42-macro)? A possible alternative would be

```
from math import log10
int(prec * log10(2))
```
You definitely do not want to use two symbolic functions here.



---

archive/issue_comments_338035.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-22T06:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338035",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_338036.json:
```json
{
    "body": "<a id='comment:48'></a>Or better yet, use the sympy function `prec_to_dps` which is meant to convert bits to digits:\n\n```\nfrom sympy.core.evalf import prec_to_dps\n```",
    "created_at": "2017-12-22T22:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338036",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>Or better yet, use the sympy function `prec_to_dps` which is meant to convert bits to digits:

```
from sympy.core.evalf import prec_to_dps
```



---

archive/issue_comments_338037.json:
```json
{
    "body": "<a id='comment:49'></a>Thanks both. I'll make a fresh branch.",
    "created_at": "2017-12-23T06:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338037",
    "user": "https://github.com/rwst"
}
```

<a id='comment:49'></a>Thanks both. I'll make a fresh branch.



---

archive/issue_comments_338038.json:
```json
{
    "body": "<a id='comment:51'></a>A minor note is that the results from `prec_dps(n)` are not identical to the previously proposed formulae at small values, even with a suitable shift.\n\n---\nNew commits:",
    "created_at": "2017-12-23T07:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338038",
    "user": "https://github.com/rwst"
}
```

<a id='comment:51'></a>A minor note is that the results from `prec_dps(n)` are not identical to the previously proposed formulae at small values, even with a suitable shift.

---
New commits:



---

archive/issue_comments_338039.json:
```json
{
    "body": "<a id='comment:52'></a>Good for me if this passes patchbot testing.",
    "created_at": "2017-12-23T09:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338039",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>Good for me if this passes patchbot testing.



---

archive/issue_comments_338040.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-24T06:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338040",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061634.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-26T09:25:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24378#event-61634"
}
```



---

archive/issue_comments_338041.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-26T09:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24378#issuecomment-338041",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
