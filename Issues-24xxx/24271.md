# Issue 24271: py3: allow flexibility in exception message formatting in doctests on Python 3

archive/issues_024034.json:
```json
{
    "body": "On Python 2 exception messages are printed, along with the exception class name, like\n\n```\nSignError: cannot multiply infinity by zero\n```\n\nwhereas on Python 3 they're printed with the exception class's fully qualified name (for non-builtin exceptions):\n\n```\nsage.rings.infinity.SignError: cannot multiply infinity by zero\n```\n\nTherefore any doctest that expects a traceback fails, due to this slight formatting difference.  One can go through all such tests and insert ellipses.  But it's simpler if we just normalize for this trivial formatting difference, similarly to #24258.\n\nAdditionally, there were a few common exceptions (particularly `IOError` which [as of Python 3.3](https://docs.python.org/3/library/exceptions.html#OSError) are just aliases for `OSError`, so we handle that case as well.\n\nIn this case the fixup isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.\n\nThis made a lot of previously \"failing\" tests pass for me.  But it should be made clear that this normalization does not in any way take away from the validity of the tests.\n\nBranch/Commit: 9a659d831cb431c6884d22c715fecc4cda9a6b61\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24271\n\n",
    "closed_at": "2017-12-13T17:38:05Z",
    "created_at": "2017-11-23T09:33:37Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: allow flexibility in exception message formatting in doctests on Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24271",
    "user": "https://github.com/embray"
}
```
On Python 2 exception messages are printed, along with the exception class name, like

```
SignError: cannot multiply infinity by zero
```

whereas on Python 3 they're printed with the exception class's fully qualified name (for non-builtin exceptions):

```
sage.rings.infinity.SignError: cannot multiply infinity by zero
```

Therefore any doctest that expects a traceback fails, due to this slight formatting difference.  One can go through all such tests and insert ellipses.  But it's simpler if we just normalize for this trivial formatting difference, similarly to #24258.

Additionally, there were a few common exceptions (particularly `IOError` which [as of Python 3.3](https://docs.python.org/3/library/exceptions.html#OSError) are just aliases for `OSError`, so we handle that case as well.

In this case the fixup isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.

This made a lot of previously "failing" tests pass for me.  But it should be made clear that this normalization does not in any way take away from the validity of the tests.

Branch/Commit: 9a659d831cb431c6884d22c715fecc4cda9a6b61

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24271





---

archive/issue_comments_358592.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-23T09:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358592",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_358593.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-23T11:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358593",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358594.json:
```json
{
    "body": "<a id='comment:3'></a>see also #16088",
    "created_at": "2017-11-23T13:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358594",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>see also #16088



---

archive/issue_comments_358595.json:
```json
{
    "body": "<a id='comment:4'></a>Interesting--it might also be worth addressing some of those common differences between built-in exception messages.  Are there any other examples besides `ZeroDivision`?",
    "created_at": "2017-11-23T14:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358595",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Interesting--it might also be worth addressing some of those common differences between built-in exception messages.  Are there any other examples besides `ZeroDivision`?



---

archive/issue_comments_358596.json:
```json
{
    "body": "<a id='comment:5'></a>NO idea. I was keeping that for stage C (make the doctests pass) after stage B (make vanilla-sage start with python 3). Stage A (make vanilla-sage build with python 3) is done already. We have some hope to see stage B completed soon, maybe.",
    "created_at": "2017-11-23T15:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358596",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>NO idea. I was keeping that for stage C (make the doctests pass) after stage B (make vanilla-sage start with python 3). Stage A (make vanilla-sage build with python 3) is done already. We have some hope to see stage B completed soon, maybe.



---

archive/issue_comments_358597.json:
```json
{
    "body": "<a id='comment:6'></a>I'm still pretty near to having the doctester 100% working too.  I'm just working out a few more small kinks.",
    "created_at": "2017-11-23T15:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358597",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>I'm still pretty near to having the doctester 100% working too.  I'm just working out a few more small kinks.



---

archive/issue_comments_358598.json:
```json
{
    "body": "<a id='comment:7'></a>1. Why this check?\n\n```\nif exc_info[0].__module__\n```\nAre there any cases where `__module__` would *not* be a `True` value?\n\n2. You really want to use `__qualname__` instead of `__name__` on Python 3, since that is what the `traceback` module uses.\n\nFor reference, this is the relevant code from the `traceback` module:\n\n```\n        stype = self.exc_type.__qualname__\n        smod = self.exc_type.__module__\n        if smod not in (\"__main__\", \"builtins\"):\n            stype = smod + '.' + stype\n```",
    "created_at": "2017-11-24T09:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358598",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>1. Why this check?

```
if exc_info[0].__module__
```
Are there any cases where `__module__` would *not* be a `True` value?

2. You really want to use `__qualname__` instead of `__name__` on Python 3, since that is what the `traceback` module uses.

For reference, this is the relevant code from the `traceback` module:

```
        stype = self.exc_type.__qualname__
        smod = self.exc_type.__module__
        if smod not in ("__main__", "builtins"):
            stype = smod + '.' + stype
```



---

archive/issue_comments_358599.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-24T09:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358599",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_358600.json:
```json
{
    "body": "<a id='comment:8'></a>3. `exc_qualname` is a confusing name. Better use `exc_fullname` or something.",
    "created_at": "2017-11-24T09:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358600",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>3. `exc_qualname` is a confusing name. Better use `exc_fullname` or something.



---

archive/issue_comments_358601.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 jdemeyer]:\n> 1. Why this check?\n> \n> ```\n> if exc_info[0].__module__\n> ```\n> Are there any cases where `__module__` would *not* be a `True` value?\n\n\nWhile I can't name an exact case off the top of my head, I've seen pathological cases (especially in the context of dynamically created classes) where `__module__` can be `None`.  For functions and methods it can definitely be `None`.  Whether or not that's \"valid\" for classes is less clear.  Anyways it's unlikely to occur, but safer to check for anyways.  You're right about `__qualname__`.",
    "created_at": "2017-11-24T11:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358601",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Replying to [comment:7 jdemeyer]:
> 1. Why this check?
> 
> ```
> if exc_info[0].__module__
> ```
> Are there any cases where `__module__` would *not* be a `True` value?


While I can't name an exact case off the top of my head, I've seen pathological cases (especially in the context of dynamically created classes) where `__module__` can be `None`.  For functions and methods it can definitely be `None`.  Whether or not that's "valid" for classes is less clear.  Anyways it's unlikely to occur, but safer to check for anyways.  You're right about `__qualname__`.



---

archive/issue_comments_358602.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-24T11:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358602",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358603.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-24T11:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358603",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358604.json:
```json
{
    "body": "<a id='comment:12'></a>Analogously, why\n\n```\ngetattr(exc_cls, '__qualname__', exc_cls.__name__)\n```\ninstead of\n\n```\nexc_cls.__qualname__\n```\nAre there any cases where `__qualname__` wouldn't exist?\n\nFor both the `__module__` check and `__qualname__` check: the Python standard `traceback` module doesn't do anything fancy here, it just uses the `__qualname__` and `__module__` attributes as-is. If that's good enough for the `traceback` module, it should be good enough for Sage.",
    "created_at": "2017-11-24T11:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358604",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Analogously, why

```
getattr(exc_cls, '__qualname__', exc_cls.__name__)
```
instead of

```
exc_cls.__qualname__
```
Are there any cases where `__qualname__` wouldn't exist?

For both the `__module__` check and `__qualname__` check: the Python standard `traceback` module doesn't do anything fancy here, it just uses the `__qualname__` and `__module__` attributes as-is. If that's good enough for the `traceback` module, it should be good enough for Sage.



---

archive/issue_comments_358605.json:
```json
{
    "body": "<a id='comment:13'></a>That specific code is run on both Python 2 and 3.  There is no `__qualname__` on Python 2.  I guess I could move all the code under a `if not six.PY2` since none of that is currently used on Python 2 anyways (it could be used though if we ever wanted to make the opposite transformation).",
    "created_at": "2017-11-24T12:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358605",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>That specific code is run on both Python 2 and 3.  There is no `__qualname__` on Python 2.  I guess I could move all the code under a `if not six.PY2` since none of that is currently used on Python 2 anyways (it could be used though if we ever wanted to make the opposite transformation).



---

archive/issue_comments_358606.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 embray]:\n> That specific code is run on both Python 2 and 3.\n\n\nRight, I missed that.\n\n> I guess I could move all the code under a `if not six.PY2`\n\n\nThat makes sense.",
    "created_at": "2017-11-24T12:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358606",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:13 embray]:
> That specific code is run on both Python 2 and 3.


Right, I missed that.

> I guess I could move all the code under a `if not six.PY2`


That makes sense.



---

archive/issue_comments_358607.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-27T09:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358607",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358608.json:
```json
{
    "body": "<a id='comment:16'></a>Fixed up a bit more and squashed.",
    "created_at": "2017-11-27T13:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358608",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Fixed up a bit more and squashed.



---

archive/issue_comments_358609.json:
```json
{
    "body": "<a id='comment:17'></a>Actually, I just noticed one other little thing that would be nice to add to this.",
    "created_at": "2017-11-27T13:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358609",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>Actually, I just noticed one other little thing that would be nice to add to this.



---

archive/issue_comments_358610.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-27T13:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358610",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_358611.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-27T13:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358611",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358612.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -12,7 +12,9 @@\n \n Therefore any doctest that expects a traceback fails, due to this slight formatting difference.  One can go through all such tests and insert ellipses.  But it's simpler if we just normalize for this trivial formatting difference, similarly to #24258.\n \n-In this case it isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.\n+Additionally, there were a few common exceptions (particularly `IOError` which [as of Python 3.3](https://docs.python.org/3/library/exceptions.html#OSError) are just aliases for `OSError`, so we handle that case as well.\n+\n+In this case the fixup isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.\n \n This made a lot of previously \"failing\" tests pass for me.  But it should be made clear that this normalization does not in any way take away from the validity of the tests.\n \n```\n",
    "created_at": "2017-11-27T13:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358612",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -12,7 +12,9 @@
 
 Therefore any doctest that expects a traceback fails, due to this slight formatting difference.  One can go through all such tests and insert ellipses.  But it's simpler if we just normalize for this trivial formatting difference, similarly to #24258.
 
-In this case it isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.
+Additionally, there were a few common exceptions (particularly `IOError` which [as of Python 3.3](https://docs.python.org/3/library/exceptions.html#OSError) are just aliases for `OSError`, so we handle that case as well.
+
+In this case the fixup isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.
 
 This made a lot of previously "failing" tests pass for me.  But it should be made clear that this normalization does not in any way take away from the validity of the tests.
 
```




---

archive/issue_comments_358613.json:
```json
{
    "body": "<a id='comment:19'></a>New commits:",
    "created_at": "2017-11-27T13:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358613",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>New commits:



---

archive/issue_comments_358614.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-27T13:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358614",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358615.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-28T13:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358615",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_061440.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:27:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24271#event-61440"
}
```



---

archive/issue_comments_358616.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-13T17:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-358616",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061441.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-13T17:38:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24271#event-61441"
}
```
