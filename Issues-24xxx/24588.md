# Issue 24588: py3: several long/int related fixes

archive/issues_024351.json:
```json
{
    "assignees": [],
    "body": "These fix a number of major crashes related to handling of Python `int`s on Python 3, especially in cases that were trying to cram them into C `long`s.\n\nCC:  @jdemeyer @fchapoton\n\nBranch/Commit: **[`5ed4bda`](https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de)**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Erik Bray, Jeroen Demeyer**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24588_\n\n",
    "closed_at": "2018-02-25T20:00:54Z",
    "created_at": "2018-01-23T12:32:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: several long/int related fixes",
    "type": "issue",
    "updated_at": "2018-02-25T20:00:54Z",
    "url": "https://github.com/sagemath/sage/issues/24588",
    "user": "https://github.com/embray"
}
```
These fix a number of major crashes related to handling of Python `int`s on Python 3, especially in cases that were trying to cram them into C `long`s.

CC:  @jdemeyer @fchapoton

Branch/Commit: **[`5ed4bda`](https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de)**

Reviewer: **Jeroen Demeyer**

Author: **Erik Bray, Jeroen Demeyer**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/24588_





---

archive/issue_events_340514.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T12:32:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340514"
}
```



---

archive/issue_events_340515.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T12:32:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340515"
}
```



---

archive/issue_events_340516.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T12:32:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340516"
}
```



---

archive/issue_events_340517.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T12:32:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340517"
}
```



---

archive/issue_comments_372670.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI think this uses `integer_check_long` more or less as intended, but Jeroen will probably want to make sure, as its author.",
    "created_at": "2018-01-23T12:33:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372670",
    "user": "https://github.com/embray"
}
```

<div id="comment:1" align="right">comment:1</div>

I think this uses `integer_check_long` more or less as intended, but Jeroen will probably want to make sure, as its author.



---

archive/issue_events_340518.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T12:33:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340518"
}
```



---

archive/issue_comments_372671.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nSeveral quick comments:\n\n1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.\n\n2. In `integer_mod.pyx` you write\n\n```\nelif (isinstance(value, int) and\n      integer_check_long_py(value, &longval, &err) and not err):\n```\nAnd you sure that you need the `isinstance(value, int)` check? Part of the point of `integer_check_long_py` is that there is no need for explicit type checking.\n\n3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?",
    "created_at": "2018-01-23T13:21:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372671",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

Several quick comments:

1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.

2. In `integer_mod.pyx` you write

```
elif (isinstance(value, int) and
      integer_check_long_py(value, &longval, &err) and not err):
```
And you sure that you need the `isinstance(value, int)` check? Part of the point of `integer_check_long_py` is that there is no need for explicit type checking.

3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?



---

archive/issue_events_340519.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T13:30:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340519"
}
```



---

archive/issue_events_340520.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T13:30:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340520"
}
```



---

archive/issue_comments_372672.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@jdemeyer](#comment:2):\n> Several quick comments:\n> \n> 1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.\n\nYes, I think when I wrote that one bit I just forgot I was in a Cython module.",
    "created_at": "2018-01-23T13:34:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372672",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@jdemeyer](#comment:2):
> Several quick comments:
> 
> 1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.

Yes, I think when I wrote that one bit I just forgot I was in a Cython module.



---

archive/issue_comments_372673.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@jdemeyer](#comment:2):\n\n> 3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?\n\nI believe so. In Python 2 we need both `__long__` and `__int__`, but on Python 3 if you have both defined Cython will take `__int__` (really it should take `__long__`).  But it seems to be confused.  However, if you have just `__long__` it will use it correctly.",
    "created_at": "2018-01-23T13:46:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372673",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@jdemeyer](#comment:2):

> 3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?

I believe so. In Python 2 we need both `__long__` and `__int__`, but on Python 3 if you have both defined Cython will take `__int__` (really it should take `__long__`).  But it seems to be confused.  However, if you have just `__long__` it will use it correctly.



---

archive/issue_comments_372674.json:
```json
{
    "body": "Changed commit from **[`23ade97`](https://github.com/sagemath/sagetrac-mirror/commit/23ade97ff241ad89a880338fca0bb5bad5e5f160)** to **[`9527794`](https://github.com/sagemath/sagetrac-mirror/commit/95277948381e2c860b04d076c860c4bf39ea3be8)**",
    "created_at": "2018-01-23T13:56:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372674",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`23ade97`](https://github.com/sagemath/sagetrac-mirror/commit/23ade97ff241ad89a880338fca0bb5bad5e5f160)** to **[`9527794`](https://github.com/sagemath/sagetrac-mirror/commit/95277948381e2c860b04d076c860c4bf39ea3be8)**



---

archive/issue_comments_372675.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6d1b3b5aed5172eb616e0f503e56cfa661a0023a\"><code>6d1b3b5</code></a></td><td><code>These checks are unnecessary</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/95277948381e2c860b04d076c860c4bf39ea3be8\"><code>9527794</code></a></td><td><code>Fix coerction from long to work correctly on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-23T13:56:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372675",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6d1b3b5aed5172eb616e0f503e56cfa661a0023a"><code>6d1b3b5</code></a></td><td><code>These checks are unnecessary</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/95277948381e2c860b04d076c860c4bf39ea3be8"><code>9527794</code></a></td><td><code>Fix coerction from long to work correctly on Python 3</code></td></tr></table>




---

archive/issue_events_340521.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T13:56:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340521"
}
```



---

archive/issue_events_340522.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-01-23T13:56:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340522"
}
```



---

archive/issue_comments_372676.json:
```json
{
    "body": "Changed commit from **[`9527794`](https://github.com/sagemath/sagetrac-mirror/commit/95277948381e2c860b04d076c860c4bf39ea3be8)** to **[`3342910`](https://github.com/sagemath/sagetrac-mirror/commit/3342910a85f83cd639d6dde60235077dd1f974e7)**",
    "created_at": "2018-01-23T17:36:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372676",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9527794`](https://github.com/sagemath/sagetrac-mirror/commit/95277948381e2c860b04d076c860c4bf39ea3be8)** to **[`3342910`](https://github.com/sagemath/sagetrac-mirror/commit/3342910a85f83cd639d6dde60235077dd1f974e7)**



---

archive/issue_comments_372677.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3342910a85f83cd639d6dde60235077dd1f974e7\"><code>3342910</code></a></td><td><code>Fix some of the tests on Python 3</code></td></tr></table>\n",
    "created_at": "2018-01-23T17:36:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372677",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3342910a85f83cd639d6dde60235077dd1f974e7"><code>3342910</code></a></td><td><code>Fix some of the tests on Python 3</code></td></tr></table>




---

archive/issue_events_340523.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-09T15:47:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340523"
}
```



---

archive/issue_events_340524.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-09T15:47:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340524"
}
```



---

archive/issue_comments_372678.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\ndoes not apply",
    "created_at": "2018-02-09T15:47:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372678",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:9" align="right">comment:9</div>

does not apply



---

archive/issue_comments_372679.json:
```json
{
    "body": "Changed commit from **[`3342910`](https://github.com/sagemath/sagetrac-mirror/commit/3342910a85f83cd639d6dde60235077dd1f974e7)** to **[`ec2f4ae`](https://github.com/sagemath/sagetrac-mirror/commit/ec2f4ae034fe3997abbc094bfa7fb53478ea1688)**",
    "created_at": "2018-02-12T10:41:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372679",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3342910`](https://github.com/sagemath/sagetrac-mirror/commit/3342910a85f83cd639d6dde60235077dd1f974e7)** to **[`ec2f4ae`](https://github.com/sagemath/sagetrac-mirror/commit/ec2f4ae034fe3997abbc094bfa7fb53478ea1688)**



---

archive/issue_comments_372680.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2203f96defc1b146c4e257cdb2351bd72aea0294\"><code>2203f96</code></a></td><td><code>py3: fixes to sage.rings.finite_rings.integer_mod to better handle conversion of Python ints to C longs where possible</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b3413ebc531bd2359ef49b550a0752178f5bf02b\"><code>b3413eb</code></a></td><td><code>py3: some int/long fixes for sage.rings.integer</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c4b44d76b9d6882f8624988705213bad5a527c3f\"><code>c4b44d7</code></a></td><td><code>py3: simple long/int fix in sage.rings.number_field.order</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1f009e1d5077cc277dcb13faee3faed16c7afac0\"><code>1f009e1</code></a></td><td><code>py3: long/int fixes for sage.rings.rational</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff90f2788822d6aa0c23cb2548598216815bd13f\"><code>ff90f27</code></a></td><td><code>py3: similarly to int_to_Q, update int_toRR to handle any size of Python int</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f7bc2e4a82c97dfa3e3f277f877e50a432ff3dc8\"><code>f7bc2e4</code></a></td><td><code>py3: update IntegerMulAction to properly handle int/long to C long conversion on Python 2 and 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b23ca5255b6001c7b1c3369498a563eb41eb1835\"><code>b23ca52</code></a></td><td><code>Split int_to_Q into a separate long_to_Q, correcting some other mistakes I had in the implementation.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a7b7fd85e5e69c5b2a1bd32332d16a14f9233ed6\"><code>a7b7fd8</code></a></td><td><code>These checks are unnecessary</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1358b965d4f13a94f320cce1d7ba25f0b0caac72\"><code>1358b96</code></a></td><td><code>Fix coerction from long to work correctly on Python 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec2f4ae034fe3997abbc094bfa7fb53478ea1688\"><code>ec2f4ae</code></a></td><td><code>Fix some of the tests on Python 3</code></td></tr></table>\n",
    "created_at": "2018-02-12T10:41:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372680",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2203f96defc1b146c4e257cdb2351bd72aea0294"><code>2203f96</code></a></td><td><code>py3: fixes to sage.rings.finite_rings.integer_mod to better handle conversion of Python ints to C longs where possible</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b3413ebc531bd2359ef49b550a0752178f5bf02b"><code>b3413eb</code></a></td><td><code>py3: some int/long fixes for sage.rings.integer</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c4b44d76b9d6882f8624988705213bad5a527c3f"><code>c4b44d7</code></a></td><td><code>py3: simple long/int fix in sage.rings.number_field.order</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1f009e1d5077cc277dcb13faee3faed16c7afac0"><code>1f009e1</code></a></td><td><code>py3: long/int fixes for sage.rings.rational</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff90f2788822d6aa0c23cb2548598216815bd13f"><code>ff90f27</code></a></td><td><code>py3: similarly to int_to_Q, update int_toRR to handle any size of Python int</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f7bc2e4a82c97dfa3e3f277f877e50a432ff3dc8"><code>f7bc2e4</code></a></td><td><code>py3: update IntegerMulAction to properly handle int/long to C long conversion on Python 2 and 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b23ca5255b6001c7b1c3369498a563eb41eb1835"><code>b23ca52</code></a></td><td><code>Split int_to_Q into a separate long_to_Q, correcting some other mistakes I had in the implementation.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a7b7fd85e5e69c5b2a1bd32332d16a14f9233ed6"><code>a7b7fd8</code></a></td><td><code>These checks are unnecessary</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1358b965d4f13a94f320cce1d7ba25f0b0caac72"><code>1358b96</code></a></td><td><code>Fix coerction from long to work correctly on Python 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec2f4ae034fe3997abbc094bfa7fb53478ea1688"><code>ec2f4ae</code></a></td><td><code>Fix some of the tests on Python 3</code></td></tr></table>




---

archive/issue_events_340525.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T10:41:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340525"
}
```



---

archive/issue_events_340526.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T10:41:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340526"
}
```



---

archive/issue_comments_372681.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWell, it does now...",
    "created_at": "2018-02-12T10:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372681",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Well, it does now...



---

archive/issue_comments_372682.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\n1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does \"nor can it be coerced to an int\" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).\n\n2. In `integer.pyx` and `rational.pyx`, you have\n\n```\n        if type(a) is not int:\n            raise ValueError(\"must be a Python int object\")\n\n        do_something_with(PyInt_AS_LONG(a))\n```\nFirst of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.\n\n3. Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`.\n\n4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.\n\n5. In `src/sage/structure/coerce_actions.pyx`, I would replace\n\n```\nif integer_check_long(nn, &n_long, &err) and not err:\n```\nby\n\n```\ninteger_check_long(nn, &n_long, &err)\nif not err:\n```",
    "created_at": "2018-02-12T11:18:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372682",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does "nor can it be coerced to an int" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).

2. In `integer.pyx` and `rational.pyx`, you have

```
        if type(a) is not int:
            raise ValueError("must be a Python int object")

        do_something_with(PyInt_AS_LONG(a))
```
First of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.

3. Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`.

4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.

5. In `src/sage/structure/coerce_actions.pyx`, I would replace

```
if integer_check_long(nn, &n_long, &err) and not err:
```
by

```
integer_check_long(nn, &n_long, &err)
if not err:
```



---

archive/issue_events_340527.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T11:18:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340527"
}
```



---

archive/issue_events_340528.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T11:18:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340528"
}
```



---

archive/issue_comments_372683.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\n> Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`\n\nCan you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.  Why for `Integer` and not `Rational`?",
    "created_at": "2018-02-12T11:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372683",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

> Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`

Can you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.  Why for `Integer` and not `Rational`?



---

archive/issue_comments_372684.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAlso, I'm not entirely convinced by the logic in `integer_mod.pyx`. It seems that the type of the result should *only* depend on the parent, not on the input number.",
    "created_at": "2018-02-12T11:24:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372684",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Also, I'm not entirely convinced by the logic in `integer_mod.pyx`. It seems that the type of the result should *only* depend on the parent, not on the input number.



---

archive/issue_comments_372685.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@embray](#comment:14):\n> > Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`\n\n> \n> Can you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.\n\nFor `Integer`, we add a specific hacked `tp_new` slot. See `fast_tp_new` in `integer.pyx`. This bypasses the Cython-generated `tp_new`, so Cython might optimize `Integer.__new__(Integer)` wrongly. This is not the case for `Rational`.",
    "created_at": "2018-02-12T11:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372685",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@embray](#comment:14):
> > Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`

> 
> Can you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.

For `Integer`, we add a specific hacked `tp_new` slot. See `fast_tp_new` in `integer.pyx`. This bypasses the Cython-generated `tp_new`, so Cython might optimize `Integer.__new__(Integer)` wrongly. This is not the case for `Rational`.



---

archive/issue_comments_372686.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@jdemeyer](#comment:12):\n> 1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does \"nor can it be coerced to an int\" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).\n\nI think originally this `integer_check_long` which tries `__index__` and some other conversions if possible.  But I changed it--I don't remember exactly why.\n\n> 2. In `integer.pyx` and `rational.pyx`, you have\n> \n> ```\n>         if type(a) is not int:\n>             raise ValueError(\"must be a Python int object\")\n> \n>         do_something_with(PyInt_AS_LONG(a))\n> ```\n> First of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.\n\nIn both these cases this is code that will only ever be used on Python 2, because I also added a `long_to_<F>` map.  If anything the `int_to_<F>` could be omitted completely on Python 2 with a compile-time `IF` but I didn't because it at least does build on Python 3, but never get used.  What do you think?\n\nI added the check very deliberately because, as you can read in the commit messages, the previous code did not have the check supposedly for \"efficiency\" because in practice the code is never run except through the coercion model where the appropriate type checks have already been made. However, in testing, the code is still tested directly.  And this is unsafe--on Python 2 it happened that it could work okay, but in fact it can actually lead to a segfault.  Keeping the check is good, and not having it was a needless micro-optimization.  I agree, in retrospect, it should be a `TypeError`.\n\n\n> 4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.\n\nIndeed--there's no need for the `Integer` there.\n\n> 5. In `src/sage/structure/coerce_actions.pyx`, I would replace\n> \n> ```\n> if integer_check_long(nn, &n_long, &err) and not err:\n> ```\n> by\n> \n> ```\n> integer_check_long(nn, &n_long, &err)\n> if not err:\n> ```\n\nI don't care much either way.",
    "created_at": "2018-02-12T11:36:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372686",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@jdemeyer](#comment:12):
> 1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does "nor can it be coerced to an int" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).

I think originally this `integer_check_long` which tries `__index__` and some other conversions if possible.  But I changed it--I don't remember exactly why.

> 2. In `integer.pyx` and `rational.pyx`, you have
> 
> ```
>         if type(a) is not int:
>             raise ValueError("must be a Python int object")
> 
>         do_something_with(PyInt_AS_LONG(a))
> ```
> First of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.

In both these cases this is code that will only ever be used on Python 2, because I also added a `long_to_<F>` map.  If anything the `int_to_<F>` could be omitted completely on Python 2 with a compile-time `IF` but I didn't because it at least does build on Python 3, but never get used.  What do you think?

I added the check very deliberately because, as you can read in the commit messages, the previous code did not have the check supposedly for "efficiency" because in practice the code is never run except through the coercion model where the appropriate type checks have already been made. However, in testing, the code is still tested directly.  And this is unsafe--on Python 2 it happened that it could work okay, but in fact it can actually lead to a segfault.  Keeping the check is good, and not having it was a needless micro-optimization.  I agree, in retrospect, it should be a `TypeError`.


> 4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.

Indeed--there's no need for the `Integer` there.

> 5. In `src/sage/structure/coerce_actions.pyx`, I would replace
> 
> ```
> if integer_check_long(nn, &n_long, &err) and not err:
> ```
> by
> 
> ```
> integer_check_long(nn, &n_long, &err)
> if not err:
> ```

I don't care much either way.



---

archive/issue_comments_372687.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI wonder if we couldn't add the same hack for Rational, for consistency's sake if nothing else.  Because that's completely non-obvious.  But that's an orthogonal issue.",
    "created_at": "2018-02-12T11:42:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372687",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

I wonder if we couldn't add the same hack for Rational, for consistency's sake if nothing else.  Because that's completely non-obvious.  But that's an orthogonal issue.



---

archive/issue_comments_372688.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nIt occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.",
    "created_at": "2018-02-12T11:43:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372688",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.



---

archive/issue_comments_372689.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nGeneral question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?",
    "created_at": "2018-02-12T11:45:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372689",
    "user": "https://github.com/embray"
}
```

<div id="comment:20" align="right">comment:20</div>

General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?



---

archive/issue_comments_372690.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8\"><code>45a005d</code></a></td><td><code>Addresses some minor review comments</code></td></tr></table>\n",
    "created_at": "2018-02-12T11:47:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372690",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8"><code>45a005d</code></a></td><td><code>Addresses some minor review comments</code></td></tr></table>




---

archive/issue_comments_372691.json:
```json
{
    "body": "Changed commit from **[`ec2f4ae`](https://github.com/sagemath/sagetrac-mirror/commit/ec2f4ae034fe3997abbc094bfa7fb53478ea1688)** to **[`45a005d`](https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8)**",
    "created_at": "2018-02-12T11:47:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372691",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ec2f4ae`](https://github.com/sagemath/sagetrac-mirror/commit/ec2f4ae034fe3997abbc094bfa7fb53478ea1688)** to **[`45a005d`](https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8)**



---

archive/issue_comments_372692.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@embray](#comment:20):\n> General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?\n\nI guess the difference is mathematical: a `Morphism` must be a morphism (this means in particular that it is defined everywhere). Coercions are required to be morphisms, conversions may be maps which are not morphisms.\n\nBut I don't know how this mathematical difference is relevant for the implementation.",
    "created_at": "2018-02-12T11:56:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372692",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@embray](#comment:20):
> General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?

I guess the difference is mathematical: a `Morphism` must be a morphism (this means in particular that it is defined everywhere). Coercions are required to be morphisms, conversions may be maps which are not morphisms.

But I don't know how this mathematical difference is relevant for the implementation.



---

archive/issue_comments_372693.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nRight, I know what these terms mean in mathematics but it's really unclear how or why they're being used in certain cases in Sage...",
    "created_at": "2018-02-12T14:14:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372693",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">comment:23</div>

Right, I know what these terms mean in mathematics but it's really unclear how or why they're being used in certain cases in Sage...



---

archive/issue_comments_372694.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@embray](#comment:19):\n> It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.\n\nIn second thought, I'll leave this as-is for now, just in this case.  Reason being that the existing class does not override `__init__` and requires passing in the domain and codomain as arguments anyways (this is in contrast with, say, `int_to_Q` whose `__init__` bakes these in).  It would be good to change this for consistency's sake, and there's probably no problem with changing this since it's really an internal implementation detail.  But for now, since `int_toRR` is defined the way it is, there's no good reason to have separate `int` and `long` maps.\n\nStill need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.",
    "created_at": "2018-02-12T14:26:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372694",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@embray](#comment:19):
> It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.

In second thought, I'll leave this as-is for now, just in this case.  Reason being that the existing class does not override `__init__` and requires passing in the domain and codomain as arguments anyways (this is in contrast with, say, `int_to_Q` whose `__init__` bakes these in).  It would be good to change this for consistency's sake, and there's probably no problem with changing this since it's really an internal implementation detail.  But for now, since `int_toRR` is defined the way it is, there's no good reason to have separate `int` and `long` maps.

Still need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.



---

archive/issue_comments_372695.json:
```json
{
    "body": "Changed commit from **[`45a005d`](https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8)** to **[`ec26452`](https://github.com/sagemath/sagetrac-mirror/commit/ec264522754c29381c777fc2131f99dad851d4a0)**",
    "created_at": "2018-02-12T15:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372695",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`45a005d`](https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8)** to **[`ec26452`](https://github.com/sagemath/sagetrac-mirror/commit/ec264522754c29381c777fc2131f99dad851d4a0)**



---

archive/issue_comments_372696.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b86da69265f2f5a57590fb1dbdab3057d8381f7b\"><code>b86da69</code></a></td><td><code>If somehow integer_check_long_py returns False return the appropriate TypeError</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec264522754c29381c777fc2131f99dad851d4a0\"><code>ec26452</code></a></td><td><code>Apparently this class should also work with a domain that is not int/long.</code></td></tr></table>\n",
    "created_at": "2018-02-12T15:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372696",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b86da69265f2f5a57590fb1dbdab3057d8381f7b"><code>b86da69</code></a></td><td><code>If somehow integer_check_long_py returns False return the appropriate TypeError</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec264522754c29381c777fc2131f99dad851d4a0"><code>ec26452</code></a></td><td><code>Apparently this class should also work with a domain that is not int/long.</code></td></tr></table>




---

archive/issue_comments_372697.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nNot totally sure about this last change, but I *think* it's better.",
    "created_at": "2018-02-12T15:04:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372697",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

Not totally sure about this last change, but I *think* it's better.



---

archive/issue_events_340529.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T15:04:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340529"
}
```



---

archive/issue_events_340530.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T15:04:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340530"
}
```



---

archive/issue_comments_372698.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@embray](#comment:24):\n> Still need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.\n\nI would just keep them.",
    "created_at": "2018-02-12T20:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372698",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@embray](#comment:24):
> Still need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.

I would just keep them.



---

archive/issue_events_340531.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-13T15:37:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340531"
}
```



---

archive/issue_events_340532.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-13T15:37:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340532"
}
```



---

archive/issue_comments_372699.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\n1. Why `long(x)` here? Surely, `int(x)` makes more sense:\n\n```\n        if not isinstance(x, (int, long)):\n            x = long(x)\n```\n\n2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.\n\n3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)",
    "created_at": "2018-02-13T15:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372699",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

1. Why `long(x)` here? Surely, `int(x)` makes more sense:

```
        if not isinstance(x, (int, long)):
            x = long(x)
```

2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.

3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)



---

archive/issue_comments_372700.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@jdemeyer](#comment:28):\n> 1. Why `long(x)` here? Surely, `int(x)` makes more sense:\n> \n> ```\n>         if not isinstance(x, (int, long)):\n>             x = long(x)\n> ```\n\nHonestly, neither is quite right.  You certainly don't want `int()` since that could overflow on Python 2.  The problem with the original design of this class it wants to be able to accept anything in its domain that can be converted to an int.  But this has problems if you want it to work for long too.  I don't know that there's actually any code that relies on its current behavior though so maybe that should just be changed.\n\n> 2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.\n\nOops, of course.\n \n> 3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)\n\nWell, the solution there is just consistent with the existing logic of that class.  I'm not sure it makes a whole lot of sense either.  I would propose to leave it as-is for now (because it fixes any Python 3 specific bugs) but you could open a separate ticket if you think the logic is wrong in general.",
    "created_at": "2018-02-14T16:28:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372700",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@jdemeyer](#comment:28):
> 1. Why `long(x)` here? Surely, `int(x)` makes more sense:
> 
> ```
>         if not isinstance(x, (int, long)):
>             x = long(x)
> ```

Honestly, neither is quite right.  You certainly don't want `int()` since that could overflow on Python 2.  The problem with the original design of this class it wants to be able to accept anything in its domain that can be converted to an int.  But this has problems if you want it to work for long too.  I don't know that there's actually any code that relies on its current behavior though so maybe that should just be changed.

> 2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.

Oops, of course.
 
> 3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)

Well, the solution there is just consistent with the existing logic of that class.  I'm not sure it makes a whole lot of sense either.  I would propose to leave it as-is for now (because it fixes any Python 3 specific bugs) but you could open a separate ticket if you think the logic is wrong in general.



---

archive/issue_comments_372701.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\n`int(x)` doesn't overflow. It just returns a `long` instance:\n\n```\nsage: int(float(1e100))\n10000000000000000159028911097599180468360808563945281389781327557747838772170381060813469985856815104L\n```",
    "created_at": "2018-02-14T16:31:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372701",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

`int(x)` doesn't overflow. It just returns a `long` instance:

```
sage: int(float(1e100))
10000000000000000159028911097599180468360808563945281389781327557747838772170381060813469985856815104L
```



---

archive/issue_comments_372702.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@embray](#comment:29):\n> I would propose to leave it as-is for now\n\nWhat's the point of replacing wrong code with different wrong code?",
    "created_at": "2018-02-15T06:35:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372702",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@embray](#comment:29):
> I would propose to leave it as-is for now

What's the point of replacing wrong code with different wrong code?



---

archive/issue_comments_372703.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThe answer is right in both the title and \"component\" of the ticket: \"py3:\".\n\nThis is far from the only \"wrong\" or at least \"bad\" code I've encountered in Sage in the course of making Python 3 (some of it is downright atrocious).  The focus of this changeset is to merely fix the bugs on Python 3.\n\n> `int(x)` doesn't overflow\n\nI was imprecise. The problem isn't that `int(x)` itself will overflow.  The behavior you cite is due to how `float.__int__` is implemented.  Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.",
    "created_at": "2018-02-15T16:21:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372703",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

The answer is right in both the title and "component" of the ticket: "py3:".

This is far from the only "wrong" or at least "bad" code I've encountered in Sage in the course of making Python 3 (some of it is downright atrocious).  The focus of this changeset is to merely fix the bugs on Python 3.

> `int(x)` doesn't overflow

I was imprecise. The problem isn't that `int(x)` itself will overflow.  The behavior you cite is due to how `float.__int__` is implemented.  Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.



---

archive/issue_comments_372704.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@embray](#comment:32):\n> Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.\n\nBut `int(x)` is used in so many places in Sage and in Python. I feel like we should have noticed any bugs there...",
    "created_at": "2018-02-15T16:25:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372704",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@embray](#comment:32):
> Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.

But `int(x)` is used in so many places in Sage and in Python. I feel like we should have noticed any bugs there...



---

archive/issue_comments_372705.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nIn this case I could change it and see how things go.  You're right--my only justifications in this case are vague hand-waving. I don't think there's a specific issue it addresses.  Although I will say that the use of `int(x)` in many places *does* have bugs, and they just don't show up because that code normally involves smaller numbers.",
    "created_at": "2018-02-15T16:28:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372705",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">comment:34</div>

In this case I could change it and see how things go.  You're right--my only justifications in this case are vague hand-waving. I don't think there's a specific issue it addresses.  Although I will say that the use of `int(x)` in many places *does* have bugs, and they just don't show up because that code normally involves smaller numbers.



---

archive/issue_comments_372706.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nLooks like there's one test I forgot to update after [45a005d6](https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8).  Thought I had all those but apparently not.",
    "created_at": "2018-02-15T16:58:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372706",
    "user": "https://github.com/embray"
}
```

<div id="comment:35" align="right">comment:35</div>

Looks like there's one test I forgot to update after [45a005d6](https://github.com/sagemath/sagetrac-mirror/commit/45a005d6c12d1fc7aa946f4635067f79067baeb8).  Thought I had all those but apparently not.



---

archive/issue_comments_372707.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nI will\n\n1. add the few minor fixes which are still needed\n\n2. revert the changes to `integer_mod.pyx` and open a new ticket for that\n\n3. give positive review to this ticket",
    "created_at": "2018-02-16T08:50:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372707",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">comment:36</div>

I will

1. add the few minor fixes which are still needed

2. revert the changes to `integer_mod.pyx` and open a new ticket for that

3. give positive review to this ticket



---

archive/issue_comments_372708.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2018-02-16T08:50:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372708",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_372709.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/long-int-fixes)** to **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)**",
    "created_at": "2018-02-16T09:07:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372709",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/embray/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/long-int-fixes)** to **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)**



---

archive/issue_events_340533.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-16T09:07:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340533"
}
```



---

archive/issue_events_340534.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-16T09:07:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340534"
}
```



---

archive/issue_comments_372710.json:
```json
{
    "body": "Changed commit from **[`ec26452`](https://github.com/sagemath/sagetrac-mirror/commit/ec264522754c29381c777fc2131f99dad851d4a0)** to **[`3a7a87e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7a87ea13258db567477a20b2eacceb9269f4f8)**",
    "created_at": "2018-02-16T09:07:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372710",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`ec26452`](https://github.com/sagemath/sagetrac-mirror/commit/ec264522754c29381c777fc2131f99dad851d4a0)** to **[`3a7a87e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7a87ea13258db567477a20b2eacceb9269f4f8)**



---

archive/issue_comments_372711.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nLast 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fc24a5435281dbee9bd449cd36da66838521831b\"><code>fc24a54</code></a></td><td><code>py3: similarly to int_to_Q, update int_toRR to handle any size of Python int</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0692e4192d1fb49c71d3af0b405fcce10dc4f186\"><code>0692e41</code></a></td><td><code>py3: update IntegerMulAction to properly handle int/long to C long conversion on Python 2 and 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2826e0b2a1be60095e1a55fb7c6e3a46a9e6ce66\"><code>2826e0b</code></a></td><td><code>Split int_to_Q into a separate long_to_Q, correcting some other mistakes I had in the implementation.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/993bfc27ee35b6968aa58a8063e132483848e96c\"><code>993bfc2</code></a></td><td><code>These checks are unnecessary</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f200fb37e1fd62ca24cf3a75a095e368c641d7e8\"><code>f200fb3</code></a></td><td><code>Fix coerction from long to work correctly on Python 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5748b28589f3cb0fbb1240f41174416ba95fda39\"><code>5748b28</code></a></td><td><code>Fix some of the tests on Python 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/857af9d87989c2ff91c6c443bf4c5ecf337723dc\"><code>857af9d</code></a></td><td><code>Addresses some minor review comments</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6eeb864c4314c7d0dadb04e36a1a1af90bc4c5b0\"><code>6eeb864</code></a></td><td><code>If somehow integer_check_long_py returns False return the appropriate TypeError</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0865e8f1815a9256d99946836e632986c9894ad5\"><code>0865e8f</code></a></td><td><code>Apparently this class should also work with a domain that is not int/long.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a7a87ea13258db567477a20b2eacceb9269f4f8\"><code>3a7a87e</code></a></td><td><code>Reviewer fixes</code></td></tr></table>\n",
    "created_at": "2018-02-16T09:07:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372711",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fc24a5435281dbee9bd449cd36da66838521831b"><code>fc24a54</code></a></td><td><code>py3: similarly to int_to_Q, update int_toRR to handle any size of Python int</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0692e4192d1fb49c71d3af0b405fcce10dc4f186"><code>0692e41</code></a></td><td><code>py3: update IntegerMulAction to properly handle int/long to C long conversion on Python 2 and 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2826e0b2a1be60095e1a55fb7c6e3a46a9e6ce66"><code>2826e0b</code></a></td><td><code>Split int_to_Q into a separate long_to_Q, correcting some other mistakes I had in the implementation.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/993bfc27ee35b6968aa58a8063e132483848e96c"><code>993bfc2</code></a></td><td><code>These checks are unnecessary</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f200fb37e1fd62ca24cf3a75a095e368c641d7e8"><code>f200fb3</code></a></td><td><code>Fix coerction from long to work correctly on Python 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5748b28589f3cb0fbb1240f41174416ba95fda39"><code>5748b28</code></a></td><td><code>Fix some of the tests on Python 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/857af9d87989c2ff91c6c443bf4c5ecf337723dc"><code>857af9d</code></a></td><td><code>Addresses some minor review comments</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6eeb864c4314c7d0dadb04e36a1a1af90bc4c5b0"><code>6eeb864</code></a></td><td><code>If somehow integer_check_long_py returns False return the appropriate TypeError</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0865e8f1815a9256d99946836e632986c9894ad5"><code>0865e8f</code></a></td><td><code>Apparently this class should also work with a domain that is not int/long.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a7a87ea13258db567477a20b2eacceb9269f4f8"><code>3a7a87e</code></a></td><td><code>Reviewer fixes</code></td></tr></table>




---

archive/issue_comments_372712.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nI had already fixed those things...\n\nI'm not sure why this change:\n\n```\n-        elif err == ERR_OVERFLOW:\n+        elif isinstance(x, long):\n```\n\nWhy a relatively slow `isinstance` when the whole point of `ERR_OVERFLOW` is that the value was already an int/long too big to fit in a C long?  At any rate, there's now an unused `cimport` of `ERR_OVERFLOW`...",
    "created_at": "2018-02-16T10:21:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372712",
    "user": "https://github.com/embray"
}
```

<div id="comment:39" align="right">comment:39</div>

I had already fixed those things...

I'm not sure why this change:

```
-        elif err == ERR_OVERFLOW:
+        elif isinstance(x, long):
```

Why a relatively slow `isinstance` when the whole point of `ERR_OVERFLOW` is that the value was already an int/long too big to fit in a C long?  At any rate, there's now an unused `cimport` of `ERR_OVERFLOW`...



---

archive/issue_events_340535.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-16T10:21:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340535"
}
```



---

archive/issue_events_340536.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-16T10:21:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340536"
}
```



---

archive/issue_comments_372713.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@embray](#comment:39):\n> I had already fixed those things...\n\nBut not in a branch on this ticket.\n\n> I'm not sure why this change:\n> \n> ```\n> -        elif err == ERR_OVERFLOW:\n> +        elif isinstance(x, long):\n> ```\n\n> Why a relatively slow `isinstance`\n\nFirst of all, it's not at all slow. This uses `PyLong_Check()` which has an optimized code path:\n\n```C\n#define PyLong_Check(op) \\\n        PyType_FastSubclass(Py_TYPE(op), Py_TPFLAGS_LONG_SUBCLASS)\n```\nThis shouldn't take any measurable time.\n\nThe reason that I changed it is because I want to check the actual condition that I need: it must be an actual Python `long` since that is what `mpz_set_pylong` takes (without checking). It is really just an extra safety check.",
    "created_at": "2018-02-16T13:58:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372713",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@embray](#comment:39):
> I had already fixed those things...

But not in a branch on this ticket.

> I'm not sure why this change:
> 
> ```
> -        elif err == ERR_OVERFLOW:
> +        elif isinstance(x, long):
> ```

> Why a relatively slow `isinstance`

First of all, it's not at all slow. This uses `PyLong_Check()` which has an optimized code path:

```C
#define PyLong_Check(op) \
        PyType_FastSubclass(Py_TYPE(op), Py_TPFLAGS_LONG_SUBCLASS)
```
This shouldn't take any measurable time.

The reason that I changed it is because I want to check the actual condition that I need: it must be an actual Python `long` since that is what `mpz_set_pylong` takes (without checking). It is really just an extra safety check.



---

archive/issue_events_340537.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-16T13:58:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340537"
}
```



---

archive/issue_events_340538.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-16T13:58:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340538"
}
```



---

archive/issue_comments_372714.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nI think by the time I pushed my fixes you changed it to your branch.\n\nI see now, upon closer inspection, that `integer_check_long_py` does *not* set `err = ERR_TYPE` if it was not passed an int/long.  So indeed in that case this additional check would be needed.  But I think that's a defect in `integer_check_long_py`.  It has *already* checked whether or not the argument is a `long`, so if it fails that check (as well as the `int` check) it should set `err=ERR_TYPE`.  Then the additional `isinstance(...)` (fast or not--it's not micro-optimization I'm concerned with here) is unnecessary.",
    "created_at": "2018-02-21T11:49:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372714",
    "user": "https://github.com/embray"
}
```

<div id="comment:41" align="right">comment:41</div>

I think by the time I pushed my fixes you changed it to your branch.

I see now, upon closer inspection, that `integer_check_long_py` does *not* set `err = ERR_TYPE` if it was not passed an int/long.  So indeed in that case this additional check would be needed.  But I think that's a defect in `integer_check_long_py`.  It has *already* checked whether or not the argument is a `long`, so if it fails that check (as well as the `int` check) it should set `err=ERR_TYPE`.  Then the additional `isinstance(...)` (fast or not--it's not micro-optimization I'm concerned with here) is unnecessary.



---

archive/issue_comments_372715.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nWhile you're at it, one (small) gripe I have with `integer_check_long(_py)` is that it requires a non-NULL err argument at all.  There are times I've used it where I didn't need the `err` value at all, and it would be nice if it could accept a NULL pointer (and in that case just not set the error).",
    "created_at": "2018-02-21T11:52:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372715",
    "user": "https://github.com/embray"
}
```

<div id="comment:42" align="right">comment:42</div>

While you're at it, one (small) gripe I have with `integer_check_long(_py)` is that it requires a non-NULL err argument at all.  There are times I've used it where I didn't need the `err` value at all, and it would be nice if it could accept a NULL pointer (and in that case just not set the error).



---

archive/issue_comments_372716.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nTo be honest, it was not easy to decide the API for `integer_check_long(_py)`. My idea was to look at various use cases and then maybe reconsider how the API should be done.\n\nBut that shouldn't affect the status of this ticket.",
    "created_at": "2018-02-21T13:21:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372716",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:43" align="right">comment:43</div>

To be honest, it was not easy to decide the API for `integer_check_long(_py)`. My idea was to look at various use cases and then maybe reconsider how the API should be done.

But that shouldn't affect the status of this ticket.



---

archive/issue_comments_372717.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@embray](#comment:42):\n> There are times I've used it where I didn't need the `err` value at all\n\nThen the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.",
    "created_at": "2018-02-22T08:39:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372717",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@embray](#comment:42):
> There are times I've used it where I didn't need the `err` value at all

Then the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.



---

archive/issue_comments_372718.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@jdemeyer](#comment:44):\n> Replying to [@embray](#comment:42):\n> > There are times I've used it where I didn't need the `err` value at all\n\n> \n> Then the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.\n\nPerhaps you're right. I definitely remember times during development where I wanted this, but I think maybe it was only while testing things and ignoring the error value.  Unless a specific example comes up again I won't worry about it.\n\nThe other thing I would still change.  It doesn't make sense to have a superfluous `isinstance(..., long)` there.  A small fix to `integer_check_long_py` would make more sense.",
    "created_at": "2018-02-22T16:04:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372718",
    "user": "https://github.com/embray"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@jdemeyer](#comment:44):
> Replying to [@embray](#comment:42):
> > There are times I've used it where I didn't need the `err` value at all

> 
> Then the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.

Perhaps you're right. I definitely remember times during development where I wanted this, but I think maybe it was only while testing things and ignoring the error value.  Unless a specific example comes up again I won't worry about it.

The other thing I would still change.  It doesn't make sense to have a superfluous `isinstance(..., long)` there.  A small fix to `integer_check_long_py` would make more sense.



---

archive/issue_comments_372719.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@embray](#comment:45):\n> It doesn't make sense to have a superfluous `isinstance(..., long)` there.\n\nI think it does make sense. It doesn't hurt and it's a safety net against calling `mpz_set_pylong` with a non-`long` which could potentially segfault Python.",
    "created_at": "2018-02-22T16:07:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372719",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@embray](#comment:45):
> It doesn't make sense to have a superfluous `isinstance(..., long)` there.

I think it does make sense. It doesn't hurt and it's a safety net against calling `mpz_set_pylong` with a non-`long` which could potentially segfault Python.



---

archive/issue_comments_372720.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nPlease re-read [#24588 comment:41](https://github.com/sagemath/sage/issues/24588#comment:41).\n\nThe (as you wrote, somewhat loose to begin with) API for `integer_check_long_py` doesn't make a whole lot of sense. It already checks `isinstance(x, long)` and should probably set the relevant error in that case.",
    "created_at": "2018-02-22T16:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372720",
    "user": "https://github.com/embray"
}
```

<div id="comment:47" align="right">comment:47</div>

Please re-read [#24588 comment:41](https://github.com/sagemath/sage/issues/24588#comment:41).

The (as you wrote, somewhat loose to begin with) API for `integer_check_long_py` doesn't make a whole lot of sense. It already checks `isinstance(x, long)` and should probably set the relevant error in that case.



---

archive/issue_comments_372721.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nThe following small change is all I'm suggesting.  This brings the API for `integer_check_long_py` more in line with the general `integer_check_long`, which to me makes much more sense, especially since it seems `integer_check_long_py` is more useful on its own than you maybe initially intended.  You are willing to take it, or leave it if you still disagree.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0df9f62f0e5d4fe2f1a423f9da958ddca6e7e532\"><code>0df9f62</code></a></td><td><code>Slight change to integer_check_long_py--it can now set err=ERR_TYPE when returning false if the argument is neither an int or a long.</code></td></tr></table>\n",
    "created_at": "2018-02-22T17:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372721",
    "user": "https://github.com/embray"
}
```

<div id="comment:48" align="right">comment:48</div>

The following small change is all I'm suggesting.  This brings the API for `integer_check_long_py` more in line with the general `integer_check_long`, which to me makes much more sense, especially since it seems `integer_check_long_py` is more useful on its own than you maybe initially intended.  You are willing to take it, or leave it if you still disagree.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0df9f62f0e5d4fe2f1a423f9da958ddca6e7e532"><code>0df9f62</code></a></td><td><code>Slight change to integer_check_long_py--it can now set err=ERR_TYPE when returning false if the argument is neither an int or a long.</code></td></tr></table>




---

archive/issue_comments_372722.json:
```json
{
    "body": "Changed commit from **[`3a7a87e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7a87ea13258db567477a20b2eacceb9269f4f8)** to **[`0df9f62`](https://github.com/sagemath/sagetrac-mirror/commit/0df9f62f0e5d4fe2f1a423f9da958ddca6e7e532)**",
    "created_at": "2018-02-22T17:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372722",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`3a7a87e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7a87ea13258db567477a20b2eacceb9269f4f8)** to **[`0df9f62`](https://github.com/sagemath/sagetrac-mirror/commit/0df9f62f0e5d4fe2f1a423f9da958ddca6e7e532)**



---

archive/issue_comments_372723.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)** to **[u/embray/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/long-int-fixes)**",
    "created_at": "2018-02-22T17:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372723",
    "user": "https://github.com/embray"
}
```

Changed branch from **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)** to **[u/embray/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/long-int-fixes)**



---

archive/issue_comments_372724.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nI don't agree entirely with this change:\n\n```diff\n@@ -176,10 +176,11 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n             err[0] = ERR_OVERFLOW\n         return 1\n     elif PyIndex_Check(x):\n-        err[0] = ERR_INDEX\n+        err[0] = 0\n         try:\n             x = PyNumber_Index(x)\n         except TypeError:\n+            err[0] = ERR_INDEX\n             return 0\n         return integer_check_long_py(x, value, err)\n     else:\n```\nIt seems safer and more natural to set `err[0] = ERR_INDEX` whenever any exception in `__index__` occurs. In any case, setting `err[0] = 0` is pointless because `integer_check_long_py()` is now guaranteed to set `err[0]` to some value.\n\nI just reverted that. If you agree, you can set positive review.",
    "created_at": "2018-02-23T09:12:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372724",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:49" align="right">comment:49</div>

I don't agree entirely with this change:

```diff
@@ -176,10 +176,11 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
             err[0] = ERR_OVERFLOW
         return 1
     elif PyIndex_Check(x):
-        err[0] = ERR_INDEX
+        err[0] = 0
         try:
             x = PyNumber_Index(x)
         except TypeError:
+            err[0] = ERR_INDEX
             return 0
         return integer_check_long_py(x, value, err)
     else:
```
It seems safer and more natural to set `err[0] = ERR_INDEX` whenever any exception in `__index__` occurs. In any case, setting `err[0] = 0` is pointless because `integer_check_long_py()` is now guaranteed to set `err[0]` to some value.

I just reverted that. If you agree, you can set positive review.



---

archive/issue_comments_372725.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/long-int-fixes)** to **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)**",
    "created_at": "2018-02-23T09:12:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372725",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/embray/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/long-int-fixes)** to **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)**



---

archive/issue_comments_372726.json:
```json
{
    "body": "Changed author from **Erik Bray** to **Erik Bray, Jeroen Demeyer**",
    "created_at": "2018-02-23T14:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372726",
    "user": "https://github.com/embray"
}
```

Changed author from **Erik Bray** to **Erik Bray, Jeroen Demeyer**



---

archive/issue_events_340539.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-23T14:22:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340539"
}
```



---

archive/issue_events_340540.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-23T14:22:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340540"
}
```



---

archive/issue_comments_372727.json:
```json
{
    "body": "Changed commit from **[`0df9f62`](https://github.com/sagemath/sagetrac-mirror/commit/0df9f62f0e5d4fe2f1a423f9da958ddca6e7e532)** to **[`5ed4bda`](https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de)**",
    "created_at": "2018-02-23T14:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372727",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`0df9f62`](https://github.com/sagemath/sagetrac-mirror/commit/0df9f62f0e5d4fe2f1a423f9da958ddca6e7e532)** to **[`5ed4bda`](https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de)**



---

archive/issue_comments_372728.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nYep, I think I was misunderstanding what `ERR_INDEX` was supposed to be. Finally we've reached an agreement :)\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de\"><code>5ed4bda</code></a></td><td><code>Slight change to integer_check_long_py--it can now set err=ERR_TYPE when returning false if the argument is neither an int or a long.</code></td></tr></table>\n",
    "created_at": "2018-02-23T14:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372728",
    "user": "https://github.com/embray"
}
```

<div id="comment:51" align="right">comment:51</div>

Yep, I think I was misunderstanding what `ERR_INDEX` was supposed to be. Finally we've reached an agreement :)

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de"><code>5ed4bda</code></a></td><td><code>Slight change to integer_check_long_py--it can now set err=ERR_TYPE when returning false if the argument is neither an int or a long.</code></td></tr></table>




---

archive/issue_events_340541.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-25T20:00:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340541"
}
```



---

archive/issue_events_340542.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d906dc42d8038058095362ee6834d151a545b7ff",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-02-25T20:00:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24588#event-340542"
}
```



---

archive/issue_comments_372729.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)** to **[`5ed4bda`](https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de)**",
    "created_at": "2018-02-25T20:00:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24588#issuecomment-372729",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/python3/long-int-fixes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/python3/long-int-fixes)** to **[`5ed4bda`](https://github.com/sagemath/sagetrac-mirror/commit/5ed4bda0599efc35d8f46ff866430460e1ef85de)**
