# Issue 24384: py3: a few changes about range

archive/issues_024147.json:
```json
{
    "body": "as part of #16081\n\nCC:  @tscrim @jdemeyer @embray\n\nReviewer: Travis Scrimshaw, Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\n\nBranch: 3725ea9322659a01c284bbccc4aa57774dccf33a\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24384\n\n",
    "closed_at": "2017-12-25T18:21:36Z",
    "created_at": "2017-12-15T16:31:28Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: a few changes about range",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24384",
    "user": "https://github.com/fchapoton"
}
```
as part of #16081

CC:  @tscrim @jdemeyer @embray

Reviewer: Travis Scrimshaw, Frédéric Chapoton

Author: Frédéric Chapoton, Travis Scrimshaw

Branch: 3725ea9322659a01c284bbccc4aa57774dccf33a

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24384





---

archive/issue_comments_461806.json:
```json
{
    "body": "Changing commit from \"\" to \"3b8e35a5eabfb40ecde88bde26f9ae6836d89d4a\"",
    "created_at": "2017-12-15T16:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461806",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "3b8e35a5eabfb40ecde88bde26f9ae6836d89d4a"



---

archive/issue_comments_461807.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/24384\"",
    "created_at": "2017-12-15T16:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461807",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/24384"



---

archive/issue_comments_461808.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-15T16:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461808",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461809.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[3b8e35a](https://git.sagemath.org/sage.git/commit?id=3b8e35a5eabfb40ecde88bde26f9ae6836d89d4a)|`py3: again some care for range`|",
    "created_at": "2017-12-15T16:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461809",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                                |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[3b8e35a](https://git.sagemath.org/sage.git/commit?id=3b8e35a5eabfb40ecde88bde26f9ae6836d89d4a)|`py3: again some care for range`|



---

archive/issue_comments_461810.json:
```json
{
    "body": "<a id='comment:2'></a>\ngreen bot, please review",
    "created_at": "2017-12-15T17:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461810",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
green bot, please review



---

archive/issue_comments_461811.json:
```json
{
    "body": "<a id='comment:3'></a>\nSo the changes to `tensor_operations.py` would not be necessary if we add `range` to the known Python classes handled by `cartesian_product`:\n\n```diff\n-native_python_containers   = set([tuple, list, set, frozenset])\n+native_python_containers   = set([tuple, list, set, frozenset, range])\n```\nIt would be good if we could somehow add all possible views to this (and other similar places for previously-list objects), but `range` is the most common one that will be passed for this construction.\n\nI also do not see the need to any changes in `abvar.py`. In Python3 (3.5.2 to be specific), I can do\n\n```\n>>> x = range(5)\n>>> x[-2]\n3\n>>> list(x)\n[0, 1, 2, 3, 4]\n```\nso `i = rows[-1][-1]+1` should not be a problem. Additionally, `matrix_from_rows` would just convert the `range` into a `list` (although I think it probably should not do any such conversion). Am I missing something there?",
    "created_at": "2017-12-15T22:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461811",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
So the changes to `tensor_operations.py` would not be necessary if we add `range` to the known Python classes handled by `cartesian_product`:

```diff
-native_python_containers   = set([tuple, list, set, frozenset])
+native_python_containers   = set([tuple, list, set, frozenset, range])
```
It would be good if we could somehow add all possible views to this (and other similar places for previously-list objects), but `range` is the most common one that will be passed for this construction.

I also do not see the need to any changes in `abvar.py`. In Python3 (3.5.2 to be specific), I can do

```
>>> x = range(5)
>>> x[-2]
3
>>> list(x)
[0, 1, 2, 3, 4]
```
so `i = rows[-1][-1]+1` should not be a problem. Additionally, `matrix_from_rows` would just convert the `range` into a `list` (although I think it probably should not do any such conversion). Am I missing something there?



---

archive/issue_comments_461812.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[98f3c45](https://git.sagemath.org/sage.git/commit/?id=98f3c45b80c3beb6eecf5344a74bd448f10e9afe)|`py3: again some care for range`|",
    "created_at": "2017-12-17T17:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461812",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[98f3c45](https://git.sagemath.org/sage.git/commit/?id=98f3c45b80c3beb6eecf5344a74bd448f10e9afe)|`py3: again some care for range`|



---

archive/issue_comments_461813.json:
```json
{
    "body": "Changing commit from \"3b8e35a5eabfb40ecde88bde26f9ae6836d89d4a\" to \"98f3c45b80c3beb6eecf5344a74bd448f10e9afe\"",
    "created_at": "2017-12-17T17:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461813",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3b8e35a5eabfb40ecde88bde26f9ae6836d89d4a" to "98f3c45b80c3beb6eecf5344a74bd448f10e9afe"



---

archive/issue_comments_461814.json:
```json
{
    "body": "<a id='comment:5'></a>\nI have undone the changes to abvar.\n\n---\nNew commits:\n|                                                                                                                                          |                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[98f3c45](https://git.sagemath.org/sage.git/commit?id=98f3c45b80c3beb6eecf5344a74bd448f10e9afe)|`py3: again some care for range`|",
    "created_at": "2017-12-17T17:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461814",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
I have undone the changes to abvar.

---
New commits:
|                                                                                                                                          |                                |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[98f3c45](https://git.sagemath.org/sage.git/commit?id=98f3c45b80c3beb6eecf5344a74bd448f10e9afe)|`py3: again some care for range`|



---

archive/issue_comments_461815.json:
```json
{
    "body": "<a id='comment:6'></a>\ngreen bot. Would it be ok like that for the moment ?",
    "created_at": "2017-12-17T20:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461815",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
green bot. Would it be ok like that for the moment ?



---

archive/issue_comments_461816.json:
```json
{
    "body": "Changing branch from \"u/chapoton/24384\" to \"public/python3/cartesian_product_range-24384\"",
    "created_at": "2017-12-17T21:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461816",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "u/chapoton/24384" to "public/python3/cartesian_product_range-24384"



---

archive/issue_comments_461817.json:
```json
{
    "body": "Changing commit from \"98f3c45b80c3beb6eecf5344a74bd448f10e9afe\" to \"3725ea9322659a01c284bbccc4aa57774dccf33a\"",
    "created_at": "2017-12-17T21:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461817",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "98f3c45b80c3beb6eecf5344a74bd448f10e9afe" to "3725ea9322659a01c284bbccc4aa57774dccf33a"



---

archive/issue_comments_461818.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw, Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2017-12-17T21:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461818",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw, Frédéric Chapoton"



---

archive/issue_comments_461819.json:
```json
{
    "body": "Changing author from \"Fr\u00e9d\u00e9ric Chapoton\" to \"Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\"",
    "created_at": "2017-12-17T21:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461819",
    "user": "https://github.com/tscrim"
}
```

Changing author from "Frédéric Chapoton" to "Frédéric Chapoton, Travis Scrimshaw"



---

archive/issue_comments_461820.json:
```json
{
    "body": "<a id='comment:7'></a>\nI ended up doing the changes to `cartesian_product` to make that handle a `range` input as that is something we will want to do eventually and it means we do not have to add a bunch of `list` wrappers.\n\n---\nNew commits:\n|                                                                                                                                          |                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[03f94dc](https://git.sagemath.org/sage.git/commit?id=03f94dc70d9511dd5fdcd3d74dbe7863f600a830)|`Handle Python3 range in cartesian_product.`|\n|[3725ea9](https://git.sagemath.org/sage.git/commit?id=3725ea9322659a01c284bbccc4aa57774dccf33a)|`Porting other changes to tensor_operations.py.`|",
    "created_at": "2017-12-17T21:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461820",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>
I ended up doing the changes to `cartesian_product` to make that handle a `range` input as that is something we will want to do eventually and it means we do not have to add a bunch of `list` wrappers.

---
New commits:
|                                                                                                                                          |                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[03f94dc](https://git.sagemath.org/sage.git/commit?id=03f94dc70d9511dd5fdcd3d74dbe7863f600a830)|`Handle Python3 range in cartesian_product.`|
|[3725ea9](https://git.sagemath.org/sage.git/commit?id=3725ea9322659a01c284bbccc4aa57774dccf33a)|`Porting other changes to tensor_operations.py.`|



---

archive/issue_comments_461821.json:
```json
{
    "body": "<a id='comment:8'></a>\nok, thanks",
    "created_at": "2017-12-18T12:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461821",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>
ok, thanks



---

archive/issue_comments_461822.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-18T12:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461822",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_461823.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think changes like this should also include native iterables that were previously functions that returned `list`s, such as `map` and `filter` as well.  Or maybe arbitrary iterables (or at least finite iterables as in `isinstance(x, Iterable) and isinstance(x, Sized)`.  The only problem I've found with this is sometimes it's necessary to take care between specific Sage objects that happen to be iterable, and arbitrary/unknown iterables that should be converted to a list.",
    "created_at": "2017-12-19T11:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461823",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I think changes like this should also include native iterables that were previously functions that returned `list`s, such as `map` and `filter` as well.  Or maybe arbitrary iterables (or at least finite iterables as in `isinstance(x, Iterable) and isinstance(x, Sized)`.  The only problem I've found with this is sometimes it's necessary to take care between specific Sage objects that happen to be iterable, and arbitrary/unknown iterables that should be converted to a list.



---

archive/issue_comments_461824.json:
```json
{
    "body": "<a id='comment:10'></a>\nOther examples include containers like `dict_keys`, `dict_values`, and `dict_items`.",
    "created_at": "2017-12-19T11:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461824",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Other examples include containers like `dict_keys`, `dict_values`, and `dict_items`.



---

archive/issue_comments_461825.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [embray](#comment%3A9):\n> I think changes like this should also include native iterables that were previously functions that returned `list`s, such as `map` and `filter` as well.  Or maybe arbitrary iterables (or at least finite iterables as in `isinstance(x, Iterable) and isinstance(x, Sized)`.  The only problem I've found with this is sometimes it's necessary to take care between specific Sage objects that happen to be iterable, and arbitrary/unknown iterables that should be converted to a list.\n\n\nActually, maybe not `Sized` since a `map` is not `Sized`, and there's no (Pythonic) way to get from a `map` object what its underlying iterators are, so if it were a map of an infinite iterator you run the risk of blowing up, but I guess that's a problem in general as well.",
    "created_at": "2017-12-19T11:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461825",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
Replying to [embray](#comment%3A9):
> I think changes like this should also include native iterables that were previously functions that returned `list`s, such as `map` and `filter` as well.  Or maybe arbitrary iterables (or at least finite iterables as in `isinstance(x, Iterable) and isinstance(x, Sized)`.  The only problem I've found with this is sometimes it's necessary to take care between specific Sage objects that happen to be iterable, and arbitrary/unknown iterables that should be converted to a list.


Actually, maybe not `Sized` since a `map` is not `Sized`, and there's no (Pythonic) way to get from a `map` object what its underlying iterators are, so if it were a map of an infinite iterator you run the risk of blowing up, but I guess that's a problem in general as well.



---

archive/issue_comments_461826.json:
```json
{
    "body": "<a id='comment:12'></a>\nWould a test like `isinstance(x, Iterable) and not isinstance(x, SageObject)` be good enough for most cases of \"arbitrary iterable that is not otherwise meaningful to Sage\"?",
    "created_at": "2017-12-19T12:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461826",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
Would a test like `isinstance(x, Iterable) and not isinstance(x, SageObject)` be good enough for most cases of "arbitrary iterable that is not otherwise meaningful to Sage"?



---

archive/issue_comments_461827.json:
```json
{
    "body": "<a id='comment:13'></a>\nI wish those Python3 containers all have some nice common base class, but they don't. `:/`\n\nUnfortunately, I'm not sure your suggestion in[comment:12](#comment%3A12) would not work because generators are iterable:\n\n```\nsage: g = (x for x in ZZ)\nsage: isinstance(g, collections.Iterable) and not isinstance(g, SageObject)\nTrue\n```\nSo there is no way to guarantee finiteness (right now, I this might be guaranteed for Python object input). Nor do we want strings to be such an object. Granted, we might be able to refine this in a reasonable way, but it will likely be a bit more involved (IDK how much from a quick look).",
    "created_at": "2017-12-19T22:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461827",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>
I wish those Python3 containers all have some nice common base class, but they don't. `:/`

Unfortunately, I'm not sure your suggestion in[comment:12](#comment%3A12) would not work because generators are iterable:

```
sage: g = (x for x in ZZ)
sage: isinstance(g, collections.Iterable) and not isinstance(g, SageObject)
True
```
So there is no way to guarantee finiteness (right now, I this might be guaranteed for Python object input). Nor do we want strings to be such an object. Granted, we might be able to refine this in a reasonable way, but it will likely be a bit more involved (IDK how much from a quick look).



---

archive/issue_comments_461828.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-25T18:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461828",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061647.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-25T18:21:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24384#event-61647"
}
```



---

archive/issue_comments_461829.json:
```json
{
    "body": "Changing branch from \"public/python3/cartesian_product_range-24384\" to \"3725ea9322659a01c284bbccc4aa57774dccf33a\"",
    "created_at": "2017-12-25T18:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461829",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/python3/cartesian_product_range-24384" to "3725ea9322659a01c284bbccc4aa57774dccf33a"



---

archive/issue_comments_461830.json:
```json
{
    "body": "Changing commit from \"3725ea9322659a01c284bbccc4aa57774dccf33a\" to \"\"",
    "created_at": "2018-01-02T14:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461830",
    "user": "https://github.com/embray"
}
```

Changing commit from "3725ea9322659a01c284bbccc4aa57774dccf33a" to ""



---

archive/issue_comments_461831.json:
```json
{
    "body": "<a id='comment:15'></a>\nI'm also annoyed that there isn't a standard ABC in Python for a *finite* iteratable.  We could make our own though.  The problem is that you can't just say it has to have `__len__` because some iterables like `map` aren't *necessarily* finite, but they can be if the iterable they wrap is finite.\n\nSo since there's no way to know absolutely for sure if an iterable is finite I would propose to not worry about it, and if the user provides an infinite iterable that's just as much user error as writing an infinite `while` loop.  It seems to be the only way really, not that I'm happy about it.",
    "created_at": "2018-01-02T14:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24384#issuecomment-461831",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
I'm also annoyed that there isn't a standard ABC in Python for a *finite* iteratable.  We could make our own though.  The problem is that you can't just say it has to have `__len__` because some iterables like `map` aren't *necessarily* finite, but they can be if the iterable they wrap is finite.

So since there's no way to know absolutely for sure if an iterable is finite I would propose to not worry about it, and if the user provides an infinite iterable that's just as much user error as writing an infinite `while` loop.  It seems to be the only way really, not that I'm happy about it.
