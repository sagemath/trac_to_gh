# Issue 24500: Implement actions using _act_ instead of _call_

archive/issues_024263.json:
```json
{
    "body": "We change the internal API of `Action`: instead of the existing `_call_` method, we implement an `_act_` method which always takes `(g, x)` as arguments, where `g` is the acting element and `x` is the acted-on element.\n\nThe current implementation using `_call_` takes a left and right argument. This is less efficient because many actions can be left or right actions. This means that every `_call_` method needs to \"decode\" its arguments as `g` and `x`.\n\nWork on #24247 shows that a significant amount of time is spent in `Action.__call__`. This ticket optimizes that quite a bit. It also adds documentation to `Action`.\n\nCC:  @videlec @tscrim\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nBranch: 3a0958dcb4da8ee91b28163172061666de38bd01\n\nCommit: 3a0958dcb4da8ee91b28163172061666de38bd01\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24500\n\n",
    "closed_at": "2018-11-29T08:13:34Z",
    "created_at": "2018-01-09T14:54:23Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Implement actions using _act_ instead of _call_",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24500",
    "user": "https://github.com/jdemeyer"
}
```
We change the internal API of `Action`: instead of the existing `_call_` method, we implement an `_act_` method which always takes `(g, x)` as arguments, where `g` is the acting element and `x` is the acted-on element.

The current implementation using `_call_` takes a left and right argument. This is less efficient because many actions can be left or right actions. This means that every `_call_` method needs to "decode" its arguments as `g` and `x`.

Work on #24247 shows that a significant amount of time is spent in `Action.__call__`. This ticket optimizes that quite a bit. It also adds documentation to `Action`.

CC:  @videlec @tscrim

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Branch: 3a0958dcb4da8ee91b28163172061666de38bd01

Commit: 3a0958dcb4da8ee91b28163172061666de38bd01

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24500





---

archive/issue_comments_339341.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-30T13:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339341",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339342.json:
```json
{
    "body": "Changing component from performance to coercion.",
    "created_at": "2018-01-30T13:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339342",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from performance to coercion.



---

archive/issue_comments_339343.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-30T13:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339343",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_339344.json:
```json
{
    "body": "<a id='comment:9'></a>Do you have timings with this ticket (at least, my understanding of the description is the \"after\" does not include this ticket)?",
    "created_at": "2018-01-30T19:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339344",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Do you have timings with this ticket (at least, my understanding of the description is the "after" does not include this ticket)?



---

archive/issue_comments_339345.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 tscrim]:\n> Do you have timings with this ticket (at least, my understanding of the description is the \"after\" does not include this ticket)?\n\n\nThe \"after\" does include this ticket.",
    "created_at": "2018-01-30T19:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339345",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [comment:9 tscrim]:
> Do you have timings with this ticket (at least, my understanding of the description is the "after" does not include this ticket)?


The "after" does include this ticket.



---

archive/issue_comments_339346.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 jdemeyer]:\n> The \"after\" does include this ticket.\n\n\nDid you invert the \u201cbefore\u201d and \u201cafter\u201d parts then?",
    "created_at": "2018-01-31T15:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339346",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:12'></a>Replying to [comment:10 jdemeyer]:
> The "after" does include this ticket.


Did you invert the “before” and “after” parts then?



---

archive/issue_comments_339347.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 mmezzarobba]:\n> Did you invert the \u201cbefore\u201d and \u201cafter\u201d parts then?\n\n\nNo, I did not...",
    "created_at": "2018-01-31T15:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339347",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 mmezzarobba]:
> Did you invert the “before” and “after” parts then?


No, I did not...



---

archive/issue_comments_339348.json:
```json
{
    "body": "<a id='comment:14'></a>On 8.2.beta4:\n\n```\nsage: k.<a> = GF(4, impl=\"ntl\"); n = 2; timeit('a ^ n', number=100000, repeat=20)\n100000 loops, best of 20: 343 ns per loop\nsage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)\n100000 loops, best of 20: 137 ns per loop\nsage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)\n10000 loops, best of 20: 7.62 \u00b5s per loop\nsage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)\n10000 loops, best of 20: 7 \u00b5s per loop\n```\nvs with #5574:\n\n```\nsage: k.<a> = GF(4, impl=\"ntl\"); n = 2; timeit('a ^ n', number=100000, repeat=20)\n100000 loops, best of 20: 341 ns per loop\nsage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)\n100000 loops, best of 20: 139 ns per loop\nsage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)\n10000 loops, best of 20: 7.71 \u00b5s per loop\nsage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)\n10000 loops, best of 20: 8.75 \u00b5s per loop\n```\nvs with #24500:\n\n```\nsage: k.<a> = GF(4, impl=\"ntl\"); n = 2; timeit('a ^ n', number=100000, repeat=20)\n100000 loops, best of 20: 356 ns per loop\nsage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)\n100000 loops, best of 20: 141 ns per loop\nsage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)\n10000 loops, best of 20: 7.53 \u00b5s per loop\nsage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)\n10000 loops, best of 20: 8.91 \u00b5s per loop\n```\n\nSo I can explain why the first test is slower: there is an additional `if action._is_left` that is needed to be performed that previously was not there because powering could assume things in a specific order. The last one slowing down is due to #5574 (and some numerical noise). The middle two are almost identical (at least within the numerical noise I was getting), which is expected considering they perform the same number of checks in Cython.\n\nHowever, I did get an improvement when something was calling `is_left()` in Python:\n\n```\nsage: from brial import BooleanMonomialMonoid\nsage: P.<x,y,z> = BooleanPolynomialRing(3)\nsage: M = BooleanMonomialMonoid(P)\nsage: x = M(x); xy = M(x*y); z=M(z); n=2\nsage: timeit('x * n', number=10000, repeat=20)\n10000 loops, best of 20: 6.52 \u00b5s per loop\nsage: timeit('n * x', number=10000, repeat=20)\n10000 loops, best of 20: 6.43 \u00b5s per loop\n```\nvs with #24500\n\n```\nsage: timeit('n * x', number=10000, repeat=20)\n10000 loops, best of 20: 6.14 \u00b5s per loop\nsage: timeit('x * n', number=10000, repeat=20)\n10000 loops, best of 20: 6.17 \u00b5s per loop\n```\n\nSo my conclusion is this ticket does do a little bit of optimizing in certain cases and a regression in others. My current inclination is to give this ticket a positive review because it makes the action interface more clean by removing some of the implementation burden (i.e., deciding which input is which type). Do you agree with my assessment? Anyone else have any objections?",
    "created_at": "2018-02-08T21:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339348",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>On 8.2.beta4:

```
sage: k.<a> = GF(4, impl="ntl"); n = 2; timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 343 ns per loop
sage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 137 ns per loop
sage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7.62 µs per loop
sage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7 µs per loop
```
vs with #5574:

```
sage: k.<a> = GF(4, impl="ntl"); n = 2; timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 341 ns per loop
sage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 139 ns per loop
sage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7.71 µs per loop
sage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 8.75 µs per loop
```
vs with #24500:

```
sage: k.<a> = GF(4, impl="ntl"); n = 2; timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 356 ns per loop
sage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 141 ns per loop
sage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7.53 µs per loop
sage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 8.91 µs per loop
```

So I can explain why the first test is slower: there is an additional `if action._is_left` that is needed to be performed that previously was not there because powering could assume things in a specific order. The last one slowing down is due to #5574 (and some numerical noise). The middle two are almost identical (at least within the numerical noise I was getting), which is expected considering they perform the same number of checks in Cython.

However, I did get an improvement when something was calling `is_left()` in Python:

```
sage: from brial import BooleanMonomialMonoid
sage: P.<x,y,z> = BooleanPolynomialRing(3)
sage: M = BooleanMonomialMonoid(P)
sage: x = M(x); xy = M(x*y); z=M(z); n=2
sage: timeit('x * n', number=10000, repeat=20)
10000 loops, best of 20: 6.52 µs per loop
sage: timeit('n * x', number=10000, repeat=20)
10000 loops, best of 20: 6.43 µs per loop
```
vs with #24500

```
sage: timeit('n * x', number=10000, repeat=20)
10000 loops, best of 20: 6.14 µs per loop
sage: timeit('x * n', number=10000, repeat=20)
10000 loops, best of 20: 6.17 µs per loop
```

So my conclusion is this ticket does do a little bit of optimizing in certain cases and a regression in others. My current inclination is to give this ticket a positive review because it makes the action interface more clean by removing some of the implementation burden (i.e., deciding which input is which type). Do you agree with my assessment? Anyone else have any objections?



---

archive/issue_comments_339349.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-08T09:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339349",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_339350.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-08T09:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339350",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339351.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-08T09:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339351",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_339352.json:
```json
{
    "body": "<a id='comment:18'></a>Many failing tests involving valuations...",
    "created_at": "2018-03-08T09:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339352",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Many failing tests involving valuations...



---

archive/issue_comments_339353.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-08T09:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339353",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_339354.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-08T10:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339354",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339355.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-08T10:02:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339355",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_339356.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-06T08:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339356",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_339357.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-06T09:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339357",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339358.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-06T09:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339358",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_339359.json:
```json
{
    "body": "<a id='comment:24'></a>Part of the slowdown in this ticket was caused by the second commit removing `Set_PythonType`. I'll drop that commit, then the regressions are gone for me.",
    "created_at": "2018-04-06T12:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339359",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Part of the slowdown in this ticket was caused by the second commit removing `Set_PythonType`. I'll drop that commit, then the regressions are gone for me.



---

archive/issue_comments_339360.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-06T12:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339360",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339361.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-11-26T11:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339361",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339362.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-27T02:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339362",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339363.json:
```json
{
    "body": "<a id='comment:28'></a>LGTM. Sorry I let this ticket fall off my radar.",
    "created_at": "2018-11-27T02:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339363",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:28'></a>LGTM. Sorry I let this ticket fall off my radar.



---

archive/issue_events_061808.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-11-27T02:44:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24500#event-61808"
}
```



---

archive/issue_comments_339364.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-29T08:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24500#issuecomment-339364",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061809.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-29T08:13:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24500",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24500#event-61809"
}
```
