# Issue 24960: Fix prime_pi errors and make primecount standard

archive/issues_024723.json:
```json
{
    "body": "The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:\n\n* prime_pi(14783545363230719)\n  returns 408351706116074, it should be 408351706116078\n* prime_pi(5685979153167559)\n  returns 161319877461134, it should be 161319877461136\n* prime_pi(642763101936913)\n  returns 19439675999018, it should be 19439675999019\n\nThe correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.\n\nNote that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning (\"computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values\"), the argument  of the last example is within the range of inputs considered to be safe.\n\nActually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.\n\nAll results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.\n\n| ||| argument |\n|-|||:----------:|\n| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |\n| primecount | 2.99|  11.168| 20.052|\n| primecount --lmo | 5.287| 21.883| 41.286|\n| prime_pi | 331| 2489| 6083|\n---\n\nHere we take the route of replacing Cython code in `sage.functions.prime_pi`\nwith calls to functions in `sage.interface.primecount`\n\nWill be fixed by #32894\n\n\n\n\n\n\nCC:  @slel\n\nKeywords: primes prime_pi primecount\n\nBranch: u/dimpase/functions/prime_pi-fix\n\nDependencies: #25009\n\nCommit: 4f77073aa914209c508cb80d74d3dd4ec52c2c60\n\nResolution: invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/24960\n\n",
    "closed_at": "2021-12-03T18:41:01Z",
    "created_at": "2018-03-12T19:14:43Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Fix prime_pi errors and make primecount standard",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24960",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```
The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:

* prime_pi(14783545363230719)
  returns 408351706116074, it should be 408351706116078
* prime_pi(5685979153167559)
  returns 161319877461134, it should be 161319877461136
* prime_pi(642763101936913)
  returns 19439675999018, it should be 19439675999019

The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.

Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.

Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.

All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.

| ||| argument |
|-|||:----------:|
| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |
| primecount | 2.99|  11.168| 20.052|
| primecount --lmo | 5.287| 21.883| 41.286|
| prime_pi | 331| 2489| 6083|
---

Here we take the route of replacing Cython code in `sage.functions.prime_pi`
with calls to functions in `sage.interface.primecount`

Will be fixed by #32894






CC:  @slel

Keywords: primes prime_pi primecount

Branch: u/dimpase/functions/prime_pi-fix

Dependencies: #25009

Commit: 4f77073aa914209c508cb80d74d3dd4ec52c2c60

Resolution: invalid

Issue created by migration from https://trac.sagemath.org/ticket/24960





---

archive/issue_comments_369458.json:
```json
{
    "body": "<a id='comment:1'></a>Could you add timings in the ticket description? Did you check with PARI/GP?\n\nFirst step would be to make primecount a proper optional package and interface it. In a second time it can be discussed whether this needs to be a standard package (ie coming with default Sage installation). As a parallel task, the fact that `prime_pi` is wrong is really bad and could be temporarilly fixed with a [stopgap http://doc.sagemath.org/html/en/reference/misc/sage/misc/stopgap.html].",
    "created_at": "2018-03-13T08:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369458",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>Could you add timings in the ticket description? Did you check with PARI/GP?

First step would be to make primecount a proper optional package and interface it. In a second time it can be discussed whether this needs to be a standard package (ie coming with default Sage installation). As a parallel task, the fact that `prime_pi` is wrong is really bad and could be temporarilly fixed with a [stopgap http://doc.sagemath.org/html/en/reference/misc/sage/misc/stopgap.html].



---

archive/issue_comments_369459.json:
```json
{
    "body": "<a id='comment:2'></a>See #24966 for actually packaging primecount.",
    "created_at": "2018-03-13T16:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369459",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>See #24966 for actually packaging primecount.



---

archive/issue_comments_369460.json:
```json
{
    "body": "<a id='comment:3'></a>I changed the description of the ticket adding execution times. I did not try using Pari/GP because Pari primepi function is very very slow (at least until the latest release, there is some minor improvement in the development code). It works by enumerating one by one all prime numbers, together with a table of pre-computed values. Just to give an example, although primepi(200000000507)=8007105083 is pre-computed. computing primepi(251000000000) requires 372 seconds, while [SageMath](SageMath) and primecount only take less than a second.",
    "created_at": "2018-03-14T08:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369460",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

<a id='comment:3'></a>I changed the description of the ticket adding execution times. I did not try using Pari/GP because Pari primepi function is very very slow (at least until the latest release, there is some minor improvement in the development code). It works by enumerating one by one all prime numbers, together with a table of pre-computed values. Just to give an example, although primepi(200000000507)=8007105083 is pre-computed. computing primepi(251000000000) requires 372 seconds, while [SageMath](SageMath) and primecount only take less than a second.



---

archive/issue_comments_369461.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -11,9 +11,18 @@\n \n Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning (\"computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values\"), the argument  of the last example is within the range of inputs considered to be safe.\n \n-Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code.\n+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The following table compares the execution times of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.\n \n-Keywords: primes prime_pi\n+| ||| argument |\n+|-|||:----------:|\n+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |\n+| primecount | 2.99|  11.168| 20.052|\n+| primecount --lmo | 5.287| 21.883| 41.286|\n+| primepi | 331| 2489| 6083|\n+\n+\n+\n+\n \n Comment: 1\n \n```\n",
    "created_at": "2018-03-14T08:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369461",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

Description changed:
```diff
--- 
+++ 
@@ -11,9 +11,18 @@
 
 Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.
 
-Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code.
+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The following table compares the execution times of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.
 
-Keywords: primes prime_pi
+| ||| argument |
+|-|||:----------:|
+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |
+| primecount | 2.99|  11.168| 20.052|
+| primecount --lmo | 5.287| 21.883| 41.286|
+| primepi | 331| 2489| 6083|
+
+
+
+
 
 Comment: 1
 
```




---

archive/issue_comments_369462.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,29 @@\n+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:\n+\n+* prime_pi(14783545363230719)\n+  returns 408351706116074, it should be 408351706116078\n+* prime_pi(5685979153167559)\n+  returns 161319877461134, it should be 161319877461136\n+* prime_pi(642763101936913)\n+  returns 19439675999018, it should be 19439675999019\n+\n+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. (not. All of them return the same result.\n+\n+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning (\"computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values\"), the argument  of the last example is within the range of inputs considered to be safe.\n+\n+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.\n+\n+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.\n+\n+| ||| argument |\n+|-|||:----------:|\n+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |\n+| primecount | 2.99|  11.168| 20.052|\n+| primecount --lmo | 5.287| 21.883| 41.286|\n+| primepi | 331| 2489| 6083|\n+\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2018-03-14T08:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369462",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,29 @@
+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:
+
+* prime_pi(14783545363230719)
+  returns 408351706116074, it should be 408351706116078
+* prime_pi(5685979153167559)
+  returns 161319877461134, it should be 161319877461136
+* prime_pi(642763101936913)
+  returns 19439675999018, it should be 19439675999019
+
+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. (not. All of them return the same result.
+
+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.
+
+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.
+
+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.
+
+| ||| argument |
+|-|||:----------:|
+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |
+| primecount | 2.99|  11.168| 20.052|
+| primecount --lmo | 5.287| 21.883| 41.286|
+| primepi | 331| 2489| 6083|
+
+
+
 
 
 Comment: 1
```




---

archive/issue_comments_369463.json:
```json
{
    "body": "<a id='comment:4'></a>Added some context information to the ticket description.",
    "created_at": "2018-03-14T08:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369463",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

<a id='comment:4'></a>Added some context information to the ticket description.



---

archive/issue_comments_369464.json:
```json
{
    "body": "<a id='comment:5'></a>When I wrote the current `prime_pi` code, there was no open source implementations of fast prime counting. I agree that the best long term solution is to use the `primecount` library.",
    "created_at": "2018-03-14T22:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369464",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:5'></a>When I wrote the current `prime_pi` code, there was no open source implementations of fast prime counting. I agree that the best long term solution is to use the `primecount` library.



---

archive/issue_comments_369465.json:
```json
{
    "body": "<a id='comment:6'></a>Fixed typos.",
    "created_at": "2018-03-14T23:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369465",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

<a id='comment:6'></a>Fixed typos.



---

archive/issue_comments_369466.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,29 @@\n+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:\n+\n+* prime_pi(14783545363230719)\n+  returns 408351706116074, it should be 408351706116078\n+* prime_pi(5685979153167559)\n+  returns 161319877461134, it should be 161319877461136\n+* prime_pi(642763101936913)\n+  returns 19439675999018, it should be 19439675999019\n+\n+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.\n+\n+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning (\"computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values\"), the argument  of the last example is within the range of inputs considered to be safe.\n+\n+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.\n+\n+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.\n+\n+| ||| argument |\n+|-|||:----------:|\n+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |\n+| primecount | 2.99|  11.168| 20.052|\n+| primecount --lmo | 5.287| 21.883| 41.286|\n+| prime_pi | 331| 2489| 6083|\n+\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2018-03-14T23:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369466",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,29 @@
+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:
+
+* prime_pi(14783545363230719)
+  returns 408351706116074, it should be 408351706116078
+* prime_pi(5685979153167559)
+  returns 161319877461134, it should be 161319877461136
+* prime_pi(642763101936913)
+  returns 19439675999018, it should be 19439675999019
+
+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.
+
+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.
+
+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.
+
+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.
+
+| ||| argument |
+|-|||:----------:|
+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |
+| primecount | 2.99|  11.168| 20.052|
+| primecount --lmo | 5.287| 21.883| 41.286|
+| prime_pi | 331| 2489| 6083|
+
+
+
 
 
 Comment: 1
```




---

archive/issue_comments_369467.json:
```json
{
    "body": "<a id='comment:8'></a>I can confirm the behavior of the last example\n\n```\nsage: %time prime_pi(642763101936913)\nCPU times: user 4min 29s, sys: 16.1 ms, total: 4min 29s\nWall time: 4min 29s\n19439675999018\n```\nand thanks to #24966 this can be checked with\n\n```\nsage: from sage.interfaces import primecount\nsage: %time primecount.prime_pi(642763101936913)\nCPU times: user 4.88 s, sys: 61.8 ms, total: 4.94 s\nWall time: 1.24 s\n19439675999019\n```",
    "created_at": "2018-06-09T12:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369467",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>I can confirm the behavior of the last example

```
sage: %time prime_pi(642763101936913)
CPU times: user 4min 29s, sys: 16.1 ms, total: 4min 29s
Wall time: 4min 29s
19439675999018
```
and thanks to #24966 this can be checked with

```
sage: from sage.interfaces import primecount
sage: %time primecount.prime_pi(642763101936913)
CPU times: user 4.88 s, sys: 61.8 ms, total: 4.94 s
Wall time: 1.24 s
19439675999019
```



---

archive/issue_comments_369468.json:
```json
{
    "body": "<a id='comment:9'></a>Since primecount has been an optional package for several years, maybe it would be a good idea to upgrade it to standard and just call it?",
    "created_at": "2021-11-12T20:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369468",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:9'></a>Since primecount has been an optional package for several years, maybe it would be a good idea to upgrade it to standard and just call it?



---

archive/issue_comments_369469.json:
```json
{
    "body": "<a id='comment:10'></a>Or if nobody has time to work on this, maybe somebody could replace the message \"\"computation of prime_pi for `x >= 2^50` has not been as thoroughly tested as for smaller values\", which is only triggered for large input, by a similar message triggered by any `x >= 10^6` say?  The message could be \"computation of prime_pi has known bugs (see #24960)\".",
    "created_at": "2021-11-12T20:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369469",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:10'></a>Or if nobody has time to work on this, maybe somebody could replace the message ""computation of prime_pi for `x >= 2^50` has not been as thoroughly tested as for smaller values", which is only triggered for large input, by a similar message triggered by any `x >= 10^6` say?  The message could be "computation of prime_pi has known bugs (see #24960)".



---

archive/issue_comments_369470.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 mmarco]:\n> Since primecount has been an optional package for several years, maybe it would be a good idea to upgrade it to standard and just call it?\n\n\n\nOf course, in that case we should reconsider #32412",
    "created_at": "2021-11-12T20:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369470",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:11'></a>Replying to [comment:9 mmarco]:
> Since primecount has been an optional package for several years, maybe it would be a good idea to upgrade it to standard and just call it?



Of course, in that case we should reconsider #32412



---

archive/issue_comments_369471.json:
```json
{
    "body": "<a id='comment:12'></a>I think we should upgrade `primecount` spkg and use it in `prime_pi`. And revert #32412",
    "created_at": "2021-11-12T22:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369471",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>I think we should upgrade `primecount` spkg and use it in `prime_pi`. And revert #32412



---

archive/issue_comments_369472.json:
```json
{
    "body": "<a id='comment:13'></a>See #32412#comment:7 for how to do the primecount Cython interfaces properly",
    "created_at": "2021-11-12T22:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369472",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>See #32412#comment:7 for how to do the primecount Cython interfaces properly



---

archive/issue_comments_369473.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:12 dimpase]:\n> I think we should upgrade `primecount` spkg and use it in `prime_pi`. And revert #32412\n\n+1\n\nThe difference in speed in huge. Not to mention the correctness.\n\nIs the cmake dependency really a no-go for making it standard?",
    "created_at": "2021-11-12T23:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369473",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:14'></a>Replying to [comment:12 dimpase]:
> I think we should upgrade `primecount` spkg and use it in `prime_pi`. And revert #32412

+1

The difference in speed in huge. Not to mention the correctness.

Is the cmake dependency really a no-go for making it standard?



---

archive/issue_comments_369474.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 mmarco]:\n> Is the cmake dependency really a no-go for making it standard?\n\n\nNo, that's outdated. `cmake` is a standard package now.",
    "created_at": "2021-11-12T23:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369474",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Replying to [comment:14 mmarco]:
> Is the cmake dependency really a no-go for making it standard?


No, that's outdated. `cmake` is a standard package now.



---

archive/issue_comments_369475.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:13 mkoeppe]:\n> See #32412#comment:7 for how to do the primecount Cython interfaces properly\n\n\nSo we should move the current cython code to a pip package, and then instruct sage to pip-install it instead of using a sage SPKG?",
    "created_at": "2021-11-14T16:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369475",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:16'></a>Replying to [comment:13 mkoeppe]:
> See #32412#comment:7 for how to do the primecount Cython interfaces properly


So we should move the current cython code to a pip package, and then instruct sage to pip-install it instead of using a sage SPKG?



---

archive/issue_comments_369476.json:
```json
{
    "body": "<a id='comment:17'></a>Yes, either the current cython code should become a pip-installable package; or switch to using https://pypi.org/project/primecount/ (but see https://github.com/hearot/primecount-python/issues/3).\n\nThe pip-installable package can then become an SPKG.",
    "created_at": "2021-11-14T17:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369476",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Yes, either the current cython code should become a pip-installable package; or switch to using https://pypi.org/project/primecount/ (but see https://github.com/hearot/primecount-python/issues/3).

The pip-installable package can then become an SPKG.



---

archive/issue_comments_369477.json:
```json
{
    "body": "<a id='comment:18'></a>I think it's more urgent to provide a bug-free `prime_pi` than to package the implementation nicely.",
    "created_at": "2021-11-14T22:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369477",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>I think it's more urgent to provide a bug-free `prime_pi` than to package the implementation nicely.



---

archive/issue_comments_369478.json:
```json
{
    "body": "<a id='comment:19'></a>It's 10 minutes of work to package it.",
    "created_at": "2021-11-14T22:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369478",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>It's 10 minutes of work to package it.



---

archive/issue_comments_369479.json:
```json
{
    "body": "<a id='comment:20'></a>if you know what to do, yes. \nif not, who knows.",
    "created_at": "2021-11-14T23:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369479",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>if you know what to do, yes. 
if not, who knows.



---

archive/issue_comments_369480.json:
```json
{
    "body": "<a id='comment:21'></a>In this case, one copies and adjusts something that works, such as https://github.com/sagemath/memory_allocator",
    "created_at": "2021-11-14T23:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369480",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>In this case, one copies and adjusts something that works, such as https://github.com/sagemath/memory_allocator



---

archive/issue_comments_369481.json:
```json
{
    "body": "<a id='comment:22'></a>I've posted some not yet complete thing on #25009",
    "created_at": "2021-11-15T11:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369481",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>I've posted some not yet complete thing on #25009



---

archive/issue_comments_369482.json:
```json
{
    "body": "<a id='comment:23'></a>A quick thing would be to put a deprecation warning in `prime_pi` et al., telling users to use `prime_pi` from `primecount` instead. Would this be acceptable way to resolve this ticket?\n(note that also `prime_pi` has 2nd optional parameter, and providing an implementation for it would be work...)\n\nAnd then it can be just removed, witin a year or so.",
    "created_at": "2021-11-16T11:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369482",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>A quick thing would be to put a deprecation warning in `prime_pi` et al., telling users to use `prime_pi` from `primecount` instead. Would this be acceptable way to resolve this ticket?
(note that also `prime_pi` has 2nd optional parameter, and providing an implementation for it would be work...)

And then it can be just removed, witin a year or so.



---

archive/issue_events_062639.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-11-16T11:18:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24960#event-62639"
}
```



---

archive/issue_comments_369483.json:
```json
{
    "body": "<a id='comment:25'></a>I don't understand in all the details what the second parameter of `prime_pi` does, but in any case it just changes the inner workings of the function, not its input/output behavior. Therefore, I think that, when implemented trough `primecount`, it would be possible to just keep the second parameter for compatibility reasons but ignore its value.",
    "created_at": "2021-11-16T11:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369483",
    "user": "https://trac.sagemath.org/admin/accounts/users/gianluca.amato.74"
}
```

<a id='comment:25'></a>I don't understand in all the details what the second parameter of `prime_pi` does, but in any case it just changes the inner workings of the function, not its input/output behavior. Therefore, I think that, when implemented trough `primecount`, it would be possible to just keep the second parameter for compatibility reasons but ignore its value.



---

archive/issue_comments_369484.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-16T14:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369484",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369485.json:
```json
{
    "body": "<a id='comment:26'></a>one has to decide what to do with the optional (usless) 2nd parameter to `prime_pi()`\n\n---\nNew commits:",
    "created_at": "2021-11-16T14:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369485",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>one has to decide what to do with the optional (usless) 2nd parameter to `prime_pi()`

---
New commits:



---

archive/issue_comments_369486.json:
```json
{
    "body": "Changing keywords from \"primes prime_pi\" to \"primes prime_pi primecount\".",
    "created_at": "2021-11-16T19:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369486",
    "user": "https://github.com/slel"
}
```

Changing keywords from "primes prime_pi" to "primes prime_pi primecount".



---

archive/issue_comments_369487.json:
```json
{
    "body": "<a id='comment:28'></a>should `primecount` to be added to dependencies of, hmm, `sagelib` ? \nBecause on a slow 32-bit machine I see how building docs is failing (if I start `make ptest` right after `./configure`), as it needs `prime_pi`, which in turn depends on `primecount`, or, more precisely, on `sage.interfaces.primecount`.",
    "created_at": "2021-11-16T20:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369487",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>should `primecount` to be added to dependencies of, hmm, `sagelib` ? 
Because on a slow 32-bit machine I see how building docs is failing (if I start `make ptest` right after `./configure`), as it needs `prime_pi`, which in turn depends on `primecount`, or, more precisely, on `sage.interfaces.primecount`.



---

archive/issue_comments_369488.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,34 @@\n+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:\n+\n+* prime_pi(14783545363230719)\n+  returns 408351706116074, it should be 408351706116078\n+* prime_pi(5685979153167559)\n+  returns 161319877461134, it should be 161319877461136\n+* prime_pi(642763101936913)\n+  returns 19439675999018, it should be 19439675999019\n+\n+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.\n+\n+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning (\"computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values\"), the argument  of the last example is within the range of inputs considered to be safe.\n+\n+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.\n+\n+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.\n+\n+| ||| argument |\n+|-|||:----------:|\n+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |\n+| primecount | 2.99|  11.168| 20.052|\n+| primecount --lmo | 5.287| 21.883| 41.286|\n+| prime_pi | 331| 2489| 6083|\n+---\n+\n+Here we take the route of replacing Cython code in `sage.functions.prime_pi`\n+with calls to functions in `sage.interface.primecount`\n+\n+\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-16T20:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369488",
    "user": "https://github.com/dimpase"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,34 @@
+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:
+
+* prime_pi(14783545363230719)
+  returns 408351706116074, it should be 408351706116078
+* prime_pi(5685979153167559)
+  returns 161319877461134, it should be 161319877461136
+* prime_pi(642763101936913)
+  returns 19439675999018, it should be 19439675999019
+
+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.
+
+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.
+
+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.
+
+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.
+
+| ||| argument |
+|-|||:----------:|
+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |
+| primecount | 2.99|  11.168| 20.052|
+| primecount --lmo | 5.287| 21.883| 41.286|
+| prime_pi | 331| 2489| 6083|
+---
+
+Here we take the route of replacing Cython code in `sage.functions.prime_pi`
+with calls to functions in `sage.interface.primecount`
+
+
+
+
 
 
 Comment: 1
```




---

archive/issue_comments_369489.json:
```json
{
    "body": "<a id='comment:30'></a>comment:21.",
    "created_at": "2021-11-16T20:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369489",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>comment:21.



---

archive/issue_comments_369490.json:
```json
{
    "body": "<a id='comment:31'></a>I finally built and tested this on a 32-bit host, the only one test error there, it is due to a different error message, `int is too big` vs `Python int is too big`.\n\nNeeds some dots to be added.",
    "created_at": "2021-11-16T20:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369490",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>I finally built and tested this on a 32-bit host, the only one test error there, it is due to a different error message, `int is too big` vs `Python int is too big`.

Needs some dots to be added.



---

archive/issue_comments_369491.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:30 mkoeppe]:\n> comment:21.\n\nI don't understand, do you mean that `primecount` is the only package that needs this treatment?",
    "created_at": "2021-11-16T20:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369491",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>Replying to [comment:30 mkoeppe]:
> comment:21.

I don't understand, do you mean that `primecount` is the only package that needs this treatment?



---

archive/issue_comments_369492.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-16T21:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369492",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369493.json:
```json
{
    "body": "<a id='comment:34'></a>Do we also need\n\n```diff\n--- a/build/pkgs/sagelib/dependencies\n+++ b/build/pkgs/sagelib/dependencies\n@@ -1,4 +1,4 @@\n-FORCE $(SCRIPTS) arb boost_cropped $(BLAS) brial cliquer cypari cysignals cython ecl eclib ecm flint libgd gap giac givaro glpk gmpy2 gsl iml jinja2 jupyter_core lcalc lrcalc libbraiding libhomfly libpng linbox m4ri m4rie memory_allocator mpc mpfi mpfr $(MP_LIBRARY) ntl numpy pari pip pkgconfig planarity ppl pplpy pycygwin $(PYTHON) ratpoints rw sage_conf singular symmetrica zn_poly $(PCFILES) | $(PYTHON_TOOLCHAIN) sage_setup\n+FORCE $(SCRIPTS) arb boost_cropped $(BLAS) brial cliquer cypari cysignals cython ecl eclib ecm flint libgd gap giac givaro glpk gmpy2 gsl iml jinja2 jupyter_core lcalc lrcalc libbraiding libhomfly libpng linbox m4ri m4rie memory_allocator mpc mpfi mpfr $(MP_LIBRARY) ntl numpy pari pip pkgconfig planarity ppl pplpy primecount pycygwin $(PYTHON) ratpoints rw sage_conf singular symmetrica zn_poly $(PCFILES) | $(PYTHON_TOOLCHAIN) sage_setup\n \n ----------\n All lines of this file are ignored except the first.\ndiff --git a/src/pyproject.toml.m4 b/src/pyproject.toml.m4\nindex 125da7ac1c..6b6402884a 100644\n--- a/src/pyproject.toml.m4\n+++ b/src/pyproject.toml.m4\n@@ -18,6 +18,7 @@ requires = [\n         numpy          \\\n         pkgconfig      \\\n         pplpy          \\\n+        primecount     \\\n         memory_allocator \\\n                     ')]\n build-backend = \"setuptools.build_meta\"\n```\nto avoid possible races? Still, this does not seem to be relevant for the issue in comment:28.",
    "created_at": "2021-11-16T21:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369493",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>Do we also need

```diff
--- a/build/pkgs/sagelib/dependencies
+++ b/build/pkgs/sagelib/dependencies
@@ -1,4 +1,4 @@
-FORCE $(SCRIPTS) arb boost_cropped $(BLAS) brial cliquer cypari cysignals cython ecl eclib ecm flint libgd gap giac givaro glpk gmpy2 gsl iml jinja2 jupyter_core lcalc lrcalc libbraiding libhomfly libpng linbox m4ri m4rie memory_allocator mpc mpfi mpfr $(MP_LIBRARY) ntl numpy pari pip pkgconfig planarity ppl pplpy pycygwin $(PYTHON) ratpoints rw sage_conf singular symmetrica zn_poly $(PCFILES) | $(PYTHON_TOOLCHAIN) sage_setup
+FORCE $(SCRIPTS) arb boost_cropped $(BLAS) brial cliquer cypari cysignals cython ecl eclib ecm flint libgd gap giac givaro glpk gmpy2 gsl iml jinja2 jupyter_core lcalc lrcalc libbraiding libhomfly libpng linbox m4ri m4rie memory_allocator mpc mpfi mpfr $(MP_LIBRARY) ntl numpy pari pip pkgconfig planarity ppl pplpy primecount pycygwin $(PYTHON) ratpoints rw sage_conf singular symmetrica zn_poly $(PCFILES) | $(PYTHON_TOOLCHAIN) sage_setup
 
 ----------
 All lines of this file are ignored except the first.
diff --git a/src/pyproject.toml.m4 b/src/pyproject.toml.m4
index 125da7ac1c..6b6402884a 100644
--- a/src/pyproject.toml.m4
+++ b/src/pyproject.toml.m4
@@ -18,6 +18,7 @@ requires = [
         numpy          \
         pkgconfig      \
         pplpy          \
+        primecount     \
         memory_allocator \
                     ')]
 build-backend = "setuptools.build_meta"
```
to avoid possible races? Still, this does not seem to be relevant for the issue in comment:28.



---

archive/issue_comments_369494.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:32 dimpase]:\n> Replying to [comment:30 mkoeppe]:\n> > comment:21.\n\n> I don't understand, do you mean that `primecount` is the only package that needs this treatment?\n\nYou were asking how to do dependencies right. The answer is: The bindings need to go into a separate Python package -- that will look just like `memory_allocator`. In this way, `sagelib` will not acquire another compile-time dependency. Modularization = do not pile on additional compile-time dependencies.",
    "created_at": "2021-11-16T22:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369494",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Replying to [comment:32 dimpase]:
> Replying to [comment:30 mkoeppe]:
> > comment:21.

> I don't understand, do you mean that `primecount` is the only package that needs this treatment?

You were asking how to do dependencies right. The answer is: The bindings need to go into a separate Python package -- that will look just like `memory_allocator`. In this way, `sagelib` will not acquire another compile-time dependency. Modularization = do not pile on additional compile-time dependencies.



---

archive/issue_comments_369495.json:
```json
{
    "body": "<a id='comment:36'></a>I think we're talking about different issues. I saw an error during docbuild stage which came from\n`src/sage/interfaces/primecount.pyx` not yet built at that moment. The external library spkg `primecount` was already built at that moment.",
    "created_at": "2021-11-16T22:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369495",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>I think we're talking about different issues. I saw an error during docbuild stage which came from
`src/sage/interfaces/primecount.pyx` not yet built at that moment. The external library spkg `primecount` was already built at that moment.



---

archive/issue_comments_369496.json:
```json
{
    "body": "<a id='comment:37'></a>As I have explained, `src/sage/interfaces/primecount.pyx` should not be part of sagelib. This is why it was deprecated!",
    "created_at": "2021-11-16T22:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369496",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>As I have explained, `src/sage/interfaces/primecount.pyx` should not be part of sagelib. This is why it was deprecated!



---

archive/issue_comments_369497.json:
```json
{
    "body": "<a id='comment:38'></a>I asked you whether it's the only Cython file out there left that should not be a part of sagelib.\nYou didn't reply - I assume this means it is not. \n\nI don't have mental capacity now to learn the ideal modern design, I just want this ticket done in the most direct way.\nModularisation can be done on another ticket.",
    "created_at": "2021-11-16T22:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369497",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>I asked you whether it's the only Cython file out there left that should not be a part of sagelib.
You didn't reply - I assume this means it is not. 

I don't have mental capacity now to learn the ideal modern design, I just want this ticket done in the most direct way.
Modularisation can be done on another ticket.



---

archive/issue_comments_369498.json:
```json
{
    "body": "<a id='comment:39'></a>I was relieved today from teaching computer graphics next term, so I have some spare mental capacity now :-)\n\nNote that `src/sage/functions/prime_pi.pyx` relies heavily on `sagelib` (e.g. on SR). \n\nWhat does not rely on sagelib (or on Sage at all) is  `src/sage/interfaces/primecount.pyx`, \nwhich is not even touched by this ticket (it's touched by  #25009).\n \nThe latter indeed can be spun off, modelling on `memory_allocator`\n(I suppose after it's done, one would only need to change one import statement in `src/sage/functions/prime_pi.pyx`.)",
    "created_at": "2021-11-17T14:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369498",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>I was relieved today from teaching computer graphics next term, so I have some spare mental capacity now :-)

Note that `src/sage/functions/prime_pi.pyx` relies heavily on `sagelib` (e.g. on SR). 

What does not rely on sagelib (or on Sage at all) is  `src/sage/interfaces/primecount.pyx`, 
which is not even touched by this ticket (it's touched by  #25009).
 
The latter indeed can be spun off, modelling on `memory_allocator`
(I suppose after it's done, one would only need to change one import statement in `src/sage/functions/prime_pi.pyx`.)



---

archive/issue_comments_369499.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-11-25T12:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369499",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_369500.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,36 @@\n+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:\n+\n+* prime_pi(14783545363230719)\n+  returns 408351706116074, it should be 408351706116078\n+* prime_pi(5685979153167559)\n+  returns 161319877461134, it should be 161319877461136\n+* prime_pi(642763101936913)\n+  returns 19439675999018, it should be 19439675999019\n+\n+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.\n+\n+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning (\"computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values\"), the argument  of the last example is within the range of inputs considered to be safe.\n+\n+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.\n+\n+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.\n+\n+| ||| argument |\n+|-|||:----------:|\n+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |\n+| primecount | 2.99|  11.168| 20.052|\n+| primecount --lmo | 5.287| 21.883| 41.286|\n+| prime_pi | 331| 2489| 6083|\n+---\n+\n+Here we take the route of replacing Cython code in `sage.functions.prime_pi`\n+with calls to functions in `sage.interface.primecount`\n+\n+Will be fixed by #32894\n+\n+\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-25T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369500",
    "user": "https://github.com/dimpase"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,36 @@
+The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:
+
+* prime_pi(14783545363230719)
+  returns 408351706116074, it should be 408351706116078
+* prime_pi(5685979153167559)
+  returns 161319877461134, it should be 161319877461136
+* prime_pi(642763101936913)
+  returns 19439675999018, it should be 19439675999019
+
+The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. All of them return the same result.
+
+Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.
+
+Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code. The table below compares the execution times (in seconds) of primecount with Deleglise-Rivat, primecount with Lagarias-Miller-Odlyzko and [SageMath](SageMath) prime_pi function.
+
+All results have been obtained with an Intel i5-2500K. For primecount, a single thread has been used.
+
+| ||| argument |
+|-|||:----------:|
+| algorithm | 642763101936913 | 5685979153167559 | 14783545363230719 |
+| primecount | 2.99|  11.168| 20.052|
+| primecount --lmo | 5.287| 21.883| 41.286|
+| prime_pi | 331| 2489| 6083|
+---
+
+Here we take the route of replacing Cython code in `sage.functions.prime_pi`
+with calls to functions in `sage.interface.primecount`
+
+Will be fixed by #32894
+
+
+
+
 
 
 Comment: 1
```




---

archive/issue_events_062640.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-11-25T13:47:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24960#event-62640"
}
```



---

archive/issue_events_062641.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-11-25T13:47:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24960#event-62641"
}
```



---

archive/issue_comments_369501.json:
```json
{
    "body": "<a id='comment:41'></a>we will proceed with this on #32894, which includes commits on this ticket's branch.",
    "created_at": "2021-11-25T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369501",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>we will proceed with this on #32894, which includes commits on this ticket's branch.



---

archive/issue_comments_369502.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-02T18:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369502",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_369503.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-12-03T18:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24960#issuecomment-369503",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_062642.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-03T18:41:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24960",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24960#event-62642"
}
```
