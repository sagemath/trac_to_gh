# Issue 24870: Ignored OSErrors in test output on Cygwin

archive/issues_024870.json:
```json
{
    "body": "When running the test suite on Cygwin, whether a test passes or fails the test log is full (for each test module of output like):\n\n```\nsage -t --long src/sage/interfaces/gap.py\nException OSError: (2, 'No such file or directory', '/tmp/tmpwVkVtd') in <bound method _TemporaryFileWrapper.__del__ of <closed file '<fdopen>', mode 'w+b' at 0x6f8032f1e40>> ignored\n    [224 tests, 49.25 s]\n```\n\nin particular this of course causes tests of the doctest runner itself to fail, and it's also making all the patchbot runs fail.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25107\n\n",
    "closed_at": "2018-04-14T18:04:59Z",
    "created_at": "2018-04-06T13:56:19Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Ignored OSErrors in test output on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24870",
    "user": "https://github.com/embray"
}
```
When running the test suite on Cygwin, whether a test passes or fails the test log is full (for each test module of output like):

```
sage -t --long src/sage/interfaces/gap.py
Exception OSError: (2, 'No such file or directory', '/tmp/tmpwVkVtd') in <bound method _TemporaryFileWrapper.__del__ of <closed file '<fdopen>', mode 'w+b' at 0x6f8032f1e40>> ignored
    [224 tests, 49.25 s]
```

in particular this of course causes tests of the doctest runner itself to fail, and it's also making all the patchbot runs fail.

Issue created by migration from https://trac.sagemath.org/ticket/25107





---

archive/issue_comments_349109.json:
```json
{
    "body": "I suspect this probably started with #24343 somehow.",
    "created_at": "2018-04-06T14:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349109",
    "user": "https://github.com/embray"
}
```

I suspect this probably started with #24343 somehow.



---

archive/issue_comments_349110.json:
```json
{
    "body": "Obvious question: is it a Sage or Python bug? I don't have a high opinion of Python's `tempfile` module, it had caused problems in the past.",
    "created_at": "2018-04-06T15:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349110",
    "user": "https://github.com/jdemeyer"
}
```

Obvious question: is it a Sage or Python bug? I don't have a high opinion of Python's `tempfile` module, it had caused problems in the past.



---

archive/issue_comments_349111.json:
```json
{
    "body": "It's kind of a Python bug.  I've actually been bitten by this issue before, but before #24343 it was more random and somewhat uncommon.  The changes in #24343 (e.g. explicitly closing files more often) made the problem guaranteed to occur.",
    "created_at": "2018-04-06T16:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349111",
    "user": "https://github.com/embray"
}
```

It's kind of a Python bug.  I've actually been bitten by this issue before, but before #24343 it was more random and somewhat uncommon.  The changes in #24343 (e.g. explicitly closing files more often) made the problem guaranteed to occur.



---

archive/issue_comments_349112.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-06T16:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349112",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_349113.json:
```json
{
    "body": "This should resolve the issue for now--considering that this is a blocker AFAIC this workaround should be good enough for now.  In the meantime I would like to continue to rethink this code and how it handles files.\n\n---\nNew commits:",
    "created_at": "2018-04-06T16:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349113",
    "user": "https://github.com/embray"
}
```

This should resolve the issue for now--considering that this is a blocker AFAIC this workaround should be good enough for now.  In the meantime I would like to continue to rethink this code and how it handles files.

---
New commits:



---

archive/issue_comments_349114.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-06T16:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349114",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_349115.json:
```json
{
    "body": "Oops, rebased on correct branch.",
    "created_at": "2018-04-06T16:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349115",
    "user": "https://github.com/embray"
}
```

Oops, rebased on correct branch.



---

archive/issue_comments_349116.json:
```json
{
    "body": "Can you wrap it in a if-cygwin branch instead of making assumptions about which temp file implementation is used?",
    "created_at": "2018-04-09T17:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349116",
    "user": "https://github.com/vbraun"
}
```

Can you wrap it in a if-cygwin branch instead of making assumptions about which temp file implementation is used?



---

archive/issue_comments_349117.json:
```json
{
    "body": "It's not making assumptions--as written it's making a feature check that isn't *necessarily* platform specific, which is usually preferable.",
    "created_at": "2018-04-10T07:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349117",
    "user": "https://github.com/embray"
}
```

It's not making assumptions--as written it's making a feature check that isn't *necessarily* platform specific, which is usually preferable.



---

archive/issue_comments_349118.json:
```json
{
    "body": "Do we really need to close the file there? Maybe a different and simpler solution would be to just remove that `self.outtmpfile.close()`.",
    "created_at": "2018-04-12T14:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349118",
    "user": "https://github.com/jdemeyer"
}
```

Do we really need to close the file there? Maybe a different and simpler solution would be to just remove that `self.outtmpfile.close()`.



---

archive/issue_comments_349119.json:
```json
{
    "body": "I alluded to this in [#comment:3 3] but the file will be deleted when the object is closed anyways, whether that close is explicit, or comes sometime later when the object goes out of scope and its `__del__` is called.  Explicitly closing ensures things happen predictably, and not doing so is not a solution to the actual problem.\n\nAnyways, that was added for avoiding `ResourceWarning`s on Python 3.",
    "created_at": "2018-04-12T16:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349119",
    "user": "https://github.com/embray"
}
```

I alluded to this in [#comment:3 3] but the file will be deleted when the object is closed anyways, whether that close is explicit, or comes sometime later when the object goes out of scope and its `__del__` is called.  Explicitly closing ensures things happen predictably, and not doing so is not a solution to the actual problem.

Anyways, that was added for avoiding `ResourceWarning`s on Python 3.



---

archive/issue_comments_349120.json:
```json
{
    "body": "OK, I think I understand the reasons now, but it wasn't obvious from reading the code (including the comments). So I agree with the fix, but the comment should be improved. I'll think about that tomorrow.",
    "created_at": "2018-04-12T19:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349120",
    "user": "https://github.com/jdemeyer"
}
```

OK, I think I understand the reasons now, but it wasn't obvious from reading the code (including the comments). So I agree with the fix, but the comment should be improved. I'll think about that tomorrow.



---

archive/issue_comments_349121.json:
```json
{
    "body": "The real problem is that the file is closed twice: once in the master process and once in the child. It can only be deleted once.",
    "created_at": "2018-04-12T19:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349121",
    "user": "https://github.com/jdemeyer"
}
```

The real problem is that the file is closed twice: once in the master process and once in the child. It can only be deleted once.



---

archive/issue_comments_349122.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> The real problem is that the file is closed twice: once in the master process and once in the child. It can only be deleted once.\n\n\nRight, that's whole point.  I more or less wrote that in the comment but I guess it should have been clearer...",
    "created_at": "2018-04-13T13:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349122",
    "user": "https://github.com/embray"
}
```

Replying to [comment:12 jdemeyer]:
> The real problem is that the file is closed twice: once in the master process and once in the child. It can only be deleted once.


Right, that's whole point.  I more or less wrote that in the comment but I guess it should have been clearer...



---

archive/issue_comments_349123.json:
```json
{
    "body": "Perhaps to give slightly more detail as well, regarding the usage/implementation of the `tempfile` module (which I agree with you is a bit crummy):\n\nIn Sage here we are using the `TemporaryFile` factory (which despite the CamelCase is actually function).  This basically uses `mkstemp` to create a unique filename, then returns a file-like object around the file descriptor and immediately calls `os.unlink` on the filename (effectively deleting the file as soon as it's no longer needed.\n\nHowever, there is also `NamedTemporaryFile` which does not immediately unlink the name, so that the file can have a name that can be used in other processes, for example.  In this case it's up to the user to delete the file, although it has an auto-delete functionality `delete=True` enabled by default in fact, that deletes the file after it is closed in `__del__`.  Unfortunately the implementation is a bit buggy, I think, since there's an unhandled exception if the file was already deleted when it gets to this point :(\n\nThe problem arises here because the `tempfile` quietly *replaces* `TemporaryFile` with `NamedTemporaryFile` on non-POSIX systems and on Cygwin, since the ability to delete a file while it has an open file descriptor is not guaranteed on other platforms.  This is actually annoying for a couple reasons:\n\n1) `NamedTemporaryFile` and `TemporaryFile` have different APIs, and this switch is done rather implicitly.  You also get the aforementioned buggy behavior of `NamedTemporaryFile` when it comes to double-deletes.\n\n2) At least on Cygwin this is unnecessary.  It might have been a concession to an older version of Cygwin (this hack seems to have been in place for a while).  But it's not necessary at all on more modern versions of Cygwin which do allow unlinking open files.\n\nSo the problem is that on Cygwin the `TemporaryFile` gets replaced with a `NamedTemporaryFile` with `delete=True` (which can be detected through presence of the `delete` attribute, though an explicit `isinstance` check could also be possible).  And, as Jeroen wrote, this means that because that `NamedTemporaryFile` is instantiated before forking, it exists in two processes, and whichever one happens to close the file first deletes it.  Then the process that closes the file second produces this annoying unhandled exception in `__del__` message.\n\nThis has actually been a problem for a long time, and I've seen it show up in the tests before rather randomly.  But it was relatively uncommon since most of the time the file was closed first in the parent process and we didn't see the message from the child process.",
    "created_at": "2018-04-13T13:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349123",
    "user": "https://github.com/embray"
}
```

Perhaps to give slightly more detail as well, regarding the usage/implementation of the `tempfile` module (which I agree with you is a bit crummy):

In Sage here we are using the `TemporaryFile` factory (which despite the CamelCase is actually function).  This basically uses `mkstemp` to create a unique filename, then returns a file-like object around the file descriptor and immediately calls `os.unlink` on the filename (effectively deleting the file as soon as it's no longer needed.

However, there is also `NamedTemporaryFile` which does not immediately unlink the name, so that the file can have a name that can be used in other processes, for example.  In this case it's up to the user to delete the file, although it has an auto-delete functionality `delete=True` enabled by default in fact, that deletes the file after it is closed in `__del__`.  Unfortunately the implementation is a bit buggy, I think, since there's an unhandled exception if the file was already deleted when it gets to this point :(

The problem arises here because the `tempfile` quietly *replaces* `TemporaryFile` with `NamedTemporaryFile` on non-POSIX systems and on Cygwin, since the ability to delete a file while it has an open file descriptor is not guaranteed on other platforms.  This is actually annoying for a couple reasons:

1) `NamedTemporaryFile` and `TemporaryFile` have different APIs, and this switch is done rather implicitly.  You also get the aforementioned buggy behavior of `NamedTemporaryFile` when it comes to double-deletes.

2) At least on Cygwin this is unnecessary.  It might have been a concession to an older version of Cygwin (this hack seems to have been in place for a while).  But it's not necessary at all on more modern versions of Cygwin which do allow unlinking open files.

So the problem is that on Cygwin the `TemporaryFile` gets replaced with a `NamedTemporaryFile` with `delete=True` (which can be detected through presence of the `delete` attribute, though an explicit `isinstance` check could also be possible).  And, as Jeroen wrote, this means that because that `NamedTemporaryFile` is instantiated before forking, it exists in two processes, and whichever one happens to close the file first deletes it.  Then the process that closes the file second produces this annoying unhandled exception in `__del__` message.

This has actually been a problem for a long time, and I've seen it show up in the tests before rather randomly.  But it was relatively uncommon since most of the time the file was closed first in the parent process and we didn't see the message from the child process.



---

archive/issue_comments_349124.json:
```json
{
    "body": "Also, while I'm calling the behavior of `NamedTemporaryFile` \"buggy\" with respect to double deletions, it may in fact be intentional, as this could point toward a programming error of some kind (which I believe is in fact the case here).",
    "created_at": "2018-04-13T13:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349124",
    "user": "https://github.com/embray"
}
```

Also, while I'm calling the behavior of `NamedTemporaryFile` "buggy" with respect to double deletions, it may in fact be intentional, as this could point toward a programming error of some kind (which I believe is in fact the case here).



---

archive/issue_comments_349125.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-13T13:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349125",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349126.json:
```json
{
    "body": "I improved (I think) the comment and also linked to my comment above for more detail.  I don't think it's such a deep problem though (albeit annoying)...\n\n---\nNew commits:",
    "created_at": "2018-04-13T13:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349126",
    "user": "https://github.com/embray"
}
```

I improved (I think) the comment and also linked to my comment above for more detail.  I don't think it's such a deep problem though (albeit annoying)...

---
New commits:



---

archive/issue_comments_349127.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-13T13:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349127",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_349128.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-04-14T18:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24870#issuecomment-349128",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_062983.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-04-14T18:04:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24870",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24870#event-62983"
}
```
