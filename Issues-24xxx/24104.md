# Issue 24104: Merge the code of ex.solve(...) and solve(...)

archive/issues_023867.json:
```json
{
    "body": "Both `Expression.solve(...)` and global `solve(...)` use Maxima for solving (in)equalities but use their own code which agrees in part, and provide some of the same options.  The first allows univariate forms/relations, the second additionally systems, and several variables. Further differences are e.g. that only `solve` makes several attempts.\n\nIn order to give users the full capabilities, regardless how called, and to ease maintenance and addition of improvements, this ticket should move the `ex.solve` code into `solve`, leaving only an interface to it. It will throughout use maxima-lib. No doctest should be in need of change, except for improved output.\n\nCC:  @mforets\n\nReviewer: Travis Scrimshaw, Ralf Stephan\n\nAuthor: Ralf Stephan, Travis Scrimshaw\n\nBranch: 0f6e8265f9ebc448d4aa4004ef0c6b504560b6ff\n\nCommit: 0f6e8265f9ebc448d4aa4004ef0c6b504560b6ff\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24104\n\n",
    "closed_at": "2017-11-02T11:05:57Z",
    "created_at": "2017-10-25T13:31:41Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Merge the code of ex.solve(...) and solve(...)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24104",
    "user": "https://github.com/rwst"
}
```
Both `Expression.solve(...)` and global `solve(...)` use Maxima for solving (in)equalities but use their own code which agrees in part, and provide some of the same options.  The first allows univariate forms/relations, the second additionally systems, and several variables. Further differences are e.g. that only `solve` makes several attempts.

In order to give users the full capabilities, regardless how called, and to ease maintenance and addition of improvements, this ticket should move the `ex.solve` code into `solve`, leaving only an interface to it. It will throughout use maxima-lib. No doctest should be in need of change, except for improved output.

CC:  @mforets

Reviewer: Travis Scrimshaw, Ralf Stephan

Author: Ralf Stephan, Travis Scrimshaw

Branch: 0f6e8265f9ebc448d4aa4004ef0c6b504560b6ff

Commit: 0f6e8265f9ebc448d4aa4004ef0c6b504560b6ff

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24104





---

archive/issue_comments_334172.json:
```json
{
    "body": "Changing type from task to enhancement.",
    "created_at": "2017-10-25T13:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334172",
    "user": "https://github.com/rwst"
}
```

Changing type from task to enhancement.



---

archive/issue_comments_334173.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-26T08:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334173",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334174.json:
```json
{
    "body": "<a id='comment:5'></a>This already passes all tests in symbolic, calculus, tests, and doc. I think the solvers have a good home in `relation.py`. In a next ticket the doctests should be moved.\n\n---\nNew commits:",
    "created_at": "2017-10-26T08:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334174",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>This already passes all tests in symbolic, calculus, tests, and doc. I think the solvers have a good home in `relation.py`. In a next ticket the doctests should be moved.

---
New commits:



---

archive/issue_comments_334175.json:
```json
{
    "body": "<a id='comment:6'></a>We can be a bit more concise, which IMO is more readable:\n\n```diff\n-        for i in x:\n-            if not isinstance(i, Expression):\n-                raise TypeError(\"%s is not a valid variable.\" % repr(i))\n+        if not all(isinstance(i, Expression) for i in x):\n+            raise TypeError(\"%s is not a valid variable\" % repr(i))\n```\n\nI feel like the handling of `f` being a single expression should be a separate function that is called by `solve` but still in the same file. It always returns something and is effectively called later in `solve` in special cases. IMO, this makes it easier to understand and maintain with independent doctests.\n\nI am tempted to keep it as a method of `Expression`, but I agree overall with the purpose of the ticket to have a uniform interface and behavior. This change also gives better code grouping. However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above. Your thoughts and counters?",
    "created_at": "2017-10-28T01:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334175",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>We can be a bit more concise, which IMO is more readable:

```diff
-        for i in x:
-            if not isinstance(i, Expression):
-                raise TypeError("%s is not a valid variable." % repr(i))
+        if not all(isinstance(i, Expression) for i in x):
+            raise TypeError("%s is not a valid variable" % repr(i))
```

I feel like the handling of `f` being a single expression should be a separate function that is called by `solve` but still in the same file. It always returns something and is effectively called later in `solve` in special cases. IMO, this makes it easier to understand and maintain with independent doctests.

I am tempted to keep it as a method of `Expression`, but I agree overall with the purpose of the ticket to have a uniform interface and behavior. This change also gives better code grouping. However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above. Your thoughts and counters?



---

archive/issue_comments_334176.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 tscrim]:\n> We can be a bit more concise, which IMO is more readable:\n> \n> ```diff\n> -        for i in x:\n> -            if not isinstance(i, Expression):\n> -                raise TypeError(\"%s is not a valid variable.\" % repr(i))\n> +        if not all(isinstance(i, Expression) for i in x):\n> +            raise TypeError(\"%s is not a valid variable\" % repr(i))\n> ```\n\n\nThis will not work because `i` is local to `all`. Actually, I changed that snippet specifically because all of `x` was given in the error, but I wanted to print only the part failing.",
    "created_at": "2017-10-28T06:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334176",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>Replying to [comment:6 tscrim]:
> We can be a bit more concise, which IMO is more readable:
> 
> ```diff
> -        for i in x:
> -            if not isinstance(i, Expression):
> -                raise TypeError("%s is not a valid variable." % repr(i))
> +        if not all(isinstance(i, Expression) for i in x):
> +            raise TypeError("%s is not a valid variable" % repr(i))
> ```


This will not work because `i` is local to `all`. Actually, I changed that snippet specifically because all of `x` was given in the error, but I wanted to print only the part failing.



---

archive/issue_comments_334177.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 tscrim]:\n> I am tempted to keep it as a method of `Expression`\n\n\nI really would like to have short code snippets in `expression.py` with long functions and documentation elsewhere. You can't put all of symbolics in one file but Python forces us (because classes can't be split).",
    "created_at": "2017-10-28T06:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334177",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>Replying to [comment:6 tscrim]:
> I am tempted to keep it as a method of `Expression`


I really would like to have short code snippets in `expression.py` with long functions and documentation elsewhere. You can't put all of symbolics in one file but Python forces us (because classes can't be split).



---

archive/issue_comments_334178.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:6 tscrim]:\n> However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above.\n\n\nThe problem is then that code has to be duplicated, e.g. the variable check above. I'm not averse to the idea in principle, separating out would need looking at the doctests which I didn't want to in this ticket. I propose to try it later when moving the doctests from `expression.py`.",
    "created_at": "2017-10-28T06:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334178",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>Replying to [comment:6 tscrim]:
> However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above.


The problem is then that code has to be duplicated, e.g. the variable check above. I'm not averse to the idea in principle, separating out would need looking at the doctests which I didn't want to in this ticket. I propose to try it later when moving the doctests from `expression.py`.



---

archive/issue_comments_334179.json:
```json
{
    "body": "<a id='comment:10'></a>However if you don't mind additionally reviewing extended changes to documentation I can put it in this ticket.",
    "created_at": "2017-10-28T06:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334179",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>However if you don't mind additionally reviewing extended changes to documentation I can put it in this ticket.



---

archive/issue_comments_334180.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 rws]:\n> Replying to [comment:6 tscrim]:\n> > I am tempted to keep it as a method of `Expression`\n\n> \n> I really would like to have short code snippets in `expression.py` with long functions and documentation elsewhere. You can't put all of symbolics in one file but Python forces us (because classes can't be split).\n\n\nThat's not true. Look at the graph code for a \"real world\" example, but basically, it does this:\n\n```python\nsage: def bar(self, x):  # Say this was in a separate file\n....:     return self._y + x\nsage: class Foo(object):\n....:     _y = 10\n....:     bar = bar\nsage: F = Foo()\nsage: F.bar(5)\n15\n```",
    "created_at": "2017-10-28T08:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334180",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Replying to [comment:8 rws]:
> Replying to [comment:6 tscrim]:
> > I am tempted to keep it as a method of `Expression`

> 
> I really would like to have short code snippets in `expression.py` with long functions and documentation elsewhere. You can't put all of symbolics in one file but Python forces us (because classes can't be split).


That's not true. Look at the graph code for a "real world" example, but basically, it does this:

```python
sage: def bar(self, x):  # Say this was in a separate file
....:     return self._y + x
sage: class Foo(object):
....:     _y = 10
....:     bar = bar
sage: F = Foo()
sage: F.bar(5)
15
```



---

archive/issue_comments_334181.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:9 rws]:\n> Replying to [comment:6 tscrim]:\n> > However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above.\n\n> \n> The problem is then that code has to be duplicated, e.g. the variable check above. I'm not averse to the idea in principle, separating out would need looking at the doctests which I didn't want to in this ticket. I propose to try it later when moving the doctests from `expression.py`.\n\n\nI didn't feel like that would be hard to split out as a separate little helper function to avoid the duplication. Although at the same time it didn't seem like there would be too much in the way of code duplication, but maybe I am not looking closely enough.",
    "created_at": "2017-10-28T08:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334181",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>Replying to [comment:9 rws]:
> Replying to [comment:6 tscrim]:
> > However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above.

> 
> The problem is then that code has to be duplicated, e.g. the variable check above. I'm not averse to the idea in principle, separating out would need looking at the doctests which I didn't want to in this ticket. I propose to try it later when moving the doctests from `expression.py`.


I didn't feel like that would be hard to split out as a separate little helper function to avoid the duplication. Although at the same time it didn't seem like there would be too much in the way of code duplication, but maybe I am not looking closely enough.



---

archive/issue_comments_334182.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:10 rws]:\n> However if you don't mind additionally reviewing extended changes to documentation I can put it in this ticket.\n\n\nI don't mind if it makes things easier to do for you.",
    "created_at": "2017-10-28T08:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334182",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Replying to [comment:10 rws]:
> However if you don't mind additionally reviewing extended changes to documentation I can put it in this ticket.


I don't mind if it makes things easier to do for you.



---

archive/issue_comments_334183.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:11 tscrim]:\n> That's not true. Look at the graph code for a \"real world\" example, but basically, it does this:\n\n\n(dynamically adding methods)\n\nThat's true! And I did it a few weeks ago in `interfaces/sympy` <slap head/>",
    "created_at": "2017-10-28T08:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334183",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>Replying to [comment:11 tscrim]:
> That's not true. Look at the graph code for a "real world" example, but basically, it does this:


(dynamically adding methods)

That's true! And I did it a few weeks ago in `interfaces/sympy` <slap head/>



---

archive/issue_comments_334184.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-29T16:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334185.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:6 tscrim]:\n> It always returns something and is effectively called later in `solve` in special cases. IMO, this makes it easier to understand and maintain with independent doctests.\n\n\nCalling itself is not necessary and it's easy to rewrite without this call. While I agree with having structure in the doctests, they serve as highly visible example when a user inputs `solve?`. Separating them makes them partly inaccessible.\n\nPlease review.",
    "created_at": "2017-10-29T16:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334185",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>Replying to [comment:6 tscrim]:
> It always returns something and is effectively called later in `solve` in special cases. IMO, this makes it easier to understand and maintain with independent doctests.


Calling itself is not necessary and it's easy to rewrite without this call. While I agree with having structure in the doctests, they serve as highly visible example when a user inputs `solve?`. Separating them makes them partly inaccessible.

Please review.



---

archive/issue_comments_334186.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks. Although I think it would be better for the `is_Expression(f)` case to be a separate function within `relation.py`, say\n\n```python\ndef _solve_expression(f, x, explicit_solutions, multiplicities, to_poly_solve, solution_dict):\n   \"\"\"\n   Solve an expression ``f``. For more information, see :func:`solve`.\n\n   TESTS:\n\n   Only tests that check :trac:`ABCDE` is fixed::\n   \"\"\"\n   # Code here\n```\nThis gives better localization of (relevant) tests, does not introduce any doc issues (it is mainly an implementation detail), and can be called with your already parsed input. If you do not agree, then what you currently have is acceptable. Yet, it is quite a big function, and I feel it is more maintainable in smaller bites. I can also do that refactoring too if you'd want.",
    "created_at": "2017-10-29T22:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334186",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Thanks. Although I think it would be better for the `is_Expression(f)` case to be a separate function within `relation.py`, say

```python
def _solve_expression(f, x, explicit_solutions, multiplicities, to_poly_solve, solution_dict):
   """
   Solve an expression ``f``. For more information, see :func:`solve`.

   TESTS:

   Only tests that check :trac:`ABCDE` is fixed::
   """
   # Code here
```
This gives better localization of (relevant) tests, does not introduce any doc issues (it is mainly an implementation detail), and can be called with your already parsed input. If you do not agree, then what you currently have is acceptable. Yet, it is quite a big function, and I feel it is more maintainable in smaller bites. I can also do that refactoring too if you'd want.



---

archive/issue_comments_334187.json:
```json
{
    "body": "<a id='comment:18'></a>Please do. I'm a bit entamgled today.",
    "created_at": "2017-10-30T04:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334187",
    "user": "https://github.com/rwst"
}
```

<a id='comment:18'></a>Please do. I'm a bit entamgled today.



---

archive/issue_comments_334188.json:
```json
{
    "body": "<a id='comment:19'></a>Here you go.\n\n---\nNew commits:",
    "created_at": "2017-10-30T08:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334188",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>Here you go.

---
New commits:



---

archive/issue_comments_334189.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-31T14:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334189",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334190.json:
```json
{
    "body": "<a id='comment:20'></a>Thanks. LGTM. I added you as author.",
    "created_at": "2017-10-31T14:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334190",
    "user": "https://github.com/rwst"
}
```

<a id='comment:20'></a>Thanks. LGTM. I added you as author.



---

archive/issue_comments_334191.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-11-02T11:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24104#issuecomment-334191",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061187.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-11-02T11:05:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24104",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24104#event-61187"
}
```
