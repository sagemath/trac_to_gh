# Issue 24805: py3: miscellaneous division-related fixes, particularly for sage_setup.autogen

archive/issues_024568.json:
```json
{
    "body": "Previously we used an opcode named 'div' both for the old `div` operator\nand for `truediv` (for compatibility's sake, since use of `__truediv__`) depends\non whether or not `from __future__ import division` is in effect).\n\nSo again, for compatibility's sake, on Python 3 we call truediv just 'div',\nwhile integer division is still explicitly 'floordiv'.\n\nIncludes a few other semi-related fixes found while testing.  This fixes most but not all Python 3 issues with `sage.ext.fast_callable`--at least those directly related to division.\n\nKeywords: division\n\nBranch/Commit: 28e567d1ea2fb27377df4b2db51f1c59ca1fbd79\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24805\n\n",
    "closed_at": "2018-03-05T17:52:58Z",
    "created_at": "2018-02-21T12:12:37Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: miscellaneous division-related fixes, particularly for sage_setup.autogen",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24805",
    "user": "https://github.com/embray"
}
```
Previously we used an opcode named 'div' both for the old `div` operator
and for `truediv` (for compatibility's sake, since use of `__truediv__`) depends
on whether or not `from __future__ import division` is in effect).

So again, for compatibility's sake, on Python 3 we call truediv just 'div',
while integer division is still explicitly 'floordiv'.

Includes a few other semi-related fixes found while testing.  This fixes most but not all Python 3 issues with `sage.ext.fast_callable`--at least those directly related to division.

Keywords: division

Branch/Commit: 28e567d1ea2fb27377df4b2db51f1c59ca1fbd79

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24805





---

archive/issue_comments_367015.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-21T12:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367016.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-21T12:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_367017.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-21T12:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367018.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-21T12:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367018",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367019.json:
```json
{
    "body": "<a id='comment:5'></a>Wouldn't it make sense to use `PyNumber_TrueDivide` even on Python 2?",
    "created_at": "2018-02-21T13:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367019",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Wouldn't it make sense to use `PyNumber_TrueDivide` even on Python 2?



---

archive/issue_comments_367020.json:
```json
{
    "body": "<a id='comment:6'></a>That's a good question.  Do we want to just always assume Python 3 division semantics?",
    "created_at": "2018-02-22T12:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367020",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>That's a good question.  Do we want to just always assume Python 3 division semantics?



---

archive/issue_comments_367021.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 embray]:\n> That's a good question.  Do we want to just always assume Python 3 division semantics?\n\n\nSage typically assumes true division semantics anyway. For example, division of `Integer` instances is closer to `int.__truediv__` than to `int.__div__`. So, with this in mind, I would indeed use Python 3 division everywhere (assuming that it doesn't break tests of course).",
    "created_at": "2018-02-22T12:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367021",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 embray]:
> That's a good question.  Do we want to just always assume Python 3 division semantics?


Sage typically assumes true division semantics anyway. For example, division of `Integer` instances is closer to `int.__truediv__` than to `int.__div__`. So, with this in mind, I would indeed use Python 3 division everywhere (assuming that it doesn't break tests of course).



---

archive/issue_comments_367022.json:
```json
{
    "body": "<a id='comment:8'></a>I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.  It would also in principle break user-defined classes, if any were actually used in this context, that implement `__div__` but not `__truediv__`.\n\nPerhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?",
    "created_at": "2018-02-22T12:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367022",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.  It would also in principle break user-defined classes, if any were actually used in this context, that implement `__div__` but not `__truediv__`.

Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?



---

archive/issue_comments_367023.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 embray]:\n> I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.\n\n\nThose should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.\n\n> Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?\n\n\nI'm not against that, but I also don't think that it's important. If you do, I guess you should output a deprecation warning if `__div__` is used.",
    "created_at": "2018-02-22T13:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367023",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:8 embray]:
> I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.


Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.

> Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?


I'm not against that, but I also don't think that it's important. If you do, I guess you should output a deprecation warning if `__div__` is used.



---

archive/issue_comments_367024.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:\n> Replying to [comment:8 embray]:\n> > I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.\n\n> \n> Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.\n\n\nYep.\n\n> > Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?\n\n> \n> I'm not against that, but I also don't think that it's important.\n\n\nI agree it's probably not a very likely scenario, but I did it anyways.  \n\n> If you do, I guess you should output a deprecation warning if `__div__` is used.\n\n\nYep, did that.",
    "created_at": "2018-02-22T14:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367024",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 embray]:
> > I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.

> 
> Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.


Yep.

> > Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?

> 
> I'm not against that, but I also don't think that it's important.


I agree it's probably not a very likely scenario, but I did it anyways.  

> If you do, I guess you should output a deprecation warning if `__div__` is used.


Yep, did that.



---

archive/issue_comments_367025.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-22T14:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367025",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367026.json:
```json
{
    "body": "<a id='comment:12'></a>Perhaps something like this.",
    "created_at": "2018-02-22T14:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367026",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Perhaps something like this.



---

archive/issue_comments_367027.json:
```json
{
    "body": "Changing keywords from \"\" to \"division\".",
    "created_at": "2018-02-23T13:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367027",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "division".



---

archive/issue_comments_367028.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-27T09:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367028",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_367029.json:
```json
{
    "body": "<a id='comment:14'></a>The way it's written now, it looks like the deprecation warning will be shown every time that `__truediv__` fails with a `TypeError`, regardless of whether `__div__` works.\n\nMaybe better something like:\n\n```\ntry:\n    ...\nexcept TypeError:\n    IF PY_MAJOR_VERSION < 3:\n        res = PyNumber_Divide(...)\n        deprecation(...)\n        return res\n    ELSE\n        raise\n    ENDIF\n```\nThis way, the deprecation will only be shown if `__div__` actually worked.",
    "created_at": "2018-02-27T09:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367029",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>The way it's written now, it looks like the deprecation warning will be shown every time that `__truediv__` fails with a `TypeError`, regardless of whether `__div__` works.

Maybe better something like:

```
try:
    ...
except TypeError:
    IF PY_MAJOR_VERSION < 3:
        res = PyNumber_Divide(...)
        deprecation(...)
        return res
    ELSE
        raise
    ENDIF
```
This way, the deprecation will only be shown if `__div__` actually worked.



---

archive/issue_comments_367030.json:
```json
{
    "body": "<a id='comment:15'></a>Yes, I was thinking of doing something like that as well, but I couldn't quite decide on the logic for it.  But I think your suggestion makes sense.",
    "created_at": "2018-02-27T09:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367030",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Yes, I was thinking of doing something like that as well, but I couldn't quite decide on the logic for it.  But I think your suggestion makes sense.



---

archive/issue_comments_367031.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-27T09:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-27T09:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367032",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_367033.json:
```json
{
    "body": "<a id='comment:18'></a>I am getting consistent doctest timeouts on a particular test system:\n\n```\nsage -t src/sage/plot/plot3d/list_plot3d.py  # Timed out\nsage -t src/sage/geometry/riemannian_manifolds/surface3d_generators.py  # Timed out\nsage -t src/sage/stats/distributions/discrete_gaussian_lattice.py  # Timed out\n```\nI'll need to check whether this ticket has something to do with that.",
    "created_at": "2018-02-27T21:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367033",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>I am getting consistent doctest timeouts on a particular test system:

```
sage -t src/sage/plot/plot3d/list_plot3d.py  # Timed out
sage -t src/sage/geometry/riemannian_manifolds/surface3d_generators.py  # Timed out
sage -t src/sage/stats/distributions/discrete_gaussian_lattice.py  # Timed out
```
I'll need to check whether this ticket has something to do with that.



---

archive/issue_comments_367034.json:
```json
{
    "body": "<a id='comment:19'></a>The timeouts are unrelated to this ticket. They are still disturbing though...",
    "created_at": "2018-02-28T06:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367034",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>The timeouts are unrelated to this ticket. They are still disturbing though...



---

archive/issue_comments_367035.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-28T06:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367035",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367036.json:
```json
{
    "body": "<a id='comment:21'></a>I've been getting some timeouts too sometimes, but I'm not sure if it's the same modules.  I'll check.",
    "created_at": "2018-02-28T14:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367036",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>I've been getting some timeouts too sometimes, but I'm not sure if it's the same modules.  I'll check.



---

archive/issue_comments_367037.json:
```json
{
    "body": "<a id='comment:22'></a>Sorry, forgot to say... this is #13135.",
    "created_at": "2018-02-28T14:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367037",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Sorry, forgot to say... this is #13135.



---

archive/issue_events_062352.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-05T17:52:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24805#event-62352"
}
```



---

archive/issue_comments_367038.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-05T17:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24805#issuecomment-367038",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
