# Issue 24690: Install Cython source files

archive/issues_024453.json:
```json
{
    "body": "The various Cython files (`.pyx`, `.pxd`, `.pxi`) from the Sage library should be *installed* in `site-packages`. In fact, we already do this for `.pxd` and `.pxi` files.\n\nTickets #21480 and #24681 discuss reasons why we should do that: it allows displaying the traceback of Cython source files without accessing `SAGE_SRC`, which is a good thing for distributions.\n\nCC:  @kiwifb @embray @mkoeppe\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Erik Bray, Jeroen Demeyer\n\nBranch: 68022a4d114951c39f63962c4b35b3feed405f93\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24690\n\n",
    "closed_at": "2018-02-11T13:03:57Z",
    "created_at": "2018-02-08T13:40:52Z",
    "labels": [
        "component: build",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Install Cython source files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24690",
    "user": "https://github.com/jdemeyer"
}
```
The various Cython files (`.pyx`, `.pxd`, `.pxi`) from the Sage library should be *installed* in `site-packages`. In fact, we already do this for `.pxd` and `.pxi` files.

Tickets #21480 and #24681 discuss reasons why we should do that: it allows displaying the traceback of Cython source files without accessing `SAGE_SRC`, which is a good thing for distributions.

CC:  @kiwifb @embray @mkoeppe

Reviewer: Fran√ßois Bissey

Author: Erik Bray, Jeroen Demeyer

Branch: 68022a4d114951c39f63962c4b35b3feed405f93

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24690





---

archive/issue_comments_342622.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-08T13:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342622",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_342623.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2018-02-08T13:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342623",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_342624.json:
```json
{
    "body": "<a id='comment:5'></a>Looks like something I had in sage-on-gentoo for several years.",
    "created_at": "2018-02-08T18:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342624",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>Looks like something I had in sage-on-gentoo for several years.



---

archive/issue_comments_342625.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-08T18:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342625",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342626.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-02-10T12:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342626",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_342627.json:
```json
{
    "body": "<a id='comment:6'></a>Test fails, see patchbot",
    "created_at": "2018-02-10T12:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342627",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>Test fails, see patchbot



---

archive/issue_comments_342628.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-10T12:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342628",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342629.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-10T12:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342629",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_342630.json:
```json
{
    "body": "<a id='comment:9'></a>This is breaking patchbots.",
    "created_at": "2018-02-10T13:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342630",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>This is breaking patchbots.



---

archive/issue_comments_342631.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-02-10T13:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342631",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_342632.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-10T20:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342632",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342633.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:7 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                                           |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n> |[68022a4](https://git.sagemath.org/sage.git/commit/?id=68022a4d114951c39f63962c4b35b3feed405f93)|`Sources in traceback are no longer in src`|\n\n\nStupid me, I always thought this failure was linked to something else that I couldn't identify. But then it looks like I have a different issue on top of this one (i.e. this test fails in sage-on-gentoo because of two things and this will only fix one). No wonder I couldn't find a single cause to the issue.",
    "created_at": "2018-02-10T20:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342633",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>Replying to [comment:7 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                                           |
> |-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
> |[68022a4](https://git.sagemath.org/sage.git/commit/?id=68022a4d114951c39f63962c4b35b3feed405f93)|`Sources in traceback are no longer in src`|


Stupid me, I always thought this failure was linked to something else that I couldn't identify. But then it looks like I have a different issue on top of this one (i.e. this test fails in sage-on-gentoo because of two things and this will only fix one). No wonder I couldn't find a single cause to the issue.



---

archive/issue_comments_342634.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-11T13:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342634",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_062155.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-11T13:03:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24690#event-62155"
}
```



---

archive/issue_comments_342635.json:
```json
{
    "body": "<a id='comment:12'></a>This happened faster than I could comment, but certainly +1 from me.",
    "created_at": "2018-02-12T10:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342635",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>This happened faster than I could comment, but certainly +1 from me.



---

archive/issue_comments_342636.json:
```json
{
    "body": "<a id='comment:13'></a>This broke some patchbots:\n\n```\nsage -t --long src/sage/repl/interpreter.py\n**********************************************************************\nFile \"src/sage/repl/interpreter.py\", line 77, in sage.repl.interpreter\nFailed example:\n    shell.run_cell('1/0')\nExpected:\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    <ipython-input-...> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()\n       ...        if type(left) is type(right):\n       ...            if mpz_sgn((<Integer>right).value) == 0:\n    -> ...                  raise ZeroDivisionError(\"rational division by zero\")\n       ...            x = <Rational> Rational.__new__(Rational)\n       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\nGot:\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    <ipython-input-1-72ac74c5f414> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13246)()\n       1909         if type(left) is type(right):\n       1910             if mpz_sgn((<Integer>right).value) == 0:\n    -> 1911                 raise ZeroDivisionError(\"rational division by zero\")\n       1912             x = <Rational> Rational.__new__(Rational)\n       1913             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.repl.interpreter\n    [131 tests, 1 failure, 2.42 s]\n```\n\nthe new location of the source files means this string comparison failed slightly...",
    "created_at": "2018-02-14T16:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342636",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>This broke some patchbots:

```
sage -t --long src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    shell.run_cell('1/0')
Expected:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-...> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()
       ...        if type(left) is type(right):
       ...            if mpz_sgn((<Integer>right).value) == 0:
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13246)()
       1909         if type(left) is type(right):
       1910             if mpz_sgn((<Integer>right).value) == 0:
    -> 1911                 raise ZeroDivisionError("rational division by zero")
       1912             x = <Rational> Rational.__new__(Rational)
       1913             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
1 item had failures:
   1 of   5 in sage.repl.interpreter
    [131 tests, 1 failure, 2.42 s]
```

the new location of the source files means this string comparison failed slightly...



---

archive/issue_comments_342637.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 embray]:\n> This broke some patchbots:\n> \n> \n> ```\n> sage -t --long src/sage/repl/interpreter.py\n> **********************************************************************\n> File \"src/sage/repl/interpreter.py\", line 77, in sage.repl.interpreter\n> Failed example:\n>     shell.run_cell('1/0')\n> Expected:\n>     ---------------------------------------------------------------------------\n>     ZeroDivisionError                         Traceback (most recent call last)\n>     <ipython-input-...> in <module>()\n>     ----> 1 Integer(1)/Integer(0)\n>     <BLANKLINE>\n>     .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()\n>        ...        if type(left) is type(right):\n>        ...            if mpz_sgn((<Integer>right).value) == 0:\n>     -> ...                  raise ZeroDivisionError(\"rational division by zero\")\n>        ...            x = <Rational> Rational.__new__(Rational)\n>        ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n>     <BLANKLINE>\n>     ZeroDivisionError: rational division by zero\n> Got:\n>     ---------------------------------------------------------------------------\n>     ZeroDivisionError                         Traceback (most recent call last)\n>     <ipython-input-1-72ac74c5f414> in <module>()\n>     ----> 1 Integer(1)/Integer(0)\n>     <BLANKLINE>\n>     /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13246)()\n>        1909         if type(left) is type(right):\n>        1910             if mpz_sgn((<Integer>right).value) == 0:\n>     -> 1911                 raise ZeroDivisionError(\"rational division by zero\")\n>        1912             x = <Rational> Rational.__new__(Rational)\n>        1913             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n>     <BLANKLINE>\n>     ZeroDivisionError: rational division by zero\n> **********************************************************************\n> 1 item had failures:\n>    1 of   5 in sage.repl.interpreter\n>     [131 tests, 1 failure, 2.42 s]\n> ```\n> \n> the new location of the source files means this string comparison failed slightly...\n\n\nThat was fixed in the latest commit. You must be looking at old reports.",
    "created_at": "2018-02-14T20:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342637",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>Replying to [comment:13 embray]:
> This broke some patchbots:
> 
> 
> ```
> sage -t --long src/sage/repl/interpreter.py
> **********************************************************************
> File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
> Failed example:
>     shell.run_cell('1/0')
> Expected:
>     ---------------------------------------------------------------------------
>     ZeroDivisionError                         Traceback (most recent call last)
>     <ipython-input-...> in <module>()
>     ----> 1 Integer(1)/Integer(0)
>     <BLANKLINE>
>     .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()
>        ...        if type(left) is type(right):
>        ...            if mpz_sgn((<Integer>right).value) == 0:
>     -> ...                  raise ZeroDivisionError("rational division by zero")
>        ...            x = <Rational> Rational.__new__(Rational)
>        ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
>     <BLANKLINE>
>     ZeroDivisionError: rational division by zero
> Got:
>     ---------------------------------------------------------------------------
>     ZeroDivisionError                         Traceback (most recent call last)
>     <ipython-input-1-72ac74c5f414> in <module>()
>     ----> 1 Integer(1)/Integer(0)
>     <BLANKLINE>
>     /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13246)()
>        1909         if type(left) is type(right):
>        1910             if mpz_sgn((<Integer>right).value) == 0:
>     -> 1911                 raise ZeroDivisionError("rational division by zero")
>        1912             x = <Rational> Rational.__new__(Rational)
>        1913             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
>     <BLANKLINE>
>     ZeroDivisionError: rational division by zero
> **********************************************************************
> 1 item had failures:
>    1 of   5 in sage.repl.interpreter
>     [131 tests, 1 failure, 2.42 s]
> ```
> 
> the new location of the source files means this string comparison failed slightly...


That was fixed in the latest commit. You must be looking at old reports.



---

archive/issue_comments_342638.json:
```json
{
    "body": "<a id='comment:15'></a>Actually I'm not sure that's exactly it.  I think that what's happening is that any patchbots that tested this ticket now have the `.pyx` files installed into their `site-packages`, but when they switch branches again to test older tickets, it's not deleting those `.pyx` files (after all, the old branches don't know what they should be there in the first place) so those patchbots are failing.\n\nI suppose there's not much we can do about that other than be aware of the problem, and eventually it will normalize...",
    "created_at": "2018-02-15T16:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24690#issuecomment-342638",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Actually I'm not sure that's exactly it.  I think that what's happening is that any patchbots that tested this ticket now have the `.pyx` files installed into their `site-packages`, but when they switch branches again to test older tickets, it's not deleting those `.pyx` files (after all, the old branches don't know what they should be there in the first place) so those patchbots are failing.

I suppose there's not much we can do about that other than be aware of the problem, and eventually it will normalize...
