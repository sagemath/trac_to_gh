# Issue 24986: Inconsistent mpz_t state after interrupted sig_realloc()

archive/issues_024749.json:
```json
{
    "body": "### TODO\n\n| |                                                                                                                                                                                                                                                                                      |\n|-|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n|\u2610|Use `sig_occurred()` to check whether an exception from Cysignals is currently being handled while in `Integer.tp_dealloc`. If so, assume that the state of the object's mpz struct may not be consistent, so do not call `mpz_clear` on it and do not place it back in the free pool.|\n|\u2610|Don't forget to re-enable the test that was disabled in #25137 in order to test that this is fixed.|\n---\nAs discussed on sage-devel, I'm fairly consistently (roughly 9 times out of 10) getting the following failure on Cygwin:\n\n```\nsage -t --warn-long 164.8 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 786, in\nsage.structure.coerce_actions.IntegerMulAction._repr_name_\nFailed example:\n    IntegerMulAction(ZZ, GF5)\nExpected:\n    Left Integer Multiplication by Integer Ring on Finite Field of size 5\nGot:\n    Left Integer Multiplication by Integer Ring on Finite Field of size 1\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.IntegerMulAction._repr_name_\n    [143 tests, 1 failure, 3.30 s]\n----------------------------------------------------------------------\nsage -t --warn-long 164.8 src/sage/structure/coerce_actions.pyx  # 1\ndoctest failed\n```\n\nObviously Sage doesn't even allow creation of an order 1 field.  In fact, I traced the cause of this to a *specific* line in `FiniteFieldFactory.create_key_and_extra_args` where, by chance, an `Integer` with a value of `1` is constructed (using `fast_tp_new`) whose `(mp_limb*)(Integer.value._mp_d)` member is assigned the same address as the `_mp_d` of the `Integer` that happens to hold the field's order.\n\nThe result is that the `order` is then set to `1` as well.  This happens *after* the check that `order>1` so creation of the field still succeeds.  Clearly there is a subtle bug either in `fast_tp_new`, or in the memory allocator itself.\n\nCC:  @jdemeyer @xcaruso\n\nKeywords: cygwin\n\nBranch/Commit: 521bac96289ae33b5ecf337f1f36a7fd29d7bc8a\n\nReviewer: Erik Bray\n\nAuthor: Jeroen Demeyer\n\nDependencies: #27073\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24986\n\n",
    "closed_at": "2019-01-27T10:54:46Z",
    "created_at": "2018-03-15T10:46:51Z",
    "labels": [
        "component: cython",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Inconsistent mpz_t state after interrupted sig_realloc()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24986",
    "user": "https://github.com/embray"
}
```
### TODO

| |                                                                                                                                                                                                                                                                                      |
|-|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|☐|Use `sig_occurred()` to check whether an exception from Cysignals is currently being handled while in `Integer.tp_dealloc`. If so, assume that the state of the object's mpz struct may not be consistent, so do not call `mpz_clear` on it and do not place it back in the free pool.|
|☐|Don't forget to re-enable the test that was disabled in #25137 in order to test that this is fixed.|
---
As discussed on sage-devel, I'm fairly consistently (roughly 9 times out of 10) getting the following failure on Cygwin:

```
sage -t --warn-long 164.8 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 786, in
sage.structure.coerce_actions.IntegerMulAction._repr_name_
Failed example:
    IntegerMulAction(ZZ, GF5)
Expected:
    Left Integer Multiplication by Integer Ring on Finite Field of size 5
Got:
    Left Integer Multiplication by Integer Ring on Finite Field of size 1
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.IntegerMulAction._repr_name_
    [143 tests, 1 failure, 3.30 s]
----------------------------------------------------------------------
sage -t --warn-long 164.8 src/sage/structure/coerce_actions.pyx  # 1
doctest failed
```

Obviously Sage doesn't even allow creation of an order 1 field.  In fact, I traced the cause of this to a *specific* line in `FiniteFieldFactory.create_key_and_extra_args` where, by chance, an `Integer` with a value of `1` is constructed (using `fast_tp_new`) whose `(mp_limb*)(Integer.value._mp_d)` member is assigned the same address as the `_mp_d` of the `Integer` that happens to hold the field's order.

The result is that the `order` is then set to `1` as well.  This happens *after* the check that `order>1` so creation of the field still succeeds.  Clearly there is a subtle bug either in `fast_tp_new`, or in the memory allocator itself.

CC:  @jdemeyer @xcaruso

Keywords: cygwin

Branch/Commit: 521bac96289ae33b5ecf337f1f36a7fd29d7bc8a

Reviewer: Erik Bray

Author: Jeroen Demeyer

Dependencies: #27073

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24986





---

archive/issue_comments_346984.json:
```json
{
    "body": "<a id='comment:2'></a>We should also consider the possibility of a bug in Cygwin, as this has not been observed on other platforms.",
    "created_at": "2018-03-15T10:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346984",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>We should also consider the possibility of a bug in Cygwin, as this has not been observed on other platforms.



---

archive/issue_comments_346985.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 jdemeyer]:\n> We should also consider the possibility of a bug in Cygwin, as this has not been observed on other platforms.\n\n\nYep, I agree. Though I think there's also a possibility of a subtle bug.  The code around which this is happening looks like this:\n\n```python\n            order = Integer(order)\n            if order <= 1:\n                raise ValueError(\"the order of a finite field must be at least 2\")\n\n            if order.is_prime():\n                p = order\n                n = Integer(1)\n```\n\nIt's the last line, `n = Integer(1)` where that `Integer` has the same `_mp_d` as `order` for some reason.  Also in this case `order` is already passed in as an `Integer`, so I'm wondering if there's some subtle bug around `order = Integer(order)`.",
    "created_at": "2018-03-15T12:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346985",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>Replying to [comment:2 jdemeyer]:
> We should also consider the possibility of a bug in Cygwin, as this has not been observed on other platforms.


Yep, I agree. Though I think there's also a possibility of a subtle bug.  The code around which this is happening looks like this:

```python
            order = Integer(order)
            if order <= 1:
                raise ValueError("the order of a finite field must be at least 2")

            if order.is_prime():
                p = order
                n = Integer(1)
```

It's the last line, `n = Integer(1)` where that `Integer` has the same `_mp_d` as `order` for some reason.  Also in this case `order` is already passed in as an `Integer`, so I'm wondering if there's some subtle bug around `order = Integer(order)`.



---

archive/issue_comments_346986.json:
```json
{
    "body": "<a id='comment:4'></a>Maybe not--by the time I get to `order = Integer(order)` the next two `Integer`s in the pool already shared the same `_mp_d`:\n\n```\n(gdb) p __pyx_v_4sage_5rings_7integer_integer_pool_count\n$37 = 7\n(gdb) p ((struct __pyx_obj_4sage_5rings_7integer_Integer *)__pyx_v_4sage_5rings_7integer_integer_pool[6]).value\n$38 = {{_mp_alloc = 1, _mp_size = 0, _mp_d = 0x602b85c40}}\n(gdb) p ((struct __pyx_obj_4sage_5rings_7integer_Integer *)__pyx_v_4sage_5rings_7integer_integer_pool[5]).value\n$39 = {{_mp_alloc = 1, _mp_size = 0, _mp_d = 0x602b85c40}}\n```\n\nI'm going to add in some tracing and see if that reveals anything (or makes the problem go away entirely which would point more toward a Cygwin bug if it's *that* sensitive.",
    "created_at": "2018-03-15T12:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346986",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Maybe not--by the time I get to `order = Integer(order)` the next two `Integer`s in the pool already shared the same `_mp_d`:

```
(gdb) p __pyx_v_4sage_5rings_7integer_integer_pool_count
$37 = 7
(gdb) p ((struct __pyx_obj_4sage_5rings_7integer_Integer *)__pyx_v_4sage_5rings_7integer_integer_pool[6]).value
$38 = {{_mp_alloc = 1, _mp_size = 0, _mp_d = 0x602b85c40}}
(gdb) p ((struct __pyx_obj_4sage_5rings_7integer_Integer *)__pyx_v_4sage_5rings_7integer_integer_pool[5]).value
$39 = {{_mp_alloc = 1, _mp_size = 0, _mp_d = 0x602b85c40}}
```

I'm going to add in some tracing and see if that reveals anything (or makes the problem go away entirely which would point more toward a Cygwin bug if it's *that* sensitive.



---

archive/issue_comments_346987.json:
```json
{
    "body": "<a id='comment:5'></a>Can you compile the Sage library with `-O0 -g` just to check for a potential compiler bug? You will need to do `rm -rf src/build` first.",
    "created_at": "2018-03-15T13:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346987",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Can you compile the Sage library with `-O0 -g` just to check for a potential compiler bug? You will need to do `rm -rf src/build` first.



---

archive/issue_comments_346988.json:
```json
{
    "body": "<a id='comment:6'></a>I'll give that a try in a bit.  A compiler bug is also certainly a possibility.  This is gcc 6.4.0.",
    "created_at": "2018-03-15T13:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346988",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>I'll give that a try in a bit.  A compiler bug is also certainly a possibility.  This is gcc 6.4.0.



---

archive/issue_comments_346989.json:
```json
{
    "body": "<a id='comment:7'></a>It's not possible that there'd be anywhere in Sage where it creates Integer objects while the GIL is released, is there?",
    "created_at": "2018-03-15T13:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346989",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>It's not possible that there'd be anywhere in Sage where it creates Integer objects while the GIL is released, is there?



---

archive/issue_comments_346990.json:
```json
{
    "body": "<a id='comment:8'></a>More generally, I think that Sage never releases the GIL. Libraries used by Sage (e.g. Numpy) might.",
    "created_at": "2018-03-15T13:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346990",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>More generally, I think that Sage never releases the GIL. Libraries used by Sage (e.g. Numpy) might.



---

archive/issue_comments_346991.json:
```json
{
    "body": "<a id='comment:9'></a>Aha! I put some code in `fast_tp_dealloc` to check, before returning an `Integer` to the pool, if there is already an entry in the pool with the same `_mp_d`, and raise a `RuntimeError` if so.  And this condition first occurs in earlier test in the same module:\n\n```\nsage -t --warn-long 164.8 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 758, in sage.structure.coerce_actions.IntegerMulAction._call_\nFailed example:\n    alarm(0.5); (2^(10^7)) * P\nExpected:\n    Traceback (most recent call last):\n    ...\n    AlarmInterrupt\nGot:\n    RuntimeError: [fast_tp_dealloc] DUPLICATE _mp_d: 0x0x60404ebe0L!\n                            (integer_pool_count: 3)\n    Exception RuntimeError: RuntimeError('[fast_tp_dealloc] DUPLICATE _mp_d: 0x0x60404ebe0L!\\n                        (integer_pool_count: 3)',) in 'sage.rings.integer.fast_tp_dealloc' ignored\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 541, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 951, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.structure.coerce_actions.IntegerMulAction._call_[11]>\", line 1, in <module>\n        alarm(RealNumber('0.5')); (Integer(2)**(Integer(10)**Integer(7))) * P\n    SystemError: error return without exception set\n```\n\nThe presence of `alarm()` also explains the slight randomness of this error.  So it seems that somewhere the allocation/deallocation of integers not safe to interruption by a signal...",
    "created_at": "2018-03-15T14:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346991",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Aha! I put some code in `fast_tp_dealloc` to check, before returning an `Integer` to the pool, if there is already an entry in the pool with the same `_mp_d`, and raise a `RuntimeError` if so.  And this condition first occurs in earlier test in the same module:

```
sage -t --warn-long 164.8 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 758, in sage.structure.coerce_actions.IntegerMulAction._call_
Failed example:
    alarm(0.5); (2^(10^7)) * P
Expected:
    Traceback (most recent call last):
    ...
    AlarmInterrupt
Got:
    RuntimeError: [fast_tp_dealloc] DUPLICATE _mp_d: 0x0x60404ebe0L!
                            (integer_pool_count: 3)
    Exception RuntimeError: RuntimeError('[fast_tp_dealloc] DUPLICATE _mp_d: 0x0x60404ebe0L!\n                        (integer_pool_count: 3)',) in 'sage.rings.integer.fast_tp_dealloc' ignored
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 541, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 951, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.coerce_actions.IntegerMulAction._call_[11]>", line 1, in <module>
        alarm(RealNumber('0.5')); (Integer(2)**(Integer(10)**Integer(7))) * P
    SystemError: error return without exception set
```

The presence of `alarm()` also explains the slight randomness of this error.  So it seems that somewhere the allocation/deallocation of integers not safe to interruption by a signal...



---

archive/issue_comments_346992.json:
```json
{
    "body": "<a id='comment:10'></a>Specifically this is inside `fast_mul` which is doing some pretty heavy creation and destruction of Integers.  If I just run the same code manually at the prompt and hit Ctrl-C, depending on exactly where it is `fast_mul`, sometimes I just get a `KeyboardInterrupt` raised from cysignals, or sometimes my `RuntimeError` gets raised.",
    "created_at": "2018-03-15T14:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346992",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Specifically this is inside `fast_mul` which is doing some pretty heavy creation and destruction of Integers.  If I just run the same code manually at the prompt and hit Ctrl-C, depending on exactly where it is `fast_mul`, sometimes I just get a `KeyboardInterrupt` raised from cysignals, or sometimes my `RuntimeError` gets raised.



---

archive/issue_comments_346993.json:
```json
{
    "body": "<a id='comment:11'></a>Two new notes:\n\n1. I can reproduce the problem reliably on Cygwin by the following:\n\n```\nsage: E = EllipticCurve(GF(5), [4,0])\nsage: set_random_seed(0); P = E.random_element()\nsage: alarm(0.5); (2^(10^7)) * P\n---------------------------------------------------------------------------\nAlarmInterrupt                            Traceback (most recent call last)\n<ipython-input-3-1f9f5650ad9d> in <module>()\n----> 1 alarm(RealNumber('0.5')); (Integer(2)**(Integer(10)**Integer(7))) * P\n...\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:40438)()\n   6371         # Now finally call into MPIR to do the shifting.\n   6372         cdef Integer z = PY_NEW(Integer)\n-> 6373         sig_on()\n   6374         if n < 0:\n   6375             mpz_fdiv_q_2exp(z.value, self.value, -n)\n\nsrc/cysignals/signals.pyx in cysignals.signals.sig_raise_exception()\n\nAlarmInterrupt:\nsage: a = Integer(5)\nsage: a\n5\nsage: b = Integer(1)\nsage: a\n1\n```\n This same process works correctly on Linux though, which is still suspicious.\n\n2. If I remove the following lines from `fast_tp_dealloc` the problem appears to go away:\n\n```python\n        # Here we free any extra memory used by the mpz_t by\n        # setting it to a single limb.\n        if o_mpz._mp_alloc > 10:\n            _mpz_realloc(o_mpz, 1)\n```\n so it's possible also something fishy is happening with `_mpz_realloc`.",
    "created_at": "2018-03-15T14:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346993",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Two new notes:

1. I can reproduce the problem reliably on Cygwin by the following:

```
sage: E = EllipticCurve(GF(5), [4,0])
sage: set_random_seed(0); P = E.random_element()
sage: alarm(0.5); (2^(10^7)) * P
---------------------------------------------------------------------------
AlarmInterrupt                            Traceback (most recent call last)
<ipython-input-3-1f9f5650ad9d> in <module>()
----> 1 alarm(RealNumber('0.5')); (Integer(2)**(Integer(10)**Integer(7))) * P
...
/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:40438)()
   6371         # Now finally call into MPIR to do the shifting.
   6372         cdef Integer z = PY_NEW(Integer)
-> 6373         sig_on()
   6374         if n < 0:
   6375             mpz_fdiv_q_2exp(z.value, self.value, -n)

src/cysignals/signals.pyx in cysignals.signals.sig_raise_exception()

AlarmInterrupt:
sage: a = Integer(5)
sage: a
5
sage: b = Integer(1)
sage: a
1
```
 This same process works correctly on Linux though, which is still suspicious.

2. If I remove the following lines from `fast_tp_dealloc` the problem appears to go away:

```python
        # Here we free any extra memory used by the mpz_t by
        # setting it to a single limb.
        if o_mpz._mp_alloc > 10:
            _mpz_realloc(o_mpz, 1)
```
 so it's possible also something fishy is happening with `_mpz_realloc`.



---

archive/issue_comments_346994.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 embray]:\n> Specifically this is inside `fast_mul`\n\n\nJust to be clear that we are talking about the same thing: you mean `fast_mul` inside `src/sage/structure/coerce_actions.pyx`?",
    "created_at": "2018-03-15T16:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346994",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:10 embray]:
> Specifically this is inside `fast_mul`


Just to be clear that we are talking about the same thing: you mean `fast_mul` inside `src/sage/structure/coerce_actions.pyx`?



---

archive/issue_comments_346995.json:
```json
{
    "body": "<a id='comment:13'></a>Yes.  Then at some point the `_mpz_realloc` I mentioned above sets the pointer to the same address as one of the existing (presumably unused) integers in the pool.",
    "created_at": "2018-03-15T16:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346995",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Yes.  Then at some point the `_mpz_realloc` I mentioned above sets the pointer to the same address as one of the existing (presumably unused) integers in the pool.



---

archive/issue_comments_346996.json:
```json
{
    "body": "<a id='comment:14'></a>It would be good to know exactly which code is executing when the interrupt/alarm happens.\n\nThere are two ways to find out:\n\n1. Run Python under `gdb`\n\n2. Using `cysignals` assume that Cygwin has a `backtrace()` function. You'll need to recompile `cysignals` with debugging. Within Sage, it suffices to do\n\n```\nSAGE_DEBUG=yes ./sage -f cysignals\n```",
    "created_at": "2018-03-15T16:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346996",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>It would be good to know exactly which code is executing when the interrupt/alarm happens.

There are two ways to find out:

1. Run Python under `gdb`

2. Using `cysignals` assume that Cygwin has a `backtrace()` function. You'll need to recompile `cysignals` with debugging. Within Sage, it suffices to do

```
SAGE_DEBUG=yes ./sage -f cysignals
```



---

archive/issue_comments_346997.json:
```json
{
    "body": "<a id='comment:15'></a>Something else to try (just shooting in the dark here): explicitly call `sage.ext.memory.init_memory_functions()` before doing your tests.",
    "created_at": "2018-03-15T16:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346997",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Something else to try (just shooting in the dark here): explicitly call `sage.ext.memory.init_memory_functions()` before doing your tests.



---

archive/issue_comments_346998.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:\n> Something else to try (just shooting in the dark here): explicitly call `sage.ext.memory.init_memory_functions()` before doing your tests.\n\n\nWhat would explicitly calling it do?  Shouldn't it be called automatically anyways?  I confirmed in gdb that mpir is using the sage/cysignals allocation functions.  I actually tried *disabling* it and it didn't seem to make a difference on the problem.",
    "created_at": "2018-03-15T17:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346998",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:
> Something else to try (just shooting in the dark here): explicitly call `sage.ext.memory.init_memory_functions()` before doing your tests.


What would explicitly calling it do?  Shouldn't it be called automatically anyways?  I confirmed in gdb that mpir is using the sage/cysignals allocation functions.  I actually tried *disabling* it and it didn't seem to make a difference on the problem.



---

archive/issue_comments_346999.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 embray]:\n> Shouldn't it be called automatically anyways?\n\n\nOf course it should. But the whole point of debugging is to verify that everything that should happen actually happens.",
    "created_at": "2018-03-15T18:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-346999",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:16 embray]:
> Shouldn't it be called automatically anyways?


Of course it should. But the whole point of debugging is to verify that everything that should happen actually happens.



---

archive/issue_comments_347000.json:
```json
{
    "body": "<a id='comment:18'></a>Does the cysignals testsuite pass (`./sage -f -c cysignals`)? Does anything change if cysignals (and the Sage library) is compiled with `-O0`?",
    "created_at": "2018-03-15T18:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347000",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Does the cysignals testsuite pass (`./sage -f -c cysignals`)? Does anything change if cysignals (and the Sage library) is compiled with `-O0`?



---

archive/issue_comments_347001.json:
```json
{
    "body": "<a id='comment:19'></a>After rebuilding with `SAGE_DEBUG=yes` (mostly--singular is failing its debug builds for some reason, which is something I'll have to investigate another time), I can no longer reproduce the problem, which is disconcerting.  I confirmed that the Sage modules compiled with `-O0`.\n\nFor reference's sake, with the `alarm(0.5)`  (and actually with other values as well, such as `alarm(1)`), the `AlarmInterrupt` is almost always raised from the same place:\n\n```\nsage: alarm(1); (2^(10^7)) * P\n\n*** SIG 14 *** inside sig_on\ndo_raise_exception(sig=14)\nPyErr_Occurred() = 0x0\nRaising Python exception 0 ms after signals...\n---------------------------------------------------------------------------\nAlarmInterrupt                            Traceback (most recent call last)\n<ipython-input-17-57b8340ec195> in <module>()\n----> 1 alarm(Integer(1)); (Integer(2)**(Integer(10)**Integer(7))) * P\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__mul__ (build/cythonized/sage/rings/integer.c:12921)()\n   1856             return y\n   1857\n-> 1858         return coercion_model.bin_op(left, right, operator.mul)\n   1859\n   1860     cpdef _mul_(self, right):\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9695)()\n   1114             action = self.get_action(xp, yp, op, x, y)\n   1115             if action is not None:\n-> 1116                 return (<Action>action)._call_(x, y)\n   1117\n   1118         try:\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/coerce_actions.pyx in sage.structure.coerce_actions.IntegerMulAction._call_ (build/cythonized/sage/structure/coerce_actions.c:10587)()\n    772             return fast_mul_long(a, n_long)\n    773\n--> 774         return fast_mul(a, nn)\n    775\n    776     def _repr_name_(self):\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/coerce_actions.pyx in sage.structure.coerce_actions.fast_mul (build/cythonized/sage/structure/coerce_actions.c:11610)()\n    899         sig_check()\n    900         pow2a += pow2a\n--> 901         n = n >> 1\n    902     sum = pow2a\n    903     n = n >> 1\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__rshift__ (build/cythonized/sage/rings/integer.c:40813)()\n   6444         if not isinstance(x, Integer):\n   6445             return x >> int(y)\n-> 6446         return (<Integer>x)._shift_helper(y, -1)\n   6447\n   6448     cdef _and(Integer self, Integer other):\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:40452)()\n   6375         # Now finally call into MPIR to do the shifting.\n   6376         cdef Integer z = PY_NEW(Integer)\n-> 6377         sig_on()\n   6378         if n < 0:\n   6379             mpz_fdiv_q_2exp(z.value, self.value, -n)\n\nsrc/cysignals/signals.pyx in cysignals.signals.sig_raise_exception()\n\nAlarmInterrupt:\n```\n\nOn occasion it's elsewhere, but most of the time it's in that shift call.  To learn much else I'll have to drop into gdb, but first I'll have to rebuild some modules with `-O(>0)` and see if the problem returns...",
    "created_at": "2018-03-16T14:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347001",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>After rebuilding with `SAGE_DEBUG=yes` (mostly--singular is failing its debug builds for some reason, which is something I'll have to investigate another time), I can no longer reproduce the problem, which is disconcerting.  I confirmed that the Sage modules compiled with `-O0`.

For reference's sake, with the `alarm(0.5)`  (and actually with other values as well, such as `alarm(1)`), the `AlarmInterrupt` is almost always raised from the same place:

```
sage: alarm(1); (2^(10^7)) * P

*** SIG 14 *** inside sig_on
do_raise_exception(sig=14)
PyErr_Occurred() = 0x0
Raising Python exception 0 ms after signals...
---------------------------------------------------------------------------
AlarmInterrupt                            Traceback (most recent call last)
<ipython-input-17-57b8340ec195> in <module>()
----> 1 alarm(Integer(1)); (Integer(2)**(Integer(10)**Integer(7))) * P

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__mul__ (build/cythonized/sage/rings/integer.c:12921)()
   1856             return y
   1857
-> 1858         return coercion_model.bin_op(left, right, operator.mul)
   1859
   1860     cpdef _mul_(self, right):

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9695)()
   1114             action = self.get_action(xp, yp, op, x, y)
   1115             if action is not None:
-> 1116                 return (<Action>action)._call_(x, y)
   1117
   1118         try:

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/coerce_actions.pyx in sage.structure.coerce_actions.IntegerMulAction._call_ (build/cythonized/sage/structure/coerce_actions.c:10587)()
    772             return fast_mul_long(a, n_long)
    773
--> 774         return fast_mul(a, nn)
    775
    776     def _repr_name_(self):

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/coerce_actions.pyx in sage.structure.coerce_actions.fast_mul (build/cythonized/sage/structure/coerce_actions.c:11610)()
    899         sig_check()
    900         pow2a += pow2a
--> 901         n = n >> 1
    902     sum = pow2a
    903     n = n >> 1

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__rshift__ (build/cythonized/sage/rings/integer.c:40813)()
   6444         if not isinstance(x, Integer):
   6445             return x >> int(y)
-> 6446         return (<Integer>x)._shift_helper(y, -1)
   6447
   6448     cdef _and(Integer self, Integer other):

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:40452)()
   6375         # Now finally call into MPIR to do the shifting.
   6376         cdef Integer z = PY_NEW(Integer)
-> 6377         sig_on()
   6378         if n < 0:
   6379             mpz_fdiv_q_2exp(z.value, self.value, -n)

src/cysignals/signals.pyx in cysignals.signals.sig_raise_exception()

AlarmInterrupt:
```

On occasion it's elsewhere, but most of the time it's in that shift call.  To learn much else I'll have to drop into gdb, but first I'll have to rebuild some modules with `-O(>0)` and see if the problem returns...



---

archive/issue_comments_347002.json:
```json
{
    "body": "<a id='comment:20'></a>In other to narrow the problem down, it would be good to know if it matters whether cysignals is compiled with `-O0` or whether the Sage library is compiled with `-O0`.",
    "created_at": "2018-03-16T14:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347002",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>In other to narrow the problem down, it would be good to know if it matters whether cysignals is compiled with `-O0` or whether the Sage library is compiled with `-O0`.



---

archive/issue_comments_347003.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 embray]:\n> On occasion it's elsewhere, but most of the time it's in that shift call.\n\n\nThe problem is that the `sig_on()` hides the actual place where the signal is raised. I hope that we can learn something by knowing precisely what is interrupted.",
    "created_at": "2018-03-16T14:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347003",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [comment:19 embray]:
> On occasion it's elsewhere, but most of the time it's in that shift call.


The problem is that the `sig_on()` hides the actual place where the signal is raised. I hope that we can learn something by knowing precisely what is interrupted.



---

archive/issue_comments_347004.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:19 embray]:\n> After rebuilding with `SAGE_DEBUG=yes` (mostly--singular is failing its debug builds for some reason, which is something I'll have to investigate another time), I can no longer reproduce the problem, which is disconcerting.  I confirmed that the Sage modules compiled with `-O0`.\n\n\nOops--disregard that.  I had forgotten exactly where I left off on this yesterday, and it appears I still had the troublesome `_mpz_realloc` disabled in the source I was building from.  After re-enabling that the problem returns, even in the debug build.",
    "created_at": "2018-03-16T14:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347004",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Replying to [comment:19 embray]:
> After rebuilding with `SAGE_DEBUG=yes` (mostly--singular is failing its debug builds for some reason, which is something I'll have to investigate another time), I can no longer reproduce the problem, which is disconcerting.  I confirmed that the Sage modules compiled with `-O0`.


Oops--disregard that.  I had forgotten exactly where I left off on this yesterday, and it appears I still had the troublesome `_mpz_realloc` disabled in the source I was building from.  After re-enabling that the problem returns, even in the debug build.



---

archive/issue_comments_347005.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:21 jdemeyer]:\n> Replying to [comment:19 embray]:\n> > On occasion it's elsewhere, but most of the time it's in that shift call.\n\n> \n> The problem is that the `sig_on()` hides the actual place where the signal is raised. I hope that we can learn something by knowing precisely what is interrupted.\n\n\nRight, but doesn't that at least mean it's at least somewhere between that `sig_on()` and the corresponding `sig_off()`?",
    "created_at": "2018-03-16T14:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347005",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>Replying to [comment:21 jdemeyer]:
> Replying to [comment:19 embray]:
> > On occasion it's elsewhere, but most of the time it's in that shift call.

> 
> The problem is that the `sig_on()` hides the actual place where the signal is raised. I hope that we can learn something by knowing precisely what is interrupted.


Right, but doesn't that at least mean it's at least somewhere between that `sig_on()` and the corresponding `sig_off()`?



---

archive/issue_comments_347006.json:
```json
{
    "body": "<a id='comment:24'></a>OK, so the problem persists with `-O0`. Good, so it looks like a real bug (either in Sage, cysignals, MPIR or Cygwin).",
    "created_at": "2018-03-16T14:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347006",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>OK, so the problem persists with `-O0`. Good, so it looks like a real bug (either in Sage, cysignals, MPIR or Cygwin).



---

archive/issue_comments_347007.json:
```json
{
    "body": "<a id='comment:25'></a>Yes, likely one of those four things--probably not the compiler though I wouldn't rule it out completely.",
    "created_at": "2018-03-16T14:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347007",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>Yes, likely one of those four things--probably not the compiler though I wouldn't rule it out completely.



---

archive/issue_comments_347008.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:23 embray]:\n> Right, but doesn't that at least mean it's at least somewhere between that `sig_on()` and the corresponding `sig_off()`?\n\n\nYes, but I would like to know the exact place in the MPIR code where it is interrupted.",
    "created_at": "2018-03-16T14:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347008",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:23 embray]:
> Right, but doesn't that at least mean it's at least somewhere between that `sig_on()` and the corresponding `sig_off()`?


Yes, but I would like to know the exact place in the MPIR code where it is interrupted.



---

archive/issue_comments_347009.json:
```json
{
    "body": "<a id='comment:27'></a>It looks like it's being interrupted in the `_mpz_realloc` call from `mpz_mul_2exp(z.value, self.value, n)`, on the just-created `Integer` \"z\".\n\nI *think* I see the general problem here.  The function `_mpz_realloc` is not interrupt-safe.  Even with GMP's realloc set to `sig_realloc`, that just blocks signals before/after the actual `realloc`.  However, it's then only after `realloc` succeeds that the `_mp_d` pointer gets updated.  If the signal handler is invoked before that happens then the old value in `_mp_d` might now point to a freed address (in fact, and address to a size=1 array of limbs).\n\nThen, as `fast_mul` is cleaned up it again frees an integer (the variable \"n\").  This is a large integer so it trips the semi-arbitrary condition:\n\n```python\n        # Here we free any extra memory used by the mpz_t by\n        # setting it to a single limb.\n        if o_mpz._mp_alloc > 10:\n            _mpz_realloc(o_mpz, 1)\n```\n\nand this `realloc` happens to give back the same `size=1` array that was previously just freed.  So both `_mp_d` end up with the same pointer.",
    "created_at": "2018-03-16T15:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347009",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>It looks like it's being interrupted in the `_mpz_realloc` call from `mpz_mul_2exp(z.value, self.value, n)`, on the just-created `Integer` "z".

I *think* I see the general problem here.  The function `_mpz_realloc` is not interrupt-safe.  Even with GMP's realloc set to `sig_realloc`, that just blocks signals before/after the actual `realloc`.  However, it's then only after `realloc` succeeds that the `_mp_d` pointer gets updated.  If the signal handler is invoked before that happens then the old value in `_mp_d` might now point to a freed address (in fact, and address to a size=1 array of limbs).

Then, as `fast_mul` is cleaned up it again frees an integer (the variable "n").  This is a large integer so it trips the semi-arbitrary condition:

```python
        # Here we free any extra memory used by the mpz_t by
        # setting it to a single limb.
        if o_mpz._mp_alloc > 10:
            _mpz_realloc(o_mpz, 1)
```

and this `realloc` happens to give back the same `size=1` array that was previously just freed.  So both `_mp_d` end up with the same pointer.



---

archive/issue_comments_347010.json:
```json
{
    "body": "<a id='comment:28'></a>I'm still doing more testing, but I seem to have fixed it by wrapping any call to `_mpz_realloc` *and* anything that *calls* `_mpz_realloc` with `sig_block/unblock()`.  But a better solution would be nice since the category of \"anything that calls `_mpz_realloc`\" includes most `mpz_` functions.",
    "created_at": "2018-03-16T15:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347010",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'></a>I'm still doing more testing, but I seem to have fixed it by wrapping any call to `_mpz_realloc` *and* anything that *calls* `_mpz_realloc` with `sig_block/unblock()`.  But a better solution would be nice since the category of "anything that calls `_mpz_realloc`" includes most `mpz_` functions.



---

archive/issue_comments_347011.json:
```json
{
    "body": "<a id='comment:29'></a>I'm afraid that this is essentially an unsolvable problem. It's well known that `longjmp()` (used by cysignals) can mess up the internal state of objects. In cysignals, I implemented safe memory allocation functions like `sig_malloc()` because those were the most common source of breakage. But of course, things can break in other ways.",
    "created_at": "2018-03-16T15:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347011",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>I'm afraid that this is essentially an unsolvable problem. It's well known that `longjmp()` (used by cysignals) can mess up the internal state of objects. In cysignals, I implemented safe memory allocation functions like `sig_malloc()` because those were the most common source of breakage. But of course, things can break in other ways.



---

archive/issue_comments_347012.json:
```json
{
    "body": "<a id='comment:30'></a>Right--in general it's not completely solvable.  For this case we do have some ways forward, however.\n\n1. In GMP/MPIR it's already possible to pass custom memory allocation functions.  We can set our own `realloc` for it to use, but what we really need here is to be able to set our own function for `_mpz_realloc`.  A pluggable interface for this could be provided as well (for now requiring a patch of course).\n\n2. In the context of fast allocation of integers, we might just have to rethink the extent to which we muck around with the internals, at the cost of some efficiency in some cases.\n\nI don't think this bug is specific to Cygwin. It just showed up there perhaps due to the larger overhead in memory allocation functions or similar reasons.",
    "created_at": "2018-03-16T16:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347012",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>Right--in general it's not completely solvable.  For this case we do have some ways forward, however.

1. In GMP/MPIR it's already possible to pass custom memory allocation functions.  We can set our own `realloc` for it to use, but what we really need here is to be able to set our own function for `_mpz_realloc`.  A pluggable interface for this could be provided as well (for now requiring a patch of course).

2. In the context of fast allocation of integers, we might just have to rethink the extent to which we muck around with the internals, at the cost of some efficiency in some cases.

I don't think this bug is specific to Cygwin. It just showed up there perhaps due to the larger overhead in memory allocation functions or similar reasons.



---

archive/issue_comments_347013.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 embray]:\n> 2. In the context of fast allocation of integers, we might just have to rethink the extent to which we muck around with the internals, at the cost of some efficiency in some cases.\n\n\nThat's not really the problem here. The internal state is already messed up before that.",
    "created_at": "2018-03-16T16:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347013",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>Replying to [comment:30 embray]:
> 2. In the context of fast allocation of integers, we might just have to rethink the extent to which we muck around with the internals, at the cost of some efficiency in some cases.


That's not really the problem here. The internal state is already messed up before that.



---

archive/issue_comments_347014.json:
```json
{
    "body": "<a id='comment:32'></a>The potential for problems is reduce if, say, we `mpz_clear` before placing objects back in the pool, and `mpz_init` when taking them out.  That's what I mean.  That could mean a big loss in performance if integers of the same size are being created and destroyed rapidly, but there's also an extent to which we should trust the memory allocator to handle that case efficiently as well.",
    "created_at": "2018-03-16T16:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347014",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>The potential for problems is reduce if, say, we `mpz_clear` before placing objects back in the pool, and `mpz_init` when taking them out.  That's what I mean.  That could mean a big loss in performance if integers of the same size are being created and destroyed rapidly, but there's also an extent to which we should trust the memory allocator to handle that case efficiently as well.



---

archive/issue_comments_347015.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:32 embray]:\n> The potential for problems is reduce if, say, we `mpz_clear` before placing objects back in the pool, and `mpz_init` when taking them out.\n\n\nI don't see why. How is this bug even related to the integer pool?",
    "created_at": "2018-03-16T16:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347015",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>Replying to [comment:32 embray]:
> The potential for problems is reduce if, say, we `mpz_clear` before placing objects back in the pool, and `mpz_init` when taking them out.


I don't see why. How is this bug even related to the integer pool?



---

archive/issue_comments_347016.json:
```json
{
    "body": "<a id='comment:34'></a>Maybe I haven't explained the issue well enough.  The bug has everything to do with the integer pool.  Of course, as you say, there are many contexts where an interrupt could leave a datastructure in an incomplete state, as is happening here with the `mpz_t`s.\n\nThis isn't usually a problem, because in most cases we have Cysignals turned on, which means an exception is raised and, in most cases (but not all--therein is still a problem) the computation is aborted and the relevant datastructures are cleaned up anyways and it doesn't entirely matter if they're consistent or not (here there is still a potential for double-frees and the like, and that would be a bug too, albeit a slightly different one).\n\nWhen it comes to the integer pool that's not the case, because instead of completely cleaning up and destroying the relevant data structures, we're always assuming that when an `Integer` is returned to the pool that it's in a sane, consistent state (or at the very least, that its `_mp_d` pointer is still valid).  And that's clearly not the case.\n\nThe deeper underlying problem here is not the bug.  The bug is that the integer pool makes it too easy to keep around invalid datastructures.",
    "created_at": "2018-03-16T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347016",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>Maybe I haven't explained the issue well enough.  The bug has everything to do with the integer pool.  Of course, as you say, there are many contexts where an interrupt could leave a datastructure in an incomplete state, as is happening here with the `mpz_t`s.

This isn't usually a problem, because in most cases we have Cysignals turned on, which means an exception is raised and, in most cases (but not all--therein is still a problem) the computation is aborted and the relevant datastructures are cleaned up anyways and it doesn't entirely matter if they're consistent or not (here there is still a potential for double-frees and the like, and that would be a bug too, albeit a slightly different one).

When it comes to the integer pool that's not the case, because instead of completely cleaning up and destroying the relevant data structures, we're always assuming that when an `Integer` is returned to the pool that it's in a sane, consistent state (or at the very least, that its `_mp_d` pointer is still valid).  And that's clearly not the case.

The deeper underlying problem here is not the bug.  The bug is that the integer pool makes it too easy to keep around invalid datastructures.



---

archive/issue_comments_347017.json:
```json
{
    "body": "<a id='comment:35'></a>~~I suppose one other possibility, is we replace the GMP memory allocation functions with ones that trace memory allocations relevant to the integer pool, and use that to perform a quick consistency check before returning objects to the pool.  Would have to think about how to do this in a way that does not have too awful overhead...~~\n\nNo, this would suck, because there would be no obvious way to enable that behavior only for the relevant contexts.",
    "created_at": "2018-03-16T16:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347017",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'></a>~~I suppose one other possibility, is we replace the GMP memory allocation functions with ones that trace memory allocations relevant to the integer pool, and use that to perform a quick consistency check before returning objects to the pool.  Would have to think about how to do this in a way that does not have too awful overhead...~~

No, this would suck, because there would be no obvious way to enable that behavior only for the relevant contexts.



---

archive/issue_comments_347018.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:34 embray]:\n> When it comes to the integer pool that's not the case, because instead of completely cleaning up and destroying the relevant data structures, we're always assuming that when an `Integer` is returned to the pool that it's in a sane, consistent state\n\n\nI see what you are trying to say, but I don't agree. I believe that \"completely cleaning up and destroying the relevant data structures\" is equally unsafe as reusing that data structure. In other words, instead of getting in trouble when reusing the `mpz_t`, you will instead get in trouble when calling `mpz_clear()` on it.",
    "created_at": "2018-03-16T19:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347018",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>Replying to [comment:34 embray]:
> When it comes to the integer pool that's not the case, because instead of completely cleaning up and destroying the relevant data structures, we're always assuming that when an `Integer` is returned to the pool that it's in a sane, consistent state


I see what you are trying to say, but I don't agree. I believe that "completely cleaning up and destroying the relevant data structures" is equally unsafe as reusing that data structure. In other words, instead of getting in trouble when reusing the `mpz_t`, you will instead get in trouble when calling `mpz_clear()` on it.



---

archive/issue_comments_347019.json:
```json
{
    "body": "<a id='comment:37'></a>Just writing down a thought before I forget: temporarily disable the integer pool following an exception from cysignals, possibly even clear it. Only re-enable next time an Integer is explicitly created. Might be nice to have an alternative to `sig_on()` that can register an error callback (without having to write an explicit try/except)",
    "created_at": "2018-03-16T22:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347019",
    "user": "https://github.com/embray"
}
```

<a id='comment:37'></a>Just writing down a thought before I forget: temporarily disable the integer pool following an exception from cysignals, possibly even clear it. Only re-enable next time an Integer is explicitly created. Might be nice to have an alternative to `sig_on()` that can register an error callback (without having to write an explicit try/except)



---

archive/issue_comments_347020.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 embray]:\n> Just writing down a thought before I forget: temporarily disable the integer pool following an exception from cysignals, possibly even clear it.\n\n\nIn my opinion, this bug has nothing to do with the integer pool, so it can't be fixed by changing the integer pool implementation.",
    "created_at": "2018-03-17T07:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347020",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>Replying to [comment:37 embray]:
> Just writing down a thought before I forget: temporarily disable the integer pool following an exception from cysignals, possibly even clear it.


In my opinion, this bug has nothing to do with the integer pool, so it can't be fixed by changing the integer pool implementation.



---

archive/issue_comments_347021.json:
```json
{
    "body": "<a id='comment:39'></a>cysignals could run a gc cycle after interrupt and have a boolean flag to tell c/cython code that we are currently in this \"dangerous\" gc cycle. This seems to be a reasonable cysignals feature, allowing users to react to possibly inconsistent C data structueres. \n\nThe integer pool could use that to not recycle `mpz_t`.",
    "created_at": "2018-03-17T23:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347021",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:39'></a>cysignals could run a gc cycle after interrupt and have a boolean flag to tell c/cython code that we are currently in this "dangerous" gc cycle. This seems to be a reasonable cysignals feature, allowing users to react to possibly inconsistent C data structueres. 

The integer pool could use that to not recycle `mpz_t`.



---

archive/issue_comments_347022.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:39 vbraun]:\n> cysignals could run a gc cycle after interrupt and have a boolean flag to tell c/cython code that we are currently in this \"dangerous\" gc cycle. This seems to be a reasonable cysignals feature, allowing users to react to possibly inconsistent C data structueres.\n\n\nI see what you mean. Something like that could be done without patching GMP/MPIR.\n\nI don't think that cysignals should run the \"gc cycle\" because the broken objects will still be referenced at that time. Instead, we could somehow check if there is a live (not yet handled) `KeyboardInterrupt` exception.",
    "created_at": "2018-03-19T09:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347022",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>Replying to [comment:39 vbraun]:
> cysignals could run a gc cycle after interrupt and have a boolean flag to tell c/cython code that we are currently in this "dangerous" gc cycle. This seems to be a reasonable cysignals feature, allowing users to react to possibly inconsistent C data structueres.


I see what you mean. Something like that could be done without patching GMP/MPIR.

I don't think that cysignals should run the "gc cycle" because the broken objects will still be referenced at that time. Instead, we could somehow check if there is a live (not yet handled) `KeyboardInterrupt` exception.



---

archive/issue_comments_347023.json:
```json
{
    "body": "<a id='comment:41'></a>More concretely, here is an idea:\n\n1. Whenever `cysignals` raises an exception, it stores a pointer `cysigs.exc_value` to the exception.\n\n2. `Integer.tp_dealloc` checks whether the exception saved by cysignals equals the currently pending exception. If not, it resets `cysigs.exc_value = NULL`. If the exception matches, it assumes that the `Integer` is in a broken state and it skips `tp_dealloc` completely: it does not store in the pool and it does not call `mpz_clear` on it.",
    "created_at": "2018-03-19T09:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347023",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>More concretely, here is an idea:

1. Whenever `cysignals` raises an exception, it stores a pointer `cysigs.exc_value` to the exception.

2. `Integer.tp_dealloc` checks whether the exception saved by cysignals equals the currently pending exception. If not, it resets `cysigs.exc_value = NULL`. If the exception matches, it assumes that the `Integer` is in a broken state and it skips `tp_dealloc` completely: it does not store in the pool and it does not call `mpz_clear` on it.



---

archive/issue_comments_347024.json:
```json
{
    "body": "Changing component from memleak to cython.",
    "created_at": "2018-03-19T09:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347024",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from memleak to cython.



---

archive/issue_comments_347025.json:
```json
{
    "body": "<a id='comment:42'></a>At what point would `cysigs.exc_value` get cleared otherwise?  In `sig_on()`?\n\nI agree with you that the problem here is not just with the integer pool, but based on further analysis it's an area that is more likely than anywhere else to be affected by this, at least where Integers are concerned.  And it's worse really--if you tried to `mpz_clear` you get a double free an exception.  But in this case, because invalid `Integer`s are being recycled (but that still happen to contain valid pointers) you end up with far more insidious bugs (i.e. the values of some ints being flipped).",
    "created_at": "2018-03-19T11:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347025",
    "user": "https://github.com/embray"
}
```

<a id='comment:42'></a>At what point would `cysigs.exc_value` get cleared otherwise?  In `sig_on()`?

I agree with you that the problem here is not just with the integer pool, but based on further analysis it's an area that is more likely than anywhere else to be affected by this, at least where Integers are concerned.  And it's worse really--if you tried to `mpz_clear` you get a double free an exception.  But in this case, because invalid `Integer`s are being recycled (but that still happen to contain valid pointers) you end up with far more insidious bugs (i.e. the values of some ints being flipped).



---

archive/issue_comments_347026.json:
```json
{
    "body": "<a id='comment:43'></a>Otherwise, I think that's a pretty acceptable solution.  It *could* lead to memory leaks, but the present situation is no better in that regard.  And we can guess this will probably be a rare situation ...",
    "created_at": "2018-03-19T11:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347026",
    "user": "https://github.com/embray"
}
```

<a id='comment:43'></a>Otherwise, I think that's a pretty acceptable solution.  It *could* lead to memory leaks, but the present situation is no better in that regard.  And we can guess this will probably be a rare situation ...



---

archive/issue_comments_347027.json:
```json
{
    "body": "<a id='comment:44'></a>Although, I also don't much see the downside to wrapping most mpz_ functions with sig_block/unblock()--any that modify the internal datastructures (in such a way that involves memory allocations) of one or more of its arguments--and that aren't expected to take long to run. Of course, this would be tedious, so we'd have to generate the wrappers automatically.",
    "created_at": "2018-03-19T11:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347027",
    "user": "https://github.com/embray"
}
```

<a id='comment:44'></a>Although, I also don't much see the downside to wrapping most mpz_ functions with sig_block/unblock()--any that modify the internal datastructures (in such a way that involves memory allocations) of one or more of its arguments--and that aren't expected to take long to run. Of course, this would be tedious, so we'd have to generate the wrappers automatically.



---

archive/issue_comments_347028.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:44 embray]:\n> that aren't expected to take long to run.\n\n\nMany interesting `mpz` functions take time at least linear in the size of the input. Since we want to support large integers, they can all take a long time.\n\nPerhaps the only obvious example to apply `sig_block()`/`sig_unblock()` to would be `mpz_init()`.",
    "created_at": "2018-03-19T12:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347028",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>Replying to [comment:44 embray]:
> that aren't expected to take long to run.


Many interesting `mpz` functions take time at least linear in the size of the input. Since we want to support large integers, they can all take a long time.

Perhaps the only obvious example to apply `sig_block()`/`sig_unblock()` to would be `mpz_init()`.



---

archive/issue_comments_347029.json:
```json
{
    "body": "<a id='comment:47'></a>That brings me back to my earlier point that it would be very helpful to be able to wrap/override `_mpz_realloc` since that's worst offender with respect to memory allocations inside most mpz functions (mostly called to extend the limbs array to make room for the result).",
    "created_at": "2018-03-19T13:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347029",
    "user": "https://github.com/embray"
}
```

<a id='comment:47'></a>That brings me back to my earlier point that it would be very helpful to be able to wrap/override `_mpz_realloc` since that's worst offender with respect to memory allocations inside most mpz functions (mostly called to extend the limbs array to make room for the result).



---

archive/issue_comments_347030.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:47 embray]:\n> That brings me back to my earlier point that it would be very helpful to be able to wrap/override `_mpz_realloc`\n\n\nThat requires convincing upstream for the need of a hook there.",
    "created_at": "2018-03-19T19:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347030",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>Replying to [comment:47 embray]:
> That brings me back to my earlier point that it would be very helpful to be able to wrap/override `_mpz_realloc`


That requires convincing upstream for the need of a hook there.



---

archive/issue_comments_347031.json:
```json
{
    "body": "<a id='comment:49'></a>By the way, I tried to reproduce this problem on Linux by adding an artificial delay in `sage_sig_realloc` (to increase the chances of the alarm happening there). Unfortunately, it could not reproduce the Cygwin problem. Maybe `realloc()` is more hardened against this?",
    "created_at": "2018-03-19T20:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347031",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:49'></a>By the way, I tried to reproduce this problem on Linux by adding an artificial delay in `sage_sig_realloc` (to increase the chances of the alarm happening there). Unfortunately, it could not reproduce the Cygwin problem. Maybe `realloc()` is more hardened against this?



---

archive/issue_comments_347032.json:
```json
{
    "body": "<a id='comment:50'></a>I have been thinking about concretely implementing [comment:41]. One problem is that Cython tends to run code without an active exception set, which means that it's non-trivial to check \"the currently pending exception\".\n\nOf course, since `Integer.tp_dealloc` uses completely custom code that Cython is not aware of, we could do it there. But I would rather prefer a general solution, which would also work without a custom `tp_dealloc`.\n\nAnother idea is to check the refcount of the exception value to check whether it has been deleted. That works as long as the exception handler really deletes the exception and does not store it somehow.\n\nOr, as you proposed in [comment:42], we could explicitly clear the stored exception value under certain circumstances where we assume that we are not currently propagating an exception.\n\nMy feeling is that the refcount solution is the least likely to break: it seems unlikely that user code would catch the exception and store it in a variable. And I am assuming that REPLs don't do this either, but I'll certainly need to check that.",
    "created_at": "2018-03-19T21:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347032",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>I have been thinking about concretely implementing [comment:41]. One problem is that Cython tends to run code without an active exception set, which means that it's non-trivial to check "the currently pending exception".

Of course, since `Integer.tp_dealloc` uses completely custom code that Cython is not aware of, we could do it there. But I would rather prefer a general solution, which would also work without a custom `tp_dealloc`.

Another idea is to check the refcount of the exception value to check whether it has been deleted. That works as long as the exception handler really deletes the exception and does not store it somehow.

Or, as you proposed in [comment:42], we could explicitly clear the stored exception value under certain circumstances where we assume that we are not currently propagating an exception.

My feeling is that the refcount solution is the least likely to break: it seems unlikely that user code would catch the exception and store it in a variable. And I am assuming that REPLs don't do this either, but I'll certainly need to check that.



---

archive/issue_comments_347033.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 jdemeyer]:\n> By the way, I tried to reproduce this problem on Linux by adding an artificial delay in `sage_sig_realloc` (to increase the chances of the alarm happening there). Unfortunately, it could not reproduce the Cygwin problem. Maybe `realloc()` is more hardened against this?\n\n\nPossibly?  Or it could just be a coincidence in how the mallocs in question work.  The only reason this really becomes a problem is that the next Integer that gets allocated some memory (for its `_mp_d`) at the same address that was freed by a previous `realloc()`.  This seems to be a predicatable behavior of my malloc--I don't know the details but it's probably got some pool of small allocations with a FIFO or something.  Or as you suggested it could be the malloc in glibc is more robust in cleaning things up if it's interrupted by a signal.  Whatever the issue is it's very subtle, but could in principle happen anywhere.",
    "created_at": "2018-03-20T11:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347033",
    "user": "https://github.com/embray"
}
```

<a id='comment:51'></a>Replying to [comment:49 jdemeyer]:
> By the way, I tried to reproduce this problem on Linux by adding an artificial delay in `sage_sig_realloc` (to increase the chances of the alarm happening there). Unfortunately, it could not reproduce the Cygwin problem. Maybe `realloc()` is more hardened against this?


Possibly?  Or it could just be a coincidence in how the mallocs in question work.  The only reason this really becomes a problem is that the next Integer that gets allocated some memory (for its `_mp_d`) at the same address that was freed by a previous `realloc()`.  This seems to be a predicatable behavior of my malloc--I don't know the details but it's probably got some pool of small allocations with a FIFO or something.  Or as you suggested it could be the malloc in glibc is more robust in cleaning things up if it's interrupted by a signal.  Whatever the issue is it's very subtle, but could in principle happen anywhere.



---

archive/issue_comments_347034.json:
```json
{
    "body": "<a id='comment:52'></a>My gut feeling is that anything that relies on refcounts is going to be very fragile in its own right, but it's worth a try.\n\nSince this problem might be very difficult to solve in general, I wonder if it would be acceptable to make a temporary fix (like I already did) that just addresses this one, exact use case in the tests, just so that I don't have to have this test failing on Cygwin.  With the goal of course of removing it later.\n\nAlternatively, we should add something to the doctest framework to skip platform-specific known failures.",
    "created_at": "2018-03-20T11:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347034",
    "user": "https://github.com/embray"
}
```

<a id='comment:52'></a>My gut feeling is that anything that relies on refcounts is going to be very fragile in its own right, but it's worth a try.

Since this problem might be very difficult to solve in general, I wonder if it would be acceptable to make a temporary fix (like I already did) that just addresses this one, exact use case in the tests, just so that I don't have to have this test failing on Cygwin.  With the goal of course of removing it later.

Alternatively, we should add something to the doctest framework to skip platform-specific known failures.



---

archive/issue_comments_347035.json:
```json
{
    "body": "<a id='comment:53'></a>I'd certainly like to fix this in cysignals. However, I have lately been bitten by various breakages of cysignals on various platforms, so I'd like to improve the continuous integration of cysignals first. If you know of a free CI service that lets you run Python code on platforms other than Linux x86_64, let me know :-)",
    "created_at": "2018-03-20T12:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347035",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>I'd certainly like to fix this in cysignals. However, I have lately been bitten by various breakages of cysignals on various platforms, so I'd like to improve the continuous integration of cysignals first. If you know of a free CI service that lets you run Python code on platforms other than Linux x86_64, let me know :-)



---

archive/issue_comments_347036.json:
```json
{
    "body": "<a id='comment:54'></a>OSX is still tricky, though I think Travis-CI has it now?\n\nI can set up CI for cysignals on Cygwin if you want.",
    "created_at": "2018-03-20T12:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347036",
    "user": "https://github.com/embray"
}
```

<a id='comment:54'></a>OSX is still tricky, though I think Travis-CI has it now?

I can set up CI for cysignals on Cygwin if you want.



---

archive/issue_comments_347037.json:
```json
{
    "body": "<a id='comment:55'></a>Replying to [comment:54 embray]:\n> OSX is still tricky, though I think Travis-CI has it now?\n\n\nIn theory, yes. In practice, not so much.\n\n> I can set up CI for cysignals on Cygwin if you want.\n\n\nThat would be super-awesome. How do you plan to do that?",
    "created_at": "2018-03-20T12:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347037",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>Replying to [comment:54 embray]:
> OSX is still tricky, though I think Travis-CI has it now?


In theory, yes. In practice, not so much.

> I can set up CI for cysignals on Cygwin if you want.


That would be super-awesome. How do you plan to do that?



---

archive/issue_comments_347038.json:
```json
{
    "body": "<a id='comment:56'></a>Julian R\u00fcth suggested to try conda for Travis CI on OS X. I'll try that.",
    "created_at": "2018-03-20T12:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347038",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:56'></a>Julian Rüth suggested to try conda for Travis CI on OS X. I'll try that.



---

archive/issue_comments_347039.json:
```json
{
    "body": "<a id='comment:57'></a>Replying to [comment:55 jdemeyer]:\n> Replying to [comment:54 embray]:\n> > OSX is still tricky, though I think Travis-CI has it now?\n\n> \n> In theory, yes. In practice, not so much.\n\n\n:(\n\n> > I can set up CI for cysignals on Cygwin if you want.\n\n> \n> That would be super-awesome. How do you plan to do that?\n\n\nAppVeyor supports Cygwin, and I have set up other projects to do Cygwin builds with AppVeyor.  It will be pretty straightforward, if you just give me admin on the cysignals project on GH (if I don't already have it)",
    "created_at": "2018-03-20T15:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347039",
    "user": "https://github.com/embray"
}
```

<a id='comment:57'></a>Replying to [comment:55 jdemeyer]:
> Replying to [comment:54 embray]:
> > OSX is still tricky, though I think Travis-CI has it now?

> 
> In theory, yes. In practice, not so much.


:(

> > I can set up CI for cysignals on Cygwin if you want.

> 
> That would be super-awesome. How do you plan to do that?


AppVeyor supports Cygwin, and I have set up other projects to do Cygwin builds with AppVeyor.  It will be pretty straightforward, if you just give me admin on the cysignals project on GH (if I don't already have it)



---

archive/issue_comments_347040.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:57 embray]:\n> It will be pretty straightforward, if you just give me admin on the cysignals project on GH (if I don't already have it)\n\n\nI just did that. Could it support 32-bit and 64-bit builds? That would be great because the other CI services are 64-bit only.",
    "created_at": "2018-03-20T19:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347040",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>Replying to [comment:57 embray]:
> It will be pretty straightforward, if you just give me admin on the cysignals project on GH (if I don't already have it)


I just did that. Could it support 32-bit and 64-bit builds? That would be great because the other CI services are 64-bit only.



---

archive/issue_comments_347041.json:
```json
{
    "body": "<a id='comment:59'></a>You may also be interested in https://github.com/sagemath/cysignals/pull/76 which is about a work-in-progress native Windows port of cysignals, using mingw64.",
    "created_at": "2018-03-20T19:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347041",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:59'></a>You may also be interested in https://github.com/sagemath/cysignals/pull/76 which is about a work-in-progress native Windows port of cysignals, using mingw64.



---

archive/issue_comments_347042.json:
```json
{
    "body": "<a id='comment:60'></a>Replying to [comment:58 jdemeyer]:\n> Could it support 32-bit and 64-bit builds? That would be great because the other CI services are 64-bit only.\n\n\nWell, it has both 64-bit and 32-bit Cygwin installed on their VMs, but the underlying machine architecture is still 64-bit.",
    "created_at": "2018-03-21T09:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347042",
    "user": "https://github.com/embray"
}
```

<a id='comment:60'></a>Replying to [comment:58 jdemeyer]:
> Could it support 32-bit and 64-bit builds? That would be great because the other CI services are 64-bit only.


Well, it has both 64-bit and 32-bit Cygwin installed on their VMs, but the underlying machine architecture is still 64-bit.



---

archive/issue_events_062674.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62674"
}
```



---

archive/issue_comments_347043.json:
```json
{
    "body": "Changing keywords from \"\" to \"cygwin\".",
    "created_at": "2018-07-07T18:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347043",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "cygwin".



---

archive/issue_events_062675.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:53:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62675"
}
```



---

archive/issue_events_062676.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:53:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62676"
}
```



---

archive/issue_comments_347044.json:
```json
{
    "body": "<a id='comment:65'></a>Conceivably doable.  This will likely never have a perfect fix, but if we can get the `sig_occurred()` feature in cysignals it will help.",
    "created_at": "2018-07-18T11:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347044",
    "user": "https://github.com/embray"
}
```

<a id='comment:65'></a>Conceivably doable.  This will likely never have a perfect fix, but if we can get the `sig_occurred()` feature in cysignals it will help.



---

archive/issue_comments_347045.json:
```json
{
    "body": "<a id='comment:66'></a>Ping to self",
    "created_at": "2018-08-08T10:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347045",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:66'></a>Ping to self



---

archive/issue_events_062677.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62677"
}
```



---

archive/issue_events_062678.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62678"
}
```



---

archive/issue_comments_347046.json:
```json
{
    "body": "<a id='comment:70'></a>This doesn't quite work yet because `sig_occurred()` is being called with a live exception. Since `sig_occurred()` may call `gc.collect()`, this means trouble.\n\nReally, `sig_occurred` should check for `PyErr_Occurred()` which is both an optimization and a protection against doing GC with an exception set.\n\n---\nNew commits:",
    "created_at": "2018-12-17T15:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347046",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:70'></a>This doesn't quite work yet because `sig_occurred()` is being called with a live exception. Since `sig_occurred()` may call `gc.collect()`, this means trouble.

Really, `sig_occurred` should check for `PyErr_Occurred()` which is both an optimization and a protection against doing GC with an exception set.

---
New commits:



---

archive/issue_comments_347047.json:
```json
{
    "body": "<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-18T14:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347048.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-18T14:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347048",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_events_062679.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62679"
}
```



---

archive/issue_events_062680.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62680"
}
```



---

archive/issue_comments_347049.json:
```json
{
    "body": "<a id='comment:73'></a>Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347049",
    "user": "https://github.com/embray"
}
```

<a id='comment:73'></a>Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_347050.json:
```json
{
    "body": "<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-06T08:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347051.json:
```json
{
    "body": "<a id='comment:76'></a>Did you do anything about comment:70?  It's not clear what you did to address this, if anything.  Does cysignals 1.8.1 fix this?",
    "created_at": "2019-01-07T13:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347051",
    "user": "https://github.com/embray"
}
```

<a id='comment:76'></a>Did you do anything about comment:70?  It's not clear what you did to address this, if anything.  Does cysignals 1.8.1 fix this?



---

archive/issue_comments_347052.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-01-07T13:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347052",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_347053.json:
```json
{
    "body": "<a id='comment:78'></a>Replying to [comment:76 embray]:\n> Did you do anything about comment:70?  It's not clear what you did to address this, if anything.  Does cysignals 1.8.1 fix this?\n\n\nYes, it is fixed by cysignals 1.8.1: https://github.com/sagemath/cysignals/commit/7030f02c97f01adb50ae63b38b68c1260fe7482d",
    "created_at": "2019-01-07T13:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347053",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:78'></a>Replying to [comment:76 embray]:
> Did you do anything about comment:70?  It's not clear what you did to address this, if anything.  Does cysignals 1.8.1 fix this?


Yes, it is fixed by cysignals 1.8.1: https://github.com/sagemath/cysignals/commit/7030f02c97f01adb50ae63b38b68c1260fe7482d



---

archive/issue_comments_347054.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-01-07T13:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347054",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_347055.json:
```json
{
    "body": "<a id='comment:79'></a>Okay, great.  I'm testing now on Cygwin, and will give positive review assuming it passes.  \n\nAlso need to make sure cysignals 1.8.1 lands in Debian but that's no reason to hold up the ticket.",
    "created_at": "2019-01-07T14:07:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347055",
    "user": "https://github.com/embray"
}
```

<a id='comment:79'></a>Okay, great.  I'm testing now on Cygwin, and will give positive review assuming it passes.  

Also need to make sure cysignals 1.8.1 lands in Debian but that's no reason to hold up the ticket.



---

archive/issue_comments_347056.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-07T15:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347056",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_347057.json:
```json
{
    "body": "<a id='comment:80'></a>Been running this test in a loop for more than an hour now with no crash.  Of course, this still isn't 100% fool-proof but it's definitely much better.",
    "created_at": "2019-01-07T15:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347057",
    "user": "https://github.com/embray"
}
```

<a id='comment:80'></a>Been running this test in a loop for more than an hour now with no crash.  Of course, this still isn't 100% fool-proof but it's definitely much better.



---

archive/issue_comments_347058.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-17T17:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347058",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_347059.json:
```json
{
    "body": "<a id='comment:81'></a>See patchbot",
    "created_at": "2019-01-17T17:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347059",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:81'></a>See patchbot



---

archive/issue_comments_347060.json:
```json
{
    "body": "<a id='comment:82'></a>So this is genuinely breaking docbuild tests somehow. That's bizarre...",
    "created_at": "2019-01-17T20:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347060",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:82'></a>So this is genuinely breaking docbuild tests somehow. That's bizarre...



---

archive/issue_comments_347061.json:
```json
{
    "body": "<a id='comment:83'></a>It's the doctest change from this ticket which is breaking things. Apparently the `sphinxbuild.py` test is raising an exception and then it tries to display the traceback, long after the exception has been handled by the doctest framework. I consider this a fishy test, so the solution is fixing that test.",
    "created_at": "2019-01-17T21:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347061",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:83'></a>It's the doctest change from this ticket which is breaking things. Apparently the `sphinxbuild.py` test is raising an exception and then it tries to display the traceback, long after the exception has been handled by the doctest framework. I consider this a fishy test, so the solution is fixing that test.



---

archive/issue_comments_347062.json:
```json
{
    "body": "<a id='comment:84'></a>In fact, the test already fails on Python 3 with vanilla Sage 8.6.",
    "created_at": "2019-01-17T22:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347062",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:84'></a>In fact, the test already fails on Python 3 with vanilla Sage 8.6.



---

archive/issue_comments_347063.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-01-17T22:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347063",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_062681.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-27T10:54:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24986#event-62681"
}
```



---

archive/issue_comments_347064.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-27T10:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24986#issuecomment-347064",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
