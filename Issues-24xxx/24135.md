# Issue 24135: Clean up in coerce_dict

archive/issues_023898.json:
```json
{
    "assignees": [],
    "body": "1. Deprecate various arguments which should have been deprecated in #15367.\n\n2. Use a tuple instead of a list to throw away. This is very slightly faster.\n\n3. Use safe memory functions from cysignals instead of `PyMem` functions.\n\n4. Split `__init__` into `__cinit__` and `__init__`.\n\n5. Rename the `iteritems()` method to `items()`.\n\n6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n\n7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n\n8. Use a custom class with `@cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n\n9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n\n10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n\n21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n\n32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n\n43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n\n**Timings**:\n\nAll the changes above lead to a modest speed-up:\n\n*`MonoDict` lookup*:\n\n```\nsage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()\nsage: L = [Integer(x) for x in range(1000)]\nsage: for k in L: D[k] = k\nsage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n```\n\nBefore: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n\nAfter: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n\n*`TripleDict` lookup*:\n\n```\nsage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()\nsage: L = [(None, None, Integer(x)) for x in range(1000)]\nsage: for k in L: D[k] = None\nsage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n```\n\nBefore: `20000 loops, best of 20: 97.3 \u00b5s per loop`\n\nAfter: `20000 loops, best of 20: 87.3 \u00b5s per loop`\n\nCC:  @simon-king-jena @nbruin @tscrim @fchapoton\n\nBranch/Commit: **[`7c83e05`](https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **coercion**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24135_\n\n",
    "closed_at": "2017-12-11T01:03:17Z",
    "created_at": "2017-10-31T14:21:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20coercion",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Clean up in coerce_dict",
    "type": "issue",
    "updated_at": "2017-12-11T01:03:17Z",
    "url": "https://github.com/sagemath/sage/issues/24135",
    "user": "https://github.com/jdemeyer"
}
```
1. Deprecate various arguments which should have been deprecated in #15367.

2. Use a tuple instead of a list to throw away. This is very slightly faster.

3. Use safe memory functions from cysignals instead of `PyMem` functions.

4. Split `__init__` into `__cinit__` and `__init__`.

5. Rename the `iteritems()` method to `items()`.

6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.

7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.

8. Use a custom class with `@cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.

9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.

10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).

21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.

32. Change the logic of the `lookup()` methods a bit to make them easier to understand.

43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...

**Timings**:

All the changes above lead to a modest speed-up:

*`MonoDict` lookup*:

```
sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()
sage: L = [Integer(x) for x in range(1000)]
sage: for k in L: D[k] = k
sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
```

Before: `20000 loops, best of 20: 72.7 µs per loop`

After: `20000 loops, best of 20: 64.5 µs per loop`

*`TripleDict` lookup*:

```
sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()
sage: L = [(None, None, Integer(x)) for x in range(1000)]
sage: for k in L: D[k] = None
sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
```

Before: `20000 loops, best of 20: 97.3 µs per loop`

After: `20000 loops, best of 20: 87.3 µs per loop`

CC:  @simon-king-jena @nbruin @tscrim @fchapoton

Branch/Commit: **[`7c83e05`](https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3)**

Reviewer: **Travis Scrimshaw**

Author: **Jeroen Demeyer**

Component: **coercion**

_Issue created by migration from https://trac.sagemath.org/ticket/24135_





---

archive/issue_events_334958.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-10-31T14:21:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334958"
}
```



---

archive/issue_events_334959.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-10-31T14:21:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20coercion",
    "label_color": "0000ff",
    "label_name": "c: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334959"
}
```



---

archive/issue_events_334960.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-10-31T14:21:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334960"
}
```



---

archive/issue_events_334961.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-10-31T14:21:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334961"
}
```



---

archive/issue_comments_365188.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,9 @@\n+#. Deprecate various arguments which should have been deprecated in #15367.\n \n+#. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+#. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+#. Split `__init__` into `__cinit__` and `__init__`.\n+\n+#. Generic code cleanup.\n``````\n",
    "created_at": "2017-10-31T16:17:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365188",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,9 @@
+#. Deprecate various arguments which should have been deprecated in #15367.
 
+#. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+#. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+#. Split `__init__` into `__cinit__` and `__init__`.
+
+#. Generic code cleanup.
``````




---

archive/issue_comments_365189.json:
```json
{
    "body": "Branch: **[u/jdemeyer/clean_up_in_coerce_dict](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/clean_up_in_coerce_dict)**",
    "created_at": "2017-10-31T16:21:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365189",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/clean_up_in_coerce_dict](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/clean_up_in_coerce_dict)**



---

archive/issue_comments_365190.json:
```json
{
    "body": "Commit: **[`5abd7b8`](https://github.com/sagemath/sagetrac-mirror/commit/5abd7b8d5f12fd2d1b516d17feed7407c87381e1)**",
    "created_at": "2017-10-31T22:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365190",
    "user": "https://github.com/tscrim"
}
```

Commit: **[`5abd7b8`](https://github.com/sagemath/sagetrac-mirror/commit/5abd7b8d5f12fd2d1b516d17feed7407c87381e1)**



---

archive/issue_comments_365191.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5abd7b8d5f12fd2d1b516d17feed7407c87381e1\">5abd7b8</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>\n",
    "created_at": "2017-10-31T22:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365191",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:3"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5abd7b8d5f12fd2d1b516d17feed7407c87381e1">5abd7b8</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>




---

archive/issue_comments_365192.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,9 +1,11 @@\n-#. Deprecate various arguments which should have been deprecated in #15367.\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n-#. Use a tuple instead of a list to throw away. This is very slightly faster.\n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n \n-#. Use safe memory functions from cysignals instead of `PyMem` functions.\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n \n-#. Split `__init__` into `__cinit__` and `__init__`.\n+4. Split `__init__` into `__cinit__` and `__init__`.\n \n-#. Generic code cleanup.\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Generic code cleanup.\n``````\n",
    "created_at": "2017-11-01T08:07:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365192",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,9 +1,11 @@
-#. Deprecate various arguments which should have been deprecated in #15367.
+1. Deprecate various arguments which should have been deprecated in #15367.
 
-#. Use a tuple instead of a list to throw away. This is very slightly faster.
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
 
-#. Use safe memory functions from cysignals instead of `PyMem` functions.
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
 
-#. Split `__init__` into `__cinit__` and `__init__`.
+4. Split `__init__` into `__cinit__` and `__init__`.
 
-#. Generic code cleanup.
+5. Rename the `iteritems()` method to `items()`.
+
+6. Generic code cleanup.
``````




---

archive/issue_comments_365193.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,4 +8,6 @@\n \n 5. Rename the `iteritems()` method to `items()`.\n \n-6. Generic code cleanup.\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Generic code cleanup.\n``````\n",
    "created_at": "2017-11-01T09:13:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365193",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,4 +8,6 @@
 
 5. Rename the `iteritems()` method to `items()`.
 
-6. Generic code cleanup.
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Generic code cleanup.
``````




---

archive/issue_comments_365194.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,4 +10,6 @@\n \n 6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n \n-7. Generic code cleanup.\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Generic code cleanup.\n``````\n",
    "created_at": "2017-11-01T09:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365194",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,4 +10,6 @@
 
 6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
 
-7. Generic code cleanup.
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Generic code cleanup.
``````




---

archive/issue_comments_365195.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dbf3831736b3ae1e20adc65d334da8764ebcf74c\">dbf3831</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>\n",
    "created_at": "2017-11-01T17:00:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365195",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dbf3831736b3ae1e20adc65d334da8764ebcf74c">dbf3831</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>




---

archive/issue_comments_365196.json:
```json
{
    "body": "Changed commit from **[`5abd7b8`](https://github.com/sagemath/sagetrac-mirror/commit/5abd7b8d5f12fd2d1b516d17feed7407c87381e1)** to **[`dbf3831`](https://github.com/sagemath/sagetrac-mirror/commit/dbf3831736b3ae1e20adc65d334da8764ebcf74c)**",
    "created_at": "2017-11-01T17:00:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365196",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5abd7b8`](https://github.com/sagemath/sagetrac-mirror/commit/5abd7b8d5f12fd2d1b516d17feed7407c87381e1)** to **[`dbf3831`](https://github.com/sagemath/sagetrac-mirror/commit/dbf3831736b3ae1e20adc65d334da8764ebcf74c)**



---

archive/issue_events_334962.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-01T17:02:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334962"
}
```



---

archive/issue_comments_365197.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,4 +12,6 @@\n \n 7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n \n-8. Generic code cleanup.\n+8. Use a custom class with `@cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. Generic code cleanup.\n``````\n",
    "created_at": "2017-11-01T17:02:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365197",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,4 +12,6 @@
 
 7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
 
-8. Generic code cleanup.
+8. Use a custom class with `@cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. Generic code cleanup.
``````




---

archive/issue_comments_365198.json:
```json
{
    "body": "Changed commit from **[`dbf3831`](https://github.com/sagemath/sagetrac-mirror/commit/dbf3831736b3ae1e20adc65d334da8764ebcf74c)** to **[`15fe12d`](https://github.com/sagemath/sagetrac-mirror/commit/15fe12d7f8b74204c1704ad860810df874294b4d)**",
    "created_at": "2017-11-01T17:24:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365198",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`dbf3831`](https://github.com/sagemath/sagetrac-mirror/commit/dbf3831736b3ae1e20adc65d334da8764ebcf74c)** to **[`15fe12d`](https://github.com/sagemath/sagetrac-mirror/commit/15fe12d7f8b74204c1704ad860810df874294b4d)**



---

archive/issue_comments_365199.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/15fe12d7f8b74204c1704ad860810df874294b4d\">15fe12d</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>\n",
    "created_at": "2017-11-01T17:24:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365199",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/15fe12d7f8b74204c1704ad860810df874294b4d">15fe12d</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>




---

archive/issue_comments_365200.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\ncc chapoton because this is also relevant for Python 3.",
    "created_at": "2017-11-01T17:52:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365200",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

cc chapoton because this is also relevant for Python 3.



---

archive/issue_comments_365201.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nCan you also justify 8 a little too? I was only able to get a loose understanding from a quick search.\n\nMaybe I am too traditional, but why remove the explicit return values?\n\n```diff\ndiff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx\nindex bbd1ca7..cc2d04f 100644\n--- a/src/sage/structure/coerce_dict.pyx\n+++ b/src/sage/structure/coerce_dict.pyx\n@@ -821,16 +869,15 @@ cdef class MonoDict:\n #on cyclic GC)\n \n cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):\n-    if op.table == NULL:\n+    if op.table is NULL:\n         return 0\n     Py_VISIT3(<PyObject*>op.eraser, visit, arg)\n     cdef size_t i\n     for i in range(op.mask + 1):\n         cursor = &op.table[i]\n-        if cursor.key_id != NULL and cursor.key_id != dummy:\n+        if valid(cursor.key_id):\n             Py_VISIT3(cursor.key_weakref, visit, arg)\n             Py_VISIT3(cursor.value, visit, arg)\n-    return 0\n@@ -859,16 +906,17 @@ cdef int MonoDict_clear(MonoDict op):\n     del tmp\n     for i in range(mask+1):\n         cursor = &(table[i])\n-        if cursor.key_id != NULL and cursor.key_id != dummy:\n+        if valid(cursor.key_id):\n             cursor.key_id = dummy\n             Py_XDECREF(cursor.key_weakref)\n             Py_XDECREF(cursor.value)\n-    PyMem_Free(table)\n-    return 0\n+    sig_free(table)\n+\n \n (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)\n (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)\n \n+\n cdef class TripleDictEraser:\n     \"\"\"\n     Erases items from a :class:`TripleDict` when a weak reference becomes\n```\n\nI am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).\n\nTrivial and I know you essentially simply moved it, but only 2 spaces instead of 4:\n\n```\n    sage: K.<t> = GF(2^55)\n    sage: for i in range(50):\n    ....:   a = K.random_element()\n    ....:   E = EllipticCurve(j=a)\n    ....:   P = E.random_point()\n    ....:   Q = 2*P\n```\nAlso with its new placement, it does not need an `#indirect doctest`.",
    "created_at": "2017-11-01T22:30:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365201",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:11" align="right">comment:11</div>

Can you also justify 8 a little too? I was only able to get a loose understanding from a quick search.

Maybe I am too traditional, but why remove the explicit return values?

```diff
diff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx
index bbd1ca7..cc2d04f 100644
--- a/src/sage/structure/coerce_dict.pyx
+++ b/src/sage/structure/coerce_dict.pyx
@@ -821,16 +869,15 @@ cdef class MonoDict:
 #on cyclic GC)
 
 cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):
-    if op.table == NULL:
+    if op.table is NULL:
         return 0
     Py_VISIT3(<PyObject*>op.eraser, visit, arg)
     cdef size_t i
     for i in range(op.mask + 1):
         cursor = &op.table[i]
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             Py_VISIT3(cursor.key_weakref, visit, arg)
             Py_VISIT3(cursor.value, visit, arg)
-    return 0
@@ -859,16 +906,17 @@ cdef int MonoDict_clear(MonoDict op):
     del tmp
     for i in range(mask+1):
         cursor = &(table[i])
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             cursor.key_id = dummy
             Py_XDECREF(cursor.key_weakref)
             Py_XDECREF(cursor.value)
-    PyMem_Free(table)
-    return 0
+    sig_free(table)
+
 
 (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)
 (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)
 
+
 cdef class TripleDictEraser:
     """
     Erases items from a :class:`TripleDict` when a weak reference becomes
```

I am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Trivial and I know you essentially simply moved it, but only 2 spaces instead of 4:

```
    sage: K.<t> = GF(2^55)
    sage: for i in range(50):
    ....:   a = K.random_element()
    ....:   E = EllipticCurve(j=a)
    ....:   P = E.random_point()
    ....:   Q = 2*P
```
Also with its new placement, it does not need an `#indirect doctest`.



---

archive/issue_comments_365202.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@tscrim](#comment:11):\n> Maybe I am too traditional, but why remove the explicit return values?\n\nConceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.",
    "created_at": "2017-11-02T11:15:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365202",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@tscrim](#comment:11):
> Maybe I am too traditional, but why remove the explicit return values?

Conceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.



---

archive/issue_comments_365203.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,4 +14,6 @@\n \n 8. Use a custom class with `@cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n \n-9. Generic code cleanup.\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Generic code cleanup.\n``````\n",
    "created_at": "2017-11-02T11:58:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365203",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,4 +14,6 @@
 
 8. Use a custom class with `@cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
 
-9. Generic code cleanup.
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Generic code cleanup.
``````




---

archive/issue_comments_365204.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,4 +16,6 @@\n \n 9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n \n-10. Generic code cleanup.\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.\n+\n+21. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n``````\n",
    "created_at": "2017-11-02T14:12:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365204",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,4 +16,6 @@
 
 9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
 
-10. Generic code cleanup.
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.
+
+21. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
``````




---

archive/issue_comments_365205.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,4 +18,6 @@\n \n 10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.\n \n-21. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means.\n+\n+32. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n``````\n",
    "created_at": "2017-11-02T14:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365205",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,4 +18,6 @@
 
 10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.
 
-21. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means.
+
+32. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
``````




---

archive/issue_comments_365206.json:
```json
{
    "body": "Changed commit from **[`15fe12d`](https://github.com/sagemath/sagetrac-mirror/commit/15fe12d7f8b74204c1704ad860810df874294b4d)** to **[`347a7c5`](https://github.com/sagemath/sagetrac-mirror/commit/347a7c544f589d5306b14f24d51ba8da41cfa535)**",
    "created_at": "2017-11-02T15:09:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365206",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`15fe12d`](https://github.com/sagemath/sagetrac-mirror/commit/15fe12d7f8b74204c1704ad860810df874294b4d)** to **[`347a7c5`](https://github.com/sagemath/sagetrac-mirror/commit/347a7c544f589d5306b14f24d51ba8da41cfa535)**



---

archive/issue_comments_365207.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/347a7c544f589d5306b14f24d51ba8da41cfa535\">347a7c5</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>\n",
    "created_at": "2017-11-02T15:09:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365207",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/347a7c544f589d5306b14f24d51ba8da41cfa535">347a7c5</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>




---

archive/issue_comments_365208.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@tscrim](#comment:11):\n> Can you also justify 8 a little too?\n\nThe new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the `@cython.freelist()` should make it extremely fast too.",
    "created_at": "2017-11-02T15:11:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365208",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@tscrim](#comment:11):
> Can you also justify 8 a little too?

The new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the `@cython.freelist()` should make it extremely fast too.



---

archive/issue_comments_365209.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@tscrim](#comment:11):\n> I am assuming 5 is for better consistency with Python3.\n\nObviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.\n\n> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).\n\nDone.",
    "created_at": "2017-11-02T15:12:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365209",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@tscrim](#comment:11):
> I am assuming 5 is for better consistency with Python3.

Obviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.

> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Done.



---

archive/issue_comments_365210.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,4 +20,6 @@\n \n 21. Rename `dummy` -> `deleted_key` to make it more clear what it means.\n \n-32. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n+\n+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n``````\n",
    "created_at": "2017-11-02T15:13:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365210",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,4 +20,6 @@
 
 21. Rename `dummy` -> `deleted_key` to make it more clear what it means.
 
-32. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
+
+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
``````




---

archive/issue_comments_365211.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI ended up doing a lot more cleanup in this version. Please review.",
    "created_at": "2017-11-02T15:13:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365211",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

I ended up doing a lot more cleanup in this version. Please review.



---

archive/issue_comments_365212.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87a01932994209c9581c90e21de2e8c9e3573970\">87a0193</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>\n",
    "created_at": "2017-11-02T18:24:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365212",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87a01932994209c9581c90e21de2e8c9e3573970">87a0193</a></td><td><code>Clean up in coerce_dict</code></td></tr></table>




---

archive/issue_comments_365213.json:
```json
{
    "body": "Changed commit from **[`347a7c5`](https://github.com/sagemath/sagetrac-mirror/commit/347a7c544f589d5306b14f24d51ba8da41cfa535)** to **[`87a0193`](https://github.com/sagemath/sagetrac-mirror/commit/87a01932994209c9581c90e21de2e8c9e3573970)**",
    "created_at": "2017-11-02T18:24:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365213",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`347a7c5`](https://github.com/sagemath/sagetrac-mirror/commit/347a7c544f589d5306b14f24d51ba8da41cfa535)** to **[`87a0193`](https://github.com/sagemath/sagetrac-mirror/commit/87a01932994209c9581c90e21de2e8c9e3573970)**



---

archive/issue_comments_365214.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThank you for the explanations. All of the changes make sense to me.\n\nHowever, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.",
    "created_at": "2017-11-02T22:01:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365214",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:21" align="right">comment:21</div>

Thank you for the explanations. All of the changes make sense to me.

However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.



---

archive/issue_events_334963.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-11-02T22:01:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334963"
}
```



---

archive/issue_events_334964.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-11-02T22:01:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334964"
}
```



---

archive/issue_events_334965.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-02T22:12:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334965"
}
```



---

archive/issue_events_334966.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-02T22:12:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334966"
}
```



---

archive/issue_comments_365215.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@tscrim](#comment:21):\n> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.\n\nI know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.\n\nBy the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.\n\nIf there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.",
    "created_at": "2017-11-02T22:12:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365215",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@tscrim](#comment:21):
> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.

I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.



---

archive/issue_comments_365216.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,7 +8,7 @@\n \n 5. Rename the `iteritems()` method to `items()`.\n \n-6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n \n 7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n \n@@ -16,9 +16,9 @@\n \n 9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n \n-10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n \n-21. Rename `dummy` -> `deleted_key` to make it more clear what it means.\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n \n 32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n \n``````\n",
    "created_at": "2017-11-02T22:12:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365216",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,7 +8,7 @@
 
 5. Rename the `iteritems()` method to `items()`.
 
-6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.
 
 7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
 
@@ -16,9 +16,9 @@
 
 9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
 
-10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).
 
-21. Rename `dummy` -> `deleted_key` to make it more clear what it means.
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.
 
 32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
 
``````




---

archive/issue_comments_365217.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@jdemeyer](#comment:22):\n> Replying to [@tscrim](#comment:21):\n> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.\n\n> \n> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.\n\nAh, I see. I couldn't quite tell if the patchbot reports were current or not.\n\n> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.\n\nIt's good to get things done.\n\n> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.\n\nI think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.",
    "created_at": "2017-11-02T22:22:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365217",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@jdemeyer](#comment:22):
> Replying to [@tscrim](#comment:21):
> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.

> 
> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

It's good to get things done.

> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.

I think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.



---

archive/issue_comments_365218.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@tscrim](#comment:23):\n> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.\n\nI believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of \"pending\", meaning that no patchbot has tested this latest version.",
    "created_at": "2017-11-02T22:59:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365218",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@tscrim](#comment:23):
> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.



---

archive/issue_comments_365219.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jdemeyer](#comment:24):\n> Replying to [@tscrim](#comment:23):\n> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.\n\n> \n> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of \"pending\", meaning that no patchbot has tested this latest version.\n\nI've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.",
    "created_at": "2017-11-02T23:21:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365219",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jdemeyer](#comment:24):
> Replying to [@tscrim](#comment:23):
> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

> 
> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.

I've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.



---

archive/issue_comments_365220.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nGreenbot.",
    "created_at": "2017-11-03T03:40:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365220",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:26" align="right">comment:26</div>

Greenbot.



---

archive/issue_comments_365221.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-11-03T03:40:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365221",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_events_334967.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-11-03T03:40:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334967"
}
```



---

archive/issue_events_334968.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-11-03T03:40:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334968"
}
```



---

archive/issue_comments_365222.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,3 +23,18 @@\n 32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n \n 43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n+\n+**Timings**:\n+\n+*`MonoDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()\n+sage: L = [Integer(x) for x in range(1000)]\n+sage: for k in L: D[k] = k\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n+\n+After: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n``````\n",
    "created_at": "2017-11-03T09:33:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365222",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,3 +23,18 @@
 32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
 
 43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
+
+**Timings**:
+
+*`MonoDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()
+sage: L = [Integer(x) for x in range(1000)]
+sage: for k in L: D[k] = k
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 72.7 µs per loop`
+
+After: `20000 loops, best of 20: 64.5 µs per loop`
``````




---

archive/issue_comments_365223.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,6 +26,8 @@\n \n **Timings**:\n \n+All the changes above lead to a modest speed-up:\n+\n *`MonoDict` lookup*:\n \n ```\n@@ -38,3 +40,16 @@\n Before: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n \n After: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n+\n+*`TripleDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()\n+sage: L = [(None, None, Integer(x)) for x in range(1000)]\n+sage: for k in L: D[k] = None\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 97.3 \u00b5s per loop`\n+\n+After\" `20000 loops, best of 20: 87.3 \u00b5s per loop`\n``````\n",
    "created_at": "2017-11-03T09:50:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365223",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,6 +26,8 @@
 
 **Timings**:
 
+All the changes above lead to a modest speed-up:
+
 *`MonoDict` lookup*:
 
 ```
@@ -38,3 +40,16 @@
 Before: `20000 loops, best of 20: 72.7 µs per loop`
 
 After: `20000 loops, best of 20: 64.5 µs per loop`
+
+*`TripleDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()
+sage: L = [(None, None, Integer(x)) for x in range(1000)]
+sage: for k in L: D[k] = None
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 97.3 µs per loop`
+
+After" `20000 loops, best of 20: 87.3 µs per loop`
``````




---

archive/issue_comments_365224.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -52,4 +52,4 @@\n \n Before: `20000 loops, best of 20: 97.3 \u00b5s per loop`\n \n-After\" `20000 loops, best of 20: 87.3 \u00b5s per loop`\n+After: `20000 loops, best of 20: 87.3 \u00b5s per loop`\n``````\n",
    "created_at": "2017-11-03T09:51:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365224",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -52,4 +52,4 @@
 
 Before: `20000 loops, best of 20: 97.3 µs per loop`
 
-After" `20000 loops, best of 20: 87.3 µs per loop`
+After: `20000 loops, best of 20: 87.3 µs per loop`
``````




---

archive/issue_comments_365225.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3\">7c83e05</a></td><td><code>Add comments on MonoDict/TripleDict attributes</code></td></tr></table>\n",
    "created_at": "2017-11-03T10:11:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365225",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3">7c83e05</a></td><td><code>Add comments on MonoDict/TripleDict attributes</code></td></tr></table>




---

archive/issue_events_334969.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2017-11-03T10:11:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334969"
}
```



---

archive/issue_events_334970.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2017-11-03T10:11:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334970"
}
```



---

archive/issue_comments_365226.json:
```json
{
    "body": "Changed commit from **[`87a0193`](https://github.com/sagemath/sagetrac-mirror/commit/87a01932994209c9581c90e21de2e8c9e3573970)** to **[`7c83e05`](https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3)**",
    "created_at": "2017-11-03T10:11:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365226",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`87a0193`](https://github.com/sagemath/sagetrac-mirror/commit/87a01932994209c9581c90e21de2e8c9e3573970)** to **[`7c83e05`](https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3)**



---

archive/issue_events_334971.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-03T10:12:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334971"
}
```



---

archive/issue_events_334972.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-03T10:12:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334972"
}
```



---

archive/issue_comments_365227.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nAdded some harmless comments.",
    "created_at": "2017-11-03T10:12:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365227",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Added some harmless comments.



---

archive/issue_comments_365228.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/clean_up_in_coerce_dict](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/clean_up_in_coerce_dict)** to **[`7c83e05`](https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3)**",
    "created_at": "2017-12-11T01:03:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24135#issuecomment-365228",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/clean_up_in_coerce_dict](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/clean_up_in_coerce_dict)** to **[`7c83e05`](https://github.com/sagemath/sagetrac-mirror/commit/7c83e05a8df5e3bad8c909b33835a2bc5b1920e3)**



---

archive/issue_events_334973.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:03:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334973"
}
```



---

archive/issue_events_334974.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "954f97637873d8ff0f32fae969f3c6871f9f2200",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-12-11T01:03:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24135",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24135#event-334974"
}
```
