# Issue 24135: Clean up in coerce_dict

archive/issues_023898.json:
```json
{
    "body": "1. Deprecate various arguments which should have been deprecated in #15367.\n\n2. Use a tuple instead of a list to throw away. This is very slightly faster.\n\n3. Use safe memory functions from cysignals instead of `PyMem` functions.\n\n4. Split `__init__` into `__cinit__` and `__init__`.\n\n5. Rename the `iteritems()` method to `items()`.\n\n6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n\n7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n\n8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n\n9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n\n10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n\n21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n\n32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n\n43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n\n**Timings**:\n\nAll the changes above lead to a modest speed-up:\n\n*`MonoDict` lookup*:\n\n```\nsage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()\nsage: L = [Integer(x) for x in range(1000)]\nsage: for k in L: D[k] = k\nsage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n```\n\nBefore: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n\nAfter: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n\n*`TripleDict` lookup*:\n\n```\nsage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()\nsage: L = [(None, None, Integer(x)) for x in range(1000)]\nsage: for k in L: D[k] = None\nsage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n```\n\nBefore: `20000 loops, best of 20: 97.3 \u00b5s per loop`\n\nAfter: `20000 loops, best of 20: 87.3 \u00b5s per loop`\n\nCC:  simonking @nbruin @tscrim @fchapoton\n\nBranch/Commit: 7c83e05a8df5e3bad8c909b33835a2bc5b1920e3\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24135\n\n",
    "closed_at": "2017-12-11T01:03:17Z",
    "created_at": "2017-10-31T14:21:39Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Clean up in coerce_dict",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24135",
    "user": "https://github.com/jdemeyer"
}
```
1. Deprecate various arguments which should have been deprecated in #15367.

2. Use a tuple instead of a list to throw away. This is very slightly faster.

3. Use safe memory functions from cysignals instead of `PyMem` functions.

4. Split `__init__` into `__cinit__` and `__init__`.

5. Rename the `iteritems()` method to `items()`.

6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.

7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.

8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.

9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.

10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).

21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.

32. Change the logic of the `lookup()` methods a bit to make them easier to understand.

43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...

**Timings**:

All the changes above lead to a modest speed-up:

*`MonoDict` lookup*:

```
sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()
sage: L = [Integer(x) for x in range(1000)]
sage: for k in L: D[k] = k
sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
```

Before: `20000 loops, best of 20: 72.7 µs per loop`

After: `20000 loops, best of 20: 64.5 µs per loop`

*`TripleDict` lookup*:

```
sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()
sage: L = [(None, None, Integer(x)) for x in range(1000)]
sage: for k in L: D[k] = None
sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
```

Before: `20000 loops, best of 20: 97.3 µs per loop`

After: `20000 loops, best of 20: 87.3 µs per loop`

CC:  simonking @nbruin @tscrim @fchapoton

Branch/Commit: 7c83e05a8df5e3bad8c909b33835a2bc5b1920e3

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24135





---

archive/issue_comments_356562.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+#. Deprecate various arguments which should have been deprecated in #15367.\n \n+#. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+#. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+#. Split `__init__` into `__cinit__` and `__init__`.\n+\n+#. Generic code cleanup.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-10-31T16:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356562",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,12 @@
+#. Deprecate various arguments which should have been deprecated in #15367.
 
+#. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+#. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+#. Split `__init__` into `__cinit__` and `__init__`.
+
+#. Generic code cleanup.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356563.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2017-10-31T22:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356563",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_356564.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Generic code cleanup.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-01T08:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356564",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,14 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Generic code cleanup.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356565.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Generic code cleanup.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-01T09:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356565",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,16 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Generic code cleanup.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356566.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Generic code cleanup.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-01T09:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356566",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Generic code cleanup.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356567.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-01T17:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356567",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356568.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-01T17:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356568",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_356569.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,20 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. Generic code cleanup.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-01T17:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356569",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,20 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. Generic code cleanup.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356570.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-01T17:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356570",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356571.json:
```json
{
    "body": "<a id='comment:10'></a>cc chapoton because this is also relevant for Python 3.",
    "created_at": "2017-11-01T17:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356571",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>cc chapoton because this is also relevant for Python 3.



---

archive/issue_comments_356572.json:
```json
{
    "body": "<a id='comment:11'></a>Can you also justify 8 a little too? I was only able to get a loose understanding from a quick search.\n\nMaybe I am too traditional, but why remove the explicit return values?\n\n```diff\ndiff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx\nindex bbd1ca7..cc2d04f 100644\n--- a/src/sage/structure/coerce_dict.pyx\n+++ b/src/sage/structure/coerce_dict.pyx\n@@ -821,16 +869,15 @@ cdef class MonoDict:\n #on cyclic GC)\n \n cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):\n-    if op.table == NULL:\n+    if op.table is NULL:\n         return 0\n     Py_VISIT3(<PyObject*>op.eraser, visit, arg)\n     cdef size_t i\n     for i in range(op.mask + 1):\n         cursor = &op.table[i]\n-        if cursor.key_id != NULL and cursor.key_id != dummy:\n+        if valid(cursor.key_id):\n             Py_VISIT3(cursor.key_weakref, visit, arg)\n             Py_VISIT3(cursor.value, visit, arg)\n-    return 0\n@@ -859,16 +906,17 @@ cdef int MonoDict_clear(MonoDict op):\n     del tmp\n     for i in range(mask+1):\n         cursor = &(table[i])\n-        if cursor.key_id != NULL and cursor.key_id != dummy:\n+        if valid(cursor.key_id):\n             cursor.key_id = dummy\n             Py_XDECREF(cursor.key_weakref)\n             Py_XDECREF(cursor.value)\n-    PyMem_Free(table)\n-    return 0\n+    sig_free(table)\n+\n \n (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)\n (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)\n \n+\n cdef class TripleDictEraser:\n     \"\"\"\n     Erases items from a :class:`TripleDict` when a weak reference becomes\n```\n\nI am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).\n\nTrivial and I know you essentially simply moved it, but only 2 spaces instead of 4:\n\n```\n    sage: K.<t> = GF(2^55)\n    sage: for i in range(50):\n    ....:   a = K.random_element()\n    ....:   E = EllipticCurve(j=a)\n    ....:   P = E.random_point()\n    ....:   Q = 2*P\n```\nAlso with its new placement, it does not need an `#indirect doctest`.",
    "created_at": "2017-11-01T22:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356572",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Can you also justify 8 a little too? I was only able to get a loose understanding from a quick search.

Maybe I am too traditional, but why remove the explicit return values?

```diff
diff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx
index bbd1ca7..cc2d04f 100644
--- a/src/sage/structure/coerce_dict.pyx
+++ b/src/sage/structure/coerce_dict.pyx
@@ -821,16 +869,15 @@ cdef class MonoDict:
 #on cyclic GC)
 
 cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):
-    if op.table == NULL:
+    if op.table is NULL:
         return 0
     Py_VISIT3(<PyObject*>op.eraser, visit, arg)
     cdef size_t i
     for i in range(op.mask + 1):
         cursor = &op.table[i]
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             Py_VISIT3(cursor.key_weakref, visit, arg)
             Py_VISIT3(cursor.value, visit, arg)
-    return 0
@@ -859,16 +906,17 @@ cdef int MonoDict_clear(MonoDict op):
     del tmp
     for i in range(mask+1):
         cursor = &(table[i])
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             cursor.key_id = dummy
             Py_XDECREF(cursor.key_weakref)
             Py_XDECREF(cursor.value)
-    PyMem_Free(table)
-    return 0
+    sig_free(table)
+
 
 (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)
 (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)
 
+
 cdef class TripleDictEraser:
     """
     Erases items from a :class:`TripleDict` when a weak reference becomes
```

I am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Trivial and I know you essentially simply moved it, but only 2 spaces instead of 4:

```
    sage: K.<t> = GF(2^55)
    sage: for i in range(50):
    ....:   a = K.random_element()
    ....:   E = EllipticCurve(j=a)
    ....:   P = E.random_point()
    ....:   Q = 2*P
```
Also with its new placement, it does not need an `#indirect doctest`.



---

archive/issue_comments_356573.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 tscrim]:\n> Maybe I am too traditional, but why remove the explicit return values?\n\n\nConceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.",
    "created_at": "2017-11-02T11:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356573",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:11 tscrim]:
> Maybe I am too traditional, but why remove the explicit return values?


Conceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.



---

archive/issue_comments_356574.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Generic code cleanup.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-02T11:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356574",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,22 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Generic code cleanup.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356575.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.\n+\n+21. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-02T14:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356575",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,24 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.
+
+21. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356576.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,26 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.\n+\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means.\n+\n+32. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-02T14:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356576",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,26 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.
+
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means.
+
+32. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356577.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-02T15:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356577",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356578.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:11 tscrim]:\n> Can you also justify 8 a little too?\n\n\nThe new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the ``@`cython.freelist()` should make it extremely fast too.",
    "created_at": "2017-11-02T15:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356578",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:11 tscrim]:
> Can you also justify 8 a little too?


The new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the ``@`cython.freelist()` should make it extremely fast too.



---

archive/issue_comments_356579.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:11 tscrim]:\n> I am assuming 5 is for better consistency with Python3.\n\n\nObviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.\n\n> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).\n\n\nDone.",
    "created_at": "2017-11-02T15:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356579",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:11 tscrim]:
> I am assuming 5 is for better consistency with Python3.


Obviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.

> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).


Done.



---

archive/issue_comments_356580.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,28 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.\n+\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means.\n+\n+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n+\n+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-02T15:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356580",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,28 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`.
+
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means.
+
+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
+
+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356581.json:
```json
{
    "body": "<a id='comment:19'></a>I ended up doing a lot more cleanup in this version. Please review.",
    "created_at": "2017-11-02T15:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356581",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>I ended up doing a lot more cleanup in this version. Please review.



---

archive/issue_comments_356582.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-02T18:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356582",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356583.json:
```json
{
    "body": "<a id='comment:21'></a>Thank you for the explanations. All of the changes make sense to me.\n\nHowever, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.",
    "created_at": "2017-11-02T22:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356583",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>Thank you for the explanations. All of the changes make sense to me.

However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.



---

archive/issue_comments_356584.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-02T22:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356584",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_356585.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-02T22:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356585",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_356586.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 tscrim]:\n> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.\n\n\nI know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.\n\nBy the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.\n\nIf there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.",
    "created_at": "2017-11-02T22:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356586",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replying to [comment:21 tscrim]:
> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.


I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.



---

archive/issue_comments_356587.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,28 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n+\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n+\n+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n+\n+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-02T22:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356587",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,28 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).
+
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.
+
+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
+
+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356588.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 jdemeyer]:\n> Replying to [comment:21 tscrim]:\n> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.\n\n> \n> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.\n\n\nAh, I see. I couldn't quite tell if the patchbot reports were current or not.\n\n> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.\n\n\nIt's good to get things done.\n\n> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.\n\n\nI think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.",
    "created_at": "2017-11-02T22:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356588",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 tscrim]:
> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.

> 
> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.


Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.


It's good to get things done.

> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.


I think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.



---

archive/issue_comments_356589.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 tscrim]:\n> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.\n\n\nI believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of \"pending\", meaning that no patchbot has tested this latest version.",
    "created_at": "2017-11-02T22:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356589",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:23 tscrim]:
> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.


I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.



---

archive/issue_comments_356590.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 jdemeyer]:\n> Replying to [comment:23 tscrim]:\n> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.\n\n> \n> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of \"pending\", meaning that no patchbot has tested this latest version.\n\n\nI've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.",
    "created_at": "2017-11-02T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356590",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 tscrim]:
> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

> 
> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.


I've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.



---

archive/issue_comments_356591.json:
```json
{
    "body": "<a id='comment:26'></a>Greenbot.",
    "created_at": "2017-11-03T03:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356591",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>Greenbot.



---

archive/issue_comments_356592.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-03T03:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356592",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_356593.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,43 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n+\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n+\n+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n+\n+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n+\n+**Timings**:\n+\n+*`MonoDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()\n+sage: L = [Integer(x) for x in range(1000)]\n+sage: for k in L: D[k] = k\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n+\n+After: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-03T09:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356593",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,43 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).
+
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.
+
+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
+
+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
+
+**Timings**:
+
+*`MonoDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()
+sage: L = [Integer(x) for x in range(1000)]
+sage: for k in L: D[k] = k
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 72.7 µs per loop`
+
+After: `20000 loops, best of 20: 64.5 µs per loop`
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356594.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,58 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n+\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n+\n+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n+\n+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n+\n+**Timings**:\n+\n+All the changes above lead to a modest speed-up:\n+\n+*`MonoDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()\n+sage: L = [Integer(x) for x in range(1000)]\n+sage: for k in L: D[k] = k\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n+\n+After: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n+\n+*`TripleDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()\n+sage: L = [(None, None, Integer(x)) for x in range(1000)]\n+sage: for k in L: D[k] = None\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 97.3 \u00b5s per loop`\n+\n+After\" `20000 loops, best of 20: 87.3 \u00b5s per loop`\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-03T09:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356594",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,58 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).
+
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.
+
+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
+
+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
+
+**Timings**:
+
+All the changes above lead to a modest speed-up:
+
+*`MonoDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()
+sage: L = [Integer(x) for x in range(1000)]
+sage: for k in L: D[k] = k
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 72.7 µs per loop`
+
+After: `20000 loops, best of 20: 64.5 µs per loop`
+
+*`TripleDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()
+sage: L = [(None, None, Integer(x)) for x in range(1000)]
+sage: for k in L: D[k] = None
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 97.3 µs per loop`
+
+After" `20000 loops, best of 20: 87.3 µs per loop`
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356595.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,58 @@\n+1. Deprecate various arguments which should have been deprecated in #15367.\n \n+2. Use a tuple instead of a list to throw away. This is very slightly faster.\n+\n+3. Use safe memory functions from cysignals instead of `PyMem` functions.\n+\n+4. Split `__init__` into `__cinit__` and `__init__`.\n+\n+5. Rename the `iteritems()` method to `items()`.\n+\n+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.\n+\n+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.\n+\n+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.\n+\n+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.\n+\n+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).\n+\n+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.\n+\n+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.\n+\n+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...\n+\n+**Timings**:\n+\n+All the changes above lead to a modest speed-up:\n+\n+*`MonoDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()\n+sage: L = [Integer(x) for x in range(1000)]\n+sage: for k in L: D[k] = k\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 72.7 \u00b5s per loop`\n+\n+After: `20000 loops, best of 20: 64.5 \u00b5s per loop`\n+\n+*`TripleDict` lookup*:\n+\n+```\n+sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()\n+sage: L = [(None, None, Integer(x)) for x in range(1000)]\n+sage: for k in L: D[k] = None\n+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)\n+```\n+\n+Before: `20000 loops, best of 20: 97.3 \u00b5s per loop`\n+\n+After: `20000 loops, best of 20: 87.3 \u00b5s per loop`\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2017-11-03T09:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356595",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,58 @@
+1. Deprecate various arguments which should have been deprecated in #15367.
 
+2. Use a tuple instead of a list to throw away. This is very slightly faster.
+
+3. Use safe memory functions from cysignals instead of `PyMem` functions.
+
+4. Split `__init__` into `__cinit__` and `__init__`.
+
+5. Rename the `iteritems()` method to `items()`.
+
+6. Introduce a new inline function `valid(ptr)` to replace the very common `ptr != NULL and ptr != dummy`.
+
+7. Change type of `key_id` from `void*` to `PyObject*`. This avoids a lot of casts.
+
+8. Use a custom class with ``@`cython.freelist` instead of a `PyCapsule` to wrap a `PyObject*`.
+
+9. In `tp_clear`, only delete references to elements contained in the dict. Move deallocation of the data structure to `__dealloc__`.
+
+10. Use random 31-bit multipliers (instead of `13` and `503`) in the hash function for `TripleDict`. This might give better mixing for large sizes (in any case, it can't hurt).
+
+21. Rename `dummy` -> `deleted_key` to make it more clear what it means. Also, there was no reason that this was of type `bytes`. Now it is simply created by `object()`.
+
+32. Change the logic of the `lookup()` methods a bit to make them easier to understand.
+
+43. Generic code cleanup: PEP 8, `is` instead of `==` for pointers, ...
+
+**Timings**:
+
+All the changes above lead to a modest speed-up:
+
+*`MonoDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import MonoDict; D = MonoDict()
+sage: L = [Integer(x) for x in range(1000)]
+sage: for k in L: D[k] = k
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 72.7 µs per loop`
+
+After: `20000 loops, best of 20: 64.5 µs per loop`
+
+*`TripleDict` lookup*:
+
+```
+sage: from sage.structure.coerce_dict import TripleDict; D = TripleDict()
+sage: L = [(None, None, Integer(x)) for x in range(1000)]
+sage: for k in L: D[k] = None
+sage: timeit('[D[k] for k in L]', repeat=20, number=20000)
+```
+
+Before: `20000 loops, best of 20: 97.3 µs per loop`
+
+After: `20000 loops, best of 20: 87.3 µs per loop`
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_356596.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-11-03T10:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_356597.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-11-03T10:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_356598.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-03T10:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356598",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_356599.json:
```json
{
    "body": "<a id='comment:31'></a>Added some harmless comments.",
    "created_at": "2017-11-03T10:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356599",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>Added some harmless comments.



---

archive/issue_comments_356600.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24135#issuecomment-356600",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061225.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:03:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24135",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24135#event-61225"
}
```
