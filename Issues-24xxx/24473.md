# Issue 24473: scipy build failure with changed LDFLAGS

archive/issues_024473.json:
```json
{
    "body": "Using the environment variables:\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++ --stdlib=libc++\"\nexport CXXFLAGS=\"$CXXFLAGS --stdlib=libc++\"\nexport LDFLAGS=\"$LDFLAGS -lc++ --stdlib=libc++\"\n```\nscipy fails to build with\n\n```\n    /usr/bin/gfortran -Wall -g -shared -L/home/ralf/sage/local/lib -Wl,-rpath,/h\nome/ralf/sage/local/lib -L/home/ralf/sage/local/lib/python/lib -L/home/ralf/sage\n/local/lib -lc++ --stdlib=libc++ -L/home/ralf/sage/local/lib/python/lib -L/home/\nralf/sage/local/lib build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy\n/fftpack/_fftpackmodule.o build/temp.linux-x86_64-2.7/scipy/fftpack/src/zfft.o b\nuild/temp.linux-x86_64-2.7/scipy/fftpack/src/drfft.o build/temp.linux-x86_64-2.7\n/scipy/fftpack/src/zrfft.o build/temp.linux-x86_64-2.7/scipy/fftpack/src/zfftnd.\no build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy/fftpack/src/dct.o\n build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy/fftpack/src/dst.o \nbuild/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/build/src.linux-x86_64-2.\n7/scipy/fftpack/fortranobject.o -L/home/ralf/sage/local/lib -Lbuild/temp.linux-x\n86_64-2.7 -ldfftpack -lfftpack -lpython2.7 -lgfortran -o build/lib.linux-x86_64-\n2.7/scipy/fftpack/_fftpack.so\n    gfortran: error: unrecognized command line option '--stdlib=libc++'\n```\nComplete log is attached.\n\nThe reason is that the libc++ directive is meant for linking commands using clang++. It should be filtered out when using gfortran as linker.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24710\n\n",
    "closed_at": "2018-02-12T09:24:34Z",
    "created_at": "2018-02-11T14:46:21Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "scipy build failure with changed LDFLAGS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24473",
    "user": "https://github.com/rwst"
}
```
Using the environment variables:

```
export CC="clang"
export CXX="clang++ --stdlib=libc++"
export CXXFLAGS="$CXXFLAGS --stdlib=libc++"
export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
```
scipy fails to build with

```
    /usr/bin/gfortran -Wall -g -shared -L/home/ralf/sage/local/lib -Wl,-rpath,/h
ome/ralf/sage/local/lib -L/home/ralf/sage/local/lib/python/lib -L/home/ralf/sage
/local/lib -lc++ --stdlib=libc++ -L/home/ralf/sage/local/lib/python/lib -L/home/
ralf/sage/local/lib build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy
/fftpack/_fftpackmodule.o build/temp.linux-x86_64-2.7/scipy/fftpack/src/zfft.o b
uild/temp.linux-x86_64-2.7/scipy/fftpack/src/drfft.o build/temp.linux-x86_64-2.7
/scipy/fftpack/src/zrfft.o build/temp.linux-x86_64-2.7/scipy/fftpack/src/zfftnd.
o build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy/fftpack/src/dct.o
 build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy/fftpack/src/dst.o 
build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/build/src.linux-x86_64-2.
7/scipy/fftpack/fortranobject.o -L/home/ralf/sage/local/lib -Lbuild/temp.linux-x
86_64-2.7 -ldfftpack -lfftpack -lpython2.7 -lgfortran -o build/lib.linux-x86_64-
2.7/scipy/fftpack/_fftpack.so
    gfortran: error: unrecognized command line option '--stdlib=libc++'
```
Complete log is attached.

The reason is that the libc++ directive is meant for linking commands using clang++. It should be filtered out when using gfortran as linker.

Issue created by migration from https://trac.sagemath.org/ticket/24710





---

archive/issue_comments_342979.json:
```json
{
    "body": "Attachment [scipy-0.19.1.log](tarball://root/attachments/some-uuid/ticket24710/scipy-0.19.1.log) by @rwst created at 2018-02-11 14:46:51",
    "created_at": "2018-02-11T14:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342979",
    "user": "https://github.com/rwst"
}
```

Attachment [scipy-0.19.1.log](tarball://root/attachments/some-uuid/ticket24710/scipy-0.19.1.log) by @rwst created at 2018-02-11 14:46:51



---

archive/issue_comments_342980.json:
```json
{
    "body": "With this patch scipy installs whenever `--stdlib=libc++` is used in LDFLAGS.\n\n---\nNew commits:",
    "created_at": "2018-02-11T16:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342980",
    "user": "https://github.com/rwst"
}
```

With this patch scipy installs whenever `--stdlib=libc++` is used in LDFLAGS.

---
New commits:



---

archive/issue_comments_342981.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-11T16:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342981",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_342982.json:
```json
{
    "body": "So this ticket is wontfix. Use these flags:\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++\"\nexport CLANG_DEFAULT_CXX_STDLIB=\"libc++\"\n```",
    "created_at": "2018-02-12T07:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342982",
    "user": "https://github.com/rwst"
}
```

So this ticket is wontfix. Use these flags:

```
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
```



---

archive/issue_comments_342983.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-12T07:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342983",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_062184.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T07:14:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24473#event-62184"
}
```



---

archive/issue_events_062185.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-12T09:24:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24473#event-62185"
}
```



---

archive/issue_comments_342984.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2018-02-12T09:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342984",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: invalid



---

archive/issue_comments_342985.json:
```json
{
    "body": "Perhaps closing the ticket was premature. See the comments around comment 25 in #24716: It seems that LDFLAGS is needed after all, which means that the fix from here is needed.",
    "created_at": "2018-02-13T08:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342985",
    "user": "https://github.com/simon-king-jena"
}
```

Perhaps closing the ticket was premature. See the comments around comment 25 in #24716: It seems that LDFLAGS is needed after all, which means that the fix from here is needed.



---

archive/issue_comments_342986.json:
```json
{
    "body": "Replying to [comment:6 SimonKing]:\n> It seems that LDFLAGS is needed after all\n\n\nFrom a quick look at #24716, it seems that the bug is in NTL upstream. Globally setting `LDFLAGS` to something involving C++ libraries seems wrong because `LDFLAGS` is not specific to C++.\n\nAnyway, if you want to reopen this ticket, I would like a good explanation why you need to change `LDFLAGS` globally.",
    "created_at": "2018-02-13T13:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342986",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 SimonKing]:
> It seems that LDFLAGS is needed after all


From a quick look at #24716, it seems that the bug is in NTL upstream. Globally setting `LDFLAGS` to something involving C++ libraries seems wrong because `LDFLAGS` is not specific to C++.

Anyway, if you want to reopen this ticket, I would like a good explanation why you need to change `LDFLAGS` globally.



---

archive/issue_comments_342987.json:
```json
{
    "body": "Indeed libc++ does not seem necessary after all, #24701 may be a problem of the clang version or of the libstdc++ version. My mistake was after the initial #24701 I changed two things at once (clang version and stdlib) and assumed the wrong of the two produced success.",
    "created_at": "2018-02-13T16:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342987",
    "user": "https://github.com/rwst"
}
```

Indeed libc++ does not seem necessary after all, #24701 may be a problem of the clang version or of the libstdc++ version. My mistake was after the initial #24701 I changed two things at once (clang version and stdlib) and assumed the wrong of the two produced success.



---

archive/issue_comments_342988.json:
```json
{
    "body": "This however still begs the question how it would be possible to change the standard C++ library when building Sage, if needed.",
    "created_at": "2018-02-13T16:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342988",
    "user": "https://github.com/rwst"
}
```

This however still begs the question how it would be possible to change the standard C++ library when building Sage, if needed.



---

archive/issue_comments_342989.json:
```json
{
    "body": "Replying to [comment:8 rws]:\n> Indeed libc++ does not seem necessary after all, #24701 may be a problem of the clang version or of the libstdc++ version. My mistake was after the initial #24701 I changed two things at once (clang version and stdlib) and assumed the wrong of the two produced success.\n\n\nWithout doing something about stdlib, Sage simply doesn't build for me with clang. That has of course been the first thing that I tried.",
    "created_at": "2018-02-13T16:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342989",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:8 rws]:
> Indeed libc++ does not seem necessary after all, #24701 may be a problem of the clang version or of the libstdc++ version. My mistake was after the initial #24701 I changed two things at once (clang version and stdlib) and assumed the wrong of the two produced success.


Without doing something about stdlib, Sage simply doesn't build for me with clang. That has of course been the first thing that I tried.



---

archive/issue_comments_342990.json:
```json
{
    "body": "But you didn't change your clang version, right? So how do you know your problem was only because of your missing libc++ flag? At that time I suggested so but I was wrong. ptestlong with clang-4/libstdc++ is fine here, as I just saw.",
    "created_at": "2018-02-13T16:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342990",
    "user": "https://github.com/rwst"
}
```

But you didn't change your clang version, right? So how do you know your problem was only because of your missing libc++ flag? At that time I suggested so but I was wrong. ptestlong with clang-4/libstdc++ is fine here, as I just saw.



---

archive/issue_comments_342991.json:
```json
{
    "body": "Replying to [comment:11 rws]:\n> But you didn't change your clang version, right? So how do you know your problem was only because of your missing libc++ flag? At that time I suggested so but I was wrong. ptestlong with clang-4/libstdc++ is fine here, as I just saw.\n\n\nHow to install clang-4 on ubuntu? `apt-get install clang` gives version 3.8.",
    "created_at": "2018-02-13T17:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342991",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:11 rws]:
> But you didn't change your clang version, right? So how do you know your problem was only because of your missing libc++ flag? At that time I suggested so but I was wrong. ptestlong with clang-4/libstdc++ is fine here, as I just saw.


How to install clang-4 on ubuntu? `apt-get install clang` gives version 3.8.



---

archive/issue_comments_342992.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n> How to install clang-4 on ubuntu? `apt-get install clang` gives version 3.8.\n\n\nI see: `apt-get install clang-4.0`.",
    "created_at": "2018-02-13T17:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342992",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:12 SimonKing]:
> How to install clang-4 on ubuntu? `apt-get install clang` gives version 3.8.


I see: `apt-get install clang-4.0`.



---

archive/issue_comments_342993.json:
```json
{
    "body": "I can confirm that on ubuntu with clang-4.0 Sage builds fine and passes all tests. However, I still see that some stuff that I care about is 14% slower with clang than with gcc. So, again, it is good for portability but not for production.",
    "created_at": "2018-02-14T06:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342993",
    "user": "https://github.com/simon-king-jena"
}
```

I can confirm that on ubuntu with clang-4.0 Sage builds fine and passes all tests. However, I still see that some stuff that I care about is 14% slower with clang than with gcc. So, again, it is good for portability but not for production.



---

archive/issue_comments_342994.json:
```json
{
    "body": "Thanks for testing it all on Ubuntu. So I think we can close this and recommend clang-4 with the flags `CC=clang CXX=clang++`.",
    "created_at": "2018-02-14T07:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342994",
    "user": "https://github.com/rwst"
}
```

Thanks for testing it all on Ubuntu. So I think we can close this and recommend clang-4 with the flags `CC=clang CXX=clang++`.



---

archive/issue_comments_342995.json:
```json
{
    "body": "Replying to [comment:15 rws]:\n> Thanks for testing it all on Ubuntu. So I think we can close this\n\n\n... or rather \"keep it closed\".\n\n> and recommend clang-4 with the flags `CC=clang CXX=clang++`.\n\n\nYes and no. Currently on ubuntu, \"clang\" is \"clang version 3.8\".",
    "created_at": "2018-02-14T08:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24473#issuecomment-342995",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:15 rws]:
> Thanks for testing it all on Ubuntu. So I think we can close this


... or rather "keep it closed".

> and recommend clang-4 with the flags `CC=clang CXX=clang++`.


Yes and no. Currently on ubuntu, "clang" is "clang version 3.8".
