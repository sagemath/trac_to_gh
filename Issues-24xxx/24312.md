# Issue 24312: py3: fixes to sage.misc.sageinspect

archive/issues_024075.json:
```json
{
    "body": "I felt it might be important to make sure these functions were working properly, as some of Sage's metaprogramming and related tests rely on reliable introspection.\n\nA number of the tests in this module only made sense on Python 2 due to minor syntactic differences or similar minor differences between the languages; in some cases I provided Python 3 alternatives, in other cases the test is just run on Python 2.  In still other cases I changed the test slightly to work on both, where I felt that it didn't impact the validity of the test.\n\nCC:  @nthiery\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nBranch: 1a461d1a70ca45410c36f9f7eb525e97e046042d\n\nCommit: 1a461d1a70ca45410c36f9f7eb525e97e046042d\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24312\n\n",
    "closed_at": "2018-05-08T17:27:02Z",
    "created_at": "2017-12-01T14:53:50Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "py3: fixes to sage.misc.sageinspect",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24312",
    "user": "https://github.com/embray"
}
```
I felt it might be important to make sure these functions were working properly, as some of Sage's metaprogramming and related tests rely on reliable introspection.

A number of the tests in this module only made sense on Python 2 due to minor syntactic differences or similar minor differences between the languages; in some cases I provided Python 3 alternatives, in other cases the test is just run on Python 2.  In still other cases I changed the test slightly to work on both, where I felt that it didn't impact the validity of the test.

CC:  @nthiery

Reviewer: Jeroen Demeyer

Author: Erik Bray

Branch: 1a461d1a70ca45410c36f9f7eb525e97e046042d

Commit: 1a461d1a70ca45410c36f9f7eb525e97e046042d

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24312





---

archive/issue_comments_336960.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-01T14:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336960",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336961.json:
```json
{
    "body": "<a id='comment:2'></a>Why the changes to `src/sage/misc/nested_class_test.py`?",
    "created_at": "2018-01-12T16:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336961",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Why the changes to `src/sage/misc/nested_class_test.py`?



---

archive/issue_comments_336962.json:
```json
{
    "body": "<a id='comment:3'></a>This was meant to support `unicode` in Python 2:\n\n```\n    elif isinstance(r, text_type):\n        # On Python 2, we want str, not unicode\n        return r.encode('utf-8', 'ignore')\n```\nAre you sure that this is no longer needed?",
    "created_at": "2018-01-12T16:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336962",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>This was meant to support `unicode` in Python 2:

```
    elif isinstance(r, text_type):
        # On Python 2, we want str, not unicode
        return r.encode('utf-8', 'ignore')
```
Are you sure that this is no longer needed?



---

archive/issue_comments_336963.json:
```json
{
    "body": "<a id='comment:4'></a>Did you intentionally duplicate this line\n\n```\niter_lines = iter(lines)\n```",
    "created_at": "2018-01-12T16:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336963",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Did you intentionally duplicate this line

```
iter_lines = iter(lines)
```



---

archive/issue_comments_336964.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:2 jdemeyer]:\n> Why the changes to `src/sage/misc/nested_class_test.py`?\n\n\nI don't think I intended to include that in this branch.  I can either remove it, or it can come along for the ride since it's a minor change that has to happen anyways. Up to you.",
    "created_at": "2018-01-12T16:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336964",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Replying to [comment:2 jdemeyer]:
> Why the changes to `src/sage/misc/nested_class_test.py`?


I don't think I intended to include that in this branch.  I can either remove it, or it can come along for the ride since it's a minor change that has to happen anyways. Up to you.



---

archive/issue_comments_336965.json:
```json
{
    "body": "<a id='comment:6'></a>What's up with this:\n\n```\n        sage: warnings.filterwarnings('ignore',\n        ....:                         r'inspect.getargspec\\(\\) is deprecated',\n        ....:                         DeprecationWarning)\n```\nIf it's genuinely deprecated, we shouldn't use it... silencing the warning doesn't help with that.",
    "created_at": "2018-01-12T16:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336965",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>What's up with this:

```
        sage: warnings.filterwarnings('ignore',
        ....:                         r'inspect.getargspec\(\) is deprecated',
        ....:                         DeprecationWarning)
```
If it's genuinely deprecated, we shouldn't use it... silencing the warning doesn't help with that.



---

archive/issue_comments_336966.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 embray]:\n> since it's a minor change that has to happen anyways\n\n\nPlease explain why it \"has to happen anyways\". Do you intend to replace\n\n```\nclass X\n```\nby\n\n```\nclass X(object)\n```\neverywhere?",
    "created_at": "2018-01-12T16:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336966",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:5 embray]:
> since it's a minor change that has to happen anyways


Please explain why it "has to happen anyways". Do you intend to replace

```
class X
```
by

```
class X(object)
```
everywhere?



---

archive/issue_comments_336967.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:3 jdemeyer]:\n> This was meant to support `unicode` in Python 2:\n> \n> ```\n>     elif isinstance(r, text_type):\n>         # On Python 2, we want str, not unicode\n>         return r.encode('utf-8', 'ignore')\n> ```\n> Are you sure that this is no longer needed?\n\n\nAh, I see. This needs to be fixed regardless since on Python 3 it was converting `str` to `bytes`.  I don't think it's needed on Python 2 unless there's some explicit reason that this function can't *return* a unicode string, and I don't see that there is.",
    "created_at": "2018-01-12T16:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336967",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Replying to [comment:3 jdemeyer]:
> This was meant to support `unicode` in Python 2:
> 
> ```
>     elif isinstance(r, text_type):
>         # On Python 2, we want str, not unicode
>         return r.encode('utf-8', 'ignore')
> ```
> Are you sure that this is no longer needed?


Ah, I see. This needs to be fixed regardless since on Python 3 it was converting `str` to `bytes`.  I don't think it's needed on Python 2 unless there's some explicit reason that this function can't *return* a unicode string, and I don't see that there is.



---

archive/issue_comments_336968.json:
```json
{
    "body": "<a id='comment:9'></a>This is redundant:\n\n```\n        sage: sgc(\"def dummy_python(self, *args, x=1): pass\")  # py3\n        sage: sgc(\"def dummy_cython(self, *args, x=1): pass\")\n```",
    "created_at": "2018-01-12T16:22:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336968",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>This is redundant:

```
        sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
        sage: sgc("def dummy_cython(self, *args, x=1): pass")
```



---

archive/issue_comments_336969.json:
```json
{
    "body": "<a id='comment:10'></a>Note to self: this obviously affects docbuilding. So one should check that it doesn't introduce any regressions in the documentation.",
    "created_at": "2018-01-12T16:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336969",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Note to self: this obviously affects docbuilding. So one should check that it doesn't introduce any regressions in the documentation.



---

archive/issue_comments_336970.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:7 jdemeyer]:\n> Replying to [comment:5 embray]:\n> > since it's a minor change that has to happen anyways\n\n> \n> Please explain why it \"has to happen anyways\". Do you intend to replace\n> \n> ```\n> class X\n> ```\n> by\n> \n> ```\n> class X(object)\n> ```\n> everywhere?\n\n\nThat's a tricky question, probably for discussion elsewhere (that is, if it requires further discussion I'll just remove the change from this ticket for now).  I don't think it needs to be changed *everywhere* but for the purposes of *tests* that are the same on Python 2 and Python 3 old-style classes often won't work (if nothing else their repr is different), and I would prefer to standardize on new-style classes.",
    "created_at": "2018-01-12T16:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336970",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Replying to [comment:7 jdemeyer]:
> Replying to [comment:5 embray]:
> > since it's a minor change that has to happen anyways

> 
> Please explain why it "has to happen anyways". Do you intend to replace
> 
> ```
> class X
> ```
> by
> 
> ```
> class X(object)
> ```
> everywhere?


That's a tricky question, probably for discussion elsewhere (that is, if it requires further discussion I'll just remove the change from this ticket for now).  I don't think it needs to be changed *everywhere* but for the purposes of *tests* that are the same on Python 2 and Python 3 old-style classes often won't work (if nothing else their repr is different), and I would prefer to standardize on new-style classes.



---

archive/issue_comments_336971.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 embray]:\n> I would prefer to standardize on new-style classes.\n\n\nFor the record: I agree. It's just that we should continue to support old-style classes on Python 2. So if a test is specifically meant to test old-style classes, it should be kept.\n\nIf you are in Orsay, please talk to Nicolas about this. He usually insists on using and supporting old-style classes.\n\n> if it requires further discussion I'll just remove the change from this ticket for now\n\n\nIf that's easy to do: please do so.",
    "created_at": "2018-01-12T16:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336971",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:11 embray]:
> I would prefer to standardize on new-style classes.


For the record: I agree. It's just that we should continue to support old-style classes on Python 2. So if a test is specifically meant to test old-style classes, it should be kept.

If you are in Orsay, please talk to Nicolas about this. He usually insists on using and supporting old-style classes.

> if it requires further discussion I'll just remove the change from this ticket for now


If that's easy to do: please do so.



---

archive/issue_comments_336972.json:
```json
{
    "body": "<a id='comment:13'></a>I think there are cases that makes sense, but I recall in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.",
    "created_at": "2018-01-15T09:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336972",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>I think there are cases that makes sense, but I recall in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.



---

archive/issue_comments_336973.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 embray]:\n> in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.\n\n\nThe question is not \"does this test *require* an old-style class?\". The question is \"is this meant to *test* old-style classes?\"",
    "created_at": "2018-01-15T09:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336973",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:13 embray]:
> in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.


The question is not "does this test *require* an old-style class?". The question is "is this meant to *test* old-style classes?"



---

archive/issue_comments_336974.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 embray]:\n> I think there are cases that makes sense, but I recall in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.\n\n\nSpeaking of which, it turns out that change *was* relevant to this ticket, because one of the tests in sageinspect uses `TestNestedParent` from that module.  The only reason I can tell that its even in a separate module is that it's related to testing `sage_getsource`.\n\nAnd no, it's not meant to test old-style classes.  That's what I was saying.  It would be easier to see this if we had actual test coverage analysis for Sage but this change is irrelevant to the test.",
    "created_at": "2018-01-15T09:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336974",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Replying to [comment:13 embray]:
> I think there are cases that makes sense, but I recall in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.


Speaking of which, it turns out that change *was* relevant to this ticket, because one of the tests in sageinspect uses `TestNestedParent` from that module.  The only reason I can tell that its even in a separate module is that it's related to testing `sage_getsource`.

And no, it's not meant to test old-style classes.  That's what I was saying.  It would be easier to see this if we had actual test coverage analysis for Sage but this change is irrelevant to the test.



---

archive/issue_comments_336975.json:
```json
{
    "body": "<a id='comment:16'></a>It also rather annoyingly contains an exact duplicate of most of the same doctest that's in sageinspect.  I would just as soon remove that.",
    "created_at": "2018-01-15T09:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336975",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>It also rather annoyingly contains an exact duplicate of most of the same doctest that's in sageinspect.  I would just as soon remove that.



---

archive/issue_comments_336976.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-15T10:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336976",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336977.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:15 embray]:\n> And no, it's not meant to test old-style classes.\n\n\nI'm not convinced. The test is meant to test the pattern\n\n```\nclass NewStyle(...):\n    class Element:\n        ...\n```\nwhich occurs a lot in Sage. It's not obvious to me why it doesn't matter if `Element` is a new-style or old-style class.",
    "created_at": "2018-01-15T18:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336977",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:15 embray]:
> And no, it's not meant to test old-style classes.


I'm not convinced. The test is meant to test the pattern

```
class NewStyle(...):
    class Element:
        ...
```
which occurs a lot in Sage. It's not obvious to me why it doesn't matter if `Element` is a new-style or old-style class.



---

archive/issue_comments_336978.json:
```json
{
    "body": "<a id='comment:19'></a>It's only meant to test *extracting the source code* of nested classes.  If you trace the code for doing that you'll find that it's fairly general code for nested statements in general (nested functions and classes) and just about the only point at which the fact of it being a class comes in is in calls to `inspect.isclass()` which returns True for both old-style and new-style classes on Python 2.",
    "created_at": "2018-01-16T16:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336978",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>It's only meant to test *extracting the source code* of nested classes.  If you trace the code for doing that you'll find that it's fairly general code for nested statements in general (nested functions and classes) and just about the only point at which the fact of it being a class comes in is in calls to `inspect.isclass()` which returns True for both old-style and new-style classes on Python 2.



---

archive/issue_comments_336979.json:
```json
{
    "body": "<a id='comment:20'></a>OK, let me turn the question around: if it doesn't matter whether it's an old-style or new-style class, why do you insist on changing it to a new-style class? Why not leave it alone?",
    "created_at": "2018-01-16T17:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336979",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>OK, let me turn the question around: if it doesn't matter whether it's an old-style or new-style class, why do you insist on changing it to a new-style class? Why not leave it alone?



---

archive/issue_comments_336980.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 jdemeyer]:\n> OK, let me turn the question around: if it doesn't matter whether it's an old-style or new-style class, why do you insist on changing it to a new-style class? Why not leave it alone?\n\n\nIn this case the *only* reason was because there was some part of the test that checked the repr of the nested class, and new-style and old-style classes have different reprs :(\n\nAlternatively I could add a fixup for this to the doctest parser as I've done in other cases.  This isn't the only example I've found like this.  It's usually just simpler to convert to a new-style class except in the miniscule number cases where that has an impact on what's being tested.",
    "created_at": "2018-01-16T17:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336980",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>Replying to [comment:20 jdemeyer]:
> OK, let me turn the question around: if it doesn't matter whether it's an old-style or new-style class, why do you insist on changing it to a new-style class? Why not leave it alone?


In this case the *only* reason was because there was some part of the test that checked the repr of the nested class, and new-style and old-style classes have different reprs :(

Alternatively I could add a fixup for this to the doctest parser as I've done in other cases.  This isn't the only example I've found like this.  It's usually just simpler to convert to a new-style class except in the miniscule number cases where that has an impact on what's being tested.



---

archive/issue_comments_336981.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-29T13:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336981",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336982.json:
```json
{
    "body": "<a id='comment:22'></a>Merge conflict.",
    "created_at": "2018-01-29T13:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336982",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Merge conflict.



---

archive/issue_comments_336983.json:
```json
{
    "body": "<a id='comment:23'></a>New commits:",
    "created_at": "2018-02-12T13:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336983",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>New commits:



---

archive/issue_comments_336984.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-12T13:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336984",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336985.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-12T13:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336985",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336986.json:
```json
{
    "body": "<a id='comment:24'></a>There is still the issue of replacing old-style by new-classes classes.",
    "created_at": "2018-02-12T13:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336986",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>There is still the issue of replacing old-style by new-classes classes.



---

archive/issue_comments_336987.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:12 jdemeyer]:\n> If you are in Orsay, please talk to Nicolas about this. He usually insists on using and supporting old-style classes.\n\n\nJust to clarify, let me elaborate on that. I am not specifically keen on old-style classes per se. In fact, if there would be an easy way to \"configure\" Python so that\n\n```\n    class A:\n        ...\n```\nwould always create a new style class, that would be very fine.\n\nOn the other hand, we have quite some of code in Sage *and* outside of Sage (in packages or users private code) that use the idiom:\n\n```\n    class A(...):\n        class Element:\n            ...\n```\n\nIt would not be a practical to have to change this everywhere to\n\n```\n    class A(...):\n        class Element(object):\n            ...\n```\nwhen anyway that won't be needed anymore with Python 3.\n\nCheers,",
    "created_at": "2018-02-13T22:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336987",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:26'></a>Replying to [comment:12 jdemeyer]:
> If you are in Orsay, please talk to Nicolas about this. He usually insists on using and supporting old-style classes.


Just to clarify, let me elaborate on that. I am not specifically keen on old-style classes per se. In fact, if there would be an easy way to "configure" Python so that

```
    class A:
        ...
```
would always create a new style class, that would be very fine.

On the other hand, we have quite some of code in Sage *and* outside of Sage (in packages or users private code) that use the idiom:

```
    class A(...):
        class Element:
            ...
```

It would not be a practical to have to change this everywhere to

```
    class A(...):
        class Element(object):
            ...
```
when anyway that won't be needed anymore with Python 3.

Cheers,



---

archive/issue_comments_336988.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 nthiery]:\n> In fact, if there would be an easy way to \"configure\" Python so that\n> \n> ```\n>     class A:\n>         ...\n> ```\n> would always create a new style class, that would be very fine.\n\n\nI agree. I sometimes wonder why there is no `from __future__ import new_class` in Python 2.",
    "created_at": "2018-02-14T06:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336988",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>Replying to [comment:26 nthiery]:
> In fact, if there would be an easy way to "configure" Python so that
> 
> ```
>     class A:
>         ...
> ```
> would always create a new style class, that would be very fine.


I agree. I sometimes wonder why there is no `from __future__ import new_class` in Python 2.



---

archive/issue_comments_336989.json:
```json
{
    "body": "<a id='comment:28'></a>I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.\n\nI'm going to rebase my original branch.  I really don't like bi-directional merges.  It's much harder to reason about.",
    "created_at": "2018-02-14T16:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336989",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'></a>I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.

I'm going to rebase my original branch.  I really don't like bi-directional merges.  It's much harder to reason about.



---

archive/issue_comments_336990.json:
```json
{
    "body": "<a id='comment:29'></a>New commits:",
    "created_at": "2018-02-14T16:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336990",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>New commits:



---

archive/issue_comments_336991.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-14T16:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336991",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336992.json:
```json
{
    "body": "<a id='comment:31'></a>This does not build correctly.",
    "created_at": "2018-02-19T12:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336992",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:31'></a>This does not build correctly.



---

archive/issue_comments_336993.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-19T12:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336993",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336994.json:
```json
{
    "body": "<a id='comment:32'></a>Looks like there's a missing import now--possibly somehow resulting from my last rebase.",
    "created_at": "2018-02-19T12:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336994",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Looks like there's a missing import now--possibly somehow resulting from my last rebase.



---

archive/issue_comments_336995.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-19T14:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336996.json:
```json
{
    "body": "<a id='comment:34'></a>Rebased; fixed missing import.",
    "created_at": "2018-02-19T14:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336996",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>Rebased; fixed missing import.



---

archive/issue_comments_336997.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-19T14:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336997",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336998.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-09T10:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336998",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336999.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:28 embray]:\n> I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.\n\n\nThat test is meant to test *actual usage* of nested classes. If there is actual usage of nested classes with old-style classes, it should be tested.\n\nMaybe a compromise would be to test it both with old-style and new-style classes and mark the former `# py2`.",
    "created_at": "2018-03-09T10:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-336999",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>Replying to [comment:28 embray]:
> I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.


That test is meant to test *actual usage* of nested classes. If there is actual usage of nested classes with old-style classes, it should be tested.

Maybe a compromise would be to test it both with old-style and new-style classes and mark the former `# py2`.



---

archive/issue_comments_337000.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 jdemeyer]:\n> Replying to [comment:28 embray]:\n> > I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.\n\n> \n> That test is meant to test *actual usage* of nested classes. If there is actual usage of nested classes with old-style classes, it should be tested.\n\n\nBut the functionality it's testing has nothing to do with whether or not it's an old-style class.  If it did I'd agree.  It's completely irrelevant though.",
    "created_at": "2018-03-09T10:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337000",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>Replying to [comment:35 jdemeyer]:
> Replying to [comment:28 embray]:
> > I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.

> 
> That test is meant to test *actual usage* of nested classes. If there is actual usage of nested classes with old-style classes, it should be tested.


But the functionality it's testing has nothing to do with whether or not it's an old-style class.  If it did I'd agree.  It's completely irrelevant though.



---

archive/issue_comments_337001.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:35 jdemeyer]:\n> Maybe a compromise would be to test it both with old-style and new-style classes and mark the former `# py2`.\n\n\nI'll go with your compromise, but it's still unnecessary.  You can see that the code that this affects is actually completely unconcerned with whether or not there's an `(object)` there (the regexp that checks for the first line of a class definition doesn't even care): https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/misc/sageinspect.py?id=7de19b8b561eec01557c878cdb5135bbad5fa81c#n2133",
    "created_at": "2018-03-09T11:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337001",
    "user": "https://github.com/embray"
}
```

<a id='comment:37'></a>Replying to [comment:35 jdemeyer]:
> Maybe a compromise would be to test it both with old-style and new-style classes and mark the former `# py2`.


I'll go with your compromise, but it's still unnecessary.  You can see that the code that this affects is actually completely unconcerned with whether or not there's an `(object)` there (the regexp that checks for the first line of a class definition doesn't even care): https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/misc/sageinspect.py?id=7de19b8b561eec01557c878cdb5135bbad5fa81c#n2133



---

archive/issue_comments_337002.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-03-09T11:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337003.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-09T11:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337003",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337004.json:
```json
{
    "body": "<a id='comment:40'></a>[comment:4] still applies",
    "created_at": "2018-03-09T11:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337004",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>[comment:4] still applies



---

archive/issue_comments_337005.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:40 jdemeyer]:\n> [comment:4] still applies\n\nOops, thanks.\n\nIf that's the only issue that remains I'll fix it and set positive review.",
    "created_at": "2018-03-09T11:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337005",
    "user": "https://github.com/embray"
}
```

<a id='comment:41'></a>Replying to [comment:40 jdemeyer]:
> [comment:4] still applies

Oops, thanks.

If that's the only issue that remains I'll fix it and set positive review.



---

archive/issue_comments_337006.json:
```json
{
    "body": "<a id='comment:42'></a>[comment:6] and [comment:9] still apply too",
    "created_at": "2018-03-09T11:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337006",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>[comment:6] and [comment:9] still apply too



---

archive/issue_comments_337007.json:
```json
{
    "body": "<a id='comment:43'></a>And [comment:3]",
    "created_at": "2018-03-09T11:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337007",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>And [comment:3]



---

archive/issue_comments_337008.json:
```json
{
    "body": "<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-03-09T11:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337008",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337009.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:9 jdemeyer]:\n> This is redundant:\n> \n> ```\n>         sage: sgc(\"def dummy_python(self, *args, x=1): pass\")  # py3\n>         sage: sgc(\"def dummy_cython(self, *args, x=1): pass\")\n> ```\n\n\nEffectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.",
    "created_at": "2018-03-09T11:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337009",
    "user": "https://github.com/embray"
}
```

<a id='comment:45'></a>Replying to [comment:9 jdemeyer]:
> This is redundant:
> 
> ```
>         sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
>         sage: sgc("def dummy_cython(self, *args, x=1): pass")
> ```


Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.



---

archive/issue_comments_337010.json:
```json
{
    "body": "<a id='comment:46'></a>For future reference: it would be good to separate commits like [this](https://git.sagemath.org/sage.git/commit/?id=6c09c501b19fce0b61246207d267e087f5c5b1bf) to their own ticket. They contain many trivial changes, making the diff harder to read. For now, just leave it: I'll look at the diff relative to that commit.",
    "created_at": "2018-03-09T11:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337010",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>For future reference: it would be good to separate commits like [this](https://git.sagemath.org/sage.git/commit/?id=6c09c501b19fce0b61246207d267e087f5c5b1bf) to their own ticket. They contain many trivial changes, making the diff harder to read. For now, just leave it: I'll look at the diff relative to that commit.



---

archive/issue_comments_337011.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:45 embray]:\n> Replying to [comment:9 jdemeyer]:\n> > This is redundant:\n> > \n> > ```\n> >         sage: sgc(\"def dummy_python(self, *args, x=1): pass\")  # py3\n> >         sage: sgc(\"def dummy_cython(self, *args, x=1): pass\")\n> > ```\n\n> \n> Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.\n\n\nNo, on Python 3 it performs the same test twice. And the outcome is obviously the same (apart from the \"dummy_cython\" string).",
    "created_at": "2018-03-09T11:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337011",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>Replying to [comment:45 embray]:
> Replying to [comment:9 jdemeyer]:
> > This is redundant:
> > 
> > ```
> >         sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
> >         sage: sgc("def dummy_cython(self, *args, x=1): pass")
> > ```

> 
> Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.


No, on Python 3 it performs the same test twice. And the outcome is obviously the same (apart from the "dummy_cython" string).



---

archive/issue_comments_337012.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:6 jdemeyer]:\n> What's up with this:\n> \n> ```\n>         sage: warnings.filterwarnings('ignore',\n>         ....:                         r'inspect.getargspec\\(\\) is deprecated',\n>         ....:                         DeprecationWarning)\n> ```\n> If it's genuinely deprecated, we shouldn't use it... silencing the warning doesn't help with that.\n\n\n`inspect.getargspec` is not used in any of the code, only in some of the doctests  The reason to keep it is that the output of `sage_getargspec` is the same as the output of `inspect.getargspec` and this tests that that is the case.\n\nThe only alternative would be to change `sage_getargspec` to be equivalent to `inspect.getfullargspec` which has no equivalent on Python 2, and then have separate tests for Python 2 and 3.  I'd be okay with that, but it's a slightly larger change.",
    "created_at": "2018-03-09T11:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337012",
    "user": "https://github.com/embray"
}
```

<a id='comment:48'></a>Replying to [comment:6 jdemeyer]:
> What's up with this:
> 
> ```
>         sage: warnings.filterwarnings('ignore',
>         ....:                         r'inspect.getargspec\(\) is deprecated',
>         ....:                         DeprecationWarning)
> ```
> If it's genuinely deprecated, we shouldn't use it... silencing the warning doesn't help with that.


`inspect.getargspec` is not used in any of the code, only in some of the doctests  The reason to keep it is that the output of `sage_getargspec` is the same as the output of `inspect.getargspec` and this tests that that is the case.

The only alternative would be to change `sage_getargspec` to be equivalent to `inspect.getfullargspec` which has no equivalent on Python 2, and then have separate tests for Python 2 and 3.  I'd be okay with that, but it's a slightly larger change.



---

archive/issue_comments_337013.json:
```json
{
    "body": "<a id='comment:49'></a>This change looks like it might break stuff:\n\n```diff\n@@ -2247,10 +2254,10 @@ def sage_getsourcelines(obj):\n \n     # First, we deal with nested classes. Their name contains a dot, and we\n     # have a special function for that purpose.\n-    if (not hasattr(obj, '__class__')) or (isinstance(obj, type) and type(obj) is not type):\n+    if not hasattr(obj, '__class__') or isinstance(obj, type):\n```\n\nI agree that the original code was strange (looking specifically for a metaclass different from `type`), but maybe there was a reason...",
    "created_at": "2018-03-09T11:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337013",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:49'></a>This change looks like it might break stuff:

```diff
@@ -2247,10 +2254,10 @@ def sage_getsourcelines(obj):
 
     # First, we deal with nested classes. Their name contains a dot, and we
     # have a special function for that purpose.
-    if (not hasattr(obj, '__class__')) or (isinstance(obj, type) and type(obj) is not type):
+    if not hasattr(obj, '__class__') or isinstance(obj, type):
```

I agree that the original code was strange (looking specifically for a metaclass different from `type`), but maybe there was a reason...



---

archive/issue_comments_337014.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:3 jdemeyer]:\n> This was meant to support `unicode` in Python 2:\n> \n> ```\n>     elif isinstance(r, text_type):\n>         # On Python 2, we want str, not unicode\n>         return r.encode('utf-8', 'ignore')\n> ```\n> Are you sure that this is no longer needed?\n\n\nI see--this should probably updated so that the previous line is `isinstance(r, six.string_types)`.  The fact that this was encoding unicode docstrings to utf-8 is definitely wrong.  They should just be kept as unicode.",
    "created_at": "2018-03-09T11:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337014",
    "user": "https://github.com/embray"
}
```

<a id='comment:50'></a>Replying to [comment:3 jdemeyer]:
> This was meant to support `unicode` in Python 2:
> 
> ```
>     elif isinstance(r, text_type):
>         # On Python 2, we want str, not unicode
>         return r.encode('utf-8', 'ignore')
> ```
> Are you sure that this is no longer needed?


I see--this should probably updated so that the previous line is `isinstance(r, six.string_types)`.  The fact that this was encoding unicode docstrings to utf-8 is definitely wrong.  They should just be kept as unicode.



---

archive/issue_comments_337015.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-09T11:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337016.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:47 jdemeyer]:\n> Replying to [comment:45 embray]:\n> > Replying to [comment:9 jdemeyer]:\n> > > This is redundant:\n> > > \n> > > ```\n> > >         sage: sgc(\"def dummy_python(self, *args, x=1): pass\")  # py3\n> > >         sage: sgc(\"def dummy_cython(self, *args, x=1): pass\")\n> > > ```\n\n> > \n> > Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.\n\n> \n> No, on Python 3 it performs the same test twice. And the outcome is obviously the same (apart from the \"dummy_cython\" string).\n\n\nYes, I understand that. But if you inspect carefully you'll see that logically it's harder to follow the example if not for the slight duplication.  As I just wrote above, the pure Python case is different for Python 2 and Python 3, while the Cython case should work the same for both.  Writing it like this makes that clearer.",
    "created_at": "2018-03-09T12:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337016",
    "user": "https://github.com/embray"
}
```

<a id='comment:52'></a>Replying to [comment:47 jdemeyer]:
> Replying to [comment:45 embray]:
> > Replying to [comment:9 jdemeyer]:
> > > This is redundant:
> > > 
> > > ```
> > >         sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
> > >         sage: sgc("def dummy_cython(self, *args, x=1): pass")
> > > ```

> > 
> > Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.

> 
> No, on Python 3 it performs the same test twice. And the outcome is obviously the same (apart from the "dummy_cython" string).


Yes, I understand that. But if you inspect carefully you'll see that logically it's harder to follow the example if not for the slight duplication.  As I just wrote above, the pure Python case is different for Python 2 and Python 3, while the Cython case should work the same for both.  Writing it like this makes that clearer.



---

archive/issue_comments_337017.json:
```json
{
    "body": "<a id='comment:53'></a>In other words, the two cases are *not* redundant on Python 2, but they happen to be redundant on Python 3 since Cython syntax is Python 3 compatible.  But the two examples have different meanings.",
    "created_at": "2018-03-09T12:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337017",
    "user": "https://github.com/embray"
}
```

<a id='comment:53'></a>In other words, the two cases are *not* redundant on Python 2, but they happen to be redundant on Python 3 since Cython syntax is Python 3 compatible.  But the two examples have different meanings.



---

archive/issue_comments_337018.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:49 jdemeyer]:\n> This change looks like it might break stuff:\n> \n> ```\n> #!diff\n> @@ -2247,10 +2254,10 @@ def sage_getsourcelines(obj):\n>  \n>      # First, we deal with nested classes. Their name contains a dot, and we\n>      # have a special function for that purpose.\n> -    if (not hasattr(obj, '__class__')) or (isinstance(obj, type) and type(obj) is not type):\n> +    if not hasattr(obj, '__class__') or isinstance(obj, type):\n> ```\n> \n> I agree that the original code was strange (looking specifically for a metaclass different from `type`), but maybe there was a reason...\n\n\nWeird, but I see what you're saying.  This code originally had `hasattr(obj, '__metaclass__')` and you changed it to this.  Let me make sure there isn't some reason I felt I had to change that.",
    "created_at": "2018-03-09T12:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337018",
    "user": "https://github.com/embray"
}
```

<a id='comment:54'></a>Replying to [comment:49 jdemeyer]:
> This change looks like it might break stuff:
> 
> ```
> #!diff
> @@ -2247,10 +2254,10 @@ def sage_getsourcelines(obj):
>  
>      # First, we deal with nested classes. Their name contains a dot, and we
>      # have a special function for that purpose.
> -    if (not hasattr(obj, '__class__')) or (isinstance(obj, type) and type(obj) is not type):
> +    if not hasattr(obj, '__class__') or isinstance(obj, type):
> ```
> 
> I agree that the original code was strange (looking specifically for a metaclass different from `type`), but maybe there was a reason...


Weird, but I see what you're saying.  This code originally had `hasattr(obj, '__metaclass__')` and you changed it to this.  Let me make sure there isn't some reason I felt I had to change that.



---

archive/issue_comments_337019.json:
```json
{
    "body": "<a id='comment:55'></a>The other thing is that this doesn't necessarily guarantee there isn't a metaclass.  On Python 2, `__metaclass__` can be any callable that's used to instantiate the type object.  So a class with a `__metaclass__` can still be exactly of type `type`.  On Python 3 this remains true when passing `metaclass=`, but I think there's been some discussion about deprecating that usage.  I don't think this usage turns up anywhere in Sage though and I'm not sure why it mattered here.",
    "created_at": "2018-03-09T12:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337019",
    "user": "https://github.com/embray"
}
```

<a id='comment:55'></a>The other thing is that this doesn't necessarily guarantee there isn't a metaclass.  On Python 2, `__metaclass__` can be any callable that's used to instantiate the type object.  So a class with a `__metaclass__` can still be exactly of type `type`.  On Python 3 this remains true when passing `metaclass=`, but I think there's been some discussion about deprecating that usage.  I don't think this usage turns up anywhere in Sage though and I'm not sure why it mattered here.



---

archive/issue_comments_337020.json:
```json
{
    "body": "<a id='comment:56'></a>Well, reverting that change definitely causes more tests to fail, so there was probably a reason.  But it might be that a different fix is needed...",
    "created_at": "2018-03-09T12:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337020",
    "user": "https://github.com/embray"
}
```

<a id='comment:56'></a>Well, reverting that change definitely causes more tests to fail, so there was probably a reason.  But it might be that a different fix is needed...



---

archive/issue_comments_337021.json:
```json
{
    "body": "<a id='comment:57'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-09T12:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337021",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:57'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337022.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:57 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                                                                                                                                      |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|\n> |[ba3fcc0](https://git.sagemath.org/sage.git/commit/?id=ba3fcc02d9df59f8ddb1158c33bcd6b59f535616)|`Originally this was actually over-restrictive: Checking for either an old-style class, or a new-style class with a custom metaclass.`|\n\n\nAs the commit message says, this line was originally trying to be *too* precise.  It was trying to handle a case like:\n\n    {{{\n    #!python\n    class SomeCategory(Category):\n        class ParentMethods:\n            pass\n    }}}\n\nthen calling `sage_getsource(SomeCategory.parent_class)` where `parent_class` is a `DynamicMetaclass`.  In this case it would go through `SomeCategory.parent_class._sage_src_lines_()` which in turn would look up the source lines for the actual class `SomeCategory.ParentMethods`, which on Python 2 was an old-style class.\n\nSo this code was really just trying to catch exactly any case where we had either an old-style class, or a class with a custom metaclass.  But really there's no reason for that restriction.  All that actually matters is that it's a class (of any type) with a dotted name.",
    "created_at": "2018-03-09T13:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337022",
    "user": "https://github.com/embray"
}
```

<a id='comment:58'></a>Replying to [comment:57 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                                                                                                                                      |
> |-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|
> |[ba3fcc0](https://git.sagemath.org/sage.git/commit/?id=ba3fcc02d9df59f8ddb1158c33bcd6b59f535616)|`Originally this was actually over-restrictive: Checking for either an old-style class, or a new-style class with a custom metaclass.`|


As the commit message says, this line was originally trying to be *too* precise.  It was trying to handle a case like:

    {{{
    #!python
    class SomeCategory(Category):
        class ParentMethods:
            pass
    }}}

then calling `sage_getsource(SomeCategory.parent_class)` where `parent_class` is a `DynamicMetaclass`.  In this case it would go through `SomeCategory.parent_class._sage_src_lines_()` which in turn would look up the source lines for the actual class `SomeCategory.ParentMethods`, which on Python 2 was an old-style class.

So this code was really just trying to catch exactly any case where we had either an old-style class, or a class with a custom metaclass.  But really there's no reason for that restriction.  All that actually matters is that it's a class (of any type) with a dotted name.



---

archive/issue_comments_337023.json:
```json
{
    "body": "<a id='comment:59'></a>\n```\nsage: from sage.misc.sageinspect import sage_getdoc\nsage: sage_getdoc(sage.categories.category_types.AbelianCategory)\n''\n```",
    "created_at": "2018-03-09T14:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337023",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:59'></a>
```
sage: from sage.misc.sageinspect import sage_getdoc
sage: sage_getdoc(sage.categories.category_types.AbelianCategory)
''
```



---

archive/issue_comments_337024.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-09T14:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337024",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337025.json:
```json
{
    "body": "<a id='comment:60'></a>This is actually an existing bug. `AbelianCategory` has no doc, but a doc is returned anyway.",
    "created_at": "2018-03-09T14:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337025",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:60'></a>This is actually an existing bug. `AbelianCategory` has no doc, but a doc is returned anyway.



---

archive/issue_comments_337026.json:
```json
{
    "body": "<a id='comment:61'></a>Let wait with this until #24936 is fixed.",
    "created_at": "2018-03-09T14:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337026",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:61'></a>Let wait with this until #24936 is fixed.



---

archive/issue_comments_337027.json:
```json
{
    "body": "<a id='comment:62'></a>can we start to move on again here ?",
    "created_at": "2018-03-28T12:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337027",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:62'></a>can we start to move on again here ?



---

archive/issue_comments_337028.json:
```json
{
    "body": "<a id='comment:63'></a>I don't think this actually needs any additional work...",
    "created_at": "2018-03-28T14:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337028",
    "user": "https://github.com/embray"
}
```

<a id='comment:63'></a>I don't think this actually needs any additional work...



---

archive/issue_comments_337029.json:
```json
{
    "body": "<a id='comment:64'></a>As usual, I prefer to review this once all dependencies have been merged.",
    "created_at": "2018-03-28T18:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337029",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:64'></a>As usual, I prefer to review this once all dependencies have been merged.



---

archive/issue_comments_337030.json:
```json
{
    "body": "<a id='comment:65'></a>Needs rebase to 8.2.rc0",
    "created_at": "2018-03-29T05:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337030",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:65'></a>Needs rebase to 8.2.rc0



---

archive/issue_comments_337031.json:
```json
{
    "body": "<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-03-29T15:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-29T15:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337032",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337033.json:
```json
{
    "body": "<a id='comment:67'></a>Rebased",
    "created_at": "2018-03-29T15:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337033",
    "user": "https://github.com/embray"
}
```

<a id='comment:67'></a>Rebased



---

archive/issue_comments_337034.json:
```json
{
    "body": "<a id='comment:68'></a>and bot is morally green",
    "created_at": "2018-03-30T07:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337034",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:68'></a>and bot is morally green



---

archive/issue_comments_337035.json:
```json
{
    "body": "<a id='comment:69'></a>I'll test it.",
    "created_at": "2018-03-30T10:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337035",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:69'></a>I'll test it.



---

archive/issue_comments_337036.json:
```json
{
    "body": "<a id='comment:70'></a>Doc still builds fine with this branch.",
    "created_at": "2018-03-30T17:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337036",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:70'></a>Doc still builds fine with this branch.



---

archive/issue_comments_337037.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-02T15:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337037",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_337038.json:
```json
{
    "body": "<a id='comment:71'></a>I do not agree with everything in this branch, but let's move forward.",
    "created_at": "2018-04-02T15:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337038",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:71'></a>I do not agree with everything in this branch, but let's move forward.



---

archive/issue_events_061525.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24312#event-61525"
}
```



---

archive/issue_comments_337039.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-08T17:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24312#issuecomment-337039",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061526.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-08T17:27:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24312",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24312#event-61526"
}
```
