# Issue 24918: Failing doctest in test_jupyter.rst when running patchbot

archive/issues_024681.json:
```json
{
    "assignees": [],
    "body": "With 8.2.beta7 all patchbots fail with:\n\n```\nFile \"src/sage/interacts/test_jupyter.rst\", line 288, in sage.interacts.test_jupyter\nFailed example:\n    test(interacts.statistics.coin)\nExpected:\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n    doctest:...: UserWarning: Attempting to set identical bottom==top results\n    in singular transformations; automatically expanding.\n    bottom=0.0, top=0.0\nGot:\n    doctest:warning\n      File \"/home/vdelecro/sage_patchbot/src/bin/sage-runtests\", line 127, in <module>\n        err = DC.run()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1163, in run\n        self.run_doctests()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 891, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1835, in dispatch\n        self.parallel_dispatch()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1732, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2001, in start\n        super(DocTestWorker, self).start()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py\", line 130, in start\n        self._popen = Popen(self)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/forking.py\", line 126, in __init__\n        code = process_obj._bootstrap()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n        self.run()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1974, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2291, in __call__\n        result = runner.run(test)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 721, in run\n        return self._run(test, compileflags, out)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 537, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 947, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interacts.test_jupyter[27]>\", line 1, in <module>\n        test(interacts.statistics.coin)\n      File \"<doctest sage.interacts.test_jupyter[3]>\", line 6, in test\n        return f(**kwargs)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/interacts/library.py\", line 736, in coin\n        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 258, in show\n        pretty_print(*args, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 229, in pretty_print\n        dm.display_immediately(*args, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 833, in display_immediately\n        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 623, in _rich_output_formatter\n        rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 581, in _call_rich_repr\n        return obj._rich_repr_(self, **rich_repr_kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 884, in _rich_repr_\n        self.save, kwds, file_ext, output_container)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 711, in graphics_from_save\n        save_function(filename, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/misc/decorators.py\", line 483, in wrapper\n        return func(*args, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 3153, in save\n        figure = self.matplotlib(**options)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 2680, in matplotlib\n        subplot.set_ylim([ymin, ymax])\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/matplotlib/axes/_base.py\", line 3239, in set_ylim\n        'bottom=%s, top=%s') % (bottom, top))\n    :\n    UserWarning: Attempting to set identical bottom==top results\n    in singular transformations; automatically expanding.\n    bottom=0.0, top=0.0\n    Interactive function <function coin at 0x7fc26c78baa0> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n```\n\n\nBranch/Commit: **[`80d61a0`](https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f)**\n\nReviewer: **Erik Bray**\n\nAuthor: **Ralf Stephan**\n\nComponent: **interact**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24918_\n\n",
    "closed_at": "2018-03-19T21:59:33Z",
    "created_at": "2018-03-06T15:02:37Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interact",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Failing doctest in test_jupyter.rst when running patchbot",
    "type": "issue",
    "updated_at": "2018-03-19T21:59:33Z",
    "url": "https://github.com/sagemath/sage/issues/24918",
    "user": "https://github.com/rwst"
}
```
With 8.2.beta7 all patchbots fail with:

```
File "src/sage/interacts/test_jupyter.rst", line 288, in sage.interacts.test_jupyter
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    doctest:...: UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
Got:
    doctest:warning
      File "/home/vdelecro/sage_patchbot/src/bin/sage-runtests", line 127, in <module>
        err = DC.run()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1163, in run
        self.run_doctests()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py", line 891, in run_doctests
        self.dispatcher.dispatch()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1835, in dispatch
        self.parallel_dispatch()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1732, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2001, in start
        super(DocTestWorker, self).start()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py", line 130, in start
        self._popen = Popen(self)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/forking.py", line 126, in __init__
        code = process_obj._bootstrap()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
        self.run()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1974, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2291, in __call__
        result = runner.run(test)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 721, in run
        return self._run(test, compileflags, out)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 537, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 947, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interacts.test_jupyter[27]>", line 1, in <module>
        test(interacts.statistics.coin)
      File "<doctest sage.interacts.test_jupyter[3]>", line 6, in test
        return f(**kwargs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/interacts/library.py", line 736, in coin
        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 258, in show
        pretty_print(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 229, in pretty_print
        dm.display_immediately(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 833, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 623, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 581, in _call_rich_repr
        return obj._rich_repr_(self, **rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 884, in _rich_repr_
        self.save, kwds, file_ext, output_container)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 711, in graphics_from_save
        save_function(filename, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 483, in wrapper
        return func(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3153, in save
        figure = self.matplotlib(**options)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 2680, in matplotlib
        subplot.set_ylim([ymin, ymax])
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/matplotlib/axes/_base.py", line 3239, in set_ylim
        'bottom=%s, top=%s') % (bottom, top))
    :
    UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
    Interactive function <function coin at 0x7fc26c78baa0> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
```


Branch/Commit: **[`80d61a0`](https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f)**

Reviewer: **Erik Bray**

Author: **Ralf Stephan**

Component: **interact**

_Issue created by migration from https://trac.sagemath.org/ticket/24918_





---

archive/issue_events_341738.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-06T15:02:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341738"
}
```



---

archive/issue_events_341739.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-06T15:02:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interact",
    "label_color": "0000ff",
    "label_name": "c: interact",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341739"
}
```



---

archive/issue_events_341740.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-06T15:02:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341740"
}
```



---

archive/issue_events_341741.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-06T15:02:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341741"
}
```



---

archive/issue_comments_379054.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe parts with \"Interactive function\" and \"doctest\" are reversed, and in \"doctest\" a backtrace is inserted. Race condition?",
    "created_at": "2018-03-06T15:07:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379054",
    "user": "https://github.com/rwst"
}
```

<div id="comment:1" align="right">comment:1</div>

The parts with "Interactive function" and "doctest" are reversed, and in "doctest" a backtrace is inserted. Race condition?



---

archive/issue_comments_379055.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nCan the output of warnings (presumably from matplotlib?) be silenced in these tests? They don't seem to add anything.",
    "created_at": "2018-03-06T15:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379055",
    "user": "https://github.com/rwst"
}
```

<div id="comment:2" align="right">comment:2</div>

Can the output of warnings (presumably from matplotlib?) be silenced in these tests? They don't seem to add anything.



---

archive/issue_comments_379056.json:
```json
{
    "body": "Branch: **[u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot)**",
    "created_at": "2018-03-06T15:17:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379056",
    "user": "https://github.com/rwst"
}
```

Branch: **[u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot)**



---

archive/issue_events_341742.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-06T15:18:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341742"
}
```



---

archive/issue_comments_379057.json:
```json
{
    "body": "Commit: **[`12a6c82`](https://github.com/sagemath/sagetrac-mirror/commit/12a6c823cb0e834d933542b37023c0aa2d076e7b)**",
    "created_at": "2018-03-06T15:18:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379057",
    "user": "https://github.com/rwst"
}
```

Commit: **[`12a6c82`](https://github.com/sagemath/sagetrac-mirror/commit/12a6c823cb0e834d933542b37023c0aa2d076e7b)**



---

archive/issue_comments_379058.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nLet's see if the patchbots like that more.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/12a6c823cb0e834d933542b37023c0aa2d076e7b\"><code>12a6c82</code></a></td><td><code>24918: fix doctest</code></td></tr></table>\n",
    "created_at": "2018-03-06T15:18:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379058",
    "user": "https://github.com/rwst"
}
```

<div id="comment:4" align="right">comment:4</div>

Let's see if the patchbots like that more.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/12a6c823cb0e834d933542b37023c0aa2d076e7b"><code>12a6c82</code></a></td><td><code>24918: fix doctest</code></td></tr></table>




---

archive/issue_comments_379059.json:
```json
{
    "body": "Author: **Ralf Stephan**",
    "created_at": "2018-03-06T15:18:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379059",
    "user": "https://github.com/rwst"
}
```

Author: **Ralf Stephan**



---

archive/issue_comments_379060.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@rwst](#comment:1):\n> in \"doctest\" a backtrace is inserted.\n\nThat's normal for doctests.\n\nThe reordering is mysterious though. It's especially mysterious that it happens only on the patchbots.\n\nThe cause is likely #24771.",
    "created_at": "2018-03-06T16:07:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379060",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@rwst](#comment:1):
> in "doctest" a backtrace is inserted.

That's normal for doctests.

The reordering is mysterious though. It's especially mysterious that it happens only on the patchbots.

The cause is likely #24771.



---

archive/issue_comments_379061.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI agree--the warning is from matplotlib and not really at all interesting for the purposes of these docs.",
    "created_at": "2018-03-06T16:13:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379061",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

I agree--the warning is from matplotlib and not really at all interesting for the purposes of these docs.



---

archive/issue_comments_379062.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHaving warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.  I could suggest that when running the doctests all warnings just go to stdout, but really this is a general problem for any test that looked at interleaved output on stdout and stderr.  I'm not really sure why it just came up in this case.",
    "created_at": "2018-03-06T16:20:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379062",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.  I could suggest that when running the doctests all warnings just go to stdout, but really this is a general problem for any test that looked at interleaved output on stdout and stderr.  I'm not really sure why it just came up in this case.



---

archive/issue_comments_379063.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@embray](#comment:7):\n> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.\n\nI agree, but that does not explain why it fails *only* on the patchbot.",
    "created_at": "2018-03-06T16:23:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379063",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@embray](#comment:7):
> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.

I agree, but that does not explain why it fails *only* on the patchbot.



---

archive/issue_comments_379064.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@embray](#comment:7):\n> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.\n\nIn principle this is also the case with #24920. If one could just switch off stderr for those tests the linking of a system readline would not be necessary to make those tests pass.",
    "created_at": "2018-03-06T16:36:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379064",
    "user": "https://github.com/rwst"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@embray](#comment:7):
> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.

In principle this is also the case with #24920. If one could just switch off stderr for those tests the linking of a system readline would not be necessary to make those tests pass.



---

archive/issue_comments_379065.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThe patchbot runner simply runs `./sage -t` using `os.system`, so on its own that shouldn't make a difference.\n\nHowever, I was able to make this fail consistently by running `sp.Popen(['./sage', '-t', 'src/sage/interacts/test_jupyter.rst'], stdout=sp.PIPE)` (where `sp` is the `subprocess` module).\n\nSo it might just be some difference, when the patchbot itself is run, in type of file stdout and/or stderr, whether or not those files are buffered, and the size of the buffer.",
    "created_at": "2018-03-06T16:54:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379065",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

The patchbot runner simply runs `./sage -t` using `os.system`, so on its own that shouldn't make a difference.

However, I was able to make this fail consistently by running `sp.Popen(['./sage', '-t', 'src/sage/interacts/test_jupyter.rst'], stdout=sp.PIPE)` (where `sp` is the `subprocess` module).

So it might just be some difference, when the patchbot itself is run, in type of file stdout and/or stderr, whether or not those files are buffered, and the size of the buffer.



---

archive/issue_comments_379066.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nEven more simply, I can reproduce just by running `./sage -t src/sage/interacts/test_jupyter.rst > test.txt`, for example.",
    "created_at": "2018-03-06T17:01:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379066",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Even more simply, I can reproduce just by running `./sage -t src/sage/interacts/test_jupyter.rst > test.txt`, for example.



---

archive/issue_comments_379067.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThe test:\n\n```\n    sage: test(interacts.statistics.coin)\n    ...\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n    ...\n```\nThe test run:\n\n```\nFailed example:\n    test(interacts.statistics.coin)\nExpected:\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2\n, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', \nmax=1)\n    ...\n```\nIt appears that ellipsis at the start of the output part of the doctest is ignored, is this a feature? If not immediately fixable I propose to \"known bug\" this doctest for now.",
    "created_at": "2018-03-07T07:52:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379067",
    "user": "https://github.com/rwst"
}
```

<div id="comment:12" align="right">comment:12</div>

The test:

```
    sage: test(interacts.statistics.coin)
    ...
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    ...
```
The test run:

```
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2
, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', 
max=1)
    ...
```
It appears that ellipsis at the start of the output part of the doctest is ignored, is this a feature? If not immediately fixable I propose to "known bug" this doctest for now.



---

archive/issue_comments_379068.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIt does make more sense that the warning should come first in the output. But whether or not it actually does come first depends on I/O buffering peculiarities it seems.",
    "created_at": "2018-03-07T09:24:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379068",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

It does make more sense that the warning should come first in the output. But whether or not it actually does come first depends on I/O buffering peculiarities it seems.



---

archive/issue_comments_379069.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nOne simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.",
    "created_at": "2018-03-07T09:28:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379069",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.



---

archive/issue_comments_379070.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jdemeyer](#comment:14):\n> One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.\n\nIn `matplotlib/axes/_base.py`, so that's a matplotlib patch I guess.",
    "created_at": "2018-03-07T09:34:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379070",
    "user": "https://github.com/rwst"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jdemeyer](#comment:14):
> One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.

In `matplotlib/axes/_base.py`, so that's a matplotlib patch I guess.



---

archive/issue_comments_379071.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nNo, I meant in the doctest framework whenever a warning is printed.",
    "created_at": "2018-03-07T09:36:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379071",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

No, I meant in the doctest framework whenever a warning is printed.



---

archive/issue_comments_379072.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI mean this change:\n\n```diff\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex 301383b..38c5cdf 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -170,6 +170,9 @@ def showwarning_with_traceback(message, category, filename, lineno, file=None, l\n         :\n         UserWarning: bad stuff\n     \"\"\"\n+    # Flush stdout to get predictable ordering of output and warnings\n+    sys.stdout.flush()\n+\n     # Get traceback to display in warning\n     tb = traceback.extract_stack()\n     tb = tb[:-1]  # Drop this stack frame for showwarning_with_traceback()\n```",
    "created_at": "2018-03-07T09:37:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379072",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

I mean this change:

```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 301383b..38c5cdf 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -170,6 +170,9 @@ def showwarning_with_traceback(message, category, filename, lineno, file=None, l
         :
         UserWarning: bad stuff
     """
+    # Flush stdout to get predictable ordering of output and warnings
+    sys.stdout.flush()
+
     # Get traceback to display in warning
     tb = traceback.extract_stack()
     tb = tb[:-1]  # Drop this stack frame for showwarning_with_traceback()
```



---

archive/issue_comments_379073.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96\"><code>857cb15</code></a></td><td><code>24918: apply suggested workaround</code></td></tr></table>\n",
    "created_at": "2018-03-07T09:43:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379073",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96"><code>857cb15</code></a></td><td><code>24918: apply suggested workaround</code></td></tr></table>




---

archive/issue_comments_379074.json:
```json
{
    "body": "Changed commit from **[`12a6c82`](https://github.com/sagemath/sagetrac-mirror/commit/12a6c823cb0e834d933542b37023c0aa2d076e7b)** to **[`857cb15`](https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96)**",
    "created_at": "2018-03-07T09:43:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379074",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`12a6c82`](https://github.com/sagemath/sagetrac-mirror/commit/12a6c823cb0e834d933542b37023c0aa2d076e7b)** to **[`857cb15`](https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96)**



---

archive/issue_comments_379075.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nYes, that makes total sense.  I was just experimenting with a different approach that reopens `sys.stdout` and `sys.stderr` with unbuffered files, but this should be simpler.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96\"><code>857cb15</code></a></td><td><code>24918: apply suggested workaround</code></td></tr></table>\n",
    "created_at": "2018-03-07T09:43:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379075",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

Yes, that makes total sense.  I was just experimenting with a different approach that reopens `sys.stdout` and `sys.stderr` with unbuffered files, but this should be simpler.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96"><code>857cb15</code></a></td><td><code>24918: apply suggested workaround</code></td></tr></table>




---

archive/issue_comments_379076.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nOK, thanks.",
    "created_at": "2018-03-07T09:44:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379076",
    "user": "https://github.com/rwst"
}
```

<div id="comment:20" align="right">comment:20</div>

OK, thanks.



---

archive/issue_comments_379077.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nLooks like this works, though in this case you can also just remove the original fix, since now the stdout does appear before the stderr as before (I'm actually not sure why that's the case--I would think the warning would be displayed first--but apparently not).",
    "created_at": "2018-03-07T10:13:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379077",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Looks like this works, though in this case you can also just remove the original fix, since now the stdout does appear before the stderr as before (I'm actually not sure why that's the case--I would think the warning would be displayed first--but apparently not).



---

archive/issue_events_341743.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-07T10:16:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341743"
}
```



---

archive/issue_events_341744.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-07T10:16:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341744"
}
```



---

archive/issue_comments_379078.json:
```json
{
    "body": "Changed branch from **[u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot)** to **[u/rws/24918](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24918)**",
    "created_at": "2018-03-07T13:50:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379078",
    "user": "https://github.com/rwst"
}
```

Changed branch from **[u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot)** to **[u/rws/24918](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24918)**



---

archive/issue_comments_379079.json:
```json
{
    "body": "Changed commit from **[`857cb15`](https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96)** to **[`80d61a0`](https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f)**",
    "created_at": "2018-03-07T13:51:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379079",
    "user": "https://github.com/rwst"
}
```

Changed commit from **[`857cb15`](https://github.com/sagemath/sagetrac-mirror/commit/857cb1503792426588ca8fd623439cd85f317d96)** to **[`80d61a0`](https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f)**



---

archive/issue_comments_379080.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f\"><code>80d61a0</code></a></td><td><code>24918: force ordered output in doctests</code></td></tr></table>\n",
    "created_at": "2018-03-07T13:51:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379080",
    "user": "https://github.com/rwst"
}
```

<div id="comment:24"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f"><code>80d61a0</code></a></td><td><code>24918: force ordered output in doctests</code></td></tr></table>




---

archive/issue_events_341745.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-07T13:51:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341745"
}
```



---

archive/issue_events_341746.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-07T13:51:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341746"
}
```



---

archive/issue_events_341747.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-03-08T13:31:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341747"
}
```



---

archive/issue_events_341748.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-03-08T13:31:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341748"
}
```



---

archive/issue_comments_379081.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2018-03-08T13:32:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379081",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_comments_379082.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThanks.",
    "created_at": "2018-03-08T13:50:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379082",
    "user": "https://github.com/rwst"
}
```

<div id="comment:27" align="right">comment:27</div>

Thanks.



---

archive/issue_events_341749.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-19T21:59:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341749"
}
```



---

archive/issue_events_341750.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "5909f9c2edd5e2e36511afdb71c6e86127cdf615",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-03-19T21:59:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24918#event-341750"
}
```



---

archive/issue_comments_379083.json:
```json
{
    "body": "Changed branch from **[u/rws/24918](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24918)** to **[`80d61a0`](https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f)**",
    "created_at": "2018-03-19T21:59:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24918#issuecomment-379083",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/rws/24918](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/24918)** to **[`80d61a0`](https://github.com/sagemath/sagetrac-mirror/commit/80d61a074638180f1c95693208c9aff2857c9d2f)**
