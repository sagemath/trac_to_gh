# Issue 24918: Failing doctest in test_jupyter.rst when running patchbot

archive/issues_024681.json:
```json
{
    "body": "With 8.2.beta7 all patchbots fail with:\n\n```\nFile \"src/sage/interacts/test_jupyter.rst\", line 288, in sage.interacts.test_jupyter\nFailed example:\n    test(interacts.statistics.coin)\nExpected:\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n    doctest:...: UserWarning: Attempting to set identical bottom==top results\n    in singular transformations; automatically expanding.\n    bottom=0.0, top=0.0\nGot:\n    doctest:warning\n      File \"/home/vdelecro/sage_patchbot/src/bin/sage-runtests\", line 127, in <module>\n        err = DC.run()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1163, in run\n        self.run_doctests()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 891, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1835, in dispatch\n        self.parallel_dispatch()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1732, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2001, in start\n        super(DocTestWorker, self).start()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py\", line 130, in start\n        self._popen = Popen(self)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/forking.py\", line 126, in __init__\n        code = process_obj._bootstrap()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n        self.run()\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1974, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2291, in __call__\n        result = runner.run(test)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 721, in run\n        return self._run(test, compileflags, out)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 537, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 947, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interacts.test_jupyter[27]>\", line 1, in <module>\n        test(interacts.statistics.coin)\n      File \"<doctest sage.interacts.test_jupyter[3]>\", line 6, in test\n        return f(**kwargs)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/interacts/library.py\", line 736, in coin\n        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 258, in show\n        pretty_print(*args, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 229, in pretty_print\n        dm.display_immediately(*args, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 833, in display_immediately\n        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 623, in _rich_output_formatter\n        rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 581, in _call_rich_repr\n        return obj._rich_repr_(self, **rich_repr_kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 884, in _rich_repr_\n        self.save, kwds, file_ext, output_container)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 711, in graphics_from_save\n        save_function(filename, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/misc/decorators.py\", line 483, in wrapper\n        return func(*args, **kwds)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 3153, in save\n        figure = self.matplotlib(**options)\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 2680, in matplotlib\n        subplot.set_ylim([ymin, ymax])\n      File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/matplotlib/axes/_base.py\", line 3239, in set_ylim\n        'bottom=%s, top=%s') % (bottom, top))\n    :\n    UserWarning: Attempting to set identical bottom==top results\n    in singular transformations; automatically expanding.\n    bottom=0.0, top=0.0\n    Interactive function <function coin at 0x7fc26c78baa0> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n```\n\n\nBranch/Commit: 80d61a074638180f1c95693208c9aff2857c9d2f\n\nReviewer: Erik Bray\n\nAuthor: Ralf Stephan\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24918\n\n",
    "closed_at": "2018-03-19T21:59:33Z",
    "created_at": "2018-03-06T15:02:37Z",
    "labels": [
        "component: interact",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Failing doctest in test_jupyter.rst when running patchbot",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24918",
    "user": "https://github.com/rwst"
}
```
With 8.2.beta7 all patchbots fail with:

```
File "src/sage/interacts/test_jupyter.rst", line 288, in sage.interacts.test_jupyter
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    doctest:...: UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
Got:
    doctest:warning
      File "/home/vdelecro/sage_patchbot/src/bin/sage-runtests", line 127, in <module>
        err = DC.run()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1163, in run
        self.run_doctests()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py", line 891, in run_doctests
        self.dispatcher.dispatch()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1835, in dispatch
        self.parallel_dispatch()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1732, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2001, in start
        super(DocTestWorker, self).start()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py", line 130, in start
        self._popen = Popen(self)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/forking.py", line 126, in __init__
        code = process_obj._bootstrap()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
        self.run()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1974, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2291, in __call__
        result = runner.run(test)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 721, in run
        return self._run(test, compileflags, out)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 537, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 947, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interacts.test_jupyter[27]>", line 1, in <module>
        test(interacts.statistics.coin)
      File "<doctest sage.interacts.test_jupyter[3]>", line 6, in test
        return f(**kwargs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/interacts/library.py", line 736, in coin
        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 258, in show
        pretty_print(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 229, in pretty_print
        dm.display_immediately(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 833, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 623, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 581, in _call_rich_repr
        return obj._rich_repr_(self, **rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 884, in _rich_repr_
        self.save, kwds, file_ext, output_container)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 711, in graphics_from_save
        save_function(filename, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 483, in wrapper
        return func(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3153, in save
        figure = self.matplotlib(**options)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 2680, in matplotlib
        subplot.set_ylim([ymin, ymax])
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/matplotlib/axes/_base.py", line 3239, in set_ylim
        'bottom=%s, top=%s') % (bottom, top))
    :
    UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
    Interactive function <function coin at 0x7fc26c78baa0> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
```


Branch/Commit: 80d61a074638180f1c95693208c9aff2857c9d2f

Reviewer: Erik Bray

Author: Ralf Stephan

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24918





---

archive/issue_comments_473683.json:
```json
{
    "body": "<a id='comment:1'></a>The parts with \"Interactive function\" and \"doctest\" are reversed, and in \"doctest\" a backtrace is inserted. Race condition?",
    "created_at": "2018-03-06T15:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473683",
    "user": "https://github.com/rwst"
}
```

<a id='comment:1'></a>The parts with "Interactive function" and "doctest" are reversed, and in "doctest" a backtrace is inserted. Race condition?



---

archive/issue_comments_473684.json:
```json
{
    "body": "<a id='comment:2'></a>Can the output of warnings (presumably from matplotlib?) be silenced in these tests? They don't seem to add anything.",
    "created_at": "2018-03-06T15:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473684",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>Can the output of warnings (presumably from matplotlib?) be silenced in these tests? They don't seem to add anything.



---

archive/issue_comments_473685.json:
```json
{
    "body": "Changing branch from \"\" to \"u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot\"",
    "created_at": "2018-03-06T15:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473685",
    "user": "https://github.com/rwst"
}
```

Changing branch from "" to "u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot"



---

archive/issue_comments_473686.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-06T15:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473686",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_473687.json:
```json
{
    "body": "Changing commit from \"\" to \"12a6c823cb0e834d933542b37023c0aa2d076e7b\"",
    "created_at": "2018-03-06T15:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473687",
    "user": "https://github.com/rwst"
}
```

Changing commit from "" to "12a6c823cb0e834d933542b37023c0aa2d076e7b"



---

archive/issue_comments_473688.json:
```json
{
    "body": "<a id='comment:4'></a>Let's see if the patchbots like that more.\n\n---\nNew commits:",
    "created_at": "2018-03-06T15:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473688",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>Let's see if the patchbots like that more.

---
New commits:



---

archive/issue_comments_473689.json:
```json
{
    "body": "Changing author from \"\" to \"Ralf Stephan\"",
    "created_at": "2018-03-06T15:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473689",
    "user": "https://github.com/rwst"
}
```

Changing author from "" to "Ralf Stephan"



---

archive/issue_comments_473690.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:1 rws]:\n> in \"doctest\" a backtrace is inserted.\n\n\nThat's normal for doctests.\n\nThe reordering is mysterious though. It's especially mysterious that it happens only on the patchbots.\n\nThe cause is likely #24771.",
    "created_at": "2018-03-06T16:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473690",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:1 rws]:
> in "doctest" a backtrace is inserted.


That's normal for doctests.

The reordering is mysterious though. It's especially mysterious that it happens only on the patchbots.

The cause is likely #24771.



---

archive/issue_comments_473691.json:
```json
{
    "body": "<a id='comment:6'></a>I agree--the warning is from matplotlib and not really at all interesting for the purposes of these docs.",
    "created_at": "2018-03-06T16:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473691",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>I agree--the warning is from matplotlib and not really at all interesting for the purposes of these docs.



---

archive/issue_comments_473692.json:
```json
{
    "body": "<a id='comment:7'></a>Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.  I could suggest that when running the doctests all warnings just go to stdout, but really this is a general problem for any test that looked at interleaved output on stdout and stderr.  I'm not really sure why it just came up in this case.",
    "created_at": "2018-03-06T16:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473692",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.  I could suggest that when running the doctests all warnings just go to stdout, but really this is a general problem for any test that looked at interleaved output on stdout and stderr.  I'm not really sure why it just came up in this case.



---

archive/issue_comments_473693.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 embray]:\n> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.\n\n\nI agree, but that does not explain why it fails *only* on the patchbot.",
    "created_at": "2018-03-06T16:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473693",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:7 embray]:
> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.


I agree, but that does not explain why it fails *only* on the patchbot.



---

archive/issue_comments_473694.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 embray]:\n> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.\n\n\nIn principle this is also the case with #24920. If one could just switch off stderr for those tests the linking of a system readline would not be necessary to make those tests pass.",
    "created_at": "2018-03-06T16:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473694",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>Replying to [comment:7 embray]:
> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.


In principle this is also the case with #24920. If one could just switch off stderr for those tests the linking of a system readline would not be necessary to make those tests pass.



---

archive/issue_comments_473695.json:
```json
{
    "body": "<a id='comment:10'></a>The patchbot runner simply runs `./sage -t` using `os.system`, so on its own that shouldn't make a difference.\n\nHowever, I was able to make this fail consistently by running `sp.Popen(['./sage', '-t', 'src/sage/interacts/test_jupyter.rst'], stdout=sp.PIPE)` (where `sp` is the `subprocess` module).\n\nSo it might just be some difference, when the patchbot itself is run, in type of file stdout and/or stderr, whether or not those files are buffered, and the size of the buffer.",
    "created_at": "2018-03-06T16:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473695",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>The patchbot runner simply runs `./sage -t` using `os.system`, so on its own that shouldn't make a difference.

However, I was able to make this fail consistently by running `sp.Popen(['./sage', '-t', 'src/sage/interacts/test_jupyter.rst'], stdout=sp.PIPE)` (where `sp` is the `subprocess` module).

So it might just be some difference, when the patchbot itself is run, in type of file stdout and/or stderr, whether or not those files are buffered, and the size of the buffer.



---

archive/issue_comments_473696.json:
```json
{
    "body": "<a id='comment:11'></a>Even more simply, I can reproduce just by running `./sage -t src/sage/interacts/test_jupyter.rst > test.txt`, for example.",
    "created_at": "2018-03-06T17:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473696",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Even more simply, I can reproduce just by running `./sage -t src/sage/interacts/test_jupyter.rst > test.txt`, for example.



---

archive/issue_comments_473697.json:
```json
{
    "body": "<a id='comment:12'></a>The test:\n\n```\n    sage: test(interacts.statistics.coin)\n    ...\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)\n    ...\n```\nThe test run:\n\n```\nFailed example:\n    test(interacts.statistics.coin)\nExpected:\n    Interactive function <function coin at ...> with 2 widgets\n      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2\n, step=100)\n      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', \nmax=1)\n    ...\n```\nIt appears that ellipsis at the start of the output part of the doctest is ignored, is this a feature? If not immediately fixable I propose to \"known bug\" this doctest for now.",
    "created_at": "2018-03-07T07:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473697",
    "user": "https://github.com/rwst"
}
```

<a id='comment:12'></a>The test:

```
    sage: test(interacts.statistics.coin)
    ...
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    ...
```
The test run:

```
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2
, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', 
max=1)
    ...
```
It appears that ellipsis at the start of the output part of the doctest is ignored, is this a feature? If not immediately fixable I propose to "known bug" this doctest for now.



---

archive/issue_comments_473698.json:
```json
{
    "body": "<a id='comment:13'></a>It does make more sense that the warning should come first in the output. But whether or not it actually does come first depends on I/O buffering peculiarities it seems.",
    "created_at": "2018-03-07T09:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473698",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>It does make more sense that the warning should come first in the output. But whether or not it actually does come first depends on I/O buffering peculiarities it seems.



---

archive/issue_comments_473699.json:
```json
{
    "body": "<a id='comment:14'></a>One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.",
    "created_at": "2018-03-07T09:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473699",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.



---

archive/issue_comments_473700.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:\n> One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.\n\n\nIn `matplotlib/axes/_base.py`, so that's a matplotlib patch I guess.",
    "created_at": "2018-03-07T09:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473700",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:
> One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.


In `matplotlib/axes/_base.py`, so that's a matplotlib patch I guess.



---

archive/issue_comments_473701.json:
```json
{
    "body": "<a id='comment:16'></a>No, I meant in the doctest framework whenever a warning is printed.",
    "created_at": "2018-03-07T09:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473701",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>No, I meant in the doctest framework whenever a warning is printed.



---

archive/issue_comments_473702.json:
```json
{
    "body": "<a id='comment:17'></a>I mean this change:\n\n```diff\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex 301383b..38c5cdf 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -170,6 +170,9 @@ def showwarning_with_traceback(message, category, filename, lineno, file=None, l\n         :\n         UserWarning: bad stuff\n     \"\"\"\n+    # Flush stdout to get predictable ordering of output and warnings\n+    sys.stdout.flush()\n+\n     # Get traceback to display in warning\n     tb = traceback.extract_stack()\n     tb = tb[:-1]  # Drop this stack frame for showwarning_with_traceback()\n```",
    "created_at": "2018-03-07T09:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473702",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>I mean this change:

```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 301383b..38c5cdf 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -170,6 +170,9 @@ def showwarning_with_traceback(message, category, filename, lineno, file=None, l
         :
         UserWarning: bad stuff
     """
+    # Flush stdout to get predictable ordering of output and warnings
+    sys.stdout.flush()
+
     # Get traceback to display in warning
     tb = traceback.extract_stack()
     tb = tb[:-1]  # Drop this stack frame for showwarning_with_traceback()
```



---

archive/issue_comments_473703.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-07T09:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473703",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_473704.json:
```json
{
    "body": "Changing commit from \"12a6c823cb0e834d933542b37023c0aa2d076e7b\" to \"857cb1503792426588ca8fd623439cd85f317d96\"",
    "created_at": "2018-03-07T09:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473704",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "12a6c823cb0e834d933542b37023c0aa2d076e7b" to "857cb1503792426588ca8fd623439cd85f317d96"



---

archive/issue_comments_473705.json:
```json
{
    "body": "<a id='comment:19'></a>Yes, that makes total sense.  I was just experimenting with a different approach that reopens `sys.stdout` and `sys.stderr` with unbuffered files, but this should be simpler.\n\n---\nNew commits:",
    "created_at": "2018-03-07T09:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473705",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Yes, that makes total sense.  I was just experimenting with a different approach that reopens `sys.stdout` and `sys.stderr` with unbuffered files, but this should be simpler.

---
New commits:



---

archive/issue_comments_473706.json:
```json
{
    "body": "<a id='comment:20'></a>OK, thanks.",
    "created_at": "2018-03-07T09:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473706",
    "user": "https://github.com/rwst"
}
```

<a id='comment:20'></a>OK, thanks.



---

archive/issue_comments_473707.json:
```json
{
    "body": "<a id='comment:21'></a>Looks like this works, though in this case you can also just remove the original fix, since now the stdout does appear before the stderr as before (I'm actually not sure why that's the case--I would think the warning would be displayed first--but apparently not).",
    "created_at": "2018-03-07T10:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473707",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>Looks like this works, though in this case you can also just remove the original fix, since now the stdout does appear before the stderr as before (I'm actually not sure why that's the case--I would think the warning would be displayed first--but apparently not).



---

archive/issue_comments_473708.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-07T10:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473708",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_473709.json:
```json
{
    "body": "Changing branch from \"u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot\" to \"u/rws/24918\"",
    "created_at": "2018-03-07T13:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473709",
    "user": "https://github.com/rwst"
}
```

Changing branch from "u/rws/failing_doctest_in_test_jupyter_rst_when_running_patchbot" to "u/rws/24918"



---

archive/issue_comments_473710.json:
```json
{
    "body": "Changing commit from \"857cb1503792426588ca8fd623439cd85f317d96\" to \"80d61a074638180f1c95693208c9aff2857c9d2f\"",
    "created_at": "2018-03-07T13:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473710",
    "user": "https://github.com/rwst"
}
```

Changing commit from "857cb1503792426588ca8fd623439cd85f317d96" to "80d61a074638180f1c95693208c9aff2857c9d2f"



---

archive/issue_comments_473711.json:
```json
{
    "body": "<a id='comment:24'></a>New commits:",
    "created_at": "2018-03-07T13:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473711",
    "user": "https://github.com/rwst"
}
```

<a id='comment:24'></a>New commits:



---

archive/issue_comments_473712.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-07T13:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473712",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_473713.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-08T13:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473713",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_473714.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Erik Bray\"",
    "created_at": "2018-03-08T13:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473714",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "" to "Erik Bray"



---

archive/issue_comments_473715.json:
```json
{
    "body": "<a id='comment:27'></a>Thanks.",
    "created_at": "2018-03-08T13:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473715",
    "user": "https://github.com/rwst"
}
```

<a id='comment:27'></a>Thanks.



---

archive/issue_events_062556.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-19T21:59:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24918#event-62556"
}
```



---

archive/issue_comments_473716.json:
```json
{
    "body": "Changing branch from \"u/rws/24918\" to \"80d61a074638180f1c95693208c9aff2857c9d2f\"",
    "created_at": "2018-03-19T21:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473716",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/rws/24918" to "80d61a074638180f1c95693208c9aff2857c9d2f"



---

archive/issue_comments_473717.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-19T21:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24918#issuecomment-473717",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
