# Issue 24285: cleaning reall and complex balls

archive/issues_024048.json:
```json
{
    "body": "We perform some cleaning\n\n- move the conversion `number field -> ball` in the files relative to number fields (creation of methds `_arb_` and `_acb_` for that purpose)\n- remove c++ clumsy dependency (ntl for number fields)\n- `with X bits precision` -> `with X bits of precision` in string representation\n\n(follow up #24318)\n(this is part of the task ticket #24289)\n\nCC:  @mezzarobba\n\nReviewer: Marc Mezzarobba, Travis Scrimshaw\n\nAuthor: Vincent Delecroix\n\nBranch: 3396c3e648d6e56c6f87018a7ec808a26032d945\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/24285\n\n",
    "closed_at": "2017-12-13T17:37:50Z",
    "created_at": "2017-11-27T08:08:59Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "cleaning reall and complex balls",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24285",
    "user": "https://github.com/videlec"
}
```
We perform some cleaning

- move the conversion `number field -> ball` in the files relative to number fields (creation of methds `_arb_` and `_acb_` for that purpose)
- remove c++ clumsy dependency (ntl for number fields)
- `with X bits precision` -> `with X bits of precision` in string representation

(follow up #24318)
(this is part of the task ticket #24289)

CC:  @mezzarobba

Reviewer: Marc Mezzarobba, Travis Scrimshaw

Author: Vincent Delecroix

Branch: 3396c3e648d6e56c6f87018a7ec808a26032d945

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/24285





---

archive/issue_comments_461989.json:
```json
{
    "body": "Changing commit from \"\" to \"c949ad7d66bdbdd8e6a8a818f2b0b86e957d2e69\"",
    "created_at": "2017-11-27T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461989",
    "user": "https://github.com/videlec"
}
```

Changing commit from "" to "c949ad7d66bdbdd8e6a8a818f2b0b86e957d2e69"



---

archive/issue_comments_461990.json:
```json
{
    "body": "Changing branch from \"\" to \"u/vdelecroix/24285\"",
    "created_at": "2017-11-27T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461990",
    "user": "https://github.com/videlec"
}
```

Changing branch from "" to "u/vdelecroix/24285"



---

archive/issue_comments_461991.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|\n|[82dcce2](https://github.com/sagemath/sagetrac-mirror/commit/82dcce26b3bd0952c296d6f069cc7762bd344dc6)|`24285: cleaning in real_mpfi`|\n|[1a89009](https://github.com/sagemath/sagetrac-mirror/commit/1a89009be05749dc1cb38e1acd6dbe71fdecc5bb)|`24285: clean ball fields`|\n|[c949ad7](https://github.com/sagemath/sagetrac-mirror/commit/c949ad7d66bdbdd8e6a8a818f2b0b86e957d2e69)|`24285: now ball fields do not need C++`|",
    "created_at": "2017-11-27T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461991",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|
|[82dcce2](https://github.com/sagemath/sagetrac-mirror/commit/82dcce26b3bd0952c296d6f069cc7762bd344dc6)|`24285: cleaning in real_mpfi`|
|[1a89009](https://github.com/sagemath/sagetrac-mirror/commit/1a89009be05749dc1cb38e1acd6dbe71fdecc5bb)|`24285: clean ball fields`|
|[c949ad7](https://github.com/sagemath/sagetrac-mirror/commit/c949ad7d66bdbdd8e6a8a818f2b0b86e957d2e69)|`24285: now ball fields do not need C++`|



---

archive/issue_comments_461992.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-27T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461992",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461993.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[53370da](https://github.com/sagemath/sagetrac-mirror/commit/53370da4caa6f0c321658c6417b67c66932f94d8)|`24285: fixing doctests`|",
    "created_at": "2017-11-27T09:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461993",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[53370da](https://github.com/sagemath/sagetrac-mirror/commit/53370da4caa6f0c321658c6417b67c66932f94d8)|`24285: fixing doctests`|



---

archive/issue_comments_461994.json:
```json
{
    "body": "Changing commit from \"c949ad7d66bdbdd8e6a8a818f2b0b86e957d2e69\" to \"53370da4caa6f0c321658c6417b67c66932f94d8\"",
    "created_at": "2017-11-27T09:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461994",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c949ad7d66bdbdd8e6a8a818f2b0b86e957d2e69" to "53370da4caa6f0c321658c6417b67c66932f94d8"



---

archive/issue_comments_461995.json:
```json
{
    "body": "<a id='comment:3'></a>\nQuick comments (no time for a full review before several weeks): I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency. However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that\u2014even storing a copy of the precision in every ball would be a better option IMO\u2014and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change? I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.",
    "created_at": "2017-11-27T12:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461995",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>
Quick comments (no time for a full review before several weeks): I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency. However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that—even storing a copy of the precision in every ball would be a better option IMO—and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change? I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.



---

archive/issue_comments_461996.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [mmezzarobba](#comment%3A3):\n> Quick comments (no time for a full review before several weeks):\n\n\nThanks for having a quick look already. After reading your comments I would propose to:\n- make this ticket only about moving number field stuff and C++ care\n- open a more general ticket about \"convergence between real intervals and balls\"\n\n> I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency.\n\n\nIndeed. If you try to use Cython in a `pyx` file and use balls you are in troubles because there is no proper distutils directive in the headers. Moreover, it make more sense implemented that way.\n\n> However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that\u2014even storing a copy of the precision in every ball would be a better option IMO\u2014and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?\n\n\nWhy would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?\n\nThe real point is: \"How do you create a ball from nothing in Cython?\". This is needed here in the code\n\n```\ndef _arb_(self, R):\n    cdef RealBall x = ---> what do I put here? <----\n```\nThe way it is for interval is at least simple `R._new()`. And I just copied it for balls. I really dislike how people implementing balls just made their own coding conventions. I do not discuss the fact that they might be better (sometimes they do). Just the fact that they are different. The two interfaces should just be the same.\n\n> I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.\n\n\nSame comment applies: uniformity with real intervals. (BTW, a docstring is not any serious doctest breaking)",
    "created_at": "2017-11-27T13:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461996",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>
Replying to [mmezzarobba](#comment%3A3):
> Quick comments (no time for a full review before several weeks):


Thanks for having a quick look already. After reading your comments I would propose to:
- make this ticket only about moving number field stuff and C++ care
- open a more general ticket about "convergence between real intervals and balls"

> I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency.


Indeed. If you try to use Cython in a `pyx` file and use balls you are in troubles because there is no proper distutils directive in the headers. Moreover, it make more sense implemented that way.

> However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that—even storing a copy of the precision in every ball would be a better option IMO—and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?


Why would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?

The real point is: "How do you create a ball from nothing in Cython?". This is needed here in the code

```
def _arb_(self, R):
    cdef RealBall x = ---> what do I put here? <----
```
The way it is for interval is at least simple `R._new()`. And I just copied it for balls. I really dislike how people implementing balls just made their own coding conventions. I do not discuss the fact that they might be better (sometimes they do). Just the fact that they are different. The two interfaces should just be the same.

> I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.


Same comment applies: uniformity with real intervals. (BTW, a docstring is not any serious doctest breaking)



---

archive/issue_comments_461997.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n-We perform various cleaning with respect to balls in order to make them more likely their interval friends.\n+We perform a cleaning and correct a mispelling\n \n-- remove c++ clumsy dependency\n-- `with X bits precision` -> `with X bits of precision`\n-- use factories in order for parent to be extension class\n-- implement a `_new` on parent as well\n+- remove c++ clumsy dependency (ntl for number fields)\n+- `with X bits precision` -> `with X bits of precision` in string representation\n+\n+(part of the task ticket #24289)\n``````\n",
    "created_at": "2017-11-27T20:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461997",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
-We perform various cleaning with respect to balls in order to make them more likely their interval friends.
+We perform a cleaning and correct a mispelling
 
-- remove c++ clumsy dependency
-- `with X bits precision` -> `with X bits of precision`
-- use factories in order for parent to be extension class
-- implement a `_new` on parent as well
+- remove c++ clumsy dependency (ntl for number fields)
+- `with X bits precision` -> `with X bits of precision` in string representation
+
+(part of the task ticket #24289)
``````




---

archive/issue_comments_461998.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-27T20:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461998",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_461999.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [vdelecroix](#comment%3A4):\n> Replying to [mmezzarobba](#comment%3A3):\n> > However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that\u2014even storing a copy of the precision in every ball would be a better option IMO\u2014and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?\n\n> \n> Why would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?\n\n\nYes, and there are real benefits. The first is that by using a custom cache, you are making a strong reference to each parent. With `UniqueRepresentation`, it is only a weak reference, so you do not get the parents nailed in memory. It also is far less clean code:\n\n- You lose localization of the input and code; in particular, you either have duplicate documentation or either the creation function or object is lacking in documentation.\n- (Essentially) Duplicate code:\n\n  - You have to maintain the cache.\n  - You do not have the guarantees of uniqueness unless you handle pickles, `__copy__`, etc.\n  - You have to handle pickles.\n  - You have to handle comparisons.\n\n- Comparisons are now slower because they are not by `id`.\n\nSo I also think removing the `UniqueRepresentation` inheritance is a big step backwards. I do not see why you need the parent to be a `cdef` class. This does not seem to be a common optimization of creating an uninitialized ball, so just put `<RealBall> (RealBall.__new__(RealBall, R))` the place you need it. Yes, readability suffers slightly, but I think that is a marginal concern for code that is being optimized to the extent that you care about creating an uninitialized object in contrast to `RealBall(R)`.",
    "created_at": "2017-11-27T23:16:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-461999",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
Replying to [vdelecroix](#comment%3A4):
> Replying to [mmezzarobba](#comment%3A3):
> > However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that—even storing a copy of the precision in every ball would be a better option IMO—and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?

> 
> Why would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?


Yes, and there are real benefits. The first is that by using a custom cache, you are making a strong reference to each parent. With `UniqueRepresentation`, it is only a weak reference, so you do not get the parents nailed in memory. It also is far less clean code:

- You lose localization of the input and code; in particular, you either have duplicate documentation or either the creation function or object is lacking in documentation.
- (Essentially) Duplicate code:

  - You have to maintain the cache.
  - You do not have the guarantees of uniqueness unless you handle pickles, `__copy__`, etc.
  - You have to handle pickles.
  - You have to handle comparisons.

- Comparisons are now slower because they are not by `id`.

So I also think removing the `UniqueRepresentation` inheritance is a big step backwards. I do not see why you need the parent to be a `cdef` class. This does not seem to be a common optimization of creating an uninitialized ball, so just put `<RealBall> (RealBall.__new__(RealBall, R))` the place you need it. Yes, readability suffers slightly, but I think that is a marginal concern for code that is being optimized to the extent that you care about creating an uninitialized object in contrast to `RealBall(R)`.



---

archive/issue_comments_462000.json:
```json
{
    "body": "<a id='comment:7'></a>\nAlso, the category framework works better when the parents are plain Python classes. More generally, I thought there was a consensus that parents should always be Python classes, except perhaps in a few very special cases.\n\nRegarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible. And I don't think we made up our own coding conventions when implementing the arb interface. Rather, the implementation of MPFI intervals is quite outdated (and their behavior sometimes plainly incorrect), while the arb interface is more modern and more careful about giving correct results\u2014at the price that some things that rely on questionable behavior elsewhere in sage simply don't work.\n\nThe first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).",
    "created_at": "2017-11-28T09:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462000",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
Also, the category framework works better when the parents are plain Python classes. More generally, I thought there was a consensus that parents should always be Python classes, except perhaps in a few very special cases.

Regarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible. And I don't think we made up our own coding conventions when implementing the arb interface. Rather, the implementation of MPFI intervals is quite outdated (and their behavior sometimes plainly incorrect), while the arb interface is more modern and more careful about giving correct results—at the price that some things that rely on questionable behavior elsewhere in sage simply don't work.

The first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).



---

archive/issue_comments_462001.json:
```json
{
    "body": "Changing commit from \"53370da4caa6f0c321658c6417b67c66932f94d8\" to \"86c440049e2d537adbb63ae6558cd4ef0496034e\"",
    "created_at": "2017-11-28T20:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462001",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "53370da4caa6f0c321658c6417b67c66932f94d8" to "86c440049e2d537adbb63ae6558cd4ef0496034e"



---

archive/issue_comments_462002.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[d9469bc](https://github.com/sagemath/sagetrac-mirror/commit/d9469bc9d7e436d2d58ff8b0a9205f6f2f14cdab)|`24285: fix string representation`|\n|[75bc752](https://github.com/sagemath/sagetrac-mirror/commit/75bc752e907bac4083bd6e0d244e4826f5235514)|`24285: simplify real balls`|\n|[86c4400](https://github.com/sagemath/sagetrac-mirror/commit/86c440049e2d537adbb63ae6558cd4ef0496034e)|`24285: now ball fields do not need C++`|",
    "created_at": "2017-11-28T20:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[d9469bc](https://github.com/sagemath/sagetrac-mirror/commit/d9469bc9d7e436d2d58ff8b0a9205f6f2f14cdab)|`24285: fix string representation`|
|[75bc752](https://github.com/sagemath/sagetrac-mirror/commit/75bc752e907bac4083bd6e0d244e4826f5235514)|`24285: simplify real balls`|
|[86c4400](https://github.com/sagemath/sagetrac-mirror/commit/86c440049e2d537adbb63ae6558cd4ef0496034e)|`24285: now ball fields do not need C++`|



---

archive/issue_comments_462003.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-28T20:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462003",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_462004.json:
```json
{
    "body": "<a id='comment:9'></a>\nPlease move your interesting balls comments on #24289. This ticket stands for moving the quadratic number field conversion.",
    "created_at": "2017-11-28T20:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462004",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>
Please move your interesting balls comments on #24289. This ticket stands for moving the quadratic number field conversion.



---

archive/issue_comments_462005.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,7 @@\n-We perform a cleaning and correct a mispelling\n+We perform some cleaning\n \n+- move the conversion `number field -> ball` in the files relative to number fields (creation of methds `_arb_` and `_acb_` for that purpose)\n - remove c++ clumsy dependency (ntl for number fields)\n - `with X bits precision` -> `with X bits of precision` in string representation\n \n-(part of the task ticket #24289)\n+(this is part of the task ticket #24289)\n``````\n",
    "created_at": "2017-11-28T20:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462005",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,7 @@
-We perform a cleaning and correct a mispelling
+We perform some cleaning
 
+- move the conversion `number field -> ball` in the files relative to number fields (creation of methds `_arb_` and `_acb_` for that purpose)
 - remove c++ clumsy dependency (ntl for number fields)
 - `with X bits precision` -> `with X bits of precision` in string representation
 
-(part of the task ticket #24289)
+(this is part of the task ticket #24289)
``````




---

archive/issue_comments_462006.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [mmezzarobba](#comment%3A7):\n> Regarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible.\n\n\nYou really need to explain me what is the difference in usage then.\n\n> The first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).\n\n\nIndeed. It might be more reasonable starting in this direction. If you make your branch alive again I can review it.",
    "created_at": "2017-11-28T20:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462006",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>
Replying to [mmezzarobba](#comment%3A7):
> Regarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible.


You really need to explain me what is the difference in usage then.

> The first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).


Indeed. It might be more reasonable starting in this direction. If you make your branch alive again I can review it.



---

archive/issue_comments_462007.json:
```json
{
    "body": "<a id='comment:11'></a>\nAnd patchbots are happy!",
    "created_at": "2017-11-29T08:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462007",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
And patchbots are happy!



---

archive/issue_comments_462008.json:
```json
{
    "body": "<a id='comment:12'></a>\nSince `RealBallField` is a `UniqueRepresentation` it shouldn't need a custom `__reduce__` (left over from the previous changes?). Modulo that, I am happy. Marc?",
    "created_at": "2017-11-29T08:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462008",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
Since `RealBallField` is a `UniqueRepresentation` it shouldn't need a custom `__reduce__` (left over from the previous changes?). Modulo that, I am happy. Marc?



---

archive/issue_comments_462009.json:
```json
{
    "body": "<a id='comment:13'></a>\nRight! Good catch.",
    "created_at": "2017-11-29T08:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462009",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>
Right! Good catch.



---

archive/issue_comments_462010.json:
```json
{
    "body": "<a id='comment:14'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[9d2298f](https://github.com/sagemath/sagetrac-mirror/commit/9d2298fe35272320158f3e96cfc384067611ef59)|`24285: __reduce__ not needed on RealBallField`|",
    "created_at": "2017-11-29T08:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462010",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[9d2298f](https://github.com/sagemath/sagetrac-mirror/commit/9d2298fe35272320158f3e96cfc384067611ef59)|`24285: __reduce__ not needed on RealBallField`|



---

archive/issue_comments_462011.json:
```json
{
    "body": "Changing commit from \"86c440049e2d537adbb63ae6558cd4ef0496034e\" to \"9d2298fe35272320158f3e96cfc384067611ef59\"",
    "created_at": "2017-11-29T08:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462011",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "86c440049e2d537adbb63ae6558cd4ef0496034e" to "9d2298fe35272320158f3e96cfc384067611ef59"



---

archive/issue_comments_462012.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [tscrim](#comment%3A12):\n> Modulo that, I am happy. Marc?\n\n\nLooks reasonable to me, but I only skimmed through the code.\n\nWhy remove the ability to construct a complex ball from a machine integer? Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.\n\nTypos: \u201cthat the map go through\u201d, \u201dcancellationss\u201d.\n\nVincent: Yes, I'll try to see if I can do something with my old branch(es) about intervals, post my comments on the other ticket, etc. ...but not now.",
    "created_at": "2017-11-29T08:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462012",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:15'></a>
Replying to [tscrim](#comment%3A12):
> Modulo that, I am happy. Marc?


Looks reasonable to me, but I only skimmed through the code.

Why remove the ability to construct a complex ball from a machine integer? Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.

Typos: “that the map go through”, ”cancellationss”.

Vincent: Yes, I'll try to see if I can do something with my old branch(es) about intervals, post my comments on the other ticket, etc. ...but not now.



---

archive/issue_comments_462013.json:
```json
{
    "body": "Changing commit from \"9d2298fe35272320158f3e96cfc384067611ef59\" to \"27ac94bd2ff8b1e406e4da6ddb0bf93cb9b25f13\"",
    "created_at": "2017-11-29T09:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462013",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9d2298fe35272320158f3e96cfc384067611ef59" to "27ac94bd2ff8b1e406e4da6ddb0bf93cb9b25f13"



---

archive/issue_comments_462014.json:
```json
{
    "body": "<a id='comment:16'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------|\n|[27ac94b](https://github.com/sagemath/sagetrac-mirror/commit/27ac94bd2ff8b1e406e4da6ddb0bf93cb9b25f13)|`24285: too many s`|",
    "created_at": "2017-11-29T09:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------|
|[27ac94b](https://github.com/sagemath/sagetrac-mirror/commit/27ac94bd2ff8b1e406e4da6ddb0bf93cb9b25f13)|`24285: too many s`|



---

archive/issue_comments_462015.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [mmezzarobba](#comment%3A15):\n> Replying to [tscrim](#comment%3A12):\n> > Modulo that, I am happy. Marc?\n\n> \n> Why remove the ability to construct a complex ball from a machine integer?\n\n\nIt does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?\n\n> Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.\n\n\nNote that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value. If the user wants quick initialization she uses arb functions directly as in\n\n```\ncdef RealBall a = RealBall.__new__(RealBall)\na._parent = TheParent      # can possibly move in __cinit__?\narb_set_si(a.value, 13)\n```\n\n> Typos: \u201cthat the map go through\u201d\n\n\nis that a typo?\n\n> \u201dcancellationss\u201d.\n\n\nright. Fixed in 27ac94b",
    "created_at": "2017-11-29T09:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462015",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>
Replying to [mmezzarobba](#comment%3A15):
> Replying to [tscrim](#comment%3A12):
> > Modulo that, I am happy. Marc?

> 
> Why remove the ability to construct a complex ball from a machine integer?


It does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?

> Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.


Note that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value. If the user wants quick initialization she uses arb functions directly as in

```
cdef RealBall a = RealBall.__new__(RealBall)
a._parent = TheParent      # can possibly move in __cinit__?
arb_set_si(a.value, 13)
```

> Typos: “that the map go through”


is that a typo?

> ”cancellationss”.


right. Fixed in 27ac94b



---

archive/issue_comments_462016.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [vdelecroix](#comment%3A17):\n> Replying to [mmezzarobba](#comment%3A15):\n> > Typos: \u201cthat the map go through\u201d\n\n> \n> is that a typo?\n\n\nShould be \"that the map goes through\".",
    "created_at": "2017-11-29T09:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462016",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>
Replying to [vdelecroix](#comment%3A17):
> Replying to [mmezzarobba](#comment%3A15):
> > Typos: “that the map go through”

> 
> is that a typo?


Should be "that the map goes through".



---

archive/issue_comments_462017.json:
```json
{
    "body": "<a id='comment:19'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[3396c3e](https://github.com/sagemath/sagetrac-mirror/commit/3396c3e648d6e56c6f87018a7ec808a26032d945)|`24285: map go -> map goes`|",
    "created_at": "2017-11-29T09:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[3396c3e](https://github.com/sagemath/sagetrac-mirror/commit/3396c3e648d6e56c6f87018a7ec808a26032d945)|`24285: map go -> map goes`|



---

archive/issue_comments_462018.json:
```json
{
    "body": "Changing commit from \"27ac94bd2ff8b1e406e4da6ddb0bf93cb9b25f13\" to \"3396c3e648d6e56c6f87018a7ec808a26032d945\"",
    "created_at": "2017-11-29T09:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462018",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "27ac94bd2ff8b1e406e4da6ddb0bf93cb9b25f13" to "3396c3e648d6e56c6f87018a7ec808a26032d945"



---

archive/issue_comments_462019.json:
```json
{
    "body": "<a id='comment:20'></a>\nthanks",
    "created_at": "2017-11-29T09:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462019",
    "user": "https://github.com/videlec"
}
```

<a id='comment:20'></a>
thanks



---

archive/issue_comments_462020.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [vdelecroix](#comment%3A17):\n> It does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?\n\n\nI'm not sure it needs to be that slow when called from Cython code, but I admit I didn't measure. I don't really care anyway.\n\n> Note that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value.\n\n\nYes, that's what I meant, sorry. As far as I can say, the general logic how how constructors are organized in the arb interface is that (i)\u00a0`__cinit__()` does basic initialization, (ii)\u00a0`__init__()` wraps the C-level intializers provided by arb (and should be reasonably fast), and (iii)\u00a0`_element_constructor_()`, conversion morphisms and the like take care of everything else. This organization has pros and cons, but it sort of makes sense to me.",
    "created_at": "2017-11-29T09:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462020",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:21'></a>
Replying to [vdelecroix](#comment%3A17):
> It does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?


I'm not sure it needs to be that slow when called from Cython code, but I admit I didn't measure. I don't really care anyway.

> Note that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value.


Yes, that's what I meant, sorry. As far as I can say, the general logic how how constructors are organized in the arb interface is that (i) `__cinit__()` does basic initialization, (ii) `__init__()` wraps the C-level intializers provided by arb (and should be reasonably fast), and (iii) `_element_constructor_()`, conversion morphisms and the like take care of everything else. This organization has pros and cons, but it sort of makes sense to me.



---

archive/issue_comments_462021.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,4 +4,5 @@\n - remove c++ clumsy dependency (ntl for number fields)\n - `with X bits precision` -> `with X bits of precision` in string representation\n \n+(follow up #24318)\n (this is part of the task ticket #24289)\n``````\n",
    "created_at": "2017-12-04T10:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462021",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,4 +4,5 @@
 - remove c++ clumsy dependency (ntl for number fields)
 - `with X bits precision` -> `with X bits of precision` in string representation
 
+(follow up #24318)
 (this is part of the task ticket #24289)
``````




---

archive/issue_comments_462022.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-06T13:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462022",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_462023.json:
```json
{
    "body": "<a id='comment:23'></a>\nI am going to consider that as a positive review.",
    "created_at": "2017-12-06T13:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462023",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>
I am going to consider that as a positive review.



---

archive/issue_comments_462024.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Marc Mezzarobba, Travis Scrimshaw\"",
    "created_at": "2017-12-06T13:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462024",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Marc Mezzarobba, Travis Scrimshaw"



---

archive/issue_comments_462025.json:
```json
{
    "body": "<a id='comment:24'></a>\nThanks Travis and Marc. Indeed, remaining remarks mostly concern the parts of the ticket that have been moved to #24289.",
    "created_at": "2017-12-06T20:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462025",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'></a>
Thanks Travis and Marc. Indeed, remaining remarks mostly concern the parts of the ticket that have been moved to #24289.



---

archive/issue_comments_462026.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-13T17:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462026",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069917.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-13T17:37:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24285#event-69917"
}
```



---

archive/issue_comments_462027.json:
```json
{
    "body": "Changing branch from \"u/vdelecroix/24285\" to \"3396c3e648d6e56c6f87018a7ec808a26032d945\"",
    "created_at": "2017-12-13T17:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462027",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/vdelecroix/24285" to "3396c3e648d6e56c6f87018a7ec808a26032d945"



---

archive/issue_comments_462028.json:
```json
{
    "body": "Changing commit from \"3396c3e648d6e56c6f87018a7ec808a26032d945\" to \"\"",
    "created_at": "2018-01-31T08:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462028",
    "user": "https://github.com/mezzarobba"
}
```

Changing commit from "3396c3e648d6e56c6f87018a7ec808a26032d945" to ""



---

archive/issue_comments_462029.json:
```json
{
    "body": "<a id='comment:26'></a>\nActually this change:\n\n```\n-        elif isinstance(other, number_field.NumberField_quadratic):\n[...]\n+        from sage.rings.number_field.number_field_base import is_NumberField\n+        if is_NumberField(other):\n             emb = other.coerce_embedding()\n-            if emb is not None:\n-                return self.has_coerce_map_from(emb.codomain())\n+            return emb is not None and self.has_coerce_map_from(emb.codomain())\n }}}\nis not correct, because the ball constructor only accepts *quadratic* NF elements. NF elements of higher degree can be converted to complex balls, but only through CLF or CIF.\n\nFixed at #24621.",
    "created_at": "2018-01-31T08:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24285#issuecomment-462029",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:26'></a>
Actually this change:

```
-        elif isinstance(other, number_field.NumberField_quadratic):
[...]
+        from sage.rings.number_field.number_field_base import is_NumberField
+        if is_NumberField(other):
             emb = other.coerce_embedding()
-            if emb is not None:
-                return self.has_coerce_map_from(emb.codomain())
+            return emb is not None and self.has_coerce_map_from(emb.codomain())
 }}}
is not correct, because the ball constructor only accepts *quadratic* NF elements. NF elements of higher degree can be converted to complex balls, but only through CLF or CIF.

Fixed at #24621.
