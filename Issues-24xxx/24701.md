# Issue 24701: Crash in linbox compiled with clang-3.8

archive/issues_024464.json:
```json
{
    "body": "On OpenSuSE with clang-3.8 and `CC=clang CXX=clang++`\n\n```\nsage:  A = random_matrix(GF(127),200,200,density=0.01,sparse=True)\nsage: A.rank()\n---------------------------------------------------------------------------\nSignalError                               Traceback (most recent call last)\n<ipython-input-12-4b1a2344e717> in <module>()\n----> 1 A.rank()\n\n/home/ralf/sage/src/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse.rank (build/cythonized/sage/matrix/matrix_modn_sparse.c:9389)()\n    788         if is_prime(self.p):\n    789             if gauss is False:\n--> 790                 return self._rank_linbox(0)\n    791             elif gauss is True:\n    792                 return self._rank_linbox(1)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)\n    720                     kwds[new_name] = kwds[old_name]\n    721                     del kwds[old_name]\n--> 722             return func(*args, **kwds)\n    723 \n    724         return wrapper\n\n/home/ralf/sage/src/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse._rank_linbox (build/cythonized/sage/matrix/matrix_modn_sparse.c:9008)()\n    728                 return x\n    729             self._init_linbox()\n--> 730             sig_on()\n    731             # the returend pivots list is currently wrong\n    732             #r, pivots = linbox.rank(1)\n\nSignalError: Segmentation fault\n\n#0  0x00007fffe58f1422 in std::ostream::sentry::sentry(std::ostream&) ()\n   from /usr/lib64/libstdc++.so.6\n#1  0x00007fffe58f1a38 in std::basic_ostream<char, std::char_traits<char> >& std::__ostream_insert<char, std::char_traits<char> >(std::basic_ostream<char, std::char_traits<char> >&, char const*, long) () from /usr/lib64/libstdc++.so.6\n#2  0x00007ffdbc8d7b06 in std::operator<< <std::char_traits<char> > (\n    __out=..., __s=<optimized out>)\n    at /usr/bin/../lib64/gcc/x86_64-suse-linux/4.8/../../../../include/c++/4.8/ostream:535\n#3  LinBox::GaussDomain<Givaro::Modular<unsigned int, unsigned int> >::InPlaceLinearPivoting<LinBox::SparseMatrix<Givaro::Modular<unsigned int, unsigned int>, LinBox::SparseMatrixFormat::SparseSeq> > (this=<optimized out>, \n    Rank=<optimized out>, determinant=<optimized out>, LigneA=..., Ni=200, \n    Nj=200) at ../../linbox/algorithms/gauss/gauss.inl:505\n#4  0x00007ffdbc8d6ab9 in linbox_modn_sparse_matrix_rank (\n    modulus=<optimized out>, numrows=200, numcols=200, rows=<optimized out>, \n    gauss=0) at linbox-sage.C:119\n#5  0x00007ffdbaab26ea in __pyx_f_4sage_4libs_6linbox_6linbox_18Linbox_modn_sparse_rank (__pyx_v_self=<optimized out>, __pyx_v_gauss=46130704)\n    at build/cythonized/sage/libs/linbox/linbox.cpp:2826\n#6  0x00007ffdbe89162f in __pyx_pf_4sage_6matrix_18matrix_modn_sparse_18Matrix_modn_sparse_28_rank_linbox (__pyx_v_self=0x7ffd9c6f69e0, __pyx_v_algorithm=)\n    at build/cythonized/sage/matrix/matrix_modn_sparse.c:9018\n#7  0x00007ffff7a44d01 in PyObject_Call \n```\n\n\n**Resolution:** duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/24701\n\n",
    "closed_at": "2018-08-14T17:28:31Z",
    "created_at": "2018-02-10T07:13:27Z",
    "labels": [
        "component: packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Crash in linbox compiled with clang-3.8",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24701",
    "user": "https://github.com/rwst"
}
```
On OpenSuSE with clang-3.8 and `CC=clang CXX=clang++`

```
sage:  A = random_matrix(GF(127),200,200,density=0.01,sparse=True)
sage: A.rank()
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-12-4b1a2344e717> in <module>()
----> 1 A.rank()

/home/ralf/sage/src/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse.rank (build/cythonized/sage/matrix/matrix_modn_sparse.c:9389)()
    788         if is_prime(self.p):
    789             if gauss is False:
--> 790                 return self._rank_linbox(0)
    791             elif gauss is True:
    792                 return self._rank_linbox(1)

/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)
    720                     kwds[new_name] = kwds[old_name]
    721                     del kwds[old_name]
--> 722             return func(*args, **kwds)
    723 
    724         return wrapper

/home/ralf/sage/src/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse._rank_linbox (build/cythonized/sage/matrix/matrix_modn_sparse.c:9008)()
    728                 return x
    729             self._init_linbox()
--> 730             sig_on()
    731             # the returend pivots list is currently wrong
    732             #r, pivots = linbox.rank(1)

SignalError: Segmentation fault

#0  0x00007fffe58f1422 in std::ostream::sentry::sentry(std::ostream&) ()
   from /usr/lib64/libstdc++.so.6
#1  0x00007fffe58f1a38 in std::basic_ostream<char, std::char_traits<char> >& std::__ostream_insert<char, std::char_traits<char> >(std::basic_ostream<char, std::char_traits<char> >&, char const*, long) () from /usr/lib64/libstdc++.so.6
#2  0x00007ffdbc8d7b06 in std::operator<< <std::char_traits<char> > (
    __out=..., __s=<optimized out>)
    at /usr/bin/../lib64/gcc/x86_64-suse-linux/4.8/../../../../include/c++/4.8/ostream:535
#3  LinBox::GaussDomain<Givaro::Modular<unsigned int, unsigned int> >::InPlaceLinearPivoting<LinBox::SparseMatrix<Givaro::Modular<unsigned int, unsigned int>, LinBox::SparseMatrixFormat::SparseSeq> > (this=<optimized out>, 
    Rank=<optimized out>, determinant=<optimized out>, LigneA=..., Ni=200, 
    Nj=200) at ../../linbox/algorithms/gauss/gauss.inl:505
#4  0x00007ffdbc8d6ab9 in linbox_modn_sparse_matrix_rank (
    modulus=<optimized out>, numrows=200, numcols=200, rows=<optimized out>, 
    gauss=0) at linbox-sage.C:119
#5  0x00007ffdbaab26ea in __pyx_f_4sage_4libs_6linbox_6linbox_18Linbox_modn_sparse_rank (__pyx_v_self=<optimized out>, __pyx_v_gauss=46130704)
    at build/cythonized/sage/libs/linbox/linbox.cpp:2826
#6  0x00007ffdbe89162f in __pyx_pf_4sage_6matrix_18matrix_modn_sparse_18Matrix_modn_sparse_28_rank_linbox (__pyx_v_self=0x7ffd9c6f69e0, __pyx_v_algorithm=)
    at build/cythonized/sage/matrix/matrix_modn_sparse.c:9018
#7  0x00007ffff7a44d01 in PyObject_Call 
```


**Resolution:** duplicate

Issue created by migration from https://trac.sagemath.org/ticket/24701





---

archive/issue_comments_471234.json:
```json
{
    "body": "<a id='comment:1'></a>\nHum, still clang using gcc's libstdc++ from gcc 4.8 in this case. Would sage want to build its own gcc on that box if there is just gcc-4.8?",
    "created_at": "2018-02-10T07:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471234",
    "user": "https://github.com/kiwifb"
}
```


<a id='comment:1'></a>
Hum, still clang using gcc's libstdc++ from gcc 4.8 in this case. Would sage want to build its own gcc on that box if there is just gcc-4.8?



---

archive/issue_comments_471235.json:
```json
{
    "body": "<a id='comment:2'></a>\nI can't even replace that library but using a libc++ if the system has it would be nice.",
    "created_at": "2018-02-10T09:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471235",
    "user": "https://github.com/rwst"
}
```


<a id='comment:2'></a>
I can't even replace that library but using a libc++ if the system has it would be nice.



---

archive/issue_events_070705.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "rename": {
        "from": "Segfault in linbox when compiled with clang-3.8",
        "to": "configure should make sure that on Linux libc++ is used with clang"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24701#event-70705"
}
```




---

archive/issue_comments_471236.json:
```json
{
    "body": "<a id='comment:4'></a>\nThat's a tall order as a check. Here it is also possible that the problem is the age of the gcc's libstdc++. Although I think it is better to use libc++/libcxx and that may be easier to enforce even it turns to be overbroad.",
    "created_at": "2018-02-11T06:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471236",
    "user": "https://github.com/kiwifb"
}
```


<a id='comment:4'></a>
That's a tall order as a check. Here it is also possible that the problem is the age of the gcc's libstdc++. Although I think it is better to use libc++/libcxx and that may be easier to enforce even it turns to be overbroad.



---

archive/issue_comments_471237.json:
```json
{
    "body": "<a id='comment:5'></a>\nWhere we are now is that the right flags seem to be\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++ --stdlib=libc++\"\nexport CXXFLAGS=\"$CXXFLAGS --stdlib=libc++\"\nexport LDFLAGS=\"$LDFLAGS -lc++ --stdlib=libc++\"\n```\nThe stdlib directive is needed on all three variables because 1. without it in CXX several packages ignore CXXFLAGS and so it's not applied with clang++ (the compiler), 2. CXXFLAGS um well it belongs there, and 3. without it in LDFLAGS several packages link with libstdc++ (fpylll, sagelib).\n\nProblem is #24705 and #24710.",
    "created_at": "2018-02-11T15:29:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471237",
    "user": "https://github.com/rwst"
}
```


<a id='comment:5'></a>
Where we are now is that the right flags seem to be

```
export CC="clang"
export CXX="clang++ --stdlib=libc++"
export CXXFLAGS="$CXXFLAGS --stdlib=libc++"
export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
```
The stdlib directive is needed on all three variables because 1. without it in CXX several packages ignore CXXFLAGS and so it's not applied with clang++ (the compiler), 2. CXXFLAGS um well it belongs there, and 3. without it in LDFLAGS several packages link with libstdc++ (fpylll, sagelib).

Problem is #24705 and #24710.



---

archive/issue_comments_471238.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [rws](#comment%3A5):\n> Where we are now is that the right flags seem to be\n> \n> ```\n> export CC=\"clang\"\n> export CXX=\"clang++ --stdlib=libc++\"\n> export CXXFLAGS=\"$CXXFLAGS --stdlib=libc++\"\n> export LDFLAGS=\"$LDFLAGS -lc++ --stdlib=libc++\"\n> ```\n\n\nActually I also need to add `-I/usr/include/libcxxabi/` for otherwise brial won't find a certain header (on my computer at least).\n\n> The stdlib directive is needed on all three variables because 1. without it in CXX several packages ignore CXXFLAGS and so it's not applied with clang++ (the compiler), 2. CXXFLAGS um well it belongs there, and 3. without it in LDFLAGS several packages link with libstdc++ (fpylll, sagelib).\n> \n> Problem is #24705 and #24710.\n",
    "created_at": "2018-02-11T18:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471238",
    "user": "https://github.com/simon-king-jena"
}
```


<a id='comment:6'></a>
Replying to [rws](#comment%3A5):
> Where we are now is that the right flags seem to be
> 
> ```
> export CC="clang"
> export CXX="clang++ --stdlib=libc++"
> export CXXFLAGS="$CXXFLAGS --stdlib=libc++"
> export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
> ```


Actually I also need to add `-I/usr/include/libcxxabi/` for otherwise brial won't find a certain header (on my computer at least).

> The stdlib directive is needed on all three variables because 1. without it in CXX several packages ignore CXXFLAGS and so it's not applied with clang++ (the compiler), 2. CXXFLAGS um well it belongs there, and 3. without it in LDFLAGS several packages link with libstdc++ (fpylll, sagelib).
> 
> Problem is #24705 and #24710.




---

archive/issue_comments_471239.json:
```json
{
    "body": "<a id='comment:7'></a>\nSo this ticket is wontfix. Use these flags:\n\n```\nexport CC=\"clang\"\nexport CXX=\"clang++\"\nexport CLANG_DEFAULT_CXX_STDLIB=\"libc++\"\n```",
    "created_at": "2018-02-12T07:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471239",
    "user": "https://github.com/rwst"
}
```


<a id='comment:7'></a>
So this ticket is wontfix. Use these flags:

```
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
```



---

archive/issue_events_070706.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T07:13:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24701#event-70706"
}
```




---

archive/issue_comments_471240.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-02-12T07:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471240",
    "user": "https://github.com/rwst"
}
```


**Changing status** from new to needs_review.



---

archive/issue_comments_471241.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-02-12T07:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471241",
    "user": "https://github.com/rwst"
}
```


**Changing status** from needs_review to positive_review.



---

archive/issue_comments_471242.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [rws](#comment%3A7):\n> So this ticket is wontfix. Use these flags:\n> \n> ```\n> export CC=\"clang\"\n> export CXX=\"clang++\"\n> export CLANG_DEFAULT_CXX_STDLIB=\"libc++\"\n> ```\n\n\nI understand that this ticket is not about letting sagelib build with clang (that's #24705). So, I'm not reverting the positive review for now.",
    "created_at": "2018-02-12T07:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471242",
    "user": "https://github.com/simon-king-jena"
}
```


<a id='comment:9'></a>
Replying to [rws](#comment%3A7):
> So this ticket is wontfix. Use these flags:
> 
> ```
> export CC="clang"
> export CXX="clang++"
> export CLANG_DEFAULT_CXX_STDLIB="libc++"
> ```


I understand that this ticket is not about letting sagelib build with clang (that's #24705). So, I'm not reverting the positive review for now.



---

archive/issue_comments_471243.json:
```json
{
    "body": "**Changing status** from positive_review to needs_review.",
    "created_at": "2018-02-13T15:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471243",
    "user": "https://github.com/rwst"
}
```


**Changing status** from positive_review to needs_review.



---

archive/issue_comments_471244.json:
```json
{
    "body": "<a id='comment:10'></a>\n#24716 looks similar. Duplicate?",
    "created_at": "2018-02-13T15:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471244",
    "user": "https://github.com/rwst"
}
```


<a id='comment:10'></a>
#24716 looks similar. Duplicate?



---

archive/issue_events_070707.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "rename": {
        "from": "configure should make sure that on Linux libc++ is used with clang",
        "to": "Crash in linbox compiled with clang-3.8"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24701#event-70707"
}
```




---

archive/issue_comments_471245.json:
```json
{
    "body": "**Resolution:** duplicate",
    "created_at": "2018-08-14T17:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24701#issuecomment-471245",
    "user": "https://github.com/embray"
}
```


**Resolution:** duplicate



---

archive/issue_events_070708.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-14T17:28:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24701",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24701#event-70708"
}
```

