# Issue 19251: Random failure in AffineCrystalFromClassicalElement.__cmp__

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-10-27 20:12:34

CC:  tscrim

Keywords: random_fail

Random failure, here on OSX:

```
sage -t --long src/sage/combinat/crystals/affine.py
**********************************************************************
File "src/sage/combinat/crystals/affine.py", line 574, in sage.combinat.crystals.affine.AffineCrystalFromClassicalElement.__cmp__
Failed example:
    cmp(b,1)
Expected:
    -1
Got:
    1
**********************************************************************
1 item had failures:
   1 of   7 in sage.combinat.crystals.affine.AffineCrystalFromClassicalElement.__cmp__
```



---

Comment by tscrim created at 2015-10-27 20:46:24

This looks like something that is going to be introduced by the `__hash__` people on #19016. This doctest does not exist currently in Sage.


---

Comment by chapoton created at 2016-08-18 19:02:31

I tried to make a branch using the brand new possibilities of "richcmp(x,y,op)". (see #21128)

I am a bit disappointed by the results of comparison with op in `<,>,>=,<=`.

Travis, what do you think ?
----
New commits:


---

Comment by tscrim created at 2016-08-18 22:55:44

I am pretty sure this is not correct:

```python
if parent(self) is not parent(other):
    return NotImplemented
```

You need to check if the comparison is `!=` as otherwise you would have `1 == b` and `1 != b` both return `False`.

Could you also elaborate more on what you mean by this?

> I am a bit disappointed by the results of comparison with op in `<,>,>=,<=`.


---

Comment by git created at 2016-08-19 07:53:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-19 07:56:17

I have replace `__richcmp__` by `_richcmp_`, for which one can assume that
arguments have the same parents. Now one gets

```
sage: b==1
False
sage: b!=1
True
```

But

```
sage: cmp(b,c)
-1
sage: cmp(c,b)
1
sage: c<b
False
sage: b<c
False
```

Maybe for coherence we will need to apply the same treatment to all crystals ?


---

Comment by tscrim created at 2016-08-19 08:26:24

You forget that if cmp does not error out, then it forces some total ordering (probably memory location), so that behavior is consistent with this. I don't think at this point we need to doing anything elsewhere.


---

Comment by chapoton created at 2016-08-19 10:07:51

This is really puzzling to me (on this branch):

```
sage: b<c
False
sage: cmp(b,c)
-1
sage: b._richcmp_(c,0)
True
sage: b.__cmp__(c)
-1

```

what is the first line doing, if not calling either cmp or `__cmp__` or rich comparison ?


---

Comment by chapoton created at 2016-08-19 12:57:58

This branch triggers failing doctests in other crystals, as I was expecting:

```
sage -t --long src/sage/categories/regular_crystals.py  # 3 doctests failed
sage -t --long src/sage/combinat/crystals/subcrystal.py  # 6 doctests failed
```



---

Comment by git created at 2016-08-26 13:18:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-08-27 05:01:28

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-08-27 05:01:28

I traced the problem down to `ElementWrapper` defining a `__richcmp__`. So I changed that to `_richcmp_` and fixed a few trivial doctest failures. Now off to the patchbot.
----
New commits:


---

Comment by git created at 2016-08-27 11:26:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-27 11:27:18

I modified 3 failing doctests, there just remains one in pickling.


---

Comment by tscrim created at 2016-08-27 16:53:39

So the problem with the pickling and `_richcmp_` has to do with equality versus identical parents. The parents are equal but not identical. This causes problems for `__richcmp__`, where it relies on parents being identical. It then creates an element wrapping an element of the test parent.

We can either implement the following the test parent to fix the doctest:

```sage
    def _element_constructor_(self, x):
        if isinstance(x, ElementWrapper):
            if x.parent() == self:
                return self.element_class(self, x.value)
        return Parent._element_constructor_(self, x)

    def _an_element_(self):
        return self.element_class(self, "_an_element_")
```

The other way is to override `__richcmp__` for `ElementWrapper` to handle when parents are equal but not identical.

I'm thinking the latter option is the way to go forward as it is backwards compatible.


---

Comment by chapoton created at 2016-08-29 19:11:44

I am sorry, but I am not quite able to follow your reasoning. If you feel you have a reasonable solution, please proceed.


---

Comment by tscrim created at 2016-08-29 19:28:32

The problem is

```sage
sage: TestParent4() == TestParent4()
True
sage: TestParent4() is TestParent4()
```

So picking creates a new equal-but-not-identical parent. Thus there is a canonical coercion map that calls the `_element_constructor_`, which simply wraps the element (the result is a wrapped element of a wrapped element). If the parents were identical, then _no_ map would be applied (this is a shortcut of the coercion model), and so the values would simply be compared as normal.

TL;DR, yes, I have a very reasonable solution.


---

Comment by git created at 2016-08-29 19:42:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-09-01 04:51:14

patchbot is green.


---

Comment by chapoton created at 2016-09-01 07:03:19

Just to be sure, `__richcmp__` will be called first, is this right ?

And why do these two richcmp methods do not use self as first parameter ?


---

Comment by tscrim created at 2016-09-01 13:56:27

Replying to [comment:19 chapoton]:
> Just to be sure, `__richcmp__` will be called first, is this right ?

Yes. `__richcmp__` is called by Python, whereas `_richcmp_` is the Sage version that is called from `__richcmp__`.

> And why do these two richcmp methods do not use self as first parameter ?

So `self` is known to Cython to be an `ElementWrapper` for speed for `_richcmp_` (or so I've been told). For `__richcmp__`, it was a result of copy/paste and laziness. I'm okay with changing both of them.


---

Comment by chapoton created at 2016-09-01 15:03:31

oh, well. I am happy enough with the current state, let us move to something else.

Do you think we should give the same treatment to other crystals ?


---

Comment by chapoton created at 2016-09-01 15:03:31

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-09-01 15:06:33

We can if you want, but it will be a low priority for me for the next week.


---

Comment by vbraun created at 2016-09-04 00:14:00

Resolution: fixed
