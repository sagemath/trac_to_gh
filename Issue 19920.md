# Issue 19920: make numpy and scipy use pkg-config to find blas/lapack

Issue created by migration from https://trac.sagemath.org/ticket/20157

Original creator: fbissey

Original creation time: 2016-03-04 01:46:46

CC:  jdemeyer

Since we want the choice of blas/lapack to be configurable by `.pc` files we need to have `numpy` and `scipy` obey to `pkg-config`.

This is complicated by the fact that `numpy/scipy`'s build system will look for 
 1) mkl
 2) openblas
 3) threaded atlas 3.10.x (tatlas.so)
 4) single thread atlas 3.10.x (satlas.so)
 5) threaded atlas (any versions)
 6) single thread atlas (any versions)
 7) accelerate on OS X
 8) blas/lapack configuration provided by the user
 9) blas/lapack source provided by the user

In that order from (1) to (9). Note that the user's wishes are ignored unless everything else fails. Getting `numpy/scipy` to obey `pkg-config` may therefore require patching.


---

Comment by fbissey created at 2016-03-04 03:07:07

Actually 

```
export {ATLAS,PTATLAS,BLAS,LAPACK,OPENBLAS,MKL}=None
```

shuts down all detection so there is hope things can be taken done selectively.


---

Comment by fbissey created at 2016-03-04 03:49:20

Setting everything to None except for `BLAS` and `LAPACK` and then giving those some values is not enough. I have got something quite ugly.


---

Comment by fbissey created at 2016-03-04 10:28:05

New commits:


---

Comment by fbissey created at 2016-03-05 19:09:43

Changing status from new to needs_review.


---

Comment by fbissey created at 2016-03-05 19:19:14

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2016-03-05 19:19:14

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by git created at 2016-03-05 19:33:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-05 19:34:24

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-03-05 22:53:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-06 10:24:03

Full log: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20Desktop%20%28Fedora%2022%20x86_64%29%20incremental/builds/458/steps/compile/logs/stdio

```
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:1651: UserWarning: 
    Atlas (http://math-atlas.sourceforge.net/) libraries not found.
    Directories to search for the libraries can be specified in the
    numpy/distutils/site.cfg file (section [atlas]) or by setting
    the ATLAS environment variable.
  warnings.warn(AtlasNotFoundError.__doc__)
blas_info:
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.
  warnings.warn('Specified path %s is invalid.' % d)
C compiler: cc

creating /tmp/tmpX0K4bQ/tmp
creating /tmp/tmpX0K4bQ/tmp/tmpX0K4bQ
compile options: '-c'
cc: /tmp/tmpX0K4bQ/source.c
cc /tmp/tmpX0K4bQ/tmp/tmpX0K4bQ/source.o -L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lcblas -o /tmp/tmpX0K4bQ/a.out
/usr/bin/ld: warning: libatlas.so.3, needed by /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/libcblas.so, not found (try using -rpath or -rpath-link)
```

It is missing the `-latlas` for some reason, though it is in the `cblas.pc`

```
$ pkg-config --libs cblas
-L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lcblas -latlas 
```



---

Comment by vbraun created at 2016-03-06 10:24:03

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2016-03-06 10:27:38

Can you look at the generated `site.cfg` file?


---

Comment by fbissey created at 2016-03-06 10:31:48

I notice poseidon also has a problem but look slightly different.


---

Comment by vbraun created at 2016-03-06 10:39:45


```
$ cat /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/site.cfg
[DEFAULT]
library_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib
include_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/include
[blas]
include_dirs = 
library_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib
blas_libs = atlas,f77blas,cblas
[lapack]
library_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib
lapack_libs = lapack,f77blas,cblas,atlas
```



---

Comment by fbissey created at 2016-03-06 21:46:59

OK I think there may be niceties in the linker. Here I get:

```
creating /tmp/tmpRM4d1X/tmp
creating /tmp/tmpRM4d1X/tmp/tmpRM4d1X
compile options: '-c'
cc: /tmp/tmpRM4d1X/source.c
cc /tmp/tmpRM4d1X/tmp/tmpRM4d1X/source.o -L/home/fbissey/sandbox/git-fork/sage/local/lib -lcblas -o /tmp/tmpRM4d1X/a.out
  FOUND:
    libraries = ['cblas']
    library_dirs = ['/home/fbissey/sandbox/git-fork/sage/local/lib']
    language = c
    define_macros = [('HAVE_CBLAS', None)]

  FOUND:
    libraries = ['cblas']
    library_dirs = ['/home/fbissey/sandbox/git-fork/sage/local/lib']
    define_macros = [('NO_ATLAS_INFO', 1), ('HAVE_CBLAS', None)]
    language = c
```

So we have only `cblas` again. But my linker still resolves it from the information in the `cblas` library.

I think there is a small bug (feature) in `numpy` that causes it to only use a single library. I think I now which part of the Gentoo patch deals with that,


---

Comment by git created at 2016-03-06 23:17:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-06 23:21:41

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-03-06 23:21:41

OK I added part of a patch from Gentoo that will let numpy's system_info.py take more that one library. I beautified the `lapack_conf.py` a bit. And revisited `scipy`'s case. It turns out we can dispense with `site.cfg`.


---

Comment by fbissey created at 2016-03-07 07:31:36

poseidon is stumping me. There is not even a compilation line

```
blas_info:
/home/kevin/sage-patchbot/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.
  warnings.warn('Specified path %s is invalid.' % d)
  libraries atlas,f77blas,cblas not found in []
  NOT AVAILABLE
```



---

Comment by fbissey created at 2016-03-07 20:25:04

While the absence of compilation output is annoying it may be due to a weakness of `pkgconfig` which can change the order of the libraries. Library order is important if your `ld` has `--as-needed` by default. We could try to pass `--no-as-needed` but it would be better if the order could be fixed from `pkgconfig`.


---

Comment by fbissey created at 2016-03-07 23:39:11

Replying to [comment:18 fbissey]:
> While the absence of compilation output is annoying it may be due to a weakness of `pkgconfig` which can change the order of the libraries. Library order is important if your `ld` has `--as-needed` by default. We could try to pass `--no-as-needed` but it would be better if the order could be fixed from `pkgconfig`.

There must something else otherwise building `cvxopt` should fail on the same machine.


---

Comment by vbraun created at 2016-03-09 23:19:36

I don't understand, its is a strong point of pkg-config that it gets library order correct regardless of the argument order.

Of course only if the pc files have the appropriate `Requires:` dependency information. E.g. right now our `lapack.pc` does this wrong, though I don't think that is the issue here.


---

Comment by vbraun created at 2016-03-09 23:20:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-09 23:20:04

In any case I'm going to run this on the build bot...


---

Comment by fbissey created at 2016-03-09 23:22:06

I am fairly sure that's not the issue. As for the order I am fairly sure that it is due to the fact that pkgconfig (python interface) uses sets. Because the set is not ordered, order can be be changed. For the `library` field it would have been better to use a list I think.


---

Comment by vbraun created at 2016-03-10 08:48:14

Possibly, though really the order of all compiler switches potentially matters not just the libraries. So the goal should be to a) always use pc files and then b) directly use the output string from `pkgconfig.libs(...)` instead of `pkgconfig.parse`


---

Comment by vbraun created at 2016-03-10 08:50:47

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-03-10 08:50:47

Fails to build scipy on some platforms:
* http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20%28Ubuntu%2012.10%29%20incremental/builds/529
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2032%20bit%29%20incremental/builds/423
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2064%20bit%29%20incremental/builds/395
Possibly due to this:

```
/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.
  warnings.warn('Specified path %s is invalid.' % d)
  libraries lapack,f77blas,cblas,atlas not found in []
  NOT AVAILABLE
```



---

Comment by fbissey created at 2016-03-10 09:01:46

OK. I think I see a pattern now. I have to check the `system_info.py` code again. The real breaking point is

```
libraries lapack,f77blas,cblas,atlas not found in []
```

the rest before is in common with successful build. It has to be a failure in finding at `[]` instead of the given `library_dirs` why it happens some times and not some other will be interesting to untangle.


---

Comment by git created at 2016-03-11 05:57:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-11 05:58:11

Let's see what the bots make of that.


---

Comment by fbissey created at 2016-03-11 05:58:11

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-03-13 21:38:05

I tried to get a machine reproducing poseidon's problems and failed. So I am switching to a debug branch in the hope that poseidon will spit out a clue for me. Do not review this branch.
----
New commits:


---

Comment by fbissey created at 2016-03-13 22:00:20

Well it spat something useful

```
[ALL]
library_dirs = /home/kevin/sage-patchbot/local/lib
include_dirs = /home/kevin/sage-patchbot/local/include
[blas]
library_dirs = 
blas_libs    = atlas, f77blas, cblas
[lapack]
library_dirs = 
lapack_libs  = lapack, f77blas, cblas, atlas
```

Back to the atlas spkg for inspection.


---

Comment by git created at 2016-03-13 22:13:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-13 22:13:53

Still no review please.


---

Comment by fbissey created at 2016-03-14 20:57:44

Random failures should now be solved by #20208.


---

Comment by git created at 2016-03-22 00:24:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-03-22 01:52:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-22 01:54:07

Clean up and merge #20208 so it does build on poseidon out of the box. Cross fingers.


---

Comment by fbissey created at 2016-03-22 20:38:32

And poseidon still fails because `pkgconf` hasn't been rebuild before `numpy`..... I guess I will have to wait until #20208 is in a beta.


---

Comment by git created at 2016-03-25 03:07:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-25 03:08:56

Rebased on 7.2.beta0 which includes #20208.


---

Comment by git created at 2016-03-28 22:07:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-29 05:00:39

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2016-03-29 05:00:39

Finally building on poseidon. Theory: #20208 fixes the case where there is no global `pkg-config` installed and `sage`'s `pkgconf` is used and in that case having it not strip default library directories when present in the `.pc` file. But poseidon still failed, probably because it has a global `pkg-config` command available and it happens to be `pkgconf`. Because it is provided by the system #20208 doesn't fix it.

The `lapack.conf` script is much more robust as a result of the latest commit.

Putting back to positive review.


---

Comment by vbraun created at 2016-03-30 14:05:49

Resolution: fixed
