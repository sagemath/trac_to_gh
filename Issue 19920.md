# Issue 19920: make numpy and scipy use pkg-config to find blas/lapack

archive/issues_019920.json:
```json
{
    "body": "CC:  jdemeyer\n\nSince we want the choice of blas/lapack to be configurable by `.pc` files we need to have `numpy` and `scipy` obey to `pkg-config`.\n\nThis is complicated by the fact that `numpy/scipy`'s build system will look for \n 1) mkl\n 2) openblas\n 3) threaded atlas 3.10.x (tatlas.so)\n 4) single thread atlas 3.10.x (satlas.so)\n 5) threaded atlas (any versions)\n 6) single thread atlas (any versions)\n 7) accelerate on OS X\n 8) blas/lapack configuration provided by the user\n 9) blas/lapack source provided by the user\n\nIn that order from (1) to (9). Note that the user's wishes are ignored unless everything else fails. Getting `numpy/scipy` to obey `pkg-config` may therefore require patching.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20157\n\n",
    "created_at": "2016-03-04T01:46:46Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "make numpy and scipy use pkg-config to find blas/lapack",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19920",
    "user": "fbissey"
}
```
CC:  jdemeyer

Since we want the choice of blas/lapack to be configurable by `.pc` files we need to have `numpy` and `scipy` obey to `pkg-config`.

This is complicated by the fact that `numpy/scipy`'s build system will look for 
 1) mkl
 2) openblas
 3) threaded atlas 3.10.x (tatlas.so)
 4) single thread atlas 3.10.x (satlas.so)
 5) threaded atlas (any versions)
 6) single thread atlas (any versions)
 7) accelerate on OS X
 8) blas/lapack configuration provided by the user
 9) blas/lapack source provided by the user

In that order from (1) to (9). Note that the user's wishes are ignored unless everything else fails. Getting `numpy/scipy` to obey `pkg-config` may therefore require patching.

Issue created by migration from https://trac.sagemath.org/ticket/20157





---

archive/issue_comments_274199.json:
```json
{
    "body": "Actually \n\n```\nexport {ATLAS,PTATLAS,BLAS,LAPACK,OPENBLAS,MKL}=None\n```\n\nshuts down all detection so there is hope things can be taken done selectively.",
    "created_at": "2016-03-04T03:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274199",
    "user": "fbissey"
}
```

Actually 

```
export {ATLAS,PTATLAS,BLAS,LAPACK,OPENBLAS,MKL}=None
```

shuts down all detection so there is hope things can be taken done selectively.



---

archive/issue_comments_274200.json:
```json
{
    "body": "Setting everything to None except for `BLAS` and `LAPACK` and then giving those some values is not enough. I have got something quite ugly.",
    "created_at": "2016-03-04T03:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274200",
    "user": "fbissey"
}
```

Setting everything to None except for `BLAS` and `LAPACK` and then giving those some values is not enough. I have got something quite ugly.



---

archive/issue_comments_274201.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-03-04T10:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274201",
    "user": "fbissey"
}
```

New commits:



---

archive/issue_comments_274202.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-05T19:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274202",
    "user": "fbissey"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_274203.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-05T19:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274203",
    "user": "fbissey"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_274204.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: standard.",
    "created_at": "2016-03-05T19:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274204",
    "user": "fbissey"
}
```

Changing component from PLEASE CHANGE to packages: standard.



---

archive/issue_comments_274205.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-05T19:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274205",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274206.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-05T19:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274206",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274207.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-05T22:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274207",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274208.json:
```json
{
    "body": "Full log: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20Desktop%20%28Fedora%2022%20x86_64%29%20incremental/builds/458/steps/compile/logs/stdio\n\n```\n/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:1651: UserWarning: \n    Atlas (http://math-atlas.sourceforge.net/) libraries not found.\n    Directories to search for the libraries can be specified in the\n    numpy/distutils/site.cfg file (section [atlas]) or by setting\n    the ATLAS environment variable.\n  warnings.warn(AtlasNotFoundError.__doc__)\nblas_info:\n/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.\n  warnings.warn('Specified path %s is invalid.' % d)\nC compiler: cc\n\ncreating /tmp/tmpX0K4bQ/tmp\ncreating /tmp/tmpX0K4bQ/tmp/tmpX0K4bQ\ncompile options: '-c'\ncc: /tmp/tmpX0K4bQ/source.c\ncc /tmp/tmpX0K4bQ/tmp/tmpX0K4bQ/source.o -L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lcblas -o /tmp/tmpX0K4bQ/a.out\n/usr/bin/ld: warning: libatlas.so.3, needed by /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/libcblas.so, not found (try using -rpath or -rpath-link)\n```\n\nIt is missing the `-latlas` for some reason, though it is in the `cblas.pc`\n\n```\n$ pkg-config --libs cblas\n-L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lcblas -latlas \n```\n",
    "created_at": "2016-03-06T10:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274208",
    "user": "vbraun"
}
```

Full log: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20Desktop%20%28Fedora%2022%20x86_64%29%20incremental/builds/458/steps/compile/logs/stdio

```
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:1651: UserWarning: 
    Atlas (http://math-atlas.sourceforge.net/) libraries not found.
    Directories to search for the libraries can be specified in the
    numpy/distutils/site.cfg file (section [atlas]) or by setting
    the ATLAS environment variable.
  warnings.warn(AtlasNotFoundError.__doc__)
blas_info:
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.
  warnings.warn('Specified path %s is invalid.' % d)
C compiler: cc

creating /tmp/tmpX0K4bQ/tmp
creating /tmp/tmpX0K4bQ/tmp/tmpX0K4bQ
compile options: '-c'
cc: /tmp/tmpX0K4bQ/source.c
cc /tmp/tmpX0K4bQ/tmp/tmpX0K4bQ/source.o -L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lcblas -o /tmp/tmpX0K4bQ/a.out
/usr/bin/ld: warning: libatlas.so.3, needed by /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/libcblas.so, not found (try using -rpath or -rpath-link)
```

It is missing the `-latlas` for some reason, though it is in the `cblas.pc`

```
$ pkg-config --libs cblas
-L/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib -lcblas -latlas 
```




---

archive/issue_comments_274209.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-06T10:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274209",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_274210.json:
```json
{
    "body": "Can you look at the generated `site.cfg` file?",
    "created_at": "2016-03-06T10:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274210",
    "user": "fbissey"
}
```

Can you look at the generated `site.cfg` file?



---

archive/issue_comments_274211.json:
```json
{
    "body": "I notice poseidon also has a problem but look slightly different.",
    "created_at": "2016-03-06T10:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274211",
    "user": "fbissey"
}
```

I notice poseidon also has a problem but look slightly different.



---

archive/issue_comments_274212.json:
```json
{
    "body": "\n```\n$ cat /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/site.cfg\n[DEFAULT]\nlibrary_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib\ninclude_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/include\n[blas]\ninclude_dirs = \nlibrary_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib\nblas_libs = atlas,f77blas,cblas\n[lapack]\nlibrary_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib\nlapack_libs = lapack,f77blas,cblas,atlas\n```\n",
    "created_at": "2016-03-06T10:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274212",
    "user": "vbraun"
}
```


```
$ cat /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/numpy-1.10.4.p1/src/site.cfg
[DEFAULT]
library_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib
include_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/include
[blas]
include_dirs = 
library_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib
blas_libs = atlas,f77blas,cblas
[lapack]
library_dirs = /mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib
lapack_libs = lapack,f77blas,cblas,atlas
```




---

archive/issue_comments_274213.json:
```json
{
    "body": "OK I think there may be niceties in the linker. Here I get:\n\n```\ncreating /tmp/tmpRM4d1X/tmp\ncreating /tmp/tmpRM4d1X/tmp/tmpRM4d1X\ncompile options: '-c'\ncc: /tmp/tmpRM4d1X/source.c\ncc /tmp/tmpRM4d1X/tmp/tmpRM4d1X/source.o -L/home/fbissey/sandbox/git-fork/sage/local/lib -lcblas -o /tmp/tmpRM4d1X/a.out\n  FOUND:\n    libraries = ['cblas']\n    library_dirs = ['/home/fbissey/sandbox/git-fork/sage/local/lib']\n    language = c\n    define_macros = [('HAVE_CBLAS', None)]\n\n  FOUND:\n    libraries = ['cblas']\n    library_dirs = ['/home/fbissey/sandbox/git-fork/sage/local/lib']\n    define_macros = [('NO_ATLAS_INFO', 1), ('HAVE_CBLAS', None)]\n    language = c\n```\n\nSo we have only `cblas` again. But my linker still resolves it from the information in the `cblas` library.\n\nI think there is a small bug (feature) in `numpy` that causes it to only use a single library. I think I now which part of the Gentoo patch deals with that,",
    "created_at": "2016-03-06T21:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274213",
    "user": "fbissey"
}
```

OK I think there may be niceties in the linker. Here I get:

```
creating /tmp/tmpRM4d1X/tmp
creating /tmp/tmpRM4d1X/tmp/tmpRM4d1X
compile options: '-c'
cc: /tmp/tmpRM4d1X/source.c
cc /tmp/tmpRM4d1X/tmp/tmpRM4d1X/source.o -L/home/fbissey/sandbox/git-fork/sage/local/lib -lcblas -o /tmp/tmpRM4d1X/a.out
  FOUND:
    libraries = ['cblas']
    library_dirs = ['/home/fbissey/sandbox/git-fork/sage/local/lib']
    language = c
    define_macros = [('HAVE_CBLAS', None)]

  FOUND:
    libraries = ['cblas']
    library_dirs = ['/home/fbissey/sandbox/git-fork/sage/local/lib']
    define_macros = [('NO_ATLAS_INFO', 1), ('HAVE_CBLAS', None)]
    language = c
```

So we have only `cblas` again. But my linker still resolves it from the information in the `cblas` library.

I think there is a small bug (feature) in `numpy` that causes it to only use a single library. I think I now which part of the Gentoo patch deals with that,



---

archive/issue_comments_274214.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-06T23:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274214",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274215.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-06T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274215",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274216.json:
```json
{
    "body": "OK I added part of a patch from Gentoo that will let numpy's system_info.py take more that one library. I beautified the `lapack_conf.py` a bit. And revisited `scipy`'s case. It turns out we can dispense with `site.cfg`.",
    "created_at": "2016-03-06T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274216",
    "user": "fbissey"
}
```

OK I added part of a patch from Gentoo that will let numpy's system_info.py take more that one library. I beautified the `lapack_conf.py` a bit. And revisited `scipy`'s case. It turns out we can dispense with `site.cfg`.



---

archive/issue_comments_274217.json:
```json
{
    "body": "poseidon is stumping me. There is not even a compilation line\n\n```\nblas_info:\n/home/kevin/sage-patchbot/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.\n  warnings.warn('Specified path %s is invalid.' % d)\n  libraries atlas,f77blas,cblas not found in []\n  NOT AVAILABLE\n```\n",
    "created_at": "2016-03-07T07:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274217",
    "user": "fbissey"
}
```

poseidon is stumping me. There is not even a compilation line

```
blas_info:
/home/kevin/sage-patchbot/local/var/tmp/sage/build/numpy-1.10.4.p1/src/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.
  warnings.warn('Specified path %s is invalid.' % d)
  libraries atlas,f77blas,cblas not found in []
  NOT AVAILABLE
```




---

archive/issue_comments_274218.json:
```json
{
    "body": "While the absence of compilation output is annoying it may be due to a weakness of `pkgconfig` which can change the order of the libraries. Library order is important if your `ld` has `--as-needed` by default. We could try to pass `--no-as-needed` but it would be better if the order could be fixed from `pkgconfig`.",
    "created_at": "2016-03-07T20:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274218",
    "user": "fbissey"
}
```

While the absence of compilation output is annoying it may be due to a weakness of `pkgconfig` which can change the order of the libraries. Library order is important if your `ld` has `--as-needed` by default. We could try to pass `--no-as-needed` but it would be better if the order could be fixed from `pkgconfig`.



---

archive/issue_comments_274219.json:
```json
{
    "body": "Replying to [comment:18 fbissey]:\n> While the absence of compilation output is annoying it may be due to a weakness of `pkgconfig` which can change the order of the libraries. Library order is important if your `ld` has `--as-needed` by default. We could try to pass `--no-as-needed` but it would be better if the order could be fixed from `pkgconfig`.\n\nThere must something else otherwise building `cvxopt` should fail on the same machine.",
    "created_at": "2016-03-07T23:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274219",
    "user": "fbissey"
}
```

Replying to [comment:18 fbissey]:
> While the absence of compilation output is annoying it may be due to a weakness of `pkgconfig` which can change the order of the libraries. Library order is important if your `ld` has `--as-needed` by default. We could try to pass `--no-as-needed` but it would be better if the order could be fixed from `pkgconfig`.

There must something else otherwise building `cvxopt` should fail on the same machine.



---

archive/issue_comments_274220.json:
```json
{
    "body": "I don't understand, its is a strong point of pkg-config that it gets library order correct regardless of the argument order.\n\nOf course only if the pc files have the appropriate `Requires:` dependency information. E.g. right now our `lapack.pc` does this wrong, though I don't think that is the issue here.",
    "created_at": "2016-03-09T23:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274220",
    "user": "vbraun"
}
```

I don't understand, its is a strong point of pkg-config that it gets library order correct regardless of the argument order.

Of course only if the pc files have the appropriate `Requires:` dependency information. E.g. right now our `lapack.pc` does this wrong, though I don't think that is the issue here.



---

archive/issue_comments_274221.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-09T23:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274221",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274222.json:
```json
{
    "body": "In any case I'm going to run this on the build bot...",
    "created_at": "2016-03-09T23:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274222",
    "user": "vbraun"
}
```

In any case I'm going to run this on the build bot...



---

archive/issue_comments_274223.json:
```json
{
    "body": "I am fairly sure that's not the issue. As for the order I am fairly sure that it is due to the fact that pkgconfig (python interface) uses sets. Because the set is not ordered, order can be be changed. For the `library` field it would have been better to use a list I think.",
    "created_at": "2016-03-09T23:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274223",
    "user": "fbissey"
}
```

I am fairly sure that's not the issue. As for the order I am fairly sure that it is due to the fact that pkgconfig (python interface) uses sets. Because the set is not ordered, order can be be changed. For the `library` field it would have been better to use a list I think.



---

archive/issue_comments_274224.json:
```json
{
    "body": "Possibly, though really the order of all compiler switches potentially matters not just the libraries. So the goal should be to a) always use pc files and then b) directly use the output string from `pkgconfig.libs(...)` instead of `pkgconfig.parse`",
    "created_at": "2016-03-10T08:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274224",
    "user": "vbraun"
}
```

Possibly, though really the order of all compiler switches potentially matters not just the libraries. So the goal should be to a) always use pc files and then b) directly use the output string from `pkgconfig.libs(...)` instead of `pkgconfig.parse`



---

archive/issue_comments_274225.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-10T08:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274225",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_274226.json:
```json
{
    "body": "Fails to build scipy on some platforms:\n* http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20%28Ubuntu%2012.10%29%20incremental/builds/529\n* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2032%20bit%29%20incremental/builds/423\n* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2064%20bit%29%20incremental/builds/395\nPossibly due to this:\n\n```\n/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.\n  warnings.warn('Specified path %s is invalid.' % d)\n  libraries lapack,f77blas,cblas,atlas not found in []\n  NOT AVAILABLE\n```\n",
    "created_at": "2016-03-10T08:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274226",
    "user": "vbraun"
}
```

Fails to build scipy on some platforms:
* http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20%28Ubuntu%2012.10%29%20incremental/builds/529
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2032%20bit%29%20incremental/builds/423
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2064%20bit%29%20incremental/builds/395
Possibly due to this:

```
/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/system_info.py:635: UserWarning: Specified path  is invalid.
  warnings.warn('Specified path %s is invalid.' % d)
  libraries lapack,f77blas,cblas,atlas not found in []
  NOT AVAILABLE
```




---

archive/issue_comments_274227.json:
```json
{
    "body": "OK. I think I see a pattern now. I have to check the `system_info.py` code again. The real breaking point is\n\n```\nlibraries lapack,f77blas,cblas,atlas not found in []\n```\n\nthe rest before is in common with successful build. It has to be a failure in finding at `[]` instead of the given `library_dirs` why it happens some times and not some other will be interesting to untangle.",
    "created_at": "2016-03-10T09:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274227",
    "user": "fbissey"
}
```

OK. I think I see a pattern now. I have to check the `system_info.py` code again. The real breaking point is

```
libraries lapack,f77blas,cblas,atlas not found in []
```

the rest before is in common with successful build. It has to be a failure in finding at `[]` instead of the given `library_dirs` why it happens some times and not some other will be interesting to untangle.



---

archive/issue_comments_274228.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-11T05:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274228",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274229.json:
```json
{
    "body": "Let's see what the bots make of that.",
    "created_at": "2016-03-11T05:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274229",
    "user": "fbissey"
}
```

Let's see what the bots make of that.



---

archive/issue_comments_274230.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-11T05:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274230",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274231.json:
```json
{
    "body": "I tried to get a machine reproducing poseidon's problems and failed. So I am switching to a debug branch in the hope that poseidon will spit out a clue for me. Do not review this branch.\n----\nNew commits:",
    "created_at": "2016-03-13T21:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274231",
    "user": "fbissey"
}
```

I tried to get a machine reproducing poseidon's problems and failed. So I am switching to a debug branch in the hope that poseidon will spit out a clue for me. Do not review this branch.
----
New commits:



---

archive/issue_comments_274232.json:
```json
{
    "body": "Well it spat something useful\n\n```\n[ALL]\nlibrary_dirs = /home/kevin/sage-patchbot/local/lib\ninclude_dirs = /home/kevin/sage-patchbot/local/include\n[blas]\nlibrary_dirs = \nblas_libs    = atlas, f77blas, cblas\n[lapack]\nlibrary_dirs = \nlapack_libs  = lapack, f77blas, cblas, atlas\n```\n\nBack to the atlas spkg for inspection.",
    "created_at": "2016-03-13T22:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274232",
    "user": "fbissey"
}
```

Well it spat something useful

```
[ALL]
library_dirs = /home/kevin/sage-patchbot/local/lib
include_dirs = /home/kevin/sage-patchbot/local/include
[blas]
library_dirs = 
blas_libs    = atlas, f77blas, cblas
[lapack]
library_dirs = 
lapack_libs  = lapack, f77blas, cblas, atlas
```

Back to the atlas spkg for inspection.



---

archive/issue_comments_274233.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-13T22:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274233",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274234.json:
```json
{
    "body": "Still no review please.",
    "created_at": "2016-03-13T22:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274234",
    "user": "fbissey"
}
```

Still no review please.



---

archive/issue_comments_274235.json:
```json
{
    "body": "Random failures should now be solved by #20208.",
    "created_at": "2016-03-14T20:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274235",
    "user": "fbissey"
}
```

Random failures should now be solved by #20208.



---

archive/issue_comments_274236.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-03-22T00:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274236",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_274237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-22T01:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274237",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274238.json:
```json
{
    "body": "Clean up and merge #20208 so it does build on poseidon out of the box. Cross fingers.",
    "created_at": "2016-03-22T01:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274238",
    "user": "fbissey"
}
```

Clean up and merge #20208 so it does build on poseidon out of the box. Cross fingers.



---

archive/issue_comments_274239.json:
```json
{
    "body": "And poseidon still fails because `pkgconf` hasn't been rebuild before `numpy`..... I guess I will have to wait until #20208 is in a beta.",
    "created_at": "2016-03-22T20:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274239",
    "user": "fbissey"
}
```

And poseidon still fails because `pkgconf` hasn't been rebuild before `numpy`..... I guess I will have to wait until #20208 is in a beta.



---

archive/issue_comments_274240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-25T03:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274240",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274241.json:
```json
{
    "body": "Rebased on 7.2.beta0 which includes #20208.",
    "created_at": "2016-03-25T03:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274241",
    "user": "fbissey"
}
```

Rebased on 7.2.beta0 which includes #20208.



---

archive/issue_comments_274242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-28T22:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274242",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274243.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-29T05:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274243",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274244.json:
```json
{
    "body": "Finally building on poseidon. Theory: #20208 fixes the case where there is no global `pkg-config` installed and `sage`'s `pkgconf` is used and in that case having it not strip default library directories when present in the `.pc` file. But poseidon still failed, probably because it has a global `pkg-config` command available and it happens to be `pkgconf`. Because it is provided by the system #20208 doesn't fix it.\n\nThe `lapack.conf` script is much more robust as a result of the latest commit.\n\nPutting back to positive review.",
    "created_at": "2016-03-29T05:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274244",
    "user": "fbissey"
}
```

Finally building on poseidon. Theory: #20208 fixes the case where there is no global `pkg-config` installed and `sage`'s `pkgconf` is used and in that case having it not strip default library directories when present in the `.pc` file. But poseidon still failed, probably because it has a global `pkg-config` command available and it happens to be `pkgconf`. Because it is provided by the system #20208 doesn't fix it.

The `lapack.conf` script is much more robust as a result of the latest commit.

Putting back to positive review.



---

archive/issue_comments_274245.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-30T14:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19920#issuecomment-274245",
    "user": "vbraun"
}
```

Resolution: fixed
