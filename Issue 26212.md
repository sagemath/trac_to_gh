# Issue 26212: Python 3 vs. Sphinx

archive/issues_026212.json:
```json
{
    "body": "CC:  embray jdemeyer\n\nWith #25382 and #26423 (patched so that it actually applies), Sphinx can almost build the Sage documentation. There are two issues: Sphinx itself produces an error:\n\n```\n[dochtml] [reference] Exception occurred:\n[dochtml] [reference]   File \"/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.4.rc0/local/lib/python3.6/site-packages/sphinx/search/__init__.py\", line 174, in loads\n[dochtml] [reference]     if not data or not s.startswith(self.PREFIX) or not \\\n[dochtml] [reference] TypeError: startswith first arg must be bytes or a tuple of bytes, not str\n```\n\nWe can patch Sphinx to fix this, or maybe we are passing bad data to Sphinx.\n\nMore seriously, Sphinx omits large chunks of the autodoc documentation. Perhaps it is related to classes containing subclasses. For example, in `sage.algebras.commutative_dga`, we have\n\n```\n\nclass GCAlgebra(UniqueRepresentation, QuotientRing_nc):\n\n    ...\n\n    class Element(QuotientRingElement):\n\n        ...\n\n```\n\nWith Python 2, methods directly within `GCAlgebra` appear, as do those in `Element`. With Python 3, only the top-level documentation for the `GCAlgebra` class is present: no methods are included at all. Within the same file, the methods for the class `GCAlgebraHomset` all appear, in both Python 2 and Python 3.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26449\n\n",
    "created_at": "2018-10-09T22:12:11Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Python 3 vs. Sphinx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26212",
    "user": "jhpalmieri"
}
```
CC:  embray jdemeyer

With #25382 and #26423 (patched so that it actually applies), Sphinx can almost build the Sage documentation. There are two issues: Sphinx itself produces an error:

```
[dochtml] [reference] Exception occurred:
[dochtml] [reference]   File "/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.4.rc0/local/lib/python3.6/site-packages/sphinx/search/__init__.py", line 174, in loads
[dochtml] [reference]     if not data or not s.startswith(self.PREFIX) or not \
[dochtml] [reference] TypeError: startswith first arg must be bytes or a tuple of bytes, not str
```

We can patch Sphinx to fix this, or maybe we are passing bad data to Sphinx.

More seriously, Sphinx omits large chunks of the autodoc documentation. Perhaps it is related to classes containing subclasses. For example, in `sage.algebras.commutative_dga`, we have

```

class GCAlgebra(UniqueRepresentation, QuotientRing_nc):

    ...

    class Element(QuotientRingElement):

        ...

```

With Python 2, methods directly within `GCAlgebra` appear, as do those in `Element`. With Python 3, only the top-level documentation for the `GCAlgebra` class is present: no methods are included at all. Within the same file, the methods for the class `GCAlgebraHomset` all appear, in both Python 2 and Python 3.

Issue created by migration from https://trac.sagemath.org/ticket/26449





---

archive/issue_comments_369438.json:
```json
{
    "body": "This branch fixes the problem that Sphinx complains about: in Sphinx's file `search/__init__.py`, it seems to assume that data the search index file is a string, not bytes. It looks like ordinary text to me, so let's open it using `'r'` instead of `'rb'`.\n\nThe second problem is distinct. I will move it to another ticket.\n----\nNew commits:",
    "created_at": "2018-10-21T18:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369438",
    "user": "jhpalmieri"
}
```

This branch fixes the problem that Sphinx complains about: in Sphinx's file `search/__init__.py`, it seems to assume that data the search index file is a string, not bytes. It looks like ordinary text to me, so let's open it using `'r'` instead of `'rb'`.

The second problem is distinct. I will move it to another ticket.
----
New commits:



---

archive/issue_comments_369439.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-21T18:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369439",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369440.json:
```json
{
    "body": "See #26522 for the second issue.",
    "created_at": "2018-10-21T18:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369440",
    "user": "jhpalmieri"
}
```

See #26522 for the second issue.



---

archive/issue_comments_369441.json:
```json
{
    "body": "See also #26451 (I don't have time right now to work on that though)",
    "created_at": "2018-10-22T10:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369441",
    "user": "jdemeyer"
}
```

See also #26451 (I don't have time right now to work on that though)



---

archive/issue_comments_369442.json:
```json
{
    "body": "You could also remove the explicit `'r'` but whatever, it doesn't hurt either.",
    "created_at": "2018-10-28T13:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369442",
    "user": "embray"
}
```

You could also remove the explicit `'r'` but whatever, it doesn't hurt either.



---

archive/issue_comments_369443.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-28T13:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369443",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_369444.json:
```json
{
    "body": "Looks like it makes sense otherwise.",
    "created_at": "2018-10-28T13:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369444",
    "user": "embray"
}
```

Looks like it makes sense otherwise.



---

archive/issue_comments_369445.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-29T22:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26212#issuecomment-369445",
    "user": "vbraun"
}
```

Resolution: fixed
