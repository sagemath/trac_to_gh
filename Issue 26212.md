# Issue 26212: Python 3 vs. Sphinx

Issue created by migration from https://trac.sagemath.org/ticket/26449

Original creator: jhpalmieri

Original creation time: 2018-10-09 22:12:11

CC:  embray jdemeyer

With #25382 and #26423 (patched so that it actually applies), Sphinx can almost build the Sage documentation. There are two issues: Sphinx itself produces an error:

```
[dochtml] [reference] Exception occurred:
[dochtml] [reference]   File "/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.4.rc0/local/lib/python3.6/site-packages/sphinx/search/__init__.py", line 174, in loads
[dochtml] [reference]     if not data or not s.startswith(self.PREFIX) or not \
[dochtml] [reference] TypeError: startswith first arg must be bytes or a tuple of bytes, not str
```

We can patch Sphinx to fix this, or maybe we are passing bad data to Sphinx.

More seriously, Sphinx omits large chunks of the autodoc documentation. Perhaps it is related to classes containing subclasses. For example, in `sage.algebras.commutative_dga`, we have

```

class GCAlgebra(UniqueRepresentation, QuotientRing_nc):

    ...

    class Element(QuotientRingElement):

        ...

```

With Python 2, methods directly within `GCAlgebra` appear, as do those in `Element`. With Python 3, only the top-level documentation for the `GCAlgebra` class is present: no methods are included at all. Within the same file, the methods for the class `GCAlgebraHomset` all appear, in both Python 2 and Python 3.


---

Comment by jhpalmieri created at 2018-10-21 18:28:58

This branch fixes the problem that Sphinx complains about: in Sphinx's file `search/__init__.py`, it seems to assume that data the search index file is a string, not bytes. It looks like ordinary text to me, so let's open it using `'r'` instead of `'rb'`.

The second problem is distinct. I will move it to another ticket.
----
New commits:


---

Comment by jhpalmieri created at 2018-10-21 18:28:58

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-10-21 18:30:43

See #26522 for the second issue.


---

Comment by jdemeyer created at 2018-10-22 10:11:23

See also #26451 (I don't have time right now to work on that though)


---

Comment by embray created at 2018-10-28 13:47:51

You could also remove the explicit `'r'` but whatever, it doesn't hurt either.


---

Comment by embray created at 2018-10-28 13:49:34

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-10-28 13:49:34

Looks like it makes sense otherwise.


---

Comment by vbraun created at 2018-10-29 22:46:34

Resolution: fixed
