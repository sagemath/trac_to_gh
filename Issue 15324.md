# Issue 15324: freetype 2.3.5 is too old for some fonts

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2013-12-21 07:49:59

Keywords: r-project graphics interfaces

The now-current freetype library has problems with newer fonts. This forbids its uses in some applications on machines having system fonts not supported by this version.

This was diagnosed on sage's R (see [this thread](https://groups.google.com/forum/#!topic/sage-support/FnTEcpfg6wE)) by Volker Braun.

A stopgap measure would be to upgrade freetype to a more forgiving version of freetype, hence this ticket.


---

Comment by charpent created at 2013-12-21 15:31:54

Changing status from new to needs_review.


---

Comment by charpent created at 2013-12-21 15:31:54

freetype 2.5.2 installs flawlessly IFF libpng12 is patched to avoid a test for setting up error catching via setjmp in libpng12 (which freetype 2.5.2 does anyway).

The resulting sage passes make ptestlong and is able to draw a curve (from sage -R in console). So I think that this ticket is ready for review.

Since it installs a newer version of a standard package and paches another onte, I think that it should be reviewed on various system (at least Mac OS X and/or Cygwin, which seem to be the most difficult cases) before clearing it.


---

Comment by charpent created at 2013-12-22 08:43:09

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2013-12-22 08:43:09

I have two problems with this branch :

1) I seem to be unable to get this code back on an sage tree on another machine :


```
sage -dev checkout --ticket 15561
sage -dev diff
```

gives me an empty diff...

2) I added a new freetype tarball in upstream and deleted the previous one. None of this appears in the branch, at least as displayed on the trac page.

I'll have to beg some help on sage-support...


---

Attachment

source tarball of the new versioj of freetype


---

Comment by charpent created at 2013-12-22 13:18:02

This branch requires the [tarball](http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2) of the new version of freetype, which is also attached to this ticket.


---

Comment by charpent created at 2013-12-22 15:33:08

Okay, I am satisfied that my push **was** successful, and that the ansence of the new upstream tarball was intended. So I'm putting it up for review again.


---

Comment by charpent created at 2013-12-22 15:33:08

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2013-12-22 15:34:33

Okay, I am satisfied that my push **was** successful, and that the ansence of the new upstream tarball was intended. So I'm putting it up for review again.


---

Comment by vbraun created at 2013-12-23 12:16:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-12-23 15:33:37

Breaks PIL, so I'm setting #15539 as dep


---

Comment by vbraun created at 2013-12-23 15:36:18

Build errors:
* http://build.sagemath.org/sage/builders/%20%20fast%20UW%20redhawk%20%28Ubuntu%2010.04%20x86_64%29%20incremental/builds/27/steps/compile/logs/freetype
* http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26/steps/compile/logs/freetype


---

Comment by vbraun created at 2013-12-23 15:36:18

Changing status from positive_review to needs_work.


---

Comment by charpent created at 2013-12-23 18:29:36

Replying to [comment:10 vbraun]:

> Build errors: * http://build.sagemath.org/sage/builders/%20%20fast%20UW%20redhawk%20%28Ubuntu%2010.04%20x86_64%29%20incremental/builds/27/steps/compile/logs/freetype * http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26/steps/compile/logs/freetype

Ahiii ! That's the snag in libpng that triggered me to patch pngconf.h. How can i check that this patch has been applied ? This error (horror ?) originates in a code section that I #defined around...

Edit, Dec 25 : I see *another* build problem with PIL and freetype. but I could diagnose it only by creating a new sage tree and git'ing !#15661 directly : adding #15561 to an already compiled tree does not force recompilation of PIL.

The problem : 


```
[ ... ]

gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/charpent/sagebis/sage/local/include/freetype2 -IlibImaging -I/home/charpent/sagebis/sage/local/include -I/usr/include -I/home/charpent/sagebis/sage/local/include/python2.7 -c _imagingft.c -o build/temp.linux-x86_64-2.7/_imagingft.o
_imagingft.c:68:31: fatal error: freetype/fterrors.h: Aucun fichier ou dossier de ce type
 #include <freetype/fterrors.h>
                               ^
compilation terminated.
error: command 'gcc' failed with exit status 1

[ ... ]
```

This happens twice (PIL attemps compilation with and without Tkinter support). This is caused by the fact that the directory containing freetype headers is no longer local/include/freetype but local/include/freetype2.

Since Pillow is now accepted in the next sage, my plan is :

 * start a new tree
 * fetch the Pillow branch (for rebase ?)
 * fetch !#15561 and adjust it.

Your thoughts ?


---

Comment by charpent created at 2013-12-23 18:34:18

Another question : should I merge #15539 and #15561 (and test with Pillow instead of PIL) ?


---

Comment by vbraun created at 2013-12-23 20:32:16

You should merge in the Pillow ticket, but its not ready yet (i.e. doesn't build).


---

Comment by vbraun created at 2013-12-23 22:54:42

You need to bump the libpng patchlevel to force a rebuild (libpng/package-version.txt). Otherwise it won't be built.


---

Comment by charpent created at 2013-12-25 09:15:11

Replying to [comment:14 vbraun]:

> You need to bump the libpng patchlevel to force a rebuild (libpng/package-version.txt). Otherwise it won't be built.

This I do not understand : #15561 **does** bump libpng (from 1.2.35.p5 to 1.2.25p6) and freetype (from 2.3.5.p4 to 2.5.2.p0) ; #15539 does **not** touch libpng nor freetype (it *uses* them **as is**). Is there another proposed branch that bumps libpng ? If so, how can I find it ?


---

Comment by charpent created at 2013-12-25 09:19:23

Replying to [comment:13 vbraun]:

> You should merge in the Pillow ticket, but its not ready yet (i.e. doesn't build).

Would that be a merge (i. e. creating a branch incorporating changes both from #15539 an #15561) or a rebase (i. e. creating a patch that *assumes* that #15539 has been incorporated) ?

Now that 15539 is closed as "fixed", rebasing sounds logical. What do you advise ?


---

Comment by vbraun created at 2013-12-25 13:00:08

You should always merge (and never rebase) branches that are already published on trac, since somebody else might have used that already as a base for their own branch.

Here is the full buildbot log: http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26

It did compile libpng-1.2.35.p6, so thats your ticket.


---

Comment by charpent created at 2013-12-25 19:54:36

Replying to [comment:17 vbraun]:

> You should always merge (and never rebase) branches that are already published on trac, since somebody else might have used that already as a base for their own branch. 

Okay. Can't say I fully understand it yet, but I did that.

> Here is the full buildbot log: http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26 It did compile libpng-1.2.35.p6, so thats your ticket.

Indeed ! Don't understand it either. I just restarted a clean tree, used git (not sage's scripts) to fetch Pillow and #15561 in separate local branches, merged Pillow in 15561 and compiled (successfully).

In the full buildbot log, the error points at pngconf.h line 328. That's the place where the error takes places while using the *unpatched* pngconf.h ; with the patched pngconf.h, the error should take place on line 334.

Is it possible that buildbot's freetype compilation might pickup an unpatched (possibly system's) pngconf.h ? If so, how to prevent this from happening ?


---

Comment by vbraun created at 2013-12-25 19:59:34

Looking at build/deps, the freetype package does not depend on libpng so will potentially build at the same time. Might be a race condition.


---

Comment by charpent created at 2013-12-25 20:18:21

Replying to [comment:19 vbraun]:

> Looking at build/deps, the freetype package does not depend on libpng so will potentially build at the same time. Might be a race condition.

Ouch ! Freetype depends on libpng, but libpng needs to be patched *first*, which means it can't be patched by freetype's branch, if I understand that correctly. The only way out I see is :

 1. create a new branch patching libpng in a ticket #xx
 1. wait for #xx to get reviewed and getting to state "fixed", and
 1. modify #15561 to depend on #xx.

I don't see how this can be made in one ticket. Do you have different thoughts ?


---

Comment by vbraun created at 2013-12-25 20:20:20

No, you can do everything in your current branch.


---

Comment by charpent created at 2013-12-25 20:26:09

Replying to [comment:21 vbraun]:

> No, you can do everything in your current branch.

I don't see how to. Care to enlighten the dummy of the day ?


---

Comment by vbraun created at 2013-12-25 20:45:04

If that race is actually the problem then you only have to add the dependency to `build/deps`. Then libpng will be built first (and patched as part of its build process), and then freetype will be built afterward. I think I'm missing the problem here, but in any case that should work (TM).


---

Comment by git created at 2013-12-25 21:28:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2013-12-25 21:31:42

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2013-12-25 21:34:24

Replying to [comment:23 vbraun]:

> If that race is actually the problem then you only have to add the dependency to `build/deps` . Then libpng will be built first (and patched as part of its build process), and then freetype will be built afterward. I think I'm missing the problem here, but in any case that should work (TM).

Okay. I did that, pushed the commit and updated status to "needs review". I'm curious about the buildbot's behaviour...

Edit, a bit later : the resulting tree passes the '(make distclean ; make )' test in an enviroment where MAKE is "make -j8". So it *can* be built in a parallel setting.


---

Comment by vbraun created at 2013-12-27 14:07:31

Resolution: fixed
