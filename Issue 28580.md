# Issue 28580: exponent too large to convert to mpfr2 (32-bit)

Issue created by migration from https://trac.sagemath.org/ticket/28817

Original creator: vbraun

Original creation time: 2019-11-28 22:19:35

CC:  wbhart fredrik.johansson charpent

This happens often, but not always when testing on 32-bit:

```
File "src/sage/tensor/differential_form_element.py", line 328, in sage.tensor.differential_form_element.DifferentialForm
Failed example:
    form2.diff().degree()
Expected:
    2
Got:
    exception: exponent too large to convert to mpfr2
**********************************************************************
1 item had failures:
   1 of  28 in sage.tensor.differential_form_element.DifferentialForm
    [287 tests, 1 failure, 0.69 s]
```



---

Comment by vbraun created at 2019-12-26 23:20:54

The "exception: exponent too large to convert to mpfr" is coming from arb. It should have called flint_abort which is just a define for abort and terminated the process, but for some reason it didnt. The final 2 is printed, too.
----
New commits:


---

Comment by vbraun created at 2019-12-27 13:34:24

Backtrace:

```
    /home/buildbot/slave/sage_git/build/local/lib/libarb.so.2(arf_get_mpfr+0x13d)[0xd0b5657d]
    /home/buildbot/slave/sage_git/build/local/lib/libarb.so.2(arb_get_interval_mpfr+0x85)[0xd0bc29d5]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/rings/real_arb.cpython-37m-i386-linux-gnu.so(+0x16d4e)[0xd0ac6d4e]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/rings/complex_arb.cpython-37m-i386-linux-gnu.so(+0x48d29)[0xd0a6ad29]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/rings/complex_arb.cpython-37m-i386-linux-gnu.so(+0x4949f)[0xd0a6b49f]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-i386-linux-gnu.so(+0xd3c5)[0xf5f533c5]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-i386-linux-gnu.so(+0x17b97)[0xf5f5db97]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/structure/parent.cpython-37m-i386-linux-gnu.so(+0x1326e)[0xf646426e]
    /home/buildbot/slave/sage_git/build/local/lib/libpython3.7m.so.1.0(+0xc37b3)[0xf7cca7b3]
    /home/buildbot/slave/sage_git/build/local/lib/libpython3.7m.so.1.0(+0x713a7)[0xf7c783a7]
    /home/buildbot/slave/sage_git/build/local/lib/libarb.so.2(arf_get_mpfr+0x13d)[0xd0b5657d]
    /home/buildbot/slave/sage_git/build/local/lib/libarb.so.2(arb_get_interval_mpfr+0xa7)[0xd0bc29f7]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/rings/real_arb.cpython-37m-i386-linux-gnu.so(+0x16d4e)[0xd0ac6d4e]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/rings/complex_arb.cpython-37m-i386-linux-gnu.so(+0x48d29)[0xd0a6ad29]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/rings/complex_arb.cpython-37m-i386-linux-gnu.so(+0x4949f)[0xd0a6b49f]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-i386-linux-gnu.so(+0xd3c5)[0xf5f533c5]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-i386-linux-gnu.so(+0x17b97)[0xf5f5db97]
    /home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/structure/parent.cpython-37m-i386-linux-gnu.so(+0x1326e)[0xf646426e]
[...]
```



---

Comment by vbraun created at 2019-12-27 16:07:52

The error comes from evaluating

```
exp(cos(x)).subs({x: CIF(-50.3035873016558,- 25.1526638467043)})
```

when testing whether a certain coefficient of the differential form is zero. This value cannot be represented in 32-bit mpfr, we catch the exception and continue testing at a different point. I think this part just works as intended.

The problem is simply that arb writes 'exception: exponent too large to convert to mpfr2' to its stderr, which may or may not be captured in the doctest stderr stream.


---

Comment by git created at 2019-12-27 16:14:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-12-27 17:32:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2019-12-27 17:35:23

Changing status from new to needs_review.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by vbraun created at 2020-01-15 23:59:35

Changing priority from major to blocker.


---

Comment by vbraun created at 2020-01-15 23:59:35

This happens almost always on the buildbot...


---

Comment by embray created at 2020-01-16 14:24:44

Looks to me like the right fix, though it could be a bit surprising that some of these methods accept Python ints only if they're within intmax, even if they _could_ work with arbitrary sized ints.


---

Comment by embray created at 2020-01-16 14:32:26

This pattern from sage.rings.integer might be good to use elsewhere as well:


```
        if is_small_python_int(b):
            tmp = b
            if (tmp & 1) == 0:
                raise ValueError("Jacobi symbol not defined for even b.")
            return mpz_kronecker_si(self.value, tmp)
        if not isinstance(b, Integer):
            b = Integer(b)
```



---

Comment by embray created at 2020-01-16 15:02:10

Yeah, for example `ComplexBall.pow` is giving inconsistent results between `2^65` and `int(2^65)`.  Fix+test incoming...


---

Comment by embray created at 2020-01-16 15:57:19

Can you try this?
----
New commits:


---

Comment by vbraun created at 2020-01-19 00:14:08

Thanks, looks good to me


---

Comment by vbraun created at 2020-01-19 00:14:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-22 20:34:14

I'm getting:

```
sage -t --long --warn-long 36.1 src/sage/rings/real_arb.pyx
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 2876, in sage.rings.real_arb.RealBall.__pow__
Failed example:
    RBF(e)**(-1r)
Expected:
    [0.367879441171442 +/- ...e-16]
Got:
    [1.792143500744e-187 +/- 5.50e-200]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 2888, in sage.rings.real_arb.RealBall.__pow__
Failed example:
    RBF(e)^int(2^65)
Expected:
    [+/- ...e+16022638320587143290]
Got:
    [+/- 2.79e+16022638320587144275]
**********************************************************************
1 item had failures:
   2 of  14 in sage.rings.real_arb.RealBall.__pow__
    [560 tests, 2 failures, 0.23 s]
----------------------------------------------------------------------
sage -t --long --warn-long 36.1 src/sage/rings/real_arb.pyx  # 2 doctests failed
----------------------------------------------------------------------
```

I also got yet another `exception: exponent too large to convert to mpfr2`, so I'll patch out the other occurence in arb as well.


---

Comment by vbraun created at 2020-01-22 20:34:20

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-01-22 20:50:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2020-01-25 17:29:30

Erik, are you going to work on the test failures that your patch introduced? If not I suggest we move it to a different ticket...


---

Comment by git created at 2020-02-02 09:14:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2020-02-02 09:16:56

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2020-02-02 09:16:56

Eric's commit is moved to #29137


---

Comment by dimpase created at 2020-02-23 09:38:36

not reported upstream?


---

Comment by dimpase created at 2020-02-23 15:19:48

reported: https://github.com/fredrik-johansson/arb/issues/302


---

Comment by dimpase created at 2020-02-23 15:23:54

As usual, the question is whether it's really needed to deviate from upstream here.


---

Comment by vbraun created at 2020-02-23 16:20:52

I don't have time to always check each 32-bit buildbot whether it tripped over this issue again, so unless you want to do that job its needed.


---

Comment by dimpase created at 2020-02-23 17:47:49

OK, good. Hopefully the arb patch won't be needed after Fredrik improves API...


---

Comment by dimpase created at 2020-02-23 17:47:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-02-25 19:51:16

Resolution: fixed
