# Issue 10352: ZODB is basically useless in Sage, since it uses pickle protocol 1

archive/issues_010352.json:
```json
{
    "body": "Assignee: jason\n\nCC:  kini\n\n\n```\nwstein@sage:~$ /usr/local/bin/sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: d = sage.databases.db.Database('sage_zodb', read_only=False)\nsage: d[12] = factor(12)\nsage: d.commit()\n...\nTypeError: can't pickle SageObject objects\n```\n\n| Sage Version 4.6, Release Date: 2010-10-30                         |\n| Type notebook() for the GUI, and license() for information.        |\nThere is a zodb mailing list discussion related to the pickle protocol here:  http://www.mail-archive.com/zodb-dev`@`zope.org/msg04628.html\n\nIn particular, pickle protocol 1 is hardcoded.  But SageObjects/Cython objects must use protocol 2 in many cases:\n\n```\nsage: import cPickle\nsage: F = factor(12)\nsage: cPickle.dumps(F, protocol=0)\nTypeError: can't pickle SageObject objects\nsage: cPickle.dumps(F, protocol=1)\nTypeError: can't pickle SageObject objects\nsage: cPickle.dumps(F, protocol=2)\n'\\x80\\x02csage.structure.factorization\\nFactorization\\nq\\x01)\\x81q\\x02}q\\x03(U\\x12_Factorization__crq\\x04\\x89U\\x14_Factorization__unitq\\x05csage.rings.integer\\nmake_integer\\nq\\x06U\\x011\\x85Rq\\x07U\\x18_Factorization__universeq\\x08csage.rings.integer_ring\\nIntegerRing\\nq\\t)Rq\\nU\\x11_Factorization__xq\\x0b]q\\x0c(h\\x06U\\x012\\x85Rq\\rK\\x02\\x86q\\x0eh\\x06U\\x013\\x85Rq\\x0fK\\x01\\x86q\\x10eub.'\n```\n\n\nThere is some code in Sage that uses ZODB (e.g, Cremona database), but I think it uses only pure python objects, so the above isn't a problem. \n\nSee also the related ticket #10352.\n\nSome ideas for how to fix this:\n\n- Modify ZODB itself, e.g., by changing: ZODB.serialiize.ObjectWriter as suggested here: http://www.mail-archive.com/zodb-dev`@`zope.org/msg04766.html\n \n- Figure out how to monkeypatch ODB.serialiize.ObjectWriter at runtime, then document this hack\n\n- \"Fix\" SageObject and/or Cython, so Sage objects can serialize using Pickle protocol 1 instead of requiring 2.  I don't personally understand exactly why SageObject can't be pickled using protocol 1.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10353\n\n",
    "created_at": "2010-11-29T01:25:48Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "title": "ZODB is basically useless in Sage, since it uses pickle protocol 1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10352",
    "user": "was"
}
```
Assignee: jason

CC:  kini


```
wstein@sage:~$ /usr/local/bin/sage
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: d = sage.databases.db.Database('sage_zodb', read_only=False)
sage: d[12] = factor(12)
sage: d.commit()
...
TypeError: can't pickle SageObject objects
```

| Sage Version 4.6, Release Date: 2010-10-30                         |
| Type notebook() for the GUI, and license() for information.        |
There is a zodb mailing list discussion related to the pickle protocol here:  http://www.mail-archive.com/zodb-dev`@`zope.org/msg04628.html

In particular, pickle protocol 1 is hardcoded.  But SageObjects/Cython objects must use protocol 2 in many cases:

```
sage: import cPickle
sage: F = factor(12)
sage: cPickle.dumps(F, protocol=0)
TypeError: can't pickle SageObject objects
sage: cPickle.dumps(F, protocol=1)
TypeError: can't pickle SageObject objects
sage: cPickle.dumps(F, protocol=2)
'\x80\x02csage.structure.factorization\nFactorization\nq\x01)\x81q\x02}q\x03(U\x12_Factorization__crq\x04\x89U\x14_Factorization__unitq\x05csage.rings.integer\nmake_integer\nq\x06U\x011\x85Rq\x07U\x18_Factorization__universeq\x08csage.rings.integer_ring\nIntegerRing\nq\t)Rq\nU\x11_Factorization__xq\x0b]q\x0c(h\x06U\x012\x85Rq\rK\x02\x86q\x0eh\x06U\x013\x85Rq\x0fK\x01\x86q\x10eub.'
```


There is some code in Sage that uses ZODB (e.g, Cremona database), but I think it uses only pure python objects, so the above isn't a problem. 

See also the related ticket #10352.

Some ideas for how to fix this:

- Modify ZODB itself, e.g., by changing: ZODB.serialiize.ObjectWriter as suggested here: http://www.mail-archive.com/zodb-dev`@`zope.org/msg04766.html
 
- Figure out how to monkeypatch ODB.serialiize.ObjectWriter at runtime, then document this hack

- "Fix" SageObject and/or Cython, so Sage objects can serialize using Pickle protocol 1 instead of requiring 2.  I don't personally understand exactly why SageObject can't be pickled using protocol 1.

Issue created by migration from https://trac.sagemath.org/ticket/10353





---

archive/issue_comments_106353.json:
```json
{
    "body": "Please do not feel offended of my naive question, but what do you think of completely removing ZODB? As far as I understand (by looking at the failing doctests when removing ZODB), only Cremona's database and the Conway polynomials database use it. Ticket #11587 migrates the Cremona's DB to SQLite, so would it not be possible to the same with the Polynomial DB? Are there any optional SPKGs which do depend on ZODB?",
    "created_at": "2011-10-03T10:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106353",
    "user": "cschwan"
}
```

Please do not feel offended of my naive question, but what do you think of completely removing ZODB? As far as I understand (by looking at the failing doctests when removing ZODB), only Cremona's database and the Conway polynomials database use it. Ticket #11587 migrates the Cremona's DB to SQLite, so would it not be possible to the same with the Polynomial DB? Are there any optional SPKGs which do depend on ZODB?



---

archive/issue_comments_106354.json:
```json
{
    "body": "I added ZODB to Sage (long ago), and I am definitely +1 to removing it from Sage, if we can figure out how.  I think it is a technology whose value (for Sage!) has come and gone.  One can do better with SQLite these days.",
    "created_at": "2011-10-03T17:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106354",
    "user": "was"
}
```

I added ZODB to Sage (long ago), and I am definitely +1 to removing it from Sage, if we can figure out how.  I think it is a technology whose value (for Sage!) has come and gone.  One can do better with SQLite these days.



---

archive/issue_comments_106355.json:
```json
{
    "body": "OK it is really a pain on sage-on-gentoo side and will become worse in a few months (removal from the main tree, zope maintenance is apparently hard that it will be put in its own repo for people who are interested in it).\n\nSo I am putting my hand up to remove zodb from sage. Anything else apart from conway polynomial database needs to be cleaned and converted to sqlite?",
    "created_at": "2011-10-03T21:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106355",
    "user": "fbissey"
}
```

OK it is really a pain on sage-on-gentoo side and will become worse in a few months (removal from the main tree, zope maintenance is apparently hard that it will be put in its own repo for people who are interested in it).

So I am putting my hand up to remove zodb from sage. Anything else apart from conway polynomial database needs to be cleaned and converted to sqlite?



---

archive/issue_comments_106356.json:
```json
{
    "body": "It looks like stein-watkins-ecdb also use zodb.",
    "created_at": "2012-12-31T00:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106356",
    "user": "fbissey"
}
```

It looks like stein-watkins-ecdb also use zodb.



---

archive/issue_comments_106357.json:
```json
{
    "body": "Hum it looks like sage/databases/stein-watkins-ecdb.py imports sage.databases.db but it is not actually using any of it as far as I can see. So it will be a simple patch to get rid of db.py and compressed_storage.py.",
    "created_at": "2013-01-03T10:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106357",
    "user": "fbissey"
}
```

Hum it looks like sage/databases/stein-watkins-ecdb.py imports sage.databases.db but it is not actually using any of it as far as I can see. So it will be a simple patch to get rid of db.py and compressed_storage.py.



---

archive/issue_comments_106358.json:
```json
{
    "body": "If I'm not wrong, sagenb uses some Python packages which are currently included in zodb spkg (I think zope.interface or stg like that, see #10352).",
    "created_at": "2013-01-04T10:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106358",
    "user": "jpflori"
}
```

If I'm not wrong, sagenb uses some Python packages which are currently included in zodb spkg (I think zope.interface or stg like that, see #10352).



---

archive/issue_comments_106359.json:
```json
{
    "body": "If I remember the discussion correctly the dependency on zope.interface will be included in a future version of sagenb. My quick check on the current version of sagenb show no import from zope.\nIt was suggested that it should be included in the sagenb bundle, I personally agree with the idea. In any case that would mean replacing the current zodb spkg with a new one cotaining only zope.interface if we want to keep it in main line.",
    "created_at": "2013-01-04T10:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106359",
    "user": "fbissey"
}
```

If I remember the discussion correctly the dependency on zope.interface will be included in a future version of sagenb. My quick check on the current version of sagenb show no import from zope.
It was suggested that it should be included in the sagenb bundle, I personally agree with the idea. In any case that would mean replacing the current zodb spkg with a new one cotaining only zope.interface if we want to keep it in main line.



---

archive/issue_comments_106360.json:
```json
{
    "body": "Attachment [trac10353-db-removal.patch](tarball://root/attachments/some-uuid/ticket10353/trac10353-db-removal.patch) by fbissey created at 2013-01-04 10:16:48\n\nthis patch remove reference to zodb from the sage library",
    "created_at": "2013-01-04T10:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106360",
    "user": "fbissey"
}
```

Attachment [trac10353-db-removal.patch](tarball://root/attachments/some-uuid/ticket10353/trac10353-db-removal.patch) by fbissey created at 2013-01-04 10:16:48

this patch remove reference to zodb from the sage library



---

archive/issue_comments_106361.json:
```json
{
    "body": "I just attached a patch to remove zodb references from the sage library. I haven't done the patch for sage-root yet.",
    "created_at": "2013-01-04T10:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106361",
    "user": "fbissey"
}
```

I just attached a patch to remove zodb references from the sage library. I haven't done the patch for sage-root yet.



---

archive/issue_comments_106362.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-05T08:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106362",
    "user": "fbissey"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_106363.json:
```json
{
    "body": "I believe the line in `spkg/standard/deps`\n\n```\n$(INST)/$(SQLALCHEMY): $(INST)/$(ZODB)\n```\n\nshould be removed completely.",
    "created_at": "2013-01-07T09:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106363",
    "user": "jdemeyer"
}
```

I believe the line in `spkg/standard/deps`

```
$(INST)/$(SQLALCHEMY): $(INST)/$(ZODB)
```

should be removed completely.



---

archive/issue_comments_106364.json:
```json
{
    "body": "You are right! I probably produced this a bit too close to midnight. I will up a corrected patch shortly.",
    "created_at": "2013-01-07T10:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106364",
    "user": "fbissey"
}
```

You are right! I probably produced this a bit too close to midnight. I will up a corrected patch shortly.



---

archive/issue_comments_106365.json:
```json
{
    "body": "remeve reference to zodb in sage_root",
    "created_at": "2013-01-07T10:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106365",
    "user": "fbissey"
}
```

remeve reference to zodb in sage_root



---

archive/issue_comments_106366.json:
```json
{
    "body": "Attachment [trac10353-sage_root.patch](tarball://root/attachments/some-uuid/ticket10353/trac10353-sage_root.patch) by fbissey created at 2013-01-07 10:07:52\n\nPatch updated.",
    "created_at": "2013-01-07T10:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106366",
    "user": "fbissey"
}
```

Attachment [trac10353-sage_root.patch](tarball://root/attachments/some-uuid/ticket10353/trac10353-sage_root.patch) by fbissey created at 2013-01-07 10:07:52

Patch updated.



---

archive/issue_comments_106367.json:
```json
{
    "body": "This causes build problems for sagenb:\n\n\n```\nProcessing dependencies for Twisted==12.1.0\nSearching for zope.interface\n\nLink to http://pypi.python.org/simple/zope.interface/ ***BLOCKED*** by --allow-hosts\n\nCouldn't find index page for 'zope.interface' (maybe misspelled?)\nScanning index of all packages (this may take a while)\n\nLink to http://pypi.python.org/simple/ ***BLOCKED*** by --allow-hosts\n\nNo local packages or download links found for zope.interface\nerror: Could not find suitable distribution for Requirement.parse('zope.interface')\nError installing Twisted-12.1.0.tar.bz2 !\n```\n",
    "created_at": "2013-01-15T10:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106367",
    "user": "jdemeyer"
}
```

This causes build problems for sagenb:


```
Processing dependencies for Twisted==12.1.0
Searching for zope.interface

Link to http://pypi.python.org/simple/zope.interface/ ***BLOCKED*** by --allow-hosts

Couldn't find index page for 'zope.interface' (maybe misspelled?)
Scanning index of all packages (this may take a while)

Link to http://pypi.python.org/simple/ ***BLOCKED*** by --allow-hosts

No local packages or download links found for zope.interface
error: Could not find suitable distribution for Requirement.parse('zope.interface')
Error installing Twisted-12.1.0.tar.bz2 !
```




---

archive/issue_comments_106368.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-15T10:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106368",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_106369.json:
```json
{
    "body": "I think this was expected and is https://github.com/sagemath/sagenb/issues/126.\nSo we should open a ticket on Sage's trac and put it as a dependency here I guess.",
    "created_at": "2013-01-15T10:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106369",
    "user": "jpflori"
}
```

I think this was expected and is https://github.com/sagemath/sagenb/issues/126.
So we should open a ticket on Sage's trac and put it as a dependency here I guess.



---

archive/issue_comments_106370.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-15T11:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106370",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_106371.json:
```json
{
    "body": "I think this is already fixed, we just need to make a new sagenb tarball. (The only thing sagenb needs to do is package zope.interface, right?)",
    "created_at": "2013-01-16T08:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106371",
    "user": "kini"
}
```

I think this is already fixed, we just need to make a new sagenb tarball. (The only thing sagenb needs to do is package zope.interface, right?)



---

archive/issue_comments_106372.json:
```json
{
    "body": "Ah, looks like this is already fixed in sagenb 0.10.3 (#13717), and the zope.interface problem was noticed in #12719 a couple months ago because IPython has also stopped using zope.",
    "created_at": "2013-01-16T08:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106372",
    "user": "kini"
}
```

Ah, looks like this is already fixed in sagenb 0.10.3 (#13717), and the zope.interface problem was noticed in #12719 a couple months ago because IPython has also stopped using zope.



---

archive/issue_comments_106373.json:
```json
{
    "body": "And now that I look more closely at this ticket's dependencies, Jeroen seems to have already noticed that... sorry for the noise :)",
    "created_at": "2013-01-16T08:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106373",
    "user": "kini"
}
```

And now that I look more closely at this ticket's dependencies, Jeroen seems to have already noticed that... sorry for the noise :)



---

archive/issue_comments_106374.json:
```json
{
    "body": "I don't feel like reviewing the Sage library patch, but it builds and works fine now.",
    "created_at": "2013-01-19T09:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106374",
    "user": "jdemeyer"
}
```

I don't feel like reviewing the Sage library patch, but it builds and works fine now.



---

archive/issue_comments_106375.json:
```json
{
    "body": "It's just removing files and one line that is useless. Christopher, could you give a review to this?",
    "created_at": "2013-01-19T09:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106375",
    "user": "fbissey"
}
```

It's just removing files and one line that is useless. Christopher, could you give a review to this?



---

archive/issue_comments_106376.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-25T15:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106376",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_106377.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-25T16:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10352#issuecomment-106377",
    "user": "jdemeyer"
}
```

Resolution: fixed
