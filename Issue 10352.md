# Issue 10352: ZODB is basically useless in Sage, since it uses pickle protocol 1

Issue created by migration from https://trac.sagemath.org/ticket/10353

Original creator: was

Original creation time: 2010-11-29 01:25:48

Assignee: jason

CC:  kini


```
wstein@sage:~$ /usr/local/bin/sage
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: d = sage.databases.db.Database('sage_zodb', read_only=False)
sage: d[12] = factor(12)
sage: d.commit()
...
TypeError: can't pickle SageObject objects
```

| Sage Version 4.6, Release Date: 2010-10-30                         |
| Type notebook() for the GUI, and license() for information.        |
There is a zodb mailing list discussion related to the pickle protocol here:  http://www.mail-archive.com/zodb-dev`@`zope.org/msg04628.html

In particular, pickle protocol 1 is hardcoded.  But SageObjects/Cython objects must use protocol 2 in many cases:

```
sage: import cPickle
sage: F = factor(12)
sage: cPickle.dumps(F, protocol=0)
TypeError: can't pickle SageObject objects
sage: cPickle.dumps(F, protocol=1)
TypeError: can't pickle SageObject objects
sage: cPickle.dumps(F, protocol=2)
'\x80\x02csage.structure.factorization\nFactorization\nq\x01)\x81q\x02}q\x03(U\x12_Factorization__crq\x04\x89U\x14_Factorization__unitq\x05csage.rings.integer\nmake_integer\nq\x06U\x011\x85Rq\x07U\x18_Factorization__universeq\x08csage.rings.integer_ring\nIntegerRing\nq\t)Rq\nU\x11_Factorization__xq\x0b]q\x0c(h\x06U\x012\x85Rq\rK\x02\x86q\x0eh\x06U\x013\x85Rq\x0fK\x01\x86q\x10eub.'
```


There is some code in Sage that uses ZODB (e.g, Cremona database), but I think it uses only pure python objects, so the above isn't a problem. 

See also the related ticket #10352.

Some ideas for how to fix this:

  - Modify ZODB itself, e.g., by changing: ZODB.serialiize.ObjectWriter as suggested here: http://www.mail-archive.com/zodb-dev`@`zope.org/msg04766.html
 
  - Figure out how to monkeypatch ODB.serialiize.ObjectWriter at runtime, then document this hack

  - "Fix" SageObject and/or Cython, so Sage objects can serialize using Pickle protocol 1 instead of requiring 2.  I don't personally understand exactly why SageObject can't be pickled using protocol 1.


---

Comment by cschwan created at 2011-10-03 10:26:49

Please do not feel offended of my naive question, but what do you think of completely removing ZODB? As far as I understand (by looking at the failing doctests when removing ZODB), only Cremona's database and the Conway polynomials database use it. Ticket #11587 migrates the Cremona's DB to SQLite, so would it not be possible to the same with the Polynomial DB? Are there any optional SPKGs which do depend on ZODB?


---

Comment by was created at 2011-10-03 17:10:53

I added ZODB to Sage (long ago), and I am definitely +1 to removing it from Sage, if we can figure out how.  I think it is a technology whose value (for Sage!) has come and gone.  One can do better with SQLite these days.


---

Comment by fbissey created at 2011-10-03 21:22:39

OK it is really a pain on sage-on-gentoo side and will become worse in a few months (removal from the main tree, zope maintenance is apparently hard that it will be put in its own repo for people who are interested in it).

So I am putting my hand up to remove zodb from sage. Anything else apart from conway polynomial database needs to be cleaned and converted to sqlite?


---

Comment by fbissey created at 2012-12-31 00:09:09

It looks like stein-watkins-ecdb also use zodb.


---

Comment by fbissey created at 2013-01-03 10:50:53

Hum it looks like sage/databases/stein-watkins-ecdb.py imports sage.databases.db but it is not actually using any of it as far as I can see. So it will be a simple patch to get rid of db.py and compressed_storage.py.


---

Comment by jpflori created at 2013-01-04 10:08:42

If I'm not wrong, sagenb uses some Python packages which are currently included in zodb spkg (I think zope.interface or stg like that, see #10352).


---

Comment by fbissey created at 2013-01-04 10:14:33

If I remember the discussion correctly the dependency on zope.interface will be included in a future version of sagenb. My quick check on the current version of sagenb show no import from zope.
It was suggested that it should be included in the sagenb bundle, I personally agree with the idea. In any case that would mean replacing the current zodb spkg with a new one cotaining only zope.interface if we want to keep it in main line.


---

Attachment

this patch remove reference to zodb from the sage library


---

Comment by fbissey created at 2013-01-04 10:18:29

I just attached a patch to remove zodb references from the sage library. I haven't done the patch for sage-root yet.


---

Comment by fbissey created at 2013-01-05 08:52:24

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-01-07 09:48:20

I believe the line in `spkg/standard/deps`

```
$(INST)/$(SQLALCHEMY): $(INST)/$(ZODB)
```

should be removed completely.


---

Comment by fbissey created at 2013-01-07 10:00:25

You are right! I probably produced this a bit too close to midnight. I will up a corrected patch shortly.


---

Comment by fbissey created at 2013-01-07 10:07:29

remeve reference to zodb in sage_root


---

Attachment

Patch updated.


---

Comment by jdemeyer created at 2013-01-15 10:46:16

This causes build problems for sagenb:


```
Processing dependencies for Twisted==12.1.0
Searching for zope.interface

Link to http://pypi.python.org/simple/zope.interface/ ***BLOCKED*** by --allow-hosts

Couldn't find index page for 'zope.interface' (maybe misspelled?)
Scanning index of all packages (this may take a while)

Link to http://pypi.python.org/simple/ ***BLOCKED*** by --allow-hosts

No local packages or download links found for zope.interface
error: Could not find suitable distribution for Requirement.parse('zope.interface')
Error installing Twisted-12.1.0.tar.bz2 !
```



---

Comment by jdemeyer created at 2013-01-15 10:46:16

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-01-15 10:53:17

I think this was expected and is https://github.com/sagemath/sagenb/issues/126.
So we should open a ticket on Sage's trac and put it as a dependency here I guess.


---

Comment by jdemeyer created at 2013-01-15 11:01:47

Changing status from needs_work to needs_review.


---

Comment by kini created at 2013-01-16 08:47:34

I think this is already fixed, we just need to make a new sagenb tarball. (The only thing sagenb needs to do is package zope.interface, right?)


---

Comment by kini created at 2013-01-16 08:49:57

Ah, looks like this is already fixed in sagenb 0.10.3 (#13717), and the zope.interface problem was noticed in #12719 a couple months ago because IPython has also stopped using zope.


---

Comment by kini created at 2013-01-16 08:51:10

And now that I look more closely at this ticket's dependencies, Jeroen seems to have already noticed that... sorry for the noise :)


---

Comment by jdemeyer created at 2013-01-19 09:53:12

I don't feel like reviewing the Sage library patch, but it builds and works fine now.


---

Comment by fbissey created at 2013-01-19 09:56:47

It's just removing files and one line that is useless. Christopher, could you give a review to this?


---

Comment by jdemeyer created at 2013-01-25 15:34:49

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-25 16:16:32

Resolution: fixed
