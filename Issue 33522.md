# Issue 33522: storage of graph embeddings buggy

Issue created by migration from https://trac.sagemath.org/ticket/33759

Original creator: vdelecroix

Original creation time: 2022-04-25 20:43:14

CC:  dcoudert


```
sage: G = Graph([(1,4), (2, 3)])
sage: G.is_planar(set_embedding=True, set_pos=True)
sage: G.delete_vertices([3])
sage: G.is_planar()
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
Input In [27], in <cell line: 4>()
      2 G.is_planar(set_embedding=True)
      3 G.delete_vertices([Integer(3)])
----> 4 G.is_planar()

File /usr/lib/python3.10/site-packages/sage/graphs/generic_graph.py:4995, in GenericGraph.is_planar(self, on_embedding, kuratowski, set_embedding, set_pos)
   4993 if hasattr(G, '_immutable'):
   4994     G = copy(G)
-> 4995 planar = is_planar(G,kuratowski=kuratowski, set_pos=set_pos, set_embedding=set_embedding)
   4996 if kuratowski:
   4997     bool_result = planar[0]

File /usr/lib/python3.10/site-packages/sage/graphs/planarity.pyx:114, in sage.graphs.planarity.is_planar (build/cythonized/sage/graphs/planarity.c:2071)()
    112 cdef dict ffrom = {vvv: i + 1 for i, vvv in enumerate(listto)}
    113 cdef dict to = {i + 1: vvv for i, vvv in enumerate(listto)}
--> 114 g.relabel(ffrom)
    115 
    116 cdef graphP theGraph

File /usr/lib/python3.10/site-packages/sage/graphs/generic_graph.py:21878, in GenericGraph.relabel(self, perm, inplace, return_map, check_input, complete_partial_function, immutable)
  21876                 new_attr[perm[v]] = value
  21877             else:
> 21878                 new_attr[perm[v]] = [perm[w] for w in value]
  21880         setattr(self, attr, new_attr)
  21882 if return_map:

File /usr/lib/python3.10/site-packages/sage/graphs/generic_graph.py:21878, in <listcomp>(.0)
  21876                 new_attr[perm[v]] = value
  21877             else:
> 21878                 new_attr[perm[v]] = [perm[w] for w in value]
  21880         setattr(self, attr, new_attr)
  21882 if return_map:

KeyError: 3
```



---

Comment by vdelecroix created at 2022-04-25 20:57:01

New commits:


---

Comment by vdelecroix created at 2022-04-25 20:57:01

Changing status from new to needs_review.


---

Comment by dcoudert created at 2022-04-26 09:32:38

Several doctests errors due to 

```diff
-                for vertex in vertices:
-                    attr_dict.pop(vertex, None)
+                for v in vertices:
+                    del attr_dict[v]
```



---

Comment by git created at 2022-04-26 18:36:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-27 10:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-04-28 10:43:19

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2022-04-28 10:43:19

I have several errors

```
sage -t --warn-long 293.2 --random-seed=30092742952270998397219008776926923749 src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 5239, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    g439.is_circular_planar(kuratowski=True, boundary=[1, 2, 3])
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[4]>", line 1, in <module>
        g439.is_circular_planar(kuratowski=True, boundary=[Integer(1), Integer(2), Integer(3)])
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 5328, in is_circular_planar
        graph._embedding[w].pop(graph._embedding[w].index(extra))
    ValueError: 0 is not in list
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 5241, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    g439.get_embedding()
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[5]>", line 1, in <module>
        g439.get_embedding()
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 2684, in get_embedding
        raise ValueError('%s has been modified and the embedding is no longer valid'%self)
    ValueError: Graph on 7 vertices has been modified and the embedding is no longer valid
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 5253, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    K23.is_circular_planar(boundary=[0, 1, 2, 3])
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[7]>", line 1, in <module>
        K23.is_circular_planar(boundary=[Integer(0), Integer(1), Integer(2), Integer(3)])
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 5328, in is_circular_planar
        graph._embedding[w].pop(graph._embedding[w].index(extra))
    ValueError: 5 is not in list
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 5260, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    K23.is_circular_planar(set_embedding=True, boundary=[0, 2, 1, 3])
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[9]>", line 1, in <module>
        K23.is_circular_planar(set_embedding=True, boundary=[Integer(0), Integer(2), Integer(1), Integer(3)])
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 5328, in is_circular_planar
        graph._embedding[w].pop(graph._embedding[w].index(extra))
    ValueError: 5 is not in list
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 5269, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    Graph(1).is_circular_planar()
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[11]>", line 1, in <module>
        Graph(Integer(1)).is_circular_planar()
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 5328, in is_circular_planar
        graph._embedding[w].pop(graph._embedding[w].index(extra))
    ValueError: 1 is not in list
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 5740, in sage.graphs.generic_graph.GenericGraph.genus
Failed example:
    cube.is_circular_planar()
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.genus[12]>", line 1, in <module>
        cube.is_circular_planar()
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 5328, in is_circular_planar
        graph._embedding[w].pop(graph._embedding[w].index(extra))
    ValueError: 0 is not in list
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 10268, in sage.graphs.generic_graph.GenericGraph.delete_vertex
Failed example:
    G.delete_vertex([3])
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.delete_vertex[17]>", line 1, in <module>
        G.delete_vertex([Integer(3)])
      File "/Users/dcoudert/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py", line 10276, in delete_vertex
        raise ValueError("vertex (%s) not in the graph"%str(vertex))
    ValueError: vertex ([3]) not in the graph
```


- in the doctest of `delete_vertex`, change `[3]` -> `3`
- instead of `neighbors.difference_update([vertex])`, you can do `neighbors.discard(vertex)`


---

Comment by vdelecroix created at 2022-04-28 13:01:20

Will fix that.

What about also fixing `_embedding` when calling `delete_edge`, `delete_edges`, `contract_edge`, `contract_edges` in this ticket?


---

Comment by git created at 2022-04-28 15:30:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2022-04-28 15:30:20

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2022-04-29 09:16:25

Can you list the changes you have done and the introduced deprecation in the ticket description.

I agree that we can also fix `contract_edge` and `contract_edges` in this ticket.


---

Comment by dcoudert created at 2022-04-29 09:16:54

The good news is that all tests pass with the last commit ;)


---

Comment by vdelecroix created at 2022-04-29 09:59:57

Simply some cleaning in `sage.graphs.planarity.is_planar`: the argument `circular` was ignored unless `set_pos=True`. The corresponding operation (ie setting positions) is more logically done in `Graph.is_circular_planar`.


---

Comment by vdelecroix created at 2022-04-29 10:03:31

Maybe it is enough for a first step. I opened #33769 for dealing with edge deletion/contraction.


---

Comment by dcoudert created at 2022-04-29 11:12:31

I have updated the ticket description.


---

Comment by dcoudert created at 2022-04-29 11:12:31

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-07 18:35:50

Changing priority from major to blocker.


---

Comment by vbraun created at 2022-05-12 21:42:32

Resolution: fixed
