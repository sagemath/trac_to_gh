# Issue 26266: Numerical glitch causes error in computation of fundamental group of curves

archive/issues_026266.json:
```json
{
    "body": "CC:  tscrim slelievre tmonteil\n\nIn Sage 8.3 we get the following (wrong) answer:\n\n\n\n```\nsage: var('t')\nsage: wp = QQ[t](t^2+t+1).roots(QQbar)[0][0]\nsage: Kw.<wp>=NumberField(wp.minpoly(), embedding=wp)\nsage: R.<x,y> = Kw[]\nsage: z = 1\nsage: f = y * (y + (-wp - 1)) * x * (x - 1) * (x - y) * (x + (-wp - 1)*y - 1) * (x + (-wp - 1)*y + (wp))\nsage: from sage.schemes.curves import zariski_vankampen as zvk\nsage: zvk.fundamental_group(f)\nFinitely presented group < x0, x1, x2, x3, x5 | x2*x1*x2^-1*x1^-1, x1*x0*x1^-1*x0^-1, x5*x2*x5^-1*x2^-1, x0^-1*x3*x0*x3^-1, x0^-1*x2*x0*x2^-1, x1*x3*x1^-1*x3^-1, x5^-1*x0*x5*x0^-1, x3^-1*x5*x3*x5^-1, x1*x5*x1^-1*x5^-1 >\n```\n\n\nIt must be wrong because the abelianized must have rank 7, so it must have at least 7 generators.\n\nNote that Sage 8.1 used to give right answers.\n\nAnyways, I think I did find the problem. When computing the braids corresponding to each segment, the endpoints are represented by floating point numbers, which may cause some errors. Using algebraic numbers for this seems to solve the issue.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26503\n\n",
    "created_at": "2018-10-18T12:43:17Z",
    "labels": [
        "algebraic geometry",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Numerical glitch causes error in computation of fundamental group of curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26266",
    "user": "mmarco"
}
```
CC:  tscrim slelievre tmonteil

In Sage 8.3 we get the following (wrong) answer:



```
sage: var('t')
sage: wp = QQ[t](t^2+t+1).roots(QQbar)[0][0]
sage: Kw.<wp>=NumberField(wp.minpoly(), embedding=wp)
sage: R.<x,y> = Kw[]
sage: z = 1
sage: f = y * (y + (-wp - 1)) * x * (x - 1) * (x - y) * (x + (-wp - 1)*y - 1) * (x + (-wp - 1)*y + (wp))
sage: from sage.schemes.curves import zariski_vankampen as zvk
sage: zvk.fundamental_group(f)
Finitely presented group < x0, x1, x2, x3, x5 | x2*x1*x2^-1*x1^-1, x1*x0*x1^-1*x0^-1, x5*x2*x5^-1*x2^-1, x0^-1*x3*x0*x3^-1, x0^-1*x2*x0*x2^-1, x1*x3*x1^-1*x3^-1, x5^-1*x0*x5*x0^-1, x3^-1*x5*x3*x5^-1, x1*x5*x1^-1*x5^-1 >
```


It must be wrong because the abelianized must have rank 7, so it must have at least 7 generators.

Note that Sage 8.1 used to give right answers.

Anyways, I think I did find the problem. When computing the braids corresponding to each segment, the endpoints are represented by floating point numbers, which may cause some errors. Using algebraic numbers for this seems to solve the issue.

Issue created by migration from https://trac.sagemath.org/ticket/26503





---

archive/issue_comments_370125.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-18T13:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370125",
    "user": "mmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370126.json:
```json
{
    "body": "Trying to see if Miguel Marco's branch is still there.\n----\nNew commits:",
    "created_at": "2018-10-18T16:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370126",
    "user": "slelievre"
}
```

Trying to see if Miguel Marco's branch is still there.
----
New commits:



---

archive/issue_comments_370127.json:
```json
{
    "body": "So this change will likely slow things down, but it will make things more numerically stable (as evidenced by this example).\n\nOne thing that should be changed:\n\n```diff\n-    TESTS::\n+    TESTS:\n \n-        # Check that # 26503 is fixed\n+    Check that :trac:`26503` is fixed::\n```\n",
    "created_at": "2018-10-18T17:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370127",
    "user": "tscrim"
}
```

So this change will likely slow things down, but it will make things more numerically stable (as evidenced by this example).

One thing that should be changed:

```diff
-    TESTS::
+    TESTS:
 
-        # Check that # 26503 is fixed
+    Check that :trac:`26503` is fixed::
```




---

archive/issue_comments_370128.json:
```json
{
    "body": "Pushing the suggestion by Travis Scrimshaw a bit further, I would change\n\n```\n    TESTS::\n\n        # Check that # 26503 is fixed\n        sage: var('t')\n        sage: wp = QQ[t](t^2+t+1).roots(QQbar)[0][0]\n        sage: Kw.<wp>=NumberField(wp.minpoly(), embedding=wp)\n        sage: R.<x,y> = Kw[]\n        sage: z = 1\n        sage: f = y * (y + (-wp - 1)) * x * (x - 1) * (x - y) * (x + (-wp - 1)*y - 1) * (x + (-wp - 1)*y + (wp))\n        sage: from sage.schemes.curves import zariski_vankampen as zvk\n        sage: g = f.subs({x:x+y})\n        sage: g = g.subs({x:x+y})\n        sage: disc = zvk.discrim(g)\n        sage: segs = zvk.segments(disc)\n        sage: segs[16]\n        (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)\n        sage: zvk.braid_in_segment(g, *segs[16])  # optional - sirocco\n        s0*s1*s3*s5*s1^-1*s0^-1*s3^-1\n```\n\nto the following, if you agree it means the same (please double check):\n\n```\n    TESTS:\n\n    Check that :trac:`26503` is fixed::\n        \n        sage: wp = QQ['t']([1, 1, 1]).roots(QQbar)[0][0]\n        sage: Kw.<wp> = NumberField(wp.minpoly(), embedding=wp)\n        sage: R.<x, y> = Kw[]\n        sage: z = -wp - 1\n        sage: f = y*(y + z)*x*(x - 1)*(x - y)*(x + z*y - 1)*(x + z*y + wp)\n        sage: from sage.schemes.curves import zariski_vankampen as zvk\n        sage: g = f.subs({x: x + 2*y})\n        sage: disc = zvk.discrim(g)\n        sage: segs = zvk.segments(disc)\n        sage: segs[16]\n        (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)\n        sage: zvk.braid_in_segment(g, *segs[16])  # optional - sirocco\n        s0*s1*s3*s5*s1^-1*s0^-1*s3^-1\n```\n\nThis combines some pep8 fixes, getting rid of a symbolic variable,\nusing `z` to clarify `f`, and combining two `.subs` into a single one.",
    "created_at": "2018-10-18T17:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370128",
    "user": "slelievre"
}
```

Pushing the suggestion by Travis Scrimshaw a bit further, I would change

```
    TESTS::

        # Check that # 26503 is fixed
        sage: var('t')
        sage: wp = QQ[t](t^2+t+1).roots(QQbar)[0][0]
        sage: Kw.<wp>=NumberField(wp.minpoly(), embedding=wp)
        sage: R.<x,y> = Kw[]
        sage: z = 1
        sage: f = y * (y + (-wp - 1)) * x * (x - 1) * (x - y) * (x + (-wp - 1)*y - 1) * (x + (-wp - 1)*y + (wp))
        sage: from sage.schemes.curves import zariski_vankampen as zvk
        sage: g = f.subs({x:x+y})
        sage: g = g.subs({x:x+y})
        sage: disc = zvk.discrim(g)
        sage: segs = zvk.segments(disc)
        sage: segs[16]
        (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)
        sage: zvk.braid_in_segment(g, *segs[16])  # optional - sirocco
        s0*s1*s3*s5*s1^-1*s0^-1*s3^-1
```

to the following, if you agree it means the same (please double check):

```
    TESTS:

    Check that :trac:`26503` is fixed::
        
        sage: wp = QQ['t']([1, 1, 1]).roots(QQbar)[0][0]
        sage: Kw.<wp> = NumberField(wp.minpoly(), embedding=wp)
        sage: R.<x, y> = Kw[]
        sage: z = -wp - 1
        sage: f = y*(y + z)*x*(x - 1)*(x - y)*(x + z*y - 1)*(x + z*y + wp)
        sage: from sage.schemes.curves import zariski_vankampen as zvk
        sage: g = f.subs({x: x + 2*y})
        sage: disc = zvk.discrim(g)
        sage: segs = zvk.segments(disc)
        sage: segs[16]
        (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)
        sage: zvk.braid_in_segment(g, *segs[16])  # optional - sirocco
        s0*s1*s3*s5*s1^-1*s0^-1*s3^-1
```

This combines some pep8 fixes, getting rid of a symbolic variable,
using `z` to clarify `f`, and combining two `.subs` into a single one.



---

archive/issue_comments_370129.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> So this change will likely slow things down, but it will make things more numerically stable (as evidenced by this example).\n> \n\nYes, but on the other hand, the other minor change I made that computes radical of the polynomial before computing the discriminant would make things faster, so overall the change could actually be faster. \n\nSamuel: I think your change is better. I will push a commit with it tomorrow.",
    "created_at": "2018-10-18T20:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370129",
    "user": "mmarco"
}
```

Replying to [comment:5 tscrim]:
> So this change will likely slow things down, but it will make things more numerically stable (as evidenced by this example).
> 

Yes, but on the other hand, the other minor change I made that computes radical of the polynomial before computing the discriminant would make things faster, so overall the change could actually be faster. 

Samuel: I think your change is better. I will push a commit with it tomorrow.



---

archive/issue_comments_370130.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-19T09:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370130",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370131.json:
```json
{
    "body": "A blank line is needed between `::` and the code block.\n\nAlso, please consider simplifying\n\n```\n        sage: g = f.subs({x:x+y})\n        sage: g = g.subs({x:x+y})\n```\n\ninto\n\n```\n        sage: g = f.subs({x: x + 2*y})\n```\n",
    "created_at": "2018-10-19T09:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370131",
    "user": "slelievre"
}
```

A blank line is needed between `::` and the code block.

Also, please consider simplifying

```
        sage: g = f.subs({x:x+y})
        sage: g = g.subs({x:x+y})
```

into

```
        sage: g = f.subs({x: x + 2*y})
```




---

archive/issue_comments_370132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-19T10:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370132",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370133.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-30T20:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370133",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370134.json:
```json
{
    "body": "I have made some trivial changes, and I allow myself to  turn this to positive.\n----\nNew commits:",
    "created_at": "2018-11-30T20:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370134",
    "user": "chapoton"
}
```

I have made some trivial changes, and I allow myself to  turn this to positive.
----
New commits:



---

archive/issue_comments_370135.json:
```json
{
    "body": "On 32-bit:\n\n```\nDoctesting 3781 files using 2 threads.\n**********************************************************************\nFile \"src/sage/schemes/curves/zariski_vankampen.py\", line 333, in sage.schemes.curves.zariski_vankampen.braid_in_segment\nFailed example:\n    segs[16]\nExpected:\n    (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)\nGot:\n    (3.82181265801140e-17 + 0.577350269189626*I,\n     -0.500000000000000 + 0.288675134594813*I)\n**********************************************************************\n1 item had failures:\n   1 of  15 in sage.schemes.curves.zariski_vankampen.braid_in_segment\n    [35 tests, 1 failure, 0.91 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/schemes/curves/zariski_vankampen.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2018-12-01T13:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370135",
    "user": "vbraun"
}
```

On 32-bit:

```
Doctesting 3781 files using 2 threads.
**********************************************************************
File "src/sage/schemes/curves/zariski_vankampen.py", line 333, in sage.schemes.curves.zariski_vankampen.braid_in_segment
Failed example:
    segs[16]
Expected:
    (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)
Got:
    (3.82181265801140e-17 + 0.577350269189626*I,
     -0.500000000000000 + 0.288675134594813*I)
**********************************************************************
1 item had failures:
   1 of  15 in sage.schemes.curves.zariski_vankampen.braid_in_segment
    [35 tests, 1 failure, 0.91 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/curves/zariski_vankampen.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_370136.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-12-01T13:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370136",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_370137.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-10T19:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370137",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370138.json:
```json
{
    "body": "Added `# abs tol 1e-16`.",
    "created_at": "2019-01-10T19:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370138",
    "user": "slelievre"
}
```

Added `# abs tol 1e-16`.



---

archive/issue_comments_370139.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-10T19:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370139",
    "user": "slelievre"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_370140.json:
```json
{
    "body": "ok",
    "created_at": "2019-01-10T20:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370140",
    "user": "chapoton"
}
```

ok



---

archive/issue_comments_370141.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-10T20:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370141",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370142.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-20T00:09:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370142",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_370143.json:
```json
{
    "body": "On 32-bit: \n\n```\nFile \"src/sage/schemes/curves/zariski_vankampen.py\", line 333, in sage.schemes.curves.zariski_vankampen.braid_in_segment\nFailed example:\n    segs[16]  # abs tol 1e-16\nExpected:\n    (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)\nGot:\n    (3.82181265801140e-17 + 0.577350269189626*I,\n     -0.500000000000000 + 0.288675134594813*I)\n**********************************************************************\n1 item had failures:\n   1 of  15 in sage.schemes.curves.zariski_vankampen.braid_in_segment\n    [35 tests, 1 failure, 0.79 s]\n```\n",
    "created_at": "2019-01-20T00:09:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370143",
    "user": "vbraun"
}
```

On 32-bit: 

```
File "src/sage/schemes/curves/zariski_vankampen.py", line 333, in sage.schemes.curves.zariski_vankampen.braid_in_segment
Failed example:
    segs[16]  # abs tol 1e-16
Expected:
    (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)
Got:
    (3.82181265801140e-17 + 0.577350269189626*I,
     -0.500000000000000 + 0.288675134594813*I)
**********************************************************************
1 item had failures:
   1 of  15 in sage.schemes.curves.zariski_vankampen.braid_in_segment
    [35 tests, 1 failure, 0.79 s]
```




---

archive/issue_comments_370144.json:
```json
{
    "body": "There is a sign problem, not only a matter of tolerance..",
    "created_at": "2019-01-20T08:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370144",
    "user": "chapoton"
}
```

There is a sign problem, not only a matter of tolerance..



---

archive/issue_comments_370145.json:
```json
{
    "body": "Seems the order of the elements in `disc` can vary.\n\nMaybe exactifying the elements of disc and sorting them would fix that:\n\n```\n        sage: wp = QQ['t']([1, 1, 1]).roots(QQbar)[0][0]\n        sage: Kw.<wp> = NumberField(wp.minpoly(), embedding=wp)\n        sage: R.<x, y> = Kw[]\n        sage: z = -wp - 1\n        sage: f = y*(y + z)*x*(x - 1)*(x - y)*(x + z*y - 1)*(x + z*y + wp)\n        sage: from sage.schemes.curves import zariski_vankampen as zvk\n        sage: g = f.subs({x: x + 2*y})\n        sage: disc = zvk.discrim(g)\n        sage: for a in disc: a.exactify()\n        sage: disc = sorted(disc)\n        sage: segs = zvk.segments(disc)\n        sage: segs[16]  # abs tol 1e-16\n        (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)\n```\n",
    "created_at": "2019-01-20T11:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370145",
    "user": "slelievre"
}
```

Seems the order of the elements in `disc` can vary.

Maybe exactifying the elements of disc and sorting them would fix that:

```
        sage: wp = QQ['t']([1, 1, 1]).roots(QQbar)[0][0]
        sage: Kw.<wp> = NumberField(wp.minpoly(), embedding=wp)
        sage: R.<x, y> = Kw[]
        sage: z = -wp - 1
        sage: f = y*(y + z)*x*(x - 1)*(x - y)*(x + z*y - 1)*(x + z*y + wp)
        sage: from sage.schemes.curves import zariski_vankampen as zvk
        sage: g = f.subs({x: x + 2*y})
        sage: disc = zvk.discrim(g)
        sage: for a in disc: a.exactify()
        sage: disc = sorted(disc)
        sage: segs = zvk.segments(disc)
        sage: segs[16]  # abs tol 1e-16
        (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)
```




---

archive/issue_comments_370146.json:
```json
{
    "body": "Replying to [comment:18 slelievre]:\n> Seems the order of the elements in `disc` can vary.\n> \n> Maybe exactifying the elements of disc and sorting them would fix that:\n> {{{\n>         sage: wp = QQ['t']([1, 1, 1]).roots(QQbar)[0][0]\n>         sage: Kw.<wp> = NumberField(wp.minpoly(), embedding=wp)\n>         sage: R.<x, y> = Kw[]\n>         sage: z = -wp - 1\n>         sage: f = y*(y + z)*x*(x - 1)*(x - y)*(x + z*y - 1)*(x + z*y + wp)\n>         sage: from sage.schemes.curves import zariski_vankampen as zvk\n>         sage: g = f.subs({x: x + 2*y})\n>         sage: disc = zvk.discrim(g)\n>         sage: for a in disc: a.exactify()\n>         sage: disc = sorted(disc)\n>         sage: segs = zvk.segments(disc)\n>         sage: segs[16]  # abs tol 1e-16\n>         (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)\n> }}}\n\nYes, that is what I think too. The failing doctest relies on the order of the roots of the discriminant being fixed, which apparently might not be depending on the architecture (as the failing doctest shows). Samuel's proposal makes more sense.",
    "created_at": "2019-01-20T11:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370146",
    "user": "mmarco"
}
```

Replying to [comment:18 slelievre]:
> Seems the order of the elements in `disc` can vary.
> 
> Maybe exactifying the elements of disc and sorting them would fix that:
> {{{
>         sage: wp = QQ['t']([1, 1, 1]).roots(QQbar)[0][0]
>         sage: Kw.<wp> = NumberField(wp.minpoly(), embedding=wp)
>         sage: R.<x, y> = Kw[]
>         sage: z = -wp - 1
>         sage: f = y*(y + z)*x*(x - 1)*(x - y)*(x + z*y - 1)*(x + z*y + wp)
>         sage: from sage.schemes.curves import zariski_vankampen as zvk
>         sage: g = f.subs({x: x + 2*y})
>         sage: disc = zvk.discrim(g)
>         sage: for a in disc: a.exactify()
>         sage: disc = sorted(disc)
>         sage: segs = zvk.segments(disc)
>         sage: segs[16]  # abs tol 1e-16
>         (0.577350269189626*I, 0.500000000000000 + 0.288675134594813*I)
> }}}

Yes, that is what I think too. The failing doctest relies on the order of the roots of the discriminant being fixed, which apparently might not be depending on the architecture (as the failing doctest shows). Samuel's proposal makes more sense.



---

archive/issue_comments_370147.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-20T15:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370147",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370148.json:
```json
{
    "body": "Pushed a commit to add this exactifying and sorting. Can someone test on 32-bit?",
    "created_at": "2019-01-20T15:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370148",
    "user": "slelievre"
}
```

Pushed a commit to add this exactifying and sorting. Can someone test on 32-bit?



---

archive/issue_comments_370149.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-20T15:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370149",
    "user": "slelievre"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_370150.json:
```json
{
    "body": "Changing keywords from \"\" to \"braids, numerical, QQbar, 32bit\".",
    "created_at": "2019-01-20T23:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370150",
    "user": "slelievre"
}
```

Changing keywords from "" to "braids, numerical, QQbar, 32bit".



---

archive/issue_comments_370151.json:
```json
{
    "body": "Patchbot seems to have trouble with it, plus one of them is getting an error with `sirocco`:\n\n```\nFile \"src/sage/schemes/curves/zariski_vankampen.py\", line 337, in sage.schemes.curves.zariski_vankampen.braid_in_segment\nFailed example:\n    zvk.braid_in_segment(g, *segs[16])  # optional - sirocco\nExpected:\n    s0*s1*s3*s5*s1^-1*s0^-1*s3^-1\nGot:\n    s5^-1*s3*s0*s1*s0*s3^-1*s4^-1*s3^-1*s2^-1\n```\n",
    "created_at": "2019-01-21T00:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370151",
    "user": "tscrim"
}
```

Patchbot seems to have trouble with it, plus one of them is getting an error with `sirocco`:

```
File "src/sage/schemes/curves/zariski_vankampen.py", line 337, in sage.schemes.curves.zariski_vankampen.braid_in_segment
Failed example:
    zvk.braid_in_segment(g, *segs[16])  # optional - sirocco
Expected:
    s0*s1*s3*s5*s1^-1*s0^-1*s3^-1
Got:
    s5^-1*s3*s0*s1*s0*s3^-1*s4^-1*s3^-1*s2^-1
```




---

archive/issue_comments_370152.json:
```json
{
    "body": "Let me run a 32-bit patchbot on it.",
    "created_at": "2019-01-21T13:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370152",
    "user": "tmonteil"
}
```

Let me run a 32-bit patchbot on it.



---

archive/issue_comments_370153.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-24T08:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370153",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_370154.json:
```json
{
    "body": "My 32-bit patchbot is unhappy :(",
    "created_at": "2019-01-24T08:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370154",
    "user": "tmonteil"
}
```

My 32-bit patchbot is unhappy :(



---

archive/issue_comments_370155.json:
```json
{
    "body": "Order seems to depend on the platform, so we can't rely on `segs[16]` and we need a better doctest.",
    "created_at": "2019-01-24T09:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370155",
    "user": "slelievre"
}
```

Order seems to depend on the platform, so we can't rely on `segs[16]` and we need a better doctest.



---

archive/issue_comments_370156.json:
```json
{
    "body": "Can you check if the discrepancy on the order appears on `disc` or `segs` ?\n\nAnyways, maybe the right thing to do about this doctest is to be explicit and give the specific segment to test?",
    "created_at": "2019-02-20T18:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370156",
    "user": "mmarco"
}
```

Can you check if the discrepancy on the order appears on `disc` or `segs` ?

Anyways, maybe the right thing to do about this doctest is to be explicit and give the specific segment to test?



---

archive/issue_comments_370157.json:
```json
{
    "body": "What precisely is that part of the doctest suppose to be testing?",
    "created_at": "2019-02-20T20:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370157",
    "user": "tscrim"
}
```

What precisely is that part of the doctest suppose to be testing?



---

archive/issue_comments_370158.json:
```json
{
    "body": "It is testing the computation of the braid along the segment. The segments are created from the Voronoi diagram of the points in disc. We compute them all, and pick a specific one (where the bug shows up) and test it. The problem seems to be that the orderof the computed segments seems to deppend on the platform, so we are picking a different one on 32 bits, and get different results.",
    "created_at": "2019-02-20T20:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370158",
    "user": "mmarco"
}
```

It is testing the computation of the braid along the segment. The segments are created from the Voronoi diagram of the points in disc. We compute them all, and pick a specific one (where the bug shows up) and test it. The problem seems to be that the orderof the computed segments seems to deppend on the platform, so we are picking a different one on 32 bits, and get different results.



---

archive/issue_comments_370159.json:
```json
{
    "body": "So if the bug is showing up in that specific segment, perhaps the thing to do is isolate that segment, maybe by checking if that segment is in `segs` and then passing it to `braid_in_segments`?",
    "created_at": "2019-02-20T20:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370159",
    "user": "tscrim"
}
```

So if the bug is showing up in that specific segment, perhaps the thing to do is isolate that segment, maybe by checking if that segment is in `segs` and then passing it to `braid_in_segments`?



---

archive/issue_comments_370160.json:
```json
{
    "body": "Ah, wait, that won't work outright because of the numerical noise.",
    "created_at": "2019-02-20T20:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370160",
    "user": "tscrim"
}
```

Ah, wait, that won't work outright because of the numerical noise.



---

archive/issue_comments_370161.json:
```json
{
    "body": "Perhaps instead of that specific segment, we check\n\n```\ns0*s1*s3*s5*s1^-1*s0^-1*s3^-1 in [zvk.braid_in_segment(g,s) for s in segs]\n```\n\nI guess we could then get the index of that braid in the corresponding list and then check the segment itself (if you also want to show that output).",
    "created_at": "2019-02-20T20:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370161",
    "user": "tscrim"
}
```

Perhaps instead of that specific segment, we check

```
s0*s1*s3*s5*s1^-1*s0^-1*s3^-1 in [zvk.braid_in_segment(g,s) for s in segs]
```

I guess we could then get the index of that braid in the corresponding list and then check the segment itself (if you also want to show that output).



---

archive/issue_comments_370162.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-20T20:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370162",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370163.json:
```json
{
    "body": "I changed the doctest by giving explicitely the endpoints of the path. It still detects the bug.\n\nI didn't test it in a 32 bits system though.",
    "created_at": "2019-02-20T20:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370163",
    "user": "mmarco"
}
```

I changed the doctest by giving explicitely the endpoints of the path. It still detects the bug.

I didn't test it in a 32 bits system though.



---

archive/issue_comments_370164.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-20T21:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370164",
    "user": "mmarco"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_370165.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-20T21:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370165",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370166.json:
```json
{
    "body": "The changes are good with me, but you need to mark 2 doctests with `# optional - sirocco` (see pathcbot). Thierry, can you run your 32-bit patchbot on this?",
    "created_at": "2019-02-20T23:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370166",
    "user": "tscrim"
}
```

The changes are good with me, but you need to mark 2 doctests with `# optional - sirocco` (see pathcbot). Thierry, can you run your 32-bit patchbot on this?



---

archive/issue_comments_370167.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-12T20:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370167",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370168.json:
```json
{
    "body": "I have added the 2 missing sirocco tags",
    "created_at": "2019-03-12T20:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370168",
    "user": "chapoton"
}
```

I have added the 2 missing sirocco tags



---

archive/issue_comments_370169.json:
```json
{
    "body": "Sorry, this fell off my radar by the time I got to a place where I could have made those modifications. Thank you Fr\u00e9d\u00e9ric for the fix and the reminder.\n\nCan someone with a 32-bit machine retest this for completeness?",
    "created_at": "2019-03-12T22:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370169",
    "user": "tscrim"
}
```

Sorry, this fell off my radar by the time I got to a place where I could have made those modifications. Thank you Frédéric for the fix and the reminder.

Can someone with a 32-bit machine retest this for completeness?



---

archive/issue_comments_370170.json:
```json
{
    "body": "`@`tmonteil: Thierry, please launch your 32 bit patchbot on this ticket",
    "created_at": "2019-03-19T10:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370170",
    "user": "chapoton"
}
```

`@`tmonteil: Thierry, please launch your 32 bit patchbot on this ticket



---

archive/issue_comments_370171.json:
```json
{
    "body": "OK. I have to reboostrap one patchbot, so do not expect some result before this evening.",
    "created_at": "2019-03-19T11:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370171",
    "user": "tmonteil"
}
```

OK. I have to reboostrap one patchbot, so do not expect some result before this evening.



---

archive/issue_comments_370172.json:
```json
{
    "body": "Replying to [comment:42 tmonteil]:\n> OK. I have to reboostrap one patchbot, so do not expect some result before this evening.\n\nNo problem. Thank you for doing that.",
    "created_at": "2019-03-19T11:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370172",
    "user": "tscrim"
}
```

Replying to [comment:42 tmonteil]:
> OK. I have to reboostrap one patchbot, so do not expect some result before this evening.

No problem. Thank you for doing that.



---

archive/issue_comments_370173.json:
```json
{
    "body": "This looks good now on 32bit, see https://patchbot.sagemath.org/log/26503/debian/9.7/i686/4.9.0-7-686/tmonteil-debian-stretch-32/2019-03-21%2013:03:07.\n\nThere is an error for the file `src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py` but it also exists for ticket 0, see https://patchbot.sagemath.org/ticket/0/ so it is unrelated to this ticket.",
    "created_at": "2019-03-21T16:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370173",
    "user": "tmonteil"
}
```

This looks good now on 32bit, see https://patchbot.sagemath.org/log/26503/debian/9.7/i686/4.9.0-7-686/tmonteil-debian-stretch-32/2019-03-21%2013:03:07.

There is an error for the file `src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py` but it also exists for ticket 0, see https://patchbot.sagemath.org/ticket/0/ so it is unrelated to this ticket.



---

archive/issue_comments_370174.json:
```json
{
    "body": "The error is actually tracked at #27250.",
    "created_at": "2019-03-21T16:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370174",
    "user": "tmonteil"
}
```

The error is actually tracked at #27250.



---

archive/issue_comments_370175.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-21T23:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370175",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370176.json:
```json
{
    "body": "Thank you. I am now setting this to positive review.",
    "created_at": "2019-03-21T23:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370176",
    "user": "tscrim"
}
```

Thank you. I am now setting this to positive review.



---

archive/issue_comments_370177.json:
```json
{
    "body": "There's been a lot of trial and error on this, do we want to keep all these commits?\nWe could squash to a single commit instead -- I'm fine either way.",
    "created_at": "2019-03-22T08:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370177",
    "user": "slelievre"
}
```

There's been a lot of trial and error on this, do we want to keep all these commits?
We could squash to a single commit instead -- I'm fine either way.



---

archive/issue_comments_370178.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370178",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_370179.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-25T19:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26266#issuecomment-370179",
    "user": "vbraun"
}
```

Resolution: fixed
