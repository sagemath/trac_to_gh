# Issue 15733: j_invariant_qexp won't allow substitution

archive/issues_015733.json:
```json
{
    "body": "Keywords: j-invariant, laurent series, q-expansion, substitution\n\n\n```\njq = j_invariant_qexp(10) \njqsub = jq.substitute(q = e^(-2*pi))\n```\n\nThis used to work (Sage 4.8).  It ought to return an approximation to 1728 (this is useful behaviour...). E.g.\n\n\n```\nn(jqsub)\n\n1727.99999999999\n```\n\nBut now it raises...\n\n\n```\nValueError: Can only substitute elements of positive valuation\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15970\n\n",
    "created_at": "2014-03-18T04:21:35Z",
    "labels": [
        "number theory",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "j_invariant_qexp won't allow substitution",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15733",
    "user": "@katestange"
}
```
Keywords: j-invariant, laurent series, q-expansion, substitution


```
jq = j_invariant_qexp(10) 
jqsub = jq.substitute(q = e^(-2*pi))
```

This used to work (Sage 4.8).  It ought to return an approximation to 1728 (this is useful behaviour...). E.g.


```
n(jqsub)

1727.99999999999
```

But now it raises...


```
ValueError: Can only substitute elements of positive valuation
```


Issue created by migration from https://trac.sagemath.org/ticket/15970





---

archive/issue_comments_203621.json:
```json
{
    "body": "The change was made in #3979.  Until Sage 5.4, substitution into power series was incorrectly implemented in many ways.  In particular, it was possible to substitute a non-zero scalar into a series only specified up to a given precision, but this cannot make sense. \n\nIn your case, \n\n```\nsage: jq = j_invariant_qexp(10)\nsage: jq.truncate(10)(exp(-2*pi)).n(100)\n1727.9999999999882175423506871\n```\n\ngives the answer you want.  But its meaning depends on assuming (correctly) that the infinitely many unspecified terms can be ignored (to within 10<sup>-10</sup>).  \n\nIn general, writing, say,\n\n```\nf = x + x^2 + O(x^3)\n```\n\ntells us nothing about how `f(2)` should be defined, or whether `6` might be a reasonable approximation.",
    "created_at": "2014-03-19T12:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203621",
    "user": "fwclarke"
}
```

The change was made in #3979.  Until Sage 5.4, substitution into power series was incorrectly implemented in many ways.  In particular, it was possible to substitute a non-zero scalar into a series only specified up to a given precision, but this cannot make sense. 

In your case, 

```
sage: jq = j_invariant_qexp(10)
sage: jq.truncate(10)(exp(-2*pi)).n(100)
1727.9999999999882175423506871
```

gives the answer you want.  But its meaning depends on assuming (correctly) that the infinitely many unspecified terms can be ignored (to within 10<sup>-10</sup>).  

In general, writing, say,

```
f = x + x^2 + O(x^3)
```

tells us nothing about how `f(2)` should be defined, or whether `6` might be a reasonable approximation.



---

archive/issue_comments_203622.json:
```json
{
    "body": "Thanks, that clears things up for me.\u00a0 Probably I should have gone to the discussion list before opening a ticket (if so, I apologize).\u00a0 But before we close the ticket, can we clarify what way the user should accomplish the intended calculation?\u00a0 How can one approximate the j-invariant for various tau in the upper half plane?\u00a0 This is something Sage ought to allow someone to do, in some fashion, so if isn't possible, then maybe this ticket should be changed to a requested feature.\u00a0 But if this discussion ought to be carried out elsewhere (like ask.sagemath.org), please let me know.",
    "created_at": "2014-03-20T02:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203622",
    "user": "@katestange"
}
```

Thanks, that clears things up for me.  Probably I should have gone to the discussion list before opening a ticket (if so, I apologize).  But before we close the ticket, can we clarify what way the user should accomplish the intended calculation?  How can one approximate the j-invariant for various tau in the upper half plane?  This is something Sage ought to allow someone to do, in some fashion, so if isn't possible, then maybe this ticket should be changed to a requested feature.  But if this discussion ought to be carried out elsewhere (like ask.sagemath.org), please let me know.



---

archive/issue_comments_203623.json:
```json
{
    "body": "Replying to [comment:2 katestange]:\n> But before we close the ticket, can we clarify what way the user should accomplish the intended calculation?\u00a0 How can one approximate the j-invariant for various tau in the upper half plane?\n\nFor numerical computations, `elliptic_j` will do:\n\n```\nsage: elliptic_j(I)\n1728.00000000000\n```\n\nand the precision can be increased as in\n\n```\nsage: elliptic_j(sqrt(-1).n(128))\n1728.0000000000000000000000000000000000\n```\n\nor\n\n```\nsage: tau = (1 + sqrt(-163))/2\nsage: elliptic_j(tau.n(100))\n-2.6253741264076799999999999999e17 + 1.3012822400356849057448214481e-12*I\nsage: (-elliptic_j(tau.n(100)).real().round())^(1/3)\n640320\n```\n",
    "created_at": "2014-03-20T09:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203623",
    "user": "fwclarke"
}
```

Replying to [comment:2 katestange]:
> But before we close the ticket, can we clarify what way the user should accomplish the intended calculation?  How can one approximate the j-invariant for various tau in the upper half plane?

For numerical computations, `elliptic_j` will do:

```
sage: elliptic_j(I)
1728.00000000000
```

and the precision can be increased as in

```
sage: elliptic_j(sqrt(-1).n(128))
1728.0000000000000000000000000000000000
```

or

```
sage: tau = (1 + sqrt(-163))/2
sage: elliptic_j(tau.n(100))
-2.6253741264076799999999999999e17 + 1.3012822400356849057448214481e-12*I
sage: (-elliptic_j(tau.n(100)).real().round())^(1/3)
640320
```




---

archive/issue_comments_203624.json:
```json
{
    "body": "Thank you!",
    "created_at": "2014-03-20T15:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203624",
    "user": "@katestange"
}
```

Thank you!



---

archive/issue_comments_203625.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-24T22:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203625",
    "user": "@aghitza"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_203626.json:
```json
{
    "body": "I added a link to `elliptic_j` in the docstring for `j_invariant_qexp`.\n----\nNew commits:",
    "created_at": "2014-04-24T22:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203626",
    "user": "@aghitza"
}
```

I added a link to `elliptic_j` in the docstring for `j_invariant_qexp`.
----
New commits:



---

archive/issue_comments_203627.json:
```json
{
    "body": "Replying to [comment:2 katestange]:\n> How can one approximate the j-invariant for various tau in the upper half plane?\u00a0 This is something Sage ought to allow someone to do, in some fashion, so if isn't possible, then maybe this ticket should be changed to a requested feature.\n\nThe request is of course a reasonable one. Sometimes all you have is a finite approximation, and evaluating that will be the best you'll get. The trick is to get rid of the `O(..)` term, which you can do with `truncate`:\n\n```\nsage: jq = j_invariant_qexp(10)\nsage: jq.truncate(100)(e^(-2*pi)).n()\n1727.99999999999\n```\n",
    "created_at": "2014-04-25T06:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203627",
    "user": "@nbruin"
}
```

Replying to [comment:2 katestange]:
> How can one approximate the j-invariant for various tau in the upper half plane?  This is something Sage ought to allow someone to do, in some fashion, so if isn't possible, then maybe this ticket should be changed to a requested feature.

The request is of course a reasonable one. Sometimes all you have is a finite approximation, and evaluating that will be the best you'll get. The trick is to get rid of the `O(..)` term, which you can do with `truncate`:

```
sage: jq = j_invariant_qexp(10)
sage: jq.truncate(100)(e^(-2*pi)).n()
1727.99999999999
```




---

archive/issue_comments_203628.json:
```json
{
    "body": "Looks good, just a small reviewer patch to add markup to symbols and a variable name.",
    "created_at": "2014-05-02T13:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203628",
    "user": "@pjbruin"
}
```

Looks good, just a small reviewer patch to add markup to symbols and a variable name.



---

archive/issue_comments_203629.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-02T13:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203629",
    "user": "@pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203630.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-13T07:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15733#issuecomment-203630",
    "user": "@vbraun"
}
```

Resolution: fixed
