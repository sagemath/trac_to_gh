# Issue 19404: Remove (DY)LD_LIBRARY_PATH

Issue created by migration from https://trac.sagemath.org/ticket/19641

Original creator: vbraun

Original creation time: 2015-11-29 13:03:15

CC:  jdemeyer fbissey nbruin

In principle, we just have to compile Sage with

```
LDFLAGS=-Wl,-rpath,$SAGE_LOCAL/lib
```

to use rpath instead of LD_LIBRARY_PATH

Using #19467 this will work with binary distribution

Benefits to Sage:
* Only Sage binaries will see the rpath setting, removing all library conflicts
* Works on OSX 10.11


---

Comment by vbraun created at 2015-11-29 21:57:12

With the attached branch I can build Sage and all tests pass except three using the quadratic sieve (build/pkgs/flintqs). Which is no surprise if you look at its build "system".
----
New commits:


---

Comment by git created at 2015-11-30 09:11:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2015-11-30 09:48:30

Fixing `flintqs` should be trivial, there is one makefile for `SAGE64` and one used otherwise - and for the record that's the diff between the two

```
--- makefile.osx64	2009-01-21 03:11:18.000000000 +1300
+++ makefile.sage	2007-05-06 11:00:10.000000000 +1200
@@ -27,8 +27,8 @@
 BIN  = QuadraticSieve QuadraticSieve.exe
 #CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -march=athlon-xp -fomit-frame-pointer -O2
 #CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -march=athlon-xp -fomit-frame-pointer -O3
-CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O2 -m64
-CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O3 -m64
+CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O2
+CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O3
 RM = rm -f
 
 .PHONY: all clean clean-custom
@@ -39,7 +39,7 @@
 	${RM} $(OBJ) $(BIN)
 
 $(BIN): $(OBJ)
-	$(CPP) -ansi -m64 $(LINKOBJ) -o "QuadraticSieve" $(LIBS)
+	$(CPP) -ansi $(LINKOBJ) -o "QuadraticSieve" $(LIBS)
 
 ModuloArith.o: ModuloArith.cpp
 	$(CPP) -ansi -c ModuloArith.cpp -o ModuloArith.o $(CXXFLAGS)
```

Anyway `$(LDFLAGS)` can be easily added to the line building `QuadraticSieve` in both (if really necessary).


---

Comment by git created at 2015-12-13 13:21:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-12-17 23:34:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2015-12-17 23:35:21

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-12-17 23:35:21

With #19699 Sage builds and all doctests pass


---

Comment by fbissey created at 2015-12-17 23:52:01

Fine with me.


---

Comment by git created at 2015-12-18 15:44:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2015-12-18 17:39:03

Replying to [comment:9 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[ab27029](http://git.sagemath.org/sage.git/commit/?id=ab27029135636709b3cecd3d4576c97101e6ca65)||`OSX ld only understands the older rpath syntax`||

Minor, but is there a reason not to use

```sh
LDFLAGS="-Wl,-rpath,$SAGE_LOCAL/lib $LDFLAGS"
```

?

(That's the only difference to `-Xlinker` where every argument has to be passed separately.)


---

Comment by git created at 2015-12-18 17:51:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-18 17:52:43

I noticed already that maxima can't handle the two-argument version of sending the linker args, so we'll have to use this syntax.


---

Comment by leif created at 2015-12-18 19:08:35

Replying to [comment:12 vbraun]:
> I noticed already that maxima can't handle the two-argument version of sending the linker args, so we'll have to use this syntax.

Hmmm, a regression?  (cf. #12759)


---

Comment by vbraun created at 2015-12-18 19:15:02

Looks more like it has always been that way. Unsetting LDFLAGS doesn't really fix the issue (cf. #12759)


---

Comment by leif created at 2015-12-18 19:25:33

Replying to [comment:14 vbraun]:
> Looks more like it has always been that way. Unsetting LDFLAGS doesn't really fix the issue (cf. #12759)

? I don't recall myself, but two people claimed it got fixed upstream (in 5.29.1 and later).

(And unsetting `LDFLAGS` in Maxima's `spkg-install` used to work because ECL's were used by Maxima anyway, assuming the settings are the same of course.)


---

Comment by vbraun created at 2015-12-18 21:14:10

Works on OSX now


---

Comment by git created at 2015-12-20 00:02:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-20 00:04:17

Bootstrapping gcc fails with 

```
/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/gcc-4.9.2.p1/gcc-build/./gcc/cc1: error while loading shared libraries: libmpc.so.3: cannot open shared object file: No such file or directory
```

should be fixed now


---

Comment by git created at 2015-12-20 11:03:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-20 14:52:53

Of course using with-stage1-ldflags then fails in stage2; Correct solution from https://gcc.gnu.org/ml/gcc/2008-09/msg00214.html


---

Comment by git created at 2015-12-21 08:50:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-21 12:49:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-21 19:19:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-22 08:39:59

Now works on all buildbot machines


---

Comment by vbraun created at 2015-12-22 19:50:46

Resolution: fixed
