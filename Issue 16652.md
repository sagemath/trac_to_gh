# Issue 16652: Doctest tolerance: allow spaces

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2014-08-27 14:43:50

CC:  zimmerma

The doctesting framework should ignore spaces before numbers when testing with `abs/rel tol`. There are two reasons why:

1. The spacing of matrices is unpredictable. You could have

```
[1.0 0.0]
[1.0 0.0]
```

vs

```
[0.999999 0.0]
[     1.0 0.0]
```

Note the added space between `[` and `1.0`.

2. Complex numbers or polynomials

```
1.0 + 1e-16*I
```

vs

```
1.0 - 1e-16*I
```

Here you want to compare ` + 1e-16` and ` - 1e-16` for your tolerance computations.


---

Comment by git created at 2014-08-27 16:01:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-08-27 18:52:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-08-27 19:17:29

Paul Zimmermann: this needs a minor change to a French book doctest. When using `# tol`, you may no longer split doctest results like

```
1.5 -
2.3
```

The minus sign may not be on its own line, you need to write

```
1.5
- 2.3
```



---

Comment by jdemeyer created at 2014-08-27 19:19:21

Changing status from new to needs_review.


---

Comment by zimmerma created at 2014-08-27 20:07:31

in the source of the french book, I've changed to:

```
  [0.347521510119 + 0.566550553398*I, 0.347521510119 - 0.566550553398*I,
  0.345023776962 + 0.439908702386*I, 0.345023776962 - 0.439908702386*I,
  -0.517257614325 + 0.512958206789*I,
  -0.517257614325 - 0.512958206789*I, -1.36699716455, -9.98357818097]
```

which uses the same number of lines, and should not make any overfull hbox.
Is that ok?

Paul


---

Comment by jdemeyer created at 2014-08-27 20:26:18

Replying to [comment:6 zimmerma]:
> in the source of the french book, I've changed to:
> {{{
>   [0.347521510119 + 0.566550553398*I, 0.347521510119 - 0.566550553398*I,
>   0.345023776962 + 0.439908702386*I, 0.345023776962 - 0.439908702386*I,
>   -0.517257614325 + 0.512958206789*I,
>   -0.517257614325 - 0.512958206789*I, -1.36699716455, -9.98357818097]
> }}}
> which uses the same number of lines, and should not make any overfull hbox.
> Is that ok?
Yes, that would be good. However, note that Sage itself actually formats the results as in my patch, with one value per line.


---

Comment by zimmerma created at 2014-08-27 20:32:00

ok, however in our book we allow ourselves not to follow 100% the Sage output format, up to spaces
and line breaks, to save some vertical space.

Paul


---

Comment by jdemeyer created at 2014-08-27 20:32:40

Fun fact: this ticket relies on functionality added in 2006:

```diff
commit 04043acc648e0bca14725f147b2040e204ae1f9b
Author: William Stein <wstein`@`ucsd.edu>
Date:   Mon May 29 01:10:56 2006 +0000

    [project `@` mpfr -- can coerce in numbers ignoring space, e.g. RR('1 E7') now works (which is what pari outputs!)]

diff --git a/src/sage/ext/mpfr.pyx b/src/sage/ext/mpfr.pyx
index 8f92208..afc9b72 100644
--- a/src/sage/ext/mpfr.pyx
+++ b/src/sage/ext/mpfr.pyx
`@``@` -602,7 +602,7 `@``@` cdef class RealNumber(element.RingElement):
             d = parent(x.denominator())
             mpfr_div(self.value, n.value, d.value, parent.rnd)
         else:
-            s = str(x)
+            s = str(x).replace(' ','')
             if mpfr_set_str(self.value, s, base, parent.rnd):
                 if s == 'NaN' or s == '`@`NaN`@`':
                     mpfr_set_nan(self.value)
```



---

Comment by git created at 2014-08-28 13:55:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-28 21:26:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-08-29 10:16:51

This looks good to me. How about renaming the `tolerance.rst` to `must_fail.rst` or so and have an explanatory sentence about what is going on at the top. I fear that somebody will sooner or later "fix" the failing doctests if its not clear ;-)


---

Comment by git created at 2014-08-29 10:30:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-01 19:22:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-01 21:36:48

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-09-01 21:36:48

Doctests fail because the line numbers are shifted, e.g. http://build.sagemath.org/sage/builders/%20%20fast%20Volker%20Desktop%20%28Fedora%2020%20x86_64%29%20incremental/builds/416/steps/shell_4/logs/stdio


---

Comment by jdemeyer created at 2014-09-02 08:42:43

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-09-06 11:03:04

Resolution: fixed
