# Issue 24044: Fix comparison of RingHomomorphisms

archive/issues_024044.json:
```json
{
    "body": "CC:  @tscrim\n\nOften, the same morphism can be created as different Python classes. For example, these are two versions of the identity map on `QQ`:\n\n```\nsage: H = End(QQ)\nsage: f = H.identity()\nsage: g = H(1)\nsage: type(f)\n<type 'sage.categories.morphism.IdentityMorphism'>\nsage: type(g)\n<type 'sage.rings.morphism.RingHomomorphism_im_gens'>\n```\n\nThe problem is that these may not compare equal:\n\n```\nsage: g == f\nFalse\nsage: f == g\nTrue\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24281\n\n",
    "created_at": "2017-11-26T08:38:12Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fix comparison of RingHomomorphisms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24044",
    "user": "@jdemeyer"
}
```
CC:  @tscrim

Often, the same morphism can be created as different Python classes. For example, these are two versions of the identity map on `QQ`:

```
sage: H = End(QQ)
sage: f = H.identity()
sage: g = H(1)
sage: type(f)
<type 'sage.categories.morphism.IdentityMorphism'>
sage: type(g)
<type 'sage.rings.morphism.RingHomomorphism_im_gens'>
```

The problem is that these may not compare equal:

```
sage: g == f
False
sage: f == g
True
```


Issue created by migration from https://trac.sagemath.org/ticket/24281





---

archive/issue_comments_337038.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-27T14:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337038",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337039.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-11-27T14:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337039",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_337040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-27T15:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337040",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337041.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-27T16:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337041",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337042.json:
```json
{
    "body": "I think having the checks that the (co)domains matched was a good first check because that should be very quick (generally, a comparison of `id`s). Moreover, with your code, you can get equality of morphisms when there is a coercion from one codomain into the other that results in equal elements.\n\n```\nsage: D = ZZ['x']\nsage: C1 = ZZ['x']\nsage: C2 = QQ['x']\nsage: phi = D.morphism(C1.gens())\nsage: psi = D.morphism(C2.gens())\nsage: Morphism._richcmp_(psi, phi, 2)  # 2 == Py_EQ\nTrue\n```\n\nHowever, we do not want these to be equal as we then have an isomorphism equal to a non-surjective map. A more minimal example that directly uses the `Morphism._richcmp_`:\n\n```\nsage: IZZ = Hom(ZZ,ZZ).natural_map()\nsage: IQQ = Hom(QQ,QQ).natural_map()\nsage: IZZ._richcmp_(IQQ, 2)\nTrue\n```\n\n(Although I do not understand why `==` is returning `False` in both of these cases.)\n\nAlso, why did you remove the `_richcmp_` for `MatrixMorphism`? I know that might generally involve more comparisons, but it still should require less CPU cycles because you do not have to apply the morphisms. Although the same comment about equal (co)domains definitely still applies (and is a current bug).",
    "created_at": "2017-11-28T00:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337042",
    "user": "@tscrim"
}
```

I think having the checks that the (co)domains matched was a good first check because that should be very quick (generally, a comparison of `id`s). Moreover, with your code, you can get equality of morphisms when there is a coercion from one codomain into the other that results in equal elements.

```
sage: D = ZZ['x']
sage: C1 = ZZ['x']
sage: C2 = QQ['x']
sage: phi = D.morphism(C1.gens())
sage: psi = D.morphism(C2.gens())
sage: Morphism._richcmp_(psi, phi, 2)  # 2 == Py_EQ
True
```

However, we do not want these to be equal as we then have an isomorphism equal to a non-surjective map. A more minimal example that directly uses the `Morphism._richcmp_`:

```
sage: IZZ = Hom(ZZ,ZZ).natural_map()
sage: IQQ = Hom(QQ,QQ).natural_map()
sage: IZZ._richcmp_(IQQ, 2)
True
```

(Although I do not understand why `==` is returning `False` in both of these cases.)

Also, why did you remove the `_richcmp_` for `MatrixMorphism`? I know that might generally involve more comparisons, but it still should require less CPU cycles because you do not have to apply the morphisms. Although the same comment about equal (co)domains definitely still applies (and is a current bug).



---

archive/issue_comments_337043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T08:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337043",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337044.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-28T08:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337044",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337045.json:
```json
{
    "body": "Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.",
    "created_at": "2017-11-28T08:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337045",
    "user": "@tscrim"
}
```

Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.



---

archive/issue_comments_337046.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.\n\nExactly. I was going to write you a longer reply, but you figured it out :-)",
    "created_at": "2017-11-28T08:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337046",
    "user": "@jdemeyer"
}
```

Replying to [comment:10 tscrim]:
> Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.

Exactly. I was going to write you a longer reply, but you figured it out :-)



---

archive/issue_comments_337047.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> {{{\n> sage: D = ZZ['x']\n> sage: C1 = ZZ['x']\n> sage: C2 = QQ['x']\n> sage: phi = D.morphism(C1.gens())\n> sage: psi = D.morphism(C2.gens())\n> sage: Morphism._richcmp_(psi, phi, 2)  # 2 == Py_EQ\n> True\n> }}}\n\nWhat is `D.morphism()` by the way? I get `AttributeError: 'PolynomialRing_integral_domain_with_category' object has no attribute 'morphism'`",
    "created_at": "2017-11-28T08:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337047",
    "user": "@jdemeyer"
}
```

Replying to [comment:7 tscrim]:
> {{{
> sage: D = ZZ['x']
> sage: C1 = ZZ['x']
> sage: C2 = QQ['x']
> sage: phi = D.morphism(C1.gens())
> sage: psi = D.morphism(C2.gens())
> sage: Morphism._richcmp_(psi, phi, 2)  # 2 == Py_EQ
> True
> }}}

What is `D.morphism()` by the way? I get `AttributeError: 'PolynomialRing_integral_domain_with_category' object has no attribute 'morphism'`



---

archive/issue_comments_337048.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Also, why did you remove the `_richcmp_` for `MatrixMorphism`?\n\nMy initial thought was that for directional comparisons (`<`, `<=`, `>`, `>=`), the code would give a different result from `Morphism._richcmp_`. So I restored the original code but only for `==` and `!=`.",
    "created_at": "2017-11-28T08:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337048",
    "user": "@jdemeyer"
}
```

Replying to [comment:7 tscrim]:
> Also, why did you remove the `_richcmp_` for `MatrixMorphism`?

My initial thought was that for directional comparisons (`<`, `<=`, `>`, `>=`), the code would give a different result from `Morphism._richcmp_`. So I restored the original code but only for `==` and `!=`.



---

archive/issue_comments_337049.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.\n\nInterestingly, morphisms are a good example in Sage of `Element` classes where one `Parent` allows many different `Element` classes. And we clearly didn't deal properly with that.",
    "created_at": "2017-11-28T08:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337049",
    "user": "@jdemeyer"
}
```

Replying to [comment:10 tscrim]:
> Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.

Interestingly, morphisms are a good example in Sage of `Element` classes where one `Parent` allows many different `Element` classes. And we clearly didn't deal properly with that.



---

archive/issue_comments_337050.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:7 tscrim]:\n> > {{{\n> > sage: D = ZZ['x']\n> > sage: C1 = ZZ['x']\n> > sage: C2 = QQ['x']\n> > sage: phi = D.morphism(C1.gens())\n> > sage: psi = D.morphism(C2.gens())\n> > sage: Morphism._richcmp_(psi, phi, 2)  # 2 == Py_EQ\n> > True\n> > }}}\n> \n> What is `D.morphism()` by the way? I get `AttributeError: 'PolynomialRing_integral_domain_with_category' object has no attribute 'morphism'`\n\nSorry, I thought I had copied the code I actually used there. That was pseudocode I wrote while waiting for Sage to recompile. It was suppose to be `phi = Hom(D,C1)(C1.gens())`.",
    "created_at": "2017-11-28T08:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337050",
    "user": "@tscrim"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:7 tscrim]:
> > {{{
> > sage: D = ZZ['x']
> > sage: C1 = ZZ['x']
> > sage: C2 = QQ['x']
> > sage: phi = D.morphism(C1.gens())
> > sage: psi = D.morphism(C2.gens())
> > sage: Morphism._richcmp_(psi, phi, 2)  # 2 == Py_EQ
> > True
> > }}}
> 
> What is `D.morphism()` by the way? I get `AttributeError: 'PolynomialRing_integral_domain_with_category' object has no attribute 'morphism'`

Sorry, I thought I had copied the code I actually used there. That was pseudocode I wrote while waiting for Sage to recompile. It was suppose to be `phi = Hom(D,C1)(C1.gens())`.



---

archive/issue_comments_337051.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Replying to [comment:10 tscrim]:\n> > Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.\n> \n> Interestingly, morphisms are a good example in Sage of `Element` classes where one `Parent` allows many different `Element` classes. And we clearly didn't deal properly with that.\n\nThis is currently the biggest example of that general shortcoming and should be addressed at some point. Although I guess in some ways with how we do things with extension classes, it works, but I am fairly certain we loose stuff from the categories when using Python classes.",
    "created_at": "2017-11-28T09:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337051",
    "user": "@tscrim"
}
```

Replying to [comment:14 jdemeyer]:
> Replying to [comment:10 tscrim]:
> > Oh, wait, the reason why we do not need to check the (co)domains match is because by the time we get to `_richcmp_`, we had to have coerced into the same parent. So the (co)domains must match at that point.
> 
> Interestingly, morphisms are a good example in Sage of `Element` classes where one `Parent` allows many different `Element` classes. And we clearly didn't deal properly with that.

This is currently the biggest example of that general shortcoming and should be addressed at some point. Although I guess in some ways with how we do things with extension classes, it works, but I am fairly certain we loose stuff from the categories when using Python classes.



---

archive/issue_comments_337052.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Replying to [comment:7 tscrim]:\n> > Also, why did you remove the `_richcmp_` for `MatrixMorphism`?\n> \n> My initial thought was that for directional comparisons (`<`, `<=`, `>`, `>=`), the code would give a different result from `Morphism._richcmp_`. So I restored the original code but only for `==` and `!=`.\n\nI see.\n\nThe earlier error is making me think a bit more about using `gens` in the general morphism code. I don't think this suffers from the same problem as #15381. Yet, we probably want to return a `NotImplemented` when `gens` is not defined (maybe also catching if it raises some [reasonable] error?).",
    "created_at": "2017-11-28T09:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337052",
    "user": "@tscrim"
}
```

Replying to [comment:13 jdemeyer]:
> Replying to [comment:7 tscrim]:
> > Also, why did you remove the `_richcmp_` for `MatrixMorphism`?
> 
> My initial thought was that for directional comparisons (`<`, `<=`, `>`, `>=`), the code would give a different result from `Morphism._richcmp_`. So I restored the original code but only for `==` and `!=`.

I see.

The earlier error is making me think a bit more about using `gens` in the general morphism code. I don't think this suffers from the same problem as #15381. Yet, we probably want to return a `NotImplemented` when `gens` is not defined (maybe also catching if it raises some [reasonable] error?).



---

archive/issue_comments_337053.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> The earlier error is making me think a bit more about using `gens` in the general morphism code. I don't think this suffers from the same problem as #15381.\n\nI think it does in the sense that I did not fix #15381 or #17768.\n\n> Yet, we probably want to return a `NotImplemented` when `gens` is not defined\n\nNot sure about that. I like explicit errors, such as an `AttributeError` when there is no `gens()`.",
    "created_at": "2017-11-28T09:19:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337053",
    "user": "@jdemeyer"
}
```

Replying to [comment:17 tscrim]:
> The earlier error is making me think a bit more about using `gens` in the general morphism code. I don't think this suffers from the same problem as #15381.

I think it does in the sense that I did not fix #15381 or #17768.

> Yet, we probably want to return a `NotImplemented` when `gens` is not defined

Not sure about that. I like explicit errors, such as an `AttributeError` when there is no `gens()`.



---

archive/issue_comments_337054.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:17 tscrim]:\n> > The earlier error is making me think a bit more about using `gens` in the general morphism code. I don't think this suffers from the same problem as #15381.\n> \n> I think it does in the sense that I did not fix #15381 or #17768.\n\nSince it makes the problem no worse than before, we can just let it be.\n\n> > Yet, we probably want to return a `NotImplemented` when `gens` is not defined\n> \n> Not sure about that. I like explicit errors, such as an `AttributeError` when there is no `gens()`.\n\nI guess we have a little more freedom with raising errors than `__contains__` (which should never raise an error). However, because of the type of error and how generic this code it suppose to be, I feel such an error strongly suggests that parent classes should implement `gens` in contrast to `*_generators` and having the appropriate category redirect from `gens` or perhaps where it is not a natural construct (say a combinatorial set). I guess since this is post-coercion, having it raise an error is saying something about the implementation of either the underlying object or their morphisms and you don't have any more fragile code by comparing a `X - > Y` and `X' -> Y` morphism, where `X` and `X'` might be in completely different categories. So I guess it is okay.\n\nThe only other thing I would like is a doctest for `_richcmp_`, preferably one that was incorrect before and now succeeds and the `QQ` vs `ZZ` example with something like\n\n```\nWhile this compares by generators (which can use coercion), the coercion model\nis first invoked to guarantee that domains must match in order to have the\nsame parent for the morphisms::\n\n    sage: phi = Hom(ZZ,ZZ).natural_map()\n    sage: psi = Hom(QQ,QQ).natural_map(\n    sage: Morphism._richcmp_(phi, psi, 2)\n    True\n    sage: phi == psi\n    False\n```\n",
    "created_at": "2017-11-28T12:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337054",
    "user": "@tscrim"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 tscrim]:
> > The earlier error is making me think a bit more about using `gens` in the general morphism code. I don't think this suffers from the same problem as #15381.
> 
> I think it does in the sense that I did not fix #15381 or #17768.

Since it makes the problem no worse than before, we can just let it be.

> > Yet, we probably want to return a `NotImplemented` when `gens` is not defined
> 
> Not sure about that. I like explicit errors, such as an `AttributeError` when there is no `gens()`.

I guess we have a little more freedom with raising errors than `__contains__` (which should never raise an error). However, because of the type of error and how generic this code it suppose to be, I feel such an error strongly suggests that parent classes should implement `gens` in contrast to `*_generators` and having the appropriate category redirect from `gens` or perhaps where it is not a natural construct (say a combinatorial set). I guess since this is post-coercion, having it raise an error is saying something about the implementation of either the underlying object or their morphisms and you don't have any more fragile code by comparing a `X - > Y` and `X' -> Y` morphism, where `X` and `X'` might be in completely different categories. So I guess it is okay.

The only other thing I would like is a doctest for `_richcmp_`, preferably one that was incorrect before and now succeeds and the `QQ` vs `ZZ` example with something like

```
While this compares by generators (which can use coercion), the coercion model
is first invoked to guarantee that domains must match in order to have the
same parent for the morphisms::

    sage: phi = Hom(ZZ,ZZ).natural_map()
    sage: psi = Hom(QQ,QQ).natural_map(
    sage: Morphism._richcmp_(phi, psi, 2)
    True
    sage: phi == psi
    False
```




---

archive/issue_comments_337055.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> {{{\n> While this compares by generators (which can use coercion), the coercion model\n> is first invoked to guarantee that domains must match in order to have the\n> same parent for the morphisms::\n> \n>     sage: phi = Hom(ZZ,ZZ).natural_map()\n>     sage: psi = Hom(QQ,QQ).natural_map()\n>     sage: Morphism._richcmp_(phi, psi, 2)\n>     True\n> }}}\n\nThat is a horrible test because you should really *never* do that (`_richcmp_` with different parents). Why should I add it?",
    "created_at": "2017-11-28T12:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337055",
    "user": "@jdemeyer"
}
```

Replying to [comment:19 tscrim]:
> {{{
> While this compares by generators (which can use coercion), the coercion model
> is first invoked to guarantee that domains must match in order to have the
> same parent for the morphisms::
> 
>     sage: phi = Hom(ZZ,ZZ).natural_map()
>     sage: psi = Hom(QQ,QQ).natural_map()
>     sage: Morphism._richcmp_(phi, psi, 2)
>     True
> }}}

That is a horrible test because you should really *never* do that (`_richcmp_` with different parents). Why should I add it?



---

archive/issue_comments_337056.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> Replying to [comment:19 tscrim]:\n> > {{{\n> > While this compares by generators (which can use coercion), the coercion model\n> > is first invoked to guarantee that domains must match in order to have the\n> > same parent for the morphisms::\n> > \n> >     sage: phi = Hom(ZZ,ZZ).natural_map()\n> >     sage: psi = Hom(QQ,QQ).natural_map()\n> >     sage: Morphism._richcmp_(phi, psi, 2)\n> >     True\n> > }}}\n> \n> That is a horrible test because you should really *never* do that (`_richcmp_` with different parents). Why should I add it?\n\nYea, right, duh. However, we should document it somewhere that we are (strongly) assuming that the parents, and hence the (co)domains are the same because of the coercion involved.",
    "created_at": "2017-11-28T12:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337056",
    "user": "@tscrim"
}
```

Replying to [comment:20 jdemeyer]:
> Replying to [comment:19 tscrim]:
> > {{{
> > While this compares by generators (which can use coercion), the coercion model
> > is first invoked to guarantee that domains must match in order to have the
> > same parent for the morphisms::
> > 
> >     sage: phi = Hom(ZZ,ZZ).natural_map()
> >     sage: psi = Hom(QQ,QQ).natural_map()
> >     sage: Morphism._richcmp_(phi, psi, 2)
> >     True
> > }}}
> 
> That is a horrible test because you should really *never* do that (`_richcmp_` with different parents). Why should I add it?

Yea, right, duh. However, we should document it somewhere that we are (strongly) assuming that the parents, and hence the (co)domains are the same because of the coercion involved.



---

archive/issue_comments_337057.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> However, because of the type of error and how generic this code it suppose to be, I feel such an error strongly suggests that parent classes should implement `gens` in contrast to `*_generators` and having the appropriate category redirect from `gens` or perhaps where it is not a natural construct (say a combinatorial set). I guess since this is post-coercion, having it raise an error is saying something about the implementation of either the underlying object or their morphisms and you don't have any more fragile code by comparing a `X - > Y` and `X' -> Y` morphism, where `X` and `X'` might be in completely different categories. So I guess it is okay.\n\nI don't quite understand what you are trying to say here...\n\nI agree that `gens()` might not be ideal, but that is really an issue for #15381.",
    "created_at": "2017-11-28T15:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337057",
    "user": "@jdemeyer"
}
```

Replying to [comment:19 tscrim]:
> However, because of the type of error and how generic this code it suppose to be, I feel such an error strongly suggests that parent classes should implement `gens` in contrast to `*_generators` and having the appropriate category redirect from `gens` or perhaps where it is not a natural construct (say a combinatorial set). I guess since this is post-coercion, having it raise an error is saying something about the implementation of either the underlying object or their morphisms and you don't have any more fragile code by comparing a `X - > Y` and `X' -> Y` morphism, where `X` and `X'` might be in completely different categories. So I guess it is okay.

I don't quite understand what you are trying to say here...

I agree that `gens()` might not be ideal, but that is really an issue for #15381.



---

archive/issue_comments_337058.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-28T15:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337058",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337059.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-28T16:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337059",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337060.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T16:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337060",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337061.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> Replying to [comment:19 tscrim]:\n> > However, because of the type of error and how generic this code it suppose to be, I feel such an error strongly suggests that parent classes should implement `gens` in contrast to `*_generators` and having the appropriate category redirect from `gens` or perhaps where it is not a natural construct (say a combinatorial set). I guess since this is post-coercion, having it raise an error is saying something about the implementation of either the underlying object or their morphisms and you don't have any more fragile code by comparing a `X - > Y` and `X' -> Y` morphism, where `X` and `X'` might be in completely different categories. So I guess it is okay.\n> \n> I don't quite understand what you are trying to say here...\n\nYea, that was perhaps a bit too short and poorly written. There are two things:\n\n1. A category that does not have a natural notation of `gens` such as `EnumeratedSets()`. Then morphisms in that category should override the `_richcmp_` because more information is necessary (it would normally have to provide it anyways).\n\n   The problem I have with having it raise an `AttributeError` on `gens` is that it suggests that the user should implement a `gens` rather than give an (overriding) implementation of `_richcmp_`. So I feel that it sends the wrong message in these cases.\n\n   Also, mostly just to note, this will be a behavior change that might result in code breaking in the wild.\n\n2. Suppose you have `f: X -> Y` and `g: X' -> Y`, where the category of `X` is, e.g., `Algebras(ZZ)` and `X'` is `Modules(ZZ)` with `X'` being `X` under the forgetful functor. However, because this would happen post-coercion (assuming smart enough homsets and coercion code), the object `X` should become `X'` and so `gens` would be the basis rather than the algebra generators.\n\n   Although I do not think our coercion and functor code is smart enough to handle this sort of situation right now anyways. The thought I had is that it really used the algebra generators of `X` to do the comparison, which may result in wrong answers because `g` is not an algebra morphism but matches on the algebra generators.\n\nDoes that clarify things?\n\n> I agree that `gens()` might not be ideal, but that is really an issue for #15381.\n\nI'm not completely sure that #15381 is relevant for not using `gens`, but your changes are no worse than before too. So this is not a blocker for a positive review.",
    "created_at": "2017-11-29T08:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337061",
    "user": "@tscrim"
}
```

Replying to [comment:22 jdemeyer]:
> Replying to [comment:19 tscrim]:
> > However, because of the type of error and how generic this code it suppose to be, I feel such an error strongly suggests that parent classes should implement `gens` in contrast to `*_generators` and having the appropriate category redirect from `gens` or perhaps where it is not a natural construct (say a combinatorial set). I guess since this is post-coercion, having it raise an error is saying something about the implementation of either the underlying object or their morphisms and you don't have any more fragile code by comparing a `X - > Y` and `X' -> Y` morphism, where `X` and `X'` might be in completely different categories. So I guess it is okay.
> 
> I don't quite understand what you are trying to say here...

Yea, that was perhaps a bit too short and poorly written. There are two things:

1. A category that does not have a natural notation of `gens` such as `EnumeratedSets()`. Then morphisms in that category should override the `_richcmp_` because more information is necessary (it would normally have to provide it anyways).

   The problem I have with having it raise an `AttributeError` on `gens` is that it suggests that the user should implement a `gens` rather than give an (overriding) implementation of `_richcmp_`. So I feel that it sends the wrong message in these cases.

   Also, mostly just to note, this will be a behavior change that might result in code breaking in the wild.

2. Suppose you have `f: X -> Y` and `g: X' -> Y`, where the category of `X` is, e.g., `Algebras(ZZ)` and `X'` is `Modules(ZZ)` with `X'` being `X` under the forgetful functor. However, because this would happen post-coercion (assuming smart enough homsets and coercion code), the object `X` should become `X'` and so `gens` would be the basis rather than the algebra generators.

   Although I do not think our coercion and functor code is smart enough to handle this sort of situation right now anyways. The thought I had is that it really used the algebra generators of `X` to do the comparison, which may result in wrong answers because `g` is not an algebra morphism but matches on the algebra generators.

Does that clarify things?

> I agree that `gens()` might not be ideal, but that is really an issue for #15381.

I'm not completely sure that #15381 is relevant for not using `gens`, but your changes are no worse than before too. So this is not a blocker for a positive review.



---

archive/issue_comments_337062.json:
```json
{
    "body": "I feel that we should just remove the init test for `RingMap`. I think it was just there to give 100% doctest coverage, and it is not a useful test.",
    "created_at": "2017-11-29T08:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337062",
    "user": "@tscrim"
}
```

I feel that we should just remove the init test for `RingMap`. I think it was just there to give 100% doctest coverage, and it is not a useful test.



---

archive/issue_comments_337063.json:
```json
{
    "body": "Replying to [comment:26 tscrim]:\n>   Also, mostly just to note, this will be a behavior change that might result in code breaking in the wild.\n\nFixing bugs changes behaviour...",
    "created_at": "2017-11-29T08:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337063",
    "user": "@jdemeyer"
}
```

Replying to [comment:26 tscrim]:
>   Also, mostly just to note, this will be a behavior change that might result in code breaking in the wild.

Fixing bugs changes behaviour...



---

archive/issue_comments_337064.json:
```json
{
    "body": "Replying to [comment:28 jdemeyer]:\n> Replying to [comment:26 tscrim]:\n> >   Also, mostly just to note, this will be a behavior change that might result in code breaking in the wild.\n> \n> Fixing bugs changes behaviour...\n\nI do not consider this to be a bug. Yet, I don't think it is a spacebar-esqe in the sense there might be someone who is relying on this behavior in a non-horrifying way. However, raising an error in this case will not be a blocker from me either.",
    "created_at": "2017-11-29T08:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337064",
    "user": "@tscrim"
}
```

Replying to [comment:28 jdemeyer]:
> Replying to [comment:26 tscrim]:
> >   Also, mostly just to note, this will be a behavior change that might result in code breaking in the wild.
> 
> Fixing bugs changes behaviour...

I do not consider this to be a bug. Yet, I don't think it is a spacebar-esqe in the sense there might be someone who is relying on this behavior in a non-horrifying way. However, raising an error in this case will not be a blocker from me either.



---

archive/issue_comments_337065.json:
```json
{
    "body": "Replying to [comment:26 tscrim]:\n> The problem I have with having it raise an `AttributeError` on `gens` is that it suggests that the user should implement a `gens` rather than give an (overriding) implementation of `_richcmp_`. So I feel that it sends the wrong message in these cases.\n\nOK, I changed this to raise `NotImplementedError`. Returning `NotImplemented` seems inappropriate here because the `_richcmp_` method does understand what is asked and it knows that it cannot compute the result.\n\n> 2. Suppose you have `f: X -> Y` and `g: X' -> Y`, where the category of `X` is, e.g., `Algebras(ZZ)` and `X'` is `Modules(ZZ)` with `X'` being `X` under the forgetful functor. However, because this would happen post-coercion (assuming smart enough homsets and coercion code), the object `X` should become `X'` and so `gens` would be the basis rather than the algebra generators.\n\nIt shouldn't be a problem if there are *more* gens. Comparing algebra morphisms using the module generators is safe (but possibly inefficient).",
    "created_at": "2017-11-29T14:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337065",
    "user": "@jdemeyer"
}
```

Replying to [comment:26 tscrim]:
> The problem I have with having it raise an `AttributeError` on `gens` is that it suggests that the user should implement a `gens` rather than give an (overriding) implementation of `_richcmp_`. So I feel that it sends the wrong message in these cases.

OK, I changed this to raise `NotImplementedError`. Returning `NotImplemented` seems inappropriate here because the `_richcmp_` method does understand what is asked and it knows that it cannot compute the result.

> 2. Suppose you have `f: X -> Y` and `g: X' -> Y`, where the category of `X` is, e.g., `Algebras(ZZ)` and `X'` is `Modules(ZZ)` with `X'` being `X` under the forgetful functor. However, because this would happen post-coercion (assuming smart enough homsets and coercion code), the object `X` should become `X'` and so `gens` would be the basis rather than the algebra generators.

It shouldn't be a problem if there are *more* gens. Comparing algebra morphisms using the module generators is safe (but possibly inefficient).



---

archive/issue_comments_337066.json:
```json
{
    "body": "Replying to [comment:27 tscrim]:\n> I feel that we should just remove the init test for `RingMap`. I think it was just there to give 100% doctest coverage, and it is not a useful test.\n\nI added a test of the `parent()`. That makes the example do at least something non-trivial.",
    "created_at": "2017-11-29T14:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337066",
    "user": "@jdemeyer"
}
```

Replying to [comment:27 tscrim]:
> I feel that we should just remove the init test for `RingMap`. I think it was just there to give 100% doctest coverage, and it is not a useful test.

I added a test of the `parent()`. That makes the example do at least something non-trivial.



---

archive/issue_comments_337067.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-29T14:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337067",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337068.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-30T01:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337068",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_337069.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> Replying to [comment:26 tscrim]:\n> > The problem I have with having it raise an `AttributeError` on `gens` is that it suggests that the user should implement a `gens` rather than give an (overriding) implementation of `_richcmp_`. So I feel that it sends the wrong message in these cases.\n> \n> OK, I changed this to raise `NotImplementedError`. Returning `NotImplemented` seems inappropriate here because the `_richcmp_` method does understand what is asked and it knows that it cannot compute the result.\n\nThank you.\n\nEverything else LGTM. Positive review.",
    "created_at": "2017-11-30T01:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337069",
    "user": "@tscrim"
}
```

Replying to [comment:30 jdemeyer]:
> Replying to [comment:26 tscrim]:
> > The problem I have with having it raise an `AttributeError` on `gens` is that it suggests that the user should implement a `gens` rather than give an (overriding) implementation of `_richcmp_`. So I feel that it sends the wrong message in these cases.
> 
> OK, I changed this to raise `NotImplementedError`. Returning `NotImplemented` seems inappropriate here because the `_richcmp_` method does understand what is asked and it knows that it cannot compute the result.

Thank you.

Everything else LGTM. Positive review.



---

archive/issue_comments_337070.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-13T17:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24044#issuecomment-337070",
    "user": "@vbraun"
}
```

Resolution: fixed
