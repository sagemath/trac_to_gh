# Issue 25272: Provide a simple (and generic) way to create immutable vectors and matrices

archive/issues_025272.json:
```json
{
    "body": "CC:  @kliem\n\nWe currently have the following elegant way to produce immutable graphs:\n\n```\nsage: set([Graph(i) for i in range(5)])\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: This graph is mutable, and thus not hashable. Create an immutable copy by `g.copy(immutable=True)`\nsage: set([Graph(i, immutable=True) for i in range(5)])\n{Graph on 0 vertices,\n Graph on 1 vertex,\n Graph on 2 vertices,\n Graph on 3 vertices,\n Graph on 4 vertices}\n```\n\nThe aim of this ticket is to have the same for other objects, in particular vectors and matrices.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25509\n\n",
    "created_at": "2018-06-05T09:30:53Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Provide a simple (and generic) way to create immutable vectors and matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25272",
    "user": "https://github.com/mantepse"
}
```
CC:  @kliem

We currently have the following elegant way to produce immutable graphs:

```
sage: set([Graph(i) for i in range(5)])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: This graph is mutable, and thus not hashable. Create an immutable copy by `g.copy(immutable=True)`
sage: set([Graph(i, immutable=True) for i in range(5)])
{Graph on 0 vertices,
 Graph on 1 vertex,
 Graph on 2 vertices,
 Graph on 3 vertices,
 Graph on 4 vertices}
```

The aim of this ticket is to have the same for other objects, in particular vectors and matrices.

Issue created by migration from https://trac.sagemath.org/ticket/25509





---

archive/issue_comments_355877.json:
```json
{
    "body": "I propose a modification of the `vector` and `matrix` constructors to accept `immutable=Tre/False` as argument. The default behaviour (mutable output) stays the same.\n----\nNew commits:",
    "created_at": "2019-12-17T12:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355877",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

I propose a modification of the `vector` and `matrix` constructors to accept `immutable=Tre/False` as argument. The default behaviour (mutable output) stays the same.
----
New commits:



---

archive/issue_comments_355878.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-12-17T12:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355878",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_355879.json:
```json
{
    "body": "Changing keywords from \"\" to \"vector, matrix, immutable\".",
    "created_at": "2019-12-17T12:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355879",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

Changing keywords from "" to "vector, matrix, immutable".



---

archive/issue_comments_355880.json:
```json
{
    "body": "I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.\n\nAre there other examples (than graphs) that do it with keywords?",
    "created_at": "2019-12-17T14:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355880",
    "user": "https://github.com/kliem"
}
```

I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.

Are there other examples (than graphs) that do it with keywords?



---

archive/issue_comments_355881.json:
```json
{
    "body": "Replying to [comment:3 gh-kliem]:\n> I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.\n\nIt would avoid introducing a variable just to make this adjustment. This can simplify code by more than just one line. Consider, for example, list/set/dict comprehensions and compare\n\n```\nS = set()\nfor x in some_list:\n    v = vector(x)\n    v.set_immutable()\n    S.add(v)\n```\n\nto\n\n```\nS = set(vector(x, immutable=True) for x in some_list)\n```\n\n\n> Are there other examples (than graphs) that do it with keywords?\n\nI did a quick research. Apart from `Graph` and `DiGraph`, I found:\n- `Sequence` and `PolynomialSequence` having an `immutable=True/False` switch\n- `SimplicialComplex` accepts both `is_mutable` and `is_immutable`\n- `Constellation` accepts `mutable`.\n\nApart from `vector` and `matrix`, the only classes I found having a `set_immutable` method, but no corresponding switch in the constructor are the following:\n\n- the abstract classes `ClonableElement` and `Mutability`\n- `Matrix_cyclo_dense` and `LatinSquare`, passing the `set_immutable` command to its associated matrix\n- `ToricLattice_quotient_element`, having a `set_mutable` method, which \"does nothing, it is introduced for compatibility purposes only\".\n\nJust like `@`mantepse, I would prefer `vector` and `matrix` to have such switches. Is there a striking argument why they shouldn't?",
    "created_at": "2019-12-17T16:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355881",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

Replying to [comment:3 gh-kliem]:
> I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.

It would avoid introducing a variable just to make this adjustment. This can simplify code by more than just one line. Consider, for example, list/set/dict comprehensions and compare

```
S = set()
for x in some_list:
    v = vector(x)
    v.set_immutable()
    S.add(v)
```

to

```
S = set(vector(x, immutable=True) for x in some_list)
```


> Are there other examples (than graphs) that do it with keywords?

I did a quick research. Apart from `Graph` and `DiGraph`, I found:
- `Sequence` and `PolynomialSequence` having an `immutable=True/False` switch
- `SimplicialComplex` accepts both `is_mutable` and `is_immutable`
- `Constellation` accepts `mutable`.

Apart from `vector` and `matrix`, the only classes I found having a `set_immutable` method, but no corresponding switch in the constructor are the following:

- the abstract classes `ClonableElement` and `Mutability`
- `Matrix_cyclo_dense` and `LatinSquare`, passing the `set_immutable` command to its associated matrix
- `ToricLattice_quotient_element`, having a `set_mutable` method, which "does nothing, it is introduced for compatibility purposes only".

Just like `@`mantepse, I would prefer `vector` and `matrix` to have such switches. Is there a striking argument why they shouldn't?



---

archive/issue_comments_355882.json:
```json
{
    "body": "Thank you for implementing this. Personally, I have been missing this option several times and was surprised it did not exist.\n\nThe `vector` function has early returns that are not handled yet, so the `immutable` keyword is sometimes ignored. Moreover, the docstring should probably be of the form:\n\n```\n    - ``immutable`` -- boolean (default: ``False``); whether the result should be an immutable vector\n```\n",
    "created_at": "2019-12-17T21:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355882",
    "user": "https://github.com/mwageringel"
}
```

Thank you for implementing this. Personally, I have been missing this option several times and was surprised it did not exist.

The `vector` function has early returns that are not handled yet, so the `immutable` keyword is sometimes ignored. Moreover, the docstring should probably be of the form:

```
    - ``immutable`` -- boolean (default: ``False``); whether the result should be an immutable vector
```




---

archive/issue_comments_355883.json:
```json
{
    "body": "Thanks. Especially the example illustrated to me, why such a switch makes sense. Maybe you could add this example to the description of the ticket.\n\nI'm not into matrices or vectors too much (I never contributed to them). So if I'm going to agree to adding a switch, I want to know, that it is useful. I never had a striking reason against adding the `immutable` switch, but one needs at least one argument on the pro side as well (otherwise we could add tons of almost useless switches for very special cases).\n\nSome more remarks:\n- You should specify the error in the doctest:\n\n```diff\n-        sage: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).\n+        ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).\n```\n\n- Maybe you can simplify the construction\n\n```diff\n-    if kwds.pop('immutable', False):\n-        M = MatrixArgs(*args, **kwds).matrix()\n-        M.set_immutable()\n-        return M\n-\n-    return MatrixArgs(*args, **kwds).matrix()\n+    immutable = kwds.pop('immutable', False)\n+    M = MatrixArgs(*args, **kwds).matrix()\n+    if immutable:\n+        M.set_immutable()\n+    return M\n```\n\n  The reason I'm suggesting it: It is clearer, what the switch immutable does. It doesn't effect the construction of the matrix, it is just setting the matrix immutable, after the construction.\n- I find it strange, when the comments preceding examples end with `. ::`. However, it seems to work well with sphinx: http://doc.sagemath.org/html/en/reference/modules/sage/modules/free_module.html\n\nOtherwise, this looks fine modulo the changes suggested by Markus Wageringel. Maybe one could add tiny tests for each case of the early returns.\n\nReplying to [comment:4 nailuj]:\n> Replying to [comment:3 gh-kliem]:\n> > I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.\n> \n> It would avoid introducing a variable just to make this adjustment. This can simplify code by more than just one line. Consider, for example, list/set/dict comprehensions and compare\n> {{{\n> S = set()\n> for x in some_list:\n>     v = vector(x)\n>     v.set_immutable()\n>     S.add(v)\n> }}}\n> to\n> {{{\n> S = set(vector(x, immutable=True) for x in some_list)\n> }}}\n> \n> > Are there other examples (than graphs) that do it with keywords?\n> \n> I did a quick research. Apart from `Graph` and `DiGraph`, I found:\n> - `Sequence` and `PolynomialSequence` having an `immutable=True/False` switch\n> - `SimplicialComplex` accepts both `is_mutable` and `is_immutable`\n> - `Constellation` accepts `mutable`.\n> \n> Apart from `vector` and `matrix`, the only classes I found having a `set_immutable` method, but no corresponding switch in the constructor are the following:\n> \n> - the abstract classes `ClonableElement` and `Mutability`\n> - `Matrix_cyclo_dense` and `LatinSquare`, passing the `set_immutable` command to its associated matrix\n> - `ToricLattice_quotient_element`, having a `set_mutable` method, which \"does nothing, it is introduced for compatibility purposes only\".\n> \n> Just like `@`mantepse, I would prefer `vector` and `matrix` to have such switches. Is there a striking argument why they shouldn't?",
    "created_at": "2019-12-18T07:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355883",
    "user": "https://github.com/kliem"
}
```

Thanks. Especially the example illustrated to me, why such a switch makes sense. Maybe you could add this example to the description of the ticket.

I'm not into matrices or vectors too much (I never contributed to them). So if I'm going to agree to adding a switch, I want to know, that it is useful. I never had a striking reason against adding the `immutable` switch, but one needs at least one argument on the pro side as well (otherwise we could add tons of almost useless switches for very special cases).

Some more remarks:
- You should specify the error in the doctest:

```diff
-        sage: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).
+        ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).
```

- Maybe you can simplify the construction

```diff
-    if kwds.pop('immutable', False):
-        M = MatrixArgs(*args, **kwds).matrix()
-        M.set_immutable()
-        return M
-
-    return MatrixArgs(*args, **kwds).matrix()
+    immutable = kwds.pop('immutable', False)
+    M = MatrixArgs(*args, **kwds).matrix()
+    if immutable:
+        M.set_immutable()
+    return M
```

  The reason I'm suggesting it: It is clearer, what the switch immutable does. It doesn't effect the construction of the matrix, it is just setting the matrix immutable, after the construction.
- I find it strange, when the comments preceding examples end with `. ::`. However, it seems to work well with sphinx: http://doc.sagemath.org/html/en/reference/modules/sage/modules/free_module.html

Otherwise, this looks fine modulo the changes suggested by Markus Wageringel. Maybe one could add tiny tests for each case of the early returns.

Replying to [comment:4 nailuj]:
> Replying to [comment:3 gh-kliem]:
> > I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.
> 
> It would avoid introducing a variable just to make this adjustment. This can simplify code by more than just one line. Consider, for example, list/set/dict comprehensions and compare
> {{{
> S = set()
> for x in some_list:
>     v = vector(x)
>     v.set_immutable()
>     S.add(v)
> }}}
> to
> {{{
> S = set(vector(x, immutable=True) for x in some_list)
> }}}
> 
> > Are there other examples (than graphs) that do it with keywords?
> 
> I did a quick research. Apart from `Graph` and `DiGraph`, I found:
> - `Sequence` and `PolynomialSequence` having an `immutable=True/False` switch
> - `SimplicialComplex` accepts both `is_mutable` and `is_immutable`
> - `Constellation` accepts `mutable`.
> 
> Apart from `vector` and `matrix`, the only classes I found having a `set_immutable` method, but no corresponding switch in the constructor are the following:
> 
> - the abstract classes `ClonableElement` and `Mutability`
> - `Matrix_cyclo_dense` and `LatinSquare`, passing the `set_immutable` command to its associated matrix
> - `ToricLattice_quotient_element`, having a `set_mutable` method, which "does nothing, it is introduced for compatibility purposes only".
> 
> Just like `@`mantepse, I would prefer `vector` and `matrix` to have such switches. Is there a striking argument why they shouldn't?



---

archive/issue_comments_355884.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-12-18T07:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355884",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_355885.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-18T15:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355885",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355886.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355886",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_355887.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-28T17:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355887",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355888.json:
```json
{
    "body": "I made all the proposed adjustments. This should be ready for review.\n\nWhile working on the early returns, I noticed that `v = vector(R, w)` and `v = vector(w, R)` just output `w` if `R` is equal to `None` or `w.base_ring()`. As a consequence, all changes applied to `v` are also applied to `w`. Do you think this is the desired behaviour or should a ticket be opened to ask if this might be a bug?",
    "created_at": "2020-01-28T17:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355888",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

I made all the proposed adjustments. This should be ready for review.

While working on the early returns, I noticed that `v = vector(R, w)` and `v = vector(w, R)` just output `w` if `R` is equal to `None` or `w.base_ring()`. As a consequence, all changes applied to `v` are also applied to `w`. Do you think this is the desired behaviour or should a ticket be opened to ask if this might be a bug?



---

archive/issue_comments_355889.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-28T17:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355889",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_355890.json:
```json
{
    "body": "I don't feel very strongly about this point, but `mutable=False` seems like a more direct way (at least in english) than `immutable=True`: naming an option directly than by its negation seems more straightforward. Perhaps worth considering.\n\n**EDIT:** as pointed out, consistency is important and for graphs it looks like `immutable` already forces our hand. Changing all to `mutable` would be a different discussion and seems not worth it.",
    "created_at": "2020-01-28T21:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355890",
    "user": "https://github.com/nbruin"
}
```

I don't feel very strongly about this point, but `mutable=False` seems like a more direct way (at least in english) than `immutable=True`: naming an option directly than by its negation seems more straightforward. Perhaps worth considering.

**EDIT:** as pointed out, consistency is important and for graphs it looks like `immutable` already forces our hand. Changing all to `mutable` would be a different discussion and seems not worth it.



---

archive/issue_comments_355891.json:
```json
{
    "body": "Replying to [comment:12 nbruin]:\n> I don't feel very strongly about this point, but `mutable=False` seems like a more direct way (at least in english) than `immutable=True`: naming an option directly than by its negation seems more straightforward. Perhaps worth considering.\n\nI think it should be consistent with graphs (either way).",
    "created_at": "2020-01-28T21:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355891",
    "user": "https://github.com/mantepse"
}
```

Replying to [comment:12 nbruin]:
> I don't feel very strongly about this point, but `mutable=False` seems like a more direct way (at least in english) than `immutable=True`: naming an option directly than by its negation seems more straightforward. Perhaps worth considering.

I think it should be consistent with graphs (either way).



---

archive/issue_comments_355892.json:
```json
{
    "body": "Your missing the colons after `Traceback (most recent call last)` in the doctest. So there is a failing test.\n\nAlso I think, error message should not end with a period.\n\nI think returning `a` with `vector(a)` is definitely not the desired behavior. E.g. `list`, `matrix` and `graph` return a copy in this case. So one would expect `vector` to behave the same.",
    "created_at": "2020-01-29T07:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355892",
    "user": "https://github.com/kliem"
}
```

Your missing the colons after `Traceback (most recent call last)` in the doctest. So there is a failing test.

Also I think, error message should not end with a period.

I think returning `a` with `vector(a)` is definitely not the desired behavior. E.g. `list`, `matrix` and `graph` return a copy in this case. So one would expect `vector` to behave the same.



---

archive/issue_comments_355893.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-29T14:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355893",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355894.json:
```json
{
    "body": "Replying to [comment:14 gh-kliem]:\n> Your missing the colons after `Traceback (most recent call last)` in the doctest. So there is a failing test.\n\nThank you, I only tested the vector file. I fixed it.\n\n> Also I think, error message should not end with a period.\n\nCould you be more specific? I don't think I introduced any error message.\n\n> I think returning `a` with `vector(a)` is definitely not the desired behavior. E.g. `list`, `matrix` and `graph` return a copy in this case. So one would expect `vector` to behave the same.\n\nThanks!",
    "created_at": "2020-01-29T14:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355894",
    "user": "https://trac.sagemath.org/admin/accounts/users/nailuj"
}
```

Replying to [comment:14 gh-kliem]:
> Your missing the colons after `Traceback (most recent call last)` in the doctest. So there is a failing test.

Thank you, I only tested the vector file. I fixed it.

> Also I think, error message should not end with a period.

Could you be more specific? I don't think I introduced any error message.

> I think returning `a` with `vector(a)` is definitely not the desired behavior. E.g. `list`, `matrix` and `graph` return a copy in this case. So one would expect `vector` to behave the same.

Thanks!



---

archive/issue_comments_355895.json:
```json
{
    "body": "LGTM.",
    "created_at": "2020-01-29T15:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355895",
    "user": "https://github.com/kliem"
}
```

LGTM.



---

archive/issue_comments_355896.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-29T15:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355896",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_355897.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-31T23:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25272",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25272#issuecomment-355897",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
