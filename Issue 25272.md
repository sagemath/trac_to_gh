# Issue 25272: Provide a simple (and generic) way to create immutable vectors and matrices

Issue created by migration from Trac.

Original creator: mantepse

Original creation time: 2018-06-05 09:30:53

CC:  @kliem

We currently have the following elegant way to produce immutable graphs:

```
sage: set([Graph(i) for i in range(5)])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: This graph is mutable, and thus not hashable. Create an immutable copy by `g.copy(immutable=True)`
sage: set([Graph(i, immutable=True) for i in range(5)])
{Graph on 0 vertices,
 Graph on 1 vertex,
 Graph on 2 vertices,
 Graph on 3 vertices,
 Graph on 4 vertices}
```

The aim of this ticket is to have the same for other objects, in particular vectors and matrices.


---

Comment by nailuj created at 2019-12-17 12:38:01

I propose a modification of the `vector` and `matrix` constructors to accept `immutable=Tre/False` as argument. The default behaviour (mutable output) stays the same.
----
New commits:


---

Comment by nailuj created at 2019-12-17 12:38:01

Changing status from new to needs_info.


---

Comment by nailuj created at 2019-12-17 12:38:01

Changing keywords from "" to "vector, matrix, immutable".


---

Comment by @kliem created at 2019-12-17 14:07:10

I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.

Are there other examples (than graphs) that do it with keywords?


---

Comment by nailuj created at 2019-12-17 16:49:51

Replying to [comment:3 gh-kliem]:
> I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.

It would avoid introducing a variable just to make this adjustment. This can simplify code by more than just one line. Consider, for example, list/set/dict comprehensions and compare

```
S = set()
for x in some_list:
    v = vector(x)
    v.set_immutable()
    S.add(v)
```

to

```
S = set(vector(x, immutable=True) for x in some_list)
```


> Are there other examples (than graphs) that do it with keywords?

I did a quick research. Apart from `Graph` and `DiGraph`, I found:
- `Sequence` and `PolynomialSequence` having an `immutable=True/False` switch
- `SimplicialComplex` accepts both `is_mutable` and `is_immutable`
- `Constellation` accepts `mutable`.

Apart from `vector` and `matrix`, the only classes I found having a `set_immutable` method, but no corresponding switch in the constructor are the following:

- the abstract classes `ClonableElement` and `Mutability`
- `Matrix_cyclo_dense` and `LatinSquare`, passing the `set_immutable` command to its associated matrix
- `ToricLattice_quotient_element`, having a `set_mutable` method, which "does nothing, it is introduced for compatibility purposes only".

Just like `@`mantepse, I would prefer `vector` and `matrix` to have such switches. Is there a striking argument why they shouldn't?


---

Comment by @mwageringel created at 2019-12-17 21:49:54

Thank you for implementing this. Personally, I have been missing this option several times and was surprised it did not exist.

The `vector` function has early returns that are not handled yet, so the `immutable` keyword is sometimes ignored. Moreover, the docstring should probably be of the form:

```
    - ``immutable`` -- boolean (default: ``False``); whether the result should be an immutable vector
```



---

Comment by @kliem created at 2019-12-18 07:47:05

Thanks. Especially the example illustrated to me, why such a switch makes sense. Maybe you could add this example to the description of the ticket.

I'm not into matrices or vectors too much (I never contributed to them). So if I'm going to agree to adding a switch, I want to know, that it is useful. I never had a striking reason against adding the `immutable` switch, but one needs at least one argument on the pro side as well (otherwise we could add tons of almost useless switches for very special cases).

Some more remarks:
- You should specify the error in the doctest:

```diff
-        sage: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).
+        ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).
```

- Maybe you can simplify the construction

```diff
-    if kwds.pop('immutable', False):
-        M = MatrixArgs(*args, **kwds).matrix()
-        M.set_immutable()
-        return M
-
-    return MatrixArgs(*args, **kwds).matrix()
+    immutable = kwds.pop('immutable', False)
+    M = MatrixArgs(*args, **kwds).matrix()
+    if immutable:
+        M.set_immutable()
+    return M
```

  The reason I'm suggesting it: It is clearer, what the switch immutable does. It doesn't effect the construction of the matrix, it is just setting the matrix immutable, after the construction.
- I find it strange, when the comments preceding examples end with `. ::`. However, it seems to work well with sphinx: http://doc.sagemath.org/html/en/reference/modules/sage/modules/free_module.html

Otherwise, this looks fine modulo the changes suggested by Markus Wageringel. Maybe one could add tiny tests for each case of the early returns.

Replying to [comment:4 nailuj]:
> Replying to [comment:3 gh-kliem]:
> > I personally do not see the advantage to just setting the matrix/vector immutable, once I'm done modifying it.
> 
> It would avoid introducing a variable just to make this adjustment. This can simplify code by more than just one line. Consider, for example, list/set/dict comprehensions and compare
> {{{
> S = set()
> for x in some_list:
>     v = vector(x)
>     v.set_immutable()
>     S.add(v)
> }}}
> to
> {{{
> S = set(vector(x, immutable=True) for x in some_list)
> }}}
> 
> > Are there other examples (than graphs) that do it with keywords?
> 
> I did a quick research. Apart from `Graph` and `DiGraph`, I found:
> - `Sequence` and `PolynomialSequence` having an `immutable=True/False` switch
> - `SimplicialComplex` accepts both `is_mutable` and `is_immutable`
> - `Constellation` accepts `mutable`.
> 
> Apart from `vector` and `matrix`, the only classes I found having a `set_immutable` method, but no corresponding switch in the constructor are the following:
> 
> - the abstract classes `ClonableElement` and `Mutability`
> - `Matrix_cyclo_dense` and `LatinSquare`, passing the `set_immutable` command to its associated matrix
> - `ToricLattice_quotient_element`, having a `set_mutable` method, which "does nothing, it is introduced for compatibility purposes only".
> 
> Just like `@`mantepse, I would prefer `vector` and `matrix` to have such switches. Is there a striking argument why they shouldn't?


---

Comment by @kliem created at 2019-12-18 07:47:38

Changing status from needs_info to needs_work.


---

Comment by git created at 2019-12-18 15:29:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by git created at 2020-01-28 17:39:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nailuj created at 2020-01-28 17:56:28

I made all the proposed adjustments. This should be ready for review.

While working on the early returns, I noticed that `v = vector(R, w)` and `v = vector(w, R)` just output `w` if `R` is equal to `None` or `w.base_ring()`. As a consequence, all changes applied to `v` are also applied to `w`. Do you think this is the desired behaviour or should a ticket be opened to ask if this might be a bug?


---

Comment by nailuj created at 2020-01-28 17:56:28

Changing status from needs_work to needs_review.


---

Comment by nbruin created at 2020-01-28 21:01:19

I don't feel very strongly about this point, but `mutable=False` seems like a more direct way (at least in english) than `immutable=True`: naming an option directly than by its negation seems more straightforward. Perhaps worth considering.

**EDIT:** as pointed out, consistency is important and for graphs it looks like `immutable` already forces our hand. Changing all to `mutable` would be a different discussion and seems not worth it.


---

Comment by mantepse created at 2020-01-28 21:26:58

Replying to [comment:12 nbruin]:
> I don't feel very strongly about this point, but `mutable=False` seems like a more direct way (at least in english) than `immutable=True`: naming an option directly than by its negation seems more straightforward. Perhaps worth considering.

I think it should be consistent with graphs (either way).


---

Comment by @kliem created at 2020-01-29 07:18:00

Your missing the colons after `Traceback (most recent call last)` in the doctest. So there is a failing test.

Also I think, error message should not end with a period.

I think returning `a` with `vector(a)` is definitely not the desired behavior. E.g. `list`, `matrix` and `graph` return a copy in this case. So one would expect `vector` to behave the same.


---

Comment by git created at 2020-01-29 14:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nailuj created at 2020-01-29 14:31:20

Replying to [comment:14 gh-kliem]:
> Your missing the colons after `Traceback (most recent call last)` in the doctest. So there is a failing test.

Thank you, I only tested the vector file. I fixed it.

> Also I think, error message should not end with a period.

Could you be more specific? I don't think I introduced any error message.

> I think returning `a` with `vector(a)` is definitely not the desired behavior. E.g. `list`, `matrix` and `graph` return a copy in this case. So one would expect `vector` to behave the same.

Thanks!


---

Comment by @kliem created at 2020-01-29 15:58:09

LGTM.


---

Comment by @kliem created at 2020-01-29 15:58:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-31 23:49:58

Resolution: fixed
