# Issue 28301: Segfault for boolean evaluation of expression with assumptions

Issue created by migration from https://trac.sagemath.org/ticket/28538

Original creator: tmonteil

Original creation time: 2019-09-25 22:16:25

CC:  rws kcrisman

As reported on [this ask question](https://ask.sagemath.org/question/48058/stack-overflow-in-boolean-test/):


```
sage: x, y = var('x, y')
sage: assume(x>0)
sage: assume(y>0)
sage: bool(y*(x-y)==0)
```


leads to (on my computer 8.9.rc1):


```
;;;
;;; Detected access to protected memory, also kwown as 'bus or segmentation fault'.
;;; Jumping to the outermost toplevel prompt
;;;
```


or (as reported, on 8.8)


```
RuntimeError: ECL says: C-STACK overflow at size 1048576. Stack can probably be resized. Proceed with caution.
```


Exchanging `x` and `y` works correctly:


```
sage: x, y = var('x, y')
sage: assume(x>0)
sage: assume(y>0)
sage: bool(x*(y-x)==0)
False
```



---

Comment by charpent created at 2019-09-26 04:21:19

On 8.9.rc1+#28534 (Python 3-based), I get a lot of

```
;;;
;;; Detected access to protected memory, also kwown as 'bus or segmentation fault'.
;;; Jumping to the outermost toplevel prompt
;;;
```

and a Sage **crash**:

```
Process Sage erreur de segmentation
```


Nice one...


---

Comment by kcrisman created at 2019-09-26 11:49:19

I'm so sorry I just don't have time any more to track down as many of these (though once in a while I somehow make the time).  But I think the best thing to do is to do whatever bool does in Maxima-in-sage `sage -maxima` and then load exactly the packages preloaded by Sage - the complex domain is usually the most suspicious one on these fronts, though I have to say this is really puzzling.  I imagine `bool` calls a comparison with zero at some point in Maxima, though I don't recall any more because I wasn't involved with the comparison-with-zero code much.


---

Comment by nbruin created at 2019-09-26 17:46:39

In maxima:

```
domain: complex;
assume(x>0,y>0);
is(equal(y*(x-y),0));
```

replicates the crash. That's sufficient to report upstream. Perhaps they can fix it.


---

Comment by tmonteil created at 2019-09-26 19:53:46

Thanks for tracking, this is now tracked upstream as https://sourceforge.net/p/maxima/bugs/3583/


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by tmonteil created at 2020-08-14 10:01:01

Once #30063 will be merged, i will make a patch to doctest that ticket.


---

Comment by charpent created at 2020-08-14 12:57:57

Replying to [comment:10 tmonteil]:
> Once #30063 will be merged, i will make a patch to doctest that ticket.

The original problem seems fixed by #30063 :

```
sage: x, y = var('x, y') 
....: assume(x>0) 
....: assume(y>0) 
....: bool(y*(x-y)==0)                                                          
False
```


Testing it properly might be a bit tricky, tough...


---

Comment by tmonteil created at 2020-08-14 13:19:16

Replying to [comment:11 charpent]:
> Replying to [comment:10 tmonteil]:
> > Once #30063 will be merged, i will make a patch to doctest that ticket.
> 
> The original problem seems fixed by #30063 :

This is why i am waiting #30063 to be merged to add a doctest.

> {{{
> sage: x, y = var('x, y') 
> ....: assume(x>0) 
> ....: assume(y>0) 
> ....: bool(y*(x-y)==0)                                                          
> False
> }}}
> 
> Testing it properly might be a bit tricky, tough...

What is wrong with using the raw example ?


---

Comment by charpent created at 2020-08-14 13:29:51

Replying to [comment:12 tmonteil]:

[ Snip... ]
> > Testing it properly might be a bit tricky, tough...
> 
> What is wrong with using the raw example ?

Too special case... I am not sure what the original problem was.


---

Comment by tmonteil created at 2020-08-24 11:24:43

New commits:


---

Comment by tmonteil created at 2020-08-24 11:24:43

Changing status from new to needs_review.


---

Comment by tmonteil created at 2020-08-24 11:29:48

Replying to [comment:13 charpent]:
> Replying to [comment:12 tmonteil]:
> 
> [ Snip... ]
> > > Testing it properly might be a bit tricky, tough...
> > 
> > What is wrong with using the raw example ?
> 
> Too special case... I am not sure what the original problem was.

This is a Maxima bug, it was reported and fixed upstream. I do not have the skill to inspect further within Maxima source code, so this doctest is the best i can provide, and it corresponds to the reported bug. If someone could provide more doctests to surround the original problem more securely, i am all for it.


---

Comment by kcrisman created at 2020-08-24 15:30:20

I think that testing the original problem no longer leads to a segfault is fine.  I agree that this is all we can do if Maxima upstream fixed it and we don't really know what the issue was. (Though it looks like it was, again, our use of `domain:complex` that triggered it.)


---

Comment by slabbe created at 2020-08-26 12:26:30

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-08-26 12:26:30

Typo: `Chack -> Check`


---

Comment by git created at 2020-08-27 09:09:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2020-08-27 09:11:03

Fixed, thanks for pointing this !


---

Comment by tmonteil created at 2020-08-27 09:11:03

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-28 04:29:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-09-01 23:00:21

Resolution: fixed
