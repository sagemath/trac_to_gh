# Issue 28301: Segfault for boolean evaluation of expression with assumptions

archive/issues_028301.json:
```json
{
    "body": "CC:  @rwst @kcrisman\n\nAs reported on [this ask question](https://ask.sagemath.org/question/48058/stack-overflow-in-boolean-test/):\n\n\n```\nsage: x, y = var('x, y')\nsage: assume(x>0)\nsage: assume(y>0)\nsage: bool(y*(x-y)==0)\n```\n\n\nleads to (on my computer 8.9.rc1):\n\n\n```\n;;;\n;;; Detected access to protected memory, also kwown as 'bus or segmentation fault'.\n;;; Jumping to the outermost toplevel prompt\n;;;\n```\n\n\nor (as reported, on 8.8)\n\n\n```\nRuntimeError: ECL says: C-STACK overflow at size 1048576. Stack can probably be resized. Proceed with caution.\n```\n\n\nExchanging `x` and `y` works correctly:\n\n\n```\nsage: x, y = var('x, y')\nsage: assume(x>0)\nsage: assume(y>0)\nsage: bool(x*(y-x)==0)\nFalse\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28538\n\n",
    "created_at": "2019-09-25T22:16:25Z",
    "labels": [
        "symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Segfault for boolean evaluation of expression with assumptions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28301",
    "user": "tmonteil"
}
```
CC:  @rwst @kcrisman

As reported on [this ask question](https://ask.sagemath.org/question/48058/stack-overflow-in-boolean-test/):


```
sage: x, y = var('x, y')
sage: assume(x>0)
sage: assume(y>0)
sage: bool(y*(x-y)==0)
```


leads to (on my computer 8.9.rc1):


```
;;;
;;; Detected access to protected memory, also kwown as 'bus or segmentation fault'.
;;; Jumping to the outermost toplevel prompt
;;;
```


or (as reported, on 8.8)


```
RuntimeError: ECL says: C-STACK overflow at size 1048576. Stack can probably be resized. Proceed with caution.
```


Exchanging `x` and `y` works correctly:


```
sage: x, y = var('x, y')
sage: assume(x>0)
sage: assume(y>0)
sage: bool(x*(y-x)==0)
False
```


Issue created by migration from https://trac.sagemath.org/ticket/28538





---

archive/issue_comments_399696.json:
```json
{
    "body": "On 8.9.rc1+#28534 (Python 3-based), I get a lot of\n\n```\n;;;\n;;; Detected access to protected memory, also kwown as 'bus or segmentation fault'.\n;;; Jumping to the outermost toplevel prompt\n;;;\n```\n\nand a Sage **crash**:\n\n```\nProcess Sage erreur de segmentation\n```\n\n\nNice one...",
    "created_at": "2019-09-26T04:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399696",
    "user": "@EmmanuelCharpentier"
}
```

On 8.9.rc1+#28534 (Python 3-based), I get a lot of

```
;;;
;;; Detected access to protected memory, also kwown as 'bus or segmentation fault'.
;;; Jumping to the outermost toplevel prompt
;;;
```

and a Sage **crash**:

```
Process Sage erreur de segmentation
```


Nice one...



---

archive/issue_comments_399697.json:
```json
{
    "body": "I'm so sorry I just don't have time any more to track down as many of these (though once in a while I somehow make the time).  But I think the best thing to do is to do whatever bool does in Maxima-in-sage `sage -maxima` and then load exactly the packages preloaded by Sage - the complex domain is usually the most suspicious one on these fronts, though I have to say this is really puzzling.  I imagine `bool` calls a comparison with zero at some point in Maxima, though I don't recall any more because I wasn't involved with the comparison-with-zero code much.",
    "created_at": "2019-09-26T11:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399697",
    "user": "@kcrisman"
}
```

I'm so sorry I just don't have time any more to track down as many of these (though once in a while I somehow make the time).  But I think the best thing to do is to do whatever bool does in Maxima-in-sage `sage -maxima` and then load exactly the packages preloaded by Sage - the complex domain is usually the most suspicious one on these fronts, though I have to say this is really puzzling.  I imagine `bool` calls a comparison with zero at some point in Maxima, though I don't recall any more because I wasn't involved with the comparison-with-zero code much.



---

archive/issue_comments_399698.json:
```json
{
    "body": "In maxima:\n\n```\ndomain: complex;\nassume(x>0,y>0);\nis(equal(y*(x-y),0));\n```\n\nreplicates the crash. That's sufficient to report upstream. Perhaps they can fix it.",
    "created_at": "2019-09-26T17:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399698",
    "user": "@nbruin"
}
```

In maxima:

```
domain: complex;
assume(x>0,y>0);
is(equal(y*(x-y),0));
```

replicates the crash. That's sufficient to report upstream. Perhaps they can fix it.



---

archive/issue_comments_399699.json:
```json
{
    "body": "Thanks for tracking, this is now tracked upstream as https://sourceforge.net/p/maxima/bugs/3583/",
    "created_at": "2019-09-26T19:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399699",
    "user": "tmonteil"
}
```

Thanks for tracking, this is now tracked upstream as https://sourceforge.net/p/maxima/bugs/3583/



---

archive/issue_comments_399700.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399700",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_399701.json:
```json
{
    "body": "Once #30063 will be merged, i will make a patch to doctest that ticket.",
    "created_at": "2020-08-14T10:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399701",
    "user": "tmonteil"
}
```

Once #30063 will be merged, i will make a patch to doctest that ticket.



---

archive/issue_comments_399702.json:
```json
{
    "body": "Replying to [comment:10 tmonteil]:\n> Once #30063 will be merged, i will make a patch to doctest that ticket.\n\nThe original problem seems fixed by #30063 :\n\n```\nsage: x, y = var('x, y') \n....: assume(x>0) \n....: assume(y>0) \n....: bool(y*(x-y)==0)                                                          \nFalse\n```\n\n\nTesting it properly might be a bit tricky, tough...",
    "created_at": "2020-08-14T12:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399702",
    "user": "@EmmanuelCharpentier"
}
```

Replying to [comment:10 tmonteil]:
> Once #30063 will be merged, i will make a patch to doctest that ticket.

The original problem seems fixed by #30063 :

```
sage: x, y = var('x, y') 
....: assume(x>0) 
....: assume(y>0) 
....: bool(y*(x-y)==0)                                                          
False
```


Testing it properly might be a bit tricky, tough...



---

archive/issue_comments_399703.json:
```json
{
    "body": "Replying to [comment:11 charpent]:\n> Replying to [comment:10 tmonteil]:\n> > Once #30063 will be merged, i will make a patch to doctest that ticket.\n> \n> The original problem seems fixed by #30063 :\n\nThis is why i am waiting #30063 to be merged to add a doctest.\n\n> {{{\n> sage: x, y = var('x, y') \n> ....: assume(x>0) \n> ....: assume(y>0) \n> ....: bool(y*(x-y)==0)                                                          \n> False\n> }}}\n> \n> Testing it properly might be a bit tricky, tough...\n\nWhat is wrong with using the raw example ?",
    "created_at": "2020-08-14T13:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399703",
    "user": "tmonteil"
}
```

Replying to [comment:11 charpent]:
> Replying to [comment:10 tmonteil]:
> > Once #30063 will be merged, i will make a patch to doctest that ticket.
> 
> The original problem seems fixed by #30063 :

This is why i am waiting #30063 to be merged to add a doctest.

> {{{
> sage: x, y = var('x, y') 
> ....: assume(x>0) 
> ....: assume(y>0) 
> ....: bool(y*(x-y)==0)                                                          
> False
> }}}
> 
> Testing it properly might be a bit tricky, tough...

What is wrong with using the raw example ?



---

archive/issue_comments_399704.json:
```json
{
    "body": "Replying to [comment:12 tmonteil]:\n\n[ Snip... ]\n> > Testing it properly might be a bit tricky, tough...\n> \n> What is wrong with using the raw example ?\n\nToo special case... I am not sure what the original problem was.",
    "created_at": "2020-08-14T13:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399704",
    "user": "@EmmanuelCharpentier"
}
```

Replying to [comment:12 tmonteil]:

[ Snip... ]
> > Testing it properly might be a bit tricky, tough...
> 
> What is wrong with using the raw example ?

Too special case... I am not sure what the original problem was.



---

archive/issue_comments_399705.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-08-24T11:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399705",
    "user": "tmonteil"
}
```

New commits:



---

archive/issue_comments_399706.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-24T11:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399706",
    "user": "tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399707.json:
```json
{
    "body": "Replying to [comment:13 charpent]:\n> Replying to [comment:12 tmonteil]:\n> \n> [ Snip... ]\n> > > Testing it properly might be a bit tricky, tough...\n> > \n> > What is wrong with using the raw example ?\n> \n> Too special case... I am not sure what the original problem was.\n\nThis is a Maxima bug, it was reported and fixed upstream. I do not have the skill to inspect further within Maxima source code, so this doctest is the best i can provide, and it corresponds to the reported bug. If someone could provide more doctests to surround the original problem more securely, i am all for it.",
    "created_at": "2020-08-24T11:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399707",
    "user": "tmonteil"
}
```

Replying to [comment:13 charpent]:
> Replying to [comment:12 tmonteil]:
> 
> [ Snip... ]
> > > Testing it properly might be a bit tricky, tough...
> > 
> > What is wrong with using the raw example ?
> 
> Too special case... I am not sure what the original problem was.

This is a Maxima bug, it was reported and fixed upstream. I do not have the skill to inspect further within Maxima source code, so this doctest is the best i can provide, and it corresponds to the reported bug. If someone could provide more doctests to surround the original problem more securely, i am all for it.



---

archive/issue_comments_399708.json:
```json
{
    "body": "I think that testing the original problem no longer leads to a segfault is fine.  I agree that this is all we can do if Maxima upstream fixed it and we don't really know what the issue was. (Though it looks like it was, again, our use of `domain:complex` that triggered it.)",
    "created_at": "2020-08-24T15:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399708",
    "user": "@kcrisman"
}
```

I think that testing the original problem no longer leads to a segfault is fine.  I agree that this is all we can do if Maxima upstream fixed it and we don't really know what the issue was. (Though it looks like it was, again, our use of `domain:complex` that triggered it.)



---

archive/issue_comments_399709.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-26T12:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399709",
    "user": "@seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399710.json:
```json
{
    "body": "Typo: `Chack -> Check`",
    "created_at": "2020-08-26T12:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399710",
    "user": "@seblabbe"
}
```

Typo: `Chack -> Check`



---

archive/issue_comments_399711.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-27T09:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399711",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399712.json:
```json
{
    "body": "Fixed, thanks for pointing this !",
    "created_at": "2020-08-27T09:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399712",
    "user": "tmonteil"
}
```

Fixed, thanks for pointing this !



---

archive/issue_comments_399713.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-27T09:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399713",
    "user": "tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399714.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-28T04:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399714",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399715.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-01T23:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28301#issuecomment-399715",
    "user": "@vbraun"
}
```

Resolution: fixed
