# Issue 11938: [ARM] Singular 3-1-3-3.p1 doesn't compile as-is

archive/issues_011938.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nThe singular package in 4.7.2alpha4 doesn't compile because it lacks a simple switch in a compilation line.\n\nThe reason is that 3-1-3-3 still uses an organisation where you either have a known platform and hence get nice switches, or you're not -- and you get crap.\n\nIn fact, sage's spkg already adds forcefully a few \"-fPIC\" here and there that make things better.\n\nThe attached patch adds a \"-shared\" switch to LIBSINGULAR_FLAGS -- but it does so before that variable is overwritten by the good flags if the platform is known. That means it unbreaks my platform but doesn't break the others.\n\nI have an upstream ticket about singular on ARM here : http://www.singular.uni-kl.de:8002/trac/ticket/299\n\nIssue created by migration from https://trac.sagemath.org/ticket/12110\n\n",
    "created_at": "2011-12-03T09:16:01Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "[ARM] Singular 3-1-3-3.p1 doesn't compile as-is",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11938",
    "user": "Snark"
}
```
Assignee: GeorgSWeber

The singular package in 4.7.2alpha4 doesn't compile because it lacks a simple switch in a compilation line.

The reason is that 3-1-3-3 still uses an organisation where you either have a known platform and hence get nice switches, or you're not -- and you get crap.

In fact, sage's spkg already adds forcefully a few "-fPIC" here and there that make things better.

The attached patch adds a "-shared" switch to LIBSINGULAR_FLAGS -- but it does so before that variable is overwritten by the good flags if the platform is known. That means it unbreaks my platform but doesn't break the others.

I have an upstream ticket about singular on ARM here : http://www.singular.uni-kl.de:8002/trac/ticket/299

Issue created by migration from https://trac.sagemath.org/ticket/12110





---

archive/issue_comments_137132.json:
```json
{
    "body": "Replying to [ticket:12110 Snark]:\n\nYou have patched Singular.Makefile.in.debug.patch, but don't you also need to patch the non-debug Makefile?\n\nThen, this needs to be rebased for 4.8, as the patch to spkg-install does not apply any more.",
    "created_at": "2012-01-01T10:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137132",
    "user": "dimpase"
}
```

Replying to [ticket:12110 Snark]:

You have patched Singular.Makefile.in.debug.patch, but don't you also need to patch the non-debug Makefile?

Then, this needs to be rebased for 4.8, as the patch to spkg-install does not apply any more.



---

archive/issue_comments_137133.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2012-01-01T10:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137133",
    "user": "dimpase"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_137134.json:
```json
{
    "body": "I didn't need to patch the non-debug Makefile, so I don't see the point of patching it : upstream has so much better in store for the future that there's little incentive to make more than what is necessary.\n\nI'll provide a newer patch when I'll have seen the failure in 4.8alpha5.",
    "created_at": "2012-01-02T12:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137134",
    "user": "Snark"
}
```

I didn't need to patch the non-debug Makefile, so I don't see the point of patching it : upstream has so much better in store for the future that there's little incentive to make more than what is necessary.

I'll provide a newer patch when I'll have seen the failure in 4.8alpha5.



---

archive/issue_comments_137135.json:
```json
{
    "body": "Replying to [comment:2 Snark]:\n> \n> I'll provide a newer patch when I'll have seen the failure in 4.8alpha5.\n\nas I mentioned, your patch needs to be rebased, anyway, as Singular spkg has been updated in the meantime.\nIt might have become platform-specific, too.",
    "created_at": "2012-01-02T13:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137135",
    "user": "dimpase"
}
```

Replying to [comment:2 Snark]:
> 
> I'll provide a newer patch when I'll have seen the failure in 4.8alpha5.

as I mentioned, your patch needs to be rebased, anyway, as Singular spkg has been updated in the meantime.
It might have become platform-specific, too.



---

archive/issue_comments_137136.json:
```json
{
    "body": "Ok, here is a rebased patch, but it won't make singular compile : there are now unresolved symbols (omalloc symbols) everywhere... I'll investigate.",
    "created_at": "2012-01-03T06:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137136",
    "user": "Snark"
}
```

Ok, here is a rebased patch, but it won't make singular compile : there are now unresolved symbols (omalloc symbols) everywhere... I'll investigate.



---

archive/issue_comments_137137.json:
```json
{
    "body": "Hmmmm... it tries to use omalloc_ndebug, which doesn't have the right symbols:\n\n```\njpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc.a |grep omSetCustomOfTrackAddr\n000006f8 T omSetCustomOfTrackAddr\njpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc_ndebug.a |grep omSetCustomOfTrackAddr\njpuydt@hecke:~/sage-4.8.alpha5/local/lib$ \n```\n\nand:\n\n```\njpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc.a |grep _omDebugAlloc\n00000000 t __omDebugAlloc\n000003cc T _omDebugAlloc\njpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc_ndebug.a |grep _omDebugAlloc\njpuydt@hecke:~/sage-4.8.alpha5/local/lib$ \n```\n\nSigh. Here is how omDebug.c (where those are defined) is compiled for libomalloc.a:\n\n```\ngcc -O2 -g -fPIC -I. -I.. -I. -I/home/jpuydt/sage-4.8.alpha5/local -I.. -DHAVE_CONFIG_H -c omDebug.c\n```\n\nand here is how it is compiled for libomalloc_ndebug.a:\n\n```\ngcc -O2 -g -fPIC -I. -I.. -I. -I/home/jpuydt/sage-4.8.alpha5/local -I.. -DHAVE_CONFIG_H -DOM_NDEBUG -c omDebug.c -o omDebug.o_ndebug\n```\n\nand of course, almost all of omDebug.c is in a #ifndef OM_NDEBUG. That explains the break, but doesn't explain why it would compile on other platforms and not here!",
    "created_at": "2012-01-03T07:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137137",
    "user": "Snark"
}
```

Hmmmm... it tries to use omalloc_ndebug, which doesn't have the right symbols:

```
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc.a |grep omSetCustomOfTrackAddr
000006f8 T omSetCustomOfTrackAddr
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc_ndebug.a |grep omSetCustomOfTrackAddr
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ 
```

and:

```
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc.a |grep _omDebugAlloc
00000000 t __omDebugAlloc
000003cc T _omDebugAlloc
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc_ndebug.a |grep _omDebugAlloc
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ 
```

Sigh. Here is how omDebug.c (where those are defined) is compiled for libomalloc.a:

```
gcc -O2 -g -fPIC -I. -I.. -I. -I/home/jpuydt/sage-4.8.alpha5/local -I.. -DHAVE_CONFIG_H -c omDebug.c
```

and here is how it is compiled for libomalloc_ndebug.a:

```
gcc -O2 -g -fPIC -I. -I.. -I. -I/home/jpuydt/sage-4.8.alpha5/local -I.. -DHAVE_CONFIG_H -DOM_NDEBUG -c omDebug.c -o omDebug.o_ndebug
```

and of course, almost all of omDebug.c is in a #ifndef OM_NDEBUG. That explains the break, but doesn't explain why it would compile on other platforms and not here!



---

archive/issue_comments_137138.json:
```json
{
    "body": "Ok, I found the problem : now there is a kernel.Makefile.in.debug.patch, which shouldn't be applied unconditionally!",
    "created_at": "2012-01-03T08:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137138",
    "user": "Snark"
}
```

Ok, I found the problem : now there is a kernel.Makefile.in.debug.patch, which shouldn't be applied unconditionally!



---

archive/issue_comments_137139.json:
```json
{
    "body": "Attachment [singular-add-shared-switch.patch](tarball://root/attachments/some-uuid/ticket12110/singular-add-shared-switch.patch) by Snark created at 2012-01-03 09:57:06\n\nPatch to add -shared as a switch by default on unknown platforms",
    "created_at": "2012-01-03T09:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137139",
    "user": "Snark"
}
```

Attachment [singular-add-shared-switch.patch](tarball://root/attachments/some-uuid/ticket12110/singular-add-shared-switch.patch) by Snark created at 2012-01-03 09:57:06

Patch to add -shared as a switch by default on unknown platforms



---

archive/issue_comments_137140.json:
```json
{
    "body": "The new patch adds a new Singular.Makefile.in.shared.patch file to patches/, and applies it unconditionally. [Aside: in my previous comment, s/kernel/Singular/]\n\nIt compiles on my ARM box.",
    "created_at": "2012-01-03T09:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137140",
    "user": "Snark"
}
```

The new patch adds a new Singular.Makefile.in.shared.patch file to patches/, and applies it unconditionally. [Aside: in my previous comment, s/kernel/Singular/]

It compiles on my ARM box.



---

archive/issue_comments_137141.json:
```json
{
    "body": "Replying to [comment:7 Snark]:\n> The new patch adds a new Singular.Makefile.in.shared.patch file to patches/, and applies it unconditionally. [Aside: in my previous comment, s/kernel/Singular/]\n> \n> It compiles on my ARM box.\nThanks! With this patch, and the new flint spkg on #10328 provided by William, the build completes. As the system does not have readline-dev installed, the Ubuntu 11.10-specific bug does not materialize. I'm running \"make ptest\" now.\n\nSo the next step would be to make proper spkgs for Singular and for Flint...",
    "created_at": "2012-01-05T04:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137141",
    "user": "dimpase"
}
```

Replying to [comment:7 Snark]:
> The new patch adds a new Singular.Makefile.in.shared.patch file to patches/, and applies it unconditionally. [Aside: in my previous comment, s/kernel/Singular/]
> 
> It compiles on my ARM box.
Thanks! With this patch, and the new flint spkg on #10328 provided by William, the build completes. As the system does not have readline-dev installed, the Ubuntu 11.10-specific bug does not materialize. I'm running "make ptest" now.

So the next step would be to make proper spkgs for Singular and for Flint...



---

archive/issue_comments_137142.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-01-06T14:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137142",
    "user": "Snark"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_137143.json:
```json
{
    "body": "[singular-3-1-3-3.p3.spkg](http://dl.free.fr/v8jRhbQ8w) on my provider's big file service.",
    "created_at": "2012-01-06T14:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137143",
    "user": "Snark"
}
```

[singular-3-1-3-3.p3.spkg](http://dl.free.fr/v8jRhbQ8w) on my provider's big file service.



---

archive/issue_comments_137144.json:
```json
{
    "body": "New version of the spkg, which should be in a reviewable state (things are checked in, I added informations to SPKG.txt...) here : [singular-3-1-3-3.p3.spkg](http://dl.free.fr/f3VYupKCF)",
    "created_at": "2012-01-07T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137144",
    "user": "Snark"
}
```

New version of the spkg, which should be in a reviewable state (things are checked in, I added informations to SPKG.txt...) here : [singular-3-1-3-3.p3.spkg](http://dl.free.fr/f3VYupKCF)



---

archive/issue_comments_137145.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-08T11:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137145",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_137146.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-11T21:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11938#issuecomment-137146",
    "user": "jdemeyer"
}
```

Resolution: fixed
