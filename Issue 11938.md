# Issue 11938: [ARM] Singular 3-1-3-3.p1 doesn't compile as-is

Issue created by migration from https://trac.sagemath.org/ticket/12110

Original creator: Snark

Original creation time: 2011-12-03 09:16:01

Assignee: GeorgSWeber

The singular package in 4.7.2alpha4 doesn't compile because it lacks a simple switch in a compilation line.

The reason is that 3-1-3-3 still uses an organisation where you either have a known platform and hence get nice switches, or you're not -- and you get crap.

In fact, sage's spkg already adds forcefully a few "-fPIC" here and there that make things better.

The attached patch adds a "-shared" switch to LIBSINGULAR_FLAGS -- but it does so before that variable is overwritten by the good flags if the platform is known. That means it unbreaks my platform but doesn't break the others.

I have an upstream ticket about singular on ARM here : http://www.singular.uni-kl.de:8002/trac/ticket/299


---

Comment by dimpase created at 2012-01-01 10:25:55

Replying to [ticket:12110 Snark]:

You have patched Singular.Makefile.in.debug.patch, but don't you also need to patch the non-debug Makefile?

Then, this needs to be rebased for 4.8, as the patch to spkg-install does not apply any more.


---

Comment by dimpase created at 2012-01-01 10:25:55

Changing status from new to needs_info.


---

Comment by Snark created at 2012-01-02 12:40:26

I didn't need to patch the non-debug Makefile, so I don't see the point of patching it : upstream has so much better in store for the future that there's little incentive to make more than what is necessary.

I'll provide a newer patch when I'll have seen the failure in 4.8alpha5.


---

Comment by dimpase created at 2012-01-02 13:32:44

Replying to [comment:2 Snark]:
> 
> I'll provide a newer patch when I'll have seen the failure in 4.8alpha5.

as I mentioned, your patch needs to be rebased, anyway, as Singular spkg has been updated in the meantime.
It might have become platform-specific, too.


---

Comment by Snark created at 2012-01-03 06:08:30

Ok, here is a rebased patch, but it won't make singular compile : there are now unresolved symbols (omalloc symbols) everywhere... I'll investigate.


---

Comment by Snark created at 2012-01-03 07:45:16

Hmmmm... it tries to use omalloc_ndebug, which doesn't have the right symbols:

```
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc.a |grep omSetCustomOfTrackAddr
000006f8 T omSetCustomOfTrackAddr
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc_ndebug.a |grep omSetCustomOfTrackAddr
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ 
```

and:

```
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc.a |grep _omDebugAlloc
00000000 t __omDebugAlloc
000003cc T _omDebugAlloc
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ nm libomalloc_ndebug.a |grep _omDebugAlloc
jpuydt@hecke:~/sage-4.8.alpha5/local/lib$ 
```

Sigh. Here is how omDebug.c (where those are defined) is compiled for libomalloc.a:

```
gcc -O2 -g -fPIC -I. -I.. -I. -I/home/jpuydt/sage-4.8.alpha5/local -I.. -DHAVE_CONFIG_H -c omDebug.c
```

and here is how it is compiled for libomalloc_ndebug.a:

```
gcc -O2 -g -fPIC -I. -I.. -I. -I/home/jpuydt/sage-4.8.alpha5/local -I.. -DHAVE_CONFIG_H -DOM_NDEBUG -c omDebug.c -o omDebug.o_ndebug
```

and of course, almost all of omDebug.c is in a #ifndef OM_NDEBUG. That explains the break, but doesn't explain why it would compile on other platforms and not here!


---

Comment by Snark created at 2012-01-03 08:07:30

Ok, I found the problem : now there is a kernel.Makefile.in.debug.patch, which shouldn't be applied unconditionally!


---

Attachment

Patch to add -shared as a switch by default on unknown platforms


---

Comment by Snark created at 2012-01-03 09:59:50

The new patch adds a new Singular.Makefile.in.shared.patch file to patches/, and applies it unconditionally. [Aside: in my previous comment, s/kernel/Singular/]

It compiles on my ARM box.


---

Comment by dimpase created at 2012-01-05 04:49:40

Replying to [comment:7 Snark]:
> The new patch adds a new Singular.Makefile.in.shared.patch file to patches/, and applies it unconditionally. [Aside: in my previous comment, s/kernel/Singular/]
> 
> It compiles on my ARM box.
Thanks! With this patch, and the new flint spkg on #10328 provided by William, the build completes. As the system does not have readline-dev installed, the Ubuntu 11.10-specific bug does not materialize. I'm running "make ptest" now.

So the next step would be to make proper spkgs for Singular and for Flint...


---

Comment by Snark created at 2012-01-06 14:15:14

Changing status from needs_info to needs_review.


---

Comment by Snark created at 2012-01-06 14:15:14

[singular-3-1-3-3.p3.spkg](http://dl.free.fr/v8jRhbQ8w) on my provider's big file service.


---

Comment by Snark created at 2012-01-07 11:39:09

New version of the spkg, which should be in a reviewable state (things are checked in, I added informations to SPKG.txt...) here : [singular-3-1-3-3.p3.spkg](http://dl.free.fr/f3VYupKCF)


---

Comment by dimpase created at 2012-01-08 11:42:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-11 21:34:22

Resolution: fixed
