# Issue 20695: Incorrect generation of p1list in modular symbols

Issue created by migration from https://trac.sagemath.org/ticket/20932

Original creator: kedlaya

Original creation time: 2016-07-03 16:47:19

CC:  robharron

Keywords: modular symbols

Originally reported by robharron on sage-nt: [https://groups.google.com/forum/#!msg/sage-nt/5HYpZKFB2qA/fRXgDkaICAAJ](https://groups.google.com/forum/#!msg/sage-nt/5HYpZKFB2qA/fRXgDkaICAAJ).

```
sage: import sage.modular.modsym.p1list as p1list
sage: for (i,j) in p1list.P1List(103809):
sage:    if i != 1 and i != 3: print (i,j)
(0, 1) #should also return (34603, 1) and (34603, 2)
```



---

Comment by kedlaya created at 2016-07-03 16:49:23

In `p1list`, one finds different code depending on the size of the level. For levels in this range, the relevant subroutine is `p1list_llong`, which contains:

```
    cmax = N/2
    if N%2:   # N odd, max divisor is <= N/3
        if N%5:  # N not a multiple of 3 either, max is N/5
            cmax = N/5
        else:
            cmax = N/3
```

but `N%5` should be `N%3`.


---

Comment by kedlaya created at 2016-07-04 15:28:19

Re issue 2: the offending subroutine in `p1list` appears to be `c_p1_normalize_llong`, in which one finds:

```
    if compute_s:
        ss[0] = <int> (arith_llong.c_inverse_mod_longlong(s*min_t, N) % ll_N)
```

As written, this creates a 32-bit integer overflow. It should be:

```
    if compute_s:
        ss[0] = <int> (arith_llong.c_inverse_mod_longlong((<llong> s)*(<llong> min_t), N) % ll_N)
```



---

Comment by kedlaya created at 2016-07-04 20:34:32

Changing status from new to needs_review.


---

Comment by kedlaya created at 2016-07-04 20:34:32

This patch addresses both issues in the description. Besides doctesting the isolating code fragments, I added optional doctests for the construction of the spaces of modular symbols; however, these take far too long to be required even as long doctests.
----
New commits:


---

Comment by cremona created at 2016-07-10 21:05:12

Apologies for the typo which git blame attributes to me in April 2009.


---

Comment by vdelecroix created at 2016-07-25 01:45:44

The following syntax is wrong

```
+    TESTS::
+    
+    This test reflects :trac:`20932`::
+        sage: N = 3*61379
```

It should be changed to

```
    TESTS:    <--- only one colon

    This test reflects :trac`20932`::
                                         <--- line break
        sage: N = 3*61379
```



---

Comment by vdelecroix created at 2016-07-25 01:47:11

In the doctest you mention `:trac:`20513`` which is another matter.


---

Comment by vdelecroix created at 2016-07-25 01:47:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-25 21:58:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-07-25 21:59:41

Changing status from needs_work to needs_review.


---

Comment by kedlaya created at 2016-07-25 21:59:41

The formatting should be fixed now.


---

Comment by chapoton created at 2016-11-06 20:10:28

would it be possible to have faster (smaller) doctests ? 600s is too much and 1800s is *way* too much.. 

at worse, maybe keep only the 600s one..


---

Comment by kedlaya created at 2016-11-06 20:54:34

Replying to [comment:10 chapoton]:
> would it be possible to have faster (smaller) doctests ? 600s is too much and 1800s is *way* too much.. 
> 
> at worse, maybe keep only the 600s one..
 
Sadly no, this is precisely a bug that occurs only for large problem sizes (see comment 1), so any doctest that actually tests it will have to deal with large problems. Is it okay if all of the doctests that confirm the resolution of this issue are optional?


---

Comment by chapoton created at 2016-11-07 20:59:06

If you want these 2 **long** tests to be never tested, they should be tagged `# not tested`, I think. In principle, `optional` should come with a parameter (like spkg name on which it depends), and will be tested whenever possible. As far as I know, there is no bare `optional`.


---

Comment by git created at 2017-08-14 19:56:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-14 20:01:27

I rebased and marked the doctests as "not tested".


---

Comment by kedlaya created at 2017-08-14 20:01:27

Set assignee to kedlaya.


---

Comment by chapoton created at 2017-08-19 16:39:40

There still remains 2 very long tests in src/sage/modular/modsym/modsym.py. I guess they should also be marked as "not tested".


---

Comment by cremona created at 2017-08-19 16:51:22

Look, there was a bug (my old typo); it has been fixed; there are doctests to show this which are marked "not tested" for good reasons.  That should be enough for this to pass.  If there are issues with different doctests i nthis file that should be made into a separate issue.  So I am giving this a positive review.


---

Comment by cremona created at 2017-08-19 16:51:22

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-08-19 17:09:13

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-08-19 17:09:13

Changing status from positive_review to needs_review.


---

Comment by kedlaya created at 2017-08-19 17:10:41

Point taken, when I changed the two doctests in p1list.pyx I should have also touched modsym.py. This is now done, but someone other than me should set this back to positive review.


---

Comment by cremona created at 2017-08-19 17:23:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-08-21 19:24:09

Resolution: fixed
