# Issue 22727: k-regular sequences: boundedness

Issue created by migration from https://trac.sagemath.org/ticket/22964

Original creator: galipnik

Original creation time: 2017-05-09 22:18:58

CC:  dkrenn

Implement an algorithm to check whether a k-regular sequence is bounded.


---

Comment by dkrenn created at 2017-05-10 06:00:43

Replying to [comment:3 galipnik]:
> Branch set to u/galipnik/k-regular-bounded

It seems that this branch is not on the trac server (forgotten `git push`?)


---

Comment by git created at 2017-05-10 06:36:22

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by galipnik created at 2017-05-10 06:42:38

Replying to [comment:4 dkrenn]:
> It seems that this branch is not on the trac server (forgotten `git push`?)
Some troubles with SSH, should be fixed now.


---

Comment by git created at 2017-05-10 10:11:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-11 22:56:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-07-11 13:47:02

I understand that this is still work in progress and not ready for reviewing. However, to privide input early, here are some comments from my pre-review:

1. `tmp`: this (empty) directory seems to be added to the repository

k_regular_sequence.py:
2. L921 is_bounded: needs a docstring. As this is the main calling function,
  it should contain for sure some illustrative examples.
  A reference to the boundedness-file should also be given.
1. L1457: three newlines were added for no reason; delete them

k_regular_sequence_bounded.py:
4. everywhere: be consistent in the OUTPUT-block with full-stop at the end.
1. L4: I would here say something like

```
   "This module contains a collection
   of algorithms to check for boundedness".
```

  and then continue maybe with

```
   "This is done
    - based on eigenvalues and
    - by the criterion presented in [MS1977]."
```

1. L19: I think since some time now, we have a separate file for the actual
  references.
1. L35: Consider not using your student mail address as it will not be
  there forever...
1. L44: Rename to something with a more descriptive name (as it is not
  a private function), e.g.
   `multiply_and_reduce` or `multiply_reduce`
1. L44: maybe mention that this function is used in the `mandel_simon_algorithm`
1. L87: I think "Return the set `\phi(S)` as defined in [MS1977]." suffices.
1. L144: use `red_matrices` instead of `redMatrices`; the same for `redLength`.
  Camel-case is used only for class names.
1. L143+144: `length` is only used once and there it could be more Pythonic:
  `redMatrics = list(M.apply(...) for M in matrices)` 
1. construct_phi: I think it is more efficients if at the beginning each matrix
  in redMatrices is `set_immutable` and then a `set` is used instead of the list.
  This also would simplify the code:
  `redMatrice.update(red_mult(B, A) for A in redMatrices for B in matrices)`
1. L147: You can use `for counter in range(1000000): ... else: raise RuntimeError(...)`, which simplifies the code.
1. L159: a more descriptive (not code-technical descriptive) error message
  would be nice.
1. L162+168: `is_integer_valued` and `is_non_negative` need docstrings
1. L172: Maybe the name of this function should be altered to reflect what
  it does better: E.g. `is_bounded_via_mandel_simon_algorithm` or
  a shortened version of this or something similar.
1. L174: replace `special semigroup` by something that says a bit more, 
  e.g. {{{whether the semigroup of all possible products of ``matrices``
  is finite/bounded.}}}. In particular do not write
  `matrices in ``matrices```.
1. L185: Examples missing.
1. L192+194: delete debugging stuff
1. L195: I would raise a `ValueError('Not all matrix entries are nonnegative.')`
1. L198 (but already somewhere above a couple of times): Maybe break this too long line to make the PEP8-people happy.
1. L202: Maybe rename to `has_bounded_matrix_powers`. If so, an ALGORITHM-block could be included which says that the eigenvalues are used for this check.
1. L216: You can write normal text in between doctests, so no need to use comments by `#`.
1. L247: IMO the following is a bit cleaner:

```
    return all(abs(eVn[0]) < 1 or
               (abs(eVn[0]) == 1 and len(eVn[1]) == eVn[2])
               for mat in matrices
               for eVn in mat.eigenvectors_right())
```

1. L257: docstring is missing
1. L257: The following avoids using the index:

```
def do(mat):
        if is_non_negative(mat):
            return mat
        elif is_non_negative(-mat):
            return -mat
        else:
            raise ValueError('there is a matrix which is neither non-negative nor non-positive.')

return list(do(mat) for mat in matrices)
```

1. L274: full-stop missing
1. L275: I would delete this line, but add a note/comment after the OUTPUT-block
  that an exception may be raised (have a look in the developer guide on
  how the docstring should look like; there were some recent changes)
1. L279: `S` vs `seq`
1. L308: Code needs some cleanup.


---

Comment by galipnik created at 2017-07-11 21:09:34

Thank you very much for your precise comments!!!
Just some minor questions:

Replying to [comment:9 dkrenn]:
> 2. L921 is_bounded: needs a docstring. As this is the main calling function, it should contain for sure some illustrative examples. A reference to the boundedness-file should also be given.
Absolutely true. Are the same examples as in k_regular_sequence_is_bounded okay? 
> 6. L19: I think since some time now, we have a separate file for the actual
>   references.
What do you mean here?

> 11. L144: use `red_matrices` instead of `redMatrices`; the same for `redLength`.
>   Camel-case is used only for class names.
Sorry, but can't find the names in my code...
> 13. construct_phi: I think it is more efficients if at the beginning each matrix in redMatrices is `set_immutable` and then a `set` is used instead of the list. This also would simplify the code: `redMatrice.update(red_mult(B, A) for A in redMatrices for B in matrices)`
Absolutely true, but is there a possibility to multiply immutable matrices? 
> 16. L162+168: `is_integer_valued` and `is_non_negative` need docstrings
Also here: It seems that you do not have my lastest commits.
> 18. L174: replace `special semigroup` by something that says a bit more, 
>   e.g. {{{whether the semigroup of all possible products of ``matrices``
>   is finite/bounded.}}}. In particular do not write
>   `matrices in ``matrices```.
Also done in my latest commits.
> 21. L195: I would raise a `ValueError('Not all matrix entries are nonnegative.')`
Not sure where exactly do you mean (lines in lasts commits are different).
> 31. L308: Code needs some cleanup.
Also here not sure where exactly.

The rest is already or will be done and committed soon!
(No need for a new review by now, will soon be reviewed by me again.)


---

Comment by git created at 2017-07-11 21:51:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-11 22:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2017-07-14 16:52:46

Replying to [comment:10 galipnik]:
> > 13. construct_phi: I think it is more efficients if at the beginning each matrix in redMatrices is `set_immutable` and then a `set` is used instead of the list. This also would simplify the code: `redMatrice.update(red_mult(B, A) for A in redMatrices for B in matrices)`
> Absolutely true, but is there a possibility to multiply immutable matrices? 
After getting rid of the mutable/immutable troubles after multiplication (see ticket #23436) by hand, the following problem accured:

```
RuntimeError: Set changed size during iteration.
```

The set is updated by taking matrix A out of the set...


---

Comment by git created at 2017-10-09 23:31:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-09 23:49:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-09 23:53:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-11-12 18:39:39

Changing status from new to needs_review.


---

Comment by dkrenn created at 2017-11-12 18:42:23

general:

- new file `octave_workspace`

file `k_regular_sequence.py`:

- docstring of `is_bounded`
  - full stop at end of first line
  - I would delete `(if decidable with this implementation)`
  - delete INPUT-block
  - some SageMath-people would say that even an OUTPUT-block is not needed
    as it is clear from the one-line description that a boolean is returned.
  - Some lines are ended with a white space; delete this.
  - In the examples, when continuing a line, try to properly indent (e.g. look
    at the parentheses).
  - I would move the SEEALSO-block before the TESTS-block.

file `k_regular_sequence_bounded.py`

- everywhere: do not end lines with a white space
- L49: Add a empty line after the one-line description.
- L49: `Used in...` is not a proper sentence. Use e.g. `This function is used...`
- L95: indent
- I think `<BLANKLINE>` can be replaced by an actual blank line and the tests
  still pass.
- L251: Maybe put `using a criterion in [MS1977]` in an ALGORITHM-block
- L256: indent
- L288: `input` (small first letter)
- L313: ALGORTHIHM block should be after OUTPUT-block
- L321: EXAMPLES instead of TEST
- L323 and others: `max(abs(eigenvalues)) = 1, multiplicities okay:` If you
  write a text, then do it correctly. Do not indent it, and of you have pieces
  of code, then use ````.
- L362: full stop
- L427: Thue--Morse (use `--`); change this also in `k_regular_sequence.py`.


---

Comment by dkrenn created at 2017-11-12 18:43:20

Replying to [comment:13 galipnik]:
> Replying to [comment:10 galipnik]:
> > > 13. construct_phi: I think it is more efficients if at the beginning each matrix in redMatrices is `set_immutable` and then a `set` is used instead of the list. This also would simplify the code: `redMatrice.update(red_mult(B, A) for A in redMatrices for B in matrices)`
> > Absolutely true, but is there a possibility to multiply immutable matrices? 
> After getting rid of the mutable/immutable troubles after multiplication (see ticket #23436) by hand, the following problem accured:
> {{{
> RuntimeError: Set changed size during iteration.
> }}}
> The set is updated by taking matrix A out of the set...

I see. I think

```
redMatrice.update([red_mult(B, A) for A in redMatrices for B in matrices])
```

should work (making it a list (or tuple) before updating).


---

Comment by dkrenn created at 2017-11-12 18:44:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-04-06 16:22:08

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by galipnik created at 2018-04-06 22:39:53

Replying to [comment:18 dkrenn]:
>   - In the examples, when continuing a line, try to properly indent (e.g. look
>     at the parentheses).

What exactly do you mean here? Where for example?


---

Comment by galipnik created at 2018-04-06 23:01:13

Replying to [comment:18 dkrenn]:
> - L323 and others: `max(abs(eigenvalues)) = 1, multiplicities okay:` If you
>   write a text, then do it correctly. Do not indent it, and of you have pieces
>   of code, then use ````.
Okay, but what is a "piece of code" here?


---

Comment by galipnik created at 2018-04-06 23:10:56

Replying to [comment:18 dkrenn]:
> - I think `<BLANKLINE>` can be replaced by an actual blank line and the tests
>   still pass.
Doesn't work.


---

Comment by git created at 2018-04-06 23:49:50

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2018-04-06 23:57:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-04-09 20:59:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2018-04-09 21:02:06

Changing status from needs_work to needs_review.


---

Comment by galipnik created at 2018-04-09 21:03:22

Changing status from needs_review to needs_info.


---

Comment by dkrenn created at 2019-03-29 09:13:21

Merged 8.7 and dependencies.
----
New commits:


---

Comment by dkrenn created at 2019-03-29 09:14:11

Replying to [comment:22 galipnik]:
> Replying to [comment:18 dkrenn]:
> >   - In the examples, when continuing a line, try to properly indent (e.g. look
> >     at the parentheses).
> 
> What exactly do you mean here? Where for example?

Done in ||[1a184cd](https://git.sagemath.org/sage.git/commit?id=1a184cd82c81007412f4a281188b09a39b79d092)||`Trac #22964: intends`||


---

Comment by dkrenn created at 2019-03-29 09:16:12

Replying to [comment:23 galipnik]:
> Replying to [comment:18 dkrenn]:
> > - L323 and others: `max(abs(eigenvalues)) = 1, multiplicities okay:` If you
> >   write a text, then do it correctly. Do not indent it, and of you have pieces
> >   of code, then use ````.
> Okay, but what is a "piece of code" here?

Done in ||[ad29c70](https://git.sagemath.org/sage.git/commit?id=ad29c70e6419a981de8d1e11c2bc60b7843b4b99)||`Trac #22964: fix text between examples`||

(Pieces of code meant something like ```abs(x)=1``` within the text, ie code which is not evaluated. Rewritten anyways.)

There is one `multiplicites okay`, this is not clear to me what is meant. galipnik, can you change this?


---

Comment by dkrenn created at 2019-03-29 09:16:46

Both mentioned commits need a small cross review, but I think we are almost at a positive review.


---

Comment by dkrenn created at 2019-03-29 09:16:53

Changing status from needs_info to needs_review.


---

Comment by galipnik created at 2019-03-30 20:47:41

Last 10 new commits:


---

Comment by galipnik created at 2019-03-30 21:01:43

Replying to [comment:34 dkrenn]:
> Both mentioned commits need a small cross review, but I think we are almost at a positive review.

Thanks for your comments/commits! I have also modified the indents in the second file, see ||[6322a79](https://git.sagemath.org/sage.git/commit?id=6322a7920081359e153a0daa0b2fe5cb0c2a26f7)||`Trac #22964: intends also in other file`||

Furthermore, I have fixed a test case, changed one and modified the description concerning the multiplicities, see the last 4 commits

So this needs review again.


---

Comment by dkrenn created at 2019-04-02 11:58:01

Replying to [comment:37 galipnik]:
> Replying to [comment:34 dkrenn]:
> > Both mentioned commits need a small cross review, but I think we are almost at a positive review.
> 
> Thanks for your comments/commits! I have also modified the indents in the second file, see ||[6322a79](https://git.sagemath.org/sage.git/commit?id=6322a7920081359e153a0daa0b2fe5cb0c2a26f7)||`Trac #22964: intends also in other file`||
> 
> Furthermore, I have fixed a test case, changed one and modified the description concerning the multiplicities, see the last 4 commits
> 
> So this needs review again.

LGTM, so I guess, once the patchbot is happy (and once all dependencies are positive), this is a positive_review.
----
New commits:


---

Comment by heluani created at 2020-08-25 20:53:15

Changing status from needs_review to needs_work.


---

Comment by heluani created at 2020-08-25 20:53:15

red branch and also on its dependency.


---

Comment by git created at 2021-05-11 17:31:27

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dkrenn created at 2021-05-11 17:32:59

Changing status from needs_work to needs_info.


---

Comment by dkrenn created at 2021-05-11 17:32:59

Merged in its dependencies (also set them correctly in the ticket-field); now based on #21343 and [SageMath](SageMath) 9.3.


---

Comment by dkrenn created at 2021-05-11 17:34:39

Two failing doctests:

```
File "src/sage/combinat/k_regular_sequence_bounded.py", line 117, in sage.combinat.k_regular_sequence_bounded.construct_phi
Failed example:
    construct_phi(L)
Expected:
    [
    [2 2 1]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [1 2 2]  [2 2 2]  [2 0 2]
    [2 2 1]  [2 1 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]
    [0 0 1], [2 1 2], [2 2 2], [0 1 2], [2 0 2], [2 2 2], [0 0 1], [2 1 2],
    <BLANKLINE>
    [2 1 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 1 1]  [2 2 2]  [0 1 1]  [2 1 0]
    [2 2 2]  [1 2 2]  [2 2 2]  [2 2 2]  [1 2 1]  [2 1 2]  [2 1 1]  [2 0 1]
    [2 2 2], [1 2 2], [1 2 2], [2 1 2], [0 1 2], [2 0 2], [1 2 2], [0 0 1]
    ]
Got:
    [
    [2 2 1]  [1 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 0 2]  [2 2 2]
    [2 2 1]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 1 2]
    [0 0 1], [2 2 2], [2 2 2], [0 1 2], [2 0 2], [0 0 1], [2 1 2], [2 1 2],
    <BLANKLINE>
    [2 1 2]  [2 2 2]  [2 2 2]  [2 2 2]  [2 1 1]  [2 2 2]  [0 1 1]  [2 1 0]
    [2 2 2]  [1 2 2]  [2 2 2]  [2 2 2]  [1 2 1]  [2 1 2]  [2 1 1]  [2 0 1]
    [2 2 2], [1 2 2], [1 2 2], [2 1 2], [0 1 2], [2 0 2], [1 2 2], [0 0 1]
    ]
**********************************************************************
File "src/sage/combinat/k_regular_sequence_bounded.py", line 133, in sage.combinat.k_regular_sequence_bounded.construct_phi
Failed example:
    construct_phi(L)
Expected:
    [
    [2 1 0]  [2 2 2]  [2 1 2]  [2 2 0]  [2 2 2]  [2 2 2]  [2 0 2]  [2 2 0]
    [2 0 0]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]  [0 2 0]  [2 2 2]  [2 2 2]
    [2 0 2], [2 2 2], [2 1 0], [2 2 0], [2 0 0], [0 0 2], [2 2 2], [2 2 2],
    <BLANKLINE>
    [1 2 2]  [2 0 2]  [2 1 2]  [2 2 2]  [0 2 2]  [2 2 0]  [2 2 2]  [2 0 2]
    [2 2 2]  [2 2 0]  [0 2 1]  [2 2 2]  [2 2 2]  [2 2 0]  [0 2 2]  [2 1 0]
    [1 0 0], [2 2 2], [2 2 2], [2 0 2], [2 2 2], [2 2 2], [2 2 2], [2 1 2],
    <BLANKLINE>
    [2 1 2]  [2 2 2]  [2 2 2]  [2 2 2]  [0 1 2]  [2 2 2]  [1 2 2]  [2 2 0]
    [2 0 2]  [2 2 2]  [2 2 0]  [2 0 0]  [2 1 0]  [2 2 2]  [0 2 2]  [2 0 2]
    [2 2 2], [2 1 0], [2 2 0], [2 2 2], [2 2 2], [0 1 2], [2 2 2], [2 0 0],
    <BLANKLINE>
    [2 2 2]  [2 2 2]  [2 2 2]  [2 1 0]  [2 2 2]  [2 2 2]  [2 2 2]  [2 2 2]
    [2 2 2]  [2 2 0]  [1 2 2]  [0 0 2]  [2 0 0]  [2 2 2]  [0 1 2]  [2 2 2]
    [2 1 2], [2 2 2], [2 2 2], [0 1 0], [2 0 2], [0 2 1], [2 2 2], [2 2 0],
    <BLANKLINE>
    [2 2 2]  [2 2 2]  [2 2 2]  [0 2 1]  [2 2 2]  [2 2 2]  [2 2 2]
    [2 0 2]  [0 0 2]  [2 2 2]  [1 0 0]  [2 0 2]  [2 1 2]  [2 2 2]
    [2 2 2], [0 2 0], [0 2 2], [1 1 2], [2 0 0], [2 2 2], [1 2 2]
    ]
Got:
    [
    [2 1 0]  [2 2 2]  [2 1 2]  [2 2 2]  [2 2 2]  [2 0 2]  [1 2 2]  [2 1 2]
    [2 0 0]  [2 2 2]  [2 2 2]  [2 2 2]  [0 2 0]  [2 2 2]  [2 2 2]  [0 2 1]
    [2 0 2], [2 2 2], [2 1 0], [2 0 0], [0 0 2], [2 2 2], [1 0 0], [2 2 2],
    <BLANKLINE>
    [2 2 2]  [2 2 2]  [2 2 0]  [2 2 2]  [0 2 2]  [2 0 2]  [2 1 2]  [2 2 2]
    [0 1 2]  [2 2 2]  [2 2 0]  [0 2 2]  [2 2 2]  [2 1 0]  [2 0 2]  [2 2 2]
    [2 2 2], [2 0 2], [2 2 2], [2 2 2], [2 2 2], [2 1 2], [2 2 2], [2 1 0],
    <BLANKLINE>
    [2 2 2]  [2 2 0]  [2 2 2]  [0 1 2]  [2 2 2]  [1 2 2]  [2 2 0]  [2 2 2]
    [2 2 0]  [2 2 2]  [2 0 0]  [2 1 0]  [2 2 2]  [0 2 2]  [2 0 2]  [2 2 2]
    [2 2 0], [2 2 0], [2 2 2], [2 2 2], [0 1 2], [2 2 2], [2 0 0], [2 1 2],
    <BLANKLINE>
    [2 2 0]  [2 2 2]  [2 2 2]  [2 1 0]  [2 2 2]  [2 2 2]  [2 2 2]  [2 0 2]
    [2 2 2]  [2 2 0]  [1 2 2]  [0 0 2]  [2 0 0]  [2 2 2]  [2 2 2]  [2 2 0]
    [2 2 2], [2 2 2], [2 2 2], [0 1 0], [2 0 2], [0 2 1], [2 2 0], [2 2 2],
    <BLANKLINE>
    [2 2 2]  [2 2 2]  [2 2 2]  [0 2 1]  [2 2 2]  [2 2 2]  [2 2 2]
    [2 0 2]  [0 0 2]  [2 2 2]  [1 0 0]  [2 0 2]  [2 1 2]  [2 2 2]
    [2 2 2], [0 2 0], [0 2 2], [1 1 2], [2 0 0], [2 2 2], [1 2 2]
    ]
```

`@`galipnik, any ideas what is going on here?


---

Comment by git created at 2021-06-29 17:11:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-06-29 17:14:29

Changing status from needs_info to needs_review.


---

Comment by dkrenn created at 2021-06-29 17:14:29

The open issue seems to be cause by some change due to handling the elements in a set or the elements hashing value. I've changed (updated) the order of the output. Please cross review these changes.


---

Comment by git created at 2022-01-05 21:55:03

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
