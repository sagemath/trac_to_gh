# Issue 13804: Some R packages no longer can  be installed

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2013-01-24 23:34:07

Assignee: jason

CC:  kcrisman

Keywords: r-project

(At least) some R packages can no longer be installed.

This is due to upstream's change of management of "lazy loading" : some packages version available through default repositories now expect to use this new mecaism, which is not available in R 2.14.0.

The best solution is probably to update the R version shipping with Sage. I have packaged  and tested it, but my solution is not yet complete : "make ptestlong" gives me two (expectable failures) :



```
sage -t  --long -force_lib devel/sage/sage/interfaces/r.py
**********************************************************************
File "/home/sage/sage-5.6/devel/sage-main/sage/interfaces/r.py", line 555:
    sage: r.version()
Expected:
    ((2, 14, 0), 'R version 2.14.0 (2011-10-31)')
Got:
    ((2, 15, 2), 'R version 2.15.2 (2012-10-26)')
**********************************************************************
File "/home/sage/sage-5.6/devel/sage-main/sage/interfaces/r.py", line 2049:
    sage: r.version()
Expected:
    ((2, 14, 0), 'R version 2.14.0 (2011-10-31)')
Got:
    ((2, 15, 2), 'R version 2.15.2 (2012-10-26)')
**********************************************************************
2 items had failures:
   1 of   4 in __main__.example_16
   1 of   4 in __main__.example_80
***Test Failed*** 2 failures.
```


which I do not know (yet) how to fix, because they involve patching doctests for r.py. Any pointer would be appreciated.


---

Comment by jason created at 2013-01-24 23:42:19

(Brief pointer; post if this doesn't make sense...)

Update the tests in SAGE_ROOT/devel/sage/sage/interfaces/r.py and then run `sage -hg commit` and then `sage -hg export tip > trac-14008.patch` and attach the resulting file.


---

Attachment

diff between 2.14.0.p6 and 2.15.2.p0 source trees fo r spkg


---

Comment by charpent created at 2013-01-24 23:59:56

Replying to [comment:1 jason]:
> (Brief pointer; post if this doesn't make sense...)
> 
> Update the tests in SAGE_ROOT/devel/sage/sage/interfaces/r.py and then run `sage -hg commit` and then `sage -hg export tip > trac-14008.patch` and attach the resulting file.

Thanks. This make sense and I will do that, but I'll first have to create a branch... Not until tomorrow (RealLife(TM) again...).


---

Comment by jason created at 2013-01-25 00:04:49

You don't have to create a branch if you don't want.


---

Comment by kcrisman created at 2013-01-25 02:29:00


```
reoved
```

?

Also, maybe the formatting of SPKG.txt is just slightly off...

So ... it sounds like even with this `r.install_package()` wouldn't work for all packages?  (Or any?)  Or am I misunderstanding things?


---

Comment by kcrisman created at 2013-01-25 02:29:33

Replying to [comment:3 jason]:
> You don't have to create a branch if you don't want.

Totally.


---

Comment by dimpase created at 2013-01-25 03:34:47

And where is the new spkg? Can you upload it somewhere? Thanks!


---

Comment by dimpase created at 2013-01-25 03:35:42

Changing assignee from jason to tbd.


---

Comment by dimpase created at 2013-01-25 03:35:42

Changing priority from minor to major.


---

Comment by dimpase created at 2013-01-25 03:35:42

Changing component from misc to packages.


---

Comment by dimpase created at 2013-01-25 03:35:42

Changing type from defect to enhancement.


---

Comment by charpent created at 2013-01-25 11:31:28

Replying to [comment:6 dimpase]:
> And where is the new spkg? Can you upload it somewhere? Thanks!

Try http://dl.free.fr/fVPIHKbzO .

Sorry for the inconvenience : I didn't know that the trac server did not accept large files, and I had to jury-rig this a bit quickly...

A formal patch is on its way (I botched my first attempt by recompiling my modified sage too early, and I have to go back...).


---

Attachment

Patch reflecting new R version in r.py's doctests


---

Comment by charpent created at 2013-01-25 13:57:41

Patch uploaded. With the new spkg (to be found at http://dl.free.fr/fVPIHKbzO), this should go to "needs review", no ? Should I do this status change ?


---

Comment by dimpase created at 2013-01-25 14:08:21

Replying to [comment:10 charpent]:
> Patch uploaded. With the new spkg (to be found at http://dl.free.fr/fVPIHKbzO), this should go to "needs review", no ? Should I do this status change ?

I tried to download the spkg, but I keep getting a corrupt file (and it goes veeeery slow too). Could you upload it to a more reasonable hosting place? 

 * One option is to use http://code.google.com/p/spkg-upload/
 * Another option is to ask for an account on the UW sage cluster (write directly to William). 
 * You might also try Dropbox or Google Drive, I think they are much faster than free.fr...


---

Comment by charpent created at 2013-01-25 15:37:52

spkg-upload is out of commission (my email to get upload credentials bounced). I have but it there : https://docs.google.com/file/d/0B1gfn4_V_wm3bHVqN3dMbzF4SGs/edit .

Hoping that this will be more efficient...


---

Comment by dimpase created at 2013-01-25 16:03:31

Changing status from new to needs_review.


---

Comment by dimpase created at 2013-01-25 16:03:31

Replying to [comment:12 charpent]:
> spkg-upload is out of commission (my email to get upload credentials bounced).

try `mvngu dot name СОБАКА(as we call this symbol in Russian) gmail dot com`

 I have but it there : https://docs.google.com/file/d/0B1gfn4_V_wm3bHVqN3dMbzF4SGs/edit .

This kind of URL won't do as the parameter of `sage -f`

I've uploaded your file to the following location: http://boxen.math.washington.edu/home/dima/packages/r-2.15.2.p0.spkg


---

Comment by dimpase created at 2013-01-25 16:05:19

Replying to [comment:12 charpent]:
> spkg-upload is out of commission (my email to get upload credentials bounced). 

just got a reply from the maintainer of http://code.google.com/p/spkg-upload/
He's updated the email there (to the one I gave here already :))


---

Comment by dimpase created at 2013-01-26 04:50:09

Could you provide examples related to R packages which this is supposed to fix?
(Even better, doctests, perhaps optional)


---

Comment by charpent created at 2013-01-26 10:45:09

Replying to [comment:15 dimpase]:

> Could you provide examples related to R packages which this is supposed to fix? (Even better, doctests, perhaps optional)

An example is easy (but dangerous, see below), a doctest is not : installing an R package is *supposed* to have a *permanent* effect on the state of the installed system (an installed package stays installed between sessions). This, as far as I can tell, cannot be checked in a doctest.

Furthermore, a newly installed R package needs a restart of Sage to be usable (or so says the final message given by r.install.packages()).

An example is trivial : take example given for r.install_package(, which installs the R aami package). But :

 * the side effect is to have the R package aami permanently installed, which is not necessarily a Good Thing(TM).
 * if aami is already installed in the user's system, the example will fail.

One could implement the following pseudocode :


```
if (aami is installed) {
	uninstall it
	demonstrate the uninstallation
	reinstall it
	demonstrate the installation
} else {
	install it
	demonstrate the installation
	uninstall it
	demonstrate the uninstallation
}

```

But this might be a bit contrived for an example, no ?

An example which demonstrates the usefulness of this newer R version is to install the R package coda, I couldn't do that with sage 5.6 and R 2.14.0, I can do that with sage 5.6 and R 2.15.2.

HTH,


---

Comment by dimpase created at 2013-01-26 11:55:34

looks good.


---

Comment by dimpase created at 2013-01-26 11:55:34

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2013-01-26 15:31:54

> Furthermore, a newly installed R package needs a restart of Sage to be usable (or so says the final message given by r.install.packages()).
> 

Somewhere I have a new doctest or something... some ticket talks about this.  I have tried many times, and I am convinced the restart is not necessary and we just added that message "to be sure".


---

Comment by charpent created at 2013-01-26 17:58:01

Thanks to all people who guided my first (stumbling) steps in Sage maintenance and coped with somewhat stupid-in-hinsight questions.


---

Comment by charpent created at 2013-01-26 18:01:37

Replying to [comment:18 kcrisman]:
> > Furthermore, a newly installed R package needs a restart of Sage to be usable (or so says the final message given by r.install.packages()).
> > 
> 
> Somewhere I have a new doctest or something... some ticket talks about this.  I have tried many times, and I am convinced the restart is not necessary and we just added that message "to be sure".

This is consonant with my (limited) trials in Sage and my (somewhat more extensive) R experience. In less busy times, I'll have a look into this... But I have other fishes to fry first.


---

Comment by jdemeyer created at 2013-01-26 22:22:23

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-26 22:22:23

There are a few administrative issues with your package:
 1. `SPKG.txt` mentions the deleted patch `install_parallel.patch` in the section "`Special Update/Build Instructions`", simply remove that item.
 1. The Changelog header should be

```
### r-2.15.2.p0 (Emmanuel Charpentier, 25 January 2013)
```

 1. You should commit (`hg rm patches/install_parallel.patch` and `hg commit`) the changes, `hg status` now reports

```
M SPKG.txt
! patches/install_parallel.patch
```

when it should report nothing.


---

Comment by dimpase created at 2013-01-27 03:20:44

updated the spkg to take care of the admin issues.


---

Comment by dimpase created at 2013-01-27 03:20:44

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-01-30 07:36:26

Resolution: fixed
