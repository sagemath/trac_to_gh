# Issue 13962: use "cp -pR", not "cp -pr"

archive/issues_013962.json:
```json
{
    "body": "Assignee: @nexttime\n\nKeywords: cp symlink\n\nAccording to [http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Limitations-of-Usual-Tools.html#Limitations-of-Usual-Tools](http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Limitations-of-Usual-Tools.html#Limitations-of-Usual-Tools), we should avoid the \"-r\" flag for `cp`. On linux, using \"-r\" or \"-R\" doesn't make a difference, but on OS X, the man page for cp says that with the -r flag, \"it does not correctly copy special files, symbolic links, or fifo's.\"\n\nAs a result, after building from scratch using #6495 on OS X, the various files `doc/en/reference/MODULE/conf.py`, which are all supposed to by symlinks to `doc/en/reference/conf_sub.py`, are copies of that file instead, and the hg repo is not clean. So I'm marking this as a blocker. I think that to fix the real problem, only the Sage library needs to be patched, but we might as well apply the scripts patch as well. I think that the only other instance of \"cp -pr\" in any spkg is in the R spkg, and I don't think those instances are worth fixing right now.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14166\n\n",
    "created_at": "2013-02-22T20:01:23Z",
    "labels": [
        "component: scripts",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.8",
    "title": "use \"cp -pR\", not \"cp -pr\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13962",
    "user": "https://github.com/jhpalmieri"
}
```
Assignee: @nexttime

Keywords: cp symlink

According to [http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Limitations-of-Usual-Tools.html#Limitations-of-Usual-Tools](http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Limitations-of-Usual-Tools.html#Limitations-of-Usual-Tools), we should avoid the "-r" flag for `cp`. On linux, using "-r" or "-R" doesn't make a difference, but on OS X, the man page for cp says that with the -r flag, "it does not correctly copy special files, symbolic links, or fifo's."

As a result, after building from scratch using #6495 on OS X, the various files `doc/en/reference/MODULE/conf.py`, which are all supposed to by symlinks to `doc/en/reference/conf_sub.py`, are copies of that file instead, and the hg repo is not clean. So I'm marking this as a blocker. I think that to fix the real problem, only the Sage library needs to be patched, but we might as well apply the scripts patch as well. I think that the only other instance of "cp -pr" in any spkg is in the R spkg, and I don't think those instances are worth fixing right now.

Issue created by migration from https://trac.sagemath.org/ticket/14166





---

archive/issue_comments_174006.json:
```json
{
    "body": "scripts repo",
    "created_at": "2013-02-22T20:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174006",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo



---

archive/issue_comments_174007.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-22T20:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174007",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_174008.json:
```json
{
    "body": "Attachment [trac_14166-scripts.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-scripts.patch) by @jhpalmieri created at 2013-02-22 20:03:07",
    "created_at": "2013-02-22T20:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174008",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_14166-scripts.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-scripts.patch) by @jhpalmieri created at 2013-02-22 20:03:07



---

archive/issue_comments_174009.json:
```json
{
    "body": "On Solaris, things are more complicated. If we use `cp -pr`, then it behaves like OS X, i.e., badly. If we use `cp -pR`, then it still doesn't work; instead, `cp -pPR` almost works. The only problem is that file permissions can get messed up, at least when a file in one directory is a link pointing to another directory. Consider this directory TEST:\n\n```\n$ ls -l TEST/\ntotal 6\ndrwxr-xr-x   2 palmieri other          3 Feb 25 04:07 dir/\n-rw-r--r--   1 palmieri other         79 Feb 24 21:13 FILE\nlrwxrwxrwx   1 palmieri other          4 Feb 25 04:06 link1 -> FILE\n$ ls -l TEST/dir/\ntotal 1\nlrwxrwxrwx   1 palmieri other          4 Feb 25 04:07 link2 -> FILE\n```\n\nNow copy it:\n\n```\n$ cp -pPR TEST X\n$ ls -l X\ntotal 6\ndrwxr-xr-x   2 palmieri other          3 Feb 25 04:07 dir/\n-rwxrwxrwx   1 palmieri other         79 Feb 25 04:06 FILE*\nlrwxrwxrwx   1 palmieri other          4 Feb 25 04:08 link1 -> FILE*\n$ ls -l X/dir\ntotal 1\nlrwxrwxrwx   1 palmieri other          4 Feb 25 04:08 link2 -> FILE\n```\n\nNote the permissions on FILE. The way around this seems to be to use `/usr/xpg4/bin/cp -pPR`@` SOURCE TARGET`, naturally.\n\nLet's ignore the scripts patch and just focus on the patch for the Sage library.",
    "created_at": "2013-02-25T04:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174009",
    "user": "https://github.com/jhpalmieri"
}
```

On Solaris, things are more complicated. If we use `cp -pr`, then it behaves like OS X, i.e., badly. If we use `cp -pR`, then it still doesn't work; instead, `cp -pPR` almost works. The only problem is that file permissions can get messed up, at least when a file in one directory is a link pointing to another directory. Consider this directory TEST:

```
$ ls -l TEST/
total 6
drwxr-xr-x   2 palmieri other          3 Feb 25 04:07 dir/
-rw-r--r--   1 palmieri other         79 Feb 24 21:13 FILE
lrwxrwxrwx   1 palmieri other          4 Feb 25 04:06 link1 -> FILE
$ ls -l TEST/dir/
total 1
lrwxrwxrwx   1 palmieri other          4 Feb 25 04:07 link2 -> FILE
```

Now copy it:

```
$ cp -pPR TEST X
$ ls -l X
total 6
drwxr-xr-x   2 palmieri other          3 Feb 25 04:07 dir/
-rwxrwxrwx   1 palmieri other         79 Feb 25 04:06 FILE*
lrwxrwxrwx   1 palmieri other          4 Feb 25 04:08 link1 -> FILE*
$ ls -l X/dir
total 1
lrwxrwxrwx   1 palmieri other          4 Feb 25 04:08 link2 -> FILE
```

Note the permissions on FILE. The way around this seems to be to use `/usr/xpg4/bin/cp -pPR`@` SOURCE TARGET`, naturally.

Let's ignore the scripts patch and just focus on the patch for the Sage library.



---

archive/issue_comments_174010.json:
```json
{
    "body": "Changing keywords from \"cp symlink\" to \"cp symlink OSX Solaris\".",
    "created_at": "2013-02-25T04:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174010",
    "user": "https://github.com/jhpalmieri"
}
```

Changing keywords from "cp symlink" to "cp symlink OSX Solaris".



---

archive/issue_comments_174011.json:
```json
{
    "body": "Attachment [trac_14166-sage.2.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-sage.2.patch) by @jhpalmieri created at 2013-02-25 04:12:20",
    "created_at": "2013-02-25T04:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174011",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_14166-sage.2.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-sage.2.patch) by @jhpalmieri created at 2013-02-25 04:12:20



---

archive/issue_comments_174012.json:
```json
{
    "body": "Attachment [trac_14166-sage.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-sage.patch) by @jhpalmieri created at 2013-02-25 04:12:31\n\nSage library",
    "created_at": "2013-02-25T04:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174012",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_14166-sage.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-sage.patch) by @jhpalmieri created at 2013-02-25 04:12:31

Sage library



---

archive/issue_comments_174013.json:
```json
{
    "body": "There are at least two good ways to test this: start with a fresh Sage 5.8.beta1 tarball, unpack the sage library spkg (spkg/standard/sage-5.8.beta1.spkg), apply this patch, package it back up (with sage -pkg sage-5.8.beta1). Then build Sage. Or do something similar, but start with a built version of Sage. Delete devel/sage and devel/sage-main. Delete spkg/installed/sage-5.8.beta1 and anything more recent. Create a patched version of the Sage spkg, as above. Run `make ptestlong`.",
    "created_at": "2013-02-25T04:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174013",
    "user": "https://github.com/jhpalmieri"
}
```

There are at least two good ways to test this: start with a fresh Sage 5.8.beta1 tarball, unpack the sage library spkg (spkg/standard/sage-5.8.beta1.spkg), apply this patch, package it back up (with sage -pkg sage-5.8.beta1). Then build Sage. Or do something similar, but start with a built version of Sage. Delete devel/sage and devel/sage-main. Delete spkg/installed/sage-5.8.beta1 and anything more recent. Create a patched version of the Sage spkg, as above. Run `make ptestlong`.



---

archive/issue_comments_174014.json:
```json
{
    "body": "Alternatively, `tar` is more portable than `cp` and usually deals with symbolic links correctly. I know for example PARI use `tar` during the installer for this reason. [I don't know tar well enough](http://www.xkcd.org/1168/), but something along the lines of\n\n```\n# tar is the most portable way to copy files\ntar c * .hg* | (cd \"$DEVEL/sage-main/\" && tar x)\n```\n",
    "created_at": "2013-02-25T07:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174014",
    "user": "https://github.com/jdemeyer"
}
```

Alternatively, `tar` is more portable than `cp` and usually deals with symbolic links correctly. I know for example PARI use `tar` during the installer for this reason. [I don't know tar well enough](http://www.xkcd.org/1168/), but something along the lines of

```
# tar is the most portable way to copy files
tar c * .hg* | (cd "$DEVEL/sage-main/" && tar x)
```




---

archive/issue_comments_174015.json:
```json
{
    "body": "If you decide to stick with the current approach, please use\n\n```\n[ -x /usr/xpg4/bin/cp ]\n```\n\ninstead of\n\n```\n[ $UNAME = \"SunOS\" ]\n```\n",
    "created_at": "2013-02-25T07:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174015",
    "user": "https://github.com/jdemeyer"
}
```

If you decide to stick with the current approach, please use

```
[ -x /usr/xpg4/bin/cp ]
```

instead of

```
[ $UNAME = "SunOS" ]
```




---

archive/issue_comments_174016.json:
```json
{
    "body": "Changing assignee from @nexttime to @jdemeyer.",
    "created_at": "2013-02-25T07:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174016",
    "user": "https://github.com/jdemeyer"
}
```

Changing assignee from @nexttime to @jdemeyer.



---

archive/issue_comments_174017.json:
```json
{
    "body": "I like the tar approach. Here's a patch.",
    "created_at": "2013-02-25T16:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174017",
    "user": "https://github.com/jhpalmieri"
}
```

I like the tar approach. Here's a patch.



---

archive/issue_comments_174018.json:
```json
{
    "body": "Sage library",
    "created_at": "2013-02-25T17:04:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174018",
    "user": "https://github.com/jhpalmieri"
}
```

Sage library



---

archive/issue_comments_174019.json:
```json
{
    "body": "Attachment [trac_14166-sage-tar.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-sage-tar.patch) by @jhpalmieri created at 2013-02-25 17:17:23",
    "created_at": "2013-02-25T17:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174019",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_14166-sage-tar.patch](tarball://root/attachments/some-uuid/ticket14166/trac_14166-sage-tar.patch) by @jhpalmieri created at 2013-02-25 17:17:23



---

archive/issue_comments_174020.json:
```json
{
    "body": "With this patch, everything seems to work on sage.math, a few other linux machines on skynet, OpenSolaris (hawk), Solaris (mark), and a few OS X 10.8 boxes I have access to.",
    "created_at": "2013-02-25T19:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174020",
    "user": "https://github.com/jhpalmieri"
}
```

With this patch, everything seems to work on sage.math, a few other linux machines on skynet, OpenSolaris (hawk), Solaris (mark), and a few OS X 10.8 boxes I have access to.



---

archive/issue_events_013782.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-02-28T10:33:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13962#event-13782"
}
```



---

archive/issue_comments_174021.json:
```json
{
    "body": "Works fine!",
    "created_at": "2013-02-28T10:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174021",
    "user": "https://github.com/jdemeyer"
}
```

Works fine!



---

archive/issue_comments_174022.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-28T10:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174022",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_174023.json:
```json
{
    "body": "See also #14236.",
    "created_at": "2013-03-06T13:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13962#issuecomment-174023",
    "user": "https://github.com/jdemeyer"
}
```

See also #14236.
