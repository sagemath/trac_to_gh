# Issue 21011: Reduce Forms from Stoll and Cremona

Issue created by migration from https://trac.sagemath.org/ticket/21248

Original creator: rlmiller

Original creation time: 2016-08-14 21:14:15

CC:  bhutz paulfili

Implementing the reduce forms algorithum from _On the reduction theory of binary forms_ for both polynomials and projective morphisms. Also includes Newton's method for 2 variables, could be further expanded in the future.


---

Comment by rlmiller created at 2016-08-16 19:10:15

_Still having some problems with the examples, and calling value errors. See notes in documentation._
----
New commits:


---

Comment by rlmiller created at 2016-08-16 19:10:15

Changing status from new to needs_review.


---

Comment by bhutz created at 2016-08-16 21:10:17

Well, the first step here is to move from 7.3beta4 to 7.4beta0.

Let's leave this as needs-work until the issues are worked out.


---

Comment by bhutz created at 2016-08-16 21:10:17

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-16 23:21:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2016-08-16 23:22:34

I did some code/formatting clean-up and made the examples work. For the most part you are just having formatting issues.

I have not tested any functionality yet.


---

Comment by rlmiller created at 2016-08-17 18:25:02

Still need a few more examples, having problems with two examples in projective_morphism.py They worked in the notebook.
----
New commits:


---

Comment by bhutz created at 2016-08-18 17:40:20

I think there may be something wrong with the 2nd part of the algorithm. Using the example from the paper that illustrates why you need to use the system of equations, the numerical root finding is not getting the same z as they do.


```
poly = 19*x^8 - 262*x^7*h + 1507*x^6*h^2 - 4784*x^5*h^3 + 9202*x^4*h^4 -
10962*x^3*h^5 + 7844*x^2*h^6 - 3040*x*h^7 + 475*h^8
```



---

Comment by git created at 2016-08-22 22:42:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rlmiller created at 2016-08-22 22:43:07

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2016-08-23 16:53:07

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2016-08-23 16:53:07

- With the updated version of magma, I'm getting consistent results with most examples. Although here is one that is not working correctly:


```
234*x^11*h + 104832*x^10*h^2 + 21346884*x^9*h^3 + 2608021728*x^8*h^4 +
212413000410*x^7*h^5 + 12109691106162*x^6*h^6 + 493106447396862*x^5*h^7
+ 14341797993350646*x^4*h^8 + 291976289803277118*x^3*h^9 +
3962625618555930456*x^2*h^10 + 32266526239647689652*x*h^11 +
119421058057217196228*h^12
```


It looks like the z0 part is correct, then the 2nd part is not.

- I'm not sure the inversion is correct. Take a look at part (2) on p13 of the paper. It may be causing the difference here

```
-234*x^10 - 95940*x^9*h - 17701164*x^8*h^2 - 1935379368*x^7*h^3 -138869177616*x^6*h^4 - 6832744528662*x^5*h^5 - 233468654564574*x^4*h^6 -5470310129096358*x^3*h^7 - 84114643276174446*x^2*h^8 -766469114143193916*x*h^9 - 3142950903278916444*h^10
```

which has

```
magma: [1,-41,0,1] vs sage: [-1,-41,0,-1]
```

or this may be the same error as in the previous bullet point.

- Also, the code is in need of a comments describing what each piece is doing.

- I also think the try/except for the NJinv can be simplified to

```
if NJinv.base_ring() != KK:
    NJinv = matrix(KK,2,2,[KK(zw.numerator()/zw.denominator()) for zw in NJinv.list()])
```

Then you can remove the .numerator() on the v0's later in the code.


---

Comment by bhutz created at 2016-08-23 20:10:38

I though about the one that is way off and here is what is going on. There is a root on the real line of the system of equations to find z(F). Your starting z0 value converges to that solution via Newton's method. However, what you need to find is the other solution which is in the upper half plane


---

Comment by git created at 2016-08-26 17:33:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-26 20:08:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-28 21:20:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2016-08-29 00:07:00

- docs still don't build

- here is another one that maybe doesn't work


```
-1872*x^5*h - 1375452*x^4*h^2 - 404242956*x^3*h^3 - 59402802888*x^2*h^4 - 4364544068352*x*h^5 - 128270946360960*h^6
```


Stoll's implementation in magma gives

```
12168*x^3 - 18252*x^2 + 9828*x - 1872
[-148  147]
[   1   -1]
```

Although he may be doing some extra reducing to get the lower degree result

Here is a similar one that also maybe doesn't work:

```
-1872*x^4 - 1098396*x^3*h - 241680348*x^2*h^2 - 23634111384*x*h^3 - 866695583520*h^4
```


Stoll's implementation in magma gives

```
2808*x^3 - 4212*x^2 + 5148*x - 1872
[-146   -1]
[   1    0]
```



---

Comment by git created at 2016-09-16 16:58:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rlmiller created at 2016-09-16 17:00:59

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2016-09-20 17:10:31

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2016-09-20 17:10:31

I did some general code clean-up and added some more description to the documentation. I also fixed the formatting issues in the documentation and examples. You should double check those changes.

For functionality

 - I'm getting consistent results with Magma now. The only difference (besides trivial differences) is that in the case of a polynomial with a single multiple root, Magma moves that root to infinity and then minimizes the resulting poly. I assume this is to make the 'degree' as low as possible. This implementation does not, but the resulting coefficients here are actually smaller, so I don't really see this is an error, just a difference in implementation.

For projective morphism, there are a couple things 

- the error_limit param needs to be passed in as well and an example where prec/error is needed.

- It is currently removing any multiple roots from the dynatomic: is this what you want to do since the algorithm is able to handle multiple roots as long as the multiplicity isn't too high?

btw, I set the default prec to 300, since that worked for nearly all my randomly generated examples.
----
New commits:


---

Comment by rlmiller created at 2016-09-23 19:13:37

New commits:


---

Comment by rlmiller created at 2016-09-23 19:13:37

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2016-09-26 14:55:19

A couple basic issues from the docs

in multi polynomial:

- input not formatting correctly

- check consistency in your use of the ZZ versus Z macro for integer ring

in projective:

the following do not match and does not need to be repeated twice anyway.


```
Still seeing issues in projective morphism
See sage.rings.polynomials.reduced_form() for details.

See sage.rings.polynomial.multi_polynomial.reduced_form() for the information on binary form reduction.
```



The following examples fail


```
P.<x,y>=ProjectiveSpace(QQ,1)
H=End(P)
f=H([x^3,y^3])
f.reduced_form()
```


QQbar seems to work for polys but not maps

```
P.<x,y>=ProjectiveSpace(QQbar,1)
H=End(P)
f=H([x^4,y^4])
f.reduced_form()
```


The behavior for RR,CC is not consistent between polynomials and morphisms

```
P.<x,y>=ProjectiveSpace(RR,1)
H=End(P)
f=H([x^4,y^4])
f.reduced_form()
```


vs


```
R.<x>=PolynomialRing(RR)
F=19*x^8 - 262*x^7 + 1507*x^6 - 4784*x^5+9202*x^4 - 10962*x^3 + 7844*x^2-3040*x+475
G=F.homogenize()
G.reduced_form()
```



---

Comment by bhutz created at 2016-09-26 14:55:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-09-28 18:53:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rlmiller created at 2016-09-28 18:54:00

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2016-09-29 19:00:19

Your changes looked fine. I got this working for a few more fields by calling complex_roots directly for the roots of the polynomials. I also had to make the dividing out the gcd a little more general as well.

Go ahead and test this version and let me know what you find.
----
New commits:


---

Comment by chapoton created at 2016-09-29 19:34:49

typo: Implimented

typo: incresed

typo: useing covergence

typo: tolerence


---

Comment by git created at 2016-09-30 01:04:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2016-09-30 01:08:00

fixed the typo and realized since you are calling reduce on the polynomial with multiple roots, that there is no need to actually do the division. So I just count the multiple roots instead.

Just noticed the other typos. I'll push another fix for those.


---

Comment by git created at 2016-09-30 01:08:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-30 01:13:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-09-30 14:20:43

`covergence conditions` is still a typo


---

Comment by rlmiller created at 2016-09-30 15:37:01

Typo fixed just waiting to push. Thanks


---

Comment by rlmiller created at 2016-09-30 18:15:37

New commits:


---

Comment by bhutz created at 2016-10-01 14:03:12

I think we're ready to go here.


---

Comment by bhutz created at 2016-10-01 14:03:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-29 14:27:15

Resolution: fixed


---

Comment by bhutz created at 2016-10-29 14:36:06

don't know what happened to the commit when I updated the milestone. I've copy/pasted the commit identifier back in.


---

Comment by bhutz created at 2016-10-29 14:38:04

apparently, that doesn't work. Have I messed up this ticket now?


---

Comment by chapoton created at 2016-10-30 21:17:44

You should rather avoid playing with the milestone once the ticket is closed.

This being said, nothing bad should happen.

Side remark: has anybody proofread this code ? there are several typos (boundry, lease, ...)


---

Comment by bhutz created at 2016-10-30 22:00:02

Yeah, i don't usually mess with the milestone post closing, but when it was marked positive 7.4 was still in beta, then it got released and this was closed into 7.5.

I didn't expect correcting that to interfere with other fields.


side reply: apparently not as carefully as you.
