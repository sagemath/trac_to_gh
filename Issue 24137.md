# Issue 24137: update networkx to version 2.0

Issue created by migration from https://trac.sagemath.org/ticket/24374

Original creator: dimpase

Original creation time: 2017-12-14 11:48:15

CC:  fbissey slelievre arojas

the new version of [networks](https://networkx.github.io/) is out since Sept. 2017, 
and appears to be installable by `sage --pip install networkx` (after doing
`sage --pip uninstall networkx`)
 
We should update.
There are few quirks [already noticed](https://groups.google.com/d/msg/sage-devel/DAifW_Ma__s/YxJD8rKgAgAJ): some functions of networkx fail if they are passed Sage's `ZZ()`
numbers as parameters (whereas `int()` works).


---

Comment by dimpase created at 2017-12-15 09:32:15

reported at https://github.com/networkx/networkx/issues/2799


---

Comment by dimpase created at 2017-12-15 11:14:35

the problem is in `networkx` code a test for `isinstance(n2,int)` should be by right for
`isinstance(n2,numbers.Integral)`

With the appropriate change in `algorithms/bipartite/generators.py`, line 67 in master (2.1), everything works


```
import numbers
if isinstance(n2,numbers.Integral):
```



---

Comment by slelievre created at 2018-02-14 11:15:17

Since a new release of NetworkX has the fix to the observed problems, this could move forward.


---

Comment by dimpase created at 2018-02-15 12:28:56

I'll make an update.


---

Comment by dcoudert created at 2018-03-28 18:42:06

Let me know if I can help.


---

Comment by saraedum created at 2018-06-21 17:12:11

I'll try to work on the actual upgrade if nobody objects.


---

Comment by dimpase created at 2018-06-21 17:15:33

Oh, another ticket I forgot about. Sorry. Please have a go at it - I am marking exams this week...


---

Attachment

renamed tarball from github


---

Comment by saraedum created at 2018-06-21 23:20:01

I pushed a branch that passes long doctests in `sage/graph/`. I am now running long doctests for all of sage.
----
New commits:


---

Comment by fbissey created at 2018-06-21 23:21:43

The zip archive from pypi is acceptable as a source and we probably should use it instead over renaming the github tarball.


---

Comment by saraedum created at 2018-06-21 23:23:04

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-06-21 23:23:04

I would not be surprised if some things are broken now. There are a lot of subtle changes in networkx and not all code paths are doctested I believe.

Some more comments for potential reviewers:
* I simplified the SPKG.txt as the changelog has not been mantained for a few years it seems. Also, I am not sure whether the dependencies section is actually useful; numpy and scipy are not hard dependencies. Furthermore, I did not drop src/doc/data as mentioned in the SPKG.txt as I do not see why we should remove that from the source package.
* I upgraded copyright headers. When there were no copyright headers at all, I added new ones and seeded them with everyone in the git history of the file. The lists of authors are really lengthy but a lot of people have made little changes to these files.
* I dropped NetworkXGraphBackend as it is not used anywhere. There might still be some pickles around that use this? If so, then we should try to upgrade them on unpickling.
* The recursive topsort has disappeared it seems.
* The balanced tree implementation now raises errors if you feed it invalid heights or degrees.


---

Comment by dimpase created at 2018-06-22 00:44:56

It is totally not kosher to just drop functionality like NetworkXGraphBackend. Why,
what's wrong with it?
That it is not used in the Sage library does not mean it is not used by users.

And even if you did that it would require a deprecation rather than outright removal...


---

Comment by dimpase created at 2018-06-22 00:44:56

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-06-22 00:49:52

NetworkXGraphBackend does not seem to be accessible without explicitly importing it. I do not think that things that are internal need to be deprecated before removal.


---

Comment by saraedum created at 2018-06-22 00:50:03

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-06-22 00:53:47

Btw., it had been deprecated in #18375 it seems.


---

Comment by saraedum created at 2018-06-22 00:57:33

Note that some of the NetworkXGraphBackend "doctests" start like this:

```
sage: G = DiGraph(digraphs.Path(5),implementation="networkx")
/usr/bin/sage-ipython:1: DeprecationWarning: The 'implementation' keyword is deprecated, and the graphs has been stored as a 'c_graph'
See http://trac.sagemath.org/18375 for details.
  #!/usr/bin/env python2
sage: G = G._backend
```


However, `G` is not a `NetworkXGraphBackend`:

```
sage: type(G).mro()
[<type 'sage.graphs.base.sparse_graph.SparseGraphBackend'>,
 <type 'sage.graphs.base.c_graph.CGraphBackend'>,
 <type 'sage.graphs.base.graph_backends.GenericGraphBackend'>,
 <type 'sage.structure.sage_object.SageObject'>,
 <type 'object'>]
```



---

Comment by saraedum created at 2018-06-22 01:02:17

Replying to [comment:13 fbissey]:
> The zip archive from pypi is acceptable as a source and we probably should use it instead over renaming the github tarball.

Ok. I don't really mind (except for recomputing the checksums.) I just thought renaming is nice because the archive was named `NetworkX-NetworkX-2.1.tar.gz` or something like that. I also wouldn't mind to use this weird name instead. Is there some reason to prefer pypi over github?


---

Comment by dimpase created at 2018-06-22 01:04:06

OK, it's fine then. I've modified the ticket description to this effect.
(Still needs review).

By the way, I was going to propose more upstream changes, so that it respects integral function arguments in the Python numerical tower, rather than starting screaming any time it's not `int()`. I only did so in a very minimal way, to fix all the uses in Sage library.
See https://github.com/networkx/networkx/pull/2800


---

Comment by fbissey created at 2018-06-22 01:06:35

Replying to [comment:20 saraedum]:
> Replying to [comment:13 fbissey]:
> > The zip archive from pypi is acceptable as a source and we probably should use it instead over renaming the github tarball.
> 
> Ok. I don't really mind (except for recomputing the checksums.) I just thought renaming is nice because the archive was named `NetworkX-NetworkX-2.1.tar.gz` or something like that. I also wouldn't mind to use this weird name instead. Is there some reason to prefer pypi over github?

Well pypi ship distribution archives rather than raw tarballs. It is a bit like the difference between a sdist and a raw tarball for an autoconf project. Except that usually the python raw stuff is a bit more easily usable than the raw autoconf stuff where `configure` and friends haven't been generated.


---

Comment by slelievre created at 2018-06-22 01:38:01

About github tarballs vs pypi tarballs: similar discussion on another ticket:
- #25083#comment:3


---

Comment by slelievre created at 2018-06-22 01:38:01

Changing keywords from "" to "upgrade, networkx".


---

Comment by saraedum created at 2018-06-25 13:32:24

Replying to [comment:22 fbissey]:
> Replying to [comment:20 saraedum]:
> > Replying to [comment:13 fbissey]:
> > > The zip archive from pypi is acceptable as a source and we probably should use it instead over renaming the github tarball.
> > 
> > Ok. I don't really mind (except for recomputing the checksums.) I just thought renaming is nice because the archive was named `NetworkX-NetworkX-2.1.tar.gz` or something like that. I also wouldn't mind to use this weird name instead. Is there some reason to prefer pypi over github?
> 
> Well pypi ship distribution archives rather than raw tarballs. It is a bit like the difference between a sdist and a raw tarball for an autoconf project. Except that usually the python raw stuff is a bit more easily usable than the raw autoconf stuff where `configure` and friends haven't been generated.

I think the general practice is to upload distribution tarballs for github releases as well, that's at least what I do ;)


---

Comment by git created at 2018-06-25 13:37:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-06-25 14:02:28

Everything seems to work now.


---

Comment by git created at 2018-06-25 14:02:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dcoudert created at 2018-06-25 17:04:17

There is something wrong with this patch. It is about upgrading NetworkX to version 2.1 (clearly needed), but it also includes modifications to various parts of the code: modifying copyright descriptions in some files (`digraph.py`, `bipartite_graph.py`, `degree_sequence.py`, etc.), droping implicit assumption about vertex ordering, removing an input parameter in `cliques_get_max_clique_graph`, etc. Why ?

If you want to correct an error like in you last commit [9553d85](https://git.sagemath.org/sage.git/commit/?id=9553d85e804047b65ce218645563b2140c2d0b0c), you can open a specific ticket.

The proposed modification of copyright in `digraph.py` is really nice and I don't know how you get the data, but it should not be done here.


---

Comment by saraedum created at 2018-06-25 17:11:22

Please see #24374#comment:14 about the compilation of the copyrights. Sure the copyright changes are not part of the upgrade but it is imo customary here to add such small non-functional changes, e.g., we recently do this for pyflakes changes.

All the changes (except the copyright) in these tickets were necessary to make doctests pass after the networkx upgrade. In particular this is the case for the clique (the parameter does not exist in networkx anymore) and matching changes (there apparently was an implicit ordering before.)


---

Comment by saraedum created at 2018-06-25 17:14:17

That said, if you want to split this up, feel free to do so.


---

Comment by dcoudert created at 2018-06-25 17:27:41

I see. I checked all the changes in the codes, and I agree it's "minor". So go for it.


---

Comment by dimpase created at 2018-06-26 22:25:46

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-06-26 22:25:46

looks good to me.


---

Comment by vbraun created at 2018-06-29 22:34:12

Resolution: fixed
