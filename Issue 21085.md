# Issue 21085: coerce_binop has dangerous behaviour wrt additional arguments

Issue created by migration from https://trac.sagemath.org/ticket/21322

Original creator: jsrn

Original creation time: 2016-08-23 21:44:56

CC:  caruso mmarco

``@`coerce_binop` is an important decorator used on binary operators to automagically apply the coercion framework on its arguments. It's widely used on e.g. `gcd` operations (`_add_`, `_sub_` etc. have coercion handled with another mechanism).

The current ``@`coerce_binop` has the following dangerous behaviour, where, if the decorated method is given an extra unnamed argument, the `self`-argument is swallowed:


```
    sage: P.<x> = GF(5)[]
    sage: f = x^2
    sage: g = x
    sage: f.gcd(g)
    x
    sage: f.gcd(g, 1)
    1
```


The reason is that ``@`coerce_binop` included a hack to allow calls such as
`Polynomial.gcd(f,g)` where `f` and `g` are polynomials and the `gcd` method is
decorated with ``@`coerce_binop`. The reason that this required a hack at all is that ``@`coerce_binop` was implemented as a class: it seems that creating decorators as classes implies a very unfortunate behaviour:


```
class MyDec:

   def __init__(self, f):
       self.f = f

   def __call__(self, x):
       print "decorated: ", self , x
       self.f(x)

mydec = MyDec

class A:

    def __init__(self, a):
        self.a = a

    @mydec
    def met(self, x):
        print "x:", x
        
myA = A(1)
myA.met(5)

```


the above prints something like


```
    decorated:  <__main__.MyDec instance at 0x7f63c5ab6c20> 5
```


and then crashes with 


```
    AttributeError: MyDec instance has no attribute 'a'
```


This is because the `self` in `__call__` of `MyDec` becomes the `MyDec` instance
-- the `A` instance is never passed to the decorating class instance!


The solution here is to rewrite `coerce_binop` as a function. At the same time, we can use ``@`sage_wraps` which ensures proper documentation (e.g. source file and line which was not retained in the previous `coerce_binop`).



---

Comment by jsrn created at 2016-08-23 22:21:04

As described.
----
New commits:


---

Comment by jsrn created at 2016-08-23 22:21:04

Changing keywords from "" to "sd75".


---

Comment by caruso created at 2016-08-24 08:00:52

For information, the popular decorator ``@`cached_method` is also implemented by a class as uses the same hack consisting in creating on the fly a new decorator for each instance (through a `__get__` method).


---

Comment by jsrn created at 2016-08-24 08:35:23

I got the following, possibly spurious doc-test failures:


```
sage -t src/sage/interfaces/sage0.py  # Timed out
sage -t src/sage/graphs/tutte_polynomial.py  # Timed out
sage -t src/sage/categories/euclidean_domains.py  # 1 doctest failed
sage -t src/sage/tests/cmdline.py  # 8 doctests failed
sage -t src/sage/interacts/debugger.py  # Timed out
sage -t src/sage/structure/element.pyx  # 6 doctests failed
sage -t src/sage/quivers/algebra_elements.pxi  # Timed out
sage -t src/sage/misc/randstate.pyx  # Timed out
sage -t src/sage/rings/polynomial/padics/polynomial_padic_capped_relative_dense.py  # 1 doctest failed
sage -t src/sage/doctest/forker.py  # Timed out
sage -t src/sage/repl/interpreter.py  # Tab character found
----------------------------------------------------------------------
```



---

Comment by git created at 2016-08-24 14:49:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2016-08-24 14:50:44

Changing status from new to needs_review.


---

Comment by git created at 2016-08-24 18:19:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2016-08-24 18:22:25

Changing status from needs_review to positive_review.


---

Comment by mmarco created at 2016-08-24 18:22:25

I don't get any of the errors pointed by jsm.

Otherwise, lgtm.
----
New commits:


---

Comment by vbraun created at 2016-08-25 21:45:42

Resolution: fixed
