# Issue 17051: MathJax for both (offline) notebooks

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2014-11-04 14:44:05

CC:  egourgoulhon

Keywords: mathjax notebook

Currenlty, `MathJax` is bundled with sagenb. But ipython notebook also requires `MathJax` for offline displaying mathematical formulas.

The aim of this ticket is to:
 - have a independent `MathJax` (default) spkg, not related to sagenb
 - have ipython notebook work with that local install
 - remove `MathJax` from sagenb bundle and use the independent one to avoid duplication

The latest `MathJax` tarball can be downloaded at https://github.com/mathjax/MathJax/archive/v2.4-latest.tar.gz


---

Comment by tmonteil created at 2014-11-04 14:51:06

The previous commit settles the first item. I know how to manage the second one, but i do not know enough about sagenb development to achieve the third one.
----
New commits:


---

Comment by tmonteil created at 2014-11-04 15:31:52

The current `MathJax` wheights 175M once installed, which is quite a lot. Shall we strip it (e.g. removing png files) ? See https://github.com/mathjax/MathJax-docs/wiki/Guide%3A-reducing-size-of-a-mathjax-installation


---

Comment by jhpalmieri created at 2014-11-05 18:44:57

First, I agree that we should remove the png files. I think that is what's done in sagenb. Second, given the current status (= slow) of sagenb development, I think that removing `MathJax` from sagenb should go on another ticket. The stripped version shouldn't take too much space, so having two copies for a while (until sagenb gets modified) is not that bad.


---

Comment by git created at 2014-11-06 12:37:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2014-11-06 12:49:38

Actually, with the help of the before mentioned mathjax reducing guide, it was possible to remove much more than only png files. It should be possible to remove even more according to our needs, but i think 9.2M is a good size for now, and the current strip is simple to read (hence debug) and barely modifies a config file.


---

Comment by kcrisman created at 2014-11-06 14:38:05

Yeah, I think that although there has been a spurt in the notebook recently, we (I) really need to just focus on making sure that the upgrade to javascript 3d is successful; disentangling the MathJax stuff there to have it back in sage could be challenging.  And there are always a few people who still want to keep sagenb totally separate so it could be a separate project for some reason.  

Sorry.  This is certainly a good goal!  But I think John is right.


---

Comment by tmonteil created at 2014-11-06 16:19:31

I am not involved in the development of sagenb, so it's really up to you.

I just gave a try, simply removing the mathjax directory in `local/lib/python2.7/site-packages/sagenb-*.egg/sagenb/data` and replacing it with a symlink  to `../../../../../../share/mathjax` seems to work well.

So, if you still want to ship mathjax within sagenb source code, a possibility is to add the previous "remove+symlink" at the end of the `build/pkgs/sagenb/spkg-install` script, so the only problem will be about downloading mathjax twice. Another possibility is to officially ship two sagenb tarballs, one with mathjax, one without.


---

Comment by kcrisman created at 2014-11-06 16:33:30

> I just gave a try, simply removing the mathjax directory in `local/lib/python2.7/site-packages/sagenb-*.egg/sagenb/data` and replacing it with a symlink  to `../../../../../../share/mathjax` seems to work well.

Good, I'll keep that in mind.
> So, if you still want to ship mathjax within sagenb source code, a possibility is to add the previous "remove+symlink" at the end of the `build/pkgs/sagenb/spkg-install` script, so the only problem will be about downloading mathjax twice. Another possibility is to officially ship two sagenb tarballs, one with mathjax, one without.

I don't think there is really any need to ship it if it is in Sage, I was just commenting on what some people liked.  Anyway, I'll make an upstream ticket - https://github.com/sagemath/sagenb/issues/258 - but don't worry about it for now.

(I'm kind of surprised IPython notebook doesn't ship MathJax.)


---

Comment by git created at 2014-11-07 15:30:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-11-07 16:31:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2014-11-07 16:42:03

In the last commit i showed how could sagenb work with mathjax spkg. It should work both with or without modifiction of sagenb spkg. Since each commit does a specific thing, we can decide whether  sagenb should use mathjax spkg or not.

- commit ​e8ef55d : basic independent mathjax spkg
- commit ​8f18d36 : strip mathjax down from 175M to <10M.
- commit ​0443d99 : make mathjax a standard spkg and a dependency of (and work with) ipython
- commit ​8ec7d5c : make mathjax a dependency of (and work with) sagenb


---

Comment by tmonteil created at 2014-11-07 16:42:03

Changing status from new to needs_review.


---

Comment by kcrisman created at 2014-11-07 16:52:34

Here is what I recommend on the sagenb piece (I have no technical opinion on the rest, though it seems like a great idea).  Do everything that you want to with the first three commits, but please save the sagenb one for a different ticket - one that is post-Sage-6.4.

The reason is that sagenb will _also_ need changes - namely, to get rid of the mathjax from itself.  That shouldn't be too hard, possibly trivial, but I just don't have the bandwidth right now to shepherd that through given that it would nonetheless need some reasonably intensive testing.  Given the small size of this package, this really shouldn't be an issue.  I already reported upstream, and have pointed out the commit in question, so everything that needs to be done can be done.


---

Comment by tmonteil created at 2014-11-07 20:40:42

Okay, i will put the commit related to sagenb in the ticket #17306. That said, the current ticket can wait after 6.4 too :)


---

Comment by git created at 2014-11-07 20:58:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2014-12-05 02:32:11

See also #17446, though I don't recommend replacing this with a possibly-unstable alpha.


---

Comment by jdemeyer created at 2014-12-05 06:05:49

Note that

```
if [ -d mathjax ] ; then
    rm -rf mathjax
fi
```

is entirely equivalent (assuming `mathjax` is never an ordinary file) to

```
rm -rf mathjax
```


So either simplify or fix that.


---

Comment by jdemeyer created at 2014-12-05 06:05:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-05 06:09:38

Shouldn't the trimming happen at packaging time (in `spkg-src`) rather than at installation time?


---

Comment by kcrisman created at 2014-12-05 13:58:47

> Shouldn't the trimming happen at packaging time (in `spkg-src`) rather than at installation time?
Yeah, see http://www.sagemath.org/doc/developer/packaging.html  Does the fact that that is needed to be run something that goes in SPKG.txt?


---

Comment by kcrisman created at 2014-12-07 03:09:00

Once this is ready, there are some other sagenb things that could be packaged up so we could try to coordinate with #17306 (the 'big' release now being out of the way).

By the way, why does http://git.sagemath.org/sage.git/diff/?id=8314779f9e64eaeb0d00444a41336529286a9708 have build/deps mysteriously vanishing?  (None of the individual commits do this, of course.)


---

Comment by git created at 2014-12-08 10:38:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2014-12-08 10:40:42

Replying to [comment:23 kcrisman]:
> By the way, why does http://git.sagemath.org/sage.git/diff/?id=8314779f9e64eaeb0d00444a41336529286a9708 have build/deps mysteriously vanishing?  (None of the individual commits do this, of course.)

I do not know, i repushed somethning and it seems the problem disapeared.


---

Comment by git created at 2014-12-08 10:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2014-12-08 10:54:13

Replying to [comment:21 jdemeyer]:
> Shouldn't the trimming happen at packaging time (in `spkg-src`) rather than at installation time?

Well, i think this is a more global issue about Sage packaging. I would avocate to ship unmodified upstream tarballs so that any user can check its integrity (hashsums). The problem of spkg-src scripts is that they is not reproducible (i can not run it myself to check if it was correctly applied) because tarballs contain some noise (e.g. timestamps). I agree that in some extreme cases (e.g. boost), the difference of size before and after is so huge that we could be tempted to repackage the upstream tarball. However, it may be a better idea to discuss with upstream about shipping trimmed versions as well (i am pretty sure many webmaster will be happy to benefit from such a standard trimmed version of mathjax). By the way, the current documentation somehow agrees with that point of view  ("Ideally it is not modified [...] if you **really** must modify the upstream tarball" (bold is mine)): http://www.sagemath.org/doc/developer/packaging.html#modified-tarballs


---

Comment by tmonteil created at 2014-12-08 11:15:42

Replying to [comment:20 jdemeyer]:
> Note that
> {{{
> if [ -d mathjax ] ; then
>     rm -rf mathjax
> fi
> }}}
> is entirely equivalent (assuming `mathjax` is never an ordinary file) to
> {{{
> rm -rf mathjax
> }}}
> 
> So either simplify or fix that.

I did it in my last commit. The reason why i did that before was in case the user symlinked to her own mathjax install (in order to mutualize with another existing mathjax install on the computer to save space (for example on a live system)).


---

Comment by kcrisman created at 2014-12-08 13:11:29

> > Shouldn't the trimming happen at packaging time (in spkg-src) rather than at installation time?
> Well, i think this is a more global issue about Sage packaging. I would avocate to ship unmodified upstream tarballs so that any user can check its integrity (hashsums). 
But it sort of misses the point of trimming at all, since now we have to ship the entire thing anyway in a source dist, and download the whole thing for an upgrade.  Maybe it helps binaries some.


---

Comment by tmonteil created at 2014-12-08 18:30:10

Replying to [comment:29 kcrisman]:
> But it sort of misses the point of trimming at all, since now we have to ship the entire thing anyway in a source dist, and download the whole thing for an upgrade.  Maybe it helps binaries some.

Indeed, most non-developpers i met use binary tarballs, live USB or PPA (actually those who build Sage from source do this because there is no binary for their distro/version/architecture).

Also, note that the mathjax tarball weights 22M while the uncompressed/untared directory weights 175M (of course a tarball obtained from the 10M trimmed directory would be very small).

As for mathjax package, i will see if upstream can ship "generic" trimmed versions.


---

Comment by kcrisman created at 2015-02-03 01:55:36

What's status here?  I don't use ipynb so I won't be reviewing this, but interested because of #17306, which I should have time to review once this is in.


---

Comment by jdemeyer created at 2015-02-04 07:38:45

Replying to [comment:28 tmonteil]:
> Replying to [comment:20 jdemeyer]:
> > Note that
> > {{{
> > if [ -d mathjax ] ; then
> >     rm -rf mathjax
> > fi
> > }}}
> > is entirely equivalent (assuming `mathjax` is never an ordinary file) to
> > {{{
> > rm -rf mathjax
> > }}}
> > 
> > So either simplify or fix that.
> 
> The reason why i did that before was in case the user symlinked to her own mathjax install

Side comment: even in that case, the commands

```
if [ -d mathjax ] ; then
    rm -rf mathjax
fi
```

and

```
rm -rf mathjax
```

are equivalent: both delete just the symlink.


---

Comment by jdemeyer created at 2015-02-04 07:40:41

Does `IPYTHON` really depend on `MATHJAX` at _installation-time_? Or is it a run-time dependency only? In the latter case, it shouldn't be added to `build/deps`.


---

Comment by jdemeyer created at 2015-02-04 07:45:31

I don't know about the portability of

```
ln -s ../../../../../../share/mathjax/
```


I would prefer

```
ln -s ../../../../../../share/mathjax/ mathjax
```



---

Comment by novoselt created at 2015-02-07 00:09:06

By the way - [MathJax 2.5 is out](http://www.mathjax.org/mathjax-v2-5-now-available/) claiming to have some superfast preview mode until everything is rendered nicely. Perhaps it can be used instead of 2.4?


---

Comment by vbraun created at 2015-02-21 14:39:31

Fixed. I also prefer to re-pack the tarball as we save quite a bit here.
----
New commits:


---

Comment by vbraun created at 2015-02-21 14:39:31

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2015-03-01 01:30:04

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-03-01 01:30:04

Looks good to me.


---

Comment by vbraun created at 2015-03-03 00:25:14

Resolution: fixed


---

Comment by novoselt created at 2015-06-02 22:17:37

So SVG fonts are removed??? They were a great alternative when there were any issues with HTML! Plus, there is still an option to use SVG as a renderer in the menu and after picking it and refreshing the page all formulas are gone and it is not clear how to go back!

If tarball is 22MB what's the necessity to strip anything but development files at all? PNG fonts are there for a reason too - some users/browsers have issues with others. For the moment one of the "other browsers" seems to be Firefox 38 on our campus computers - things are ugly in SageNB and in SageMathCell I only see math processing error message.

MathJax is an essential component of Sage, so if contributes to 5% of its tarball and unpacked size I don't see it as a problem at all...


---

Comment by fbissey created at 2015-06-02 22:26:35

Replying to [comment:42 novoselt]:
> So SVG fonts are removed??? They were a great alternative when there were any issues with HTML! Plus, there is still an option to use SVG as a renderer in the menu and after picking it and refreshing the page all formulas are gone and it is not clear how to go back!
> 
> If tarball is 22MB what's the necessity to strip anything but development files at all? PNG fonts are there for a reason too - some users/browsers have issues with others. For the moment one of the "other browsers" seems to be Firefox 38 on our campus computers - things are ugly in SageNB and in SageMathCell I only see math processing error message.
> 
> MathJax is an essential component of Sage, so if contributes to 5% of its tarball and unpacked size I don't see it as a problem at all...

tarball size is not the only problem. sage also has one patch to avoid extra problem from this. 

But as a starting point to conversation you have to know that by default if left alone these `.png` fonts will be copied in each subfolder of the html sage documentation. One data point I have from https://github.com/cschwan/sage-on-gentoo/issues/344 is that for two languages (english and french) the size of the html doc comes to 1.7GB in sage-on-gentoo before I did something about the duplications of fonts everywhere. After that it comes to 274MB. Check your vanilla sage install and you will find out that with all the language enabled you are under that figure. I think the basic figure for all languages is over 5GB, if you don't do anything about these `.png` fonts.


---

Comment by vbraun created at 2015-06-02 22:29:20

ff38 should work fine with the fonts, sounds like a serious bug. Is it really fixed/worked around by installing png fonts?


---

Comment by novoselt created at 2015-06-02 22:38:15

I don't know if it will be fixed, but the error messages that flash are that it cannot load webfonts. This may be something special for our computer setup (= whatever campus IT guys are doing, things are fine on my desktop), but at least in the past SVG worked quite well and presumably does not have issues of PNG fonts.

Related to multiple copies - surely that is not MathJax's fault! If there is a need to have fonts in each folder, couldn't it be achieved via symlinks?


---

Comment by fbissey created at 2015-06-02 22:42:38

I am fairly sure there is a configuration option in `mathjax` to avoid copying the fonts, but I am not sure it is currently working/enabled properly. Removing duplicates which is what I currently do in sage-on-gentoo requires extra massaging that would easily be put in the install script. If the bits to avoid the copying could be fixed or enabled properly that would be better. I think we have enough information that a new ticket should be opened rather than beating on this closed one.


---

Comment by novoselt created at 2015-06-02 23:04:49

#18596
