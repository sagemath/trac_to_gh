# Issue 11160: 65x penalty in performance for using float instead of RealNumber

Issue created by migration from https://trac.sagemath.org/ticket/11332

Original creator: pang

Original creation time: 2011-05-12 15:53:49

Assignee: tbd

Keywords: float, RealNumber

The function random() returns a "float", but 1.0*random() is a "RealNumber". The following code:


```
%time
#1
N=5000
x=random()
for c in xrange(N):
    kk = exp(x)
```

takes 5.24 seconds, while


```
%time
#1
N=5000
x=random()*1.0
for c in xrange(N):
    kk = exp(x)
```

takes 0.08


---

Comment by pang created at 2011-05-13 11:06:48

It's a bit worse:


```
x=random()
timeit('exp(x)')
```


125 loops, best of 3: 7.88 ms per loop

while 


```
x=random()*1.0
timeit('exp(x)')
```


625 loops, best of 3: 48.3 µs per loop

so the ratio is rather around 150x.


---

Comment by nbruin created at 2011-05-16 21:19:59

note that "float" is the standard python float type, whereas RealNumber is a preferred type for sage. Furthermore, "exp" is a general sage function that can do all kinds of "exponentiation" (symbolic, numeric etc.), and that incurs overhead. Apparently a particularly bad one for "float" types. Setting the base line:

```
sage: x=random()
sage: y=RealNumber(x)
sage: z=RDF(x)
sage: timeit('exp(x)')
625 loops, best of 3: 1.15 ms per loop
sage: timeit('exp(y)')
625 loops, best of 3: 10.3 µs per loop
sage: timeit('exp(z)')
625 loops, best of 3: 3.52 µs per loop
```

Using python's own "exp" is the fastest:

```
sage: timeit('math.exp(x)')
625 loops, best of 3: 373 ns per loop
```

You can shave off some time from the RealNumber one too by calling a method specific for it. It's slower, but RealNumber has much more functionality (also multiprecision)

```
sage: timeit('y.exp()')
625 loops, best of 3: 6.28 µs per loop
```

RDF is supposed to be Sage's version of "double precision floats" and is indeed comparable:

```
sage: timeit('z.exp()')
625 loops, best of 3: 704 ns per loop
```

If you don't mind a float, math.exp seems to receive a fairly efficiently coerced float from either RealNumber or RDF

```
sage: timeit('math.exp(y)')
625 loops, best of 3: 510 ns per loop
sage: timeit('math.exp(z)')
625 loops, best of 3: 419 ns per loop
```

It would be nice if the generic "exp" would find a bit faster codepaths for some of these types, but I wouldn't consider the current behaviour a "defect".


---

Comment by jdemeyer created at 2014-10-29 08:11:40

Changing component from performance to symbolics.


---

Comment by jdemeyer created at 2014-10-29 08:11:40

Changing assignee from tbd to burcin.


---

Comment by mmezzarobba created at 2015-04-14 11:41:38

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2015-04-14 11:41:38

Fixed?


```
sage: sage: x=random()
sage: sage: y=RealNumber(x)
sage: sage: z=RDF(x)
sage: sage: timeit('exp(x)')
625 loops, best of 3: 17.7 µs per loop
sage: sage: timeit('exp(y)')
625 loops, best of 3: 5.9 µs per loop
sage: sage: timeit('exp(z)')
625 loops, best of 3: 2.29 µs per loop
```



---

Comment by vdelecroix created at 2015-04-22 19:23:12

Replying to [comment:8 mmezzarobba]:
> Fixed?
> 
> {{{
> sage: sage: x=random()
> sage: sage: y=RealNumber(x)
> sage: sage: z=RDF(x)
> sage: sage: timeit('exp(x)')
> 625 loops, best of 3: 17.7 µs per loop
> sage: sage: timeit('exp(y)')
> 625 loops, best of 3: 5.9 µs per loop
> sage: sage: timeit('exp(z)')
> 625 loops, best of 3: 2.29 µs per loop
> }}}

Half

```
sage: x = random()
sage: timeit('exp(x)', number=50000)
50000 loops, best of 3: 8.15 µs per loop
sage: from math import exp as math_exp
sage: timeit('math_exp(x)', number=50000)
50000 loops, best of 3: 290 ns per loop
```

just 30x slower. Better than the 65x that was reported for the difference between `float` and `RR`.


---

Comment by jdemeyer created at 2015-04-23 05:37:25

92x on my system:

```
sage: timeit('exp(x)', number=100000, repeat=10)
100000 loops, best of 10: 8.55 µs per loop
sage: timeit('math_exp(x)', number=100000, repeat=10)
100000 loops, best of 10: 92.1 ns per loop
```



---

Comment by mmezzarobba created at 2015-04-23 06:52:36

Wait, what exactly are we trying to measure? I thought this ticket was about the overhead of `exp()` (I mean `sage.functions.log.exp`) for some argument types. If we allow ourselves to call the “right” function or method for each type, then both `RDF(x).exp()` and `math.exp(x)` are fast when applicable.


---

Comment by vdelecroix created at 2015-04-24 21:36:37

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2015-04-24 21:36:37

Agreed that it is not exactly the same issue... but still there is a problem for `exp` being very slow. So we can either open a new ticket for that slightly similar issue or precise the issue here.


---

Comment by rws created at 2016-10-06 13:10:14

Changing status from needs_info to needs_review.


---

Comment by rws created at 2016-10-06 13:10:14

I think there was progress from
https://github.com/pynac/pynac/issues/108

I don't think you can get better than a few µs for symbolic `exp()`, there is too much overhead from `symbolic/function.pyx` even for `GinacFunction`s.


---

Comment by mderickx created at 2017-08-30 18:44:12

Changing status from needs_review to positive_review.


---

Comment by mderickx created at 2017-08-30 18:44:12

I agree that the original problem is fixed.


---

Comment by embray created at 2017-12-12 08:23:33

Resolution: wontfix
