# Issue 19719: elements of finite field algebraic closure are not hashable

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2016-01-24 21:41:01

CC:  pbruin jpflori

We have

```
sage: K = GF(2).algebraic_closure()
sage: a = K.an_element()
sage: hash(a)
Traceback (most recent call last):
...
TypeError: ...
```

and this prevent resultant computation of bivariate polynomials

```
sage: R.<x,y> = K[]
sage: x.resultant(y)
Traceback (most recent call last):
...
TypeError: ...
```



---

Comment by vdelecroix created at 2016-01-24 22:46:17

Here is a naive implementation. We need to do some kind of canonicalization to get the hash value... hence it is necessarily slow. There might be some faster option if we have more compatibility with the multiplicative generators.


---

Comment by vdelecroix created at 2016-01-24 22:46:48

New commits:


---

Comment by vdelecroix created at 2016-01-24 22:46:48

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-01-25 08:47:23

It would already be slightly more efficient to remove the branch and double `hash` and do something like

```
return hash(x) + (F.degree() - 1) * 1009
```



---

Comment by vdelecroix created at 2016-01-25 10:29:50

Replying to [comment:5 jdemeyer]:
> It would already be slightly more efficient to remove the branch and double `hash` and do something like
> {{{
> return hash(x) + (F.degree() - 1) * 1009
> }}}

True for efficiency. But there will be collisions sooner. The reason is that `map(hash, GF(q))` is `[0, 1, ..., q-1]`. Maybe it was a bad choice for `GF(q)`? What about something like

```
return (hash(x) + deg * p1) ^ ((deg - 1) * p2)
```

I am not sure about the optimal size of `p1` and `p2`... But you are right anyway, I should get rid of the branch!


---

Comment by jdemeyer created at 2016-01-25 10:33:30

Replying to [comment:6 vdelecroix]:
> {{{
> return (hash(x) + deg * p1) ^ ((deg - 1) * p2)
> }}}

I don't see why that would be better than my proposal. It is more complicated, but has the same inputs...


---

Comment by git created at 2016-01-25 10:46:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-01-25 10:48:55

I followed your suggestion but with a slightly larger value for `1009`.


---

Comment by jdemeyer created at 2016-01-25 10:51:32

Just use `hash(x) + 1500007*(F.degree() - 1)` by itself, no need for double hashing which only slows things down.


---

Comment by git created at 2016-01-25 11:06:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-25 11:29:20

How does this interact with #17569? If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.


---

Comment by vdelecroix created at 2016-01-25 11:46:20

Replying to [comment:12 jdemeyer]:
> How does this interact with #17569? 

No interaction as far as I can see.

> If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.

True. But it is disjoint from #17569, isn't it? Even without this patch hashes are incompatible by restriction to finite fields (except the prime field). It might be tricky to provide a coherent hash that would depend on the embedding... a (far from optimal) solution for finite field could be

```
def __hash__(self):
    cf = self._parent.coerce_embedding()
    if cf is not None:
        return hash(cf(self))
    else:
        ... old code ...
```

What do you think? But I would consider this as disjoint from this ticket.


---

Comment by saraedum created at 2016-05-27 17:42:21

Replying to [comment:12 jdemeyer]:
> If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.
I am not sure that this really is a good idea: https://wiki.sagemath.org/EqualityCoercion
In the long run we might have to move away from our "mathematical" implementation of `==` but this is not the focus of this ticket.
The changes propose here are a clear improvement of the current situation and seem perfectly fine to me.


---

Comment by saraedum created at 2016-05-27 17:42:21

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2016-05-27 17:47:46

Thanks for having a look! As a reviewer you should always
 - check the milestone
 - put your name in the "Reviewers" field
(I did it here)


---

Comment by vbraun created at 2016-05-28 12:13:42

Resolution: fixed
