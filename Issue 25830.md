# Issue 25830: Mitigate speed regression in polynomial division over ℤ

Issue created by migration from https://trac.sagemath.org/ticket/26067

Original creator: mmezzarobba

Original creation time: 2018-08-15 16:09:45

CC:  arojas @timokau

Speed up `//` for multivariate polynomials over ℤ after the regression discussed at #24735#comment:7. See also #25313.

#24735:

```
sage: P.<x,y> = ZZ[]
sage: p = 3*(-x^8*y^2 - x*y^9 + 6*x^8*y + 17*x^2*y^6 - x^3*y^2)
sage: q = 7*(x^2 + x*y + y^2 + 1)
sage: %timeit p//q
The slowest run took 43.99 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 278 µs per loop
```


This ticket:

```
sage: P.<x,y> = ZZ[]
sage: p = 3*(-x^8*y^2 - x*y^9 + 6*x^8*y + 17*x^2*y^6 - x^3*y^2)
sage: q = 7*(x^2 + x*y + y^2 + 1)
sage: %timeit p//q
The slowest run took 44.73 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 101 µs per loop
```



---

Comment by mmezzarobba created at 2018-08-15 16:09:57

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-08-16 02:02:15

For fairness, do you have timings before #24735?

Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?


---

Comment by arojas created at 2018-08-16 06:00:56

According to upstream [0], p_Divide returns 0 when the division is not exact. I have no idea what __floordiv__ should return for polynomials with integers coefficients given that it's not an Euclidean domain, but are you sure that this is what you want?

[0] https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2768


---

Comment by arojas created at 2018-08-16 06:07:40

Replying to [comment:2 tscrim]:
> Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?

There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)


---

Comment by tscrim created at 2018-08-16 13:16:29

Replying to [comment:4 arojas]:
> Replying to [comment:2 tscrim]:
> > Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?
> 
> There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)

Then all of [commit 9ffa9998](https://git.sagemath.org/sage.git/commit/?h=197ac562304611d9f946337332349bff9fa0d05d&id=9ffa9998f5739e010b607070ab1c0e2c41880a1c) is a typo? It is saying there is a `p_MDivide` function unless I am misunderstanding something.


---

Comment by arojas created at 2018-08-16 13:47:07

Replying to [comment:5 tscrim]:
> Replying to [comment:4 arojas]:
> > Replying to [comment:2 tscrim]:
> > > Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?
> > 
> > There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)
> 
> Then all of [commit 9ffa9998](https://git.sagemath.org/sage.git/commit/?h=197ac562304611d9f946337332349bff9fa0d05d&id=9ffa9998f5739e010b607070ab1c0e2c41880a1c) is a typo? It is saying there is a `p_MDivide` function unless I am misunderstanding something.

Ah, you're right. Looks like they differ in the extra 'ring' parameter. After this patch both versions are used in Sage, so neither should be removed


---

Comment by mmezzarobba created at 2019-02-13 11:19:28

Replying to [comment:3 arojas]:
> According to upstream [0], p_Divide returns 0 when the division is not exact. I have no idea what __floordiv__ should return for polynomials with integers coefficients given that it's not an Euclidean domain, but are you sure that this is what you want?

As far as I'm concerned it would be okay. But we could maybe also fall back on calling `reduce()` when `p_Divide` returns zero. That would be fast in the case that really makes sense, and slow but consistent with `reduce()` by construction in the general case. What do you think?


---

Comment by git created at 2019-02-14 10:17:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-02-14 10:22:53

Here is a new version that shouldn't break anything. Some timings using a benchmark that Bill Hart posted to sage-devel a while ago:


```
sage: P.<x,y,z,t> = ZZ[]
....: f = 1 + x + y + z + t;
....: p = f^20;
....: q = p*(p + 1);
....: %time _ = q//p
```


8.7.beta3: 5 min 7s

+ this ticket: 41.7 s


---

Comment by git created at 2019-02-14 14:12:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-14 14:15:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-02-16 19:07:33

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-02-16 19:07:33

LGTM.


---

Comment by mmezzarobba created at 2019-02-17 07:57:20

Replying to [comment:12 tscrim]:
> LGTM.

Thank you!


---

Comment by vbraun created at 2019-02-22 22:01:42

Resolution: fixed
