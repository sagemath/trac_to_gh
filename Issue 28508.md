# Issue 28508: Add environment.yml and src/environment.yml for "conda env create -f".

Issue created by migration from https://trac.sagemath.org/ticket/28745

Original creator: mkoeppe

Original creation time: 2019-11-16 18:07:53

CC:  isuruf saraedum dimpase embray

These file describes the conda environment (conda package dependencies):

`src/environment.yml` - describes packages needed for doing sagelib development. 

`environment.yml` - describes packages for sage-the-distribution development. In addition to `src/environment.yml`, this would include packages such as `automake`.


---

Comment by mkoeppe created at 2019-11-17 19:22:17

New commits:


---

Comment by mkoeppe created at 2019-11-17 19:22:17

Changing keywords from "" to "conda".


---

Comment by saraedum created at 2019-11-17 20:43:31

mkoeppe: I can only see one file in the diff here on trac. Did you forget to add the other?


---

Comment by mkoeppe created at 2019-11-17 20:44:52

This is how far I got!


---

Comment by mkoeppe created at 2019-11-17 20:45:58

Any help and discussion is welcome.


---

Comment by saraedum created at 2019-11-17 21:00:51

First of all, I think it's great to explore ways to provide an //alternative// to the SPKG system. I have been wanting to use conda for this for a long time.

I have not used conda-debug a lot but I think a combination of `conda debug [sagelib-recipe]`, `conda install sage`, `conda remove sagelib --force` should essentially do the right thing here as well.

A proper `environment.yml` file, as you propose, probably makes more sense though. For me the question is how we can make sure that it is kept up to date. We might want to use [GitLab](GitLab) CI to actually check that sagelib builds with that environment.yml.

In the long run, it would be great if doctests passed, see https://github.com/conda-forge/sagelib-feedstock/issues/19.


---

Comment by saraedum created at 2019-11-17 21:04:55

I am not sure I understand your intentions for the sage-the-distribution environment.yml. What would the workflow look like? Install that environment.yml, then force-uninstall the package that I want to work on? How would the SPKG system know which packages it needs to build now?


---

Comment by mkoeppe created at 2019-11-17 21:14:17

Replying to [comment:7 saraedum]:
> I am not sure I understand your intentions for the sage-the-distribution environment.yml. What would the workflow look like? Install that environment.yml, then force-uninstall the package that I want to work on? How would the SPKG system know which packages it needs to build now?
Through the spkg-configure mechanism that was introduced recently, sage-the-distribution decides whether to install its own version of the package; but this can be overridden using `configure` options such as `--with-system-glpk=force`. (Here "system", of course, from the viewpoint of sage, includes the conda packages.) Sage developers could use the conda environment to avoid compiling many packages by default, but still work on and install sage-the-distribution packages that override the packages provided by conda.


---

Comment by mkoeppe created at 2019-11-17 21:15:08

Replying to [comment:6 saraedum]:
> We might want to use [GitLab](GitLab) CI to actually check that sagelib builds with that environment.yml.
+1


---

Comment by saraedum created at 2019-11-17 21:26:33

So, to make this actually useful, we'd need the corresponding configure flags to use "system" for everything that is in environment.yml as well, right?


---

Comment by saraedum created at 2019-11-17 21:32:59

But maybe we should split this into two tickets. One to do the sagelib environment.yml, and then this one to do the more complicated sage-the-distribution environment.yml.


---

Comment by mkoeppe created at 2019-11-17 21:41:00

Replying to [comment:10 saraedum]:
> So, to make this actually useful, we'd need the corresponding configure flags to use "system" for everything that is in environment.yml as well, right?
No, the default is already to use the "system" package when it is available and deemed suitable by the configure test.
It can be changed to using the sage distribution's package by using `configure --with-system-glpk=no`.


---

Comment by mkoeppe created at 2019-11-17 21:42:04

Replying to [comment:11 saraedum]:
> But maybe we should split this into two tickets. One to do the sagelib environment.yml, and then this one to do the more complicated sage-the-distribution environment.yml.
Good idea. I have created #28752 for that and have narrowed down the present ticket.


---

Comment by mkoeppe created at 2019-11-17 21:46:23

Replying to [comment:14 mkoeppe]:
> Replying to [comment:11 saraedum]:
> > But maybe we should split this into two tickets. One to do the sagelib environment.yml, and then this one to do the more complicated sage-the-distribution environment.yml.
> Good idea. I have created #28752 for that and have narrowed down the present ticket.
(Actually, the sagelib one is more complicated - see #28752!)


---

Comment by git created at 2019-11-18 15:01:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-11-18 15:10:49

This works reasonably well already (this is on macOS Mojave, with current miniconda 3). 
I had the problem that `automake` and `aclocal` installed by conda segfault, so I bootstrapped Sage using the homebrew binaries.
Then, running `configure`, most packages that have `spkg-configure` scripts recognize the installed conda packages, with the following exceptions:

```
SAGE_SPKG_CONFIGURE_PERL_TERM_READLINE_GNU
SAGE_SPKG_CONFIGURE_PARI_SEADATA_SMALL
SAGE_SPKG_CONFIGURE_GF2X
SAGE_SPKG_CONFIGURE_LIBSEMIGROUPS
SAGE_SPKG_CONFIGURE_PATCH
SAGE_SPKG_CONFIGURE_ISL
SAGE_SPKG_CONFIGURE_PARI*
SAGE_SPKG_CONFIGURE_ECLIB
SAGE_SPKG_CONFIGURE_LCALC
```

Then, a parallel `make` succesfully compiled 135 packages but got stuck on `ecl-16.1.2.p5`, `openblas-0.3.6.p0`, and `tachyon-0.98.9.p7`.


---

Comment by isuruf created at 2019-11-18 15:26:17

For pari, you need to install `pari-nftables` as well. Can you post the config.log so that we can debug why the other packages are not picked up?

Btw, since this ticket focuses on spkg-configure, shouldn't the packages installed be limited to the ones with an spkg-configure?


---

Comment by mkoeppe created at 2019-11-18 17:32:33

Replying to [comment:21 isuruf]:
> since this ticket focuses on spkg-configure, shouldn't the packages installed be limited to the ones with an spkg-configure?
Good point.


---

Comment by saraedum created at 2019-11-21 21:31:17

mkoeppe, I think your environment.yml missed the pins from https://github.com/conda-forge/conda-forge-pinning-feedstock/blob/master/recipe/conda_build_config.yaml. I am adding them now.


---

Comment by saraedum created at 2019-11-21 22:44:58

mkoeppe, I update the environment yml. The only ones that don't work for me now are:

* perl_term_readline_gnu
* gp2c (from PARI)

isuruf: are they packaged somewhere on conda-forge?

Also I have to rely on the system's pkgconf. Do we have pkgconf in conda-forge?
----
New commits:


---

Comment by saraedum created at 2019-11-21 22:45:31

I'm building sage now with this environment.yml. Let's see how far I get…


---

Comment by mkoeppe created at 2019-11-21 22:51:28

Thanks a lot, this is looking great.

As for `perl_term_readline_gnu`, as far as I understand, conda-forge packages `perl` and `perl-app-cpanminus` but not individual CPAN packages, and one is expected to install any packages using `cpanminus`.


---

Comment by isuruf created at 2019-11-21 22:51:46

`perl_term_readline_gnu` and `gp2c` are not packaged. `pkgconf` is in conda-forge as `pkg-config`


---

Comment by isuruf created at 2019-11-21 22:56:50

If you are on Debian or Ubuntu, you need to fix #28533


---

Comment by saraedum created at 2019-11-21 22:57:10

Replying to [comment:29 isuruf]:
`pkgconf` is in conda-forge as `pkg-config`

Is this really the same thing? There's at least no pkgconf binary in pkg-config. And judging from my ArchLinux's pkgconf and conda-forge's pkg-config --help, these seem to be two different things.


---

Comment by saraedum created at 2019-11-21 22:59:14

Replying to [comment:27 saraedum]:
> I'm building sage now with this environment.yml. Let's see how far I get…

pkgconf and tachyon failed to build.


---

Comment by saraedum created at 2019-11-21 23:11:36

SageMath sets the following for tachyon:


```
+PNGINC= -I$(SAGE_LOCAL)/include
+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng -lz
```


Reporting to #27186 where the m4 script for libpng was added.


---

Comment by saraedum created at 2019-11-21 23:13:15

Tachyon's build is very confusing. It appears that they are ignoring the environment's CFLAGS.


---

Comment by isuruf created at 2019-11-21 23:16:26

Replying to [comment:31 saraedum]:
> Replying to [comment:29 isuruf]:
> `pkgconf` is in conda-forge as `pkg-config`
> 
> Is this really the same thing? There's at least no pkgconf binary in pkg-config. And judging from my ArchLinux's pkgconf and conda-forge's pkg-config --help, these seem to be two different things.

That's fine. They both do the same thing. https://github.com/pkgconf/pkgconf#compatibility-with-pkg-config


---

Comment by git created at 2019-11-21 23:34:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2019-11-22 06:09:38

Replying to [comment:28 mkoeppe]:
> but not individual CPAN packages

It's just that they haven't been package yet. If there's anybody who is interested in helping out, they can be packaged.


---

Comment by isuruf created at 2019-12-20 00:26:48

We can add `openblas, cliquer, r-base` to the list now.


---

Comment by isuruf created at 2019-12-21 19:00:23

New commits:


---

Comment by git created at 2019-12-21 19:03:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-12-22 03:04:29

The latter doesn't work for me:

```
$ conda env create -n sage -f environment.yml
Collecting package metadata (repodata.json): done
Solving environment: failed

ResolvePackageNotFound: 
  - blas-devel[build=*openblas]
```



---

Comment by mkoeppe created at 2020-01-14 18:44:49

Replying to [comment:41 dimpase]:
> The latter doesn't work for me:
> {{{
> $ conda env create -n sage -f environment.yml
> Collecting package metadata (repodata.json): done
> Solving environment: failed
> 
> ResolvePackageNotFound: 
>   - blas-devel[build=*openblas]
> }}}
Neither for me.


---

Comment by mkoeppe created at 2020-01-14 19:42:55

After removing this line, I get the following:

```
[python3-3.7.3.p1] /opt/conda/envs/sage/bin/x86_64-conda_cos6-linux-gnu-cc -pthread -shared -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/envs/sage/lib -Wl,-rpath-link,/opt/conda/envs/sage/lib -L/opt/conda/envs/sage/lib -L. -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/envs/sage/lib -Wl,-rpath-link,/opt/conda/envs/sage/lib -L/opt/conda/envs/sage/lib -L. -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/envs/sage/lib -Wl,-rpath-link,/opt/conda/envs/sage/lib -L/opt/conda/envs/sage/lib -DNDEBUG -D_FORTIFY_SOURCE=2 -O2 -isystem /opt/conda/envs/sage/include build/temp.linux-x86_64-3.7/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Modules/_ctypes/_ctypes.o build/temp.linux-x86_64-3.7/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Modules/_ctypes/callbacks.o build/temp.linux-x86_64-3.7/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Modules/_ctypes/callproc.o build/temp.linux-x86_64-3.7/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Modules/_ctypes/stgdict.o build/temp.linux-x86_64-3.7/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Modules/_ctypes/cfield.o -L. -L/sage/local/lib -L/opt/conda/envs/sage/lib -L/usr/local/lib -lffi -ldl -lpython3.7m -o build/lib.linux-x86_64-3.7/_ctypes.cpython-37m-x86_64-linux-gnu.so
[python3-3.7.3.p1] *** WARNING: renaming "_crypt" since importing it failed: build/lib.linux-x86_64-3.7/_crypt.cpython-37m-x86_64-linux-gnu.so: undefined symbol: crypt_r
...
[python3-3.7.3.p1] hashlib module imported OK
[python3-3.7.3.p1] Traceback (most recent call last):
[python3-3.7.3.p1]   File "<string>", line 1, in <module>
[python3-3.7.3.p1]   File "/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Lib/crypt.py", line 3, in <module>
[python3-3.7.3.p1]     import _crypt
[python3-3.7.3.p1] ModuleNotFoundError: No module named '_crypt'
[python3-3.7.3.p1] crypt module failed to import
[python3-3.7.3.p1] readline module imported OK
[python3-3.7.3.p1] socket module imported OK
[python3-3.7.3.p1] Error: One or more modules failed to import.
```

This is on a Debian docker image based on continuumio/miniconda3:latest - see attached


---

Attachment


---

Comment by mkoeppe created at 2020-01-14 20:53:36

I have created #29012 for this defect.


---

Comment by mkoeppe created at 2020-01-22 17:37:39

Would it be a good idea to generate this file from information to be put in `build/pkgs/SPKG/conda-environment.txt` as in #29053? 
----
New commits:


---

Comment by mkoeppe created at 2020-03-22 17:50:40

If one works around the python build failures of #29012 by using system python3 (#27824), several other errors show up:

Testsuite of libatomic_ops:

```
  [libatomic_ops-7.6.2]   /bin/bash ../libtool  --tag=CC   --mode=link /opt/conda/bin/x86_64-conda_cos6-linux-gnu-cc  -Wall -Wextra -Wpedantic -Wno-long-long -O2 -g -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /opt/conda/include   -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/lib -Wl,-rpath-link,/opt/conda/lib -L/opt/conda/lib -o test_malloc test_malloc.o -lpthread ../src/libatomic_ops_gpl.la ../src/libatomic_ops.la 
  [libatomic_ops-7.6.2]   libtool: link: /opt/conda/bin/x86_64-conda_cos6-linux-gnu-cc -Wall -Wextra -Wpedantic -Wno-long-long -O2 -g -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /opt/conda/include -Wl,-rpath -Wl,/sage/local/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z -Wl,relro -Wl,-z -Wl,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath -Wl,/opt/conda/lib -Wl,-rpath-link -Wl,/opt/conda/lib -o test_malloc test_malloc.o  -L/sage/local/lib -L/opt/conda/lib -lpthread ../src/.libs/libatomic_ops_gpl.a /sage/local/var/tmp/sage/build/libatomic_ops-7.6.2/src/src/.libs/libatomic_ops.a ../src/.libs/libatomic_ops.a
  [libatomic_ops-7.6.2]   /opt/conda/bin/../lib/gcc/x86_64-conda_cos6-linux-gnu/7.3.0/../../../../x86_64-conda_cos6-linux-gnu/bin/ld: ../src/.libs/libatomic_ops_gpl.a(atomic_ops_stack.o): in function `AO_double_compare_and_swap_release':
  [libatomic_ops-7.6.2]   /sage/local/var/tmp/sage/build/libatomic_ops-7.6.2/src/src/atomic_ops/sysdeps/gcc/generic.h:219: undefined reference to `__atomic_compare_exchange_16'
  [libatomic_ops-7.6.2]   collect2: error: ld returned 1 exit status
  [libatomic_ops-7.6.2]   make[7]: *** [Makefile:634: test_malloc] Error 1
```



---

Comment by mkoeppe created at 2020-03-22 17:58:46

... as well as giac and fflas_ffpack.

To reproduce: 

```
EXTRA_DOCKER_BUILD_ARGS="--build-arg TARGETS=\"build ptest\" --build-arg USE_MAKEFLAGS=\"-k V=0\"" tox -e docker-conda-forge-standard
```

on the branch of #27824.


---

Comment by mkoeppe created at 2020-03-22 18:03:19

(see also #29327)


---

Comment by git created at 2020-03-22 18:13:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-18 21:34:38

Shall we try to get this one here to work for 9.1?


---

Comment by git created at 2020-04-26 19:56:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-29 19:19:26

Changing priority from major to minor.


---

Comment by mkoeppe created at 2020-05-01 18:16:15

Moving some tickets to 9.2. This is not a promise that I will be working on them.


---

Comment by isuruf created at 2020-10-30 19:25:48

Changing status from new to needs_review.


---

Comment by isuruf created at 2020-10-30 22:27:02

I added `SAGE_ROOT/environment.yml` for spkg-configure ones and `SAGE_ROOT/src/environment.yml` for all standard packages. These files are auto generated. Not sure if we should check them into the repo for ease of use.


---

Comment by mkoeppe created at 2020-10-30 22:33:43

I don't think the generated files should be checked in - instead they should be added to the list of files that are put into the configure tarball.


---

Comment by mkoeppe created at 2020-10-30 22:36:46

See for example commit 885092e77b06b6d616297edd8ac1a37db9113cc6, where files were added


---

Comment by git created at 2020-10-30 22:40:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-30 22:41:52

Also, if you could untabify `src/doc/bootstrap`...


---

Comment by git created at 2020-10-30 22:53:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-30 23:16:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-11-01 10:31:03

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-11-01 10:31:03

Merge conflict


---

Comment by mkoeppe created at 2020-11-01 16:39:07

New commits:


---

Comment by mkoeppe created at 2020-11-01 16:39:07

Changing status from needs_work to positive_review.


---

Comment by isuruf created at 2020-11-10 17:57:28

New commits:


---

Comment by vbraun created at 2020-11-19 23:32:58

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-11-19 23:32:58

Merge conflict


---

Comment by isuruf created at 2020-11-19 23:36:00

Which branch should I fix the conflict against? `develop` doesn't seem to have a conflict with this branch


---

Comment by dimpase created at 2020-11-20 09:52:43

Replying to [comment:73 isuruf]:
> Which branch should I fix the conflict against? `develop` doesn't seem to have a conflict with this branch

it's unfortunate feauture of our workflow that this is a bit of a moving target.
https://github.com/vbraun/sage/tree/develop

do not try to merge/rebase with it, as it's likely to be in vain.


---

Comment by mkoeppe created at 2020-11-23 02:18:49

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2020-11-23 02:18:49

Last 10 new commits:


---

Comment by git created at 2020-11-23 02:21:19

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by git created at 2020-11-23 02:21:19

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-11-23 02:21:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-11-29 11:57:38

Resolution: fixed
