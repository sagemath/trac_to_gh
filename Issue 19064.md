# Issue 19064: Improved Graph.complement() (and cleanup in dense_graph.pyx)

Issue created by migration from https://trac.sagemath.org/ticket/19301

Original creator: ncohen

Original creation time: 2015-09-28 18:23:45

CC:  vdelecroix dimpase dcoudert borassi

This branch improves the algorithm behind `Graph.complement()`, which currently calls `has_edge(u,v)` for every pair of points.

With this, the computation of the complement is done on a dense graph, as it should.

Nathann


---

Comment by ncohen created at 2015-09-28 18:29:21

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-09-28 18:29:21

New commits:


---

Comment by dcoudert created at 2015-09-28 20:12:01

I like this patch ;)

However, there is a small issue:

```
sage -t --long src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 16320, in sage.graphs.generic_graph.GenericGraph.complement
Failed example:
    G.complement()
Expected:
    Traceback (most recent call last):
    ...
    TypeError: complement not well defined for (di)graphs with multiple edges
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.complement[9]>", line 1, in <module>
        G.complement()
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16341, in complement
        self._scream_if_not_simple()
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 1257, in _scream_if_not_simple
        raise ValueError(msg)
    ValueError: This method is not known to work on graphs with multiedges. Perhaps this method can be updated to handle them, but in the meantime if you want to use it please disallow multiedges using allow_multiple_edges().
**********************************************************************
1 item had failures:
   1 of  15 in sage.graphs.generic_graph.GenericGraph.complement
    [2950 tests, 1 failure, 56.23 s]
----------------------------------------------------------------------
sage -t --long src/sage/graphs/generic_graph.py  # 1 doctest failed
----------------------------------------------------------------------
```

Sorry, I know you don't like multiple edges ;)


---

Comment by ncohen created at 2015-09-28 20:15:48

Yo !

> I like this patch ;)

Yeah, me too. I have been giving a bad look to this `complement` function for a long time now, as it was clearly wasteful. Incidentally, this will "produce" many graphs with a 'dense' backend, while they are mostly non-existent in Sage nowadays. Perhaps new bugs related to this backend will pop out, or none if we are lucky.

> However, there is a small issue:

Arg, right. There were *two* checks for multiple edges in the same function, so I removed one but the error message changed. Will be fixed in a second.

Nathann


---

Comment by git created at 2015-09-28 20:19:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-09-28 21:22:00

Passes all tests on `src/sage/graphs/`.

Why don't you use `check_allocarray` or `MemoryAllocator`?


---

Comment by ncohen created at 2015-09-29 02:42:05

> Why don't you use `check_allocarray` or `MemoryAllocator`?

Because those pointers are sometimes reallocated (function 'resize'), and the two would not mix well.

Nathann


---

Comment by dcoudert created at 2015-09-29 06:14:33

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-09-29 06:14:33

Then the patch is good to go.


---

Comment by ncohen created at 2015-09-29 07:18:05

Thanks !


---

Comment by vbraun created at 2015-10-12 07:15:48

Resolution: fixed
