# Issue 19064: Improved Graph.complement() (and cleanup in dense_graph.pyx)

archive/issues_019064.json:
```json
{
    "body": "CC:  @videlec @dimpase @dcoudert borassi\n\nThis branch improves the algorithm behind `Graph.complement()`, which currently calls `has_edge(u,v)` for every pair of points.\n\nWith this, the computation of the complement is done on a dense graph, as it should.\n\nNathann\n\nIssue created by migration from https://trac.sagemath.org/ticket/19301\n\n",
    "created_at": "2015-09-28T18:23:45Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Improved Graph.complement() (and cleanup in dense_graph.pyx)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19064",
    "user": "https://github.com/nathanncohen"
}
```
CC:  @videlec @dimpase @dcoudert borassi

This branch improves the algorithm behind `Graph.complement()`, which currently calls `has_edge(u,v)` for every pair of points.

With this, the computation of the complement is done on a dense graph, as it should.

Nathann

Issue created by migration from https://trac.sagemath.org/ticket/19301





---

archive/issue_comments_261237.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-28T18:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261237",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_261238.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-09-28T18:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261238",
    "user": "https://github.com/nathanncohen"
}
```

New commits:



---

archive/issue_comments_261239.json:
```json
{
    "body": "I like this patch ;)\n\nHowever, there is a small issue:\n\n```\nsage -t --long src/sage/graphs/generic_graph.py\n**********************************************************************\nFile \"src/sage/graphs/generic_graph.py\", line 16320, in sage.graphs.generic_graph.GenericGraph.complement\nFailed example:\n    G.complement()\nExpected:\n    Traceback (most recent call last):\n    ...\n    TypeError: complement not well defined for (di)graphs with multiple edges\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.generic_graph.GenericGraph.complement[9]>\", line 1, in <module>\n        G.complement()\n      File \"/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16341, in complement\n        self._scream_if_not_simple()\n      File \"/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 1257, in _scream_if_not_simple\n        raise ValueError(msg)\n    ValueError: This method is not known to work on graphs with multiedges. Perhaps this method can be updated to handle them, but in the meantime if you want to use it please disallow multiedges using allow_multiple_edges().\n**********************************************************************\n1 item had failures:\n   1 of  15 in sage.graphs.generic_graph.GenericGraph.complement\n    [2950 tests, 1 failure, 56.23 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/graphs/generic_graph.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nSorry, I know you don't like multiple edges ;)",
    "created_at": "2015-09-28T20:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261239",
    "user": "https://github.com/dcoudert"
}
```

I like this patch ;)

However, there is a small issue:

```
sage -t --long src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 16320, in sage.graphs.generic_graph.GenericGraph.complement
Failed example:
    G.complement()
Expected:
    Traceback (most recent call last):
    ...
    TypeError: complement not well defined for (di)graphs with multiple edges
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.complement[9]>", line 1, in <module>
        G.complement()
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16341, in complement
        self._scream_if_not_simple()
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 1257, in _scream_if_not_simple
        raise ValueError(msg)
    ValueError: This method is not known to work on graphs with multiedges. Perhaps this method can be updated to handle them, but in the meantime if you want to use it please disallow multiedges using allow_multiple_edges().
**********************************************************************
1 item had failures:
   1 of  15 in sage.graphs.generic_graph.GenericGraph.complement
    [2950 tests, 1 failure, 56.23 s]
----------------------------------------------------------------------
sage -t --long src/sage/graphs/generic_graph.py  # 1 doctest failed
----------------------------------------------------------------------
```

Sorry, I know you don't like multiple edges ;)



---

archive/issue_comments_261240.json:
```json
{
    "body": "Yo !\n\n> I like this patch ;)\n\nYeah, me too. I have been giving a bad look to this `complement` function for a long time now, as it was clearly wasteful. Incidentally, this will \"produce\" many graphs with a 'dense' backend, while they are mostly non-existent in Sage nowadays. Perhaps new bugs related to this backend will pop out, or none if we are lucky.\n\n> However, there is a small issue:\n\nArg, right. There were *two* checks for multiple edges in the same function, so I removed one but the error message changed. Will be fixed in a second.\n\nNathann",
    "created_at": "2015-09-28T20:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261240",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> I like this patch ;)

Yeah, me too. I have been giving a bad look to this `complement` function for a long time now, as it was clearly wasteful. Incidentally, this will "produce" many graphs with a 'dense' backend, while they are mostly non-existent in Sage nowadays. Perhaps new bugs related to this backend will pop out, or none if we are lucky.

> However, there is a small issue:

Arg, right. There were *two* checks for multiple edges in the same function, so I removed one but the error message changed. Will be fixed in a second.

Nathann



---

archive/issue_comments_261241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-28T20:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_261242.json:
```json
{
    "body": "Passes all tests on `src/sage/graphs/`.\n\nWhy don't you use `check_allocarray` or `MemoryAllocator`?",
    "created_at": "2015-09-28T21:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261242",
    "user": "https://github.com/dcoudert"
}
```

Passes all tests on `src/sage/graphs/`.

Why don't you use `check_allocarray` or `MemoryAllocator`?



---

archive/issue_comments_261243.json:
```json
{
    "body": "> Why don't you use `check_allocarray` or `MemoryAllocator`?\n\nBecause those pointers are sometimes reallocated (function 'resize'), and the two would not mix well.\n\nNathann",
    "created_at": "2015-09-29T02:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261243",
    "user": "https://github.com/nathanncohen"
}
```

> Why don't you use `check_allocarray` or `MemoryAllocator`?

Because those pointers are sometimes reallocated (function 'resize'), and the two would not mix well.

Nathann



---

archive/issue_comments_261244.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-29T06:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261244",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_261245.json:
```json
{
    "body": "Then the patch is good to go.",
    "created_at": "2015-09-29T06:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261245",
    "user": "https://github.com/dcoudert"
}
```

Then the patch is good to go.



---

archive/issue_comments_261246.json:
```json
{
    "body": "Thanks !",
    "created_at": "2015-09-29T07:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261246",
    "user": "https://github.com/nathanncohen"
}
```

Thanks !



---

archive/issue_comments_261247.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-10-12T07:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19064#issuecomment-261247",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
