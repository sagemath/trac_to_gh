# Issue 13627: Upon quitting Sage, Maxima may keep running and eat up all memory

Issue created by migration from https://trac.sagemath.org/ticket/13831

Original creator: nthiery

Original creation time: 2012-12-14 13:11:11

Assignee: was

CC:  leif zimmerma

Keywords: maxima

How to reproduce:
In a clean directory, put the following makefile

```
truc:
	/opt/sage-5.2/sage crash-maxima.sage
```

(editing the location of sage to your local setup)

In a file crash-maxima.sage, put

```
x, y = var('x y')
desolve_rk4(x*y*(2-y), y, ics=[0,1], end_points=[0, 1], step=0.5)
```


then type:

```
    make truc
```


I did not manage to reduce this further, and in particular to reproduce the issue without going through ``make``. I tried the obvious things like checking what had changed in the environment and which shell was used to run the make recipe.

This is on Ubuntu 11.10, with Sage 5.3, 5.4, 5.4.1, and 5.5.rc0. With Sage 5.3 the memory seems to be eaten up at a faster speed. A few colleagues got the same crash on slightly different platforms (it appeared in our build process for the book Calcul MathÃ©matique avec Sage).


---

Comment by leif created at 2012-12-14 13:40:23

Changing keywords from "maxima" to "maxima orphans".


---

Comment by leif created at 2012-12-14 15:11:34

FWIW, I can reproduce this on Ubuntu 10.04.4 x86, Sage 5.5.rc0, GCC 4.7.2, ...

(I killed the Maxima process after a while, before running out of swap space.)


---

Comment by leif created at 2012-12-14 16:05:06

Same behavior when running `sage -c '...'` (replacing the single-quotes in `var(...)` by double-quotes of course) from a Sage subshell invoked by `make`, but not when starting `sage` interactively, pasting the commands, from such a subshell.

No idea yet what's really going on (i.e., what Maxima or ECL end up doing), but apparently some Sage scripts indeed "get confused" (or behave differently) when run from a `make` environment, probably then triggering some Maxima bug.


---

Comment by leif created at 2012-12-14 16:55:06

Replying to [comment:3 leif]:
> No idea yet what's really going on (i.e., what Maxima or ECL end up doing), but apparently some Sage scripts indeed "get confused" (or behave differently) when run from a `make` environment, probably then triggering some Maxima bug.

Still no idea, but it doesn't seem related to environment variables (set by `make`); the only ones that differ here are `MAKE`, `MAKEFLAGS`, `MFLAGS` (the latter both empty), and `MAKELEVEL`.  (And I can't reproduce Maxima running mad with `env MAKE=... MAKEFLAGS="" MFLAGS="" MAKELEVEL=1 /path/to/sage -c '...'`.)

Wonder whether some file descriptors _somehow<sup>TM</sup>_ get messed up...  (Although adding `print` to the Sage command line, the result is shown in all cases; using e.g. `make -j1` doesn't make any difference. )


---

Comment by leif created at 2012-12-14 18:46:17

Hmmm, at least using the following `Makefile` works as expected (no orphans, nor Maxima eating up all memory):


```make
maxima:
        /path/to/sage --maxima --very-quiet -r "rk(-x*(y-2)*y,y,1,[x,0,1,0.500000000000000]);"
```


So apparently _the pexpect interface_ (when run from `make`, but not in an interactive Sage session) causes Maxima to do something weird afterwards...


---

Comment by leif created at 2012-12-14 19:26:42

Replying to [comment:6 leif]:
> So apparently _the pexpect interface_ (when run from `make`, but not in an interactive Sage session) causes Maxima to do something weird afterwards...


```make

maxima-from-sage-prompt:
        /path/to/sage -c 'maxima("rk(-x*(y-2)*y,y,1,[x,0,1,0.500000000000000]);")'

maxima-from-sage-prompt-cleanup:
        /path/to/sage -c 'maxima("rk(-x*(y-2)*y,y,1,[x,0,1,0.500000000000000]);"); from sage.interfaces.maxima import __doctest_cleanup; __doctest_cleanup()'
```


While the first leaves Maxima running (eating up all memory, at least until `malloc()` or similar fails), the latter doesn't...


---

Comment by leif created at 2012-12-15 16:30:44

Incidentally(?) the issue is fixed in / by installing Maxima 5.29.1 (#13364), along with ECL 12.12.1 (#13324).

Both tickets are still work in progress atm, or at least needing review... :P
