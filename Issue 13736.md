# Issue 13736: Calling ntl.zz_p(x,0) crashes sage

Issue created by migration from https://trac.sagemath.org/ticket/13940

Original creator: mjo

Original creation time: 2013-01-10 21:08:29

Assignee: AlexGhitza

While investigating the behavior of `0^0`, I ran into this:


```
sage: ntl.zz_p(1,0)
/home/mjo/src/sage-5.6.beta2/local/lib/libcsage.so(print_backtrace+0x40)[0x7f5ef4c24f4d]
/home/mjo/src/sage-5.6.beta2/local/lib/libcsage.so(sigdie+0x23)[0x7f5ef4c24fa8]
/home/mjo/src/sage-5.6.beta2/local/lib/libcsage.so(sage_signal_handler+0x1ee)[0x7f5ef4c24a44]
/lib64/libpthread.so.0(+0x10810)[0x7f5efa272810]
/lib64/libc.so.6(gsignal+0x35)[0x7f5ef97e9b55]
/lib64/libc.so.6(abort+0x17a)[0x7f5ef97eaefa]
/home/mjo/src/sage-5.6.beta2/local/lib/libcsage.so(init_csage+0x0)[0x7f5ef4c25c7e]
/home/mjo/src/sage-5.6.beta2/local/lib/libntl.so(_ZN3NTL5ErrorEPKc+0x33)[0x7f5ef4633e83]
/home/mjo/src/sage-5.6.beta2/local/lib/libntl.so(_ZN3NTL9zz_pInfoTC2Ell+0x4ac)[0x7f5ef45d623c]
/home/mjo/src/sage-5.6.beta2/local/lib/libntl.so(_ZN3NTL11zz_pContextC1Ell+0x4c)[0x7f5ef45d654c]
/home/mjo/src/sage-5.6.beta2/local/lib/libcsage.so(zz_pContext_construct+0x57)[0x7f5ef4c29f34]
/home/mjo/src/sage-5.6.beta2/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_lzz_pContext.so(+0x39a8)[0x7f5ee76569a8]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(+0xc1783)[0x7f5efa541783]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyObject_Call+0x63)[0x7f5efa4cf6b3]
/home/mjo/src/sage-5.6.beta2/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_lzz_pContext.so(+0x48de)[0x7f5ee76578de]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyObject_Call+0x63)[0x7f5efa4cf6b3]
/home/mjo/src/sage-5.6.beta2/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_lzz_p.so(+0x6ce0)[0x7f5ee7445ce0]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(+0xc1783)[0x7f5efa541783]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyObject_Call+0x63)[0x7f5efa4cf6b3]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4666)[0x7f5efa590686]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x42)[0x7f5efa5935d2]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x668f)[0x7f5efa5926af]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5890)[0x7f5efa5918b0]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5890)[0x7f5efa5918b0]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5f68)[0x7f5efa591f88]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5890)[0x7f5efa5918b0]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5890)[0x7f5efa5918b0]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5890)[0x7f5efa5918b0]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x8bd)[0x7f5efa59349d]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x42)[0x7f5efa5935d2]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xc8)[0x7f5efa5b7f08]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x21f)[0x7f5efa5b8c2f]
/home/mjo/src/sage-5.6.beta2/local/lib/libpython2.7.so.1.0(Py_Main+0xc73)[0x7f5efa5d0253]
/lib64/libc.so.6(__libc_start_main+0xec)[0x7f5ef97d648c]
python(+0x8a9)[0x7f5efaaae8a9]

------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/home/mjo/src/sage-5.6.beta2/spkg/bin/sage: line 310:  9121 Aborted                 sage-ipython "$@" -i
```




---

Comment by nbruin created at 2013-01-10 23:40:58

Changing priority from major to minor.


---

Comment by nbruin created at 2013-01-10 23:40:58

`sage/libs/ntl/ntl_lzz_p.pyx`, line 57:

```
       The class zz_p implements arithmetic modulo p, for p smaller than a
       machine word.
    
       NOTE: This type is provided mostly for completeness, and shouldn't
       be used in any production code.
```

so that would make this a rather minor issue, perhaps.
`gdb` traceback:

```
#0  0x00000031cfe36285 in raise () from /lib64/libc.so.6
#1  0x00000031cfe37b9b in abort () from /lib64/libc.so.6
#2  0x00007fffed65fa67 in global_NTL_error_callback () from /usr/local/sage/5.6b1/local/lib/libcsage.so
#3  0x00007fffed3ceb7f in NTL::Error (s=0x7fffed40bc2f "zz_pContext: p must be > 1") at tools.c:48
```

so it's simply the `0` it's tripping over. Either the wrapper should catch invalid arguments (expensive?) or the code should be executing with an signal handler in place to catch the abort (`sig_on` switch is expensive!). Cheap option: document that people should check their inputs or risk coredump. This is a low-level interface for testing purposes after all.


---

Comment by jdemeyer created at 2013-02-22 21:05:51

> `sig_on` switch is expensive
_[citation needed]_


---

Comment by jdemeyer created at 2013-02-22 21:21:35

The thing with `sig_on()` is that everybody is claiming that `sig_on()`/`sig_off()` is extremely slow, using that as an excuses not to use it.

But in reality, `sig_on()` and `sig_off()` together take about 21 clock cycles on a Xeon X7460 (On Linux 2.6.24 with glibc 2.7). It's something and it cannot totally be ignored, but it would only really matter in very low-level code.


---

Comment by mjo created at 2013-02-26 18:50:55

I had initially listed this as part of #13786, but will leave it until this ticket is fixed. Whoever fixes this should just make `0^0 == 1`.


---

Comment by mjo created at 2020-02-09 00:06:20

Changing status from new to needs_review.


---

Comment by mjo created at 2020-02-09 00:06:20

I guess I should finally fix this.
----
New commits:


---

Comment by tscrim created at 2020-02-11 10:13:34

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-02-11 10:13:34

LGTM.


---

Comment by vbraun created at 2020-02-17 23:16:01

Resolution: fixed
