# Issue 20453: Live documentation in Jupyter using thebe

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2016-05-27 08:42:15

CC:  vdelecroix vbraun rbeezer slelievre tmonteil




---

Comment by nthiery created at 2016-05-27 09:07:11

New commits:


---

Comment by nthiery created at 2016-05-27 09:09:02

The current branch is not to be merged in Sage, as it contains some edits in the Sage's faq that are just here for quick testing (compiling the faq is fast!).


---

Comment by git created at 2016-05-27 15:43:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by nthiery created at 2016-05-28 09:13:42

Changing keywords from "" to "days77, jupyter, thebe, notebook".


---

Comment by git created at 2016-06-15 20:38:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-06-27 08:16:59

Everything seems to work (nice!). Some naive questions from a user point of view:

- would it be possible to remove the "sage: " string in the cells? It would be convenient since it perturb the editor. It would even be worse with the continuation "....:" since these are not ignored by the sage preparser...

Less importantly:

- why did you decide to have this "Run" and "Run Again" buttons? These do not exist in the standard Jupyter notebook. Would it be possible to simply remove them?

- the cells are properly executed when pressing "Shift + Enter" but, contrarily to the case of the notebook, after pressing "Shift + Enter" the focus is kept in the same cell. Not sure that it is desirable to move the focus (since the next cell might be very far).


---

Comment by vdelecroix created at 2016-06-27 16:18:04

I moved the part related to improvements to #20893. I definitely think that we should try to have something ready for the next beta release. And it is in good shape!


---

Comment by vdelecroix created at 2016-07-01 06:49:44

As discussed with Florent (by mail) the first step should be ready (see #20893 for next steps). I am going through the changes and testing this version.


---

Comment by vdelecroix created at 2016-07-01 06:49:44

Changing status from new to needs_review.


---

Comment by slelievre created at 2016-08-22 13:38:25

This ticket solves #17269.


---

Comment by tmonteil created at 2016-08-22 13:55:36

Replying to [comment:21 slelievre]:
> This ticket solves #17269.

Thanks for letting me know about the current ticket. This is indeed a blocker to leave sage notebook for good (this, and the fact that jupyter doen not handle `.rst` files as worksheets, let me continue to use the former during tutorials).


---

Comment by vdelecroix created at 2016-08-22 14:08:32

With the current version, the button `activate` does not appear in all situation. It does for the reference manual but not for `Help -> Thematic Tutorials -> Tutorial: Sage Introductory Programming (PREP)`.


---

Comment by vdelecroix created at 2016-08-22 14:08:32

Changing status from needs_review to needs_work.


---

Comment by tmonteil created at 2016-08-22 14:13:12

`thebe.js` should not be raw copied to Sage source code. Instead, it should be installed as a Sage package, so that it is easier to keep it up-to-date. Typically, the script you copied is adapted to Jupyter 4.0.5.


---

Comment by nthiery created at 2016-08-22 15:29:30

Hi Thierry,

Thanks for looking at this!

It was Volker's suggestion to just raw copy thebe.js in the sources.

One part of the rationale is simplicity. The other is that, once jupyterlab will have matured out, thebe.js is likely to become a thin layer on top of it, if not just a part of it. So it's not that crucial to take the efforts of a super clean long term solution.

But I don't have a strong opinion either.


---

Comment by tmonteil created at 2016-08-22 19:03:01

Having a dedicated spkg is not such a huge effort, and there are tons of temporary things in Sage that wait to be cleaned for years, let us not make things worse when we can avoid it. Let me just give a try.


---

Comment by tmonteil created at 2016-08-22 19:40:20

I wrote #21309 to package thebe.js (needs review) and let the current branch depend on that one (i.e. i replaced the hardcoded code to a symlink to the file provided by the spkg). It works well on my machine.

----
New commits:


---

Comment by tmonteil created at 2016-08-22 20:32:10

Replying to [comment:23 vdelecroix]:
> With the current version, the button `activate` does not appear in all situation. It does for the reference manual but not for `Help -> Thematic Tutorials -> Tutorial: Sage Introductory Programming (PREP)`.

I double checked this. Actually, the button does not appear when the pages do  not have cells (the first pages of the PREP are just pictures, no computations), but it does otherwise (see e.g. the "Calculus 1" page), so it is somehow a good feature.


---

Comment by tmonteil created at 2016-08-22 20:32:10

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2016-08-23 15:21:42

Replying to [comment:28 tmonteil]:
> I wrote #21309 to package thebe.js (needs review) and let the current branch depend on that one (i.e. i replaced the hardcoded code to a symlink to the file provided by the spkg). It works well on my machine.

Ça c'est gentil!

For the record, I had Florent Cayré on the phone this morning. He started looking at this, but somehow he has a technical issue posting messages on trac which we did not manage to debug. Anyway, we should be able to review this shortly (e.g. tomorrow during the Sage Days).


---

Comment by tmonteil created at 2016-08-23 17:55:27

Changing keywords from "days77, jupyter, thebe, notebook" to "days77, jupyter, thebe, notebook, sd75".


---

Comment by tmonteil created at 2016-08-23 17:55:27

Great ! (i just arrived at Cernay, barbecue tonight!)


---

Comment by git created at 2016-08-25 17:17:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2016-08-30 09:21:03

(Just editing ticket description, fixing formatting.)


---

Comment by nthiery created at 2016-09-04 15:34:33

Hi Vincent, Thierry,
Besides merging the latest #21309 when it's polished, do you consider this as ready to go?
It would be nice to be done with this!
Thanks,


---

Comment by tmonteil created at 2016-09-04 21:57:03

I changed the symlink from `local/share/thebejs/thebe.js` to `local/share/thebe/thebe.js` according to the renaming done in #21309. Since the two branches were completely entangled (lot of merges), i went back to the last Florent's commit, fixed the symlink and added (and updated) Nicola's comment in `thebe-sage.js` header. Now the two branches are completely independant, apart from the very last merge.

If you plan to modify something in the current ticket or in #21309, please undo the last merge before, or it will start to knit again.
----
New commits:


---

Comment by tmonteil created at 2016-09-04 22:09:04

Replying to [comment:35 nthiery]:
> Hi Vincent, Thierry,
> Besides merging the latest #21309 when it's polished, do you consider this as ready to go?
> It would be nice to be done with this!
> Thanks,

I did not inspect `thebe-sage.js` as i would have done for Python files. But its behaviour corresponds to the claimed feature and the code seem not malicious. So i guess it will be OK for me once the dependencies will be satisfied.


---

Comment by nthiery created at 2016-09-05 07:01:26

Thanks Thierry for the final version of #21309 (Jeroen is double checking it right now) and for cleaning the history.

I agree that we are on a thin line here since we don't have strong review standards set for js files like this one. For example we are missing tests! However writing such tests would take some infrastructure; we should discuss how to setup such infrastructure with the Jupyter people at some point, but for now I guess that's ok.

Vincent, any further comment?

Cheers,
                                 Nicolas


---

Comment by tmonteil created at 2016-09-05 08:07:53

Changing status from needs_review to needs_work.


---

Comment by tmonteil created at 2016-09-05 08:07:53

I have a doubt: to avoid race condition, i guess we should add thebe to the doc build dependencies.


---

Comment by git created at 2016-09-05 10:05:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-09-05 10:06:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2016-09-05 10:10:23

Replying to [comment:40 tmonteil]:
> I have a doubt: to avoid race condition, i guess we should add thebe to the doc build dependencies.

For this, i had to merge with sage.7.3 because the exact same line in `build/make/deps` changed there. Let us test the build like this (it might take some time). Again, if you plan to do some modifications, do not forget to undo the very last merge (with #21309) before.


---

Comment by nthiery created at 2016-09-05 13:58:46

Replying to [comment:43 tmonteil]:
> Replying to [comment:40 tmonteil]:
> > I have a doubt: to avoid race condition, i guess we should add thebe to the doc build dependencies.
> 
> For this, i had to merge with sage.7.3 because the exact same line in `build/make/deps` changed there. Let us test the build like this (it might take some time).

Ok, thanks!

> Again, if you plan to do some modifications, do not forget to undo the very last merge (with #21309) before.

We discussed this with Jeroen this morning. Unless Vincent has a specific requestion, we don't plan for further modifications.


---

Comment by vdelecroix created at 2016-09-05 15:57:42

(good for me)


---

Comment by tmonteil created at 2016-09-05 16:01:31

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2016-09-06 23:45:00

I don't want to remove the positive review but I would like some info about `/src/doc/common/themes/sage/static/thebe.js` which reads

```
../../../../../../local/share/thebe/thebe.js
```

Would there be a better way to refer to the `thebe.js` file installed by the `thebe` package? The above assume a particular sage install. I don't usually let people get away with putting `/local/` in anything these days as it is bad for stuff like sage-on-gentoo and more broadly sage-on-distro.


---

Comment by tmonteil created at 2016-09-07 09:39:00

I have no idea on how to do that. This kind of symlink already appears for `mathjax`, but the symlink is done when sagenb is installed. Unfortunately, there is no `sage_documentation` package where we could add a `spkg-install` script to install the symlink at build time. I you have an idea to improve this situation, it would be nice to implement it here and for mathjax as well.


---

Comment by fbissey created at 2016-09-07 09:48:58

I have no solution right now. I will have to find a way to live with it. I'll come up with something, I usually do in the end. It doesn't always make sense in vanilla sage unfortunately.


---

Comment by vbraun created at 2016-09-10 09:00:23

Resolution: fixed


---

Comment by jdemeyer created at 2016-09-18 11:00:55

Adding a symbolic link from the sources to some installation directory really makes no sense, especially because it is hardcoded. Having it installed by the `thebe` package would at least make slightly more sense. Of course, ideally we would just use `thebe.js` from the installation directory.


---

Comment by jdemeyer created at 2016-09-18 19:57:13

See #21527 for a follow-up on the symbolic link issue.


---

Comment by tmonteil created at 2016-10-16 19:52:42

Here is some feedback after real-life testing. I am currently teaching for a 3-week Sage tutorial, and there is a workflow issue, somehow `thebe.js` miss the main point of the sagenb live documentation.

On sagenb notebook, say the students work on some thematic tutorial, they do some tests, copy some lecturer's examples and want to keep their changes. What they can do is to click on `File` (top left) and then `Copy worksheet` so that the live documentation becomes a true sagenb worksheet they can save to come back on it later.

In the current case, we can do some tests and modifications (which is great), but all the work is lost when we close the webpage. We should have a button to export the current state into a (possibly degradated, we do not really care about the subtle html structure) `.ipynb` file that can then be saved.


---

Comment by nthiery created at 2016-10-17 07:25:16

Thanks Thierry for the feedback!

Yes, this is a very desirable feature, which we had already listed on #20893:

> - [ ] Add support in Thebe for basic export to Jupyter notebooks. A
>   quality loss (in particular in terms of the hierarchical
>   structure) is acceptable.

Do you mind merging this item with the new one you added there?


---

Comment by jdemeyer created at 2017-02-27 11:58:29

While preparing the report for OpenDreamKit, I just noticed that this is completely broken: #22458
