# Issue 16648: random failure with factorization of polynomials over finite fields

archive/issues_016648.json:
```json
{
    "body": "CC:  jpflori @vbraun\n\nTicket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random in that field. See the attached test file for a precise function that realizes the bug.\n\nSee also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).\n\nIssue created by migration from https://trac.sagemath.org/ticket/16885\n\n",
    "created_at": "2014-08-27T10:26:38Z",
    "labels": [
        "component: commutative algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "random failure with factorization of polynomials over finite fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16648",
    "user": "https://github.com/videlec"
}
```
CC:  jpflori @vbraun

Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random in that field. See the attached test file for a precise function that realizes the bug.

See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).

Issue created by migration from https://trac.sagemath.org/ticket/16885





---

archive/issue_comments_219444.json:
```json
{
    "body": "Attachment [test_polynomials.py](tarball://root/attachments/some-uuid/ticket16885/test_polynomials.py) by @videlec created at 2014-08-27 10:28:48",
    "created_at": "2014-08-27T10:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219444",
    "user": "https://github.com/videlec"
}
```

Attachment [test_polynomials.py](tarball://root/attachments/some-uuid/ticket16885/test_polynomials.py) by @videlec created at 2014-08-27 10:28:48



---

archive/issue_comments_219445.json:
```json
{
    "body": "Changing keywords from \"\" to \"random_fail\".",
    "created_at": "2014-08-27T10:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219445",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "" to "random_fail".



---

archive/issue_comments_219446.json:
```json
{
    "body": "Could you please describe the actual problem in the ticket description, preferably with a minimal example showing the bug.",
    "created_at": "2014-08-27T10:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219446",
    "user": "https://github.com/jdemeyer"
}
```

Could you please describe the actual problem in the ticket description, preferably with a minimal example showing the bug.



---

archive/issue_comments_219447.json:
```json
{
    "body": "Here is a little more detailed failure output:\n\n```\n<type 'list'> [0, Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 0, Mod(Mod(2, 3), Mod(1, 3)*\na^4 + Mod(2, 3)*a^3 + Mod(2, 3))]\n<type 'sage.libs.pari.gen.gen'> Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(\nMod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x\n<type 'sage.libs.pari.gen.gen'> [Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod\n(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + \nMod(2, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3\n))*x + Mod(Mod(2, 3)*a^3 + Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1]\n<type 'list'> [[Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^\n4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(\n1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +\n Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))]~, [1, 1, 1, 1]~]\n<type 'sage.libs.pari.gen.gen'> Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^3 + Mod(\nMod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a\n^3 + Mod(2, 3))\nERROR (after 761 iterations):\n polynomial   : 2*T^4 + 2*T^2 + T\n polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2\n factorization: <class 'sage.structure.factorization.Factorization'>, (2) * T * (T + 1) * (T + 2*z^2 + 2*z + 1) * (T + z^3 + z^2 + 2)\n product      : <type 'sage.rings.polynomial.polynomial_zz_pex.Polynomial_ZZ_pEX'>, 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T\n product parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2\n product      : 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T\n```\n\nbasically printing what happens when PARI is called before the slightly modified Vincent output.\n\nAs you might see, the factorization at the end of the call to factor() in polynomial element is correct.\nMore precisely, the first two factors in the PARI factorization are the same as what we get back in Vincent's file in the Factorization object, but the third one Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +\n Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)) = T + 2*z<sup>3+z</sup>2 does not appear there and the fourth one becomes the third one.\nThe fourth one (T + 2*z^2 + 2*z + 1) in Sage's Factorizaiton object is mysterious (and different from the one which disappeared from PARI fac object.",
    "created_at": "2014-08-28T15:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219447",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Here is a little more detailed failure output:

```
<type 'list'> [0, Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 0, Mod(Mod(2, 3), Mod(1, 3)*
a^4 + Mod(2, 3)*a^3 + Mod(2, 3))]
<type 'sage.libs.pari.gen.gen'> Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(
Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x
<type 'sage.libs.pari.gen.gen'> [Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod
(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + 
Mod(2, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3
))*x + Mod(Mod(2, 3)*a^3 + Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1]
<type 'list'> [[Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^
4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(
1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +
 Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))]~, [1, 1, 1, 1]~]
<type 'sage.libs.pari.gen.gen'> Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^3 + Mod(
Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a
^3 + Mod(2, 3))
ERROR (after 761 iterations):
 polynomial   : 2*T^4 + 2*T^2 + T
 polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2
 factorization: <class 'sage.structure.factorization.Factorization'>, (2) * T * (T + 1) * (T + 2*z^2 + 2*z + 1) * (T + z^3 + z^2 + 2)
 product      : <type 'sage.rings.polynomial.polynomial_zz_pex.Polynomial_ZZ_pEX'>, 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T
 product parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2
 product      : 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T
```

basically printing what happens when PARI is called before the slightly modified Vincent output.

As you might see, the factorization at the end of the call to factor() in polynomial element is correct.
More precisely, the first two factors in the PARI factorization are the same as what we get back in Vincent's file in the Factorization object, but the third one Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +
 Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)) = T + 2*z<sup>3+z</sup>2 does not appear there and the fourth one becomes the third one.
The fourth one (T + 2*z^2 + 2*z + 1) in Sage's Factorizaiton object is mysterious (and different from the one which disappeared from PARI fac object.



---

archive/issue_comments_219448.json:
```json
{
    "body": "Something wrong happens in:\n\n```\nF = [(R(f), int(e)) for f, e in zip(pols, exps)]\n```\n\nWith further debugging, it seems doing that without R and int is fine, and putting R and int breaks some values in the list.",
    "created_at": "2014-08-28T15:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219448",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Something wrong happens in:

```
F = [(R(f), int(e)) for f, e in zip(pols, exps)]
```

With further debugging, it seems doing that without R and int is fine, and putting R and int breaks some values in the list.



---

archive/issue_comments_219449.json:
```json
{
    "body": "Here is one quite smallish example:\n\n```\n[(Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(2, 3)*a^2 + Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(2, 3)*a^2 + Mod(2, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(1, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1)]\n<type 'list'> [(T + z^3 + 2*z^2 + 1, 1), (T + z^3, 1), (T + z^4 + z^3 + z^2 + 2, 1), (T + 2*z^4 + 2*z^2 + 2*z, 1), (T + 2*z^4 + z^3 + z^2 + z, 1)]\n```\n\nand the ring/pol were:\n\n```\npolynomial   : T^5 + 2*T^4 + 1\n polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^5 + 2*x + 1\n factorization: <class 'sage.structure.factorization.Factorization'>, (T + z^3) * (T + z^3 + 2*z^2 + 1) * (T + z^4 + z^3 + z^2 + 2) * (T + 2*z^4 + 2*z^2 + 2*z) * (T + 2*z^4 + z^3 + z^2 + z)\n```\n\n}}}",
    "created_at": "2014-08-28T15:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219449",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Here is one quite smallish example:

```
[(Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(2, 3)*a^2 + Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(2, 3)*a^2 + Mod(2, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(1, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1)]
<type 'list'> [(T + z^3 + 2*z^2 + 1, 1), (T + z^3, 1), (T + z^4 + z^3 + z^2 + 2, 1), (T + 2*z^4 + 2*z^2 + 2*z, 1), (T + 2*z^4 + z^3 + z^2 + z, 1)]
```

and the ring/pol were:

```
polynomial   : T^5 + 2*T^4 + 1
 polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^5 + 2*x + 1
 factorization: <class 'sage.structure.factorization.Factorization'>, (T + z^3) * (T + z^3 + 2*z^2 + 1) * (T + z^4 + z^3 + z^2 + 2) * (T + 2*z^4 + 2*z^2 + 2*z) * (T + 2*z^4 + z^3 + z^2 + z)
```

}}}



---

archive/issue_comments_219450.json:
```json
{
    "body": "Simpler test without factor stuff:\n\n```\nwhile True:\n    d = ZZ.random_element(2,10)\n    K = GF(3**d, 'a')\n    R = PolynomialRing(K, 'x')\n    for i in xrange(10**4):\n        f = R.random_element()\n        if f != pari([c._pari_(\"a\") for c in R(pari(f))]).Polrev():\n            print f, pari(f), R(pari(f)), i\n            raise ValueError\n```\n\nDoes someone confirm failures with that one?",
    "created_at": "2014-08-28T16:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219450",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Simpler test without factor stuff:

```
while True:
    d = ZZ.random_element(2,10)
    K = GF(3**d, 'a')
    R = PolynomialRing(K, 'x')
    for i in xrange(10**4):
        f = R.random_element()
        if f != pari([c._pari_("a") for c in R(pari(f))]).Polrev():
            print f, pari(f), R(pari(f)), i
            raise ValueError
```

Does someone confirm failures with that one?



---

archive/issue_comments_219451.json:
```json
{
    "body": "Replying to [comment:10 jpflori]:\n> Does someone confirm failures with that one?\n\nYes, got a failure as well. You might update the description of the ticket.\n\nVincent",
    "created_at": "2014-08-28T16:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219451",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:10 jpflori]:
> Does someone confirm failures with that one?

Yes, got a failure as well. You might update the description of the ticket.

Vincent



---

archive/issue_comments_219452.json:
```json
{
    "body": "I am also getting failures with the following variant:\n\n```python\nwhile True:\n    d = ZZ.random_element(2, 8)\n    K = GF(3**d, 'a')\n    R = PolynomialRing(K, 'x')\n    f = R.random_element()\n    pf = pari(f)\n    pfl = pf.list()\n    Kpfl = [K(c) for c in pfl]\n    Rf = R(Kpfl)\n    if f != Rf:\n        print f, pf, pfl, Kpfl, Rf\n        raise ValueError\n```\n\nThe values in one particularly simple case are as follows (applied `lift(lift(...))` to PARI objects to make them readable):\n\n```\nf = a^3*x^2 + (a^3 + 2*a^2 + a)*x\npf = a^3*x^2 + (a^3 + 2*a^2 + a)*x\npfl = [0, a^3 + 2*a^2 + a, a^3]\nKpfl = [0, a^3 + 2*a^2 + a, a^3]\nRf = a^3*x^2 + (2*a^2 + 2*a + 2)*x\n```\n\nEverything is consistent up to the conversion of `Kpfl` (the list of coefficients) to a polynomial, where the coefficient `a^3 + 2*a^2 + a` changes into `2*a^2 + 2*a + 2`.",
    "created_at": "2014-08-28T18:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219452",
    "user": "https://github.com/pjbruin"
}
```

I am also getting failures with the following variant:

```python
while True:
    d = ZZ.random_element(2, 8)
    K = GF(3**d, 'a')
    R = PolynomialRing(K, 'x')
    f = R.random_element()
    pf = pari(f)
    pfl = pf.list()
    Kpfl = [K(c) for c in pfl]
    Rf = R(Kpfl)
    if f != Rf:
        print f, pf, pfl, Kpfl, Rf
        raise ValueError
```

The values in one particularly simple case are as follows (applied `lift(lift(...))` to PARI objects to make them readable):

```
f = a^3*x^2 + (a^3 + 2*a^2 + a)*x
pf = a^3*x^2 + (a^3 + 2*a^2 + a)*x
pfl = [0, a^3 + 2*a^2 + a, a^3]
Kpfl = [0, a^3 + 2*a^2 + a, a^3]
Rf = a^3*x^2 + (2*a^2 + 2*a + 2)*x
```

Everything is consistent up to the conversion of `Kpfl` (the list of coefficients) to a polynomial, where the coefficient `a^3 + 2*a^2 + a` changes into `2*a^2 + 2*a + 2`.



---

archive/issue_comments_219453.json:
```json
{
    "body": "Hi Peter,\n\nJust to mention, using your code, we also get the fact that it works the second time\n\n```\nsage: while True:\n....:         d = ZZ.random_element(2, 8)\n....:         K = GF(3**d, 'a')\n....:         R = PolynomialRing(K, 'x')\n....:         f = R.random_element()\n....:         pf = pari(f)\n....:         pfl = pf.list()\n....:         Kpfl = [K(c) for c in pfl]\n....:         Rf = R(Kpfl)\n....:         if f != Rf:\n....:                 print f, pf, pfl, Kpfl, Rf\n....:                 raise ValueError\n<BOOM>\nsage: R(Kpfl) == f\nTrue\n```\n",
    "created_at": "2014-08-30T16:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219453",
    "user": "https://github.com/videlec"
}
```

Hi Peter,

Just to mention, using your code, we also get the fact that it works the second time

```
sage: while True:
....:         d = ZZ.random_element(2, 8)
....:         K = GF(3**d, 'a')
....:         R = PolynomialRing(K, 'x')
....:         f = R.random_element()
....:         pf = pari(f)
....:         pfl = pf.list()
....:         Kpfl = [K(c) for c in pfl]
....:         Rf = R(Kpfl)
....:         if f != Rf:
....:                 print f, pf, pfl, Kpfl, Rf
....:                 raise ValueError
<BOOM>
sage: R(Kpfl) == f
True
```




---

archive/issue_comments_219454.json:
```json
{
    "body": "The error occurs more precisely in the initialization of ` Polynomial_ZZ_pEX`. It can be tracked with the following modifications\n\n```\n--- a/src/sage/rings/polynomial/polynomial_zz_pex.pyx\n+++ b/src/sage/rings/polynomial/polynomial_zz_pex.pyx\n@@ -132,6 +132,7 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):\n             x = x.list()\n \n         if PY_TYPE_CHECK(x, list) or PY_TYPE_CHECK(x, tuple):\n+            y = x[:]\n             Polynomial.__init__(self, parent, is_gen=is_gen)\n             (<Polynomial_template>self)._cparent = get_cparent(parent)\n             celement_construct(&self.x, (<Polynomial_template>self)._cparent)\n@@ -143,6 +144,19 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):\n                 e = K(e)\n                 d = parent._modulus.ZZ_pE(list(e.polynomial()))\n                 ZZ_pEX_SetCoeff(self.x, i, d.x)\n+            while y and y[-1] == 0:\n+                y.pop(-1)\n+            if list(self) != y:\n+                print \"ERROR in Polynomial_ZZ_pEX constructor\"\n+                print \"call with args:\"\n+                print \"  x = {}\".format(x)\n+                print \"  check = {}\".format(check)\n+                print \"  is_gen = {}\".format(is_gen)\n+                print \"  construct = {}\".format(construct)\n+                print \"but got the result {}\".format(self)\n+                print \"variables\"\n+                print \"  K = {}\".format(K)\n+                raise RuntimeError\n             return\n```\n\nand running\n\n```\nwhile True:\n    d = ZZ.random_element(2, 8)\n    K = GF(3**d, 'a')\n    R = PolynomialRing(K, 'x')\n    f = R.random_element()\n    l = [K(c) for c in f._pari_().list()]\n    g = R(l)\n```\n\nI got the following kind of error\n\n```\nERROR in Polynomial_ZZ_pEX constructor\ncall with args:\n  x = [a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + a^4 + a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2]\n  check = True\n  is_gen = False\n  construct = False\nbut got the result (a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2)*x^2 + (2*a^5 + 2*a^4 + a^3 + a^2 + 2)*x + a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1\nvariables\n  K = Finite Field in a of size 3^7\n```\n\n\nMight be related or not:\n- if I replace `f._pari_().list()` with `list(f._pari_())` in the code above then the RAM just fill in few seconds\n- if I replace `f._pari_().list()` with `f.list()` then I do not see error anymore\n\nVincent",
    "created_at": "2014-08-30T18:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219454",
    "user": "https://github.com/videlec"
}
```

The error occurs more precisely in the initialization of ` Polynomial_ZZ_pEX`. It can be tracked with the following modifications

```
--- a/src/sage/rings/polynomial/polynomial_zz_pex.pyx
+++ b/src/sage/rings/polynomial/polynomial_zz_pex.pyx
@@ -132,6 +132,7 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):
             x = x.list()
 
         if PY_TYPE_CHECK(x, list) or PY_TYPE_CHECK(x, tuple):
+            y = x[:]
             Polynomial.__init__(self, parent, is_gen=is_gen)
             (<Polynomial_template>self)._cparent = get_cparent(parent)
             celement_construct(&self.x, (<Polynomial_template>self)._cparent)
@@ -143,6 +144,19 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):
                 e = K(e)
                 d = parent._modulus.ZZ_pE(list(e.polynomial()))
                 ZZ_pEX_SetCoeff(self.x, i, d.x)
+            while y and y[-1] == 0:
+                y.pop(-1)
+            if list(self) != y:
+                print "ERROR in Polynomial_ZZ_pEX constructor"
+                print "call with args:"
+                print "  x = {}".format(x)
+                print "  check = {}".format(check)
+                print "  is_gen = {}".format(is_gen)
+                print "  construct = {}".format(construct)
+                print "but got the result {}".format(self)
+                print "variables"
+                print "  K = {}".format(K)
+                raise RuntimeError
             return
```

and running

```
while True:
    d = ZZ.random_element(2, 8)
    K = GF(3**d, 'a')
    R = PolynomialRing(K, 'x')
    f = R.random_element()
    l = [K(c) for c in f._pari_().list()]
    g = R(l)
```

I got the following kind of error

```
ERROR in Polynomial_ZZ_pEX constructor
call with args:
  x = [a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + a^4 + a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2]
  check = True
  is_gen = False
  construct = False
but got the result (a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2)*x^2 + (2*a^5 + 2*a^4 + a^3 + a^2 + 2)*x + a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1
variables
  K = Finite Field in a of size 3^7
```


Might be related or not:
- if I replace `f._pari_().list()` with `list(f._pari_())` in the code above then the RAM just fill in few seconds
- if I replace `f._pari_().list()` with `f.list()` then I do not see error anymore

Vincent



---

archive/issue_comments_219455.json:
```json
{
    "body": "I go a bit further and seems that the trouble comes from the initialization in the Sage NTL wrapper. More precisely, in the constructor of `Polynomial_ZZ_pEX` there is a problem in the following loop\n\n```\nfor i,e in enumerate(x):\n    # self(x) is supposed to be a conversion,\n    # not necessarily a coercion. So, we must\n    # not do K.coerce(e) but K(e).\n    e = K(e)\n    d = parent._modulus.ZZ_pE(list(e.polynomial()))\n    ZZ_pEX_SetCoeff(self.x, i, d.x)\n```\n\nWhen an error occurs the coefficient `list(e.polynomial())` is right but `d` is wrong. The mysterious `parent._modulus` is of class `ntl_ZZ_pEContext_class` in `libs/ntl/ntl_ZZ_pEContext.pyx`. The file is poorly documented and I do not know NTL enough to dig further.\n\nVincent",
    "created_at": "2014-08-31T10:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219455",
    "user": "https://github.com/videlec"
}
```

I go a bit further and seems that the trouble comes from the initialization in the Sage NTL wrapper. More precisely, in the constructor of `Polynomial_ZZ_pEX` there is a problem in the following loop

```
for i,e in enumerate(x):
    # self(x) is supposed to be a conversion,
    # not necessarily a coercion. So, we must
    # not do K.coerce(e) but K(e).
    e = K(e)
    d = parent._modulus.ZZ_pE(list(e.polynomial()))
    ZZ_pEX_SetCoeff(self.x, i, d.x)
```

When an error occurs the coefficient `list(e.polynomial())` is right but `d` is wrong. The mysterious `parent._modulus` is of class `ntl_ZZ_pEContext_class` in `libs/ntl/ntl_ZZ_pEContext.pyx`. The file is poorly documented and I do not know NTL enough to dig further.

Vincent



---

archive/issue_comments_219456.json:
```json
{
    "body": "I suspected something with NTL and contexts wrongly restored at some point but did not investigate far enough and thought \"well it doesn't seem NTL is used that much in the problematic code, just PARI and factorization\".\nBut with your info it seems it might indeed be some problem with NTL contexts restoration (at the C++ level).\nI'll try to track it down.",
    "created_at": "2014-09-01T13:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219456",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I suspected something with NTL and contexts wrongly restored at some point but did not investigate far enough and thought "well it doesn't seem NTL is used that much in the problematic code, just PARI and factorization".
But with your info it seems it might indeed be some problem with NTL contexts restoration (at the C++ level).
I'll try to track it down.



---

archive/issue_comments_219457.json:
```json
{
    "body": "Might be something like #9524.\nThere we found out that the NTL context stuff for the polynomial defining the finite field was restored, but the context for the integer giving the characteristic was not.",
    "created_at": "2014-09-01T13:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219457",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Might be something like #9524.
There we found out that the NTL context stuff for the polynomial defining the finite field was restored, but the context for the integer giving the characteristic was not.



---

archive/issue_comments_219458.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-01T15:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219458",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_219459.json:
```json
{
    "body": "It seems adding a little contexts restoration helps solves this.\n----\nNew commits:",
    "created_at": "2014-09-01T15:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219459",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

It seems adding a little contexts restoration helps solves this.
----
New commits:



---

archive/issue_comments_219460.json:
```json
{
    "body": "Maybe we should add a test, but it implies finding an easily and quickly reproducible test...\n\nFixing the typos I did would be nice as well :)",
    "created_at": "2014-09-01T15:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219460",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Maybe we should add a test, but it implies finding an easily and quickly reproducible test...

Fixing the typos I did would be nice as well :)



---

archive/issue_comments_219461.json:
```json
{
    "body": "I don't think you need the `<ntl_ZZ_pX>` cast.",
    "created_at": "2014-09-01T16:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219461",
    "user": "https://github.com/jdemeyer"
}
```

I don't think you need the `<ntl_ZZ_pX>` cast.



---

archive/issue_comments_219462.json:
```json
{
    "body": "Yep, that's highly probable.\nI just got it from the previous snippet of code.",
    "created_at": "2014-09-01T18:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219462",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Yep, that's highly probable.
I just got it from the previous snippet of code.



---

archive/issue_comments_219463.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-12T21:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219463",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_016123.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2014-09-16T18:47:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16648#event-16123"
}
```



---

archive/issue_comments_219464.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-16T18:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16648#issuecomment-219464",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
