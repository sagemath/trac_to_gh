# Issue 30979: tox.ini (local): Add environment variables to skip system package installs, mechanism for a local interactive shell

Issue created by migration from https://trac.sagemath.org/ticket/31216

Original creator: mkoeppe

Original creation time: 2021-01-09 19:19:23

CC:  @tobiasdiez @kliem dimpase

(from #31064)

We add the following to the `local-...` environments:

- an environment variable that can be passed to tox to skip system package installs, directly reusing a previously set up system

  This can save time and also give developers more control for experiments with system packages.

- a target or environment variable to give an interactive shell.


---

Comment by mkoeppe created at 2021-01-09 21:17:51

Last 10 new commits:


---

Comment by git created at 2021-01-10 00:46:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-10 00:47:17

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2021-01-10 12:57:48

On a first glance this looks good. Thanks! Could you please also add documentation for these tox commands / switches. Also I was wondering if one could add a `tox -e local-homebrew-macos-standard -- install-system-packages` that only installs the system packages?


---

Comment by git created at 2021-01-10 21:07:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-11 04:36:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-11 04:38:12

Replying to [comment:8 gh-tobiasdiez]:
> Could you please also add documentation for these tox commands / switches. 

Done

> Also I was wondering if one could add a `tox -e local-homebrew-macos-standard -- install-system-packages` that only installs the system packages?

I have instead added more `SKIP_...` options.


---

Comment by @tobiasdiez created at 2021-01-11 15:23:21

Replying to [comment:12 mkoeppe]:
> I have instead added more `SKIP_...` options.
> 

Thanks! Would it also make sense to add one to skip `make`? (I remember you once told me how to do this, I think, it was via `config.status` or something - but maybe the version using skip is closer in spirit anyway).

I'll review this once #30944 is merged in develop.


---

Comment by mkoeppe created at 2021-01-11 19:10:53

Replying to [comment:13 gh-tobiasdiez]:
> Would it also make sense to add one to skip `make`? 

You can just pass a make target that does nothing - such as `Makefile`


---

Comment by @tobiasdiez created at 2021-01-12 12:56:13

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2021-01-12 12:56:13

> local-sudo-standard run-test: commands[1] | bash -c 'case "" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo update) ;;'/usr/bin/bash: -c: line 1: syntax error: unexpected end of file

I think there is a "esac" missing at the end of these two lines:

```

+    local-{root,sudo}:    bash -c 'case "{env:SKIP_SYSTEM_PKG_INSTALL:}" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command {env:SYSTEM} {env:__SUDO:} update) ;;'
+    local-{root,sudo}:    bash -c 'case "{env:SKIP_SYSTEM_PKG_INSTALL:}" in 1|y*|Y*);; *) PACKAGES=$(build/bin/sage-get-system-packages {env:SYSTEM} $(PATH=build/bin:$PATH build/bin/sage-package list {env:SAGE_PACKAGE_LIST_ARGS}) _bootstrap); eval $(build/bin/sage-print-system-package-command {env:SYSTEM} {env:__SUDO:} --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ;;'

```



---

Comment by @tobiasdiez created at 2021-01-12 13:48:49

Replying to [comment:14 mkoeppe]:
> Replying to [comment:13 gh-tobiasdiez]:
> > Would it also make sense to add one to skip `make`? 
> 
> You can just pass a make target that does nothing - such as `Makefile` 
> 


`tox -e local-sudo-standard Makefile` with `SKIP_BOOTSTRAP: yes` and `SKIP_CONFIGURE: yes` still runs `bootstrap` and `base-toolchain` in the `make` command, which then fails since `configure` was not called before.


---

Comment by mkoeppe created at 2021-01-12 18:15:36

Ah, of course. Make that `configure.ac` instead of `Makefile`...


---

Comment by @tobiasdiez created at 2021-01-18 17:05:16

That worked, thanks! Apart from the missing "esac" mentioned above, this looks good to me.


---

Comment by git created at 2021-01-18 19:33:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-18 19:33:46

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-01-19 15:44:28

Is the prefix `[mkoeppe`@`sage sage]$` really needed / what's its purpose?
https://github.com/sagemath/sagetrac-mirror/compare/u/mkoeppe/tox__improve_local_sudo_ubuntu_standard...u/mkoeppe/tox_ini__local___add_environment_variables_to_skip_system_package_installs__mechanism_for_a_local_interactive_shell#diff-c13a55474e037a35696cfba4768b81295c0383f1940052c5fcbef0737387f165R610

Otherwise the changes look good to me.


---

Comment by mkoeppe created at 2021-01-19 19:06:41

Replying to [comment:21 gh-tobiasdiez]:
> Is the prefix `[mkoeppe`@`sage sage]$` really needed / what's its purpose?

It's a typical shell prompt on posix systems. The second `sage` indicates the current directory. This is consistent with other parts of the Sage developer guide, for example https://doc.sagemath.org/html/en/developer/doctesting.html


---

Comment by @tobiasdiez created at 2021-01-19 21:18:01

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2021-01-19 21:18:01

Thanks, then it looks good to me!


---

Comment by mkoeppe created at 2021-01-19 21:18:57

Thanks!


---

Comment by vbraun created at 2021-01-31 20:53:33

Resolution: fixed
