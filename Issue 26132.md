# Issue 26132: Improve triconnectivity algorithm: some cythonization

archive/issues_026132.json:
```json
{
    "body": "CC:  @meghanamreddy saiharsh @tscrim\n\nWe do some speed up improvements by\n- changing the way edges are stored internally\n- simplifying method ``__split_multiple_edges``\n- declare variable types\n- use int arrays\n\nIssue created by migration from https://trac.sagemath.org/ticket/26369\n\n",
    "created_at": "2018-10-01T07:03:50Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Improve triconnectivity algorithm: some cythonization",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26132",
    "user": "https://github.com/dcoudert"
}
```
CC:  @meghanamreddy saiharsh @tscrim

We do some speed up improvements by
- changing the way edges are stored internally
- simplifying method ``__split_multiple_edges``
- declare variable types
- use int arrays

Issue created by migration from https://trac.sagemath.org/ticket/26369





---

archive/issue_comments_368040.json:
```json
{
    "body": "This commit changes the way to deal with edges. We now associate each edge a unique identifier (int) and then store that identifier instead of the edge in data structures such as internal dictionaries, the doubly link list, the components, etc.\n\nAfter that we can turn many data structures to arrays. Furthermore, it ensures that `_LinkedListNode` only stores an integer\nvalue and not any types.\n\nOn the way, we drastically simplify method `__split_multiple_edges`. Indeed, we don't need to sort edges, but to arrange edges with same end points into buckets. If a bucket has more than one edge, we have a set of multiple edges.\n----\nNew commits:",
    "created_at": "2018-10-01T07:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368040",
    "user": "https://github.com/dcoudert"
}
```

This commit changes the way to deal with edges. We now associate each edge a unique identifier (int) and then store that identifier instead of the edge in data structures such as internal dictionaries, the doubly link list, the components, etc.

After that we can turn many data structures to arrays. Furthermore, it ensures that `_LinkedListNode` only stores an integer
value and not any types.

On the way, we drastically simplify method `__split_multiple_edges`. Indeed, we don't need to sort edges, but to arrange edges with same end points into buckets. If a bucket has more than one edge, we have a set of multiple edges.
----
New commits:



---

archive/issue_comments_368041.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-01T07:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368041",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368042.json:
```json
{
    "body": "In the second commit, we declare simple types, use int arrays instead of list/dict, etc.",
    "created_at": "2018-10-01T07:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368042",
    "user": "https://github.com/dcoudert"
}
```

In the second commit, we declare simple types, use int arrays instead of list/dict, etc.



---

archive/issue_comments_368043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-01T16:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368044.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-01T16:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368044",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_368045.json:
```json
{
    "body": "This last commit uses the observation that the index in list `int_to_edge` of virtual edges is `>= m` (the first virtual edge has index `m`, the second `m+1`, etc.). \n- The internal label of a virtual edge is now its index.\n- To test if an edge is a virtual edge, it suffices to test if its index is `>= m`.\n- We introduce 2 arrays to store edges extremities. The main motivation is to avoid constantly accessing list `int_to_edge`.\n\nMore cythonization can be done, in particular for the doubly linked list, but I don't know yet what's the best way to do it. May be for another ticket. We already do a lot here.\n\nAlso, I have some doubt in types declarations between `int` and `Py_ssize_t`. When should we use this `Py_ssize_t` ?",
    "created_at": "2018-10-01T16:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368045",
    "user": "https://github.com/dcoudert"
}
```

This last commit uses the observation that the index in list `int_to_edge` of virtual edges is `>= m` (the first virtual edge has index `m`, the second `m+1`, etc.). 
- The internal label of a virtual edge is now its index.
- To test if an edge is a virtual edge, it suffices to test if its index is `>= m`.
- We introduce 2 arrays to store edges extremities. The main motivation is to avoid constantly accessing list `int_to_edge`.

More cythonization can be done, in particular for the doubly linked list, but I don't know yet what's the best way to do it. May be for another ticket. We already do a lot here.

Also, I have some doubt in types declarations between `int` and `Py_ssize_t`. When should we use this `Py_ssize_t` ?



---

archive/issue_comments_368046.json:
```json
{
    "body": "`Py_ssize_t` is for when you thing you might overflow the usual `int`. In general, you should use `Py_ssize_t` as `int` imposes a more artificial limitation on sizes.",
    "created_at": "2018-10-01T22:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368046",
    "user": "https://github.com/tscrim"
}
```

`Py_ssize_t` is for when you thing you might overflow the usual `int`. In general, you should use `Py_ssize_t` as `int` imposes a more artificial limitation on sizes.



---

archive/issue_comments_368047.json:
```json
{
    "body": "Timings:\n\nYour branch:\n\n```\nsage: G = graphs.JankoKharaghaniGraph(936)\nsage: (G.order(), G.size())\n(936, 175500)\nsage: %time T = G.spqr_tree()\nCPU times: user 4.28 s, sys: 124 ms, total: 4.41 s\nWall time: 4.37 s\n```\n\nvs 8.4.beta7:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 6.2 s, sys: 92 ms, total: 6.3 s\nWall time: 6.22 s\n```\n\n\nSo already you have a very good speedup on this example (cut ~1/3 of the run time). Let me take a look over things to see what I can improve as well.",
    "created_at": "2018-10-01T22:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368047",
    "user": "https://github.com/tscrim"
}
```

Timings:

Your branch:

```
sage: G = graphs.JankoKharaghaniGraph(936)
sage: (G.order(), G.size())
(936, 175500)
sage: %time T = G.spqr_tree()
CPU times: user 4.28 s, sys: 124 ms, total: 4.41 s
Wall time: 4.37 s
```

vs 8.4.beta7:

```
sage: %time T = G.spqr_tree()
CPU times: user 6.2 s, sys: 92 ms, total: 6.3 s
Wall time: 6.22 s
```


So already you have a very good speedup on this example (cut ~1/3 of the run time). Let me take a look over things to see what I can improve as well.



---

archive/issue_comments_368048.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-01T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368048",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368049.json:
```json
{
    "body": "With Cythonizing the helper classes, I get a ~3x speedup versus 8.4.beta7:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 2.63 s, sys: 72 ms, total: 2.7 s\nWall time: 2.66 s\n```\n\n\nI have not looked at the generated C code to see where inefficiencies are yet (i.e., types that we know that we can declare), but that might get even more speed out. However, the next step would be moving away from the Python types such as `list` and `dict` to C++ STL types `vector` and `map` with explicitly declared types. Actually, you might just consider separating these out into a separate C++  file/library (I believe you can simply replace `Py_ssize_t` with `ssize_t`). This will give you more control over things, but (of course) means you have to manage the memory more yourself.",
    "created_at": "2018-10-01T23:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368049",
    "user": "https://github.com/tscrim"
}
```

With Cythonizing the helper classes, I get a ~3x speedup versus 8.4.beta7:

```
sage: %time T = G.spqr_tree()
CPU times: user 2.63 s, sys: 72 ms, total: 2.7 s
Wall time: 2.66 s
```


I have not looked at the generated C code to see where inefficiencies are yet (i.e., types that we know that we can declare), but that might get even more speed out. However, the next step would be moving away from the Python types such as `list` and `dict` to C++ STL types `vector` and `map` with explicitly declared types. Actually, you might just consider separating these out into a separate C++  file/library (I believe you can simply replace `Py_ssize_t` with `ssize_t`). This will give you more control over things, but (of course) means you have to manage the memory more yourself.



---

archive/issue_comments_368050.json:
```json
{
    "body": "Although to do that, I believe you would need to make `_LinkedList(Node)` and `_Component` into C++ classes. Well, I am saying/asking to get rid of as much of the Python as possible. :P",
    "created_at": "2018-10-01T23:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368050",
    "user": "https://github.com/tscrim"
}
```

Although to do that, I believe you would need to make `_LinkedList(Node)` and `_Component` into C++ classes. Well, I am saying/asking to get rid of as much of the Python as possible. :P



---

archive/issue_comments_368051.json:
```json
{
    "body": "Actually, pulling it out to a separate library might be a little tricky because of having to work with the `Graph` object. Anyways, these are things that can wait for another ticket. Although one thing that would be really good would be if you could fix the type of `_LinkedListNode` (or maybe as a [fused type](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html)).",
    "created_at": "2018-10-02T00:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368051",
    "user": "https://github.com/tscrim"
}
```

Actually, pulling it out to a separate library might be a little tricky because of having to work with the `Graph` object. Anyways, these are things that can wait for another ticket. Although one thing that would be really good would be if you could fix the type of `_LinkedListNode` (or maybe as a [fused type](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html)).



---

archive/issue_comments_368052.json:
```json
{
    "body": "It seems like this code converts the graph internally into a specific format, so maybe it could work as a standalone library (or C++) with Sage handling the conversion.\n\nQuestion, does `e_node_dict` always eventually expand out to `G.order()`? If so, then it would be better for it to be a fixed-length array of `_LinkedListNode`'s (once those become `struct`'s, but that seems a little more invasive of a change than I initially was thinking).\n\nIn general, the only bad bit of C code I see are those coming from the `graph_copy` manipulations and the fact that `_LinkedListNode` does not know its `data` type. For the graph manipulations, it might better to directly call the corresponding `_backend` method. At the very least, it avoids a level of python indirection, but you might have to unpack the `int_to_edge` into 3 arrays or an array of a `cdef struct` (I would go with the latter) and then feed each of those off.\n\nI made `_LinkedListNode` know that `data` is a `Py_ssize_t`, which gave me a few extra ticks.\n\nIt might be better for `e_stack` to be a C++ STL `stack` (or `vector`) of `int`'s too.\n\nI didn't see a general `_LinkedList` needing to be a doubly-linked list other than the `remove`. Do you think it would be possible to easily hold onto that `prev` so you don't need to manipulate a doubly-linked list (and only a singly-linked list)?\n\nSpeaking of which, the `_LinkedList` is a little strange in that its getter and setter methods are based on working with the nodes rather than the underlying data.\n\nOkay, I am done with my comments and commits.",
    "created_at": "2018-10-02T02:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368052",
    "user": "https://github.com/tscrim"
}
```

It seems like this code converts the graph internally into a specific format, so maybe it could work as a standalone library (or C++) with Sage handling the conversion.

Question, does `e_node_dict` always eventually expand out to `G.order()`? If so, then it would be better for it to be a fixed-length array of `_LinkedListNode`'s (once those become `struct`'s, but that seems a little more invasive of a change than I initially was thinking).

In general, the only bad bit of C code I see are those coming from the `graph_copy` manipulations and the fact that `_LinkedListNode` does not know its `data` type. For the graph manipulations, it might better to directly call the corresponding `_backend` method. At the very least, it avoids a level of python indirection, but you might have to unpack the `int_to_edge` into 3 arrays or an array of a `cdef struct` (I would go with the latter) and then feed each of those off.

I made `_LinkedListNode` know that `data` is a `Py_ssize_t`, which gave me a few extra ticks.

It might be better for `e_stack` to be a C++ STL `stack` (or `vector`) of `int`'s too.

I didn't see a general `_LinkedList` needing to be a doubly-linked list other than the `remove`. Do you think it would be possible to easily hold onto that `prev` so you don't need to manipulate a doubly-linked list (and only a singly-linked list)?

Speaking of which, the `_LinkedList` is a little strange in that its getter and setter methods are based on working with the nodes rather than the underlying data.

Okay, I am done with my comments and commits.



---

archive/issue_comments_368053.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-02T02:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368054.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-02T13:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368054",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368055.json:
```json
{
    "body": "Thank you Travis for the great improvements.\n\nI removed `graph_copy`, `int_to_edge`, and `edge_to_int` as we don't need them anymore. In fact, we can use the status of an edge to decide if it is in the graph or not (active if 0,1,2 or inactive if -1).\n\nI will check what can be done for `_LinkedListNode`. Note that I'm reluctant to go to C++ as I know very little of it.",
    "created_at": "2018-10-02T13:17:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368055",
    "user": "https://github.com/dcoudert"
}
```

Thank you Travis for the great improvements.

I removed `graph_copy`, `int_to_edge`, and `edge_to_int` as we don't need them anymore. In fact, we can use the status of an edge to decide if it is in the graph or not (active if 0,1,2 or inactive if -1).

I will check what can be done for `_LinkedListNode`. Note that I'm reluctant to go to C++ as I know very little of it.



---

archive/issue_comments_368056.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-02T16:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368057.json:
```json
{
    "body": "I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable.",
    "created_at": "2018-10-02T16:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368057",
    "user": "https://github.com/dcoudert"
}
```

I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable.



---

archive/issue_comments_368058.json:
```json
{
    "body": "To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.\n\nI'm curious of the new running time of your favorite example.",
    "created_at": "2018-10-02T16:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368058",
    "user": "https://github.com/dcoudert"
}
```

To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.

I'm curious of the new running time of your favorite example.



---

archive/issue_comments_368059.json:
```json
{
    "body": "Replying to [comment:17 dcoudert]:\n> I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable. \n\nI agree, but I feel like this is something we should care a little less about code reability than speed. In fact, this cut the time by another half:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 1.2 s, sys: 36 ms, total: 1.23 s\nWall time: 1.2 s\n```\n\nUnfortunately Cython does not yet support C++ classes, which would have made the code more readable IMO. Although it just means we had to write more pure C-like code. The 2x speedup though makes it worth it.",
    "created_at": "2018-10-02T22:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368059",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:17 dcoudert]:
> I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable. 

I agree, but I feel like this is something we should care a little less about code reability than speed. In fact, this cut the time by another half:

```
sage: %time T = G.spqr_tree()
CPU times: user 1.2 s, sys: 36 ms, total: 1.23 s
Wall time: 1.2 s
```

Unfortunately Cython does not yet support C++ classes, which would have made the code more readable IMO. Although it just means we had to write more pure C-like code. The 2x speedup though makes it worth it.



---

archive/issue_comments_368060.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-02T23:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368060",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_368061.json:
```json
{
    "body": "Replying to [comment:18 dcoudert]:\n> To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.\n\nThe only operation that requires the doubly part is the removal. The rest are constant time (with holding onto the head and tail of every linked list) with a singly-linked list. That is why I asked about holding onto the \"previous\" node of the one being removed if that was easily doable. I don't think so easily, it would probably make the code fairly difficult to read, and probably not gain much speed.\n\nSo I think this will be good for now. At least, I don't see a way to get really any more speed out. Thank you for all your hard work on this!",
    "created_at": "2018-10-02T23:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368061",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:18 dcoudert]:
> To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.

The only operation that requires the doubly part is the removal. The rest are constant time (with holding onto the head and tail of every linked list) with a singly-linked list. That is why I asked about holding onto the "previous" node of the one being removed if that was easily doable. I don't think so easily, it would probably make the code fairly difficult to read, and probably not gain much speed.

So I think this will be good for now. At least, I don't see a way to get really any more speed out. Thank you for all your hard work on this!



---

archive/issue_comments_368062.json:
```json
{
    "body": "Thank you for your great help.",
    "created_at": "2018-10-03T06:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368062",
    "user": "https://github.com/dcoudert"
}
```

Thank you for your great help.



---

archive/issue_events_024280.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2018-10-04T21:54:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26132#event-24280"
}
```



---

archive/issue_comments_368063.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-04T21:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26132#issuecomment-368063",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
