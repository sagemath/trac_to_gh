# Issue 31402: Spherical Harmonics: special cases and more examples

archive/issues_031402.json:
```json
{
    "body": "CC:  @egourgoulhon @tscrim @slel @mkoeppe\n\nThis ticket is devoted to improve spherical harmonics and make them function properly. That entails treating special cases more efficiently and adding a bunch of doctests for checking correctness.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31639\n\n",
    "created_at": "2021-04-10T15:21:11Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Spherical Harmonics: special cases and more examples",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31402",
    "user": "https://github.com/mjungmath"
}
```
CC:  @egourgoulhon @tscrim @slel @mkoeppe

This ticket is devoted to improve spherical harmonics and make them function properly. That entails treating special cases more efficiently and adding a bunch of doctests for checking correctness.

Issue created by migration from https://trac.sagemath.org/ticket/31639





---

archive/issue_comments_448640.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-10T15:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448640",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448641.json:
```json
{
    "body": "Here is one first approach based on the current branch of #25034.\n\nAny chance to get rid of terms like `sqrt(sin^2(theta))` in a nice way?",
    "created_at": "2021-04-10T15:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448641",
    "user": "https://github.com/mjungmath"
}
```

Here is one first approach based on the current branch of #25034.

Any chance to get rid of terms like `sqrt(sin^2(theta))` in a nice way?



---

archive/issue_comments_448642.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-10T21:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448643.json:
```json
{
    "body": "Replying to [comment:4 gh-mjungmath]:\n> Here is one first approach based on the current branch of #25034.\n\n\nThanks!\n\n> \n> Any chance to get rid of terms like `sqrt(sin^2(theta))` in a nice way?\n\n\nThese ones are really annoying in Sage; this is why I introduced the functions `simplify_sqrt_real` and `simplify_abs_trig`, which are used in the default simplification chain for calculus on manifolds. They do the job here:\n\n```\nsage: x, y = var('x y')\nsage: s = spherical_harmonic(2, 1, x, y); s\n1/4*sqrt(6)*sqrt(5)*sqrt(sin(x)^2)*cos(x)*e^(I*y)/sqrt(pi)\nsage: assume(0 <= x, x <= pi)                              \nsage: s.simplify_full()  # no effect despite the above assumptions!\n1/4*sqrt(6)*sqrt(5)*sqrt(sin(x)^2)*cos(x)*e^(I*y)/sqrt(pi)\n```\n\n```\nsage: from sage.manifolds.utilities import simplify_sqrt_real, simplify_abs_trig\nsage: simplify_abs_trig(simplify_sqrt_real(s))\n1/4*sqrt(5)*sqrt(3)*sqrt(2)*cos(x)*e^(I*y)*sin(x)/sqrt(pi)\n```",
    "created_at": "2021-04-11T14:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448643",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:4 gh-mjungmath]:
> Here is one first approach based on the current branch of #25034.


Thanks!

> 
> Any chance to get rid of terms like `sqrt(sin^2(theta))` in a nice way?


These ones are really annoying in Sage; this is why I introduced the functions `simplify_sqrt_real` and `simplify_abs_trig`, which are used in the default simplification chain for calculus on manifolds. They do the job here:

```
sage: x, y = var('x y')
sage: s = spherical_harmonic(2, 1, x, y); s
1/4*sqrt(6)*sqrt(5)*sqrt(sin(x)^2)*cos(x)*e^(I*y)/sqrt(pi)
sage: assume(0 <= x, x <= pi)                              
sage: s.simplify_full()  # no effect despite the above assumptions!
1/4*sqrt(6)*sqrt(5)*sqrt(sin(x)^2)*cos(x)*e^(I*y)/sqrt(pi)
```

```
sage: from sage.manifolds.utilities import simplify_sqrt_real, simplify_abs_trig
sage: simplify_abs_trig(simplify_sqrt_real(s))
1/4*sqrt(5)*sqrt(3)*sqrt(2)*cos(x)*e^(I*y)*sin(x)/sqrt(pi)
```



---

archive/issue_comments_448644.json:
```json
{
    "body": "The following results given in the EXAMPLES section:\n\n```\nY_1^-1(x,y)=-1/2*sqrt(3/2)*e^(-I*y)*sin(x)/sqrt(pi)\nY_1^1(x,y)=1/4*sqrt(3)*sqrt(2)*sqrt(sin(x)^2)*e^(I*y)/sqrt(pi)\nY_2^-1(x,y)=-1/4*sqrt(15)*sqrt(2)*sqrt(sin(x)^2)*cos(x)*e^(-I*y)/sqrt(pi)\nY_2^1(x,y)=1/4*sqrt(6)*sqrt(5)*sqrt(sin(x)^2)*cos(x)*e^(I*y)/sqrt(pi)\n```\nhave signs opposite to https://en.wikipedia.org/wiki/Table_of_spherical_harmonics and https://mathworld.wolfram.com/SphericalHarmonic.html. This is certainly due to the [Condon-Shortley phase](https://en.wikipedia.org/wiki/Spherical_harmonics#Condon%E2%80%93Shortley_phase) (-1)<sup>m</sup>. I think we should agree with Wikipedia's convention, since it is standard in mathematical physics. Problably, we should offer the option `condon_shortley=True` in `spherical_harmonic`'s arguments. For instance, this is done in the package [kerrgeodesic_gw](https://github.com/BlackHolePerturbationToolkit/kerrgeodesic_gw):\n\n```\nsage: from kerrgeodesic_gw import spin_weighted_spherical_harmonic\nsage: x, y = var('x y')\nsage: spin_weighted_spherical_harmonic(0, 1, -1, x, y)  # weight = 0 -> spherical harmonic\n0.25*sqrt(6)*e^(-I*y)*sin(x)/sqrt(pi)\nsage: spin_weighted_spherical_harmonic(0, 1, 1, x, y)\n-1/4*sqrt(6)*e^(I*y)*sin(x)/sqrt(pi)\nsage: spin_weighted_spherical_harmonic(0, 1, 1, x, y, condon_shortley=False)\n1/4*sqrt(6)*e^(I*y)*sin(x)/sqrt(pi)\n```\nBy the way, there is not the `sqrt(sin(x)^2)` issue discussed in comment:7 in the above outputs, maybe because `kerrgeodesic_gw` uses the algorithm of Golberg (1967) and does not rely explicitely on associated Legendre function; see the function `_compute_sw_spherical_harm` in line 27 of the file [spin_weighted_spherical_harm.py](https://github.com/BlackHolePerturbationToolkit/kerrgeodesic_gw/blob/master/kerrgeodesic_gw/spin_weighted_spherical_harm.py).\n\nPS: `kerrgeodesic_gw` can be installed in Sage with `sage -pip install kerrgeodesic_gw`, but if you want to play with it without installing it, you can run this [notebook](https://nbviewer.jupyter.org/github/BlackHolePerturbationToolkit/kerrgeodesic_gw/blob/master/Notebooks/basic_kerrgeodesic_gw.ipynb) in [Binder](https://mybinder.org/v2/gh/BlackHolePerturbationToolkit/kerrgeodesic_gw/master?filepath=Notebooks/basic_kerrgeodesic_gw.ipynb).",
    "created_at": "2021-04-11T15:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448644",
    "user": "https://github.com/egourgoulhon"
}
```

The following results given in the EXAMPLES section:

```
Y_1^-1(x,y)=-1/2*sqrt(3/2)*e^(-I*y)*sin(x)/sqrt(pi)
Y_1^1(x,y)=1/4*sqrt(3)*sqrt(2)*sqrt(sin(x)^2)*e^(I*y)/sqrt(pi)
Y_2^-1(x,y)=-1/4*sqrt(15)*sqrt(2)*sqrt(sin(x)^2)*cos(x)*e^(-I*y)/sqrt(pi)
Y_2^1(x,y)=1/4*sqrt(6)*sqrt(5)*sqrt(sin(x)^2)*cos(x)*e^(I*y)/sqrt(pi)
```
have signs opposite to https://en.wikipedia.org/wiki/Table_of_spherical_harmonics and https://mathworld.wolfram.com/SphericalHarmonic.html. This is certainly due to the [Condon-Shortley phase](https://en.wikipedia.org/wiki/Spherical_harmonics#Condon%E2%80%93Shortley_phase) (-1)<sup>m</sup>. I think we should agree with Wikipedia's convention, since it is standard in mathematical physics. Problably, we should offer the option `condon_shortley=True` in `spherical_harmonic`'s arguments. For instance, this is done in the package [kerrgeodesic_gw](https://github.com/BlackHolePerturbationToolkit/kerrgeodesic_gw):

```
sage: from kerrgeodesic_gw import spin_weighted_spherical_harmonic
sage: x, y = var('x y')
sage: spin_weighted_spherical_harmonic(0, 1, -1, x, y)  # weight = 0 -> spherical harmonic
0.25*sqrt(6)*e^(-I*y)*sin(x)/sqrt(pi)
sage: spin_weighted_spherical_harmonic(0, 1, 1, x, y)
-1/4*sqrt(6)*e^(I*y)*sin(x)/sqrt(pi)
sage: spin_weighted_spherical_harmonic(0, 1, 1, x, y, condon_shortley=False)
1/4*sqrt(6)*e^(I*y)*sin(x)/sqrt(pi)
```
By the way, there is not the `sqrt(sin(x)^2)` issue discussed in comment:7 in the above outputs, maybe because `kerrgeodesic_gw` uses the algorithm of Golberg (1967) and does not rely explicitely on associated Legendre function; see the function `_compute_sw_spherical_harm` in line 27 of the file [spin_weighted_spherical_harm.py](https://github.com/BlackHolePerturbationToolkit/kerrgeodesic_gw/blob/master/kerrgeodesic_gw/spin_weighted_spherical_harm.py).

PS: `kerrgeodesic_gw` can be installed in Sage with `sage -pip install kerrgeodesic_gw`, but if you want to play with it without installing it, you can run this [notebook](https://nbviewer.jupyter.org/github/BlackHolePerturbationToolkit/kerrgeodesic_gw/blob/master/Notebooks/basic_kerrgeodesic_gw.ipynb) in [Binder](https://mybinder.org/v2/gh/BlackHolePerturbationToolkit/kerrgeodesic_gw/master?filepath=Notebooks/basic_kerrgeodesic_gw.ipynb).



---

archive/issue_comments_448645.json:
```json
{
    "body": "Another motivation for using the Condon-Shortley phase: SymPy uses it:\n\n```\nsage: x, y = var('x y')                             \nsage: from sympy import Ynm                   \nsage: Ynm(1, 1, x, y).expand(func=True)\n-sqrt(6)*exp(I*y)*sin(x)/(4*sqrt(pi))\n```\nWe should certainly agree with SymPy (in addition to Wikipedia, MathWorld, etc.)",
    "created_at": "2021-04-12T13:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448645",
    "user": "https://github.com/egourgoulhon"
}
```

Another motivation for using the Condon-Shortley phase: SymPy uses it:

```
sage: x, y = var('x y')                             
sage: from sympy import Ynm                   
sage: Ynm(1, 1, x, y).expand(func=True)
-sqrt(6)*exp(I*y)*sin(x)/(4*sqrt(pi))
```
We should certainly agree with SymPy (in addition to Wikipedia, MathWorld, etc.)



---

archive/issue_comments_448646.json:
```json
{
    "body": "Thank you for the input. I agree that a flag for the Condon-Shortley phase is the most favorable option.\n\nI'll probably use `simplify_abs_trig`. Why haven't these simplifications made it to the global namespace though? I think it is definitely worth to add.\n\nLet's wait for #25034 before we wrap this up here.",
    "created_at": "2021-04-12T14:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31402#issuecomment-448646",
    "user": "https://github.com/mjungmath"
}
```

Thank you for the input. I agree that a flag for the Condon-Shortley phase is the most favorable option.

I'll probably use `simplify_abs_trig`. Why haven't these simplifications made it to the global namespace though? I think it is definitely worth to add.

Let's wait for #25034 before we wrap this up here.



---

archive/issue_events_083331.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T02:16:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83331"
}
```



---

archive/issue_events_083332.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83332"
}
```



---

archive/issue_events_083333.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83333"
}
```



---

archive/issue_events_083334.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83334"
}
```



---

archive/issue_events_083335.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83335"
}
```



---

archive/issue_events_083336.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83336"
}
```



---

archive/issue_events_083337.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83337"
}
```



---

archive/issue_events_083338.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83338"
}
```



---

archive/issue_events_083339.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31402",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31402#event-83339"
}
```
