# Issue 26428: python3: 'filter' object is not subscriptable in libs/gap/util.pyx

Issue created by migration from https://trac.sagemath.org/ticket/26665

Original creator: fbissey

Original creation time: 2018-11-08 20:02:24

Because sage-on-gentoo doesn't use `GAP_DIR` we are exposed to a code path that is not doctested and that fails with python3.

```
      File "sage/libs/gap/util.pyx", line 199, in sage.libs.gap.util.initialize (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4452)
        s = str_to_bytes(gap_root(), FS_ENCODING, "surrogateescape")
      File "sage/libs/gap/util.pyx", line 171, in sage.libs.gap.util.gap_root (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4232)
        gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]
    TypeError: 'filter' object is not subscriptable
```




---

Comment by fbissey created at 2018-11-08 20:22:44

Still have to write a doctest.
----
New commits:


---

Comment by fbissey created at 2018-11-08 21:55:34

I am not sure how to write that doctest. To test this properly we have to start a new instance of sage with `GAP_ROOT_DIR` set to wrong value and then call `gap_root`. I cannot seem to change the value inside of sage in a way that sticks until the `gap_root` call.


---

Comment by git created at 2018-11-08 22:45:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-11-08 22:46:30

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-11-08 22:46:30

Figured something out.


---

Comment by tscrim created at 2018-11-09 01:40:20

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-11-09 01:40:20

LGTM.


---

Comment by embray created at 2018-11-09 13:28:51

I'm not wild about the fact that this will just crash with a not-so-useful exception if the file is not found, or the line being searched for in that file is not found.  But that was the case before this ticket as well so it's fine.  I just thought that was worth pointing out.


---

Comment by fbissey created at 2018-11-11 20:57:49

Hopefully once the new gap package is sorted all that mess will disappear.


---

Comment by vbraun created at 2018-11-12 21:11:33

Resolution: fixed


---

Comment by @timokau created at 2018-11-25 10:40:23


```
sage: os.system("GAP_ROOT_DIR=/not_a_path sage -c \"sage.libs.gap.util.gap_root()\"")
The gap-4.5.5.spkg (or later) seems to be not installed!
```


This breaks for me because I set `GAP_ROOT_DIR` in `sage-env` which is sourced on `sage` startup. As far as I understand that is how `sage-env` and `GAP_ROOT_DIR` are intended to be used, so the doctest should be changed. Also I would expect this test to add significant overhead for little gain, since it has to go through the whole sage startup.


---

Comment by @timokau created at 2018-11-25 13:14:33

Fix in #26758.
