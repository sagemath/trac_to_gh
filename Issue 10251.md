# Issue 10251: ecm does not compile on some 32-bit Linux systems

archive/issues_010251.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  @zimmermann6 @dimpase @nexttime @mwhansen\n\nKeywords: ecm spkg-install\n\nOn the Skynet machine cicero and on a 32-bit Gentoo Linux Pentium D machine of my own, the ecm package from #5847 does not install in Sage.\n\nThe problem is with Sage's `spkg-install` as the pure upstream sources in `src/` work fine.\n\nThe following works:\n\n```\n$ ./configure\n$ make\n```\n\n\nThe following (emulating `spkg-install`) does NOT work:\n\n```\n$ export CFLAGS=\"-g -O3 -fPIC\"\n$ ./configure\n$ make\n```\n\n\nIt fails with the error\n\n```\nspv.c: In function 'spv_pwmul':\nspv.c:157: error: unknown register name '%xmm7' in 'asm'\nspv.c:157: error: unknown register name '%xmm6' in 'asm'\nspv.c:157: error: unknown register name '%xmm5' in 'asm'\nspv.c:157: error: unknown register name '%xmm3' in 'asm'\nspv.c:157: error: unknown register name '%xmm2' in 'asm'\nspv.c:157: error: unknown register name '%xmm1' in 'asm'\nspv.c:157: error: unknown register name '%xmm0' in 'asm'\n```\n\n\nIt doesn't actually matter what CFLAGS is set to, it fails even with\n\n```\n$ export CFLAGS=\" \"\n```\n\n\nThis is probably because Sage's CFLAGS overrides ecm's CFLAGS.  I think the easiest solution is simply not set any CFLAGS in ecm's `spkg-install`.  Since ecm really wants to optimize for a particular machine, I think the fact that ecm's CFLAGS are not used has also bad consequences for speed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10252\n\n",
    "created_at": "2010-11-12T10:24:27Z",
    "labels": [
        "packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "ecm does not compile on some 32-bit Linux systems",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10251",
    "user": "@jdemeyer"
}
```
Assignee: tbd

CC:  @zimmermann6 @dimpase @nexttime @mwhansen

Keywords: ecm spkg-install

On the Skynet machine cicero and on a 32-bit Gentoo Linux Pentium D machine of my own, the ecm package from #5847 does not install in Sage.

The problem is with Sage's `spkg-install` as the pure upstream sources in `src/` work fine.

The following works:

```
$ ./configure
$ make
```


The following (emulating `spkg-install`) does NOT work:

```
$ export CFLAGS="-g -O3 -fPIC"
$ ./configure
$ make
```


It fails with the error

```
spv.c: In function 'spv_pwmul':
spv.c:157: error: unknown register name '%xmm7' in 'asm'
spv.c:157: error: unknown register name '%xmm6' in 'asm'
spv.c:157: error: unknown register name '%xmm5' in 'asm'
spv.c:157: error: unknown register name '%xmm3' in 'asm'
spv.c:157: error: unknown register name '%xmm2' in 'asm'
spv.c:157: error: unknown register name '%xmm1' in 'asm'
spv.c:157: error: unknown register name '%xmm0' in 'asm'
```


It doesn't actually matter what CFLAGS is set to, it fails even with

```
$ export CFLAGS=" "
```


This is probably because Sage's CFLAGS overrides ecm's CFLAGS.  I think the easiest solution is simply not set any CFLAGS in ecm's `spkg-install`.  Since ecm really wants to optimize for a particular machine, I think the fact that ecm's CFLAGS are not used has also bad consequences for speed.

Issue created by migration from https://trac.sagemath.org/ticket/10252





---

archive/issue_comments_104544.json:
```json
{
    "body": "note that GMP-ECM uses CC and CFLAGS from GMP, which ensures both portability and performance.\nThus overriding the choice of CFLAGS by GMP-ECM is a bad idea.\n\nWhat does `grep CFLAGS gmp.h` give on that machine?\n\nPaul",
    "created_at": "2010-11-12T10:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104544",
    "user": "@zimmermann6"
}
```

note that GMP-ECM uses CC and CFLAGS from GMP, which ensures both portability and performance.
Thus overriding the choice of CFLAGS by GMP-ECM is a bad idea.

What does `grep CFLAGS gmp.h` give on that machine?

Paul



---

archive/issue_comments_104545.json:
```json
{
    "body": "Replying to [comment:2 zimmerma]:\n> What does `grep CFLAGS gmp.h` give on that machine?\n\nOn my machine (32-bit Gentoo Linux Pentium D), I get with the mpir header installed by Sage:\n\n```\n#define __GMP_CFLAGS \"-g -O3 \"\n#define __MPIR_CFLAGS \"-g -O3 \"\n```\n\n\nWith the system-wide `/usr/include/gmp.h`, I get\n\n```\n#define __GMP_CFLAGS \"-pipe -march=nocona -O2 -mfpmath=sse\"\n```\n",
    "created_at": "2010-11-12T12:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104545",
    "user": "@jdemeyer"
}
```

Replying to [comment:2 zimmerma]:
> What does `grep CFLAGS gmp.h` give on that machine?

On my machine (32-bit Gentoo Linux Pentium D), I get with the mpir header installed by Sage:

```
#define __GMP_CFLAGS "-g -O3 "
#define __MPIR_CFLAGS "-g -O3 "
```


With the system-wide `/usr/include/gmp.h`, I get

```
#define __GMP_CFLAGS "-pipe -march=nocona -O2 -mfpmath=sse"
```




---

archive/issue_comments_104546.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> Replying to [comment:2 zimmerma]:\n> > What does `grep CFLAGS gmp.h` give on that machine?\n> \n> On my machine (32-bit Gentoo Linux Pentium D), I get with the mpir header installed by Sage:\n> {{{\n> #define __GMP_CFLAGS \"-g -O3 \"\n> #define __MPIR_CFLAGS \"-g -O3 \"\n> }}}\n> \n> With the system-wide `/usr/include/gmp.h`, I get\n> {{{\n> #define __GMP_CFLAGS \"-pipe -march=nocona -O2 -mfpmath=sse\"\n> }}}\n\nthe spkg should work with the system-wide CFLAGS value. With `-g -O3` it seems `HAVE_SSE2` is defined but SSE2 is not supported.\n\nWhat is strange is that the GMP-ECM configure checks if SSE2 is really supported,\nand if it is not the SSE2 code should not be compiled.\n\nDo you confirm that the upstream package works with `CFLAGS=-g -O3`?\n\nPaul",
    "created_at": "2010-11-12T13:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104546",
    "user": "@zimmermann6"
}
```

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 zimmerma]:
> > What does `grep CFLAGS gmp.h` give on that machine?
> 
> On my machine (32-bit Gentoo Linux Pentium D), I get with the mpir header installed by Sage:
> {{{
> #define __GMP_CFLAGS "-g -O3 "
> #define __MPIR_CFLAGS "-g -O3 "
> }}}
> 
> With the system-wide `/usr/include/gmp.h`, I get
> {{{
> #define __GMP_CFLAGS "-pipe -march=nocona -O2 -mfpmath=sse"
> }}}

the spkg should work with the system-wide CFLAGS value. With `-g -O3` it seems `HAVE_SSE2` is defined but SSE2 is not supported.

What is strange is that the GMP-ECM configure checks if SSE2 is really supported,
and if it is not the SSE2 code should not be compiled.

Do you confirm that the upstream package works with `CFLAGS=-g -O3`?

Paul



---

archive/issue_comments_104547.json:
```json
{
    "body": "Replying to [comment:4 zimmerma]:\n> Do you confirm that the upstream package works with `CFLAGS=-g -O3`?\n\nNo, the upstream package does not work with those CFLAGS.  The reports in this bug report concerned the **upstream** sources (built independently of Sage).",
    "created_at": "2010-11-12T13:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104547",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 zimmerma]:
> Do you confirm that the upstream package works with `CFLAGS=-g -O3`?

No, the upstream package does not work with those CFLAGS.  The reports in this bug report concerned the **upstream** sources (built independently of Sage).



---

archive/issue_comments_104548.json:
```json
{
    "body": "I can reproduce the problem on a 32-bit Pentium 4, both with ecm-6.3 and the svn version. I will\ntry to find a fix.\n\nPaul",
    "created_at": "2010-11-12T13:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104548",
    "user": "@zimmermann6"
}
```

I can reproduce the problem on a 32-bit Pentium 4, both with ecm-6.3 and the svn version. I will
try to find a fix.

Paul



---

archive/issue_comments_104549.json:
```json
{
    "body": "> I will try to find a fix.\n\nwith Pierrick Gaudry, we have analyzed and fixed the problem.\n\nLong story: the asm volatile instructions without constraints in the configure script compile fine without -msse2, but those from the `spv.c` file, which have constraints, do not compile\nwithout -msse2. The fix was to put instructions with constraints in configure.\n\nShort story: apply the following patch\n\n```\n--- configure.in        (revision 1545)\n+++ configure.in        (revision 1546)\n@@ -296,9 +296,9 @@\n   AC_MSG_CHECKING([for SSE2 support])\n   m4_define([SSE2_TEST_PROG], [AC_LANG_PROGRAM([], dnl\n [#if (defined(__GNUC__) || defined(__ICL)) && defined(__i386__)\n-/* When there are no constraints, registers are referred to by\n-   single % sign, not double. Argh */\n-asm volatile (\"pmuludq %xmm2, %xmm0\");\n+/* On some machines, a program without constraints may pass without -msse2 but\n+   those with constraints in spv.c fail, thus we test with constraints here. */\n+asm volatile (\"pmuludq %%xmm2, %%xmm0\" : : :\"%xmm0\");\n #else\n #error\n #IRIXdoesnotexitaterrordirective\n```\n",
    "created_at": "2010-11-12T14:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104549",
    "user": "@zimmermann6"
}
```

> I will try to find a fix.

with Pierrick Gaudry, we have analyzed and fixed the problem.

Long story: the asm volatile instructions without constraints in the configure script compile fine without -msse2, but those from the `spv.c` file, which have constraints, do not compile
without -msse2. The fix was to put instructions with constraints in configure.

Short story: apply the following patch

```
--- configure.in        (revision 1545)
+++ configure.in        (revision 1546)
@@ -296,9 +296,9 @@
   AC_MSG_CHECKING([for SSE2 support])
   m4_define([SSE2_TEST_PROG], [AC_LANG_PROGRAM([], dnl
 [#if (defined(__GNUC__) || defined(__ICL)) && defined(__i386__)
-/* When there are no constraints, registers are referred to by
-   single % sign, not double. Argh */
-asm volatile ("pmuludq %xmm2, %xmm0");
+/* On some machines, a program without constraints may pass without -msse2 but
+   those with constraints in spv.c fail, thus we test with constraints here. */
+asm volatile ("pmuludq %%xmm2, %%xmm0" : : :"%xmm0");
 #else
 #error
 #IRIXdoesnotexitaterrordirective
```




---

archive/issue_comments_104550.json:
```json
{
    "body": "I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.\n\nFor example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.",
    "created_at": "2010-11-12T14:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104550",
    "user": "@jdemeyer"
}
```

I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.

For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.



---

archive/issue_comments_104551.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.\n> \n> For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.\n\nHow does the upstream mpir find these optimized flags?",
    "created_at": "2010-11-12T17:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104551",
    "user": "@dimpase"
}
```

Replying to [comment:8 jdemeyer]:
> I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.
> 
> For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.

How does the upstream mpir find these optimized flags?



---

archive/issue_comments_104552.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2010-11-19T10:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104552",
    "user": "@jdemeyer"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_104553.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.\n\nI consider such *upstream* issues, i.e., upstream should IMHO **\"modify\"** `CFLAGS` et al. if appropriate or necessary, rather than either ignoring them or (solely) using user-specified settings \"as is\".\n\n(Try e.g. `env CFLAGS=\"\" ./sage -ba-force && ./sage -c \"quit\"`... which *breaks* the Cython-generated C code, or at least used to do so.)\n\n\n\n\n> For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.\n\nJust for the record: `-march=hobel` implies `-mtune=hobel` (and `-mcpu=hobel`).",
    "created_at": "2010-11-21T17:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104553",
    "user": "@nexttime"
}
```

Replying to [comment:8 jdemeyer]:
> I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.

I consider such *upstream* issues, i.e., upstream should IMHO **"modify"** `CFLAGS` et al. if appropriate or necessary, rather than either ignoring them or (solely) using user-specified settings "as is".

(Try e.g. `env CFLAGS="" ./sage -ba-force && ./sage -c "quit"`... which *breaks* the Cython-generated C code, or at least used to do so.)




> For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.

Just for the record: `-march=hobel` implies `-mtune=hobel` (and `-mcpu=hobel`).



---

archive/issue_comments_104554.json:
```json
{
    "body": "> I consider such upstream issues, i.e., upstream should IMHO \"modify\" CFLAGS et al. if appropriate or necessary\n\nI disagree. If the user requests CFLAGS=..., upstream should use those flags.\n\nPaul Zimmermann",
    "created_at": "2010-11-21T19:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104554",
    "user": "@zimmermann6"
}
```

> I consider such upstream issues, i.e., upstream should IMHO "modify" CFLAGS et al. if appropriate or necessary

I disagree. If the user requests CFLAGS=..., upstream should use those flags.

Paul Zimmermann



---

archive/issue_comments_104555.json:
```json
{
    "body": "Replying to [comment:12 zimmerma]:\n> > I consider such upstream issues, i.e., upstream should IMHO \"modify\" CFLAGS et al. if appropriate or necessary\n> \n> I disagree. If the user requests CFLAGS=..., upstream should use those flags.\n\nYes, but not (necessarily) exclusively. ;-)\n\n(Almost all build scripts append or prepend to `CFLAGS` etc., which is convenient if one only wants to add e.g. \"`-g`\", \"`-march=native`\" or \"`-mcpu=i486`\". Here we want the former...)",
    "created_at": "2010-11-21T19:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104555",
    "user": "@nexttime"
}
```

Replying to [comment:12 zimmerma]:
> > I consider such upstream issues, i.e., upstream should IMHO "modify" CFLAGS et al. if appropriate or necessary
> 
> I disagree. If the user requests CFLAGS=..., upstream should use those flags.

Yes, but not (necessarily) exclusively. ;-)

(Almost all build scripts append or prepend to `CFLAGS` etc., which is convenient if one only wants to add e.g. "`-g`", "`-march=native`" or "`-mcpu=i486`". Here we want the former...)



---

archive/issue_comments_104556.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2010-11-22T01:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104556",
    "user": "@nexttime"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_104557.json:
```json
{
    "body": "So we at least still have the problem of adding `-m64` if `SAGE64=yes` (i.e., if we want a 64-bit build on systems that default to 32-bit builds):\n\n```sh\n...\n# Note that GMP-ECM is written in C (and assembler) - no C++ sources.\n\nif [ \"$SAGE64\" = yes ]; then\n    echo \"Building a 64-bit version of GMP-ECM\"\n    if [ -z \"$CFLAG64\" ]; then\n        CFLAG64=-m64\n    fi\n    CFLAGS=\"$CFLAGS $CFLAG64 -fPIC\"\n    LDFLAGS=\"$CFLAG64\"; export LDFLAGS\nelse\n    CFLAGS=\"$CFLAGS -fPIC\"\nfi\n\n# We add debug symbols by default;\nif [ \"$SAGE_DEBUG\" = yes ]; then\n    # Disable optimization:\n    CFLAGS=\"$CFLAGS -g -O0\"\nelse\n    # Enable optimization, may be overridden by user settings:\n    CFLAGS=\"-g -O3 $CFLAGS\"\nfi\n\nexport CFLAGS # usually redundant, but safe(r)\n...\n```\n\n\nOf course I could add \"our\" (or worse, also *any user-specified*) `CFLAGS` to `CC`, i.e. the C compiler command, and `unset CFLAGS` to make ECM's effective, but I wouldn't like that. (And some settings then would get overridden by ECM's `CFLAGS` anyway.)\n\n----\n\nAn IMHO better solution is to also add `-march=native` to `CFLAGS`, since this enables SSE (to be precise, allows SSE2 instructions) if supported by the processor (when `configure` defines `HAVE_SSE2`), ignoring `SAGE_FAT_BINARY` at least for the moment (unless ECM's `configure` has an option like `--disable-sse` or similar; I haven't really checked that yet, perhaps just `--enable-sse2=no` on *32-bit* x86).\n\n\n\n\nI'm not sure what happens if we configure with `CFLAGS` set and `--enable-gmp-cflags=no` (which seems to be more appropriate when using ECM with MPIR).",
    "created_at": "2010-11-22T01:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104557",
    "user": "@nexttime"
}
```

So we at least still have the problem of adding `-m64` if `SAGE64=yes` (i.e., if we want a 64-bit build on systems that default to 32-bit builds):

```sh
...
# Note that GMP-ECM is written in C (and assembler) - no C++ sources.

if [ "$SAGE64" = yes ]; then
    echo "Building a 64-bit version of GMP-ECM"
    if [ -z "$CFLAG64" ]; then
        CFLAG64=-m64
    fi
    CFLAGS="$CFLAGS $CFLAG64 -fPIC"
    LDFLAGS="$CFLAG64"; export LDFLAGS
else
    CFLAGS="$CFLAGS -fPIC"
fi

# We add debug symbols by default;
if [ "$SAGE_DEBUG" = yes ]; then
    # Disable optimization:
    CFLAGS="$CFLAGS -g -O0"
else
    # Enable optimization, may be overridden by user settings:
    CFLAGS="-g -O3 $CFLAGS"
fi

export CFLAGS # usually redundant, but safe(r)
...
```


Of course I could add "our" (or worse, also *any user-specified*) `CFLAGS` to `CC`, i.e. the C compiler command, and `unset CFLAGS` to make ECM's effective, but I wouldn't like that. (And some settings then would get overridden by ECM's `CFLAGS` anyway.)

----

An IMHO better solution is to also add `-march=native` to `CFLAGS`, since this enables SSE (to be precise, allows SSE2 instructions) if supported by the processor (when `configure` defines `HAVE_SSE2`), ignoring `SAGE_FAT_BINARY` at least for the moment (unless ECM's `configure` has an option like `--disable-sse` or similar; I haven't really checked that yet, perhaps just `--enable-sse2=no` on *32-bit* x86).




I'm not sure what happens if we configure with `CFLAGS` set and `--enable-gmp-cflags=no` (which seems to be more appropriate when using ECM with MPIR).



---

archive/issue_comments_104558.json:
```json
{
    "body": "Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...",
    "created_at": "2010-11-22T04:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104558",
    "user": "@nexttime"
}
```

Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...



---

archive/issue_comments_104559.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2010-11-22T04:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104559",
    "user": "@nexttime"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_104560.json:
```json
{
    "body": "Replying to [comment:14 leif]:\n> So we at least still have the problem of adding `-m64` if `SAGE64=yes` [...]\n\nnot sure. GMP uses 64-bit words if available (even if the system is 32 bit), and GMP-ECM uses\nGMP CFLAGS.\n\nPaul",
    "created_at": "2010-11-22T08:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104560",
    "user": "@zimmermann6"
}
```

Replying to [comment:14 leif]:
> So we at least still have the problem of adding `-m64` if `SAGE64=yes` [...]

not sure. GMP uses 64-bit words if available (even if the system is 32 bit), and GMP-ECM uses
GMP CFLAGS.

Paul



---

archive/issue_comments_104561.json:
```json
{
    "body": "So the solution is easy: don't set **any** `CFLAGS` in the mpir and ecm packages.  Right?",
    "created_at": "2010-11-22T08:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104561",
    "user": "@jdemeyer"
}
```

So the solution is easy: don't set **any** `CFLAGS` in the mpir and ecm packages.  Right?



---

archive/issue_comments_104562.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> So the solution is easy: don't set **any** `CFLAGS` in the mpir and ecm packages.  Right?\n\nthat is my advice. Same for MPFR, which also copies CFLAGS from GMP.\n\nPaul",
    "created_at": "2010-11-22T09:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104562",
    "user": "@zimmermann6"
}
```

Replying to [comment:17 jdemeyer]:
> So the solution is easy: don't set **any** `CFLAGS` in the mpir and ecm packages.  Right?

that is my advice. Same for MPFR, which also copies CFLAGS from GMP.

Paul



---

archive/issue_comments_104563.json:
```json
{
    "body": "Replying to [comment:14 leif]:\n> An IMHO better solution is to also add `-march=native` to `CFLAGS`, since this enables SSE (to be precise, allows SSE2 instructions) if supported by the processor (when `configure` defines `HAVE_SSE2`), ignoring `SAGE_FAT_BINARY` at least for the moment (unless ECM's `configure` has an option like `--disable-sse` or similar; I haven't really checked that yet, perhaps just `--enable-sse2=no` on *32-bit* x86).\n\nYou know that -march=native is only supported on x86 and amd64 cpus right?\nI can tell you first hand that the compilation will stop straight away on ppc.\nAnd then you will get Dave telling you it is not supported by other compilers.",
    "created_at": "2010-11-22T09:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104563",
    "user": "@kiwifb"
}
```

Replying to [comment:14 leif]:
> An IMHO better solution is to also add `-march=native` to `CFLAGS`, since this enables SSE (to be precise, allows SSE2 instructions) if supported by the processor (when `configure` defines `HAVE_SSE2`), ignoring `SAGE_FAT_BINARY` at least for the moment (unless ECM's `configure` has an option like `--disable-sse` or similar; I haven't really checked that yet, perhaps just `--enable-sse2=no` on *32-bit* x86).

You know that -march=native is only supported on x86 and amd64 cpus right?
I can tell you first hand that the compilation will stop straight away on ppc.
And then you will get Dave telling you it is not supported by other compilers.



---

archive/issue_comments_104564.json:
```json
{
    "body": "Replying to [comment:19 fbissey]:\n> You know that -march=native is only supported on x86 and amd64 cpus right?\n\nNot only, but ...\n\n> I can tell you first hand that the compilation will stop straight away on ppc.\n\nI was not going to try to enable SSE2 on PowerPCs (nor SPARC processors). ;-)\n\n\n\n\n\n> And then you will get Dave telling you it is not supported by other compilers.\n\nThere's very little support for other compilers in Sage, and it's easy to add a distinction when the day it gets necessary comes, though I could add it now.",
    "created_at": "2010-11-22T10:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104564",
    "user": "@nexttime"
}
```

Replying to [comment:19 fbissey]:
> You know that -march=native is only supported on x86 and amd64 cpus right?

Not only, but ...

> I can tell you first hand that the compilation will stop straight away on ppc.

I was not going to try to enable SSE2 on PowerPCs (nor SPARC processors). ;-)





> And then you will get Dave telling you it is not supported by other compilers.

There's very little support for other compilers in Sage, and it's easy to add a distinction when the day it gets necessary comes, though I could add it now.



---

archive/issue_comments_104565.json:
```json
{
    "body": "Replying to [comment:20 leif]:\n> Replying to [comment:19 fbissey]:\n> > You know that -march=native is only supported on x86 and amd64 cpus right?\n> \n> Not only, but ...\n> \n> > I can tell you first hand that the compilation will stop straight away on ppc.\n> \n> I was not going to try to enable SSE2 on PowerPCs (nor SPARC processors). ;-)\n> \n> \n\n> \n> \n> > And then you will get Dave telling you it is not supported by other compilers.\n> \n> There's very little support for other compilers in Sage, and it's easy to add a distinction when the day it gets necessary comes, though I could add it now.\n\nOk, I missed a little bit of context. I guess I didn't pay full attention to the whole thread. Sorry for the noise.",
    "created_at": "2010-11-22T10:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104565",
    "user": "@kiwifb"
}
```

Replying to [comment:20 leif]:
> Replying to [comment:19 fbissey]:
> > You know that -march=native is only supported on x86 and amd64 cpus right?
> 
> Not only, but ...
> 
> > I can tell you first hand that the compilation will stop straight away on ppc.
> 
> I was not going to try to enable SSE2 on PowerPCs (nor SPARC processors). ;-)
> 
> 

> 
> 
> > And then you will get Dave telling you it is not supported by other compilers.
> 
> There's very little support for other compilers in Sage, and it's easy to add a distinction when the day it gets necessary comes, though I could add it now.

Ok, I missed a little bit of context. I guess I didn't pay full attention to the whole thread. Sorry for the noise.



---

archive/issue_comments_104566.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-11-24T02:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104566",
    "user": "@nexttime"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_104567.json:
```json
{
    "body": "Replying to [comment:15 leif]:\n> Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...\n\nDid so...\n\nSetting this ticket to \"needs review\" too, can be closed as duplicate when #5847 gets a positive review / merged.",
    "created_at": "2010-11-24T02:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104567",
    "user": "@nexttime"
}
```

Replying to [comment:15 leif]:
> Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...

Did so...

Setting this ticket to "needs review" too, can be closed as duplicate when #5847 gets a positive review / merged.



---

archive/issue_comments_104568.json:
```json
{
    "body": "Replying to [comment:22 leif]:\n> Replying to [comment:15 leif]:\n> > Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...\n> \n> Did so...\n> \n> Setting this ticket to \"needs review\" too, can be closed as duplicate when #5847 gets a positive review / merged.\n\nI've updated the p2 package at #5847 (some corrections, some improvements); same place, different md5sum, still or again needing testing (especially on PowerPCs) / review.\n\nSee http://trac.sagemath.org/sage_trac/ticket/5847#comment:86 .",
    "created_at": "2010-11-25T14:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104568",
    "user": "@nexttime"
}
```

Replying to [comment:22 leif]:
> Replying to [comment:15 leif]:
> > Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...
> 
> Did so...
> 
> Setting this ticket to "needs review" too, can be closed as duplicate when #5847 gets a positive review / merged.

I've updated the p2 package at #5847 (some corrections, some improvements); same place, different md5sum, still or again needing testing (especially on PowerPCs) / review.

See http://trac.sagemath.org/sage_trac/ticket/5847#comment:86 .



---

archive/issue_comments_104569.json:
```json
{
    "body": "Replying to [comment:23 leif]:\n> Replying to [comment:22 leif]:\n> > Replying to [comment:15 leif]:\n> > > Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...\n> > \n> > Did so...\n> > \n> > Setting this ticket to \"needs review\" too, can be closed as duplicate when #5847 gets a positive review / merged.\n> \n> I've updated the p2 package at #5847 (some corrections, some improvements); same place, different md5sum, still or again needing testing (especially on PowerPCs) / review.\n> \n> See http://trac.sagemath.org/sage_trac/ticket/5847#comment:86 .\n\nduly tested on PPC, see the other ticket.",
    "created_at": "2010-11-25T16:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104569",
    "user": "@dimpase"
}
```

Replying to [comment:23 leif]:
> Replying to [comment:22 leif]:
> > Replying to [comment:15 leif]:
> > > Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...
> > 
> > Did so...
> > 
> > Setting this ticket to "needs review" too, can be closed as duplicate when #5847 gets a positive review / merged.
> 
> I've updated the p2 package at #5847 (some corrections, some improvements); same place, different md5sum, still or again needing testing (especially on PowerPCs) / review.
> 
> See http://trac.sagemath.org/sage_trac/ticket/5847#comment:86 .

duly tested on PPC, see the other ticket.



---

archive/issue_comments_104570.json:
```json
{
    "body": "Is there any reason this shouldn't be closed as a dup now?",
    "created_at": "2010-12-04T01:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104570",
    "user": "@robertwb"
}
```

Is there any reason this shouldn't be closed as a dup now?



---

archive/issue_comments_104571.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2010-12-04T01:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104571",
    "user": "@robertwb"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_104572.json:
```json
{
    "body": "Replying to [comment:25 robertwb]:\n> Is there any reason this shouldn't be closed as a dup now?\n\nWell, it's a symbolic link to #5847, which still needs review, delaying the MPIR upgrade (#8664) further.\n\nWe should close it when #5847 got merged.",
    "created_at": "2010-12-04T02:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104572",
    "user": "@nexttime"
}
```

Replying to [comment:25 robertwb]:
> Is there any reason this shouldn't be closed as a dup now?

Well, it's a symbolic link to #5847, which still needs review, delaying the MPIR upgrade (#8664) further.

We should close it when #5847 got merged.



---

archive/issue_comments_104573.json:
```json
{
    "body": "Changing keywords from \"ecm spkg-install\" to \"ecm spkg-install SSE2\".",
    "created_at": "2011-09-09T04:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104573",
    "user": "@nexttime"
}
```

Changing keywords from "ecm spkg-install" to "ecm spkg-install SSE2".



---

archive/issue_comments_104574.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-09-09T04:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104574",
    "user": "@nexttime"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_104575.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-09T04:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104575",
    "user": "@nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_104576.json:
```json
{
    "body": "for your information, this bug is fixed upstream, but we have no new release yet. The fix\nconsists in adding -msse2 when required to compile the corresponding assembly files.\nSee around lines 297-326 of the configure.in file in the svn version upstream.\n\nPaul Zimmermann",
    "created_at": "2011-09-10T07:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104576",
    "user": "@zimmermann6"
}
```

for your information, this bug is fixed upstream, but we have no new release yet. The fix
consists in adding -msse2 when required to compile the corresponding assembly files.
See around lines 297-326 of the configure.in file in the svn version upstream.

Paul Zimmermann



---

archive/issue_comments_104577.json:
```json
{
    "body": "Replying to [comment:30 zimmerma]:\n> for your information, this bug is fixed upstream, but we have no new release yet.\n\nThanks. We already apply that patch (I think; from revision 1546) in the .p2 spkg at #5847.",
    "created_at": "2011-09-10T07:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104577",
    "user": "@nexttime"
}
```

Replying to [comment:30 zimmerma]:
> for your information, this bug is fixed upstream, but we have no new release yet.

Thanks. We already apply that patch (I think; from revision 1546) in the .p2 spkg at #5847.



---

archive/issue_comments_104578.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2011-09-12T19:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104578",
    "user": "@nexttime"
}
```

Resolution: duplicate



---

archive/issue_comments_104579.json:
```json
{
    "body": "this problem is fixed in GMP-ECM 6.4, which has just been released.\n\nPaul Zimmermann",
    "created_at": "2012-01-03T23:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-104579",
    "user": "@zimmermann6"
}
```

this problem is fixed in GMP-ECM 6.4, which has just been released.

Paul Zimmermann
