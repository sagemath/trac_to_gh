# Issue 10251: ecm does not compile on some 32-bit Linux systems

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2010-11-12 10:24:27

Assignee: tbd

CC:  zimmerma dimpase leif mhansen

Keywords: ecm spkg-install

On the Skynet machine cicero and on a 32-bit Gentoo Linux Pentium D machine of my own, the ecm package from #5847 does not install in Sage.

The problem is with Sage's `spkg-install` as the pure upstream sources in `src/` work fine.

The following works:

```
$ ./configure
$ make
```


The following (emulating `spkg-install`) does NOT work:

```
$ export CFLAGS="-g -O3 -fPIC"
$ ./configure
$ make
```


It fails with the error

```
spv.c: In function 'spv_pwmul':
spv.c:157: error: unknown register name '%xmm7' in 'asm'
spv.c:157: error: unknown register name '%xmm6' in 'asm'
spv.c:157: error: unknown register name '%xmm5' in 'asm'
spv.c:157: error: unknown register name '%xmm3' in 'asm'
spv.c:157: error: unknown register name '%xmm2' in 'asm'
spv.c:157: error: unknown register name '%xmm1' in 'asm'
spv.c:157: error: unknown register name '%xmm0' in 'asm'
```


It doesn't actually matter what CFLAGS is set to, it fails even with

```
$ export CFLAGS=" "
```


This is probably because Sage's CFLAGS overrides ecm's CFLAGS.  I think the easiest solution is simply not set any CFLAGS in ecm's `spkg-install`.  Since ecm really wants to optimize for a particular machine, I think the fact that ecm's CFLAGS are not used has also bad consequences for speed.


---

Comment by zimmerma created at 2010-11-12 10:38:55

note that GMP-ECM uses CC and CFLAGS from GMP, which ensures both portability and performance.
Thus overriding the choice of CFLAGS by GMP-ECM is a bad idea.

What does `grep CFLAGS gmp.h` give on that machine?

Paul


---

Comment by jdemeyer created at 2010-11-12 12:51:01

Replying to [comment:2 zimmerma]:
> What does `grep CFLAGS gmp.h` give on that machine?

On my machine (32-bit Gentoo Linux Pentium D), I get with the mpir header installed by Sage:

```
#define __GMP_CFLAGS "-g -O3 "
#define __MPIR_CFLAGS "-g -O3 "
```


With the system-wide `/usr/include/gmp.h`, I get

```
#define __GMP_CFLAGS "-pipe -march=nocona -O2 -mfpmath=sse"
```



---

Comment by zimmerma created at 2010-11-12 13:04:56

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 zimmerma]:
> > What does `grep CFLAGS gmp.h` give on that machine?
> 
> On my machine (32-bit Gentoo Linux Pentium D), I get with the mpir header installed by Sage:
> {{{
> #define __GMP_CFLAGS "-g -O3 "
> #define __MPIR_CFLAGS "-g -O3 "
> }}}
> 
> With the system-wide `/usr/include/gmp.h`, I get
> {{{
> #define __GMP_CFLAGS "-pipe -march=nocona -O2 -mfpmath=sse"
> }}}

the spkg should work with the system-wide CFLAGS value. With `-g -O3` it seems `HAVE_SSE2` is defined but SSE2 is not supported.

What is strange is that the GMP-ECM configure checks if SSE2 is really supported,
and if it is not the SSE2 code should not be compiled.

Do you confirm that the upstream package works with `CFLAGS=-g -O3`?

Paul


---

Comment by jdemeyer created at 2010-11-12 13:10:50

Replying to [comment:4 zimmerma]:
> Do you confirm that the upstream package works with `CFLAGS=-g -O3`?

No, the upstream package does not work with those CFLAGS.  The reports in this bug report concerned the *upstream* sources (built independently of Sage).


---

Comment by zimmerma created at 2010-11-12 13:22:08

I can reproduce the problem on a 32-bit Pentium 4, both with ecm-6.3 and the svn version. I will
try to find a fix.

Paul


---

Comment by zimmerma created at 2010-11-12 14:17:34

> I will try to find a fix.

with Pierrick Gaudry, we have analyzed and fixed the problem.

Long story: the asm volatile instructions without constraints in the configure script compile fine without -msse2, but those from the `spv.c` file, which have constraints, do not compile
without -msse2. The fix was to put instructions with constraints in configure.

Short story: apply the following patch

```
--- configure.in        (revision 1545)
+++ configure.in        (revision 1546)
`@``@` -296,9 +296,9 `@``@`
   AC_MSG_CHECKING([for SSE2 support])
   m4_define([SSE2_TEST_PROG], [AC_LANG_PROGRAM([], dnl
 [#if (defined(__GNUC__) || defined(__ICL)) && defined(__i386__)
-/* When there are no constraints, registers are referred to by
-   single % sign, not double. Argh */
-asm volatile ("pmuludq %xmm2, %xmm0");
+/* On some machines, a program without constraints may pass without -msse2 but
+   those with constraints in spv.c fail, thus we test with constraints here. */
+asm volatile ("pmuludq %%xmm2, %%xmm0" : : :"%xmm0");
 #else
 #error
 #IRIXdoesnotexitaterrordirective
```



---

Comment by jdemeyer created at 2010-11-12 14:29:02

I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.

For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.


---

Comment by dimpase created at 2010-11-12 17:32:27

Replying to [comment:8 jdemeyer]:
> I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.
> 
> For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.

How does the upstream mpir find these optimized flags?


---

Comment by jdemeyer created at 2010-11-19 10:45:21

Changing priority from blocker to major.


---

Comment by leif created at 2010-11-21 17:06:03

Replying to [comment:8 jdemeyer]:
> I can imagine that this bug-fix will make the ecm package work, but I believe that the deeper issue in Sage still needs to be addressed: namely that `spkg-install` (both for mpir and for ecm) is providing CFLAGS when it should leave that to the packages themselves.

I consider such _upstream_ issues, i.e., upstream should IMHO *"modify"* `CFLAGS` et al. if appropriate or necessary, rather than either ignoring them or (solely) using user-specified settings "as is".

(Try e.g. `env CFLAGS="" ./sage -ba-force && ./sage -c "quit"`... which _breaks_ the Cython-generated C code, or at least used to do so.)




> For example, on sage.math.washington.edu, the upstream mpir package uses the flags `-O2 -m64 -march=core2 -mtune=core2` (i.e.: optimized for the particular machine) while within Sage, the flags `-g -O3` are used.

Just for the record: `-march=hobel` implies `-mtune=hobel` (and `-mcpu=hobel`).


---

Comment by zimmerma created at 2010-11-21 19:07:07

> I consider such upstream issues, i.e., upstream should IMHO "modify" CFLAGS et al. if appropriate or necessary

I disagree. If the user requests CFLAGS=..., upstream should use those flags.

Paul Zimmermann


---

Comment by leif created at 2010-11-21 19:50:19

Replying to [comment:12 zimmerma]:
> > I consider such upstream issues, i.e., upstream should IMHO "modify" CFLAGS et al. if appropriate or necessary
> 
> I disagree. If the user requests CFLAGS=..., upstream should use those flags.

Yes, but not (necessarily) exclusively. ;-)

(Almost all build scripts append or prepend to `CFLAGS` etc., which is convenient if one only wants to add e.g. "`-g`", "`-march=native`" or "`-mcpu=i486`". Here we want the former...)


---

Comment by leif created at 2010-11-22 01:11:15

Changing status from new to needs_info.


---

Comment by leif created at 2010-11-22 01:11:15

So we at least still have the problem of adding `-m64` if `SAGE64=yes` (i.e., if we want a 64-bit build on systems that default to 32-bit builds):

```sh
...
# Note that GMP-ECM is written in C (and assembler) - no C++ sources.

if [ "$SAGE64" = yes ]; then
    echo "Building a 64-bit version of GMP-ECM"
    if [ -z "$CFLAG64" ]; then
        CFLAG64=-m64
    fi
    CFLAGS="$CFLAGS $CFLAG64 -fPIC"
    LDFLAGS="$CFLAG64"; export LDFLAGS
else
    CFLAGS="$CFLAGS -fPIC"
fi

# We add debug symbols by default;
if [ "$SAGE_DEBUG" = yes ]; then
    # Disable optimization:
    CFLAGS="$CFLAGS -g -O0"
else
    # Enable optimization, may be overridden by user settings:
    CFLAGS="-g -O3 $CFLAGS"
fi

export CFLAGS # usually redundant, but safe(r)
...
```


Of course I could add "our" (or worse, also _any user-specified_) `CFLAGS` to `CC`, i.e. the C compiler command, and `unset CFLAGS` to make ECM's effective, but I wouldn't like that. (And some settings then would get overridden by ECM's `CFLAGS` anyway.)

----

An IMHO better solution is to also add `-march=native` to `CFLAGS`, since this enables SSE (to be precise, allows SSE2 instructions) if supported by the processor (when `configure` defines `HAVE_SSE2`), ignoring `SAGE_FAT_BINARY` at least for the moment (unless ECM's `configure` has an option like `--disable-sse` or similar; I haven't really checked that yet, perhaps just `--enable-sse2=no` on _32-bit_ x86).




I'm not sure what happens if we configure with `CFLAGS` set and `--enable-gmp-cflags=no` (which seems to be more appropriate when using ECM with MPIR).


---

Comment by leif created at 2010-11-22 04:52:00

Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...


---

Comment by leif created at 2010-11-22 04:52:00

Changing status from needs_info to needs_work.


---

Comment by zimmerma created at 2010-11-22 08:29:18

Replying to [comment:14 leif]:
> So we at least still have the problem of adding `-m64` if `SAGE64=yes` [...]

not sure. GMP uses 64-bit words if available (even if the system is 32 bit), and GMP-ECM uses
GMP CFLAGS.

Paul


---

Comment by jdemeyer created at 2010-11-22 08:56:42

So the solution is easy: don't set *any* `CFLAGS` in the mpir and ecm packages.  Right?


---

Comment by zimmerma created at 2010-11-22 09:20:54

Replying to [comment:17 jdemeyer]:
> So the solution is easy: don't set *any* `CFLAGS` in the mpir and ecm packages.  Right?

that is my advice. Same for MPFR, which also copies CFLAGS from GMP.

Paul


---

Comment by fbissey created at 2010-11-22 09:28:44

Replying to [comment:14 leif]:
> An IMHO better solution is to also add `-march=native` to `CFLAGS`, since this enables SSE (to be precise, allows SSE2 instructions) if supported by the processor (when `configure` defines `HAVE_SSE2`), ignoring `SAGE_FAT_BINARY` at least for the moment (unless ECM's `configure` has an option like `--disable-sse` or similar; I haven't really checked that yet, perhaps just `--enable-sse2=no` on _32-bit_ x86).

You know that -march=native is only supported on x86 and amd64 cpus right?
I can tell you first hand that the compilation will stop straight away on ppc.
And then you will get Dave telling you it is not supported by other compilers.


---

Comment by leif created at 2010-11-22 10:08:25

Replying to [comment:19 fbissey]:
> You know that -march=native is only supported on x86 and amd64 cpus right?

Not only, but ...

> I can tell you first hand that the compilation will stop straight away on ppc.

I was not going to try to enable SSE2 on PowerPCs (nor SPARC processors). ;-)





> And then you will get Dave telling you it is not supported by other compilers.

There's very little support for other compilers in Sage, and it's easy to add a distinction when the day it gets necessary comes, though I could add it now.


---

Comment by fbissey created at 2010-11-22 10:16:11

Replying to [comment:20 leif]:
> Replying to [comment:19 fbissey]:
> > You know that -march=native is only supported on x86 and amd64 cpus right?
> 
> Not only, but ...
> 
> > I can tell you first hand that the compilation will stop straight away on ppc.
> 
> I was not going to try to enable SSE2 on PowerPCs (nor SPARC processors). ;-)
> 
> 

> 
> 
> > And then you will get Dave telling you it is not supported by other compilers.
> 
> There's very little support for other compilers in Sage, and it's easy to add a distinction when the day it gets necessary comes, though I could add it now.

Ok, I missed a little bit of context. I guess I didn't pay full attention to the whole thread. Sorry for the noise.


---

Comment by leif created at 2010-11-24 02:16:54

Changing status from needs_work to needs_review.


---

Comment by leif created at 2010-11-24 02:16:54

Replying to [comment:15 leif]:
> Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...

Did so...

Setting this ticket to "needs review" too, can be closed as duplicate when #5847 gets a positive review / merged.


---

Comment by leif created at 2010-11-25 14:31:18

Replying to [comment:22 leif]:
> Replying to [comment:15 leif]:
> > Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...
> 
> Did so...
> 
> Setting this ticket to "needs review" too, can be closed as duplicate when #5847 gets a positive review / merged.

I've updated the p2 package at #5847 (some corrections, some improvements); same place, different md5sum, still or again needing testing (especially on PowerPCs) / review.

See http://trac.sagemath.org/sage_trac/ticket/5847#comment:86 .


---

Comment by dimpase created at 2010-11-25 16:43:30

Replying to [comment:23 leif]:
> Replying to [comment:22 leif]:
> > Replying to [comment:15 leif]:
> > > Just for the record: I'll upload a new spkg that also fixes this issue at #5847 (hopefully) soon...
> > 
> > Did so...
> > 
> > Setting this ticket to "needs review" too, can be closed as duplicate when #5847 gets a positive review / merged.
> 
> I've updated the p2 package at #5847 (some corrections, some improvements); same place, different md5sum, still or again needing testing (especially on PowerPCs) / review.
> 
> See http://trac.sagemath.org/sage_trac/ticket/5847#comment:86 .

duly tested on PPC, see the other ticket.


---

Comment by robertwb created at 2010-12-04 01:47:25

Is there any reason this shouldn't be closed as a dup now?


---

Comment by robertwb created at 2010-12-04 01:47:25

Changing status from needs_review to needs_info.


---

Comment by leif created at 2010-12-04 02:16:05

Replying to [comment:25 robertwb]:
> Is there any reason this shouldn't be closed as a dup now?

Well, it's a symbolic link to #5847, which still needs review, delaying the MPIR upgrade (#8664) further.

We should close it when #5847 got merged.


---

Comment by leif created at 2011-09-09 04:48:45

Changing keywords from "ecm spkg-install" to "ecm spkg-install SSE2".


---

Comment by leif created at 2011-09-09 04:48:45

Changing status from needs_info to needs_review.


---

Comment by leif created at 2011-09-09 04:48:54

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2011-09-10 07:22:59

for your information, this bug is fixed upstream, but we have no new release yet. The fix
consists in adding -msse2 when required to compile the corresponding assembly files.
See around lines 297-326 of the configure.in file in the svn version upstream.

Paul Zimmermann


---

Comment by leif created at 2011-09-10 07:40:04

Replying to [comment:30 zimmerma]:
> for your information, this bug is fixed upstream, but we have no new release yet.

Thanks. We already apply that patch (I think; from revision 1546) in the .p2 spkg at #5847.


---

Comment by leif created at 2011-09-12 19:00:30

Resolution: duplicate


---

Comment by zimmerma created at 2012-01-03 23:57:03

this problem is fixed in GMP-ECM 6.4, which has just been released.

Paul Zimmermann
