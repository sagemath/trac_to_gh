# Issue 10294: Upgrading pexpect

archive/issues_010294.json:
```json
{
    "body": "Assignee: @williamstein\n\nCC:  drkirkby @nexttime vincent.neri\n\nKeywords: pexpect upgrade\n\nWe use pexpect version 2.0. Shouldn't we upgrade to the current version 2.3?\n\nThis may be related with the performance problem reported at #10294.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10295\n\n",
    "created_at": "2010-11-20T08:53:18Z",
    "labels": [
        "interfaces",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "Upgrading pexpect",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10294",
    "user": "@simon-king-jena"
}
```
Assignee: @williamstein

CC:  drkirkby @nexttime vincent.neri

Keywords: pexpect upgrade

We use pexpect version 2.0. Shouldn't we upgrade to the current version 2.3?

This may be related with the performance problem reported at #10294.

Issue created by migration from https://trac.sagemath.org/ticket/10295





---

archive/issue_comments_105138.json:
```json
{
    "body": "Try version 2.4 even. This has been discussed to death several times on sage-devel.\nVersion 2.1 and over are slower than what we currently have. Plus from experience\nin sage-on-gentoo where at some stage we experimented with pexpect 2.4, some plotting broke down in the notebook.",
    "created_at": "2010-11-20T08:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105138",
    "user": "@kiwifb"
}
```

Try version 2.4 even. This has been discussed to death several times on sage-devel.
Version 2.1 and over are slower than what we currently have. Plus from experience
in sage-on-gentoo where at some stage we experimented with pexpect 2.4, some plotting broke down in the notebook.



---

archive/issue_comments_105139.json:
```json
{
    "body": "When I say version 2.4 you have to go there: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)\nrather than here: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)",
    "created_at": "2010-11-20T09:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105139",
    "user": "@kiwifb"
}
```

When I say version 2.4 you have to go there: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)
rather than here: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)



---

archive/issue_comments_105140.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> When I say version 2.4 you have to go there: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)\n> rather than here: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)\n\nAren't the two links the same?\n\nSo, you say that there might be a performance problem with more recent versions of pexpect. That's bad, because the idea was to *get rid of* a performance problem by upgrading...",
    "created_at": "2010-11-20T09:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105140",
    "user": "@simon-king-jena"
}
```

Replying to [comment:2 fbissey]:
> When I say version 2.4 you have to go there: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)
> rather than here: [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect)

Aren't the two links the same?

So, you say that there might be a performance problem with more recent versions of pexpect. That's bad, because the idea was to *get rid of* a performance problem by upgrading...



---

archive/issue_comments_105141.json:
```json
{
    "body": "cut and paste didn't work as expected the second one was meant to be:\n[http://pexpect.sourceforge.net/](http://pexpect.sourceforge.net/)\n\nsearch the mailing list for pexpect, it is a proverbial can of worms.",
    "created_at": "2010-11-20T09:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105141",
    "user": "@kiwifb"
}
```

cut and paste didn't work as expected the second one was meant to be:
[http://pexpect.sourceforge.net/](http://pexpect.sourceforge.net/)

search the mailing list for pexpect, it is a proverbial can of worms.



---

archive/issue_comments_105142.json:
```json
{
    "body": "2.4 is not released yet. Here's a package for 2.3 that I created.\n\nhttp://boxen.math.washington.edu/home/kirkby/patches/pexpect-2.3.spkg\n\nbut on my OpenSolaris machine, this 2.3 package results in one doctest failure, which is:\n\n\n```\nsage -t  -long -force_lib devel/sage/sage/interfaces/expect.py\n```\n\n\nThe interface must be semi-working, as the interface to R works - or at lease the R doctest does not fail. Here's the error message of the failed doctest. \n\n\n```\nsage -t  -long -force_lib devel/sage/sage/interfaces/sage0.py\n         [14.8 s]\nsage -t  -long -force_lib devel/sage/sage/interfaces/expect.py\nException pexpect.ExceptionPexpect: ExceptionPexpect() in <bound method spawn.__del__ of <pexpect.spawn object at 0xc5988ac>> ignored\n\n<snip out load more similar errors>\n\n<pexpect.spawn object at 0xc386d6c>> ignored\nException pexpect.ExceptionPexpect: ExceptionPexpect() in <bound method spawn.__del__ of <pexpect.spawn object at 0xc386d6c>> ignored\n**********************************************************************\nFile \"/export/home/drkirkby/sage-4.7.alpha3/devel/sage-main/sage/interfaces/expect.py\", line 867:\n    sage: r._expect.before\nExpected:\n    'abc;\\r\\n[1] '\nGot:\n    'abc <- 10 +15;\\r\\n__SAGE__R__PROMPT__> abc;\\r\\n[1] '\n**********************************************************************\n1 items had failures:\n   1 of  11 in __main__.example_16\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /export/home/drkirkby/.sage//tmp/.doctest_expect.py\n         [18.4 s]\nsage -t  -long -force_lib devel/sage/sage/interfaces/gap.py\n         [20.4 s]\n```\n\n\nI think in some cases where we call external programs there are probably better ways of doing this. For example\n* R has libraries, I expect we can call R via the libraries, rather than on the command line. \n* Mathematica uses the [Mathlink](http://reference.wolfram.com/mathematica/tutorial/MathLinkAndExternalProgramCommunicationOverview.html) protocol to communicate between the kernel and front end. How to use [Mathlink](http://reference.wolfram.com/mathematica/tutorial/MathLinkAndExternalProgramCommunicationOverview.html) is documented, and has been used by at least open-source program ([JMath](http://robotics.caltech.edu/~radford/jmath/)) to work with Mathematica. But Sage calls Mathematica via the command line. \n\nDave",
    "created_at": "2011-04-08T07:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105142",
    "user": "drkirkby"
}
```

2.4 is not released yet. Here's a package for 2.3 that I created.

http://boxen.math.washington.edu/home/kirkby/patches/pexpect-2.3.spkg

but on my OpenSolaris machine, this 2.3 package results in one doctest failure, which is:


```
sage -t  -long -force_lib devel/sage/sage/interfaces/expect.py
```


The interface must be semi-working, as the interface to R works - or at lease the R doctest does not fail. Here's the error message of the failed doctest. 


```
sage -t  -long -force_lib devel/sage/sage/interfaces/sage0.py
         [14.8 s]
sage -t  -long -force_lib devel/sage/sage/interfaces/expect.py
Exception pexpect.ExceptionPexpect: ExceptionPexpect() in <bound method spawn.__del__ of <pexpect.spawn object at 0xc5988ac>> ignored

<snip out load more similar errors>

<pexpect.spawn object at 0xc386d6c>> ignored
Exception pexpect.ExceptionPexpect: ExceptionPexpect() in <bound method spawn.__del__ of <pexpect.spawn object at 0xc386d6c>> ignored
**********************************************************************
File "/export/home/drkirkby/sage-4.7.alpha3/devel/sage-main/sage/interfaces/expect.py", line 867:
    sage: r._expect.before
Expected:
    'abc;\r\n[1] '
Got:
    'abc <- 10 +15;\r\n__SAGE__R__PROMPT__> abc;\r\n[1] '
**********************************************************************
1 items had failures:
   1 of  11 in __main__.example_16
***Test Failed*** 1 failures.
For whitespace errors, see the file /export/home/drkirkby/.sage//tmp/.doctest_expect.py
         [18.4 s]
sage -t  -long -force_lib devel/sage/sage/interfaces/gap.py
         [20.4 s]
```


I think in some cases where we call external programs there are probably better ways of doing this. For example
* R has libraries, I expect we can call R via the libraries, rather than on the command line. 
* Mathematica uses the [Mathlink](http://reference.wolfram.com/mathematica/tutorial/MathLinkAndExternalProgramCommunicationOverview.html) protocol to communicate between the kernel and front end. How to use [Mathlink](http://reference.wolfram.com/mathematica/tutorial/MathLinkAndExternalProgramCommunicationOverview.html) is documented, and has been used by at least open-source program ([JMath](http://robotics.caltech.edu/~radford/jmath/)) to work with Mathematica. But Sage calls Mathematica via the command line. 

Dave



---

archive/issue_comments_105143.json:
```json
{
    "body": "Oops, I see this doctest is related to R. But I'm sure there are other doctests which make use of pexpect, which are passing\n\nDave",
    "created_at": "2011-04-08T07:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105143",
    "user": "drkirkby"
}
```

Oops, I see this doctest is related to R. But I'm sure there are other doctests which make use of pexpect, which are passing

Dave



---

archive/issue_comments_105144.json:
```json
{
    "body": "While 2.4 is not on sourceforge but on pypi.python.org [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect) I think we can call it released unless you have other infos (from author/mailing list).\nAs far as I remember, last time we tried pexpect-2.4 on sage-on-gentoo it broke plotting in the notebook. Can you try to do some plotting in the notebook with this version of pexpect? Digged my email archive, more precisely:\n\n```\ng=sin(x); plot(g,(x,-pi,3*pi/2))\n```\n\nin the notebook. It produced the following for us (at the time, notice the python time stamp):\n\n```\nimport os;os.chdir(\"/tmp/tmpo2KomY\");\nexecfile(\"_sage_input_1.py\")Python 2.6.4 (r264:75706, Mar  4 2010,\n21:15:13)\n[GCC 4.3.4] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> \n>>> import os;os.chdir(\"/tmp/tmpo2KomY\");\n>>> execfile(\"_sage_input_1.py\")\nSTART1\n\nimport os;os.chdir(\"/tmp/tmpY61yjM\");\nexecfile(\"_sage_input_2.py\")\n\nimport os;os.chdir(\"/tmp/tmpXjmsQK\");\nexecfile(\"_sage_input_3.py\")\n__SAGE__\n__SAGE__import os;os.chdir(\"/tmp/tmpY61yjM\");\n__SAGE__execfile(\"_sage_input_2.py\")\nSTART2\n__SAGE__\n__SAGE__import os;os.chdir(\"/tmp/tmpXjmsQK\");\n```\n",
    "created_at": "2011-04-08T09:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105144",
    "user": "@kiwifb"
}
```

While 2.4 is not on sourceforge but on pypi.python.org [http://pypi.python.org/pypi/pexpect](http://pypi.python.org/pypi/pexpect) I think we can call it released unless you have other infos (from author/mailing list).
As far as I remember, last time we tried pexpect-2.4 on sage-on-gentoo it broke plotting in the notebook. Can you try to do some plotting in the notebook with this version of pexpect? Digged my email archive, more precisely:

```
g=sin(x); plot(g,(x,-pi,3*pi/2))
```

in the notebook. It produced the following for us (at the time, notice the python time stamp):

```
import os;os.chdir("/tmp/tmpo2KomY");
execfile("_sage_input_1.py")Python 2.6.4 (r264:75706, Mar  4 2010,
21:15:13)
[GCC 4.3.4] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> 
>>> import os;os.chdir("/tmp/tmpo2KomY");
>>> execfile("_sage_input_1.py")
START1

import os;os.chdir("/tmp/tmpY61yjM");
execfile("_sage_input_2.py")

import os;os.chdir("/tmp/tmpXjmsQK");
execfile("_sage_input_3.py")
__SAGE__
__SAGE__import os;os.chdir("/tmp/tmpY61yjM");
__SAGE__execfile("_sage_input_2.py")
START2
__SAGE__
__SAGE__import os;os.chdir("/tmp/tmpXjmsQK");
```




---

archive/issue_comments_105145.json:
```json
{
    "body": "Dave, have you tried plotting in the notebook?",
    "created_at": "2011-04-12T23:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105145",
    "user": "@kiwifb"
}
```

Dave, have you tried plotting in the notebook?



---

archive/issue_comments_105146.json:
```json
{
    "body": "Bump this. There is a pexpect 3.1 now at http://pexpect.readthedocs.org/en/latest/ (note: the sourceforge address will redirect you there). For a long time I thought pexpect was done and there wouldn't be anymore release.\n\nI think if the project is alive they may take request from us.",
    "created_at": "2014-03-30T09:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105146",
    "user": "@kiwifb"
}
```

Bump this. There is a pexpect 3.1 now at http://pexpect.readthedocs.org/en/latest/ (note: the sourceforge address will redirect you there). For a long time I thought pexpect was done and there wouldn't be anymore release.

I think if the project is alive they may take request from us.



---

archive/issue_comments_105147.json:
```json
{
    "body": "Hum wrong stuff in that branch sorry will update shortly.",
    "created_at": "2015-05-08T02:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105147",
    "user": "@kiwifb"
}
```

Hum wrong stuff in that branch sorry will update shortly.



---

archive/issue_comments_105148.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-08T02:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105148",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105149.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-08T02:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105149",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105150.json:
```json
{
    "body": "The bad behavior in the notebook originates in `sagenb/notebook/worksheet.py`, this is potentially broken but the question is why don't we go there we the old pexpect?",
    "created_at": "2015-05-08T02:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105150",
    "user": "@kiwifb"
}
```

The bad behavior in the notebook originates in `sagenb/notebook/worksheet.py`, this is potentially broken but the question is why don't we go there we the old pexpect?



---

archive/issue_comments_105151.json:
```json
{
    "body": "Be aware that #17686 cleans up `expect.py`.",
    "created_at": "2015-05-08T11:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105151",
    "user": "@nexttime"
}
```

Be aware that #17686 cleans up `expect.py`.



---

archive/issue_comments_105152.json:
```json
{
    "body": "Seems to be orthogonal to the only change I made to that file. It'll just need rebasing. On the other hand there seem to be several `load` functions defined in sage. And it is not obvious why we should get that one in the notebook.",
    "created_at": "2015-05-08T12:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105152",
    "user": "@kiwifb"
}
```

Seems to be orthogonal to the only change I made to that file. It'll just need rebasing. On the other hand there seem to be several `load` functions defined in sage. And it is not obvious why we should get that one in the notebook.



---

archive/issue_comments_105153.json:
```json
{
    "body": "https://github.com/billpage/sagenb/commit/811a2e762bb041dd34d32d96b003ab46eaab22e9\n\nHere is a patch to sagenb/interfaces/expect.py that corrects the bad behavior in the notebook following upgrade to pexpect 3.3.  The problem is due to a difference between pexpect 2.0 and newer versions of pexpect in what happens following a TIMEOUT of an expect; call.  TIMEOUT is the intended result from a call to '_read'. In newer versions '_expect.before' is not modified by TIMEOUT so the output continues to accumulate. There is no need to do this ourselves in 'output_status'.",
    "created_at": "2015-05-10T08:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105153",
    "user": "bpage"
}
```

https://github.com/billpage/sagenb/commit/811a2e762bb041dd34d32d96b003ab46eaab22e9

Here is a patch to sagenb/interfaces/expect.py that corrects the bad behavior in the notebook following upgrade to pexpect 3.3.  The problem is due to a difference between pexpect 2.0 and newer versions of pexpect in what happens following a TIMEOUT of an expect; call.  TIMEOUT is the intended result from a call to '_read'. In newer versions '_expect.before' is not modified by TIMEOUT so the output continues to accumulate. There is no need to do this ourselves in 'output_status'.



---

archive/issue_comments_105154.json:
```json
{
    "body": "See also http://pexpect.readthedocs.org/en/latest/history.html?highlight=timeout#version-2-3 for perhaps a better explanation.",
    "created_at": "2015-05-10T08:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105154",
    "user": "bpage"
}
```

See also http://pexpect.readthedocs.org/en/latest/history.html?highlight=timeout#version-2-3 for perhaps a better explanation.



---

archive/issue_comments_105155.json:
```json
{
    "body": "Cool, I'll try that tomorrow morning. The next step will be performance measurements. One of the reason we hadn't moved to at least pexpect 2.4 was poor performance (sloooow). I would be willing to trade performance for something properly maintained but we should know what we are getting into on that front. Then again that `TIMEOUT` thing may have been the cause.",
    "created_at": "2015-05-10T08:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105155",
    "user": "@kiwifb"
}
```

Cool, I'll try that tomorrow morning. The next step will be performance measurements. One of the reason we hadn't moved to at least pexpect 2.4 was poor performance (sloooow). I would be willing to trade performance for something properly maintained but we should know what we are getting into on that front. Then again that `TIMEOUT` thing may have been the cause.



---

archive/issue_comments_105156.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> Then again that `TIMEOUT` thing may have been the cause.\n\nThe mentioned change was made in 2.3, but already 2.1 was said to be slooooooooow.\n\nBut we'll (or you'll) see...",
    "created_at": "2015-05-10T14:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105156",
    "user": "@nexttime"
}
```

Replying to [comment:25 fbissey]:
> Then again that `TIMEOUT` thing may have been the cause.

The mentioned change was made in 2.3, but already 2.1 was said to be slooooooooow.

But we'll (or you'll) see...



---

archive/issue_comments_105157.json:
```json
{
    "body": "I also doubt that this particular case of the use of TIMEOUT has anything to do with version 2.1 being slower.  The problem here is how the notebook interacts with Sage in an asynchronous manner.  TIMEOUT is the expected behavior when checking on the status of a computation.  This allows notebook to display partial results, i.e. the output in 'self._so_far'.  The notebook code treats TIMEOUT as a Python exception rather than waiting for it with a 'expect' pattern.  In the old version of pexpect this exception did not update the '.before' attribute.  On the other hand if the code was changed to explicitly look for 'pexpect.TIMEOUT' then we would have had this problem even with the old version.\n\nWhat is the recommended way to measure Sage performance?",
    "created_at": "2015-05-10T15:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105157",
    "user": "bpage"
}
```

I also doubt that this particular case of the use of TIMEOUT has anything to do with version 2.1 being slower.  The problem here is how the notebook interacts with Sage in an asynchronous manner.  TIMEOUT is the expected behavior when checking on the status of a computation.  This allows notebook to display partial results, i.e. the output in 'self._so_far'.  The notebook code treats TIMEOUT as a Python exception rather than waiting for it with a 'expect' pattern.  In the old version of pexpect this exception did not update the '.before' attribute.  On the other hand if the code was changed to explicitly look for 'pexpect.TIMEOUT' then we would have had this problem even with the old version.

What is the recommended way to measure Sage performance?



---

archive/issue_comments_105158.json:
```json
{
    "body": "Replying to [comment:27 bpage]:\n> What is the recommended way to measure Sage performance?\n\nGood question, I can only talk about the command line interface:\n\nOf course there's `time ./sage -t --long src/sage/interfaces/` (probably with `-p`; one can also set `SAGE_TEST_ITER` and `SAGE_TEST_GLOBAL_ITER`).  Only testing the interfaces that actually use pexpect (and where the external program is really installed) makes more sense.\n\nTests that make heavy use of (stand-alone) Maxima/`ecl`, Singular, `gap` and `gp` are meaningful as well.  I cannot really list them right now, but `src/sage/schemes/elliptic_curves/` and especially `src/sage/sandpiles/sandpile.py` are known to fall into that category IIRC.\n\nBefore testing, it IMHO makes sense to remove or rename `$DOT_SAGE/timings*.json`, otherwise doctests will get reordered with undesirable impact on the resource usage, influencing the measured timings.",
    "created_at": "2015-05-10T15:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105158",
    "user": "@nexttime"
}
```

Replying to [comment:27 bpage]:
> What is the recommended way to measure Sage performance?

Good question, I can only talk about the command line interface:

Of course there's `time ./sage -t --long src/sage/interfaces/` (probably with `-p`; one can also set `SAGE_TEST_ITER` and `SAGE_TEST_GLOBAL_ITER`).  Only testing the interfaces that actually use pexpect (and where the external program is really installed) makes more sense.

Tests that make heavy use of (stand-alone) Maxima/`ecl`, Singular, `gap` and `gp` are meaningful as well.  I cannot really list them right now, but `src/sage/schemes/elliptic_curves/` and especially `src/sage/sandpiles/sandpile.py` are known to fall into that category IIRC.

Before testing, it IMHO makes sense to remove or rename `$DOT_SAGE/timings*.json`, otherwise doctests will get reordered with undesirable impact on the resource usage, influencing the measured timings.



---

archive/issue_comments_105159.json:
```json
{
    "body": "On my system with pexpect 3.x from github I get:\n\n```\n  wspage@suse:~/sage> inxi -SCI\n  System:    Host: suse Kernel: 3.0.101-0.46-default x86_64 (64 bit) \n             Desktop Gnome 2.28.2 Distro: SUSE Linux Enterprise Server 11 (x86_64) VERSION = 11 PATCHLEVEL = 3\n  CPU:       Quad core Intel Core i5-2500K CPU (-MCP-) cache: 6144 KB flags: (lm nx sse sse2 sse3 sse4_1 sse4_2 ssse3 vmx) \n             Clock Speeds: 1: 1600.00 MHz 2: 1600.00 MHz 3: 3301.00 MHz 4: 1600.00 MHz\n  Info:      Processes: 245 Uptime: 67 days  5:09 Memory: 11461.1/15917.0MB Client: Shell inxi: 1.7.24 \n\n \n  wspage@suse:~/sage> time ./sage -t --long src/sage/interfaces/\n  ...\n  ----------------------------------------------------------------------\n  sage -t --long src/sage/interfaces/expect.py  # 1 doctest failed\n  ----------------------------------------------------------------------\n  Total time for all tests: 123.2 seconds\n      cpu time: 14.3 seconds\n      cumulative wall time: 120.5 seconds\n\n  real\t2m18.358s\n  user\t0m56.396s\n  sys\t0m4.856s\n```\n",
    "created_at": "2015-05-10T21:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105159",
    "user": "bpage"
}
```

On my system with pexpect 3.x from github I get:

```
  wspage@suse:~/sage> inxi -SCI
  System:    Host: suse Kernel: 3.0.101-0.46-default x86_64 (64 bit) 
             Desktop Gnome 2.28.2 Distro: SUSE Linux Enterprise Server 11 (x86_64) VERSION = 11 PATCHLEVEL = 3
  CPU:       Quad core Intel Core i5-2500K CPU (-MCP-) cache: 6144 KB flags: (lm nx sse sse2 sse3 sse4_1 sse4_2 ssse3 vmx) 
             Clock Speeds: 1: 1600.00 MHz 2: 1600.00 MHz 3: 3301.00 MHz 4: 1600.00 MHz
  Info:      Processes: 245 Uptime: 67 days  5:09 Memory: 11461.1/15917.0MB Client: Shell inxi: 1.7.24 

 
  wspage@suse:~/sage> time ./sage -t --long src/sage/interfaces/
  ...
  ----------------------------------------------------------------------
  sage -t --long src/sage/interfaces/expect.py  # 1 doctest failed
  ----------------------------------------------------------------------
  Total time for all tests: 123.2 seconds
      cpu time: 14.3 seconds
      cumulative wall time: 120.5 seconds

  real	2m18.358s
  user	0m56.396s
  sys	0m4.856s
```




---

archive/issue_comments_105160.json:
```json
{
    "body": "You should do some things like\n\n```\n    %timeit gp.eval('2+3')\n    %timeit gp('2') + gp('3')\n    %timeit axiom('2+3')\n```\n\netc.   The doctesting won't testing latency much, and latency is *the* main issue with performance with the pexpect interfaces.\nThe other is size, e.g.,\n\n```\n    %timeit s=str(gp.eval('2^10000'))\n```\n",
    "created_at": "2015-05-10T21:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105160",
    "user": "@williamstein"
}
```

You should do some things like

```
    %timeit gp.eval('2+3')
    %timeit gp('2') + gp('3')
    %timeit axiom('2+3')
```

etc.   The doctesting won't testing latency much, and latency is *the* main issue with performance with the pexpect interfaces.
The other is size, e.g.,

```
    %timeit s=str(gp.eval('2^10000'))
```




---

archive/issue_comments_105161.json:
```json
{
    "body": "I will move to do the latency test shortly but for reference when I do the doctesting of `sage/interface` on my machine.\npexpect-2.0\n\n```\nTotal time for all tests: 118.3 seconds\n    cpu time: 20.6 seconds\n    cumulative wall time: 115.9 seconds\n\nreal    1m59.638s\nuser    1m21.060s\nsys     0m3.290s\n```\n\npexpect-3.3\n\n```\nTotal time for all tests: 128.3 seconds\n    cpu time: 21.3 seconds\n    cumulative wall time: 125.9 seconds\n\nreal    2m9.655s\nuser    1m27.270s\nsys     0m3.200s\n```\n\nSo it's a little bit slower already. I don't know if anything skew that a bit. Moving to the latency test which may be a better test anyway.",
    "created_at": "2015-05-10T22:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105161",
    "user": "@kiwifb"
}
```

I will move to do the latency test shortly but for reference when I do the doctesting of `sage/interface` on my machine.
pexpect-2.0

```
Total time for all tests: 118.3 seconds
    cpu time: 20.6 seconds
    cumulative wall time: 115.9 seconds

real    1m59.638s
user    1m21.060s
sys     0m3.290s
```

pexpect-3.3

```
Total time for all tests: 128.3 seconds
    cpu time: 21.3 seconds
    cumulative wall time: 125.9 seconds

real    2m9.655s
user    1m27.270s
sys     0m3.200s
```

So it's a little bit slower already. I don't know if anything skew that a bit. Moving to the latency test which may be a better test anyway.



---

archive/issue_comments_105162.json:
```json
{
    "body": "pexpect-2.0\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath Version 6.7.beta4, Release Date: 2015-05-05               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: %timeit gp.eval('2+3')\nThe slowest run took 269.56 times longer than the fastest. This could mean that an intermediate result is being cached \n10000 loops, best of 3: 94.4 us per loop\nsage: %timeit gp('2') + gp('3')\nThe slowest run took 8.78 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 556 us per loop\nsage: %timeit s=str(gp.eval('2^10000'))\n1000 loops, best of 3: 250 us per loop\n```\n\n\nOne time only so we don't use the cache\n\n```\nsage: %time gp.eval('2+3')\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 728 us\n'5'\nsage: %time gp('2') + gp('3')\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 1.51 ms\n5\nsage: %time s=str(gp.eval('2^10000'))\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 667 us\n```\n\n\npexpect-3.3\n\n```\nsage: %timeit gp.eval('2+3')\nThe slowest run took 80.90 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 309 us per loop\nsage: %timeit gp('2') + gp('3')\n1000 loops, best of 3: 1.54 ms per loop\nsage: %timeit s=str(gp.eval('2^10000'))\nThe slowest run took 6.02 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 513 us per loop\n```\n\nOne time only\n\n```\nsage: %time gp.eval('2+3')\nCPU times: user 10 ms, sys: 0 ns, total: 10 ms\nWall time: 30.5 ms\n'5'\nsage: %time gp('2') + gp('3')\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 4.58 ms\n5\nsage: %time s=str(gp.eval('2^10000'))\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 644 us\n```\n\n\nSo it is a little bit all over the place, but generally 3 to 4 times slower with pexpect 3.3. I don't know if it is acceptable. Since upstream is now alive and well we could take it as an issue with them?",
    "created_at": "2015-05-10T22:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105162",
    "user": "@kiwifb"
}
```

pexpect-2.0

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath Version 6.7.beta4, Release Date: 2015-05-05               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: %timeit gp.eval('2+3')
The slowest run took 269.56 times longer than the fastest. This could mean that an intermediate result is being cached 
10000 loops, best of 3: 94.4 us per loop
sage: %timeit gp('2') + gp('3')
The slowest run took 8.78 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 556 us per loop
sage: %timeit s=str(gp.eval('2^10000'))
1000 loops, best of 3: 250 us per loop
```


One time only so we don't use the cache

```
sage: %time gp.eval('2+3')
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 728 us
'5'
sage: %time gp('2') + gp('3')
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 1.51 ms
5
sage: %time s=str(gp.eval('2^10000'))
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 667 us
```


pexpect-3.3

```
sage: %timeit gp.eval('2+3')
The slowest run took 80.90 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 309 us per loop
sage: %timeit gp('2') + gp('3')
1000 loops, best of 3: 1.54 ms per loop
sage: %timeit s=str(gp.eval('2^10000'))
The slowest run took 6.02 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 513 us per loop
```

One time only

```
sage: %time gp.eval('2+3')
CPU times: user 10 ms, sys: 0 ns, total: 10 ms
Wall time: 30.5 ms
'5'
sage: %time gp('2') + gp('3')
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 4.58 ms
5
sage: %time s=str(gp.eval('2^10000'))
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 644 us
```


So it is a little bit all over the place, but generally 3 to 4 times slower with pexpect 3.3. I don't know if it is acceptable. Since upstream is now alive and well we could take it as an issue with them?



---

archive/issue_comments_105163.json:
```json
{
    "body": "> So it is a little bit all over the place, but generally 3 to 4 times slower with pexpect 3.3. I don't know if it is acceptable.\n\nNo, this is definitely not acceptable.  For real work it could easily mean people's programs are 4 times slower due to this upgrade.  It's important to understand that the use case of pexpect by Sage is massively different than the use case of pexpect for absolutely everybody else -- for them some latency issues are no big deal, but for us they are.\n\nIncidentally, I think there is no caching going on despite what %timeit says...",
    "created_at": "2015-05-10T22:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105163",
    "user": "@williamstein"
}
```

> So it is a little bit all over the place, but generally 3 to 4 times slower with pexpect 3.3. I don't know if it is acceptable.

No, this is definitely not acceptable.  For real work it could easily mean people's programs are 4 times slower due to this upgrade.  It's important to understand that the use case of pexpect by Sage is massively different than the use case of pexpect for absolutely everybody else -- for them some latency issues are no big deal, but for us they are.

Incidentally, I think there is no caching going on despite what %timeit says...



---

archive/issue_comments_105164.json:
```json
{
    "body": "Right, I am hearing you. This is a definite problem. So is keeping dead software. If we are keeping the pexpect 2.0 branch in for performance issue it becomes the responsibility of sage developers to maintain it and add new features like the one Bill wants. \n\nEffectively we are maintaining a fork and if we are going that way I would like it to be formalized with a different name and possibly integrated in the sage code itself. This is so people don't get upgraded to a different pexpect through pip if they are using it. Also while our core functionality uses this pexpect, we don't want to block other packages that would need a newer pexpect.\n\nThat is my opinion on the matter. The other way is to work, possibly with upstream, to solve that latency problem in newer versions.",
    "created_at": "2015-05-10T22:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105164",
    "user": "@kiwifb"
}
```

Right, I am hearing you. This is a definite problem. So is keeping dead software. If we are keeping the pexpect 2.0 branch in for performance issue it becomes the responsibility of sage developers to maintain it and add new features like the one Bill wants. 

Effectively we are maintaining a fork and if we are going that way I would like it to be formalized with a different name and possibly integrated in the sage code itself. This is so people don't get upgraded to a different pexpect through pip if they are using it. Also while our core functionality uses this pexpect, we don't want to block other packages that would need a newer pexpect.

That is my opinion on the matter. The other way is to work, possibly with upstream, to solve that latency problem in newer versions.



---

archive/issue_comments_105165.json:
```json
{
    "body": "fbissey -- definitely -- I completely agree with you, as long as \"we\" = not me :-)",
    "created_at": "2015-05-10T23:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105165",
    "user": "@williamstein"
}
```

fbissey -- definitely -- I completely agree with you, as long as "we" = not me :-)



---

archive/issue_comments_105166.json:
```json
{
    "body": "`@`bill do you think it would be easy to bake unicode support in pexpect 2.0? Or would it be easier to work out the latency issue? You seem to have a good handle on what's in pexpect.",
    "created_at": "2015-05-10T23:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105166",
    "user": "@kiwifb"
}
```

`@`bill do you think it would be easy to bake unicode support in pexpect 2.0? Or would it be easier to work out the latency issue? You seem to have a good handle on what's in pexpect.



---

archive/issue_comments_105167.json:
```json
{
    "body": "Apparently the performance problem originates with this old commit:\n\nhttps://github.com/pexpect/pexpect/commit/600463686284ea102548f5e0bf51582db051dc78#diff-dfb232b43530f0961894e09a0d862aa4R1048\n\nafter commenting out\n\nhttps://github.com/pexpect/pexpect/blob/3.x/pexpect/__init__.py#L1540\n\n\n```\n                #time.sleep(0.0001)\n```\n\n\nperformance changes from\n\n\n```\nsage: sage: %timeit gp.eval('2+3')\n1000 loops, best of 3: 427 \u00b5s per loop\nsage: sage: %timeit gp.eval('2+3')\n1000 loops, best of 3: 449 \u00b5s per loop\n```\n\n\nto this\n\n\n```\nsage: %timeit gp.eval('2+3')\nThe slowest run took 175.25 times longer than the fastest. This could mean that an intermediate result is being cached \n10000 loops, best of 3: 76.3 \u00b5s per loop\nsage: %timeit gp.eval('2+3')\nThe slowest run took 7.85 times longer than the fastest. This could mean that an intermediate result is being cached \n10000 loops, best of 3: 76.4 \u00b5s per loop\n```\n",
    "created_at": "2015-05-11T05:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105167",
    "user": "bpage"
}
```

Apparently the performance problem originates with this old commit:

https://github.com/pexpect/pexpect/commit/600463686284ea102548f5e0bf51582db051dc78#diff-dfb232b43530f0961894e09a0d862aa4R1048

after commenting out

https://github.com/pexpect/pexpect/blob/3.x/pexpect/__init__.py#L1540


```
                #time.sleep(0.0001)
```


performance changes from


```
sage: sage: %timeit gp.eval('2+3')
1000 loops, best of 3: 427 µs per loop
sage: sage: %timeit gp.eval('2+3')
1000 loops, best of 3: 449 µs per loop
```


to this


```
sage: %timeit gp.eval('2+3')
The slowest run took 175.25 times longer than the fastest. This could mean that an intermediate result is being cached 
10000 loops, best of 3: 76.3 µs per loop
sage: %timeit gp.eval('2+3')
The slowest run took 7.85 times longer than the fastest. This could mean that an intermediate result is being cached 
10000 loops, best of 3: 76.4 µs per loop
```




---

archive/issue_comments_105168.json:
```json
{
    "body": "Excellent job! Do we have contact upstream to see if this is really needed or could be made optional?",
    "created_at": "2015-05-11T05:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105168",
    "user": "@kiwifb"
}
```

Excellent job! Do we have contact upstream to see if this is really needed or could be made optional?



---

archive/issue_comments_105169.json:
```json
{
    "body": "Alternative to patching pexpect, we can just replace pieces of pexpect that we don't like with custom Python or Cython code (I do this in #17686 for exiting programs).",
    "created_at": "2015-05-11T06:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105169",
    "user": "@jdemeyer"
}
```

Alternative to patching pexpect, we can just replace pieces of pexpect that we don't like with custom Python or Cython code (I do this in #17686 for exiting programs).



---

archive/issue_comments_105170.json:
```json
{
    "body": "Replying to [comment:33 was]:\n> No, this is definitely not acceptable.  For real work it could easily mean people's programs are 4 times slower due to this upgrade.\n\nIndeed. I am even using a patched version of my department's linux distribution, since otherwise the latency (of pseudo-TTY, which slows down pexpect) makes my group cohomology spkg practically unusable.",
    "created_at": "2015-05-11T06:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105170",
    "user": "@simon-king-jena"
}
```

Replying to [comment:33 was]:
> No, this is definitely not acceptable.  For real work it could easily mean people's programs are 4 times slower due to this upgrade.

Indeed. I am even using a patched version of my department's linux distribution, since otherwise the latency (of pseudo-TTY, which slows down pexpect) makes my group cohomology spkg practically unusable.



---

archive/issue_comments_105171.json:
```json
{
    "body": "Replying to [comment:39 jdemeyer]:\n> Alternative to patching pexpect, we can just replace pieces of pexpect that we don't like with custom Python or Cython code (I do this in #17686 for exiting programs).\n\nThat's interesting if we can do it in a systematic way. I wouldn't mind getting rid of most pexpect interface with the exception of the notebook (which may be harder).",
    "created_at": "2015-05-11T07:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105171",
    "user": "@kiwifb"
}
```

Replying to [comment:39 jdemeyer]:
> Alternative to patching pexpect, we can just replace pieces of pexpect that we don't like with custom Python or Cython code (I do this in #17686 for exiting programs).

That's interesting if we can do it in a systematic way. I wouldn't mind getting rid of most pexpect interface with the exception of the notebook (which may be harder).



---

archive/issue_comments_105172.json:
```json
{
    "body": "Replying to [comment:41 fbissey]:\n> That's interesting if we can do it in a systematic way. I wouldn't mind getting rid of most pexpect interface with the exception of the notebook (which may be harder).\n\nI don't mean to stop using pexpect interfaces. I mean replacing parts of pexpect itself: the main pexpect code is in one Python class `spawn` and we can monkey-patch that by subclassing that and changing methods as we please.\n\nSince pexpect uses some low-level OS stuff, implementing the critical parts in Cython might also give significant speed gain (I haven't tested this yet, but surely calling `os.foo()` in Python and playing with strings will be slower than directly calling the `foo()` system call from Cython).",
    "created_at": "2015-05-11T07:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105172",
    "user": "@jdemeyer"
}
```

Replying to [comment:41 fbissey]:
> That's interesting if we can do it in a systematic way. I wouldn't mind getting rid of most pexpect interface with the exception of the notebook (which may be harder).

I don't mean to stop using pexpect interfaces. I mean replacing parts of pexpect itself: the main pexpect code is in one Python class `spawn` and we can monkey-patch that by subclassing that and changing methods as we please.

Since pexpect uses some low-level OS stuff, implementing the critical parts in Cython might also give significant speed gain (I haven't tested this yet, but surely calling `os.foo()` in Python and playing with strings will be slower than directly calling the `foo()` system call from Cython).



---

archive/issue_comments_105173.json:
```json
{
    "body": "Replying to [comment:37 bpage]:\n> Apparently the performance problem originates with this old commit:\n> \n> https://github.com/pexpect/pexpect/commit/600463686284ea102548f5e0bf51582db051dc78#diff-dfb232b43530f0961894e09a0d862aa4R1048\n> \n> after commenting out\n> \n> https://github.com/pexpect/pexpect/blob/3.x/pexpect/__init__.py#L1540\n> \n> {{{\n>                 #time.sleep(0.0001)\n> }}}\n\nHahaha, I was going to grab 2.1 and investigate the changes compared to 2.0.  (Didn't realize the full history was kept.)\n\n\nOf course continually polling without delay isn't nice either; it will significantly increase the CPU load.",
    "created_at": "2015-05-11T09:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105173",
    "user": "@nexttime"
}
```

Replying to [comment:37 bpage]:
> Apparently the performance problem originates with this old commit:
> 
> https://github.com/pexpect/pexpect/commit/600463686284ea102548f5e0bf51582db051dc78#diff-dfb232b43530f0961894e09a0d862aa4R1048
> 
> after commenting out
> 
> https://github.com/pexpect/pexpect/blob/3.x/pexpect/__init__.py#L1540
> 
> {{{
>                 #time.sleep(0.0001)
> }}}

Hahaha, I was going to grab 2.1 and investigate the changes compared to 2.0.  (Didn't realize the full history was kept.)


Of course continually polling without delay isn't nice either; it will significantly increase the CPU load.



---

archive/issue_comments_105174.json:
```json
{
    "body": "Replying to [comment:43 leif]:\n> Replying to [comment:37 bpage]:\n> > Apparently the performance problem originates with this old commit:\n> > \n> > https://github.com/pexpect/pexpect/commit/600463686284ea102548f5e0bf51582db051dc78#diff-dfb232b43530f0961894e09a0d862aa4R1048\n> > \n> > after commenting out\n> > \n> > https://github.com/pexpect/pexpect/blob/3.x/pexpect/__init__.py#L1540\n> > \n> > {{{\n> >                 #time.sleep(0.0001)\n> > }}}\n> \n> Hahaha, I was going to grab 2.1 and investigate the changes compared to 2.0.  (Didn't realize the full history was kept.)\n> \n> \n> Of course continually polling without delay isn't nice either; it will significantly increase the CPU load.\n\nWill it? After all unless there are quite a number of other changes, it is the current situation with 2.0, isn't it? Upgrading without patching would decrease the CPU load if I am not mistaken.\n\n\nAnyway, I like Jeroen's idea but we will need to upgrade pexpect in any case. I am all in favour of upgrading now with a patch and working on some cythonized elements for pexpect in a follow up ticket. We could remove the patch when we have something satisfactory in place.",
    "created_at": "2015-05-11T09:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105174",
    "user": "@kiwifb"
}
```

Replying to [comment:43 leif]:
> Replying to [comment:37 bpage]:
> > Apparently the performance problem originates with this old commit:
> > 
> > https://github.com/pexpect/pexpect/commit/600463686284ea102548f5e0bf51582db051dc78#diff-dfb232b43530f0961894e09a0d862aa4R1048
> > 
> > after commenting out
> > 
> > https://github.com/pexpect/pexpect/blob/3.x/pexpect/__init__.py#L1540
> > 
> > {{{
> >                 #time.sleep(0.0001)
> > }}}
> 
> Hahaha, I was going to grab 2.1 and investigate the changes compared to 2.0.  (Didn't realize the full history was kept.)
> 
> 
> Of course continually polling without delay isn't nice either; it will significantly increase the CPU load.

Will it? After all unless there are quite a number of other changes, it is the current situation with 2.0, isn't it? Upgrading without patching would decrease the CPU load if I am not mistaken.


Anyway, I like Jeroen's idea but we will need to upgrade pexpect in any case. I am all in favour of upgrading now with a patch and working on some cythonized elements for pexpect in a follow up ticket. We could remove the patch when we have something satisfactory in place.



---

archive/issue_comments_105175.json:
```json
{
    "body": "Replying to [comment:44 fbissey]:\n> Replying to [comment:43 leif]:\n> > Of course continually polling without delay isn't nice either; it will significantly increase the CPU load.\n> \n> Will it?\n\n[http://en.wikipedia.org/wiki/Busy_waiting](http://en.wikipedia.org/wiki/Busy_waiting).\n\nI'll have to look closer at the code.  Haven't tested yet, but I guess it'll get worse the longer the net computation in the subprocess takes; the examples above only do short toy computations and don't take the overall CPU time into account.  (It may lead to effectively doubling `SAGE_NUM_THREADS` in ptestlong.)\n \n> After all unless there are quite a number of other changes, it is the current situation with 2.0, isn't it? Upgrading without patching would decrease the CPU load if I am not mistaken.\n\nProbably.  In fact, for me ptestlong with 3.3 (unpatched) went faster than with 2.0, although only slightly, under the same conditions (constant low load).  (But in both cases I had some process apparently still waiting for Singular after all other tests had already finished, so the wall time got messed up a bit.)\n\nBut I'm ok with first upgrading here and removing the `sleep`, then checking what else we could tweak on another ticket.\n \n> Anyway, I like Jeroen's idea but we will need to upgrade pexpect in any case. I am all in favour of upgrading now with a patch and working on some cythonized elements for pexpect in a follow up ticket. We could remove the patch when we have something satisfactory in place.\n\nSubclassing, probably with individual changes for different interfaces or dynamically changing parameters is the way to go I think.\n\nWhile we could perhaps do some parts in Cython, leaving Python of course puts more burden of portablility on us, depending on what exactly we do.",
    "created_at": "2015-05-11T12:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105175",
    "user": "@nexttime"
}
```

Replying to [comment:44 fbissey]:
> Replying to [comment:43 leif]:
> > Of course continually polling without delay isn't nice either; it will significantly increase the CPU load.
> 
> Will it?

[http://en.wikipedia.org/wiki/Busy_waiting](http://en.wikipedia.org/wiki/Busy_waiting).

I'll have to look closer at the code.  Haven't tested yet, but I guess it'll get worse the longer the net computation in the subprocess takes; the examples above only do short toy computations and don't take the overall CPU time into account.  (It may lead to effectively doubling `SAGE_NUM_THREADS` in ptestlong.)
 
> After all unless there are quite a number of other changes, it is the current situation with 2.0, isn't it? Upgrading without patching would decrease the CPU load if I am not mistaken.

Probably.  In fact, for me ptestlong with 3.3 (unpatched) went faster than with 2.0, although only slightly, under the same conditions (constant low load).  (But in both cases I had some process apparently still waiting for Singular after all other tests had already finished, so the wall time got messed up a bit.)

But I'm ok with first upgrading here and removing the `sleep`, then checking what else we could tweak on another ticket.
 
> Anyway, I like Jeroen's idea but we will need to upgrade pexpect in any case. I am all in favour of upgrading now with a patch and working on some cythonized elements for pexpect in a follow up ticket. We could remove the patch when we have something satisfactory in place.

Subclassing, probably with individual changes for different interfaces or dynamically changing parameters is the way to go I think.

While we could perhaps do some parts in Cython, leaving Python of course puts more burden of portablility on us, depending on what exactly we do.



---

archive/issue_comments_105176.json:
```json
{
    "body": "Perhaps proposing an upstream patch to provide an optional parameter such as\n\n\n```\nexpect(prompt,yield=false)\n```\n\n\nto optionally avoid the call to sleep would be a good idea?  Apparently there are situations such as the way that Sage uses gap where busy waiting is a good thing.  Meanwhile in Python 3.x there is asyncio and pexpect 3.x already supports that.",
    "created_at": "2015-05-11T14:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105176",
    "user": "bpage"
}
```

Perhaps proposing an upstream patch to provide an optional parameter such as


```
expect(prompt,yield=false)
```


to optionally avoid the call to sleep would be a good idea?  Apparently there are situations such as the way that Sage uses gap where busy waiting is a good thing.  Meanwhile in Python 3.x there is asyncio and pexpect 3.x already supports that.



---

archive/issue_comments_105177.json:
```json
{
    "body": "Based on\nhttp://stackoverflow.com/questions/7273474/behavior-of-pythons-time-sleep0-under-linux-does-it-cause-a-context-switch\n\nI tried\n\n\n```\n                time.sleep(0)\n```\n\n\nin *pexpect/__init__.py* and the result on my linux system remains fast (78.9 \u00b5s per loop).  In principle the use of *sleep(0)* should allow scheduling on all systems but it might be a good idea for someone with a MAC to try this on OSX.\n\nThe pexpect people might accept a patch to change this to 0.",
    "created_at": "2015-05-11T16:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105177",
    "user": "bpage"
}
```

Based on
http://stackoverflow.com/questions/7273474/behavior-of-pythons-time-sleep0-under-linux-does-it-cause-a-context-switch

I tried


```
                time.sleep(0)
```


in *pexpect/__init__.py* and the result on my linux system remains fast (78.9 µs per loop).  In principle the use of *sleep(0)* should allow scheduling on all systems but it might be a good idea for someone with a MAC to try this on OSX.

The pexpect people might accept a patch to change this to 0.



---

archive/issue_comments_105178.json:
```json
{
    "body": "Why do you think it's busy waiting? It looks like it's reading with a timeout, which is not busy waiting.",
    "created_at": "2015-05-11T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105178",
    "user": "@jdemeyer"
}
```

Why do you think it's busy waiting? It looks like it's reading with a timeout, which is not busy waiting.



---

archive/issue_comments_105179.json:
```json
{
    "body": "Replying to [comment:47 bpage]:\n> The pexpect people might accept a patch to change this to 0.\n\nWell, rather the delay should be configurable.\n\nBut the whole `expect_loop()` and `read_nonblocking()` look pretty messy.  We should perhaps simply overwrite one or both with a version that fits our needs.  The whole class certainly isn't written for performance.\n\n\nNote that the behaviour also depends on the writer (i.e., the subprocess); ECL for example is extremely poor in that it doesn't write strings, but really character by character, such that in the worst case we here would end up with at least `len(s)` * 0.1 ms (and at least len(s) context switches, not including the system calls themselves, where pexpect doesn't only call `select()` and probably `read()`, but also `waitpid()` because of the `isalive()` checks).",
    "created_at": "2015-05-11T16:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105179",
    "user": "@nexttime"
}
```

Replying to [comment:47 bpage]:
> The pexpect people might accept a patch to change this to 0.

Well, rather the delay should be configurable.

But the whole `expect_loop()` and `read_nonblocking()` look pretty messy.  We should perhaps simply overwrite one or both with a version that fits our needs.  The whole class certainly isn't written for performance.


Note that the behaviour also depends on the writer (i.e., the subprocess); ECL for example is extremely poor in that it doesn't write strings, but really character by character, such that in the worst case we here would end up with at least `len(s)` * 0.1 ms (and at least len(s) context switches, not including the system calls themselves, where pexpect doesn't only call `select()` and probably `read()`, but also `waitpid()` because of the `isalive()` checks).



---

archive/issue_comments_105180.json:
```json
{
    "body": "`@`jdemeye Yes I see, so I wonder why they need *time.sleep* at all?  I am back to asking them to just remove it. But if they prefer a patch with a configurable sleep time then why not?\n\n`@`leif Re: rewriting the loop.  For sure if you have the time but I think the priority should be to get pexpect updated soonest.",
    "created_at": "2015-05-11T17:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105180",
    "user": "bpage"
}
```

`@`jdemeye Yes I see, so I wonder why they need *time.sleep* at all?  I am back to asking them to just remove it. But if they prefer a patch with a configurable sleep time then why not?

`@`leif Re: rewriting the loop.  For sure if you have the time but I think the priority should be to get pexpect updated soonest.



---

archive/issue_comments_105181.json:
```json
{
    "body": "Replying to [comment:48 jdemeyer]:\n> Why do you think it's busy waiting? It looks like it's reading with a timeout, which is not busy waiting.\n\nUnless the timeout is `None`, it *is* busy waiting.\n\nWith a larger timeout, it gets less worse, but is still busy waiting.",
    "created_at": "2015-05-11T17:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105181",
    "user": "@nexttime"
}
```

Replying to [comment:48 jdemeyer]:
> Why do you think it's busy waiting? It looks like it's reading with a timeout, which is not busy waiting.

Unless the timeout is `None`, it *is* busy waiting.

With a larger timeout, it gets less worse, but is still busy waiting.



---

archive/issue_comments_105182.json:
```json
{
    "body": "Replying to [comment:50 bpage]:\n> `@`leif Re: rewriting the loop.  For sure if you have the time but I think the priority should be to get pexpect updated soonest.\n\nOf course on a follow-up, as I said before.\n\n`sleep(0)` shouldn't be necessary because of the (many!) system calls in the loop.",
    "created_at": "2015-05-11T17:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105182",
    "user": "@nexttime"
}
```

Replying to [comment:50 bpage]:
> `@`leif Re: rewriting the loop.  For sure if you have the time but I think the priority should be to get pexpect updated soonest.

Of course on a follow-up, as I said before.

`sleep(0)` shouldn't be necessary because of the (many!) system calls in the loop.



---

archive/issue_comments_105183.json:
```json
{
    "body": "https://github.com/pexpect/pexpect/issues/215",
    "created_at": "2015-05-11T17:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105183",
    "user": "bpage"
}
```

https://github.com/pexpect/pexpect/issues/215



---

archive/issue_comments_105184.json:
```json
{
    "body": "Replying to [comment:53 bpage]:\n> https://github.com/pexpect/pexpect/issues/215\n\nThank you for linking back... B)\n\n(Hope the guys don't get my address.)",
    "created_at": "2015-05-11T17:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105184",
    "user": "@nexttime"
}
```

Replying to [comment:53 bpage]:
> https://github.com/pexpect/pexpect/issues/215

Thank you for linking back... B)

(Hope the guys don't get my address.)



---

archive/issue_comments_105185.json:
```json
{
    "body": "Replying to [comment:51 leif]:\n> Replying to [comment:48 jdemeyer]:\n> > Why do you think it's busy waiting? It looks like it's reading with a timeout, which is not busy waiting.\n> \n> Unless the timeout is `None`, it *is* busy waiting.\n> \n> With a larger timeout, it gets less worse, but is still busy waiting.\n\nOk, it's not as bad as I first thought, since the loop is exited upon the first timeout (which is on the *total* time spent in `expect_loop()`, but also used in `select()`).  So it depends on what happens in the application upon timeout, and the timeout chosen.",
    "created_at": "2015-05-11T21:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105185",
    "user": "@nexttime"
}
```

Replying to [comment:51 leif]:
> Replying to [comment:48 jdemeyer]:
> > Why do you think it's busy waiting? It looks like it's reading with a timeout, which is not busy waiting.
> 
> Unless the timeout is `None`, it *is* busy waiting.
> 
> With a larger timeout, it gets less worse, but is still busy waiting.

Ok, it's not as bad as I first thought, since the loop is exited upon the first timeout (which is on the *total* time spent in `expect_loop()`, but also used in `select()`).  So it depends on what happens in the application upon timeout, and the timeout chosen.



---

archive/issue_comments_105186.json:
```json
{
    "body": "It would be good if upstream were accepting one of the possible changes.\n\n`@`Bill I see you have made a pull request can you tell us the results from travis when you have them? If it passes the tests I'll update the branch.",
    "created_at": "2015-05-12T03:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105186",
    "user": "@kiwifb"
}
```

It would be good if upstream were accepting one of the possible changes.

`@`Bill I see you have made a pull request can you tell us the results from travis when you have them? If it passes the tests I'll update the branch.



---

archive/issue_comments_105187.json:
```json
{
    "body": "Hum.... I don't see much improvement by applying that patch at all.\n\n```\nsage: %time gp.eval('2+3')\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 24 ms\n'5'\n```\n\nNote that while William says there shouldn't be a cache there is definitely one\n\n```\nsage: %time gp.eval('2+3')\nCPU times: user 0 ns, sys: 20 ms, total: 20 ms\nWall time: 23.4 ms\n'5'\nsage: %time gp.eval('2+3')\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 309 us\n'5'\n```\n",
    "created_at": "2015-05-12T03:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105187",
    "user": "@kiwifb"
}
```

Hum.... I don't see much improvement by applying that patch at all.

```
sage: %time gp.eval('2+3')
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 24 ms
'5'
```

Note that while William says there shouldn't be a cache there is definitely one

```
sage: %time gp.eval('2+3')
CPU times: user 0 ns, sys: 20 ms, total: 20 ms
Wall time: 23.4 ms
'5'
sage: %time gp.eval('2+3')
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 309 us
'5'
```




---

archive/issue_comments_105188.json:
```json
{
    "body": "Replying to [comment:57 fbissey]:\n> Note that while William says there shouldn't be a cache there is definitely one\n> {{{\n> sage: %time gp.eval('2+3')\n> CPU times: user 0 ns, sys: 20 ms, total: 20 ms\n> Wall time: 23.4 ms\n> '5'\n> sage: %time gp.eval('2+3')\n> CPU times: user 0 ns, sys: 0 ns, total: 0 ns\n> Wall time: 309 us\n> '5'\n> }}}\nIsn't that just the overhead of starting up the process the first time you run it? If I subsequently send other strings to `gp`, such as `gp.eval('3+4')`, I get similar times. That's not consistent with caching.",
    "created_at": "2015-05-12T05:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105188",
    "user": "@nbruin"
}
```

Replying to [comment:57 fbissey]:
> Note that while William says there shouldn't be a cache there is definitely one
> {{{
> sage: %time gp.eval('2+3')
> CPU times: user 0 ns, sys: 20 ms, total: 20 ms
> Wall time: 23.4 ms
> '5'
> sage: %time gp.eval('2+3')
> CPU times: user 0 ns, sys: 0 ns, total: 0 ns
> Wall time: 309 us
> '5'
> }}}
Isn't that just the overhead of starting up the process the first time you run it? If I subsequently send other strings to `gp`, such as `gp.eval('3+4')`, I get similar times. That's not consistent with caching.



---

archive/issue_comments_105189.json:
```json
{
    "body": "I hadn't thought of that. But then the figure for the first run with pexpect 2.0 is in us while it is ms for 3.3. So there is quite a gap for that. May be I will need to recheck the timing for 2.0. \n\n`timeit` is definitely in the same ballpark for 2.0 (94.4 us) and 3.3 (99.7 us) so you are probably right.",
    "created_at": "2015-05-12T06:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105189",
    "user": "@kiwifb"
}
```

I hadn't thought of that. But then the figure for the first run with pexpect 2.0 is in us while it is ms for 3.3. So there is quite a gap for that. May be I will need to recheck the timing for 2.0. 

`timeit` is definitely in the same ballpark for 2.0 (94.4 us) and 3.3 (99.7 us) so you are probably right.



---

archive/issue_comments_105190.json:
```json
{
    "body": "For info: upgrading pexpect might also solve another issue we are having when running Sage's doctests within a docker container. See comment by olliewalsh on:\n \nhttps://github.com/docker/docker/issues/12277\n\n`@`Vincent.Neri: using this branch might be the easiest way to try out a recent version of pexpect and experiment with olliewalsh's suggestion",
    "created_at": "2015-05-12T07:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105190",
    "user": "@nthiery"
}
```

For info: upgrading pexpect might also solve another issue we are having when running Sage's doctests within a docker container. See comment by olliewalsh on:
 
https://github.com/docker/docker/issues/12277

`@`Vincent.Neri: using this branch might be the easiest way to try out a recent version of pexpect and experiment with olliewalsh's suggestion



---

archive/issue_comments_105191.json:
```json
{
    "body": "Replying to [comment:56 fbissey]:\n> It would be good if upstream were accepting one of the possible changes.\n> \n> `@`Bill I see you have made a pull request can you tell us the results from travis when you have them? If it passes the tests I'll update the branch.\n\nhttps://github.com/pexpect/pexpect/pull/216\n\nI am not sure if the \"ci/teamcity\" result is real.  Could someone with more experience with this ci stuff take a look?",
    "created_at": "2015-05-12T11:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105191",
    "user": "bpage"
}
```

Replying to [comment:56 fbissey]:
> It would be good if upstream were accepting one of the possible changes.
> 
> `@`Bill I see you have made a pull request can you tell us the results from travis when you have them? If it passes the tests I'll update the branch.

https://github.com/pexpect/pexpect/pull/216

I am not sure if the "ci/teamcity" result is real.  Could someone with more experience with this ci stuff take a look?



---

archive/issue_comments_105192.json:
```json
{
    "body": "It looks like a misconfiguration rather than a fault in pexpect but I couldn't affirm it 100%.",
    "created_at": "2015-05-12T12:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105192",
    "user": "@kiwifb"
}
```

It looks like a misconfiguration rather than a fault in pexpect but I couldn't affirm it 100%.



---

archive/issue_comments_105193.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-13T11:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105193",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105194.json:
```json
{
    "body": "The failing test upstream for python3.3 is a bit annoying but I am pushing the patch anyway as we are only concerned with python2.7 and 3.4.x (or even 3.5) in the future. It looks like we may have to get ready to shift target to pexpect 4.0 if they solve their last issue for a release.",
    "created_at": "2015-05-13T11:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105194",
    "user": "@kiwifb"
}
```

The failing test upstream for python3.3 is a bit annoying but I am pushing the patch anyway as we are only concerned with python2.7 and 3.4.x (or even 3.5) in the future. It looks like we may have to get ready to shift target to pexpect 4.0 if they solve their last issue for a release.



---

archive/issue_comments_105195.json:
```json
{
    "body": "We'll also need a new release of sagenb or patch it, getting it done may be fun...",
    "created_at": "2015-05-13T11:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105195",
    "user": "@kiwifb"
}
```

We'll also need a new release of sagenb or patch it, getting it done may be fun...



---

archive/issue_comments_105196.json:
```json
{
    "body": "Note that we can also re-implement the slow/broken parts in the Cython front-end `sage/interfaces/sagespawn.pyx`. Doing that for `expect_loop()` and `read_nonblocking()` might be worth it.",
    "created_at": "2015-06-23T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105196",
    "user": "@jdemeyer"
}
```

Note that we can also re-implement the slow/broken parts in the Cython front-end `sage/interfaces/sagespawn.pyx`. Doing that for `expect_loop()` and `read_nonblocking()` might be worth it.



---

archive/issue_comments_105197.json:
```json
{
    "body": "What advantage can we gain from using Cython to re-implement? I think it might be better to propose a different upstream patch, something like:\n\n   time.sleep(self.maxSleep)\n\nwhere maxSleep corresponds to a new optional parameter that defaults to 0.0001 for backward compatibility but which we can set to 0 in `expect.py`.  I have tested `time.sleep(0)` and it seems to have the same end effect in Sage as commenting it out (and the same failures upstream).  Given that they have apparently used similar strategies in the past, by making it optional I think we can expect upstream to agree to the change and that it would be incorporated into future versions of pexpect with no impact on Sage maintenance.",
    "created_at": "2015-06-23T16:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105197",
    "user": "bpage"
}
```

What advantage can we gain from using Cython to re-implement? I think it might be better to propose a different upstream patch, something like:

   time.sleep(self.maxSleep)

where maxSleep corresponds to a new optional parameter that defaults to 0.0001 for backward compatibility but which we can set to 0 in `expect.py`.  I have tested `time.sleep(0)` and it seems to have the same end effect in Sage as commenting it out (and the same failures upstream).  Given that they have apparently used similar strategies in the past, by making it optional I think we can expect upstream to agree to the change and that it would be incorporated into future versions of pexpect with no impact on Sage maintenance.



---

archive/issue_comments_105198.json:
```json
{
    "body": "Replying to [comment:67 bpage]:\n> What advantage can we gain from using Cython to re-implement?\nI wasn't specifically talking about the `sleep(0.0001)` issue, it was just a general comment.\n\nWe could\n1. Directly call system calls instead of using `os.foo()`, leading to better performance and better reliability, especially w.r.t. interrupts.\n2. Use C strings instead of Python strings for performance.\n3. More generally change/add functionality without depending on upstream.",
    "created_at": "2015-06-23T17:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105198",
    "user": "@jdemeyer"
}
```

Replying to [comment:67 bpage]:
> What advantage can we gain from using Cython to re-implement?
I wasn't specifically talking about the `sleep(0.0001)` issue, it was just a general comment.

We could
1. Directly call system calls instead of using `os.foo()`, leading to better performance and better reliability, especially w.r.t. interrupts.
2. Use C strings instead of Python strings for performance.
3. More generally change/add functionality without depending on upstream.



---

archive/issue_comments_105199.json:
```json
{
    "body": "Is there significant overhead calling `os.foo`?  By \"w.r.t. interrupts\" are you referring to the so called Python GIL that makes most things like this single-threaded? Would that mean that we would have to be careful to avoid mixing `os.foo` calls and direct system calls? I understand that this changes significantly in Python 3.  `pexpect 3.x` and `4.x` support some new asynchronous modes for i/o processing in Python 3 that might be of interest.\n\nI am sceptical that performance is significantly limited by string matching. I think this might only be the case if it is necessary to locate prompts within very large \"before\" buffers - something that does not happen frequently in the way that Sage calls external programs and when it does, performance may not be a priority.  Do you have any examples where this would be of benefit?\n\nIf the goal is to change/add functionality without depending on upstream perhaps the best choice would be to re-write `pexpect` entirely in cython, e.g. `cexpect`.  But it worries me every time the choice is made to re-invent things in Sage.",
    "created_at": "2015-06-23T17:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105199",
    "user": "bpage"
}
```

Is there significant overhead calling `os.foo`?  By "w.r.t. interrupts" are you referring to the so called Python GIL that makes most things like this single-threaded? Would that mean that we would have to be careful to avoid mixing `os.foo` calls and direct system calls? I understand that this changes significantly in Python 3.  `pexpect 3.x` and `4.x` support some new asynchronous modes for i/o processing in Python 3 that might be of interest.

I am sceptical that performance is significantly limited by string matching. I think this might only be the case if it is necessary to locate prompts within very large "before" buffers - something that does not happen frequently in the way that Sage calls external programs and when it does, performance may not be a priority.  Do you have any examples where this would be of benefit?

If the goal is to change/add functionality without depending on upstream perhaps the best choice would be to re-write `pexpect` entirely in cython, e.g. `cexpect`.  But it worries me every time the choice is made to re-invent things in Sage.



---

archive/issue_comments_105200.json:
```json
{
    "body": "Replying to [comment:69 bpage]:\n> Is there significant overhead calling `os.foo`?\nNo idea, I haven't profiled anything. Most likely there is not a large overhead.\n\n> By \"w.r.t. interrupts\" are you referring to the so called Python GIL that makes most things like this single-threaded?\nNo, but that could actually be a 4th point on my list above.\n\n> Would that mean that we would have to be careful to avoid mixing `os.foo` calls and direct system calls?\nNo, there is no such problem.\n\n> I understand that this changes significantly in Python 3.\nI have no idea what changes in Python 3 for system calls.\n\n> I am sceptical that performance is significantly limited by string matching. I think this might only be the case if it is necessary to locate prompts within very large \"before\" buffers - something that does not happen frequently in the way that Sage calls external programs and when it does, performance may not be a priority.  Do you have any examples where this would be of benefit?\nIt happens a lot in practice: it happens when a `pexpect` process has a large output (which is then followed by a prompt). See the last example of [comment:30]\n\n> If the goal is to change/add functionality without depending on upstream perhaps the best choice would be to re-write `pexpect` entirely in cython, e.g. `cexpect`.\nI don't really want to fork completely `pexpect`. It might be sufficient to change only `expect` and `read_nonblocking`.",
    "created_at": "2015-06-23T17:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105200",
    "user": "@jdemeyer"
}
```

Replying to [comment:69 bpage]:
> Is there significant overhead calling `os.foo`?
No idea, I haven't profiled anything. Most likely there is not a large overhead.

> By "w.r.t. interrupts" are you referring to the so called Python GIL that makes most things like this single-threaded?
No, but that could actually be a 4th point on my list above.

> Would that mean that we would have to be careful to avoid mixing `os.foo` calls and direct system calls?
No, there is no such problem.

> I understand that this changes significantly in Python 3.
I have no idea what changes in Python 3 for system calls.

> I am sceptical that performance is significantly limited by string matching. I think this might only be the case if it is necessary to locate prompts within very large "before" buffers - something that does not happen frequently in the way that Sage calls external programs and when it does, performance may not be a priority.  Do you have any examples where this would be of benefit?
It happens a lot in practice: it happens when a `pexpect` process has a large output (which is then followed by a prompt). See the last example of [comment:30]

> If the goal is to change/add functionality without depending on upstream perhaps the best choice would be to re-write `pexpect` entirely in cython, e.g. `cexpect`.
I don't really want to fork completely `pexpect`. It might be sufficient to change only `expect` and `read_nonblocking`.



---

archive/issue_comments_105201.json:
```json
{
    "body": "Replying to [comment:69 bpage]:\n> By \"w.r.t. interrupts\" are you referring to the so called Python GIL that makes most things like this single-threaded?\nNo, with \"interrupts\" I am talking about CTRL-C, a.k.a. `KeyboardInterrupt` in Python. The problem is that Python's `os` interface really doesn't deal with those well. Here is the problem:\n\n```\ntry:\n    result = os.read(fd)\nexcept KeyboardInterrupt:\n    # ... ?\n```\n\nThe problem is that, when an interrupt happens, you simply cannot know whether the `read()` call actually succeeded and what the result is (the interrupt could happen while assigned the result for example).\n\nI don't know to what extent this is actually a problem in practice, but it is something that worries me about `pexpect`.\n\nIn Cython, interrupt handling has to be done manually, which means that it can be done in a predictable way.",
    "created_at": "2015-06-23T18:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105201",
    "user": "@jdemeyer"
}
```

Replying to [comment:69 bpage]:
> By "w.r.t. interrupts" are you referring to the so called Python GIL that makes most things like this single-threaded?
No, with "interrupts" I am talking about CTRL-C, a.k.a. `KeyboardInterrupt` in Python. The problem is that Python's `os` interface really doesn't deal with those well. Here is the problem:

```
try:
    result = os.read(fd)
except KeyboardInterrupt:
    # ... ?
```

The problem is that, when an interrupt happens, you simply cannot know whether the `read()` call actually succeeded and what the result is (the interrupt could happen while assigned the result for example).

I don't know to what extent this is actually a problem in practice, but it is something that worries me about `pexpect`.

In Cython, interrupt handling has to be done manually, which means that it can be done in a predictable way.



---

archive/issue_comments_105202.json:
```json
{
    "body": "Replying to [comment:70 jdemeyer]:\n> Replying to [comment:69 bpage]:\n> \n> > I am sceptical that performance is significantly limited by string matching. I think this might only be the case if it is necessary to locate prompts within very large \"before\" buffers - something that does not happen frequently in the way that Sage calls external programs and when it does, performance may not be a priority.  Do you have any examples where this would be of benefit?\n> It happens a lot in practice: it happens when a `pexpect` process has a large output (which is then followed by a prompt). See the last example of [comment:30]\n\nMy point was that I would not expect something like `%timeit s=str(gp.eval('2^10000'))` to be particularly fast.  But maybe it is important to note that `pexpect` already does make an effort to allow faster scanning for prompt if it can be represented as a fixed string rather than a regular expression.\n\n> \n> > If the goal is to change/add functionality without depending on upstream perhaps the best choice would be to re-write `pexpect` entirely in cython, e.g. `cexpect`.\n> I don't really want to fork completely `pexpect`. It might be sufficient to change only `expect` and `read_nonblocking`.\n\nIt seems to me that this is exactly the essential part of `pexpect` on which Sage depends. Most of the rest of `pexpect` is just program interface and portability.",
    "created_at": "2015-06-23T18:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105202",
    "user": "bpage"
}
```

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 bpage]:
> 
> > I am sceptical that performance is significantly limited by string matching. I think this might only be the case if it is necessary to locate prompts within very large "before" buffers - something that does not happen frequently in the way that Sage calls external programs and when it does, performance may not be a priority.  Do you have any examples where this would be of benefit?
> It happens a lot in practice: it happens when a `pexpect` process has a large output (which is then followed by a prompt). See the last example of [comment:30]

My point was that I would not expect something like `%timeit s=str(gp.eval('2^10000'))` to be particularly fast.  But maybe it is important to note that `pexpect` already does make an effort to allow faster scanning for prompt if it can be represented as a fixed string rather than a regular expression.

> 
> > If the goal is to change/add functionality without depending on upstream perhaps the best choice would be to re-write `pexpect` entirely in cython, e.g. `cexpect`.
> I don't really want to fork completely `pexpect`. It might be sufficient to change only `expect` and `read_nonblocking`.

It seems to me that this is exactly the essential part of `pexpect` on which Sage depends. Most of the rest of `pexpect` is just program interface and portability.



---

archive/issue_comments_105203.json:
```json
{
    "body": "See commit to pexpect\n\nhttps://github.com/pexpect/pexpect/commit/40ce421051c0a54f3b3849424491882cf1339801\n\nby Jeff Quast.  Some discussion at\n\nhttps://gitter.im/pexpect/pexpect\n\nThe proposal is to make it possible for Sage to stop bundling an obsolete version of pexpect and to take advantage of recent improvements to pexpect including unicode support and support for Python 3.",
    "created_at": "2015-10-15T00:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105203",
    "user": "bpage"
}
```

See commit to pexpect

https://github.com/pexpect/pexpect/commit/40ce421051c0a54f3b3849424491882cf1339801

by Jeff Quast.  Some discussion at

https://gitter.im/pexpect/pexpect

The proposal is to make it possible for Sage to stop bundling an obsolete version of pexpect and to take advantage of recent improvements to pexpect including unicode support and support for Python 3.



---

archive/issue_comments_105204.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-05T00:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105204",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105205.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-05T00:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105205",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105206.json:
```json
{
    "body": "OK this is to update/test on top of the superfluous-sleep branch of pexpect - this 4.0.1+ hence the `_p1` bit. We may move to an upstream release including this if all goes well.\n\nThe upgrade needs to be matched with a `sagenb` upgrade including matching fixes for the notebook. Sorry to have been this long in preparing this.\n----\nNew commits:",
    "created_at": "2015-11-05T00:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105206",
    "user": "@kiwifb"
}
```

OK this is to update/test on top of the superfluous-sleep branch of pexpect - this 4.0.1+ hence the `_p1` bit. We may move to an upstream release including this if all goes well.

The upgrade needs to be matched with a `sagenb` upgrade including matching fixes for the notebook. Sorry to have been this long in preparing this.
----
New commits:



---

archive/issue_comments_105207.json:
```json
{
    "body": "The matching change to `sagenb` is now https://github.com/sagemath/sagenb/pull/351.",
    "created_at": "2015-11-05T00:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105207",
    "user": "@kiwifb"
}
```

The matching change to `sagenb` is now https://github.com/sagemath/sagenb/pull/351.



---

archive/issue_comments_105208.json:
```json
{
    "body": "Bill, have you tried the new branch and tarball?",
    "created_at": "2015-11-10T01:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105208",
    "user": "@kiwifb"
}
```

Bill, have you tried the new branch and tarball?



---

archive/issue_comments_105209.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-17T20:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105209",
    "user": "@kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_105210.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-11-23T14:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105210",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_105211.json:
```json
{
    "body": "Why the custom tarball? Usually in Sage, we try using an upstream tarball with Sage patches.",
    "created_at": "2015-11-23T14:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105211",
    "user": "@jdemeyer"
}
```

Why the custom tarball? Usually in Sage, we try using an upstream tarball with Sage patches.



---

archive/issue_comments_105212.json:
```json
{
    "body": "If you can give very explicit instructions on how to test these simultaneously I should be okay to try to merge this over Thanksgiving (US).  Do you expect (hah!) any differences between local installations and server ones?",
    "created_at": "2015-11-23T15:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105212",
    "user": "@kcrisman"
}
```

If you can give very explicit instructions on how to test these simultaneously I should be okay to try to merge this over Thanksgiving (US).  Do you expect (hah!) any differences between local installations and server ones?



---

archive/issue_comments_105213.json:
```json
{
    "body": "Replying to [comment:80 jdemeyer]:\n> Why the custom tarball? Usually in Sage, we try using an upstream tarball with Sage patches.\n\nYes and I tried to do it that way. But just taking the latest release and then adding the patch from the commit didn't work. That particular branch was split from master sometimes after the latest release and sticking to `pexpect 4.0.1` means that I was going to have to do some backporting. Because it was not obvious I decided to bit the bullet and ship the branch.",
    "created_at": "2015-11-23T22:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105213",
    "user": "@kiwifb"
}
```

Replying to [comment:80 jdemeyer]:
> Why the custom tarball? Usually in Sage, we try using an upstream tarball with Sage patches.

Yes and I tried to do it that way. But just taking the latest release and then adding the patch from the commit didn't work. That particular branch was split from master sometimes after the latest release and sticking to `pexpect 4.0.1` means that I was going to have to do some backporting. Because it was not obvious I decided to bit the bullet and ship the branch.



---

archive/issue_comments_105214.json:
```json
{
    "body": "I think you should then do either of the following two things:\n\n(A) properly document how the tarball was made: I should be able to follow your instructions and end up with the same files.\n\n(B) add a patch between the branch you want to use and the latest upstream stable release. Then there will be no issues of a patch not applying.",
    "created_at": "2015-11-24T08:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105214",
    "user": "@jdemeyer"
}
```

I think you should then do either of the following two things:

(A) properly document how the tarball was made: I should be able to follow your instructions and end up with the same files.

(B) add a patch between the branch you want to use and the latest upstream stable release. Then there will be no issues of a patch not applying.



---

archive/issue_comments_105215.json:
```json
{
    "body": "Also, fill in your author name.",
    "created_at": "2015-11-24T08:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105215",
    "user": "@jdemeyer"
}
```

Also, fill in your author name.



---

archive/issue_comments_105216.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2015-11-24T08:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105216",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_105217.json:
```json
{
    "body": "Fair enough I put it to review after all. Patch between 4.0.1 and the state of this branch is 50KB :( no wonder the patch from the commit just didn't apply. Anyway all these things are incoming.",
    "created_at": "2015-11-24T09:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105217",
    "user": "@kiwifb"
}
```

Fair enough I put it to review after all. Patch between 4.0.1 and the state of this branch is 50KB :( no wonder the patch from the commit just didn't apply. Anyway all these things are incoming.



---

archive/issue_comments_105218.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-24T09:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105218",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105219.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-24T09:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105219",
    "user": "@kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105220.json:
```json
{
    "body": "If this doesn't make any more progress in the next few days I will probably just revert [this sagenb commit](https://github.com/sagemath/sagenb/commit/ab1f775af96583e5b9db79f53c5f3613f2815894) upstream and release something, then we could have a specific sagenb just for this ticket later.",
    "created_at": "2015-12-01T04:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105220",
    "user": "@kcrisman"
}
```

If this doesn't make any more progress in the next few days I will probably just revert [this sagenb commit](https://github.com/sagemath/sagenb/commit/ab1f775af96583e5b9db79f53c5f3613f2815894) upstream and release something, then we could have a specific sagenb just for this ticket later.



---

archive/issue_comments_105221.json:
```json
{
    "body": "Note that there is a circular dependency with #19616. Can somebody please clarify?",
    "created_at": "2015-12-01T15:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105221",
    "user": "@jdemeyer"
}
```

Note that there is a circular dependency with #19616. Can somebody please clarify?



---

archive/issue_comments_105222.json:
```json
{
    "body": "[fbissey said](https://github.com/sagemath/sagenb/pull/351#issuecomment-157493140) that the packages need to be updated simultaneously; assuming that #19616 ends up including [this commit](https://github.com/sagemath/sagenb/commit/ab1f775af96583e5b9db79f53c5f3613f2815894), then that ticket would be the one.",
    "created_at": "2015-12-01T15:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105222",
    "user": "@kcrisman"
}
```

[fbissey said](https://github.com/sagemath/sagenb/pull/351#issuecomment-157493140) that the packages need to be updated simultaneously; assuming that #19616 ends up including [this commit](https://github.com/sagemath/sagenb/commit/ab1f775af96583e5b9db79f53c5f3613f2815894), then that ticket would be the one.



---

archive/issue_comments_105223.json:
```json
{
    "body": "Sorry to ask the obvious question, but did anybody ever check that Sage even starts with this branch? Because it doesn't for me...\n\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/src/sage-config/src/bin/sage-ipython\", line 10, in <module>\n    from sage.repl.interpreter import SageTerminalApp\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/repl/interpreter.py\", line 218, in <module>\n    from IPython.core.interactiveshell import InteractiveShell\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/__init__.py\", line 47, in <module>\n    from .core.application import Application\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/application.py\", line 24, in <module>\n    from IPython.core import release, crashhandler\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/crashhandler.py\", line 28, in <module>\n    from IPython.core import ultratb\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/ultratb.py\", line 116, in <module>\n    from IPython.utils import path as util_path\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/utils/path.py\", line 19, in <module>\n    from IPython.utils.process import system\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/utils/process.py\", line 19, in <module>\n    from ._process_posix import system, getoutput, arg_split, check_pid\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/utils/_process_posix.py\", line 24, in <module>\n    import pexpect\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/__init__.py\", line 75, in <module>\n    from .pty_spawn import spawn, spawnu\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 11, in <module>\n    import ptyprocess\nImportError: No module named ptyprocess\n```\n",
    "created_at": "2015-12-01T20:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105223",
    "user": "@jdemeyer"
}
```

Sorry to ask the obvious question, but did anybody ever check that Sage even starts with this branch? Because it doesn't for me...


```
Traceback (most recent call last):
  File "/usr/local/src/sage-config/src/bin/sage-ipython", line 10, in <module>
    from sage.repl.interpreter import SageTerminalApp
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/repl/interpreter.py", line 218, in <module>
    from IPython.core.interactiveshell import InteractiveShell
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/__init__.py", line 47, in <module>
    from .core.application import Application
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/application.py", line 24, in <module>
    from IPython.core import release, crashhandler
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/crashhandler.py", line 28, in <module>
    from IPython.core import ultratb
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/ultratb.py", line 116, in <module>
    from IPython.utils import path as util_path
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/utils/path.py", line 19, in <module>
    from IPython.utils.process import system
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/utils/process.py", line 19, in <module>
    from ._process_posix import system, getoutput, arg_split, check_pid
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/utils/_process_posix.py", line 24, in <module>
    import pexpect
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/__init__.py", line 75, in <module>
    from .pty_spawn import spawn, spawnu
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 11, in <module>
    import ptyprocess
ImportError: No module named ptyprocess
```




---

archive/issue_comments_105224.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-01T20:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105224",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105225.json:
```json
{
    "body": "Bother, I didn't notice that this bit was split off. Works brilliantly in sage-on-gentoo. Seriously I was counting on Bill to look it over weeks ago, but he disappeared. I'll be pushing the needed dependencies ASAP.",
    "created_at": "2015-12-01T20:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105225",
    "user": "@kiwifb"
}
```

Bother, I didn't notice that this bit was split off. Works brilliantly in sage-on-gentoo. Seriously I was counting on Bill to look it over weeks ago, but he disappeared. I'll be pushing the needed dependencies ASAP.



---

archive/issue_comments_105226.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-01T20:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105226",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105227.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-12-01T20:49:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105227",
    "user": "@kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105228.json:
```json
{
    "body": "Should work now.",
    "created_at": "2015-12-01T20:49:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105228",
    "user": "@kiwifb"
}
```

Should work now.



---

archive/issue_comments_105229.json:
```json
{
    "body": "I am sorry but I have been focusing on other unrelated things. I am kind of lost and confused about how to test this kind of change in Sage.  What exactly do I need to do? Can I just checkout a branch using git and build Sage? Steps?",
    "created_at": "2015-12-01T20:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105229",
    "user": "bpage"
}
```

I am sorry but I have been focusing on other unrelated things. I am kind of lost and confused about how to test this kind of change in Sage.  What exactly do I need to do? Can I just checkout a branch using git and build Sage? Steps?



---

archive/issue_comments_105230.json:
```json
{
    "body": "Replying to [comment:96 bpage]:\n> Can I just checkout a branch using git and build Sage?\nPrecisely. The easiest way to get access to the Trac branches is using `git-trac`: \nhttp://doc.sagemath.org/html/en/developer/git_trac.html\n\nOnce you have Sage and `git-trac` set up, you should be able to do\n\n```\n$ git trac checkout 10295\n$ make\n```\n",
    "created_at": "2015-12-01T21:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105230",
    "user": "@jdemeyer"
}
```

Replying to [comment:96 bpage]:
> Can I just checkout a branch using git and build Sage?
Precisely. The easiest way to get access to the Trac branches is using `git-trac`: 
http://doc.sagemath.org/html/en/developer/git_trac.html

Once you have Sage and `git-trac` set up, you should be able to do

```
$ git trac checkout 10295
$ make
```




---

archive/issue_comments_105231.json:
```json
{
    "body": "Upstream tarball for `ptyprocess`?",
    "created_at": "2015-12-01T21:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105231",
    "user": "@jdemeyer"
}
```

Upstream tarball for `ptyprocess`?



---

archive/issue_comments_105232.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-12-01T21:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105232",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_105233.json:
```json
{
    "body": "Added.",
    "created_at": "2015-12-01T21:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105233",
    "user": "@kiwifb"
}
```

Added.



---

archive/issue_comments_105234.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-12-01T21:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105234",
    "user": "@kiwifb"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_105235.json:
```json
{
    "body": "Combining the last two topics, I think these are the correct instructions for building Sage: first download the `pexpect` and `ptyprocess` tarballs (as given in the description) and stick them in `SAGE_ROOT/upstream/`. Then do\n\n```\n$ git trac checkout 10295\n$ make\n```\n",
    "created_at": "2015-12-01T21:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105235",
    "user": "@jhpalmieri"
}
```

Combining the last two topics, I think these are the correct instructions for building Sage: first download the `pexpect` and `ptyprocess` tarballs (as given in the description) and stick them in `SAGE_ROOT/upstream/`. Then do

```
$ git trac checkout 10295
$ make
```




---

archive/issue_comments_105236.json:
```json
{
    "body": "OK, at least `ptyprocess` and `pexpect` build now. I'll rebuild Sage from scratch and test it overnight.",
    "created_at": "2015-12-01T21:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105236",
    "user": "@jdemeyer"
}
```

OK, at least `ptyprocess` and `pexpect` build now. I'll rebuild Sage from scratch and test it overnight.



---

archive/issue_comments_105237.json:
```json
{
    "body": "I'm going to have to make a different ticket for this sagenb update than originally anticipated, I think.",
    "created_at": "2015-12-02T02:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105237",
    "user": "@kcrisman"
}
```

I'm going to have to make a different ticket for this sagenb update than originally anticipated, I think.



---

archive/issue_comments_105238.json:
```json
{
    "body": "I get some failures:\n\n```\n----------------------------------------------------------------------\nsage -t --long src/sage/interfaces/gap.py  # 14 doctests failed\nsage -t --long src/sage/interfaces/expect.py  # Timed out\n----------------------------------------------------------------------\n```\n\nFor the first one, there are lots of errors of this sort:\n\n```\nsage -t --long src/sage/interfaces/gap.py\n**********************************************************************\nFile \"src/sage/interfaces/gap.py\", line 717, in sage.interfaces.gap.Gap_generic._eval_line\nFailed example:\n    a\nExpected:\n    3\nGot:\n    ** Gap crashed or quit executing 'Print($sage1);' **\n    Restarting Gap and trying again\n    <repr(<sage.interfaces.gap.GapElement at 0x10cd07870>) failed: RuntimeError: Gap produced error output\n    Error, Variable: '$sage1' must have a value\n    <BLANKLINE>\n       executing Print($sage1);>\n**********************************************************************\nFile \"src/sage/interfaces/gap.py\", line 779, in sage.interfaces.gap.Gap_generic.unbind\nFailed example:\n    gap.set('x', '2')\nExpected nothing\nGot:\n    ** Gap crashed or quit executing 'x:=2;;' **\n    Restarting Gap and trying again\n**********************************************************************\n```\n\nFor the second one, the start of that part of the log looks like this:\n\n```\n**********************************************************************\nFile \"src/sage/interfaces/expect.py\", line 708, in sage.interfaces.expect.Expect._eval_line_using_file\nFailed example:\n    singular('a')\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496\\\n, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858\\\n, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.expect.Expect._eval_line_using_file[4]>\", line 1, in <module>\n        singular('a')\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", lin\\\ne 788, in __call__\n        return SingularElement(self, type, x, False)\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", lin\\\ne 1266, in __init__\n        raise_(TypeError, x, sys.exc_info()[2])\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", lin\\\ne 1261, in __init__\n        self._name = parent._create( value, type)\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", lin\\\ne 749, in _create\n        self.set(type, name, value)\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", lin\\\ne 692, in set\n        self.eval(cmd)\n      File \"/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", lin\\\ne 650, in eval\n        raise SingularError('Singular error:\\n%s'%s)\n    TypeError: Singular error:\n       ? `a` is undefined\n       ? error occurred in or before STDIN line 12: `def sage15=a;`\n**********************************************************************\nFile \"src/sage/interfaces/expect.py\", line 710, in sage.interfaces.expect.Expect._eval_line_using_file\nFailed example:\n    singular.eval('quit;')\nExpected:\n    ''\nGot:\n    Singular crashed -- automatically restarting.\n    ''\n**********************************************************************\nFile \"src/sage/interfaces/expect.py\", line 721, in sage.interfaces.expect.Expect._eval_line_using_file\nFailed example:\n    singular(3)\nExpected:\n    Singular crashed -- automatically restarting.\n    3\nGot:\n    Singular crashed -- automatically restarting.\n    Singular crashed -- automatically restarting.\n    Singular crashed -- automatically restarting.\n    <repr(<sage.interfaces.singular.SingularElement at 0x11ac13fa0>) failed: AttributeError: 'NoneType' object has no attri\\\nbute 'group'>\n**********************************************************************\nFile \"src/sage/interfaces/expect.py\", line 800, in sage.interfaces.expect.Expect._eval_line\nFailed example:\n    singular._eval_line('def a=3;')\nExpected:\n    ''\nGot:\n    Singular crashed -- automatically restarting.\n    ''\n**********************************************************************\n```\n\nThis is on OS X 10.10, Sage built from scratch.",
    "created_at": "2015-12-02T02:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105238",
    "user": "@jhpalmieri"
}
```

I get some failures:

```
----------------------------------------------------------------------
sage -t --long src/sage/interfaces/gap.py  # 14 doctests failed
sage -t --long src/sage/interfaces/expect.py  # Timed out
----------------------------------------------------------------------
```

For the first one, there are lots of errors of this sort:

```
sage -t --long src/sage/interfaces/gap.py
**********************************************************************
File "src/sage/interfaces/gap.py", line 717, in sage.interfaces.gap.Gap_generic._eval_line
Failed example:
    a
Expected:
    3
Got:
    ** Gap crashed or quit executing 'Print($sage1);' **
    Restarting Gap and trying again
    <repr(<sage.interfaces.gap.GapElement at 0x10cd07870>) failed: RuntimeError: Gap produced error output
    Error, Variable: '$sage1' must have a value
    <BLANKLINE>
       executing Print($sage1);>
**********************************************************************
File "src/sage/interfaces/gap.py", line 779, in sage.interfaces.gap.Gap_generic.unbind
Failed example:
    gap.set('x', '2')
Expected nothing
Got:
    ** Gap crashed or quit executing 'x:=2;;' **
    Restarting Gap and trying again
**********************************************************************
```

For the second one, the start of that part of the log looks like this:

```
**********************************************************************
File "src/sage/interfaces/expect.py", line 708, in sage.interfaces.expect.Expect._eval_line_using_file
Failed example:
    singular('a')
Exception raised:
    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496\
, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858\
, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.expect.Expect._eval_line_using_file[4]>", line 1, in <module>
        singular('a')
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py", lin\
e 788, in __call__
        return SingularElement(self, type, x, False)
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py", lin\
e 1266, in __init__
        raise_(TypeError, x, sys.exc_info()[2])
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py", lin\
e 1261, in __init__
        self._name = parent._create( value, type)
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py", lin\
e 749, in _create
        self.set(type, name, value)
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py", lin\
e 692, in set
        self.eval(cmd)
      File "/Users/jpalmier/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/interfaces/singular.py", lin\
e 650, in eval
        raise SingularError('Singular error:\n%s'%s)
    TypeError: Singular error:
       ? `a` is undefined
       ? error occurred in or before STDIN line 12: `def sage15=a;`
**********************************************************************
File "src/sage/interfaces/expect.py", line 710, in sage.interfaces.expect.Expect._eval_line_using_file
Failed example:
    singular.eval('quit;')
Expected:
    ''
Got:
    Singular crashed -- automatically restarting.
    ''
**********************************************************************
File "src/sage/interfaces/expect.py", line 721, in sage.interfaces.expect.Expect._eval_line_using_file
Failed example:
    singular(3)
Expected:
    Singular crashed -- automatically restarting.
    3
Got:
    Singular crashed -- automatically restarting.
    Singular crashed -- automatically restarting.
    Singular crashed -- automatically restarting.
    <repr(<sage.interfaces.singular.SingularElement at 0x11ac13fa0>) failed: AttributeError: 'NoneType' object has no attri\
bute 'group'>
**********************************************************************
File "src/sage/interfaces/expect.py", line 800, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular._eval_line('def a=3;')
Expected:
    ''
Got:
    Singular crashed -- automatically restarting.
    ''
**********************************************************************
```

This is on OS X 10.10, Sage built from scratch.



---

archive/issue_comments_105239.json:
```json
{
    "body": "That is new and I should try a build on OS X 10.11.",
    "created_at": "2015-12-02T03:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105239",
    "user": "@kiwifb"
}
```

That is new and I should try a build on OS X 10.11.



---

archive/issue_comments_105240.json:
```json
{
    "body": "I get similar errors as jhpalmieri.",
    "created_at": "2015-12-02T07:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105240",
    "user": "@jdemeyer"
}
```

I get similar errors as jhpalmieri.



---

archive/issue_comments_105241.json:
```json
{
    "body": "I think I am an idiot. I need to add a bit that's different for this branch than what we had before with `pexpect-3.3`.",
    "created_at": "2015-12-02T07:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105241",
    "user": "@kiwifb"
}
```

I think I am an idiot. I need to add a bit that's different for this branch than what we had before with `pexpect-3.3`.



---

archive/issue_comments_105242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-02T10:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105242",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105243.json:
```json
{
    "body": "The last commit is not sufficient to solve the observed problems but it should be included especially with regards to speed. Still have to find the post `pexpect-4.0.1` change responsible for these.",
    "created_at": "2015-12-02T10:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105243",
    "user": "@kiwifb"
}
```

The last commit is not sufficient to solve the observed problems but it should be included especially with regards to speed. Still have to find the post `pexpect-4.0.1` change responsible for these.



---

archive/issue_comments_105244.json:
```json
{
    "body": "I think it's better to move those changes to the `SageSpawn` class instead (see `src/sage/interfaces/sagespawn.pyx`).",
    "created_at": "2015-12-02T13:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105244",
    "user": "@jdemeyer"
}
```

I think it's better to move those changes to the `SageSpawn` class instead (see `src/sage/interfaces/sagespawn.pyx`).



---

archive/issue_comments_105245.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-12-02T13:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105245",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_105246.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-02T13:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105246",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105247.json:
```json
{
    "body": "I think there is a new problem in `send()`. In certain cases, the following can happen:\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 870, in _eval_line\n    E.sendline(line)\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 529, in sendline\n    n = self.send(s)\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 520, in send\n    return os.write(self.child_fd, b)\nOSError: [Errno 9] Bad file descriptor\n```\n",
    "created_at": "2015-12-02T14:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105247",
    "user": "@jdemeyer"
}
```

I think there is a new problem in `send()`. In certain cases, the following can happen:

```
Traceback (most recent call last):
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 870, in _eval_line
    E.sendline(line)
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 529, in sendline
    n = self.send(s)
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 520, in send
    return os.write(self.child_fd, b)
OSError: [Errno 9] Bad file descriptor
```




---

archive/issue_comments_105248.json:
```json
{
    "body": "Something is closing the file descriptor for the `pty`, but I haven't figured out which thing is doing that.",
    "created_at": "2015-12-02T15:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105248",
    "user": "@jdemeyer"
}
```

Something is closing the file descriptor for the `pty`, but I haven't figured out which thing is doing that.



---

archive/issue_comments_105249.json:
```json
{
    "body": "The file descriptor is closed during garbage collection.",
    "created_at": "2015-12-02T15:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105249",
    "user": "@jdemeyer"
}
```

The file descriptor is closed during garbage collection.



---

archive/issue_comments_105250.json:
```json
{
    "body": "The change causing that is not actually between 4.0.1 and the current patch but in between 3.3 and 4.0.1. Quite a lot of change in there but it sounds like overeager garbage collection.",
    "created_at": "2015-12-02T20:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105250",
    "user": "@kiwifb"
}
```

The change causing that is not actually between 4.0.1 and the current patch but in between 3.3 and 4.0.1. Quite a lot of change in there but it sounds like overeager garbage collection.



---

archive/issue_comments_105251.json:
```json
{
    "body": "Adding `E._keep_alive()` in the `_eval_line` code in `sage/interfaces/expect.py` solves the problem for `expect.py` but not for `gap.py`. Presumably it is abusive and would have to be added in numerous place, and properly ripped afterwards, that doesn't scale.",
    "created_at": "2015-12-03T00:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105251",
    "user": "@kiwifb"
}
```

Adding `E._keep_alive()` in the `_eval_line` code in `sage/interfaces/expect.py` solves the problem for `expect.py` but not for `gap.py`. Presumably it is abusive and would have to be added in numerous place, and properly ripped afterwards, that doesn't scale.



---

archive/issue_comments_105252.json:
```json
{
    "body": "Let me know when you're ready for me to make sagenb 0.11.6 with the one-character change needed...",
    "created_at": "2015-12-03T03:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105252",
    "user": "@kcrisman"
}
```

Let me know when you're ready for me to make sagenb 0.11.6 with the one-character change needed...



---

archive/issue_comments_105253.json:
```json
{
    "body": "I asked upstream for guidance, this is what they have to say so far:\nWhen the `PtyProcess` instance (`self.ptyproc` on a `Pexpect` spawn instance) is garbage collected, it will indeed close the file descriptor. But I don't see how that could have happened when you're still calling `E.sendline()` - clearly there is still a reference to the object, so it shouldn't be garbage collected.\n\nCould something else be closing an fd explicitly? I have run into odd effects before because the numbers representing fds are readily reused. If one fd gets closed while its corresponding 'handle' object (e.g. a `PtyProcess` instance) still exists, when the handle object is garbage collected, it may close an unrelated file which has been opened in the meantime:\n\n\n\n```\nA =  open('foo')\n# handle A with fd=5\nos.close(5)\nB = open('bar')\n# handle A with fd=5\n# handle B with fd=5\ndel A\n# handle A is garbage collected, closing fd 5\nB.read()\n# Bad fd!\n```\n",
    "created_at": "2015-12-03T20:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105253",
    "user": "@kiwifb"
}
```

I asked upstream for guidance, this is what they have to say so far:
When the `PtyProcess` instance (`self.ptyproc` on a `Pexpect` spawn instance) is garbage collected, it will indeed close the file descriptor. But I don't see how that could have happened when you're still calling `E.sendline()` - clearly there is still a reference to the object, so it shouldn't be garbage collected.

Could something else be closing an fd explicitly? I have run into odd effects before because the numbers representing fds are readily reused. If one fd gets closed while its corresponding 'handle' object (e.g. a `PtyProcess` instance) still exists, when the handle object is garbage collected, it may close an unrelated file which has been opened in the meantime:



```
A =  open('foo')
# handle A with fd=5
os.close(5)
B = open('bar')
# handle A with fd=5
# handle B with fd=5
del A
# handle A is garbage collected, closing fd 5
B.read()
# Bad fd!
```




---

archive/issue_comments_105254.json:
```json
{
    "body": "It looks like the stuff crashing is tests added by #10296",
    "created_at": "2015-12-03T21:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105254",
    "user": "@kiwifb"
}
```

It looks like the stuff crashing is tests added by #10296



---

archive/issue_comments_105255.json:
```json
{
    "body": "Replying to [comment:119 fbissey]:\n> Could something else be closing an fd explicitly?\n\nThis is a likely explanation of what is happening. The \"problem\" is that `pexpect` was split up in two independent parts (`pexpect` and `ptyprocess`) and the Sage wrapper `SageSpawn` tries to override the wrong `close()` method.",
    "created_at": "2015-12-04T06:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105255",
    "user": "@jdemeyer"
}
```

Replying to [comment:119 fbissey]:
> Could something else be closing an fd explicitly?

This is a likely explanation of what is happening. The "problem" is that `pexpect` was split up in two independent parts (`pexpect` and `ptyprocess`) and the Sage wrapper `SageSpawn` tries to override the wrong `close()` method.



---

archive/issue_comments_105256.json:
```json
{
    "body": "We need a custom wrapper over `PtyProcess` also.",
    "created_at": "2015-12-04T09:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105256",
    "user": "@jdemeyer"
}
```

We need a custom wrapper over `PtyProcess` also.



---

archive/issue_comments_105257.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-04T10:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105257",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105258.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-12-04T10:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105258",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105259.json:
```json
{
    "body": "The new `pexpect` seems slightly slower at reading large strings:\n\npexpect 2.0:\n\n```\nsage: timeit('str(gp(\"2^2^22\"))', repeat=10)\n5 loops, best of 10: 380 ms per loop\n```\n\n\npexpect 4.0.1:\n\n```\nsage: timeit('str(gp(\"2^2^22\"))', repeat=10)\n5 loops, best of 10: 402 ms per loop\n```\n",
    "created_at": "2015-12-04T11:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105259",
    "user": "@jdemeyer"
}
```

The new `pexpect` seems slightly slower at reading large strings:

pexpect 2.0:

```
sage: timeit('str(gp("2^2^22"))', repeat=10)
5 loops, best of 10: 380 ms per loop
```


pexpect 4.0.1:

```
sage: timeit('str(gp("2^2^22"))', repeat=10)
5 loops, best of 10: 402 ms per loop
```




---

archive/issue_comments_105260.json:
```json
{
    "body": "The same now with `%time` shows that the time increase is mainly in `user` time, so it's really the `pexpect` code which is causing the slowdown:\n\npexpect 2.0:\n\n```\nsage: %time _ = str(gp(\"2^2^22\"))\nCPU times: user 184 ms, sys: 4 ms, total: 188 ms\nWall time: 384 ms\n```\n\n\npexpect 4.0.1:\n\n```\nsage: %time _ = str(gp(\"2^2^22\"))\nCPU times: user 203 ms, sys: 7 ms, total: 210 ms\nWall time: 405 ms\n```\n",
    "created_at": "2015-12-04T11:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105260",
    "user": "@jdemeyer"
}
```

The same now with `%time` shows that the time increase is mainly in `user` time, so it's really the `pexpect` code which is causing the slowdown:

pexpect 2.0:

```
sage: %time _ = str(gp("2^2^22"))
CPU times: user 184 ms, sys: 4 ms, total: 188 ms
Wall time: 384 ms
```


pexpect 4.0.1:

```
sage: %time _ = str(gp("2^2^22"))
CPU times: user 203 ms, sys: 7 ms, total: 210 ms
Wall time: 405 ms
```




---

archive/issue_comments_105261.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-04T11:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105261",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105262.json:
```json
{
    "body": "I just noticed that `pexpect` uses a read buffer of only 2000 bytes by default.\n\nWTF??? Does `pexpect` upstream really *want* things to be slow?",
    "created_at": "2015-12-04T13:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105262",
    "user": "@jdemeyer"
}
```

I just noticed that `pexpect` uses a read buffer of only 2000 bytes by default.

WTF??? Does `pexpect` upstream really *want* things to be slow?



---

archive/issue_comments_105263.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-04T13:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105263",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105264.json:
```json
{
    "body": "Looking better now:\n\npexpect 2.0 upstream:\n\n```\nsage: %time _ = str(gp(\"2^2^22\"))\nCPU times: user 184 ms, sys: 4 ms, total: 188 ms\nWall time: 384 ms\n```\n\n\npexpect 4.0.1 upstream:\n\n```\nsage: %time _ = str(gp(\"2^2^22\"))\nCPU times: user 308 ms, sys: 9 ms, total: 317 ms\nWall time: 571 ms\n```\n\n\npexpect 4.0.1 + Sage patches:\n\n```\nsage: %time _ = str(gp(\"2^2^22\"))\nCPU times: user 26 ms, sys: 2 ms, total: 28 ms\nWall time: 231 ms\n```\n",
    "created_at": "2015-12-04T13:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105264",
    "user": "@jdemeyer"
}
```

Looking better now:

pexpect 2.0 upstream:

```
sage: %time _ = str(gp("2^2^22"))
CPU times: user 184 ms, sys: 4 ms, total: 188 ms
Wall time: 384 ms
```


pexpect 4.0.1 upstream:

```
sage: %time _ = str(gp("2^2^22"))
CPU times: user 308 ms, sys: 9 ms, total: 317 ms
Wall time: 571 ms
```


pexpect 4.0.1 + Sage patches:

```
sage: %time _ = str(gp("2^2^22"))
CPU times: user 26 ms, sys: 2 ms, total: 28 ms
Wall time: 231 ms
```




---

archive/issue_comments_105265.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-12-04T13:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105265",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105266.json:
```json
{
    "body": "It's especially interesting to look at `user` time. We cannot really change how much time is spent in the system calls, but we can change the time spent in Python code.",
    "created_at": "2015-12-04T14:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105266",
    "user": "@jdemeyer"
}
```

It's especially interesting to look at `user` time. We cannot really change how much time is spent in the system calls, but we can change the time spent in Python code.



---

archive/issue_comments_105267.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-04T14:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105267",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105268.json:
```json
{
    "body": "`make ptestlong` passes.",
    "created_at": "2015-12-04T18:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105268",
    "user": "@jdemeyer"
}
```

`make ptestlong` passes.



---

archive/issue_comments_105269.json:
```json
{
    "body": "jdemeyer asked for a branch for the sagenb piece of this.  I didn't want to have two branches - I guess I should have based on this branch but too late now, and won't have time later today.\n\nu/kcrisman/ticket/10295\n\n```diff\ndiff --git a/build/pkgs/sagenb/checksums.ini b/build/pkgs/sagenb/checksums.ini\nindex f35bb1b..f8e929b 100644\n--- a/build/pkgs/sagenb/checksums.ini\n+++ b/build/pkgs/sagenb/checksums.ini\n@@ -1,4 +1,4 @@\n tarball=sagenb-VERSION.tar\n-sha1=66593ecf18cbf77115279f6f1564854eb9b93df5\n-md5=facdc06b94fcf0a85b76aa861c6e646f\n-cksum=2719820378\n+sha1=7631e986aa01676cfac2522d5cc52b4131f0d399\n+md5=4a286cac8412fa3af9cdcc6b6234b9ce\n+cksum=2718880955\ndiff --git a/build/pkgs/sagenb/package-version.txt b/build/pkgs/sagenb/package-v\nindex 35ad344..af92809 100644\n--- a/build/pkgs/sagenb/package-version.txt\n+++ b/build/pkgs/sagenb/package-version.txt\n@@ -1 +1 @@\n-0.11.4\n+0.11.5.1\n```\n\n\nPackage will be at http://www.math-cs.gordon.edu/~kcrisman/sagenb-0.11.5.1.tar",
    "created_at": "2015-12-04T18:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105269",
    "user": "@kcrisman"
}
```

jdemeyer asked for a branch for the sagenb piece of this.  I didn't want to have two branches - I guess I should have based on this branch but too late now, and won't have time later today.

u/kcrisman/ticket/10295

```diff
diff --git a/build/pkgs/sagenb/checksums.ini b/build/pkgs/sagenb/checksums.ini
index f35bb1b..f8e929b 100644
--- a/build/pkgs/sagenb/checksums.ini
+++ b/build/pkgs/sagenb/checksums.ini
@@ -1,4 +1,4 @@
 tarball=sagenb-VERSION.tar
-sha1=66593ecf18cbf77115279f6f1564854eb9b93df5
-md5=facdc06b94fcf0a85b76aa861c6e646f
-cksum=2719820378
+sha1=7631e986aa01676cfac2522d5cc52b4131f0d399
+md5=4a286cac8412fa3af9cdcc6b6234b9ce
+cksum=2718880955
diff --git a/build/pkgs/sagenb/package-version.txt b/build/pkgs/sagenb/package-v
index 35ad344..af92809 100644
--- a/build/pkgs/sagenb/package-version.txt
+++ b/build/pkgs/sagenb/package-version.txt
@@ -1 +1 @@
-0.11.4
+0.11.5.1
```


Package will be at http://www.math-cs.gordon.edu/~kcrisman/sagenb-0.11.5.1.tar



---

archive/issue_comments_105270.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-04T19:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105270",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105271.json:
```json
{
    "body": "In the `pexpect` log, I see this:\n\n```\nbyte-compiling /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py to async.pyc\n  File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py\", line 16\n    transport, pw = yield from asyncio.get_event_loop()\\\n                             ^\nSyntaxError: invalid syntax\n```\n\nand as a result, there is a file `async.py` but not `async.pyc`. Something to worry about?",
    "created_at": "2015-12-04T20:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105271",
    "user": "@jhpalmieri"
}
```

In the `pexpect` log, I see this:

```
byte-compiling /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py to async.pyc
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py", line 16
    transport, pw = yield from asyncio.get_event_loop()\
                             ^
SyntaxError: invalid syntax
```

and as a result, there is a file `async.py` but not `async.pyc`. Something to worry about?



---

archive/issue_comments_105272.json:
```json
{
    "body": "Replying to [comment:142 jhpalmieri]:\n> In the `pexpect` log, I see this:\n> {{{\n> byte-compiling /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py to async.pyc\n>   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py\", line 16\n>     transport, pw = yield from asyncio.get_event_loop()\\\n>                              ^\n> SyntaxError: invalid syntax\n> }}}\n> and as a result, there is a file `async.py` but not `async.pyc`. Something to worry about?\n\nNo, I opened an issue upstream that was quickly closed. And it mirrored at least another issue opened by another distro maintainer. This file is only used with python3. See [https://github.com/pexpect/pexpect/issues/297](https://github.com/pexpect/pexpect/issues/297)",
    "created_at": "2015-12-04T20:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105272",
    "user": "@kiwifb"
}
```

Replying to [comment:142 jhpalmieri]:
> In the `pexpect` log, I see this:
> {{{
> byte-compiling /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py to async.pyc
>   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/pexpect/async.py", line 16
>     transport, pw = yield from asyncio.get_event_loop()\
>                              ^
> SyntaxError: invalid syntax
> }}}
> and as a result, there is a file `async.py` but not `async.pyc`. Something to worry about?

No, I opened an issue upstream that was quickly closed. And it mirrored at least another issue opened by another distro maintainer. This file is only used with python3. See [https://github.com/pexpect/pexpect/issues/297](https://github.com/pexpect/pexpect/issues/297)



---

archive/issue_comments_105273.json:
```json
{
    "body": "I greatly appreciate all of your hard work on this and regret not being able to keep up. The new timings are very impressive. I have one question:  Do you have timings before and after for the full Sage test suite or at least those parts of it that exercise most of the functionality associated with those other parts of Sage besides gap that use external components via pexpect?",
    "created_at": "2015-12-04T20:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105273",
    "user": "bpage"
}
```

I greatly appreciate all of your hard work on this and regret not being able to keep up. The new timings are very impressive. I have one question:  Do you have timings before and after for the full Sage test suite or at least those parts of it that exercise most of the functionality associated with those other parts of Sage besides gap that use external components via pexpect?



---

archive/issue_comments_105274.json:
```json
{
    "body": "I gave it a try but documentation doesn't build\n\n```\n[notebook ] reading sources... [ 85%] sagenb/notebook/template\n[notebook ] Exception occurred:\n[notebook ] File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/Flask-0.10.1-py2.7.egg/flask/globals.py\", line 34, in _find_app\n[notebook ] raise RuntimeError('working outside of application context')\n[notebook ] RuntimeError: working outside of application context\n[notebook ] The full traceback has been saved in /var/folders/hj/rs3k66f91zddr7hvc6yf_90m0000gp/T/sphinx-err-jc5YhT.log, if you want to report the issue to the developers.\n[notebook ] Please also report this if it was a user error, so that a better error message can be provided next time.\n[notebook ] A bug report can be filed in the tracker at <https://bitbucket.org/birkenfeld/sphinx/issues/>. Thanks!\nError building the documentation.\nTraceback (most recent call last):\n  File \"/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py\", line 1641, in <module>\n    getattr(get_builder(name), type)()\n  File \"/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py\", line 302, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py\", line 513, in _wrapper\n    x.get(99999)\n  File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python/multiprocessing/pool.py\", line 567, in get\n    raise self._value\nOSError: [notebook ] Exception occurred:\n\nmake[1]: *** [doc-html-mathjax] Error 1\n```\n",
    "created_at": "2015-12-05T10:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105274",
    "user": "@vbraun"
}
```

I gave it a try but documentation doesn't build

```
[notebook ] reading sources... [ 85%] sagenb/notebook/template
[notebook ] Exception occurred:
[notebook ] File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/Flask-0.10.1-py2.7.egg/flask/globals.py", line 34, in _find_app
[notebook ] raise RuntimeError('working outside of application context')
[notebook ] RuntimeError: working outside of application context
[notebook ] The full traceback has been saved in /var/folders/hj/rs3k66f91zddr7hvc6yf_90m0000gp/T/sphinx-err-jc5YhT.log, if you want to report the issue to the developers.
[notebook ] Please also report this if it was a user error, so that a better error message can be provided next time.
[notebook ] A bug report can be filed in the tracker at <https://bitbucket.org/birkenfeld/sphinx/issues/>. Thanks!
Error building the documentation.
Traceback (most recent call last):
  File "/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py", line 1641, in <module>
    getattr(get_builder(name), type)()
  File "/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py", line 302, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py", line 513, in _wrapper
    x.get(99999)
  File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
OSError: [notebook ] Exception occurred:

make[1]: *** [doc-html-mathjax] Error 1
```




---

archive/issue_comments_105275.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-08T15:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105275",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105276.json:
```json
{
    "body": "Replying to [comment:144 bpage]:\n> Do you have timings before and after for the full Sage test suite or at least those parts of it that exercise most of the functionality associated with those other parts of Sage besides gap that use external components via pexpect?\n\nSee [attachment:old-pexpect.log] and [attachment:new-pexpect.log] for the output of\n\n```\n./sage -t --optional=sage src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py*\n```\n\n(test all files in `src/sage/interfaces` 5 times).\n\nThe total time of those tests is (I'm not claiming that anything is statistically significant):\n\nold:\n\n```\nTotal time for all tests: 378.2 seconds\n    cpu time: 86.5 seconds\n    cumulative wall time: 365.2 seconds\n```\n\n\nnew:\n\n```\nTotal time for all tests: 360.3 seconds\n    cpu time: 93.6 seconds\n    cumulative wall time: 347.1 seconds\n```\n",
    "created_at": "2015-12-08T16:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105276",
    "user": "@jdemeyer"
}
```

Replying to [comment:144 bpage]:
> Do you have timings before and after for the full Sage test suite or at least those parts of it that exercise most of the functionality associated with those other parts of Sage besides gap that use external components via pexpect?

See [attachment:old-pexpect.log] and [attachment:new-pexpect.log] for the output of

```
./sage -t --optional=sage src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py*
```

(test all files in `src/sage/interfaces` 5 times).

The total time of those tests is (I'm not claiming that anything is statistically significant):

old:

```
Total time for all tests: 378.2 seconds
    cpu time: 86.5 seconds
    cumulative wall time: 365.2 seconds
```


new:

```
Total time for all tests: 360.3 seconds
    cpu time: 93.6 seconds
    cumulative wall time: 347.1 seconds
```




---

archive/issue_comments_105277.json:
```json
{
    "body": "Replying to [comment:148 jdemeyer]:\n> Replying to [comment:144 bpage]:\n> > Do you have timings before and after for the full Sage test suite or at least those parts of it that exercise most of the functionality associated with those other parts of Sage besides gap that use external components via pexpect?\n> \n> See [attachment:old-pexpect.log] and [attachment:new-pexpect.log] for the output of\n> {{{\n> ./sage -t --optional=sage src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py*\n> }}}\n> (test all files in `src/sage/interfaces` 5 times).\n> \n> The total time of those tests is (I'm not claiming that anything is statistically significant):\n> \n> old:\n> {{{\n> Total time for all tests: 378.2 seconds\n>     cpu time: 86.5 seconds\n>     cumulative wall time: 365.2 seconds\n> }}}\n> \n> new:\n> {{{\n> Total time for all tests: 360.3 seconds\n>     cpu time: 93.6 seconds\n>     cumulative wall time: 347.1 seconds\n> }}}\n\nSo the CPU time increased by a significant amount, which is bad...\n\n(Not sure how reliable the figures at all are.)",
    "created_at": "2015-12-08T17:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105277",
    "user": "@nexttime"
}
```

Replying to [comment:148 jdemeyer]:
> Replying to [comment:144 bpage]:
> > Do you have timings before and after for the full Sage test suite or at least those parts of it that exercise most of the functionality associated with those other parts of Sage besides gap that use external components via pexpect?
> 
> See [attachment:old-pexpect.log] and [attachment:new-pexpect.log] for the output of
> {{{
> ./sage -t --optional=sage src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py* src/sage/interfaces/*.py*
> }}}
> (test all files in `src/sage/interfaces` 5 times).
> 
> The total time of those tests is (I'm not claiming that anything is statistically significant):
> 
> old:
> {{{
> Total time for all tests: 378.2 seconds
>     cpu time: 86.5 seconds
>     cumulative wall time: 365.2 seconds
> }}}
> 
> new:
> {{{
> Total time for all tests: 360.3 seconds
>     cpu time: 93.6 seconds
>     cumulative wall time: 347.1 seconds
> }}}

So the CPU time increased by a significant amount, which is bad...

(Not sure how reliable the figures at all are.)



---

archive/issue_comments_105278.json:
```json
{
    "body": "Replying to [comment:149 leif]:\n> So the CPU time increased by a significant amount, which is bad...\n> \n> (Not sure how reliable the figures at all are.)\n\nI have no idea if it's really significant. I don't even know how to check this (all I know is that I should **not** ask the person who wrote the patchbot startup-time plugin)",
    "created_at": "2015-12-08T17:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105278",
    "user": "@jdemeyer"
}
```

Replying to [comment:149 leif]:
> So the CPU time increased by a significant amount, which is bad...
> 
> (Not sure how reliable the figures at all are.)

I have no idea if it's really significant. I don't even know how to check this (all I know is that I should **not** ask the person who wrote the patchbot startup-time plugin)



---

archive/issue_comments_105279.json:
```json
{
    "body": "P.S.:  There is (or at least used to be) `SAGE_TEST_ITER` and `SAGE_TEST_GLOBAL_ITER` (w.r.t. the \"five times\").",
    "created_at": "2015-12-08T17:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105279",
    "user": "@nexttime"
}
```

P.S.:  There is (or at least used to be) `SAGE_TEST_ITER` and `SAGE_TEST_GLOBAL_ITER` (w.r.t. the "five times").



---

archive/issue_comments_105280.json:
```json
{
    "body": "Still there (around line 230 in `src/sage/doctest/control.py`).",
    "created_at": "2015-12-08T17:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105280",
    "user": "@jhpalmieri"
}
```

Still there (around line 230 in `src/sage/doctest/control.py`).



---

archive/issue_comments_105281.json:
```json
{
    "body": "Attachment [old-pexpect.log](tarball://root/attachments/some-uuid/ticket10295/old-pexpect.log) by @jdemeyer created at 2015-12-08 19:05:32\n\nOld doctest timings",
    "created_at": "2015-12-08T19:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105281",
    "user": "@jdemeyer"
}
```

Attachment [old-pexpect.log](tarball://root/attachments/some-uuid/ticket10295/old-pexpect.log) by @jdemeyer created at 2015-12-08 19:05:32

Old doctest timings



---

archive/issue_comments_105282.json:
```json
{
    "body": "New doctest timings",
    "created_at": "2015-12-08T19:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105282",
    "user": "@jdemeyer"
}
```

New doctest timings



---

archive/issue_comments_105283.json:
```json
{
    "body": "Attachment [new-pexpect.log](tarball://root/attachments/some-uuid/ticket10295/new-pexpect.log) by @jdemeyer created at 2015-12-08 19:07:17\n\nI tried the doctests in `sage/interface` again, now with 10 runs. Results are essentially the same:\n\nold:\n\n```\nTotal time for all tests: 722.6 seconds\n    cpu time: 170.2 seconds\n    cumulative wall time: 696.9 seconds\n```\n\n\nnew:\n\n```\nTotal time for all tests: 710.4 seconds\n    cpu time: 185.6 seconds\n    cumulative wall time: 685.0 seconds\n```\n\n\nIs it really a problem if the CPU goes up while the total time goes down?",
    "created_at": "2015-12-08T19:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105283",
    "user": "@jdemeyer"
}
```

Attachment [new-pexpect.log](tarball://root/attachments/some-uuid/ticket10295/new-pexpect.log) by @jdemeyer created at 2015-12-08 19:07:17

I tried the doctests in `sage/interface` again, now with 10 runs. Results are essentially the same:

old:

```
Total time for all tests: 722.6 seconds
    cpu time: 170.2 seconds
    cumulative wall time: 696.9 seconds
```


new:

```
Total time for all tests: 710.4 seconds
    cpu time: 185.6 seconds
    cumulative wall time: 685.0 seconds
```


Is it really a problem if the CPU goes up while the total time goes down?



---

archive/issue_comments_105284.json:
```json
{
    "body": "Replying to [comment:153 jdemeyer]:\n> Is it really a problem if the CPU goes up while the total time goes down?\n\nAs always, *it depends*.\n\nDo we burn more carbon that way?\n\nMore seriously, in case the potential cpu time is wasted otherwise, perhaps not (*wall time* then matters; but even on a battery-powered notebook, the answer might yet be different).  But if it's not, i.e., if other processes suffer from getting less, it does of course.  So it mainly depends on the user, or rather the usage of the machine Sage is running on (and hence potentially many users).\n\n\n\n\n\nReplying late to [comment:130 jdemeyer]:\n> I just noticed that `pexpect` uses a read buffer of only 2000 bytes by default.\n> \n> WTF??? Does `pexpect` upstream really *want* things to be slow?\n\nThink of pexpect's purpose; not counting newlines, 2000 characters is 80 columns by 25 lines, so pretty reasonable even with ASCII art output (well, perhaps twice that, but not vastly more.).\n\nIn the same sense, benchmarking with `gp(\"2<sup>2</sup>22\")` seems hardly appropriate, IMHO.\n\nLatency matters, more than throughput.  (And in a multitasking environment, overall resource usage.)",
    "created_at": "2015-12-08T20:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105284",
    "user": "@nexttime"
}
```

Replying to [comment:153 jdemeyer]:
> Is it really a problem if the CPU goes up while the total time goes down?

As always, *it depends*.

Do we burn more carbon that way?

More seriously, in case the potential cpu time is wasted otherwise, perhaps not (*wall time* then matters; but even on a battery-powered notebook, the answer might yet be different).  But if it's not, i.e., if other processes suffer from getting less, it does of course.  So it mainly depends on the user, or rather the usage of the machine Sage is running on (and hence potentially many users).





Replying late to [comment:130 jdemeyer]:
> I just noticed that `pexpect` uses a read buffer of only 2000 bytes by default.
> 
> WTF??? Does `pexpect` upstream really *want* things to be slow?

Think of pexpect's purpose; not counting newlines, 2000 characters is 80 columns by 25 lines, so pretty reasonable even with ASCII art output (well, perhaps twice that, but not vastly more.).

In the same sense, benchmarking with `gp("2<sup>2</sup>22")` seems hardly appropriate, IMHO.

Latency matters, more than throughput.  (And in a multitasking environment, overall resource usage.)



---

archive/issue_comments_105285.json:
```json
{
    "body": "Replying to [comment:155 leif]:\n> In the same sense, benchmarking with `gp(\"2<sup>2</sup>22\")` seems hardly appropriate, IMHO.\n\nLarge outputs do actually happen in Sage. It's not so crazy.\n\nI agree that it's not the *only* thing which matters.",
    "created_at": "2015-12-08T20:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105285",
    "user": "@jdemeyer"
}
```

Replying to [comment:155 leif]:
> In the same sense, benchmarking with `gp("2<sup>2</sup>22")` seems hardly appropriate, IMHO.

Large outputs do actually happen in Sage. It's not so crazy.

I agree that it's not the *only* thing which matters.



---

archive/issue_comments_105286.json:
```json
{
    "body": "Is anybody willing to review this ticket? I won't waste my time investigating the CPU time issue if this ticket will stall anyway.",
    "created_at": "2015-12-08T20:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105286",
    "user": "@jdemeyer"
}
```

Is anybody willing to review this ticket? I won't waste my time investigating the CPU time issue if this ticket will stall anyway.



---

archive/issue_comments_105287.json:
```json
{
    "body": "Replying to [comment:156 jdemeyer]:\n> Replying to [comment:155 leif]:\n> > In the same sense, benchmarking with `gp(\"2<sup>2</sup>22\")` seems hardly appropriate, IMHO.\n> \n> Large outputs do actually happen in Sage. It's not so crazy.\n\nYep, but certainly not the typical usage scenario of pexpect, so I wouldn't blame upstream for their default buffer size.\n\nOn the other hand, often the interaction of Sage with pexpect-driven programs looks more like a human one, where lots of variables get set with short commands, to finally get a (typically relatively short) answer.  Mainly in toy examples communication overhead dominates computation time (unless latency in a longer dialogue is really bad, as we experienced with some Ubuntu kernels a while ago).\n\n\n\n\nI'm not very worried about the increased CPU time (yet ;-) ); it's just that we shouldn't exclusively focus on bare throughput.\n\nIf the number and/or size of objects passed is huge, it's probably more worth thinking of other solutions.",
    "created_at": "2015-12-08T21:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105287",
    "user": "@nexttime"
}
```

Replying to [comment:156 jdemeyer]:
> Replying to [comment:155 leif]:
> > In the same sense, benchmarking with `gp("2<sup>2</sup>22")` seems hardly appropriate, IMHO.
> 
> Large outputs do actually happen in Sage. It's not so crazy.

Yep, but certainly not the typical usage scenario of pexpect, so I wouldn't blame upstream for their default buffer size.

On the other hand, often the interaction of Sage with pexpect-driven programs looks more like a human one, where lots of variables get set with short commands, to finally get a (typically relatively short) answer.  Mainly in toy examples communication overhead dominates computation time (unless latency in a longer dialogue is really bad, as we experienced with some Ubuntu kernels a while ago).




I'm not very worried about the increased CPU time (yet ;-) ); it's just that we shouldn't exclusively focus on bare throughput.

If the number and/or size of objects passed is huge, it's probably more worth thinking of other solutions.



---

archive/issue_comments_105288.json:
```json
{
    "body": "Replying to [comment:157 jdemeyer]:\n> Is anybody willing to review this ticket? I won't waste my time investigating the CPU time issue if this ticket will stall anyway.\n\nI do not find the difference in reported times for the sage/interface tests at all disturbing. I seriously doubt that it would be noticeable to the average user. At the same time the new gap timings suggest that certain heavy users might be pleasantly surprized.\n\nI plan to test this change some time in the next few days.  One thing that I want out of this change is support for unicode in external packages. I expect to be able to give it a positive review.",
    "created_at": "2015-12-08T21:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105288",
    "user": "bpage"
}
```

Replying to [comment:157 jdemeyer]:
> Is anybody willing to review this ticket? I won't waste my time investigating the CPU time issue if this ticket will stall anyway.

I do not find the difference in reported times for the sage/interface tests at all disturbing. I seriously doubt that it would be noticeable to the average user. At the same time the new gap timings suggest that certain heavy users might be pleasantly surprized.

I plan to test this change some time in the next few days.  One thing that I want out of this change is support for unicode in external packages. I expect to be able to give it a positive review.



---

archive/issue_comments_105289.json:
```json
{
    "body": "I added some latency timings too, which again show a significant improvement.",
    "created_at": "2015-12-09T08:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105289",
    "user": "@jdemeyer"
}
```

I added some latency timings too, which again show a significant improvement.



---

archive/issue_comments_105290.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-09T13:43:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105290",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105291.json:
```json
{
    "body": "I see no reason to include all the changes on the `superfluous-sleep` branch. I changed the patch to take just the changes proposed on the pull request.",
    "created_at": "2015-12-09T13:44:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105291",
    "user": "@jdemeyer"
}
```

I see no reason to include all the changes on the `superfluous-sleep` branch. I changed the patch to take just the changes proposed on the pull request.



---

archive/issue_comments_105292.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-09T14:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105292",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105293.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-12-09T14:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105293",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_105294.json:
```json
{
    "body": "Replying to [comment:162 jdemeyer]:\n> I see no reason to include all the changes on the `superfluous-sleep` branch. I changed the patch to take just the changes proposed on the pull request.\n\nFailed to parse that...  So you rebased the changes from PR !#291 onto 4.0.1 (since the PR is based on some 4.1.dev)?\n----\nNew commits:",
    "created_at": "2015-12-09T14:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105294",
    "user": "@nexttime"
}
```

Replying to [comment:162 jdemeyer]:
> I see no reason to include all the changes on the `superfluous-sleep` branch. I changed the patch to take just the changes proposed on the pull request.

Failed to parse that...  So you rebased the changes from PR !#291 onto 4.0.1 (since the PR is based on some 4.1.dev)?
----
New commits:



---

archive/issue_comments_105295.json:
```json
{
    "body": "Replying to [comment:165 leif]:\n> Failed to parse that...  So you rebased the changes from PR !#291 onto 4.0.1 (since the PR is based on some 4.1.dev)?\n\nYes. But it was a trivial rebase, essentially just a cherry-pick of one commit.\n\nNow all 3 patches are independent.",
    "created_at": "2015-12-09T14:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105295",
    "user": "@jdemeyer"
}
```

Replying to [comment:165 leif]:
> Failed to parse that...  So you rebased the changes from PR !#291 onto 4.0.1 (since the PR is based on some 4.1.dev)?

Yes. But it was a trivial rebase, essentially just a cherry-pick of one commit.

Now all 3 patches are independent.



---

archive/issue_comments_105296.json:
```json
{
    "body": "The new version of patch for https://github.com/pexpect/pexpect/pull/304 shows again a small improvement.",
    "created_at": "2015-12-09T14:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105296",
    "user": "@jdemeyer"
}
```

The new version of patch for https://github.com/pexpect/pexpect/pull/304 shows again a small improvement.



---

archive/issue_comments_105297.json:
```json
{
    "body": "How about creating a new, clean branch?",
    "created_at": "2015-12-09T14:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105297",
    "user": "@nexttime"
}
```

How about creating a new, clean branch?



---

archive/issue_comments_105298.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-09T21:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105298",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105299.json:
```json
{
    "body": "Thanks for all the work on this Jeroen, I have been rather absent for the last week at least but it looks like a great clean up as well as an upgrade.",
    "created_at": "2015-12-09T22:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105299",
    "user": "@kiwifb"
}
```

Thanks for all the work on this Jeroen, I have been rather absent for the last week at least but it looks like a great clean up as well as an upgrade.



---

archive/issue_comments_105300.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-09T22:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105300",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105301.json:
```json
{
    "body": "I've patched sage.6.10.beta7 and built it on SMC.  I ran the interface tests. I configured it to run from SMC worksheet and verified that Sage and my favorite external packages (FriCAS and Octave) work as expected. Unicode symbols work in FriCAS. Everything looks fine to me. I would give this ticket a positive review.",
    "created_at": "2015-12-10T03:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105301",
    "user": "bpage"
}
```

I've patched sage.6.10.beta7 and built it on SMC.  I ran the interface tests. I configured it to run from SMC worksheet and verified that Sage and my favorite external packages (FriCAS and Octave) work as expected. Unicode symbols work in FriCAS. Everything looks fine to me. I would give this ticket a positive review.



---

archive/issue_comments_105302.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-10T03:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105302",
    "user": "bpage"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105303.json:
```json
{
    "body": "Note that the dependency #19671 still needs a review.",
    "created_at": "2015-12-10T07:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105303",
    "user": "@jdemeyer"
}
```

Note that the dependency #19671 still needs a review.



---

archive/issue_comments_105304.json:
```json
{
    "body": "Since we are in the \"sage-6.10.rc\" phase, I don't think this should be merged in 6.10.",
    "created_at": "2015-12-10T08:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105304",
    "user": "@jdemeyer"
}
```

Since we are in the "sage-6.10.rc" phase, I don't think this should be merged in 6.10.



---

archive/issue_comments_105305.json:
```json
{
    "body": "Now that this has positive review otherwise, I'll also be sure to include the relevant piece in #19616.  Fran\u00e7ois, if you want to make the same PR as before I can do that; I'm not sure how to revert reverting a changeset on Github, I just want to make sure your name is still attached to that change.",
    "created_at": "2015-12-10T14:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105305",
    "user": "@kcrisman"
}
```

Now that this has positive review otherwise, I'll also be sure to include the relevant piece in #19616.  François, if you want to make the same PR as before I can do that; I'm not sure how to revert reverting a changeset on Github, I just want to make sure your name is still attached to that change.



---

archive/issue_comments_105306.json:
```json
{
    "body": "Replying to [comment:177 kcrisman]:\n> Now that this has positive review otherwise, I'll also be sure to include the relevant piece in #19616.  Fran\u00e7ois, if you want to make the same PR as before I can do that; I'm not sure how to revert reverting a changeset on Github, I just want to make sure your name is still attached to that change.\n\nOn it.",
    "created_at": "2015-12-10T19:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105306",
    "user": "@kiwifb"
}
```

Replying to [comment:177 kcrisman]:
> Now that this has positive review otherwise, I'll also be sure to include the relevant piece in #19616.  François, if you want to make the same PR as before I can do that; I'm not sure how to revert reverting a changeset on Github, I just want to make sure your name is still attached to that change.

On it.



---

archive/issue_comments_105307.json:
```json
{
    "body": "I have made one additional pull request to `pexpect`: [https://github.com/pexpect/pexpect/pull/308/files](https://github.com/pexpect/pexpect/pull/308/files)\n\nIt is really quite trivial and it provided yet another easy optimization. If some reviewer agrees, I will add that patch to the branch here.",
    "created_at": "2015-12-10T19:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105307",
    "user": "@jdemeyer"
}
```

I have made one additional pull request to `pexpect`: [https://github.com/pexpect/pexpect/pull/308/files](https://github.com/pexpect/pexpect/pull/308/files)

It is really quite trivial and it provided yet another easy optimization. If some reviewer agrees, I will add that patch to the branch here.



---

archive/issue_comments_105308.json:
```json
{
    "body": "Replying to [comment:178 fbissey]:\n> Replying to [comment:177 kcrisman]:\n> > Now that this has positive review otherwise, I'll also be sure to include the relevant piece in #19616.  Fran\u00e7ois, if you want to make the same PR as before I can do that; I'm not sure how to revert reverting a changeset on Github, I just want to make sure your name is still attached to that change.\n> \n> On it.\nThis is now https://github.com/sagemath/sagenb/pull/356",
    "created_at": "2015-12-10T20:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105308",
    "user": "@kiwifb"
}
```

Replying to [comment:178 fbissey]:
> Replying to [comment:177 kcrisman]:
> > Now that this has positive review otherwise, I'll also be sure to include the relevant piece in #19616.  François, if you want to make the same PR as before I can do that; I'm not sure how to revert reverting a changeset on Github, I just want to make sure your name is still attached to that change.
> 
> On it.
This is now https://github.com/sagemath/sagenb/pull/356



---

archive/issue_comments_105309.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2015-12-14T09:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105309",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_105310.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2015-12-14T09:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105310",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_105311.json:
```json
{
    "body": "Merged the latest version of #19616.",
    "created_at": "2015-12-14T09:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105311",
    "user": "@jdemeyer"
}
```

Merged the latest version of #19616.



---

archive/issue_comments_105312.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-14T09:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105312",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105313.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2015-12-16T21:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105313",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_105314.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2015-12-16T21:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105314",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_105315.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-16T21:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105315",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105316.json:
```json
{
    "body": "Follow-up at #19736.",
    "created_at": "2015-12-16T22:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105316",
    "user": "@jdemeyer"
}
```

Follow-up at #19736.



---

archive/issue_comments_105317.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-22T19:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10294#issuecomment-105317",
    "user": "@vbraun"
}
```

Resolution: fixed
