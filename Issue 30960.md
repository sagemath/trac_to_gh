# Issue 30960: Use bitsets/binary matrix for edges of dense graphs

archive/issues_030960.json:
```json
{
    "body": "CC:  @dcoudert\n\nKeywords: dense graphs, bitsets\n\nCurrently, the dense graphs backend redefines bitsets. We change the type to `binary_matrix_t`.\n\nThis mainly simplifies the code and lets dense graphs use future improvements of bitsets, but it also speeds up direct functions with the backend.\n\nRealloc is a bit slower though.\n\nWe also add reallocation for binary matrix and make some small improvements to `binary_matrix.pxi`.\n\nBefore:\n\n\n```\nsage: set_random_seed(0)                                                                                                              \nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                             \nsage: %timeit G = Graph(edges, sparse=False, loops=True)                                                                              \n19.4 ms \u00b1 752 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: G = Graph(edges, sparse=False, loops=True)                                                                                      \nsage: %timeit _ = G.copy(sparse=True)                                                                                                 \n49.2 ms \u00b1 312 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit _ = G.copy(sparse=False)                                                                                                \n6.18 ms \u00b1 5.74 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\n\nAfter:\n\n```\nsage: set_random_seed(0)                                                                                                                                                            \nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                                                                           \nsage: %timeit G = Graph(edges, sparse=False, loops=True)                                                                                                                            \n19.2 ms \u00b1 55.8 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: G = Graph(edges, sparse=False, loops=True)                                                                                                                                    \nsage: %timeit _ = G.copy(sparse=True)                                                                                                                                               \n47.3 ms \u00b1 396 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit _ = G.copy(sparse=False)                                                                                                                                              \n3.64 ms \u00b1 15.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31197\n\n",
    "created_at": "2021-01-07T15:56:45Z",
    "labels": [
        "graph theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Use bitsets/binary matrix for edges of dense graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30960",
    "user": "@kliem"
}
```
CC:  @dcoudert

Keywords: dense graphs, bitsets

Currently, the dense graphs backend redefines bitsets. We change the type to `binary_matrix_t`.

This mainly simplifies the code and lets dense graphs use future improvements of bitsets, but it also speeds up direct functions with the backend.

Realloc is a bit slower though.

We also add reallocation for binary matrix and make some small improvements to `binary_matrix.pxi`.

Before:


```
sage: set_random_seed(0)                                                                                                              
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                             
sage: %timeit G = Graph(edges, sparse=False, loops=True)                                                                              
19.4 ms ± 752 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: G = Graph(edges, sparse=False, loops=True)                                                                                      
sage: %timeit _ = G.copy(sparse=True)                                                                                                 
49.2 ms ± 312 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit _ = G.copy(sparse=False)                                                                                                
6.18 ms ± 5.74 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


After:

```
sage: set_random_seed(0)                                                                                                                                                            
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                                                                           
sage: %timeit G = Graph(edges, sparse=False, loops=True)                                                                                                                            
19.2 ms ± 55.8 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: G = Graph(edges, sparse=False, loops=True)                                                                                                                                    
sage: %timeit _ = G.copy(sparse=True)                                                                                                                                               
47.3 ms ± 396 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit _ = G.copy(sparse=False)                                                                                                                                              
3.64 ms ± 15.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


Issue created by migration from https://trac.sagemath.org/ticket/31197





---

archive/issue_comments_442180.json:
```json
{
    "body": "I fully agree with these changes. However, may be a first step is to do what has been done for bitsets: use .pxd and .pyx files and no longer .pxi. So split this ticket in 2, one for modifications of the binary matrix data structure (and addition of realloc method), and the other for the modification of the dense graph backend.",
    "created_at": "2021-01-07T16:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442180",
    "user": "@dcoudert"
}
```

I fully agree with these changes. However, may be a first step is to do what has been done for bitsets: use .pxd and .pyx files and no longer .pxi. So split this ticket in 2, one for modifications of the binary matrix data structure (and addition of realloc method), and the other for the modification of the dense graph backend.



---

archive/issue_comments_442181.json:
```json
{
    "body": "Sure, I was almost expecting this request (maybe not for splitting into pxd and pyx, but this one should be done as well).",
    "created_at": "2021-01-07T16:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442181",
    "user": "@kliem"
}
```

Sure, I was almost expecting this request (maybe not for splitting into pxd and pyx, but this one should be done as well).



---

archive/issue_comments_442182.json:
```json
{
    "body": "We already have `binary_matrix.pxd` but not `binary_matrix.pyx`.",
    "created_at": "2021-01-07T17:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442182",
    "user": "@dcoudert"
}
```

We already have `binary_matrix.pxd` but not `binary_matrix.pyx`.



---

archive/issue_comments_442183.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-07T20:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442183",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442184.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-07T20:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442184",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442185.json:
```json
{
    "body": "If I'm correct, it should be a bit faster to get out-neighbors (unsafe iterator) now. For in-neighbors, I'm not sure if it is faster or slower. \n\nConcerning the realloc, the slowdown might not be a critical issue.\n\nI'm waiting for the patchbot. My tests are OK, but I may have missed something.",
    "created_at": "2021-01-07T22:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442185",
    "user": "@dcoudert"
}
```

If I'm correct, it should be a bit faster to get out-neighbors (unsafe iterator) now. For in-neighbors, I'm not sure if it is faster or slower. 

Concerning the realloc, the slowdown might not be a critical issue.

I'm waiting for the patchbot. My tests are OK, but I may have missed something.



---

archive/issue_comments_442186.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-07T23:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442186",
    "user": "@dcoudert"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_442187.json:
```json
{
    "body": "some failing doctests in `src/sage/groups/perm_gps/partn_ref/refinement_graphs.pyx` due to the removal of `num_longs`.",
    "created_at": "2021-01-07T23:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442187",
    "user": "@dcoudert"
}
```

some failing doctests in `src/sage/groups/perm_gps/partn_ref/refinement_graphs.pyx` due to the removal of `num_longs`.



---

archive/issue_comments_442188.json:
```json
{
    "body": "`copy_dense_graph` in `src/sage/groups/perm_gps/part_ref/refinement_graphs.pyx`?\n\nThat is the complete wrong place for such a function.",
    "created_at": "2021-01-08T07:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442188",
    "user": "@kliem"
}
```

`copy_dense_graph` in `src/sage/groups/perm_gps/part_ref/refinement_graphs.pyx`?

That is the complete wrong place for such a function.



---

archive/issue_comments_442189.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-08T08:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442189",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442190.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-08T08:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442190",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_442191.json:
```json
{
    "body": "I know method `copy_dense_graph` is `unsafe`, but it might be better to check whether both matrix have the same size, no ?",
    "created_at": "2021-01-08T09:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442191",
    "user": "@dcoudert"
}
```

I know method `copy_dense_graph` is `unsafe`, but it might be better to check whether both matrix have the same size, no ?



---

archive/issue_comments_442192.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-08T10:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442192",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442193.json:
```json
{
    "body": "Replying to [comment:13 dcoudert]:\n> I know method `copy_dense_graph` is `unsafe`, but it might be better to check whether both matrix have the same size, no ?\n\nSure.",
    "created_at": "2021-01-08T10:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442193",
    "user": "@kliem"
}
```

Replying to [comment:13 dcoudert]:
> I know method `copy_dense_graph` is `unsafe`, but it might be better to check whether both matrix have the same size, no ?

Sure.



---

archive/issue_comments_442194.json:
```json
{
    "body": "You check `active_vertices` but not `edges`. Since the `copy` method of `binary_matrix` assumes that both matrix have the same size, we must have a test somewhere to prevent segfaults.",
    "created_at": "2021-01-08T10:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442194",
    "user": "@dcoudert"
}
```

You check `active_vertices` but not `edges`. Since the `copy` method of `binary_matrix` assumes that both matrix have the same size, we must have a test somewhere to prevent segfaults.



---

archive/issue_comments_442195.json:
```json
{
    "body": "`__init__` and `dealloc` guarantee this. But if you want, I can add this test, just to make sure no one messes around with the matrix or the active vertices without using the proper methods (or the methods are changed without preserving this property).",
    "created_at": "2021-01-08T10:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442195",
    "user": "@kliem"
}
```

`__init__` and `dealloc` guarantee this. But if you want, I can add this test, just to make sure no one messes around with the matrix or the active vertices without using the proper methods (or the methods are changed without preserving this property).



---

archive/issue_comments_442196.json:
```json
{
    "body": "Yes, I think it's better to have these tests and the extra cost is small compared to the actual cost of the copy of the binary matrix.",
    "created_at": "2021-01-08T10:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442196",
    "user": "@dcoudert"
}
```

Yes, I think it's better to have these tests and the extra cost is small compared to the actual cost of the copy of the binary matrix.



---

archive/issue_comments_442197.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-08T10:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442197",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442198.json:
```json
{
    "body": "Perfect. Thank you.",
    "created_at": "2021-01-08T11:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442198",
    "user": "@dcoudert"
}
```

Perfect. Thank you.



---

archive/issue_comments_442199.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-08T11:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442199",
    "user": "@dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442200.json:
```json
{
    "body": "Thank you for reviewing.",
    "created_at": "2021-01-08T11:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442200",
    "user": "@kliem"
}
```

Thank you for reviewing.



---

archive/issue_comments_442201.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-31T20:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30960",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30960#issuecomment-442201",
    "user": "@vbraun"
}
```

Resolution: fixed
