# Issue 30960: Use bitsets/binary matrix for edges of dense graphs

Issue created by migration from https://trac.sagemath.org/ticket/31197

Original creator: @kliem

Original creation time: 2021-01-07 15:56:45

CC:  dcoudert

Keywords: dense graphs, bitsets

Currently, the dense graphs backend redefines bitsets. We change the type to `binary_matrix_t`.

This mainly simplifies the code and lets dense graphs use future improvements of bitsets, but it also speeds up direct functions with the backend.

Realloc is a bit slower though.

We also add reallocation for binary matrix and make some small improvements to `binary_matrix.pxi`.

Before:


```
sage: set_random_seed(0)                                                                                                              
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                             
sage: %timeit G = Graph(edges, sparse=False, loops=True)                                                                              
19.4 ms ± 752 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: G = Graph(edges, sparse=False, loops=True)                                                                                      
sage: %timeit _ = G.copy(sparse=True)                                                                                                 
49.2 ms ± 312 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit _ = G.copy(sparse=False)                                                                                                
6.18 ms ± 5.74 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


After:

```
sage: set_random_seed(0)                                                                                                                                                            
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]                                                                                                           
sage: %timeit G = Graph(edges, sparse=False, loops=True)                                                                                                                            
19.2 ms ± 55.8 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: G = Graph(edges, sparse=False, loops=True)                                                                                                                                    
sage: %timeit _ = G.copy(sparse=True)                                                                                                                                               
47.3 ms ± 396 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit _ = G.copy(sparse=False)                                                                                                                                              
3.64 ms ± 15.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```



---

Comment by dcoudert created at 2021-01-07 16:17:47

I fully agree with these changes. However, may be a first step is to do what has been done for bitsets: use .pxd and .pyx files and no longer .pxi. So split this ticket in 2, one for modifications of the binary matrix data structure (and addition of realloc method), and the other for the modification of the dense graph backend.


---

Comment by @kliem created at 2021-01-07 16:19:04

Sure, I was almost expecting this request (maybe not for splitting into pxd and pyx, but this one should be done as well).


---

Comment by dcoudert created at 2021-01-07 17:16:48

We already have `binary_matrix.pxd` but not `binary_matrix.pyx`.


---

Comment by git created at 2021-01-07 20:05:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2021-01-07 20:05:19

Changing status from new to needs_review.


---

Comment by dcoudert created at 2021-01-07 22:15:37

If I'm correct, it should be a bit faster to get out-neighbors (unsafe iterator) now. For in-neighbors, I'm not sure if it is faster or slower. 

Concerning the realloc, the slowdown might not be a critical issue.

I'm waiting for the patchbot. My tests are OK, but I may have missed something.


---

Comment by dcoudert created at 2021-01-07 23:29:50

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2021-01-07 23:29:50

some failing doctests in `src/sage/groups/perm_gps/partn_ref/refinement_graphs.pyx` due to the removal of `num_longs`.


---

Comment by @kliem created at 2021-01-08 07:54:27

`copy_dense_graph` in `src/sage/groups/perm_gps/part_ref/refinement_graphs.pyx`?

That is the complete wrong place for such a function.


---

Comment by git created at 2021-01-08 08:22:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2021-01-08 08:22:27

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2021-01-08 09:10:25

I know method `copy_dense_graph` is `unsafe`, but it might be better to check whether both matrix have the same size, no ?


---

Comment by git created at 2021-01-08 10:08:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2021-01-08 10:08:46

Replying to [comment:13 dcoudert]:
> I know method `copy_dense_graph` is `unsafe`, but it might be better to check whether both matrix have the same size, no ?

Sure.


---

Comment by dcoudert created at 2021-01-08 10:22:44

You check `active_vertices` but not `edges`. Since the `copy` method of `binary_matrix` assumes that both matrix have the same size, we must have a test somewhere to prevent segfaults.


---

Comment by @kliem created at 2021-01-08 10:26:30

`__init__` and `dealloc` guarantee this. But if you want, I can add this test, just to make sure no one messes around with the matrix or the active vertices without using the proper methods (or the methods are changed without preserving this property).


---

Comment by dcoudert created at 2021-01-08 10:36:39

Yes, I think it's better to have these tests and the extra cost is small compared to the actual cost of the copy of the binary matrix.


---

Comment by git created at 2021-01-08 10:55:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2021-01-08 11:27:48

Perfect. Thank you.


---

Comment by dcoudert created at 2021-01-08 11:27:48

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-01-08 11:33:49

Thank you for reviewing.


---

Comment by vbraun created at 2021-01-31 20:53:36

Resolution: fixed
