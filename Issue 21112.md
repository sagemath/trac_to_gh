# Issue 21112: build verbose upon Python's logging module

Issue created by migration from https://trac.sagemath.org/ticket/21349

Original creator: dkrenn

Original creation time: 2016-08-26 17:18:00

CC:  mkoeppe was novoselt jdemeyer

Make SageMath's verbosity system use Python's logging module and explain how to use (basic) logging in SageMath.

See the discussion on https://groups.google.com/d/msg/sage-devel/TYjZcAg9uT0/Ym-H6KmNAAAJ


---

Comment by dkrenn created at 2016-08-26 17:25:42

The current branch provides the new functionality and gives a short "howto" use Python's logging module.

What is left: Update the whole Sage-library to use the new sage.misc.verbose.verbose (it's syntax compatible).

Old sage.misc.misc.verbose is deprecated. Once the deprecation period is over, we can switch to sage.misc.verbose.* in the global name space.
----
New commits:


---

Comment by aapitzsch created at 2016-08-26 17:50:35

Is this related to #17815?


---

Comment by mkoeppe created at 2016-08-28 10:49:56

This needs testing in SageMathCloud and in the notebook.
A while back, when using Python logging in SMC, I noticed that log messages would end up in the wrong cell (where the logger was initialized). At the time I wrote a (hackish) workaround for my project: https://github.com/mkoeppe/infinite-group-relaxation-code/blob/master/logging.sage


---

Comment by dkrenn created at 2016-08-29 13:50:26

Replying to [comment:3 aapitzsch]:
> Is this related to #17815?

Kind of. #17815 means that the following part of [comment:2 dkrenn] is skipped (which is fine for me):
> Old sage.misc.misc.verbose is deprecated. Once the deprecation period is over, we can switch to sage.misc.verbose.* in the global name space.


---

Comment by git created at 2016-08-29 15:36:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-30 09:15:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-08-30 10:59:11

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-08-31 14:36:53

If this is meant as a replacement for the current 'verbose' system, shouldn't Sage (the application) initialize the logger?
Also see comment 5.


---

Comment by mmezzarobba created at 2016-09-01 13:13:21

Thanks for working on this!

A quick suggestion (unfortunately, I don't have time for reviewing the code right now): what would you think of adding a semi-standard logging level (say `HINT` to follow Maple's terminology) between `logging.WARNING` and `logging.INFO`? The idea is that `HINT` messages would be similar to `INFO` messages, but _on by default_ under the Sage shell/notebook, and could be used (sparingly!) for things that aren't quite warnings but that the user ought to know when using sage interactively (“try this instead” when returning a probably useless result, for instance).

On a related note, are you sure that you want to keep exposing and documenting Sage's legacy verbosity levels, instead of just supporting them for compatibility but encouraging everyone to switch to standard `logging` levels?


---

Comment by git created at 2016-09-02 14:47:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-09-02 14:48:33

Replying to [comment:12 mkoeppe]:
> If this is meant as a replacement for the current 'verbose' system, shouldn't Sage (the application) initialize the logger?

Done.


---

Comment by dkrenn created at 2016-09-02 14:49:09

Replying to [comment:13 mmezzarobba]:
> A quick suggestion (unfortunately, I don't have time for reviewing the code right now): what would you think of adding a semi-standard logging level (say `HINT` to follow Maple's terminology) between `logging.WARNING` and `logging.INFO`? The idea is that `HINT` messages would be similar to `INFO` messages, but _on by default_ under the Sage shell/notebook, and could be used (sparingly!) for things that aren't quite warnings but that the user ought to know when using sage interactively (“try this instead” when returning a probably useless result, for instance).

Is fine for me; I suggest to put this on a follow-up ticket.


---

Comment by dkrenn created at 2016-09-02 14:49:39

Replying to [comment:13 mmezzarobba]:
> On a related note, are you sure that you want to keep exposing and documenting Sage's legacy verbosity levels, instead of just supporting them for compatibility but encouraging everyone to switch to standard `logging` levels?

Ok (I think I agree); changed.


---

Comment by dkrenn created at 2016-09-02 14:55:46

Replying to [comment:5 mkoeppe]:
> This needs testing in SageMathCloud and in the notebook.

No idea what to do here...


---

Comment by git created at 2016-09-02 15:02:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-03 23:14:25

Replying to [comment:18 dkrenn]:
> Replying to [comment:5 mkoeppe]:
> > This needs testing in SageMathCloud and in the notebook.
> 
> No idea what to do here...

For SageMathCloud: https://github.com/sagemathinc/smc/wiki/SageMath-Development-on-SageMathCloud


---

Comment by was created at 2016-09-03 23:20:29

I don't see any reason why this would impact SageMathCloud (really just Ubuntu 16.04).  We'll test there when the next beta is released and open a ticket if there are any problems.    (Thanks for being considerate and worrying about testing there.)


---

Comment by mkoeppe created at 2016-09-03 23:48:17

Replying to [comment:21 was]:
> I don't see any reason why this would impact SageMathCloud (really just Ubuntu 16.04).  We'll test there when the next beta is released and open a ticket if there are any problems.    (Thanks for being considerate and worrying about testing there.)

It's not about the OS. 
Python's logging, or rather the way that this patch intends to use it to replace the verbose facility, "does not work" in SageMathCloud. Try this example, from the patch on this ticket, in SMC.

```
+    sage: import logging
+    sage: logging.basicConfig()
+
+Setting the level::
+
+    sage: logging.getLogger().setLevel(logging.INFO)
+
+Log something::
+
+    sage: logger = logging.getLogger(__name__)
+    sage: logger.info('Hello. I am talking to you.')
+    INFO:__main__:Hello. I am talking to you.
```

See comment 5 for more info


---

Comment by was created at 2016-09-04 00:03:12

I see -- the logger must not use sys.stdout (or sys.stderr).  Argh.   Does this fully work with Jupyter?  Does jupyter do something special to deal with this.


---

Comment by mkoeppe created at 2016-09-04 00:06:12

Replying to [comment:23 was]:
> I see -- the logger must not use sys.stdout (or sys.stderr).  Argh.   Does this fully work with Jupyter?  Does jupyter do something special to deal with this.
I don't know. I have only tested logging in the ipython shell, the sage notebook and SMC.


---

Comment by mkoeppe created at 2016-09-04 02:27:23

Replying to [comment:24 mkoeppe]:
> Replying to [comment:23 was]:
> > I see -- the logger must not use sys.stdout (or sys.stderr).  Argh.   Does this fully work with Jupyter?  Does jupyter do something special to deal with this.

When using a Jupyter notebook (using `sage --notebook=jupyter`), the log messages end up in the terminal rather than in the notebook:

```
[I 19:24:29.026 NotebookApp] Kernel started: 6f4e0b9a-ad72-4147-99c6-f9dae1282fda
INFO:__main__:Hello. I am talking to you.
```



---

Comment by mkoeppe created at 2016-09-04 02:27:46

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-09-08 18:10:07

Likewise in [SageMathCell](SageMathCell) (http://sagecell.sagemath.org/).


---

Comment by dkrenn created at 2016-09-08 19:05:31

Replying to [comment:25 mkoeppe]:
> Replying to [comment:24 mkoeppe]:
> > Replying to [comment:23 was]:
> > > I see -- the logger must not use sys.stdout (or sys.stderr).  Argh.   Does this fully work with Jupyter?  Does jupyter do something special to deal with this.
> 
> When using a Jupyter notebook (using `sage --notebook=jupyter`), the log messages end up in the terminal rather than in the notebook:
> {{{
> [I 19:24:29.026 NotebookApp] Kernel started: 6f4e0b9a-ad72-4147-99c6-f9dae1282fda
> INFO:__main__:Hello. I am talking to you.
> }}}

Does anyone know how to fix this?


---

Comment by mkoeppe created at 2016-09-08 19:11:43

Replying to [comment:28 dkrenn]:
> Does anyone know how to fix this?

See the link in comment 5.


---

Comment by dkrenn created at 2016-09-08 19:21:25

Replying to [comment:29 mkoeppe]:
> Replying to [comment:28 dkrenn]:
> > Does anyone know how to fix this?
> 
> See the link in comment 5.

Yes, I've looked at this before. Can you (or someone else who is knowing something about these stream handlers) include the relevant part(s) of code here in the branch on this ticket?


---

Comment by mkoeppe created at 2016-09-08 20:25:56

Replying to [comment:30 dkrenn]:
>  Can you (or someone else who is knowing something about these stream handlers) include the relevant part(s) of code here in the branch on this ticket?

I've added something based on that code.
Doesn't work yet with the Jupyter notebook, either because there's already a handler installed when `basic_sage_logging_config` is called or something overrides it later. This needs investigating

----
New commits:


---

Comment by novoselt created at 2016-09-09 01:15:51

About SageMathCell - logging is already used there with the relevant file https://github.com/sagemath/sagecell/blob/master/log.py

I don't recall much detail by now, but when I was making things work the problem was that IPython and tornado are trying to install their own loggers as well and perform global initialization if they don't detect one present. Listing all loggers/handlers after startup in a particular environment may be helpful to figuring out what to do.


---

Comment by mkoeppe created at 2017-01-11 00:24:42

Related: https://github.com/ipython/ipykernel/issues/111
----
New commits:


---

Comment by mkoeppe created at 2017-01-11 00:34:49

The upstream fix for the logging problem in Jupyter notebooks appears to be fixed in newer versions of ipykernel. 
#22125 upgrades to 4.5.2, which should be new enough (haven't tested).
Is it possible to add doctests for this?


---

Comment by mkoeppe created at 2020-06-18 21:10:55

Pushed a partial rebase of this branch, dropping a few commits that updated imports and tests throughout the sage library. It will be easier to redo them than to try to rebase them.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
