# Issue 32468: Incremental build sometimes fails with toml / pyparsing

Issue created by migration from https://trac.sagemath.org/ticket/32705

Original creator: vbraun

Original creation time: 2021-10-17 08:09:44

CC:  mkoeppe dimpase

Is that a missing dependency on pyparsing? 

```
Setting up build directory for toml-0.10.2
Finished extraction
No patch files found in ../patches
****************************************************
Host system:
Linux zen 5.14.9-200.fc34.x86_64 #1 SMP Thu Sep 30 11:55:35 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=/usr/bin/gcc
COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/11/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-redhat-linux
Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,objc,obj-c++,ada,go,d,lto --prefix=/usr --mandir=/usr/share/man --infodir=/u
sr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-syst
em-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-h
ash-style=gnu --enable-plugin --enable-initfini-array --with-isl=/builddir/build/BUILD/gcc-11.2.1-20210728/obj-x86_64-redhat-linux/isl-install --enable-offloa
d-targets=nvptx-none --without-cuda-driver --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=i686 --build=x86_64-redhat-linux
Thread model: posix
Supported LTO compression algorithms: zlib zstd
gcc version 11.2.1 20210728 (Red Hat 11.2.1-1) (GCC) 
****************************************************
Uninstalling existing 'toml'
Warning: File '/home/release/Sage/local/var/lib/sage/wheels/toml-0.10.2-py2.py3-none-any.whl' not found
Warning: Directory '/home/release/Sage/local/var/lib/sage/wheels' not found
Running pip-uninstall script for 'toml'
Found existing installation: toml 0.10.2
Uninstalling toml-0.10.2:
  Successfully uninstalled toml-0.10.2
Removing stamp file '/home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/installed/toml-0.10.2'
Installing toml-0.10.2
Processing /home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/toml-0.10.2/src
    Running command python setup.py egg_info
    running egg_info
    creating /tmp/pip-pip-egg-info-594bu2qg/toml.egg-info
    writing /tmp/pip-pip-egg-info-594bu2qg/toml.egg-info/PKG-INFO
    writing dependency_links to /tmp/pip-pip-egg-info-594bu2qg/toml.egg-info/dependency_links.txt
    writing top-level names to /tmp/pip-pip-egg-info-594bu2qg/toml.egg-info/top_level.txt
    writing manifest file '/tmp/pip-pip-egg-info-594bu2qg/toml.egg-info/SOURCES.txt'
    reading manifest file '/tmp/pip-pip-egg-info-594bu2qg/toml.egg-info/SOURCES.txt'
    reading manifest template 'MANIFEST.in'
    adding license file 'LICENSE'
    writing manifest file '/tmp/pip-pip-egg-info-594bu2qg/toml.egg-info/SOURCES.txt'
Building wheels for collected packages: toml
  Building wheel for toml (setup.py): started
  Running command /home/release/Sage/local/var/lib/sage/venv-python3.9/bin/python3 -u -c 'import io, os, sys, setuptools, tokenize; sys.argv[0] = '"'"'/home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/toml-0.10.2/src/setup.py'"'"'; __file__='"'"'/home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/toml-0.10.2/src/setup.py'"'"';f = getattr(tokenize, '"'"'open'"'"', open)(__file__) if os.path.exists(__file__) else io.StringIO('"'"'from setuptools import setup; setup()'"'"');code = f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' bdist_wheel -d /tmp/pip-wheel-fv3bkflk
  Traceback (most recent call last):
    File "<string>", line 1, in <module>
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/toml-0.10.2/src/setup.py", line 11, in <module>
      setup(
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/__init__.py", line 153, in setup
      return distutils.core.setup(**attrs)
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/_distutils/core.py", line 108, in setup
      _setup_distribution = dist = klass(attrs)
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/dist.py", line 450, in __init__
      _Distribution.__init__(
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/_distutils/dist.py", line 293, in __init__
      self.finalize_options()
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/dist.py", line 827, in finalize_options
      for ep in sorted(loaded, key=by_order):
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/dist.py", line 826, in <lambda>
      loaded = map(lambda e: e.load(), filtered)
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 2449, in load
      self.require(*args, **kwargs)
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 2472, in require
      items = working_set.resolve(reqs, env, installer, extras=self.extras)
    File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 772, in resolve
      raise DistributionNotFound(req, requirers)
  pkg_resources.DistributionNotFound: The 'pyparsing>=2.0.2' distribution was not found and is required by packaging
  Building wheel for toml (setup.py): finished with status 'error'
  ERROR: Failed building wheel for toml
```



---

Comment by vbraun created at 2021-10-17 08:32:21

Also found in the log:

```
make[1]: Circular /home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/installed/toml-0.10.2 <- /home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/installed/setuptools_scm-6.3.1 dependency dropped.
```



---

Comment by vbraun created at 2021-10-17 09:00:21

New commits:


---

Comment by vbraun created at 2021-10-17 09:00:21

Changing status from new to needs_review.


---

Comment by vbraun created at 2021-10-17 09:41:04

See also: https://github.com/takluyver/flit/issues/451 Bug: cyclic dependency with tomli==1.2.1 and flit_core==3.2.0

The state of things is definitely broken...

The idea seems to be to have `flit_core` at the bottom of the dependecy tree: https://flit.readthedocs.io/en/latest/bootstrap.html


---

Comment by vbraun created at 2021-10-17 09:41:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-10-17 10:23:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-17 10:38:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2021-10-17 11:00:45

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2021-10-17 11:19:42

Changing priority from major to blocker.


---

Comment by mkoeppe created at 2021-10-17 15:43:54


```
--- a/build/pkgs/flit_core/spkg-install.in
+++ b/build/pkgs/flit_core/spkg-install.in
@@ -1,2 +1,25 @@
+# filt_core is a dependency for setuptools, must install by hand
```

How so?


---

Comment by mkoeppe created at 2021-10-17 15:49:21

The changes on the branch also have nothing to do with the ticket description


---

Comment by mkoeppe created at 2021-10-17 16:16:05

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-10-17 18:06:10

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-10-17 18:06:10

The `toml` package is removed in #32707; after package upgrades, all package have transitioned to using `tomli`.


---

Comment by dimpase created at 2021-10-22 10:02:08

lgtm


---

Comment by dimpase created at 2021-10-22 10:02:08

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-25 15:39:21

Resolution: invalid
