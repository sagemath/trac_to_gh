# Issue 34582: Numerical separators behave inconsistently

Issue created by migration from https://trac.sagemath.org/ticket/34819

Original creator: @io4

Original creation time: 2022-12-03 00:08:36

PEP 515 numerical separators (such as 1_000_000, as introduced in #28490) behave inconsistently, ignoring everything after the first separator upon conversion to a different precision.

Reproduction:

```
    sage: z = 1_0000.000000000000000000000000000000000000
    sage: z # works as expected without the conversion
    10000.000000000000000000000000000000000000
    sage: RR(z)
    1.00000000000000
```


SageMath version 9.5, Release Date: 2022-01-30, Using Python 3.10.6, OS: Ubuntu 22.04.1

Also reproduces on Sage 9.7


---

Comment by @DaveWitteMorris created at 2022-12-03 00:28:47

I suspect the incorrect value arises here (lines 1461-1465) in `src/sage/rings/real_mpfr.pyx`:

```
if isinstance(x, RealLiteral):
    s = (<RealLiteral>x).literal
    base = (<RealLiteral>x).base
    if mpfr_set_str(self.value, str_to_bytes(s), base, parent.rnd):
        self._set(s, base)
```

The [documentation of `mpfr_strtofr`](https://machinecognitis.github.io/Math.Mpfr.Native/html/31cf29bb-b672-5829-a62d-f91e9547eb0c.htm) says "The subject sequence is defined as the longest initial subsequence of the input string, starting with the first non-whitespace character, that is of the expected form." That could explain why everything after the first underscore is ignored.

Several lines later in the same method, I see:

```
s = str(x).replace(' ','').replace('_', '')
```

Maybe we could solve the problem by applying this replacement in the `__init__` method, which is defined later (lines 5669-5685) in the same file:

```
def __init__(self, RealField_class parent, x=0, int base=10):
        <snip docstring>
    RealNumber.__init__(self, parent, x, base)
    if isinstance(x, str):
        self.base = base
        self.literal = x
```

I.e., perhaps we should strip the underscores (and spaces?) before assigning to `self.literal`.


---

Comment by @io4 created at 2022-12-03 06:22:21

Set assignee to @io4.


---

Comment by @io4 created at 2022-12-03 06:22:21

Seems that the purpose of stripping spaces is to faciliate comparation with "NaN+NaN*I" (whose default stringification contains spaces) so that shouldn't be needed.

Removing underscores before setting self.literal does fix the issue.


---

Comment by @io4 created at 2022-12-03 06:33:31

Changing status from new to needs_review.


---

Comment by @io4 created at 2022-12-03 06:33:31

New commits:


---

Comment by mmezzarobba created at 2022-12-07 17:21:16

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2022-12-07 17:21:16

lgtm, thanks for the fix!


---

Comment by vbraun created at 2022-12-14 22:12:10

Resolution: fixed
