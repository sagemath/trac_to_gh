# Issue 14617: Weird error in exponential integral

Issue created by migration from https://trac.sagemath.org/ticket/14821

Original creator: ppurka

Original creation time: 2013-06-26 04:55:22

Assignee: burcin

CC:  nbruin rws

This is so trivial that I am surprised this bug even exists. :) Present since at least sage-5.2 till present versions.

The following integral works

```
H = exp(-10^-1*x)
H.integral(x, 0, 1)

-10*e^(-1/10) + 10
```


But the following integral errors out

```
H = exp(-1.0 * 10^-1*x)
H.integral(x, 0, 1)

Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_19.py", line 10, in <module>
    exec compile(u'open("___code___.py","w").write("# -*- coding: utf-8 -*-\\n" + _support_.preparse_worksheet_cell(base64.b64decode("SCA9IGV4cCgtMS4wKjEwXi0xKngpCkguaW50ZWdyYWwoeCwgMCwgMSk="),globals())+"\\n"); execfile(os.path.abspath("___code___.py"))
  File "", line 1, in <module>
    
  File "/tmp/tmpE7_LAK/___code___.py", line 4, in <module>
    exec compile(u'H.integral(x, _sage_const_0 , _sage_const_1 )
  File "", line 1, in <module>
    
  File "expression.pyx", line 9058, in sage.symbolic.expression.Expression.integral (sage/symbolic/expression.cpp:37991)
  File "/usr/local/src/sage/sage-5.2.server/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py", line 683, in integrate
    return definite_integral(expression, v, a, b)
  File "function.pyx", line 432, in sage.symbolic.function.Function.__call__ (sage/symbolic/function.cpp:4941)
  File "/usr/local/src/sage/sage-5.2.server/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py", line 173, in _eval_
    return integrator(*args)
  File "/usr/local/src/sage/sage-5.2.server/local/lib/python2.7/site-packages/sage/symbolic/integration/external.py", line 21, in maxima_integrator
    result = maxima.sr_integral(expression, v, a, b)
  File "/usr/local/src/sage/sage-5.2.server/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py", line 746, in sr_integral
    raise error
RuntimeError: ECL says: In function GCD, the value of the second argument is
  1.0
which is not of the expected type INTEGER
```



---

Comment by ppurka created at 2013-06-26 04:57:18

Even simpler example.


---

Comment by kcrisman created at 2013-06-26 15:01:11

Almost certainly the same error (see [this sage-support thread](https://groups.google.com/forum/#!topic/sage-support/zpbCOeljVqI):

```
sage: integral(exp(-300.0/(-0.064*x+14.0)),x,0.0,120.0) 
```

and also [this ask.sagemath question](http://ask.sagemath.org/question/2028/def-fx-evaluvates-individually-but-not-inside-plot).

The real underlying issue is the one [at this Maxima bug](https://sourceforge.net/p/maxima/bugs/2510/); basically, we use `keepfloat:true` in Maxima so that things like the integral of `e<sup>(-x</sup>2)` come out right, but this causes things to go wrong in these examples.

And [Nils' comment](https://groups.google.com/forum/#!topic/sage-devel/JZ54xk51F-E) still applies, that it's not clear why something with a float in it should be integrated symbolically (rather than numerically) at all.  I think this is an important point, though I'm not sure how to resolve it in such a ridiculously simple case as yours.  Note that I updated the Maxima bug, and with `keepfloat:false` it is ridiculously accurate as a float.

That said, we should still have a better error message, and ideally just a correct answer.


---

Comment by ppurka created at 2013-06-28 08:50:33

`-` _deleted dumb comment (look at the diff and comment:5 if you want to know why I deleted this :)_ `-`

I saw you mention in the ticket whether it is user error to provide a floating number `-1.0` in the exponential function. The `-1.0` used in the example is just an example. I had a more complicated number there. It really surprised me when the integral failed. Such kind of integrals should never fail.


---

Comment by kcrisman created at 2013-06-28 13:34:52

Wait, I'm confused.  What does the value of the derivative have to do with `keepfloat` and this behavior?  

```
sage: H = exp(-.00001*x)
sage: H.integral(x,0,1)
<same error>
sage: plot(H,(x,0,1),ymin=0)
<essentially constant plot>
```


The reason why Nils and others consider this to be close to user error is that it's not clear what a non-numerical integral of an integral with floats in it should mean.  The indefinite integral would be inaccurate by definition.  Or am I misrepresenting something, Nils?

One possible workaround I see is that we could catch this error and ask the user whether they wanted a numerical integral, or even return a numerical integral.    We haven't seen this in circumstances without exponentials of floats.

Another thing to note is that it's the _endpoints_ being floats which caused `keepfloat` to be necessary.  We could investigate whether we want to only use `keepfloat:true` in those situations.


---

Comment by ppurka created at 2013-06-28 17:29:39

Oh, now that I read the maxima ticket again, I see that sage was forcing keepfloat true  and not the other way around. Sorry for the misleading comments earlier.


---

Comment by rws created at 2014-12-30 17:09:06

Original commands now give `0.6321205588285577` which seems correct so just a doctest is now needed.


---

Comment by paulmasson created at 2016-07-22 20:50:42

Changing priority from major to minor.


---

Comment by paulmasson created at 2016-07-22 20:50:42

Added doctest
----
New commits:


---

Comment by paulmasson created at 2016-07-22 20:50:42

Changing status from new to needs_review.


---

Comment by rws created at 2016-07-23 06:47:14

Your commit is fine and can be considered as reviewed. However, I made the mistake not looking at the second case given in comment:2. This one still crashes. So, to preserve the valuable discussion, instead of closing the ticket and opening a second, I put the second case on top of the ticket description and set "needs work".


---

Comment by rws created at 2016-07-23 06:47:14

Changing status from needs_review to needs_work.


---

Comment by @marcioadames created at 2018-10-22 19:58:59

When running the following cell:



```
u(x,t)=0;
for n in [1..10]:
    u=u+exp(-n^2*(pi^2/4)*t)*sin(n*(pi/4)*x);
plot(u(x,1.80),(0,4))
```


The output presents a sinus like curve with huge amplitude for t = 1.80, 1.79 or 1.78. This cannot be, for the exponential should make the values very small.

It seems to me a problem with the evaluation of the exponential for these  values. What am I missing?


---

Comment by @DaveWitteMorris created at 2020-12-31 05:57:18

Changing status from needs_work to needs_review.


---

Comment by @DaveWitteMorris created at 2020-12-31 05:57:18

Changing keywords from "" to "integration, maxima".


---

Comment by @DaveWitteMorris created at 2020-12-31 05:57:18

The `RuntimeError` at the start of the ticket description (and mentioned in comment:13) is gone:

```
sage: integral(exp(-300.0/(-0.064*x+14.0)),x,0.0,120.0)                                        
4.62770039817000e-9
```

I added a doctest for this and rebased on 9.3b5, so I hope we can close this old ticket.

The issue in comment:14 is invalid. The plot has an amplitude of approximately 0.12, which is correct.  The only reason it looks large in the picture is that the y-axis has been scaled to fit the graph.
----
New commits:


---

Comment by tscrim created at 2021-01-05 01:38:24

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-01-05 01:38:24

I believe all issues raised in this ticket have been addressed.


---

Comment by @DaveWitteMorris created at 2021-01-05 22:31:26

Thanks for doing the review!


---

Comment by vbraun created at 2021-01-24 10:36:54

Resolution: fixed
