# Issue 30014: ExtPowerFreeModule, ExtPowerDualFreeModule: Simplify _repr_

Issue created by migration from https://trac.sagemath.org/ticket/30251

Original creator: mkoeppe

Original creation time: 2020-07-30 02:17:13

CC:  egourgoulhon tscrim @mjungmath

... using `ZZ.ordinal_str()`


---

Comment by mkoeppe created at 2020-07-30 02:18:07

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-30 02:18:07

New commits:


---

Comment by egourgoulhon created at 2020-07-30 12:16:37

Nice simplification! To secure it, one should probably perform

```diff
- self._degree = degree
+ self._degree = ZZ(degree)
```

in the `__init__` method of `ExtPowerFreeModule` and `ExtPowerDualFreeModule`.


---

Comment by mkoeppe created at 2020-07-30 15:35:39

Good idea!


---

Comment by git created at 2020-07-30 15:40:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-30 16:12:02

(pushed to wrong ticket)


---

Comment by git created at 2020-07-30 16:12:48

(repaired push to wrong ticket)


---

Comment by @mjungmath created at 2020-07-30 16:18:03

This is just a general comment not only related to this ticket (I picked this ticket randomly), but worth to emphasize once again: the deeper you dig and the more comprehensive your modifications are in the `tensor` module, the more likely it may corrupt the manifolds code, as there is a _very_ strong dependence. Please be aware of that fact. I don't think it will go so far, but it would be very sad if the `manifolds` module would be unusable in the upcoming version of Sage.

Furthermore, since the `manifolds` module is similarly structured, it is very likely that analogous improvements can be applied there, too.


---

Comment by mkoeppe created at 2020-07-30 17:01:02

Replying to [comment:8 gh-mjungmath]:
> the deeper you dig and the more comprehensive your modifications are in the `tensor` module, the more likely it may corrupt the manifolds code, as there is a _very_ strong dependence.

Thanks. Well, that's why we have doctests and peer review. I run the doctests also in the manifolds module -- and the patchbot runs all doctests.

> Furthermore, since the `manifolds` module is similarly structured, it is very likely that analogous improvements can be applied there, too.

Absolutely. I'll hope to do that when I have learned more about the manifolds code (I hope to be using this code soon for some of my research), or when it becomes necessary because of changes in the tensor modules code. Do feel free to make these changes if you would like them earlier.


---

Comment by egourgoulhon created at 2020-07-30 18:02:51

Replying to [comment:8 gh-mjungmath]:
> This is just a general comment not only related to this ticket (I picked this ticket randomly), but worth to emphasize once again: the deeper you dig and the more comprehensive your modifications are in the `tensor` module, the more likely it may corrupt the manifolds code, as there is a _very_ strong dependence. Please be aware of that fact. I don't think it will go so far, but it would be very sad if the `manifolds` module would be unusable in the upcoming version of Sage.


Thanks for expressing your concern. However, as Matthias pointed out in his reply (comment:9), doctests shall prevent breakage in the manifold part. It remains true that doctests are not exhaustive and it will be more satisfactory to have a more comprehensive test suite, albeit more CPU consuming. Such a suite could be derived from the [manifold examples page](https://sagemanifolds.obspm.fr/examples.html). I guess one shall first turn these Jupyter notebooks into rst files, via the export menu. When there is a significant change in the manifold/tensor code, I usually run by hand some selected examples from the above page, typically, the [S2 sphere](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_sphere_S2.ipynb), the [S3 one](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_sphere_S3_Hopf.ipynb), the [Kerr spacetime](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb) (good test of parallel computation of the Riemann tensor) and the [anti-de Sitter space](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_anti_de_Sitter.ipynb). An automated test suite would be of great help in this respect. 

Another concern one might have is performance, which is not tracked by doctests, but could be in the test suite (note that there is a total CPU time measurement in the Kerr notebook mentioned above). 

That being said, I think the changes in the `tensor` modules proposed by Matthias are great improvements. In particular, they shall make `FiniteRankFreeModule` usable for other purposes than tensor field computations on smooth manifolds. 

> Furthermore, since the `manifolds` module is similarly structured, it is very likely that analogous improvements can be applied there, too.

Indeed!


---

Comment by mkoeppe created at 2020-07-30 18:16:38

Replying to [comment:10 egourgoulhon]:
> It remains true that doctests are not exhaustive and it will be more satisfactory to have a more comprehensive test suite, albeit more CPU consuming. Such a suite could be derived from the [manifold examples page](https://sagemanifolds.obspm.fr/examples.html). I guess one shall first turn these Jupyter notebooks into rst files, via the export menu. 

+1. Could they possibly be added as thematic tutorials in the main sage tree, or are there technical limitations that would prevent that?

> Another concern one might have is performance, which is not tracked by doctests, but could be in the test suite (note that there is a total CPU time measurement in the Kerr notebook mentioned above). 

Yes, this is an important point - and one for which Sage unfortunately does not have a very good solution. Sure - we notice performance regressions sometimes when doctests suddenly time out. But obviously doctests are not very well suited as benchmarks. (One might think about "# optional - benchmark" annotations though...)

(By the way, some of the doctests in sage.manifolds probably should be marked "long" -- I frequently see them time out in the automated tests on [GitHub](GitHub) actions - see for example https://github.com/sagemath/sage/runs/910575697?check_suite_focus=true)


---

Comment by @mjungmath created at 2020-07-30 18:23:30

Thanks for pointing this out in such detail, Eric. I was not sure how "deep" the doctesting of the patchbot actually goes.

> That being said, I think the changes in the tensor modules proposed by Matthias are great improvements. In particular, they shall make FiniteRankFreeModule usable for other purposes than tensor field computations on smooth manifolds. 

I didn't mean to be dismissive, sorry. I think the modifications and the effort by Matthias are extremely beneficial to the project. :)


---

Comment by mkoeppe created at 2020-07-30 18:24:35

No worries!


---

Comment by egourgoulhon created at 2020-07-30 21:06:33

Good to go. Thanks!


---

Comment by egourgoulhon created at 2020-07-30 21:06:33

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-30 21:07:38

Thank you!


---

Comment by egourgoulhon created at 2020-07-30 21:29:57

Replying to [comment:11 mkoeppe]:
> Replying to [comment:10 egourgoulhon]:
> > It remains true that doctests are not exhaustive and it will be more satisfactory to have a more comprehensive test suite, albeit more CPU consuming. Such a suite could be derived from the [manifold examples page](https://sagemanifolds.obspm.fr/examples.html). I guess one shall first turn these Jupyter notebooks into rst files, via the export menu. 
> 
> +1. Could they possibly be added as thematic tutorials in the main sage tree, or are there technical limitations that would prevent that?

The large CPU times could prevent to add these examples to the thematic tutorials, which are doctested at each run of `make ptestlong`. For instance, if you look at the last cell of the [Kerr notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), you see that it takes about 6 min when running in parallel on 8 processes. NB: most of this CPU time is not spent in the actual tensor calculations, but in the simplifications of the involved symbolic expressions. 
> 
> > Another concern one might have is performance, which is not tracked by doctests, but could be in the test suite (note that there is a total CPU time measurement in the Kerr notebook mentioned above). 
> 
> Yes, this is an important point - and one for which Sage unfortunately does not have a very good solution. Sure - we notice performance regressions sometimes when doctests suddenly time out. But obviously doctests are not very well suited as benchmarks. (One might think about "# optional - benchmark" annotations though...)
> 
> (By the way, some of the doctests in sage.manifolds probably should be marked "long" -- I frequently see them time out in the automated tests on [GitHub](GitHub) actions - see for example https://github.com/sagemath/sage/runs/910575697?check_suite_focus=true)

Yes, we should open a ticket for this.


---

Comment by vbraun created at 2020-08-14 22:23:11

Resolution: fixed


---

Comment by slelievre created at 2020-08-14 23:26:35

Replying to [comment:10 egourgoulhon]:
>
> Such a suite could be derived from the [manifold examples page](https://sagemanifolds.obspm.fr/examples.html). I guess one shall first turn these Jupyter notebooks into rst files, via the export menu. 

Or use [nbval](https://pypi.org/project/nbval/).


---

Comment by egourgoulhon created at 2020-08-17 09:40:21

Replying to [comment:18 slelievre]:
> Replying to [comment:10 egourgoulhon]:
> >
> > Such a suite could be derived from the [manifold examples page](https://sagemanifolds.obspm.fr/examples.html). I guess one shall first turn these Jupyter notebooks into rst files, via the export menu. 
> 
> Or use [nbval](https://pypi.org/project/nbval/).

Thank you Samuel for the tip! I was not aware of nbval.
