# Issue 28994: add intersphinx mapping for Scipy

Issue created by migration from https://trac.sagemath.org/ticket/29231

Original creator: @mwageringel

Original creation time: 2020-02-21 13:51:29

CC:  embray jhpalmieri

This ticket adds an intersphinx mapping for Sphinx to resolve hyperlinks to the Scipy documentation.

With this change, Sphinx fetches the Scipy inventory file `objects.inv` from https://docs.scipy.org/doc/scipy/reference/ during the docbuild. (If this fails for some reason, the docbuild will also fail.)


---

Comment by @mwageringel created at 2020-02-21 13:56:42

This merges cleanly with #17405.

If this gets accepted, the same could be applied to numpy.
----
New commits:


---

Comment by @mwageringel created at 2020-02-21 13:56:42

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-02-21 14:48:09

Sage should in principle build without an internet connection, so I am not in favor of this approach. (“If this fails for some reason, the docbuild will also fail.”)


---

Comment by git created at 2020-02-21 18:41:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-02-21 18:49:33

You are right, that is a problem. It is possible to set a local inventory file as a fallback*. For Python, this was done by adding `src/doc/common/python3.inv` to the repository. However, I do not really like the idea of adding another binary file to the repository that would need to be updated manually.

Instead, I have configured intersphinx to use the `python3.inv` as fallback for Scipy. This means that cross-links for Scipy are not resolved when the fallback is used, as they are not present in the Python inventory file, but the documentation build still succeeds.

With these changes applied, I have successfully built the documentation without internet access.

----
*For reference, see [Multiple target for the inventory](https://www.sphinx-doc.org/en/master/usage/extensions/intersphinx.html#confval-intersphinx_mapping).


---

Comment by vdelecroix created at 2020-02-22 08:15:03

Replying to [comment:3 jhpalmieri]:
> Sage should in principle build without an internet connection, so I am not in favor of this approach. (“If this fails for some reason, the docbuild will also fail.”)

+1.

Though, it would be great that something like `:obj:`scipy:scipy.integrate.ode`` in Sage documentation resolves correctly (either pointing to the local documentation or online). `pplpy` intersphinx relies on the fact that its documentation is built and installed. This is implemented in `build/pkgs/pplpy/spkg-postinst`

```
$ cat build/pkgs/pplpy/spkg-postinst 
if [[ "$SAGE_SPKG_INSTALL_DOCS" != no ]] ; then
    # Compile pplpy's documentation
    cd src
    cd docs
    $MAKE html

    # install pplpy's documentation
    PPLPY_DOCS=$SAGE_SHARE/doc/pplpy
    mkdir -p $PPLPY_DOCS
    cp -r build/html/*  $PPLPY_DOCS
fi
```

Though, if we start allowing for `pplpy` to come from the system the `intersphinx` will be broken and that also needs a solution.


---

Comment by @mwageringel created at 2020-02-22 10:29:02

Replying to [comment:6 vdelecroix]:
> Though, if we start allowing for `pplpy` to come from the system the `intersphinx` will be broken and that also needs a solution.

I would suggest to change the pplpy intersphinx mapping to point to the online version of the pplpy documentation instead of the local version. The local inventory file can be used as fallback (and the dummy file as secondary fallback). This ensures that cross-links (to the online version) can still be resolved correctly if either an internet connection or the local pplpy documentation exists during the docbuild.

Admittedly, it might be better if the cross-links resolved to the local documentation in the case when the local objects.inv is used, and to the online documentation if the online version is used, but there does not seem to be an easy way to configure this, as far as I understand.


---

Comment by git created at 2020-02-24 17:52:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-02-24 17:58:23

I have just made the change for `pplpy` as well, so Intersphinx gets the online version of the `objects.inv` file and uses the local version as fallback. I have successfully built the documentation without internet access. There do not seem to be any `pplpy` cross-links, so far. The dochtml.log shows that Intersphinx correctly finds the fallback, though.


---

Comment by git created at 2020-02-25 17:45:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-02-26 08:43:31

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2020-02-26 08:43:31

This proposal is not acceptable. Building Sage should not trigger any internet connection beyond downloading packages (that can be done prior to the build with `sage -d`).

One option would actually be to package the various inventories. But that look tedious to maintain.

Do you know what other projects do?


---

Comment by @mwageringel created at 2020-02-26 13:16:44

Other projects like [numpy](https://github.com/numpy/numpy/blob/cef4dc9d91d980c3df816de00154a22e96439fa4/doc/source/conf.py#L239-L243), [scipy](https://github.com/scipy/scipy/blob/04c59ef48e66675f9902e88163506f3843fccdfb/doc/source/conf.py#L326-L331) and [matplotlib](https://github.com/matplotlib/matplotlib/blob/5cb84e070bcb4ebc5ddd5b1c8e5e8a1eccec5863/doc/conf.py#L110-L119) all use the online versions of inventory files. None of them even provides a fallback for the case that the download fails. This also means we cannot follow the `pplpy` approach of compiling the documentation for those packages ourselves, as it would connect to the internet.

I am not sure why triggering an internet connection is a problem, as long as download failures are handled gracefully. In the worst case, one ends up without cross-references, which is exactly what we have now.

I would like to avoid extra maintenance burdens that would be caused by packaging the inventory files. How about making the download of inventory files optional, similar to the `--no-plot` docbuild option? It would be nice then if this was used for the documentation on our website, at least, which is probably where most people read the Sage documentation.


---

Comment by vdelecroix created at 2020-02-26 14:24:55

Replying to [comment:12 gh-mwageringel]:
> Other projects like [numpy](https://github.com/numpy/numpy/blob/cef4dc9d91d980c3df816de00154a22e96439fa4/doc/source/conf.py#L239-L243), [scipy](https://github.com/scipy/scipy/blob/04c59ef48e66675f9902e88163506f3843fccdfb/doc/source/conf.py#L326-L331) and [matplotlib](https://github.com/matplotlib/matplotlib/blob/5cb84e070bcb4ebc5ddd5b1c8e5e8a1eccec5863/doc/conf.py#L110-L119) all use the online versions of inventory files. None of them even provides a fallback for the case that the download fails. This also means we cannot follow the `pplpy` approach of compiling the documentation for those packages ourselves, as it would connect to the internet.
> 
> I am not sure why triggering an internet connection is a problem, as long as download failures are handled gracefully. In the worst case, one ends up without cross-references, which is exactly what we have now.

Because a user do not expect `make build` to trigger an internet connection. I do not quite agree with the term "handled gracefully" since you end up with a different documentation.
 
> I would like to avoid extra maintenance burdens that would be caused by packaging the inventory files.

+1. It makes no sense to have these files as packages. It will be outdated very soon.

> How about making the download of inventory files optional, similar to the `--no-plot` docbuild option? It would be nice then if this was used for the documentation on our website, at least, which is probably where most people read the Sage documentation.

Could you make a detailed proposal on sage-devel? This kind of changes in the build system have to go through a common agreement by devs.


---

Comment by @mwageringel created at 2020-02-26 19:50:37

Here is the thread on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/h3jkMGhKjBs). There is also a very similar ticket #27164.


---

Comment by jhpalmieri created at 2020-02-26 20:01:44

There is also #27495, which is somewhat related.


---

Comment by embray created at 2021-02-26 11:33:32

What's the status of this?  There has been discussion of this recently again, and it would be good to do at least _something_ about it, as I need this for #31404 as well.

I think currently this looks good--one thing I might change is for the dummy fallback see if the docs are installed locally first (e.g. if pplpy was installed with `SAGE_SPKG_INSTALL_DOCS`, then we can find its docs in `SAGE_SHARE/doc/pplpy`).

I think this is better than nothing for now.


---

Comment by @mwageringel created at 2021-03-05 18:14:33

I think the main concern voiced on the mailing list discussion linked in comment:14 is that intersphinx eagerly tries to connect to the internet, which may be undesirable for some people in some situations. To avoid this, Sage could by default ask for permission to connect to the internet to download missing files, but that would be quite a complex change to the build system.


---

Comment by mkoeppe created at 2021-03-05 18:31:51

We should just make this optional, enabled by another `SAGE_DOC_....` option.
When building the version for the website (see also #31415), we would enable the option.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
