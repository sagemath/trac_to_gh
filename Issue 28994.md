# Issue 28994: add intersphinx mapping for Scipy

archive/issues_028994.json:
```json
{
    "body": "CC:  @embray @jhpalmieri\n\nThis ticket adds an intersphinx mapping for Sphinx to resolve hyperlinks to the Scipy documentation.\n\nWith this change, Sphinx fetches the Scipy inventory file `objects.inv` from https://docs.scipy.org/doc/scipy/reference/ during the docbuild. (If this fails for some reason, the docbuild will also fail.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/29231\n\n",
    "created_at": "2020-02-21T13:51:29Z",
    "labels": [
        "component: documentation"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "add intersphinx mapping for Scipy",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28994",
    "user": "https://github.com/mwageringel"
}
```
CC:  @embray @jhpalmieri

This ticket adds an intersphinx mapping for Sphinx to resolve hyperlinks to the Scipy documentation.

With this change, Sphinx fetches the Scipy inventory file `objects.inv` from https://docs.scipy.org/doc/scipy/reference/ during the docbuild. (If this fails for some reason, the docbuild will also fail.)

Issue created by migration from https://trac.sagemath.org/ticket/29231





---

archive/issue_comments_409976.json:
```json
{
    "body": "This merges cleanly with #17405.\n\nIf this gets accepted, the same could be applied to numpy.\n----\nNew commits:",
    "created_at": "2020-02-21T13:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409976",
    "user": "https://github.com/mwageringel"
}
```

This merges cleanly with #17405.

If this gets accepted, the same could be applied to numpy.
----
New commits:



---

archive/issue_comments_409977.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-21T13:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409977",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409978.json:
```json
{
    "body": "Sage should in principle build without an internet connection, so I am not in favor of this approach. (\u201cIf this fails for some reason, the docbuild will also fail.\u201d)",
    "created_at": "2020-02-21T14:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409978",
    "user": "https://github.com/jhpalmieri"
}
```

Sage should in principle build without an internet connection, so I am not in favor of this approach. (“If this fails for some reason, the docbuild will also fail.”)



---

archive/issue_comments_409979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-21T18:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409979",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409980.json:
```json
{
    "body": "You are right, that is a problem. It is possible to set a local inventory file as a fallback*. For Python, this was done by adding `src/doc/common/python3.inv` to the repository. However, I do not really like the idea of adding another binary file to the repository that would need to be updated manually.\n\nInstead, I have configured intersphinx to use the `python3.inv` as fallback for Scipy. This means that cross-links for Scipy are not resolved when the fallback is used, as they are not present in the Python inventory file, but the documentation build still succeeds.\n\nWith these changes applied, I have successfully built the documentation without internet access.\n\n----\n*For reference, see [Multiple target for the inventory](https://www.sphinx-doc.org/en/master/usage/extensions/intersphinx.html#confval-intersphinx_mapping).",
    "created_at": "2020-02-21T18:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409980",
    "user": "https://github.com/mwageringel"
}
```

You are right, that is a problem. It is possible to set a local inventory file as a fallback*. For Python, this was done by adding `src/doc/common/python3.inv` to the repository. However, I do not really like the idea of adding another binary file to the repository that would need to be updated manually.

Instead, I have configured intersphinx to use the `python3.inv` as fallback for Scipy. This means that cross-links for Scipy are not resolved when the fallback is used, as they are not present in the Python inventory file, but the documentation build still succeeds.

With these changes applied, I have successfully built the documentation without internet access.

----
*For reference, see [Multiple target for the inventory](https://www.sphinx-doc.org/en/master/usage/extensions/intersphinx.html#confval-intersphinx_mapping).



---

archive/issue_comments_409981.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n> Sage should in principle build without an internet connection, so I am not in favor of this approach. (\u201cIf this fails for some reason, the docbuild will also fail.\u201d)\n\n+1.\n\nThough, it would be great that something like `:obj:`scipy:scipy.integrate.ode`` in Sage documentation resolves correctly (either pointing to the local documentation or online). `pplpy` intersphinx relies on the fact that its documentation is built and installed. This is implemented in `build/pkgs/pplpy/spkg-postinst`\n\n```\n$ cat build/pkgs/pplpy/spkg-postinst \nif [[ \"$SAGE_SPKG_INSTALL_DOCS\" != no ]] ; then\n    # Compile pplpy's documentation\n    cd src\n    cd docs\n    $MAKE html\n\n    # install pplpy's documentation\n    PPLPY_DOCS=$SAGE_SHARE/doc/pplpy\n    mkdir -p $PPLPY_DOCS\n    cp -r build/html/*  $PPLPY_DOCS\nfi\n```\n\nThough, if we start allowing for `pplpy` to come from the system the `intersphinx` will be broken and that also needs a solution.",
    "created_at": "2020-02-22T08:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409981",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:3 jhpalmieri]:
> Sage should in principle build without an internet connection, so I am not in favor of this approach. (“If this fails for some reason, the docbuild will also fail.”)

+1.

Though, it would be great that something like `:obj:`scipy:scipy.integrate.ode`` in Sage documentation resolves correctly (either pointing to the local documentation or online). `pplpy` intersphinx relies on the fact that its documentation is built and installed. This is implemented in `build/pkgs/pplpy/spkg-postinst`

```
$ cat build/pkgs/pplpy/spkg-postinst 
if [[ "$SAGE_SPKG_INSTALL_DOCS" != no ]] ; then
    # Compile pplpy's documentation
    cd src
    cd docs
    $MAKE html

    # install pplpy's documentation
    PPLPY_DOCS=$SAGE_SHARE/doc/pplpy
    mkdir -p $PPLPY_DOCS
    cp -r build/html/*  $PPLPY_DOCS
fi
```

Though, if we start allowing for `pplpy` to come from the system the `intersphinx` will be broken and that also needs a solution.



---

archive/issue_comments_409982.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> Though, if we start allowing for `pplpy` to come from the system the `intersphinx` will be broken and that also needs a solution.\n\nI would suggest to change the pplpy intersphinx mapping to point to the online version of the pplpy documentation instead of the local version. The local inventory file can be used as fallback (and the dummy file as secondary fallback). This ensures that cross-links (to the online version) can still be resolved correctly if either an internet connection or the local pplpy documentation exists during the docbuild.\n\nAdmittedly, it might be better if the cross-links resolved to the local documentation in the case when the local objects.inv is used, and to the online documentation if the online version is used, but there does not seem to be an easy way to configure this, as far as I understand.",
    "created_at": "2020-02-22T10:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409982",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:6 vdelecroix]:
> Though, if we start allowing for `pplpy` to come from the system the `intersphinx` will be broken and that also needs a solution.

I would suggest to change the pplpy intersphinx mapping to point to the online version of the pplpy documentation instead of the local version. The local inventory file can be used as fallback (and the dummy file as secondary fallback). This ensures that cross-links (to the online version) can still be resolved correctly if either an internet connection or the local pplpy documentation exists during the docbuild.

Admittedly, it might be better if the cross-links resolved to the local documentation in the case when the local objects.inv is used, and to the online documentation if the online version is used, but there does not seem to be an easy way to configure this, as far as I understand.



---

archive/issue_comments_409983.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-24T17:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409983",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409984.json:
```json
{
    "body": "I have just made the change for `pplpy` as well, so Intersphinx gets the online version of the `objects.inv` file and uses the local version as fallback. I have successfully built the documentation without internet access. There do not seem to be any `pplpy` cross-links, so far. The dochtml.log shows that Intersphinx correctly finds the fallback, though.",
    "created_at": "2020-02-24T17:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409984",
    "user": "https://github.com/mwageringel"
}
```

I have just made the change for `pplpy` as well, so Intersphinx gets the online version of the `objects.inv` file and uses the local version as fallback. I have successfully built the documentation without internet access. There do not seem to be any `pplpy` cross-links, so far. The dochtml.log shows that Intersphinx correctly finds the fallback, though.



---

archive/issue_comments_409985.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-25T17:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409985",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409986.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-02-26T08:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409986",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_409987.json:
```json
{
    "body": "This proposal is not acceptable. Building Sage should not trigger any internet connection beyond downloading packages (that can be done prior to the build with `sage -d`).\n\nOne option would actually be to package the various inventories. But that look tedious to maintain.\n\nDo you know what other projects do?",
    "created_at": "2020-02-26T08:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409987",
    "user": "https://github.com/videlec"
}
```

This proposal is not acceptable. Building Sage should not trigger any internet connection beyond downloading packages (that can be done prior to the build with `sage -d`).

One option would actually be to package the various inventories. But that look tedious to maintain.

Do you know what other projects do?



---

archive/issue_comments_409988.json:
```json
{
    "body": "Other projects like [numpy](https://github.com/numpy/numpy/blob/cef4dc9d91d980c3df816de00154a22e96439fa4/doc/source/conf.py#L239-L243), [scipy](https://github.com/scipy/scipy/blob/04c59ef48e66675f9902e88163506f3843fccdfb/doc/source/conf.py#L326-L331) and [matplotlib](https://github.com/matplotlib/matplotlib/blob/5cb84e070bcb4ebc5ddd5b1c8e5e8a1eccec5863/doc/conf.py#L110-L119) all use the online versions of inventory files. None of them even provides a fallback for the case that the download fails. This also means we cannot follow the `pplpy` approach of compiling the documentation for those packages ourselves, as it would connect to the internet.\n\nI am not sure why triggering an internet connection is a problem, as long as download failures are handled gracefully. In the worst case, one ends up without cross-references, which is exactly what we have now.\n\nI would like to avoid extra maintenance burdens that would be caused by packaging the inventory files. How about making the download of inventory files optional, similar to the `--no-plot` docbuild option? It would be nice then if this was used for the documentation on our website, at least, which is probably where most people read the Sage documentation.",
    "created_at": "2020-02-26T13:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409988",
    "user": "https://github.com/mwageringel"
}
```

Other projects like [numpy](https://github.com/numpy/numpy/blob/cef4dc9d91d980c3df816de00154a22e96439fa4/doc/source/conf.py#L239-L243), [scipy](https://github.com/scipy/scipy/blob/04c59ef48e66675f9902e88163506f3843fccdfb/doc/source/conf.py#L326-L331) and [matplotlib](https://github.com/matplotlib/matplotlib/blob/5cb84e070bcb4ebc5ddd5b1c8e5e8a1eccec5863/doc/conf.py#L110-L119) all use the online versions of inventory files. None of them even provides a fallback for the case that the download fails. This also means we cannot follow the `pplpy` approach of compiling the documentation for those packages ourselves, as it would connect to the internet.

I am not sure why triggering an internet connection is a problem, as long as download failures are handled gracefully. In the worst case, one ends up without cross-references, which is exactly what we have now.

I would like to avoid extra maintenance burdens that would be caused by packaging the inventory files. How about making the download of inventory files optional, similar to the `--no-plot` docbuild option? It would be nice then if this was used for the documentation on our website, at least, which is probably where most people read the Sage documentation.



---

archive/issue_comments_409989.json:
```json
{
    "body": "Replying to [comment:12 gh-mwageringel]:\n> Other projects like [numpy](https://github.com/numpy/numpy/blob/cef4dc9d91d980c3df816de00154a22e96439fa4/doc/source/conf.py#L239-L243), [scipy](https://github.com/scipy/scipy/blob/04c59ef48e66675f9902e88163506f3843fccdfb/doc/source/conf.py#L326-L331) and [matplotlib](https://github.com/matplotlib/matplotlib/blob/5cb84e070bcb4ebc5ddd5b1c8e5e8a1eccec5863/doc/conf.py#L110-L119) all use the online versions of inventory files. None of them even provides a fallback for the case that the download fails. This also means we cannot follow the `pplpy` approach of compiling the documentation for those packages ourselves, as it would connect to the internet.\n> \n> I am not sure why triggering an internet connection is a problem, as long as download failures are handled gracefully. In the worst case, one ends up without cross-references, which is exactly what we have now.\n\nBecause a user do not expect `make build` to trigger an internet connection. I do not quite agree with the term \"handled gracefully\" since you end up with a different documentation.\n \n> I would like to avoid extra maintenance burdens that would be caused by packaging the inventory files.\n\n+1. It makes no sense to have these files as packages. It will be outdated very soon.\n\n> How about making the download of inventory files optional, similar to the `--no-plot` docbuild option? It would be nice then if this was used for the documentation on our website, at least, which is probably where most people read the Sage documentation.\n\nCould you make a detailed proposal on sage-devel? This kind of changes in the build system have to go through a common agreement by devs.",
    "created_at": "2020-02-26T14:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409989",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:12 gh-mwageringel]:
> Other projects like [numpy](https://github.com/numpy/numpy/blob/cef4dc9d91d980c3df816de00154a22e96439fa4/doc/source/conf.py#L239-L243), [scipy](https://github.com/scipy/scipy/blob/04c59ef48e66675f9902e88163506f3843fccdfb/doc/source/conf.py#L326-L331) and [matplotlib](https://github.com/matplotlib/matplotlib/blob/5cb84e070bcb4ebc5ddd5b1c8e5e8a1eccec5863/doc/conf.py#L110-L119) all use the online versions of inventory files. None of them even provides a fallback for the case that the download fails. This also means we cannot follow the `pplpy` approach of compiling the documentation for those packages ourselves, as it would connect to the internet.
> 
> I am not sure why triggering an internet connection is a problem, as long as download failures are handled gracefully. In the worst case, one ends up without cross-references, which is exactly what we have now.

Because a user do not expect `make build` to trigger an internet connection. I do not quite agree with the term "handled gracefully" since you end up with a different documentation.
 
> I would like to avoid extra maintenance burdens that would be caused by packaging the inventory files.

+1. It makes no sense to have these files as packages. It will be outdated very soon.

> How about making the download of inventory files optional, similar to the `--no-plot` docbuild option? It would be nice then if this was used for the documentation on our website, at least, which is probably where most people read the Sage documentation.

Could you make a detailed proposal on sage-devel? This kind of changes in the build system have to go through a common agreement by devs.



---

archive/issue_comments_409990.json:
```json
{
    "body": "Here is the thread on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/h3jkMGhKjBs). There is also a very similar ticket #27164.",
    "created_at": "2020-02-26T19:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409990",
    "user": "https://github.com/mwageringel"
}
```

Here is the thread on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/h3jkMGhKjBs). There is also a very similar ticket #27164.



---

archive/issue_comments_409991.json:
```json
{
    "body": "There is also #27495, which is somewhat related.",
    "created_at": "2020-02-26T20:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409991",
    "user": "https://github.com/jhpalmieri"
}
```

There is also #27495, which is somewhat related.



---

archive/issue_comments_409992.json:
```json
{
    "body": "What's the status of this?  There has been discussion of this recently again, and it would be good to do at least *something* about it, as I need this for #31404 as well.\n\nI think currently this looks good--one thing I might change is for the dummy fallback see if the docs are installed locally first (e.g. if pplpy was installed with `SAGE_SPKG_INSTALL_DOCS`, then we can find its docs in `SAGE_SHARE/doc/pplpy`).\n\nI think this is better than nothing for now.",
    "created_at": "2021-02-26T11:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409992",
    "user": "https://github.com/embray"
}
```

What's the status of this?  There has been discussion of this recently again, and it would be good to do at least *something* about it, as I need this for #31404 as well.

I think currently this looks good--one thing I might change is for the dummy fallback see if the docs are installed locally first (e.g. if pplpy was installed with `SAGE_SPKG_INSTALL_DOCS`, then we can find its docs in `SAGE_SHARE/doc/pplpy`).

I think this is better than nothing for now.



---

archive/issue_comments_409993.json:
```json
{
    "body": "I think the main concern voiced on the mailing list discussion linked in comment:14 is that intersphinx eagerly tries to connect to the internet, which may be undesirable for some people in some situations. To avoid this, Sage could by default ask for permission to connect to the internet to download missing files, but that would be quite a complex change to the build system.",
    "created_at": "2021-03-05T18:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409993",
    "user": "https://github.com/mwageringel"
}
```

I think the main concern voiced on the mailing list discussion linked in comment:14 is that intersphinx eagerly tries to connect to the internet, which may be undesirable for some people in some situations. To avoid this, Sage could by default ask for permission to connect to the internet to download missing files, but that would be quite a complex change to the build system.



---

archive/issue_comments_409994.json:
```json
{
    "body": "We should just make this optional, enabled by another `SAGE_DOC_....` option.\nWhen building the version for the website (see also #31415), we would enable the option.",
    "created_at": "2021-03-05T18:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409994",
    "user": "https://github.com/mkoeppe"
}
```

We should just make this optional, enabled by another `SAGE_DOC_....` option.
When building the version for the website (see also #31415), we would enable the option.



---

archive/issue_comments_409995.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409995",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_409996.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409996",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_409997.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28994#issuecomment-409997",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
