# Issue 11748: Sympow needs to specify -ffp-contract=on

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2011-10-13 20:09:10

Assignee: tbd

CC:  leif

See #11226 and [http://boxen.math.washington.edu/home/jdemeyer/spkg/sympow-1.018.1.p9.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/sympow-1.018.1.p9.spkg).

For sympow, we need to use the compiler option {{{-ffp-contract=on
}}} (if the compiler supports it).


---

Comment by jdemeyer created at 2011-10-17 20:00:31

Not reported upstream because *upstream project is dead* (we should probably have this as an option in the "Upstream" field).


---

Comment by jdemeyer created at 2011-10-19 21:08:19

Tested on Core2, pentium4, ia64 with fairly recent versions of gcc.


---

Comment by jdemeyer created at 2011-10-19 21:08:19

Changing status from new to needs_review.


---

Comment by Snark created at 2011-10-29 18:57:17

sympow-1.018.1.p10.spkg compiles on my ARM box.


---

Comment by leif created at 2011-10-31 03:14:04

With GCC versions prior to 4.6, you might have to specify e.g. `-fno-fused-madd` instead on some platforms, so you could also check whether that's supported and use it in case it is.

[Although it's not immediately clear to me whether that's desirable at all; with (fused) multiply-accumulate, the results are _more_ accurate than without.  They'll of course frequently differ slightly from what you get _with_ strict IEEE 754 compliance.]




`spkg-install`  should use `$MAKE` instead of `make`.

`$SAGE_LOCAL` should be quoted in the generated script.

There are a few typos in the comments, e.g. _"default mode of operat*ion*"_ and   _"prec*is*ion"_ (instead of _"precion"_).


---

Comment by leif created at 2011-10-31 03:29:22

P.S.:

```
Linux silius 2.6.32.46-0.3-ppc64 #1 SMP 2011-09-29 17:49:31 +0200 ppc64 ppc64 ppc64 GNU/Linux
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
Target: powerpc64-unknown-linux-gnu
Configured with: ../gcc-4.4.6/configure -v --prefix=/home/leif/local/silius/ --program-suffix=-4.4.6 --enable-languages=c,c++,fortran --enable-plugins --enable-lto --enable-gold --enable-version-specific-runtime-libs --with-cpu=power7 --with-tune=power7 --with-gmp=/home/leif/local/silius/ --with-mpfr=/home/leif/local/silius/ --with-mpc=/home/leif/local/silius/
Thread model: posix
gcc version 4.4.6 (GCC) 
****************************************************
patching file Configure
patching file generate.c
patching file fpu.c
The double precision of your FPU is 105 bits.
The Quad Double library used by SYMPOW assumes IEEE-754 double precision
numbers with exactly 53 bits in the mantissa (64 bits in total).

Unfortunately, we currently have no workaround for your system.
Running SYMPOW will surely fail. Please report this problem to
sage-devel (http://groups.google.com/group/sage-devel),
mentioning in particular your operating system, processor type
and compiler version (run gcc --version).
```



---

Comment by leif created at 2011-10-31 03:37:37

With `-mno-fused-add`, it builds.  (I get _"The double precision of your FPU is 53 bits."_)


---

Comment by leif created at 2011-10-31 03:37:37

Changing status from needs_review to needs_work.


---

Comment by leif created at 2011-10-31 03:41:04

Replying to [comment:9 leif]:
> With GCC versions prior to 4.6, you might have to specify e.g. `-fno-fused-madd` [...]

Note that it's of course `-m`, not `-f`.


---

Comment by leif created at 2011-10-31 04:30:14

FWIW, both with the p9 (with `-O3`, and *without* `-mno-fused-madd`, which is AFAIK the default) and with the p10 (with `-mno-fused-madd`) all (long) tests in

 `sage/lfunctions/sympow.py`

pass.  So you should probably change your check to detect whether the doubles are 64-bit / have a 53-bit mantissa.


Only the optional ones fail (differently); one has to compute extra data (with PARI/GP) for these anyway.  With the p10 I get:

```
sage -t -long -optional "devel/sage/sage/lfunctions/sympow.py"
**********************************************************************
File ".../sage/lfunctions/sympow.py", line 127:
    sage: a = sympow.L(EllipticCurve('11a'), 2, 16); a   # optional
Expected:
    '1.057599244590958E+00'
Got:
    '-4.967915042710588E+11'
**********************************************************************
File ".../sage/lfunctions/sympow.py", line 129:
    sage: RR(a)                    # optional -- requires precomputations
Expected:
    1.05759924459096
Got:
    -4.96791504271059e11
**********************************************************************
1 items had failures:
   2 of   5 in __main__.example_4
***Test Failed*** 2 failures.
For whitespace errors, see the file /home/leif/.sage//tmp/sympow_52568.py
	 [12.7 s]
```


Fairly loud noise... :-)

(Might be that the data in the "manually" computed file is just wrong.)


---

Comment by leif created at 2011-10-31 04:56:43

Replying to [comment:13 leif]:
> FWIW, both with the p9 (with `-O3`, and *without* `-mno-fused-madd`, which is AFAIK the default) and with the p10 (with `-mno-fused-madd`) all (long) tests in
> 
>  `sage/lfunctions/sympow.py`
> 
> pass.  So you should probably change your check to detect whether the doubles are 64-bit / have a 53-bit mantissa.

With the p9 (and *with* `-mfused-add`):

```sh
$ time env SAGE_TEST_ITER=20 ./sage -tp 1 -long devel/sage/sage/lfunctions/sympow.py 
Testing that Sage starts...
Yes, Sage starts.
Global iterations: 1
File iterations: 20
No long cached timings exist; will create for successful files.
Doctesting 1 file using 1 thread
sage -t -long devel/sage/sage/lfunctions/sympow.py
	 [10.2 s]
 
----------------------------------------------------------------------
All tests passed!
Timings have been updated.
Total time for all tests: 232.1 seconds

real	3m54.484s
user	3m39.864s
sys	0m11.631s
```


With the p10:

```sh
$ time env SAGE_TEST_ITER=20 ./sage -tp 1 -long devel/sage/sage/lfunctions/sympow.py 
Testing that Sage starts...
Yes, Sage starts.
Global iterations: 1
File iterations: 20
Using long cached timings to run longest doctests first.
Doctesting 1 file using 1 thread
sage -t -long devel/sage/sage/lfunctions/sympow.py
	 [11.4 s]
 
----------------------------------------------------------------------
All tests passed!
Timings have been updated.
Total time for all tests: 238.5 seconds

real	4m0.566s
user	3m44.169s
sys	0m11.777s
```


(Both packages compiled with `-O3 -march=power7 -mtune=power7`.)


---

Comment by jdemeyer created at 2011-10-31 09:12:07

Replying to [comment:9 leif]:
> With GCC versions prior to 4.6, you might have to specify e.g. `-fno-fused-madd` instead on some platforms, so you could also check whether that's supported and use it in case it is.
Good point, I will add that flag.

> [Although it's not immediately clear to me whether that's desirable at all; with (fused) multiply-accumulate, the results are _more_ accurate than without.  They'll of course frequently differ slightly from what you get _with_ strict IEEE 754 compliance.]

This is certainly desirable.  SYMPOW really requires strict IEEE-754 compliance, anything _more_ precise is bad.


---

Comment by jdemeyer created at 2011-10-31 09:18:39

Replying to [comment:13 leif]:
> FWIW, both with the p9 (with `-O3`, and *without* `-mno-fused-madd`, which is AFAIK the default) and with the p10 (with `-mno-fused-madd`) all (long) tests in
> 
>  `sage/lfunctions/sympow.py`
> 
> pass.
The fact that all tests pass, does not necessarily mean that SYMPOW is operating correctly.  It has been shown that SYMPOW sometimes computes incorrect results when fused-madd is used.  I agree, this was with gcc 4.6.0 on ia64, not gcc 4.4.6 on powerpc, but still...


---

Comment by jdemeyer created at 2011-10-31 14:15:15

Diff for the new Sympow spkg, for review only


---

Attachment

New spkg, builds correctly on `silius`, both with gcc 4.6.1 and with gcc 4.3.4.  Needs review.


---

Comment by jdemeyer created at 2011-10-31 14:15:56

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-10-31 14:22:15

The new spkg does give harmless deprecation warnings on newer gcc versions.  Should I add the flag `-Wno-deprecated`?


---

Comment by leif created at 2011-10-31 20:58:38

Replying to [comment:19 jdemeyer]:
> The new spkg does give harmless deprecation warnings on newer gcc versions.  Should I add the flag `-Wno-deprecated`?

Why?  Because upstream died and nobody is going to fix the code?

IMHO it's better to not suppress such warnings, even though they might confuse or annoy users.  (It's ok to suppress some other warnings, e.g. for Cython-generated files when you're 100% sure that GCC is just not smart enough to deduce that they're non-issues.  But in most cases, one should avoid the warnings by changing the code.)


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by cremona created at 2012-01-15 21:39:01

I happen to be at a conference with Mark Watkins (sympow author) for the next 5 days.  Is there anything useful I can ask him?


---

Comment by cremona created at 2012-01-15 21:46:32

What is required of a reviewer?  I have no idea what is going on with these gcc issues.  But I successfully built the spkg on 4.8.alpha6 on a 64-bit ubuntu machine;  and not being sure what the relevant things to test are I am testing sage/schemes/elliptic_curves since I know that some sympow is used in there.

But I may be wasting my time since this is not the kind of machine on which there were problems, and the gcc version is 4.3.3.


---

Comment by leif created at 2012-01-15 22:17:45

Replying to [comment:23 cremona]:
> What is required of a reviewer?  I have no idea what is going on with these gcc issues.  But I successfully built the spkg on 4.8.alpha6 on a 64-bit ubuntu machine;  and not being sure what the relevant things to test are I am testing sage/schemes/elliptic_curves since I know that some sympow is used in there.
> 
> But I may be wasting my time since this is not the kind of machine on which there were problems, and the gcc version is 4.3.3.

Well, in addition to the platforms where Sympow previously _caused_ trouble (those with [optional] non-standard floating-point and/or MAC/FMA instructions), the new spkg should also (still) work on more common platforms, so testing it on the latter doesn't hurt either.

Perhaps you could give more details w.r.t. the processor and your Ubuntu version; GCC 4.3.3 smells like Ubuntu 9.04.  Otherwise -- if your time allows -- you could run a full test (`ptestlong`) with a recent Sage version and the new spkg here.

According to `deps`, only the Sage library depends on Sympow, so you don't have to rebuild any other spkgs.  (You could do a `./sage -ba-force` after installing the new spkg, but this shouldn't be necessary.)




I don't think there's anything we (at least me) could or should ask Mark, but Jeroen will know better.


---

Comment by leif created at 2012-01-15 22:21:51

P.S.: I can perhaps (re-)review the new spkg tomorrow evening; I'm not sure whether there've been changes since I last looked at it.


---

Comment by Snark created at 2012-01-16 07:04:39

Replying to [comment:24 leif]:
> According to `deps`, only the Sage library depends on Sympow, so you don't have to rebuild any other spkgs.  (You could do a `./sage -ba-force` after installing the new spkg, but this shouldn't be necessary.)

According to deps, nothing depends on sympow ; see my recent mail to the sage-devel mailing-list where I'm surprised by the many roots of the dependency graph.


---

Comment by leif created at 2012-01-16 19:32:01

Replying to [comment:26 Snark]:
> Replying to [comment:24 leif]:
> > According to `deps`, only the Sage library depends on Sympow, so you don't have to rebuild any other spkgs.  (You could do a `./sage -ba-force` after installing the new spkg, but this shouldn't be necessary.)
> 
> According to deps, nothing depends on sympow ; see my recent mail to the sage-devel mailing-list where I'm surprised by the many roots of the dependency graph.

Doesn't really surprise me... ;-)


At least target `all` (which is the real root of the dependency graph) depends on Sympow, and the Sage library _does use_ the Sympow executable, so could or _should_<sup>TM</sup> depend on it (although there's no need to rebuild the library upon a change/update of Sympow, but `sage -b` usually doesn't do much anyway).


---

Comment by jdemeyer created at 2012-01-16 19:50:41

Replying to [comment:26 Snark]:
> According to deps, nothing depends on sympow ;
True, no package depends on Sympow and the Sage library doesn't depend on Sympow in the sense that building it (`./sage -b`) doesn't need Sympow.  But of course, the Sage runtime needs Sympow.


---

Comment by Snark created at 2012-01-16 20:00:22

Thanks for your remarks -- I can't help but notice two things:
 1. this question is crucial when one wants to work on cross-compilation, as a build-time dep must be built for the host and a runtime for the target!
 2. this bug report might not be the most appropriate place for this ;-)


---

Comment by leif created at 2012-01-16 20:39:58

Replying to [comment:25 leif]:
> P.S.: I can perhaps (re-)review the new spkg tomorrow evening; I'm not sure whether there've been changes since I last looked at it.

At first glance looks ok, modulo some cosmetic inconsistencies and the like (in `spkg-install`):

 * Indentation
 * "Sympow" vs. "sympow" vs. "SYMPOW"; `SPKG.txt` (mostly) uses the latter.
 * Not all error messages are redirected to stderr.
 * Some error messages don't start with "`Error`" (and don't contain the word elsewhere).
 * Superfluous `if [ -d $FOO ]; then rm -rf $FOO; fi` (instead of just `rm -rf $FOO`) etc.
 * The viral trailing semicolon in

```sh
   echo "SAGE_LOCAL undefined ... exiting";
```

 * A few typos (either _"[fused] multiply-a*d*d instructions"_ or _"multiply-and*-add*..."_ -- also without a hyphen before _"instructions"_; _"almost surely on a*n* x86 system"_, ...?)

A little more relevant:

 * To go triple safe, you could add `-fno-fast-math` to your `FLAG` list.
 * `$SCRIPT` (which contains `$SAGE_LOCAL`) should be quoted near the end of `spkg-install`; perhaps also `$file`, which in contrast just depends on Sympow['s data file names], not a user setting.
 * The generated script should perhaps test `$SAGE_LOCAL` to give a meaningful error message in case it is undefined.
 * `if [ ! -f "$TARGET/sympow" ] ...` could be `if [ ! -x "$TARGET/sympow" ] ...`.




I cannot (re)test this much; will probably do on cleo, perhaps silius, and some "unaffected" systems; interesting would also be newer Intel CPUs with AVX, although the early Sandy Bridges (for example) do not support multiply-accumulate IIRC.

I also haven't looked at the new C code recently, assuming it hasn't changed since I last did (a few month ago).


---

Comment by leif created at 2012-01-17 19:42:30

Replying to [comment:30 leif]:
> I cannot (re)test this much; will probably do on cleo [...]


```
...
Linux cleo 2.6.18-128.1.1.el5 #1 SMP Mon Jan 26 13:57:09 EST 2009 ia64 ia64 ia64 GNU/Linux
Deleting directories from past builds of previous/current versions of sympow-1.018.1.p10
Extracting package /home/leif/Sage/spkgs/sympow-1.018.1.p10.spkg ...
-rw-r--r-- 1 leif sage 2212655 Oct 31 07:15 /home/leif/Sage/spkgs/sympow-1.018.1.p10.spkg
Finished extraction
****************************************************
Host system
uname -a:
Linux cleo 2.6.18-128.1.1.el5 #1 SMP Mon Jan 26 13:57:09 EST 2009 ia64 ia64 ia64 GNU/Linux
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
Target: ia64-redhat-linux
Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-libgcj-multifile --enable-languages=c,c++,objc,obj-c++,java,fortran,ada --enable-java-awt=gtk --disable-dssi --enable-plugin --with-java-home=/usr/lib/jvm/java-1.4.2-gcj-1.4.2.0/jre --host=ia64-redhat-linux
Thread model: posix
gcc version 4.1.2 20080704 (Red Hat 4.1.2-44)
****************************************************
patching file Configure
patching file generate.c
patching file fpu.c
The double precision of your FPU is 105 bits.
The Quad Double library used by SYMPOW assumes IEEE-754 double precision
numbers with exactly 53 bits in the mantissa (64 bits in total).

Unfortunately, we currently have no workaround for your system.
Running SYMPOW will almost certainly fail on some inputs.
Please report this problem to
sage-devel (http://groups.google.com/group/sage-devel),
mentioning in particular your operating system, processor type
and compiler version (run gcc --version).

real	0m1.626s
user	0m0.128s
sys	0m0.072s
************************************************************************
Error installing package sympow-1.018.1.p10
************************************************************************
...
leif`@`cleo:~/Sage/release/build/cleo/sage-4.8.rc0-gcc-4.2.1> echo $CFLAGS 
-O3 -g -fno-strict-aliasing
```


I think older GCCs (>= 4.0.1 or 4.2.1) should be supported as well, especially on platforms like this.  Haven't tracked down what exactly goes wrong...




Ooops, just noticed John C. infected me: Ignore the prompt / directory name -- it's of course GCC *4.1.2*, not 4.2.1.  Do we want to support this version (on Itanium)?


---

Comment by leif created at 2012-01-17 21:01:02

Replying to [comment:31 leif]:
> 

```
...
************************************************************************
Error installing package sympow-1.018.1.p10
************************************************************************
...
leif`@`cleo:~/Sage/release/build/cleo/sage-4.8.rc0-gcc-4.2.1> echo $CFLAGS 
-O3 -g -fno-strict-aliasing
```


More detailed:

```
...
gcc -v
Using built-in specs.
Target: ia64-redhat-linux
Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-libgcj-multifile --enable-languages=c,c++,objc,obj-c++,java,fortran,ada --enable-java-awt=gtk --disable-dssi --enable-plugin --with-java-home=/usr/lib/jvm/java-1.4.2-gcj-1.4.2.0/jre --host=ia64-redhat-linux
Thread model: posix
gcc version 4.1.2 20080704 (Red Hat 4.1.2-44)
****************************************************
patching file Configure
patching file generate.c
patching file fpu.c

Initial CFLAGS='-O3 -g -fno-strict-aliasing'
Testing '-ffp-contract=on': ...not recognized (compilation failed)
Testing '-mno-fused-madd': ...not recognized (compilation failed)
Testing '-mfpmath=sse': ...not recognized (compilation failed)
Testing '-mpc64': ...not recognized (compilation failed)
Accumulated CFLAGS='-O3 -g -fno-strict-aliasing'

The double precision of your FPU is 105 bits.
The Quad Double library used by SYMPOW assumes IEEE-754 double precision
numbers with exactly 53 bits in the mantissa (64 bits in total).

Unfortunately, we currently have no workaround for your system.
Running SYMPOW will almost certainly fail on some inputs.
...
```



---

Comment by leif created at 2012-01-17 21:31:08

Changing status from needs_review to needs_work.


---

Comment by leif created at 2012-01-17 21:31:08

Replying to [comment:32 leif]:
> More detailed:

```
...
gcc -v
Using built-in specs.
Target: ia64-redhat-linux
Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-libgcj-multifile --enable-languages=c,c++,objc,obj-c++,java,fortran,ada --enable-java-awt=gtk --disable-dssi --enable-plugin --with-java-home=/usr/lib/jvm/java-1.4.2-gcj-1.4.2.0/jre --host=ia64-redhat-linux
Thread model: posix
gcc version 4.1.2 20080704 (Red Hat 4.1.2-44)
****************************************************
patching file Configure
patching file generate.c
patching file fpu.c
 
Initial CFLAGS='-O3 -g -fno-strict-aliasing'
Testing '-ffp-contract=on': ...not recognized (compilation failed)
Testing '-mno-fused-madd': ...not recognized (compilation failed)
Testing '-mfpmath=sse': ...not recognized (compilation failed)
Testing '-mpc64': ...not recognized (compilation failed)
Accumulated CFLAGS='-O3 -g -fno-strict-aliasing'

The double precision of your FPU is 105 bits.
The Quad Double library used by SYMPOW assumes IEEE-754 double precision
numbers with exactly 53 bits in the mantissa (64 bits in total).

Unfortunately, we currently have no workaround for your system.
Running SYMPOW will almost certainly fail on some inputs.
...
```



In this case `-ffloat-store` helps (`-fno-fast-math` doesn't):

```
...
patching file Configure
patching file generate.c
patching file fpu.c

Initial CFLAGS='-O3 -g -fno-strict-aliasing'
Testing '-ffp-contract=on': ...not recognized (compilation failed)
Testing '-mno-fused-madd': ...not recognized (compilation failed)
Testing '-mfpmath=sse': ...not recognized (compilation failed)
Testing '-mpc64': ...not recognized (compilation failed)
Testing '-ffloat-store': ...compiles ...runs (exit code 0)
Testing '-fno-fast-math': ...compiles ...runs (exit code 0)
Accumulated CFLAGS='-O3 -g -fno-strict-aliasing -ffloat-store -fno-fast-math'

The double precision of your FPU is 53 bits.
...
```



---

Comment by jdemeyer created at 2012-01-19 16:13:53

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-01-19 16:13:53

leif: I took care of most of your comments.  It now uses "-ffloat-store" if needed.


---

Attachment

Diff for the sympow spkg p10 -> p11, for review only


---

Comment by jdemeyer created at 2012-01-21 23:49:17

leif, could you please review?


---

Comment by leif created at 2012-01-22 09:26:15

Replying to [comment:35 jdemeyer]:
> leif, could you please review?

I'm _"at it_"<sup>TM</sup> (already took a brief look); will yet take some time, hopefully later today...


---

Comment by leif created at 2012-01-22 09:28:55

Replying to [comment:36 leif]:
> I'm _"at it_"<sup>TM</sup> (already took a brief look); will yet take some time, hopefully later today...


P.S.: FWIW, now of course also builds and passes tests on cleo with GCC 4.1.2.


---

Comment by leif created at 2012-01-22 09:35:59

I wonder if we should try `-ffloat-store` before "resorting" to `-fno-fast-math` (which, depending on the platform, disables a lot), but I don't really have an idea w.r.t. the performance impact.


---

Comment by jdemeyer created at 2012-01-22 10:03:38

`-fno-fast-math` is clearly an option we want in all cases.  The opposite `-ffast-math` makes code not IEEE compliant.


---

Comment by vbraun created at 2012-02-04 19:49:32

Looks good to me.

Incidentally, did you look at the sympow source? Do you have an opinion on how easy it would be to replace their troublesome quad math implementation with libquadmath?


---

Comment by vbraun created at 2012-02-04 19:49:32

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-06 08:33:41

Replying to [comment:40 vbraun]:
> Looks good to me.
> 
> Incidentally, did you look at the sympow source?
No.

> Do you have an opinion on how easy it would be to replace their troublesome quad math implementation with libquadmath? 
I think libquadmath does something different from SYMPOW's "quad double".  libquadmath implements [Quadruple precision numbers](http://en.wikipedia.org/wiki/Quadruple_precision) (113 bits) whereas SYMPOW's quad double implements something like 4*53 = 212 bits of precision.

Anyway, I don't think it's that troublesome, once you understand that it needs IEEE-compliants doubles.

Thanks for the review!


---

Comment by jdemeyer created at 2012-02-07 13:21:32

Resolution: fixed
