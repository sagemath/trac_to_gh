# Issue 26348: Matrix product over GF(11) segfaults on multicore server

archive/issues_026348.json:
```json
{
    "body": "CC:  @embray\n\nMultiplying a 1000x1000 matrix over GF(11) causes a segfault on a 32 core server.\n\n\n```\nsage: a=random_matrix(GF(11),1000)\nsage: b = a*a\nErreur de segmentation\n```\n\n\ngdb says it comes from OpenBLAS thread manager.\n\n```\nThread 48 \"python\" received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7fe738c31700 (LWP 18829)]\n0x00007fffef552d0e in blas_thread_server ()\n   from /home/pernet/sage/local/lib/libopenblas.so.0\n(gdb) where\n#0  0x00007fffef552d0e in blas_thread_server ()\n   from /home/pernet/sage/local/lib/libopenblas.so.0\n#1  0x00007ffff7d73f2a in start_thread (arg=0x7fe738c31700)\n    at pthread_create.c:463\n#2  0x00007ffff7b08f0f in clone ()\n    at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\n\n```\n\n\nbut in valgrind mode, everything works just fine.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26585\n\n",
    "created_at": "2018-10-28T18:05:38Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Matrix product over GF(11) segfaults on multicore server",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26348",
    "user": "https://github.com/ClementPernet"
}
```
CC:  @embray

Multiplying a 1000x1000 matrix over GF(11) causes a segfault on a 32 core server.


```
sage: a=random_matrix(GF(11),1000)
sage: b = a*a
Erreur de segmentation
```


gdb says it comes from OpenBLAS thread manager.

```
Thread 48 "python" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fe738c31700 (LWP 18829)]
0x00007fffef552d0e in blas_thread_server ()
   from /home/pernet/sage/local/lib/libopenblas.so.0
(gdb) where
#0  0x00007fffef552d0e in blas_thread_server ()
   from /home/pernet/sage/local/lib/libopenblas.so.0
#1  0x00007ffff7d73f2a in start_thread (arg=0x7fe738c31700)
    at pthread_create.c:463
#2  0x00007ffff7b08f0f in clone ()
    at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95

```


but in valgrind mode, everything works just fine.

Issue created by migration from https://trac.sagemath.org/ticket/26585





---

archive/issue_comments_370582.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2018-10-28T18:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370582",
    "user": "https://github.com/ClementPernet"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_370583.json:
```json
{
    "body": "I have a suspicion that this is an openblas bug but it's not clear yet.",
    "created_at": "2018-10-28T19:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370583",
    "user": "https://github.com/embray"
}
```

I have a suspicion that this is an openblas bug but it's not clear yet.



---

archive/issue_comments_370584.json:
```json
{
    "body": "Somehow, it seems like, the `blas_thread_init` routine is being called multiple times, when it shouldn't be.",
    "created_at": "2018-10-28T19:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370584",
    "user": "https://github.com/embray"
}
```

Somehow, it seems like, the `blas_thread_init` routine is being called multiple times, when it shouldn't be.



---

archive/issue_comments_370585.json:
```json
{
    "body": "Hmm; I think I see the problem.\nWhen the openblas library is first initialized it runs through a number of initialization routines, including a function called `blas_thread_init`.  By default the `blas_num_threads` is 1, so nothing very interesting happens in `blas_thread_init`.  Nevertheless, it concludes by setting a global variable `blas_server_avail = 1`.  This prevents any subsequent calls to `blas_thread_init` from doing anything.\n\nNormally the only way `blas_server_avail` gets reset to zero is if the function `blas_thread_shutdown` is called.  This can be called manually, I think, though there is usually any reason to. But there is one case in which it does get called transparently:  When openblas is initialized it registers a `pthread_atfork` handler to call `blas_thread_shutdown` prior to forking (so that the child process gets a clean threading state).  In the child process the thread manager is then re-enabled (`blas_thread_init`).  But in the *parent* it is not immediately re-initialized.\n\nRather, most functions in openblas that use threads (e.g. `blas_exec_async`) check `blas_server_avail` and call `blas_thread_init` if it is zero.  However, `openblas_set_num_threads` does *not* perform such a check.  But if it is called to increase the number of threads, it does go ahead and create new threads without checking `blas_server_avail` *at all*.  The end result is as if `blas_thread_init` were called (more or less, with some exceptions), but openblas doesn't *think* threads have been initialized.  Then when `blas_thread_init` does get called it starts mutating global data (such as mutexes) that the now running threads are already using, leading to segfaults in those threads.",
    "created_at": "2018-10-28T21:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370585",
    "user": "https://github.com/embray"
}
```

Hmm; I think I see the problem.
When the openblas library is first initialized it runs through a number of initialization routines, including a function called `blas_thread_init`.  By default the `blas_num_threads` is 1, so nothing very interesting happens in `blas_thread_init`.  Nevertheless, it concludes by setting a global variable `blas_server_avail = 1`.  This prevents any subsequent calls to `blas_thread_init` from doing anything.

Normally the only way `blas_server_avail` gets reset to zero is if the function `blas_thread_shutdown` is called.  This can be called manually, I think, though there is usually any reason to. But there is one case in which it does get called transparently:  When openblas is initialized it registers a `pthread_atfork` handler to call `blas_thread_shutdown` prior to forking (so that the child process gets a clean threading state).  In the child process the thread manager is then re-enabled (`blas_thread_init`).  But in the *parent* it is not immediately re-initialized.

Rather, most functions in openblas that use threads (e.g. `blas_exec_async`) check `blas_server_avail` and call `blas_thread_init` if it is zero.  However, `openblas_set_num_threads` does *not* perform such a check.  But if it is called to increase the number of threads, it does go ahead and create new threads without checking `blas_server_avail` *at all*.  The end result is as if `blas_thread_init` were called (more or less, with some exceptions), but openblas doesn't *think* threads have been initialized.  Then when `blas_thread_init` does get called it starts mutating global data (such as mutexes) that the now running threads are already using, leading to segfaults in those threads.



---

archive/issue_comments_370586.json:
```json
{
    "body": "Confirmed.  Simply adding `if (unlikely(blas_server_avail == 0)) blas_thread_init();` at the beginning of `openblas_set_num_threads` was good enough to fix it.",
    "created_at": "2018-10-28T21:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370586",
    "user": "https://github.com/embray"
}
```

Confirmed.  Simply adding `if (unlikely(blas_server_avail == 0)) blas_thread_init();` at the beginning of `openblas_set_num_threads` was good enough to fix it.



---

archive/issue_comments_370587.json:
```json
{
    "body": "Added upstream pull request; if someone wants to review it I can also add the patch to Sage's openblas package.",
    "created_at": "2018-10-29T08:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370587",
    "user": "https://github.com/embray"
}
```

Added upstream pull request; if someone wants to review it I can also add the patch to Sage's openblas package.



---

archive/issue_comments_370588.json:
```json
{
    "body": "Erik openblas patch is available for testing at branch `public/26585-openblas_patch`.",
    "created_at": "2018-10-29T08:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370588",
    "user": "https://github.com/videlec"
}
```

Erik openblas patch is available for testing at branch `public/26585-openblas_patch`.



---

archive/issue_comments_370589.json:
```json
{
    "body": "Cool, might as well add it to the ticket.  If we need to update it later nbd.\n----\nNew commits:",
    "created_at": "2018-10-29T18:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370589",
    "user": "https://github.com/embray"
}
```

Cool, might as well add it to the ticket.  If we need to update it later nbd.
----
New commits:



---

archive/issue_comments_370590.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-31T10:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370590",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370591.json:
```json
{
    "body": "Fix accepted upstream as-is.",
    "created_at": "2018-10-31T10:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370591",
    "user": "https://github.com/embray"
}
```

Fix accepted upstream as-is.



---

archive/issue_comments_370592.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-31T10:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370592",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370593.json:
```json
{
    "body": "Good news. Thanks Erik for taking care of it!",
    "created_at": "2018-10-31T10:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370593",
    "user": "https://github.com/videlec"
}
```

Good news. Thanks Erik for taking care of it!



---

archive/issue_comments_370594.json:
```json
{
    "body": "Updated the title of the ticket to reflect the broader problem (if I need to look for this later I won't remember the exact example of multiplying matrices in GF(11) :)",
    "created_at": "2018-10-31T10:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370594",
    "user": "https://github.com/embray"
}
```

Updated the title of the ticket to reflect the broader problem (if I need to look for this later I won't remember the exact example of multiplying matrices in GF(11) :)



---

archive/issue_events_065994.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-01T00:58:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26348#event-65994"
}
```



---

archive/issue_comments_370595.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-01T00:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370595",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_370596.json:
```json
{
    "body": "I just realized this probably should have increased the patch version of the SPKG.  Otherwise it won't get updated in incremental builds.\n\nIt's not clear to me that this patch is immediately needed though...",
    "created_at": "2018-11-02T17:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26348#issuecomment-370596",
    "user": "https://github.com/embray"
}
```

I just realized this probably should have increased the patch version of the SPKG.  Otherwise it won't get updated in incremental builds.

It's not clear to me that this patch is immediately needed though...
