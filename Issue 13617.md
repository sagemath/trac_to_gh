# Issue 13617: Change sage.combinat.combinat.combinations() to use Combinations

Issue created by migration from https://trac.sagemath.org/ticket/13821

Original creator: ppurka

Original creation time: 2012-12-11 15:21:21

Assignee: sage-combinat

CC:  sage-combinat kini

As I mentioned a long time ago in #5288, the `combinations()` method is not ideal for working with Sage objects. This warning is also present in the documentation of this command. There is a much better command `Combinations`. The `combinations` command should be made to return a list by calling `Combinations` instead.

The result of this change in the code will be that
1. It will also speed up the function considerably, partly because it won't depend on string parsing from GAP.
2. It will be able to handle Sage objects much better.
3. If and when #10534 is merged, the function will automatically gain at least 10x speed.

Similarly, `combinations_iterator` should directly return a `Combinations` object, instead of duplicating stuff.


---

Comment by ppurka created at 2012-12-11 16:02:30

Changing status from new to needs_review.


---

Comment by ppurka created at 2012-12-11 16:02:30

The attached patch implements this change.


---

Comment by tscrim created at 2012-12-11 19:29:32

Why not deprecate the function? Does this depend on #5288 getting merged into sage?

Thanks,

Travis


---

Comment by tscrim created at 2012-12-11 19:29:32

Changing status from needs_review to needs_info.


---

Comment by ppurka created at 2012-12-12 01:02:17

Replying to [comment:2 tscrim]:
> Why not deprecate the function? Does this depend on #5288 getting merged into sage?
> 
> Thanks,

> Travis
It could be deprecated. But I don't know why it was written in the first place. It doesn't depend on #5288 at all.


---

Comment by tscrim created at 2012-12-15 07:04:28

My guess is that it was from the old code (before `Combinations` and possibly before the categories model). I would deprecate the function since it is redundant and it just references `Combinations`. Also your `INPUT:` list bullets are indented too far and I would prefer the documentation to say _returns_ or _references_ rather than _wrapper for_ for `combinations_iterator`. Thanks.


---

Comment by ppurka created at 2012-12-15 16:28:55

Ok. I have put deprecation in the functions and done a bunch of cleanups. There is a second patch which replaces all the calls to `combinations*` with `Combinations`, that i could find with `search_src()`.


---

Comment by ppurka created at 2012-12-15 16:28:55

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2012-12-15 18:31:08

A few more documenation things:
- The `INPUT:` for `combintions_iterator()` is still indented.
- You have `..note::` but there should be a space there: `.. NOTE::` (personally I prefer the capitalized form since it is consistent with the dev-guide, but if you prefer the lowercase, that's fine).
- I don't like the formatting of

```
It is possible to take combinations of Sage objects.::
```

  as it will output in the html

```
It is possible to take combinations of Sage objects.:
```

  Thus either remove the period or put a space between the period and the colon (i.e. as `objects. ::`).

Thanks,

Travis


---

Comment by ppurka created at 2012-12-15 20:35:54

Apply to devel/sage


---

Attachment

Thanks for the review. These issues should be fixed now.

Patchbot: apply trac_13821-change_combinations.patch trac_13821-replace_combinations.patch


---

Comment by tscrim created at 2012-12-16 17:13:06

Looks good to me. Thanks.


---

Comment by tscrim created at 2012-12-16 17:13:06

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-12-22 07:01:56

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-12-22 07:01:56

This needs to be rebased on top of #13723.


---

Comment by ppurka created at 2012-12-22 13:35:34

Replying to [comment:9 jdemeyer]:
> This needs to be rebased on top of #13723.
This should be fixed now. Only change needed was the [removal of an import](https://github.com/ppurka/sage-patches/commit/32d79050656d5fa65d5eb44912f43cd8be2f9dba#L0L18).


---

Comment by ppurka created at 2012-12-22 13:35:34

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2012-12-30 12:11:13

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-12-30 12:11:13

There are two doctest failures coming from #11763:

```
sage -t  -force_lib devel/sage/sage/geometry/polyhedron/base_ZZ.py
**********************************************************************
File "/release/merger/sage-5.6.beta2/devel/sage-main/sage/geometry/polyhedron/base_ZZ.py", line 227:
    sage: list( P.fibration_generator(2) )
Expected:
    [A 2-dimensional polyhedron in ZZ^4 defined as the convex hull of 3 vertices]
Got:
    doctest:239: DeprecationWarning: Use Combinations(mset,k) instead.
    See http://trac.sagemath.org/13821 for details.
    [A 2-dimensional polyhedron in ZZ^4 defined as the convex hull of 3 vertices]
**********************************************************************
```

and

```
sage -t  -force_lib devel/sage/sage/graphs/generic_graph.py
**********************************************************************
File "/release/merger/sage-5.6.beta2/devel/sage-main/sage/graphs/generic_graph.py", line 11862:
    sage: G.triangles_count()
Expected:
    0
Got:
    doctest:11913: DeprecationWarning: Use Combinations(mset,k) instead.
    See http://trac.sagemath.org/13821 for details.
    0
**********************************************************************
```



---

Attachment

Apply to devel/sage after above patch


---

Comment by ppurka created at 2012-12-30 16:37:59

[Updated](https://github.com/ppurka/sage-patches/commit/be89adf79265ebd147c16ea5dc4e9db044253f00) the patch. I will set it to positive review if the patchbot turns green with envy.


---

Comment by ppurka created at 2012-12-30 16:37:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-12-31 09:41:51

ppurka: this is a change which requires an actual review.


---

Comment by ppurka created at 2012-12-31 09:51:59

Replying to [comment:13 jdemeyer]:
> ppurka: this is a change which requires an actual review.
I don't mind. But the patchbot seems to have failed in exactly the same position. This is unexpected. I didn't see any other use of `combination` from `search_src()`.

Moreover, my local testing gave no errors on those files.


---

Comment by ppurka created at 2012-12-31 09:58:34

From the patchbot logs:

```
2012-12-30 23:17:49 +0000
Looking at #13821
Looking at #13723
#13723 already applied (5.6.beta0 <= 5.6.beta1)
Looking at #11763
#11763 already applied (5.6.beta1 <= 5.6.beta1)
Patches for #13821:
    trac_13821-change_combinations.patch#06e5f20c6df61a1803698a5b80ee0240
    trac_13821-replace_combinations.patch#5356795e4cae7f89cd58c17dbe122f7f
hg qpop trac_13821-replace_combinations.patch
qpop: trac_13821-replace_combinations.patch is already at the top
hg qapplied
trac_13821-change_combinations.patch
trac_13821-replace_combinations.patch
```

Why is it using the old patches? Shouldn't it be trying with the new patches?


---

Comment by ppurka created at 2012-12-31 12:03:04

patchbot apply trac_13821-change_combinations.patch trac_13821-replace_combinations.patch


---

Comment by tscrim created at 2012-12-31 17:36:17

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2012-12-31 17:36:17

Works for me as well:

```
travis@travis-virtualbox:~/sage-5.5.rc0/devel/sage-reviews/sage$ sage -t graphs/generic_graph.py geometry/polyhedron/base_ZZ.py 
sage -t  "devel/sage-reviews/sage/geometry/polyhedron/base_ZZ.py"
	 [24.3 s]
sage -t  "devel/sage-reviews/sage/graphs/generic_graph.py"  
	 [91.9 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 116.3 seconds
```

(For whomever is interested, the replace patch depends on #13503)

I've had this issue of the patchbot using old patches come up a few places before. I've kicked the patchbot, so hopefully next time the patchbot will pass all tests. Since the tests pass for me, I'm going to set this to positive review.


---

Comment by ppurka created at 2012-12-31 17:42:05

Thanks.

I didn't know it was a more common occurrence with the patchbot. It looks like it doesn't clear the queue while applying new patches.


---

Comment by ppurka created at 2012-12-31 17:43:41

`@`kini - can you have a look at the patchbot? I think you are one of the few people who know how it works.


---

Comment by kini created at 2012-12-31 18:36:35

Hmm, I have no idea. I tried running my 5.6.beta0 patchbot on it but it failed even more strangely. Building 5.6.beta1 now to try that...


---

Comment by tscrim created at 2013-01-01 05:35:24

Replying to [comment:20 kini]:
> Hmm, I have no idea. I tried running my 5.6.beta0 patchbot on it but it failed even more strangely. Building 5.6.beta1 now to try that...

Did it fail to apply? My guess is that is because #13503 was merged in `5.6.beta1`. I've formally added it as a dependency.


---

Comment by ppurka created at 2013-01-01 10:40:32

It should apply fine to beta0, since it applies fine to beta1. Anyway, the patchbot seems to have caught up or kini did some miracle! :)


---

Comment by kini created at 2013-01-01 19:05:01

I didn't do anything. Vanilla 5.6.beta1 doesn't even pass tests on my machine, and my patchbot failed to apply #11763 to beta0 for some reason. Volker's patchbot is the one that came along and gave this ticket a green light.


---

Comment by jdemeyer created at 2013-01-07 20:56:34

Resolution: fixed
