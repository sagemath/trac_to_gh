# Issue 13011: Implement index(cone) for fan morphisms

archive/issues_013011.json:
```json
{
    "body": "Assignee: mhampton\n\nCC:  @vbraun\n\nKeywords: toric\n\nFor #12892 it would be useful to compute indices of cones as they define the number of components of each fiber. The index is defined in\n Yi Hu, Chien-Hao Liu, and Shing-Tung Yau. Toric morphisms and fibrations of toric Calabi-Yau hypersurfaces. Adv. Theor. Math. Phys., 6(3):457-506, 2002. arXiv:math/0010082v2 [math.AG].\nfor the case of surjection of complete fans. The attached patch extends the definition to any morphism:\n* if the corresponded quotient of lattices is finite, return its order;\n* if it has free generators, return infinity;\n* if the codomain cone does not have covering domain cones at all, return None.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13183\n\n",
    "created_at": "2012-06-29T16:18:48Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Implement index(cone) for fan morphisms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13011",
    "user": "https://github.com/novoselt"
}
```
Assignee: mhampton

CC:  @vbraun

Keywords: toric

For #12892 it would be useful to compute indices of cones as they define the number of components of each fiber. The index is defined in
 Yi Hu, Chien-Hao Liu, and Shing-Tung Yau. Toric morphisms and fibrations of toric Calabi-Yau hypersurfaces. Adv. Theor. Math. Phys., 6(3):457-506, 2002. arXiv:math/0010082v2 [math.AG].
for the case of surjection of complete fans. The attached patch extends the definition to any morphism:
* if the corresponded quotient of lattices is finite, return its order;
* if it has free generators, return infinity;
* if the codomain cone does not have covering domain cones at all, return None.

Issue created by migration from https://trac.sagemath.org/ticket/13183





---

archive/issue_comments_157061.json:
```json
{
    "body": "Hi Volker, does the description definition sound OK?\n\nThe patch also improves handling of (non-saturated) sublattices and quotient lattices. In the process I had to cut `_split_ambient_lattice` - it will not split the dual one anymore. Note that this dual splitting was not documented and was used only to construct the dual quotient lattice - I have reimplemented the latter one in a more mathematically straightforward way, everything works as before, but choice of generators in doctest examples is now different (I checked that it is equivalent).\n\nI'll put a ready for review version in a few days.",
    "created_at": "2012-06-29T16:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157061",
    "user": "https://github.com/novoselt"
}
```

Hi Volker, does the description definition sound OK?

The patch also improves handling of (non-saturated) sublattices and quotient lattices. In the process I had to cut `_split_ambient_lattice` - it will not split the dual one anymore. Note that this dual splitting was not documented and was used only to construct the dual quotient lattice - I have reimplemented the latter one in a more mathematically straightforward way, everything works as before, but choice of generators in doctest examples is now different (I checked that it is equivalent).

I'll put a ready for review version in a few days.



---

archive/issue_comments_157062.json:
```json
{
    "body": "How about `fiber_index()` to distinguish it from the already existing index method?\n\nThe point of `_split_ambient_lattice` was that you only had to compute the Smith normal form once for the cone. Why not make use of cached data? \n\nThe index is always finite according to p.464. \n\nIf there is no preimage cone, I would also be fine with returning 0 instead of `None` in accord with counting fiber connected components.",
    "created_at": "2012-06-29T18:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157062",
    "user": "https://github.com/vbraun"
}
```

How about `fiber_index()` to distinguish it from the already existing index method?

The point of `_split_ambient_lattice` was that you only had to compute the Smith normal form once for the cone. Why not make use of cached data? 

The index is always finite according to p.464. 

If there is no preimage cone, I would also be fine with returning 0 instead of `None` in accord with counting fiber connected components.



---

archive/issue_comments_157063.json:
```json
{
    "body": "Well, we don't really have fibers yet here and since it is defined as \"index over cone\" I thought index(cone) is the way to go.\n\nThe initial reason for dropping M splitting was that I couldn't figure out how to make it work nicely with sublattices when I need to split an already quotient lattice. Since my replacement is a straightforward implementation in terms of the dual lattice of a sublattice, in retrospect I also think that it would be better. Speedwise I didn't do precise measurements, but I was keeping an eye on timings of doctests and so far they don't seem to be affected.\n\nThe index is always finite in the case when the lattice morphism is surjective (assumption on p. 463) and fans are complete (implicit assumption of the paper). Take P2 and embed A1 over one of its rays. Then 3 fixed points and 2 lines are not covered at all, one line has only its distinguished point covered, and the torus itself has a lower dimensional torus in it. So my proposal is to return None for non-covered cones and infinity for two others. I'll also include a details explanation of this example into documentation.\n\nOn the level of toric morphisms, I think (component, count) would be the best output, with (None, None) for the case of non-covered orbits. For \"partially covered\" ones I am not sure yet. (component, -count) where count is multiplicity over distinguish point is one option, but I don't think I like it. Maybe (component, count, codimension)? Where codimension is for the \"covered points\" relative to the whole orbit. So for surjective case it is 0 and in the above example 1. In this case perhaps we should always return a triple. Anyway, let me know what you think! (Although I'll be off the grid for a few days.)",
    "created_at": "2012-06-29T20:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157063",
    "user": "https://github.com/novoselt"
}
```

Well, we don't really have fibers yet here and since it is defined as "index over cone" I thought index(cone) is the way to go.

The initial reason for dropping M splitting was that I couldn't figure out how to make it work nicely with sublattices when I need to split an already quotient lattice. Since my replacement is a straightforward implementation in terms of the dual lattice of a sublattice, in retrospect I also think that it would be better. Speedwise I didn't do precise measurements, but I was keeping an eye on timings of doctests and so far they don't seem to be affected.

The index is always finite in the case when the lattice morphism is surjective (assumption on p. 463) and fans are complete (implicit assumption of the paper). Take P2 and embed A1 over one of its rays. Then 3 fixed points and 2 lines are not covered at all, one line has only its distinguished point covered, and the torus itself has a lower dimensional torus in it. So my proposal is to return None for non-covered cones and infinity for two others. I'll also include a details explanation of this example into documentation.

On the level of toric morphisms, I think (component, count) would be the best output, with (None, None) for the case of non-covered orbits. For "partially covered" ones I am not sure yet. (component, -count) where count is multiplicity over distinguish point is one option, but I don't think I like it. Maybe (component, count, codimension)? Where codimension is for the "covered points" relative to the whole orbit. So for surjective case it is 0 and in the above example 1. In this case perhaps we should always return a triple. Anyway, let me know what you think! (Although I'll be off the grid for a few days.)



---

archive/issue_comments_157064.json:
```json
{
    "body": "I see. I wouldn't mind if we just implicitly required surjectivity for all `fiber_something()` methods and raise a `ValueError` otherwise. Otherwise there isn't really any meaningful fibration structure. Having to always report extra codimensions over the base torus orbits seems painful/confusing with very little utility.",
    "created_at": "2012-06-29T21:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157064",
    "user": "https://github.com/vbraun"
}
```

I see. I wouldn't mind if we just implicitly required surjectivity for all `fiber_something()` methods and raise a `ValueError` otherwise. Otherwise there isn't really any meaningful fibration structure. Having to always report extra codimensions over the base torus orbits seems painful/confusing with very little utility.



---

archive/issue_comments_157065.json:
```json
{
    "body": "Fibers are defined for any morphism, no matter whether it is a fibration or not, so I'd like fiber methods to do something useful still. After some more thinking I'd like to use None as described above, but return 0 for non-finite index. Reason: I compute the index as the product of invariants, then if it is 0 (indicating ZZ-factors) replace it with infinity. Dropping this extra replacement simplifies life here and then we can also just return this index for \"incomplete covering\", i.e. if there is some fiber over the distinguished point, we return it with zero to indicate that generically there are no such components at all. So possible cases will be:\n* (component, count) - surjective, count has to be positive;\n* (component, 0) - non-surjective, but the distinguished point is covered;\n* (None, None) - even the distinguished point is not covered;\nwhere the second element is always the index of a cone in the sense of this ticket.\nThose who want more details in the 0-case can use `restrict_to_image` method, which makes only two other cases possible.",
    "created_at": "2012-07-07T14:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157065",
    "user": "https://github.com/novoselt"
}
```

Fibers are defined for any morphism, no matter whether it is a fibration or not, so I'd like fiber methods to do something useful still. After some more thinking I'd like to use None as described above, but return 0 for non-finite index. Reason: I compute the index as the product of invariants, then if it is 0 (indicating ZZ-factors) replace it with infinity. Dropping this extra replacement simplifies life here and then we can also just return this index for "incomplete covering", i.e. if there is some fiber over the distinguished point, we return it with zero to indicate that generically there are no such components at all. So possible cases will be:
* (component, count) - surjective, count has to be positive;
* (component, 0) - non-surjective, but the distinguished point is covered;
* (None, None) - even the distinguished point is not covered;
where the second element is always the index of a cone in the sense of this ticket.
Those who want more details in the 0-case can use `restrict_to_image` method, which makes only two other cases possible.



---

archive/issue_comments_157066.json:
```json
{
    "body": "Every morphism has inverse images, but I would reserve \"fiber\" for the case where you have a fibration. If only because it has the same English root.",
    "created_at": "2012-07-07T15:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157066",
    "user": "https://github.com/vbraun"
}
```

Every morphism has inverse images, but I would reserve "fiber" for the case where you have a fibration. If only because it has the same English root.



---

archive/issue_comments_157067.json:
```json
{
    "body": "OK, ready for review, with infinity for the infinite index, otherwise it is confusing. It also turned out that old implementation was not generic enough to handle sublattices, I've added a workaround using the index over the origin, which is mathematically exactly the same. More general code is also added to `_Cone_from_PPL` and `normalize_rays`, which turned out to be quite a bit slower than existing one. So I made sure that we still use the old route when it is sufficient, in particular I don't see any speed regression on testing sage/geometry and sage/schemes/toric (by the way Volker - thanks for the idea to move toric files to a separate folder - very convenient for testing!).\n\nThe second patch is somewhat optional, but I propose to include it: since now we mostly deal with matrices whose rows (and not columns) are ray generators, it is more natural. Code is the third hunk, the rest is doctest adjustment due to a different choice of generators.",
    "created_at": "2012-07-10T01:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157067",
    "user": "https://github.com/novoselt"
}
```

OK, ready for review, with infinity for the infinite index, otherwise it is confusing. It also turned out that old implementation was not generic enough to handle sublattices, I've added a workaround using the index over the origin, which is mathematically exactly the same. More general code is also added to `_Cone_from_PPL` and `normalize_rays`, which turned out to be quite a bit slower than existing one. So I made sure that we still use the old route when it is sufficient, in particular I don't see any speed regression on testing sage/geometry and sage/schemes/toric (by the way Volker - thanks for the idea to move toric files to a separate folder - very convenient for testing!).

The second patch is somewhat optional, but I propose to include it: since now we mostly deal with matrices whose rows (and not columns) are ray generators, it is more natural. Code is the third hunk, the rest is doctest adjustment due to a different choice of generators.



---

archive/issue_comments_157068.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-10T01:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157068",
    "user": "https://github.com/novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_157069.json:
```json
{
    "body": "Rebased for Sage-5.2.rc0",
    "created_at": "2012-07-19T04:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157069",
    "user": "https://github.com/novoselt"
}
```

Rebased for Sage-5.2.rc0



---

archive/issue_comments_157070.json:
```json
{
    "body": "Attachment [trac_13183_index_of_codomain_cone.patch](tarball://root/attachments/some-uuid/ticket13183/trac_13183_index_of_codomain_cone.patch) by @novoselt created at 2013-01-30 23:34:14\n\nRebased for Sage-5.7.beta1",
    "created_at": "2013-01-30T23:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157070",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_13183_index_of_codomain_cone.patch](tarball://root/attachments/some-uuid/ticket13183/trac_13183_index_of_codomain_cone.patch) by @novoselt created at 2013-01-30 23:34:14

Rebased for Sage-5.7.beta1



---

archive/issue_comments_157071.json:
```json
{
    "body": "Apply trac_13183_index_of_codomain_cone.patch trac_13183_untwist_lattice_splitting.patch",
    "created_at": "2013-01-30T23:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157071",
    "user": "https://github.com/novoselt"
}
```

Apply trac_13183_index_of_codomain_cone.patch trac_13183_untwist_lattice_splitting.patch



---

archive/issue_comments_157072.json:
```json
{
    "body": "Looks good to me",
    "created_at": "2013-03-21T11:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157072",
    "user": "https://github.com/vbraun"
}
```

Looks good to me



---

archive/issue_comments_157073.json:
```json
{
    "body": "Replying to [comment:9 vbraun]:\n> Looks good to me\n\nAs in \"positive review\"?-)",
    "created_at": "2013-03-21T14:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157073",
    "user": "https://github.com/novoselt"
}
```

Replying to [comment:9 vbraun]:
> Looks good to me

As in "positive review"?-)



---

archive/issue_comments_157074.json:
```json
{
    "body": "Yes, forgot to press the button ;-)",
    "created_at": "2013-03-21T15:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157074",
    "user": "https://github.com/vbraun"
}
```

Yes, forgot to press the button ;-)



---

archive/issue_comments_157075.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-21T15:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157075",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_012948.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-03-26T22:30:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13011#event-12948"
}
```



---

archive/issue_comments_157076.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-03-26T22:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13011#issuecomment-157076",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
