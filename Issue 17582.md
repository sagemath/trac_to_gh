# Issue 17582: Use uintmax_t for Integer.divisors

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-02-20 19:27:20

The `divisors` method of `Integer` is implemented using `long long` if possible. However, it would be better to use `uintmax_t` for this, which is at least as large as `long long`. Another advantage is that we no longer need the `mpz_set_longlong()` functions from `c_lib`.


---

Comment by jdemeyer created at 2015-02-20 21:14:16

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-02-20 21:14:16

New commits:


---

Comment by git created at 2015-02-21 10:33:08

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-02-22 09:35:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-02-26 21:18:27

That sucks. mpz_set_ux isn't in gmp - at least gmp 5.1.3, if you know it is in 6.0.0+ I at least can force an upgrade in sage-on-gentoo. But right now it is a major headache for sage-on-distro (much more so than pari git master).


---

Comment by jdemeyer created at 2015-02-26 21:30:31

Indeed, those functions seem MPIR-specific. For me personally, that's not an issue (we do use MPIR after all in Sage).


---

Comment by fbissey created at 2015-02-26 21:34:16

I know it would be less of an issue if other gmp using code had moved to using mpir directly one way or another (flint being the only one) rather than just saying "you can do that if mpir is installed with gmp-compat". I think I can do an ugly hack for that one.


---

Comment by jdemeyer created at 2015-02-26 21:42:20

You mean there would be _less_ an issue if _more_ code relied on MPIR?


---

Comment by fbissey created at 2015-02-26 21:48:45

Replying to [comment:10 jdemeyer]:
> You mean there would be _less_ an issue if _more_ code relied on MPIR?

Well that would force the hand. 

What I mean is take pari. You can compile it with mpir by using the gmp compatibility layer. You cannot tell pari to compile directly against mpir, using mpir headers and libmpir. 

If all the packages in the sage stack could do that. It would be easy, install mpir and build everything against it. Reality is everything apart from flint is using gmp and expect gmp. And only use mpir if it is masquerading itself as gmp. 

In a distro where gmp is already installed because of gcc it won't happen unless you can convince the toolchain team of the distro to switch to mpir. Tough job.


---

Comment by jdemeyer created at 2015-02-26 21:49:39

We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.


---

Comment by fbissey created at 2015-02-26 21:55:40

Replying to [comment:12 jdemeyer]:
> We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.

I guess that would be handy but what happens on 32 bits systems? We are still dealing with them for the foreseeable future.

I am trying a hack where integer.pyx and mpz.pxd explicitly use mpir. But not anything else.

I am guessing if mpir is a complete superset of gmp I could switch the whole sage library to explicit mpir. A bit of linking madness but it would work.


---

Comment by jdemeyer created at 2015-02-26 22:05:28

Replying to [comment:13 fbissey]:
> Replying to [comment:12 jdemeyer]:
> > We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.
> 
> I guess that would be handy but what happens on 32 bits systems?
When using `unsigned long`, stuff would become slower for 32-bit systems. It's really a matter of what do you prefer? It's a classical pick 2 out of 3: clean code, fast code, portable code.


---

Comment by fbissey created at 2015-02-26 22:14:38

New hurdle, my hack didn't work because I have mpir 2.6.0 installed, I am guessing the symbol is in 2.7.0. I would have to update mpir as well to make it work.

Yes classic! And it would be nice if it was completed by 6.6 release. Portable gets sage-on-distro out of the hole for this time but it may not go on forever. At some point mpir and gmp may diverge enough that flint or sage will want to do something that is mpir only. That day I think the best thing to do will be to make mpir explicit, at least where it is needed, rather than faking gmp. And pray that linker do their job properly.


---

Comment by fbissey created at 2015-02-27 00:14:18

Upgraded mpir but it still fails. Inspecting libmpir with

```
nm -D /usr/lib64/libmpir.so.16 | grep mpz_set_ux
000000000002ea6e T __gmpz_set_ux
```

And I get the same thing with mpir built in vanilla sage (and the gmp in sage) everything seems to be prefixed with `__g`. Do you have an idea what is going on?


---

Comment by fbissey created at 2015-02-27 01:33:59

got it working by replacing every instances of gmp.h by mpir.h in sage/libs/gmp and replacing all gmp/gmpxx by mpir/mpirxx in module_list.py. Because c_lib, pari, ntl and friends are still linked to gmp I have linking to both gmp and mpir when inspecting with ldd, but readelf on the extension will only show mpir since it is the only one it is directly linked against.

Changing the headers in sage/libs/gmp wasn't enough in that it spread symbol problems in other places. 

Now to run full doctest on the monster.


---

Comment by fbissey created at 2015-02-27 03:56:50

doctest run as normally as expected for sage-on-gentoo on my machine. I was more or less expecting failures in the places where there are gmp(xx) headers outside of sage/libs/gmp but those seem to be more robust.

I would favor portability but that may be a discussion we need to have on sage-devel.


---

Comment by jdemeyer created at 2015-02-28 11:18:07

Replying to [comment:18 fbissey]:
> I would favor portability but that may be a discussion we need to have on sage-devel.
What do you think of my proposal to use `unsigned long`? That would be portable and clean. On 64-bit there would be no difference.

For small inputs, using `unsigned long` will even be faster on 32-bit systems, since the compiler wouldn't need to emulate 64-bit `long long` operations. For larger inputs, there might be a slow-down but it might not be so bad given that there are no native 64-bit operations anyway.


---

Comment by fbissey created at 2015-02-28 11:23:42

Replying to [comment:19 jdemeyer]:
> Replying to [comment:18 fbissey]:
> > I would favor portability but that may be a discussion we need to have on sage-devel.
> What do you think of my proposal to use `unsigned long`? That would be portable and clean. On 64-bit there would be no difference.
> 
> For small inputs, using `unsigned long` will even be faster on 32-bit systems, since the compiler wouldn't need to emulate 64-bit `long long` operations. For larger inputs, there might be a slow-down but it might not be so bad given that there are no native 64-bit operations anyway.


I am OK with using `unsigned long` but it all gave me food for thought.


---

Comment by jdemeyer created at 2015-03-01 09:42:25

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-03-01 11:55:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-03-01 11:57:26

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2015-03-01 20:27:35

mpz_set_ux is still in that patch but it looks like it links ok ok against gmp. Rebuilding and testing, but it should be good.


---

Comment by jdemeyer created at 2015-03-01 20:42:18

Replying to [comment:25 fbissey]:
> mpz_set_ux is still in that patch but it looks like it links ok ok against gmp. Rebuilding and testing, but it should be good.
I left the declaration indeed, but it doesn't hurt...


---

Comment by fbissey created at 2015-03-01 20:57:18

Definitely doesn't, good to go.


---

Comment by fbissey created at 2015-03-01 20:57:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-03 00:25:07

Resolution: fixed
