# Issue 17582: Use uintmax_t for Integer.divisors

archive/issues_017582.json:
```json
{
    "body": "The `divisors` method of `Integer` is implemented using `long long` if possible. However, it would be better to use `uintmax_t` for this, which is at least as large as `long long`. Another advantage is that we no longer need the `mpz_set_longlong()` functions from `c_lib`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17819\n\n",
    "created_at": "2015-02-20T19:27:20Z",
    "labels": [
        "component: c_lib",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Use uintmax_t for Integer.divisors",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17582",
    "user": "https://github.com/jdemeyer"
}
```
The `divisors` method of `Integer` is implemented using `long long` if possible. However, it would be better to use `uintmax_t` for this, which is at least as large as `long long`. Another advantage is that we no longer need the `mpz_set_longlong()` functions from `c_lib`.

Issue created by migration from https://trac.sagemath.org/ticket/17819





---

archive/issue_comments_234510.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-20T21:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234510",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_234511.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-20T21:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234511",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_234512.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-02-21T10:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234512",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_234513.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-22T09:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234513",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_234514.json:
```json
{
    "body": "That sucks. mpz_set_ux isn't in gmp - at least gmp 5.1.3, if you know it is in 6.0.0+ I at least can force an upgrade in sage-on-gentoo. But right now it is a major headache for sage-on-distro (much more so than pari git master).",
    "created_at": "2015-02-26T21:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234514",
    "user": "https://github.com/kiwifb"
}
```

That sucks. mpz_set_ux isn't in gmp - at least gmp 5.1.3, if you know it is in 6.0.0+ I at least can force an upgrade in sage-on-gentoo. But right now it is a major headache for sage-on-distro (much more so than pari git master).



---

archive/issue_comments_234515.json:
```json
{
    "body": "Indeed, those functions seem MPIR-specific. For me personally, that's not an issue (we do use MPIR after all in Sage).",
    "created_at": "2015-02-26T21:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234515",
    "user": "https://github.com/jdemeyer"
}
```

Indeed, those functions seem MPIR-specific. For me personally, that's not an issue (we do use MPIR after all in Sage).



---

archive/issue_comments_234516.json:
```json
{
    "body": "I know it would be less of an issue if other gmp using code had moved to using mpir directly one way or another (flint being the only one) rather than just saying \"you can do that if mpir is installed with gmp-compat\". I think I can do an ugly hack for that one.",
    "created_at": "2015-02-26T21:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234516",
    "user": "https://github.com/kiwifb"
}
```

I know it would be less of an issue if other gmp using code had moved to using mpir directly one way or another (flint being the only one) rather than just saying "you can do that if mpir is installed with gmp-compat". I think I can do an ugly hack for that one.



---

archive/issue_comments_234517.json:
```json
{
    "body": "You mean there would be *less* an issue if *more* code relied on MPIR?",
    "created_at": "2015-02-26T21:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234517",
    "user": "https://github.com/jdemeyer"
}
```

You mean there would be *less* an issue if *more* code relied on MPIR?



---

archive/issue_comments_234518.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> You mean there would be *less* an issue if *more* code relied on MPIR?\n\nWell that would force the hand. \n\nWhat I mean is take pari. You can compile it with mpir by using the gmp compatibility layer. You cannot tell pari to compile directly against mpir, using mpir headers and libmpir. \n\nIf all the packages in the sage stack could do that. It would be easy, install mpir and build everything against it. Reality is everything apart from flint is using gmp and expect gmp. And only use mpir if it is masquerading itself as gmp. \n\nIn a distro where gmp is already installed because of gcc it won't happen unless you can convince the toolchain team of the distro to switch to mpir. Tough job.",
    "created_at": "2015-02-26T21:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234518",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:10 jdemeyer]:
> You mean there would be *less* an issue if *more* code relied on MPIR?

Well that would force the hand. 

What I mean is take pari. You can compile it with mpir by using the gmp compatibility layer. You cannot tell pari to compile directly against mpir, using mpir headers and libmpir. 

If all the packages in the sage stack could do that. It would be easy, install mpir and build everything against it. Reality is everything apart from flint is using gmp and expect gmp. And only use mpir if it is masquerading itself as gmp. 

In a distro where gmp is already installed because of gcc it won't happen unless you can convince the toolchain team of the distro to switch to mpir. Tough job.



---

archive/issue_comments_234519.json:
```json
{
    "body": "We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.",
    "created_at": "2015-02-26T21:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234519",
    "user": "https://github.com/jdemeyer"
}
```

We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.



---

archive/issue_comments_234520.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.\n\nI guess that would be handy but what happens on 32 bits systems? We are still dealing with them for the foreseeable future.\n\nI am trying a hack where integer.pyx and mpz.pxd explicitly use mpir. But not anything else.\n\nI am guessing if mpir is a complete superset of gmp I could switch the whole sage library to explicit mpir. A bit of linking madness but it would work.",
    "created_at": "2015-02-26T21:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234520",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:12 jdemeyer]:
> We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.

I guess that would be handy but what happens on 32 bits systems? We are still dealing with them for the foreseeable future.

I am trying a hack where integer.pyx and mpz.pxd explicitly use mpir. But not anything else.

I am guessing if mpir is a complete superset of gmp I could switch the whole sage library to explicit mpir. A bit of linking madness but it would work.



---

archive/issue_comments_234521.json:
```json
{
    "body": "Replying to [comment:13 fbissey]:\n> Replying to [comment:12 jdemeyer]:\n> > We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.\n> \n> I guess that would be handy but what happens on 32 bits systems?\nWhen using `unsigned long`, stuff would become slower for 32-bit systems. It's really a matter of what do you prefer? It's a classical pick 2 out of 3: clean code, fast code, portable code.",
    "created_at": "2015-02-26T22:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234521",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 fbissey]:
> Replying to [comment:12 jdemeyer]:
> > We could also replace `uintmax_t` by `unsigned long` which is usually the same on 64-bit systems and which doesn't have portability issues.
> 
> I guess that would be handy but what happens on 32 bits systems?
When using `unsigned long`, stuff would become slower for 32-bit systems. It's really a matter of what do you prefer? It's a classical pick 2 out of 3: clean code, fast code, portable code.



---

archive/issue_comments_234522.json:
```json
{
    "body": "New hurdle, my hack didn't work because I have mpir 2.6.0 installed, I am guessing the symbol is in 2.7.0. I would have to update mpir as well to make it work.\n\nYes classic! And it would be nice if it was completed by 6.6 release. Portable gets sage-on-distro out of the hole for this time but it may not go on forever. At some point mpir and gmp may diverge enough that flint or sage will want to do something that is mpir only. That day I think the best thing to do will be to make mpir explicit, at least where it is needed, rather than faking gmp. And pray that linker do their job properly.",
    "created_at": "2015-02-26T22:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234522",
    "user": "https://github.com/kiwifb"
}
```

New hurdle, my hack didn't work because I have mpir 2.6.0 installed, I am guessing the symbol is in 2.7.0. I would have to update mpir as well to make it work.

Yes classic! And it would be nice if it was completed by 6.6 release. Portable gets sage-on-distro out of the hole for this time but it may not go on forever. At some point mpir and gmp may diverge enough that flint or sage will want to do something that is mpir only. That day I think the best thing to do will be to make mpir explicit, at least where it is needed, rather than faking gmp. And pray that linker do their job properly.



---

archive/issue_comments_234523.json:
```json
{
    "body": "Upgraded mpir but it still fails. Inspecting libmpir with\n\n```\nnm -D /usr/lib64/libmpir.so.16 | grep mpz_set_ux\n000000000002ea6e T __gmpz_set_ux\n```\n\nAnd I get the same thing with mpir built in vanilla sage (and the gmp in sage) everything seems to be prefixed with `__g`. Do you have an idea what is going on?",
    "created_at": "2015-02-27T00:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234523",
    "user": "https://github.com/kiwifb"
}
```

Upgraded mpir but it still fails. Inspecting libmpir with

```
nm -D /usr/lib64/libmpir.so.16 | grep mpz_set_ux
000000000002ea6e T __gmpz_set_ux
```

And I get the same thing with mpir built in vanilla sage (and the gmp in sage) everything seems to be prefixed with `__g`. Do you have an idea what is going on?



---

archive/issue_comments_234524.json:
```json
{
    "body": "got it working by replacing every instances of gmp.h by mpir.h in sage/libs/gmp and replacing all gmp/gmpxx by mpir/mpirxx in module_list.py. Because c_lib, pari, ntl and friends are still linked to gmp I have linking to both gmp and mpir when inspecting with ldd, but readelf on the extension will only show mpir since it is the only one it is directly linked against.\n\nChanging the headers in sage/libs/gmp wasn't enough in that it spread symbol problems in other places. \n\nNow to run full doctest on the monster.",
    "created_at": "2015-02-27T01:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234524",
    "user": "https://github.com/kiwifb"
}
```

got it working by replacing every instances of gmp.h by mpir.h in sage/libs/gmp and replacing all gmp/gmpxx by mpir/mpirxx in module_list.py. Because c_lib, pari, ntl and friends are still linked to gmp I have linking to both gmp and mpir when inspecting with ldd, but readelf on the extension will only show mpir since it is the only one it is directly linked against.

Changing the headers in sage/libs/gmp wasn't enough in that it spread symbol problems in other places. 

Now to run full doctest on the monster.



---

archive/issue_comments_234525.json:
```json
{
    "body": "doctest run as normally as expected for sage-on-gentoo on my machine. I was more or less expecting failures in the places where there are gmp(xx) headers outside of sage/libs/gmp but those seem to be more robust.\n\nI would favor portability but that may be a discussion we need to have on sage-devel.",
    "created_at": "2015-02-27T03:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234525",
    "user": "https://github.com/kiwifb"
}
```

doctest run as normally as expected for sage-on-gentoo on my machine. I was more or less expecting failures in the places where there are gmp(xx) headers outside of sage/libs/gmp but those seem to be more robust.

I would favor portability but that may be a discussion we need to have on sage-devel.



---

archive/issue_comments_234526.json:
```json
{
    "body": "Replying to [comment:18 fbissey]:\n> I would favor portability but that may be a discussion we need to have on sage-devel.\nWhat do you think of my proposal to use `unsigned long`? That would be portable and clean. On 64-bit there would be no difference.\n\nFor small inputs, using `unsigned long` will even be faster on 32-bit systems, since the compiler wouldn't need to emulate 64-bit `long long` operations. For larger inputs, there might be a slow-down but it might not be so bad given that there are no native 64-bit operations anyway.",
    "created_at": "2015-02-28T11:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234526",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:18 fbissey]:
> I would favor portability but that may be a discussion we need to have on sage-devel.
What do you think of my proposal to use `unsigned long`? That would be portable and clean. On 64-bit there would be no difference.

For small inputs, using `unsigned long` will even be faster on 32-bit systems, since the compiler wouldn't need to emulate 64-bit `long long` operations. For larger inputs, there might be a slow-down but it might not be so bad given that there are no native 64-bit operations anyway.



---

archive/issue_comments_234527.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> Replying to [comment:18 fbissey]:\n> > I would favor portability but that may be a discussion we need to have on sage-devel.\n> What do you think of my proposal to use `unsigned long`? That would be portable and clean. On 64-bit there would be no difference.\n> \n> For small inputs, using `unsigned long` will even be faster on 32-bit systems, since the compiler wouldn't need to emulate 64-bit `long long` operations. For larger inputs, there might be a slow-down but it might not be so bad given that there are no native 64-bit operations anyway.\n\n\nI am OK with using `unsigned long` but it all gave me food for thought.",
    "created_at": "2015-02-28T11:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234527",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:19 jdemeyer]:
> Replying to [comment:18 fbissey]:
> > I would favor portability but that may be a discussion we need to have on sage-devel.
> What do you think of my proposal to use `unsigned long`? That would be portable and clean. On 64-bit there would be no difference.
> 
> For small inputs, using `unsigned long` will even be faster on 32-bit systems, since the compiler wouldn't need to emulate 64-bit `long long` operations. For larger inputs, there might be a slow-down but it might not be so bad given that there are no native 64-bit operations anyway.


I am OK with using `unsigned long` but it all gave me food for thought.



---

archive/issue_comments_234528.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-01T09:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234528",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_234529.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-01T11:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234529",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_234530.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-01T11:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234530",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_234531.json:
```json
{
    "body": "mpz_set_ux is still in that patch but it looks like it links ok ok against gmp. Rebuilding and testing, but it should be good.",
    "created_at": "2015-03-01T20:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234531",
    "user": "https://github.com/kiwifb"
}
```

mpz_set_ux is still in that patch but it looks like it links ok ok against gmp. Rebuilding and testing, but it should be good.



---

archive/issue_comments_234532.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> mpz_set_ux is still in that patch but it looks like it links ok ok against gmp. Rebuilding and testing, but it should be good.\nI left the declaration indeed, but it doesn't hurt...",
    "created_at": "2015-03-01T20:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234532",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 fbissey]:
> mpz_set_ux is still in that patch but it looks like it links ok ok against gmp. Rebuilding and testing, but it should be good.
I left the declaration indeed, but it doesn't hurt...



---

archive/issue_comments_234533.json:
```json
{
    "body": "Definitely doesn't, good to go.",
    "created_at": "2015-03-01T20:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234533",
    "user": "https://github.com/kiwifb"
}
```

Definitely doesn't, good to go.



---

archive/issue_comments_234534.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-01T20:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234534",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_234535.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-03-03T00:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17582#issuecomment-234535",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
