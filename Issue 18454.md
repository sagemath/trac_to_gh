# Issue 18454: Trac #17572 breaks the installation of several R packages.

archive/issues_018454.json:
```json
{
    "body": "CC:  @DrXyzzy @kiwifb @jdemeyer @vbraun jpswanson @kcrisman\n\nKeywords: r-project\n\nSince 6.8.beta1, some packages (among them \"git2r\" and, therefore, \"devtools\" that depends on it, no longer install.\n\nThses package seem to depend on Makevars ; \"git2r\" definitely depends on Makevars.\n\ngit bisect points to commit bb5c9f3a2d9a6edcffe787716faa91fa5fd4aed6, which is in #17572, as the source of the problem. Indeed : bb5c9f3a... is entitled \"Do not let R use global or user-local Makevars\".\n\nI am afraid that this solution cannot be accepted : it breaks existing R packages, finctional in all \"normal\" R installations. Furthermore, it breaks a mechanism documented upstream as legitimate for future packages.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18691\n\n",
    "created_at": "2015-06-12T20:28:12Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Trac #17572 breaks the installation of several R packages.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18454",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
CC:  @DrXyzzy @kiwifb @jdemeyer @vbraun jpswanson @kcrisman

Keywords: r-project

Since 6.8.beta1, some packages (among them "git2r" and, therefore, "devtools" that depends on it, no longer install.

Thses package seem to depend on Makevars ; "git2r" definitely depends on Makevars.

git bisect points to commit bb5c9f3a2d9a6edcffe787716faa91fa5fd4aed6, which is in #17572, as the source of the problem. Indeed : bb5c9f3a... is entitled "Do not let R use global or user-local Makevars".

I am afraid that this solution cannot be accepted : it breaks existing R packages, finctional in all "normal" R installations. Furthermore, it breaks a mechanism documented upstream as legitimate for future packages.

Issue created by migration from https://trac.sagemath.org/ticket/18691





---

archive/issue_comments_250412.json:
```json
{
    "body": "Could we set `R_MAKEVARS_USER` to something like `\"$DOT_SAGE/R/Makevars.user\"`? Would that help? (We already do this kind of thing with IPython and matplotlib.)",
    "created_at": "2015-06-12T20:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250412",
    "user": "https://github.com/jhpalmieri"
}
```

Could we set `R_MAKEVARS_USER` to something like `"$DOT_SAGE/R/Makevars.user"`? Would that help? (We already do this kind of thing with IPython and matplotlib.)



---

archive/issue_comments_250413.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-14T19:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250413",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_250414.json:
```json
{
    "body": "The proposed patch is a \"damage control\" patch limiting the effect of #17572 to Darwin OS. Edit : the resultant Sage passes `ptestlong` with `\"All tests passed !\"`.\n\nRationale : the problem (mis-)fixed by #17572 seems to be limited to machines running clang. It seems, from reading pages pointed to in the discussion of this patch, that this happens on Mac OS X due to slightly suboptimal apple development software.\n\nAs already seen, this \"solution\" breaks the installation of several R packages, which explicitly check for systemwide `Makevars` or user-specific `Makevars.user` set by way of R_HOME and R_PROFILE environment variables.\n\nOur current solution is to unset these variables and export the variables `R_MAKEVARS_SITE` and `R_MAKEVARS_SITE`, pointing to convenient Sage-specific versions of similarly named files. As far as I can tell, we do **not** have such files, which breaks the build of some R packages.\n\nI do not have a Mac, and I do not use clang. Therefore, I'm ill-qualified to propose a solution. A **stopgap** could be to create such **empty** files at R installation, and keep the patch as it curently is.\n\nHowever, I do not understand **why** clang breaks when the relevant variables are not defined, and why gcc breaks when they are defined as pointing to nonexistent files.\n\nSo we have a few courses of action :\n\n1. keep #17572 as it is now, and add the creation of empty Makevars.site and Makevars.user somewhere at the end of the R installation script. Not that easy,..\n\n2. Limit #17572 to Darwin machines (= current damage control patch) and find some apple-specific way to fix the problem of non-installing R packages.\n\n3. Revert #17572 entierely and find some other way to induce clang that it can in fact run without these environment variables.\n\nIn any case, fixing this one needs the expertise of someone having access to a clang-plagued Mac OS X machine. I can't test a solution of this combination.\n\nI put this \"damage control\" patch as `needs_review`. Feel free to pull it back to `needs_work` if you have some proposal to implement solutions 1 or 3. Or something else entirely...\n\n---\nNew commits:",
    "created_at": "2015-06-14T19:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250414",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

The proposed patch is a "damage control" patch limiting the effect of #17572 to Darwin OS. Edit : the resultant Sage passes `ptestlong` with `"All tests passed !"`.

Rationale : the problem (mis-)fixed by #17572 seems to be limited to machines running clang. It seems, from reading pages pointed to in the discussion of this patch, that this happens on Mac OS X due to slightly suboptimal apple development software.

As already seen, this "solution" breaks the installation of several R packages, which explicitly check for systemwide `Makevars` or user-specific `Makevars.user` set by way of R_HOME and R_PROFILE environment variables.

Our current solution is to unset these variables and export the variables `R_MAKEVARS_SITE` and `R_MAKEVARS_SITE`, pointing to convenient Sage-specific versions of similarly named files. As far as I can tell, we do **not** have such files, which breaks the build of some R packages.

I do not have a Mac, and I do not use clang. Therefore, I'm ill-qualified to propose a solution. A **stopgap** could be to create such **empty** files at R installation, and keep the patch as it curently is.

However, I do not understand **why** clang breaks when the relevant variables are not defined, and why gcc breaks when they are defined as pointing to nonexistent files.

So we have a few courses of action :

1. keep #17572 as it is now, and add the creation of empty Makevars.site and Makevars.user somewhere at the end of the R installation script. Not that easy,..

2. Limit #17572 to Darwin machines (= current damage control patch) and find some apple-specific way to fix the problem of non-installing R packages.

3. Revert #17572 entierely and find some other way to induce clang that it can in fact run without these environment variables.

In any case, fixing this one needs the expertise of someone having access to a clang-plagued Mac OS X machine. I can't test a solution of this combination.

I put this "damage control" patch as `needs_review`. Feel free to pull it back to `needs_work` if you have some proposal to implement solutions 1 or 3. Or something else entirely...

---
New commits:



---

archive/issue_comments_250415.json:
```json
{
    "body": "If the packages trip over missing files then we can just create them at the end of the R spkg-install",
    "created_at": "2015-06-14T19:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250415",
    "user": "https://github.com/vbraun"
}
```

If the packages trip over missing files then we can just create them at the end of the R spkg-install



---

archive/issue_comments_250416.json:
```json
{
    "body": "I think we need to be more careful there. #17572 is caused by interference with another `R` install on the system. Whether there is breakage or not that is a problem. You don't usually see it on non-apple because your system variable and sage variables are likely to be similar. But it also means that you will share the installed package between your `R` install outside of sage and the one installed in sage.\n\nThat is not sane. \n\nI think we would be better served by defining `R_HOME` in the sage environment rather than bluntly unseting it. I unfortunately do not keep crap in `/usr/local` on my apple machine (I know better, and so should a lot of people) so meaningful testing is hard for me.",
    "created_at": "2015-06-14T21:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250416",
    "user": "https://github.com/kiwifb"
}
```

I think we need to be more careful there. #17572 is caused by interference with another `R` install on the system. Whether there is breakage or not that is a problem. You don't usually see it on non-apple because your system variable and sage variables are likely to be similar. But it also means that you will share the installed package between your `R` install outside of sage and the one installed in sage.

That is not sane. 

I think we would be better served by defining `R_HOME` in the sage environment rather than bluntly unseting it. I unfortunately do not keep crap in `/usr/local` on my apple machine (I know better, and so should a lot of people) so meaningful testing is hard for me.



---

archive/issue_comments_250417.json:
```json
{
    "body": "Looking at it more closely #17572 may have erred when defining `R_MAKEVARS_USER`. `R_MAKEVARS_SITE` is tested for existence before being used in `local/lib/R/bin/config` but the same file only test `R_MAKEVARS_USER` to be defined and will assume that if it is defined it must exist. I think upstream should check for its existence too.\n\nI am curious Emmanuel, would replacing the line `R_MAKEVARS_USER=\"$SAGE_LOCAL/lib/R/share/Makevars.user\" && export R_MAKEVARS_USER` by `unset R_MAKEVARS_USER` be enough to solve your difficulties?",
    "created_at": "2015-06-14T23:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250417",
    "user": "https://github.com/kiwifb"
}
```

Looking at it more closely #17572 may have erred when defining `R_MAKEVARS_USER`. `R_MAKEVARS_SITE` is tested for existence before being used in `local/lib/R/bin/config` but the same file only test `R_MAKEVARS_USER` to be defined and will assume that if it is defined it must exist. I think upstream should check for its existence too.

I am curious Emmanuel, would replacing the line `R_MAKEVARS_USER="$SAGE_LOCAL/lib/R/share/Makevars.user" && export R_MAKEVARS_USER` by `unset R_MAKEVARS_USER` be enough to solve your difficulties?



---

archive/issue_comments_250418.json:
```json
{
    "body": "In fact both `R_MAKEVARS_*` variables should have been unset. If `R_MAKEVARS_SITE` is unset it will be set to a default value which is sane, or at least should\n\n```\n: ${R_MAKEVARS_SITE=\"${R_HOME}/etc${R_ARCH}/Makevars.site\"}\n```\nJust to double check is it a correct syntax above, or is it a bug upstream and it should be `${...:=...}` instead of `: ${...=...}`?",
    "created_at": "2015-06-14T23:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250418",
    "user": "https://github.com/kiwifb"
}
```

In fact both `R_MAKEVARS_*` variables should have been unset. If `R_MAKEVARS_SITE` is unset it will be set to a default value which is sane, or at least should

```
: ${R_MAKEVARS_SITE="${R_HOME}/etc${R_ARCH}/Makevars.site"}
```
Just to double check is it a correct syntax above, or is it a bug upstream and it should be `${...:=...}` instead of `: ${...=...}`?



---

archive/issue_comments_250419.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T05:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250419",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250420.json:
```json
{
    "body": "Second proposal :\n\n* Do not make Darwin a special case.\n* Create Sage-specific Makevars files if necessary.\n\nThe site-wide Makevars file goes into the `$SAGE_LOCAL` tree, the user-specific file in his/her/its `$DOT_SAGE` tree.\n\nThis is done in the `sage-env` script (in order to check this at each and every Sage use, and avoid damaging a file created only at installation time.\n\nThis works for me (C)(R)(TM)... This patch needs attention of Apple users ! ==> `needs_review`.",
    "created_at": "2015-06-18T05:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250420",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Second proposal :

* Do not make Darwin a special case.
* Create Sage-specific Makevars files if necessary.

The site-wide Makevars file goes into the `$SAGE_LOCAL` tree, the user-specific file in his/her/its `$DOT_SAGE` tree.

This is done in the `sage-env` script (in order to check this at each and every Sage use, and avoid damaging a file created only at installation time.

This works for me (C)(R)(TM)... This patch needs attention of Apple users ! ==> `needs_review`.



---

archive/issue_comments_250421.json:
```json
{
    "body": "As is it should work but the creation of the file `$R_MAKEVARS_SITE` is unnecessary as `R` checks that it exist (from `SAGE_LOCAL/lib/R/bin/config`)\n\n```\nif test \"${site}\" = \"yes\"; then\n: ${R_MAKEVARS_SITE=\"${R_HOME}/etc${R_ARCH}/Makevars.site\"}\n  if test -f \"${R_MAKEVARS_SITE}\"; then\n    makefiles=\"${makefiles} -f ${R_MAKEVARS_SITE}\"\n  fi\nfi\n```\nThe existence of `$R_MAKEVARS_USER` however is not tested, only that the variable is not empty, so populating it when we define it is a really good idea. \n\nOn a separate remark on style you should quote both ` R_MAKEVARS_SITE` and `R_MAKEVARS_USER` as they are paths that can potentially contain spaces.",
    "created_at": "2015-06-18T08:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250421",
    "user": "https://github.com/kiwifb"
}
```

As is it should work but the creation of the file `$R_MAKEVARS_SITE` is unnecessary as `R` checks that it exist (from `SAGE_LOCAL/lib/R/bin/config`)

```
if test "${site}" = "yes"; then
: ${R_MAKEVARS_SITE="${R_HOME}/etc${R_ARCH}/Makevars.site"}
  if test -f "${R_MAKEVARS_SITE}"; then
    makefiles="${makefiles} -f ${R_MAKEVARS_SITE}"
  fi
fi
```
The existence of `$R_MAKEVARS_USER` however is not tested, only that the variable is not empty, so populating it when we define it is a really good idea. 

On a separate remark on style you should quote both ` R_MAKEVARS_SITE` and `R_MAKEVARS_USER` as they are paths that can potentially contain spaces.



---

archive/issue_comments_250422.json:
```json
{
    "body": "Oh and I completely approve the new location of `R_MAKEVARS_USER`, this is really where it belongs and make it useful for a system wide install of `sage`. The previous location not so much.",
    "created_at": "2015-06-18T09:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250422",
    "user": "https://github.com/kiwifb"
}
```

Oh and I completely approve the new location of `R_MAKEVARS_USER`, this is really where it belongs and make it useful for a system wide install of `sage`. The previous location not so much.



---

archive/issue_comments_250423.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T10:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250423",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250424.json:
```json
{
    "body": "Also quote on the right hand of the two `echo` commands `{}` is not the same thing.",
    "created_at": "2015-06-18T10:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250424",
    "user": "https://github.com/kiwifb"
}
```

Also quote on the right hand of the two `echo` commands `{}` is not the same thing.



---

archive/issue_comments_250425.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T10:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250425",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250426.json:
```json
{
    "body": "Fran\u00e7ois,\n\nGood catch for the need to quote paths. I have been Windows-weaned too long ago to really think about these follies...\n\nSkipping the site variable : I'm not so sure : the R statrup code is a bit of a fisherman's net, and I am not sure that an R package (for example) does not use it cavalierly in a situation where it does not exists. So my paranoid version takes care of that.\n\nWould you care to formally review this ?\n\n---\nNew commits:",
    "created_at": "2015-06-18T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250426",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

FranÃ§ois,

Good catch for the need to quote paths. I have been Windows-weaned too long ago to really think about these follies...

Skipping the site variable : I'm not so sure : the R statrup code is a bit of a fisherman's net, and I am not sure that an R package (for example) does not use it cavalierly in a situation where it does not exists. So my paranoid version takes care of that.

Would you care to formally review this ?

---
New commits:



---

archive/issue_comments_250427.json:
```json
{
    "body": "Further comment : if The Apple cimpiler (clang) really needs permanent supplementary flags to be useful with R, a patch to this effect should be submitted upstream.\n\nIf it happens only with Sage, **another** ticket, clearly marked as Apple-specific, should be opened to this end.",
    "created_at": "2015-06-18T10:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250427",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Further comment : if The Apple cimpiler (clang) really needs permanent supplementary flags to be useful with R, a patch to this effect should be submitted upstream.

If it happens only with Sage, **another** ticket, clearly marked as Apple-specific, should be opened to this end.



---

archive/issue_comments_250428.json:
```json
{
    "body": "Can you use `-f` instead of `-a` (I actually had to look up what `-a` does!)\n\nAnd if the file does not exist, using `>>` (for append) looks strange, better use `>`.",
    "created_at": "2015-06-18T10:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250428",
    "user": "https://github.com/jdemeyer"
}
```

Can you use `-f` instead of `-a` (I actually had to look up what `-a` does!)

And if the file does not exist, using `>>` (for append) looks strange, better use `>`.



---

archive/issue_comments_250429.json:
```json
{
    "body": "Formally yes, that's what I am doing now :) `R_MAKEVARS_USER=\"$DOT_SAGE/SagesRMakevars.user\"}` You seem to have a lose end bracket that should go.\n\nAs to regards to `clang` currently we cannot compile sage with it at this stage (and we still need a fortran compiler to complicate things). The problem with `clang` which launched all those problems is that settings for another install outside of sage (probably done with `clang` as a matter of fact) got pulled into `sage` during while `R` was being built. `R` kind of has two building phases. In a first step `R` proper is being built. Then standard package are being built and that's when the mix up occurred.\n\nI also agree with Jeroen's comments.",
    "created_at": "2015-06-18T10:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250429",
    "user": "https://github.com/kiwifb"
}
```

Formally yes, that's what I am doing now :) `R_MAKEVARS_USER="$DOT_SAGE/SagesRMakevars.user"}` You seem to have a lose end bracket that should go.

As to regards to `clang` currently we cannot compile sage with it at this stage (and we still need a fortran compiler to complicate things). The problem with `clang` which launched all those problems is that settings for another install outside of sage (probably done with `clang` as a matter of fact) got pulled into `sage` during while `R` was being built. `R` kind of has two building phases. In a first step `R` proper is being built. Then standard package are being built and that's when the mix up occurred.

I also agree with Jeroen's comments.



---

archive/issue_comments_250430.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T10:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250430",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250431.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> Can you use `-f` instead of `-a` (I actually had to look up what `-a` does!)\n\n\n`-a` is **intentional** : either Makevar file could be a symlink to a machine- or project-specific Makevar file, and Sage should respect this if it has been so positioned by the user.\n\n> And if the file does not exist, using `>>` (for append) looks strange, better use `>`.\n\n\nThat's nitpicking. But so be it (commit under way)...\n\n---\nNew commits:",
    "created_at": "2015-06-18T10:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250431",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:17 jdemeyer]:
> Can you use `-f` instead of `-a` (I actually had to look up what `-a` does!)


`-a` is **intentional** : either Makevar file could be a symlink to a machine- or project-specific Makevar file, and Sage should respect this if it has been so positioned by the user.

> And if the file does not exist, using `>>` (for append) looks strange, better use `>`.


That's nitpicking. But so be it (commit under way)...

---
New commits:



---

archive/issue_comments_250432.json:
```json
{
    "body": "Dangling right bracket `}` still there.",
    "created_at": "2015-06-18T11:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250432",
    "user": "https://github.com/kiwifb"
}
```

Dangling right bracket `}` still there.



---

archive/issue_comments_250433.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-18T11:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250433",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_250434.json:
```json
{
    "body": "Replying to [comment:20 charpent]:\n> Replying to [comment:17 jdemeyer]:\n> > Can you use `-f` instead of `-a` (I actually had to look up what `-a` does!)\n\n> \n> `-a` is **intentional** : either Makevar file could be a symlink to a machine- or project-specific Makevar file, and Sage should respect this if it has been so positioned by the user.\n\n\nIf you think that `-f` will not work with symlinks, you are mistaken. Being a file and being a symlink are independent. In particular, a symlink to an existing file is considered to be both a file and a symlink.\n\nYou really want to use `-f` here, since `-a` will match directories (and other weird things like devices,...) and you don't want that. Moreover, `-f` is more portable than `-a`.",
    "created_at": "2015-06-18T11:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250434",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:20 charpent]:
> Replying to [comment:17 jdemeyer]:
> > Can you use `-f` instead of `-a` (I actually had to look up what `-a` does!)

> 
> `-a` is **intentional** : either Makevar file could be a symlink to a machine- or project-specific Makevar file, and Sage should respect this if it has been so positioned by the user.


If you think that `-f` will not work with symlinks, you are mistaken. Being a file and being a symlink are independent. In particular, a symlink to an existing file is considered to be both a file and a symlink.

You really want to use `-f` here, since `-a` will match directories (and other weird things like devices,...) and you don't want that. Moreover, `-f` is more portable than `-a`.



---

archive/issue_comments_250435.json:
```json
{
    "body": "Replying to [comment:18 fbissey]:\n> As to regards to `clang` currently we cannot compile sage with it at this stage (and we still need a fortran compiler to complicate things).\n\n\nFortran *significantly* complicates things for R: it needs to link together C and Fortran code and that only works if the C and Fortran compilers are sufficiently compatible.",
    "created_at": "2015-06-18T11:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250435",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:18 fbissey]:
> As to regards to `clang` currently we cannot compile sage with it at this stage (and we still need a fortran compiler to complicate things).


Fortran *significantly* complicates things for R: it needs to link together C and Fortran code and that only works if the C and Fortran compilers are sufficiently compatible.



---

archive/issue_comments_250436.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T12:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250436",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250437.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> Dangling right bracket `}` still there.\n\n\nThis zombie should be off for good now...",
    "created_at": "2015-06-18T12:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250437",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:21 fbissey]:
> Dangling right bracket `}` still there.


This zombie should be off for good now...



---

archive/issue_comments_250438.json:
```json
{
    "body": "Did you forget an `echo`?\n\n```\n>&2 \"Warning: $R_MAKEVARS_SITE exists and is not a file : trouble ahead...\"\n```\n\n(personally, I would just drop the `-a` test, it's over-complicating things for no clear advantage)",
    "created_at": "2015-06-18T12:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250438",
    "user": "https://github.com/jdemeyer"
}
```

Did you forget an `echo`?

```
>&2 "Warning: $R_MAKEVARS_SITE exists and is not a file : trouble ahead..."
```

(personally, I would just drop the `-a` test, it's over-complicating things for no clear advantage)



---

archive/issue_comments_250439.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> Did you forget an `echo`?\n\n\nIndeed... patch on the way.\n\n> {{{\n> >&2 \"Warning: $R_MAKEVARS_SITE exists and is not a file : trouble ahead...\"\n\n> }}}\n> \n> (personally, I would just drop the `-a` test, it's over-complicating things for no clear advantage)\n\n\nBasic surgeon's conditioning : if you don't see it, don't cut it ! We want to avoid overwriting something in the way as long as we don't know what is it and how it landed here...",
    "created_at": "2015-06-18T12:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250439",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:26 jdemeyer]:
> Did you forget an `echo`?


Indeed... patch on the way.

> {{{
> >&2 "Warning: $R_MAKEVARS_SITE exists and is not a file : trouble ahead..."

> }}}
> 
> (personally, I would just drop the `-a` test, it's over-complicating things for no clear advantage)


Basic surgeon's conditioning : if you don't see it, don't cut it ! We want to avoid overwriting something in the way as long as we don't know what is it and how it landed here...



---

archive/issue_comments_250440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T12:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250441.json:
```json
{
    "body": "Forgot to update status.",
    "created_at": "2015-06-18T14:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250441",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Forgot to update status.



---

archive/issue_comments_250442.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-18T14:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250442",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_250443.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Replying to [comment:18 fbissey]:\n> > As to regards to `clang` currently we cannot compile sage with it at this stage (and we still need a fortran compiler to complicate things).\n\n> \n> Fortran *significantly* complicates things for R: it needs to link together C and Fortran code and that only works if the C and Fortran compilers are sufficiently compatible.\n\n\nIt is worse than that. `R`'s configure script identifies clearly how to mix C and fortran, i.e. it looks at your fortran compiler and identifies the necessary mangling. At least one of the standard `R` packages that are built by default just assume `gfortran` style mangling for their calls to blas/lapack functions. So whatever fortran compiler you use to build `R` you have to make it behave like `gfortran`.",
    "created_at": "2015-06-18T22:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250443",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:23 jdemeyer]:
> Replying to [comment:18 fbissey]:
> > As to regards to `clang` currently we cannot compile sage with it at this stage (and we still need a fortran compiler to complicate things).

> 
> Fortran *significantly* complicates things for R: it needs to link together C and Fortran code and that only works if the C and Fortran compilers are sufficiently compatible.


It is worse than that. `R`'s configure script identifies clearly how to mix C and fortran, i.e. it looks at your fortran compiler and identifies the necessary mangling. At least one of the standard `R` packages that are built by default just assume `gfortran` style mangling for their calls to blas/lapack functions. So whatever fortran compiler you use to build `R` you have to make it behave like `gfortran`.



---

archive/issue_comments_250444.json:
```json
{
    "body": "Does anybody thinks that this patch (#18691) needs further work, or can we move to review ?",
    "created_at": "2015-06-23T09:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250444",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Does anybody thinks that this patch (#18691) needs further work, or can we move to review ?



---

archive/issue_comments_250445.json:
```json
{
    "body": "I'd rename `$DOT_SAGE/SagesRMakevars.user` to `$DOT_SAGE/R/Makevars.user`; rest looks ok\n* no need to put Sage into the filename, its in dotsage already\n* provide a place for future R-in-Sage specific stuff",
    "created_at": "2015-06-23T10:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250445",
    "user": "https://github.com/vbraun"
}
```

I'd rename `$DOT_SAGE/SagesRMakevars.user` to `$DOT_SAGE/R/Makevars.user`; rest looks ok
* no need to put Sage into the filename, its in dotsage already
* provide a place for future R-in-Sage specific stuff



---

archive/issue_comments_250446.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-23T12:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250446",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250447.json:
```json
{
    "body": "Replying to [comment:32 vbraun]:\n> I'd rename `$DOT_SAGE/SagesRMakevars.user` to `$DOT_SAGE/R/Makevars.user`; rest looks ok\n> * no need to put Sage into the filename, its in dotsage already\n\n\nIndeed. Good point.\n\n> * provide a place for future R-in-Sage specific stuff\n\n\nNice idea ... provided that this doesn't generate a drift from \"standalone R\". Apple-specific difficulties with Fortran are bad enough, we don't want to find ourselves maintaining a semi-clandestine fork...\n\nStill needs review...",
    "created_at": "2015-06-23T12:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250447",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:32 vbraun]:
> I'd rename `$DOT_SAGE/SagesRMakevars.user` to `$DOT_SAGE/R/Makevars.user`; rest looks ok
> * no need to put Sage into the filename, its in dotsage already


Indeed. Good point.

> * provide a place for future R-in-Sage specific stuff


Nice idea ... provided that this doesn't generate a drift from "standalone R". Apple-specific difficulties with Fortran are bad enough, we don't want to find ourselves maintaining a semi-clandestine fork...

Still needs review...



---

archive/issue_comments_250448.json:
```json
{
    "body": "While probably not necessary, I would feel better if you were using `mkdir -p` as `$DOT_SAGE` is no guaranteed to exist (but will probably be created by the time you get there).",
    "created_at": "2015-06-23T12:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250448",
    "user": "https://github.com/kiwifb"
}
```

While probably not necessary, I would feel better if you were using `mkdir -p` as `$DOT_SAGE` is no guaranteed to exist (but will probably be created by the time you get there).



---

archive/issue_comments_250449.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-23T12:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250449",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250450.json:
```json
{
    "body": "Replying to [comment:35 fbissey]:\n> While probably not necessary, I would feel better if you were using `mkdir -p` as `$DOT_SAGE` is no guaranteed to exist (but will probably be created by the time you get there).\n\n\nDone. Feeling better ?",
    "created_at": "2015-06-23T12:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250450",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:35 fbissey]:
> While probably not necessary, I would feel better if you were using `mkdir -p` as `$DOT_SAGE` is no guaranteed to exist (but will probably be created by the time you get there).


Done. Feeling better ?



---

archive/issue_comments_250451.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-23T12:40:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250451",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_250452.json:
```json
{
    "body": "Much better thank you. I think it is good to go now.",
    "created_at": "2015-06-23T12:40:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250452",
    "user": "https://github.com/kiwifb"
}
```

Much better thank you. I think it is good to go now.



---

archive/issue_events_052384.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-24T11:37:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18454#event-52384"
}
```



---

archive/issue_comments_250453.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-24T11:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250453",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_250454.json:
```json
{
    "body": "Starting with a clean install of Sage, this leads to an error message at the start of building (as soon as `sage-env` is run):\n\n```\n$ make\nmkdir -p logs\ncd build && \\\n\t\"../build/pipestatus\" \\\n\t\t\"./install all 2>&1\" \\\n\t\t\"tee -a ../logs/install.log\"\n/Users/palmieri/sage-6.8.beta6/src/bin/sage-env: line 434: /Users/palmieri/sage-6.8.beta6/local/lib/R/share/Makevars.site: No such file or directory\n```\nThis is because the directory `$SAGE_LOCAL/lib/R/share/` does not yet exist, so the redirection \n\n```\necho \"## Empty site-wide Makevars file for Sage's R\" > \"$R_MAKEVARS_SITE\"\n```\nfails. The build continues anyway, and I guess the file should be created when Sage is next run, but would it be better to create this file when installing `R` (that is, in `build/pkgs/r/spkg-install`)? Or at least to check if the directory exists before trying to create the file, to avoid a needless error message?",
    "created_at": "2015-07-01T05:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250454",
    "user": "https://github.com/jhpalmieri"
}
```

Starting with a clean install of Sage, this leads to an error message at the start of building (as soon as `sage-env` is run):

```
$ make
mkdir -p logs
cd build && \
	"../build/pipestatus" \
		"./install all 2>&1" \
		"tee -a ../logs/install.log"
/Users/palmieri/sage-6.8.beta6/src/bin/sage-env: line 434: /Users/palmieri/sage-6.8.beta6/local/lib/R/share/Makevars.site: No such file or directory
```
This is because the directory `$SAGE_LOCAL/lib/R/share/` does not yet exist, so the redirection 

```
echo "## Empty site-wide Makevars file for Sage's R" > "$R_MAKEVARS_SITE"
```
fails. The build continues anyway, and I guess the file should be created when Sage is next run, but would it be better to create this file when installing `R` (that is, in `build/pkgs/r/spkg-install`)? Or at least to check if the directory exists before trying to create the file, to avoid a needless error message?



---

archive/issue_comments_250455.json:
```json
{
    "body": "I should have flat refused the definition of `R_MAKEVARS_SITE` the default is just fine, we should have unset any definition from the environment so it doesn't pollute the sage one. I have seen the message too, not hurting the build but not a nice artefact.",
    "created_at": "2015-07-01T06:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250455",
    "user": "https://github.com/kiwifb"
}
```

I should have flat refused the definition of `R_MAKEVARS_SITE` the default is just fine, we should have unset any definition from the environment so it doesn't pollute the sage one. I have seen the message too, not hurting the build but not a nice artefact.



---

archive/issue_comments_250456.json:
```json
{
    "body": "This ticket is closed ==> created #18835. Followup there.",
    "created_at": "2015-07-01T13:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18454",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18454#issuecomment-250456",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

This ticket is closed ==> created #18835. Followup there.
