# Issue 22124: Bug in creation of SetPartition

archive/issues_022124.json:
```json
{
    "body": "CC:  sage-combinat @tscrim @darijgr @alauve @zabrocki\n\nSo far, I've no idea what's wrong.  Here is the code, it produces an assertion error:\n\n```\nsage: n=3\nsage: d = {pi: pi.descents(from_zero=False) for pi in Permutations(n)}\nsage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]\nsage: SetPartition(C)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22361\n\n",
    "created_at": "2017-02-12T14:05:13Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Bug in creation of SetPartition",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22124",
    "user": "@mantepse"
}
```
CC:  sage-combinat @tscrim @darijgr @alauve @zabrocki

So far, I've no idea what's wrong.  Here is the code, it produces an assertion error:

```
sage: n=3
sage: d = {pi: pi.descents(from_zero=False) for pi in Permutations(n)}
sage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]
sage: SetPartition(C)
```


Issue created by migration from https://trac.sagemath.org/ticket/22361





---

archive/issue_comments_307327.json:
```json
{
    "body": "Your `C` is unhashable. Compare `SetPartition([[(1,2),(3,4)],[(5,6)]]` and `SetPartition([[[1,2],[3,4]],[This is the Trac macro *5,6* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,6-macro)])`; tuples are immutable, lists are mutable.\n\nAnyways, the error message should be better.",
    "created_at": "2017-02-12T14:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307327",
    "user": "@jm58660"
}
```

Your `C` is unhashable. Compare `SetPartition([[(1,2),(3,4)],[(5,6)]]` and `SetPartition([[[1,2],[3,4]],[This is the Trac macro *5,6* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,6-macro)])`; tuples are immutable, lists are mutable.

Anyways, the error message should be better.



---

archive/issue_comments_307328.json:
```json
{
    "body": "Actually, I made a worse mistake.  `C` contains duplicate elements...\n\nCan I close this ticket?",
    "created_at": "2017-02-12T14:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307328",
    "user": "@mantepse"
}
```

Actually, I made a worse mistake.  `C` contains duplicate elements...

Can I close this ticket?



---

archive/issue_comments_307329.json:
```json
{
    "body": "Replying to [comment:2 mantepse]:\n\n> Can I close this ticket?\n\nChange milestone to sage-invalid/duplicate/wontfix and put to needs review -state. I can then mark as positive review.\n\nBut I think you found a kind of bug. Why was the error message like what you get?",
    "created_at": "2017-02-12T15:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307329",
    "user": "@jm58660"
}
```

Replying to [comment:2 mantepse]:

> Can I close this ticket?

Change milestone to sage-invalid/duplicate/wontfix and put to needs review -state. I can then mark as positive review.

But I think you found a kind of bug. Why was the error message like what you get?



---

archive/issue_comments_307330.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2017-02-12T16:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307330",
    "user": "@mantepse"
}
```

Changing priority from major to minor.



---

archive/issue_comments_307331.json:
```json
{
    "body": "Travis knows more about how to correct this.",
    "created_at": "2017-02-12T18:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307331",
    "user": "@jm58660"
}
```

Travis knows more about how to correct this.



---

archive/issue_comments_307332.json:
```json
{
    "body": "The problem is in how `SetPartition(foo)` works. It assumes that `foo` corresponds to an element in `SetPartitions()`, which is the disjoint union of all set partitions of `[n]`. I would make the `__classcall_private__` actually try somewhat to construct the correct set of set partitions. Another problem is that the constructor is not quite permissive enough when constructing the elements (or at least is trying enough to convert it to the correct datatypes).",
    "created_at": "2017-02-12T19:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307332",
    "user": "@tscrim"
}
```

The problem is in how `SetPartition(foo)` works. It assumes that `foo` corresponds to an element in `SetPartitions()`, which is the disjoint union of all set partitions of `[n]`. I would make the `__classcall_private__` actually try somewhat to construct the correct set of set partitions. Another problem is that the constructor is not quite permissive enough when constructing the elements (or at least is trying enough to convert it to the correct datatypes).



---

archive/issue_comments_307333.json:
```json
{
    "body": "Minor correction: since `SetPartition([[pi] for pi in Permutations(3)])` works, I think that `SetPartitions` is what it promises to be.\n\nThus, I think the difficulty is rather to have `check` do something more fine grained than `self in self.parent()`.\n\nIf I understand correctly, `self in self.parent()` is shorthand for `self.parent().__contains__(self)` which does all the right checks, but only returns `True` or `False`.\n\nSo, the quick fix is to copy all these checks into `check`.  However, this is duplication of code.",
    "created_at": "2017-02-12T19:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307333",
    "user": "@mantepse"
}
```

Minor correction: since `SetPartition([[pi] for pi in Permutations(3)])` works, I think that `SetPartitions` is what it promises to be.

Thus, I think the difficulty is rather to have `check` do something more fine grained than `self in self.parent()`.

If I understand correctly, `self in self.parent()` is shorthand for `self.parent().__contains__(self)` which does all the right checks, but only returns `True` or `False`.

So, the quick fix is to copy all these checks into `check`.  However, this is duplication of code.



---

archive/issue_comments_307334.json:
```json
{
    "body": "Very strong -1.\n\nThe check is not the problem. The main problem that generates this error is the allowable data structures to construct elements:\n\n```\nsage: SetPartition(set(map(Set, C)))\n{{[1, 2, 3]}, {[1, 3, 2], [2, 3, 1]}, {[2, 1, 3], [3, 1, 2]}, {[3, 2, 1]}}\n```\n\nThe `__contains__` fails (as it should) because a list is not a set.\n\nHowever, there is another potential issue with the containment check not being strict enough because the set partition corresponding to, e.g., `C` is not in the enumerated set. I'm okay with `SetPartitions()` being a generic parent, but it is technically wrong that `set(map(Set, C)) in SetPartitions()`. Fixing this means we need to be more specific about the parent that `SetPartition.__classcall_private__` constructs.\n\nEdit - +1 to changing to raising `ValueError`.",
    "created_at": "2017-02-12T19:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307334",
    "user": "@tscrim"
}
```

Very strong -1.

The check is not the problem. The main problem that generates this error is the allowable data structures to construct elements:

```
sage: SetPartition(set(map(Set, C)))
{{[1, 2, 3]}, {[1, 3, 2], [2, 3, 1]}, {[2, 1, 3], [3, 1, 2]}, {[3, 2, 1]}}
```

The `__contains__` fails (as it should) because a list is not a set.

However, there is another potential issue with the containment check not being strict enough because the set partition corresponding to, e.g., `C` is not in the enumerated set. I'm okay with `SetPartitions()` being a generic parent, but it is technically wrong that `set(map(Set, C)) in SetPartitions()`. Fixing this means we need to be more specific about the parent that `SetPartition.__classcall_private__` constructs.

Edit - +1 to changing to raising `ValueError`.



---

archive/issue_comments_307335.json:
```json
{
    "body": "Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?\n\nIf so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?",
    "created_at": "2017-02-13T15:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307335",
    "user": "@mantepse"
}
```

Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?

If so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?



---

archive/issue_comments_307336.json:
```json
{
    "body": "Replying to [comment:11 mantepse]:\n> Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?\n\nI would say yes. However, that is a problem for another ticket since the fix is much more in-depth than what we should be doing on this ticket.\n\n> If so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?\n\nNo! That would completely circumvent the checks.",
    "created_at": "2017-02-13T15:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307336",
    "user": "@tscrim"
}
```

Replying to [comment:11 mantepse]:
> Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?

I would say yes. However, that is a problem for another ticket since the fix is much more in-depth than what we should be doing on this ticket.

> If so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?

No! That would completely circumvent the checks.



---

archive/issue_comments_307337.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-13T15:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307337",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_307338.json:
```json
{
    "body": "Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?\n\n(concerning `SetPartitions` and `SetPartition` only, I didn't touch the rest right now.)",
    "created_at": "2017-02-13T15:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307338",
    "user": "@mantepse"
}
```

Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?

(concerning `SetPartitions` and `SetPartition` only, I didn't touch the rest right now.)



---

archive/issue_comments_307339.json:
```json
{
    "body": "Replying to [comment:14 mantepse]:\n> Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?\n\nThat defaults back to `Parent.__contains__`, which simply checks to see that the input can construct an element of itself. Hence, no check is actually performed. This is going in the wrong direction. I should have time to actually fix this today.",
    "created_at": "2017-02-13T15:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307339",
    "user": "@tscrim"
}
```

Replying to [comment:14 mantepse]:
> Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?

That defaults back to `Parent.__contains__`, which simply checks to see that the input can construct an element of itself. Hence, no check is actually performed. This is going in the wrong direction. I should have time to actually fix this today.



---

archive/issue_comments_307340.json:
```json
{
    "body": "Travis, I would like to understand (and there is no rush):\n\nI moved the check into `SetPartition.check`.  So, the check is performed when \"untrusted\" code creates a set partition.\n\nWhy is this going in the wrong direction?",
    "created_at": "2017-02-13T16:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307340",
    "user": "@mantepse"
}
```

Travis, I would like to understand (and there is no rush):

I moved the check into `SetPartition.check`.  So, the check is performed when "untrusted" code creates a set partition.

Why is this going in the wrong direction?



---

archive/issue_comments_307341.json:
```json
{
    "body": "Replying to [comment:16 mantepse]:\n> Travis, I would like to understand (and there is no rush):\n> \n> I moved the check into `SetPartition.check`.  So, the check is performed when \"untrusted\" code creates a set partition.\n> \n> Why is this going in the wrong direction?\n\nSorry, I forgot that you moved that into the `check` function. However, this now has `__contains__` construct an element and then perform the check, the first of which is relatively slow and also requires extra function calls. It also means that subclasses cannot strictly override the `__contains__` behavior (should they want to).",
    "created_at": "2017-02-13T16:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307341",
    "user": "@tscrim"
}
```

Replying to [comment:16 mantepse]:
> Travis, I would like to understand (and there is no rush):
> 
> I moved the check into `SetPartition.check`.  So, the check is performed when "untrusted" code creates a set partition.
> 
> Why is this going in the wrong direction?

Sorry, I forgot that you moved that into the `check` function. However, this now has `__contains__` construct an element and then perform the check, the first of which is relatively slow and also requires extra function calls. It also means that subclasses cannot strictly override the `__contains__` behavior (should they want to).



---

archive/issue_comments_307342.json:
```json
{
    "body": "Also, thinking about it (i.e. not by testing), it should allow one to create set partitions that are not in the correct parent, such as `{{1}}` could be an element of `SetPartitions(2)`.",
    "created_at": "2017-02-13T16:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307342",
    "user": "@tscrim"
}
```

Also, thinking about it (i.e. not by testing), it should allow one to create set partitions that are not in the correct parent, such as `{{1}}` could be an element of `SetPartitions(2)`.



---

archive/issue_comments_307343.json:
```json
{
    "body": "Where is `check` perform a `__contains__`? \n\n\n```\nsage: SetPartition([[1]]) in SetPartitions(2)\nFalse\n```\n\nbecause that check is performed in the various `__contains__` methods of the subclasses.  More precisely, if you want to have, for example, Set partitions of a fixed set `S`, you'd implement `__contains__` there, which would check that the union of the parts of the argument is the given set.",
    "created_at": "2017-02-13T16:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307343",
    "user": "@mantepse"
}
```

Where is `check` perform a `__contains__`? 


```
sage: SetPartition([[1]]) in SetPartitions(2)
False
```

because that check is performed in the various `__contains__` methods of the subclasses.  More precisely, if you want to have, for example, Set partitions of a fixed set `S`, you'd implement `__contains__` there, which would check that the union of the parts of the argument is the given set.



---

archive/issue_comments_307344.json:
```json
{
    "body": "As I suspected, with your branch, I can do:\n\n```\nsage: P2 = SetPartitions(2)\nsage: P2([[1]])\n{{1}}\nsage: P2([[1]]) in P2\nFalse\n```\n\nin contrast to the current behavior, which raises an error.",
    "created_at": "2017-02-13T16:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307344",
    "user": "@tscrim"
}
```

As I suspected, with your branch, I can do:

```
sage: P2 = SetPartitions(2)
sage: P2([[1]])
{{1}}
sage: P2([[1]]) in P2
False
```

in contrast to the current behavior, which raises an error.



---

archive/issue_comments_307345.json:
```json
{
    "body": "No, it is the other way around. If you are checking a containment, then it creates an element and performs `check`. IMO, the check of `__contains__` should be as fast as possible.",
    "created_at": "2017-02-13T16:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307345",
    "user": "@tscrim"
}
```

No, it is the other way around. If you are checking a containment, then it creates an element and performs `check`. IMO, the check of `__contains__` should be as fast as possible.



---

archive/issue_comments_307346.json:
```json
{
    "body": "Here's a branch where your approach could not work by optimizing the `__contains__` and a few other things. At least it would not work without pushing all of containment checking to `check()`, which would necessitate subclassing the element class as well.\n\nI think this is a situation of we can't have our cake and eat it too. If we want a more refined error message, then we need to duplicate some of the code in `check()`. :/ Although since it is not a big block of code, I wouldn't strictly object.\n----\nNew commits:",
    "created_at": "2017-02-13T17:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307346",
    "user": "@tscrim"
}
```

Here's a branch where your approach could not work by optimizing the `__contains__` and a few other things. At least it would not work without pushing all of containment checking to `check()`, which would necessitate subclassing the element class as well.

I think this is a situation of we can't have our cake and eat it too. If we want a more refined error message, then we need to duplicate some of the code in `check()`. :/ Although since it is not a big block of code, I wouldn't strictly object.
----
New commits:



---

archive/issue_comments_307347.json:
```json
{
    "body": "OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?\n\n1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.\n\n2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?",
    "created_at": "2017-02-13T18:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307347",
    "user": "@mantepse"
}
```

OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?

1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.

2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?



---

archive/issue_comments_307348.json:
```json
{
    "body": "Replying to [comment:23 mantepse]:\n> OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?\n> \n> 1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.\n\nThis is not true. If the parent of `x` is not `S = SetPartitions(17)`, then it tries `x == S(x)` (which could involve an additional coercion attempt for the `==`). In fact, I am advocating that `__contains__` *should* be overwritten.\n\n> 2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?\n\nNo, we would need to implement `check` in each element class for the respective parents, which means a new element class for each parent. This is the first thing that we want to avoid. The second is that it makes `__contains__` much slower (relatively) because it has to construct a new element (which then has to be destroyed because it is transient no matter what). I don't think a (slightly) more detailed error message is worth this.",
    "created_at": "2017-02-13T23:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307348",
    "user": "@tscrim"
}
```

Replying to [comment:23 mantepse]:
> OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?
> 
> 1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.

This is not true. If the parent of `x` is not `S = SetPartitions(17)`, then it tries `x == S(x)` (which could involve an additional coercion attempt for the `==`). In fact, I am advocating that `__contains__` *should* be overwritten.

> 2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?

No, we would need to implement `check` in each element class for the respective parents, which means a new element class for each parent. This is the first thing that we want to avoid. The second is that it makes `__contains__` much slower (relatively) because it has to construct a new element (which then has to be destroyed because it is transient no matter what). I don't think a (slightly) more detailed error message is worth this.



---

archive/issue_comments_307349.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-11T18:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22124#issuecomment-307349",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
