# Issue 11672: Race condition in building MPIR/yasm

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2011-09-24 13:50:38

Assignee: tbd

CC:  wbhart leif

The included Yasm includes re2c which has a race condition during parallel build. See the upstream ticket for details:

http://tortall.lighthouseapp.com/projects/78676-yasm/tickets/238-parallel-make-fails

A possible workaround is to build the included yasm in a single thread.


---

Comment by leif created at 2011-09-24 14:45:58

Nice.

Which version of MPIR are you referring to?

(I don't know whether the yasm version in our "recent" MPIR packages ever changed at all, or which one we currently use.)

FWIW, IIRC we did a lot of massively parallel builds of MPIR 2.1.x, because of the race condition in _MPIR's_ `make install` (fixed in MPIR 2.1.3 or .4), but never ran into an error caused by yasm.


---

Comment by leif created at 2011-09-24 14:45:58

Changing priority from major to minor.


---

Comment by vbraun created at 2011-09-24 15:00:12

This is the mpir-1.2.2.p2.spkg from sage-4.7.2.alpha2. All versions of Yasm have the bug.

You probably didn't trip over the yasm bug because you were using a file system that allows you to open the same file multiple times for writing. Then you don't get the segfault, but you may get corrupted output. If you are extremely lucky gcc might even compile the clobbered output from re2c, and you'd just get mathematically wrong results for integer arithmetic.


---

Comment by vbraun created at 2011-09-24 15:00:12

Changing priority from minor to major.


---

Comment by leif created at 2011-09-24 15:04:49

Replying to [comment:1 leif]:
> FWIW, IIRC we did a lot of massively parallel builds of MPIR 2.1.x, because of the race condition in _MPIR's_ `make install` (fixed in MPIR 2.1.3 or .4), but never ran into an error caused by yasm.

The latter is apparently [fixed in MPIR 2.1.4](http://groups.google.com/group/mpir-devel/browse_thread/thread/04928454886f34ab/e29bf19c2590d2d0).


---

Comment by leif created at 2011-09-24 15:09:19

If it doesn't necessarily lead to a build error... :)

(I've also added a reference to this ticket on #11616.)


---

Comment by leif created at 2011-09-24 15:09:19

Changing priority from major to critical.


---

Comment by leif created at 2011-09-24 15:12:34

Replying to [comment:3 leif]:
> Replying to [comment:1 leif]:
> > FWIW, IIRC we did a lot of massively parallel builds of MPIR 2.1.x, because of the race condition in _MPIR's_ `make install` (fixed in MPIR 2.1.3 or .4), but never ran into an error caused by yasm.
> 
> The latter is apparently [fixed in MPIR 2.1.4](http://groups.google.com/group/mpir-devel/browse_thread/thread/04928454886f34ab/e29bf19c2590d2d0).

Not the latter, I meant MPIR's `make install` race condition. ;-)


---

Comment by vbraun created at 2011-10-03 10:20:21

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-10-03 10:20:21

This is now fixed upstream in

https://github.com/yasm/yasm/commit/2bd66514b6b100887c19d8598da38347b3cff40e


---

Comment by leif created at 2011-10-03 12:46:39

Wonder whether they can include the fix in MPIR 2.5.0 (which should already be right before the door).

I'll provide updated MPIR spkgs (at least an MPIR 2.1.3.p5 or 2.1.4.pX spkg, the others for #11616) fixing the need to specify `ABI=32` on 32-bit operating systems running on 64-bit CPUs anyway, then I can include such a fix by a patch to upstream.

Note that the yasm guys do not check whether the call to `tmpfile()` succeeded, nor is the file opened in text mode as it was before. (The latter should be irrelevant _on our supported platforms_ -- including Cygwin AFAIK. Microsoft deprecated `tmpfile()` anyway... ;-) )


---

Comment by vbraun created at 2011-10-03 12:59:32

> Note that the yasm guys do not check whether the call to tmpfile() succeeded

In the unlikely case that `tmpfile()` can't find a unique file name, it'll return NULL so at least the yasm build will fail with a clean segfault. There are probably many other things that would go wrong at build time if `tmpfile()` fails...


---

Comment by leif created at 2011-10-03 13:37:18

Replying to [comment:8 vbraun]:
> > Note that the yasm guys do not check whether the call to tmpfile() succeeded
> 
> In the unlikely case that `tmpfile()` can't find a unique file name, it'll return NULL


```
ERRORS
       EACCES Search permission denied for directory in file's path prefix.

       EEXIST Unable to generate a unique filename.

       EINTR  The call was interrupted by a signal.

       EMFILE Too many file descriptors in use by the process.

       ENFILE Too many files open in the system.

       ENOSPC There was no room in the directory to add the new filename.

       EROFS  Read-only file system.
```


So there are a couple of reasons why `tmpfile()`could fail (and these may be temporary, i.e., later calls at least from other processes may well succeed).

Letting `re2c` segfault is of course the pythonic way... ;-)


---

Comment by vbraun created at 2011-10-03 15:36:09

Replying to [comment:9 leif]:
> So there are a couple of reasons why `tmpfile()`could fail

And all of them will break the build, whether or not re2c catches the error.


---

Comment by leif created at 2011-10-05 04:18:31

Just in case...


---

Comment by jdemeyer created at 2011-10-31 12:03:48

Nothing to review here...


---

Comment by jdemeyer created at 2011-10-31 12:03:48

Changing status from needs_review to needs_work.


---

Comment by leif created at 2012-04-05 15:43:35

This is now fixed by the MPIR 2.4.0.*p2* spkg at #11616 (patch to upstream added).

In case that gets merged, this ticket can be closed as a duplicate (or more precisely, as fixed / superseded by #11616).


---

Comment by leif created at 2012-04-18 23:44:04

Changing status from needs_work to positive_review.


---

Comment by leif created at 2012-04-18 23:44:04

Positive review w.r.t. that #11616 fixes this (by a patch from Sage, not MPIR upstream).

But we IMHO shouldn't close this ticket until #11616 got merged.


---

Comment by jdemeyer created at 2012-04-29 14:14:52

Resolution: duplicate
