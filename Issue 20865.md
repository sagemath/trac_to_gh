# Issue 20865: Sage's top-level 'configure' doesn't properly exit on errors, instead breaks the build

archive/issues_020865.json:
```json
{
    "body": "CC:  @jdemeyer\n\nKeywords: configure package type missing build error\n\nWhich of the following exits your shell?\n\n```sh\nexit 1 | exit 0\n\nexit 0 | exit 1\n\nexit 1 | exit 1\n\nexit 0 | exit 0\n```\n*(The answer is \"none of them\".)*\n\n---\n\nSee [this long thread on sage-devel](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/87837) where we tracked down an obscure build error to this bug in `configure`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21102\n\n",
    "created_at": "2016-07-27T06:17:29Z",
    "labels": [
        "component: build: configure",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Sage's top-level 'configure' doesn't properly exit on errors, instead breaks the build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20865",
    "user": "https://github.com/nexttime"
}
```
CC:  @jdemeyer

Keywords: configure package type missing build error

Which of the following exits your shell?

```sh
exit 1 | exit 0

exit 0 | exit 1

exit 1 | exit 1

exit 0 | exit 0
```
*(The answer is "none of them".)*

---

See [this long thread on sage-devel](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/87837) where we tracked down an obscure build error to this bug in `configure`.


Issue created by migration from https://trac.sagemath.org/ticket/21102





---

archive/issue_comments_288131.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-27T06:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288131",
    "user": "https://github.com/nexttime"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_288132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-27T06:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288132",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288133.json:
```json
{
    "body": "P.S.:  I don't think we should ignore empty folders in `build/pkgs/`; if someone disagrees, we can change that on a follow-up ticket.",
    "created_at": "2016-07-27T07:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288133",
    "user": "https://github.com/nexttime"
}
```

P.S.:  I don't think we should ignore empty folders in `build/pkgs/`; if someone disagrees, we can change that on a follow-up ticket.



---

archive/issue_comments_288134.json:
```json
{
    "body": "To test this, do for example:\n\n```sh\nmkdir build/pkgs/broken_package\n./configure && echo Apparently no error.\necho broken > build/pkgs/broken_package/type\n./configure && echo Apparently no error.\n```\nOptionally take a look at `build/make/Makefile`...\n\nThen pull the branch here, run `autoconf`, and retry the above (perhaps first after having done `rm -r build/pkgs/broken_package`).",
    "created_at": "2016-07-27T07:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288134",
    "user": "https://github.com/nexttime"
}
```

To test this, do for example:

```sh
mkdir build/pkgs/broken_package
./configure && echo Apparently no error.
echo broken > build/pkgs/broken_package/type
./configure && echo Apparently no error.
```
Optionally take a look at `build/make/Makefile`...

Then pull the branch here, run `autoconf`, and retry the above (perhaps first after having done `rm -r build/pkgs/broken_package`).



---

archive/issue_comments_288135.json:
```json
{
    "body": "Lets just say that exception handling isn't bash's strong suit...\n\nIMHO the entire autogenerating-Makefile should be converted to Python and moved into `sage_bootstrap` for a) error checking sanity and b) testability and c) having a single point of truth for if and when a directory is a package. But not on this ticket...",
    "created_at": "2016-07-27T20:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288135",
    "user": "https://github.com/vbraun"
}
```

Lets just say that exception handling isn't bash's strong suit...

IMHO the entire autogenerating-Makefile should be converted to Python and moved into `sage_bootstrap` for a) error checking sanity and b) testability and c) having a single point of truth for if and when a directory is a package. But not on this ticket...



---

archive/issue_comments_288136.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-27T20:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288136",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_288137.json:
```json
{
    "body": "Replying to [comment:5 vbraun]:\n> Lets just say that exception handling isn't bash's strong suit...\n\n\nWell, that's standard(ized) (Bourne) shell behavior.\n\n\\\\\n\n> IMHO the entire autogenerating-Makefile should be converted to Python and moved into `sage_bootstrap` for a) error checking sanity and b) testability and c) having a single point of truth for if and when a directory is a package. But not on this ticket...\n\n\nEven if we keep it in `configure[.ac]`, the shell functions could be improved (e.g. not rereading the folders and files five times).  But we could of course use Python there as well, where it (creating the Makefile) IMHO belongs.\n\nNote that while we meanwhile require a system python, AFAICS there's not a single test for python in `configure`yet.",
    "created_at": "2016-07-27T20:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288137",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:5 vbraun]:
> Lets just say that exception handling isn't bash's strong suit...


Well, that's standard(ized) (Bourne) shell behavior.

\\

> IMHO the entire autogenerating-Makefile should be converted to Python and moved into `sage_bootstrap` for a) error checking sanity and b) testability and c) having a single point of truth for if and when a directory is a package. But not on this ticket...


Even if we keep it in `configure[.ac]`, the shell functions could be improved (e.g. not rereading the folders and files five times).  But we could of course use Python there as well, where it (creating the Makefile) IMHO belongs.

Note that while we meanwhile require a system python, AFAICS there's not a single test for python in `configure`yet.



---

archive/issue_comments_288138.json:
```json
{
    "body": "Replying to [comment:7 leif]:\n> Replying to [comment:5 vbraun]:\n> > Lets just say that exception handling isn't bash's strong suit...\n\n> \n> Well, that's standard(ized) (Bourne) shell behavior.\n\n\nP.S.:  You have similar problems in functional languages or attribute grammars, without global variables (Pfui anyway) and without passing pointers or references for results... ;-)\n\nSo the shell's behavoir appears to be good, the problem being that not everybody's aware of when subshells (with their own environment) are invoked.",
    "created_at": "2016-07-27T21:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288138",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:7 leif]:
> Replying to [comment:5 vbraun]:
> > Lets just say that exception handling isn't bash's strong suit...

> 
> Well, that's standard(ized) (Bourne) shell behavior.


P.S.:  You have similar problems in functional languages or attribute grammars, without global variables (Pfui anyway) and without passing pointers or references for results... ;-)

So the shell's behavoir appears to be good, the problem being that not everybody's aware of when subshells (with their own environment) are invoked.



---

archive/issue_comments_288139.json:
```json
{
    "body": "Opinions on `configure` dumping a list of all packages (one per line!) near the end?\n\nI think this makes it even more unlikely people will notice *warnings* etc. from `configure`.",
    "created_at": "2016-07-27T21:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288139",
    "user": "https://github.com/nexttime"
}
```

Opinions on `configure` dumping a list of all packages (one per line!) near the end?

I think this makes it even more unlikely people will notice *warnings* etc. from `configure`.



---

archive/issue_comments_288140.json:
```json
{
    "body": "I've opened [ticket:21116 a follow-up] for a couple of improvements to `configure`.\n\nNot intended for rewriting it in Python though. ;-)\n\n(I'd prefer you doing that on a *separate* ticket.)",
    "created_at": "2016-07-28T15:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288140",
    "user": "https://github.com/nexttime"
}
```

I've opened [ticket:21116 a follow-up] for a couple of improvements to `configure`.

Not intended for rewriting it in Python though. ;-)

(I'd prefer you doing that on a *separate* ticket.)



---

archive/issue_comments_288141.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-28T17:44:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20865#issuecomment-288141",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056338.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-07-28T17:44:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20865",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20865#event-56338"
}
```
