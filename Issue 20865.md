# Issue 20865: Sage's top-level 'configure' doesn't properly exit on errors, instead breaks the build

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2016-07-27 06:17:29

CC:  jdemeyer

Keywords: configure package type missing build error

Which of the following exits your shell?

```sh
exit 1 | exit 0

exit 0 | exit 1

exit 1 | exit 1

exit 0 | exit 0
```

_(The answer is "none of them".)_

----

See [this long thread on sage-devel](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/87837) where we tracked down an obscure build error to this bug in `configure`.



---

Comment by leif created at 2016-07-27 06:21:00

Changing status from new to needs_review.


---

Comment by git created at 2016-07-27 06:40:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by leif created at 2016-07-27 07:03:37

P.S.:  I don't think we should ignore empty folders in `build/pkgs/`; if someone disagrees, we can change that on a follow-up ticket.


---

Comment by leif created at 2016-07-27 07:17:54

To test this, do for example:

```sh
mkdir build/pkgs/broken_package
./configure && echo Apparently no error.
echo broken > build/pkgs/broken_package/type
./configure && echo Apparently no error.
```

Optionally take a look at `build/make/Makefile`...

Then pull the branch here, run `autoconf`, and retry the above (perhaps first after having done `rm -r build/pkgs/broken_package`).


---

Comment by vbraun created at 2016-07-27 20:35:51

Lets just say that exception handling isn't bash's strong suit...

IMHO the entire autogenerating-Makefile should be converted to Python and moved into `sage_bootstrap` for a) error checking sanity and b) testability and c) having a single point of truth for if and when a directory is a package. But not on this ticket...


---

Comment by vbraun created at 2016-07-27 20:35:51

Changing status from needs_review to positive_review.


---

Comment by leif created at 2016-07-27 20:48:58

Replying to [comment:5 vbraun]:
> Lets just say that exception handling isn't bash's strong suit...

Well, that's standard(ized) (Bourne) shell behavior.

\\

> IMHO the entire autogenerating-Makefile should be converted to Python and moved into `sage_bootstrap` for a) error checking sanity and b) testability and c) having a single point of truth for if and when a directory is a package. But not on this ticket...

Even if we keep it in `configure[.ac]`, the shell functions could be improved (e.g. not rereading the folders and files five times).  But we could of course use Python there as well, where it (creating the Makefile) IMHO belongs.

Note that while we meanwhile require a system python, AFAICS there's not a single test for python in `configure`yet.


---

Comment by leif created at 2016-07-27 21:04:10

Replying to [comment:7 leif]:
> Replying to [comment:5 vbraun]:
> > Lets just say that exception handling isn't bash's strong suit...
> 
> Well, that's standard(ized) (Bourne) shell behavior.

P.S.:  You have similar problems in functional languages or attribute grammars, without global variables (Pfui anyway) and without passing pointers or references for results... ;-)

So the shell's behavoir appears to be good, the problem being that not everybody's aware of when subshells (with their own environment) are invoked.


---

Comment by leif created at 2016-07-27 21:17:13

Opinions on `configure` dumping a list of all packages (one per line!) near the end?

I think this makes it even more unlikely people will notice _warnings_ etc. from `configure`.


---

Comment by leif created at 2016-07-28 15:38:39

I've opened [ticket:21116 a follow-up] for a couple of improvements to `configure`.

Not intended for rewriting it in Python though. ;-)

(I'd prefer you doing that on a _separate_ ticket.)


---

Comment by vbraun created at 2016-07-28 17:44:35

Resolution: fixed
