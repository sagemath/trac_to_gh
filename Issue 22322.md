# Issue 22322: Matchings in Bipartite Graphs

Issue created by migration from https://trac.sagemath.org/ticket/22559

Original creator: zgershkoff

Original creation time: 2017-03-09 19:26:12




---

Comment by zgershkoff created at 2017-03-09 19:41:59

Changing component from PLEASE CHANGE to graph theory.


---

Comment by zgershkoff created at 2017-03-09 19:41:59

Changing priority from major to minor.


---

Comment by zgershkoff created at 2017-03-09 19:41:59

Changing type from PLEASE CHANGE to enhancement.


---

Comment by zgershkoff created at 2017-03-09 19:41:59

New commits:


---

Comment by zgershkoff created at 2017-03-09 19:41:59

Changing status from new to needs_review.


---

Comment by git created at 2017-03-09 22:50:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-10 03:52:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-03-14 21:18:09

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2017-03-14 21:18:09

zgershkoff, I could not find your handle on the wiki home page.


---

Comment by zgershkoff created at 2017-03-14 23:25:35

I don't see anything in the developer's guide about this. Is this sufficient?


---

Comment by zgershkoff created at 2017-03-14 23:25:35

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-03-15 00:19:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-03-15 10:16:58

Replying to [comment:6 zgershkoff]:
> I don't see anything in the developer's guide about this. Is this sufficient?
Yes. It is probably not in the developer's guide. But the merge commit uses that information (and the Reviewer field) afaik. It would be great if you could also add yourself to the list on the wiki's homepage.


---

Comment by saraedum created at 2017-03-15 10:39:02

I made some minor changes. Let's see what the patchbots think about this.


---

Comment by git created at 2017-03-15 11:18:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-03-20 02:01:56

The patchbot says it fails python3 compatibility when it calls six.iteritems, which I find confusing-- I thought the purpose of the six library was python2-3 compatibility.


---

Comment by Stefan created at 2017-03-20 04:08:32

Just a hunch here: maybe you need to write "for (u, v) in six.iteritems..."?

I couldn't find anything online justifying this.


---

Comment by chapoton created at 2017-03-20 08:11:06

Patchbot is not smart enough to recognize the six before iteritems.

You should rather use

```
from six import iteritems

...

for u,v in iteritems
```



---

Comment by tscrim created at 2017-03-20 08:39:55

Three other minor things:

* You should start with
  {{{#!diff
    def matching(self, value_only=False, algorithm="Hopcroft-Karp",
                 use_edge_labels=False, solver=None, verbose=0):
        r"""
  }}}
  (and end with `"""`).
* For the wikipedia, use
  {{{
  :wikipedia:`Matching_(graph_theory)`
  }}}
  which handles all of the linking and formatting.
* Change the first ``use_edge_labels`` to:
  {{{
          - when set to ``True``, computes a weighted matching where each
            edge is weighted by its label (if an edge has no label, `1` is
            assumed); ignored if ``algorithm`` is not ``"Edmonds"``, ``"LP"``
  }}}


---

Comment by git created at 2017-03-20 16:55:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-03-20 17:01:08

I made all the documentation changes tscrim suggested except the last one, which I believe saraedum already addressed.

Replying to [comment:16 chapoton]:
> Patchbot is not smart enough to recognize the six before iteritems.
> 

I changed it to just `iteritems` in bipartite_graph.py, but the way I had it before is exactly how it was used in graph.py. I didn't fix it in graph.py since it's not broken.


---

Comment by tscrim created at 2017-03-20 17:35:47

No, Julian did not address it already; in particular there are still 2 commas separated by a space. I also (slightly) think you should aim to make it not use periods to be consistent and concise.


---

Comment by git created at 2017-03-20 17:46:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-03-20 17:52:09

Ok, I see. Thank you for the feedback. I fixed the things you pointed out, but I changed the phrasing away from "ignored if ``algorithm`` is not ``"Edmonds"``, ``"LP"``" because it's now configured to raise an error if `use_edge_labels==True` but `algorithm` is not set to `"Edmonds"` or `"LP"`.
----
New commits:


---

Comment by git created at 2017-03-20 17:53:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-20 17:53:52

You need to revert back the indentation by 2 spaces.


---

Comment by git created at 2017-03-20 18:54:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-20 23:21:34

You also need to do the other two lines. See comment:17 (also, it would be good if the arguments for the function started at the same level, it's a PEP8 thing).


---

Comment by zgershkoff created at 2017-03-21 00:34:04

Replying to [comment:27 tscrim]:
> You also need to do the other two lines. See comment:17 (also, it would be good if the arguments for the function started at the same level, it's a PEP8 thing).
I believe the lines you're referring to are addressed in this commit https://git.sagemath.org/sage.git/commit/?h=e3c353ee32fec6fe8f5f84c3d51bea6b5045dc1a&id=5339528b85dd389a3e7633678fe609796fe787b0 - I'm not sure why it didn't show up in the trac ticket.

I'll look into PEP8 and make changes shortly.


---

Comment by git created at 2017-03-21 00:42:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-21 00:47:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-21 00:52:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Stefan created at 2017-05-05 01:13:29

I think this looks good now. Travis, do you agree?


---

Comment by tscrim created at 2017-05-05 01:34:28

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-05-05 01:34:28

Whoops, sorry this fell of my radar. Yep, looks good.


---

Comment by dcoudert created at 2017-05-05 06:36:16

Why don't you use `G.networkx_graph()` to get the networkx version of the graph ?


---

Comment by vbraun created at 2017-05-05 22:23:39

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-05-05 22:23:39


```
[sagelib-8.0.beta5] byte-compiling /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/graphs/bipartite_graph.py to bipartite_graph.pyc
[sagelib-8.0.beta5]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/graphs/bipartite_graph.py", line 1369
[sagelib-8.0.beta5]     raise ValueError("use_edge_labels can not be used with
[sagelib-8.0.beta5]                                                          ^
[sagelib-8.0.beta5] SyntaxError: EOL while scanning string literal
```



---

Comment by git created at 2017-05-11 22:12:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-05-11 22:18:42

Changing status from needs_work to needs_review.


---

Comment by zgershkoff created at 2017-05-11 22:18:42

Looks like I wasn't careful enough while following the PEP8 guidelines. All doctests pass so it should be fine now.

Replying to [comment:34 dcoudert]:
> Why don't you use `G.networkx_graph()` to get the networkx version of the graph ?

I adapted the code from the matching method of graph.py. Perhaps that would have been cleaner.


---

Comment by git created at 2017-05-12 00:10:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-05-12 00:15:11

I adopted dcoudert's suggestion and saved a line of code.


---

Comment by dcoudert created at 2017-05-12 12:34:42

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2017-05-12 12:34:42

Passes all tests, so looks good to me.


---

Comment by vbraun created at 2017-05-14 08:32:54

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-05-14 08:32:54

Documentation doesn't build


---

Comment by dcoudert created at 2017-05-14 08:46:55

it's the bullet `- when set to ``True``, computes ...`. You must add 2 spaces on the next lines. Then the doc builds.

```
          - when set to ``True``, computes a weighted matching where each edge
            is weighted by its label (if an edge has no label, `1` is assumed);
            only if ``algorithm`` is ``"Edmonds"``, ``"LP"``
```



---

Comment by git created at 2017-05-14 20:56:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-05-14 20:57:56

Thanks for catching that. It's curious that the doctest didn't notice.

I'll set it to needs review again. Third time's a charm...


---

Comment by zgershkoff created at 2017-05-14 20:57:56

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2017-05-14 21:28:56

Well... actually, there is a another issue with the wikipedia link. Sorry.

This

```
        For more information, see the `Wikipedia article on matchings
        :wikipedia:`Matching_(graph_theory)`
```

produces something like `For more information, see the Wikipediaarticleonmatchings:wikipedia:â€˜Matching(graphtheory)`. Check the html.

So you should write

```
        For more information, see :wikipedia:`Matching_(graph_theory)`
```

or even better

```
    .. SEEALSO::

        - :wikipedia:`Matching_(graph_theory)`
        - :meth:`~Graph.matching`
```

no need for blank line between bullets here.


---

Comment by dcoudert created at 2017-05-14 21:28:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-05-14 22:25:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-05-14 22:27:48

Changing status from needs_work to needs_review.


---

Comment by zgershkoff created at 2017-05-14 22:29:23

Is there a way I can build the documentation myself to check for errors? `./sage -t src/sage/graphs/bipartite_graph.py` doesn't seem to do it, and I don't see anything in the documentation.


---

Comment by dcoudert created at 2017-05-14 22:36:23

`./sage -docbuild reference html` and  `./sage -docbuild reference/graphs html` to rebuild only the graphs part.

Note that from time to time I have to do `make doc-clean && make` to rebuild the documentation from scratch. For this patch you should not have to do it.


---

Comment by git created at 2017-05-16 19:23:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-05-16 19:25:03

Thanks. It took some effort but the documentation seems to render correctly now.


---

Comment by tscrim created at 2017-05-16 20:19:00

Back to positive review.


---

Comment by tscrim created at 2017-05-16 20:19:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-05-20 21:49:44

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-05-20 21:49:44

Various doctest failures, e.g.

```
sage -t --long --warn-long 71.2 src/sage/combinat/permutation.py
**********************************************************************
File "src/sage/combinat/permutation.py", line 6926, in sage.combinat.permutation.bistochastic_as_sum_of_permutations
Failed example:
    decomp = bistochastic_as_sum_of_permutations(M)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.permutation.bistochastic_as_sum_of_permutations[7]>", line 1, in <module>
        decomp = bistochastic_as_sum_of_permutations(M)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/combinat/permutation.py", line 6973, in bistochastic_as_sum_of_permutations
        matching = G.matching(use_edge_labels=True)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/graphs/bipartite_graph.py", line 1365, in matching
        "Hopcroft-Karp or Eppstein")
    ValueError: use_edge_labels can not be used with Hopcroft-Karp or Eppstein
**********************************************************************
```



---

Comment by dcoudert created at 2017-05-21 06:53:29

Sorry I did not pass tests on the full library when reviewing this ticket. 


One solution is to set the algorithm to `None` 

```
    def matching(self, value_only=False, algorithm=None,
                 use_edge_labels=False, solver=None, verbose=0):
```

and then to add after `self._scream_if_not_simple()`:

```
        if algorithm is None:
            if use_edge_labels:
                algorithm = "Edmonds"
            else:
                algorithm = "Hopcroft-Karp"
```

You will have to update the documentation accordingly, for instance like 

```
        - ``algorithm`` -- string (default: ``"Hopcroft-Karp"`` if
          ``use_edge_labels==False``, otherwise ``"Edmonds"``)

}}} 

and add a tests on a weighted graph like:
{{{
sage: G = graphs.CycleGraph(4)
sage: B = BipartiteGraph([(u,v,2) for u,v in G.edges(labels=0)])
sage: B.matching(use_edge_labels=True)
[(0, 3, 2), (1, 2, 2)]
sage: B.matching(use_edge_labels=True, value_only=True)
4
sage: B.matching(use_edge_labels=True, value_only=True, algorithm='Edmonds')
4
sage: B.matching(use_edge_labels=True, value_only=True, algorithm='LP')
4.0
sage: B.matching(use_edge_labels=True, value_only=True, algorithm='Eppstein')
Traceback (most recent call last):
...
ValueError: use_edge_labels can not be used with Hopcroft-Karp or Eppstein
sage: B.matching(use_edge_labels=True, value_only=True, algorithm='Hopcroft-Karp')
Traceback (most recent call last):
...
ValueError: use_edge_labels can not be used with Hopcroft-Karp or Eppstein
sage: B.matching(use_edge_labels=False, value_only=True, algorithm='Hopcroft-Karp')
2
sage: B.matching(use_edge_labels=False, value_only=True, algorithm='Eppstein')
2
sage: B.matching(use_edge_labels=False, value_only=True, algorithm='Edmonds')
2
sage: B.matching(use_edge_labels=False, value_only=True, algorithm='LP')
2
}}}


---

Comment by tscrim created at 2017-05-21 14:43:15

+1 Can you make the appropriate changes David?


---

Comment by dcoudert created at 2017-05-21 16:05:31

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2017-05-21 16:05:31

I had to create a new branch since I cannot push in branch `u/zgershkoff/matchings_in_bipartite_graphs`. The new branch is in `public/`, so you can push commits as well.

Bipartite graphs are used in the following modules. The new branch passes all tests (on my computer), but it's better to double check (as well as docbuild, etc.).

```
src/sage/combinat/
src/sage/game_theory/
src/sage/graphs/
src/sage/groups/
src/sage/matrix/
src/sage/matroids/
```


Let's hope this ticket will soon be finalized ;)
----
New commits:


---

Comment by tscrim created at 2017-05-22 01:01:44

Replying to [comment:56 dcoudert]:
> I had to create a new branch since I cannot push in branch `u/zgershkoff/matchings_in_bipartite_graphs`. The new branch is in `public/`, so you can push commits as well.

That is the correct behavior and the correct thing to do.

> Bipartite graphs are used in the following modules. The new branch passes all tests (on my computer), but it's better to double check (as well as docbuild, etc.).

LGTM too. Thanks.


---

Comment by tscrim created at 2017-05-22 01:01:44

Changing status from needs_review to positive_review.


---

Comment by zgershkoff created at 2017-05-23 19:49:27

I agree with this solution-- better than the options I was considering. Thanks for taking care of it.


---

Comment by vbraun created at 2017-05-24 19:10:38

Resolution: fixed
