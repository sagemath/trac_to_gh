# Issue 21279: Fix sagelib sdist (src/setup.py sdist)

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-09-17 04:36:36

CC:  jdemeyer vbraun embray leif fbissey dimpase mjo chapoton

This ticket adds some targets to `src/Makefile.in`: `sdist` and `sdistcheck`.
The latter, after building an `sdist` (using `distutils`), unpacks it into a subdirectory, and builds and installs (into SAGE_LOCAL) from there. 

`(cd src && make sdist)` gives the following warnings. They need fixing.

```
warning: sdist: standard file not found: should have one of README, README.txt
reading manifest template 'MANIFEST.in'
warning: sdist: MANIFEST.in, line 6: 'recursive-include' expects <dir> <pattern1> <pattern2> ...

warning: no previously-included files matching '*.h' found under directory 'sage/ext/interpreters'
warning: no previously-included files found matching 'sage/libs/pari/gen.h'
warning: no previously-included files found matching 'sage/modular/arithgroup/farey_symbol.h'
warning: no previously-included files found matching 'sage/rings/real_mpfi.h'
warning: no previously-included files found matching 'sage/symbolic/pynac.h'
warning: no directories found matching 'doc/common/static'
warning: no files found matching 'doc/en/bordeaux_2008/birch.png'
warning: no files found matching 'doc/en/bordeaux_2008/modpcurve.png'
no previously-included directories found matching 'doc/output'
```



There is something more seriously wrong with the sdist. The sage that is built from there (using `(cd src && make sdistcheck)`)  crashes as follows.

```
/Users/mkoeppe/s/sage/sage-rebasing/src/sage/ext/interpreters/wrapper_rdf.pxd in init sage.plot.plot3d.parametric_surface (build/cythonized/sage/plot/plot3d/parametric_surface.c:11409)()
      1 # Automatically generated by sage_setup/autogen/interpreters.pyc.  Do not edit!
      2 
      3 from cpython cimport PyObject
      4 
      5 from sage.ext.fast_callable cimport Wrapper
      6 
----> 7 cdef class Wrapper_rdf(Wrapper):
        global cdef = undefined
        global Wrapper_rdf = undefined
        global Wrapper = undefined
      8     cdef int _n_args
      9     cdef double* _args
     10     cdef int _n_constants
     11     cdef double* _constants
     12     cdef object _list_py_constants
     13     cdef int _n_py_constants
     14     cdef PyObject** _py_constants
     15     cdef int _n_stack
     16     cdef double* _stack
     17     cdef int _n_code
     18     cdef int* _code
     19     cdef object _domain
     20     cdef bint call_c(self,
     21                      double* args,
     22                      double* result) except 0

ImportError: No module named wrapper_rdf
```


This needs fixing.


---

Comment by mkoeppe created at 2016-09-17 04:44:54

Last 10 new commits:


---

Comment by fbissey created at 2016-09-17 04:56:22

Obviously you are missing an include that would point where to find `sage/ext/fast_callable.*`. I will have a deeper look.


---

Comment by fbissey created at 2016-09-17 05:06:55

So this fails after you built and you try to run `./sage`? There may be some points in sage that sets where to find the hierarchy of include files under `SAGE_SRC` when, once you have installed sage properly you should point to `SAGE_LIB` (usually `SAGE_LOCAL/lib/python2.7/site-package`).

If that's the case that may recoup with some concerns I expressed in one of the earlier tickets. sage's internal should be fixed before you do something like that to the build system. Off course I could be wrong :)


---

Comment by mkoeppe created at 2016-09-17 05:10:59

Replying to [comment:4 fbissey]:
> So this fails after you built and you try to run `./sage`? 

Yes.

> There may be some points in sage that sets where to find the hierarchy of include files under `SAGE_SRC` when, once you have installed sage properly you should point to `SAGE_LIB` (usually `SAGE_LOCAL/lib/python2.7/site-package`).

I don't understand, could you explain more?


---

Comment by fbissey created at 2016-09-17 05:19:58

Is `SAGE_SRC` pointing to anything or is it blank? From the little bit I see, I am guessing some piece of code is autogenerated at runtime to be compiled and executed. And to work, it needs to have an include (-I$SOMEPATH) that points to the top of the sage python install (SAGE_LIB) or as it is usually wrongly done in sage, where the source is in SAGE_SRC. You would find this in `sage/misc/cython.py`.

Have to prepare dinner for my family. Be back in about 2-3 hours.


---

Comment by git created at 2016-09-17 06:03:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-17 06:07:48

I added another debugging helper `make sdistcheck-compare-trees`, which shows the differences between the source tree and the sdist tree. 

There are various differences (for example, all README files are missing); I won't have time to take a closer look before tomorrow.


---

Comment by git created at 2016-10-23 01:31:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-10-23 05:39:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-10-23 06:05:02

This ticket needs some help from the distutils experts


---

Comment by embray created at 2016-11-07 12:59:24

What can I help with?


---

Comment by mkoeppe created at 2016-11-10 06:48:36

Replying to [comment:13 embray]:
> What can I help with?

I'd need help in figuring out why some files are missing in the `sdist` and what is the idiomatic way (or the most appropriate way for Sage) of adding them.


---

Comment by embray created at 2016-11-10 11:48:26

I think this calls for a cleaning up of the MANIFEST.in.  I'll play around with it.


---

Comment by embray created at 2016-11-10 12:59:07

I think that #21682 might help with this issue as well.  As I've repeatedly suggested, it's best to include Cythonized sources in the sdist (taking the onus off the user to create the files with the correct version of Cython--especially important since we currently use a patched Cython for Sage...).  This would also ensure that generated modules like the pari interfaces are included (on possible problem with this is if we want to be able to target different versions of pari--that's a problem to be pushed down the line though...)


---

Comment by mkoeppe created at 2020-02-06 12:26:56

`@`embray This is the ticket that I mentioned in #26964.


---

Comment by @Shlokatadistance created at 2020-03-30 05:45:20

Can you tell me how did that error go from ` no previously-included files ` to. ` no directories found `, the time I recreated this error, this happened after I had quit the command of ./sage


---

Comment by @Shlokatadistance created at 2020-04-04 12:49:01

Also I had obtained such an error after a direct installation of [SageMath](SageMath) as an application, did you do it the same way? or was it through the tar file and unpacking?


---

Comment by dimpase created at 2020-05-16 12:33:48

Is this still relevant? Has the world converged onto distributing via pip?


---

Comment by mkoeppe created at 2020-05-16 15:36:01

Yes, still need to fix this.


---

Comment by git created at 2020-05-17 05:39:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-05-17 06:04:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-25 06:35:43

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-25 06:35:43

Development continues on #29950 (Build sagelib using the installed `sage_setup`, add `spkg-src`). This ticket can be closed.


---

Comment by dimpase created at 2020-07-16 19:07:17

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2020-10-11 16:57:56

Resolution: duplicate
