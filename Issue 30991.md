# Issue 30991: The "-march=native" flag vs. the compiler used when Python extensions are built

archive/issues_030991.json:
```json
{
    "body": "CC:  @kliem @zlscherr @jhpalmieri\n\n(from #31132)\n\n#27122 determines whether `CC` accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n\nHowever, Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could be `clang`, which does not accept `-march=native`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31228\n\n",
    "created_at": "2021-01-13T01:51:14Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "The \"-march=native\" flag vs. the compiler used when Python extensions are built",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30991",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @kliem @zlscherr @jhpalmieri

(from #31132)

#27122 determines whether `CC` accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.

However, Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could be `clang`, which does not accept `-march=native`.

Issue created by migration from https://trac.sagemath.org/ticket/31228





---

archive/issue_comments_442086.json:
```json
{
    "body": "Do we manually set the Compiler to be different somewhere vor is this enforced by using system python? If not, is there a reasonable place to check this?\n\nCan this happen to python modules only?",
    "created_at": "2021-01-13T07:29:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442086",
    "user": "https://github.com/kliem"
}
```

Do we manually set the Compiler to be different somewhere vor is this enforced by using system python? If not, is there a reasonable place to check this?

Can this happen to python modules only?



---

archive/issue_comments_442087.json:
```json
{
    "body": "There is `CFLAGS_NON_NATIVE` etc that should be used in case the compiler changes.",
    "created_at": "2021-01-13T07:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442087",
    "user": "https://github.com/kliem"
}
```

There is `CFLAGS_NON_NATIVE` etc that should be used in case the compiler changes.



---

archive/issue_comments_442088.json:
```json
{
    "body": "This is the standard behavior of python's distutils. Only Python extension modules are affected.\n\n`m4/sage_check_python_for_venv` defines a macro used by `build/pkgs/python3/spkg-configure.m4` to check the suitability of distutils.\n\nThese are probably the best places to put additional checks.",
    "created_at": "2021-01-13T20:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442088",
    "user": "https://github.com/mkoeppe"
}
```

This is the standard behavior of python's distutils. Only Python extension modules are affected.

`m4/sage_check_python_for_venv` defines a macro used by `build/pkgs/python3/spkg-configure.m4` to check the suitability of distutils.

These are probably the best places to put additional checks.



---

archive/issue_comments_442089.json:
```json
{
    "body": "I see. I can add a file compiling with `-march=native` in `m4/sage_check_python_for_venv`. In case of failure, I have to export something.\n\nIf this fails, I have to build extension modules with `export CFLAGS=CFLAGS_NON_NATIVE` and `export CXXFLAGS=CXXFLAGS_NON_NATIVE` somehow.",
    "created_at": "2021-01-13T20:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442089",
    "user": "https://github.com/kliem"
}
```

I see. I can add a file compiling with `-march=native` in `m4/sage_check_python_for_venv`. In case of failure, I have to export something.

If this fails, I have to build extension modules with `export CFLAGS=CFLAGS_NON_NATIVE` and `export CXXFLAGS=CXXFLAGS_NON_NATIVE` somehow.



---

archive/issue_comments_442090.json:
```json
{
    "body": "Much easier would be to give completely up on `march=native` in this case.",
    "created_at": "2021-01-13T20:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442090",
    "user": "https://github.com/kliem"
}
```

Much easier would be to give completely up on `march=native` in this case.



---

archive/issue_comments_442091.json:
```json
{
    "body": "Replying to [comment:6 gh-kliem]:\n> Much easier would be to give completely up on `march=native` in this case.\n\n\nYes, I think that would be better. Otherwise too many `spkg-install` files would have to be changed. I don't see a clean way of implementing this in the helper functions `sdh_pip_install` and `sdh_setup_bdist_wheel`.",
    "created_at": "2021-01-13T21:04:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442091",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 gh-kliem]:
> Much easier would be to give completely up on `march=native` in this case.


Yes, I think that would be better. Otherwise too many `spkg-install` files would have to be changed. I don't see a clean way of implementing this in the helper functions `sdh_pip_install` and `sdh_setup_bdist_wheel`.



---

archive/issue_comments_442092.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-01-14T00:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442092",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_442093.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-14T04:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442094.json:
```json
{
    "body": "Let's do this on top of #31132, which has modified the same files.\n\nI have added one commit that refactors `m4/sage_check_python_for_venv.m4` as preparation.",
    "created_at": "2021-01-14T04:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442094",
    "user": "https://github.com/mkoeppe"
}
```

Let's do this on top of #31132, which has modified the same files.

I have added one commit that refactors `m4/sage_check_python_for_venv.m4` as preparation.



---

archive/issue_comments_442095.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-14T04:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442095",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442096.json:
```json
{
    "body": "Here's an attempt",
    "created_at": "2021-01-14T04:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442096",
    "user": "https://github.com/mkoeppe"
}
```

Here's an attempt



---

archive/issue_comments_442097.json:
```json
{
    "body": "Looks plausible, however I don't see exactly, where `-march=native` was added such that this command fails.\n\n```\n            AS_IF([CC=\"$CC\" CXX=\"$CXX\" conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [\n```\n\nMaybe we need to add `-march=native` yet:\n\n```\n            AS_IF([CC=\"$CC\" CXX=\"$CXX\" CFLAGS=\"-march=native\" CXXFLAGS=\"-march=native\" conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [\n```\n\nBut I'm just hoping they are respected.",
    "created_at": "2021-01-14T08:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442097",
    "user": "https://github.com/kliem"
}
```

Looks plausible, however I don't see exactly, where `-march=native` was added such that this command fails.

```
            AS_IF([CC="$CC" CXX="$CXX" conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
```

Maybe we need to add `-march=native` yet:

```
            AS_IF([CC="$CC" CXX="$CXX" CFLAGS="-march=native" CXXFLAGS="-march=native" conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
```

But I'm just hoping they are respected.



---

archive/issue_comments_442098.json:
```json
{
    "body": "Yes, I meant to add `CFLAGS=\"$CFLAGS_MARCH\"` in these places",
    "created_at": "2021-01-14T17:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442098",
    "user": "https://github.com/mkoeppe"
}
```

Yes, I meant to add `CFLAGS="$CFLAGS_MARCH"` in these places



---

archive/issue_comments_442099.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-01-15T21:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442099",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_442100.json:
```json
{
    "body": "On homebrew, this will have to be tested together with #31227 if a current XCode version is in use",
    "created_at": "2021-01-16T04:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442100",
    "user": "https://github.com/mkoeppe"
}
```

On homebrew, this will have to be tested together with #31227 if a current XCode version is in use



---

archive/issue_comments_442101.json:
```json
{
    "body": "There is a merge conflict with #31227.\n\nDoes the problem show up during github workflows? (If so, I can fix the merge conflict and test whether the problem goes away.)",
    "created_at": "2021-01-16T08:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442101",
    "user": "https://github.com/kliem"
}
```

There is a merge conflict with #31227.

Does the problem show up during github workflows? (If so, I can fix the merge conflict and test whether the problem goes away.)



---

archive/issue_comments_442102.json:
```json
{
    "body": "It showed up when I tried in on my local machine. \nBut now I think the observed failures are actually caused by some outdated code in install scripts of some packages, which explicitly set `CC=clang` - see #30725.",
    "created_at": "2021-01-16T17:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442102",
    "user": "https://github.com/mkoeppe"
}
```

It showed up when I tried in on my local machine. 
But now I think the observed failures are actually caused by some outdated code in install scripts of some packages, which explicitly set `CC=clang` - see #30725.



---

archive/issue_comments_442103.json:
```json
{
    "body": "Instead of disabling `-march=native` alltogether, one might get away with just disabling it in `sdh_pip_install`.",
    "created_at": "2021-01-22T22:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442103",
    "user": "https://github.com/kliem"
}
```

Instead of disabling `-march=native` alltogether, one might get away with just disabling it in `sdh_pip_install`.



---

archive/issue_comments_442104.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-23T04:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442104",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442105.json:
```json
{
    "body": "I prefer the easy solution as currently implemented, see comment 7 above",
    "created_at": "2021-01-23T04:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442105",
    "user": "https://github.com/mkoeppe"
}
```

I prefer the easy solution as currently implemented, see comment 7 above



---

archive/issue_comments_442106.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-23T04:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442106",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442107.json:
```json
{
    "body": "Upgrading this to blocker, because this ticket is needed to get cython installation to work again (when python uses clang instead of gcc):\n\nhttps://trac.sagemath.org/ticket/30725#comment:50",
    "created_at": "2021-01-23T10:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442107",
    "user": "https://github.com/kliem"
}
```

Upgrading this to blocker, because this ticket is needed to get cython installation to work again (when python uses clang instead of gcc):

https://trac.sagemath.org/ticket/30725#comment:50



---

archive/issue_comments_442108.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2021-01-23T10:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442108",
    "user": "https://github.com/kliem"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_442109.json:
```json
{
    "body": "Replying to [comment:16 gh-kliem]:\n> New commits:\n> |                                                                                                                                          |                         |\n> |------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|\n> |[3a86a18](https://git.sagemath.org/sage.git/commit?id=3a86a18f345a1c98411aa05254bff58ac02c3180)|`add CFLAGS and CXXFLAGS`|\n\n\nI think this commit is needed, isn't it?",
    "created_at": "2021-01-23T10:20:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442109",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:16 gh-kliem]:
> New commits:
> |                                                                                                                                          |                         |
> |------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|
> |[3a86a18](https://git.sagemath.org/sage.git/commit?id=3a86a18f345a1c98411aa05254bff58ac02c3180)|`add CFLAGS and CXXFLAGS`|


I think this commit is needed, isn't it?



---

archive/issue_comments_442110.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-23T10:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442110",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_442111.json:
```json
{
    "body": "I just started github actions along with commit `3a86a18f345a1c98411aa05254bff58ac02c3180`.\n\nPlease tell me, if I need to pull other tickets yet as mentioned in:\n\nhttps://trac.sagemath.org/ticket/30725#comment:42\n\nBtw, I personally would find it useful, those tickets needed to fix github actions on top of the current beta are collected somewhere.",
    "created_at": "2021-01-23T10:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442111",
    "user": "https://github.com/kliem"
}
```

I just started github actions along with commit `3a86a18f345a1c98411aa05254bff58ac02c3180`.

Please tell me, if I need to pull other tickets yet as mentioned in:

https://trac.sagemath.org/ticket/30725#comment:42

Btw, I personally would find it useful, those tickets needed to fix github actions on top of the current beta are collected somewhere.



---

archive/issue_comments_442112.json:
```json
{
    "body": "Replying to [comment:27 gh-kliem]:\n> Replying to [comment:16 gh-kliem]:\n> > New commits:\n> > |                                                                                                                                          |                         |\n> > |------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|\n> > |[3a86a18](https://git.sagemath.org/sage.git/commit?id=3a86a18f345a1c98411aa05254bff58ac02c3180)|`add CFLAGS and CXXFLAGS`|\n\n> \n> I think this commit is needed, isn't it?\n\n\nRight, something like this. I'll try to dig out the commits that I was using",
    "created_at": "2021-01-23T18:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442112",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 gh-kliem]:
> Replying to [comment:16 gh-kliem]:
> > New commits:
> > |                                                                                                                                          |                         |
> > |------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|
> > |[3a86a18](https://git.sagemath.org/sage.git/commit?id=3a86a18f345a1c98411aa05254bff58ac02c3180)|`add CFLAGS and CXXFLAGS`|

> 
> I think this commit is needed, isn't it?


Right, something like this. I'll try to dig out the commits that I was using



---

archive/issue_comments_442113.json:
```json
{
    "body": "I have pushed the branch to #31227. Maybe we can skip the present ticket and do everything in #31227.",
    "created_at": "2021-01-23T20:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442113",
    "user": "https://github.com/mkoeppe"
}
```

I have pushed the branch to #31227. Maybe we can skip the present ticket and do everything in #31227.



---

archive/issue_events_081630.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-25T19:21:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30991#event-81630"
}
```



---

archive/issue_comments_442114.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-25T19:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442114",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_442115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-25T21:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442115",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442116.json:
```json
{
    "body": "Agreed.",
    "created_at": "2021-01-25T21:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442116",
    "user": "https://github.com/kliem"
}
```

Agreed.



---

archive/issue_events_081631.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-26T20:28:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30991#event-81631"
}
```



---

archive/issue_comments_442117.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-03-26T20:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30991#issuecomment-442117",
    "user": "https://github.com/vbraun"
}
```

Resolution: invalid
