# Issue 30991: The "-march=native" flag vs. the compiler used when Python extensions are built

Issue created by migration from https://trac.sagemath.org/ticket/31228

Original creator: mkoeppe

Original creation time: 2021-01-13 01:51:14

CC:  @kliem @zlscherr jhpalmieri

(from #31132)

#27122 determines whether `CC` accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.

However, Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could be `clang`, which does not accept `-march=native`.


---

Comment by @kliem created at 2021-01-13 07:29:37

Do we manually set the Compiler to be different somewhere vor is this enforced by using system python? If not, is there a reasonable place to check this?

Can this happen to python modules only?


---

Comment by @kliem created at 2021-01-13 07:30:58

There is `CFLAGS_NON_NATIVE` etc that should be used in case the compiler changes.


---

Comment by mkoeppe created at 2021-01-13 20:39:24

This is the standard behavior of python's distutils. Only Python extension modules are affected.

`m4/sage_check_python_for_venv` defines a macro used by `build/pkgs/python3/spkg-configure.m4` to check the suitability of distutils.

These are probably the best places to put additional checks.


---

Comment by @kliem created at 2021-01-13 20:54:04

I see. I can add a file compiling with `-march=native` in `m4/sage_check_python_for_venv`. In case of failure, I have to export something.

If this fails, I have to build extension modules with `export CFLAGS=CFLAGS_NON_NATIVE` and `export CXXFLAGS=CXXFLAGS_NON_NATIVE` somehow.


---

Comment by @kliem created at 2021-01-13 20:57:46

Much easier would be to give completely up on `march=native` in this case.


---

Comment by mkoeppe created at 2021-01-13 21:04:16

Replying to [comment:6 gh-kliem]:
> Much easier would be to give completely up on `march=native` in this case.

Yes, I think that would be better. Otherwise too many `spkg-install` files would have to be changed. I don't see a clean way of implementing this in the helper functions `sdh_pip_install` and `sdh_setup_bdist_wheel`.


---

Comment by mkoeppe created at 2021-01-14 00:49:07

Changing priority from major to critical.


---

Comment by git created at 2021-01-14 04:29:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-01-14 04:30:38

Let's do this on top of #31132, which has modified the same files.

I have added one commit that refactors `m4/sage_check_python_for_venv.m4` as preparation.


---

Comment by git created at 2021-01-14 04:54:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-14 04:55:14

Here's an attempt


---

Comment by @kliem created at 2021-01-14 08:15:12

Looks plausible, however I don't see exactly, where `-march=native` was added such that this command fails.


```
            AS_IF([CC="$CC" CXX="$CXX" conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
```


Maybe we need to add `-march=native` yet:


```
            AS_IF([CC="$CC" CXX="$CXX" CFLAGS="-march=native" CXXFLAGS="-march=native" conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
```


But I'm just hoping they are respected.


---

Comment by mkoeppe created at 2021-01-14 17:50:48

Yes, I meant to add `CFLAGS="$CFLAGS_MARCH"` in these places


---

Comment by @kliem created at 2021-01-15 21:48:42

New commits:


---

Comment by mkoeppe created at 2021-01-16 04:21:07

On homebrew, this will have to be tested together with #31227 if a current XCode version is in use


---

Comment by @kliem created at 2021-01-16 08:22:23

There is a merge conflict with #31227.

Does the problem show up during github workflows? (If so, I can fix the merge conflict and test whether the problem goes away.)


---

Comment by mkoeppe created at 2021-01-16 17:57:47

Changing priority from critical to major.


---

Comment by mkoeppe created at 2021-01-16 17:57:47

It showed up when I tried in on my local machine. 
But now I think the observed failures are actually caused by some outdated code in install scripts of some packages, which explicitly set `CC=clang` - see #30725.


---

Comment by @kliem created at 2021-01-22 22:20:50

Instead of disabling `-march=native` alltogether, one might get away with just disabling it in `sdh_pip_install`.


---

Comment by mkoeppe created at 2021-01-23 04:38:36

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-01-23 04:38:36

I prefer the easy solution as currently implemented, see comment 7 above


---

Comment by git created at 2021-01-23 04:40:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-23 10:09:16

Upgrading this to blocker, because this ticket is needed to get cython installation to work again (when python uses clang instead of gcc):

https://trac.sagemath.org/ticket/30725#comment:50


---

Comment by @kliem created at 2021-01-23 10:09:16

Changing priority from major to blocker.


---

Comment by @kliem created at 2021-01-23 10:20:53

Replying to [comment:16 gh-kliem]:
> New commits:
> ||[3a86a18](https://git.sagemath.org/sage.git/commit?id=3a86a18f345a1c98411aa05254bff58ac02c3180)||`add CFLAGS and CXXFLAGS`||

I think this commit is needed, isn't it?


---

Comment by @kliem created at 2021-01-23 10:21:32

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-01-23 10:39:03

I just started github actions along with commit `3a86a18f345a1c98411aa05254bff58ac02c3180`.

Please tell me, if I need to pull other tickets yet as mentioned in:

https://trac.sagemath.org/ticket/30725#comment:42

Btw, I personally would find it useful, those tickets needed to fix github actions on top of the current beta are collected somewhere.


---

Comment by mkoeppe created at 2021-01-23 18:35:11

Replying to [comment:27 gh-kliem]:
> Replying to [comment:16 gh-kliem]:
> > New commits:
> > ||[3a86a18](https://git.sagemath.org/sage.git/commit?id=3a86a18f345a1c98411aa05254bff58ac02c3180)||`add CFLAGS and CXXFLAGS`||
> 
> I think this commit is needed, isn't it?

Right, something like this. I'll try to dig out the commits that I was using


---

Comment by mkoeppe created at 2021-01-23 20:24:55

I have pushed the branch to #31227. Maybe we can skip the present ticket and do everything in #31227.


---

Comment by mkoeppe created at 2021-01-25 19:21:54

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-01-25 21:28:27

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-01-25 21:28:27

Agreed.


---

Comment by vbraun created at 2021-03-26 20:28:26

Resolution: invalid
