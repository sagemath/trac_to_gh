# Issue 22923: Add a library of common helper functions for use in spkg-install

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-06-07 14:39:13

This idea has come up before but not been implemented.  My implementation simply adds a collection of shell functions with names prefixed by `sdh_` for Sage distribution helpers (this is somewhat inspired by, but much simpler than, the `dh_` programs from the `debhelper` package in Debian).

These functions are exported by `sage-spkg`, and so are immediately usable by any `spkg-build`, `spkg-install`, or similar scripts executed from `sage-spkg` (these are still not required to be shell scripts, but as most are having such a library is convenient).

One piece of boilerplate I replaced with a function is the check in most `spkg-install`s for `$SAGE_LOCAL`.  A downside to this is that if the script is run outside the correct environment, then rather than getting a useful error message we just get that `sdh_check_vars` is undefined.  I have two thoughts on this:

1) In general these scripts shouldn't be run directly in the first place.  In the case that they are (such as testing) the person developing the package should have some awareness of the fact that these scripts are being run from `sage-spkg` and assume `sage-env` has been sourced.

2) Most of the time these scripts are run, it's after they've been copied to a temporary build directory for the package.  If nothing else, `sage-spkg` could create a wrapper around these scripts that automatically sets some default assumptions (such as sourcing `sage-env` and the new `sage-dist-helpers`).

In general, though, I think having a library of helper functions will be a big improvement to the consistency and legibility of theses scripts.  

This ticket also updates the `spkg-install` for `patch` for demonstration purposes only.  I don't intend with this to go on a mass rewriting of install scripts, but having this will be helpful for some other work (e.g. #22509, #22510).


---

Comment by embray created at 2017-06-07 14:41:06

This could also replace the `$PIP_INSTALL` variable that's used for Python packages with an `sdh_pip_install` helper, serving the same purpose, but that could be done separately.


---

Comment by jdemeyer created at 2017-06-07 14:46:37

The whole point of this

```
if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "Error: SAGE_LOCAL undefined - exiting..."
    echo >&2 "Maybe run 'sage -sh'?"
    exit 1
fi
```

is to abort when the variable is not defined. A plain `sdh_check_common_vars` does not do that. At least replace it by `sdh_check_common_vars || exit $?` or something like that.


---

Comment by jdemeyer created at 2017-06-07 14:56:04

I would also rename `sdh_check_common_vars` to something like `sdh_guard` (or `sdh_begin` or `sdh_check`). It's not important what `sdh_check_common_vars` does, only that it guards against accidental executing of `spkg-install` when the necessary variables are not defined.


---

Comment by embray created at 2017-06-07 15:00:09

I'm not sure I understand.  It's already defined to exit the script immediately.


---

Comment by embray created at 2017-06-07 15:00:59

Replying to [comment:4 embray]:
> I'm not sure I understand.  It's already defined to exit the script immediately.

Oh, you mean if it's _not_ defined in the first place.


---

Comment by embray created at 2017-06-07 15:05:27

One point I will make though, is that if more of the build functionality is moved into helper functions there's also less effect a script can have if it's run outside the sage environment.  For example if `sdh_make_install` is not defined, then nothing will be installed.  That's no a silver bullet though, so I can still see the usefulness of having this guard in place.


---

Comment by embray created at 2017-06-07 15:10:02

Okay, I'd be fine with something like `sdh_guard || exit $?`.  It's still boilerplate but at least now it's only one line.


---

Comment by embray created at 2017-06-08 12:36:36

That said, this brings me back around to the idea I was mulling earlier, that maybe the `spkg-*` scripts that live in the package directories shouldn't be executable in the first place.  That as, they would not have executable permissions, and not have a shebang line.

_Only_ when the script is copied to the temporary install directory does it get marked executable, and gets a header automatically written which, among other things, ensures that the correct `sage-env` is sourced.  So there's generally no danger in running it outside the correct sage environment.  

This might limit it to being a shell script, but it could still be a wrapper for a non-shell executable if desired (there are only a couple cases of this currently, such as atlas).


---

Comment by jdemeyer created at 2017-06-08 14:44:08

Replying to [comment:8 embray]:
> _Only_ when the script is copied to the temporary install directory does it get marked executable, and gets a header automatically written which, among other things, ensures that the correct `sage-env` is sourced.

My gut feeling is that this is a bit too much magic. At least the `sdh_guard || exit $?` boilerplate is easy to understand with little surprises.


---

Comment by embray created at 2017-06-08 14:55:06

That was my feeling too at first, which is why I dropped the idea initially.  But now that I've tried it I think it has a number of advantages, including the fact that it automatically makes these scripts more robust without their authors having to think about details that aren't immediately related to building/installing the package.


---

Comment by embray created at 2017-06-08 14:55:20

Have a look at #23179.


---

Comment by git created at 2017-07-06 13:22:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-07-06 13:22:55

Rebased on latest version of #23179


---

Comment by embray created at 2017-07-06 13:22:55

Changing status from new to needs_review.


---

Comment by git created at 2017-07-07 13:53:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-07-13 10:10:23

Needs to be rebased on the latest version of #23179. Given that I'll probably wait with a review for this ticket until after the next beta, you could also wait until then and then rebase on 8.1.beta0.


---

Comment by embray created at 2017-07-13 13:48:14

True, it needs to be rebased now.  I don't mind the timing, but why specifically after the next beta?  Or is that just the next point at which #23179 will be merged into develop?


---

Comment by embray created at 2017-07-13 13:48:19

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-07-13 13:54:04

Actually, just to be clear, if you (or anyone else) wants to review this sooner you can still see the diff between this branch and the branch for #23179 like so:

https://git.sagemath.org/sage.git/diff?id2=u/embray/build/script-wrappers&id=u/embray/build/helpers

That should make reviewing this much easier.


---

Comment by jdemeyer created at 2017-07-14 07:43:45

I'd rather be sure that #23179 really is merged. It wouldn't surprise me if problems would come up with that ticket.


---

Comment by embray created at 2017-07-17 08:39:12

It wouldn't surprise me either, though not much of this ticket is really strongly dependent on #23179.  It only affects how `sdh_guard` is used.  Up to you though.


---

Comment by git created at 2017-07-18 09:57:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-07-18 09:58:20

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-08-09 11:24:01

This introduces again `PKG_OLD_STYLE`. Is this a mistake in the branch or do you really think it is needed?

Other than that, I have no objections by looking at the patch. I still need to test, but I will do that after you fix the `PKG_OLD_STYLE` stuff.


---

Comment by jdemeyer created at 2017-08-09 11:24:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-08-09 11:26:28

This may or may not be for a follow-up ticket, but in `build/pkgs/lcalc/spkg-install` (and others), there is

```
success() {
    if [ $? -ne 0 ]; then
        echo >&2 "Error building the Lcalc package: '$1'"
        exit 1
    fi
}
```


I guess a helper function like that would be useful to have.


---

Comment by embray created at 2017-08-09 11:27:41

Oops, that was not intentional.  It's possible I pushed from a different computer where I still had that commit in the branch.  I'm a little confused by that because normally I would have made sure to sync up first, but it was 3 weeks ago so I don't remember.


---

Comment by embray created at 2017-08-09 11:29:31

Replying to [comment:25 jdemeyer]:
> This may or may not be for a follow-up ticket, but in `build/pkgs/lcalc/spkg-install` (and others), there is
> {{{
> success() {
>     if [ $? -ne 0 ]; then
>         echo >&2 "Error building the Lcalc package: '$1'"
>         exit 1
>     fi
> }
> }}}
> 
> I guess a helper function like that would be useful to have.

Yes, I already added something like that in #22509, but it might be worth pulling into a separate ticket.  I just added it there because it became increasingly useful.


---

Comment by embray created at 2017-08-09 11:35:21

I see why I'm confused. This needs to be rebased on the final version of #23179.  I don't know why you removed the dependency.  I think it's useful to have listed in the ticket even if the dependency has been completed.


---

Comment by git created at 2017-08-09 11:37:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-08-09 11:38:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-08-09 11:48:58

If you intend that `spkg-install` can be run _without_ `sage-spkg` (I assume that was part of the intention of #23179), the following should be done in `spkg-install` instead of `sage-spkg`:

```
# Export package information for use from within the scripts.
export PKG_NAME PKG_BASE PKG_VER
```

These could be handled analogously to `SAGE_ROOT` with the values hard-coded in the generated `spkg-install` file.


---

Comment by jdemeyer created at 2017-08-09 11:48:58

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-08-09 11:57:10

Agreed. I already fixed that in #22509 [here](https://git.sagemath.org/sage.git/commit/?h=dbdb94788f6275e19c5fd150bec8a889188f3164&id=5f0637dbbcdb3dd87c69e803cd694d10ed86e52d).  I should have just fixed that in this branch though.


---

Comment by git created at 2017-08-09 12:01:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-08-09 12:03:05

If this otherwise works for you, I'm also going to add some updates to the developer documentation.  Of course, I will continue to update the docs as more helpers are added...


---

Comment by embray created at 2017-08-09 12:07:11

Replying to [comment:34 embray]:
> If this otherwise works for you, I'm also going to add some updates to the developer documentation.  Of course, I will continue to update the docs as more helpers are added...

On second thought; as it stands with this ticket the helpers that it adds are few in number and trivial enough that there's not enormous advantage to using them.  This will change, however, after a few more updates that will add some additional helpers.  But maybe the feature isn't worth advertising until it's more complete.  In the meantime it will be useful to have the framework in place so that it can be built on.


---

Comment by embray created at 2017-08-09 12:07:11

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-08-09 12:09:07

Works for me...


---

Comment by jdemeyer created at 2017-08-09 12:09:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-08-14 22:36:55

You want this to be merged? There is no milestone set...


---

Comment by vbraun created at 2017-08-17 20:33:26

Resolution: fixed
