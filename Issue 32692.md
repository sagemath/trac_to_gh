# Issue 32692: Bad determination of the coordinate range when restricting charts to subdomains

archive/issues_032692.json:
```json
{
    "body": "CC:  @mkoeppe @tscrim @mjungmath\n\nSince Sage 9.4, we have \n\n```\nsage: M = Manifold(2, 'M')\nsage: X.<x,y> = M.chart(r\"x:(0,+oo) y\")\nsage: X.coord_range()\nx: (0, +oo); y: (-oo, +oo)\nsage: U = M.open_subset('U', coord_def={X: x<1})\nsage: X.restrict(U).coord_range()\nx: (-oo, 1); y: (-oo, +oo)\n```\n\nThe lower bound for `x` should be `O`, not `-oo`.\n\nSage <= 9.3 was free of this bug. In Sage >= 9.4, one can trace it to the optional argument `bounds` of `RealChart.__init__`, which is used in `RealChart.restrict` (cf. the line `res = type(self)(..., bounds=self._bounds, ...)`)\nand which is not correctly transmitted by `Chart.__classcall__`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32929\n\n",
    "created_at": "2021-11-24T21:33:01Z",
    "labels": [
        "component: manifolds",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Bad determination of the coordinate range when restricting charts to subdomains",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32692",
    "user": "https://github.com/egourgoulhon"
}
```
CC:  @mkoeppe @tscrim @mjungmath

Since Sage 9.4, we have 

```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart(r"x:(0,+oo) y")
sage: X.coord_range()
x: (0, +oo); y: (-oo, +oo)
sage: U = M.open_subset('U', coord_def={X: x<1})
sage: X.restrict(U).coord_range()
x: (-oo, 1); y: (-oo, +oo)
```

The lower bound for `x` should be `O`, not `-oo`.

Sage <= 9.3 was free of this bug. In Sage >= 9.4, one can trace it to the optional argument `bounds` of `RealChart.__init__`, which is used in `RealChart.restrict` (cf. the line `res = type(self)(..., bounds=self._bounds, ...)`)
and which is not correctly transmitted by `Chart.__classcall__`.

Issue created by migration from https://trac.sagemath.org/ticket/32929





---

archive/issue_comments_465870.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-27T16:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465870",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_465871.json:
```json
{
    "body": "Here is a proposed fix. The bug was triggered in `Chart.__classcall__` by the unconditional resetting of the argument `coordinate_options`, so that neither `bounds` nor `periods` could be transmitted to `__init__` while constructing the restricted chart in `Chart.restrict` or `RealChart.restrict`. \n\nIn correcting the bug, I had to change the attribute `_periods` of charts from a dictionary to a tuple, to make it hashable. Hence the changes in the file `point.py` (method `ManifoldPoint.__eq__`). As a benefit, the output of `Chart.periods()` is more readable. \n\nThe doctest change in line 669 of `manifold.py` simply restores the correct coordinate values for a point constructed via `TopologicalManifold._an_element_()`. Indeed, `git blame` reveals that this doctest was incorrectly changed when the bug was introduced in Sage 9.4.\n----\nNew commits:",
    "created_at": "2021-11-27T16:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465871",
    "user": "https://github.com/egourgoulhon"
}
```

Here is a proposed fix. The bug was triggered in `Chart.__classcall__` by the unconditional resetting of the argument `coordinate_options`, so that neither `bounds` nor `periods` could be transmitted to `__init__` while constructing the restricted chart in `Chart.restrict` or `RealChart.restrict`. 

In correcting the bug, I had to change the attribute `_periods` of charts from a dictionary to a tuple, to make it hashable. Hence the changes in the file `point.py` (method `ManifoldPoint.__eq__`). As a benefit, the output of `Chart.periods()` is more readable. 

The doctest change in line 669 of `manifold.py` simply restores the correct coordinate values for a point constructed via `TopologicalManifold._an_element_()`. Indeed, `git blame` reveals that this doctest was incorrectly changed when the bug was introduced in Sage 9.4.
----
New commits:



---

archive/issue_comments_465872.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-11-27T16:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465872",
    "user": "https://github.com/egourgoulhon"
}
```

Changing priority from major to critical.



---

archive/issue_comments_465873.json:
```json
{
    "body": "Changing keywords from \"\" to \"chart\".",
    "created_at": "2021-11-27T16:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465873",
    "user": "https://github.com/egourgoulhon"
}
```

Changing keywords from "" to "chart".



---

archive/issue_comments_465874.json:
```json
{
    "body": "Just a trivial change for doc formatting:\n\n```diff\n         - a tuple of variables (as elements of ``SR``)\n         - a dictionary with possible keys:\n-          - `\"periods\"`: a tuple of periods\n-          - `\"bounds\"`: a tuple of coordinate ranges\n+\n+          * ``\"periods\"``: a tuple of periods\n+          * ``\"bounds\"``: a tuple of coordinate ranges\n```\n\nOnce changed, you can set a positive review.",
    "created_at": "2021-11-29T09:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465874",
    "user": "https://github.com/tscrim"
}
```

Just a trivial change for doc formatting:

```diff
         - a tuple of variables (as elements of ``SR``)
         - a dictionary with possible keys:
-          - `"periods"`: a tuple of periods
-          - `"bounds"`: a tuple of coordinate ranges
+
+          * ``"periods"``: a tuple of periods
+          * ``"bounds"``: a tuple of coordinate ranges
```

Once changed, you can set a positive review.



---

archive/issue_comments_465875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-29T10:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_465876.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n\nThank you for the review!\n> Just a trivial change for doc formatting:\nCorrected in the above commit.",
    "created_at": "2021-11-29T10:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465876",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:5 tscrim]:

Thank you for the review!
> Just a trivial change for doc formatting:
Corrected in the above commit.



---

archive/issue_comments_465877.json:
```json
{
    "body": "The other thing that is needed (I believe) in the blank line between the indented bullets.",
    "created_at": "2021-11-29T11:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465877",
    "user": "https://github.com/tscrim"
}
```

The other thing that is needed (I believe) in the blank line between the indented bullets.



---

archive/issue_comments_465878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-29T12:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465878",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_465879.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> The other thing that is needed (I believe) in the blank line between the indented bullets.\nThanks for catching this. This is corrected in the last commit.",
    "created_at": "2021-11-29T12:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465879",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:8 tscrim]:
> The other thing that is needed (I believe) in the blank line between the indented bullets.
Thanks for catching this. This is corrected in the last commit.



---

archive/issue_comments_465880.json:
```json
{
    "body": "in view of comment:5.\n\nThank you Travis!",
    "created_at": "2021-11-30T20:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465880",
    "user": "https://github.com/egourgoulhon"
}
```

in view of comment:5.

Thank you Travis!



---

archive/issue_comments_465881.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-30T20:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465881",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465882.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-12T15:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32692#issuecomment-465882",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087023.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32692",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32692#event-87023"
}
```
