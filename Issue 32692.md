# Issue 32692: Bad determination of the coordinate range when restricting charts to subdomains

Issue created by migration from https://trac.sagemath.org/ticket/32929

Original creator: egourgoulhon

Original creation time: 2021-11-24 21:33:01

CC:  mkoeppe tscrim @mjungmath

Since Sage 9.4, we have 

```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart(r"x:(0,+oo) y")
sage: X.coord_range()
x: (0, +oo); y: (-oo, +oo)
sage: U = M.open_subset('U', coord_def={X: x<1})
sage: X.restrict(U).coord_range()
x: (-oo, 1); y: (-oo, +oo)
```

The lower bound for `x` should be `O`, not `-oo`.

Sage <= 9.3 was free of this bug. In Sage >= 9.4, one can trace it to the optional argument `bounds` of `RealChart.__init__`, which is used in `RealChart.restrict` (cf. the line `res = type(self)(..., bounds=self._bounds, ...)`)
and which is not correctly transmitted by `Chart.__classcall__`.


---

Comment by egourgoulhon created at 2021-11-27 16:13:15

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2021-11-27 16:13:15

Here is a proposed fix. The bug was triggered in `Chart.__classcall__` by the unconditional resetting of the argument `coordinate_options`, so that neither `bounds` nor `periods` could be transmitted to `__init__` while constructing the restricted chart in `Chart.restrict` or `RealChart.restrict`. 

In correcting the bug, I had to change the attribute `_periods` of charts from a dictionary to a tuple, to make it hashable. Hence the changes in the file `point.py` (method `ManifoldPoint.__eq__`). As a benefit, the output of `Chart.periods()` is more readable. 

The doctest change in line 669 of `manifold.py` simply restores the correct coordinate values for a point constructed via `TopologicalManifold._an_element_()`. Indeed, `git blame` reveals that this doctest was incorrectly changed when the bug was introduced in Sage 9.4.
----
New commits:


---

Comment by egourgoulhon created at 2021-11-27 16:13:15

Changing priority from major to critical.


---

Comment by egourgoulhon created at 2021-11-27 16:13:15

Changing keywords from "" to "chart".


---

Comment by tscrim created at 2021-11-29 09:52:02

Just a trivial change for doc formatting:

```diff
         - a tuple of variables (as elements of ``SR``)
         - a dictionary with possible keys:
-          - `"periods"`: a tuple of periods
-          - `"bounds"`: a tuple of coordinate ranges
+
+          * ``"periods"``: a tuple of periods
+          * ``"bounds"``: a tuple of coordinate ranges
```

Once changed, you can set a positive review.


---

Comment by git created at 2021-11-29 10:45:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-11-29 10:47:20

Replying to [comment:5 tscrim]:

Thank you for the review!
> Just a trivial change for doc formatting:
Corrected in the above commit.


---

Comment by tscrim created at 2021-11-29 11:03:32

The other thing that is needed (I believe) in the blank line between the indented bullets.


---

Comment by git created at 2021-11-29 12:33:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-11-29 12:34:52

Replying to [comment:8 tscrim]:
> The other thing that is needed (I believe) in the blank line between the indented bullets.
Thanks for catching this. This is corrected in the last commit.


---

Comment by egourgoulhon created at 2021-11-30 20:18:00

in view of comment:5.

Thank you Travis!


---

Comment by egourgoulhon created at 2021-11-30 20:18:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-12 15:09:12

Resolution: fixed
