# Issue 18174: Get rid of sage.combinat.cartesian_product

Issue created by migration from https://trac.sagemath.org/ticket/18411

Original creator: vdelecroix

Original creation time: 2015-05-13 09:44:39

CC:  nthiery ncohen

The features of `sage.combinat.cartesian_product.CartesianProduct` are now completely integrated into the category framework. We just make `CartesianProduct` an alias for `sage.sets.cartesian_product.CartesianProduct` (with some tweak to support the behavior).

`sage.combinat.cartesian_product.CartesianProduct` is deprecated.


---

Comment by git created at 2015-09-07 19:39:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-12 02:18:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-09-12 02:22:17

Changing status from new to needs_review.


---

Comment by git created at 2015-09-12 09:56:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-12 13:47:06

Thanks Frédéric for fixing a doctest. Though, I do not see the point of modifying `src/sage/rings/quotient_ring.py`. This file is completely unrelated to this ticket.


---

Comment by git created at 2015-09-12 14:17:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-12 14:40:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-09-12 14:41:33

Hi Frédéric,

This was clearly not the way to fix `composition_signed.py`. I removed this change from your commit. The rest of my commits should fix all issues with timed out testing (ie root system and padic) as well as the issue with tableau tuples.

Vincent


---

Comment by git created at 2015-09-12 17:19:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-12 17:31:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-12 17:41:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-12 19:04:28

The only failing doctest is fine when run independently... I am not sure what may have happend.

Vincent


---

Comment by git created at 2015-09-12 22:48:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-12 22:51:18

New commits:


---

Comment by vdelecroix created at 2015-09-12 22:51:18

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-09-12 22:52:05

I was worried with `CombinatorialFreeModule` but it went smoothly. I just need to add a commit for the deprecation!


---

Comment by git created at 2015-09-12 23:26:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-13 01:21:02

Annoying bug:

```
sage: F = FiniteEnumeratedSet([int(1), int(2)])
sage: F(1)
Traceback (most recent call last):
...
TypeError: Cannot convert int to sage.structure.element.Element
```

And the following is also a bug IMHO

```
sage: FiniteEnumeratedSet([1,2]) is FiniteEnumeratedSet([int(1),int(2)])
True
```



---

Comment by git created at 2015-09-13 01:47:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-09-13 01:54:07

I got into troubles. Combinatorial free modules are too laxist and you discover mistakes only very lately... in the following an element `g` is built

```
sage: M = SchurTensorModule(QQ, 2, 2)
sage: A = M._schur
sage: f = M.basis()[(1,1)]
sage: e = A.basis().values()[0]
sage: g = e*f
```

but it is not valid in the sense that the keys do not correspond to the basis

```
sage: map(type, g.monomial_coefficients().keys())
[<type 'tuple'>]
sage: g.parent().basis().keys()
The cartesian product of ({1, 2}, {1, 2})
```

And hence you *silently* got

```
sage: g.to_vector()
(0, 0, 0, 0)
```



---

Comment by git created at 2015-09-13 02:14:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-09-13 02:15:43

All right, my solution is to not use `cartesian_product` in combinatorial free module and postponed this step to #19195. Needs review again.

Vincent


---

Comment by vdelecroix created at 2015-09-13 02:15:43

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-09-13 03:30:28

Patchbot's green light ;-)


---

Comment by git created at 2015-09-14 15:20:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-14 16:32:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-14 16:36:15

I just implemented the changes requested By Nicolas Thiéry while we discussed on phone.


---

Comment by git created at 2015-09-15 00:47:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-15 21:11:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-15 21:23:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-15 21:30:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-15 21:36:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-15 21:39:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2015-09-15 21:53:38

Here is a trace of the non trivial points we discussed privately with
Vincent:

> >- enumerated_set_from_iterator: do we want instead to start filling
> >the cache in case it does not exist yet?
> 
> Nope. The cache might be *never* used in that class. And when it exists it
> is automatically filled since it is a lazy_list.

Oh, I had not noticed that, in `EnumeratedSetFromIterator`, the existence
of the cache was decided upon construction. +1 then.

>>>> - Why moving __iter__ from `EnumeratedSets.CartesianProducts` to
>>>> `Sets.CartesianProducts`?
>>>
>>> Because otherwise there are some failing doctests. For example
>>>     `Set([1,2,3])`
>>> is iterable but the following was not
>>>     `cartesian_product([Set(1,2,3), Set([1,2,3])])`
>>>
>>> The fact that something is iterable does not necessarily mean that it
>>> belongs to `EnumeratedSet`. At least for me and the current class
>>> `FiniteEnumeratedSet`, the enumerated set {1, 2, 3} is not equal to the
>>> enumerated set {3, 2, 1}. But they are equal as sets. And the set {1, 2, 3}
>>> should be iterable.
>>
>> I see your point. Yet this is annoying; where do we want to put the
>> exact limit between `Set` and `EnumeratedSet`? Where should, e.g. features
>> like cardinality_from_iterator live?
>>
>> Hmm, I am not sure what to do here.
>
>Right. My main motivation was to fix some doctests were previous code
>expected that the result was iterable. I do not exactly remind where it was.

Would it make sense to put it in `Sets.Finite.CartesianProduct`, given
that it only works in the finite case?

>The iterator is mandatory for cardinality_from_iterator, as it is not
>for Sets I would not put there.

Yeah, that's a good point.

>> - Do we want to systematically use itertools.product when in some
>> cases it's memory complexity is not as good as what we can do when we
>> have iterables and not iterators as input?
>
>Clearly not. But we are lacking something better. Once the list is
>expanded, you can not beat itertools. So in most cases, it is what you
>want since the size of factors is small compared to the size of the product.
>
>> - Sets 2034: is_empty: - don't catch all exceptions - is it about
>> parents not implementing is_empty, or about returning Unknown or
>> raising an exception? In which case we should specify that exception
>> and only catch that one.
>
>done
>
>> - `CartesianProduct_iters`: Make the difference with cartesian_product
>> more explicit and add a link?
>
>done
>
>> - Compositions: `return FiniteEnumeratedSet([self])`
>
>done
>
>> or make `cartesian_product()` return `FiniteEnumeratedSet([xxx])` or
>> `Set([xxx])` where `xxx` is the trivial tuple.
>
>This is not a good idea. The interface should be uniform when you do
>elt[i] to access the i-th cartesian projection.
>
>> - partition_tuple: could there not be other combinations, like (())?
>
>I did not found any. The empty tuple comes from the iteration with product.
>
>> - root_lattice_realization: is the conversion to `FiniteEnumeratedSet`
>> still necessary?
>>
>> {{{
>> C = cartesian_product([PositiveIntegers(),
>> FiniteEnumeratedSet(Q.roots())])
>> }}}
>>
>> If so, should instead cartesian_product do more input tidying work?
>
>Indeed, it is not. done.
>
> >- sets.family: maybe that test was about checking that things work
> >when a parent C is just in EnumeratedSets but C.cardinality() ==
> >infinity
> 
> I reintroduced the test using `cartesian_product` instead of `CartesianProduct`
>
>> ... about `cartesian_product()` ...
>>
>> So what about returning:
>>
>> {{{
>>          sage: from sage.sets.cartesian_product import CartesianProduct
>>          sage: CartesianProduct((), Sets().CartesianProducts())
>>          The cartesian product of ()
>> }}}
>>
>> I vaguely remember we discussed this at some point, but don't remember
>> what the outcome was. Of course if the user did not specify a category
>> to `cartesian_product()`, we don't quite know what's the category he
>> expects, but `Sets().CartesianProducts()` sounds like a reasonable
>> starting point.
>
>I also remember that we discussed it. And indeed, for the sake of 
>backward compatibility it needs to be done in that ticket... we had
>
> {{{
>sage: CartesianProduct()
>Cartesian product of
>sage: CartesianProduct().cardinality()
>1
>sage: CartesianProduct().an_element()
>[]
>}}}
>
>There is an other commit for that.

Thanks!

I made some minor review changes. Since the spacing commit for the
tutorial was going the wrong way w.r.t. Python's convention, I allowed
myself to revert it, and actually fix accordingly the surrounding
lines (which I had written incorrectly a couple years ago). I hope
that's ok.

Up to the final position of the `__iter__` method which I am not yet
quite comfortable with, I am happy with the current state.

Anyone a point of view on this final sticking point?

Cheers,
                      Nicolas


---

Comment by vdelecroix created at 2015-09-16 02:57:26

If we switch back, only the following fails (from `sage.combinat.tutorial`):

```
sage: Suits = Set(["Hearts", "Diamonds", "Spades", "Clubs"])
sage: Values = Set([2, 3, 4, 5, 6, 7, 8, 9, 10,
....:               "Jack", "Queen", "King", "Ace"])
sage: Cards = cartesian_product([Values, Suits])
sage: Hands = Subsets(Cards, 5)
Traceback (most recent call last):
...
AttributeError: 'CartesianProduct_with_category' object has no attribute 'list'
```

and the reason is because you can not do the list of `Cards`...

```
sage: list(Cards)
Traceback (most recent call last):
...
AttributeError: 'CartesianProduct_with_category' object has no attribute 'list'
```


There are of course other ways to fix it, but I found that it was the simplest. Using `FiniteEnumeratedSet` instead of `Set` in the tutorial seems unnatural to me since you want to keep it as simple as possible...

Vincent


---

Comment by nthiery created at 2015-09-16 11:26:16

Replying to [comment:39 vdelecroix]:
> If we switch back, only the following fails (from `sage.combinat.tutorial`):
> {{{
> sage: Suits = Set(["Hearts", "Diamonds", "Spades", "Clubs"])
> sage: Values = Set([2, 3, 4, 5, 6, 7, 8, 9, 10,
> ....:               "Jack", "Queen", "King", "Ace"])
> sage: Cards = cartesian_product([Values, Suits])
> sage: Hands = Subsets(Cards, 5)
> Traceback (most recent call last):
> ...
> AttributeError: 'CartesianProduct_with_category' object has no attribute 'list'
> }}}
> and the reason is because you can not do the list of `Cards`...
> {{{
> sage: list(Cards)
> Traceback (most recent call last):
> ...
> AttributeError: 'CartesianProduct_with_category' object has no attribute 'list'
> }}}
> 
> There are of course other ways to fix it, but I found that it was the simplest. Using `FiniteEnumeratedSet` instead of `Set` in the tutorial seems unnatural to me since you want to keep it as simple as possible...

I tend to agree indeed; this would be annoying. 

Maybe we should eventually make the distinction between sets, sets admitting an iterator, and sets with a distinguished enumeration.

For now, let's say that this will do, unless someone has some additional insight to provide.

Still, any thought about moving this feature to Sets.Finite.CartesianProducts?


---

Comment by vdelecroix created at 2015-09-16 13:21:52

Replying to [comment:40 nthiery]:
> Replying to [comment:39 vdelecroix]:
> 
> Maybe we should eventually make the distinction between sets, sets admitting an iterator, and sets with a distinguished enumeration.

Ideally, we would do a conditional inheritance based on the presence of `__iter__`. I am not sure it is worth it to complicate anymore the various set categories with an `IterableSets`.

> For now, let's say that this will do, unless someone has some additional insight to provide.
> 
> Still, any thought about moving this feature to `Sets.Finite.CartesianProducts`?

Before it was in `EnumeratedSets.CartesianProducts` and not `EnumeratedSets.Finite.CartesianProducts`. So I tend to prefer the place it is. Of course, we should support better infinite factors.

Vincent


---

Comment by vdelecroix created at 2015-09-19 03:01:15

ping: are we good?


---

Comment by vdelecroix created at 2015-09-23 16:02:30

ping ping: are we good good?


---

Comment by nthiery created at 2015-09-26 13:26:03

Oh, sorry, I missed the ping in my mailbox. Yes, given that noone commented about the Sets thing, I believe we are good. Moving to positive review.


---

Comment by nthiery created at 2015-09-26 13:26:03

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2015-09-26 13:27:00

Changing status from positive_review to needs_work.


---

Comment by nthiery created at 2015-09-26 13:28:39

Oh, I had not noticed the startup module plugin failure. If you see a trivial way to avoid loading the following modules on startup, that would be nice. Otherwise we can live without it:


```
+    sage.combinat.rigged_configurations.itertools
+    sage.geometry.itertools
+    sage.geometry.polyhedron.itertools
```



---

Comment by vdelecroix created at 2015-09-26 13:40:56

Replying to [comment:47 nthiery]:
> Oh, I had not noticed the startup module plugin failure. If you see a trivial way to avoid loading the following modules on startup, that would be nice. Otherwise we can live without it:
> 
> {{{
> +    sage.combinat.rigged_configurations.itertools
> +    sage.geometry.itertools
> +    sage.geometry.polyhedron.itertools
> }}}

It is a problem with the patchbot plugin, Not with my code ;-). The module is `itertools` and not `whatever.the.patchbot.thinks.itertools`.

```
sage: sage.combinat.rigged_configurations.itertools
Traceback (most recent call last):
...
AttributeError: 'module' object has no attribute 'itertools'
```



---

Comment by vdelecroix created at 2015-09-26 13:42:08

More precisely, see [issue 71](https://github.com/robertwb/sage-patchbot/issues/71).


---

Comment by nthiery created at 2015-09-26 13:49:27

Changing status from needs_work to positive_review.


---

Comment by nthiery created at 2015-09-26 13:49:27

Oh, I see. Back to positive review then.

Thanks for all the hard work!!!


---

Comment by vdelecroix created at 2015-09-26 14:05:14

Thanks Nicolas for the careful review.


---

Comment by vbraun created at 2015-10-11 12:29:34

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-10-11 12:29:34

Doctest failure, possibly due to one of these:

```
0e16148 Trac #18338: bell_polynomial(n,k) should always return a polynomial
1d39e65 Trac #18284: Implement left top and right bottom maps for rigged configurations
9481c0b Trac #18223: cartesian products with orders
a677b85 Trac #18044: Implement categories for super algebras/modules
2fef51e Trac #17716: AsymptoticRing and AsymptoticExpression
dbd82f3 Trac #17693: mutable poset: a data structure for asymptotic expressions
34f358b Trac #17190: Error in conversion from RR['x,y'] to RR['x']
a87d70f Trac #19357: Bug in Multivariate Laurent Polynomial Ring
20616e0 Trac #19321: provide better hash functions
```



---

Comment by git created at 2015-10-12 23:41:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by vdelecroix created at 2015-10-12 23:42:19

Changing status from needs_work to positive_review.


---

Comment by vdelecroix created at 2015-10-12 23:42:19

fixed the issue from #17411... hoping it is the only one.


---

Comment by vbraun created at 2015-10-14 09:11:43

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-10-14 09:11:43

Try again with the next beta


---

Comment by git created at 2015-10-16 21:11:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-10-16 21:11:51

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2015-10-16 22:17:04

The change sounds fine to me! Assuming all test pass, back to positive review.


---

Comment by nthiery created at 2015-10-16 22:17:04

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-10-17 06:35:14

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2015-10-17 06:35:14

... does not...


---

Comment by git created at 2015-10-17 06:38:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-10-17 06:38:53

...waiting for the patchbot green light...


---

Comment by vdelecroix created at 2015-10-17 13:26:29

Changing status from needs_work to positive_review.


---

Comment by vdelecroix created at 2015-10-17 13:26:29

Bueno!


---

Comment by vbraun created at 2015-10-17 19:32:16

Merge conflict


---

Comment by vbraun created at 2015-10-17 19:32:16

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2015-10-20 00:16:02

With what?


---

Comment by git created at 2015-10-22 02:41:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-10-22 02:42:17

Hoping I will not have to rebase once more...


---

Comment by vdelecroix created at 2015-10-22 02:42:17

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-10-22 06:53:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-10-23 17:28:11

Resolution: fixed
