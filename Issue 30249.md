# Issue 30249: Prepare doctests for Arb 2.18

Issue created by migration from https://trac.sagemath.org/ticket/30486

Original creator: mkoeppe

Original creation time: 2020-09-02 05:06:44

CC:  fredrik.johansson mmezzarobba vdelecroix fbissey arojas dimpase

Although we have deferred the Arb upgrade to Sage 9.3, on various platforms (e.g. `ubuntu-groovy-standard`, https://github.com/sagemath/sage/runs/1058929422) we are already getting the doctest failures because system Arb is 2.18.

Hence we need to adjust the doctests (see #28623) already in Sage 9.2


---

Comment by dimpase created at 2020-09-16 22:34:33

In #28623#comment:25
there are examples of tests that lead to an error on 2.16, while producing 
a meaningful answer on 2.18, so I don't really think this is easy to consolidate - without making doctests dependent on the arb  version (are there facilities for this ?)


---

Comment by mkoeppe created at 2020-09-16 22:38:41

On this ticket, we would not add such tests.


---

Comment by dimpase created at 2020-09-16 22:41:46

Replying to [comment:3 mkoeppe]:
> On this ticket, we would not add such tests.
what else is left - tagging them `# random - tbf when arb 2.18 is here` ?


---

Comment by mkoeppe created at 2020-09-16 23:37:55

Replying to [comment:4 dimpase]:
>  tagging them `# random - tbf when arb 2.18 is here` ?

That's a good way to do this


---

Comment by dimpase created at 2020-09-17 08:59:22

I'll do a proper fix, with version tags etc


---

Comment by dimpase created at 2020-09-17 09:06:31

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-09-17 09:06:31

this are tags for, and tagging of tests in rings/real_arb, allowing both versions to be tested properly.

is this the right way to get `arb` version that I use?
----
New commits:


---

Comment by git created at 2020-09-17 09:24:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-17 09:43:15

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-09-17 09:43:15

arrgh, the arb version determination is wrong. How does one get the version of the system arb package used?


---

Comment by fbissey created at 2020-09-17 10:02:53

From the point of view of sage-on-distros the use of something like `package_versions` or anything else from `sage.misc.package` is wrong.

The only clear difference between versions seem to be the soname or equivalent of the library. And that information may be be meaningless on some platforms.


---

Comment by fbissey created at 2020-09-17 10:06:43

From `arb.h`

```
ARB_DLL extern const char * arb_version;
```

may be it is possible to ask arb itself?


---

Comment by dimpase created at 2020-09-17 10:17:59

yes, that's what's I'm doing atm. A bit silly - arb should get on pkg-config...


---

Comment by git created at 2020-09-17 10:33:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-17 10:41:00

OK, fixed now.


---

Comment by dimpase created at 2020-09-17 10:41:00

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2020-09-17 10:51:44

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-09-17 10:51:44

Replying to [comment:12 dimpase]:
> yes, that's what's I'm doing atm. A bit silly - arb should get on pkg-config...

I don't think it is silly. pkg-config would be a nice alternative but being able to interrogate the library/program itself about its own version should be a standard feature.

I like the branch, it looks good to me.


---

Comment by vbraun created at 2020-09-21 22:19:49


```
sage -t --long --warn-long 43.6 --random-seed=0 src/sage/doctest/control.py
**********************************************************************
File "src/sage/doctest/control.py", line 778, in sage.doctest.control.DocTestController.expand_files_into_sources
Failed example:
    sorted(DC.sources[0].options.optional)  # abs tol 1
Expected:
    ['guava', 'magma', 'py2']
Got:
    ['arb216', 'guava', 'magma', 'py3']
**********************************************************************
1 item had failures:
   1 of  23 in sage.doctest.control.DocTestController.expand_files_into_sources
    [208 tests, 1 failure, 1.95 s]
----------------------------------------------------------------------
sage -t --long --warn-long 43.6 --random-seed=0 src/sage/doctest/control.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2020-09-21 22:19:49

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-09-22 11:44:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-22 11:48:23

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2020-09-22 11:48:23

OK, fixed, tested.


---

Comment by vbraun created at 2020-09-27 09:09:46

Resolution: fixed
