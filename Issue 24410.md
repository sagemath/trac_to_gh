# Issue 24410: Stricter locking around sage-rebase on Cygwin

archive/issues_024410.json:
```json
{
    "body": "Keywords: rebase\n\nIn #23397 I added a file lock around running `sage-rebase.sh` at the end of every package install on Cygwin, in an effort to reduce errors when multiple packages run `sage-rebase.sh` simultaneously during parallel builds.\n\nUnfortunately, it seems this was not enough--it's possible to get errors during parallel builds of `sage-rebase.sh` is run during the build/installation of some packages.\n\nSo with this change (on Cygwin only of course) all build processes obtain a shared lock on `rebase.lock`, and then `sage-rebase.sh` is run under an exclusive lock.\n\nThis unfortunately slows down parallel builds--for any N packages being built simultaneously, all packages in that set have to wait whichever one takes the longest to build.  But I think this is a necessary sacrifice in order for the builds to not run into this problem.  In the future it may be possible to make this more fine-grained; after all it isn't strictly necessary to run `rebase` for every package (only those that install DLLs).\n\nIssue created by migration from https://trac.sagemath.org/ticket/24647\n\n",
    "created_at": "2018-02-02T15:01:20Z",
    "labels": [
        "component: porting: cygwin"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Stricter locking around sage-rebase on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24410",
    "user": "https://github.com/embray"
}
```
Keywords: rebase

In #23397 I added a file lock around running `sage-rebase.sh` at the end of every package install on Cygwin, in an effort to reduce errors when multiple packages run `sage-rebase.sh` simultaneously during parallel builds.

Unfortunately, it seems this was not enough--it's possible to get errors during parallel builds of `sage-rebase.sh` is run during the build/installation of some packages.

So with this change (on Cygwin only of course) all build processes obtain a shared lock on `rebase.lock`, and then `sage-rebase.sh` is run under an exclusive lock.

This unfortunately slows down parallel builds--for any N packages being built simultaneously, all packages in that set have to wait whichever one takes the longest to build.  But I think this is a necessary sacrifice in order for the builds to not run into this problem.  In the future it may be possible to make this more fine-grained; after all it isn't strictly necessary to run `rebase` for every package (only those that install DLLs).

Issue created by migration from https://trac.sagemath.org/ticket/24647





---

archive/issue_comments_341634.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-02T15:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341634",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_341635.json:
```json
{
    "body": "Does Cygwin support `/dev/fd`? That might be a simpler solution to deal with locks from a file descriptor.",
    "created_at": "2018-02-02T15:18:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341635",
    "user": "https://github.com/jdemeyer"
}
```

Does Cygwin support `/dev/fd`? That might be a simpler solution to deal with locks from a file descriptor.



---

archive/issue_comments_341636.json:
```json
{
    "body": "It does, but I'm not exactly sure what you're proposing.  This is reasonably simple as-is and less platform-dependent.",
    "created_at": "2018-02-02T15:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341636",
    "user": "https://github.com/embray"
}
```

It does, but I'm not exactly sure what you're proposing.  This is reasonably simple as-is and less platform-dependent.



---

archive/issue_comments_341637.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-12T09:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341637",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_341638.json:
```json
{
    "body": "I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n\n[BTW: I had to edit `call :READREGISTRY HKEY_LOCAL_MACHINE\\SOFTWARE\\Cygwin\\setup rootdir` to `call :READREGISTRY HKEY_CURRENT_USER\\SOFTWARE\\Cygwin\\setup rootdir` : I have no admin rights on the machine I'm trying this on...).\n\nThis happened twice. A third attempt worked after waiting about 20 minutes. Go figure...\n\nThis should probably documented at least in the information message (`\"Now waiting for the rebase lock. This might be long...\"`) and possibly in the [Cygwin port page](https://trac.sagemath.org/wiki/Cygwin64Port).\n\n==> tentatively `needs_work`\n\n[ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.",
    "created_at": "2018-03-12T09:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341638",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.

[BTW: I had to edit `call :READREGISTRY HKEY_LOCAL_MACHINE\SOFTWARE\Cygwin\setup rootdir` to `call :READREGISTRY HKEY_CURRENT_USER\SOFTWARE\Cygwin\setup rootdir` : I have no admin rights on the machine I'm trying this on...).

This happened twice. A third attempt worked after waiting about 20 minutes. Go figure...

This should probably documented at least in the information message (`"Now waiting for the rebase lock. This might be long..."`) and possibly in the [Cygwin port page](https://trac.sagemath.org/wiki/Cygwin64Port).

==> tentatively `needs_work`

[ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.



---

archive/issue_comments_341639.json:
```json
{
    "body": "Replying to [comment:5 charpent]:\n> [ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.\n\nThat's what this is trying to resolve.",
    "created_at": "2018-03-12T13:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341639",
    "user": "https://github.com/embray"
}
```

Replying to [comment:5 charpent]:
> [ I'm almost sure this is not related, but when in doubt... ] : I still get lots of errors when trying to build in parallel, dur to fork() failing (Resource temporarily unavailable). Most times, it happens while trying to install a pip package.

That's what this is trying to resolve.



---

archive/issue_comments_341640.json:
```json
{
    "body": "Replying to [comment:5 charpent]:\n> I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n\nI think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...",
    "created_at": "2018-03-12T13:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341640",
    "user": "https://github.com/embray"
}
```

Replying to [comment:5 charpent]:
> I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.

I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...



---

archive/issue_comments_341641.json:
```json
{
    "body": "I think I might see the problem.  It's the same reason I added an explicit `echo \"Waiting for rebase lock\"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.",
    "created_at": "2018-03-12T13:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341641",
    "user": "https://github.com/embray"
}
```

I think I might see the problem.  It's the same reason I added an explicit `echo "Waiting for rebase lock"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.



---

archive/issue_comments_341642.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> Replying to [comment:5 charpent]:\n> > I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n> \n> I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...\n\nRegarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.",
    "created_at": "2018-03-12T13:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341642",
    "user": "https://github.com/embray"
}
```

Replying to [comment:7 embray]:
> Replying to [comment:5 charpent]:
> > I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.
> 
> I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...

Regarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.



---

archive/issue_comments_341643.json:
```json
{
    "body": "Attachment [dochtml.log.gz](tarball://root/attachments/some-uuid/ticket24647/dochtml.log.gz) by @EmmanuelCharpentier created at 2018-03-12 16:07:04\n\nLog of two attempts to make the documentation with MAKE==\"make -j4\"",
    "created_at": "2018-03-12T16:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341643",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Attachment [dochtml.log.gz](tarball://root/attachments/some-uuid/ticket24647/dochtml.log.gz) by @EmmanuelCharpentier created at 2018-03-12 16:07:04

Log of two attempts to make the documentation with MAKE=="make -j4"



---

archive/issue_comments_341644.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> Replying to [comment:7 embray]:\n> > Replying to [comment:5 charpent]:\n> > > I think that this is related : the system hangs with a message telling \"Waiting for rebase lock\". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\\local\\bin\\sage-rebaseall.bat.\n> > \n> > I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...\n> \n> Regarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.\n\nThat would be a problem of delay.\n\nSo this might be related : I can't finish make (with MAKE=\"make -j4\") on this machine ; it fails reporting a timeout in a forked process. See the uploaded log.\n\nI'll unset MAKE and try to finish this one.",
    "created_at": "2018-03-12T16:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341644",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:9 embray]:
> Replying to [comment:7 embray]:
> > Replying to [comment:5 charpent]:
> > > I think that this is related : the system hangs with a message telling "Waiting for rebase lock". I gave up after reasonable time (about ten minutes with *no* activity indication after this message) : C-c C-C, then closing all Cygwin processes and goig to cmd.exe to execute %SAGE_ROOT%\local\bin\sage-rebaseall.bat.
> > 
> > I think in this case it's not that there's nothing happening, but rather the output from the other build process gets blocked until it's complete (so e.g. if some builds are waiting on mpir to build which can take a long time, you'll get blocked output and then a big output dump when the mpir build is done).  I'm not exactly sure what that is but it should maybe be fixed...
> 
> Regarding the above comment, I don't think MPIR specifically was the issue, but just `s/mpir/whatever-other-slow-building-package/` in the above.

That would be a problem of delay.

So this might be related : I can't finish make (with MAKE="make -j4") on this machine ; it fails reporting a timeout in a forked process. See the uploaded log.

I'll unset MAKE and try to finish this one.



---

archive/issue_comments_341645.json:
```json
{
    "body": "I can't seem to reproduce the problem of the output hanging, but I feel like I have seen it before, but I don't remember in exactly what context.",
    "created_at": "2018-03-12T16:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341645",
    "user": "https://github.com/embray"
}
```

I can't seem to reproduce the problem of the output hanging, but I feel like I have seen it before, but I don't remember in exactly what context.



---

archive/issue_comments_341646.json:
```json
{
    "body": "Replying to [comment:10 charpent]:\n\n[ Snip... ]\n\n> I'll unset MAKE and try to finish this one.\n\nA serial make finished successfully un abouy 15 minutes (the last unsuccesful attempt to parallel make (which was only for docs) took 23 minutes).\n\nFWIW, my various attempts to parallel make took about 22h30min of registered computing time, not that far of the 27h12min and some change needed by my previous serial building of 8.2.beta5(IIRC).\n\nThe elapsed time was much longer, sice I didn't attend to all the build and discovered errors after coming back to my office after ( night | lunch | another night ).\n\nAt least on my present machine, parallel building seems currently a losing proposition.\n\nI also noticed a strong tendency to trashing (a coexistent Chrome window completely stopped responding several times...) : 8 GB RAM might be insufficient for safely building sage on 4 threads...",
    "created_at": "2018-03-12T16:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341646",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:10 charpent]:

[ Snip... ]

> I'll unset MAKE and try to finish this one.

A serial make finished successfully un abouy 15 minutes (the last unsuccesful attempt to parallel make (which was only for docs) took 23 minutes).

FWIW, my various attempts to parallel make took about 22h30min of registered computing time, not that far of the 27h12min and some change needed by my previous serial building of 8.2.beta5(IIRC).

The elapsed time was much longer, sice I didn't attend to all the build and discovered errors after coming back to my office after ( night | lunch | another night ).

At least on my present machine, parallel building seems currently a losing proposition.

I also noticed a strong tendency to trashing (a coexistent Chrome window completely stopped responding several times...) : 8 GB RAM might be insufficient for safely building sage on 4 threads...



---

archive/issue_comments_341647.json:
```json
{
    "body": "I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda",
    "created_at": "2018-03-12T18:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341647",
    "user": "https://github.com/embray"
}
```

I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda



---

archive/issue_comments_341648.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> I think I might see the problem.  It's the same reason I added an explicit `echo \"Waiting for rebase lock\"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.\n\nIn retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...",
    "created_at": "2018-03-12T18:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341648",
    "user": "https://github.com/embray"
}
```

Replying to [comment:8 embray]:
> I think I might see the problem.  It's the same reason I added an explicit `echo "Waiting for rebase lock"` in `sage-spkg` even though `sage-flock` also (normally) displays a message.  However, the message displayed by `sage-flock` doesn't output a newline until the lock is actually obtained.  This causes the line-buffered output to hang.  I'm going to test that though, and if so I think it would suffice to add a `--quiet` flag to `sage-flock` so that it doesn't output anything for cases like this.

In retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...



---

archive/issue_comments_341649.json:
```json
{
    "body": "I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.",
    "created_at": "2018-03-12T18:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341649",
    "user": "https://github.com/embray"
}
```

I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.



---

archive/issue_comments_341650.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-12T19:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341650",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_341651.json:
```json
{
    "body": "Gonna start a fresh build from scratch with `make -j4`.",
    "created_at": "2018-03-12T19:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341651",
    "user": "https://github.com/embray"
}
```

Gonna start a fresh build from scratch with `make -j4`.



---

archive/issue_comments_341652.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda\n\nFrom this list, I can only suspect Google Chrome, if that is akin to the \"Google Desktop\" listed.\n\nBut since is a machine configured by our (somewhat parano\u00efd) administrators, I might well have, for example, an antivirus running in the background and invisible to me.\n\nCare for a full install log (I'd have to send it directly to you, since it woould be about 2.1 MB gzipped...) ?\n----\nNew commits:",
    "created_at": "2018-03-12T19:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341652",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:13 embray]:
> I don't know what the deal is with your machine then.  I don't have a recent result for a full build from scratch on mine but it should't take that long.  You probably have some kind of BLODA: https://cygwin.com/faq/faq.html#faq.using.bloda

From this list, I can only suspect Google Chrome, if that is akin to the "Google Desktop" listed.

But since is a machine configured by our (somewhat paranoÃ¯d) administrators, I might well have, for example, an antivirus running in the background and invisible to me.

Care for a full install log (I'd have to send it directly to you, since it woould be about 2.1 MB gzipped...) ?
----
New commits:



---

archive/issue_comments_341653.json:
```json
{
    "body": "Replying to [comment:15 embray]:\n> I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.\n\nCurrent state :\n\n```\n$ ls -lR sage/local/var/lock/\nsage/local/var/lock/:\ntotal 0\n-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock\n-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock\n```\n",
    "created_at": "2018-03-12T19:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341653",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:15 embray]:
> I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.

Current state :

```
$ ls -lR sage/local/var/lock/
sage/local/var/lock/:
total 0
-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock
-rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock
```




---

archive/issue_comments_341654.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-03-12T19:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341654",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_341655.json:
```json
{
    "body": "Sorry, I didn't see the last part at first...\n\nReplying to [comment:14 embray]:\n\n[ Snip... ]\n\n> In retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...\n\nI agree with you : I'm starting to suppose that my \"work\" machine's configuration (out of my control) is even //worse// than Windows...\n\nI'll try to setup a fresh Windows VM on a sane (i. e. Linux) machine and reproduce the issues. If so, I'll re-open.",
    "created_at": "2018-03-12T19:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341655",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Sorry, I didn't see the last part at first...

Replying to [comment:14 embray]:

[ Snip... ]

> In retrospect, this shouldn't be necessary either since the `sage-flock` call's stderr is piped to `/dev/null`.  I'm going to try again to reproduce the issue but if I can't I'd ask you set postive_review anyways because it definitely fixes all rebase issues during build for my personal machine, as well as the patchbot...

I agree with you : I'm starting to suppose that my "work" machine's configuration (out of my control) is even //worse// than Windows...

I'll try to setup a fresh Windows VM on a sane (i. e. Linux) machine and reproduce the issues. If so, I'll re-open.



---

archive/issue_comments_341656.json:
```json
{
    "body": "Replying to [comment:19 charpent]:\n> Replying to [comment:15 embray]:\n> > I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.\n> \n> Current state :\n> {{{\n> $ ls -lR sage/local/var/lock/\n> sage/local/var/lock/:\n> total 0\n> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock\n> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock\n> }}}\n\nIt would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch.  If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).",
    "created_at": "2018-03-12T20:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341656",
    "user": "https://github.com/embray"
}
```

Replying to [comment:19 charpent]:
> Replying to [comment:15 embray]:
> > I did find a different bug--if your don't already have `$SAGE_LOCAL/var/lock` this failed to create it; that might have been a problem in your case.
> 
> Current state :
> {{{
> $ ls -lR sage/local/var/lock/
> sage/local/var/lock/:
> total 0
> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 pip2.lock
> -rw-r--r-- 1 121235 Domain Users 0 12 mars  19:03 rebase.lock
> }}}

It would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch.  If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).



---

archive/issue_comments_341657.json:
```json
{
    "body": "Replying to [comment:21 embray]:\n\n[ Snip... ]\n\n> It would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch. \n\nI'll try to do this eventually, but I won't be able to do this in the next two weeks at a minimum, at least on my problematic machine.\n\n> If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).\n\nThat's what I did anyway...",
    "created_at": "2018-03-13T09:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341657",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:21 embray]:

[ Snip... ]

> It would get created, eventually, at least after the first pip install.  But with the fix I just pushed you might consider trying another `make distclean` and make from scratch. 

I'll try to do this eventually, but I won't be able to do this in the next two weeks at a minimum, at least on my problematic machine.

> If you want to save time, make sure to use the `--with-blas=atlas` and `SAGE_ATLAS_LIB=/usr/lib` (as long as you have cygwin's lapack package installed).

That's what I did anyway...



---

archive/issue_comments_341658.json:
```json
{
    "body": "Replying to [comment:17 embray]:\n> Gonna start a fresh build from scratch with `make -j4`.\n\nHow did this went ?",
    "created_at": "2018-03-13T09:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341658",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:17 embray]:
> Gonna start a fresh build from scratch with `make -j4`.

How did this went ?



---

archive/issue_comments_341659.json:
```json
{
    "body": "Replying to [comment:23 charpent]:\n> Replying to [comment:17 embray]:\n> > Gonna start a fresh build from scratch with `make -j4`.\n> \n> How did this went ?\n\nIn retrospect, maybe the times you got aren't so unreasonable after all:\n\n\n```\nreal    361m29.365s\nuser    313m46.310s\nsys     162m22.775s\nSage build/upgrade complete!\n```\n\n\nThat's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).\n\nI'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.\n\nI also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.",
    "created_at": "2018-03-13T10:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341659",
    "user": "https://github.com/embray"
}
```

Replying to [comment:23 charpent]:
> Replying to [comment:17 embray]:
> > Gonna start a fresh build from scratch with `make -j4`.
> 
> How did this went ?

In retrospect, maybe the times you got aren't so unreasonable after all:


```
real    361m29.365s
user    313m46.310s
sys     162m22.775s
Sage build/upgrade complete!
```


That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).

I'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.

I also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.



---

archive/issue_comments_341660.json:
```json
{
    "body": "Replying to [comment:24 embray]:\n> Replying to [comment:23 charpent]:\n> > Replying to [comment:17 embray]:\n> > > Gonna start a fresh build from scratch with `make -j4`.\n> > \n> > How did this went ?\n> \n> In retrospect, maybe the times you got aren't so unreasonable after all:\n> \n> {{{\n> real    361m29.365s\n> user    313m46.310s\n> sys     162m22.775s\n> Sage build/upgrade complete!\n> }}}\n> \n> That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).\n\nThe times I quoted were for attempts to //parallel// build... So my times are still unacceptably high.\n\nYour hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with \"CYGWIN=detect_bloda\" didn't show anything. But I'll retry this after a cold start...\n\nI'll also try a fresh build on a VM. As already told, this will have to wait a bit...\n\nBTW, something else bothers me : the discrepancy between wall time and CPU time. From the (serial) `testlong.log` I ran after completing the build :\n\n\n```\nTotal time for all tests: 63115.2 seconds\n    cpu time: 17746.2 seconds\n    cumulative wall time: 45802.2 seconds\n```\n\n\nand this is displayed below the call :\n\n```\nreal    1074m14,375s\nuser    687m47,318s\nsys     247m32,749s\n```\n\n\nNotes :\n* A bit less than 18 hours for the tests is a bit long in the tooth...\n* I get the two errors already reported (killing a process takes more than 4 seconds, unicode error in the doctest framework) plus a new one :\n\n\n```\nsage -t --long --warn-long 209.2 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 786, in sage.structure.coerce\n_actions.IntegerMulAction._repr_name_\nFailed example:\n    IntegerMulAction(ZZ, GF5)\nExpected:\n    Left Integer Multiplication by Integer Ring on Finite Field of size 5\nGot:\n    Left Integer Multiplication by Integer Ring on Finite Field of size 1\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.IntegerMulAction._repr_name_\n    [143 tests, 1 failure, 11.83 s]\n```\n\n\nCare for a formal bug report ?\n\n> I'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.\n> \n> I also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.",
    "created_at": "2018-03-13T15:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341660",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:24 embray]:
> Replying to [comment:23 charpent]:
> > Replying to [comment:17 embray]:
> > > Gonna start a fresh build from scratch with `make -j4`.
> > 
> > How did this went ?
> 
> In retrospect, maybe the times you got aren't so unreasonable after all:
> 
> {{{
> real    361m29.365s
> user    313m46.310s
> sys     162m22.775s
> Sage build/upgrade complete!
> }}}
> 
> That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).

The times I quoted were for attempts to //parallel// build... So my times are still unacceptably high.

Your hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with "CYGWIN=detect_bloda" didn't show anything. But I'll retry this after a cold start...

I'll also try a fresh build on a VM. As already told, this will have to wait a bit...

BTW, something else bothers me : the discrepancy between wall time and CPU time. From the (serial) `testlong.log` I ran after completing the build :


```
Total time for all tests: 63115.2 seconds
    cpu time: 17746.2 seconds
    cumulative wall time: 45802.2 seconds
```


and this is displayed below the call :

```
real    1074m14,375s
user    687m47,318s
sys     247m32,749s
```


Notes :
* A bit less than 18 hours for the tests is a bit long in the tooth...
* I get the two errors already reported (killing a process takes more than 4 seconds, unicode error in the doctest framework) plus a new one :


```
sage -t --long --warn-long 209.2 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 786, in sage.structure.coerce
_actions.IntegerMulAction._repr_name_
Failed example:
    IntegerMulAction(ZZ, GF5)
Expected:
    Left Integer Multiplication by Integer Ring on Finite Field of size 5
Got:
    Left Integer Multiplication by Integer Ring on Finite Field of size 1
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.IntegerMulAction._repr_name_
    [143 tests, 1 failure, 11.83 s]
```


Care for a formal bug report ?

> I'll also say however that the build completed without any errors or requiring any intervention on my part, so it should be pretty stable.  I think my last version of this patch may have been slightly broken because of the directory creation issue, so maybe it didn't quite work as advertised before.
> 
> I also didn't notice any long hangs with no output, but it's not as if I had my eyes glued to the screen the entire time either.



---

archive/issue_comments_341661.json:
```json
{
    "body": "Replying to [comment:25 charpent]:\n> Replying to [comment:24 embray]:\n> > Replying to [comment:23 charpent]:\n> > > Replying to [comment:17 embray]:\n> > > > Gonna start a fresh build from scratch with `make -j4`.\n> > > \n> > > How did this went ?\n> > \n> > In retrospect, maybe the times you got aren't so unreasonable after all:\n> > \n> > {{{\n> > real    361m29.365s\n> > user    313m46.310s\n> > sys     162m22.775s\n> > Sage build/upgrade complete!\n> > }}}\n> > \n> > That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).\n> \n> The times I quoted were for attempts to //parallel// build... So my times are still unacceptably high.\n> \n> Your hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with \"CYGWIN=detect_bloda\" didn't show anything. But I'll retry this after a cold start...\n\nI'm pretty sure `CYGWIN=detect_bloda` is deprecated / doesn't do anything anymore.",
    "created_at": "2018-03-13T18:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341661",
    "user": "https://github.com/embray"
}
```

Replying to [comment:25 charpent]:
> Replying to [comment:24 embray]:
> > Replying to [comment:23 charpent]:
> > > Replying to [comment:17 embray]:
> > > > Gonna start a fresh build from scratch with `make -j4`.
> > > 
> > > How did this went ?
> > 
> > In retrospect, maybe the times you got aren't so unreasonable after all:
> > 
> > {{{
> > real    361m29.365s
> > user    313m46.310s
> > sys     162m22.775s
> > Sage build/upgrade complete!
> > }}}
> > 
> > That's just over 6 hours.  If it were a serial build it would be roughly 4 times that (roughly of course--just because it was using `-j4` doesn't mean it's going to be exactly 4 times faster, *especially* given how much this patch slows things down).
> 
> The times I quoted were for attempts to //parallel// build... So my times are still unacceptably high.
> 
> Your hypothesis of an interference with an (unknown) program running on my config still deserves exploration. A first attempt of running with "CYGWIN=detect_bloda" didn't show anything. But I'll retry this after a cold start...

I'm pretty sure `CYGWIN=detect_bloda` is deprecated / doesn't do anything anymore.



---

archive/issue_comments_341662.json:
```json
{
    "body": "I just ran a `make ptestlong` and I also got the coerce_actions failure, though the same module passed when run on its own.  Seems like some kind of caching issue maybe--worth investigating.",
    "created_at": "2018-03-13T21:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341662",
    "user": "https://github.com/embray"
}
```

I just ran a `make ptestlong` and I also got the coerce_actions failure, though the same module passed when run on its own.  Seems like some kind of caching issue maybe--worth investigating.



---

archive/issue_comments_341663.json:
```json
{
    "body": "I ran it again and now it's failing consistently, even though it passed once before.\n\nAnyways, that's a separate issue from this--I'll open a ticket for it.",
    "created_at": "2018-03-13T21:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341663",
    "user": "https://github.com/embray"
}
```

I ran it again and now it's failing consistently, even though it passed once before.

Anyways, that's a separate issue from this--I'll open a ticket for it.



---

archive/issue_comments_341664.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-21T06:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341664",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_341665.json:
```json
{
    "body": "Heh, oh no!  This has me confused for a moment.",
    "created_at": "2018-03-21T17:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24410#issuecomment-341665",
    "user": "https://github.com/embray"
}
```

Heh, oh no!  This has me confused for a moment.
