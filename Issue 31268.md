# Issue 31268: tox.ini: Add macports environment

Issue created by migration from https://trac.sagemath.org/ticket/31505

Original creator: mkoeppe

Original creation time: 2021-03-17 01:03:08

CC:  slelievre @kliem jhpalmieri dimpase slabbe vbraun @zlscherr

https://guide.macports.org/#installing.macports.source.multiple


---

Comment by mkoeppe created at 2021-03-17 02:30:29

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-17 02:30:29

New commits:


---

Comment by git created at 2021-03-17 21:16:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-18 19:05:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-18 19:58:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-18 22:41:39

Changing priority from major to critical.


---

Comment by slelievre created at 2021-03-21 01:53:25

No need for a `.macports-build-env` file similar to `.homebrew-build-env`?


---

Comment by mkoeppe created at 2021-03-21 04:27:42

I don't think we need this - only 1 command is needed to prepare the build


---

Comment by slelievre created at 2021-03-21 12:54:48

The `tox -e ...` commands run `./bootstrap && ./configure && make` or similar.

Could they run `./bootstrap -q && ./configure -q && make -s V=0` instead?


---

Comment by slelievre created at 2021-03-21 12:57:07

Oh in fact they already do. Sorry for the noise. I'm trying this out and will report.


---

Comment by mkoeppe created at 2021-03-21 16:24:51

Yes, `make` runs with `V=0`, but for the others I really want to see the output.


---

Comment by mkoeppe created at 2021-03-21 16:33:11

For more quiet, you can use `tox -p auto -e local-macports-standard -- config.status` (logs will appear in `.tox/local-macports-standard/log`


---

Comment by slelievre created at 2021-03-22 10:32:40

In a fresh clone, I ran:

```
$ git trac checkout 31505
$ git trac fetch 31496 && git merge FETCH_HEAD -m "Merge 31496"
$ git trac fetch 31335 && git merge FETCH_HEAD -m "Merge 31335"
$ git trac fetch 31474 && git merge FETCH_HEAD -m "Merge 31474"
```

and then got this for `local-macports-minimal`
(I'm a bit surprised it succeeds so fast):

```
$ tox -p auto -e local-macports-minimal -- config.status
✔ OK local-macports-minimal in 32 minutes, 29.252 seconds
_________________________ summary _________________________
  local-macports-minimal: commands succeeded
  congratulations :)
```

As for `local-macports-standard`, it is taking a lot longer.
I'll report when it's done.


---

Comment by mkoeppe created at 2021-03-24 01:29:52

Let's get this into 9.3 please


---

Comment by jhpalmieri created at 2021-03-26 16:19:05

I tried `tox -e local-macports-standard` on OS X Big Sur, and it seems to have gotten stuck installing `sagelib`. I can't find the `logs/pkgs` directory, but `sagelib` is not listed in `.tox/local-macports-standard/local/var/lib/sage/installed`: the most recently modified file there is for `networkx`. There is also no appropriate directory in `local/lib/python3.8/site-packages/`. It looks like it's been stuck for hours now. (I'm not sure why it decided to use the Xcode Python 3.8 vs. the MacPorts Python 3.9, by the way.)


---

Comment by jhpalmieri created at 2021-03-26 18:25:39

Oh, the package log files are in their usual place. Here is the sagelib log file (after I hit ctrl-C to end the process).


---

Attachment

Replying to [comment:24 jhpalmieri]:
> (I'm not sure why it decided to use the Xcode Python 3.8 vs. the MacPorts Python 3.9, by the way.)

MacPorts does not install a `python3` executable, only versioned executables `python3.8`, `python3.9`. 

Unclear why it gets stuck in the build -- look like yet another library threads vs. python multiprocessing problem, like the ones that we chased in the parallel docbuild ticket not so long ago.
Does it go away if you repeat the build (it will not start from scratch)


---

Comment by git created at 2021-03-26 19:05:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-26 19:05:57

Now you can do `tox -e local-macports-standard-python3.9`


---

Comment by jhpalmieri created at 2021-03-27 02:20:50

`tox -e local-macports-standard-python3.9` doesn't work for me: it ends with

```
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make all-build'):

* package:         gmpy2-2.1.0b5
  last build time: Mar 26 18:32
  log file:        /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/logs/pkgs/gmpy2-2.1.0b5.log
  build directory: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/.tox/local-macports-standard-python3.9/local/var/tmp/sage/build/gmpy2-2.1.0b5

* package:         rpy2-3.3.6
  last build time: Mar 26 18:40
  log file:        /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/logs/pkgs/rpy2-3.3.6.log
  build directory: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/.tox/local-macports-standard-python3.9/local/var/tmp/sage/build/rpy2-3.3.6

* package:         cysignals-1.10.2
  last build time: Mar 26 18:42
  log file:        /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/logs/pkgs/cysignals-1.10.2.log
  build directory: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/.tox/local-macports-standard-python3.9/local/var/tmp/sage/build/cysignals-1.10.2

* package:         pynac-0.7.27.p1
  last build time: Mar 26 18:43
  log file:        /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/logs/pkgs/pynac-0.7.27.p1.log
  build directory: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/.tox/local-macports-standard-python3.9/local/var/tmp/sage/build/pynac-0.7.27.p1

* package:         cvxopt-1.2.5
  last build time: Mar 26 18:44
  log file:        /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/logs/pkgs/cvxopt-1.2.5.log
  build directory: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/.tox/local-macports-standard-python3.9/local/var/tmp/sage/build/cvxopt-1.2.5

It is safe to delete any log files and build directories, but they
contain information that is helpful for debugging build problems.
WARNING: If you now run 'make' again, the build directory of the
same version of the package will, by default, be deleted. Set the
environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

make[1]: *** [all-build] Error 1
make: *** [build] Error 2
```

rpy2:

```
clang: error: unsupported option '-fopenmp'
```

gmpy2:

```
In file included from src/gmpy2.c:461:
./src/gmpy2.h:81:12: fatal error: 'gmp.h' file not found
```

cysignals:

```
ld: illegal thread local variable reference to regular symbol _PARI_SIGINT_block for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
error: command '/usr/bin/gcc' failed with exit code 1
Building wheel for cysignals (setup.py): finished with status 'error'
```

etc.


---

Comment by mkoeppe created at 2021-03-27 02:25:32

Thanks for testing! Is this on a system that also has homebrew in `/usr/local`?


---

Comment by git created at 2021-03-27 02:29:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-27 02:42:33

For making sure that no homebrew stuff from `/usr/local` leaks in, I have some work in #31552, #31562, #31567


---

Comment by jhpalmieri created at 2021-03-27 02:53:06

Yes, it has homebrew in `/usr/local`.


---

Comment by mkoeppe created at 2021-03-27 02:57:32

Could you post config.log please?


---

Comment by jhpalmieri created at 2021-03-27 03:09:29

Here's config.log from `.tox/local-macports-standard/log`.


---

Attachment


---

Comment by mkoeppe created at 2021-03-27 15:53:02

config.log has a lot of `/usr/local` - for gmp, ntl, boost.


---

Comment by git created at 2021-03-28 02:07:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by jhpalmieri created at 2021-03-28 05:17:47

I tried with the new branch and I'm still not succeeding. More problematically, and this has been true throughout, the process never ends — when it hits a problem, it just hangs and I have to hit ctrl-C to stop it.


---

Comment by mkoeppe created at 2021-03-28 06:49:05

Replying to [comment:41 jhpalmieri]:
> More problematically, and this has been true throughout, the process never ends — when it hits a problem, it just hangs and I have to hit ctrl-C to stop it.

Could this just be the behavior of `make -k`?  I use this throughout in runs via tox.


---

Comment by mkoeppe created at 2021-03-28 16:48:08

Replying to [comment:42 mkoeppe]:
> Could this just be the behavior of `make -k`?  I use this throughout in runs via tox.
I've opened #31574 to stop imposing this as a default


---

Comment by jhpalmieri created at 2021-03-28 17:32:34

I don't know. For example, when there is an error building sagelib, that particular process never ends: there is no conclusion in the sagelib log file until I halt it, and then it ends with `KeyboardInterrupt`. Is that a symptom of using `make -k`? I've used `make -k` before when building Sage and it has always stopped when it was supposed to.


---

Comment by mkoeppe created at 2021-03-28 17:55:52

That sounds more like another instance of the multiprocessing bugs that we encountered recently in the docbuild, just this time affecting the parallel build of extension modules...


---

Comment by mkoeppe created at 2021-03-29 03:56:13

Probably better to first try out #31567


---

Comment by git created at 2021-03-31 03:57:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-04-01 23:54:08

It seems that the macports builds don't exclude homebrew by default, so I had to use `tox -e macos-nohomebrew-local-macports-minimal` — I hope I got that right. I don't see many traces of `/usr/local` in the log files, but `openblas` failed to build, ending with

```
perl ./gensymbol osx x86_64 _ 1 0  0 0 0 0 "" "" 1 0 1 1 1 1 > osx.def
gfortran-mp-10 -O2 -m128bit-long-double -Wall -frecursive -fno-optimize-sibling-calls -m64 -fPIC -msse3 -mssse3 -L/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/.tox/macos-nohomebrew-local-macports-minimal/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/.tox/macos-nohomebrew-local-macports-minimal/local/lib  -all_load -headerpad_max_install_names -install_name "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/.tox/macos-nohomebrew-local-macports-minimal/local/var/tmp/sage/build/openblas-0.3.13/src/exports/../libopenblas.0.dylib" -dynamiclib -o ../libopenblas_atomp-r0.3.13.dylib ../libopenblas_atomp-r0.3.13.a -Wl,-exported_symbols_list,osx.def  
/bin/sh: gfortran-mp-10: command not found
```

I'll attach the log file.


---

Attachment


---

Comment by mkoeppe created at 2021-04-01 23:56:06

config.log too please


---

Attachment

for nohomebrew macports-minimal


---

Comment by jhpalmieri created at 2021-04-02 00:08:38

I don't know if there are any helpful files in `.../local/var/tmp/build/sage/openblas/src`, but I can provide those, too.


---

Comment by mkoeppe created at 2021-04-02 00:35:00

No, I won't need those. I found the problem already


---

Comment by git created at 2021-04-02 01:56:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-02 02:21:10

Replying to [comment:48 jhpalmieri]:
> It seems that the macports builds don't exclude homebrew by default,

Yes, the additional isolation work to ignore homebrew in /usr/local is only done if you use the factors `macos-nohomebrew`. 

> so I had to use `tox -e macos-nohomebrew-local-macports-minimal` — I hope I got that right

This variant should work better now. What went wrong in the previous version is that it prescribed using the MacPorts-provided gfortran compiler, but in the configuration `macports-minimal` that one is not actually installed.


---

Comment by jhpalmieri created at 2021-04-02 17:29:42

Great, `macos-nohomebrew-local-macports-minimal` now works. The `standard` version did not, although I'm trying again with the latest branch. (I've now lost the old log files, but a few packages complained about missing `png.h`.)

Should the macports recipes automatically include `nohomebrew`? Conversely, and I haven't tried seriously installing macports on a system, so I don't know if this is an issue, but should homebrew builds also try to exclude macports?


---

Comment by mkoeppe created at 2021-04-02 17:37:15

Replying to [comment:54 jhpalmieri]:
> Great, `macos-nohomebrew-local-macports-minimal` now works. 

Thanks for testing!

> Should the macports recipes automatically include `nohomebrew`? 

I thought about this yesterday but decided against it. I think it's useful for developers to be able to reproduce the build behavior on user machines that have both homebrew and macports installed.

> Conversely, and I haven't tried seriously installing macports on a system, so I don't know if this is an issue, but should homebrew builds also try to exclude macports?

I haven't tried yet with a global installation of macports. Given that macports by default does not install into `/usr/local`, there is much less potential for macports leaking into the build, although there could be packages that check the standard macports install location explicitly.


---

Comment by jhpalmieri created at 2021-04-02 23:48:01

Probably for another ticket: Sage's build system doesn't find the macports `gpatch` program. The file `build/pkgs/patch/distros/macports.txt` says the right thing, but it looks like `spkg-configure.m4` doesn't look for a `gpatch` executable, only `patch`.


---

Comment by jhpalmieri created at 2021-04-02 23:52:51

Would this fix it?

```diff
diff --git a/build/pkgs/patch/spkg-configure.m4 b/build/pkgs/patch/spkg-configure.m4
index 02adb910d9..31bb84dc9d 100644
--- a/build/pkgs/patch/spkg-configure.m4
+++ b/build/pkgs/patch/spkg-configure.m4
@@ -1,7 +1,7 @@
 SAGE_SPKG_CONFIGURE(
     [patch], [
        AC_CACHE_CHECK([for GNU patch >= 2.7.0], [ac_cv_path_PATCH], [
-        AC_PATH_PROGS_FEATURE_CHECK([PATCH], [patch], [
+        AC_PATH_PROGS_FEATURE_CHECK([PATCH], [patch gpatch], [
             patch_version=`$ac_path_PATCH --version 2>&1 \
                 | $SED -n -e 's/GNU patch *\([[0-9]]*\.[[0-9]]*\.[[0-9]]*\)/\1/p'`
             AS_IF([test -n "$patch_version"], [
```



---

Comment by mkoeppe created at 2021-04-02 23:58:01

This alone would not be a good fix. `configure` would certainly find `gpatch` after this change -- but then we would have to make sure that all of our code that uses `patch` instead uses the environment variable `PATCH` -- and also audit all SPKG whether they do the same. (In any case, it would be a different ticket.)


---

Comment by jhpalmieri created at 2021-04-03 00:03:34

I opened #31595 for the `gpatch` issue.


---

Comment by mkoeppe created at 2021-04-03 02:54:48

I have encountered a problem with `local-macports-standard-python3.9`: rpy2 build fails with clang: error: unsupported option '-fopenmp' - this is now #31596


---

Comment by jhpalmieri created at 2021-04-03 03:14:57

I see that too, with `macos-nohomebrew-local-macports-standard`.


---

Comment by mkoeppe created at 2021-04-03 03:16:16

I am testing with `EXTRA_CONFIGURE_ARGS="--disable-r"` now


---

Comment by jhpalmieri created at 2021-04-05 22:23:20

I'm running into mild problems with `macos-nohomebrew-local-macports-standard`, in particular after I run it once, hit some problems, and then run `tox -r -e ...`:

```
Error: Failed to activate icu: Image error: /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc0/.tox/macos-nohomebrew-local-macports-stan already exists and does not belong to a registered port.  Unable to activate port icu. Use 'port -f activate icu' to force the activation.
```

Is there really supposed to be a file `.tox/macos-nohomebrew-local-macports-stan` (which there is), or was the correct name truncated and then not handled properly by `tox -r ...`?


---

Comment by mkoeppe created at 2021-04-05 22:28:24

No, this looks like a bug in the MacPorts scripts, truncating some filenames.


---

Comment by jhpalmieri created at 2021-04-06 17:08:52

Replying to [comment:44 jhpalmieri]:
> I don't know. For example, when there is an error building sagelib, that particular process never ends: there is no conclusion in the sagelib log file until I halt it, and then it ends with `KeyboardInterrupt`. Is that a symptom of using `make -k`? I've used `make -k` before when building Sage and it has always stopped when it was supposed to.

I'm hitting this problem on another computer, this time running OS X Catalina. I don't know what to do except interrupt the process.


---

Comment by dimpase created at 2021-04-07 20:01:27

please rebase


---

Comment by git created at 2021-04-07 20:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-04-07 22:50:42

I see a bug of sorts - /usr/local leaks into macports build, via GMP:

```
#define ABSOLUTE_GMP_H "///usr/local/include/gmp.h"
```

and this results in fpylll not finding `gmp.h`, for some reason


---

Comment by dimpase created at 2021-04-07 22:57:01

and `gmp` in `/opt/local` is not recognised by `./configure`


---

Comment by mkoeppe created at 2021-04-07 22:57:31

Yes, this should be fixed via #31348 (as in its ticket description, not the branch just added there)


---

Comment by mkoeppe created at 2021-04-08 16:46:33

Given that the /usr/local leakage only affects users who have both MacPorts and /usr/local installed, perhaps we can get this ticket in as is?


---

Comment by jhpalmieri created at 2021-04-08 18:49:03

I wish that `macos-nohomebrew-local-macports-standard` would succeed on at least one machine for me, but I keep hitting problems with sagelib. I'll try one more time and then upload the sagelib log file, but it will probably look like the one I uploaded before.


---

Comment by mkoeppe created at 2021-04-08 18:55:08

Do you set `MAKE` to `make -j...` or `SAGE_NUM_THREADS` by any chance? If so, it would be worth testing if the problem goes away if you unset these variables.

Another thing to try could be `export EXTRA_CONFIGURE_ARGS="--enable-editable"`, which uses a simpler build system


---

Comment by jhpalmieri created at 2021-04-09 02:15:56

I unset `MAKE` and `MAKEFLAGS`, and other than taking longer, I see the same thing. I'm attaching the sagelib log file (before hitting ctrl-c). I'll try with `--enable-editable`.


---

Attachment

With `--enable-editable`, it did at least end when building the Sage library failed. The end of the log file looks like this:

```
    g++ -bundle -undefined dynamic_lookup -Wl,-headerpad,0x1000 -L/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib -Wl,-rpath,/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib -O2 -g -march=native build/temp.macosx-10.14.6-x86_64-3.8/sage/symbolic/expression.o -lpynac -lgmp -o build/lib.macosx-10.14.6-x86_64-3.8/sage/symbolic/expression.cpython-38-darwin.so -lpari
    ld: warning: dylib (/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/libpynac.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)
    ld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)
    error: command '/usr/bin/gcc' failed with exit code 1
ERROR: Command errored out with exit status 1: /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/src/setup.py'"'"'; __file__='"'"'/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/src/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' --no-user-cfg develop --no-deps Check the logs for full command output.
Exception information:
Traceback (most recent call last):
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/cli/base_command.py", line 189, in _main
    status = self.run(options, args)
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/cli/req_command.py", line 178, in wrapper
    return func(self, options, args)
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/commands/install.py", line 391, in run
    installed = install_given_reqs(
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/req/__init__.py", line 80, in install_given_reqs
    requirement.install(
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/req/req_install.py", line 764, in install
    install_editable_legacy(
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/operations/install/editable_legacy.py", line 49, in install_editable
    call_subprocess(
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/pip/_internal/utils/subprocess.py", line 258, in call_subprocess
    raise InstallationSubprocessError(proc.returncode, command_desc)
pip._internal.exceptions.InstallationSubprocessError: Command errored out with exit status 1: /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/src/setup.py'"'"'; __file__='"'"'/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/src/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' --no-user-cfg develop --no-deps Check the logs for full command output.
Removed build tracker: '/private/var/folders/00/zrss7sdj3bzd23f2_gnspy2h0000gp/T/pip-req-tracker-jrbc7dbe'

real	5m28.311s
user	49m7.815s
sys	1m20.961s
```

This was with the command `EXTRA_CONFIGURE_ARGS="--enable-editable --disable-r" tox -r -e macos-nohomebrew-local-macports-standard`


---

Comment by mkoeppe created at 2021-04-09 16:55:38

Thanks for testing!

This `error: command '/usr/bin/gcc' failed with exit code 1` without an actual gcc error message is really puzzling. 

Also in the previous logs that you sent, there was such a message at the end but I didn't see an actual error either.

Could you try what happens now if you do 
`SKIP_SYSTEM_PKG_INSTALL=1 SKIP_BOOTSTRAP=1 SKIP_CONFIGURE=1 EXTRA_CONFIGURE_ARGS="--enable-editable --disable-r" tox -e macos-nohomebrew-local-macports-standard` (note, no `-r` for tox, so this should be fast)


---

Attachment


---

Comment by jhpalmieri created at 2021-04-09 17:39:15

It fails again. I've attached the new part of the sagelib log.


---

Comment by mkoeppe created at 2021-04-09 17:53:49

Now error messages are there!

```
    building 'sage.libs.readline' extension
    gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -O2 -g -march=native -Isage/cpython -I/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/src -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -I/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/python3.8/site-packages/numpy/core/include -I/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c sage/libs/readline.c -o build/temp.macosx-10.14.6-x86_64-3.8/sage/libs/readline.o
    sage/libs/readline.c:1451:36: error: use of undeclared identifier 'rl_catch_signals'
      __pyx_t_1 = __Pyx_PyInt_From_int(rl_catch_signals); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 88, __pyx_L1_error)
```


```
    gcc -bundle -undefined dynamic_lookup -Wl,-headerpad,0x1000 -L/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib -Wl,-rpath,/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib -O2 -g -march=native build/temp.macosx-10.14.6-x86_64-3.8/sage/rings/complex_double.o -L/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/macports/lib -lm -lgmp -lpari -lgsl -lm -lopenblas -o build/lib.macosx-10.14.6-x86_64-3.8/sage/rings/complex_double.cpython-38-darwin.so -lpari
    ld: warning: dylib (/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/macports/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)
    ld: warning: dylib (/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/macports/lib/libgsl.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)
    ld: warning: dylib (/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/macports/lib/libopenblas.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)
    ld: illegal data reference in _avma to thread local variable _avma in dylib /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/.tox/macos-nohomebrew-local-macports-standard/local/lib/libpari.dylib for architecture x86_64
    clang: error: linker command failed with exit code 1 (use -v to see invocation)
    error: command '/usr/bin/gcc' failed with exit code 1
```



---

Comment by mkoeppe created at 2021-04-09 18:24:00

The `readline` issue is probably just #29000 again. 

(Or we may want to create a `.macports-build-env` script, after all. https://guide.macports.org/#installing.shell only mentions setting `PATH` - but we may need to also set `CPATH` and `LIBRARY_PATH` if we want libraries to be found that do not come with .pc files.)


---

Comment by jhpalmieri created at 2021-04-10 18:20:39

At this point I'm certainly happy removing the ban, but since I can't get the macports-standard tox build to work, I can't positively review the rest.


---

Comment by mkoeppe created at 2021-04-10 18:36:04

OK, I have split this part out to #31641


---

Comment by mkoeppe created at 2021-04-10 18:39:50

Changing priority from critical to major.


---

Comment by mkoeppe created at 2021-04-10 19:01:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-27 22:17:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-09 22:38:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-07-21 07:41:06

How can we move forward here? Does this still need work?
Or is it ready for review?


---

Comment by mkoeppe created at 2021-07-21 11:07:01

I'd think after #31786 is merged, we can update `build/pkgs/gfortran/distros/macports.txt` and perhaps create a .macports-build-env as suggested in comment:13, comment:79.


---

Comment by slelievre created at 2021-11-21 21:24:45

Ticket #31786 was merged in Sage 9.4.beta6.


---

Comment by git created at 2022-04-15 17:44:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-04-15 19:24:24

I must be doing something wrong:

```
% tox -e local-macports-standard
_____________________________________________________ summary _____________________________________________________
ERROR:   local-macports-standard: unresolvable substitution(s):
    commands: 'EXTRA_SAGE_PACKAGES'
Environment variables are missing or defined recursively.
```



---

Comment by git created at 2022-04-15 20:46:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-15 20:47:21

Thanks for testing! I hadn't tested it yet after rebasing


---

Comment by jhpalmieri created at 2022-04-15 21:38:29

Thanks, now it's building. I don't know why it (Macports) is building Python 2.7, but I happened to look just now, and that's what it's doing.


---

Comment by jhpalmieri created at 2022-04-15 22:56:34

I don't know if this part of the description is still accurate:

```
tox -e local-macports-standard             # uses /usr/bin/python unless configured otherwise
```

There is no `/usr/bin/python` on my OS X machine, just `/usr/bin/python3`.


---

Comment by mkoeppe created at 2022-04-16 04:56:40

`tox -e local-macports-standard` just failed for me (on macOS Big Sur 11.6) with

```
--->  Applying patches to gcc10
--->  Configuring gcc10
Warning: Applying '--without-build-config' workaround to Xcode none / CLT 13.2.0.0.1.1638488800
Warning: If versions > 12.5 please check if it is still required
--->  Building gcc10                                     
Error: Failed to build gcc10: command execution failed   
Error: See /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-standard/macports/var/macports/logs/_Users_mkoeppe_s_sage_sage-rebasing_worktree-rebase_.tox_local-macports-standard_macports_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_lang_gcc10/gcc10/main.log for details.
Error: Follow https://guide.macports.org/#project.tickets if you believe there is a bug.
Error: Processing of port gcc10 failed
```



---

Comment by jhpalmieri created at 2022-04-16 15:56:30

Replying to [comment:101 mkoeppe]:
> `tox -e local-macports-standard` just failed for me (on macOS Big Sur 11.6) with
> {{{
> --->  Applying patches to gcc10
> --->  Configuring gcc10
> Warning: Applying '--without-build-config' workaround to Xcode none / CLT 13.2.0.0.1.1638488800
> Warning: If versions > 12.5 please check if it is still required
> --->  Building gcc10                                     
> Error: Failed to build gcc10: command execution failed   
> Error: See /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-standard/macports/var/macports/logs/_Users_mkoeppe_s_sage_sage-rebasing_worktree-rebase_.tox_local-macports-standard_macports_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_lang_gcc10/gcc10/main.log for details.
> Error: Follow https://guide.macports.org/#project.tickets if you believe there is a bug.
> Error: Processing of port gcc10 failed
> }}}
I see the same.


---

Comment by git created at 2022-04-16 17:28:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-16 22:57:59

With the change to gcc11, I am getting a bit farther.

```
--->  Building R
Error: Failed to build R: command execution failed       
Error: See /opt/local/var/macports/logs/_opt_local_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_math_R/R/main.log for details.
Error: Follow https://guide.macports.org/#project.tickets if you believe there is a bug.
Error: Processing of port R failed
```

apparently because of a failure in some pdf docbuild

```
:info:build Error: compiling TeX file 'reshape.tex' failed with message:
:info:build Running 'texi2dvi' on 'reshape.tex' failed.
:info:build LaTeX errors:
:info:build ! LaTeX Error: File `fancyvrb.sty' not found.
:info:build Type X to quit or <RETURN> to proceed,
:info:build or enter new name. (Default extension: sty)
:info:build ! Emergency stop.
:info:build <read *> 
:info:build          
:info:build l.19 \begingroup
:info:build                 ^^M
:info:build !  ==> Fatal error occurred, no output PDF file produced!
:info:build Execution halted
:info:build make[1]: *** [vignettes] Error 1
:info:build make[1]: Leaving directory `/opt/local/var/macports/build/_opt_local_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_math_R/R/work/R-4.1.3/src/library'
:info:build make: *** [vignettes] Error 2
```



---

Comment by jhpalmieri created at 2022-04-17 01:59:32

I see

```
Warning: texlive-bin installs files outside the common directory structure.
--->  Installing texlive-bin @2022.62882_0+x11
--->  Activating texlive-bin @2022.62882_0+x11
Error: Failed to activate texlive-bin: can't create directory "/Library/TeX/Distributions/.FactoryDefaults/MacPorts-Users_palmieri_Desktop_Sage_sage_builds_TESTING_sage-9.6.rc0_.tox_local-macports-standard_macports-TeXLive": permission denied
Error: See /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.6.rc0/.tox/local-macports-standard/macports/var/macports/logs/_Users_palmieri_Desktop_Sage_sage_builds_TESTING_sage-9.6.rc0_.tox_local-macports-standard_macports_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_tex_texlive-bin/texlive-bin/main.log for details.
Error: Follow https://guide.macports.org/#project.tickets if you believe there is a bug.
Error: Processing of port R failed
```

I don't like the idea of this trying to install anything in `/Library`, and that looks like a problem.


---

Comment by mkoeppe created at 2022-04-17 02:47:53

Yes, it looks like not all packages are prepared for installation in a custom prefix.

I've tried installing in the default prefix (`/opt/local`) with sudo (that's `tox -e local-macports-optlocal-standard`), and installation of texlive went through without error. Just did `sudo /opt/local/bin/port install texlive-latex-extra` to get some of the missing files.


---

Comment by git created at 2022-04-17 06:08:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-17 06:13:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-17 06:38:02

This gets me to the Sage distribution build. Next error: `rpy2` fails

```
  gcc -bundle -undefined dynamic_lookup -Wl,-headerpad,0x1000 -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -g -O2 build/temp.macosx-10.14-x86_64-3.8/build/temp.macosx-10.14-x86_64-3.8/_rinterface_cffi_api.o -L/opt/local/lib -L/opt/local/lib -lpcre2-8 -llzma -lbz2 -lz -ldl -lm -liconv -licuuc -licui18n -o build/lib.macosx-10.14-x86_64-3.8/_rinterface_cffi_api.abi3.so -fopenmp -Wl,-headerpad_max_install_names -Wl,-syslibroot,/Library/Developer/CommandLineTools/SDKs/MacOSX11.sdk -arch x86_64 -F/opt/local/Library/Frameworks/R.framework/.. -framework R
  clang: error: unsupported option '-fopenmp'
```



---

Comment by mkoeppe created at 2022-04-17 07:24:23

Also `sagelib` fails

```
4 warnings generated.
ld: illegal data reference in _avma to thread local variable _avma in dylib /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib/libpari.dylib for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
error: Command "gcc -bundle -undefined dynamic_lookup -Wl,-headerpad,0x1000 -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -g -O2 build/temp.macosx-10.14-x86_64-3.8/build/cythonized/sage/libs/pari/convert_sage_complex_double.o -L/opt/local/lib -lgsl -lpari -lgmp -lm -lopenblas -o build/lib.macosx-10.14-x86_64-3.8/sage/libs/pari/convert_sage_complex_double.cpython-38-darwin.so -lpari" failed with exit status 1
```



---

Comment by jhpalmieri created at 2022-04-18 17:53:41

With `tox -e local-macports-minimal`, `gfortran` fails. This unfortunately happens on this machine with ordinary Sage if I use `./configure --with-system-gfortran=no` with the error message

```
Error: configuring for an unreleased macOS version x86_64-apple-darwin21.4.0
```

I don't know why this is called "unreleased".


---

Comment by mkoeppe created at 2022-04-18 18:04:01

I guess our gcc/gfortran package is just too old. 

Unfortunately we don't see this on our GH Actions because there are no macOS 12 runners yet. Apparently one can request access - https://github.community/t/macos-12-runner-not-available/242185/9


---

Comment by mkoeppe created at 2022-04-18 18:16:40

I've requested access to the macOS 12 runners for the `sagemath` GH organization.


---

Comment by mkoeppe created at 2022-04-20 03:52:07

Replying to [comment:111 mkoeppe]:
> This gets me to the Sage distribution build. Next error: `rpy2` fails
> {{{
>   gcc -bundle -undefined dynamic_lookup -Wl,-headerpad,0x1000 -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-macports-optlocal-standard/local/lib -g -O2 build/temp.macosx-10.14-x86_64-3.8/build/temp.macosx-10.14-x86_64-3.8/_rinterface_cffi_api.o -L/opt/local/lib -L/opt/local/lib -lpcre2-8 -llzma -lbz2 -lz -ldl -lm -liconv -licuuc -licui18n -o build/lib.macosx-10.14-x86_64-3.8/_rinterface_cffi_api.abi3.so -fopenmp -Wl,-headerpad_max_install_names -Wl,-syslibroot,/Library/Developer/CommandLineTools/SDKs/MacOSX11.sdk -arch x86_64 -F/opt/local/Library/Frameworks/R.framework/.. -framework R
>   clang: error: unsupported option '-fopenmp'
> }}}

This compiler flag comes from the configuration of the macports-provided R.

```
(sage-buildsh) mkoeppe@egret:src$ /opt/local/bin/R CMD config --cppflags
-I/opt/local/Library/Frameworks/R.framework/Resources/include
(sage-buildsh) mkoeppe@egret:src$ /opt/local/bin/R CMD config --ldflags
-fopenmp -L/opt/local/lib -Wl,-headerpad_max_install_names -Wl,-syslibroot,/Library/Developer/CommandLineTools/SDKs/MacOSX11.sdk -arch x86_64 -F/opt/local/Library/Frameworks/R.framework/.. -framework R -L/opt/local/lib -lpcre2-8 -llzma -lbz2 -lz -ldl -lm -liconv -licuuc -licui18n
(sage-buildsh) mkoeppe@egret:src$ /opt/local/bin/R CMD config CC
/opt/local/bin/clang-mp-13
```



---

Comment by mkoeppe created at 2022-04-24 05:23:18

Replying to [comment:113 jhpalmieri]:
> `gfortran` fails. This unfortunately happens on this machine with ordinary Sage if I use `./configure --with-system-gfortran=no` with the error message
> {{{
> Error: configuring for an unreleased macOS version x86_64-apple-darwin21.4.0
> }}}

I've opened #33750 for the upgrade of gcc/gfortran


---

Comment by jhpalmieri created at 2022-05-01 02:51:02

With 9.6.rc3 + this ticket, `tox -e local-macports-minimal` more or less worked for me: the first time through it hung, but then I hit ctrl-c and ran it again, and it finished. `tox -e local-macports-standard` did not work.


---

Comment by jhpalmieri created at 2022-05-01 03:46:02

Running `tox -e local-macports-standard` ends with:

```
--->  Computing dependencies for gd2
--->  Dependencies to be installed: fontconfig freetype brotli cmake curl libheif aom git gdk-pixbuf2 gobject-introspection cairo libjpeg-turbo tiff lerc rav1e cargo cargo-bootstrap rust libgit2 cargo-c x265 webp
Error: The following dependencies were not installed because all of them have unmet dependencies (likely due to a dependency cycle): fontconfig freetype brotli cmake curl libheif aom git gdk-pixbuf2 gobject-introspection cairo libjpeg-turbo tiff lerc rav1e cargo cargo-bootstrap rust libgit2 cargo-c x265 webp
Error: Follow https://guide.macports.org/#project.tickets if you believe there is a bug.
Error: Processing of port gd2 failed
ERROR: InvocationError for command /bin/bash -c 'case "" in 1|y*|Y*);; *)  port selfupdate &&  port upgrade outdated && PACKAGES=$(build/bin/sage-get-system-packages macports $(PATH=build/bin:$PATH build/bin/sage-package list --has-file=spkg-configure.m4 :standard:) _bootstrap    ); eval $(build/bin/sage-print-system-package-command macports  --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ;; esac' (exited with code 1)
________________________________________ summary _________________________________________
ERROR:   local-macports-standard: commands failed
```



---

Comment by mkoeppe created at 2022-05-01 05:45:25

I removed `/opt/local` after the upgrade to macOS Monterey, and `tox -e local-macports-optlocal-minimal` did a fresh installation of macports. The build succeeded.


---

Comment by git created at 2022-05-01 05:59:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-05-01 05:59:26

(That's after rebasing on 9.6rc3)


---

Comment by mkoeppe created at 2022-05-01 07:42:25

Replying to [comment:119 jhpalmieri]:
> Running `tox -e local-macports-standard` ends with:
> {{{
> --->  Computing dependencies for gd2
> --->  Dependencies to be installed: fontconfig freetype brotli cmake curl libheif aom git gdk-pixbuf2 gobject-introspection cairo libjpeg-turbo tiff lerc rav1e cargo cargo-bootstrap rust libgit2 cargo-c x265 webp

I'm getting the same error with `tox -e local-macports-optlocal-standard`.


---

Comment by git created at 2022-05-01 07:44:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-01 07:50:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-01 16:18:13

Now it ends with `Error: The following dependencies were not installed because all of them have unmet dependencies (likely due to a dependency cycle): curl brotli cmake`


---

Comment by git created at 2022-05-01 16:39:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-01 17:18:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-05-01 17:46:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-05-01 19:35:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-01 19:36:44

Now all packages that run into the issue with `cmake` appear to be disabled. Macports package installation finished without error now.


---

Comment by mkoeppe created at 2022-05-01 20:24:38

There are a few installation notes

```
  gpatch has the following notes:
    The patch tool provided by this port is prefixed with the character 'g' by default making it available as 'gpatch'.
    
    If you want to use 'patch' and other GNU coreutils by default, add this directory to the front of your PATH environment variable:
        /opt/local/libexec/gnubin/

  py310-tox has the following notes:
    To make the Python 3.10 version of tox the one that is run when you execute the commands without a version suffix, e.g. 'tox', run:
    
    port select --set tox tox310
  py310-virtualenv has the following notes:
    The executable is installed as '/opt/local/bin/virtualenv-3.10'. To symlink it to '/opt/local/bin/virtualenv', run:
    
        sudo port select --set virtualenv virtualenv310
  python310 has the following notes:
    To make this the default Python or Python 3 (i.e., the version run by the 'python' or 'python3' commands), run one or both of:
    
        sudo port select --set python python310
        sudo port select --set python3 python310
```


In particular, `tox -e local-macports-optlocal-standard` uses `/usr/bin/python3` as the python.


---

Comment by mkoeppe created at 2022-05-01 22:17:08

`tox -e local-macports-optlocal-standard` succeeds.


---

Comment by mkoeppe created at 2022-05-01 22:32:15

`tox -e local-macports-optlocal-python3.10-standard` warns:

```
checking ... whether /opt/local/bin/python3.10 is good... 
configure: WARNING: this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132
```



---

Comment by mkoeppe created at 2022-05-01 22:32:54

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-01 22:52:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-01 22:55:26

Replying to [comment:134 mkoeppe]:
> `tox -e local-macports-optlocal-python3.10-standard` warns:
> {{{
> checking ... whether /opt/local/bin/python3.10 is good... 
> configure: WARNING: this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see #31132
> }}}
... and gmpy2 fails to build


---

Comment by mkoeppe created at 2022-05-02 01:03:46

Replying to [comment:137 mkoeppe]:
> Replying to [comment:134 mkoeppe]:
> > `tox -e local-macports-optlocal-python3.10-standard` warns:
> > {{{
> > checking ... whether /opt/local/bin/python3.10 is good... 
> > configure: WARNING: this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see #31132
> > }}}
> ... and `gmpy2`, `cysignals`, `cvxopt` fail to build - similar to comment:31


---

Comment by git created at 2022-05-02 01:14:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-02 01:14:33

This fixes gmpy2, cvxopt


---

Comment by git created at 2022-05-02 02:41:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-02 06:35:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-02 06:37:55

Now `tox -e local-macports-optlocal-python3.10-standard` succeeds. The trick was to block out the homebrew installation in `/usr/local`.


---

Comment by git created at 2022-08-02 17:37:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-05 05:19:24

`tox -e local-macports-optlocal-standard-python3.10 -- ptest ` builds without problems, and there is only a small number of doctest failures.

```
sage -t --random-seed=37353794756962291469199267391330052516 src/doc/en/constructions/calculus.rst  # Timed out
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/interfaces/macaulay2.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/libs/libecm.pyx  # 7 doctests failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/matrix/constructor.pyx  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/attach.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/display/formatter.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/interface_magic.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/interpreter.py  # 2 doctests failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/ipython_tests.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/rich_output/backend_ipython.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/repl/ipython_extension.py  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/structure/sage_object.pyx  # 1 doctest failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/tests/cmdline.py  # 4 doctests failed
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/typeset/ascii_art.py  # 1 doctest failed
```

Most of these failures are from the warning "UserWarning: Attempting to work in a virtualenv. If you encounter problems, please install IPython inside the virtualenv."

The only real failures are:

```
sage -t --random-seed=37353794756962291469199267391330052516 src/sage/libs/libecm.pyx
**********************************************************************
File "src/sage/libs/libecm.pyx", line 33, in sage.libs.libecm
Failed example:
    ecmfactor(2^128+1,1000,sigma=227140902)
Expected:
    (True, 5704689200685129054721, 227140902)
Got:
    (False, None)
**********************************************************************
File "src/sage/libs/libecm.pyx", line 91, in sage.libs.libecm.ecmfactor
Failed example:
    ecmfactor(N, 2e5)
Expected:
    (True, 2349023, ...)
Got:
    (True, 187072209578355573530071658587684226515959365500927, 0)
**********************************************************************
File "src/sage/libs/libecm.pyx", line 113, in sage.libs.libecm.ecmfactor
Failed example:
    ecmfactor(N, 1e3)
Expected:
    (False, None)
Got:
    (True, 170141183460469231731687303715884105727, 0)
**********************************************************************
File "src/sage/libs/libecm.pyx", line 130, in sage.libs.libecm.ecmfactor
Failed example:
    ecmfactor(N, 100, verbose=True)
Expected:
    Performing one curve with B1=100
    Found factor in step 1: 11
    (True, 11, ...)
Got:
    Performing one curve with B1=100
    Found factor in step 1: 479270685891287906588011710623477140055626627230262983486227930615309559797523855924635580611607650107391
    (True,
     479270685891287906588011710623477140055626627230262983486227930615309559797523855924635580611607650107391,
     0)
**********************************************************************
File "src/sage/libs/libecm.pyx", line 134, in sage.libs.libecm.ecmfactor
Failed example:
    ecmfactor(N/11, 100, verbose=True)
Expected:
    Performing one curve with B1=100
    Found no factor.
    (False, None)
Got:
    Performing one curve with B1=100
    Found factor in step 1: 43570062353753446053455610056679740005056966111842089407838902783209959981593077811330507328327968191581
    (True,
     43570062353753446053455610056679740005056966111842089407838902783209959981593077811330507328327968191581,
     0)
**********************************************************************
File "src/sage/libs/libecm.pyx", line 144, in sage.libs.libecm.ecmfactor
Failed example:
    alarm(0.5); ecmfactor(2^521-1, 1e7)
Expected:
    Traceback (most recent call last):
    ...
    AlarmInterrupt
Got:
    (True,
     6864797660130609714981900799081393217269435300143305409394463459185543183397656052122559640661454554977296311391480858037121987999716643812574028291115057151,
     0)
**********************************************************************
File "src/sage/libs/libecm.pyx", line 151, in sage.libs.libecm.ecmfactor
Failed example:
    ecmfactor(1, 100)
Expected:
    (True, 1, ...)
Got:
    (False, None)
**********************************************************************
2 items had failures:
   1 of   9 in sage.libs.libecm
   6 of  21 in sage.libs.libecm.ecmfactor
    [28 tests, 7 failures, 0.93 s]
```



---

Comment by mkoeppe created at 2022-08-05 05:19:34

Good enough to get this in?


---

Comment by dimpase created at 2022-08-24 14:22:23

does macports have its own ecm here in these errors? If so, we can avoid them by testing ecm more in spkg-configure.


---

Comment by mkoeppe created at 2022-08-24 15:19:21

Yes, there is an ecm.


---

Comment by mkoeppe created at 2022-08-24 16:41:56

Do you want to work on this? I don't, hence my question in comment:147


---

Comment by dimpase created at 2022-08-24 16:45:01

Replying to [comment:150 mkoeppe]:
> Do you want to work on this? I don't, hence my question in comment:147
I'll see if I can fix this quickly.
If not, it can be merged as is, I guess.


---

Comment by jhpalmieri created at 2022-08-24 17:24:38

I tried `tox -e local-macports-standard` and got

```
Error: Failed to install cmake-bootstrap: MacPorts requires root privileges for this action
Error: See /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta8/.tox/local-macports-standard/macports/var/macports/logs/_Users_palmieri_Desktop_Sage_sage_builds_TESTING_sage-9.7.beta8_.tox_local-macports-standard_macports_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_devel_cmake-bootstrap/cmake-bootstrap/main.log for details.
Error: Follow https://guide.macports.org/#project.tickets if you believe there is a bug.
Error: Processing of port gcc11 failed
```

Since I wasn't using `local-macports-optlocal-standard`, I wasn't expecting to need root privileges.


---

Comment by mkoeppe created at 2022-08-24 22:14:26

I can confirm this. It seems to be a new macports bug.


---

Comment by dimpase created at 2022-08-25 08:54:40

regarding `ecm` errors, are they only for the library interface, whereas `sage/interfaces/ecm.py` tests OK?


---

Comment by mkoeppe created at 2022-08-25 15:55:20

If I was careful in comment:146 where I summarized the failures, then yes


---

Comment by dimpase created at 2022-08-27 18:13:55

Replying to [comment:153 mkoeppe]:
> I can confirm this. It seems to be a new macports bug.
https://ports.macports.org/port/cmake-bootstrap/ says to run `sudo port install cmake-bootstrap` - no idea why.

I'm trying to test with `sudo` now.


---

Comment by dimpase created at 2022-08-28 07:04:29

How does one pass `--enable-build-as-root` to tox?


---

Comment by mkoeppe created at 2022-08-28 15:20:14

You can set the environment variable `EXTRA_CONFIGURE_ARGS`


---

Comment by dimpase created at 2022-08-29 09:04:30

`sudo  EXTRA_CONFIGURE_ARGS="--enable-build-as-root" tox -e local-macports-standard` is very slow (single-thread?), and seems to hang on installing Pari - this is after installing all the pre-reqs - which was also very slow, and included building clang from source (sic!).

Can't it use XCode's clang instead?


---

Comment by dimpase created at 2022-08-29 15:00:25

anyway, macports in .tox/ was installed,so I chown'd it to the normal user, and proceeded without sudo. This pushed the build further,but still it is single thread. Waiting for tests to finish.


---

Comment by mkoeppe created at 2022-08-29 15:06:41

Replying to [comment:159 dimpase]:
> `sudo  EXTRA_CONFIGURE_ARGS="--enable-build-as-root" tox -e local-macports-standard` is very slow (single-thread?)

You could have set `MAKE="make -j16" `


---

Comment by dimpase created at 2022-08-29 20:09:03

with the latest beta8 merged, I am getting a sagelib building error 

```
    error: Command "gcc -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -Wno-unused-result 
-Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System
/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Develop
er/Library/Frameworks/Python3.framework/Versions/3.8/Headers -Werror=implicit-function-declaration -g -O2
 -I///Users/dima/software/sage/.tox/local-macports-standard/macports/include -Isage/cpython -Isage/libs/n
tl -Isage/libs/arb -I/Users/dima/software/sage/.tox/local-macports-standard/local/lib/python3.8/site-pack
ages/cypari2 -Isage/libs/flint -I/Users/dima/software/sage/.tox/local-macports-standard/local/lib/python3
.8/site-packages/cysignals -I/Users/dima/software/sage/src -I/Users/dima/software/sage/.tox/local-macport
s-standard/local/lib/python3.8/site-packages/numpy/core/include -I/Applications/Xcode.app/Contents/Develo
per/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -I/Users/dima/software/sage/.tox/
local-macports-standard/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Pyt
hon3.framework/Versions/3.8/include/python3.8 -c sage/rings/number_field/number_field_element_quadratic.c
pp -o build/temp.macosx-10.14-x86_64-cpython-38/sage/rings/number_field/number_field_element_quadratic.o 
-std=c++11" failed with exit status 1
    error: subprocess-exited-with-error
    
    × python setup.py develop did not run successfully.
    │ exit code: 1
    ╰─> See above for output.
    
    note: This error originates from a subprocess, and is likely not a problem with pip.
    full command: /Users/dima/software/sage/.tox/local-macports-standard/local/bin/python3 -c '
    exec(compile('"'"''"'"''"'"'
    # This is <pip-setuptools-caller> -- a caller that pip uses to run setup.py
    #
    # - It imports setuptools before invoking setup.py, to enable projects that directly
    #   import from `distutils.core` to work with newer packaging standards.
    # - It provides a clear error message when setuptools is not installed.
    # - It sets `sys.argv[0]` to the underlying `setup.py`, when invoking `setup.py` so
    #   setuptools doesn'"'"'t think the script is `-c`. This avoids the following warning:
    #     manifest_maker: standard file '"'"'-c'"'"' not found".
    # - It generates a shim setup.py, for handling setup.cfg-only projects.
    import os, sys, tokenize
    
    try:
        import setuptools
    except ImportError as error:
        print(
            "ERROR: Can not execute `setup.py` since setuptools is not available in "
            "the build environment.",
            file=sys.stderr,
        )
        sys.exit(1)
    
    __file__ = %r
    sys.argv[0] = __file__
    
    if os.path.exists(__file__):
        filename = __file__
        with tokenize.open(__file__) as f:
            setup_py_code = f.read()
    else:
        filename = "<auto-generated setuptools caller>"
        setup_py_code = "from setuptools import setup; setup()"
    
    exec(compile(setup_py_code, filename, "exec"))
    '"'"''"'"''"'"' % ('"'"'/Users/dima/software/sage/src/setup.py'"'"',), "<pip-setuptools-caller>", "exec"))' --no-user-cfg develop --no-deps
    cwd: /Users/dima/software/sage/src/
error: subprocess-exited-with-error

× python setup.py develop did not run successfully.
│ exit code: 1
╰─> See above for output.

note: This error originates from a subprocess, and is likely not a problem with pip.

```



---

Comment by mkoeppe created at 2022-08-29 20:25:58

The actual g++ error message is missing in what you pasted here


---

Comment by dimpase created at 2022-08-29 21:26:49

right - I thought it's some kind of Python packaging error :-)

```
    INFO: compile options: '-I///Users/dima/software/sage/.tox/local-macports-standard/macports/include -
Isage/cpython -Isage/libs/ntl -Isage/libs/arb -I/Users/dima/software/sage/.tox/local-macports-standard/lo
cal/lib/python3.8/site-packages/cypari2 -Isage/libs/flint -I/Users/dima/software/sage/.tox/local-macports
-standard/local/lib/python3.8/site-packages/cysignals -I/Users/dima/software/sage/src -I/Users/dima/softw
are/sage/.tox/local-macports-standard/local/lib/python3.8/site-packages/numpy/core/include -I/Application
s/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -I/Use
rs/dima/software/sage/.tox/local-macports-standard/local/include -I/Applications/Xcode.app/Contents/Devel
oper/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c'
    extra options: '-std=c++11'
    INFO: gcc: sage/rings/number_field/number_field_element_quadratic.cpp
    In file included from sage/rings/number_field/number_field_element_quadratic.cpp:837:
    In file included from sage/libs/flint/flint_wrap.h:42:
    ///Users/dima/software/sage/.tox/local-macports-standard/macports/include/flint/fmpz_mod_poly.h:306:12: error: use of undeclared identifier '_fmpz_poly_deflation'; did you mean 'fmpz_mod_poly_deflation'?
        return _fmpz_poly_deflation(input->coeffs, input->length);
               ^~~~~~~~~~~~~~~~~~~~
               fmpz_mod_poly_deflation
    ///Users/dima/software/sage/.tox/local-macports-standard/macports/include/flint/fmpz_mod_poly.h:303:7: note: 'fmpz_mod_poly_deflation' declared here
    ulong fmpz_mod_poly_deflation(const fmpz_mod_poly_t input,
          ^
    ///Users/dima/software/sage/.tox/local-macports-standard/macports/include/flint/fmpz_mod_poly.h:306:33: error: cannot initialize a parameter of type 'const fmpz_mod_poly_struct *' with an lvalue of type 'fmpz *const' (aka 'long *const')
        return _fmpz_poly_deflation(input->coeffs, input->length);
...
```


macports comes with flint 2.9.0, so it seems there is some kind of  incompatibility with our 2.8.4.


---

Comment by mkoeppe created at 2022-08-29 21:37:27

The problem is that `-I///Users/dima/software/sage/.tox/local-macports-standard/macports/include` at the front of the command line. It's not supposed to be there


---

Comment by dimpase created at 2022-08-29 21:55:59

Replying to [comment:165 mkoeppe]:
> The problem is that `-I///Users/dima/software/sage/.tox/local-macports-standard/macports/include` at the front of the command line. It's not supposed to be there

that's probably what `tox` is doing to create an isolated environment, no?


---

Comment by mkoeppe created at 2022-08-29 23:12:03

No, this is the install location of macports within the tox environment. I set these variables:

```
+    local-macports:           MP_PREFIX={envdir}/macports
+    local-macports:   PATH={env:MP_PREFIX}/bin:/usr/bin:/bin:/usr/sbin:/sbin
+    local-macports:   CPATH={env:MP_PREFIX}/include
+    local-macports:   LIBRARY_PATH={env:MP_PREFIX}/lib
+    local-macports:   SETENV=eval $(build/bin/sage-print-system-package-command {env:SYSTEM} setup-build-env)
```

but not `CFLAGS`.


---

Comment by dimpase created at 2022-08-29 23:26:24

Then it's done by macports, not by tox.


---

Comment by mkoeppe created at 2022-08-29 23:48:25

Could you check what the macports-installed `python3` gives when you ask it `python3 -m sysconfig`


---

Comment by dimpase created at 2022-08-30 07:22:48

there are 2 installations of python3.10 in .tox/local-macports-standard/:

```
dima@oucl13243 sage %  .tox/local-macports-standard/macports/bin/python3.10
Python 3.10.6 (main, Aug 27 2022, 17:58:26) [Clang 13.1.6 (clang-1316.0.21.2.5)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> 
dima@oucl13243 sage %  .tox/local-macports-standard/bin/python3
Python 3.10.6 (main, Aug 11 2022, 13:49:25) [Clang 13.1.6 (clang-1316.0.21.2.5)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
```


The latter is the only `python3` (without `.10`), though.


---

Attachment

sysconfig1


---

Comment by dimpase created at 2022-08-30 07:24:55

sysconf2


---

Attachment

attached are their outputs when run with `-m sysconfig`.

(there is also python2.7.18 - hopefully we have stopped all python2's used in our build by now...)
