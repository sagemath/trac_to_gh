# Issue 24728: Slowness of polygen(ZZ).change_ring(SR)

archive/issues_024728.json:
```json
{
    "body": "This branch shows that the generic polynomial code is not aware of the symbolic zero problem. On Sage develop, the operation\n\n```\nsage: p = polygen(ZZ)^2 + 1\nsage: %timeit p.change_ring(SR)\n1000 loops, best of 3: 322 \u00b5s per loop\nsage: %timeit p.change_ring(RR)\n100000 loops, best of 3: 12.9 \u00b5s per loop\n```\n\ntakes much longer with SR because `Expression.__nonzero__` is ultimately called. For the problems with this, see https://trac.sagemath.org/wiki/symbolics/nonzero\n\nThe branch adds 5 print statements before the calls to `__nonzero__` are made. The output is:\n\n```\nsage: p = polygen(ZZ)^2 + 1\nsage: p.change_ring(SR)\n0 Symbolic Ring\n1 1 [0, 1]\n2 1 Symbolic Ring\n3 x^2 + 1 <type 'sage.symbolic.expression.Expression'>\n2 x^2 + 1 Symbolic Ring\n4 x^2 + 1 <type 'sage.symbolic.expression.Expression'>\n2 x^2 + 1 Symbolic Ring\nx^2 + 1\n```\n\nOne can see\n- SR is tested for zero once;\n- the coefficients are tested once;\n- twice `x^2 + 1` is tested for zero\n- three times `__nonzero__` calls itself at point 2.\n\nInserting `return False` at the top of `__nonzero__` reduces the time to 70us. The culprit is the testing of `x^2 + 1`.\n\nOne easy solution that does not require the interface change outlined in https://trac.sagemath.org/wiki/symbolics/nonzero would be implementing #21201.\n\nThis branch should then be replaced with an improvement in the places marked.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24965\n\n",
    "created_at": "2018-03-13T15:31:58Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Slowness of polygen(ZZ).change_ring(SR)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24728",
    "user": "https://github.com/rwst"
}
```
This branch shows that the generic polynomial code is not aware of the symbolic zero problem. On Sage develop, the operation

```
sage: p = polygen(ZZ)^2 + 1
sage: %timeit p.change_ring(SR)
1000 loops, best of 3: 322 µs per loop
sage: %timeit p.change_ring(RR)
100000 loops, best of 3: 12.9 µs per loop
```

takes much longer with SR because `Expression.__nonzero__` is ultimately called. For the problems with this, see https://trac.sagemath.org/wiki/symbolics/nonzero

The branch adds 5 print statements before the calls to `__nonzero__` are made. The output is:

```
sage: p = polygen(ZZ)^2 + 1
sage: p.change_ring(SR)
0 Symbolic Ring
1 1 [0, 1]
2 1 Symbolic Ring
3 x^2 + 1 <type 'sage.symbolic.expression.Expression'>
2 x^2 + 1 Symbolic Ring
4 x^2 + 1 <type 'sage.symbolic.expression.Expression'>
2 x^2 + 1 Symbolic Ring
x^2 + 1
```

One can see
- SR is tested for zero once;
- the coefficients are tested once;
- twice `x^2 + 1` is tested for zero
- three times `__nonzero__` calls itself at point 2.

Inserting `return False` at the top of `__nonzero__` reduces the time to 70us. The culprit is the testing of `x^2 + 1`.

One easy solution that does not require the interface change outlined in https://trac.sagemath.org/wiki/symbolics/nonzero would be implementing #21201.

This branch should then be replaced with an improvement in the places marked.

Issue created by migration from https://trac.sagemath.org/ticket/24965





---

archive/issue_comments_346708.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2018-03-13T15:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346708",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_346709.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-13T15:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346709",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_346710.json:
```json
{
    "body": "The code should **never** test whether `x^2 + 1` is zero as a symbolic expression. I don't understand the trace that you obtain.",
    "created_at": "2018-03-13T15:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346710",
    "user": "https://github.com/videlec"
}
```

The code should **never** test whether `x^2 + 1` is zero as a symbolic expression. I don't understand the trace that you obtain.



---

archive/issue_comments_346711.json:
```json
{
    "body": "I mean `3 x^2 + 1 <type 'sage.symbolic.expression.Expression'>` and `4 x^2 + 1 <type 'sage.symbolic.expression.Expression'>` should not be there.",
    "created_at": "2018-03-13T15:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346711",
    "user": "https://github.com/videlec"
}
```

I mean `3 x^2 + 1 <type 'sage.symbolic.expression.Expression'>` and `4 x^2 + 1 <type 'sage.symbolic.expression.Expression'>` should not be there.



---

archive/issue_comments_346712.json:
```json
{
    "body": "In other words\n\n```\nsage: p = SR['x'](polygen(ZZ, 'x'))\nsage: p.degree()\n0\n```\n\nshould be\n\n```\nsage: p = SR['x'](polygen(ZZ, 'x'))\nsage: p.degree()\n1\n```\n\nNobody cares whether it is slow or not. It is just **wrong**.",
    "created_at": "2018-03-13T15:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346712",
    "user": "https://github.com/videlec"
}
```

In other words

```
sage: p = SR['x'](polygen(ZZ, 'x'))
sage: p.degree()
0
```

should be

```
sage: p = SR['x'](polygen(ZZ, 'x'))
sage: p.degree()
1
```

Nobody cares whether it is slow or not. It is just **wrong**.



---

archive/issue_comments_346713.json:
```json
{
    "body": "Changing component from performance to commutative algebra.",
    "created_at": "2018-03-13T16:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346713",
    "user": "https://github.com/rwst"
}
```

Changing component from performance to commutative algebra.



---

archive/issue_comments_346714.json:
```json
{
    "body": "Changing type from task to defect.",
    "created_at": "2018-03-13T16:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346714",
    "user": "https://github.com/rwst"
}
```

Changing type from task to defect.



---

archive/issue_comments_346715.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> Nobody cares whether it is slow or not. It is just **wrong**.\n\nSo I thought earlier in #24942#comment:12, and now it turns out it's the reason for slowness. Changing the description.",
    "created_at": "2018-03-13T16:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346715",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:6 vdelecroix]:
> Nobody cares whether it is slow or not. It is just **wrong**.

So I thought earlier in #24942#comment:12, and now it turns out it's the reason for slowness. Changing the description.



---

archive/issue_comments_346716.json:
```json
{
    "body": "And note that I already explicitely said what needs to be done to fix this in #24942#comment:13",
    "created_at": "2018-03-13T16:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346716",
    "user": "https://github.com/videlec"
}
```

And note that I already explicitely said what needs to be done to fix this in #24942#comment:13



---

archive/issue_comments_346717.json:
```json
{
    "body": "Fact is that `PolynomialRing_general._element_constructor` is not called at all here.",
    "created_at": "2018-03-13T16:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346717",
    "user": "https://github.com/rwst"
}
```

Fact is that `PolynomialRing_general._element_constructor` is not called at all here.



---

archive/issue_comments_346718.json:
```json
{
    "body": "This is completely broken because of\n\n```\nsage: SR.has_coerce_map_from(ZZ['x'])\nTrue\n```\n\nAs a consequence of the above, the conversion `ZZ[x] -> SR['x']` goes through the base ring `SR` of the codomain.",
    "created_at": "2018-03-13T19:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346718",
    "user": "https://github.com/videlec"
}
```

This is completely broken because of

```
sage: SR.has_coerce_map_from(ZZ['x'])
True
```

As a consequence of the above, the conversion `ZZ[x] -> SR['x']` goes through the base ring `SR` of the codomain.



---

archive/issue_comments_346719.json:
```json
{
    "body": "The code of `SR._coerce_map_from_` is so nice\n\n```\nelif is_PolynomialRing(R) or is_MPolynomialRing(R) or \\\n     is_FractionField(R) or is_LaurentPolynomialRing(R):\n    base = R.base_ring()\n    return base is not self and self.has_coerce_map_from(base)\n```\n",
    "created_at": "2018-03-13T20:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346719",
    "user": "https://github.com/videlec"
}
```

The code of `SR._coerce_map_from_` is so nice

```
elif is_PolynomialRing(R) or is_MPolynomialRing(R) or \
     is_FractionField(R) or is_LaurentPolynomialRing(R):
    base = R.base_ring()
    return base is not self and self.has_coerce_map_from(base)
```




---

archive/issue_comments_346720.json:
```json
{
    "body": "Here you have to choose:\n- make the proposal in the ticket description happen and break two minor backward compatibilities (that I would judge as half broken anyway\n- live with `SR['x'](polygen(ZZ)` being degree zero and use `SR['x'](list(p))` when you need the proper conversion",
    "created_at": "2018-03-13T20:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346720",
    "user": "https://github.com/videlec"
}
```

Here you have to choose:
- make the proposal in the ticket description happen and break two minor backward compatibilities (that I would judge as half broken anyway
- live with `SR['x'](polygen(ZZ)` being degree zero and use `SR['x'](list(p))` when you need the proper conversion



---

archive/issue_comments_346721.json:
```json
{
    "body": "The first sounds correct. But the fix is over my head, I have no idea about how to fix this.",
    "created_at": "2018-03-13T20:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346721",
    "user": "https://github.com/rwst"
}
```

The first sounds correct. But the fix is over my head, I have no idea about how to fix this.



---

archive/issue_comments_346722.json:
```json
{
    "body": "It looks like the degree 0 result is consistent with how name ambiguities are resolved elsewhere:\n\n```\nsage: f=QQ['x']['x'](QQ['x'].0)\nsage: f.degree()\n0\n```\n\nThere is an `x` in `SR`, `SR` is supposed to be a ring, so `ZZ` coerces into it. As a result, `ZZ['x']` coerces into it as well. Furthermore, that means that `ZZ['x']` coerces as constants into `SR['x']`.",
    "created_at": "2018-03-14T01:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346722",
    "user": "https://github.com/nbruin"
}
```

It looks like the degree 0 result is consistent with how name ambiguities are resolved elsewhere:

```
sage: f=QQ['x']['x'](QQ['x'].0)
sage: f.degree()
0
```

There is an `x` in `SR`, `SR` is supposed to be a ring, so `ZZ` coerces into it. As a result, `ZZ['x']` coerces into it as well. Furthermore, that means that `ZZ['x']` coerces as constants into `SR['x']`.



---

archive/issue_comments_346723.json:
```json
{
    "body": "Then you are free to clarify the description and set to \"won't fix\".",
    "created_at": "2018-03-14T04:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346723",
    "user": "https://github.com/videlec"
}
```

Then you are free to clarify the description and set to "won't fix".



---

archive/issue_comments_346724.json:
```json
{
    "body": "Or better: to document and test this feature in the `SR` documentation!",
    "created_at": "2018-03-14T05:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24728#issuecomment-346724",
    "user": "https://github.com/videlec"
}
```

Or better: to document and test this feature in the `SR` documentation!
