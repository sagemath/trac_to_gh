# Issue 14813: Bug in pickling of toric varieties

archive/issues_014813.json:
```json
{
    "body": "CC:  @novoselt jkeitel\n\n```\nsage: variety = toric_varieties.P(1)\nsage: variety.cohomology_ring()\nRational cohomology ring of a 1-d CPR-Fano toric variety covered by 2 affine patches\nsage: pickle = dumps(variety)\nsage: loads(pickle)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-13-41fbbbe8d1ed> in <module>()\n----> 1 loads(pickle)\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.loads (sage/structure/sage_object.c:11044)()\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in unreduce(cls, args, keywords)\n    599 \n    600     \"\"\"\n--> 601     return cls(*args, **keywords)\n    602 \n    603 \n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/misc/classcall_metaclass.so in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:1224)()\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/misc/cachefunc.so in sage.misc.cachefunc.WeakCachedFunction.__call__ (sage/misc/cachefunc.c:5347)()\n\n/home/vbraun/Code/sage.git/local/lib/python/weakref.pyc in __getitem__(self, key)\n     54 \n     55     def __getitem__(self, key):\n---> 56         o = self.data[key]()\n     57         if o is None:\n     58             raise KeyError, key\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/category_object.so in sage.structure.category_object.CategoryObject.__hash__ (sage/structure/category_object.c:8312)()\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1921)()\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/toric/fano_variety.pyc in _repr_(self)\n    746         \"\"\"\n    747         return (\"%d-d CPR-Fano toric variety covered by %d affine patches\"\n--> 748                 % (self.dimension_relative(), self.fan().ngenerating_cones()))\n    749 \n    750     def anticanonical_hypersurface(self, **kwds):\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/ambient_space.pyc in dimension_relative(self)\n    393             2\n    394         \"\"\"\n--> 395         return self._dimension_relative\n\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6736)()\n\n<type 'str'>: (<type 'exceptions.AttributeError'>, AttributeError('CPRFanoToricVariety_field_with_category' object has no attribute '_dimension_relative',))\n```\nAnalysis:\n* There is a circular reference between the ToricVariety and the CohomologyRing. \n* The unpickler therefore must work with half-constructed objects and only later fill in the attributes.\n* The CohomologyRing inherits from UniqueRepresentation, so it will try to look in the unique representation cache\n* For that, we need `__hash__()` of the toric variety which is provided by CategoryObject\n* The hash depends on `__repr__()` which accesses attributes of the toric variety that are not yet filled in.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15050\n\n",
    "created_at": "2013-08-16T12:05:34Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "Bug in pickling of toric varieties",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14813",
    "user": "https://github.com/vbraun"
}
```
CC:  @novoselt jkeitel

```
sage: variety = toric_varieties.P(1)
sage: variety.cohomology_ring()
Rational cohomology ring of a 1-d CPR-Fano toric variety covered by 2 affine patches
sage: pickle = dumps(variety)
sage: loads(pickle)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-13-41fbbbe8d1ed> in <module>()
----> 1 loads(pickle)

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.loads (sage/structure/sage_object.c:11044)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in unreduce(cls, args, keywords)
    599 
    600     """
--> 601     return cls(*args, **keywords)
    602 
    603 

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/misc/classcall_metaclass.so in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:1224)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/misc/cachefunc.so in sage.misc.cachefunc.WeakCachedFunction.__call__ (sage/misc/cachefunc.c:5347)()

/home/vbraun/Code/sage.git/local/lib/python/weakref.pyc in __getitem__(self, key)
     54 
     55     def __getitem__(self, key):
---> 56         o = self.data[key]()
     57         if o is None:
     58             raise KeyError, key

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/category_object.so in sage.structure.category_object.CategoryObject.__hash__ (sage/structure/category_object.c:8312)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1921)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/toric/fano_variety.pyc in _repr_(self)
    746         """
    747         return ("%d-d CPR-Fano toric variety covered by %d affine patches"
--> 748                 % (self.dimension_relative(), self.fan().ngenerating_cones()))
    749 
    750     def anticanonical_hypersurface(self, **kwds):

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/ambient_space.pyc in dimension_relative(self)
    393             2
    394         """
--> 395         return self._dimension_relative

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6736)()

<type 'str'>: (<type 'exceptions.AttributeError'>, AttributeError('CPRFanoToricVariety_field_with_category' object has no attribute '_dimension_relative',))
```
Analysis:
* There is a circular reference between the ToricVariety and the CohomologyRing. 
* The unpickler therefore must work with half-constructed objects and only later fill in the attributes.
* The CohomologyRing inherits from UniqueRepresentation, so it will try to look in the unique representation cache
* For that, we need `__hash__()` of the toric variety which is provided by CategoryObject
* The hash depends on `__repr__()` which accesses attributes of the toric variety that are not yet filled in.

Issue created by migration from https://trac.sagemath.org/ticket/15050





---

archive/issue_comments_188726.json:
```json
{
    "body": "I think the best solution is to just not pickle caches, especially since the ToricVariety is likely to have lots of caches. If you want to store results then you are probably going to do so explicitly already.",
    "created_at": "2013-08-16T12:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188726",
    "user": "https://github.com/vbraun"
}
```

I think the best solution is to just not pickle caches, especially since the ToricVariety is likely to have lots of caches. If you want to store results then you are probably going to do so explicitly already.



---

archive/issue_comments_188727.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-16T12:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188727",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_188728.json:
```json
{
    "body": "Agreed!",
    "created_at": "2013-08-16T15:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188728",
    "user": "https://github.com/novoselt"
}
```

Agreed!



---

archive/issue_comments_188729.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-08-16T15:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188729",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_188730.json:
```json
{
    "body": "Changing keywords from \"\" to \"toric\".",
    "created_at": "2013-08-16T15:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188730",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "" to "toric".



---

archive/issue_events_043278.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-17T11:23:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14813#event-43278"
}
```



---

archive/issue_comments_188731.json:
```json
{
    "body": "Hi Volker, hi Andrey,\n\nwhile this patch fixes the issue with the CohomologyRing, there are several other internally cached objects that give rise to the same problem, namely those generated after calling\n\n```\nTodd_class, Chern_class, Chern_character, Kaehler_cone, Mori_cone\n```\nThese bugs can be fixed analogously to what you did for the methods above (tried it sucessfully on my local version), but I'm not sure how to get git to make a new patch. (Hopefully that'll change in three weeks in Oxford.)\n\nCheers,\nJan",
    "created_at": "2013-09-03T10:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188731",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

Hi Volker, hi Andrey,

while this patch fixes the issue with the CohomologyRing, there are several other internally cached objects that give rise to the same problem, namely those generated after calling

```
Todd_class, Chern_class, Chern_character, Kaehler_cone, Mori_cone
```
These bugs can be fixed analogously to what you did for the methods above (tried it sucessfully on my local version), but I'm not sure how to get git to make a new patch. (Hopefully that'll change in three weeks in Oxford.)

Cheers,
Jan



---

archive/issue_comments_188732.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-09-03T10:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188732",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_188733.json:
```json
{
    "body": "Don't reopen reviewed tickets. You should make a new follow-up ticket.",
    "created_at": "2013-09-03T11:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188733",
    "user": "https://github.com/vbraun"
}
```

Don't reopen reviewed tickets. You should make a new follow-up ticket.



---

archive/issue_comments_188734.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-09-03T11:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188734",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_043279.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14813#event-43279"
}
```



---

archive/issue_events_043280.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14813#event-43280"
}
```



---

archive/issue_events_043281.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-20T10:49:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14813#event-43281"
}
```



---

archive/issue_comments_188735.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-20T10:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14813#issuecomment-188735",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
