# Issue 14813: Bug in pickling of toric varieties

Issue created by migration from https://trac.sagemath.org/ticket/15050

Original creator: vbraun

Original creation time: 2013-08-16 12:05:34

CC:  novoselt jkeitel


```
sage: variety = toric_varieties.P(1)
sage: variety.cohomology_ring()
Rational cohomology ring of a 1-d CPR-Fano toric variety covered by 2 affine patches
sage: pickle = dumps(variety)
sage: loads(pickle)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-13-41fbbbe8d1ed> in <module>()
----> 1 loads(pickle)

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.loads (sage/structure/sage_object.c:11044)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in unreduce(cls, args, keywords)
    599 
    600     """
--> 601     return cls(*args, **keywords)
    602 
    603 

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/misc/classcall_metaclass.so in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:1224)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/misc/cachefunc.so in sage.misc.cachefunc.WeakCachedFunction.__call__ (sage/misc/cachefunc.c:5347)()

/home/vbraun/Code/sage.git/local/lib/python/weakref.pyc in __getitem__(self, key)
     54 
     55     def __getitem__(self, key):
---> 56         o = self.data[key]()
     57         if o is None:
     58             raise KeyError, key

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/category_object.so in sage.structure.category_object.CategoryObject.__hash__ (sage/structure/category_object.c:8312)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1921)()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/toric/fano_variety.pyc in _repr_(self)
    746         """
    747         return ("%d-d CPR-Fano toric variety covered by %d affine patches"
--> 748                 % (self.dimension_relative(), self.fan().ngenerating_cones()))
    749 
    750     def anticanonical_hypersurface(self, **kwds):

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/ambient_space.pyc in dimension_relative(self)
    393             2
    394         """
--> 395         return self._dimension_relative

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6736)()

<type 'str'>: (<type 'exceptions.AttributeError'>, AttributeError('CPRFanoToricVariety_field_with_category' object has no attribute '_dimension_relative',))
```

Analysis:
  * There is a circular reference between the ToricVariety and the CohomologyRing. 
  * The unpickler therefore must work with half-constructed objects and only later fill in the attributes.
  * The CohomologyRing inherits from UniqueRepresentation, so it will try to look in the unique representation cache
  * For that, we need `__hash__()` of the toric variety which is provided by CategoryObject
  * The hash depends on `__repr__()` which accesses attributes of the toric variety that are not yet filled in.


---

Comment by vbraun created at 2013-08-16 12:54:20

I think the best solution is to just not pickle caches, especially since the ToricVariety is likely to have lots of caches. If you want to store results then you are probably going to do so explicitly already.


---

Comment by vbraun created at 2013-08-16 12:55:58

Changing status from new to needs_review.


---

Comment by novoselt created at 2013-08-16 15:29:49

Agreed!


---

Comment by novoselt created at 2013-08-16 15:29:49

Changing status from needs_review to positive_review.


---

Comment by novoselt created at 2013-08-16 15:29:49

Changing keywords from "" to "toric".


---

Comment by jkeitel created at 2013-09-03 10:00:58

Hi Volker, hi Andrey,

while this patch fixes the issue with the CohomologyRing, there are several other internally cached objects that give rise to the same problem, namely those generated after calling

```
Todd_class, Chern_class, Chern_character, Kaehler_cone, Mori_cone
```

These bugs can be fixed analogously to what you did for the methods above (tried it sucessfully on my local version), but I'm not sure how to get git to make a new patch. (Hopefully that'll change in three weeks in Oxford.)

Cheers,
Jan


---

Comment by jkeitel created at 2013-09-03 10:01:44

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-09-03 11:07:41

Don't reopen reviewed tickets. You should make a new follow-up ticket.


---

Comment by vbraun created at 2013-09-03 11:07:41

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2013-12-20 10:49:10

Resolution: fixed
