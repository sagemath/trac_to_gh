# Issue 30350: Remove import of 'ppl' at startup

archive/issues_030350.json:
```json
{
    "body": "CC:  @kliem novoselt vbraun winfried jipilab mjo vdelecroix\n\nCurrently, sage imports `ppl` (from `pplpy`) at startup, via `sage.geometry.cone`, `sage.geometry.integral_points`, and `sage.geometry.lattice_polytopes`. \n\nThis should be changed, both\n- as preparation for other backends for polyhedral cones (in particular `PyNormaliz`)\n- for the modularization of sagelib (#29705).\n\nIssue created by migration from https://trac.sagemath.org/ticket/30587\n\n",
    "created_at": "2020-09-16T20:28:37Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "title": "Remove import of 'ppl' at startup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30350",
    "user": "mkoeppe"
}
```
CC:  @kliem novoselt vbraun winfried jipilab mjo vdelecroix

Currently, sage imports `ppl` (from `pplpy`) at startup, via `sage.geometry.cone`, `sage.geometry.integral_points`, and `sage.geometry.lattice_polytopes`. 

This should be changed, both
- as preparation for other backends for polyhedral cones (in particular `PyNormaliz`)
- for the modularization of sagelib (#29705).

Issue created by migration from https://trac.sagemath.org/ticket/30587





---

archive/issue_comments_432812.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T17:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432812",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_432813.json:
```json
{
    "body": "I'm looking at this at the moment.\n\nI think one needs to also take case of `Polyhedron_base`, because once it is lazily imported, then it immediately imports all depencies, in particular the stuff from `ppl`.\n\nSo if the goal is to have a working sage as good as possible without `ppl`, then this should be touched as well.\n\n(I tested adding a line `from foo import nonsense` into `backend_ppl.py`. Sage is starting all right, but polyhedra are unusable. However, only backend ppl should fail.)",
    "created_at": "2020-12-07T20:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432813",
    "user": "@kliem"
}
```

I'm looking at this at the moment.

I think one needs to also take case of `Polyhedron_base`, because once it is lazily imported, then it immediately imports all depencies, in particular the stuff from `ppl`.

So if the goal is to have a working sage as good as possible without `ppl`, then this should be touched as well.

(I tested adding a line `from foo import nonsense` into `backend_ppl.py`. Sage is starting all right, but polyhedra are unusable. However, only backend ppl should fail.)



---

archive/issue_comments_432814.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-12-07T21:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432814",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_432815.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-07T21:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432815",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_432816.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-09T21:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432816",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_432817.json:
```json
{
    "body": "If the imports would not wind up in an extremely hot path, you might also work around the circular imports with local ones (`from foo import whatever` within the function that needs `whatever`). Those don't get run until the function is called, but it does introduce a tiny redundant dictionary lookup the second, third, etc times the function is called.",
    "created_at": "2020-12-09T21:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432817",
    "user": "mjo"
}
```

If the imports would not wind up in an extremely hot path, you might also work around the circular imports with local ones (`from foo import whatever` within the function that needs `whatever`). Those don't get run until the function is called, but it does introduce a tiny redundant dictionary lookup the second, third, etc times the function is called.



---

archive/issue_comments_432818.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T09:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432818",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432819.json:
```json
{
    "body": "So lazy import appears to be a bit slower.\n\nFor `%timeit polytopes.cube()` I went from 411 \u00b5s to 417. I don't know if this is acceptable.\nSo there appears to be a overhead of about 6 \u00b5s per call.\n----\nNew commits:",
    "created_at": "2020-12-10T09:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432819",
    "user": "@kliem"
}
```

So lazy import appears to be a bit slower.

For `%timeit polytopes.cube()` I went from 411 µs to 417. I don't know if this is acceptable.
So there appears to be a overhead of about 6 µs per call.
----
New commits:



---

archive/issue_comments_432820.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T10:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432820",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432821.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-10T10:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432821",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_432822.json:
```json
{
    "body": "In the doctest for `lazy_import`, this text:\n\n```\n+ To install foo using the Sage package manager, you can try to run:\n+        !sage -i non-existing-package\n```\n\nwill only appear on sage-the-distribution but not in downstream packaged sage, so it's best to use `...` here",
    "created_at": "2020-12-10T16:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432822",
    "user": "mkoeppe"
}
```

In the doctest for `lazy_import`, this text:

```
+ To install foo using the Sage package manager, you can try to run:
+        !sage -i non-existing-package
```

will only appear on sage-the-distribution but not in downstream packaged sage, so it's best to use `...` here



---

archive/issue_comments_432823.json:
```json
{
    "body": "Ok, I wasn't exactly sure, what part would appear and what part would not.",
    "created_at": "2020-12-10T16:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432823",
    "user": "@kliem"
}
```

Ok, I wasn't exactly sure, what part would appear and what part would not.



---

archive/issue_comments_432824.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T16:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432824",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432825.json:
```json
{
    "body": "In fact, perhaps `LazyImport.__repr__` should catch this error and print itself in a friendlier way?",
    "created_at": "2020-12-10T16:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432825",
    "user": "mkoeppe"
}
```

In fact, perhaps `LazyImport.__repr__` should catch this error and print itself in a friendlier way?



---

archive/issue_comments_432826.json:
```json
{
    "body": "Also typo `An example of and import `: and->an",
    "created_at": "2020-12-10T16:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432826",
    "user": "mkoeppe"
}
```

Also typo `An example of and import `: and->an



---

archive/issue_comments_432827.json:
```json
{
    "body": "Another data point regarding performance: Without this ticket, I am getting\n\n```\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n51.7 \u00b5s \u00b1 866 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n53.9 \u00b5s \u00b1 774 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n52.8 \u00b5s \u00b1 738 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nRight after building this branch, I am getting:\n\n```\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n88.2 \u00b5s \u00b1 22.3 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n57.2 \u00b5s \u00b1 1.22 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n53.5 \u00b5s \u00b1 307 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit Polyhedron(vertices=[[]])                                                     \n53.2 \u00b5s \u00b1 508 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nSo I don't think that we should be concerned about the performance impact here.",
    "created_at": "2020-12-10T16:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432827",
    "user": "mkoeppe"
}
```

Another data point regarding performance: Without this ticket, I am getting

```
sage: %timeit Polyhedron(vertices=[[]])                                                     
51.7 µs ± 866 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
53.9 µs ± 774 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
52.8 µs ± 738 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


Right after building this branch, I am getting:

```
sage: %timeit Polyhedron(vertices=[[]])                                                     
88.2 µs ± 22.3 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
57.2 µs ± 1.22 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
53.5 µs ± 307 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
53.2 µs ± 508 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


So I don't think that we should be concerned about the performance impact here.



---

archive/issue_comments_432828.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T17:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432828",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432829.json:
```json
{
    "body": "I think the repr should express somehow that it is a `LazyImport` object so that users who see this output can know where this is coming from.",
    "created_at": "2020-12-10T18:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432829",
    "user": "mkoeppe"
}
```

I think the repr should express somehow that it is a `LazyImport` object so that users who see this output can know where this is coming from.



---

archive/issue_comments_432830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T18:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432830",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432831.json:
```json
{
    "body": "Hm... perhaps only for failed imports?",
    "created_at": "2020-12-10T18:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432831",
    "user": "mkoeppe"
}
```

Hm... perhaps only for failed imports?



---

archive/issue_comments_432832.json:
```json
{
    "body": "Well the other thing is lying as well. But sure.",
    "created_at": "2020-12-10T19:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432832",
    "user": "@kliem"
}
```

Well the other thing is lying as well. But sure.



---

archive/issue_comments_432833.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T19:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432833",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432834.json:
```json
{
    "body": "patchbot shows errors",
    "created_at": "2020-12-10T23:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432834",
    "user": "mkoeppe"
}
```

patchbot shows errors



---

archive/issue_comments_432835.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-10T23:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432835",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_432836.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-11T07:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432836",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432837.json:
```json
{
    "body": "Somehow forgot that.",
    "created_at": "2020-12-11T07:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432837",
    "user": "@kliem"
}
```

Somehow forgot that.



---

archive/issue_comments_432838.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-11T07:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432838",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_432839.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-11T20:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432839",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_432840.json:
```json
{
    "body": "Thank you. So I guess I know how that mechanism works, you can ping me, to do it with other packages.",
    "created_at": "2020-12-11T20:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432840",
    "user": "@kliem"
}
```

Thank you. So I guess I know how that mechanism works, you can ping me, to do it with other packages.



---

archive/issue_comments_432841.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-12-13T09:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432841",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_432842.json:
```json
{
    "body": "On OSX:\n\n```\n**********************************************************************\nFile \"src/sage/misc/lazy_import.pyx\", line 1073, in sage.misc.lazy_import.?\nFailed example:\n    not_there\nExpected:\n    Failed lazy import:\n    foo is not available.\n    Importing not_there failed: No module named 'foo'\n    No equivalent system packages for ... are known to Sage.\n    ...\nGot:\n    Failed lazy import:\n    foo is not available.\n    Importing not_there failed: No module named 'foo'\n    To install foo using the unknown package manager, you can try to run:\n    # install the following packages:\n    To install foo using the Sage package manager, you can try to run:\n      !sage -i non-existing-package\n    No equivalent system packages for pip are known to Sage.\n**********************************************************************\n```\n",
    "created_at": "2020-12-13T09:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432842",
    "user": "vbraun"
}
```

On OSX:

```
**********************************************************************
File "src/sage/misc/lazy_import.pyx", line 1073, in sage.misc.lazy_import.?
Failed example:
    not_there
Expected:
    Failed lazy import:
    foo is not available.
    Importing not_there failed: No module named 'foo'
    No equivalent system packages for ... are known to Sage.
    ...
Got:
    Failed lazy import:
    foo is not available.
    Importing not_there failed: No module named 'foo'
    To install foo using the unknown package manager, you can try to run:
    # install the following packages:
    To install foo using the Sage package manager, you can try to run:
      !sage -i non-existing-package
    No equivalent system packages for pip are known to Sage.
**********************************************************************
```




---

archive/issue_comments_432843.json:
```json
{
    "body": "Looks like we never tested the runtime system package advice on macOS without homebrew. `unknown` needs special-casing",
    "created_at": "2020-12-13T17:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432843",
    "user": "mkoeppe"
}
```

Looks like we never tested the runtime system package advice on macOS without homebrew. `unknown` needs special-casing



---

archive/issue_comments_432844.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-13T17:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432844",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432845.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-13T17:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432845",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432846.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-13T17:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432846",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_432847.json:
```json
{
    "body": "Thanks for the quick fix.",
    "created_at": "2020-12-13T18:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432847",
    "user": "@kliem"
}
```

Thanks for the quick fix.



---

archive/issue_comments_432848.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-13T18:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432848",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_432849.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-14T23:53:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30350#issuecomment-432849",
    "user": "vbraun"
}
```

Resolution: fixed
