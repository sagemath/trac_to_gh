# Issue 30350: Remove import of 'ppl' at startup

Issue created by migration from https://trac.sagemath.org/ticket/30587

Original creator: mkoeppe

Original creation time: 2020-09-16 20:28:37

CC:  @kliem novoselt vbraun winfried jipilab mjo vdelecroix

Currently, sage imports `ppl` (from `pplpy`) at startup, via `sage.geometry.cone`, `sage.geometry.integral_points`, and `sage.geometry.lattice_polytopes`. 

This should be changed, both
 - as preparation for other backends for polyhedral cones (in particular `PyNormaliz`)
 - for the modularization of sagelib (#29705).


---

Comment by mkoeppe created at 2020-12-06 17:46:46

Changing keywords from "" to "sd111".


---

Comment by @kliem created at 2020-12-07 20:56:12

I'm looking at this at the moment.

I think one needs to also take case of `Polyhedron_base`, because once it is lazily imported, then it immediately imports all depencies, in particular the stuff from `ppl`.

So if the goal is to have a working sage as good as possible without `ppl`, then this should be touched as well.

(I tested adding a line `from foo import nonsense` into `backend_ppl.py`. Sage is starting all right, but polyhedra are unusable. However, only backend ppl should fail.)


---

Comment by @kliem created at 2020-12-07 21:25:46

New commits:


---

Comment by @kliem created at 2020-12-07 21:25:46

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-12-09 21:11:37

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2020-12-09 21:36:35

If the imports would not wind up in an extremely hot path, you might also work around the circular imports with local ones (`from foo import whatever` within the function that needs `whatever`). Those don't get run until the function is called, but it does introduce a tiny redundant dictionary lookup the second, third, etc times the function is called.


---

Comment by git created at 2020-12-10 09:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-10 09:16:53

So lazy import appears to be a bit slower.

For `%timeit polytopes.cube()` I went from 411 µs to 417. I don't know if this is acceptable.
So there appears to be a overhead of about 6 µs per call.
----
New commits:


---

Comment by git created at 2020-12-10 10:25:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-10 10:39:26

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-10 16:43:51

In the doctest for `lazy_import`, this text:

```
+ To install foo using the Sage package manager, you can try to run:
+        !sage -i non-existing-package
```

will only appear on sage-the-distribution but not in downstream packaged sage, so it's best to use `...` here


---

Comment by @kliem created at 2020-12-10 16:44:38

Ok, I wasn't exactly sure, what part would appear and what part would not.


---

Comment by git created at 2020-12-10 16:45:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 16:48:15

In fact, perhaps `LazyImport.__repr__` should catch this error and print itself in a friendlier way?


---

Comment by mkoeppe created at 2020-12-10 16:48:46

Also typo `An example of and import `: and->an


---

Comment by mkoeppe created at 2020-12-10 16:53:43

Another data point regarding performance: Without this ticket, I am getting

```
sage: %timeit Polyhedron(vertices=[[]])                                                     
51.7 µs ± 866 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
53.9 µs ± 774 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
52.8 µs ± 738 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


Right after building this branch, I am getting:

```
sage: %timeit Polyhedron(vertices=[[]])                                                     
88.2 µs ± 22.3 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
57.2 µs ± 1.22 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
53.5 µs ± 307 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit Polyhedron(vertices=[[]])                                                     
53.2 µs ± 508 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


So I don't think that we should be concerned about the performance impact here.


---

Comment by git created at 2020-12-10 17:13:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 18:06:23

I think the repr should express somehow that it is a `LazyImport` object so that users who see this output can know where this is coming from.


---

Comment by git created at 2020-12-10 18:29:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 18:56:54

Hm... perhaps only for failed imports?


---

Comment by @kliem created at 2020-12-10 19:01:02

Well the other thing is lying as well. But sure.


---

Comment by git created at 2020-12-10 19:07:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 23:19:56

patchbot shows errors


---

Comment by mkoeppe created at 2020-12-10 23:20:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-11 07:46:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-11 07:46:34

Somehow forgot that.


---

Comment by @kliem created at 2020-12-11 07:46:34

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-11 20:06:37

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-11 20:13:54

Thank you. So I guess I know how that mechanism works, you can ping me, to do it with other packages.


---

Comment by vbraun created at 2020-12-13 09:37:22

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-12-13 09:37:22

On OSX:

```
**********************************************************************
File "src/sage/misc/lazy_import.pyx", line 1073, in sage.misc.lazy_import.?
Failed example:
    not_there
Expected:
    Failed lazy import:
    foo is not available.
    Importing not_there failed: No module named 'foo'
    No equivalent system packages for ... are known to Sage.
    ...
Got:
    Failed lazy import:
    foo is not available.
    Importing not_there failed: No module named 'foo'
    To install foo using the unknown package manager, you can try to run:
    # install the following packages:
    To install foo using the Sage package manager, you can try to run:
      !sage -i non-existing-package
    No equivalent system packages for pip are known to Sage.
**********************************************************************
```



---

Comment by mkoeppe created at 2020-12-13 17:31:24

Looks like we never tested the runtime system package advice on macOS without homebrew. `unknown` needs special-casing


---

Comment by git created at 2020-12-13 17:48:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-13 17:52:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-13 17:53:14

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-12-13 18:03:58

Thanks for the quick fix.


---

Comment by @kliem created at 2020-12-13 18:03:58

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-12-14 23:53:29

Resolution: fixed
