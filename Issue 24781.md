# Issue 24781: Bug in shuffle product `ShuffleProduct_w1w2`

Issue created by migration from Trac.

Original creator: zabrocki

Original creation time: 2018-03-21 11:50:29

CC:  saliola darij

Keywords: combinat, words, shuffle product

Here is the command that I entered to trigger this bug

```
sage: list(Words(1,1)[0].shuffle([2]))
[None, None]
```

The class sage.combinat.words.shuffle_product.ShuffleProduct_w1w2 tries to cast the output of the call in the parent of `w1` but if it fails, it outputs `None` rather than something else.


---

Comment by zabrocki created at 2018-03-21 11:58:55

Of course what we should see in that example is

```
sage: list(Word([1]).shuffle([2]))
[word: 12, word: 21]
```

The problem is the parent of `Words(1,1)[0]` is

```
sage: Words(1,1)[0].parent()
Finite words over {1}
```

and the output of the shuffle contains 1 and 2 and so the offending code in `ShuffleProduct_w1w2`

```
        try:
            return self._w1.parent()(res)
        except ValueError:
            # Special situation: the parent of w1 is too
            # restrictive to be cast on res.
            if isinstance(self._w1.parent(), Compositions_n):
                return Compositions(res)
```

has the problem that since it can't make `[1,2]` into a `finite words over {1}` and it isn't a composition, then it doesn't do anything.


---

Comment by zabrocki created at 2018-03-21 12:24:30

I am pretty sure that the line `return Compositions(res)` never gets called because (I believe) that line should read `return Composition(res)` (no `s`)


---

Comment by darij created at 2018-03-21 16:10:12

Ouch. The whole idea of trying to ducktype to `self._w1.parent()` smells to me, but I don't know how to improve on it. Can we take the union of two alphabets?


---

Comment by zabrocki created at 2018-03-21 16:32:39

The simple solution is just to add the line `return res` (which will just be a list in the case that the other checks fail) at the end of the except clause.

We could also check that `isinstance(w1.parent(),FiniteWords)` and if that is the case call `return Word(res)` and if it fails then just `return res`.


---

Comment by zabrocki created at 2018-03-21 18:28:57

Changing status from new to needs_review.


---

Comment by zabrocki created at 2018-03-21 18:28:57

New commits:


---

Comment by darij created at 2018-03-21 18:36:36

Looks good, but care to add a doctest for the Composition fix?


```
sage: from sage.combinat.words.shuffle_product import ShuffleProduct_w1w2
sage: a = Compositions(1)([1])
sage: b = Compositions(2)([1,1])
sage: ShuffleProduct_w1w2(a, b).list()
```

should return

```
[[1, 1, 1], [1, 1, 1], [1, 1, 1]]
```



---

Comment by zabrocki created at 2018-03-21 19:01:15

I think I will take a little more care with this.  This code is generating bad parents right now and this could just push the error down the road.

```
sage: A = Compositions(6, inner=[2,3])[0]
sage: [B in B.parent() for B in A.shuffle_product([1])]
[False, False, False]
```


If I am not mistaken, this is actually a problem with the `Composition` code since this isn't right:

```
sage: Compositions(6, inner=[2,3])([2,2,2,2,2])
[2, 2, 2, 2, 2]
sage: _.parent()
Compositions of the integer 6 satisfying constraints inner=[2, 3]
```



---

Comment by zabrocki created at 2018-03-21 19:01:15

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-21 19:18:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zabrocki created at 2018-03-21 19:21:46

I modified the doc test that was there.  This doesn't fix the parent problem, but I think that should be another ticket about the `Composition` code.  What do you think?


---

Comment by darij created at 2018-03-21 19:23:37

TBH I prefer a new doctest rather than editing the old one. But I don't have an opinion on the parent issue... this is a design issue. How do `Partitions' do it? Do their parents also reflect all the restrictions that were placed when they were generated?


---

Comment by zabrocki created at 2018-03-21 21:07:27

Don't think of it as 'editing the old doctest', think of it as correcting it.  The reason that doctest is there is to test those lines of code, and it didn't before and now it does.

Check out #15131 and run the test that was raised in the description *not* on this branch.  You will see that it fails.  You had already identified this as an error and opened (and closed) a ticket that didn't fix the problem.

You are right that `Partitions` does not fully check that an element is in the class when it creates an element.  For example:

```
sage: B = Partitions(4,max_part=2)([3,1])
sage: B in B.parent()
False
```



---

Comment by zabrocki created at 2018-03-21 21:08:18

Changing status from needs_work to needs_review.


---

Comment by darij created at 2018-03-21 21:34:41

I can't run it right now, as I'm going through a full rebuild of Sage (previous one was crashing on start reproducibly). But I don't understand your argument for why the old doctest shouldn't be left around.


---

Comment by zabrocki created at 2018-03-21 22:55:47

Please look carefully at the lines I changed and at the lines just above those.  The same doc test was repeated twice so I have not removed anything.  Instead I changed the second doctest so that it does what the sentence says it does.  In between the two repeated doctests, it was written (just above where I changed it):

```
        Sage is no longer confused by a too-restrictive parent
        of `I` when shuffling two compositions `I` and `J`
        (cf. :trac:`15131`)::
```

So I corrected the doctest below that sentence so that it does what that sentence says.

I am 99.9% sure that this is what the original author of those lines (you) meant to put there before and unfortunately it was just missing the 3-4 characters that would have triggered the bug.

If you want, I can add a different doctest.


---

Comment by darij created at 2018-03-21 23:56:41

Changing status from needs_review to positive_review.


---

Comment by darij created at 2018-03-21 23:56:41

Ah! Thanks for keeping track. I have long forgotten what errors I have fixed (or thought so) 4 years ago, but this should have been my intent. LGTM then!


---

Comment by tscrim created at 2018-03-22 01:01:14

Reviewer name.


---

Comment by vbraun created at 2018-05-12 11:47:20

Resolution: fixed
