# Issue 24781: Bug in shuffle product `ShuffleProduct_w1w2`

archive/issues_024781.json:
```json
{
    "body": "CC:  @saliola @darijgr\n\nKeywords: combinat, words, shuffle product\n\nHere is the command that I entered to trigger this bug\n\n```\nsage: list(Words(1,1)[0].shuffle([2]))\n[None, None]\n```\n\nThe class sage.combinat.words.shuffle_product.ShuffleProduct_w1w2 tries to cast the output of the call in the parent of `w1` but if it fails, it outputs `None` rather than something else.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25018\n\n",
    "created_at": "2018-03-21T11:50:29Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Bug in shuffle product `ShuffleProduct_w1w2`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24781",
    "user": "https://github.com/zabrocki"
}
```
CC:  @saliola @darijgr

Keywords: combinat, words, shuffle product

Here is the command that I entered to trigger this bug

```
sage: list(Words(1,1)[0].shuffle([2]))
[None, None]
```

The class sage.combinat.words.shuffle_product.ShuffleProduct_w1w2 tries to cast the output of the call in the parent of `w1` but if it fails, it outputs `None` rather than something else.

Issue created by migration from https://trac.sagemath.org/ticket/25018





---

archive/issue_comments_347554.json:
```json
{
    "body": "Of course what we should see in that example is\n\n```\nsage: list(Word([1]).shuffle([2]))\n[word: 12, word: 21]\n```\n\nThe problem is the parent of `Words(1,1)[0]` is\n\n```\nsage: Words(1,1)[0].parent()\nFinite words over {1}\n```\n\nand the output of the shuffle contains 1 and 2 and so the offending code in `ShuffleProduct_w1w2`\n\n```\n        try:\n            return self._w1.parent()(res)\n        except ValueError:\n            # Special situation: the parent of w1 is too\n            # restrictive to be cast on res.\n            if isinstance(self._w1.parent(), Compositions_n):\n                return Compositions(res)\n```\n\nhas the problem that since it can't make `[1,2]` into a `finite words over {1}` and it isn't a composition, then it doesn't do anything.",
    "created_at": "2018-03-21T11:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347554",
    "user": "https://github.com/zabrocki"
}
```

Of course what we should see in that example is

```
sage: list(Word([1]).shuffle([2]))
[word: 12, word: 21]
```

The problem is the parent of `Words(1,1)[0]` is

```
sage: Words(1,1)[0].parent()
Finite words over {1}
```

and the output of the shuffle contains 1 and 2 and so the offending code in `ShuffleProduct_w1w2`

```
        try:
            return self._w1.parent()(res)
        except ValueError:
            # Special situation: the parent of w1 is too
            # restrictive to be cast on res.
            if isinstance(self._w1.parent(), Compositions_n):
                return Compositions(res)
```

has the problem that since it can't make `[1,2]` into a `finite words over {1}` and it isn't a composition, then it doesn't do anything.



---

archive/issue_comments_347555.json:
```json
{
    "body": "I am pretty sure that the line `return Compositions(res)` never gets called because (I believe) that line should read `return Composition(res)` (no `s`)",
    "created_at": "2018-03-21T12:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347555",
    "user": "https://github.com/zabrocki"
}
```

I am pretty sure that the line `return Compositions(res)` never gets called because (I believe) that line should read `return Composition(res)` (no `s`)



---

archive/issue_comments_347556.json:
```json
{
    "body": "Ouch. The whole idea of trying to ducktype to `self._w1.parent()` smells to me, but I don't know how to improve on it. Can we take the union of two alphabets?",
    "created_at": "2018-03-21T16:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347556",
    "user": "https://github.com/darijgr"
}
```

Ouch. The whole idea of trying to ducktype to `self._w1.parent()` smells to me, but I don't know how to improve on it. Can we take the union of two alphabets?



---

archive/issue_comments_347557.json:
```json
{
    "body": "The simple solution is just to add the line `return res` (which will just be a list in the case that the other checks fail) at the end of the except clause.\n\nWe could also check that `isinstance(w1.parent(),FiniteWords)` and if that is the case call `return Word(res)` and if it fails then just `return res`.",
    "created_at": "2018-03-21T16:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347557",
    "user": "https://github.com/zabrocki"
}
```

The simple solution is just to add the line `return res` (which will just be a list in the case that the other checks fail) at the end of the except clause.

We could also check that `isinstance(w1.parent(),FiniteWords)` and if that is the case call `return Word(res)` and if it fails then just `return res`.



---

archive/issue_comments_347558.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-21T18:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347558",
    "user": "https://github.com/zabrocki"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_347559.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-21T18:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347559",
    "user": "https://github.com/zabrocki"
}
```

New commits:



---

archive/issue_comments_347560.json:
```json
{
    "body": "Looks good, but care to add a doctest for the Composition fix?\n\n\n```\nsage: from sage.combinat.words.shuffle_product import ShuffleProduct_w1w2\nsage: a = Compositions(1)([1])\nsage: b = Compositions(2)([1,1])\nsage: ShuffleProduct_w1w2(a, b).list()\n```\n\nshould return\n\n```\n[[1, 1, 1], [1, 1, 1], [1, 1, 1]]\n```\n",
    "created_at": "2018-03-21T18:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347560",
    "user": "https://github.com/darijgr"
}
```

Looks good, but care to add a doctest for the Composition fix?


```
sage: from sage.combinat.words.shuffle_product import ShuffleProduct_w1w2
sage: a = Compositions(1)([1])
sage: b = Compositions(2)([1,1])
sage: ShuffleProduct_w1w2(a, b).list()
```

should return

```
[[1, 1, 1], [1, 1, 1], [1, 1, 1]]
```




---

archive/issue_comments_347561.json:
```json
{
    "body": "I think I will take a little more care with this.  This code is generating bad parents right now and this could just push the error down the road.\n\n```\nsage: A = Compositions(6, inner=[2,3])[0]\nsage: [B in B.parent() for B in A.shuffle_product([1])]\n[False, False, False]\n```\n\n\nIf I am not mistaken, this is actually a problem with the `Composition` code since this isn't right:\n\n```\nsage: Compositions(6, inner=[2,3])([2,2,2,2,2])\n[2, 2, 2, 2, 2]\nsage: _.parent()\nCompositions of the integer 6 satisfying constraints inner=[2, 3]\n```\n",
    "created_at": "2018-03-21T19:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347561",
    "user": "https://github.com/zabrocki"
}
```

I think I will take a little more care with this.  This code is generating bad parents right now and this could just push the error down the road.

```
sage: A = Compositions(6, inner=[2,3])[0]
sage: [B in B.parent() for B in A.shuffle_product([1])]
[False, False, False]
```


If I am not mistaken, this is actually a problem with the `Composition` code since this isn't right:

```
sage: Compositions(6, inner=[2,3])([2,2,2,2,2])
[2, 2, 2, 2, 2]
sage: _.parent()
Compositions of the integer 6 satisfying constraints inner=[2, 3]
```




---

archive/issue_comments_347562.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-21T19:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347562",
    "user": "https://github.com/zabrocki"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347563.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-21T19:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347563",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347564.json:
```json
{
    "body": "I modified the doc test that was there.  This doesn't fix the parent problem, but I think that should be another ticket about the `Composition` code.  What do you think?",
    "created_at": "2018-03-21T19:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347564",
    "user": "https://github.com/zabrocki"
}
```

I modified the doc test that was there.  This doesn't fix the parent problem, but I think that should be another ticket about the `Composition` code.  What do you think?



---

archive/issue_comments_347565.json:
```json
{
    "body": "TBH I prefer a new doctest rather than editing the old one. But I don't have an opinion on the parent issue... this is a design issue. How do `Partitions' do it? Do their parents also reflect all the restrictions that were placed when they were generated?",
    "created_at": "2018-03-21T19:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347565",
    "user": "https://github.com/darijgr"
}
```

TBH I prefer a new doctest rather than editing the old one. But I don't have an opinion on the parent issue... this is a design issue. How do `Partitions' do it? Do their parents also reflect all the restrictions that were placed when they were generated?



---

archive/issue_comments_347566.json:
```json
{
    "body": "Don't think of it as 'editing the old doctest', think of it as correcting it.  The reason that doctest is there is to test those lines of code, and it didn't before and now it does.\n\nCheck out #15131 and run the test that was raised in the description *not* on this branch.  You will see that it fails.  You had already identified this as an error and opened (and closed) a ticket that didn't fix the problem.\n\nYou are right that `Partitions` does not fully check that an element is in the class when it creates an element.  For example:\n\n```\nsage: B = Partitions(4,max_part=2)([3,1])\nsage: B in B.parent()\nFalse\n```\n",
    "created_at": "2018-03-21T21:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347566",
    "user": "https://github.com/zabrocki"
}
```

Don't think of it as 'editing the old doctest', think of it as correcting it.  The reason that doctest is there is to test those lines of code, and it didn't before and now it does.

Check out #15131 and run the test that was raised in the description *not* on this branch.  You will see that it fails.  You had already identified this as an error and opened (and closed) a ticket that didn't fix the problem.

You are right that `Partitions` does not fully check that an element is in the class when it creates an element.  For example:

```
sage: B = Partitions(4,max_part=2)([3,1])
sage: B in B.parent()
False
```




---

archive/issue_comments_347567.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-21T21:08:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347567",
    "user": "https://github.com/zabrocki"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347568.json:
```json
{
    "body": "I can't run it right now, as I'm going through a full rebuild of Sage (previous one was crashing on start reproducibly). But I don't understand your argument for why the old doctest shouldn't be left around.",
    "created_at": "2018-03-21T21:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347568",
    "user": "https://github.com/darijgr"
}
```

I can't run it right now, as I'm going through a full rebuild of Sage (previous one was crashing on start reproducibly). But I don't understand your argument for why the old doctest shouldn't be left around.



---

archive/issue_comments_347569.json:
```json
{
    "body": "Please look carefully at the lines I changed and at the lines just above those.  The same doc test was repeated twice so I have not removed anything.  Instead I changed the second doctest so that it does what the sentence says it does.  In between the two repeated doctests, it was written (just above where I changed it):\n\n```\n        Sage is no longer confused by a too-restrictive parent\n        of `I` when shuffling two compositions `I` and `J`\n        (cf. :trac:`15131`)::\n```\n\nSo I corrected the doctest below that sentence so that it does what that sentence says.\n\nI am 99.9% sure that this is what the original author of those lines (you) meant to put there before and unfortunately it was just missing the 3-4 characters that would have triggered the bug.\n\nIf you want, I can add a different doctest.",
    "created_at": "2018-03-21T22:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347569",
    "user": "https://github.com/zabrocki"
}
```

Please look carefully at the lines I changed and at the lines just above those.  The same doc test was repeated twice so I have not removed anything.  Instead I changed the second doctest so that it does what the sentence says it does.  In between the two repeated doctests, it was written (just above where I changed it):

```
        Sage is no longer confused by a too-restrictive parent
        of `I` when shuffling two compositions `I` and `J`
        (cf. :trac:`15131`)::
```

So I corrected the doctest below that sentence so that it does what that sentence says.

I am 99.9% sure that this is what the original author of those lines (you) meant to put there before and unfortunately it was just missing the 3-4 characters that would have triggered the bug.

If you want, I can add a different doctest.



---

archive/issue_comments_347570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-21T23:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347570",
    "user": "https://github.com/darijgr"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_347571.json:
```json
{
    "body": "Ah! Thanks for keeping track. I have long forgotten what errors I have fixed (or thought so) 4 years ago, but this should have been my intent. LGTM then!",
    "created_at": "2018-03-21T23:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347571",
    "user": "https://github.com/darijgr"
}
```

Ah! Thanks for keeping track. I have long forgotten what errors I have fixed (or thought so) 4 years ago, but this should have been my intent. LGTM then!



---

archive/issue_comments_347572.json:
```json
{
    "body": "Reviewer name.",
    "created_at": "2018-03-22T01:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347572",
    "user": "https://github.com/tscrim"
}
```

Reviewer name.



---

archive/issue_comments_347573.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-12T11:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24781#issuecomment-347573",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
