# Issue 12701: Clear MMX state in i686 Solaris longjmp()

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-04-24 15:17:01

Assignee: drkirkby

CC:  leif

The libc `setjmp`/`longjmp` functions of OpenSolaris 06.2009-32 on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.


---

Comment by jdemeyer created at 2012-04-24 16:01:06

Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.


---

Comment by jdemeyer created at 2012-04-25 15:50:52

Changing component from solaris to c_lib.


---

Comment by jdemeyer created at 2012-04-25 15:50:52

Changing assignee from drkirkby to jdemeyer.


---

Comment by jdemeyer created at 2012-04-25 15:50:52

I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.


---

Comment by jdemeyer created at 2012-04-26 20:24:44

Test program


---

Attachment


---

Comment by jdemeyer created at 2012-04-27 15:22:53

Changing status from new to needs_review.


---

Attachment


---

Comment by vbraun created at 2012-04-30 15:18:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2012-04-30 15:18:39

The joys of the x86 architechture! ;-)

Patch looks good to me.


---

Comment by jdemeyer created at 2012-05-06 12:20:38

Resolution: fixed


---

Comment by jdemeyer created at 2012-06-03 13:10:15

Similar test program using setcontext()


---

Attachment

#13076 fixes this problem in a much better way, so that ticket effectively undoes this.
