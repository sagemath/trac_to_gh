# Issue 12701: Clear MMX state in i686 Solaris longjmp()

archive/issues_012701.json:
```json
{
    "body": "Assignee: drkirkby\n\nCC:  @nexttime\n\nThe libc `setjmp`/`longjmp` functions of OpenSolaris 06.2009-32 on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12873\n\n",
    "created_at": "2012-04-24T15:17:01Z",
    "labels": [
        "solaris",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "Clear MMX state in i686 Solaris longjmp()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12701",
    "user": "@jdemeyer"
}
```
Assignee: drkirkby

CC:  @nexttime

The libc `setjmp`/`longjmp` functions of OpenSolaris 06.2009-32 on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.

Issue created by migration from https://trac.sagemath.org/ticket/12873





---

archive/issue_comments_151790.json:
```json
{
    "body": "Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.",
    "created_at": "2012-04-24T16:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151790",
    "user": "@jdemeyer"
}
```

Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.



---

archive/issue_comments_151791.json:
```json
{
    "body": "Changing component from solaris to c_lib.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151791",
    "user": "@jdemeyer"
}
```

Changing component from solaris to c_lib.



---

archive/issue_comments_151792.json:
```json
{
    "body": "Changing assignee from drkirkby to @jdemeyer.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151792",
    "user": "@jdemeyer"
}
```

Changing assignee from drkirkby to @jdemeyer.



---

archive/issue_comments_151793.json:
```json
{
    "body": "I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151793",
    "user": "@jdemeyer"
}
```

I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.



---

archive/issue_comments_151794.json:
```json
{
    "body": "Test program",
    "created_at": "2012-04-26T20:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151794",
    "user": "@jdemeyer"
}
```

Test program



---

archive/issue_comments_151795.json:
```json
{
    "body": "Attachment [emms.c](tarball://root/attachments/some-uuid/ticket12873/emms.c) by @jdemeyer created at 2012-04-26 20:33:01",
    "created_at": "2012-04-26T20:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151795",
    "user": "@jdemeyer"
}
```

Attachment [emms.c](tarball://root/attachments/some-uuid/ticket12873/emms.c) by @jdemeyer created at 2012-04-26 20:33:01



---

archive/issue_comments_151796.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-27T15:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151796",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_151797.json:
```json
{
    "body": "Attachment [12873_emms.patch](tarball://root/attachments/some-uuid/ticket12873/12873_emms.patch) by @jdemeyer created at 2012-04-30 09:40:25",
    "created_at": "2012-04-30T09:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151797",
    "user": "@jdemeyer"
}
```

Attachment [12873_emms.patch](tarball://root/attachments/some-uuid/ticket12873/12873_emms.patch) by @jdemeyer created at 2012-04-30 09:40:25



---

archive/issue_comments_151798.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-30T15:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151798",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_151799.json:
```json
{
    "body": "The joys of the x86 architechture! ;-)\n\nPatch looks good to me.",
    "created_at": "2012-04-30T15:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151799",
    "user": "@vbraun"
}
```

The joys of the x86 architechture! ;-)

Patch looks good to me.



---

archive/issue_comments_151800.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-06T12:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151800",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_151801.json:
```json
{
    "body": "Similar test program using setcontext()",
    "created_at": "2012-06-03T13:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151801",
    "user": "@jdemeyer"
}
```

Similar test program using setcontext()



---

archive/issue_comments_151802.json:
```json
{
    "body": "Attachment [context.c](tarball://root/attachments/some-uuid/ticket12873/context.c) by @jdemeyer created at 2012-06-03 19:54:45\n\n#13076 fixes this problem in a much better way, so that ticket effectively undoes this.",
    "created_at": "2012-06-03T19:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12701#issuecomment-151802",
    "user": "@jdemeyer"
}
```

Attachment [context.c](tarball://root/attachments/some-uuid/ticket12873/context.c) by @jdemeyer created at 2012-06-03 19:54:45

#13076 fixes this problem in a much better way, so that ticket effectively undoes this.
