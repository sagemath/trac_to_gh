# Issue 26995: is_isomorphic broken with keyword edge_labels=True

archive/issues_026995.json:
```json
{
    "body": "CC:  @videlec @tscrim stumpc5 @dcoudert @dimpase\n\nKeywords: py3, graph, cyclotomic, matrix, permutation_of, graph, is_isomorphic\n\nThis code led to finding this bug in the `is_isomorphic` method.\n\nHere is a simple working example:\n\n```\nsage: m1 = matrix(ZZ, [[1, -1, -1], [-1, -1, -1], [1, 0, -1]])\nsage: m2 = matrix(ZZ, [[-1, -1, -1], [-1, 1, -1], [-1, 1, 0]])\n```\n\nThe two matrices are equal up to permutation of rows and columns:\n\n```\nsage: m1.is_permutation_of(m2)\nTrue\n```\n\nBut, not over `CyclotomicField`s:\n\n```\nsage: CF = CyclotomicField(1)\nsage: p1 = matrix(CF, [[1, -1, -1], [-1, -1, -1], [1, 0, -1]])\nsage: p2 = matrix(CF, [[-1, -1, -1], [-1, 1, -1], [-1, 1, 0]])\nsage: p1.is_permutation_of(p2)\nFalse\n```\n\nEven with 2 is also does not work:\n\n```\nsage: CF = CyclotomicField(2)\nsage: p1 = matrix(CF, [[1, -1, -1], [-1, -1, -1], [1, 0, -1]])\nsage: p2 = matrix(CF, [[-1, -1, -1], [-1, 1, -1], [-1, 1, 0]])\nsage: p1.is_permutation_of(p2)\nFalse\n```\n\nThis error is provoked at the level of graphs:\n\n```\nsage: g1 = p1.as_bipartite_graph()\nsage: g2 = p2.as_bipartite_graph()\nsage: sorted(g1.edge_labels())\n[1, -1, -1, -1, -1, -1, 1, 0, -1]\nsage: sorted(g2.edge_labels())\n[-1, -1, -1, -1, 1, -1, -1, 1, 0]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/27232\n\n",
    "closed_at": "2019-07-20T09:10:57Z",
    "created_at": "2019-02-07T16:51:49Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "is_isomorphic broken with keyword edge_labels=True",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26995",
    "user": "https://github.com/jplab"
}
```
CC:  @videlec @tscrim stumpc5 @dcoudert @dimpase

Keywords: py3, graph, cyclotomic, matrix, permutation_of, graph, is_isomorphic

This code led to finding this bug in the `is_isomorphic` method.

Here is a simple working example:

```
sage: m1 = matrix(ZZ, [[1, -1, -1], [-1, -1, -1], [1, 0, -1]])
sage: m2 = matrix(ZZ, [[-1, -1, -1], [-1, 1, -1], [-1, 1, 0]])
```

The two matrices are equal up to permutation of rows and columns:

```
sage: m1.is_permutation_of(m2)
True
```

But, not over `CyclotomicField`s:

```
sage: CF = CyclotomicField(1)
sage: p1 = matrix(CF, [[1, -1, -1], [-1, -1, -1], [1, 0, -1]])
sage: p2 = matrix(CF, [[-1, -1, -1], [-1, 1, -1], [-1, 1, 0]])
sage: p1.is_permutation_of(p2)
False
```

Even with 2 is also does not work:

```
sage: CF = CyclotomicField(2)
sage: p1 = matrix(CF, [[1, -1, -1], [-1, -1, -1], [1, 0, -1]])
sage: p2 = matrix(CF, [[-1, -1, -1], [-1, 1, -1], [-1, 1, 0]])
sage: p1.is_permutation_of(p2)
False
```

This error is provoked at the level of graphs:

```
sage: g1 = p1.as_bipartite_graph()
sage: g2 = p2.as_bipartite_graph()
sage: sorted(g1.edge_labels())
[1, -1, -1, -1, -1, -1, 1, 0, -1]
sage: sorted(g2.edge_labels())
[-1, -1, -1, -1, 1, -1, -1, 1, 0]
```

Issue created by migration from https://trac.sagemath.org/ticket/27232





---

archive/issue_comments_379655.json:
```json
{
    "body": "Here is the current issue, sorting is broken on the CyclotomicField:\n\n```\nsage: g1 = p1.as_bipartite_graph()\nsage: g2 = p2.as_bipartite_graph()\nsage: sorted(g1.edge_labels())\n[1, -1, -1, -1, -1, -1, 1, 0, -1]\nsage: sorted(g2.edge_labels())\n[-1, -1, -1, -1, 1, -1, -1, 1, 0]\n```",
    "created_at": "2019-02-07T17:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379655",
    "user": "https://github.com/jplab"
}
```

Here is the current issue, sorting is broken on the CyclotomicField:

```
sage: g1 = p1.as_bipartite_graph()
sage: g2 = p2.as_bipartite_graph()
sage: sorted(g1.edge_labels())
[1, -1, -1, -1, -1, -1, 1, 0, -1]
sage: sorted(g2.edge_labels())
[-1, -1, -1, -1, 1, -1, -1, 1, 0]
```



---

archive/issue_comments_379656.json:
```json
{
    "body": "This code is crap. How can you assume that the elements of your ring could be sorted with respect to some total order?",
    "created_at": "2019-02-07T19:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379656",
    "user": "https://github.com/videlec"
}
```

This code is crap. How can you assume that the elements of your ring could be sorted with respect to some total order?



---

archive/issue_comments_379657.json:
```json
{
    "body": "Replying to [comment:2 vdelecroix]:\n> This code is crap. How can you assume that the elements of your ring could be sorted with respect to some total order?\n\n\nRight! :-S I was quite puzzled when saw that this was done!!\n\nThat step in the `_is_isomorphic` method of graph with the option `edge_labels=True` should be repaired so that it makes sense...\n\nThe above code came up while looking at two character tables coming from two isomorphic groups. They should be equal up to permutation of columns and rows, but it was returns `False` !!!",
    "created_at": "2019-02-08T13:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379657",
    "user": "https://github.com/jplab"
}
```

Replying to [comment:2 vdelecroix]:
> This code is crap. How can you assume that the elements of your ring could be sorted with respect to some total order?


Right! :-S I was quite puzzled when saw that this was done!!

That step in the `_is_isomorphic` method of graph with the option `edge_labels=True` should be repaired so that it makes sense...

The above code came up while looking at two character tables coming from two isomorphic groups. They should be equal up to permutation of columns and rows, but it was returns `False` !!!



---

archive/issue_comments_379658.json:
```json
{
    "body": "This is indeed annoying. Many graphs problem like this one have to be fixed with the switch to Python3 (where comparison might simply throw errors)...",
    "created_at": "2019-02-08T15:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379658",
    "user": "https://github.com/videlec"
}
```

This is indeed annoying. Many graphs problem like this one have to be fixed with the switch to Python3 (where comparison might simply throw errors)...



---

archive/issue_comments_379659.json:
```json
{
    "body": "Agreed. Many progresses have been done in the graph module and a lot remains to be done. Help fixing problems / reviewing tickets is more than welcome :P\n\nI tried the example with Python 2 and 3 and the answer is `False` in both cases and it is effectively due to the test `if edge_labels and sorted(self.edge_labels()) != sorted(other.edge_labels()):` that is `False` here for the reason explained above (#comment:2).\n\nDo you have any suggestion on how to compare the 2 lists of edge labels knowing that edge labels can be unhashable ?\n\nMay be this ticket could be moved to the graph component as it will only touch method `is_isomorphic` ? Could make it easier to trac changes in the graph module...",
    "created_at": "2019-02-08T16:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379659",
    "user": "https://github.com/dcoudert"
}
```

Agreed. Many progresses have been done in the graph module and a lot remains to be done. Help fixing problems / reviewing tickets is more than welcome :P

I tried the example with Python 2 and 3 and the answer is `False` in both cases and it is effectively due to the test `if edge_labels and sorted(self.edge_labels()) != sorted(other.edge_labels()):` that is `False` here for the reason explained above (#comment:2).

Do you have any suggestion on how to compare the 2 lists of edge labels knowing that edge labels can be unhashable ?

May be this ticket could be moved to the graph component as it will only touch method `is_isomorphic` ? Could make it easier to trac changes in the graph module...



---

archive/issue_comments_379660.json:
```json
{
    "body": "Changing keywords from \"cyclotomic, matrix, permutation_of\" to \"cyclotomic, matrix, permutation_of, graph, is_isomorphic\".",
    "created_at": "2019-02-09T17:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379660",
    "user": "https://github.com/dcoudert"
}
```

Changing keywords from "cyclotomic, matrix, permutation_of" to "cyclotomic, matrix, permutation_of, graph, is_isomorphic".



---

archive/issue_comments_379661.json:
```json
{
    "body": "I tried many stuff today without success. This is really one of the major issue of the graph module.\n\nWe can do a simple hack to replace the test `sorted(self.edge_labels()) != sorted(other.edge_labels())` in method `is_isomorphic` of `generic_graph.py`. This is not nice/efficient but it does the job.\n\n```\n                def same_edge_labels(self_labels, other_labels):\n                    \"\"\"\n                    Check that the lists have exactly the same content.\n                    This is slower than sorting and checking equality, but safe\n                    for Python3.\n                    \"\"\"\n                    for label in self_labels:\n                        if label in other_labels:\n                            other_labels.remove(label)\n                        else:\n                            return False\n                    return not other_labels\n```\n\nHowever, this is far from enough as method `graph_isom_equivalent_non_edge_labeled_graph` sorts many times lists of edge labels. I tried to remove these sortings, but I don't have a sufficient understanding of the methods to know what is correct, what is not and more importantly, what is assumed as input/output of other methods like those of `sage.groups.perm_gps.partn_ref.refinement_graphs`, etc.\n\nI'm pushing in a public branch what I tried to do. Feel free to modify/correct/etc. and even suppress if you believe it is not a good approach to fix the problem. It's breaking doctests in `is_isomorphic` and `canonical_label`...\n\n\nPS: The cost to pay for accepting anything as an edge label is really high :(\n\n---\nNew commits:",
    "created_at": "2019-02-09T17:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379661",
    "user": "https://github.com/dcoudert"
}
```

I tried many stuff today without success. This is really one of the major issue of the graph module.

We can do a simple hack to replace the test `sorted(self.edge_labels()) != sorted(other.edge_labels())` in method `is_isomorphic` of `generic_graph.py`. This is not nice/efficient but it does the job.

```
                def same_edge_labels(self_labels, other_labels):
                    """
                    Check that the lists have exactly the same content.
                    This is slower than sorting and checking equality, but safe
                    for Python3.
                    """
                    for label in self_labels:
                        if label in other_labels:
                            other_labels.remove(label)
                        else:
                            return False
                    return not other_labels
```

However, this is far from enough as method `graph_isom_equivalent_non_edge_labeled_graph` sorts many times lists of edge labels. I tried to remove these sortings, but I don't have a sufficient understanding of the methods to know what is correct, what is not and more importantly, what is assumed as input/output of other methods like those of `sage.groups.perm_gps.partn_ref.refinement_graphs`, etc.

I'm pushing in a public branch what I tried to do. Feel free to modify/correct/etc. and even suppress if you believe it is not a good approach to fix the problem. It's breaking doctests in `is_isomorphic` and `canonical_label`...


PS: The cost to pay for accepting anything as an edge label is really high :(

---
New commits:



---

archive/issue_comments_379662.json:
```json
{
    "body": "There is indeed a general problem with labels (not only for graphs). Ideally, when one has a structure with labels, one should be able to specify\n1. whether labels have a total order (and provide a comparison function)\n2. whether labels are hashable (and provide a hash function)\n3. if neither 1. nor 2. applies, be prepared for costly checks\n\nIn the current situation, if 1. applies, you can use sort and if 2. applies you can use Python `set`.",
    "created_at": "2019-02-10T19:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379662",
    "user": "https://github.com/videlec"
}
```

There is indeed a general problem with labels (not only for graphs). Ideally, when one has a structure with labels, one should be able to specify
1. whether labels have a total order (and provide a comparison function)
2. whether labels are hashable (and provide a hash function)
3. if neither 1. nor 2. applies, be prepared for costly checks

In the current situation, if 1. applies, you can use sort and if 2. applies you can use Python `set`.



---

archive/issue_comments_379663.json:
```json
{
    "body": "Changing component from algebra to graph theory.",
    "created_at": "2019-02-22T09:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379663",
    "user": "https://github.com/jplab"
}
```

Changing component from algebra to graph theory.



---

archive/issue_comments_379664.json:
```json
{
    "body": "Replying to [comment:7 vdelecroix]:\n> There is indeed a general problem with labels (not only for graphs). Ideally, when one has a structure with labels, one should be able to specify\n> 1. whether labels have a total order (and provide a comparison function)\n> 2. whether labels are hashable (and provide a hash function)\n> 3. if neither 1. nor 2. applies, be prepared for costly checks\n> \n> In the current situation, if 1. applies, you can use sort and if 2. applies you can use Python `set`.\n\n\nThat sounds like a reasonable ideal. It does not sound too idealistic either.",
    "created_at": "2019-02-22T09:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379664",
    "user": "https://github.com/jplab"
}
```

Replying to [comment:7 vdelecroix]:
> There is indeed a general problem with labels (not only for graphs). Ideally, when one has a structure with labels, one should be able to specify
> 1. whether labels have a total order (and provide a comparison function)
> 2. whether labels are hashable (and provide a hash function)
> 3. if neither 1. nor 2. applies, be prepared for costly checks
> 
> In the current situation, if 1. applies, you can use sort and if 2. applies you can use Python `set`.


That sounds like a reasonable ideal. It does not sound too idealistic either.



---

archive/issue_comments_379665.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-09T17:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379665",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_379666.json:
```json
{
    "body": "I pushed a new branch to fix the issues with `is_isomorphic`, and in particular with `graph_isom_equivalent_non_edge_labeled_graph`. It seems to fix all remaining failing doctests in `generic_graph.py` in Python 3.\n\nIt took me some time to understand the method, and in particular why and when sort is needed. I reduced the number of places where sort is used, and used `sorted(..., key=str)` to sort hazardous objects (i.e., list of edge labels). For sure some users will invent another kind of edge labels for which this will not work, but unless we implement everywhere the remarks of #comment:7, and so force the user to specify the sort method, I don't see how we can magically answer all requirements.\n\n\n\nHelp needed: I use method `filterfalse` from itertools, but it'ss called `ifilterfalse` in Python 2 and `filterfalse` in Python 3. I used a try .. except to import it, but there is certainly a smarter way.\n\n\nPlease review, check, double check, do some tests, etc.\n\n---\nNew commits:",
    "created_at": "2019-03-09T17:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379666",
    "user": "https://github.com/dcoudert"
}
```

I pushed a new branch to fix the issues with `is_isomorphic`, and in particular with `graph_isom_equivalent_non_edge_labeled_graph`. It seems to fix all remaining failing doctests in `generic_graph.py` in Python 3.

It took me some time to understand the method, and in particular why and when sort is needed. I reduced the number of places where sort is used, and used `sorted(..., key=str)` to sort hazardous objects (i.e., list of edge labels). For sure some users will invent another kind of edge labels for which this will not work, but unless we implement everywhere the remarks of #comment:7, and so force the user to specify the sort method, I don't see how we can magically answer all requirements.



Help needed: I use method `filterfalse` from itertools, but it'ss called `ifilterfalse` in Python 2 and `filterfalse` in Python 3. I used a try .. except to import it, but there is certainly a smarter way.


Please review, check, double check, do some tests, etc.

---
New commits:



---

archive/issue_comments_379667.json:
```json
{
    "body": "Changing keywords from \"cyclotomic, matrix, permutation_of, graph, is_isomorphic\" to \"py3, graph, cyclotomic, matrix, permutation_of, graph, is_isomorphic\".",
    "created_at": "2019-03-09T17:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379667",
    "user": "https://github.com/dcoudert"
}
```

Changing keywords from "cyclotomic, matrix, permutation_of, graph, is_isomorphic" to "py3, graph, cyclotomic, matrix, permutation_of, graph, is_isomorphic".



---

archive/issue_comments_379668.json:
```json
{
    "body": "Replying to [comment:10 dcoudert]:\n> Help needed: I use method `filterfalse` from itertools, but it'ss called `ifilterfalse` in Python 2 and `filterfalse` in Python 3. I used a try .. except to import it, but there is certainly a smarter way.\n\n\nGet rid of `filterfalse`:\n\n```diff\n-    for label in filterfalse(edge_labels.__contains__, G.edge_labels()):\n+    for label in G.edge_labels():\n+        if label in edge_labels:\n+            continue\n```\nAlthough I might also unroll `G.edge_labels()` and do\n\n```python\n    for _,_,label in G.edge_iterator():\n        if label in edge_labels:\n            continue\n```",
    "created_at": "2019-03-09T21:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379668",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:10 dcoudert]:
> Help needed: I use method `filterfalse` from itertools, but it'ss called `ifilterfalse` in Python 2 and `filterfalse` in Python 3. I used a try .. except to import it, but there is certainly a smarter way.


Get rid of `filterfalse`:

```diff
-    for label in filterfalse(edge_labels.__contains__, G.edge_labels()):
+    for label in G.edge_labels():
+        if label in edge_labels:
+            continue
```
Although I might also unroll `G.edge_labels()` and do

```python
    for _,_,label in G.edge_iterator():
        if label in edge_labels:
            continue
```



---

archive/issue_comments_379669.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-09T23:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379669",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379670.json:
```json
{
    "body": "done.\n\nThere is this doctest error:\n\n```\nsage -t --long src/sage/combinat/root_system/coxeter_matrix.py\n**********************************************************************\nFile \"src/sage/combinat/root_system/coxeter_matrix.py\", line 1041, in sage.combinat.root_system.coxeter_matrix.recognize_coxeter_type_from_matrix\nFailed example:\n    CoxeterMatrix(CoxeterType(['A',10,1]).coxeter_graph()).coxeter_type()\nExpected:\n    Coxeter type of ['A', 10, 1]\nGot:\n    Coxeter type of ['A', 10, 1] relabelled by {0: 2, 1: 3, 2: 4, 3: 5, 4: 6, 5: 7, 6: 8, 7: 9, 8: 10, 9: 0, 10: 1}\n```\nCan anyone tell if it's something serious or if it is sufficient to replace the expected output or the example.",
    "created_at": "2019-03-09T23:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379670",
    "user": "https://github.com/dcoudert"
}
```

done.

There is this doctest error:

```
sage -t --long src/sage/combinat/root_system/coxeter_matrix.py
**********************************************************************
File "src/sage/combinat/root_system/coxeter_matrix.py", line 1041, in sage.combinat.root_system.coxeter_matrix.recognize_coxeter_type_from_matrix
Failed example:
    CoxeterMatrix(CoxeterType(['A',10,1]).coxeter_graph()).coxeter_type()
Expected:
    Coxeter type of ['A', 10, 1]
Got:
    Coxeter type of ['A', 10, 1] relabelled by {0: 2, 1: 3, 2: 4, 3: 5, 4: 6, 5: 7, 6: 8, 7: 9, 8: 10, 9: 0, 10: 1}
```
Can anyone tell if it's something serious or if it is sufficient to replace the expected output or the example.



---

archive/issue_comments_379671.json:
```json
{
    "body": "You should **not** update the output for this test. Here there is an implicit ordering on the vertices and it is not detecting that they should match (instead it is a rotation of the cycle graph by 2 steps). This might be a case where we should force the isomorphism test to (attempt to) sort the output as we need this labeling to be canonical (as there are generally non-trivial automorphisms as in this example).",
    "created_at": "2019-03-10T00:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379671",
    "user": "https://github.com/tscrim"
}
```

You should **not** update the output for this test. Here there is an implicit ordering on the vertices and it is not detecting that they should match (instead it is a rotation of the cycle graph by 2 steps). This might be a case where we should force the isomorphism test to (attempt to) sort the output as we need this labeling to be canonical (as there are generally non-trivial automorphisms as in this example).



---

archive/issue_comments_379672.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-10T09:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379672",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379673.json:
```json
{
    "body": "Right, we need a method returning a total ordering of hashable (vertices) or unhashable (labels) objects. It's the only way to ensure the correctness of the methods here. But how to write something reasonably fast ? and where to put it ?",
    "created_at": "2019-03-10T10:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379673",
    "user": "https://github.com/dcoudert"
}
```

Right, we need a method returning a total ordering of hashable (vertices) or unhashable (labels) objects. It's the only way to ensure the correctness of the methods here. But how to write something reasonably fast ? and where to put it ?



---

archive/issue_comments_379674.json:
```json
{
    "body": "Maybe functools.cmp_to_key(func) from https://docs.python.org/3/library/functools.html ?",
    "created_at": "2019-03-10T10:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379674",
    "user": "https://github.com/dimpase"
}
```

Maybe functools.cmp_to_key(func) from https://docs.python.org/3/library/functools.html ?



---

archive/issue_comments_379675.json:
```json
{
    "body": "Replying to [comment:17 dimpase]:\n> Maybe functools.cmp_to_key(func) from https://docs.python.org/3/library/functools.html ?\n\nBut what should be the function ?",
    "created_at": "2019-03-10T11:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379675",
    "user": "https://github.com/dcoudert"
}
```

Replying to [comment:17 dimpase]:
> Maybe functools.cmp_to_key(func) from https://docs.python.org/3/library/functools.html ?

But what should be the function ?



---

archive/issue_comments_379676.json:
```json
{
    "body": "Replying to [comment:18 dcoudert]:\n> Replying to [comment:17 dimpase]:\n> > Maybe functools.cmp_to_key(func) from https://docs.python.org/3/library/functools.html ?\n\n> But what should be the function ?\n\nthe comparison used in Python2, I gather.",
    "created_at": "2019-03-10T11:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379676",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:18 dcoudert]:
> Replying to [comment:17 dimpase]:
> > Maybe functools.cmp_to_key(func) from https://docs.python.org/3/library/functools.html ?

> But what should be the function ?

the comparison used in Python2, I gather.



---

archive/issue_comments_379677.json:
```json
{
    "body": "> the comparison used in Python2, I gather.\n\nBut we don't have it, right ?",
    "created_at": "2019-03-10T12:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379677",
    "user": "https://github.com/dcoudert"
}
```

> the comparison used in Python2, I gather.

But we don't have it, right ?



---

archive/issue_comments_379678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-11T16:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379678",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_067600.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26995#event-67600"
}
```



---

archive/issue_comments_379679.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379679",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_379680.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379680",
    "user": "https://github.com/embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_events_067601.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26995#event-67601"
}
```



---

archive/issue_events_067602.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26995#event-67602"
}
```



---

archive/issue_comments_379681.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-05T10:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379681",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379682.json:
```json
{
    "body": "Rebased on last beta.\n\nThis ticket is certainly the last big py3 issue in the graph module.\nSo any comment / help / /idea for improving / etc. is more than welcome :)",
    "created_at": "2019-07-05T10:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379682",
    "user": "https://github.com/dcoudert"
}
```

Rebased on last beta.

This ticket is certainly the last big py3 issue in the graph module.
So any comment / help / /idea for improving / etc. is more than welcome :)



---

archive/issue_comments_379683.json:
```json
{
    "body": "What do you think about these minor changes?\n\n```diff\ndiff --git a/src/sage/graphs/generic_graph.py b/src/sage/graphs/generic_graph.py\nindex 00e39838fe..71424d5e2b 100644\n--- a/src/sage/graphs/generic_graph.py\n+++ b/src/sage/graphs/generic_graph.py\n@@ -23995,13 +23995,13 @@ def graph_isom_equivalent_non_edge_labeled_graph(g, partition=None, standard_lab\n             edge_partition = [el[1] for el in edge_partition]\n             edge_partition = [list(chain(*edge_partition))]\n \n-        # An edge between u and v with label l and multiplicity k being encoded\n-        # as an uv edge with label [l,k], we must not assume that an edge with\n-        # multiplicity 2 is equivalent to a simple edge !\n-        # Hence, we still distinguish edges with different multiplicity\n-        if g_has_multiple_edges:\n+        else: # g_has_multiple_edges\n+            # An edge between u and v with label l and multiplicity k being encoded\n+            # as an uv edge with label [l,k], we must not assume that an edge with\n+            # multiplicity 2 is equivalent to a simple edge!\n+            # Hence, we still distinguish edges with different multiplicity.\n \n-            # Gather the partitions of edges with same multiplicity\n+            # Gather the partitions of edges with same multiplicity.\n             tmp = {}\n             for el, part in edge_partition:\n                 # The multiplicity of a label is the number of edges from u to v\n```\nI don't have any other comments. Is everyone else happy with this branch?",
    "created_at": "2019-07-10T17:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379683",
    "user": "https://github.com/jhpalmieri"
}
```

What do you think about these minor changes?

```diff
diff --git a/src/sage/graphs/generic_graph.py b/src/sage/graphs/generic_graph.py
index 00e39838fe..71424d5e2b 100644
--- a/src/sage/graphs/generic_graph.py
+++ b/src/sage/graphs/generic_graph.py
@@ -23995,13 +23995,13 @@ def graph_isom_equivalent_non_edge_labeled_graph(g, partition=None, standard_lab
             edge_partition = [el[1] for el in edge_partition]
             edge_partition = [list(chain(*edge_partition))]
 
-        # An edge between u and v with label l and multiplicity k being encoded
-        # as an uv edge with label [l,k], we must not assume that an edge with
-        # multiplicity 2 is equivalent to a simple edge !
-        # Hence, we still distinguish edges with different multiplicity
-        if g_has_multiple_edges:
+        else: # g_has_multiple_edges
+            # An edge between u and v with label l and multiplicity k being encoded
+            # as an uv edge with label [l,k], we must not assume that an edge with
+            # multiplicity 2 is equivalent to a simple edge!
+            # Hence, we still distinguish edges with different multiplicity.
 
-            # Gather the partitions of edges with same multiplicity
+            # Gather the partitions of edges with same multiplicity.
             tmp = {}
             for el, part in edge_partition:
                 # The multiplicity of a label is the number of edges from u to v
```
I don't have any other comments. Is everyone else happy with this branch?



---

archive/issue_comments_379684.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-10T18:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379685.json:
```json
{
    "body": "I followed your idea and now it's `if g_has_multiple_edges: .... else: ...`",
    "created_at": "2019-07-10T18:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379685",
    "user": "https://github.com/dcoudert"
}
```

I followed your idea and now it's `if g_has_multiple_edges: .... else: ...`



---

archive/issue_comments_379686.json:
```json
{
    "body": "Great! As I said, I'm happy. Others have looked more carefully at this, so I would like to hear from them before setting this to positive review.",
    "created_at": "2019-07-10T18:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379686",
    "user": "https://github.com/jhpalmieri"
}
```

Great! As I said, I'm happy. Others have looked more carefully at this, so I would like to hear from them before setting this to positive review.



---

archive/issue_comments_379687.json:
```json
{
    "body": "I found the documentation a little confusing, so here are some changes. `@`dcoudert, if you are happy with them, then I think we can set this to positive review.\n\n---\nNew commits:",
    "created_at": "2019-07-17T22:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379687",
    "user": "https://github.com/jhpalmieri"
}
```

I found the documentation a little confusing, so here are some changes. `@`dcoudert, if you are happy with them, then I think we can set this to positive review.

---
New commits:



---

archive/issue_comments_379688.json:
```json
{
    "body": "Sorry, I'll better let this to others, not enough time before going on vacation.",
    "created_at": "2019-07-17T22:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379688",
    "user": "https://github.com/dimpase"
}
```

Sorry, I'll better let this to others, not enough time before going on vacation.



---

archive/issue_comments_379689.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-17T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379689",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379690.json:
```json
{
    "body": "A small typo\n\n```diff\n-    edge labeled with a list ``[[label1, multiplicity], [label1,\n+    edge labeled with a list ``[[label1, multiplicity], [label2,\n```",
    "created_at": "2019-07-17T22:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379690",
    "user": "https://github.com/dcoudert"
}
```

A small typo

```diff
-    edge labeled with a list ``[[label1, multiplicity], [label1,
+    edge labeled with a list ``[[label1, multiplicity], [label2,
```



---

archive/issue_comments_379691.json:
```json
{
    "body": "I did the correction and pushed to a new branch in `public/`\n\n---\nNew commits:",
    "created_at": "2019-07-17T23:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379691",
    "user": "https://github.com/dcoudert"
}
```

I did the correction and pushed to a new branch in `public/`

---
New commits:



---

archive/issue_comments_379692.json:
```json
{
    "body": "I'm happy with all these modification. The code is much better now and fix py3 failing doctests. Further improvements are certainly possible, but let's do them in another patch.\n\nThank you all for the help.",
    "created_at": "2019-07-17T23:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379692",
    "user": "https://github.com/dcoudert"
}
```

I'm happy with all these modification. The code is much better now and fix py3 failing doctests. Further improvements are certainly possible, but let's do them in another patch.

Thank you all for the help.



---

archive/issue_comments_379693.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-17T23:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379693",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_067603.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-07-20T09:10:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26995#event-67603"
}
```



---

archive/issue_comments_379694.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-20T09:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26995",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26995#issuecomment-379694",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
