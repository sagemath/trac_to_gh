# Issue 10726: Fix and upgrade Gram-Schmidt

Issue created by migration from Trac.

Original creator: rbeezer

Original creation time: 2011-02-16 17:48:23

Assignee: jason, was

If a set of vectors has a linearly dependent subset, followed by a vector outside the span of that subset, then the presence of a zero vector in the orthogonal set causes division by a zero dot product.

There are various other improvements that can be made in this routine.


```
sage: A=matrix(QQ, [[1,2],[2,4],[1,1]])
sage: A.gram_schmidt()
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)

/sage/sage-4.6.2.alpha4/<ipython console> in <module>()

/sage/sage-4.6.2.alpha4/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.gram_schmidt (sage/matrix/matrix2.c:31979)()

/sage/sage-4.6.2.alpha4/local/lib/python2.6/site-packages/sage/modules/misc.pyc in gram_schmidt(B)
     55     for i in range(1,n):
     56         for j in range(i):
---> 57             mu[i,j] = B[i].dot_product(Bstar[j]) / (Bstar[j].dot_product(Bstar[j]))
     58         Bstar.append(B[i] - sum(mu[i,j]*Bstar[j] for j in range(i)))
     59     return Bstar, mu

/sage/sage-4.6.2.alpha4/local/lib/python2.6/site-packages/sage/structure/element.so in sage.structure.element.RingElement.__div__ (sage/structure/element.c:11981)()

/sage/sage-4.6.2.alpha4/local/lib/python2.6/site-packages/sage/rings/rational.so in sage.rings.rational.Rational._div_ (sage/rings/rational.c:15177)()

ZeroDivisionError: Rational division by zero
```



---

Comment by rbeezer created at 2011-02-27 01:38:58

Changing status from new to needs_review.


---

Attachment


---

Comment by kini created at 2011-03-23 22:32:37

fix patchbot comment


---

Comment by mraum created at 2011-03-26 01:19:24

In line 6364: properly contains
In line 6444: For the integers and the rationals the field 

There is only one thing you didn't catch. If you fix that I can give this a positive review (please provide a patch that depends on the current one, to make my life easier) :

File "/scratch/mraum/sagedev/devel/sage-dev/sage/modules/misc.py", line 66:
    sage: gram_schmidt(V)
Exception raised:
    Traceback (most recent call last):
      File "/scratch/mraum/sagedev/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/scratch/mraum/sagedev/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/scratch/mraum/sagedev/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_1[16]>", line 1, in <module>
        gram_schmidt(V)###line 66:
    sage: gram_schmidt(V)
      File "/scratch/mraum/sagedev/local/lib/python/site-packages/sage/modules/misc.py", line 83, in gram_schmidt
        raise ValueError("linearly dependent input for module version of Gram-Schmidt")
    ValueError: linearly dependent input for module version of Gram-Schmidt


---

Comment by mraum created at 2011-03-26 01:19:24

Changing status from needs_review to needs_work.


---

Comment by rbeezer created at 2011-03-27 05:34:33

Changing status from needs_work to needs_review.


---

Attachment

Martin - thanks for the careful review and for catching these three items.

"doctests" patch implements changes to fix all three.

Rob


---

Comment by mraum created at 2011-03-30 19:28:05

Changing status from needs_review to positive_review.


---

Comment by mraum created at 2011-03-30 19:28:05

Ok, the doctest patch fixes all issues. So this gets a positive review


---

Comment by jdemeyer created at 2011-04-13 12:12:33

Problems while building the documentation:

```
docstring of sage.matrix.matrix2.Matrix.gram_schmidt:47: (WARNING/2) Literal block expected; none found.
docstring of sage.matrix.matrix2.Matrix.gram_schmidt:217: (WARNING/2) Literal block expected; none found.
```



---

Comment by jdemeyer created at 2011-04-13 12:12:33

Changing status from positive_review to needs_work.


---

Comment by rbeezer created at 2011-04-14 05:47:04

Changing status from needs_work to needs_review.


---

Attachment

Documentation fixes are added into a v2 version of the doctest patch.

Just had to change two `::` to `:` in sage/matrix/matrix2.pyx.

So this change is ready for review.


---

Comment by mraum created at 2011-04-18 11:02:46

The patchbot does not apply the patches this depends on. Do you, Robert, know how to fix that in the ticket description?


---

Comment by rbeezer created at 2011-04-19 00:30:44

Replying to [comment:8 mraum]:
> The patchbot does not apply the patches this depends on. Do you, Robert, know how to fix that in the ticket description?

I have tried to chase back the dependencies and get everything in order for the patchbot.  We'll see.  The only change since this _had_ a positive review was a couple of extra double-colons that had to be removed, so the documentation would build right.


---

Comment by rbeezer created at 2011-04-19 00:34:47

Feeding the patchbot:

Depends on #10536, #10683, #10794 

Apply: trac_10791-fix-gram-schmidt.patch, trac_10791-gram-schmidt-doctests-v2.patch


---

Comment by mraum created at 2011-05-06 14:23:11

A copy of trac_10791-gram-schmidt-doctests-v2.patch


---

Attachment

One more try to make the patchbot retry: I added a copy of the last patch.

Depends on #10536, #10683, #10794

Apply: trac_10791-fix-gram-schmidt.patch, trac-10791-gram-schmidt-doctests-v2.patch


---

Comment by jdemeyer created at 2011-05-07 10:19:32

Using a bare `except:` (line 6303 of `sage/matrix/matrix2.pyx`) is a very bad idea.  You should catch specific exceptions, not all.


---

Comment by rbeezer created at 2011-05-08 20:22:37

Replying to [comment:12 jdemeyer]:
> Using a bare `except:` (line 6303 of `sage/matrix/matrix2.pyx`) is a very bad idea.  You should catch specific exceptions, not all.

Yes, I became aware of this many months ago.  However, I never know just what to be catching.  In other words, it would be nice to use a `__call___` method as a way to sanitize input, but I often have trouble figuring out just how the code will react when it fails (just what type of error will come back).

So which is preferable:


```
try:
   n = Integer(n_input)
except SomeError:
   raise ....
```


or


```
if not is_Integer(n_input):
    raise ...
else:
    n = Integer(n_input)
```


In the first case is it enough to just catch  `TypeError` and `ValueError`?

In the second case, I am often at a loss to decide which to use, in particular I once spent a very long time trying to determine if an input was a real number.

So my naked except is really an act of desperation.  Advice would be appreciated.

Rob


---

Comment by rbeezer created at 2011-05-08 20:22:37

Changing status from needs_review to needs_info.


---

Attachment

The naked except has been corrected to:


```
        try:
            F = R.fraction_field()
        except TypeError:
            raise TypeError(<snipped>)
```


This had a positive review back at comment 5.  Since then it has received a documentation fix (double colons) and the fix on the except clause.  Those are the only changes since then.

I do not know what is up with the patchbot, as it seems totally dead at the moment.  In any event, it seems counter-productive to wait on it while it is still being developed.  This is passing all tests for me right now.


---

Comment by rbeezer created at 2011-07-18 17:37:32

Changing status from needs_info to needs_review.


---

Comment by rbeezer created at 2011-07-18 17:57:39

Apply *only* this patch


---

Attachment

Got confused with the various patches here, so I just rolled everything into one, the v3 patch.  So only apply this one patch.


---

Comment by mraum created at 2011-08-06 15:01:25

I checked this once more. The documentation builds fine, indeed. And everything since nothing but the exception has changed, I can set this again to positive review.


---

Comment by mraum created at 2011-08-06 15:01:25

Changing status from needs_review to positive_review.


---

Comment by rbeezer created at 2011-08-11 05:04:41

Thanks, Martin!  I'm just getting caught up now that email notifications are working again.

Rob


---

Comment by jdemeyer created at 2011-08-18 22:02:13

Resolution: fixed


---

Comment by jdemeyer created at 2011-08-24 14:54:06

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-08-24 14:54:06

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-08-24 14:54:06

Doctest failure on flavius ():

```
sage -t -long  -force_lib devel/sage/sage/matrix/matrix2.pyx
**********************************************************************
File "/home/buildbot/build/sage/flavius-1/flavius_full/build/sage-4.7.2.alpha2/devel/sage-main/sage/matrix/matrix2.pyx", line 7722:
    sage: M.round(10)
Expected:
    [-2.4494897428           0.0           0.0]
    [-3.6742346142  0.7071067812           0.0]
    [-4.8989794856  1.4142135624           0.0]
Got:
    [-2.4494897428           0.0           0.0]
    [-3.6742346142  0.7071067812           0.0]
    [-4.8989794856  1.4142135624          -0.0]
**********************************************************************
```



---

Comment by jdemeyer created at 2011-08-24 21:58:22

Doctest failure on bsd (OS X 10.8.0 x86_64):

```
sage -t -long  -force_lib devel/sage/sage/matrix/matrix2.pyx
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.2.alpha2/devel/sage-main/sage/matrix/matrix2.pyx", line 7718:
    sage: G.round(6)
Expected:
    [-0.408248 -0.408248 -0.816497]
    [ 0.707107 -0.707107      -0.0]
    [ -0.57735  -0.57735   0.57735]
Got:
    [-0.408248 -0.408248 -0.816497]
    [ 0.707107 -0.707107       0.0]
    [ -0.57735  -0.57735   0.57735]
**********************************************************************
```



---

Comment by jdemeyer created at 2011-08-24 21:58:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-08-24 21:58:28

Changing status from needs_review to needs_work.


---

Comment by rbeezer created at 2011-08-25 02:11:20

Changing status from needs_work to needs_info.


---

Comment by rbeezer created at 2011-08-25 02:11:20

Turns out the IEEE specification includes a "negative zero."  Rounding and `.zero_at()` might do the trick.

Six such changes in the "negative zero" patch.  Successful with one instance where I converted a `-0.0` to `0.0`.

Jeroen - could you easily test/review this on the two failing machines?  If it works across three architectures, I'll then apply the same technique to #10795, #10837 with some confidence.

Thanks for your patience with this (exasperating) numerical work.

Rob


---

Comment by rbeezer created at 2011-08-25 18:57:30

Changing keywords from "" to "sd32".


---

Comment by rbeezer created at 2011-09-19 02:50:11

Changing status from needs_info to needs_review.


---

Comment by jason created at 2011-12-04 00:12:28

What's needed now?  Jeroen just needs to test this last doctest fix on flavius and bsd?  (or should we set it back to positive review, since the doctest changes are minor, and depend on the more widespread release testing to catch it on the platforms we don't have easy access to?)

I think I would prefer setting this back to positive review, since Jeroen will be implicitly testing it on those two platforms when he merges it (as long as it still passes on Rob's platform).


---

Comment by jhpalmieri created at 2011-12-04 00:48:23

There are errors on sage.math and on OS X 10.6.8, applied to Sage 4.8.alpha3:

```
sage -t --long "devel/sage/sage/matrix/matrix2.pyx"         
**********************************************************************
File "/Applications/sage_builds/sage-4.8.alpha3/devel/sage/sage/matrix/matrix2.pyx", line 8072:
    sage: G*G.transpose()
Expected:
    [      1 0.?e-37 0.?e-35]
    [0.?e-37       1 0.?e-35]
    [0.?e-35 0.?e-35       1]
Got:
    [      1 0.?e-18 0.?e-19]
    [0.?e-18       1 0.?e-18]
    [0.?e-19 0.?e-18       1]
**********************************************************************
File "/Applications/sage_builds/sage-4.8.alpha3/devel/sage/sage/matrix/matrix2.pyx", line 8087:
    sage: G
Expected:
    [                         -0.3849001794597505?  -0.1924500897298753? - 0.1924500897298753?*I   0.3849001794597505? + 0.7698003589195010?*I                          -0.1924500897298753?]
    [-0.06165497274852388? - 0.1387236886841787?*I  0.8188551068163327? - 0.10018933071635130?*I  0.2003786614327026? + 0.05394810115495839?*I  0.02119389688230508? + 0.5028733714801478?*I]
    [  0.3842387256410419? - 0.5694103019142261?*I  0.1416892863096208? - 0.06139779741542298?*I  0.4633778333528464? - 0.01285039016180503?*I  0.02658516588219101? - 0.5373044261814995?*I]
Got:
    [                         -0.3849001794597505?  -0.1924500897298753? - 0.1924500897298753?*I   0.3849001794597505? + 0.7698003589195010?*I                          -0.1924500897298753?]
    [-0.06165497274852388? - 0.1387236886841787?*I  0.8188551068163327? - 0.10018933071635130?*I  0.2003786614327026? + 0.05394810115495839?*I  0.02119389688230508? + 0.5028733714801478?*I]
    [  0.3842387256410419? - 0.5694103019142261?*I   0.1416892863096208? - 0.0613977974154230?*I  0.4633778333528464? - 0.01285039016180503?*I  0.02658516588219101? - 0.5373044261814995?*I]
**********************************************************************
File "/Applications/sage_builds/sage-4.8.alpha3/devel/sage/sage/matrix/matrix2.pyx", line 8091:
    sage: M
Expected:
    [                        5.196152422706632?                                          0                                          0]
    [-3.079201435678004? + 3.464101615137755?*I             19.22286447225071? + 0.?e-37*I                                          0]
    [  4.426352063787131? - 8.66025403784439?*I -5.117362738127481? - 3.502773139275513?*I             7.480012456446966? + 0.?e-35*I]
Got:
    [                        5.196152422706632?                                          0                                          0]
    [-3.079201435678004? + 3.464101615137755?*I             19.22286447225071? + 0.?e-17*I                                          0]
    [  4.426352063787131? - 8.66025403784439?*I -5.117362738127481? - 3.502773139275513?*I             7.480012456446966? + 0.?e-16*I]
**********************************************************************
File "/Applications/sage_builds/sage-4.8.alpha3/devel/sage/sage/matrix/matrix2.pyx", line 8095:
    sage: M*G-A
Expected:
    [            0.?e-37 0.?e-37 + 0.?e-37*I 0.?e-37 + 0.?e-37*I             0.?e-37]
    [0.?e-36 + 0.?e-36*I 0.?e-35 + 0.?e-36*I 0.?e-36 + 0.?e-36*I 0.?e-36 + 0.?e-36*I]
    [0.?e-35 + 0.?e-35*I 0.?e-35 + 0.?e-35*I 0.?e-35 + 0.?e-35*I 0.?e-35 + 0.?e-35*I]
Got:
    [            0.?e-18 0.?e-18 + 0.?e-18*I 0.?e-18 + 0.?e-17*I             0.?e-18]
    [0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-17*I 0.?e-16 + 0.?e-17*I 0.?e-17 + 0.?e-16*I]
    [0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]
**********************************************************************
File "/Applications/sage_builds/sage-4.8.alpha3/devel/sage/sage/matrix/matrix2.pyx", line 8099:
    sage: G*G.conjugate().transpose()
Expected:
    [1.000000000000000? + 0.?e-37*I            0.?e-37 + 0.?e-37*I            0.?e-36 + 0.?e-36*I]
    [           0.?e-37 + 0.?e-37*I 1.000000000000000? + 0.?e-37*I            0.?e-36 + 0.?e-36*I]
    [           0.?e-36 + 0.?e-36*I            0.?e-36 + 0.?e-36*I 1.000000000000000? + 0.?e-35*I]
Got:
    [1.000000000000000? + 0.?e-18*I            0.?e-18 + 0.?e-18*I            0.?e-17 + 0.?e-16*I]
    [           0.?e-18 + 0.?e-18*I 1.000000000000000? + 0.?e-18*I            0.?e-16 + 0.?e-17*I]
    [           0.?e-17 + 0.?e-16*I            0.?e-16 + 0.?e-17*I 1.000000000000000? + 0.?e-16*I]
**********************************************************************
File "/Applications/sage_builds/sage-4.8.alpha3/devel/sage/sage/matrix/matrix2.pyx", line 8130:
    sage: G*G.transpose()
Expected:
    [      1 0.?e-35]
    [0.?e-35       1]
Got:
    [      1 0.?e-18]
    [0.?e-18       1]
**********************************************************************
1 items had failures:
   6 of  68 in __main__.example_97
***Test Failed*** 6 failures.
For whitespace errors, see the file /Users/palmieri/.sage//tmp/matrix2_40831.py
	 [37.9 s]
 
----------------------------------------------------------------------
The following tests failed:


	sage -t --long "devel/sage/sage/matrix/matrix2.pyx"
Total time for all tests: 37.9 seconds
```



---

Comment by jhpalmieri created at 2011-12-04 00:48:23

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-12-04 11:33:16

Replying to [comment:26 jason]:
> and depend on the more widespread release testing to catch it on the platforms we don't have easy access to?

Yes.  If you think a patch looks reasonable and has been tested to some extent, just set it to positive_review.


---

Comment by rbeezer created at 2011-12-04 19:55:21

Replying to [comment:27 jhpalmieri]:
> There are errors on sage.math and on OS X 10.6.8, applied to Sage 4.8.alpha3:

Jason, John, Jeroen - thanks for the attention to this, and the other outstanding linear algebra tickets.  I've been on an (extended) Sage vacation, but I think you are reeling me back in.  ;-)

This does need work.  Fix at #11544 prevents printing from having a side-effect that increases precision over QQbar.  I think this work predates that change.  So it does need work at the moment.

I am building a fresh alpha right now and will try to get on top of outstanding tickets later today.  It'd be great to get a few of thse into 4.8 if it is not too late - I'll be using this stuff in class in the spring with my Sage-enabled textbook and a few of us are working on this CRC linear algebra handbook chapter that will be doctestable.

Thanks,
Rob


---

Comment by rbeezer created at 2011-12-05 05:12:50

Changing status from needs_work to needs_review.


---

Attachment

Oh man, that was painful.  I am really rusty.  Use it or lose it.  But I'm back.

Patch fixes failing doctests over QQbar, mostly by checking small norms on matrices which should be the zero matrix.  A bit brutal, but we don't have `round()` and `zero_at()` for matrices over QQbar.  (Those'd be a nice additions, no?).

I got identical failures on Ubuntu.  Now passing all tests in matrix/matrix2.pyx.  My 4.8.alpha3 has some weirdness (Atlas segfaults), but I think this should be OK.

Thanks for the look, John and Jason.  Off to investigate a few other things.

Rob


---

Comment by jason created at 2011-12-13 15:44:57

Looks good.  Tested on OSX 10.6.8 and passes tests in matrix/*.pyx on sage-4.7.2.alpha3 (+some other patches I've applied)


---

Comment by jason created at 2011-12-13 15:44:57

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-12-16 10:02:36

The commit message of [attachment:trac_10791-gram-schmidt-negative-zero.patch] needs to be updated.


---

Comment by jdemeyer created at 2011-12-16 10:02:36

Changing status from positive_review to needs_work.


---

Attachment

Jeroen,

My mistake - very sorry about that.

I have replaced the problem patch with one containing a commit message.

Rob


---

Comment by rbeezer created at 2011-12-16 16:04:31

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2011-12-17 09:12:05

Resolution: fixed
