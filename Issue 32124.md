# Issue 32124: Actually remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations

Issue created by migration from https://trac.sagemath.org/ticket/32361

Original creator: mkoeppe

Original creation time: 2021-08-10 18:46:44

CC:  vbraun jhpalmieri dimpase

Follow-up from #29585, which forgot to include a crucial commit.

Race conditions are still present in parallel builds:
https://github.com/sagemath/sage/runs/3274951485?check_suite_focus=true

```
  [cython-0.29.21]   user	1m11.995s
  [cython-0.29.21]   sys	0m2.867s
  [cython-0.29.21]   Copying package files from temporary location /sage/local/var/tmp/sage/build/cython-0.29.21/inst to /sage/local
  [cython-0.29.21]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/Cython/__pycache__': File exists
  [cython-0.29.21]   ************************************************************************
  [cython-0.29.21]   Error copying files for cython-0.29.21.
  [cython-0.29.21]   ************************************************************************
```




---

Comment by mkoeppe created at 2021-08-10 19:05:18

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-08-10 19:47:55

the branch field was removed?

I am away from kbds till Sat, so I can review only visually


---

Comment by mkoeppe created at 2021-08-10 19:54:28

... editing mistake
----
New commits:


---

Comment by jhpalmieri created at 2021-08-18 18:38:03

I'd never set `SAGE_SUDO="sudo -E"` before, but now I'm trying it and `pip` is failing to build. In brief experiments, it seems to succeed without this branch.


---

Attachment


---

Comment by jhpalmieri created at 2021-08-18 18:45:21

Just to confirm: if I do `sudo make distclean; ./configure; make toolchain; make pip`, it fails with this branch, succeeds with 9.4.rc2 (assuming that `SAGE_SUDO` is set).


---

Comment by mkoeppe created at 2021-08-22 01:00:49

`sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?

As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.


---

Comment by jhpalmieri created at 2021-09-06 01:05:19

Replying to [comment:7 mkoeppe]:
> `sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?
> 
> As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.

It is still the case that after doing `export SAGE_SUDO="sudo -E"`, then `pip` fails to build.


---

Comment by git created at 2021-09-06 02:53:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-06 02:53:55

Found the mistake, fixed


---

Comment by jhpalmieri created at 2021-09-06 16:29:03

That helps, thanks. In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:

```
Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>
```

(This is again with `SAGE_SUDO` set.)


---

Comment by mkoeppe created at 2021-09-06 18:25:30

Replying to [comment:12 jhpalmieri]:
> In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:
> {{{
> Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>
> }}}

Thanks, I see them too. I'll investigate


---

Comment by git created at 2021-09-06 18:33:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-06 18:35:25

Unchanged with 9.5.beta0 merged (which has #32046)

Also upgrading pip to latest (21.2.4) does not make a difference


---

Comment by mkoeppe created at 2021-09-06 18:38:27

Newer pip issue: https://github.com/pypa/pip/issues/10151


---

Comment by git created at 2021-09-06 18:59:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-06 19:00:36

OK, found a solution. Not a pip bug.


---

Comment by jhpalmieri created at 2021-09-07 02:01:47

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-09-07 02:01:47

Okay, I think it's ready to go. I don't know what else to do to stress-test it.


---

Comment by mkoeppe created at 2021-09-07 02:02:46

Thank you!


---

Comment by vbraun created at 2021-09-13 22:22:35

Resolution: fixed
