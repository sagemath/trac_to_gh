# Issue 32124: Actually remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations

archive/issues_032124.json:
```json
{
    "body": "CC:  @vbraun @jhpalmieri @dimpase\n\nFollow-up from #29585, which forgot to include a crucial commit.\n\nRace conditions are still present in parallel builds:\nhttps://github.com/sagemath/sage/runs/3274951485?check_suite_focus=true\n\n```\n  [cython-0.29.21]   user\t1m11.995s\n  [cython-0.29.21]   sys\t0m2.867s\n  [cython-0.29.21]   Copying package files from temporary location /sage/local/var/tmp/sage/build/cython-0.29.21/inst to /sage/local\n  [cython-0.29.21]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/Cython/__pycache__': File exists\n  [cython-0.29.21]   ************************************************************************\n  [cython-0.29.21]   Error copying files for cython-0.29.21.\n  [cython-0.29.21]   ************************************************************************\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32361\n\n",
    "created_at": "2021-08-10T18:46:44Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Actually remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32124",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @vbraun @jhpalmieri @dimpase

Follow-up from #29585, which forgot to include a crucial commit.

Race conditions are still present in parallel builds:
https://github.com/sagemath/sage/runs/3274951485?check_suite_focus=true

```
  [cython-0.29.21]   user	1m11.995s
  [cython-0.29.21]   sys	0m2.867s
  [cython-0.29.21]   Copying package files from temporary location /sage/local/var/tmp/sage/build/cython-0.29.21/inst to /sage/local
  [cython-0.29.21]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/Cython/__pycache__': File exists
  [cython-0.29.21]   ************************************************************************
  [cython-0.29.21]   Error copying files for cython-0.29.21.
  [cython-0.29.21]   ************************************************************************
```



Issue created by migration from https://trac.sagemath.org/ticket/32361





---

archive/issue_comments_458154.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-10T19:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458154",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_458155.json:
```json
{
    "body": "the branch field was removed?\n\nI am away from kbds till Sat, so I can review only visually",
    "created_at": "2021-08-10T19:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458155",
    "user": "https://github.com/dimpase"
}
```

the branch field was removed?

I am away from kbds till Sat, so I can review only visually



---

archive/issue_comments_458156.json:
```json
{
    "body": "... editing mistake\n----\nNew commits:",
    "created_at": "2021-08-10T19:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458156",
    "user": "https://github.com/mkoeppe"
}
```

... editing mistake
----
New commits:



---

archive/issue_comments_458157.json:
```json
{
    "body": "I'd never set `SAGE_SUDO=\"sudo -E\"` before, but now I'm trying it and `pip` is failing to build. In brief experiments, it seems to succeed without this branch.",
    "created_at": "2021-08-18T18:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458157",
    "user": "https://github.com/jhpalmieri"
}
```

I'd never set `SAGE_SUDO="sudo -E"` before, but now I'm trying it and `pip` is failing to build. In brief experiments, it seems to succeed without this branch.



---

archive/issue_comments_458158.json:
```json
{
    "body": "Attachment [pip-21.1.2.log](tarball://root/attachments/some-uuid/ticket32361/pip-21.1.2.log) by @jhpalmieri created at 2021-08-18 18:38:21",
    "created_at": "2021-08-18T18:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458158",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [pip-21.1.2.log](tarball://root/attachments/some-uuid/ticket32361/pip-21.1.2.log) by @jhpalmieri created at 2021-08-18 18:38:21



---

archive/issue_comments_458159.json:
```json
{
    "body": "Just to confirm: if I do `sudo make distclean; ./configure; make toolchain; make pip`, it fails with this branch, succeeds with 9.4.rc2 (assuming that `SAGE_SUDO` is set).",
    "created_at": "2021-08-18T18:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458159",
    "user": "https://github.com/jhpalmieri"
}
```

Just to confirm: if I do `sudo make distclean; ./configure; make toolchain; make pip`, it fails with this branch, succeeds with 9.4.rc2 (assuming that `SAGE_SUDO` is set).



---

archive/issue_comments_458160.json:
```json
{
    "body": "`sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?\n\nAs `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.",
    "created_at": "2021-08-22T01:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458160",
    "user": "https://github.com/mkoeppe"
}
```

`sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?

As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.



---

archive/issue_comments_458161.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> `sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?\n> \n> As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.\n\nIt is still the case that after doing `export SAGE_SUDO=\"sudo -E\"`, then `pip` fails to build.",
    "created_at": "2021-09-06T01:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458161",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:7 mkoeppe]:
> `sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?
> 
> As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.

It is still the case that after doing `export SAGE_SUDO="sudo -E"`, then `pip` fails to build.



---

archive/issue_comments_458162.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T02:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458162",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458163.json:
```json
{
    "body": "Found the mistake, fixed",
    "created_at": "2021-09-06T02:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458163",
    "user": "https://github.com/mkoeppe"
}
```

Found the mistake, fixed



---

archive/issue_comments_458164.json:
```json
{
    "body": "That helps, thanks. In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:\n\n```\nValue for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>\n```\n\n(This is again with `SAGE_SUDO` set.)",
    "created_at": "2021-09-06T16:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458164",
    "user": "https://github.com/jhpalmieri"
}
```

That helps, thanks. In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:

```
Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>
```

(This is again with `SAGE_SUDO` set.)



---

archive/issue_comments_458165.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:\n> {{{\n> Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>\n> }}}\n\nThanks, I see them too. I'll investigate",
    "created_at": "2021-09-06T18:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458165",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 jhpalmieri]:
> In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:
> {{{
> Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>
> }}}

Thanks, I see them too. I'll investigate



---

archive/issue_comments_458166.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T18:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458166",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458167.json:
```json
{
    "body": "Unchanged with 9.5.beta0 merged (which has #32046)\n\nAlso upgrading pip to latest (21.2.4) does not make a difference",
    "created_at": "2021-09-06T18:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458167",
    "user": "https://github.com/mkoeppe"
}
```

Unchanged with 9.5.beta0 merged (which has #32046)

Also upgrading pip to latest (21.2.4) does not make a difference



---

archive/issue_comments_458168.json:
```json
{
    "body": "Newer pip issue: https://github.com/pypa/pip/issues/10151",
    "created_at": "2021-09-06T18:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458168",
    "user": "https://github.com/mkoeppe"
}
```

Newer pip issue: https://github.com/pypa/pip/issues/10151



---

archive/issue_comments_458169.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T18:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458169",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458170.json:
```json
{
    "body": "OK, found a solution. Not a pip bug.",
    "created_at": "2021-09-06T19:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458170",
    "user": "https://github.com/mkoeppe"
}
```

OK, found a solution. Not a pip bug.



---

archive/issue_comments_458171.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-07T02:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458171",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458172.json:
```json
{
    "body": "Okay, I think it's ready to go. I don't know what else to do to stress-test it.",
    "created_at": "2021-09-07T02:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458172",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, I think it's ready to go. I don't know what else to do to stress-test it.



---

archive/issue_comments_458173.json:
```json
{
    "body": "Thank you!",
    "created_at": "2021-09-07T02:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458173",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_events_029180.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-13T22:22:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32124#event-29180"
}
```



---

archive/issue_comments_458174.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-13T22:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32124",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32124#issuecomment-458174",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
