# Issue 25120: Check python3 syntax without write access

Issue created by migration from Trac.

Original creator: @timokau

Original creation time: 2018-05-13 19:35:49

Currently the python3 syntax tests needs write access to the source directory because it attempts to create `pyc` files in it.

This new implementation of the test instead writes those `pyc` files in a temporary directory. It does pretty much the same as the main function of `py_compile` except that it gives a target file argument (without that the default is in the same directory).


---

Comment by @timokau created at 2018-05-13 19:35:58

Changing status from new to needs_review.


---

Comment by @timokau created at 2018-05-13 19:42:14

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jdemeyer created at 2018-05-14 08:40:02

1. Since we don't need the output file anyway, is it possible to compile to `sys.devnull` instead?

2. Passing the filenames as actual arguments seems safer than embedding the filenames as strings in the script. So I would pass those filenames as before and then use `sys.argv` in the script.


---

Comment by jdemeyer created at 2018-05-14 09:14:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-14 09:50:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-05-14 09:50:22

Replying to [comment:3 jdemeyer]:
> 1. Since we don't need the output file anyway, is it possible to compile to `sys.devnull` instead?

Unfortunately not:

```
Traceback (most recent call last):
  File "<string>", line 7, in <module>
  File "/usr/lib/python3.6/py_compile.py", line 120, in compile
    raise FileExistsError(msg.format(cfile))
FileExistsError: /dev/null is a non-regular file and will be changed into a regular one if import writes a byte-compiled file to it

```


> 2. Passing the filenames as actual arguments seems safer than embedding the filenames as strings in the script. So I would pass those filenames as before and then use `sys.argv` in the script.

Right, changed.
----
New commits:


---

Comment by @timokau created at 2018-05-14 09:50:34

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-05-15 14:28:57

OK, instead of writing the output to a temporary file, you could just compile in memory using this code from `py_compile.compile`:

```
    loader = importlib.machinery.SourceFileLoader('<py_compile>', file)
    source_bytes = loader.get_data(file)
    code = loader.source_to_code(source_bytes, file,
                                 _optimize=optimize)
```



---

Comment by jdemeyer created at 2018-05-15 14:33:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-16 10:06:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-05-16 10:06:28

Changing status from needs_work to needs_review.


---

Comment by @timokau created at 2018-05-16 10:06:28

I amended the implementation to compile in memory like you suggested.
----
New commits:


---

Comment by jdemeyer created at 2018-05-16 10:22:54

This comment should be updated:

```
        # compile all given files into the same temporary file
        # (no write access to the source dir needed)
```

and please spell "syntax" correctly in the commit message


---

Comment by jdemeyer created at 2018-05-16 10:24:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-16 10:41:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-05-16 10:41:55

Done
----
New commits:


---

Comment by @timokau created at 2018-05-16 10:41:55

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-05-16 13:01:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-17 18:53:03

Merge corflict


---

Comment by vbraun created at 2018-05-17 18:53:03

Changing status from positive_review to needs_work.


---

Comment by @timokau created at 2018-05-17 23:23:26

Is there anything I can do to fix that? It auto-merges with 8.3.beta1.


---

Comment by git created at 2018-05-20 22:53:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-05-20 22:53:59

Changing status from needs_work to positive_review.


---

Comment by @timokau created at 2018-05-20 22:53:59

I have rebased on 8.3.beta2.


---

Comment by @timokau created at 2018-05-20 22:55:04

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2018-06-06 15:15:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-07 22:15:08

Resolution: fixed
