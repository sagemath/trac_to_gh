# Issue 12336: Optimize zero test in dict_addition.pyx

archive/issues_012336.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  stumpc5 sage-combinat\n\nThe code currently says:\n\n```\n        a = D[iter(D).next()]\n        if hasattr(a,'parent') and hasattr(a.parent(),'zero'):\n            zero = a.parent().zero()\n        else:\n            zero = 0\n    for_removal = [key for key in D if D[key] == zero]\n    for key in for_removal:\n        del D[key]    \n```\n\nIf it's robust, using `bool(x)` that is `__nonzero__` could be faster.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12508\n\n",
    "created_at": "2012-02-14T13:36:41Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "title": "Optimize zero test in dict_addition.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12336",
    "user": "hivert"
}
```
Assignee: sage-combinat

CC:  stumpc5 sage-combinat

The code currently says:

```
        a = D[iter(D).next()]
        if hasattr(a,'parent') and hasattr(a.parent(),'zero'):
            zero = a.parent().zero()
        else:
            zero = 0
    for_removal = [key for key in D if D[key] == zero]
    for key in for_removal:
        del D[key]    
```

If it's robust, using `bool(x)` that is `__nonzero__` could be faster.

Issue created by migration from https://trac.sagemath.org/ticket/12508





---

archive/issue_comments_145250.json:
```json
{
    "body": "did you do some tests?\n\nWithin Sage, I get\n\nsage: D = dict( (i,i) for i in range(100000) ) \nsage: zero = 0\nsage: %timeit for_removal = [key for key in D if D[key] == zero]\n25 loops, best of 3: 23.2 ms per loop\nsage: %timeit for_removal = [key for key in D if D[key].__nonzero__() ]\n25 loops, best of 3: 36.8 ms per loop\n\nBut calling __nonzero__ in python is much slower than is cython, isn't it?",
    "created_at": "2012-02-14T16:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145250",
    "user": "stumpc5"
}
```

did you do some tests?

Within Sage, I get

sage: D = dict( (i,i) for i in range(100000) ) 
sage: zero = 0
sage: %timeit for_removal = [key for key in D if D[key] == zero]
25 loops, best of 3: 23.2 ms per loop
sage: %timeit for_removal = [key for key in D if D[key].__nonzero__() ]
25 loops, best of 3: 36.8 ms per loop

But calling __nonzero__ in python is much slower than is cython, isn't it?



---

archive/issue_comments_145251.json:
```json
{
    "body": "Replying to [comment:1 stumpc5]:\n> did you do some tests?\n\nActually not Yet... However:\n\n```\nsage: D = dict( (i,i) for i in srange(100000) )\nsage: zero = 0\nsage: %timeit for_removal = [key for key in D if D[key] == zero]\n25 loops, best of 3: 15 ms per loop\nsage: %timeit for_removal = [key for key in D if D[key].__nonzero__() ]\n25 loops, best of 3: 27.5 ms per loop\nsage: %timeit for_removal = [key for key in D if not D[key] ]\n25 loops, best of 3: 8.78 ms per loop\n```\n\nTwo remarks:\n\n- Using sage integer (ie `srange`) is more realistic than python\n  `int`.\n\n- I actually meant `bool(D[key])` which calls implicitely\n  `__nonzero__` in an optimized way, rather than calling explicitely it.\n\nOf course, we still have to check how it behave in Cython.\n\nCheers,\n\nFlorent",
    "created_at": "2012-02-14T19:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145251",
    "user": "hivert"
}
```

Replying to [comment:1 stumpc5]:
> did you do some tests?

Actually not Yet... However:

```
sage: D = dict( (i,i) for i in srange(100000) )
sage: zero = 0
sage: %timeit for_removal = [key for key in D if D[key] == zero]
25 loops, best of 3: 15 ms per loop
sage: %timeit for_removal = [key for key in D if D[key].__nonzero__() ]
25 loops, best of 3: 27.5 ms per loop
sage: %timeit for_removal = [key for key in D if not D[key] ]
25 loops, best of 3: 8.78 ms per loop
```

Two remarks:

- Using sage integer (ie `srange`) is more realistic than python
  `int`.

- I actually meant `bool(D[key])` which calls implicitely
  `__nonzero__` in an optimized way, rather than calling explicitely it.

Of course, we still have to check how it behave in Cython.

Cheers,

Florent



---

archive/issue_comments_145252.json:
```json
{
    "body": ">   - I actually meant `bool(D[key])` which calls implicitely\n>     `__nonzero__` in an optimized way, rather than calling explicitely it.\n\nIf you don't know it, here is what I call by optimized way:\n\n```\nsage: class bla(object):\n....:      def __nonzero__(self): \n....:           print \"bla.__nonzero__ called\"\n....:           return True\n....: \nsage: b = bla()\nsage: if b: print \"ok\"\n....: \nbla.__nonzero__ called\nok\n```\n\nBut:\n\n```\nsage: b.__nonzero__ = lambda self: False\nsage: if b: print \"ok\"\n....: \nbla.__nonzero__ called\nok\n```\n\nSo the lookup in `b.__dict__` is bypassed (see\n[special method lookup](http://docs.python.org/reference/datamodel.html#special-method-lookup-for-new-style-classes)),\nwhich allows for much faster non zero test than calling `__nonzero__`\nexplicitely. I'm pretty sure Cython optimize that too.",
    "created_at": "2012-02-14T20:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145252",
    "user": "hivert"
}
```

>   - I actually meant `bool(D[key])` which calls implicitely
>     `__nonzero__` in an optimized way, rather than calling explicitely it.

If you don't know it, here is what I call by optimized way:

```
sage: class bla(object):
....:      def __nonzero__(self): 
....:           print "bla.__nonzero__ called"
....:           return True
....: 
sage: b = bla()
sage: if b: print "ok"
....: 
bla.__nonzero__ called
ok
```

But:

```
sage: b.__nonzero__ = lambda self: False
sage: if b: print "ok"
....: 
bla.__nonzero__ called
ok
```

So the lookup in `b.__dict__` is bypassed (see
[special method lookup](http://docs.python.org/reference/datamodel.html#special-method-lookup-for-new-style-classes)),
which allows for much faster non zero test than calling `__nonzero__`
explicitely. I'm pretty sure Cython optimize that too.



---

archive/issue_comments_145253.json:
```json
{
    "body": "Changing assignee from sage-combinat to hivert.",
    "created_at": "2012-02-14T20:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145253",
    "user": "hivert"
}
```

Changing assignee from sage-combinat to hivert.



---

archive/issue_comments_145254.json:
```json
{
    "body": "By the way, I didn't put you in cc because I wanted you to fix that. I thought you might be interested in those kind of optimizations. If you want to fix it, please tell me, otherwise I'll do it myself.",
    "created_at": "2012-02-14T20:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145254",
    "user": "hivert"
}
```

By the way, I didn't put you in cc because I wanted you to fix that. I thought you might be interested in those kind of optimizations. If you want to fix it, please tell me, otherwise I'll do it myself.



---

archive/issue_comments_145255.json:
```json
{
    "body": "Replying to [comment:4 hivert]:\n> By the way, I didn't put you in cc because I wanted you to fix that. I thought you might be interested in those kind of optimizations. If you want to fix it, please tell me, otherwise I'll do it myself.\n\nI will look at the special method lookup these days, but go ahead providing a patch if you want (can we always be certain that bool( D[key] ) will indeed return what we want it to return? ).",
    "created_at": "2012-02-14T21:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145255",
    "user": "stumpc5"
}
```

Replying to [comment:4 hivert]:
> By the way, I didn't put you in cc because I wanted you to fix that. I thought you might be interested in those kind of optimizations. If you want to fix it, please tell me, otherwise I'll do it myself.

I will look at the special method lookup these days, but go ahead providing a patch if you want (can we always be certain that bool( D[key] ) will indeed return what we want it to return? ).



---

archive/issue_comments_145256.json:
```json
{
    "body": "Replying to [comment:5 stumpc5]:\n> can we always be certain that bool( D[key] ) will indeed return what we want it to return?\n\nIt's Python's specification, so it definitely should return what we want. Now the best way to be sure that it does is to add it in the generic tests for object in the category `FreeModules()`. Since now, thanks to Simon all rings conform with categories, adding a test here should catch all problems.",
    "created_at": "2012-02-15T08:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145256",
    "user": "hivert"
}
```

Replying to [comment:5 stumpc5]:
> can we always be certain that bool( D[key] ) will indeed return what we want it to return?

It's Python's specification, so it definitely should return what we want. Now the best way to be sure that it does is to add it in the generic tests for object in the category `FreeModules()`. Since now, thanks to Simon all rings conform with categories, adding a test here should catch all problems.



---

archive/issue_comments_145257.json:
```json
{
    "body": "Replying to [comment:6 hivert]:\n> Replying to [comment:5 stumpc5]:\n> It's Python's specification, so it definitely should return what we want. Now the best way to be sure that it does is to add it in the generic tests for object in the category `FreeModules()`. Since now, thanks to Simon all rings conform with categories, adding a test here should catch all problems.\n\nThings are getting forward, that's great to hear!",
    "created_at": "2012-02-15T08:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145257",
    "user": "stumpc5"
}
```

Replying to [comment:6 hivert]:
> Replying to [comment:5 stumpc5]:
> It's Python's specification, so it definitely should return what we want. Now the best way to be sure that it does is to add it in the generic tests for object in the category `FreeModules()`. Since now, thanks to Simon all rings conform with categories, adding a test here should catch all problems.

Things are getting forward, that's great to hear!



---

archive/issue_comments_145258.json:
```json
{
    "body": "Replying to [comment:7 stumpc5]:\n> Replying to [comment:6 hivert]:\n> > Replying to [comment:5 stumpc5]:\n> > It's Python's specification, so it definitely should return what we want. Now the best way to be sure that it does is to add it in the generic tests for object in the category `FreeModules()`. Since now, thanks to Simon all rings conform with categories, adding a test here should catch all problems.\n> \n> Things are getting forward, that's great to hear!\n\nI just saw this patch in my list, so I give it a ping to see if this was solved somewhere else, or if it is still to be done (most likely by you, Florent ?)...",
    "created_at": "2013-01-02T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145258",
    "user": "stumpc5"
}
```

Replying to [comment:7 stumpc5]:
> Replying to [comment:6 hivert]:
> > Replying to [comment:5 stumpc5]:
> > It's Python's specification, so it definitely should return what we want. Now the best way to be sure that it does is to add it in the generic tests for object in the category `FreeModules()`. Since now, thanks to Simon all rings conform with categories, adding a test here should catch all problems.
> 
> Things are getting forward, that's great to hear!

I just saw this patch in my list, so I give it a ping to see if this was solved somewhere else, or if it is still to be done (most likely by you, Florent ?)...



---

archive/issue_comments_145259.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-23T19:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145259",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_145260.json:
```json
{
    "body": "* `dict_addition.pyx` was deprecated in #20680 in favor of blas.sum\n\n* there one finds `src/sage/data_structures/blas_dict.pyx:    for_removal = [key for key in result if not result[key]]`\n\nSo let us close this ticket now.",
    "created_at": "2018-02-23T19:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145260",
    "user": "chapoton"
}
```

* `dict_addition.pyx` was deprecated in #20680 in favor of blas.sum

* there one finds `src/sage/data_structures/blas_dict.pyx:    for_removal = [key for key in result if not result[key]]`

So let us close this ticket now.



---

archive/issue_comments_145261.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2018-02-23T20:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12336#issuecomment-145261",
    "user": "jdemeyer"
}
```

Resolution: invalid
