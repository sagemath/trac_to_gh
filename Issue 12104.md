# Issue 12104: dvipng fails due to missing jpeg symbols (gd spkg)

Issue created by migration from Trac.

Original creator: mjo

Original creation time: 2012-01-07 03:46:48

Assignee: GeorgSWeber

On machines where the system `gd` is build with jpeg support, `dvipng` will fail with missing symbols:


```
WARNING: display latex u'10^8': dvipng exited with error:
  [stderr]
  dvipng: symbol lookup error: dvipng: undefined symbol:
          gdImageCreateFromJpegPtr 
```


because sage's `gd` is built without jpeg support.

This breaks pretty much all of the reference documentation.

Some potential solutions:

 * Remove the `--without-jpeg` flag from the `gd` spkg
 * Package `dvipng` with sage, and build it against sage's `gd`
 * Don't hide the system `gd` if it's present while building the docs



---

Comment by mjo created at 2013-06-16 17:08:34

Changing priority from major to critical.


---

Comment by mjo created at 2013-06-16 17:08:34

The docs now default to using MathJax, which fixes that problem, but we're traded it for a worse one: I can no longer plot anything.

With a fresh sage-5.10.rc2:


```
sage: plot(sin,x,-1,1)                                          
dvipng: symbol lookup error: dvipng: undefined symbol: gdImageCreateFromJpegPtr
...
RuntimeError: dvipng was not able to process the following file:
/home/mjo/.sage//matplotlib-1.2.1/tex.cache/c97c52e62b093248234a0445c488a218.dvi
Here is the full report generated by dvipng:


```


The error only occurs within sage; if I run dvipng manually (not within `sage -sh`), it works fine. If I run it within `sage -sh`, it crashes with the missing symbols error.

The problem is the same as the original report. You can't expect my dvipng to be built against a gd with the same flags as the one shipped by sage.


---

Comment by mjo created at 2013-06-16 17:20:08

This only occurs when you use latex for the text in the plot. I do that in my init.sage, so to reproduce,

sage --nodotsage


```
sage: from matplotlib import rcParams
sage: rcParams['text.usetex'] = True
sage: plot(sin,x,-1,1)
<boom>
```


See #13543 for why you might want to use a real latex implementation.


---

Comment by leif created at 2013-06-16 17:40:54

Replying to [ticket:12276 mjo]:
> Some potential solutions:
> 
>  * Remove the `--without-jpeg` flag from the `gd` spkg
>  * Package `dvipng` with sage, and build it against sage's `gd`
>  * Don't hide the system `gd` if it's present while building the docs

* Install the optional (currently outdated I guess) jpeg spkg.

* Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).

* Local fix:  Set `RUN_PATH` in the `dvipng` executable... ;-)


---

Comment by leif created at 2013-06-16 17:48:56

Replying to [comment:3 leif]:
> * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).

E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.


---

Comment by vbraun created at 2013-06-17 05:15:29

Please not yet another wrapper script, any external (non-Sage) binaries must be called via `sage-native-execute`. Including dvipng.


---

Comment by mjo created at 2013-06-17 05:29:16

Replying to [comment:5 vbraun]:
> Please not yet another wrapper script, any external (non-Sage) binaries must be called via `sage-native-execute`. Including dvipng.

So this should be fixed in matplotlib or whoever is calling dvipng? The wrapper script would seem to do that without having to patch every caller of dvipng, but I understand not wanting a wrapper script for every binary we use.


---

Comment by leif created at 2013-06-17 14:52:22

Replying to [comment:4 leif]:
> Replying to [comment:3 leif]:
> > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).
> 
> E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.

That was rather meant as an ad-hoc solution for Michael, not that we should ship such a script (although it might turn out to be the easiest solution ;-) ).

(Just like messing with the system's(!) `dvipng`'s `DT_RUNPATH`.)


---

Comment by mjo created at 2013-06-19 12:14:11

Replying to [comment:4 leif]:
> Replying to [comment:3 leif]:
> > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).
> 
> E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.

Interestingly enough, the wrapper script eats up 100% CPU and never terminates.


---

Comment by vbraun created at 2013-06-19 14:58:06

Just to point out the obvious, a script called `dvipng` must exclude itself from the path before calling `dvipng` lest you get an infinite recursion.


---

Comment by leif created at 2013-06-20 00:14:06

Replying to [comment:8 mjo]:
> Replying to [comment:4 leif]:
> > Replying to [comment:3 leif]:
> > > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).
> > 
> > E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.
> 
> Interestingly enough, the wrapper script eats up 100% CPU and never terminates.

That's because `sage-native-execute` does not yet restore the original `PATH`.


---

Comment by jdemeyer created at 2015-09-08 12:48:16

Changing assignee from GeorgSWeber to jdemeyer.


---

Comment by jdemeyer created at 2015-09-08 12:48:16

Changing component from build to packages: standard.


---

Comment by mjo created at 2020-02-08 23:01:01

This is solved to a degree, because the top-level configure script can detect and use the system copy of libgd, which will have whatever symbols the system copy of dvipng needs.


---

Comment by mjo created at 2020-02-08 23:01:01

Changing status from new to needs_review.


---

Comment by mjo created at 2020-02-08 23:01:12

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-02-20 08:30:09

Resolution: invalid
