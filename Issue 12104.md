# Issue 12104: dvipng fails due to missing jpeg symbols (gd spkg)

archive/issues_012104.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nOn machines where the system `gd` is build with jpeg support, `dvipng` will fail with missing symbols:\n\n\n```\nWARNING: display latex u'10^8': dvipng exited with error:\n  [stderr]\n  dvipng: symbol lookup error: dvipng: undefined symbol:\n          gdImageCreateFromJpegPtr \n```\n\n\nbecause sage's `gd` is built without jpeg support.\n\nThis breaks pretty much all of the reference documentation.\n\nSome potential solutions:\n\n* Remove the `--without-jpeg` flag from the `gd` spkg\n* Package `dvipng` with sage, and build it against sage's `gd`\n* Don't hide the system `gd` if it's present while building the docs\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12276\n\n",
    "created_at": "2012-01-07T03:46:48Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "dvipng fails due to missing jpeg symbols (gd spkg)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12104",
    "user": "mjo"
}
```
Assignee: GeorgSWeber

On machines where the system `gd` is build with jpeg support, `dvipng` will fail with missing symbols:


```
WARNING: display latex u'10^8': dvipng exited with error:
  [stderr]
  dvipng: symbol lookup error: dvipng: undefined symbol:
          gdImageCreateFromJpegPtr 
```


because sage's `gd` is built without jpeg support.

This breaks pretty much all of the reference documentation.

Some potential solutions:

* Remove the `--without-jpeg` flag from the `gd` spkg
* Package `dvipng` with sage, and build it against sage's `gd`
* Don't hide the system `gd` if it's present while building the docs


Issue created by migration from https://trac.sagemath.org/ticket/12276





---

archive/issue_comments_140304.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2013-06-16T17:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140304",
    "user": "mjo"
}
```

Changing priority from major to critical.



---

archive/issue_comments_140305.json:
```json
{
    "body": "The docs now default to using MathJax, which fixes that problem, but we're traded it for a worse one: I can no longer plot anything.\n\nWith a fresh sage-5.10.rc2:\n\n\n```\nsage: plot(sin,x,-1,1)                                          \ndvipng: symbol lookup error: dvipng: undefined symbol: gdImageCreateFromJpegPtr\n...\nRuntimeError: dvipng was not able to process the following file:\n/home/mjo/.sage//matplotlib-1.2.1/tex.cache/c97c52e62b093248234a0445c488a218.dvi\nHere is the full report generated by dvipng:\n\n\n```\n\n\nThe error only occurs within sage; if I run dvipng manually (not within `sage -sh`), it works fine. If I run it within `sage -sh`, it crashes with the missing symbols error.\n\nThe problem is the same as the original report. You can't expect my dvipng to be built against a gd with the same flags as the one shipped by sage.",
    "created_at": "2013-06-16T17:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140305",
    "user": "mjo"
}
```

The docs now default to using MathJax, which fixes that problem, but we're traded it for a worse one: I can no longer plot anything.

With a fresh sage-5.10.rc2:


```
sage: plot(sin,x,-1,1)                                          
dvipng: symbol lookup error: dvipng: undefined symbol: gdImageCreateFromJpegPtr
...
RuntimeError: dvipng was not able to process the following file:
/home/mjo/.sage//matplotlib-1.2.1/tex.cache/c97c52e62b093248234a0445c488a218.dvi
Here is the full report generated by dvipng:


```


The error only occurs within sage; if I run dvipng manually (not within `sage -sh`), it works fine. If I run it within `sage -sh`, it crashes with the missing symbols error.

The problem is the same as the original report. You can't expect my dvipng to be built against a gd with the same flags as the one shipped by sage.



---

archive/issue_comments_140306.json:
```json
{
    "body": "This only occurs when you use latex for the text in the plot. I do that in my init.sage, so to reproduce,\n\nsage --nodotsage\n\n\n```\nsage: from matplotlib import rcParams\nsage: rcParams['text.usetex'] = True\nsage: plot(sin,x,-1,1)\n<boom>\n```\n\n\nSee #13543 for why you might want to use a real latex implementation.",
    "created_at": "2013-06-16T17:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140306",
    "user": "mjo"
}
```

This only occurs when you use latex for the text in the plot. I do that in my init.sage, so to reproduce,

sage --nodotsage


```
sage: from matplotlib import rcParams
sage: rcParams['text.usetex'] = True
sage: plot(sin,x,-1,1)
<boom>
```


See #13543 for why you might want to use a real latex implementation.



---

archive/issue_comments_140307.json:
```json
{
    "body": "Replying to [ticket:12276 mjo]:\n> Some potential solutions:\n> \n>  * Remove the `--without-jpeg` flag from the `gd` spkg\n>  * Package `dvipng` with sage, and build it against sage's `gd`\n>  * Don't hide the system `gd` if it's present while building the docs\n\n* Install the optional (currently outdated I guess) jpeg spkg.\n\n* Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).\n\n* Local fix:  Set `RUN_PATH` in the `dvipng` executable... ;-)",
    "created_at": "2013-06-16T17:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140307",
    "user": "leif"
}
```

Replying to [ticket:12276 mjo]:
> Some potential solutions:
> 
>  * Remove the `--without-jpeg` flag from the `gd` spkg
>  * Package `dvipng` with sage, and build it against sage's `gd`
>  * Don't hide the system `gd` if it's present while building the docs

* Install the optional (currently outdated I guess) jpeg spkg.

* Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).

* Local fix:  Set `RUN_PATH` in the `dvipng` executable... ;-)



---

archive/issue_comments_140308.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).\n\nE.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng \"$`@`\"`.",
    "created_at": "2013-06-16T17:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140308",
    "user": "leif"
}
```

Replying to [comment:3 leif]:
> * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).

E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.



---

archive/issue_comments_140309.json:
```json
{
    "body": "Please not yet another wrapper script, any external (non-Sage) binaries must be called via `sage-native-execute`. Including dvipng.",
    "created_at": "2013-06-17T05:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140309",
    "user": "vbraun"
}
```

Please not yet another wrapper script, any external (non-Sage) binaries must be called via `sage-native-execute`. Including dvipng.



---

archive/issue_comments_140310.json:
```json
{
    "body": "Replying to [comment:5 vbraun]:\n> Please not yet another wrapper script, any external (non-Sage) binaries must be called via `sage-native-execute`. Including dvipng.\n\nSo this should be fixed in matplotlib or whoever is calling dvipng? The wrapper script would seem to do that without having to patch every caller of dvipng, but I understand not wanting a wrapper script for every binary we use.",
    "created_at": "2013-06-17T05:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140310",
    "user": "mjo"
}
```

Replying to [comment:5 vbraun]:
> Please not yet another wrapper script, any external (non-Sage) binaries must be called via `sage-native-execute`. Including dvipng.

So this should be fixed in matplotlib or whoever is calling dvipng? The wrapper script would seem to do that without having to patch every caller of dvipng, but I understand not wanting a wrapper script for every binary we use.



---

archive/issue_comments_140311.json:
```json
{
    "body": "Replying to [comment:4 leif]:\n> Replying to [comment:3 leif]:\n> > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).\n> \n> E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng \"$`@`\"`.\n\nThat was rather meant as an ad-hoc solution for Michael, not that we should ship such a script (although it might turn out to be the easiest solution ;-) ).\n\n(Just like messing with the system's(!) `dvipng`'s `DT_RUNPATH`.)",
    "created_at": "2013-06-17T14:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140311",
    "user": "leif"
}
```

Replying to [comment:4 leif]:
> Replying to [comment:3 leif]:
> > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).
> 
> E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.

That was rather meant as an ad-hoc solution for Michael, not that we should ship such a script (although it might turn out to be the easiest solution ;-) ).

(Just like messing with the system's(!) `dvipng`'s `DT_RUNPATH`.)



---

archive/issue_comments_140312.json:
```json
{
    "body": "Replying to [comment:4 leif]:\n> Replying to [comment:3 leif]:\n> > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).\n> \n> E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng \"$`@`\"`.\n\nInterestingly enough, the wrapper script eats up 100% CPU and never terminates.",
    "created_at": "2013-06-19T12:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140312",
    "user": "mjo"
}
```

Replying to [comment:4 leif]:
> Replying to [comment:3 leif]:
> > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).
> 
> E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.

Interestingly enough, the wrapper script eats up 100% CPU and never terminates.



---

archive/issue_comments_140313.json:
```json
{
    "body": "Just to point out the obvious, a script called `dvipng` must exclude itself from the path before calling `dvipng` lest you get an infinite recursion.",
    "created_at": "2013-06-19T14:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140313",
    "user": "vbraun"
}
```

Just to point out the obvious, a script called `dvipng` must exclude itself from the path before calling `dvipng` lest you get an infinite recursion.



---

archive/issue_comments_140314.json:
```json
{
    "body": "Replying to [comment:8 mjo]:\n> Replying to [comment:4 leif]:\n> > Replying to [comment:3 leif]:\n> > > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).\n> > \n> > E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng \"$`@`\"`.\n> \n> Interestingly enough, the wrapper script eats up 100% CPU and never terminates.\n\nThat's because `sage-native-execute` does not yet restore the original `PATH`.",
    "created_at": "2013-06-20T00:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140314",
    "user": "leif"
}
```

Replying to [comment:8 mjo]:
> Replying to [comment:4 leif]:
> > Replying to [comment:3 leif]:
> > > * Make sure `dvipng` isn't called with Sage's environment set up (`LD_LIBRARY_PATH`; use `sage-native-execute` or whatever).
> > 
> > E.g. create a wrapper script `$SAGE_LOCAL/bin/dvipng` that calls `sage-native-execute dvipng "$`@`"`.
> 
> Interestingly enough, the wrapper script eats up 100% CPU and never terminates.

That's because `sage-native-execute` does not yet restore the original `PATH`.



---

archive/issue_comments_140315.json:
```json
{
    "body": "Changing assignee from GeorgSWeber to jdemeyer.",
    "created_at": "2015-09-08T12:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140315",
    "user": "jdemeyer"
}
```

Changing assignee from GeorgSWeber to jdemeyer.



---

archive/issue_comments_140316.json:
```json
{
    "body": "Changing component from build to packages: standard.",
    "created_at": "2015-09-08T12:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140316",
    "user": "jdemeyer"
}
```

Changing component from build to packages: standard.



---

archive/issue_comments_140317.json:
```json
{
    "body": "This is solved to a degree, because the top-level configure script can detect and use the system copy of libgd, which will have whatever symbols the system copy of dvipng needs.",
    "created_at": "2020-02-08T23:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140317",
    "user": "mjo"
}
```

This is solved to a degree, because the top-level configure script can detect and use the system copy of libgd, which will have whatever symbols the system copy of dvipng needs.



---

archive/issue_comments_140318.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-08T23:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140318",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_140319.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-08T23:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140319",
    "user": "mjo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_140320.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-02-20T08:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12104",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12104#issuecomment-140320",
    "user": "chapoton"
}
```

Resolution: invalid
