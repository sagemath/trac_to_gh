# Issue 10481: Generation of subsets and partitions enumerated sets

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2010-12-30 16:27:16

Assignee: vdelecroix

CC:  sage-combinat

Keywords: generation, combinatorics, set, subset, partition

This ticket stands for a faster implementation of subset and partition generation of (finite or infinite) enumerated sets.

The timing for anything related to Sage sage.combinat.Subwords, sage.combinat.Subsets, sage.combinat.SetPartitions, ... are very slow. The roadmap is as follows

1) *Low level generation:* Implement a small python extension which must be as performant as itertools is


```
sage: import itertools
sage: list(itertools.combinations(['a','b','c'],2))
[('a', 'b'), ('a', 'c'), ('b', 'c')]
```


The following will be available:

 * subset of given size
 * all subsets
 * set partitions with given integer combination
 * all set partitions

And for each of them different order of generation (lex, revlex, Gray codes, ...) and output as list or tuple.

Any Suggested names for iterators?

combinations_lex_as_list, combinations_lex_as_tuple combinations_revlex_as_

2) *Include and interface it with Sage:* this won't be hard.

REFERENCES:

 * Knuth TAOCP fascicule 3a
 * Python C API http://docs.python.org/c-api/


---

Comment by vdelecroix created at 2011-04-05 13:32:54

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2011-04-29 20:52:55

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2011-05-27 17:20:27

Remove assignee vdelecroix.


---

Comment by vdelecroix created at 2011-05-27 17:27:54

Set assignee to vdelecroix.


---

Comment by vdelecroix created at 2011-06-02 10:39:56

Changing status from needs_work to needs_review.


---

Comment by hivert created at 2011-06-02 16:21:08

Hi Vincent,

Your patch looks good except a few remarks:

 - the field Author below is for credits. You should put your real name and
   not your login.

 - the documentation now says:
    {{{
    [...]
    The elements of the output are tuples of Python int (and not Sage Integer).
    [...]
    It's element are returned as plain list of python int.
    }}}
    At least one of those two sentences is wrong. Also they seems a little
    redundent. This should be fixed.

I'm sorry for not having the time to put a review patch, nor finish the review
now.


---

Comment by vdelecroix created at 2011-06-03 13:08:12

>  - the field Author below is for credits. You should put your real name and
>    not your login.

Thank you for modifying this.

>  - the documentation now says:
>     {{{
>     [...]
>     The elements of the output are tuples of Python int (and not Sage Integer).
>     [...]
>     It's element are returned as plain list of python int.
>     }}}

That's right. Output value are now tuples and it is fully specified.


---

Attachment

Hi Vincent,

I need more time to review your long patch. I just notice the following:

```
file: sage/combinat/choose_nk.py
85	            sage: [0,2] in c52   # trac XXXX 
```

You probably want to replace XXXX by an actual number. I'll continue my review tomorrow (hopefully)

Florent


---

Comment by vdelecroix created at 2011-06-16 12:30:17

Hi Florent

> I need more time to review your long patch. 

Certainly. Thanks for the review.

I have three important design questions relative to that patch and the Combinatorial classes which it modify
  * should the attributes of a CombinatorialClass be visible like S.w or do we prefer S._w (some code in graphs uses a direct call to S.w) ?
  * what should be the inheritance/relations between say Subsets (subset of a given set) and Subsets_k (subset of size k of a given set) ?
  * what should be the output of Subwords ? tuple, list, strings, any user defined type ? Actually, if you initialize it with list (resp. tuple, string) it output lists (resp. tuple, string). 

> I just notice the following:
> {{{
> file: sage/combinat/choose_nk.py
> 85	            sage: [0,2] in c52   # trac XXXX 
> }}}
> You probably want to replace XXXX by an actual number.

Done


---

Comment by ncohen created at 2012-01-29 15:47:52

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2012-04-29 19:35:16

Nathan, you should be more explicit when asking for more info...


---

Comment by vdelecroix created at 2012-04-29 19:42:14

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2012-05-25 12:27:14

I update the file to make it works on sage-5.0. I will update the corresponding patch in the combinat queue.


---

Comment by chapoton created at 2012-07-11 10:01:31

This code breaks a test in polytopes.parallelotope, because this last procedure calls Combinations and expect to receive a list and not a tuple. This has to be cured, maybe by inserting a list() at the appropriate place in this procedure. Please test that the correction works before uploading a new patch.

Please also remove all trailing whitespaces, see the bot report.


---

Comment by chapoton created at 2012-07-16 14:06:27

Here is a minimal example of what goes wrong in polytopes.parallelotope :


```
sage: g=[ vector([1,0]), vector([0,1])]
sage: Combinations(g)
```


This is a mutability/hash problem, when trying to convert a multiset in a set, apparently..


---

Comment by vdelecroix created at 2012-07-20 11:12:00

Replying to [comment:19 chapoton]:
> Here is a minimal example of what goes wrong in polytopes.parallelotope :
> 
> {{{
> sage: g=[ vector([1,0]), vector([0,1])]
> sage: Combinations(g)
> }}}
> 
> This is a mutability/hash problem, when trying to convert a multiset in a set, apparently..

In the above example, the command fails because the *vector* is not hashable.


---

Attachment


---

Comment by vdelecroix created at 2012-07-20 11:38:12

I correct the error and add the ticket number on the first line of the patch (as asked by the patchbot).


---

Comment by chapoton created at 2012-08-27 18:56:18

Apply only:

  * trac_10534-generation_of_subsets_and_set_partitions.3.patch


---

Attachment


---

Comment by chapoton created at 2012-08-31 19:29:39

new patch, to ensure 100% doctest


---

Comment by emchennyc created at 2012-11-03 22:03:30

I got 100% doctest coverage for all the edited files but there was one warning. If someone doesn't mind explaining what is the significance of this, that would be helpful.
--------------------------------------------------------------------------
SCORE /Applications/sage/devel/sage-main/sage/combinat/subset.py: 100% (33 of 33)

Possibly wrong (function name doesn't occur in doctests):
	 * _element_constructor_(self, x):
	 * _element_constructor_(self, x):
-------------------------------------------------------------------------

Also, "devel/sage/sage/tests/interrupt.pyx" timed out when I ran the long doctests.


---

Comment by vdelecroix created at 2012-11-04 18:44:32

> --------------------------------------------------------------------------
> SCORE /Applications/sage/devel/sage-main/sage/combinat/subset.py: 100% (33 of 33)
> 
> Possibly wrong (function name doesn't occur in doctests):
> 	 * _element_constructor_(self, x):
> 	 * _element_constructor_(self, x):

This is because the methods _element_constructor_(self, x) are not directly tested. There should be a comment "# indirect doctest" after the corresponding test. Basically, this function is used to build an element of a parent, but it is called through the method __call__ of the parent (which is implemented in Parent).

> Also, "devel/sage/sage/tests/interrupt.pyx" timed out when I ran the long doctests.

This is much more ennoying and I do not know why.


---

Comment by ncohen created at 2013-03-24 19:37:07

Helloooooooooooooooo !!!

While I read your patch, two things :
* an "It's" should become an "its"
* why do you change the ouput type from lists to tuples ?

Btw, sorry I did not answer your comment many months ago, I may have missed the warning from trac : I had set the ticket to `needs_info` because you seemed to be asking rather fundamental questions which would have had an impact on the patch, so that it would have been a pity to review the patch if you intended to change it so much later.

Have you had an answer from Florent since ?

Nathann


---

Comment by vdelecroix created at 2013-06-03 18:48:15

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2014-06-06 12:26:59

Hello,

I have made a branch from the latest patch, but only partially. I have not touched the files `set_partition` and `set_partition_ordered`. 

Maybe one could just try to get this smaller changes in ?

----
New commits:


---

Comment by vdelecroix created at 2014-06-06 14:13:39

Hi,

You deserve a necromancy badge ;-) I gave up on that ticket since Travis was refactoring a lot in `sage.combinat.*`. It definitely makes sense to have at least a portion of it. I will have a look.

Vincent


---

Comment by vdelecroix created at 2014-06-06 19:21:33

Ok. From the commit you proposed, I think we could
- deprecate `ChooseNK` and `SplitNK` as it is used nowhere and subsumed by subsets and set partitions.
- do some more cleaning in `combination.py`, `subset.py` and `subwords.py`:
    - remove the inheritance from `CombinatorialClass` and make them inherit from `Parent`. We would set the category to `EnumeratedSets().Finite()`
    - better iteration
    - make `Subwords` work with words as input
      {{{
      sage: Subwords(Word([1,2,3,4,5]))
      Traceback (most recent call last):
      ...
      ValueError: datatype should be str, list or tuple
      }}}
    - etc
If you agree with this, I can modify the ticket description and propose a commit.

Vincent


---

Comment by tscrim created at 2014-06-06 19:47:49

Replying to [comment:32 vdelecroix]:
> You deserve a necromancy badge ;-) I gave up on that ticket since Travis was refactoring a lot in `sage.combinat.*`. It definitely makes sense to have at least a portion of it. I will have a look.

I don't really have time right now to keep going through that, as much as I'd like to. +1 on getting this in. I don't remember if I had any (partial) removal of `CombinatorialClass` in `combination.py`, `subset.py`, or `subwords.py` to give as a starting point, but I don't think I did. However if you have any problems with doing this, I might have some answers so feel free to ask.

Best,

Travis


---

Comment by git created at 2014-06-06 19:57:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-06-06 19:59:07

I have made a clean-up commit, changin only small details such as raise syntax and so on. I will now stop working on that.

I agree with the changes that you propose. I hope there will be no merge problem with my stupid clean-up commit..


---

Comment by vdelecroix created at 2014-06-06 21:20:36

I have some more to push on subsets and subwords... but for tomorrow ;-)
----
New commits:


---

Comment by chapoton created at 2014-06-07 06:50:53

There are some doctest continuation `...` that should be replaced by `....:`


---

Comment by git created at 2014-06-07 12:38:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-07 15:30:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-06-07 15:33:36

Very cool... now we can do

```
sage: S = Subsets(Subsets(Subsets(3)))
sage: S.cardinality()
115792089237316195423570985008687907853269984665640564039457584007913129639936
sage: S.unrank(14321093401985)
`1, 3}, {3}}, {{2}, {3}, {1, 2}, {2, 3}, {1, 3}, {1, 2, 3}}, {{1, 3}, {2}, {2, 3}, {}, {3}}, {{2}}, {}, {{1, 3}, {1, 2}, {2}, {3}}, {{2}, {1}}, {{1, 2}, {2}, {1`
sage: S.random_element()
...
```

(so I updated the tutorial which had before a `#long time` for that kind of examples). And moreover no `CombinatorialClass` anymore.

Needs review!

Vincent


---

Comment by vdelecroix created at 2014-06-07 15:33:36

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-06-07 18:59:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-12 16:30:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-06-12 16:38:54

Hey Vincent, I've gone through and it looks good (I tried to change the `element_class` workaround, but `Set_object_enumerated` is actually a subclass of `Parent` causing layout conflicts...uggg). I've made some minor tweaks and changed the strings to the python 3 `format`. If you're happy with my changes, then positive review. Other things (like removing `CombinatorialClass` from `Combinations` and the `element_class` thing) can be on followups.


---

Comment by vdelecroix created at 2014-06-12 16:49:06

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2014-06-12 16:49:06

Replying to [comment:46 tscrim]:
> Hey Vincent, I've gone through and it looks good (I tried to change the `element_class` workaround, but `Set_object_enumerated` is actually a subclass of `Parent` causing layout conflicts...uggg). I've made some minor tweaks and changed the strings to the python 3 `format`. If you're happy with my changes, then positive review. Other things (like removing `CombinatorialClass` from `Combinations` and the `element_class` thing) can be on followups.

Thanks for your contribution on this!

Vincent


---

Comment by vbraun created at 2014-06-14 20:05:13

Merge failure due to #16067


---

Comment by vbraun created at 2014-06-14 20:06:45

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-06-14 20:24:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-06-14 20:25:24

All right. The rebase was rather trivial.


---

Comment by vdelecroix created at 2014-06-14 20:25:24

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-06-15 12:06:01

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-06-15 12:06:01


```
sage -t --long src/sage/misc/sageinspect.py  # 1 doctest failed
```



---

Comment by git created at 2014-06-15 14:57:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-06-15 14:58:20

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-06-15 16:19:51

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-06-15 16:19:51

Try running the testsuite...


---

Comment by tscrim created at 2014-06-15 16:49:11

I did (again):

```
travis`@`travis-sage:~/sage/src/sage/misc$ sage -tp sageinspect.py 
Running doctests with ID 2014-06-15-09-38-19-7033a8ad.
Doctesting 1 file using 4 threads.
sage -t sageinspect.py
    [251 tests, 24.24 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 24.6 seconds
    cpu time: 4.7 seconds
    cumulative wall time: 24.2 seconds
travis`@`travis-sage:~/sage/src/sage/misc$ sage -tp --long sageinspect.py 
Running doctests with ID 2014-06-15-09-40-50-0dd08e9e.
Doctesting 1 file using 4 threads.
sage -t --long sageinspect.py
    [251 tests, 24.16 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 24.5 seconds
    cpu time: 4.7 seconds
    cumulative wall time: 24.2 seconds
```

Is there a failure elsewhere (I also checked the failures that the patchbot reported and those passed)?


---

Comment by vdelecroix created at 2014-06-15 17:27:18

Same problem as in #16472

```
sage -t --long structure/sage_object.pyx
**********************************************************************
File "structure/sage_object.pyx", line 1346, in sage.structure.sage_object.unpickle_all
Failed example:
    sage.structure.sage_object.unpickle_all()  # (4s on sage.math, 2011)
Expected
...
Got:
...
    Failed:
    _class__sage_combinat_choose_nk_ChooseNK__.sobj
    _class__sage_combinat_split_nk_SplitNK_nk__.sobj
```


If the approach with `__setstate__` is more standard then we should go for it here as well.


---

Comment by tscrim created at 2014-06-15 17:41:23

Will you be taking care of it Vincent or do you want me to?


---

Comment by vdelecroix created at 2014-06-15 17:42:07

Replying to [comment:58 tscrim]:
> Will you be taking care of it Vincent or do you want me to?

No, no. I will do it along your lines. Thanks for proposing.


---

Comment by git created at 2014-06-15 19:13:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-06-15 19:14:29

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2014-06-15 19:14:29

Hey Travis,

Please double check that everything is fine.

Vincent


---

Comment by tscrim created at 2014-06-16 05:06:21

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2014-06-16 05:06:21

LGTM. Thanks Vincent.


---

Comment by vbraun created at 2014-06-18 12:00:18

Resolution: fixed
