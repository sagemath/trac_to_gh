# Issue 30860: build/pkgs/gcc/spkg-configure.m4: Fix SAGE_BROKEN_GCC test

Issue created by migration from https://trac.sagemath.org/ticket/31097

Original creator: mkoeppe

Original creation time: 2020-12-22 15:01:35

CC:  dimpase mjo @tobiasdiez @kliem

Code in `build/pkgs/gcc/spkg-configure.m4`, last modified in #30128, tries to use the `configure`-generated file `src/bin/sage-env-config` as part of the `SAGE_BROKEN_GCC` test.

As observed in #30845, this fails on builds from a distclean source tree into a `SAGE_LOCAL` that has an installed `g++`.


---

Comment by mkoeppe created at 2020-12-22 15:28:05

I think the fix could be to just take out the `source sage-env-config`.  In this particular case (`gcc`, `g++` installed in `$SAGE_LOCAL`), the variables `CONFIGURED_CC` etc. are not actually used; and other recent changes to `sage-env` should make it run OK without the `sage-env-config`.


---

Comment by mkoeppe created at 2020-12-22 15:30:24

... please test ...
----
New commits:


---

Comment by mkoeppe created at 2020-12-22 15:30:24

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-12-22 16:34:46

Strange. Even with this ticket included I get
> Checking whether [SageMath](SageMath) should install SPKG gcc...
> bash: /home/runner/work/sage/sage/src/bin/sage-env-config: No such file or directory
> configure: Installing GCC because installed g++ is broken

https://github.com/tobiasdiez/sage/runs/1595724994?check_suite_focus=true


---

Comment by mkoeppe created at 2020-12-22 16:37:20

You forgot to run `bootstrap`.


---

Comment by @tobiasdiez created at 2020-12-22 16:38:55

I don't think so, it's under "Install dependencies".


---

Comment by mkoeppe created at 2020-12-22 16:41:25

You need to change `bootstrap -D` to `bootstrap`


---

Comment by mkoeppe created at 2020-12-22 16:43:17

Or better, go through tox instead of doing things from scratch again


---

Comment by @tobiasdiez created at 2020-12-22 17:03:42

Thanks! That worked. However, now I get:

```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG gcc...
checking for C compiler vendor... gnu
checking whether /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-c++ supports C++11 features with -std=gnu++11... yes
checking for /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-cc option to accept ISO C99... none needed
configure: no suitable system package found for SPKG gcc
checking for the location of crti.o... /usr/share/miniconda/envs/sage-build/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib/../lib
-----------------------------------------------------------------------------
```

so detection is not yet working.


---

Comment by @tobiasdiez created at 2020-12-22 22:13:04

False alarm. It is working for me now! The changes look good to me as well, but I would prefer if somebody else also has a look.


---

Comment by @kliem created at 2021-01-15 07:12:28

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-01-15 07:12:28

I agree, that this locks good.


---

Comment by mkoeppe created at 2021-01-15 18:12:12

Thanks!


---

Comment by vbraun created at 2021-01-24 10:38:05

Resolution: fixed
