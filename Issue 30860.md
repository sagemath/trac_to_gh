# Issue 30860: build/pkgs/gcc/spkg-configure.m4: Fix SAGE_BROKEN_GCC test

archive/issues_030860.json:
```json
{
    "body": "CC:  @dimpase @orlitzky @tobiasdiez @kliem\n\nCode in `build/pkgs/gcc/spkg-configure.m4`, last modified in #30128, tries to use the `configure`-generated file `src/bin/sage-env-config` as part of the `SAGE_BROKEN_GCC` test.\n\nAs observed in #30845, this fails on builds from a distclean source tree into a `SAGE_LOCAL` that has an installed `g++`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31097\n\n",
    "created_at": "2020-12-22T15:01:35Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "build/pkgs/gcc/spkg-configure.m4: Fix SAGE_BROKEN_GCC test",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30860",
    "user": "@mkoeppe"
}
```
CC:  @dimpase @orlitzky @tobiasdiez @kliem

Code in `build/pkgs/gcc/spkg-configure.m4`, last modified in #30128, tries to use the `configure`-generated file `src/bin/sage-env-config` as part of the `SAGE_BROKEN_GCC` test.

As observed in #30845, this fails on builds from a distclean source tree into a `SAGE_LOCAL` that has an installed `g++`.

Issue created by migration from https://trac.sagemath.org/ticket/31097





---

archive/issue_comments_441003.json:
```json
{
    "body": "I think the fix could be to just take out the `source sage-env-config`.  In this particular case (`gcc`, `g++` installed in `$SAGE_LOCAL`), the variables `CONFIGURED_CC` etc. are not actually used; and other recent changes to `sage-env` should make it run OK without the `sage-env-config`.",
    "created_at": "2020-12-22T15:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441003",
    "user": "@mkoeppe"
}
```

I think the fix could be to just take out the `source sage-env-config`.  In this particular case (`gcc`, `g++` installed in `$SAGE_LOCAL`), the variables `CONFIGURED_CC` etc. are not actually used; and other recent changes to `sage-env` should make it run OK without the `sage-env-config`.



---

archive/issue_comments_441004.json:
```json
{
    "body": "... please test ...\n----\nNew commits:",
    "created_at": "2020-12-22T15:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441004",
    "user": "@mkoeppe"
}
```

... please test ...
----
New commits:



---

archive/issue_comments_441005.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-22T15:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441005",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_441006.json:
```json
{
    "body": "Strange. Even with this ticket included I get\n> Checking whether [SageMath](SageMath) should install SPKG gcc...\n> bash: /home/runner/work/sage/sage/src/bin/sage-env-config: No such file or directory\n> configure: Installing GCC because installed g++ is broken\n\nhttps://github.com/tobiasdiez/sage/runs/1595724994?check_suite_focus=true",
    "created_at": "2020-12-22T16:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441006",
    "user": "@tobiasdiez"
}
```

Strange. Even with this ticket included I get
> Checking whether [SageMath](SageMath) should install SPKG gcc...
> bash: /home/runner/work/sage/sage/src/bin/sage-env-config: No such file or directory
> configure: Installing GCC because installed g++ is broken

https://github.com/tobiasdiez/sage/runs/1595724994?check_suite_focus=true



---

archive/issue_comments_441007.json:
```json
{
    "body": "You forgot to run `bootstrap`.",
    "created_at": "2020-12-22T16:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441007",
    "user": "@mkoeppe"
}
```

You forgot to run `bootstrap`.



---

archive/issue_comments_441008.json:
```json
{
    "body": "I don't think so, it's under \"Install dependencies\".",
    "created_at": "2020-12-22T16:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441008",
    "user": "@tobiasdiez"
}
```

I don't think so, it's under "Install dependencies".



---

archive/issue_comments_441009.json:
```json
{
    "body": "You need to change `bootstrap -D` to `bootstrap`",
    "created_at": "2020-12-22T16:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441009",
    "user": "@mkoeppe"
}
```

You need to change `bootstrap -D` to `bootstrap`



---

archive/issue_comments_441010.json:
```json
{
    "body": "Or better, go through tox instead of doing things from scratch again",
    "created_at": "2020-12-22T16:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441010",
    "user": "@mkoeppe"
}
```

Or better, go through tox instead of doing things from scratch again



---

archive/issue_comments_441011.json:
```json
{
    "body": "Thanks! That worked. However, now I get:\n\n```\n-----------------------------------------------------------------------------\nChecking whether SageMath should install SPKG gcc...\nchecking for C compiler vendor... gnu\nchecking whether /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-c++ supports C++11 features with -std=gnu++11... yes\nchecking for /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-cc option to accept ISO C99... none needed\nconfigure: no suitable system package found for SPKG gcc\nchecking for the location of crti.o... /usr/share/miniconda/envs/sage-build/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib/../lib\n-----------------------------------------------------------------------------\n```\n\nso detection is not yet working.",
    "created_at": "2020-12-22T17:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441011",
    "user": "@tobiasdiez"
}
```

Thanks! That worked. However, now I get:

```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG gcc...
checking for C compiler vendor... gnu
checking whether /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-c++ supports C++11 features with -std=gnu++11... yes
checking for /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-cc option to accept ISO C99... none needed
configure: no suitable system package found for SPKG gcc
checking for the location of crti.o... /usr/share/miniconda/envs/sage-build/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib/../lib
-----------------------------------------------------------------------------
```

so detection is not yet working.



---

archive/issue_comments_441012.json:
```json
{
    "body": "False alarm. It is working for me now! The changes look good to me as well, but I would prefer if somebody else also has a look.",
    "created_at": "2020-12-22T22:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441012",
    "user": "@tobiasdiez"
}
```

False alarm. It is working for me now! The changes look good to me as well, but I would prefer if somebody else also has a look.



---

archive/issue_comments_441013.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-15T07:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441013",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_441014.json:
```json
{
    "body": "I agree, that this locks good.",
    "created_at": "2021-01-15T07:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441014",
    "user": "@kliem"
}
```

I agree, that this locks good.



---

archive/issue_comments_441015.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-01-15T18:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441015",
    "user": "@mkoeppe"
}
```

Thanks!



---

archive/issue_comments_441016.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-24T10:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30860#issuecomment-441016",
    "user": "@vbraun"
}
```

Resolution: fixed
