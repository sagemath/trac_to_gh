# Issue 27859: Cached methods with do_pickle=True fail for UniqueRepresentation objects

Issue created by migration from https://trac.sagemath.org/ticket/28096

Original creator: klee

Original creation time: 2019-07-02 07:25:56

CC:  simonking tscrim nbruin

The decorator ``@`cahced_method(do_pickle=True)` is used to make a method to cache the result and the cached result pickled along with the object.

This fails for objects of `UniqueRepresentation` class. It is a consequence of the defective behavior of `UniqueRepresentation` object not putting its state into the pickle.

This ticket solves the problem. A discussion on this issue was in 

https://groups.google.com/forum/#!topic/sage-devel/n7v71cnVTmk


---

Comment by git created at 2019-07-02 07:27:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2019-07-02 07:32:16

Changing status from new to needs_review.


---

Comment by nbruin created at 2019-07-03 05:30:14

We can definitely not turn pickling on by default. See #15692.


---

Comment by klee created at 2019-07-03 05:42:46

This is not about turn pickling on by default. This turns on pickling only for ``@`cached_methods` with **`do_pickle=True`**.


---

Comment by klee created at 2019-07-03 06:04:17

This ticket makes `UniqueRepresentation` objects do what other sage objects do, for pickling cached methods.


---

Comment by git created at 2019-07-03 08:01:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2019-07-03 08:21:29

To a reviewer:

Before this ticket, 

- the cached function attached to cached method with `do_pickle=False` (the default) is not pickled 

- the cached function attached to cached method with `do_pickle=True` is not pickled

With this ticket and before the last commit, 

- the cached function attached to cached method with `do_pickle=False` (the default) is pickled //without the cache//

- the cached function attached to cached method with `do_pickle=True` is pickled with the cache

After the last commit,

- the cached function attached to cached method with `do_pickle=False` (the default) is not pickled

- the cached function attached to cached method with `do_pickle=True` is pickled with the cache 

This last pickling behaviour of `UniqueRepresentation` objects is somewhat halfway between the old pickling behavior of `UniqueRepresentation` objects and that of other sage objects (second behavior).

The last version seems preferable because it does not increase the size of a pickle to keep unnecessary information, namely cached function without the cache.


---

Comment by git created at 2019-07-03 08:37:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-03 08:52:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-03 13:41:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-08-05 08:41:05

After a brief look at the diff, it seems to me that there are many changes that have nothing to do with the purpose of this ticket: You remove `from __future__ import absolute_import` and you have various changes of the following form:

```diff
@@ -167,9 +167,9 @@ class Manifolds(Category_over_base_ring):
 
             TESTS::
 
-                sage: TestSuite(Manifolds(RR).Smooth()).run()
                 sage: Manifolds(RR).Smooth.__module__
                 'sage.categories.manifolds'
+                sage: TestSuite(Manifolds(RR).Smooth()).run()
             """
             return self._with_axiom('Smooth')
 }}}
Why?


---

Comment by klee created at 2019-08-05 11:47:11

Replying to [comment:14 SimonKing]:
> After a brief look at the diff, it seems to me that there are many changes that have nothing to do with the purpose of this ticket: You remove `from __future__ import absolute_import` 

Right. This is nothing to do with the purpose of the ticket. You know that this import statement is not necessary any more since python 2.7. It happens that as I am writing a patch for a ticket, I encounter things to be easily fixed, like obvious typos, docstrings in bad style, unnecessary imports (like the above) and so on. Sometimes I fix them. Other times I pass them.

Is this bad? Do you think I should revert these small changes not related with the purpose of the ticket before I push the commits?

I think if developers do not make such spontaneous fixes, improvement of the overall quality of sage code will get slower.

>> and you have various changes of the following form:
> {{{
> #!diff
> `@``@` -167,9 +167,9 `@``@` class Manifolds(Category_over_base_ring):
>  
>              TESTS::
>  
> -                sage: TestSuite(Manifolds(RR).Smooth()).run()
>                  sage: Manifolds(RR).Smooth.__module__
>                  'sage.categories.manifolds'
> +                sage: TestSuite(Manifolds(RR).Smooth()).run()
>              """
>              return self._with_axiom('Smooth')
>  }}}
> Why?

This (and many others like this) was related with the ticket. Without this reordering, I got doctest failures. But strangely but happily, now with 8.9.beta5, I don't have them any more even without reordering. I will revert back these changes.


---

Comment by git created at 2019-08-05 11:47:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2019-08-05 18:48:51

Replying to [comment:15 klee]:
> Replying to [comment:14 SimonKing]:
> > After a brief look at the diff, it seems to me that there are many changes that have nothing to do with the purpose of this ticket: You remove `from __future__ import absolute_import` 
> 
> Right. This is nothing to do with the purpose of the ticket. You know that this import statement is not necessary any more since python 2.7.

I might be wrong, but I think this is still needed in Python 2.7, as I have recently had to add the statement in one of my own projects to solve a problem that did not exist with Python 3.


---

Comment by git created at 2019-08-05 22:59:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2019-08-05 23:06:39

Replying to [comment:17 gh-mwageringel]:
> Replying to [comment:15 klee]:
> > Replying to [comment:14 SimonKing]:
> > > After a brief look at the diff, it seems to me that there are many changes that have nothing to do with the purpose of this ticket: You remove `from __future__ import absolute_import` 
> > 
> > Right. This is nothing to do with the purpose of the ticket. You know that this import statement is not necessary any more since python 2.7.
> 
> I might be wrong, but I think this is still needed in Python 2.7, as I have recently had to add the statement in one of my own projects to solve a problem that did not exist with Python 3.

Ah, I am wrong. You are right. I had somehow wrong understanding on this matter. I added back the imports.

Thanks!


---

Comment by klee created at 2019-08-09 05:25:43

After studying how cython objects pickling works, I am now more confident that the patch works well as promised.


---

Comment by embray created at 2019-08-13 11:03:06

Before merged I would just want to see the commit history on this ticket cleaned up with a rebase: get rid of all the unnecessary merge commits, and things like "Add back absolute_import".  I can help with that if need be.


---

Comment by git created at 2019-08-13 11:48:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2019-08-27 00:18:38

This ticket deserves more attention. For your info, the branch is python3-safe.


---

Comment by git created at 2019-09-16 07:09:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-12-26 07:54:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2019-12-26 07:56:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-12-26 09:26:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2019-12-26 09:26:27

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-06-18 02:29:46

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-06-18 07:07:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-18 07:18:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2020-06-18 07:24:28

I am not sure if this patch would incur any bad side effects. Experts on `UniqueRepresentation` are welcome to scrutinize.


---

Comment by klee created at 2020-06-18 07:30:42

Changing status from needs_work to needs_review.


---

Comment by klee created at 2020-06-18 07:34:59

In particular, I do not understand Volker's comment in the discussion:

> Not every circularly dependent collection of cython objects can be pickled. Cached values can make the difference between what can and cannot be pickled. So whether or not pickling works can't reliably be tested in that case.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by mkoeppe created at 2022-03-21 19:25:33

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-03-21 19:25:33

needs rebase


---

Comment by git created at 2022-03-22 08:39:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-03-23 01:43:15

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-08-13 00:38:15

rebased
----
New commits:


---

Comment by klee created at 2022-08-13 01:09:06

Thank you. This is long neglected, even by me. Perhaps it may need some revision.


---

Comment by mkoeppe created at 2022-08-13 01:12:05

I ran into an issue with `UniqueRepresentation` in #19195, so I'm taking a look at open related tickets (#25388, #25389, #14167)
