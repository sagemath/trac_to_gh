# Issue 34342: Faster iterator for planar set partitions

archive/issues_034342.json:
```json
{
    "body": "CC:  @srdoty @fchapoton @zabrocki @anneschilling @saliola\n\nKeywords: set partition, diagram algebra\n\nRight now, we iterate through all planar set partitions in `algebras.PlanarPartition` by filtering out the non-planar diagrams. However, this is very inefficient for large values of `n`. We implement a recursive algorithm that works by simply taking the part `{a, b, c, ...}` that contains the largest element and uses the fact that we can form the planar partition by combining the planar set partitions on the remaining sets `{1, ..., a-1}, `{a+1, ..., b-1}`, `...`, which are all independent.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34579\n\n",
    "created_at": "2022-09-24T13:13:22Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Faster iterator for planar set partitions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34342",
    "user": "@tscrim"
}
```
CC:  @srdoty @fchapoton @zabrocki @anneschilling @saliola

Keywords: set partition, diagram algebra

Right now, we iterate through all planar set partitions in `algebras.PlanarPartition` by filtering out the non-planar diagrams. However, this is very inefficient for large values of `n`. We implement a recursive algorithm that works by simply taking the part `{a, b, c, ...}` that contains the largest element and uses the fact that we can form the planar partition by combining the planar set partitions on the remaining sets `{1, ..., a-1}, `{a+1, ..., b-1}`, `...`, which are all independent.

Issue created by migration from https://trac.sagemath.org/ticket/34579





---

archive/issue_comments_486954.json:
```json
{
    "body": "\n```\nsage: %timeit list(planar_diagrams_new(1))\n2.24 \u00b5s \u00b1 21.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100,000 loops each)\nsage: %timeit list(planar_diagrams_new(2))\n54.2 \u00b5s \u00b1 279 ns per loop (mean \u00b1 std. dev. of 7 runs, 10,000 loops each)\nsage: %timeit list(planar_diagrams_new(3))\n590 \u00b5s \u00b1 13.3 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1,000 loops each)\nsage: %timeit list(planar_diagrams_new(4))\n6.05 ms \u00b1 62.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit list(planar_diagrams_new(5))\n69.5 ms \u00b1 1.03 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\nversus old\n\n```\nsage: %timeit list(planar_diagrams(1))\n6.36 \u00b5s \u00b1 38.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100,000 loops each)\nsage: %timeit list(planar_diagrams(2))\n55.4 \u00b5s \u00b1 333 ns per loop (mean \u00b1 std. dev. of 7 runs, 10,000 loops each)\nsage: %timeit list(planar_diagrams(3))\n1.12 ms \u00b1 6.76 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1,000 loops each)\nsage: %timeit list(planar_diagrams(4))\n28.1 ms \u00b1 169 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit list(planar_diagrams(5))\n872 ms \u00b1 5.12 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nSo we already see a 10x speedup on `n=5` (which means planar set partitions on `2n = 10` elements).\n\nThe downsides are that it no longer iterates through the set partitions in order of the number of parts and it is limited by the Python recursion depth.\n\nA similar change could be done with the Temperley-Lieb diagrams by using the `DyckWords` iterator an `to_noncrossing_set_partition()` method, and I expect to lead to a speedup as well.\n----\nNew commits:",
    "created_at": "2022-09-24T13:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486954",
    "user": "@tscrim"
}
```


```
sage: %timeit list(planar_diagrams_new(1))
2.24 µs ± 21.5 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
sage: %timeit list(planar_diagrams_new(2))
54.2 µs ± 279 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
sage: %timeit list(planar_diagrams_new(3))
590 µs ± 13.3 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
sage: %timeit list(planar_diagrams_new(4))
6.05 ms ± 62.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit list(planar_diagrams_new(5))
69.5 ms ± 1.03 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

versus old

```
sage: %timeit list(planar_diagrams(1))
6.36 µs ± 38.8 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
sage: %timeit list(planar_diagrams(2))
55.4 µs ± 333 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
sage: %timeit list(planar_diagrams(3))
1.12 ms ± 6.76 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
sage: %timeit list(planar_diagrams(4))
28.1 ms ± 169 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit list(planar_diagrams(5))
872 ms ± 5.12 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

So we already see a 10x speedup on `n=5` (which means planar set partitions on `2n = 10` elements).

The downsides are that it no longer iterates through the set partitions in order of the number of parts and it is limited by the Python recursion depth.

A similar change could be done with the Temperley-Lieb diagrams by using the `DyckWords` iterator an `to_noncrossing_set_partition()` method, and I expect to lead to a speedup as well.
----
New commits:



---

archive/issue_comments_486955.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-24T13:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486955",
    "user": "@tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_486956.json:
```json
{
    "body": "Looks good, but the definition of \"planar set partition\" is not clear to me. How is this different from noncrossing partitions ?",
    "created_at": "2022-10-02T18:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486956",
    "user": "@fchapoton"
}
```

Looks good, but the definition of "planar set partition" is not clear to me. How is this different from noncrossing partitions ?



---

archive/issue_comments_486957.json:
```json
{
    "body": "They are not different; just an alternative name.",
    "created_at": "2022-10-02T22:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486957",
    "user": "@tscrim"
}
```

They are not different; just an alternative name.



---

archive/issue_comments_486958.json:
```json
{
    "body": "Could it be interesting to use some cache for recursive calls on the same sets ?",
    "created_at": "2022-10-03T04:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486958",
    "user": "@dcoudert"
}
```

Could it be interesting to use some cache for recursive calls on the same sets ?



---

archive/issue_comments_486959.json:
```json
{
    "body": "If this is really the same as noncrossing partitions, it only depends on `n`, up to the unique increasing relabeling.",
    "created_at": "2022-10-03T06:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486959",
    "user": "@fchapoton"
}
```

If this is really the same as noncrossing partitions, it only depends on `n`, up to the unique increasing relabeling.



---

archive/issue_comments_486960.json:
```json
{
    "body": "That is a good idea to increase the speed, but it will significantly increase the memory usage. Right now, I think this only needs to keep roughly the current planar set partition in memory. Your proposal will need to keep all `k < n` set partitions of `n` in memory.",
    "created_at": "2022-10-03T09:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486960",
    "user": "@tscrim"
}
```

That is a good idea to increase the speed, but it will significantly increase the memory usage. Right now, I think this only needs to keep roughly the current planar set partition in memory. Your proposal will need to keep all `k < n` set partitions of `n` in memory.



---

archive/issue_comments_486961.json:
```json
{
    "body": "Just some not-well-cooked ideas:\n\n- would it make sense to use `nauty` for this, if it can provide ?\n\n- you are right about memory. Even if there is only one cached set for each integer n, the size of this set is growing like `~4^n`.\n\n- it seems to me that iterating through Dyck paths and using `to_noncrossing_partition` is not as fast as what you propose here\n\nBut a positive review in the current state in also possible, as it is an improvement, of course.",
    "created_at": "2022-10-06T06:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486961",
    "user": "@fchapoton"
}
```

Just some not-well-cooked ideas:

- would it make sense to use `nauty` for this, if it can provide ?

- you are right about memory. Even if there is only one cached set for each integer n, the size of this set is growing like `~4^n`.

- it seems to me that iterating through Dyck paths and using `to_noncrossing_partition` is not as fast as what you propose here

But a positive review in the current state in also possible, as it is an improvement, of course.



---

archive/issue_comments_486962.json:
```json
{
    "body": "Replying to [comment:7 Fr\u00e9d\u00e9ric Chapoton]:\n> - would it make sense to use `nauty` for this, if it can provide ?\n\nI am not sure what aspects you want to use. If it is enumerating planar graphs, this is done by `plantri` for connected graphs, which are all the same set partition. So I don't see how to get all set partitions from this.\n\n> - it seems to me that iterating through Dyck paths and using `to_noncrossing_partition` is not as fast as what you propose here\n\nThe `to_noncrossing_partition()` can be made a lot better. Even at its current form, it to be much slower than filtering out all Brauer diagrams by checking planarity for any `n > 7`:\n\n```\nsage: TL = algebras.TemperleyLieb(7, QQ.one())\nsage: %time L = [d for d in TL.basis().keys()]\nCPU times: user 572 ms, sys: 41 \u00b5s, total: 572 ms\nWall time: 571 ms\nsage: len(L)\n429\nsage: %time L = [d.to_noncrossing_partition() for d in DyckWords(7)]\nCPU times: user 10.7 ms, sys: 0 ns, total: 10.7 ms\nWall time: 10.6 ms\nsage: DyckWords(7).cardinality()\n429\n\nsage: TL = algebras.TemperleyLieb(8, QQ.one())\nsage: %time L = [d for d in TL.basis().keys()]\nCPU times: user 8.33 s, sys: 0 ns, total: 8.33 s\nWall time: 8.33 s\nsage: len(L)\n1430\nsage: %time L = [d.to_noncrossing_partition() for d in DyckWords(8)]\nCPU times: user 29.3 ms, sys: 0 ns, total: 29.3 ms\nWall time: 29.1 ms\nsage: DyckWords(8).cardinality()\n1430\n```\n\n\nSome small tweaks would be made (separating out the core part of the algorithm into Cython to have it return tuples of tuples), which would likely make the speed disparity even greater.",
    "created_at": "2022-10-06T08:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486962",
    "user": "@tscrim"
}
```

Replying to [comment:7 Frédéric Chapoton]:
> - would it make sense to use `nauty` for this, if it can provide ?

I am not sure what aspects you want to use. If it is enumerating planar graphs, this is done by `plantri` for connected graphs, which are all the same set partition. So I don't see how to get all set partitions from this.

> - it seems to me that iterating through Dyck paths and using `to_noncrossing_partition` is not as fast as what you propose here

The `to_noncrossing_partition()` can be made a lot better. Even at its current form, it to be much slower than filtering out all Brauer diagrams by checking planarity for any `n > 7`:

```
sage: TL = algebras.TemperleyLieb(7, QQ.one())
sage: %time L = [d for d in TL.basis().keys()]
CPU times: user 572 ms, sys: 41 µs, total: 572 ms
Wall time: 571 ms
sage: len(L)
429
sage: %time L = [d.to_noncrossing_partition() for d in DyckWords(7)]
CPU times: user 10.7 ms, sys: 0 ns, total: 10.7 ms
Wall time: 10.6 ms
sage: DyckWords(7).cardinality()
429

sage: TL = algebras.TemperleyLieb(8, QQ.one())
sage: %time L = [d for d in TL.basis().keys()]
CPU times: user 8.33 s, sys: 0 ns, total: 8.33 s
Wall time: 8.33 s
sage: len(L)
1430
sage: %time L = [d.to_noncrossing_partition() for d in DyckWords(8)]
CPU times: user 29.3 ms, sys: 0 ns, total: 29.3 ms
Wall time: 29.1 ms
sage: DyckWords(8).cardinality()
1430
```


Some small tweaks would be made (separating out the core part of the algorithm into Cython to have it return tuples of tuples), which would likely make the speed disparity even greater.



---

archive/issue_comments_486963.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-10-10T12:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486963",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_486964.json:
```json
{
    "body": "ok, let's move forward. I am setting the branch here to positive",
    "created_at": "2022-10-10T12:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486964",
    "user": "@fchapoton"
}
```

ok, let's move forward. I am setting the branch here to positive



---

archive/issue_comments_486965.json:
```json
{
    "body": "Thank you!",
    "created_at": "2022-10-10T23:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486965",
    "user": "@tscrim"
}
```

Thank you!



---

archive/issue_comments_486966.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-10-16T22:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34342#issuecomment-486966",
    "user": "@vbraun"
}
```

Resolution: fixed
