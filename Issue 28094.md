# Issue 28094: AttributeError when computing manifold chart after computing its vector field module

archive/issues_028094.json:
```json
{
    "body": "CC:  @egourgoulhon @embray\n\nKeywords: manifolds\n\nThe following produces an attribute error:\n\n```\nsage: M = Manifold(2, 'M')\nsage: XM = M.vector_field_module()\nsage: X.<x, y> = M.chart()\nTraceback (most recent call last)\n...\nAttributeError: 'VectorFieldModule_with_category' object has no attribute '_known_bases'\n```\n\nObserved with Sage 8.9.beta5, whether py2-based or py3-based,\non Cygwin, Debian, macOS.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28331\n\n",
    "created_at": "2019-08-07T15:55:22Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "AttributeError when computing manifold chart after computing its vector field module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28094",
    "user": "https://github.com/slel"
}
```
CC:  @egourgoulhon @embray

Keywords: manifolds

The following produces an attribute error:

```
sage: M = Manifold(2, 'M')
sage: XM = M.vector_field_module()
sage: X.<x, y> = M.chart()
Traceback (most recent call last)
...
AttributeError: 'VectorFieldModule_with_category' object has no attribute '_known_bases'
```

Observed with Sage 8.9.beta5, whether py2-based or py3-based,
on Cygwin, Debian, macOS.

Issue created by migration from https://trac.sagemath.org/ticket/28331





---

archive/issue_comments_396476.json:
```json
{
    "body": "This error results from incompatible statements from the user. The first one is\n\n```\nsage: XM = M.vector_field_module()\n```\nWhen asked to construct the module of vector fields just after the manifold declaration, in absence of any further information, Sage returns a module over C<sup>oo</sup>(M) that is not free, since this is the generic case. But then the second statement:\n\n```\nsage: X.<x, y> = M.chart()\n```\nimplies that M is parallelizable, since it can be covered by a single chart. The set of vector fields must then be a free module over C<sup>oo</sup>(M).  Hence the incompatibility. \n\nIf one reverses the order of the two statements, then everything is fine:\n\n```\nsage: M = Manifold(2, 'M')\nsage: X.<x, y> = M.chart()\nsage: XM = M.vector_field_module()\nsage: XM\nFree module X(M) of vector fields on the 2-dimensional differentiable manifold M\nsage: XM.category()\nCategory of finite dimensional modules over Algebra of differentiable scalar fields\n on the 2-dimensional differentiable manifold M\n```\nIndeed, when asked for the module of vector fields, Sage knows that it must be a free module, the manifold being manifestly parallelizable. \n\nIf one would like to keep the original order, i.e. create the module of vector fields before the chart, one must set the optional argument `force_free` to `True`:\n\n```\nsage: M = Manifold(2, 'M')\nsage: XM = M.vector_field_module(force_free=True)\nsage: X.<x, y> = M.chart()\nsage: XM\nFree module X(M) of vector fields on the 2-dimensional differentiable manifold M\n```\n\nSo I would say that to avoid the `AttributeError`, one shall return an explicit error message when trying to create a chart, the domain of which is assumed to be not parallelizable.",
    "created_at": "2019-08-07T22:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396476",
    "user": "https://github.com/egourgoulhon"
}
```

This error results from incompatible statements from the user. The first one is

```
sage: XM = M.vector_field_module()
```
When asked to construct the module of vector fields just after the manifold declaration, in absence of any further information, Sage returns a module over C<sup>oo</sup>(M) that is not free, since this is the generic case. But then the second statement:

```
sage: X.<x, y> = M.chart()
```
implies that M is parallelizable, since it can be covered by a single chart. The set of vector fields must then be a free module over C<sup>oo</sup>(M).  Hence the incompatibility. 

If one reverses the order of the two statements, then everything is fine:

```
sage: M = Manifold(2, 'M')
sage: X.<x, y> = M.chart()
sage: XM = M.vector_field_module()
sage: XM
Free module X(M) of vector fields on the 2-dimensional differentiable manifold M
sage: XM.category()
Category of finite dimensional modules over Algebra of differentiable scalar fields
 on the 2-dimensional differentiable manifold M
```
Indeed, when asked for the module of vector fields, Sage knows that it must be a free module, the manifold being manifestly parallelizable. 

If one would like to keep the original order, i.e. create the module of vector fields before the chart, one must set the optional argument `force_free` to `True`:

```
sage: M = Manifold(2, 'M')
sage: XM = M.vector_field_module(force_free=True)
sage: X.<x, y> = M.chart()
sage: XM
Free module X(M) of vector fields on the 2-dimensional differentiable manifold M
```

So I would say that to avoid the `AttributeError`, one shall return an explicit error message when trying to create a chart, the domain of which is assumed to be not parallelizable.



---

archive/issue_comments_396477.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2019-08-07T22:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396477",
    "user": "https://github.com/egourgoulhon"
}
```

Changing priority from major to minor.



---

archive/issue_comments_396478.json:
```json
{
    "body": "Hi Eric, thanks for the explanation that makes complete sense.\n\nTo provide further context to this ticket, no one actually intentionally tried to do things in the order reported.  Rather, we were investigating an unrelated issue where, for some reason, it seems some doctests were being run out of order and/or skipping statements.  So it just happened that this was run by the doctest runner (even though there's no test that actually does this intentionally).\n\nOne could claim \"garbage in, garbage out\".  However, it still seemed like a real bug that we were getting a seemingly random `AttributeError` in this case.\n\nI agree with your assessment that the best thing to do here would be to catch this case and raise a more useful exception.",
    "created_at": "2019-08-12T10:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396478",
    "user": "https://github.com/embray"
}
```

Hi Eric, thanks for the explanation that makes complete sense.

To provide further context to this ticket, no one actually intentionally tried to do things in the order reported.  Rather, we were investigating an unrelated issue where, for some reason, it seems some doctests were being run out of order and/or skipping statements.  So it just happened that this was run by the doctest runner (even though there's no test that actually does this intentionally).

One could claim "garbage in, garbage out".  However, it still seemed like a real bug that we were getting a seemingly random `AttributeError` in this case.

I agree with your assessment that the best thing to do here would be to catch this case and raise a more useful exception.



---

archive/issue_comments_396479.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> Hi Eric, thanks for the explanation that makes complete sense.\n> \n> To provide further context to this ticket, no one actually intentionally tried to do things in the order reported.  Rather, we were investigating an unrelated issue where, for some reason, it seems some doctests were being run out of order and/or skipping statements.  So it just happened that this was run by the doctest runner (even though there's no test that actually does this intentionally).\n> \n> One could claim \"garbage in, garbage out\".  However, it still seemed like a real bug that we were getting a seemingly random `AttributeError` in this case.\n\n\nAgreed.\n\n> \n> I agree with your assessment that the best thing to do here would be to catch this case and raise a more useful exception.\n\n\nOK I'll prepare this.",
    "created_at": "2019-08-12T13:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396479",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:3 embray]:
> Hi Eric, thanks for the explanation that makes complete sense.
> 
> To provide further context to this ticket, no one actually intentionally tried to do things in the order reported.  Rather, we were investigating an unrelated issue where, for some reason, it seems some doctests were being run out of order and/or skipping statements.  So it just happened that this was run by the doctest runner (even though there's no test that actually does this intentionally).
> 
> One could claim "garbage in, garbage out".  However, it still seemed like a real bug that we were getting a seemingly random `AttributeError` in this case.


Agreed.

> 
> I agree with your assessment that the best thing to do here would be to catch this case and raise a more useful exception.


OK I'll prepare this.



---

archive/issue_comments_396480.json:
```json
{
    "body": "To explain further, last week I ran `make ptestlong`\non Cygwin on Windows 7 for the first time\n(on SageMath 8.9.beta5 built from source there).\nIt gave a dozen of failures not observed on other systems.\n\nOne of these failures seemed to boil down to the present example.\n\nIn `src/sage/manifolds/differentiable/vectorfield_module.py`\nwe find the class `VectorFieldModule` with its many methods\nincluding `identity_map` and `zero`.\n\nThe method `identity_map` has tests starting at line 1003:\n\n```\nsage: M = Manifold(2, M)\nsage: XM = M.vector_field_module()\nsage: X.identity_map()\n```\n\nThe method `zero` comes next, with tests starting at line 1023:\n\n```\nsage: M = Manifold(2, M)\nsage: X.<x,y> = M.chart()  # makes M parallelizable\nsage: XM = M.vector_field_module()\nsage: XM.zero()\n```\n\nOne possible explanation to the observed error would be that when running\n\n```\nsage -t src/sage/manifolds/differentiable/vectorfield_module.py\n```\nthe doctest runner skipped the \"repeated\" line\n\n```\nsage: M = Manifold(2, M)\n```\nin the doctests for `zero`, re-using the `M` defined using an\nidentical line in the previous doctest.\n\nIf we figure out exactly what goes wrong, we'll open a targeted ticket.\n\nSorry for the extra work here, maybe no user would ever have typed that.",
    "created_at": "2019-08-12T13:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396480",
    "user": "https://github.com/slel"
}
```

To explain further, last week I ran `make ptestlong`
on Cygwin on Windows 7 for the first time
(on SageMath 8.9.beta5 built from source there).
It gave a dozen of failures not observed on other systems.

One of these failures seemed to boil down to the present example.

In `src/sage/manifolds/differentiable/vectorfield_module.py`
we find the class `VectorFieldModule` with its many methods
including `identity_map` and `zero`.

The method `identity_map` has tests starting at line 1003:

```
sage: M = Manifold(2, M)
sage: XM = M.vector_field_module()
sage: X.identity_map()
```

The method `zero` comes next, with tests starting at line 1023:

```
sage: M = Manifold(2, M)
sage: X.<x,y> = M.chart()  # makes M parallelizable
sage: XM = M.vector_field_module()
sage: XM.zero()
```

One possible explanation to the observed error would be that when running

```
sage -t src/sage/manifolds/differentiable/vectorfield_module.py
```
the doctest runner skipped the "repeated" line

```
sage: M = Manifold(2, M)
```
in the doctests for `zero`, re-using the `M` defined using an
identical line in the previous doctest.

If we figure out exactly what goes wrong, we'll open a targeted ticket.

Sorry for the extra work here, maybe no user would ever have typed that.



---

archive/issue_comments_396481.json:
```json
{
    "body": "Replying to [comment:5 slelievre]:\n> Sorry for the extra work here, maybe no user would ever have typed that.\n\n\nMaybe, maybe not.  I could see it being an easy mistake to make, and throwing unhandled `AttributeError`s from public methods is still a bug no matter what, albeit a minor one in this case :)",
    "created_at": "2019-08-12T13:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396481",
    "user": "https://github.com/embray"
}
```

Replying to [comment:5 slelievre]:
> Sorry for the extra work here, maybe no user would ever have typed that.


Maybe, maybe not.  I could see it being an easy mistake to make, and throwing unhandled `AttributeError`s from public methods is still a bug no matter what, albeit a minor one in this case :)



---

archive/issue_comments_396482.json:
```json
{
    "body": "Replying to [comment:5 slelievre]:\n> \n> One possible explanation to the observed error would be that when running\n> \n> ```\n> sage -t src/sage/manifolds/differentiable/vectorfield_module.py\n> ```\n> the doctest runner skipped the \"repeated\" line\n> \n> ```\n> sage: M = Manifold(2, M)\n> ```\n> in the doctests for `zero`, re-using the `M` defined using an\n> identical line in the previous doctest.\n> \n\n\nWhy should the doctest runner skip this line? `Manifold` has *not* the unique representation property: each call to it, even with the same arguments, generates a different object. In other words, in any Sage session, we have\n\n```\nsage: Manifold(2, 'M') is Manifold(2, 'M')\nFalse\n```",
    "created_at": "2019-08-12T15:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396482",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:5 slelievre]:
> 
> One possible explanation to the observed error would be that when running
> 
> ```
> sage -t src/sage/manifolds/differentiable/vectorfield_module.py
> ```
> the doctest runner skipped the "repeated" line
> 
> ```
> sage: M = Manifold(2, M)
> ```
> in the doctests for `zero`, re-using the `M` defined using an
> identical line in the previous doctest.
> 


Why should the doctest runner skip this line? `Manifold` has *not* the unique representation property: each call to it, even with the same arguments, generates a different object. In other words, in any Sage session, we have

```
sage: Manifold(2, 'M') is Manifold(2, 'M')
False
```



---

archive/issue_comments_396483.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> Replying to [comment:5 slelievre]:\n> > Sorry for the extra work here, maybe no user would ever have typed that.\n\n> \n> Maybe, maybe not.  I could see it being an easy mistake to make, and throwing unhandled `AttributeError`s from public methods is still a bug no matter what, albeit a minor one in this case :)\nAgreed. I'll fix this.",
    "created_at": "2019-08-12T15:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396483",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:6 embray]:
> Replying to [comment:5 slelievre]:
> > Sorry for the extra work here, maybe no user would ever have typed that.

> 
> Maybe, maybe not.  I could see it being an easy mistake to make, and throwing unhandled `AttributeError`s from public methods is still a bug no matter what, albeit a minor one in this case :)
Agreed. I'll fix this.



---

archive/issue_comments_396484.json:
```json
{
    "body": "Replying to [comment:7 egourgoulhon]:\n> \n> Why should the doctest runner skip this line? `Manifold` has *not* the unique representation property: each call to it, even with the same arguments, generates a different object. \n\n\nWell actually, there may be a possible explanation: the function `Manifold` returns objects that belong to classes (like `DifferentiableManifold`) inheriting from `UniqueRepresentation`. It is creating them by using the argument `unique_tag=getrandbits(128)*time()` in `DifferentiableManifold.__init__`, where `getrandbits` is defined in `sage.misc.prandom` (see line 2650 in `src.sage.manifolds.manifold.py`). So in principle, each created object should be unique. If for some reason, the doctest runner returns twice the same value for `getrandbits(128)*time()` (very fast machine + unexpected behavior of `getrandbits` ??), then this could explain the observed behavior... \n\nThe reason why manifold classes inherit from `UniqueRepresentation` is to make pickling work easily, which is required for multithreading parallelization. By working on the pickling, maybe we could get rid of `UniqueRepresentation` (keeping only `WithEqualityById`) and of the `unique_tag` argument.",
    "created_at": "2019-08-12T16:38:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396484",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:7 egourgoulhon]:
> 
> Why should the doctest runner skip this line? `Manifold` has *not* the unique representation property: each call to it, even with the same arguments, generates a different object. 


Well actually, there may be a possible explanation: the function `Manifold` returns objects that belong to classes (like `DifferentiableManifold`) inheriting from `UniqueRepresentation`. It is creating them by using the argument `unique_tag=getrandbits(128)*time()` in `DifferentiableManifold.__init__`, where `getrandbits` is defined in `sage.misc.prandom` (see line 2650 in `src.sage.manifolds.manifold.py`). So in principle, each created object should be unique. If for some reason, the doctest runner returns twice the same value for `getrandbits(128)*time()` (very fast machine + unexpected behavior of `getrandbits` ??), then this could explain the observed behavior... 

The reason why manifold classes inherit from `UniqueRepresentation` is to make pickling work easily, which is required for multithreading parallelization. By working on the pickling, maybe we could get rid of `UniqueRepresentation` (keeping only `WithEqualityById`) and of the `unique_tag` argument.



---

archive/issue_comments_396485.json:
```json
{
    "body": "Interesting--I never would have just guessed that.  I haven't had a chance yet to look into what was going on with the test runner on that machine.  So far all we have to go on is the observed behavior, though it's not behavior I've seen before.\n\nIt's entirely possible that what you wrote here is relevant in this particular case.  I can look into it next time Samuel and I are together.",
    "created_at": "2019-08-13T08:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396485",
    "user": "https://github.com/embray"
}
```

Interesting--I never would have just guessed that.  I haven't had a chance yet to look into what was going on with the test runner on that machine.  So far all we have to go on is the observed behavior, though it's not behavior I've seen before.

It's entirely possible that what you wrote here is relevant in this particular case.  I can look into it next time Samuel and I are together.



---

archive/issue_comments_396486.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-08-13T14:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396486",
    "user": "https://github.com/egourgoulhon"
}
```

New commits:



---

archive/issue_comments_396487.json:
```json
{
    "body": "With the above commit, a `ValueError` is now returned, with a more explicit message:\n\n```\nsage: M = Manifold(2, 'M')\nsage: XM = M.vector_field_module()\nsage: X.<x, y> = M.chart()\nTraceback (most recent call last):\n...\nValueError: the Module X(M) of vector fields on the 2-dimensional\n differentiable manifold M has already been constructed as a\n non-free module, which implies that the 2-dimensional\n differentiable manifold M is not parallelizable and hence cannot\n be the domain of a coordinate chart\n```\nSimilarly, if one attempts to construct a vector frame, while XM is not a free module, one now gets\n\n```\nsage: e = M.vector_frame('e')\nTraceback (most recent call last):\n...\nValueError: the Module X(M) of vector fields on the 2-dimensional\n differentiable manifold M has already been constructed as a\n non-free module and therefore cannot have a basis\n```",
    "created_at": "2019-08-13T14:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396487",
    "user": "https://github.com/egourgoulhon"
}
```

With the above commit, a `ValueError` is now returned, with a more explicit message:

```
sage: M = Manifold(2, 'M')
sage: XM = M.vector_field_module()
sage: X.<x, y> = M.chart()
Traceback (most recent call last):
...
ValueError: the Module X(M) of vector fields on the 2-dimensional
 differentiable manifold M has already been constructed as a
 non-free module, which implies that the 2-dimensional
 differentiable manifold M is not parallelizable and hence cannot
 be the domain of a coordinate chart
```
Similarly, if one attempts to construct a vector frame, while XM is not a free module, one now gets

```
sage: e = M.vector_frame('e')
Traceback (most recent call last):
...
ValueError: the Module X(M) of vector fields on the 2-dimensional
 differentiable manifold M has already been constructed as a
 non-free module and therefore cannot have a basis
```



---

archive/issue_comments_396488.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-13T14:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396488",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396489.json:
```json
{
    "body": "Looks great, thank you.",
    "created_at": "2019-08-14T06:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396489",
    "user": "https://github.com/embray"
}
```

Looks great, thank you.



---

archive/issue_comments_396490.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-14T06:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396490",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396491.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> Looks great, thank you.\n\n\nThanks for the review!",
    "created_at": "2019-08-15T14:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396491",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:13 embray]:
> Looks great, thank you.


Thanks for the review!



---

archive/issue_comments_396492.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-15T20:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28094#issuecomment-396492",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_070728.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-15T20:30:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28094",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28094#event-70728"
}
```
