# Issue 21883: powers of 1 in QQbar

Issue created by migration from https://trac.sagemath.org/ticket/22120

Original creator: dkrenn

Original creation time: 2017-01-02 17:09:56

CC:  cheuberg

The following does not work at the moment:

```
QQbar(1)^QQbar(sqrt(2))
QQ(1)^QQbar(sqrt(3))
ZZ(1)^QQbar(sqrt(5))
```




---

Comment by dkrenn created at 2017-01-02 17:17:48

Changing status from new to needs_review.


---

Comment by dkrenn created at 2017-01-02 17:17:48

Patchbot...please test ;)
----
New commits:


---

Comment by git created at 2017-01-02 17:22:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-01-03 08:25:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2017-01-03 08:27:02

LGTM. Please cross-review my changes and set to `positive_review` provided that a patchbot agrees.


---

Comment by dkrenn created at 2017-01-03 10:04:39

Replying to [comment:6 cheuberg]:
> LGTM. Please cross-review my changes and set to `positive_review` provided that a patchbot agrees.

Thank you for your changes. Patchbot agrees as well.


---

Comment by dkrenn created at 2017-01-03 10:04:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-01-21 16:34:45

Resolution: fixed


---

Comment by vdelecroix created at 2017-01-22 16:38:47

Hello,

What was the rationale for this ticket? I have two objections to it

- In Sage we try to make any binary operation `op(x, y)` works independently of the values of `x` and `y` but only on their parents. This is the base of the whole coercion model. Having `pow(1, x)` works inconditionally is misleading (there are terrible counterexample to my assertion).

- More importantly, the test `my_qqbar_number == QQbar.one()` can be *very* costly. You are possibly forcing an exactification in `QQbar` just to allow a very useless corner case. On sage-7.5.1 we had

```
sage: s = sum(AA(i)**(1/i) for i in range(1,20))
sage: %timeit (s/s) ** 4
10000 loops, best of 3: 55 µs per loop
```

  but with your patch

```
sage: s = sum(AA(i)**(1/i) for i in range(1,20))
sage: (s/s) ** 4  # you can wait ...
```


Looking forward to your answer.

Vincent


---

Comment by dkrenn created at 2017-01-23 19:11:19

Hello Vincent,

Replying to [comment:9 vdelecroix]:
> What was the rationale for this ticket?

`1^my_qqbar_number` is mathematically meaningful.

> - In Sage we try to make any binary operation `op(x, y)` works independently of the values of `x` and `y` but only on their parents. This is the base of the whole coercion model. Having `pow(1, x)` works inconditionally is misleading (there are terrible counterexample to my assertion).

I completely agree that the parent of the output should only be influenced by the parents of the inputs and not its particular values. And, after the patch of this ticket, pow of a QQbar element to a QQbar element is (still) always a QQbar element (unless it is not possible and an error is thrown).

FWIW, as it is implemented now, `pow` and coercions unfortunately do not play well together (only basic stuff, like if there is a direct coercion (i.e. no new parent has to be found), works)

> - More importantly, the test `my_qqbar_number == QQbar.one()` can be *very* costly. You are possibly forcing an exactification in `QQbar` just to allow a very useless corner case. On sage-7.5.1 we had
> {{{
> sage: s = sum(AA(i)**(1/i) for i in range(1,20))
> sage: %timeit (s/s) ** 4
> 10000 loops, best of 3: 55 µs per loop
> }}}
>   but with your patch
> {{{
> sage: s = sum(AA(i)**(1/i) for i in range(1,20))
> sage: (s/s) ** 4  # you can wait ...
> }}}

Oh, indeed, this is a problem and need to be changed.

> just to allow a very useless corner case

I disagree with your "useless". As mentioned, `1` to some QQbar element is mathematically meaningful, and some people care about being able to calculate things.

What about checking if the element is "trivially" `1` (in the same spirit as the symbolic expression's `is_trivial_zero`)? Thus no exactification would be done, but `s=QQbar(1)` would still be recognized.


---

Comment by vdelecroix created at 2017-01-24 08:47:39

Replying to [comment:10 dkrenn]:
> Replying to [comment:9 vdelecroix]:
> What about checking if the element is "trivially" `1` (in the same spirit as the symbolic expression's `is_trivial_zero`)? Thus no exactification would be done, but `s=QQbar(1)` would still be recognized.

Would already be better...

```
from sage.rings.qqbar import ANRational

def is_trivially_one(x):
    descr = x._descr
    return isinstance(descr, ANRational) and descr._value.is_one()
```



---

Comment by dkrenn created at 2017-01-25 08:22:04

Follow-up ticket #22250 created.


---

Comment by dkrenn created at 2017-01-25 08:26:16

Replying to [comment:10 dkrenn]:
> On sage-7.5.1 we had
> > {{{
> > sage: s = sum(AA(i)**(1/i) for i in range(1,20))
> > sage: %timeit (s/s) ** 4
> > 10000 loops, best of 3: 55 µs per loop
> > }}}

I am not sure, what I am doing wrong, but on my 7.5 this already takes ages...


---

Comment by vdelecroix created at 2017-01-25 17:14:08

Replying to [comment:13 dkrenn]:
> Replying to [comment:10 dkrenn]:
> > On sage-7.5.1 we had
> > > {{{
> > > sage: s = sum(AA(i)**(1/i) for i in range(1,20))
> > > sage: %timeit (s/s) ** 4
> > > 10000 loops, best of 3: 55 µs per loop
> > > }}}
> 
> I am not sure, what I am doing wrong, but on my 7.5 this already takes ages...

Which step?


---

Comment by dkrenn created at 2017-01-25 17:40:08

Replying to [comment:14 vdelecroix]:
> Replying to [comment:13 dkrenn]:
> > Replying to [comment:10 dkrenn]:
> > > On sage-7.5.1 we had
> > > > {{{
> > > > sage: s = sum(AA(i)**(1/i) for i in range(1,20))
> > > > sage: %timeit (s/s) ** 4
> > > > 10000 loops, best of 3: 55 µs per loop
> > > > }}}
> > 
> > I am not sure, what I am doing wrong, but on my 7.5 this already takes ages...
> 
> Which step?

Let me reformulate:

```
sage: s = sum(AA(i)**(1/i) for i in range(1,20))
sage: (s/s) ** 4
```

does not give a result within a couple of hours on a fresh 7.5. And I was wondering why?


---

Comment by vdelecroix created at 2017-01-26 12:52:47

What about the traceback after Ctrl-C?

random guess: it might be relative to `_repr_`. You can try `a = (s/s)**4` instead.


---

Comment by dkrenn created at 2017-01-26 13:43:19

Replying to [comment:16 vdelecroix]:
> What about the traceback after Ctrl-C?


```
sage: s = sum(AA(i)**(1/i) for i in range(1,20))
sage: a = (s/s)**4
^C---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)
<ipython-input-2-00135d41d691> in <module>()
----> 1 a = (s/s)**Integer(4)

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in __pow__(self, e)
   4465         d = e.denominator()
   4466         if d == 1:
-> 4467             return generic_power(self, n)
   4468 
   4469         # First, check for exact roots.

/local/dakrenn/sage/7.5/src/sage/structure/element.pyx in sage.structure.element.generic_power (/local/dakrenn/sage/7.5/src/build/cythonized/sage/structure/element.c:27899)()
   4111     """
   4112 
-> 4113     return generic_power_c(a,n,one)
   4114 
   4115 cdef generic_power_c(a, nn, one):

/local/dakrenn/sage/7.5/src/sage/structure/element.pyx in sage.structure.element.generic_power_c (/local/dakrenn/sage/7.5/src/build/cythonized/sage/structure/element.c:28765)()
   4159     # check for idempotence, and store the result otherwise
   4160     aa = a*a
-> 4161     if aa == a:
   4162         return a
   4163 

/local/dakrenn/sage/7.5/src/sage/structure/element.pyx in sage.structure.element.Element.__richcmp__ (/local/dakrenn/sage/7.5/src/build/cythonized/sage/structure/element.c:10359)()
   1121             # an instance of Element. The explicit casts below make
   1122             # Cython generate optimized code for this call.
-> 1123             return (<Element>self)._richcmp_(other, op)
   1124         else:
   1125             return coercion_model.richcmp(self, other, op)

/local/dakrenn/sage/7.5/src/sage/structure/element.pyx in sage.structure.element.Element._richcmp_ (/local/dakrenn/sage/7.5/src/build/cythonized/sage/structure/element.c:10558)()
   1156         cdef int c
   1157         try:
-> 1158             c = left._cmp_(right)
   1159         except NotImplementedError:
   1160             # Check equality by id(), knowing that left is not right

/local/dakrenn/sage/7.5/src/sage/structure/element.pyx in sage.structure.element.Element._cmp_ (/local/dakrenn/sage/7.5/src/build/cythonized/sage/structure/element.c:10947)()
   1172         left_cmp = left.__cmp__
   1173         if isinstance(left_cmp, MethodType):
-> 1174             return left_cmp(right)
   1175         msg = LazyFormat("comparison not implemented for %r")%type(left)
   1176         raise NotImplementedError(msg)

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in __cmp__(self, other)
   4405             return -other.sign()
   4406         else:
-> 4407             return self._sub_(other).sign()
   4408 
   4409     def __pow__(self, e):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in sign(self)
   4734             # OK, we'll try adding precision one more time
   4735             self._more_precision()
-> 4736             return self.sign()
   4737         else:
   4738             # Sigh...

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in sign(self)
   4737         else:
   4738             # Sigh...
-> 4739             self.exactify()
   4740             return self.sign()
   4741 

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7074             left = self._left
   7075             right = self._right
-> 7076             left.exactify()
   7077             right.exactify()
   7078             gen = left._exact_field().union(right._exact_field())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   3269         od = self._descr
   3270         if isinstance(od, (ANRational, ANExtensionElement)): return
-> 3271         self._set_descr(self._descr.exactify())
   3272 
   3273     def _set_descr(self, new_descr):

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in exactify(self)
   7076             left.exactify()
   7077             right.exactify()
-> 7078             gen = left._exact_field().union(right._exact_field())
   7079             left_value = gen(left._exact_value())
   7080             right_value = gen(right._exact_value())

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in union(self, other)
   2408         newpol_sage_y = QQy(newpol_sage)
   2409 
-> 2410         red_elt, red_back, red_pol = do_polred(newpol_sage_y)
   2411 
   2412         red_back_x = QQx(red_back)

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in do_polred(poly)
   1711         (1/4*x, 4*x, x^4 - 268435456*x^2 + 211973662764908353025)
   1712     """
-> 1713     new_poly, elt_back = poly._pari_().polredbest(flag=1)
   1714 
   1715     parent = poly.parent()

/local/dakrenn/sage/7.5/local/lib/python2.7/site-packages/sage/libs/cypari2/auto_gen.pxi in sage.libs.cypari2.gen.gen_auto.polredbest (/local/dakrenn/sage/7.5/src/build/cythonized/sage/libs/cypari2/gen.c:80864)()
  15908         """
  15909         cdef GEN _T = T.g
> 15910         sig_on()
  15911         cdef GEN _ret = polredbest(_T, flag)
  15912         return new_gen(_ret)

src/cysignals/signals.pyx in cysignals.signals.sig_raise_exception (build/src/cysignals/signals.c:1303)()

KeyboardInterrupt: 
```



---

Comment by dkrenn created at 2017-01-26 13:43:38

Replying to [comment:16 vdelecroix]:
> random guess: it might be relative to `_repr_`. You can try `a = (s/s)**4` instead.

Does not seem to change anything.


---

Comment by dkrenn created at 2017-02-08 10:40:01

Dear Vincent,

Replying to [comment:15 dkrenn]:
> Let me reformulate:
> {{{
> sage: s = sum(AA(i)**(1/i) for i in range(1,20))
> sage: (s/s) ** 4
> }}}
> does not give a result within a couple of hours on a fresh 7.5. And I was wondering why?

I've tried to investigate this now: On all systems and Sage-versions (with and without this patch) I've tested it, this takes ages. I have no idea how it could be that fast on your system. Can you maybe repeat the test or do you have any (other) guess what happens?

(The problem is, that the generic pow tests for idempotence `a**2 == a`, which is not possible for our example above.)


---

Comment by jdemeyer created at 2018-01-08 11:22:04

Why special case powers of 1 in `QQbar`? This makes no sense since we don't support `QQbar^QQbar` powering in general. I'd prefer to revert this in #5574 unless somebody gives me a good reason for why this ticket sense.


---

Comment by jdemeyer created at 2018-01-08 11:25:21

Actually, I created #24490 to revert this.
