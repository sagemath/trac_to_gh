# Issue 17139: Cleanup subgraphsearch to avoid crashes

archive/issues_017139.json:
```json
{
    "body": "CC:  @dcoudert @dimpase @jm58660 @videlec simon @tscrim\n\nThe SubgraphSearch code crashes from time to time when you Ctrl+C it during its memory allocation instructions.\n\nThis patch cleans the code a bit so that all allocations happen in one place, before the actual code is run. And so `__dealloc__` only frees the memory that has been allocated, even if the code was interrupted.\n\nBasically, we avoid crashed only with simple code cleaning.\n\n1) In order to produce the crash, run this and CTRL+C it immediately:\n\n\n```\ngraphs.CompleteMultipartiteGraph([20,20,20,20]).subgraph_search(graphs.CompleteGraph(5))\n```\n\n\nDo it several times in a row if necessary.\n\n2) The code could use a rewrite with bitsets. It would be faster and lighter in memory, but there is already a pretty similar code in `needs_review` at #17309 and I fear that it may take time before it is reviewed. So I will wait for this before reimplementing SubgraphSearch.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17376\n\n",
    "created_at": "2014-11-21T16:08:45Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Cleanup subgraphsearch to avoid crashes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17139",
    "user": "https://github.com/nathanncohen"
}
```
CC:  @dcoudert @dimpase @jm58660 @videlec simon @tscrim

The SubgraphSearch code crashes from time to time when you Ctrl+C it during its memory allocation instructions.

This patch cleans the code a bit so that all allocations happen in one place, before the actual code is run. And so `__dealloc__` only frees the memory that has been allocated, even if the code was interrupted.

Basically, we avoid crashed only with simple code cleaning.

1) In order to produce the crash, run this and CTRL+C it immediately:


```
graphs.CompleteMultipartiteGraph([20,20,20,20]).subgraph_search(graphs.CompleteGraph(5))
```


Do it several times in a row if necessary.

2) The code could use a rewrite with bitsets. It would be faster and lighter in memory, but there is already a pretty similar code in `needs_review` at #17309 and I fear that it may take time before it is reviewed. So I will wait for this before reimplementing SubgraphSearch.

Issue created by migration from https://trac.sagemath.org/ticket/17376





---

archive/issue_comments_227545.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-11-21T16:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227545",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_227546.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-11-21T16:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227546",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_227547.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-11-21T16:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227547",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_227548.json:
```json
{
    "body": "I tried the patch multiple times and got no crash, while without the patch I can get a segfault.\n\nInstall OK, long tests OK => positive review.\n\nDavid.\nPS: I'm changing the patch from \"graphics\" to \"graph theory\". It seems more appropriate.",
    "created_at": "2014-11-24T02:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227548",
    "user": "https://github.com/dcoudert"
}
```

I tried the patch multiple times and got no crash, while without the patch I can get a segfault.

Install OK, long tests OK => positive review.

David.
PS: I'm changing the patch from "graphics" to "graph theory". It seems more appropriate.



---

archive/issue_comments_227549.json:
```json
{
    "body": "Changing component from graphics to graph theory.",
    "created_at": "2014-11-24T02:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227549",
    "user": "https://github.com/dcoudert"
}
```

Changing component from graphics to graph theory.



---

archive/issue_comments_227550.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-24T02:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227550",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_227551.json:
```json
{
    "body": "YOooooooooo !\n\n> PS: I'm changing the patch from \"graphics\" to \"graph theory\". It seems more appropriate.\n\nOh, right.\n\nAnd thanks for the review !\n\nNathann",
    "created_at": "2014-11-24T03:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227551",
    "user": "https://github.com/nathanncohen"
}
```

YOooooooooo !

> PS: I'm changing the patch from "graphics" to "graph theory". It seems more appropriate.

Oh, right.

And thanks for the review !

Nathann



---

archive/issue_comments_227552.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-24T16:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17139#issuecomment-227552",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_016560.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2014-11-24T16:00:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17139",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17139#event-16560"
}
```
