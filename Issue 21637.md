# Issue 21637: Make autogen/pari Python 3 compatible

Issue created by migration from https://trac.sagemath.org/ticket/21874

Original creator: jdemeyer

Original creation time: 2016-11-13 22:49:19

CC:  defeo chapoton




---

Comment by chapoton created at 2016-11-14 18:52:40

New commits:


---

Comment by chapoton created at 2016-11-14 18:52:40

Changing status from new to needs_review.


---

Comment by git created at 2016-11-14 19:27:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-11-14 19:27:45

should be good now. Works for python3, not checked for python2.


---

Comment by jdemeyer created at 2016-11-16 12:56:47

Doctest failure, see patchbot.


---

Comment by jdemeyer created at 2016-11-16 12:56:47

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-11-16 13:00:09

The "native" format for filenames is `bytes`. So it seems silly to convert `bytes` to `unicode` and then let Python convert it back to `bytes`. Just drop the `.decode()`.


---

Comment by chapoton created at 2016-11-16 14:16:09

elsewhere in the code, one takes the sum (+) of datadir and a string, so one needs the decode()


---

Comment by git created at 2016-11-16 14:18:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-11-16 14:20:16

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-11-16 14:21:39

Replying to [comment:6 chapoton]:
> elsewhere in the code, one takes the sum (+) of datadir and a string, so one needs the decode()

That string should then also be `bytes`.


---

Comment by jdemeyer created at 2016-11-16 14:21:39

Changing status from needs_review to needs_work.


---

Comment by defeo created at 2016-11-16 14:41:56

> The "native" format for filenames is `bytes`.

Are you sure about this? In Python 3.5


```
>>> import os
>>> type(os.listdir('.')[0])
str
```



---

Comment by jdemeyer created at 2016-11-16 14:45:15

`listdir` outputs `str` when given `str` and `bytes` when given `bytes`:

```
>>> import os
>>> type(os.listdir(b'.')[0])
<class 'bytes'>
```


```
>>> import os
>>> type(os.listdir('.')[0])
<class 'str'>
```



---

Comment by jdemeyer created at 2016-11-16 14:47:58

See https://docs.python.org/3/howto/unicode.html#unicode-filenames

Note the sentence "When opening a file for reading or writing, you can usually just provide the Unicode string as the filename, and it will be automatically converted to the right encoding for you". This means that Python does a conversion of encoding, so it makes sense to use `bytes` for filenames to avoid conversions.


---

Comment by defeo created at 2016-11-16 15:06:05

Replying to [comment:12 jdemeyer]:
> See https://docs.python.org/3/howto/unicode.html#unicode-filenames
> 
> Note the sentence "When opening a file for reading or writing, you can usually just provide the Unicode string as the filename, and it will be automatically converted to the right encoding for you". This means that Python does a conversion of encoding, so it makes sense to use `bytes` for filenames to avoid conversions.

But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.

I do not even dare imagine what would happen with a WIN-1252-encoded fat filesystem mounted inside a ISO-8859 locale (these things can happen with usb keys...).


---

Comment by jdemeyer created at 2016-11-16 15:17:57

Replying to [comment:13 defeo]:
> But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.

If `string` is ASCII, then `string.encode()` should be pretty safe since most encodings map ASCII to ASCII bytes.


---

Comment by defeo created at 2016-11-16 15:20:41

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 defeo]:
> > But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.
> 
> If `string` is ASCII, then `string.encode()` should be pretty safe since most encodings map ASCII to ASCII bytes.

Same goes for `datastring.decode()`, then. I was obviously thinking of the case where they contain non-ASCII characters.


---

Comment by jdemeyer created at 2016-11-16 15:31:00

Replying to [comment:15 defeo]:
> Same goes for `datastring.decode()`, then.

Not if `datastring` refers to a user-chosen path. Then we shouldn't make too many assumptions.


---

Comment by defeo created at 2016-11-16 15:45:40

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 defeo]:
> > Same goes for `datastring.decode()`, then.
> 
> Not if `datastring` refers to a user-chosen path. Then we shouldn't make too many assumptions.

Right. I thought it was the other way around. So where are these `datadir` + `string`? I see one on line 83 of `parser.py`, and there `string` is `pari.desc`, so I agree with you (assuming that gp correctly handles locale encodings). Any other places?


---

Comment by chapoton created at 2016-11-16 16:04:57

I think this is the only place. Could you please handle all this without me ?


---

Comment by git created at 2016-11-16 19:57:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-11-16 19:58:36

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-11-16 19:58:36

ok, here is another try, following Jeroen's suggestion


---

Comment by chapoton created at 2016-11-17 10:02:18

patchbot now gives a green light


---

Comment by jdemeyer created at 2016-11-17 10:07:01

Good for me then.


---

Comment by jdemeyer created at 2016-11-17 10:07:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-11-19 16:34:52

Resolution: fixed
