# Issue 20783: gap/libgap polynomial to Sage

Issue created by migration from https://trac.sagemath.org/ticket/21020

Original creator: vdelecroix

Original creation time: 2016-07-13 20:23:45

CC:  dimpase tscrim

Given a polynomial in gap/libgap it is (most of the time) not possible to get it back into Sage.

Note: the other direction is dealt with in #18266


---

Comment by chapoton created at 2019-01-03 15:55:28

first tentative:

* working conversion of polynomial rings

* not working conversion of polynomials in one variable

I have no idea how to ask Gap for the Ring containing a polynomial..
----
New commits:


---

Comment by dimpase created at 2019-01-03 16:35:08

Replying to [comment:3 chapoton]:
> I have no idea how to ask Gap for the Ring containing a polynomial..
if `f` is your polynomial, then

```
gap> Ring(f);
```

does what you ask.


---

Comment by chapoton created at 2019-01-03 17:58:49

Hmm. Not very clear.. Does not look like a polynomial ring..

```
sage: x=polygen(QQ,'x')
sage: f=x+6
sage: g=libgap(f)
sage: g.Ring()
<ring with 1 generators>
sage: g.Ring().IsPolynomialRing()
false
```



---

Comment by git created at 2019-01-03 19:29:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-03 19:30:10

Here is something that seems to work, even if somewhat ugly.


---

Comment by chapoton created at 2019-01-03 19:30:10

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-01-03 20:03:50

Changing keywords from "" to "libgap".


---

Comment by chapoton created at 2019-01-04 08:56:31

bot is morally green, please review


---

Comment by tscrim created at 2019-01-04 18:27:07

Dima, do you have any other comments? I am ready to set this to a positive review.


---

Comment by dimpase created at 2019-01-05 00:38:31

Can we get doctests for multivariate polynomials? And for different base rings?


---

Comment by chapoton created at 2019-01-05 07:56:59

This will not work for multi-variate polynomials so far.


---

Comment by vdelecroix created at 2019-01-05 08:43:12

1) I think should also be treated at the same time
- (univariate) rational functions
- (univariate) laurent polynomials

2) Instead of going through the coercion system in Sage you should just query gap base ring (function [CoefficientsRing](https://www.gap-system.org/Manuals/doc/ref/chap66.html#X8235D10781BE8003)).


---

Comment by vdelecroix created at 2019-01-05 08:43:12

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-01-05 08:44:16

By all ways, please do that! I have zero knowledge of gap, essentially.


---

Comment by dimpase created at 2019-01-05 08:48:02

Replying to [comment:14 chapoton]:
> This will not work for multi-variate polynomials so far.

There is code in this branch added for multivariate polynomial rings, so it was quite unclear why no examples for treating multivariate polynomials...


---

Comment by vdelecroix created at 2019-01-05 08:53:33

Replying to [comment:16 chapoton]:
> By all ways, please do that! I have zero knowledge of gap, essentially.

I am working on a commit.


---

Comment by vdelecroix created at 2019-01-05 10:07:32

Contrarily to what I thought, it seems not possible to extract the common ring of the coefficients from GAP. I kept the "common_parent".

Now works with (univriate) Laurent polynomials and rational functions.

Needs review again.
----
New commits:


---

Comment by vdelecroix created at 2019-01-05 10:07:32

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-01-05 10:56:34

Replying to [comment:19 vdelecroix]:
> Contrarily to what I thought, it seems not possible to extract the common ring of the coefficients from GAP. I kept the "common_parent".

Did you try `CoefficientRing(Ring(f))` for
a GAP polynomial `f`?

(I'll have a look later today...)


---

Comment by vdelecroix created at 2019-01-05 11:20:38

Replying to [comment:20 dimpase]:
> Replying to [comment:19 vdelecroix]:
> > Contrarily to what I thought, it seems not possible to extract the common ring of the coefficients from GAP. I kept the "common_parent".
> 
> Did you try `CoefficientRing(Ring(f))` for
> a GAP polynomial `f`?
> 
> (I'll have a look later today...)

complete failure

```
sage: x = libgap.eval('Indeterminate(Integers, "x")')
sage: libgap.Ring(x)
<ring with 1 generators>
sage: libgap.CoefficientsRing(libgap.Ring(x))
Traceback (most recent call last):
...
AttributeError: No such attribute: CoefficientsRing.
```



---

Comment by dimpase created at 2019-01-05 12:54:13

If this works in GAP then it is matter of putting `CoefficientRing` into an appropriate list of GAP functions, or just calling `libgap.function_factory(CoefficientRing)`


---

Comment by chapoton created at 2019-01-05 17:57:54

Dima, do you have a concrete proposal ? Otherwise, one could start with the current thing and enhance that later in other tickets ?

What is the correct argument for  CoefficientsRing ?

```
sage: x=polygen(QQ,'x')
sage: X=libgap(x)
sage: R=X.Ring()
sage: R.CoefficientsRing()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-9-003be256b736> in <module>()
----> 1 R.CoefficientsRing()

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement_MethodProxy.__call__ (build/cythonized/sage/libs/gap/element.c:18831)()
   2465             return GapElement_Function.__call__(self, * ([self.first_argument] + list(args)))
   2466         else:
-> 2467             return GapElement_Function.__call__(self, self.first_argument)
   2468 
   2469 

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement_Function.__call__ (build/cythonized/sage/libs/gap/element.c:18288)()
   2353             return make_any_gap_element(self.parent(), result)
   2354         except RuntimeError as msg:
-> 2355             raise ValueError('libGAP: ' + str(msg))
   2356         finally:
   2357             GAP_Leave()

ValueError: libGAP: Error, no method found! Error, no 1st choice method found for `CoefficientsRing' on 1 arguments
```



---

Comment by dimpase created at 2019-01-06 02:12:39

This looks like a GAP bug to me. I've opened [#3159](https://github.com/gap-system/gap/issues/3159) for GAP.

Indeed, this should not stop us from going ahead with this ticket in some form.


---

Comment by chapoton created at 2019-01-06 10:35:26

Then I am satisfied with the current state, and ready to give a positive review.

Vincent, d'accord ?


---

Comment by vdelecroix created at 2019-01-07 07:31:39

Replying to [comment:25 chapoton]:
> Then I am satisfied with the current state, and ready to give a positive review.
> 
> Vincent, d'accord ?

C'est bon pour moi. Merci Frédéric.


---

Comment by vdelecroix created at 2019-01-07 07:31:39

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2019-01-18 00:48:43

I don't know if it is only me but this ticket breaks building in sage-on-gentoo with cython-0.29.2

```
-> First build of interpreters
running build_cython
Enabling Cython debugging support
Updating Cython code....
warning: sage/graphs/mcqd.pyx:52:19: local variable 'clique_number' referenced before assignment
warning: sage/graphs/mcqd.pyx:55:57: local variable 'clique_number' referenced before assignment

Error compiling Cython file:
------------------------------------------------------------
...
from sage.structure.parent import Parent
from sage.rings.all import ZZ, QQ, RDF

from sage.groups.perm_gps.permgroup_element cimport PermutationGroupElement
from sage.combinat.permutation import Permutation
from sage.structure.element cimport coercion_model as cm
^
------------------------------------------------------------

sage/libs/gap/element.pyx:34:0: 'sage/structure/element/coercion_model.pxd' not found
warning: sage/libs/gap/element.pyx:238:21: local variable 'result' referenced before assignment
warning: sage/libs/gap/element.pyx:239:15: local variable 'result' referenced before assignment

Error compiling Cython file:
------------------------------------------------------------
...
            var = var.sage()
            num, den, val = self.CoefficientsOfUnivariateRationalFunction()
            num = num.sage()
            den = den.sage()
            val = val.sage()
            base_ring = cm.common_parent(*(num + den))
                         ^
------------------------------------------------------------

sage/libs/gap/element.pyx:1277:26: cimported module has no attribute 'common_parent'

Error compiling Cython file:
------------------------------------------------------------
...
            var = var.sage()
            num, den, val = self.CoefficientsOfUnivariateRationalFunction()
            num = num.sage()
            den = den.sage()
            val = val.sage()
            base_ring = cm.common_parent(*(num + den))
                         ^
------------------------------------------------------------

sage/libs/gap/element.pyx:1277:26: Compiler crash in AnalyseExpressionsTransform

ModuleNode.body = StatListNode(element.pyx:19:0)
StatListNode.stats[13] = CClassDefNode(element.pyx:369:5,
    as_name = u'GapElement',
    class_name = u'GapElement',
    doc = u"\n    Wrapper for all Gap objects.\n\n    .. NOTE::\n\n        In order to create ``GapElements`` you should use the\n        ``libgap`` instance (the parent of all Gap elements) to\n        convert things into ``GapElement``. You must not create\n        ``GapElement`` instances manually.\n\n    EXAMPLES::\n\n        sage: libgap(0)\n        0\n\n    If Gap finds an error while evaluating, a corresponding assertion is raised::\n\n        sage: libgap.eval('1/0')\n        Traceback (most recent call last):\n        ...\n        ValueError: libGAP: Error, Rational operations: <divisor> must not be zero\n\n    Also, a ``ValueError`` is raised if the input is not a simple expression::\n\n        sage: libgap.eval('1; 2; 3')\n        Traceback (most recent call last):\n        ...\n        ValueError: can only evaluate a single statement\n    ")
CClassDefNode.body = StatListNode(element.pyx:370:4)
StatListNode.stats[30] = DefNode(element.pyx:1202:4,
    doc = u'\n        Return the Sage equivalent of the :class:`GapElement`\n\n        EXAMPLES::\n\n            sage: libgap(1).sage()\n            1\n            sage: type(_)\n            <type \'sage.rings.integer.Integer\'>\n\n            sage: libgap(3/7).sage()\n            3/7\n            sage: type(_)\n            <type \'sage.rings.rational.Rational\'>\n\n            sage: libgap.eval(\'5 + 7*E(3)\').sage()\n            7*zeta3 + 5\n\n            sage: libgap(Infinity).sage()\n            +Infinity\n            sage: libgap(-Infinity).sage()\n            -Infinity\n\n            sage: libgap(True).sage()\n            True\n            sage: libgap(False).sage()\n            False\n            sage: type(_)\n            <... \'bool\'>\n\n            sage: libgap(\'this is a string\').sage()\n            \'this is a string\'\n            sage: type(_)\n            <... \'str\'>\n\n            sage: x = libgap.eval(\'Indeterminate(Integers, "x")\')\n\n            sage: p = x^2 - 2*x + 3\n            sage: p.sage()\n            x^2 - 2*x + 3\n            sage: p.sage().parent()\n            Univariate Polynomial Ring in x over Integer Ring\n\n            sage: p = x^-2 + 3*x\n            sage: p.sage()\n            x^-2 + 3*x\n            sage: p.sage().parent()\n            Univariate Laurent Polynomial Ring in x over Integer Ring\n\n            sage: p = (3 * x^2 + x) / (x^2 - 2)\n            sage: p.sage()\n            (3*x^2 + x)/(x^2 - 2)\n            sage: p.sage().parent()\n            Fraction Field of Univariate Polynomial Ring in x over Integer Ring\n        ',
    modifiers = [...]/0,
    name = u'sage',
    np_args_idx = [...]/0,
    num_required_args = 1,
    outer_attrs = [...]/2,
    py_wrapper_required = True,
    used = True)
File 'ExprNodes.py', line 5338, in infer_type: GeneralCallNode(element.pyx:1277:40,
    result_is_used = True,
    use_managed_ref = True)
File 'ExprNodes.py', line 6826, in infer_type: AttributeNode(element.pyx:1277:26,
    attribute = u'common_parent',
    is_attribute = 1,
    needs_none_check = True,
    result_is_used = True,
    use_managed_ref = True)

Compiler crash traceback from this point on:
  File "/usr/lib64/python2.7/site-packages/Cython/Compiler/ExprNodes.py", line 6826, in infer_type
    return node.entry.type
AttributeError: 'NoneType' object has no attribute 'type'
Traceback (most recent call last):
  File "/usr/lib64/python2.7/site-packages/Cython/Build/Dependencies.py", line 1244, in cythonize_one_helper
    return cythonize_one(*m)
  File "/usr/lib64/python2.7/site-packages/Cython/Build/Dependencies.py", line 1220, in cythonize_one
    raise CompileError(None, pyx_file)
CompileError: sage/libs/gap/element.pyx
************************************************************************
Traceback (most recent call last):
  File "setup.py", line 954, in <module>
    ext_modules = ext_modules)
  File "/usr/lib64/python2.7/distutils/core.py", line 151, in setup
    dist.run_commands()
  File "/usr/lib64/python2.7/distutils/dist.py", line 953, in run_commands
    self.run_command(cmd)
  File "/usr/lib64/python2.7/distutils/dist.py", line 972, in run_command
    cmd_obj.run()
  File "setup.py", line 857, in run
    build.run(self)
  File "/usr/lib64/python2.7/distutils/command/build.py", line 127, in run
    self.run_command(cmd_name)
  File "/usr/lib64/python2.7/distutils/cmd.py", line 326, in run_command
    self.distribution.run_command(command)
  File "/usr/lib64/python2.7/distutils/dist.py", line 972, in run_command
    cmd_obj.run()
  File "setup.py", line 376, in run
    cache=False,
  File "/usr/lib64/python2.7/site-packages/Cython/Build/Dependencies.py", line 1088, in cythonize
    result.get(99999)  # seconds
  File "/usr/lib64/python2.7/multiprocessing/pool.py", line 572, in get
    raise self._value
CompileError: sage/libs/gap/element.pyx
************************************************************************
Error building the Sage library
************************************************************************
```

Going from `from sage.structure.element cimport coercion_model as cm` to `from sage.structure.coerce cimport coercion_model as cm` seem to fix the breakage.


---

Comment by chapoton created at 2019-01-18 07:40:09

coercion_model has been moved by ticket #27021

so there is a conflict between here and there..


---

Comment by fbissey created at 2019-01-18 07:53:48

Replying to [comment:28 chapoton]:
> coercion_model has been moved by ticket #27021
> 
> so there is a conflict between here and there..

So that won't just be me, Volker is just trying to merge both tickets at the same time.


---

Comment by chapoton created at 2019-01-18 08:02:02

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2019-01-18 08:02:02

let us step back here then


---

Comment by git created at 2019-01-18 09:08:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-18 09:12:47

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-01-18 09:12:47

now the correct fix..
----
New commits:


---

Comment by tscrim created at 2019-01-18 17:19:45

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-01-18 17:19:45

LGTM.


---

Comment by vbraun created at 2019-01-26 15:55:43

Resolution: fixed


---

Comment by dimpase created at 2020-09-02 18:54:32

follow up (a bug): #30496
