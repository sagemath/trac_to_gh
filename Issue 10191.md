# Issue 10191: SageNB fails to install when SAGE_PATH is set to '.'

Issue created by migration from Trac.

Original creator: hivert

Original creation time: 2010-10-30 15:48:54

Assignee: jason, was

CC:  leif mpatel mhansen jdemeyer jhpalmieri

Keywords: notebook installation

When `SAGE_PATH` is set to '.', during the installation of sagenb, python is able to find sagenb into its path and therefore refuse to add it to easy-install.pth. Later sage won't find it leading to the following error message

```
ImportError: No module named sagenb.misc.sphinxify
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```


This is a followup to #10176 and there has been some discussion on [sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332)


---

Comment by leif created at 2010-10-30 22:53:09

Changing keywords from "notebook installation" to "notebook installation dot PYTHONPATH easy_install easy-install pth sage-spkg setuptools".


---

Comment by leif created at 2010-10-30 22:53:09

From `sage-env`:

```sh
if [ -d "$SAGE_ROOT/local/lib/python" ]; then
    PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"   && export PYTHONPATH
    PYTHONHOME="$SAGE_ROOT/local" && export PYTHONHOME
fi
```


We shouldn't add `$SAGE_PATH` there if it is empty btw., but the removal of "`.`" from `PYTHONPATH` should be performed in `sage-spkg` I think.

(`$SAGE_PATH` is also _appended_ to an overwritten(?!) `PYTHONPATH` in `sage-doctest`.)


---

Comment by leif created at 2010-10-31 01:23:19

Ok, after changing some instances of `PYTHON_PATH` to `PYTHONPATH` (argh!), the attached patch works for me.

You can try setting `SAGE_PATH` to something containing "`.`" (e.g. `":/foo/bar:.:/baz`, too), of course also doing `export SAGE_PATH`, then [re]installing the SageNB 0.8.7 spkg (or the newer ones, p1 or p2, but these aren't necessary, i.e., the patch here fixes the issue in a different way, not needing an additional work-around).


---

Comment by leif created at 2010-10-31 01:23:19

Changing status from new to needs_review.


---

Comment by leif created at 2010-10-31 01:31:06

As far as I know, Cygwin (as opposed to MS DOS/Windows) also uses "`:`" to separate directories in search paths, so this should work for Cygwin as well.

(Other shell and even Python scripts in Sage also hard-code that character.)


---

Comment by leif created at 2010-10-31 01:41:03

Changing component from notebook to build.


---

Comment by hivert created at 2010-10-31 08:55:44

Replying to [comment:5 leif]:

Applying the patch give me

```
patching file sage-spkg
Hunk #1 succeeded at 292 (offset -8 lines).
```

Are you sure that you didn't change anything else from a vanilla 4.6.rc0 ? 

Anyway, for what concerns openSUSE 11.1 and 11.3 the patch perfectly works. I also checked it on sage.sagemath.org. So I'm ok to give it a positive review, except for the Cygwin question where I'm not competent. Please do it on my behalf as soon as you have Mike answer.


---

Comment by leif created at 2010-10-31 09:04:20

Replying to [comment:6 hivert]:
> Applying the patch give me

```
patching file sage-spkg
Hunk #1 succeeded at 292 (offset -8 lines).
```

> Are you sure that you didn't change anything else from a vanilla 4.6.rc0 ? 

Ok, not based on _vanilla_ rc0; I've also applied a completely unrelated patch to `sage-spkg` (removing "`x`" from `tar` by default, #10040).


---

Attachment

Apply to scripts repo. Based on vanilla Sage 4.6.rc0. (Updated version, handles more weird cases, too.)


---

Comment by leif created at 2010-10-31 13:16:29

I've uploaded a slightly improved patch, this time _really_ based on _vanilla_ 4.6.rc0.

Try again...

(also with `SAGE_PATH=".::./././//./://bingo//:baz:::://///:./.:."` and alike) ;-)

Although it _might_ still fail with e.g. `SAGE_PATH="./foo/.."` (if `./foo/` happens to exist in the directory `setup` is run in), but this would at least for SageNB be catched by the 0.8.7.p{1,2} spkgs...


---

Comment by leif created at 2011-08-11 19:07:57

ping...

(Still needs review, only the Cygwin question seems still open, though I believe it'll also work on Cygwin.)

The patch will almost certainly have to get rebased, haven't tried yet.


---

Comment by leif created at 2011-08-11 20:14:06

SCRIPTS repo. Same patch, rebased to Sage 4.7.1.rc2.


---

Attachment

Replying to [comment:9 leif]:
> The patch will almost certainly have to get rebased, haven't tried yet.

Wow, the patch still applied (with an offset of only a few lines); I've rebased it on Sage 4.7.1.rc2 despite of that to now apply cleanly.

There are currently some concurrent tickets also patching `sage-spkg` though.


---

Comment by ppurka created at 2011-10-13 12:34:50

New attempt to clean up even nastier paths (including .., ./., etc)


---

Attachment

New attempt to clean up even nastier paths (including .., ./., etc) (Ignore the other patch)


---

Attachment

Please check [attachment:trac_10192-remove_dot_and_more_from_PYTHONPATH_in_sage.spkg.patch] against other platforms. I have checked it on Linux x86_64 and it cleans up nasty examples like the one mentioned earlier `".::./././//./://bingo//:baz:::://///:./.:."`. (Indented the paste below :))

```
 ~ $ AAAA=".::./././//./://bingo//:baz:::://///:./.:."
 ~ $ new_pp=""
 ~ $ IFS=":"
 ~ $ for x in $AAAA; do
  if [ -n "$x" -a -n "$(echo "$x" | sed -e 's/[\.\/]\+//g')" ]; then
    if [ -z "$new_pp" ]; then
      new_pp="$x"
    else
      new_pp="${new_pp}:$x"
    fi
  fi
done 
 ~ $ echo "$new_pp"
//bingo//:baz
```

This is against 4.7.0. I will later try to upload it rebased against 4.7.2.


---

Comment by leif created at 2011-10-13 15:00:03

And what's the advantage of running `sed` (and twice `test`, and `echo`) multiple times in a loop? B)

I'm not sure right now whether my patch is up-to-date btw., as the currently attached one doesn't remove redundant slashs and (e.g.) `./`... 8/


---

Comment by ppurka created at 2011-10-13 15:26:05

Replying to [comment:13 leif]:
> And what's the advantage of running `sed` (and twice `test`, and `echo`) multiple times in a loop? B)
> 
> I'm not sure right now whether my patch is up-to-date btw., as the currently attached one doesn't remove redundant slashs and (e.g.) `./`... 8/
The main point in the patch is the separator that is redefined to ':'.

Now when you run a loop through the variable, it loops through all the parts separated by ':'. Once each part is separated, you can check whether it is empty (hence the first test `-n "$x"`), or whether it consists of only . and / (hence the echo + sed). This is important because this catches all the bad cases like `..`, `./.`, `.`, etc. ( In relation to #11914, I tried to cd to devel/sage/sage and ran sage as `SAGE_PATH=.. sage -n` and it failed to run. So we should definitely weed out at least `..` by itself. ) I do feel that it is over-engineered, but I haven't been able to come up with a better solution that catches all the cases.

Since all the scripts in Sage are trying to conform to POSIX you need the echo + sed. In pure bash, you can replace the `"$( echo "$x" | sed ... )"` with simply `"${x//[\.\/]}"`


---

Comment by leif created at 2011-10-13 17:18:48

Replying to [comment:14 ppurka]:
> Replying to [comment:13 leif]:
> > And what's the advantage of running `sed` (and twice `test`, and `echo`) multiple times in a loop? B)
> > 
> > I'm not sure right now whether my patch is up-to-date btw., as the currently attached one doesn't remove redundant slashs and (e.g.) `./`... 8/
> The main point in the patch is the separator that is redefined to ':'.

Well, I know `IFS`, but I don't want to run it in a loop; that was my point.

My improved code snippet (simplified and catching additional instances; using a single invocation of `sed`) looks like this:

```sh
$ echo $EXAMPLE; echo; echo ":$EXAMPLE:" | sed \
-e 's|/\+|/|g' \
-e 's|:\(\./\)\+|:|g' \
-e 's|\(/\.\)\+:|:|g' \
-e 's|\(:\.\)\+:|:|g' \
-e 's|:\+|:|g' -e 's|^:\+||' -e 's|:\+$||' 
.::./././//./://bingo//:baz:::://///:./.:.

/bingo/:baz:/
```





> This is important because this catches all the bad cases like `..`, `./.`, `.`, etc.

We only have to catch "`.`" (i.e., the current working directory) _here_.




> (In relation to #11914, I tried to cd to devel/sage/sage and ran sage as `SAGE_PATH=.. sage -n` and it failed to run. So we should definitely weed out at least `..` by itself.)

IMHO not.  If you put things into `SAGE_PATH`, you have to live with the results (or side-effects) _in that case_.  Or we have to do that in `sage-sage`, before we (try to) start the notebook only, independently of the fix to `sage-env` at #11914 (and of course `sage-spkg`, which is patched here).

A better approach in the case of the notebook would perhaps be to directly test whether any component of `PYTHONPATH` yields `devel/sage-*/` (or has a subdirectory `sage` with an `__init__.py` file in it), or, probably easiest, _prepend_ the correct directory to `PYTHONPATH` before running `sage-notebook`.

(We should better discuss the latter on #11914.)


---

Attachment

SCRIPTS repo. Improved version of my previous patch. Based on Sage 4.7.2.alpha4.


---

Comment by leif created at 2011-10-13 17:53:26

New patch is up.


---

Comment by ppurka created at 2011-10-16 12:48:14

New patch looks good to me. I will leave it to people who actually had the problem(s) to report back and change this to "positive review."

Personally, I had no problems in getting Sage compiled and up and running on two different Linux distributions, and with sage-4.7.0 and sage-4.7.2_alpha3.


---

Attachment

Updated the v2 of the file so that it applies to sage-4.8


---

Comment by ppurka created at 2012-02-03 19:30:52

Update patch to sage-4.8.

This has positive review from my side. If there is nothing else holding it up, then it should be merged, in my opinion.


---

Comment by ppurka created at 2012-02-03 19:30:52

Changing status from needs_review to positive_review.


---

Attachment


---

Comment by jdemeyer created at 2012-02-04 14:12:54

Rebased to #11073.


---

Comment by jdemeyer created at 2012-02-06 21:23:06

Resolution: fixed


---

Comment by jdemeyer created at 2012-02-16 09:44:21

Changing status from closed to new.


---

Comment by jdemeyer created at 2012-02-16 09:44:21

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2012-02-16 09:44:21

This needs work because "\+" in sed scripts isn't portable.  You can replace "X\+" by "XX*", which is equivalent.


---

Comment by jdemeyer created at 2012-02-16 09:45:48

Another minor comment: use spaces instead of TABs for indenting.


---

Comment by ppurka created at 2012-02-16 09:50:15

Replying to [comment:22 jdemeyer]:
> This needs work because "\+" in sed scripts isn't portable.  You can replace "X\+" by "XX*", which is equivalent.

Is `\{1,\}` a portable version of `\+`?


---

Comment by jdemeyer created at 2012-02-16 09:56:45

Replying to [comment:24 ppurka]:
> Is `\{1,\}` a portable version of `\+`?

As far as I can tell, yes.  But I consider "XX*" to be more readable than "X\{1,\}", especially for short strings X, which is the case here.


---

Comment by ppurka created at 2012-02-16 11:46:15

Apply only this to SAGE_ROOT


---

Attachment

Updated the patch with the stated modifications. Please review.

Here is the output in busybox (probably the closest system to POSIX I have around here, but the earlier version also works fine):

```
~> busybox sh


BusyBox v1.18.4 (Ubuntu 1:1.18.4-2ubuntu2) built-in shell (ash)
Enter 'help' for a list of built-in commands.

~ $ EXAMPLE=".::./././//./://bingo//:baz:::://///:./.:."
~ $ echo :$EXAMPLE: | busybox sed -e 's|//*|/|g' -e 's|:\(\./\)\{1,\}|:|g' -e 's
s|::*$||'
/bingo/:baz:/
```



---

Comment by ppurka created at 2012-02-16 11:46:58

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-02-21 10:55:13

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-27 11:20:06

Resolution: fixed
