# Issue 26326: Sage screws up the integration of some functions.

archive/issues_026326.json:
```json
{
    "body": "CC:  mforets chapoton\n\nKeywords: integration\n\nInspiration this [ask.sagemath](https://ask.sagemath.org/question/44077/indefinite-integral-is-incorrect/) question.\n\nA lot of tickets describe indefinite integral bugs attributable to `maxima`, most notably its `abs_integrate` package ; see #12731 for a sample of the latter, and the [list](https://trac.sagemath.org/wiki/symbolics#Integrationtickets) of integration tickets for somother infamous examples...\n\nHowever, Sage, which is becoming a mature system, seems to have become able to screw up things by itself on its own, without any external help. Case in point :\n\n```\nsage: elliptic_e(x,1/2).diff(x)\nsqrt(-1/2*sin(x)^2 + 1)\n```\n\n\n* Maxima can't solve the reverse problem, but will honestly report its failure  :\n\n```\nsage: maxima.integrate(sqrt(1-m*sin(x)^2),x).sage()\nintegrate(sqrt(-m*sin(x)^2 + 1), x)\n\n```\n\n* Sage will lie ;-) :\n\n```\nsage: integrate(sqrt(1-m*sin(x)^2),x)\n1/4*m*x - 1/8*m*sin(2*x)\n```\n\nwhich is wrong, //wrong//, **wrong**...\n\nIssue created by migration from https://trac.sagemath.org/ticket/26563\n\n",
    "created_at": "2018-10-26T20:37:58Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "Sage screws up the integration of some functions.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26326",
    "user": "charpent"
}
```
CC:  mforets chapoton

Keywords: integration

Inspiration this [ask.sagemath](https://ask.sagemath.org/question/44077/indefinite-integral-is-incorrect/) question.

A lot of tickets describe indefinite integral bugs attributable to `maxima`, most notably its `abs_integrate` package ; see #12731 for a sample of the latter, and the [list](https://trac.sagemath.org/wiki/symbolics#Integrationtickets) of integration tickets for somother infamous examples...

However, Sage, which is becoming a mature system, seems to have become able to screw up things by itself on its own, without any external help. Case in point :

```
sage: elliptic_e(x,1/2).diff(x)
sqrt(-1/2*sin(x)^2 + 1)
```


* Maxima can't solve the reverse problem, but will honestly report its failure  :

```
sage: maxima.integrate(sqrt(1-m*sin(x)^2),x).sage()
integrate(sqrt(-m*sin(x)^2 + 1), x)

```

* Sage will lie ;-) :

```
sage: integrate(sqrt(1-m*sin(x)^2),x)
1/4*m*x - 1/8*m*sin(2*x)
```

which is wrong, //wrong//, **wrong**...

Issue created by migration from https://trac.sagemath.org/ticket/26563





---

archive/issue_comments_370784.json:
```json
{
    "body": "I think that this actually is due to `abs_integrate`:\n\n```\n(%i1) integrate(sqrt(1-m*sin(x)^2),x);\n                           /\n                           [               2\n(%o1)                      I sqrt(1 - m sin (x)) dx\n                           ]\n                           /\n(%i2) load(abs_integrate);\nARRSTORE: use_fast_arrays=false; allocate a new property hash table for $INTABLE2\n(%o2) sage-develop/local/share/maxima/5.41.0/share/contrib/integration/abs_integrate.mac\n(%i3) integrate(sqrt(1-m*sin(x)^2),x);\n                    2 m sin(2 x) false - m sin(2 x) + 2 m x\n(%o3)               ---------------------------------------\n                                       8\n```\n\n(although it's quite interesting what sage does with the result...)",
    "created_at": "2018-10-27T06:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370784",
    "user": "mantepse"
}
```

I think that this actually is due to `abs_integrate`:

```
(%i1) integrate(sqrt(1-m*sin(x)^2),x);
                           /
                           [               2
(%o1)                      I sqrt(1 - m sin (x)) dx
                           ]
                           /
(%i2) load(abs_integrate);
ARRSTORE: use_fast_arrays=false; allocate a new property hash table for $INTABLE2
(%o2) sage-develop/local/share/maxima/5.41.0/share/contrib/integration/abs_integrate.mac
(%i3) integrate(sqrt(1-m*sin(x)^2),x);
                    2 m sin(2 x) false - m sin(2 x) + 2 m x
(%o3)               ---------------------------------------
                                       8
```

(although it's quite interesting what sage does with the result...)



---

archive/issue_comments_370785.json:
```json
{
    "body": "Changing keywords from \"integration\" to \"integration, abs_integrate\".",
    "created_at": "2019-06-09T08:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370785",
    "user": "chapoton"
}
```

Changing keywords from "integration" to "integration, abs_integrate".



---

archive/issue_comments_370786.json:
```json
{
    "body": "fixed by #27958, that needs review",
    "created_at": "2019-06-17T14:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370786",
    "user": "chapoton"
}
```

fixed by #27958, that needs review



---

archive/issue_comments_370787.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-12-18T15:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370787",
    "user": "mjo"
}
```

New commits:



---

archive/issue_comments_370788.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-18T15:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370788",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370789.json:
```json
{
    "body": "red branch => needs work",
    "created_at": "2021-01-25T14:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370789",
    "user": "chapoton"
}
```

red branch => needs work



---

archive/issue_comments_370790.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-25T14:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370790",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_370791.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-25T18:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370791",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_370792.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-25T18:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370792",
    "user": "mjo"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_370793.json:
```json
{
    "body": "Rebased onto develop.",
    "created_at": "2021-01-25T18:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370793",
    "user": "mjo"
}
```

Rebased onto develop.



---

archive/issue_comments_370794.json:
```json
{
    "body": "LGTM.",
    "created_at": "2021-01-26T03:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370794",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_370795.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-26T03:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370795",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370796.json:
```json
{
    "body": "What about the time it takes ? Do we really need this doctest ?",
    "created_at": "2021-01-26T19:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370796",
    "user": "chapoton"
}
```

What about the time it takes ? Do we really need this doctest ?



---

archive/issue_comments_370797.json:
```json
{
    "body": "It takes about 15s on my computer. While it is not very long, it still is a bit long. It is important to have a regression test, which is why I gave it a positive review. Yet, I do see your point about not increasing the (long) test time too much. It suggests a change in the overall testing framework in Sage with respect to the symbolics. Perhaps we need to add the tests explicitly to the installation check? Although I lean towards keeping this at least for now to demonstrate where we have had issues. Fr\u00e9d\u00e9ric, your thoughts?",
    "created_at": "2021-01-27T00:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370797",
    "user": "tscrim"
}
```

It takes about 15s on my computer. While it is not very long, it still is a bit long. It is important to have a regression test, which is why I gave it a positive review. Yet, I do see your point about not increasing the (long) test time too much. It suggests a change in the overall testing framework in Sage with respect to the symbolics. Perhaps we need to add the tests explicitly to the installation check? Although I lean towards keeping this at least for now to demonstrate where we have had issues. Frédéric, your thoughts?



---

archive/issue_comments_370798.json:
```json
{
    "body": "It's slow but it's also kind of a cool example. Personally I'd prefer to delete ten other symbol-salad integration tests to make up for the time this one takes =)\n\n(IMO anything tested by the upstream test suite is a waste of time to duplicate within the sage library, since users have the option to run those test suites as well.)",
    "created_at": "2021-01-27T01:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370798",
    "user": "mjo"
}
```

It's slow but it's also kind of a cool example. Personally I'd prefer to delete ten other symbol-salad integration tests to make up for the time this one takes =)

(IMO anything tested by the upstream test suite is a waste of time to duplicate within the sage library, since users have the option to run those test suites as well.)



---

archive/issue_comments_370799.json:
```json
{
    "body": "Well, my point is that if everybody happily adds new doctests, only a few people care about how long it takes, and nobody at all cares about the ever-increasing time required to doctest sage. May I recall that a long doctest should rather not take more than 5s ?\n\nhttps://doc.sagemath.org/html/en/developer/doctesting.html#run-long-doctests\n\nMaybe specifying the algorithm that works would shorten the test time by not trying the failing algorithms ?",
    "created_at": "2021-01-27T09:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370799",
    "user": "chapoton"
}
```

Well, my point is that if everybody happily adds new doctests, only a few people care about how long it takes, and nobody at all cares about the ever-increasing time required to doctest sage. May I recall that a long doctest should rather not take more than 5s ?

https://doc.sagemath.org/html/en/developer/doctesting.html#run-long-doctests

Maybe specifying the algorithm that works would shorten the test time by not trying the failing algorithms ?



---

archive/issue_comments_370800.json:
```json
{
    "body": "In this case the point of the test is that maxima \"fails to integrate it incorrectly,\" after which sympy produces the correct result. When maxima returns a wrong answer (rather than giving up), sympy is never tried and we just return the wrong thing. Maxima gives up quickly, but the rest of the time spent in the doctest is just sympy performing the integral and getting the right answer.\n\nI'm fine if we want to leave this doctest out. I was just trying to help close out an old ticket by providing a test that shows that it's fixed.\n\n(And in general, if you ever want to propose that we go back and delete all of the \"fixed in a new version of $package\" doctests, I'd be all for it. I already run the test suites for maxima, pari, flint, etc. and don't need to test for those bugs all over again when I build sage.)",
    "created_at": "2021-01-27T13:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370800",
    "user": "mjo"
}
```

In this case the point of the test is that maxima "fails to integrate it incorrectly," after which sympy produces the correct result. When maxima returns a wrong answer (rather than giving up), sympy is never tried and we just return the wrong thing. Maxima gives up quickly, but the rest of the time spent in the doctest is just sympy performing the integral and getting the right answer.

I'm fine if we want to leave this doctest out. I was just trying to help close out an old ticket by providing a test that shows that it's fixed.

(And in general, if you ever want to propose that we go back and delete all of the "fixed in a new version of $package" doctests, I'd be all for it. I already run the test suites for maxima, pari, flint, etc. and don't need to test for those bugs all over again when I build sage.)



---

archive/issue_comments_370801.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-02-20T10:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26326#issuecomment-370801",
    "user": "vbraun"
}
```

Resolution: fixed
