# Issue 26326: Sage screws up the integration of some functions.

Issue created by migration from https://trac.sagemath.org/ticket/26563

Original creator: charpent

Original creation time: 2018-10-26 20:37:58

CC:  mforets chapoton

Keywords: integration

Inspiration this [ask.sagemath](https://ask.sagemath.org/question/44077/indefinite-integral-is-incorrect/) question.

A lot of tickets describe indefinite integral bugs attributable to `maxima`, most notably its `abs_integrate` package ; see #12731 for a sample of the latter, and the [list](https://trac.sagemath.org/wiki/symbolics#Integrationtickets) of integration tickets for somother infamous examples...

However, Sage, which is becoming a mature system, seems to have become able to screw up things by itself on its own, without any external help. Case in point :

```
sage: elliptic_e(x,1/2).diff(x)
sqrt(-1/2*sin(x)^2 + 1)
```


* Maxima can't solve the reverse problem, but will honestly report its failure  :

```
sage: maxima.integrate(sqrt(1-m*sin(x)^2),x).sage()
integrate(sqrt(-m*sin(x)^2 + 1), x)

```

* Sage will lie ;-) :

```
sage: integrate(sqrt(1-m*sin(x)^2),x)
1/4*m*x - 1/8*m*sin(2*x)
```

which is wrong, //wrong//, **wrong**...


---

Comment by mantepse created at 2018-10-27 06:46:34

I think that this actually is due to `abs_integrate`:

```
(%i1) integrate(sqrt(1-m*sin(x)^2),x);
                           /
                           [               2
(%o1)                      I sqrt(1 - m sin (x)) dx
                           ]
                           /
(%i2) load(abs_integrate);
ARRSTORE: use_fast_arrays=false; allocate a new property hash table for $INTABLE2
(%o2) sage-develop/local/share/maxima/5.41.0/share/contrib/integration/abs_integrate.mac
(%i3) integrate(sqrt(1-m*sin(x)^2),x);
                    2 m sin(2 x) false - m sin(2 x) + 2 m x
(%o3)               ---------------------------------------
                                       8
```

(although it's quite interesting what sage does with the result...)


---

Comment by chapoton created at 2019-06-09 08:23:56

Changing keywords from "integration" to "integration, abs_integrate".


---

Comment by chapoton created at 2019-06-17 14:09:06

fixed by #27958, that needs review


---

Comment by mjo created at 2020-12-18 15:20:07

New commits:


---

Comment by mjo created at 2020-12-18 15:20:07

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-01-25 14:28:44

red branch => needs work


---

Comment by chapoton created at 2021-01-25 14:28:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-01-25 18:02:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-01-25 18:02:50

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-01-25 18:02:50

Rebased onto develop.


---

Comment by tscrim created at 2021-01-26 03:04:10

LGTM.


---

Comment by tscrim created at 2021-01-26 03:04:10

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-01-26 19:57:49

What about the time it takes ? Do we really need this doctest ?


---

Comment by tscrim created at 2021-01-27 00:17:34

It takes about 15s on my computer. While it is not very long, it still is a bit long. It is important to have a regression test, which is why I gave it a positive review. Yet, I do see your point about not increasing the (long) test time too much. It suggests a change in the overall testing framework in Sage with respect to the symbolics. Perhaps we need to add the tests explicitly to the installation check? Although I lean towards keeping this at least for now to demonstrate where we have had issues. Frédéric, your thoughts?


---

Comment by mjo created at 2021-01-27 01:23:53

It's slow but it's also kind of a cool example. Personally I'd prefer to delete ten other symbol-salad integration tests to make up for the time this one takes =)

(IMO anything tested by the upstream test suite is a waste of time to duplicate within the sage library, since users have the option to run those test suites as well.)


---

Comment by chapoton created at 2021-01-27 09:25:53

Well, my point is that if everybody happily adds new doctests, only a few people care about how long it takes, and nobody at all cares about the ever-increasing time required to doctest sage. May I recall that a long doctest should rather not take more than 5s ?

https://doc.sagemath.org/html/en/developer/doctesting.html#run-long-doctests

Maybe specifying the algorithm that works would shorten the test time by not trying the failing algorithms ?


---

Comment by mjo created at 2021-01-27 13:42:49

In this case the point of the test is that maxima "fails to integrate it incorrectly," after which sympy produces the correct result. When maxima returns a wrong answer (rather than giving up), sympy is never tried and we just return the wrong thing. Maxima gives up quickly, but the rest of the time spent in the doctest is just sympy performing the integral and getting the right answer.

I'm fine if we want to leave this doctest out. I was just trying to help close out an old ticket by providing a test that shows that it's fixed.

(And in general, if you ever want to propose that we go back and delete all of the "fixed in a new version of $package" doctests, I'd be all for it. I already run the test suites for maxima, pari, flint, etc. and don't need to test for those bugs all over again when I build sage.)


---

Comment by vbraun created at 2021-02-20 10:46:32

Resolution: fixed
