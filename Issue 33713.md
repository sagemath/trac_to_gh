# Issue 33713: Add free resolutions with Singular backend

Issue created by migration from https://trac.sagemath.org/ticket/33950

Original creator: klee

Original creation time: 2022-06-04 12:04:04




---

Comment by git created at 2022-06-04 12:05:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-04 12:11:31

Changing status from new to needs_review.


---

Comment by git created at 2022-06-04 12:27:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-06-11 12:16:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-06-14 04:06:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-27 01:24:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by tscrim created at 2022-08-04 04:33:08

It is very nice to have this feature in Sage; it is something that has been missing for a long time. Sorry for taking so long to get to reviewing it. I have some issues with the overall design that I would like to discuss:

- I think we should do the main computations lazily; that is only when the user asks for them such as computing the length of the resolution. This is a general Sage philosophy: a `Parent` should be quick to create (of course, this is not necessarily universal). These lazy computational bits could then be overriden in subclasses for specific implementations. I think this also leads to a better organizational structure for the classes.
- Why are these classes in Cython files? The only thing that uses Cython is the `to_sage_resolution()`, which could go in the Singular interface file.

Some more trivial points:

- Use `_repr_` instead of `__repr__` as the former allows a user to use `rename()` on the object.
- I would have `FreeResolution_generic` inherit from `UniqueRepresentation` because we don't want to have to do the computations twice for the same ideal.
- I think we should have the string repr be based off the input data. The `_latex_`, `_ascii_art_`, `_unicode_art_` can then use the ones from `chain_complex()` with the current one being something like `pp()`. Perhaps `_latex_` is better directly implemented though (with a `latex_name` attribute added too).
- You can make `_initial_differential` a ``@`lazy_attribute`.
- I much prefer single underscore instead of double as the name-mangling makes it difficult when you want to directly access the attributes (e.g., for speed).
- Given the `chain_complex()`, are there any methods there worthwhile to also call from the free resolution? I am not sure there are any (beyond display methods) since resolutions are exact.


---

Comment by klee created at 2022-08-04 06:45:21

Replying to [comment:10 tscrim]:
> Sorry for taking so long to get to reviewing it. 

No. Just thank you for attention.  

> - I think we should do the main computations lazily; that is only when the user asks for them such as computing the length of the resolution. 

As you see, the gist of the code is to convert the resolution object computed by Singular to a Sage object as fast as possible and the Sage object contains detailed information (degrees(multi degrees) of generators of component modules and the length) about the resolution. By my experiments, the resolution computation is as fast as Macaulay2.

Then what do you mean by doing the computation lazily? For instance, the length is immediately available after the conversion. And I don't see anything to do lazily in this conversion.

#33953 is dependent on this ticket and requires fast resolution computation.


---

Comment by git created at 2022-08-04 06:48:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-04 10:03:12

Replying to [comment:11 klee]:
> Replying to [comment:10 tscrim]:
> > - I think we should do the main computations lazily; that is only when the user asks for them such as computing the length of the resolution. 
> 
> As you see, the gist of the code is to convert the resolution object computed by Singular to a Sage object as fast as possible and the Sage object contains detailed information (degrees(multi degrees) of generators of component modules and the length) about the resolution. By my experiments, the resolution computation is as fast as Macaulay2.

Indeed. I want to keep that in Cython, but moved to the interface file. I feel that is the more appropriate place for it.

> Then what do you mean by doing the computation lazily? For instance, the length is immediately available after the conversion. And I don't see anything to do lazily in this conversion.

This is what I mean: Do not ask Singular to do the computation until it is required by something the user wants to do. Now this can be improved by making the `_repr_()` not needing to compute the resolution.

A followup ticket would be to make the API for this play nicely with FP graded modules. I would likely want an object for those resolutions, but that will take a little bit of work to handle the potentially infinite length. I can likely modify what I did for the Hochschild complex for that.

Based on that, I would want to convert this to a subclass of `CategoryObject` instead of `SageObject` and have it live in the category of `ChainComplexes`. This shouldn't change much, but it does allow for the possibility of implementing maps or functors on free resolutions (mainly this would allow for computation of (left) derived functors). What do you think?
----
New commits:


---

Comment by klee created at 2022-08-04 10:53:43

Replying to [comment:13 tscrim]:
> This is what I mean: Do not ask Singular to do the computation until it is required by something the user wants to do. Now this can be improved by making the `_repr_()` not needing to compute the resolution.

The lazy computation looks good to me.  

> Based on that, I would want to convert this to a subclass of `CategoryObject` instead of `SageObject` and have it live in the category of `ChainComplexes`. This shouldn't change much, but it does allow for the possibility of implementing maps or functors on free resolutions (mainly this would allow for computation of (left) derived functors). What do you think?

Okay. Feel free to modify the code for your needs, till the code pass the original doctests and run as fast as before.


---

Comment by klee created at 2022-08-04 11:09:00

Replying to [comment:13 tscrim]:
> Indeed. I want to keep that in Cython, but moved to the interface file. I feel that is the more appropriate place for it.

I felt that too, but also thought that keeping `[Graded]FreeResolution` class and `to_sage_resolution[_graded]` function in the same cython file would make them run fast. If I am wrong, I am okay with moving them to the Singular interface file.


---

Comment by tscrim created at 2022-08-05 11:02:20

I was hoping to get to this today, but something unexpected came up.

The speed of the functions is not affected by being in the same Cython file. Now there will be some slight slowdown for converting the resolution class to a Python file (versus Cython), but since that is all of the boilerplate code that is called infrequently to only once (e.g., the `__getitem__`), this should be insignificant (i.e., nearly all of the time is spent computing the resolution). However, having it be a Python class will make maintenance and extensions easier in the long term.

Is there some tests I should use that are particularly good for timing purposes?


---

Comment by klee created at 2022-08-05 11:34:34

Replying to [comment:16 tscrim]:
> I was hoping to get to this today, but something unexpected came up.
> 
> The speed of the functions is not affected by being in the same Cython file. Now there will be some slight slowdown for converting the resolution class to a Python file (versus Cython), but since that is all of the boilerplate code that is called infrequently to only once (e.g., the __getitem__), this should be insignificant (i.e., nearly all of the time is spent computing the resolution). However, having it be a Python class will make maintenance and extensions easier in the long term.

Okay.

> Is there some tests I should use that are particularly good for timing purposes?

Perhaps one or two tests are somewhere in my files. After you are done with your work, I can run the tests and report the result.


---

Comment by git created at 2022-08-06 11:37:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-06 11:39:37

Okay, I am done for now.

I changed the `ideal` argument to `module` argument reflecting its generality.

I reworked the documentation to try and make is more readable as a non-programming-technical document at the module-level. I also did some other doc changes to try and improve the overall accuracy.

I did not change it to a `CategoryObject` as `ChainComplexes` is actually expecting the objects to be `Parent`s. This would be easily enough to do, but I am feeling lazy about it right now. It is something that could be done easily enough on a later ticket.


---

Comment by git created at 2022-08-08 04:14:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-08-08 04:35:46

I made minor fixes in docstrings.

- The base class `FreeResolution_generic` seems generic rather than abstract.
- I prefer a spaced list than a tight list in INPUT section. From the discussion in sage-devel, I learned that I should respect whichever style an author uses. So I reverted my own change of an AUTHOR section.

Otherwise it looks good to me.

For performance, I tested with #33953. I got

Before your patch,

```
sage: k = GF(11)
sage: E = EllipticCurve(k,[1,1])
sage: Q = E(6,5)
sage: phi = E.multiplication_by_m_isogeny(2)
sage: mor = phi.morphism()
sage: mor.degree()
4
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.5 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.5 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.4 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.4 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.8 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.5 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.6 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.6 ms per loop
```

After your patch,

```
sage: k = GF(11)
sage: E = EllipticCurve(k,[1,1])
sage: Q = E(6,5)
sage: phi = E.multiplication_by_m_isogeny(2)
sage: mor = phi.morphism()
sage: mor.degree()
4
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 28.2 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 28.1 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.7 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 28.1 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 27.6 ms per loop
sage: timeit('mor.projective_degrees()')
25 loops, best of 3: 28 ms per loop
```

I don't know if the difference in timings is statistically significant. Anyway, it seems negligible.


---

Comment by tscrim created at 2022-08-08 05:10:19

Replying to [comment:21 klee]:
> - The base class `FreeResolution_generic` seems generic rather than abstract.

Bikeshedding (nor do I really care that much): I am not sure I agree with calling it `generic` as it really doesn't work unless subclasses implement certain aspects. While instances can be created, I don't think that qualifies it to be generic.

> - I prefer a spaced list than a tight list in INPUT section. From the discussion in sage-devel, I learned that I should respect whichever style an author uses. So I reverted my own change of an AUTHOR section.

That was not my takeaway from that discussion; nobody wanted to make a policy. Yet, I don't care too much about this file to insist.

> Otherwise it looks good to me.

Thank you.

> For performance, I tested with #33953. I got

Thank you for testing.

> I don't know if the difference in timings is statistically significant. Anyway, it seems negligible.

Using the numbers you gave, it less than 1% slower by comparing the means. So if this is something that is going to be called very frequently or in a tight loop, then we might want to care about it. Although I am fairly certain it will become even smaller on larger examples.

If everything is good with you, then you can set a positive review and I will try to review #33953.


---

Comment by klee created at 2022-08-08 06:14:34

Replying to [comment:23 tscrim]:
> Bikeshedding (nor do I really care that much): I am not sure I agree with calling it `generic` as it really doesn't work unless subclasses implement certain aspects. While instances can be created, I don't think that qualifies it to be generic.

Perhaps I learned somewhere that an abstract class defines interfaces, and a subclass provides implementations. A generic class provides common operations...
 
> If everything is good with you, then you can set a positive review and I will try to review #33953.

Thank you!


---

Comment by klee created at 2022-08-08 06:14:34

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-08-08 06:20:01

Replying to [comment:24 klee]:
> Replying to [comment:23 tscrim]:
> > Bikeshedding (nor do I really care that much): I am not sure I agree with calling it `generic` as it really doesn't work unless subclasses implement certain aspects. While instances can be created, I don't think that qualifies it to be generic.
> 
> Perhaps I learned somewhere that an abstract class defines interfaces, and a subclass provides implementations. A generic class provides common operations...

There isn't universal definitions of this IIRC. My understanding of Sage is a generic class is one that can do most functionality on its own, but lacks some specific features that subclasses can do. Consequently, anything that requires a subclass to implement even partial functionality should be considered an abstract class. Well, it is possible that the `FreeResolution_generic` will eventually become more of a generic class. I feel that calling it a generic class is slightly misleading, but I don't think it is so important here.


---

Comment by klee created at 2022-08-08 06:33:53

Replying to [comment:25 tscrim]:
> > Perhaps I learned somewhere that an abstract class defines interfaces, and a subclass provides implementations. A generic class provides common operations...
> 
> There isn't universal definitions of this IIRC. 

Okay. 

I uploaded #33953 rebased on this ticket.


---

Comment by vbraun created at 2022-08-28 11:08:59

PDF docs don't build:

```
[sagemath_doc_pdf-none] ! Package inputenc Error: Unicode character ⊕ (U+2295)
[sagemath_doc_pdf-none] (inputenc)                not set up for use with LaTeX.
```



---

Comment by vbraun created at 2022-08-28 11:08:59

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2022-08-28 23:40:03

You either need to update `build/pkgs/sage_docbuild/src/sage_docbuild/conf.py` with the unicode symbol

```
    \DeclareUnicodeCharacter{2295}{\ensuremath{\oplus}}
```

or use ⨁ (2A01) instead of ⊕ (2295).


---

Comment by git created at 2022-08-29 03:04:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-08-29 03:07:42

Replying to [comment:28 tscrim]:
> You either need to update `build/pkgs/sage_docbuild/src/sage_docbuild/conf.py` with the unicode symbol
> {{{
>     \DeclareUnicodeCharacter{2295}{\ensuremath{\oplus}}
> }}}
> or use ⨁ (2A01) instead of ⊕ (2295).

Thanks. This ⨁ (2A01) looks too big on my terminal.


---

Comment by tscrim created at 2022-08-29 04:21:04

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2022-08-29 04:21:04

Thanks.


---

Comment by vbraun created at 2022-08-30 06:51:55

Resolution: fixed
