# Issue 22532: tensor_product fails when one of the matrices has 0 rows or columns

archive/issues_022532.json:
```json
{
    "body": "CC:  @fchapoton @videlec\n\nKeywords: block_matrix, tensor_product\n\nHere is a small example of the error\n\n\n```\nm1 = matrix(QQ, 1, 0, [])\nm2 = matrix(QQ, 2, 2, [1, 2, 3, 4])\nprint m1.tensor_product(m2)\n```\n\n\nOf course, the correct tensor product of these two matrices should be given by\n\n\n```\nmatrix(QQ, 2, 0, [])\n```\n\n\nIt could be that the problem is coming from the block matrix structure.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22769\n\n",
    "created_at": "2017-04-06T16:28:59Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "tensor_product fails when one of the matrices has 0 rows or columns",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22532",
    "user": "jwiltshiregordon"
}
```
CC:  @fchapoton @videlec

Keywords: block_matrix, tensor_product

Here is a small example of the error


```
m1 = matrix(QQ, 1, 0, [])
m2 = matrix(QQ, 2, 2, [1, 2, 3, 4])
print m1.tensor_product(m2)
```


Of course, the correct tensor product of these two matrices should be given by


```
matrix(QQ, 2, 0, [])
```


It could be that the problem is coming from the block matrix structure.

Issue created by migration from https://trac.sagemath.org/ticket/22769





---

archive/issue_comments_314047.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-24T00:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314047",
    "user": "@tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_314048.json:
```json
{
    "body": "I decided to just special case the `tensor_product` call to handle these cases.",
    "created_at": "2017-04-24T00:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314048",
    "user": "@tscrim"
}
```

I decided to just special case the `tensor_product` call to handle these cases.



---

archive/issue_comments_314049.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-24T00:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314049",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314050.json:
```json
{
    "body": "Green patchbot.",
    "created_at": "2017-05-21T02:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314050",
    "user": "@tscrim"
}
```

Green patchbot.



---

archive/issue_comments_314051.json:
```json
{
    "body": "Isn't it a problem with `block_matrix`\n\n```\nsage: block_matrix(0, 2, [])\nTraceback (most recent call last):\n...\nValueError: invalid nrows/ncols passed to block_matrix\n```\n\nEDIT: no! since `block_matrix` has no way to understand the size of the matrices in the empty list!\n\nNote that the following does work\n\n```\nsage: block_matrix(2, 2, [[matrix(0,2), matrix(0,2)], [matrix(0,2), matrix(0,2)]])\n[]\nsage: parent(_)\nFull MatrixSpace of 0 by 4 dense matrices over Integer Ring\n```\n",
    "created_at": "2017-06-03T17:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314051",
    "user": "@videlec"
}
```

Isn't it a problem with `block_matrix`

```
sage: block_matrix(0, 2, [])
Traceback (most recent call last):
...
ValueError: invalid nrows/ncols passed to block_matrix
```

EDIT: no! since `block_matrix` has no way to understand the size of the matrices in the empty list!

Note that the following does work

```
sage: block_matrix(2, 2, [[matrix(0,2), matrix(0,2)], [matrix(0,2), matrix(0,2)]])
[]
sage: parent(_)
Full MatrixSpace of 0 by 4 dense matrices over Integer Ring
```




---

archive/issue_comments_314052.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> Note that the following does work\n> {{{\n> sage: block_matrix(2, 2, [[matrix(0,2), matrix(0,2)], [matrix(0,2), matrix(0,2)]])\n> []\n> sage: parent(_)\n> Full MatrixSpace of 0 by 4 dense matrices over Integer Ring\n> }}}\n\nThat should also work as those arguments are:\n\n```\n    -  ``nrows`` - the number of block rows\n\n    -  ``ncols`` - the number of block cols\n```\n\nIMO, changing it so that it goes through that construction seems like overkill in trying to follow the definition exactly rather than equivalent code.",
    "created_at": "2017-06-03T21:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314052",
    "user": "@tscrim"
}
```

Replying to [comment:4 vdelecroix]:
> Note that the following does work
> {{{
> sage: block_matrix(2, 2, [[matrix(0,2), matrix(0,2)], [matrix(0,2), matrix(0,2)]])
> []
> sage: parent(_)
> Full MatrixSpace of 0 by 4 dense matrices over Integer Ring
> }}}

That should also work as those arguments are:

```
    -  ``nrows`` - the number of block rows

    -  ``ncols`` - the number of block cols
```

IMO, changing it so that it goes through that construction seems like overkill in trying to follow the definition exactly rather than equivalent code.



---

archive/issue_comments_314053.json:
```json
{
    "body": "With your patch it looks like the resulting matrix will always be defined over `QQ`. You would better use `self.matrix_space`.",
    "created_at": "2017-06-04T07:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314053",
    "user": "@videlec"
}
```

With your patch it looks like the resulting matrix will always be defined over `QQ`. You would better use `self.matrix_space`.



---

archive/issue_comments_314054.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-04T08:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314054",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314055.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> With your patch it looks like the resulting matrix will always be defined over `QQ`. You would better use `self.matrix_space`.\n\nThat was really bad of me. Initially I should have used the base ring. However, I like the `self.matrix_space()` approach. I thought about having it return the `.zero()` element, but then I realized that having it sometimes return an immutable matrix could cause confusion.",
    "created_at": "2017-06-04T08:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314055",
    "user": "@tscrim"
}
```

Replying to [comment:6 vdelecroix]:
> With your patch it looks like the resulting matrix will always be defined over `QQ`. You would better use `self.matrix_space`.

That was really bad of me. Initially I should have used the base ring. However, I like the `self.matrix_space()` approach. I thought about having it return the `.zero()` element, but then I realized that having it sometimes return an immutable matrix could cause confusion.



---

archive/issue_comments_314056.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> Replying to [comment:6 vdelecroix]:\n> > With your patch it looks like the resulting matrix will always be defined over `QQ`. You would better use `self.matrix_space`.\n> \n> That was really bad of me. Initially I should have used the base ring. However, I like the `self.matrix_space()` approach. I thought about having it return the `.zero()` element, but then I realized that having it sometimes return an immutable matrix could cause confusion.\n\nCan still use `.zero().__copy__()`.",
    "created_at": "2017-06-05T19:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314056",
    "user": "@videlec"
}
```

Replying to [comment:8 tscrim]:
> Replying to [comment:6 vdelecroix]:
> > With your patch it looks like the resulting matrix will always be defined over `QQ`. You would better use `self.matrix_space`.
> 
> That was really bad of me. Initially I should have used the base ring. However, I like the `self.matrix_space()` approach. I thought about having it return the `.zero()` element, but then I realized that having it sometimes return an immutable matrix could cause confusion.

Can still use `.zero().__copy__()`.



---

archive/issue_comments_314057.json:
```json
{
    "body": "And note that the empty list is not even needed\n\n```\nsage: MatrixSpace(QQ, 3, 4)()\n[0 0 0 0]\n[0 0 0 0]\n[0 0 0 0]\n```\n",
    "created_at": "2017-06-05T19:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314057",
    "user": "@videlec"
}
```

And note that the empty list is not even needed

```
sage: MatrixSpace(QQ, 3, 4)()
[0 0 0 0]
[0 0 0 0]
[0 0 0 0]
```




---

archive/issue_comments_314058.json:
```json
{
    "body": "There is no need to import `matrix` anymore. And you would better import `block_matrix` only if it is needed.",
    "created_at": "2017-06-05T19:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314058",
    "user": "@videlec"
}
```

There is no need to import `matrix` anymore. And you would better import `block_matrix` only if it is needed.



---

archive/issue_comments_314059.json:
```json
{
    "body": "And it would be good to have a check for parent of the result (not only dimensions)\n\n```\nsage: m1 = MatrixSpace(GF(5), 3, 2).an_element()\nsage: m2 = MatrixSpace(GF(5), 0, 4).an_element()\nsage: m1.tensor_product(m2).parent()\nWHOIAM?\n```\n",
    "created_at": "2017-06-05T19:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314059",
    "user": "@videlec"
}
```

And it would be good to have a check for parent of the result (not only dimensions)

```
sage: m1 = MatrixSpace(GF(5), 3, 2).an_element()
sage: m2 = MatrixSpace(GF(5), 0, 4).an_element()
sage: m1.tensor_product(m2).parent()
WHOIAM?
```




---

archive/issue_comments_314060.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-05T19:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314060",
    "user": "@videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_314061.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-05T23:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314061",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314062.json:
```json
{
    "body": "Somewhat surprising, it is faster to pass nothing than to make a copy:\n\n```\nsage: MS = MatrixSpace(QQ, 4, 3)\nsage: %timeit MS.zero().__copy__()\nThe slowest run took 18.18 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 5.32 \u00b5s per loop\nsage: %timeit MS()\nThe slowest run took 25.40 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.27 \u00b5s per loop\n```\n\nI've also taken case of comment:12 and comment:13.",
    "created_at": "2017-06-05T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314062",
    "user": "@tscrim"
}
```

Somewhat surprising, it is faster to pass nothing than to make a copy:

```
sage: MS = MatrixSpace(QQ, 4, 3)
sage: %timeit MS.zero().__copy__()
The slowest run took 18.18 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 5.32 µs per loop
sage: %timeit MS()
The slowest run took 25.40 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.27 µs per loop
```

I've also taken case of comment:12 and comment:13.



---

archive/issue_comments_314063.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-05T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314063",
    "user": "@tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_314064.json:
```json
{
    "body": "It is not the copy that takes time. I think that `.zero()` would better be cached.\n\n```\nsage: MS = MatrixSpace(QQ, 4, 3)\nsage: %timeit MS.zero()\n100000 loops, best of 3: 4.13 \u00b5s per loop\nsage: z = MS.zero()\nsage: %timeit z.__copy__()\n1000000 loops, best of 3: 788 ns per loop\nsage: %timeit MS()\n1000000 loops, best of 3: 1.07 \u00b5s per loop\n```\n",
    "created_at": "2017-06-06T08:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314064",
    "user": "@videlec"
}
```

It is not the copy that takes time. I think that `.zero()` would better be cached.

```
sage: MS = MatrixSpace(QQ, 4, 3)
sage: %timeit MS.zero()
100000 loops, best of 3: 4.13 µs per loop
sage: z = MS.zero()
sage: %timeit z.__copy__()
1000000 loops, best of 3: 788 ns per loop
sage: %timeit MS()
1000000 loops, best of 3: 1.07 µs per loop
```




---

archive/issue_comments_314065.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-06T10:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314065",
    "user": "@videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_314066.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-06-06T11:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314066",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_314067.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-06-06T11:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314067",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_314068.json:
```json
{
    "body": "So `zero()` is cached, but ``@`cached_method` does not optimize for aliases that well:\n\n```\nsage: MS = MatrixSpace(QQ, 4, 3)\nsage: %timeit MS.zero_matrix()\nThe slowest run took 1624.29 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000000 loops, best of 3: 61.6 ns per loop\nsage: %timeit MS.zero()\nThe slowest run took 10.05 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 4.58 \u00b5s per loop\n```\n\nSo I converted to use `MS.zero_matrix().__copy__()`, which ends up being the same path that `MS()` uses, but is more direct.\n\nI'm allowing myself a change back to positive review since it is essentially a trivial change and tests pass.",
    "created_at": "2017-06-06T11:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314068",
    "user": "@tscrim"
}
```

So `zero()` is cached, but ``@`cached_method` does not optimize for aliases that well:

```
sage: MS = MatrixSpace(QQ, 4, 3)
sage: %timeit MS.zero_matrix()
The slowest run took 1624.29 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 61.6 ns per loop
sage: %timeit MS.zero()
The slowest run took 10.05 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.58 µs per loop
```

So I converted to use `MS.zero_matrix().__copy__()`, which ends up being the same path that `MS()` uses, but is more direct.

I'm allowing myself a change back to positive review since it is essentially a trivial change and tests pass.



---

archive/issue_comments_314069.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-06T11:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314069",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_314070.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-09T18:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22532#issuecomment-314070",
    "user": "@vbraun"
}
```

Resolution: fixed
