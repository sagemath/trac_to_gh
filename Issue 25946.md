# Issue 25946: doctest: tolerance parsing and ellipses

Issue created by migration from https://trac.sagemath.org/ticket/26183

Original creator: @bryangingechen

Original creation time: 2018-09-03 02:10:22

CC:  jdemeyer

Keywords: tolerance

When a line of test input tagged with e.g. `# rel tol` throws a warning or error, the line numbers, version numbers, etc. in the tracebacks are tested, even if there are ellipses in the test output signaling that they should be ignored.

Here's a toy example:


```
def foo():
    """
    The following test fails, but I would like it to pass, or for there to be some easy workaround.

    TESTS::
        sage: foo() # rel tol 1e-1
        [0, ... 9]
    """
    print([j for j in range(10)])
```



---

Comment by @bryangingechen created at 2018-09-03 02:39:51

I guess this behavior is known, or at least it is exploited in [this test](https://github.com/sagemath/sage/blob/e8633b09919542a65e7e990c8369fee30c7edefd/src/sage/doctest/parsing.py#L1005).

One partial workaround is to avoid using `#rel tol` in tests which throw errors and just use ellipses to simulate it.


---

Comment by jdemeyer created at 2018-09-03 07:25:26

Do you have an actual use case where you really need this?

I consider this known behaviour with no intention to fix it. In fact, I might go even further and make it an error to combine `...` and `# tol`.


---

Comment by @bryangingechen created at 2018-09-03 15:06:12

I agree that there's probably no good reason why one would ever need both `...` and `#rel tol` / `#abs tol`. Making this into an error would be good; certainly it would have saved me a lot of time figuring out why the test kept failing when I was working on #25260 (see [the second change here](https://git.sagemath.org/sage.git/commit/?h=1743f709cfb55db4fd6bc14c71406fdcc74354e6&id=2d605673654c77aa14456a040bcb22947de8bc7f) if you're curious).


---

Comment by embray created at 2018-09-06 10:01:04

Replying to [comment:2 jdemeyer]:
> Do you have an actual use case where you really need this?
> 
> I consider this known behaviour with no intention to fix it. In fact, I might go even further and make it an error to combine `...` and `# tol`.

I'm not sure I'd go that far.  There are perfectly valid cases one could think of where some long output contains floating point values on which you'd want to use `# tol`, but ignore other parts of the output.

It took me a moment to understand what the original problem was but I see now and think it's a valid bug in the test framework, albeit a small one that I'm not too worried about (if some code is crashing with an unexpected exception I don't really care if the result of the test is a little strange as long as it obviously fails...)


---

Comment by jdemeyer created at 2018-09-06 21:18:23

Replying to [comment:4 embray]:
> There are perfectly valid cases one could think of where some long output contains floating point values on which you'd want to use `# tol`, but ignore other parts of the output.

There may be valid use cases, but those don't seem important enough to add additional complications to the doctest framework to support combining `...` and `tol`.


---

Comment by embray created at 2018-09-07 09:28:58

Perhaps it's not that complicated...  Have you tried?
(I should add, I'm not saying it should be your responsibility to if you don't care about the issue, just I don't know for sure that it makes anything more complicated.)


---

Comment by jdemeyer created at 2018-09-07 14:28:01

Replying to [comment:6 embray]:
> Perhaps it's not that complicated...

It's complicated because `...` might hide numbers. Imagine

```
sage: list(range(5))  # abs tol 0.1
[..., 3.1, ...]
```

This needs to pass (with 3.1 replacing 3). However, to check that, you need to match 3.1 with every number in the list `[0, 1, 2, 3, 4]`.

And there is crazy stuff like

```
sage: pi.n()  # abs tol 0.002
3.13...
```

which should pass because the `3.13...` might be `3.1399` which is less than `0.002` from `pi.n()`.

Note that the case where `...` does not involve any numbers is already supported.


---

Comment by jdemeyer created at 2018-09-07 14:29:04

In other words: mixing string pattern matching with numerical computations is hard.


---

Comment by embray created at 2018-09-11 15:46:20

I see what you're saying now.  I think that with some reasonable rules it is still not that bad and could be made to work, but without that it is better to just not make any guarantees and discourage it.


---

Comment by @bryangingechen created at 2018-09-11 17:48:53

I've changed the ticket description to better reflect the result of the discussion above.


---

Comment by jdemeyer created at 2019-01-11 14:01:59

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-01-11 14:01:59

This doesn't help make doctests pass, but it does give an informative message whenever this problem appears.
----
New commits:


---

Comment by embray created at 2019-01-11 14:08:41

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-11 14:08:41

Okay. Definitely better than nothing, and probably not worth putting too much more thought into.


---

Comment by @bryangingechen created at 2019-01-11 15:39:00

This is fine with me too. This message would've saved me much of the frustration that led me to open this issue.


---

Comment by vbraun created at 2019-01-23 14:18:05

Resolution: fixed
