# Issue 14353: doctesting framework doesn't properly handle atexit

archive/issues_014353.json:
```json
{
    "body": "Assignee: @roed314\n\nCC:  @jdemeyer @roed314\n\nany commands that are registered through atexit are not run if they are called through a `DocTestWorker`.\n\nFor example\n\n```python\nsage: import atexit, shutil, tempfile\nsage: atexit.register(shutil.rmtree, tempfile.mkdtemp())\n```\n\nleaves a temporary file behind when run through the doctesting framework when there shouldn't be (the behaviour that you get when you run the same commands through the sage command line).\n\nIssue created by migration from https://trac.sagemath.org/ticket/14557\n\n",
    "created_at": "2013-05-09T00:03:19Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "doctesting framework doesn't properly handle atexit",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14353",
    "user": "https://github.com/ohanar"
}
```
Assignee: @roed314

CC:  @jdemeyer @roed314

any commands that are registered through atexit are not run if they are called through a `DocTestWorker`.

For example

```python
sage: import atexit, shutil, tempfile
sage: atexit.register(shutil.rmtree, tempfile.mkdtemp())
```

leaves a temporary file behind when run through the doctesting framework when there shouldn't be (the behaviour that you get when you run the same commands through the sage command line).

Issue created by migration from https://trac.sagemath.org/ticket/14557





---

archive/issue_comments_181038.json:
```json
{
    "body": "I guess the bug is really that Python's `multiprocess.Process()` instances don't call atexit handlers when they die.",
    "created_at": "2013-05-09T07:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181038",
    "user": "https://github.com/jdemeyer"
}
```

I guess the bug is really that Python's `multiprocess.Process()` instances don't call atexit handlers when they die.



---

archive/issue_comments_181039.json:
```json
{
    "body": "Working on a patch...",
    "created_at": "2013-05-09T07:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181039",
    "user": "https://github.com/jdemeyer"
}
```

Working on a patch...



---

archive/issue_comments_181040.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-09T08:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181040",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_181041.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-05-09T19:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181041",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_181042.json:
```json
{
    "body": "when not running long doctests the second `os.path.isfile(F)` will fail, otherwise this looks good",
    "created_at": "2013-05-09T19:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181042",
    "user": "https://github.com/ohanar"
}
```

when not running long doctests the second `os.path.isfile(F)` will fail, otherwise this looks good



---

archive/issue_comments_181043.json:
```json
{
    "body": "Attachment [14557_doctest_atexit.patch](tarball://root/attachments/some-uuid/ticket14557/14557_doctest_atexit.patch) by @jdemeyer created at 2013-05-10 08:25:05",
    "created_at": "2013-05-10T08:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181043",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14557_doctest_atexit.patch](tarball://root/attachments/some-uuid/ticket14557/14557_doctest_atexit.patch) by @jdemeyer created at 2013-05-10 08:25:05



---

archive/issue_comments_181044.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-05-10T08:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181044",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_181045.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-10T22:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181045",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_181046.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-13T13:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-181046",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_014135.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-05-13T13:27:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14353#event-14135"
}
```
