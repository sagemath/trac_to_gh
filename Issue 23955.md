# Issue 23955: -std=c99 causes numerous problems on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-11-10 16:49:53

#23919 introduced numerous regressions in the Cygwin build.  Unfortunately this ticket was not tested by the Cygwin patchbot because it just didn't get to it (it is rather slow, and has been crashing lately for some reason).  I was also not made aware of this ticket.

Many headers included in newlib (Cygwin's libc) have some compatibility problems with `-std=c99`.  `-std=gnu++98` tends to fare better.

In the short term I might just set that universally for Cygwin, rather than try to deal with each individual issue that comes up.


---

Comment by embray created at 2017-11-10 17:53:31

New commits:


---

Comment by embray created at 2017-11-10 17:53:31

Changing keywords from "" to "windows cygwin".


---

Comment by embray created at 2017-11-10 17:53:31

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-11-11 04:04:14

Do you mean `sys.platform != 'cygwin'`?


---

Comment by embray created at 2017-11-11 13:11:28

Oops that's weird. I just did a test build of this before posting and it worked, but looking at the logs I definitely had this the right way around before. I don't know how it got switched just before I committed. Been doing a lot of that lately. I was tired and rushed.


---

Comment by embray created at 2017-11-11 13:11:28

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2017-11-11 14:51:44

Replying to [comment:4 embray]:
> Oops that's weird. I just did a test build of this before posting and it worked, but looking at the logs I definitely had this the right way around before. I don't know how it got switched just before I committed. Been doing a lot of that lately. I was tired and rushed. 

Definitely `needs_work` : Python3 now fails to build (I'll upload the (compressed) log momentarily...


---

Comment by charpent created at 2017-11-11 14:52:38

Failure to build python3 with #24192.


---

Attachment

`@`charpent, did you try it with `!=`? `@`embray, can you push the correction?


---

Comment by charpent created at 2017-11-11 15:52:26

Replying to [comment:6 tscrim]:
> `@`charpent, did you try it with `!=`?

Nope. I'm a bit out of my (excessively shallow) depth, here. I prefer to wait for embray to push it itself : he knows what he's doing ; not me...

> `@`embray, can you push the correction?

Seconded.


---

Comment by charpent created at 2017-11-12 00:28:49

I bit the bullet, `git checkout`ed #24192, `git pull`ed #24121, #24189, #24191 and inverted the test line 435 of `src/setup.py`.

To no avail : fails to build the library... I throw the towel for now...

==> still `needs_work`


---

Comment by git created at 2017-11-13 08:26:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-11-13 08:32:23

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-13 09:06:50

1. Why `gnu++98` and not `gnu++11`? Sooner or later, we will require C++11 and then this will break on Cygwin. In fact, I thought that we already required C++11 so I'm slightly surprised that `gnu++98` even works.

2. I think it is more readable to reverse the `if` condition and write

```
if sys.platform == "cygwin":
    # Cygwin stuff
else:
    # Generic stuff
```



---

Comment by jdemeyer created at 2017-11-13 09:11:53

3. This only deals with the _default_ flags in case no other `-std` flags were given (coming from pkgconfig, from `module_list.py`, from `# distutils` declarations...). If Cygwin truly has problems with `-std=c...`, then it should probably replace all such flags.


---

Comment by embray created at 2017-11-13 12:29:16

It doesn't have a problem in all cases, just some.  But you raise a good point, maybe for Cygwin it just force the safest flags.  I'll try `gnu++11`--you're right, that _should_ work.  I think at one point I had a problem with some module compiling with C++11 but I might have misremembered.

In general most of the problems here has to do with bugs/oddities in how newlib handles flags like `_POSIX_SOURCE` depending on the order in which some headers are included.


---

Comment by charpent created at 2017-11-14 08:36:00

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2017-11-14 08:36:00

8.1rc0 + #24121 + #24189 + #24191 + #24192 sill doesn't build on Windows+Cygwin. The problem happens at the (final) Sage library building, where some files fail to build, the error message pointing to the need of C++11 support.

I'll try to  upload the (compressed) log.

==>`needs_work`


---

Comment by charpent created at 2017-11-14 08:41:04

Failed attempt to build with #24121+#24189+#24191+#24192


---

Attachment

So it seems that I was correct that Sage _requires_ C++11.


---

Comment by embray created at 2017-11-14 11:54:26

I'm still going to try it out, but that's not true.  With the current version of this ticket everything built correctly and the test suite passed so I'm not sure what problem Emmanuel is having.


---

Comment by git created at 2017-11-14 12:25:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-11-14 12:29:00

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-11-14 12:29:00

Reworked slightly, using `-std=gnu++11` for Cygwin.  I'm still keeping the defaults for modules that already have a `-std=` flag.  In principle I should probably add these flags by force on Cygwin but it so happens that for now it works okay.  So I'd rather leave it as is for now as a short-term workaround, and then see about addressing individual problems with certain modules individually.


---

Comment by jdemeyer created at 2017-11-14 12:32:44

Just one detail: could you add a reference to this ticket in a comment, so we know why Cygwin needs to be special?


---

Comment by charpent created at 2017-11-14 22:39:39

Smells good : after resetting --hard and pulling that branch again :
* `sage -b` finished without errors (at last !)
* `make` built the doc without problems.

Since this build is a bit of a chimera (different parts built with dufferent versions of `setup.py`), I'll give it a rebuild (`make distclean && make ptestlong`) before giving it positive review. This will take a while (especially if it gets interrupted by those pesky "Resource temporarily unavailable"...).

Thank you for your patience !


---

Comment by charpent created at 2017-11-15 07:02:43

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2017-11-15 07:02:43

Sage 8.1rc0 + #24121 + #24189 + #24191 + #24192 builds and passes ptestlong with two transient failures :


```
----------------------------------------------------------------------
sage -t --long --warn-long 114.5 src/sage/parallel/map_reduce.py  # 2 doctests failed
sage -t --long --warn-long 114.5 src/sage/misc/temporary_file.py  # 5 doctests failed
----------------------------------------------------------------------
```


Both doctests pass without error when ran standalone.

==>`positive_review`

Note : this is long (about 8 hours for full rebuild and tests, including about 1/4h lost due to a "Resource temporarily unavailable"...), on a virtual machine allocated 4 CPUs and 8 GB RAM.

This is mainly due to a long build : from install.log :

```
real	129m17,235s
user	179m33,147s
sys	102m1,896s
```

then

```
real	151m57,343s
user	242m18,472s
sys	54m40,605s
```



On the same bare metal, running Debian testing (8 CPUs, 16 GB RAM) :

```
real	54m55,725s
user	257m40,535s
sys	6m44,282s
```


About 281 minutes of real time vs 54 minutes. One notes
* 156 minutes of "sys" CPU time, vs about 7 minutes on "bare" Debian.
* 420 minutes of "user" CPU time, vs 257 minutes on "bare" Debian

Accounting for the avilability of about twice the resources on ""bare" Debian, that means that the large "Cygwin overhead" may be attributed at least in part to inefficiencies in system calls.

Things are different for Sage use, as exemplified by the doctests. On Cygwin :

```
Total time for all tests: 7468.6 seconds
    cpu time: 18746.4 seconds
    cumulative wall time: 26871.3 seconds
```


On the same bare metal :

```
Total time for all tests: 3397.3 seconds
    cpu time: 20643.2 seconds
    cumulative wall time: 26481.0 seconds
```


Both wall time and CPU times are roughly proportional to the available resources.

One is tempted to conclude that Cygwin is piss-poor at Sage development but results in an usable Sage. But of course, this is way too rough to be credible...

One also notes discrepancies between sum of "user" and "sys" times and total elapsed time. This may be due to more "system" activity on Windows. And the fact that Windows runs on a VM, which needs some CPU time for itself.

HTH,


---

Comment by embray created at 2017-11-15 13:45:33

Still need to add a comment per #24192#comment:19 (agreed)


---

Comment by embray created at 2017-11-15 13:45:33

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-11-15 13:47:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-11-15 13:48:32

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-11-15 13:59:53

Replying to [comment:21 charpent]:
> Note : this is long (about 8 hours for full rebuild and tests, including about 1/4h lost due to a "Resource temporarily unavailable"...), on a virtual machine allocated 4 CPUs and 8 GB RAM.

It shouldn't take that long.  Also, are using the openblas or "atlas".  Selecting "atlas" and supplying `SAGE_ATLAS_LIB=/usr/lib` will allow it to use the BLAS from Cygwin's lapack package which is going to be slower, but not typically _that_ slow.

I need to rework BLAS installation so it can use the version from the system more easily and more explicitly.  While that does fall under my general work of making Sage use more system packages, this is a special enough case that it might be worth the effort for me to address it specifically now.  That way it would also be easier to use Cygwin's native openblas package.


---

Comment by embray created at 2017-11-15 14:02:40

Also as far as installation time goes, it is slower to do a full build on Cygwin.  This mostly has to do with the significantly greater overhead involved in each process that is run.  You'll probably notice that every package's `./configure` is _slowwwwww_ for this reason.  I have an experimental branch that makes it easier to cache configure results for each package, but this seems to shave off at best 5 minutes (which is still not nothing).  ccache goes a long way too...


---

Comment by vbraun created at 2017-11-17 13:28:06

Resolution: fixed
