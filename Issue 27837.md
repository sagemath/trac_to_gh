# Issue 27837: Fix caching of Macaulay2 polynomial rings

Issue created by migration from https://trac.sagemath.org/ticket/28074

Original creator: @mwageringel

Original creation time: 2019-06-27 18:52:14

CC:  dimpase saliola

Keywords: Macaulay2

This ticket:

- adds caching of univariate Macaulay2 polynomial rings;

- fixes an issue where, upon conversion of an ideal from Sage to Macaulay2, the Macaulay2 ring that is already cached does not get re-used, but is reconstructed instead;


```
sage: R.<x,y> = QQ[]
sage: R1 = macaulay2(R)
sage: I = R.ideal(y^2 - x)
sage: R2 = macaulay2(I).ring()
sage: R1._operator('===', R2)   # should be true
false
```


- moves `is_exact()` from `MPolynomialRing_macaulay2_repr` to `MPolynomialRing_base` where it seems to belong.



---

Comment by @mwageringel created at 2019-06-27 19:11:07

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-06-27 19:11:07

This is accomplished by refactoring and deduplicating some code related to the conversion. In some places, I replaced `_macaulay2_()` methods by implementations of `_macaulay2_init_()` which returns a string to be used as input for the Macaulay2 interpreter. This has the advantage that the generic interface mechanism in `sage.structure.sage_object` then takes care of the caching. The methods `_macaulay2_set_ring()` and `_macaulay2_base_str()` are removed.

(For the future – not in this ticket – it would also be nice to have caching when converting in the other direction, from Macaulay2 to Sage, so that the new Sage object remembers the Macaulay2 element it was constructed from. However, none of the interfaces seem to be doing this currently, as far as I can tell, so this could be more complicated to deal with.)

This branch is based on #27979 to avoid merge conflicts. Only the last commit is new. I tested this with Macaulay2 version 1.12 and Python 2 and 3.
----
New commits:


---

Comment by git created at 2019-06-28 15:08:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2019-06-28 15:11:02

I have just fixed 2 pyflakes warnings. The remaining one is about `long` which is dealt with in #27826.


---

Comment by git created at 2019-07-29 09:46:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2019-07-29 09:50:43

I rebased on 8.9.beta4 and changed the signature of `is_exact` to resolve a Cython warning.


---

Comment by git created at 2019-08-19 18:45:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2019-08-19 18:46:48

Rebased.


---

Comment by chapoton created at 2019-09-18 18:52:10

red branch


---

Comment by chapoton created at 2019-09-18 18:52:10

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-09-18 19:00:25

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-09-18 19:00:25

New commits:


---

Comment by dimpase created at 2019-09-18 19:28:34

looks good to me. Sorry for sitting on it for so long.


---

Comment by dimpase created at 2019-09-18 19:28:34

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-09-30 08:12:27

moving milestone to 9.0 (after release of 8.9)


---

Comment by vbraun created at 2019-10-06 23:06:56

Resolution: fixed
