# Issue 22201: docbuild: Use lexists when testing whether a symlink exists

Issue created by migration from Trac.

Original creator: infinity0

Original creation time: 2017-02-25 15:15:47




---

Comment by infinity0 created at 2017-02-25 15:17:37

Changing status from new to needs_review.


---

Comment by infinity0 created at 2017-02-25 15:17:37

New commits:


---

Comment by infinity0 created at 2017-02-25 15:17:37

Changing component from PLEASE CHANGE to build.


---

Comment by infinity0 created at 2017-02-25 15:17:37

Changing type from PLEASE CHANGE to defect.


---

Comment by vdelecroix created at 2017-02-25 17:37:10

This looks annoying. Why the symlink is pointing to a non-existing directory in the first place?


---

Comment by infinity0 created at 2017-02-25 18:18:25

I can't remember now. Possibly I was messing around with a solution to #21732 or #22088 or just getting the Debian package working in the first place.

But the logic shouldn't break just because I might've been doing unusual things. There's already logic to remove a regular file or a working symlink to a file, so we should also remove broken symlinks.


---

Comment by jdemeyer created at 2017-02-25 19:50:37

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-02-25 19:50:37

Instead of trying to figure out whether to run `unlink()` or `rmtree()`, why not use EAFP principles and use `try`/`except`? Something like

```
try:
    os.unlink(path)
except OSError:
    try:
        shutil.rmtree(path)
    except OSError:
        if os.path.lexists(path):
            raise
```


PS: I sometimes wonder why Python makes it so hard to implement common shell commands like `rm -rf` or `mkdir -p` correctly.


---

Comment by git created at 2017-02-25 22:23:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-02-25 22:27:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by infinity0 created at 2017-02-25 22:28:56

I tweaked what you suggested to be a bit shorter. It's not fully EAFP but I think the brevity makes up for it.

Interestingly on Python3 they have a special subclass of OSError called IsADirectoryError that would make this code even shorter, but never mind.


---

Comment by infinity0 created at 2017-02-25 22:30:24

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-02-25 22:31:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by infinity0 created at 2017-02-25 22:32:19

whoops, I forgot to re-raise for other types of errors. ¬.¬


---

Comment by git created at 2017-03-11 17:08:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by infinity0 created at 2017-03-11 17:17:25

I realised the previous version (in comment:10) is wrong, here is an updated version. If you don't like it, I can also do the longer EAFP version that you posted earlier.

I actually think the first one (my original commit) is best, it's slightly long-winded but at least the error messages are exact. With both this recent version and your EAFP version, the error messages could be misleading, e.g.

Recent version:
- real problem: grand-child file can't be removed because child directory is not writable
- raised error: static_dir is a directory

EAFP version:
- real problem: parent directory is not writable
- raised error: static_dir is not a directory


---

Comment by jdemeyer created at 2017-06-21 14:50:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-22 07:24:42

Resolution: fixed
