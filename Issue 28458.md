# Issue 28458: gcc: mismatch of assembler / linker during configure

archive/issues_028458.json:
```json
{
    "body": "CC:  dimpase\n\nWhen activating the sage environment (e.g. with `sage -sh`) for some reason (I'm not sure what the motivation is) it sets the `AS` environment variable by calling\n\n```\n$CC -print-file-name=as\n```\n\nand likewise with `LD`.\n\nIn my case this command is just returning the strings `as` and `ld` without a full path.\n\nHowever, when I run `./configure` in this environment I get output like:\n\n\n```\nchecking g++ version... 7.4.0\nconfigure: Installing GCC because there is a mismatch of assemblers\nconfigure:   g++ -std=gnu++11 -std=gnu++11 uses /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe\nconfigure:   $AS equal to as\nconfigure: Installing GCC because there is a mismatch of linkers\nconfigure:   g++ -std=gnu++11 -std=gnu++11 uses /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/ld.exe\nconfigure:   $LD equal to ld\n```\n\n\nand, in turn, sage will try to build its own gcc.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28695\n\n",
    "created_at": "2019-11-05T13:59:04Z",
    "labels": [
        "build: configure",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "gcc: mismatch of assembler / linker during configure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28458",
    "user": "embray"
}
```
CC:  dimpase

When activating the sage environment (e.g. with `sage -sh`) for some reason (I'm not sure what the motivation is) it sets the `AS` environment variable by calling

```
$CC -print-file-name=as
```

and likewise with `LD`.

In my case this command is just returning the strings `as` and `ld` without a full path.

However, when I run `./configure` in this environment I get output like:


```
checking g++ version... 7.4.0
configure: Installing GCC because there is a mismatch of assemblers
configure:   g++ -std=gnu++11 -std=gnu++11 uses /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe
configure:   $AS equal to as
configure: Installing GCC because there is a mismatch of linkers
configure:   g++ -std=gnu++11 -std=gnu++11 uses /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/ld.exe
configure:   $LD equal to ld
```


and, in turn, sage will try to build its own gcc.

Issue created by migration from https://trac.sagemath.org/ticket/28695





---

archive/issue_comments_401893.json:
```json
{
    "body": "How about changing `file` to `prog`?\n\n```\n$ gcc  -print-prog-name=as\n/usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/../../../../x86_64-pc-linux-gnu/bin/as\n```\n",
    "created_at": "2019-11-05T14:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401893",
    "user": "dimpase"
}
```

How about changing `file` to `prog`?

```
$ gcc  -print-prog-name=as
/usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/../../../../x86_64-pc-linux-gnu/bin/as
```




---

archive/issue_comments_401894.json:
```json
{
    "body": "Yes, that seems to give the answer the configure script is likely looking for:\n\n\n```\n$ gcc  -print-prog-name=as\n/usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe\n```\n\n\nHowever, I wonder why `sage-env` sets `$AS` and `$LD` in the first place.",
    "created_at": "2019-11-05T16:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401894",
    "user": "embray"
}
```

Yes, that seems to give the answer the configure script is likely looking for:


```
$ gcc  -print-prog-name=as
/usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe
```


However, I wonder why `sage-env` sets `$AS` and `$LD` in the first place.



---

archive/issue_comments_401895.json:
```json
{
    "body": "#14296 checks that as and ld match what compiler have, although it does it wrongly, imho.",
    "created_at": "2019-11-05T16:33:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401895",
    "user": "dimpase"
}
```

#14296 checks that as and ld match what compiler have, although it does it wrongly, imho.



---

archive/issue_comments_401896.json:
```json
{
    "body": "Replying to [comment:4 dimpase]:\n> #14296 checks that as and ld match what compiler have, although it does it wrongly, imho.\n\nYes, as you say it should probably use `-print-prog-name` instead; I wonder if that was something that changed in gcc at one point.\n\nHowever, that still doesn't answer why `sage-env` sets those variables too, which seems unnecessary...",
    "created_at": "2019-11-06T12:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401896",
    "user": "embray"
}
```

Replying to [comment:4 dimpase]:
> #14296 checks that as and ld match what compiler have, although it does it wrongly, imho.

Yes, as you say it should probably use `-print-prog-name` instead; I wonder if that was something that changed in gcc at one point.

However, that still doesn't answer why `sage-env` sets those variables too, which seems unnecessary...



---

archive/issue_comments_401897.json:
```json
{
    "body": "Also I think it's a bit overkill that it will just go ahead and build gcc in this case.  Perhaps it should just error-out the `configure` instead.  It's a misconfiguration, and should tell the user as such, rather than just plowing ahead and compiling a different gcc.",
    "created_at": "2019-11-06T12:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401897",
    "user": "embray"
}
```

Also I think it's a bit overkill that it will just go ahead and build gcc in this case.  Perhaps it should just error-out the `configure` instead.  It's a misconfiguration, and should tell the user as such, rather than just plowing ahead and compiling a different gcc.



---

archive/issue_comments_401898.json:
```json
{
    "body": "I see; the `sage-env` changes were made as part of that ticket as well, I guess to prevent a user's `$LD` or `$AS` from breaking things somehow.\n\nI still think that's overkill; we can't just override every imaginable environment variable in the user's environment that might have some undesired impact.  This strikes me as the kind of thing that annoyed someone once, just enough, that it required a workaround.\n\nHowever, I'd be okay with keeping the `sage-env` stuff as long as it is changed to use `-print-prog-name`, and we change the `configure` script to make inconsistency on this a hard error.",
    "created_at": "2019-11-06T12:56:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401898",
    "user": "embray"
}
```

I see; the `sage-env` changes were made as part of that ticket as well, I guess to prevent a user's `$LD` or `$AS` from breaking things somehow.

I still think that's overkill; we can't just override every imaginable environment variable in the user's environment that might have some undesired impact.  This strikes me as the kind of thing that annoyed someone once, just enough, that it required a workaround.

However, I'd be okay with keeping the `sage-env` stuff as long as it is changed to use `-print-prog-name`, and we change the `configure` script to make inconsistency on this a hard error.



---

archive/issue_comments_401899.json:
```json
{
    "body": "Yes, I agree that ./configure should just error out on such a mismatch.\nAs to sage-env, I'd have just removed that check, as over-engineering (but proceed as you like, your solution just might need more checks, with clang...).",
    "created_at": "2019-11-06T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401899",
    "user": "dimpase"
}
```

Yes, I agree that ./configure should just error out on such a mismatch.
As to sage-env, I'd have just removed that check, as over-engineering (but proceed as you like, your solution just might need more checks, with clang...).



---

archive/issue_comments_401900.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401900",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_401901.json:
```json
{
    "body": "Ahhh, I forgot about this, but it still causes problems when trying to install optional packages if you're already in a sage environment shell (this is especially a problem for the Windows version).  I'll go ahead and make a patch...",
    "created_at": "2020-01-08T13:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401901",
    "user": "embray"
}
```

Ahhh, I forgot about this, but it still causes problems when trying to install optional packages if you're already in a sage environment shell (this is especially a problem for the Windows version).  I'll go ahead and make a patch...



---

archive/issue_comments_401902.json:
```json
{
    "body": "Interesting--for some reason I wasn't able to reproduce this problem on my local Windows development build, but I was on Sage installed by the Windows installer.  It turns out this almost already works because the current code in `build/pkgs/gcc/spkg-configure.m4` reads like:\n\n\n```\n    if test -n \"$AS\"; then\n        CXX_as=`$CXX -print-prog-name=as 2>/dev/null`\n        CXX_as=`command -v $CXX_as 2>/dev/null`\n        cmd_AS=`command -v $AS`\n\n        if ! (test \"$CXX_as\" = \"\" -o \"$CXX_as\" -ef \"$cmd_AS\"); then\n            SAGE_SHOULD_INSTALL_GCC([there is a mismatch of assemblers])\n            AC_MSG_NOTICE([  $CXX uses $CXX_as])\n            AC_MSG_NOTICE([  \\$AS equal to $AS])\n        fi\n    fi\n```\n\n\nThe tricky part is in the `test ... $CXX_as -ef $cmd_AS`.  I didn't know this but the `-ef` flag means the two files have the same device and inode number.  In my case I had\n\n\n```\nCXX_as=/usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe\ncmd_AS=/usr/bin/as\n```\n\n\nbut it turns out this test is *true* in my case, so `/usr/bin/as` must be a hard link to the real `as.exe`.  However, after being bundled into the installer and then unpacked the two files are just copies of each other--oops.  Right now the build of the Windows installer does not have a good way to preserve hard links.\n\nNevertheless, the fact that this happens to work on my Cygwin install is a happy accident.  I think this is still an issue, and the fix is the same.",
    "created_at": "2020-01-08T13:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401902",
    "user": "embray"
}
```

Interesting--for some reason I wasn't able to reproduce this problem on my local Windows development build, but I was on Sage installed by the Windows installer.  It turns out this almost already works because the current code in `build/pkgs/gcc/spkg-configure.m4` reads like:


```
    if test -n "$AS"; then
        CXX_as=`$CXX -print-prog-name=as 2>/dev/null`
        CXX_as=`command -v $CXX_as 2>/dev/null`
        cmd_AS=`command -v $AS`

        if ! (test "$CXX_as" = "" -o "$CXX_as" -ef "$cmd_AS"); then
            SAGE_SHOULD_INSTALL_GCC([there is a mismatch of assemblers])
            AC_MSG_NOTICE([  $CXX uses $CXX_as])
            AC_MSG_NOTICE([  \$AS equal to $AS])
        fi
    fi
```


The tricky part is in the `test ... $CXX_as -ef $cmd_AS`.  I didn't know this but the `-ef` flag means the two files have the same device and inode number.  In my case I had


```
CXX_as=/usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe
cmd_AS=/usr/bin/as
```


but it turns out this test is *true* in my case, so `/usr/bin/as` must be a hard link to the real `as.exe`.  However, after being bundled into the installer and then unpacked the two files are just copies of each other--oops.  Right now the build of the Windows installer does not have a good way to preserve hard links.

Nevertheless, the fact that this happens to work on my Cygwin install is a happy accident.  I think this is still an issue, and the fix is the same.



---

archive/issue_comments_401903.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-01-08T14:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401903",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_401904.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2020-01-08T14:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401904",
    "user": "embray"
}
```

Changing priority from major to minor.



---

archive/issue_comments_401905.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-08T14:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401905",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401906.json:
```json
{
    "body": "lgtm",
    "created_at": "2020-01-08T17:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401906",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_401907.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-08T17:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401907",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401908.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-11T17:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28458#issuecomment-401908",
    "user": "vbraun"
}
```

Resolution: fixed
