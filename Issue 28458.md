# Issue 28458: gcc: mismatch of assembler / linker during configure

Issue created by migration from https://trac.sagemath.org/ticket/28695

Original creator: embray

Original creation time: 2019-11-05 13:59:04

CC:  dimpase

When activating the sage environment (e.g. with `sage -sh`) for some reason (I'm not sure what the motivation is) it sets the `AS` environment variable by calling

```
$CC -print-file-name=as
```

and likewise with `LD`.

In my case this command is just returning the strings `as` and `ld` without a full path.

However, when I run `./configure` in this environment I get output like:


```
checking g++ version... 7.4.0
configure: Installing GCC because there is a mismatch of assemblers
configure:   g++ -std=gnu++11 -std=gnu++11 uses /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe
configure:   $AS equal to as
configure: Installing GCC because there is a mismatch of linkers
configure:   g++ -std=gnu++11 -std=gnu++11 uses /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/ld.exe
configure:   $LD equal to ld
```


and, in turn, sage will try to build its own gcc.


---

Comment by dimpase created at 2019-11-05 14:02:16

How about changing `file` to `prog`?

```
$ gcc  -print-prog-name=as
/usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/../../../../x86_64-pc-linux-gnu/bin/as
```



---

Comment by embray created at 2019-11-05 16:24:07

Yes, that seems to give the answer the configure script is likely looking for:


```
$ gcc  -print-prog-name=as
/usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe
```


However, I wonder why `sage-env` sets `$AS` and `$LD` in the first place.


---

Comment by dimpase created at 2019-11-05 16:33:55

#14296 checks that as and ld match what compiler have, although it does it wrongly, imho.


---

Comment by embray created at 2019-11-06 12:52:04

Replying to [comment:4 dimpase]:
> #14296 checks that as and ld match what compiler have, although it does it wrongly, imho.

Yes, as you say it should probably use `-print-prog-name` instead; I wonder if that was something that changed in gcc at one point.

However, that still doesn't answer why `sage-env` sets those variables too, which seems unnecessary...


---

Comment by embray created at 2019-11-06 12:53:23

Also I think it's a bit overkill that it will just go ahead and build gcc in this case.  Perhaps it should just error-out the `configure` instead.  It's a misconfiguration, and should tell the user as such, rather than just plowing ahead and compiling a different gcc.


---

Comment by embray created at 2019-11-06 12:56:53

I see; the `sage-env` changes were made as part of that ticket as well, I guess to prevent a user's `$LD` or `$AS` from breaking things somehow.

I still think that's overkill; we can't just override every imaginable environment variable in the user's environment that might have some undesired impact.  This strikes me as the kind of thing that annoyed someone once, just enough, that it required a workaround.

However, I'd be okay with keeping the `sage-env` stuff as long as it is changed to use `-print-prog-name`, and we change the `configure` script to make inconsistency on this a hard error.


---

Comment by dimpase created at 2019-11-06 13:01:30

Yes, I agree that ./configure should just error out on such a mismatch.
As to sage-env, I'd have just removed that check, as over-engineering (but proceed as you like, your solution just might need more checks, with clang...).


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by embray created at 2020-01-08 13:19:00

Ahhh, I forgot about this, but it still causes problems when trying to install optional packages if you're already in a sage environment shell (this is especially a problem for the Windows version).  I'll go ahead and make a patch...


---

Comment by embray created at 2020-01-08 13:49:23

Interesting--for some reason I wasn't able to reproduce this problem on my local Windows development build, but I was on Sage installed by the Windows installer.  It turns out this almost already works because the current code in `build/pkgs/gcc/spkg-configure.m4` reads like:


```
    if test -n "$AS"; then
        CXX_as=`$CXX -print-prog-name=as 2>/dev/null`
        CXX_as=`command -v $CXX_as 2>/dev/null`
        cmd_AS=`command -v $AS`

        if ! (test "$CXX_as" = "" -o "$CXX_as" -ef "$cmd_AS"); then
            SAGE_SHOULD_INSTALL_GCC([there is a mismatch of assemblers])
            AC_MSG_NOTICE([  $CXX uses $CXX_as])
            AC_MSG_NOTICE([  \$AS equal to $AS])
        fi
    fi
```


The tricky part is in the `test ... $CXX_as -ef $cmd_AS`.  I didn't know this but the `-ef` flag means the two files have the same device and inode number.  In my case I had


```
CXX_as=/usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/as.exe
cmd_AS=/usr/bin/as
```


but it turns out this test is _true_ in my case, so `/usr/bin/as` must be a hard link to the real `as.exe`.  However, after being bundled into the installer and then unpacked the two files are just copies of each other--oops.  Right now the build of the Windows installer does not have a good way to preserve hard links.

Nevertheless, the fact that this happens to work on my Cygwin install is a happy accident.  I think this is still an issue, and the fix is the same.


---

Comment by embray created at 2020-01-08 14:22:28

New commits:


---

Comment by embray created at 2020-01-08 14:22:28

Changing priority from major to minor.


---

Comment by embray created at 2020-01-08 14:22:28

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-01-08 17:54:38

lgtm


---

Comment by dimpase created at 2020-01-08 17:54:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-11 17:45:10

Resolution: fixed
