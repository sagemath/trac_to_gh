# Issue 11716: Sage is missing the lambert_w function conversion from Maxima

Issue created by migration from https://trac.sagemath.org/ticket/11888

Original creator: benjaminfjones

Original creation time: 2011-10-01 23:04:08

Assignee: burcin

CC:  kcrisman ktkohl

Keywords: lambert_w symbolics conversion maxima

Maxima returns solutions to some exponential equations in terms of the `lambert_w` function. Sage is missing a conversion for this function:


```

sage: solve(e^(5*x)+x==0, x, to_poly_solve=True)
[x == -1/5*lambert_w(5)]
sage: S = solve(e^(5*x)+x==0, x, to_poly_solve=True)
sage: z = S[0].rhs()
sage: z
-1/5*lambert_w(5)
sage: N(z)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/Users/jonesbe/sage/sage-4.7.2.alpha2/devel/sage-test/sage/<ipython console> in <module>()

/Users/jonesbe/sage/latest/local/lib/python2.6/site-packages/sage/misc/functional.pyc in numerical_approx(x, prec, digits)
   1264             prec = int((digits+1) * 3.32192) + 1
   1265     try:
-> 1266         return x._numerical_approx(prec)
   1267     except AttributeError:
   1268         from sage.rings.complex_double import is_ComplexDoubleElement

/Users/jonesbe/sage/latest/local/lib/python2.6/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression._numerical_approx (sage/symbolic/expression.cpp:17950)()

TypeError: cannot evaluate symbolic expression numerically
sage: lambert_w(5)
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)

/Users/jonesbe/sage/sage-4.7.2.alpha2/devel/sage-test/sage/<ipython console> in <module>()

NameError: name 'lambert_w' is not defined
sage: 
```


`mpmath` can evaluate the `lambert_w` function, so it should be easy to add a new symbolic function to Sage that will fix this issue.


---

Attachment

add lambert_w symbolic function


---

Comment by benjaminfjones created at 2012-01-10 02:44:56

Changing keywords from "lambert_w symbolics conversion maxima" to "lambert_w symbolics conversion maxima sd35.5".


---

Comment by benjaminfjones created at 2012-01-10 02:44:56

Changing status from new to needs_review.


---

Comment by benjaminfjones created at 2012-01-10 02:44:56

Preliminary patch needs review.  The function has been added using the template developed as part of #11143. The issue described in the description is addressed in one of the doctests.


---

Comment by kini created at 2012-01-10 11:37:20

apply to $SAGE_ROOT/devel/sage


---

Attachment

Running `make ptestlong` now. I fixed a couple of doctests that broke, and fixed some typos and rST syntax problems in your docstring.


---

Comment by kini created at 2012-01-10 12:12:58

All tests pass.


---

Comment by benjaminfjones created at 2012-01-10 20:05:47

Thanks for the fixes, kini. I've run `make ptestlong` with the patches applied and verified that all tests pass. Maybe I can get `@`kcrisman to finish a review this afternoon.


---

Comment by kcrisman created at 2012-01-10 20:24:20

I don't see any obvious problems, but the random expression usually doesn't change much with these new functions and this one is _really_ different.  

It's also spread across many lines, and I'm not sure if this is appropriate (just in this one case, of course).


---

Comment by kini created at 2012-01-11 01:56:46

I spread it across lines because 1) I was trying to keep within the recommended PEP 8 guidelines for line length, and 2) because of this


```
[2012-01-10 22:54:53] <kini> while I was fixing the second doctest, some weird
stuff started happening to vim
[2012-01-10 22:55:02] <kini> I thought my terminal had frozen or something
[2012-01-10 22:56:02] <kini> but it turns out that apparently opening a new line
after a line with a 1800-character-long Sage symbolic expression on it causes
vim to take a full 12 seconds to compute the correct indentation level for the
next line
[2012-01-10 22:56:20] <benjaminfjones> ha!
[2012-01-10 22:56:30] <kini> on a 4.5 GHz Core i5-2500K and utilizing three
cores!
[2012-01-10 22:56:39] <benjaminfjones> wow
```


What is inappropriate about adding line breaks?

As for the length of the expression, it seems to be a fluke. With the patches applied, starting with random seeds other than `2` gives expressions of a more "normal" length.


---

Comment by benjaminfjones created at 2012-01-11 03:30:58

I agree, it looks like a fluke that the expression grows so large. I did some testing of `random_expr` and found that it "normally" produces output around 200 - 400 character long, but occasionally the outputs can be 10 times that (I saw a few around 2500 characters long!)


---

Comment by fredrik.johansson created at 2012-01-11 15:26:12

I strongly recommend implementing the general version of the Lambert W function (taking a branch parameter).


---

Comment by kcrisman created at 2012-01-11 15:43:34

> I strongly recommend implementing the general version of the Lambert W function (taking a branch parameter).

Can you be more specific?  (Is this standard with other multivalued functions in Sage?)  Maybe this could be a separate ticket, unless the change was really easy.


---

Comment by benjaminfjones created at 2012-01-11 15:55:10

The change should be simple. mpmath implements the a branch `W_k(z)` for each integer `k`. It's just a matter of adding a second parameter to the wrapper and putting in some tests. I'm sitting on the train from Beverly MA to Logan airport now, I'll see if I can get it uploaded before the train stops (or my battery dies).


---

Comment by kcrisman created at 2012-01-11 15:57:58

Sweet, I didn't realize it was that quick.  I love doing Sage development on that train :)  There is also free wifi at Logan, I believe.


---

Comment by kcrisman created at 2012-02-03 03:23:33

Ping.  I'd love to review this but sounds like Fredrik's point is good and if it's pretty easy for you to add that, we might as well.


---

Comment by fredrik.johansson created at 2012-02-03 10:14:29

Yes, it should be easy; just add an optional branch parameter, lambertw(z, branch=0).

Another suggestion is to use scipy.special.lambertw for evaluation over RDF and CDF. The SciPy implementation is a Cython translation of the double precision version in mpmath; it supports all branches and has excellent numerical stability, and runs quite a bit faster.


```
import scipy.special
import mpmath
timeit("mpmath.lambertw(-35.0r+4.6jr,2r)")
timeit("mpmath.fp.lambertw(-35.0r+4.6jr,2r)")
timeit("scipy.special.lambertw(-35.0r+4.6jr,2r)")
print repr(complex(mpmath.lambertw(-35.0r+4.6jr,2r)))
print repr(mpmath.fp.lambertw(-35.0r+4.6jr,2r))
print repr(scipy.special.lambertw(-35.0r+4.6jr,2r))

625 loops, best of 3: 301 µs per loop
625 loops, best of 3: 65.1 µs per loop
625 loops, best of 3: 6.75 µs per loop
(0.91763023745202721+14.071606637742889j)
(0.91763023745202721+14.071606637742889j)
(0.91763023745202721+14.071606637742889j)
```



---

Comment by kcrisman created at 2012-02-03 15:58:06

Nice; I wonder if there are more places we are beginning to default to mpmath where SciPy could be useful for the double fields.


---

Comment by kcrisman created at 2012-02-03 15:58:06

Changing status from needs_review to needs_work.


---

Comment by benjaminfjones created at 2012-02-03 17:25:29

Thanks for the ping. I'm still here (and I have a patch pretty much ready to go) I just got buried under teaching. I'll try to upload a patch this evening.


---

Comment by benjaminfjones created at 2012-02-04 01:10:01

After looking at this a bit more, it may be more involved than I initially envisioned to implement arbitrary branches of the lambert_w function in one symbolic function. Right now, the patch from SD 35.5 implements a subclass of !`BuiltinFunction`. The underlying assumptions about subclasses of BuiltinFunction include: (from sage/symbolic/function.pyx)


```
We assume that each subclass of this class will define one symbolic function.
```


One issue is that there isn't a way (as far as I can see) to pass a branch parameter to !`BuiltinFunction`'s `_call_` method. (Perhaps burcin or other authority on Sage symbolics can comment on this.)

Changing the evaluation numerical eval to use SciPy would be an easy change, that's for sure. I can do that quickly and upload a patch that implements the principle branch only. 

Another idea I just had was to do something like what we have for the Bessel functions, in particular the !`Bessel` class in sage/functions/special.py which is just a basic python class returning one of the Bessel (I,J,Y) functions of a given order.


---

Comment by kcrisman created at 2012-02-04 01:30:39

Ok, that makes sense.   I feel like there should be a way to do that nonetheless - see `incomplete_gamma`, with

```
        BuiltinFunction.__init__(self, "gamma", nargs=2, latex_name=r"\Gamma",
                conversions={'maxima':'gamma_incomplete', 'mathematica':'Gamma',
                    'maple':'GAMMA'})
```

and then use `_eval_` and `_evalf_`, but I don't have time to try looking into whether that would work here now.

Based on Fredrik's comment, make sure to only use SciPy for RDF/CDF - hopefully there is a good model elsewhere to use for that.


---

Comment by benjaminfjones created at 2012-02-06 05:24:03

proof of concept patch (not ready for review)


---

Attachment

OK, I made a second attempt. The patch isn't complete (I need to fix and add docstrings and do more testing) and is *not* ready for review, but if the reviewers will take a look at the basic implementation and give me feedback, I'd appreciate it.

In [attachment:trac_11888_v2.patch] there is a new symbolic function  `lambert_w_branch` which takes two arguments, a complex number `z` and an integer branch `n`. This is implemented using scipy.special.lambertw for RDF/CDF arguments z and using mpmath otherwise. 

There is also a wrapper function `lambert_w` that accepts either one or two arguments. For one argument it returns the principle branch `lambert_w_branch(z,0)`, for two it returns `lambert_w_branch(z,n)`. I still need to add the conversion from Maxima (by hand now, since `lambert_w` doesn't inherit from BuiltinFunction any more).


---

Comment by benjaminfjones created at 2012-02-11 22:07:49

I fixed the doctests and added lambert_w to the symbol table. I verified that all tests pass including the random_tests.py ones. The patch [attachment:trac_11888_v3.patch] is ready for review.


---

Comment by benjaminfjones created at 2012-02-11 22:07:49

Changing status from needs_work to needs_review.


---

Comment by fredrik.johansson created at 2012-02-11 22:27:40

principle -> principal, branchs -> branches

Otherwise, from looking at the patch, seems good.


---

Comment by benjaminfjones created at 2012-02-12 00:28:46

Thanks for looking at the patch, Fredrik. I've fixed the mistakes and replaced the latest patch.


---

Comment by benjaminfjones created at 2012-02-12 00:29:15

adds lambert_w and lambert_w_branch functions


---

Attachment

* typo

```
  SciPy is used to evalute
```

 * Will this conflict with the beta function patch when it comes to the random test?
 * I'm wondering whether we should add a couple conversions to Mma/Maple in the init (apparently Maxima is working fine, though see [this possible enhancement](http://www.ma.utexas.edu/pipermail/maxima/2011/025861.html)).  Mathematica apparently calls it ProductLog...


---

Comment by benjaminfjones created at 2012-02-12 06:48:48

* I'll fix the typo (tomorrow)
 * I'll make the beta function ticket a dependency so the random test will come out correctly after the two patches are merged in order
 * ProductLog in Mathematica puts the branch parameter first. I guess it makes sense to be consistent with that convention as well as the discussion on the Maxima list. I can't figure out whether the generalized lambert function ever made it into Maxima..


---

Comment by benjaminfjones created at 2012-02-12 20:49:15

addressed reviewer issues, changed order of arguments to be consistant with Mma/Maple


---

Attachment

fixes random tests after rebasing against #9130


---

Attachment


---

Comment by burcin created at 2012-02-13 10:21:14

Do we really want to call this function `lambert_w_branch()`? Can we name it `lambert_w()`? I would even suggest to add custom printing methods (`_print_()` and `_print_latex_()`) to avoid printing the branch argument if it is 0.

If the function is named lambert_w, you can remove the wrapper function `lambert_w()` and the manual manipulation of the symbol table. In this case, a custom `__call__()` method would take the place of the wrapper method.

BTW, we should either open a new ticket to add known exact evaluations to `_eval_()` or do this here:
 - 0 -> 0
 - e -> 1
 - -1/e -> -1


---

Comment by burcin created at 2012-02-13 10:29:13

I have one more comment. Sorry for multiple emails.

You should check if the parent is `RDF` or `CDF` using `is`, not `==`. In this context, `parent` is an argument to the `_evalf_()` method, which overrides the `parent()` function imported from `sage.structure.coerce`. I suggest naming the argument `parent_d` instead of `parent`. Then you can do:


```
R = parent_d or parent(z)
if R is float or R is complex or R is RDF or R is CDF: 
    import scipy.special 
    return scipy.special.lambertw(z, n) 
else: 
    import mpmath 
    return mpmath_utils.call(mpmath.lambertw, z, n, parent=parent) 
```



---

Comment by burcin created at 2012-02-13 10:29:13

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2012-02-13 18:27:54

Replying to [comment:28 burcin]:
> Do we really want to call this function `lambert_w_branch()`? Can we name it `lambert_w()`? I would even suggest to add custom printing methods (`_print_()` and `_print_latex_()`) to avoid printing the branch argument if it is 0.
That's a great idea.


---

Comment by benjaminfjones created at 2012-02-18 06:10:43

I've written a new patch that includes significant changes compared to the last one. I think I've included all of burcin's suggestions and I think it's much improved now. All tests pass with the patch applied on 5.0.beta4 + #12507.

One thing I haven't managed to figure out is how to get integration to work, e.g.


```
sage: integrate(lambert_w(x), x)
...
RuntimeError: ECL says: Error executing code in Maxima: lambert_w: wrong number of arguments.
```


I guess that's because there isn't a two-argument version of lambert_w defined in maxima. The conversion maxima -> Sage works (as shown in one of the doctests) but it looks like the other way doesn't. Another example:


```
sage: maxima(lambert_w(5))
Maxima ERROR:
	
lambert_w: wrong number of arguments.
 -- an error. To debug this try: debugmode(true);
```


Q: How do I get around this?

Numerical integration also fails unless I pass a lambda function:


```
sage: numerical_integral(lambert_w(x), 0, 1)
Exception TypeError: "function not supported for these types, and can't coerce safely to supported types" in 'sage.gsl.integration.c_ff' ignored
...
(0.0, 0.0)
```


but ....


```
sage: numerical_integral(lambda x: lambert_w(x), 0, 1)
(0.33036612476168054, 3.667800782666048e-15)
```


Q: How do I fix this?


---

Comment by benjaminfjones created at 2012-02-18 06:11:24

adds lambert_w function


---

Attachment


---

Comment by burcin created at 2012-02-18 16:39:51

Replying to [comment:31 benjaminfjones]:
> I've written a new patch that includes significant changes compared to the last one. I think I've included all of burcin's suggestions and I think it's much improved now. All tests pass with the patch applied on 5.0.beta4 + #12507.

Thanks! The patch looks really good. When checking if the input is 0 in `_eval_`, you might want to `return z` instead of `Integer(0)` to preserve the type of the input. Similarly, we should return `parent(z)(1)` or `parent(z)(-1)` in the other branches.

<snip>
> I guess that's because there isn't a two-argument version of lambert_w defined in maxima. The conversion maxima -> Sage works (as shown in one of the doctests) but it looks like the other way doesn't. Another example:
> 
> {{{
> sage: maxima(lambert_w(5))
> Maxima ERROR:
> 	
> lambert_w: wrong number of arguments.
>  -- an error. To debug this try: debugmode(true);
> }}}
> 
> Q: How do I get around this?

You need to define `_maxima_init_evaled_()`. See line 895 of `sage/fuctions/other.py`:

http://hg.sagemath.org/sage-main/file/c239be1054e0/sage/functions/other.py#l895


---

Comment by benjaminfjones created at 2012-02-22 18:55:34

Replying to [comment:33 burcin]:
> 
> You need to define `_maxima_init_evaled_()`. See line 895 of `sage/fuctions/other.py`:
> 
> http://hg.sagemath.org/sage-main/file/c239be1054e0/sage/functions/other.py#l895
> 

It seems that adding `_maxima_init_evaled_()` solves one issue, converting to Maxima with `_maxima_()`,


```
sage: lambert_w(x)._maxima_()
lambert_w(x)
sage: lambert_w(1,x)._maxima_()
...
NotImplementedError: Non-principal branch lambert_w[1](x) is not implemented in Maxima
```


but integration still doesn't work (same error is raised as before). Looking closer it seems that the issue is here:


```
sage: z = lambert_w(x)
sage: z.operands()
[0, x]
sage: z.operator()
lambert_w
```


because when `sr_to_max` is called in the integration code, I get:


```
sage: from sage.interfaces.maxima_lib import sr_to_max
sage: sr_to_max(lambert_w(x))
<ECL: ((%LAMBERT_W) 0 $X)>
sage: sr_to_max(lambert_w(1, x))
<ECL: ((%LAMBERT_W) 1 $X)>
```


and Maxima barfs because it doesn't know what to do with `((%LAMBERT_W) 0 $X)`.


---

Attachment

added custom latex printing and Maxima initialization


---

Comment by benjaminfjones created at 2012-03-13 21:08:50

I've posted my latest patch in case anyone wants to play around with getting integration of `lambert_w` to work. 

This issue could be a new ticket. One solution I can see is to add `lambert_w` to the `special_sage_to_max` dictionary in `sage/intefaces/maxima_lib.py`. There are a few other special functions listed there (like `Ei` and `polylog`) that need special conversions to maxima.

So, I propose that we either:
 a. Review patch [attachment:trac_11888_v6.patch] and open a new ticket for the integration issue
 b. Agree on a simple workaround like adding `lambert_w` to `special_sage_to_max` and I'll add it to the patch.


---

Comment by benjaminfjones created at 2012-03-13 21:08:50

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2012-03-14 12:50:35

I think that b. makes sense.  You'd also have to add `max_lambert_w` at about [this spot](http://hg.sagemath.org/sage-main/file/c239be1054e0/sage/interfaces/maxima_lib.py#l1093) but having numerical integrals would be worth it.  

I assume that this is a pretty easy change?  If not, I guess we could just document that this doesn't work yet.  In either case something should be documented, though, since half of our bug reports seem to be people using new, cool functionality who then expect that new functionality to be fully featured as well - i.e., it's not really a bug report at all, but a feature request.  Having good doc for what we _don't_ do will help with that.


---

Comment by kcrisman created at 2012-03-16 02:12:04

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2012-03-16 02:12:04

'Needs work' for b.


---

Comment by benjaminfjones created at 2012-03-19 19:58:32

Changing status from needs_work to needs_review.


---

Comment by benjaminfjones created at 2012-03-19 19:58:32

Success! 

Symbolic and numerical integration now work as expected for the principle branch. I added doctests to indicate what is and is not implemented. 

----

One other comment, to indicate what causes errors, I want to add doctests to `lambert_w` such as: 


```
sage: integral(lambert_w(1,x), x)                                                                   
ERROR: An unexpected error occurred while tokenizing input                                          
...                                                                                                 
RuntimeError: ECL says: Error executing code in Maxima: lambert_w: expected exactly 1 arguments.   
```


and 


```
sage: numerical_integral(lambert_w(x), 0, 1)                                                        
Exception TypeError: "function not supported for these types, and can't coerce safely to supported types" in 'sage.gsl.integration.c_ff' ignored                                                    
...                                                                                                 
(0.0, 0.0)
```


but the doctest framework doesn't recognize the `Exception TypeError` and it seems to automatically fail if a `RuntimeError` is raised. If I put the latter 4 lines in the docstring for `lambert_w`, it fails doctesting, the framework only sees the `(0.0, 0.0)` part at the end. Is there a way around either of these issues?


---

Comment by benjaminfjones created at 2012-03-19 19:59:05

adds lambert_w function, including integration


---

Attachment


---

Comment by davidloeffler created at 2012-03-26 07:10:52

Apply trac_11888_v7.patch

(for patchbot, which is trying to apply all nine patches at once)


---

Comment by benjaminfjones created at 2012-04-07 22:47:22

I removed #12507 from dependencies since it was merged in 5.0.beta5 and now the patchbot is getting confused trying to apply #12507 to 5.0.beta12 before testing.

I verified that [attachment:trac_11888_v7.2.patch] applies cleanly to 5.0.beta12 and I'm rerunning a patchbot instance on it.


---

Comment by kcrisman created at 2012-05-17 12:28:01

I'm sure we can finish this off next week in Seattle.  Meanwhile, an interesting update from the Maxima developers about coming attractions:

```

Message: 4
Date: Thu, 17 May 2012 04:31:13 +0000 (UTC)
From: Robert Dodier <robert.dodier@gmail.com>
To: maxima@math.utexas.edu
Subject: Re: [Maxima] Generalized Lambert W function - premature
       commit
Message-ID: <jp1uuh$jv8$1@dough.gmane.org>

On 2012-05-17, David Billinghurst <dbmaxima@gmail.com> wrote:

> Oops. I have accidentally committed some code for Generalized Lambert
> W function to src/specfn.lisp.  Still getting my head around git.

> The code seems functionally correct, and passes tests in
> tests/rtest_lambert_w.mac, but I hadn't finished polishing it and it
> is still undocumented.  Unless anyone objects, I will leave it in
> place for the time being.

No problem, OK by me.

> There is a new function generalized_lambert_w(k,z) that returns the
> kth branch W_k(z).  There are float and bigfloat routines for complex
> z.  generalized_lambert_w(0,z) is not (yet) simplified to
> lambert_w(z), as I hadn't decided if this should be done
> unconditionally or controlled by a flag.  Thoughts?

Is it more convenient to simplify W_0(z) instead of W(z) ? If not, then
it seems reasonable to just go ahead and simplify it.

If you decide against automatically simplifying W_0(z) to W(z), I guess
I hope you don't make it controlled by a flag; flags cause trouble,
because one can't guess by looking at some code how it's going to turn
out. How about a function to carry out the simplification.

```



---

Comment by benjaminfjones created at 2012-05-17 20:37:24

That will be good; should allow us to integrate the non-principle branch. Although, in Sage 5.0, we're still a major version behind the current Maxima release.


---

Comment by rbeezer created at 2012-05-18 04:09:24

I am reviewing an expository paper about the Lambert W function and it says "Maple this" and "Maple that".  Let's get this into Sage and stay competitive with the M's!  ;-)

Rob, in cheerleader mode


---

Comment by benjaminfjones created at 2012-05-18 04:40:41

removed trailing whitespace


---

Attachment

I agree! In that spirit, here is a rebase of the patch for Sage-5.0.


---

Comment by zimmerma created at 2012-05-25 09:27:15

this ticket is pointed out on the SD40.5 wiki page. Is there any particular thing one should review?

Paul


---

Comment by dsm created at 2012-05-25 12:25:13

It looks like a few principle/principal mixups made it through.


---

Comment by kcrisman created at 2012-05-25 13:54:33

> this ticket is pointed out on the SD40.5 wiki page. Is there any particular thing one should review?
I think that just checking everything still works and that syntax is proper (and spelling, thanks dsm) is good.  Checking some random values against another program would be helpful, especially for the branches.  Making sure documentation builds and looks good.  But this has been looked at by a lot of eyes, so I don't think it needs to be gone over completely from scratch, especially since I think Ben has doctested a lot of the issues raised in previous comments (which are worth scanning).


---

Comment by benjaminfjones created at 2012-05-25 18:10:36

Changing keywords from "lambert_w symbolics conversion maxima sd35.5" to "lambert_w symbolics conversion maxima sd35.5 sd40.5".


---

Comment by benjaminfjones created at 2012-05-25 18:18:06

I can make a quick spelling fix patch, but I'll wait and see if anyone else has changes to suggest.


---

Comment by dsm created at 2012-05-26 07:14:33

After some real-world discussions, I'd prefer to avoid falling into Python ints for (some of) the special values:


```
sage: parent(lambert_w(0))
Integer Ring
sage: parent(lambert_w(e))
<type 'int'>
sage: parent(lambert_w(-1/e))
<type 'int'>
sage: parent(lambert_w(SR(-1/e)))
<type 'int'>
sage: parent(lambert_w(SR(0)))
Integer Ring
```


Mysteriously enough, instrumenting it reveals that `_eval_` is actually returning SR(1) which then in some part of the code I don't understand becomes int(1) before we get it back.  If we explicitly return Integer(1) then it seems to stay as Integer(1).  This isn't the biggest deal in the world but there have been several bug reports caused by something falling out of Sagespace into Pythonspace.


---

Comment by dsm created at 2012-05-26 20:45:08

It looks like whatever happens after _eval_ might "dereference" the SR; the call seems to give Integer(1) if _eval_ returns SR(Integer(1)).  Probably someone who actually knows what's going on could explain it in one line.


---

Comment by benjaminfjones created at 2012-05-27 06:13:23

One solution is to change the return statements in these special cases where the automatic simplification returns an integer to just explicitly return `Integer(1)`, etc..

How does that sound?


---

Comment by benjaminfjones created at 2012-05-27 18:33:36

New patch is ready for review. I hope this can be the final revision! 

Patchbot: apply [This is the Trac macro *attachment:trac_11888_v8.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_11888_v8.patch-macro) to $SAGE_ROOT/devel/sage


---

Comment by dsm created at 2012-05-27 20:02:40

Looking at it now.


---

Comment by benjaminfjones created at 2012-05-27 20:41:57

fixed spelling / grammer mistakes, returned parent(Integer(...)) for special values


---

Attachment

Okay, this looks good.  Two copyedits, an extra doc describing the behaviours of the derivative function, some tests making sure we can't differentiate with respect to the branch number, and the addition of lambert_W(-pi/2) = pi/2*I as a special value.

I give positive review to the preexisting parts of v8; if the new bits of v9 look okay I think we're good to go.


---

Attachment

post-review version of lambertw sf


---

Comment by benjaminfjones created at 2012-05-27 22:06:36

New changes look good; good catch about the derivative w.r.t. branch. All relavent tests pass for me on sage-5.0. I would say this is ready to go in! Thanks for the very thorough review, Doug.


---

Comment by dsm created at 2012-05-27 22:09:50

Changing status from needs_review to positive_review.


---

Comment by dsm created at 2012-05-27 22:10:25

+1.  Tx for the work!


---

Comment by was created at 2012-05-27 22:18:39

Changing status from positive_review to needs_work.


---

Comment by was created at 2012-05-27 22:18:39

This patch is awesome!  It's also a great example of how to make a well-documented new symbolic function that illustrates many issues. Here are a few trivial nitpicks:

* What is "simplication"?

```
When automatic simplication occurs, the parent of the output value should be 
```


* This docstring should start with r" since it contains a backslash:

```
        646	        """ 
 	647	        The derivative of `W_n(x)` is `W_n(x)/(x \cdot W_n(x) + x)`. 
```

(check for similar instances throughout).

* Don't use periods at the end of exceptions (also don't capitalize).  Many instances of this being wrong, e.g., 

```
 	679	            raise ValueError("Derivative not defined with respect to the branch number.") 
```

Here's a good example of what an exception string should look like (built into python):

```
>>> 1/0
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ZeroDivisionError: integer division or modulo by zero
```



---

Comment by dsm created at 2012-05-27 22:33:54

Updated version taking into account comments of was.


---

Comment by dsm created at 2012-05-27 22:34:04

Changing status from needs_work to needs_review.


---

Comment by dsm created at 2012-05-27 22:46:34

minor edits


---

Attachment


---

Comment by was created at 2012-05-27 22:49:43

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-14 06:38:22

Resolution: fixed
