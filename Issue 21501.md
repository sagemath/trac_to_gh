# Issue 21501: %attach has a weird behaviour when dealing with SyntaxError

archive/issues_021501.json:
```json
{
    "body": "CC:  @vbraun @tscrim @fchapoton\n\nKeywords: %attach\n\nThe new `%attach` behaves in a strange way when dealing with files that contain errors. Sometimes it parses color escapes sometimes it does not.\n\nHere is how to reproduce the issue:\n\n```\n$ echo \"1 + \" > /tmp/test.py\n$ sage\nsage: %attach /tmp/test.py\n  File \"/tmp/test.py\", line 1\n    1 +\n        ^\nSyntaxError: invalid syntax\n\nsage: os.system('echo \"1 + 1\" > /tmp/test.py')\n0\n### reloading attached file test.py modified at 12:32:53 ###\nsage: os.system('echo \"1 + \" > /tmp/test.py')\n0\n### reloading attached file test.py modified at 12:33:14 ###\n?[1;36m  File ?[1;32m\"/tmp/test.py\"?[1;36m, line ?[1;32m1?[0m\n?[1;33m    1 +?[0m\n?[1;37m        ^?[0m\n?[1;31mSyntaxError?[0m?[1;31m:?[0m invalid syntax\n\nsage: \n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21738\n\n",
    "created_at": "2016-10-21T12:37:26Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "%attach has a weird behaviour when dealing with SyntaxError",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21501",
    "user": "https://github.com/etn40ff"
}
```
CC:  @vbraun @tscrim @fchapoton

Keywords: %attach

The new `%attach` behaves in a strange way when dealing with files that contain errors. Sometimes it parses color escapes sometimes it does not.

Here is how to reproduce the issue:

```
$ echo "1 + " > /tmp/test.py
$ sage
sage: %attach /tmp/test.py
  File "/tmp/test.py", line 1
    1 +
        ^
SyntaxError: invalid syntax

sage: os.system('echo "1 + 1" > /tmp/test.py')
0
### reloading attached file test.py modified at 12:32:53 ###
sage: os.system('echo "1 + " > /tmp/test.py')
0
### reloading attached file test.py modified at 12:33:14 ###
?[1;36m  File ?[1;32m"/tmp/test.py"?[1;36m, line ?[1;32m1?[0m
?[1;33m    1 +?[0m
?[1;37m        ^?[0m
?[1;31mSyntaxError?[0m?[1;31m:?[0m invalid syntax

sage: 
```



Issue created by migration from https://trac.sagemath.org/ticket/21738





---

archive/issue_comments_298105.json:
```json
{
    "body": "Note that it works the first time (when you call attach yourself) but not when the attached file is changed. In the latter case, there is already a sage: prompt that needs to be erased, the output printed, and the prompt redrawn. \n\nThats done in IPython's prompt_toolkit patch_stdout_context context, which also screws up ansi sequences.",
    "created_at": "2016-10-22T20:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-298105",
    "user": "https://github.com/vbraun"
}
```

Note that it works the first time (when you call attach yourself) but not when the attached file is changed. In the latter case, there is already a sage: prompt that needs to be erased, the output printed, and the prompt redrawn. 

Thats done in IPython's prompt_toolkit patch_stdout_context context, which also screws up ansi sequences.



---

archive/issue_comments_298106.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-22T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-298106",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_298107.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-10-22T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-298107",
    "user": "https://github.com/vbraun"
}
```

New commits:



---

archive/issue_comments_298108.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-23T16:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-298108",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_298109.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-31T12:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-298109",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_020322.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-31T12:32:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21501#event-20322"
}
```
