# Issue 21501: %attach has a weird behaviour when dealing with SyntaxError

Issue created by migration from Trac.

Original creator: etn40ff

Original creation time: 2016-10-21 12:37:26

CC:  vbraun tscrim chapoton

Keywords: %attach

The new `%attach` behaves in a strange way when dealing with files that contain errors. Sometimes it parses color escapes sometimes it does not.

Here is how to reproduce the issue:

```
$ echo "1 + " > /tmp/test.py
$ sage
sage: %attach /tmp/test.py
  File "/tmp/test.py", line 1
    1 +
        ^
SyntaxError: invalid syntax

sage: os.system('echo "1 + 1" > /tmp/test.py')
0
### reloading attached file test.py modified at 12:32:53 ###
sage: os.system('echo "1 + " > /tmp/test.py')
0
### reloading attached file test.py modified at 12:33:14 ###
?[1;36m  File ?[1;32m"/tmp/test.py"?[1;36m, line ?[1;32m1?[0m
?[1;33m    1 +?[0m
?[1;37m        ^?[0m
?[1;31mSyntaxError?[0m?[1;31m:?[0m invalid syntax

sage: 
```




---

Comment by vbraun created at 2016-10-22 20:31:17

Note that it works the first time (when you call attach yourself) but not when the attached file is changed. In the latter case, there is already a sage: prompt that needs to be erased, the output printed, and the prompt redrawn. 

Thats done in IPython's prompt_toolkit patch_stdout_context context, which also screws up ansi sequences.


---

Comment by vbraun created at 2016-10-22 20:34:46

Changing status from new to needs_review.


---

Comment by vbraun created at 2016-10-22 20:34:46

New commits:


---

Comment by tscrim created at 2016-10-23 16:47:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-31 12:32:37

Resolution: fixed
