# Issue 31516: Bug in charpoly over discrete valuation rings

Issue created by migration from https://trac.sagemath.org/ticket/31753

Original creator: caruso

Original creation time: 2021-04-29 07:15:59

CC:  rpages slelievre

Keywords: characteristic polynomial

There is a bug in the computation of the characteristic polynomial over a discrete valuation ring.


```
sage: R.<t> = GF(5)[[]]
sage: M = matrix(3, 3, [ 1, t + O(t^3), t^2, 1 + t + O(t^3), 2 + t^2, 3 + 2*t + O(t^3), t - t^2, 2*t, 1 + t ])
sage: M.charpoly()
Traceback (most recent call last):
...
TypeError: 'PlusInfinity' object cannot be interpreted as an integer
Hessenberg form only possible for matrices over a field
```


This ticket fixes this.


---

Comment by caruso created at 2021-04-29 07:19:22

Changing status from new to needs_review.


---

Comment by git created at 2021-04-29 07:20:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-04-29 10:44:16

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2021-04-29 10:44:16

*a.*

The patchbot reports an incorrect Trac link. To fix it:

```diff
-    We check that trac:`31753` is resolved::
+    We check that :trac:`31753` is resolved::
```



*b.*

Your fix for the bug seems to consist in removing `m` from a `cdef` declaration.

Can you explain why that caused a problem, and why this is a good solution?

But probably someone who knows more Cython than me should review that part.


---

Comment by git created at 2021-04-29 10:46:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2021-04-29 10:47:58

Replying to [comment:5 slelievre]:
> Your fix for the bug seems to consist in removing `m` from a `cdef` declaration.
> Can you explain why that caused a problem, and why this is a good solution?

It's just because `precision_relative` can return `+Infinity` which cannot be cast to an integer (in fact an element of type `Py_ssize_t`). Removing the declaration, we let python handle this.


---

Comment by caruso created at 2021-04-29 10:48:09

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2021-04-29 12:43:45

Right, `m` can be infinity. That's why `maxi` is also
left out of the `cdef`. Is there a cdef type for
Python or Sage objects that could be used?
Perhaps not crucial, as the inner loop matters most.

Still, about `cdef` lines, maybe remove the one about `c`
and add `entry` to the `RingElement` one?


```diff
-    cdef Matrix_generic_dense c
-    cdef RingElement pivot, inv, scalar
+    cdef RingElement entry, pivot, inv, scalar
```


Commit [28a35a97](https://github.com/sagemath/sage/commit/28a35a9799db95a2c0ae42c7d99ac61e9ba06d3c#diff-0c40f0947acf9c267eee2853b89814d61d4faac185f00f1f21751b09e8b9f349)
from #30892 added the `cdef ... c` line while removing the use of `c`.


---

Comment by caruso created at 2021-04-29 17:49:20

Replying to [comment:9 slelievre]:
> {{{#!diff
> -    cdef Matrix_generic_dense c
> -    cdef RingElement pivot, inv, scalar
> +    cdef RingElement entry, pivot, inv, scalar
> }}}

Good point!


---

Comment by git created at 2021-04-29 17:50:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-04-29 22:43:54

Since this fixes a bug, maybe it can still go in Sage 9.3.


---

Comment by slelievre created at 2021-04-29 22:43:54

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-04-29 22:45:07

Changing keywords from "characteristic polynomial" to "characteristic polynomial, charpoly".


---

Comment by chapoton created at 2021-05-10 11:05:05

milestone to 9.4, as 9.3 has been released


---

Comment by vbraun created at 2021-06-19 20:57:56

Resolution: fixed
