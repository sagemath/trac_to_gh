# Issue 13862: FIx IPython 0.13 issues

archive/issues_013862.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  @vbraun\n\nCan we keep this ticket open to track all the remaining IPython issues?\n\nStill outstanding:\n\nFrom Kannappan Sampath:\n\n1. I am unable to exit by typing \"exit\", but Ctrl+D however works! \n2. Usually on the first run of sage, I receive some directive from Sage asking me not to interrupt as it is setting some paths. I did not receive such a directive this time... \n\nI don't know if (2) is our problem, but we should double-check that the message isn't disabled if it should be printed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14066\n\n",
    "created_at": "2013-02-06T06:39:30Z",
    "labels": [
        "component: please change",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "FIx IPython 0.13 issues",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13862",
    "user": "https://github.com/jasongrout"
}
```
Assignee: tbd

CC:  @vbraun

Can we keep this ticket open to track all the remaining IPython issues?

Still outstanding:

From Kannappan Sampath:

1. I am unable to exit by typing "exit", but Ctrl+D however works! 
2. Usually on the first run of sage, I receive some directive from Sage asking me not to interrupt as it is setting some paths. I did not receive such a directive this time... 

I don't know if (2) is our problem, but we should double-check that the message isn't disabled if it should be printed

Issue created by migration from https://trac.sagemath.org/ticket/14066





---

archive/issue_comments_172341.json:
```json
{
    "body": "Another",
    "created_at": "2013-02-06T06:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172341",
    "user": "https://github.com/jasongrout"
}
```

Another



---

archive/issue_comments_172342.json:
```json
{
    "body": "Regarding (3), loading a sage file (i.e., %runfile init.sage) certainly works with sage syntax like load.  So the problem appears to be that the %runfile code isn't being used to run init.sage.",
    "created_at": "2013-02-06T06:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172342",
    "user": "https://github.com/jasongrout"
}
```

Regarding (3), loading a sage file (i.e., %runfile init.sage) certainly works with sage syntax like load.  So the problem appears to be that the %runfile code isn't being used to run init.sage.



---

archive/issue_comments_172343.json:
```json
{
    "body": "(2) is certainly not related to IPython.",
    "created_at": "2013-02-06T07:33:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172343",
    "user": "https://github.com/jdemeyer"
}
```

(2) is certainly not related to IPython.



---

archive/issue_comments_172344.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to user interface.",
    "created_at": "2013-02-06T07:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172344",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from PLEASE CHANGE to user interface.



---

archive/issue_comments_172345.json:
```json
{
    "body": "Changing assignee from tbd to @williamstein.",
    "created_at": "2013-02-06T07:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172345",
    "user": "https://github.com/jdemeyer"
}
```

Changing assignee from tbd to @williamstein.



---

archive/issue_comments_172346.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2013-02-06T09:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172346",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_172347.json:
```json
{
    "body": "For (1): In devel/sage/sage/all.py, we find this code at the very top:\n\n```\n# Error message that matches the Sage/IPython defaults\nquit = \"Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.\"\nexit = quit\n```\n\nWho put that there?  Deleting those lines restores exit and quit to act just as expected.",
    "created_at": "2013-02-07T03:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172347",
    "user": "https://github.com/jasongrout"
}
```

For (1): In devel/sage/sage/all.py, we find this code at the very top:

```
# Error message that matches the Sage/IPython defaults
quit = "Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation."
exit = quit
```

Who put that there?  Deleting those lines restores exit and quit to act just as expected.



---

archive/issue_comments_172348.json:
```json
{
    "body": "It looks like William put it there in 2006, so apparently it is a leftover from the old system.  I wonder how exit and quit worked before; clearly they didn't just print the string!",
    "created_at": "2013-02-07T03:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172348",
    "user": "https://github.com/jasongrout"
}
```

It looks like William put it there in 2006, so apparently it is a leftover from the old system.  I wonder how exit and quit worked before; clearly they didn't just print the string!



---

archive/issue_comments_172349.json:
```json
{
    "body": "So issue (1) seems to have a solution. Here's an idea for (2):\n\n```diff\ndiff --git a/sage/misc/sage_extension.py b/sage/misc/sage_extension.py\n--- a/sage/misc/sage_extension.py\n+++ b/sage/misc/sage_extension.py\n@@ -453,7 +453,8 @@\n         \"\"\"\n         startup_file = os.environ.get('SAGE_STARTUP_FILE', '')\n         if os.path.exists(startup_file):\n-            self.shell.run_cell('%%run %r'%startup_file)\n+            with open(startup_file, 'r') as f:\n+                self.shell.run_cell(f.read())\n \n     def init_inspector(self):\n         # Ideally, these would just be methods of the Inspector class\n```\n\n(That is, call `run_cell` on the contents of the init file, instead of calling `run_cell(%%run ...)` on the init file itself.)",
    "created_at": "2013-02-11T16:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172349",
    "user": "https://github.com/jhpalmieri"
}
```

So issue (1) seems to have a solution. Here's an idea for (2):

```diff
diff --git a/sage/misc/sage_extension.py b/sage/misc/sage_extension.py
--- a/sage/misc/sage_extension.py
+++ b/sage/misc/sage_extension.py
@@ -453,7 +453,8 @@
         """
         startup_file = os.environ.get('SAGE_STARTUP_FILE', '')
         if os.path.exists(startup_file):
-            self.shell.run_cell('%%run %r'%startup_file)
+            with open(startup_file, 'r') as f:
+                self.shell.run_cell(f.read())
 
     def init_inspector(self):
         # Ideally, these would just be methods of the Inspector class
```

(That is, call `run_cell` on the contents of the init file, instead of calling `run_cell(%%run ...)` on the init file itself.)



---

archive/issue_comments_172350.json:
```json
{
    "body": "I don't know much about this IPython stuff, but it would be good to resolve these issues as this is the only remaining blocker for sage-5.7.",
    "created_at": "2013-02-12T07:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172350",
    "user": "https://github.com/jdemeyer"
}
```

I don't know much about this IPython stuff, but it would be good to resolve these issues as this is the only remaining blocker for sage-5.7.



---

archive/issue_comments_172351.json:
```json
{
    "body": "John, that fix seems reasonable.  Looking at the IPython source, the default for the %run magic is to run using the python execfile function, so that explains why sage-specific things didn't work.  run_cell should apply the sage-specific things.\n\nBut I would change the call to `run_cell(f.read(), silent=True)` (and then check to make sure tracebacks still work; if not, then use `run_cell(f.read(), store_history=False)`)",
    "created_at": "2013-02-12T13:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172351",
    "user": "https://github.com/jasongrout"
}
```

John, that fix seems reasonable.  Looking at the IPython source, the default for the %run magic is to run using the python execfile function, so that explains why sage-specific things didn't work.  run_cell should apply the sage-specific things.

But I would change the call to `run_cell(f.read(), silent=True)` (and then check to make sure tracebacks still work; if not, then use `run_cell(f.read(), store_history=False)`)



---

archive/issue_comments_172352.json:
```json
{
    "body": "To be consistent with shell.runfile_ipy, I just use store_history=False...",
    "created_at": "2013-02-12T14:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172352",
    "user": "https://github.com/jasongrout"
}
```

To be consistent with shell.runfile_ipy, I just use store_history=False...



---

archive/issue_comments_172353.json:
```json
{
    "body": "Attachment [trac_14066-startup.patch](tarball://root/attachments/some-uuid/ticket14066/trac_14066-startup.patch) by @jasongrout created at 2013-02-12 14:18:36",
    "created_at": "2013-02-12T14:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172353",
    "user": "https://github.com/jasongrout"
}
```

Attachment [trac_14066-startup.patch](tarball://root/attachments/some-uuid/ticket14066/trac_14066-startup.patch) by @jasongrout created at 2013-02-12 14:18:36



---

archive/issue_comments_172354.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-12T14:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172354",
    "user": "https://github.com/jasongrout"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_172355.json:
```json
{
    "body": "Attachment [trac_14066-quitexit.patch](tarball://root/attachments/some-uuid/ticket14066/trac_14066-quitexit.patch) by @jasongrout created at 2013-02-12 14:19:45",
    "created_at": "2013-02-12T14:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172355",
    "user": "https://github.com/jasongrout"
}
```

Attachment [trac_14066-quitexit.patch](tarball://root/attachments/some-uuid/ticket14066/trac_14066-quitexit.patch) by @jasongrout created at 2013-02-12 14:19:45



---

archive/issue_comments_172356.json:
```json
{
    "body": "I've noticed that attach no longer works. It says it's been deprecated and to use %attach, but then this appears to have a bug.\n\nIf I have a file \"test.py\" which contains one line\n\nprint \"hello\"\n\nthen when I attach:\n\n%attach 'test.py'\n\nthen it prints hello. But if I rewrite the line to:\n\nprint \"hey\"\n\nand then hit enter on sage, it doesn't print anything.",
    "created_at": "2013-02-12T22:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172356",
    "user": "https://trac.sagemath.org/admin/accounts/users/chrisjamesberg"
}
```

I've noticed that attach no longer works. It says it's been deprecated and to use %attach, but then this appears to have a bug.

If I have a file "test.py" which contains one line

print "hello"

then when I attach:

%attach 'test.py'

then it prints hello. But if I rewrite the line to:

print "hey"

and then hit enter on sage, it doesn't print anything.



---

archive/issue_comments_172357.json:
```json
{
    "body": "I think that `%attach` sort of works, maybe even mostly works, but printing does not. If my file contains the line `a=3`:\n\n```\nsage: %attach test.py\nsage: a\n3\nsage: # now I edit test.py to say a=12.0\nsage: a\n12.0\n```\n\nFunction definitions get updated just fine, but as you point out, print statements don't seem to work right. What else needs to be tested to know if print statements are the only issue?\n\nNote that if I attach a file with print statements, then change it, then attach it again, the print statements appear twice. So I think the change is being detected, but the output isn't showing up when it should.",
    "created_at": "2013-02-12T23:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172357",
    "user": "https://github.com/jhpalmieri"
}
```

I think that `%attach` sort of works, maybe even mostly works, but printing does not. If my file contains the line `a=3`:

```
sage: %attach test.py
sage: a
3
sage: # now I edit test.py to say a=12.0
sage: a
12.0
```

Function definitions get updated just fine, but as you point out, print statements don't seem to work right. What else needs to be tested to know if print statements are the only issue?

Note that if I attach a file with print statements, then change it, then attach it again, the print statements appear twice. So I think the change is being detected, but the output isn't showing up when it should.



---

archive/issue_comments_172358.json:
```json
{
    "body": "Replying to [comment:15 chrisjamesberg]:\n> and then hit enter on sage, it doesn't print anything.\n\nI don't quite understand what the problem is. Is it a problem that simply hitting ENTER doesn't reload the file, that the file is only reloaded before executing an actual command?\n\nBecause other than that, I find that `%attach` works fine. So, I'm willing to give this positive_review.",
    "created_at": "2013-02-14T11:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172358",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 chrisjamesberg]:
> and then hit enter on sage, it doesn't print anything.

I don't quite understand what the problem is. Is it a problem that simply hitting ENTER doesn't reload the file, that the file is only reloaded before executing an actual command?

Because other than that, I find that `%attach` works fine. So, I'm willing to give this positive_review.



---

archive/issue_comments_172359.json:
```json
{
    "body": "Regarding attach, I suppose that is a difference between the old and new.  In the old, the attach expressions were run after every enter press (i.e., before the prompt was displayed).  Now they are run just before any code is executed.  I guess the issue is that blank lines in some sense \"don't count\" because of a shortcut.  Let me see if I can add an option for attached files to run there as well.",
    "created_at": "2013-02-14T13:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172359",
    "user": "https://github.com/jasongrout"
}
```

Regarding attach, I suppose that is a difference between the old and new.  In the old, the attach expressions were run after every enter press (i.e., before the prompt was displayed).  Now they are run just before any code is executed.  I guess the issue is that blank lines in some sense "don't count" because of a shortcut.  Let me see if I can add an option for attached files to run there as well.



---

archive/issue_comments_172360.json:
```json
{
    "body": "It's going to be a bit tricky to execute attached files on empty input (i.e., just pressing enter) because, by default, IPython ignores attempts to execute empty strings.  Do we really need this?",
    "created_at": "2013-02-14T14:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172360",
    "user": "https://github.com/jasongrout"
}
```

It's going to be a bit tricky to execute attached files on empty input (i.e., just pressing enter) because, by default, IPython ignores attempts to execute empty strings.  Do we really need this?



---

archive/issue_comments_172361.json:
```json
{
    "body": "I don't think its necessary. I'm sure it'll break somebody's workflow (http://xkcd.com/1172/) but there are better solutions to \"reload when saved\" that don't involve sending non-commands.",
    "created_at": "2013-02-14T14:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172361",
    "user": "https://github.com/vbraun"
}
```

I don't think its necessary. I'm sure it'll break somebody's workflow (http://xkcd.com/1172/) but there are better solutions to "reload when saved" that don't involve sending non-commands.



---

archive/issue_comments_172362.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-14T22:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172362",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172363.json:
```json
{
    "body": "Since nobody complained I set this to positive review ;-)",
    "created_at": "2013-02-14T22:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172363",
    "user": "https://github.com/vbraun"
}
```

Since nobody complained I set this to positive review ;-)



---

archive/issue_comments_172364.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-16T11:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172364",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_013694.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-02-16T11:28:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13862#event-13694"
}
```



---

archive/issue_comments_172365.json:
```json
{
    "body": "See #14144 for another one.",
    "created_at": "2013-02-17T16:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13862",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13862#issuecomment-172365",
    "user": "https://github.com/jhpalmieri"
}
```

See #14144 for another one.
