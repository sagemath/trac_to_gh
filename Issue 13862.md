# Issue 13862: FIx IPython 0.13 issues

Issue created by migration from https://trac.sagemath.org/ticket/14066

Original creator: jason

Original creation time: 2013-02-06 06:39:30

Assignee: tbd

CC:  vbraun

Can we keep this ticket open to track all the remaining IPython issues?

Still outstanding:

From Kannappan Sampath:

1. I am unable to exit by typing "exit", but Ctrl+D however works! 
2. Usually on the first run of sage, I receive some directive from Sage asking me not to interrupt as it is setting some paths. I did not receive such a directive this time... 

I don't know if (2) is our problem, but we should double-check that the message isn't disabled if it should be printed


---

Comment by jason created at 2013-02-06 06:40:39

Another


---

Comment by jason created at 2013-02-06 06:46:28

Regarding (3), loading a sage file (i.e., %runfile init.sage) certainly works with sage syntax like load.  So the problem appears to be that the %runfile code isn't being used to run init.sage.


---

Comment by jdemeyer created at 2013-02-06 07:33:12

(2) is certainly not related to IPython.


---

Comment by jdemeyer created at 2013-02-06 07:33:28

Changing component from PLEASE CHANGE to user interface.


---

Comment by jdemeyer created at 2013-02-06 07:33:28

Changing assignee from tbd to was.


---

Comment by jdemeyer created at 2013-02-06 09:27:19

Changing priority from major to blocker.


---

Comment by jason created at 2013-02-07 03:42:37

For (1): In devel/sage/sage/all.py, we find this code at the very top:

```
# Error message that matches the Sage/IPython defaults
quit = "Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation."
exit = quit
```

Who put that there?  Deleting those lines restores exit and quit to act just as expected.


---

Comment by jason created at 2013-02-07 03:55:15

It looks like William put it there in 2006, so apparently it is a leftover from the old system.  I wonder how exit and quit worked before; clearly they didn't just print the string!


---

Comment by jhpalmieri created at 2013-02-11 16:52:52

So issue (1) seems to have a solution. Here's an idea for (2):

```diff
diff --git a/sage/misc/sage_extension.py b/sage/misc/sage_extension.py
--- a/sage/misc/sage_extension.py
+++ b/sage/misc/sage_extension.py
@@ -453,7 +453,8 @@
         """
         startup_file = os.environ.get('SAGE_STARTUP_FILE', '')
         if os.path.exists(startup_file):
-            self.shell.run_cell('%%run %r'%startup_file)
+            with open(startup_file, 'r') as f:
+                self.shell.run_cell(f.read())
 
     def init_inspector(self):
         # Ideally, these would just be methods of the Inspector class
```

(That is, call `run_cell` on the contents of the init file, instead of calling `run_cell(%%run ...)` on the init file itself.)


---

Comment by jdemeyer created at 2013-02-12 07:20:03

I don't know much about this IPython stuff, but it would be good to resolve these issues as this is the only remaining blocker for sage-5.7.


---

Comment by jason created at 2013-02-12 13:37:49

John, that fix seems reasonable.  Looking at the IPython source, the default for the %run magic is to run using the python execfile function, so that explains why sage-specific things didn't work.  run_cell should apply the sage-specific things.

But I would change the call to `run_cell(f.read(), silent=True)` (and then check to make sure tracebacks still work; if not, then use `run_cell(f.read(), store_history=False)`)


---

Comment by jason created at 2013-02-12 14:18:15

To be consistent with shell.runfile_ipy, I just use store_history=False...


---

Attachment


---

Comment by jason created at 2013-02-12 14:19:45

Changing status from new to needs_review.


---

Attachment


---

Comment by chrisjamesberg created at 2013-02-12 22:59:21

I've noticed that attach no longer works. It says it's been deprecated and to use %attach, but then this appears to have a bug.

If I have a file "test.py" which contains one line

print "hello"

then when I attach:

%attach 'test.py'

then it prints hello. But if I rewrite the line to:

print "hey"

and then hit enter on sage, it doesn't print anything.


---

Comment by jhpalmieri created at 2013-02-12 23:29:55

I think that `%attach` sort of works, maybe even mostly works, but printing does not. If my file contains the line `a=3`:

```
sage: %attach test.py
sage: a
3
sage: # now I edit test.py to say a=12.0
sage: a
12.0
```

Function definitions get updated just fine, but as you point out, print statements don't seem to work right. What else needs to be tested to know if print statements are the only issue?

Note that if I attach a file with print statements, then change it, then attach it again, the print statements appear twice. So I think the change is being detected, but the output isn't showing up when it should.


---

Comment by jdemeyer created at 2013-02-14 11:27:40

Replying to [comment:15 chrisjamesberg]:
> and then hit enter on sage, it doesn't print anything.

I don't quite understand what the problem is. Is it a problem that simply hitting ENTER doesn't reload the file, that the file is only reloaded before executing an actual command?

Because other than that, I find that `%attach` works fine. So, I'm willing to give this positive_review.


---

Comment by jason created at 2013-02-14 13:47:47

Regarding attach, I suppose that is a difference between the old and new.  In the old, the attach expressions were run after every enter press (i.e., before the prompt was displayed).  Now they are run just before any code is executed.  I guess the issue is that blank lines in some sense "don't count" because of a shortcut.  Let me see if I can add an option for attached files to run there as well.


---

Comment by jason created at 2013-02-14 14:05:45

It's going to be a bit tricky to execute attached files on empty input (i.e., just pressing enter) because, by default, IPython ignores attempts to execute empty strings.  Do we really need this?


---

Comment by vbraun created at 2013-02-14 14:33:22

I don't think its necessary. I'm sure it'll break somebody's workflow (http://xkcd.com/1172/) but there are better solutions to "reload when saved" that don't involve sending non-commands.


---

Comment by vbraun created at 2013-02-14 22:02:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-02-14 22:02:46

Since nobody complained I set this to positive review ;-)


---

Comment by jdemeyer created at 2013-02-16 11:28:49

Resolution: fixed


---

Comment by jhpalmieri created at 2013-02-17 16:33:29

See #14144 for another one.
