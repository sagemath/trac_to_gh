# Issue 15813: miscellaneous cleanup/bugfixes for sage.misc.interpreter and sage.misc.sage_extension

Issue created by migration from https://trac.sagemath.org/ticket/16050

Original creator: ohanar

Original creation time: 2014-04-02 23:48:04

CC:  jason

This is just a bit of cleanup+bugfixes that I've done over the past couple weeks. Notable changes:

- remove deprecations from #12719
- fix iload to actually be able to edit the loaded lines (could still be better, but would require more hacking on ipython internals; probably should just be added to upstream ipython instead)
- fix weird random bugs encountered with `InterfaceShellTransformer` (e.g. in gap, creating an error will cause future valid lines to error out) -- as far as I can tell, the code was just overthought (and had interface specific things that should belong as part of the appropriate interface)
- use the IPython shutdown hook rather than customizing `ask_exit`
- remove some dead and unused code


---

Comment by ohanar created at 2014-04-02 23:51:43

I would also like to move most of this code out of `sage.misc` to something like `sage.app`, but I'm not really happy with that package name. Maybe something like `sage.terminal`? Suggestions would be welcome.

Also, this is just a first step towards cleanup. Certainly more could be done (e.g. stuff surrounding the preparser), but I figured may as well do this gradually rather than as a patchbomb.


---

Comment by mmezzarobba created at 2014-04-03 07:26:22

Replying to [comment:1 ohanar]:
> I would also like to move most of this code out of `sage.misc` to something like `sage.app`, but I'm not really happy with that package name. Maybe something like `sage.terminal`? Suggestions would be welcome.

`sage.shell`? `sage.toplevel`? `sage.repl`?


---

Comment by ohanar created at 2014-04-04 16:59:28

Replying to [comment:2 mmezzarobba]:
> `sage.shell`? `sage.toplevel`? `sage.repl`?
ooh, I like `sage.repl` :)


---

Comment by git created at 2014-04-09 21:36:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-09 21:45:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-10 18:32:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-10 18:36:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ohanar created at 2014-04-10 18:38:00

(Sorry for the force push, didn't properly copy a symlink.)

I'll make further changes in future tickets (I'll of course fix any regressions here, if they are found), so I'm marking this as needs review.


---

Comment by ohanar created at 2014-04-10 19:21:48

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-04-13 21:48:29

Conflicts with the already-merged (but not released) #15990.

From looking at the source it seems that this still suffers from the same problem as #16154, the sage prompt transformer ought to run first and not last. Can you fix it here, then I'll close my ticket.


---

Comment by git created at 2014-04-13 23:40:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by ohanar created at 2014-04-13 23:41:13

ok, I added your fix for #16154 and merged in #15990.


---

Comment by vbraun created at 2014-04-14 09:52:17

Can you also fix the module path in the doctests? ;-)

```
sage -t --long src/sage/repl/ipython_extension.py
**********************************************************************
File "src/sage/repl/ipython_extension.py", line 78, in sage.repl.ipython_extension.SageMagics.crun
Failed example:
    from sage.misc.interpreter import get_test_shell
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.repl.ipython_extension.SageMagics.crun[0]>", line 1, in <module>
        from sage.misc.interpreter import get_test_shell
    ImportError: cannot import name get_test_shell
**********************************************************************
File "src/sage/repl/ipython_extension.py", line 79, in sage.repl.ipython_extension.SageMagics.crun
Failed example:
    shell = get_test_shell()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.repl.ipython_extension.SageMagics.crun[1]>", line 1, in <module>
        shell = get_test_shell()
    NameError: name 'get_test_shell' is not defined
**********************************************************************
1 item had failures:
```



---

Comment by vbraun created at 2014-04-14 09:58:04

Fixed
----
New commits:


---

Comment by vbraun created at 2014-04-14 16:55:35

Resolution: fixed
