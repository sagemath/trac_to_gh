# Issue 28899: make `%display text plain` the default for text-based backends

Issue created by migration from https://trac.sagemath.org/ticket/29136

Original creator: @mwageringel

Original creation time: 2020-02-01 21:57:48

CC:  nbruin mantepse

This ticket changes the default text display preference for the text-based backends `BackendIPythonCommandline` and `BackendDoctest` from `None` (unspecified) to `"plain"`. This was brought up on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/fXrv4JC6NEI).

This change only affects the behavior of `pretty_print`. The `pretty_print` output defaults to Latex if the text display preference is not specified, which is unsuitable for text-based backends. After setting the default to `"plain"`, the output is plain text.


```
sage: pretty_print(x^12)
\newcommand{\Bold}[1]{\mathbf{#1}}x^{12}
sage: %display plain
sage: pretty_print(x^12)
x^12
```


Besides changing the defaults, this ticket adds improvements to the documentation. In particular, the documentation of `pretty_print` now more clearly expresses what the function does. The implementation of `pretty_print` is left unchanged.

Moreover, a context manager `local_display_preferences` for temporarily changing the display preferences is added. Although not strictly necessary, this simplifies the doctests testing the behavior of text display `None` which is the default in the notebooks.

----

For reference, this is the backend hierarchy:

- `BackendBase`
    - `BackendSimple` (used for .sage scripts)
    - [✔] `BackendDoctest`
    - `BackendTest` (mock backend for testing)
    - `BackendSageNB`
    - `BackendIPython`
        - [✔] `BackendIPythonCommandline`
            - `BackendEmacs`
        - `BackendIPythonNotebook`
        - `BackendCell` (sage cell server)

The default preferences for all the other backends are left unchangend. In particular this applies to `BackendSimple`, as it is meant to be minimalistic and only supports plain text output anyway, so `pretty_print` does not use Latex output with this backend.


---

Comment by @mwageringel created at 2020-02-01 22:03:00

New commits:


---

Comment by @mwageringel created at 2020-02-01 22:03:00

Changing status from new to needs_review.


---

Comment by vbraun created at 2020-02-01 23:38:34

lgtm, but what do you think about a shorter name for the context manager? `local_display_preferences` can probably be improved... how about `display_context` or just `display`? In particular the latter is evocative of `%display`, so `display(text='ascii_art)` would be the closest to `%display text ascii_art`. Only downside is a potential clash with the IPython `display` command, but then that isn't all that useful anyways and its clear from the import what is being used.


---

Comment by nbruin created at 2020-02-02 06:36:57

`display` sounds perhaps a bit too active. I really associate it with `print` and `show` and would expect it to do something similar. Indeed in

```
with display(text=...):
  pretty_print(...)
```

it's not so bad, but I would still go for `display_context` to avoid all confusion.


---

Comment by @mwageringel created at 2020-02-02 11:28:34

Thanks for the suggestions. I have renamed it to `display_context`. The previous name was indeed a bit unwieldy.

I have also fixed the doctest failure in the Mathematica interface that was found by the patchbot ([diff](https://git.sagemath.org/sage.git/diff?id2=25517ec1ee19f5b8a4403c663873ab507656a8ba&id=7cc3a835279de3caa152b0ba2572b981e5979560)).
----
New commits:


---

Comment by @mwageringel created at 2020-03-29 21:08:17

Could someone review this please?


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by git created at 2020-05-21 21:32:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by klee created at 2021-04-08 03:59:12

As of Sage 9.3.rc2, `pretty_print()` prints plain by default in a terminal


---

Comment by klee created at 2021-04-08 04:07:31

Actually text preference of the display manager does not affect terminal ipython backend.

```
sage: dm = get_display_manager()                                                
sage: dm.preferences.text                                                       
sage: pretty_print(x^2)                                                         
x^2
sage: dm.preferences.text = 'latex'                                             
sage: pretty_print(x^2)                                                         
x^2
sage: latex(x^2)                                                                
x^{2}
sage: html(x^2)                                                                 
<html><script type="math/tex; mode=display">\newcommand{\Bold}[1]{\mathbf{#1}}x^{2}</script></html>
```



---

Comment by @mwageringel created at 2021-04-09 18:41:21

Replying to [comment:11 klee]:
> Actually text preference of the display manager does not affect terminal ipython backend.

Well, they do if set to `ascii_art` or `unicode_art`. As far as I can tell, this now behaves as it should. Thanks.

Is there an interest in the other changes on the current branch or should we close this ticket? Mainly, the branch adds a context manager for changing the display preferences and improves the documentation of `pretty_print`.


---

Comment by klee created at 2021-04-10 02:32:45

Replying to [comment:12 gh-mwageringel]:
> Replying to [comment:11 klee]:
> > Actually text preference of the display manager does not affect terminal ipython backend.
> 
> Well, they do if set to `ascii_art` or `unicode_art`. As far as I can tell, this now behaves as it should. Thanks.

Right. I missed that.

> Is there an interest in the other changes on the current branch?

I don't know. Possibly. At least you need to revise the ticket description, and explain what this ticket achieves in the changed situation.


---

Comment by @mwageringel created at 2021-04-29 20:05:16

New commits:


---

Comment by klee created at 2021-04-30 04:56:33

What is the advantage of using `display_context` over using existing `get_display_manager`? Can't we do the same in doctesting with the following?

```
sage: from sage.repl.rich_output import get_display_manager
sage: dm = get_display_manager()
sage: dm.preferences.text = 'ascii_art'  
```



---

Comment by @mwageringel created at 2021-04-30 20:42:01

Yes, that should work, but one also needs to set it back to the default value after the doctest, as it is not automatically reset by the doctesting framework. However, this would also add a pattern to the documentation that is not suitable for general use outside of doctests (in contrast to the context manager). Outside of tests, one would have to restore the previous value, not the default, and wrap everything in try-except, which is almost exactly what the context manager accomplishes.

I admit the benefits are small. If you prefer, we can make this ticket just about the documentation. Otherwise, if we keep `display_context`, I will look for other places in the documentation that could make use of it.


---

Comment by @mwageringel created at 2021-04-30 20:42:01

Changing status from needs_review to needs_info.


---

Comment by klee created at 2021-04-30 23:24:35

Replying to [comment:16 gh-mwageringel]:
> Yes, that should work, but one also needs to set it back to the default value after the doctest, as it is not automatically reset by the doctesting framework. 

Okay. How about outside of the doctesting framework? I myself do not use rich text output much. But if you do and find yourself frequently changing text preferences, doesn't it make sense to import `display_context` into the global namespace so that you do not need to import it in each session? This also would make the doctest look cleaner. But as our policy is to minimize the global namespace, we should do it only if it benefits many users.


---

Comment by @mwageringel created at 2021-05-01 14:30:41

Replying to [comment:17 klee]:
> How about outside of the doctesting framework? I myself do not use rich text output much. But if you do and find yourself frequently changing text preferences, doesn't it make sense to import `display_context` into the global namespace so that you do not need to import it in each session?

For interactive use, I would just use the magic `%display unicode_art` for instance, so adding `display_context` to the global namespace does not seem necessary. I have added that magic to my sage.init file and rarely change it. I have difficulty to think of a non-hypothetical use-case in library code, so I admit this is not so useful outside doctests.


---

Comment by klee created at 2021-05-03 02:28:30

For doctesting rich output textual representations, functions like `ascii_art()`, `unicode_art()` are commonly used. So I don't see a room for `display_context` there.

For the documentation of `pretty_print`, `%display` magic should be used rather than `display_context` since that is what Sage users use to change preferences. Since `%display` errors out in doctests, we need to tag it `# not tested` 

In conclusion, I don't see any real necessity or benefit of `display_context` in Sage.  

One other comment:

```diff
--- a/src/sage/repl/rich_output/pretty_print.py
+++ b/src/sage/repl/rich_output/pretty_print.py
@@ -4,7 +4,7 @@ The ``pretty_print`` command
 
 Works similar to the ``print`` function, except that it always tries
 to use a rich output for an object, as specified via the text display
-preference. If such a rich output is not available, it is falling back on the
+preference. If such a rich output is not available, it falls back on the
 plain text.
 
 EXAMPLES::
```



---

Comment by @mwageringel created at 2021-05-03 17:56:55

Yes, I agree.

Replying to [comment:19 klee]:
> For the documentation of `pretty_print`, `%display` magic should be used rather than `display_context` since that is what Sage users use to change preferences. Since `%display` errors out in doctests, we need to tag it `# not tested` 

I have implemented this by hiding the actual change of the preferences in a `TESTS:` block which is not shown in the documentation. An alternative would be to use `get_test_shell()`, which is commonly done for such IPython specific features. This would have the advantage that it does not use `# not tested`, but makes the documentation a bit harder to understand.
----
New commits:


---

Comment by @mwageringel created at 2021-05-03 17:56:55

Changing priority from major to minor.


---

Comment by @mwageringel created at 2021-05-03 17:56:55

Changing status from needs_info to needs_review.


---

Comment by klee created at 2021-05-04 01:14:35

Okay. It seems that this is the best we can do right now. In the future, I hope we could remove the `# not tested` tag though.


---

Comment by klee created at 2021-05-04 01:14:35

Changing status from needs_review to positive_review.


---

Comment by klee created at 2021-07-19 00:37:01

Changing status from positive_review to needs_work.


---

Comment by klee created at 2021-07-19 00:37:01

Merge fails.


---

Comment by git created at 2021-07-26 20:09:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2021-07-26 20:11:25

Changing priority from minor to major.


---

Comment by @mwageringel created at 2021-07-26 20:11:25

Trivial merge, so I am setting this back to positive.


---

Comment by @mwageringel created at 2021-07-26 20:11:25

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-08-29 09:37:53

Resolution: fixed
