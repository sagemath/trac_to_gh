# Issue 25137: Fix cryptominisat build on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-05-16 14:55:09

CC:  slelievre tscrim jmantysalo embray jdemeyer saraedum tmonteil vdelecroix mjo novoselt fbissey dimpase




---

Comment by embray created at 2018-05-16 14:56:46

Changing status from new to needs_review.


---

Comment by embray created at 2018-05-16 14:56:46

New commits:


---

Comment by embray created at 2018-05-16 15:18:25

Turns out there's nothing to report upstream, because the problems with Cygwin are already fixed there.  However, the Cygwin fixes are kind of incidental to other changes.  Until/unless we upgrade this package in Sage, these specifically targeted fixes are simpler to patch in than the larger changes in upstream.


---

Comment by saraedum created at 2018-05-26 17:05:00

I'm confused. Doesn't this add `-g` twice?


---

Comment by saraedum created at 2018-05-26 17:05:09

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-05-28 14:04:37

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-05-28 14:04:37

Yes, I had intended to remove the `-g` from those earlier lines.


---

Comment by git created at 2018-05-28 17:06:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-05-31 10:36:31

Please see how it looks like with the new release #25480. Do you want to put this ticket as a dependency?


---

Comment by embray created at 2018-05-31 12:12:08

This might be mostly superseded by #25480, except maybe for the `spkg-install` updates.
I'll test and see...


---

Comment by saraedum created at 2018-07-04 17:03:58

Any update on this?


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by jdemeyer created at 2019-01-24 09:32:12

What's the status of this now after #25480?


---

Comment by embray created at 2019-03-07 15:07:30

I'll have to give it another try. Maybe this is fixed by #25480? I haven't checked.


---

Comment by embray created at 2019-03-07 15:07:30

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-03-07 15:07:35

Set assignee to embray.


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-04 02:06:10

Building cryptominisat is still broken with 9.1.rc2 (https://github.com/mkoeppe/sage/runs/641394520)

```
-- Found python interpreter, libs and header files
-- Building python interface
CMake Error at python/CMakeLists.txt:44 (string):
  string sub-command REPLACE requires at least four arguments.


-- Python CFLAGS:  '-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -fdebug-prefix-map=/cygdrive/d/cyg_pub/devel/python/python37/python37-3.7.7-1.x86_64/build=/usr/src/debug/python37-3.7.7-1 -fdebug-prefix-map=/cygdrive/d/cyg_pub/devel/python/python37/python37-3.7.7-1.x86_64/src/Python-3.7.7=/usr/src/debug/python37-3.7.7-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -fdebug-prefix-map=/cygdrive/d/cyg_pub/devel/python/python37/python37-3.7.7-1.x86_64/build=/usr/src/debug/python37-3.7.7-1 -fdebug-prefix-map=/cygdrive/d/cyg_pub/devel/python/python37/python37-3.7.7-1.x86_64/src/Python-3.7.7=/usr/src/debug/python37-3.7.7-1'
-- Python LDFLAGS: '-lcrypt -lintl -ldl'
-- Python LINKFORSHARED flags: ''
-- Python module will be installed to : '/cygdrive/d/a/sage/sage/local'
-- Configuring incomplete, errors occurred!
See also "/cygdrive/d/a/sage/sage/local/var/tmp/sage/build/cryptominisat-5.6.8/src/CMakeFiles/CMakeOutput.log".
See also "/cygdrive/d/a/sage/sage/local/var/tmp/sage/build/cryptominisat-5.6.8/src/CMakeFiles/CMakeError.log".
********************************************************************************
Error configuring cryptominisat-5.6.8 with cmake
See the file
    /cygdrive/d/a/sage/sage/local/var/tmp/sage/build/cryptominisat-5.6.8/src/CMakeFiles/CMakeOutput.log
for details.
********************************************************************************
```



---

Comment by slelievre created at 2020-05-04 09:50:05

There's a new release of CryptoMiniSat. The issue here
was said to be fixed upstream so it might be enough
to upgrade to CryptoMiniSat 5.7.1.


---

Comment by mkoeppe created at 2020-05-04 15:37:52

Replying to [comment:21 slelievre]:
> There's a new release of CryptoMiniSat. The issue here
> was said to be fixed upstream so it might be enough
> to upgrade to CryptoMiniSat 5.7.1.
OK who wants to work on it?


---

Comment by slelievre created at 2020-07-14 14:45:35

CryptoMiniSat 5.8.0 was released on 2020-07-06.


---

Comment by mkoeppe created at 2020-07-14 16:52:46

Instructions for doing the upgrade:

1) Add `upstream_url` field to `checksums.ini` https://wiki.sagemath.org/ReleaseTours/sage-9.1#For_developers-1

2) Run `./sage -package update cryptominisat 5.8.0`

3) Remove patches

4) Try build on local machine

5) Push to the ticket


---

Comment by novoselt created at 2020-07-15 19:43:35

The needed URL is

```
upstream_url=https://github.com/msoos/cryptominisat/archive/VERSION.tar.gz
```



---

Comment by slelievre created at 2020-08-02 14:03:38

Forgot about this and opened #30264. I'm setting it to duplicate.


---

Comment by mkoeppe created at 2020-08-12 18:05:22

Would someone like to update the branch please?


---

Comment by slelievre created at 2020-08-13 13:14:27

Changing keywords from "" to "upgrade, cryptominisat".


---

Comment by slelievre created at 2020-08-13 13:14:27

With this branch, `make cryptominisat` and `sage -i cryptominisat` succeed.

They used to fail with Sage 9.x for the previous version of the package.

Tested on Debian 10 buster and macOS 10.14.6 Mojave. Cygwin testing needed.

New doctest failure (both on Debian and macOS):

```bash
$ OPT='--optional=build,cryptominisat,dochtml,memlimit,sage'
$ ./sage -t --long $OPT --random-seed=0 src/sage/sat/boolean_polynomials.py
too many failed tests, not using stored timings
Running doctests with ID 2020-08-13-14-39-55-b4ff37bc.
Git branch: develop
Using --optional=build,cryptominisat,dochtml,memlimit,sage
Doctesting 1 file.
sage -t --long --random-seed=0 src/sage/sat/boolean_polynomials.py
**********************************************************************
File "src/sage/sat/boolean_polynomials.py", line 131, in sage.sat.boolean_polynomials.solve
Failed example:
    sr = sage.crypto.mq.SR(1, 4, 4, 8, allow_zero_inversions = True)                  # optional - cryptominisat, long time
Expected nothing
Got:
    c [g 0] truth-find prop checks  : 156
    c [g 0] -> of which prop        : 22.44 %
    c [g 0] -> of which confl       :  0.64 %
    c [g 0] elim called             : 54
    c [g 0] ---> which lead to prop : 22.22 %
    c [g 0] ---> which lead to confl:  0.00 %
    c [g 0] size: 12    x 24
    c [g 1] truth-find prop checks  : 178
    c [g 1] -> of which prop        : 51.12 %
    c [g 1] -> of which confl       :  0.00 %
    c [g 1] elim called             : 150
    c [g 1] ---> which lead to prop : 11.33 %
    c [g 1] ---> which lead to confl:  0.00 %
    c [g 1] size: 12    x 24
**********************************************************************
1 item had failures:
   1 of  40 in sage.sat.boolean_polynomials.solve
    [45 tests, 1 failure, 80.53 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/sat/boolean_polynomials.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 80.6 seconds
    cpu time: 82.1 seconds
    cumulative wall time: 80.5 seconds
```

----
New commits:


---

Comment by mkoeppe created at 2020-08-13 15:00:45

For broader testing, push a tag to github...


---

Comment by slelievre created at 2020-08-21 17:38:28

The extra verbosity needs fixing before wider testing. Help needed.


---

Comment by slelievre created at 2020-08-31 18:20:48

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2020-08-31 18:20:48

Or maybe it only happens on my machine?


---

Comment by tmonteil created at 2020-09-01 18:59:04

I had a look some time ago, i also had such issues, so it is not only on your machine. If i understood correctly (to be checked), it is possible that the verbosity happens when a cryptominisat instance is run while another is still running, as if we got the log of the previous instance (?). You could inspect by adding some sleep between doctests, just to check.


---

Comment by tmonteil created at 2020-09-01 18:59:40

So, i expect the doctest to fail.


---

Comment by tmonteil created at 2020-09-01 18:59:40

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-11-14 02:49:37

Currently we build cryptominisat including its Python bindings (`pycryptosat`).
This is slightly problematic for the plan to separate non-Python packages (`SAGE_LOCAL`) from Python packages (`SAGE_VENV`), see #29013 (and #30534 for `pynac`).

But there is also https://pypi.org/project/pycryptosat/, which can be installed separately.  Its release history seems to be out of sync with cryptominisat.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by tmonteil created at 2021-09-22 10:20:45

I forgot the existence of this ticket and created #32545 to get a faster cryptominisat, here is a branch that fixes the issue: i removed the `s_verbosity=1` option of some doctest, since it produces noise to another unrelated doctest that appears later in the same file (which confirms [comment:36 comment:36]).

I could not test on Cygwin.


---

Comment by tmonteil created at 2021-09-22 10:20:45

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-09-22 15:52:02

It would be good to address comment:39


---

Comment by tmonteil created at 2021-09-22 19:13:02

Replying to [comment:43 mkoeppe]:
> It would be good to address comment:39

I am not sure i understand the rationale in favor of such a move:

- installing `pycryptosat` from `pypi` still requires that we ship `cryptominisat` binaries, so we just add one dependency without removing work on our side (worse, i guess we will have to ensure that the `pycryptosat` shipped by the author in the tarball is _not_ installed)

- relying on `pypi` + `pierrev` (the anonymous maintainer of `pycryptosat` in `pypi`) adds 2 intermediates, for which the web of trust is not very clear to me

- if `pycryptosat` shipped by `pypi` stops being updated, then we are locked to update `cryptominisat`

Or do you mean that we should make 2 spkg with different names (`cryptominisat` and `pycryptosat`) with the same upstream tarball, one with `sdh_make` and one with `sdh_pip_install` ?


---

Comment by mkoeppe created at 2021-09-22 19:19:28

Replying to [comment:44 tmonteil]:
> Or do you mean that we should make 2 spkg with different names (`cryptominisat` and `pycryptosat`) with the same upstream tarball, one with `sdh_make` and one with `sdh_pip_install` ?

Yes, this part at least would be a useful step, as the package will then work with the new separation of SAGE_LOCAL and SAGE_VENV (see for example #32442)


---

Comment by mkoeppe created at 2021-09-22 19:20:37

Replying to [comment:44 tmonteil]:
> - relying on `pypi` + `pierrev` (the anonymous maintainer of `pycryptosat` in `pypi`) adds 2 intermediates, for which the web of trust is not very clear to me

Yes, this is an unfortunate situation, perhaps we should contact the maintainers of the packages to help clarify it...


---

Comment by tmonteil created at 2021-09-22 21:55:04

Replying to [comment:45 mkoeppe]:
> Replying to [comment:44 tmonteil]:
> > Or do you mean that we should make 2 spkg with different names (`cryptominisat` and `pycryptosat`) with the same upstream tarball, one with `sdh_make` and one with `sdh_pip_install` ?
> 
> Yes, this part at least would be a useful step, as the package will then work with the new separation of SAGE_LOCAL and SAGE_VENV (see for example #32442)

OK. It seems nontrivial since the `python/README.rst` in the tarball states:


```
The pycryptosat python package compiles while compiling CryptoMiniSat. It
cannotbe compiled on its own, it must be compiled at the same time as
CryptoMiniSat.
```


So, perhaps the way is to keep a single spkg, compile the whole, and then install the various stuff according to the respective variables SAGE_LOCAL and SAGE_VENV ?


---

Comment by mkoeppe created at 2021-09-23 03:39:16

Replying to [comment:47 tmonteil]:
> It seems nontrivial since the `python/README.rst` in the tarball states:
> 
> {{{
> The pycryptosat python package compiles while compiling CryptoMiniSat. It
> cannotbe compiled on its own, it must be compiled at the same time as
> CryptoMiniSat.
> }}}
> 
> So, perhaps the way is to keep a single spkg, compile the whole, and then install the various stuff according to the respective variables SAGE_LOCAL and SAGE_VENV ?

That wouldn't work so well because of the way how we keep installation records for packages.

I think we should try to split it into two packages and just build, but not install, the library a second time.


---

Comment by slelievre created at 2021-09-23 14:03:46

This fails for me on Cygwin. For details, see:

- https://www.math.u-psud.fr/~lelievre/t/slel-25374.tar.gz


---

Comment by mkoeppe created at 2021-10-01 03:14:44

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2021-10-22 14:21:23

It seems pycryptosat might land on PyPI soon, see

- https://github.com/msoos/cryptominisat/issues/663#issuecomment-949415672


---

Comment by slelievre created at 2021-11-08 12:40:44

In fact it has been there for a while:

- https://pypi.org/project/pycryptosat/

but probably we are waiting on a new release?


---

Comment by slelievre created at 2022-01-13 20:08:53

See also

- #33162: Fix installation of cryptominisat and pycryptosat


---

Comment by mkoeppe created at 2022-01-14 23:55:25

Changing component from porting: Cygwin to packages: optional.


---

Comment by mkoeppe created at 2022-01-14 23:55:25

Changing priority from minor to major.


---

Comment by dimpase created at 2022-01-16 10:16:17

Replying to [comment:46 mkoeppe]:
> Replying to [comment:44 tmonteil]:
> > - relying on `pypi` + `pierrev` (the anonymous maintainer of `pycryptosat` in `pypi`) adds 2 intermediates, for which the web of trust is not very clear to me
> 
> Yes, this is an unfortunate situation, perhaps we should contact the maintainers of the packages to help clarify it...

PyPI now lists msoos as the maintainer.


---

Comment by dimpase created at 2022-01-16 13:34:00

needs testing on cygwin in partiular
----
New commits:


---

Comment by dimpase created at 2022-01-16 13:34:00

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-01-16 13:37:02

running tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1704383865


---

Comment by mkoeppe created at 2022-01-16 18:13:27

Note that you need to run the workflows `tox-optional` and `cygwin-standard` to test it...


---

Comment by dimpase created at 2022-01-17 09:51:28

Replying to [comment:60 dimpase]:
> running tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1704383865

many (all?) runs failed with 

```
  [sagemath_doc_html-none]   make[3]: *** [Makefile:37: doc-inventory-reference] Error 2
  [sagemath_doc_html-none]   make[3]: Target 'doc-html' not remade because of errors.
```

(I cancelled after all docker ubuntu/debian runs failed)


---

Comment by git created at 2022-01-17 19:25:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-17 19:35:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-22 22:37:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tmonteil created at 2022-06-17 21:50:05

Is there something missing to get this ticket approved ?


---

Comment by mkoeppe created at 2022-06-17 21:51:21

It needs to be tested on Cygwin


---

Comment by tmonteil created at 2022-06-17 22:31:26

Replying to [comment:69 mkoeppe]:
> It needs to be tested on Cygwin

Isn't it unmaintained ?


---

Comment by mkoeppe created at 2022-06-17 22:39:30

Fine with me to just declare that this optional package is not supported on Cygwin.
But the ticket title promises something about Cygwin, so at least that should be changed.


---

Comment by dimpase created at 2022-06-18 07:53:08

Replying to [comment:69 mkoeppe]:
> It needs to be tested on Cygwin

Can it be tested with GH Actions?


---

Comment by tscrim created at 2022-06-18 09:17:18

I can try to setup a Cygwin build and test on Monday when I get to my office since my computer there has Windows 11.


---

Attachment


---

Comment by tscrim created at 2022-06-22 04:46:49

I was not able to build it following the installation instructions for Cygwin, building Sage from source, and running `sage -i cryptominisat`. I have attached the log. Let me know what other data you might need.


---

Comment by fbissey created at 2022-06-22 04:53:42

What version of cmake was used?


---

Comment by tscrim created at 2022-06-22 04:54:32

Replying to [comment:75 fbissey]:
> What version of cmake was used?


```
tscri`@`DESKTOP-I0BK7J0 ~/sage
$ cmake --version
cmake version 3.20.0

CMake suite maintained and supported by Kitware (kitware.com/cmake).
```



---

Comment by fbissey created at 2022-06-22 05:24:12

Can you attach those two as well

```
See also "/home/tscri/sage/local/var/tmp/sage/build/cryptominisat-5.8.0/src/CMakeFiles/CMakeOutput.log".
See also "/home/tscri/sage/local/var/tmp/sage/build/cryptominisat-5.8.0/src/CMakeFiles/CMakeError.log".
```

I suspect a variable is empty when it shouldn't. It may just be a matter of an extra option, but it could be a windows special.

This is where cmake says it fails

```
string(REPLACE "\n" " " PY_LINKFORSHARED_CONFIG ${PY_LINKFORSHARED_CONFIG})
```

If shared linking doesn't make sense on cygwin, it is not looking good.


---

Attachment


---

Attachment


---

Comment by tscrim created at 2022-06-22 05:26:38

Done.


---

Comment by fbissey created at 2022-06-22 08:33:45

Thanks. I always forgot how those two files are usually useless. I don't think we can easily build the python interface on cygwin. Mostly because to build the python module it wants dynamic flags - on linux for example

```
-- Found python interpreter, libs and header files
-- Building python interface
-- Python CFLAGS:  '-Wno-unused-result -Wsign-compare -DNDEBUG'
-- Python LDFLAGS: '-ldl  -lm'
-- Python LINKFORSHARED flags: '-Xlinker -export-dynamic'
-- Python module installation prefix: --prefix=/usr
```

If we can hand feed an appropriate `-DPY_LINKFORSHARED_CONFIG=...` to cmake on cygwin, we may be able to get something. The other option is to turn off python support on the platform :(

Anyone wanting to test flags can do so by running

```
EXTRA_OPTS="-DPY_LINKFORSHARED_CONFIG='$my_flags'" ./sage -i cryptominisat
```

courtesy of the cmake configure line in `spkg-install.in`

```
sdh_cmake -DUSE_GAUSS='ON' $EXTRA_OPTS
```



---

Comment by tscrim created at 2022-06-22 23:51:40

Replying to [comment:79 fbissey]:
> Anyone wanting to test flags can do so by running
> {{{
> EXTRA_OPTS="-DPY_LINKFORSHARED_CONFIG='$my_flags'" ./sage -i cryptominisat
> }}}

I ran this and it also did not work for me. Maybe the key bit in the log is this:

```
[cryptominisat-5.8.0] -- Python CFLAGS:  '-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall'
[cryptominisat-5.8.0] -- Python LDFLAGS: '-lcrypt -lintl -ldl'
[cryptominisat-5.8.0] -- Python LINKFORSHARED flags: ''
```

I can post updated logs if desired, but I don't think much has changed...


---

Comment by fbissey created at 2022-06-22 23:54:58

Well you were supposed to replace `$my_flags` by what you think should be there if you have a clue. And yes the key bit is

```
[cryptominisat-5.8.0] -- Python LINKFORSHARED flags: ''
```

the cmake script cannot handle an empty string here.


---

Comment by tscrim created at 2022-06-23 00:16:37

That is what I was thinking, but I have no idea what to actually put there as I am ignorant/dumb wrt most of the build stuff. I also tried with what was in your post, but it didn't like the `-export-dynamic`. Trying it with `-Xlinker` also results in

```
[cryptominisat-5.8.0] -- Python LINKFORSHARED flags: ''
```



---

Comment by fbissey created at 2022-06-23 00:20:30

I thought you could override the autodetection by providing it but may be you cannot. I'd have to run it interactively with `ccmake` to see what is possible.


---

Comment by fbissey created at 2022-06-23 00:24:56

OK, no possible override, it is not visible from the interface. Disabling python on cygwin is the only we'll build this out of the box.


---

Comment by fbissey created at 2022-06-23 00:34:11

Is the python build used on cygwin only static? Or is there a dynamic library somewhere?


---

Comment by tscrim created at 2022-06-23 00:37:29

Replying to [comment:85 fbissey]:
> Is the python build used on cygwin only static? Or is there a dynamic library somewhere?

I have no idea. How can I check this?


---

Comment by fbissey created at 2022-06-23 00:39:29

I don't know, I am not a windows person at all. I don't know how cygwin works. I am inspecting the source to figure out whether this particular is ever used. It may be possible to just edit it out.


---

Comment by tscrim created at 2022-06-23 00:46:07

It seems like it is dynamic:

```
tscri`@`DESKTOP-I0BK7J0 ~/sage
$ ./sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/home/tscri/sage

(sage-sh) tscri`@`DESKTOP-I0BK7J0:sage$ which python
/home/tscri/sage/local/var/lib/sage/venv-python3.9/bin/python

(sage-sh) tscri`@`DESKTOP-I0BK7J0:sage$ exit
Exited Sage subshell.

tscri`@`DESKTOP-I0BK7J0 ~/sage
$ ls -al /home/tscri/sage/local/var/lib/sage/venv-python3.9/bin/python
-rwxr-xr-x 1 tscri tscri 9747 Jun 22 11:05 /home/tscri/sage/local/var/lib/sage/venv-python3.9/bin/python

tscri`@`DESKTOP-I0BK7J0 ~/sage
$ ldd local/var/lib/sage/venv-python3.9/bin/python
        ntdll.dll => /cygdrive/c/Windows/SYSTEM32/ntdll.dll (0x7ffd1ac00000)
        KERNEL32.DLL => /cygdrive/c/Windows/System32/KERNEL32.DLL (0x7ffd1a0d0000)
        KERNELBASE.dll => /cygdrive/c/Windows/System32/KERNELBASE.dll (0x7ffd180e0000)
        cygwin1.dll => /usr/bin/cygwin1.dll (0x180040000)
        libpython3.9.dll => /usr/bin/libpython3.9.dll (0x3fcb60000)
        cygintl-8.dll => /usr/bin/cygintl-8.dll (0x3fe870000)
        cyggcc_s-seh-1.dll => /usr/bin/cyggcc_s-seh-1.dll (0x3ff490000)
        cygiconv-2.dll => /usr/bin/cygiconv-2.dll (0x3fe900000)
```

Here is also the Cygwin Python's install, which seems to be different:

```

tscri`@`DESKTOP-I0BK7J0 ~/sage
$ python
Python 3.9.10 (main, Jan 20 2022, 21:37:52)
[GCC 11.2.0] on cygwin
Type "help", "copyright", "credits" or "license" for more information.
>>>

tscri`@`DESKTOP-I0BK7J0 ~/sage
$ which python
/usr/bin/python

tscri`@`DESKTOP-I0BK7J0 ~/sage
$ ldd /usr/bin/python
        ntdll.dll => /cygdrive/c/Windows/SYSTEM32/ntdll.dll (0x7ffd1ac00000)
        KERNEL32.DLL => /cygdrive/c/Windows/System32/KERNEL32.DLL (0x7ffd1a0d0000)
        KERNELBASE.dll => /cygdrive/c/Windows/System32/KERNELBASE.dll (0x7ffd180e0000)
        cygwin1.dll => /usr/bin/cygwin1.dll (0x180040000)
        libpython3.9.dll => /usr/bin/libpython3.9.dll (0x3fcb60000)
        cygintl-8.dll => /usr/bin/cygintl-8.dll (0x3fe870000)
        cyggcc_s-seh-1.dll => /usr/bin/cyggcc_s-seh-1.dll (0x3ff490000)
        cygiconv-2.dll => /usr/bin/cygiconv-2.dll (0x3fe900000)
```



---

Comment by fbissey created at 2022-06-23 00:49:13

Good, to know. The bits that are blocking cmake are not actually doing anything in practise. So we can edit them out. Are you OK with trying a patch?


---

Comment by tscrim created at 2022-06-23 00:49:51

Replying to [comment:89 fbissey]:
> Good, to know. The bits that are blocking cmake are not actually doing anything in practise. So we can edit them out. Are you OK with trying a patch?

Yep, just tell me what to do.


---

Attachment

experimental patch for cryptominisat on cygwin


---

Comment by fbissey created at 2022-06-23 00:56:14

OK, I have just attached a patch to the ticket. From the sage root create the folder `build/pkgs/cryptominisat/patches/` and copy the patch in that folder.

Once done you can proceed with the normal `./sage -i cryptominisat`.


---

Comment by tscrim created at 2022-06-23 01:00:13

With the patch, it built successfully.


---

Comment by fbissey created at 2022-06-23 01:02:45

Great, I believe the patch is platform neutral because it only remove parts that are functionally dead. I will update the branch and once we had some retest on other platform we can get this in.


---

Comment by tscrim created at 2022-06-23 01:07:31

Now are tests in `src/sage/sat/solvers/cryptominisat.py` expected to pass? They are marked by `pycryptosat`, and when I run

```
$ ./sage -tp --optional=sage,pycryptosat src/sage/sat/solvers/cryptominisat.py
```

I get lots of failures coming down to this:

```
**********************************************************************
File "src/sage/sat/solvers/cryptominisat.py", line 50, in sage.sat.solvers.cryptominisat.CryptoMiniSat
Failed example:
    solver = CryptoMiniSat()                                  # optional - pycryptosat
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/lazy_import.pyx", line 253, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2942)
        self._object = getattr(__import__(self._module, {}, {}, [self._name]), self._name)
    ModuleNotFoundError: No module named 'pycryptosat'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/tscri/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/tscri/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.sat.solvers.cryptominisat.CryptoMiniSat[1]>", line 1, in <module>
        solver = CryptoMiniSat()                                  # optional - pycryptosat
      File "/home/tscri/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
        self._solver = Solver(verbose=int(verbosity), confl_limit=int(confl_limit), threads=int(threads))
      File "sage/misc/lazy_import.pyx", line 391, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4237)
        return self.get_object()(*args, **kwds)
      File "sage/misc/lazy_import.pyx", line 217, in sage.misc.lazy_import.LazyImport.get_object (build/cythonized/sage/misc/lazy_import.c:2619)
        return self._get_object()
      File "sage/misc/lazy_import.pyx", line 256, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:3057)
        raise FeatureNotPresentError(self._feature, reason=f'Importing {self._name} failed: {e}')
    sage.features.FeatureNotPresentError: pycryptosat is not available.
    Importing Solver failed: No module named 'pycryptosat'
    No equivalent system packages for cygwin are known to Sage.
    To install pycryptosat using the Sage package manager, you can try to run:
      !sage -i cryptominisat
    No equivalent system packages for pip are known to Sage.
```



---

Comment by fbissey created at 2022-06-23 01:10:14

Ok it installed but obviously it doesn't work. There should be a file with a name starting with `pycryptominisat` inside the `site-packages` folder of python. Can you see it? and if so what is the exact name?


---

Comment by fbissey created at 2022-06-23 01:11:51

New commits:


---

Comment by tscrim created at 2022-06-23 01:12:46

Because I was stupid and didn't realize that was a separate package because I probably mistyped the name when doing `./sage -i pycryptosat`. Although I am back with a very familiar error:

```
[pycryptosat-5.8.0] -- Python CFLAGS:  '-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall'
[pycryptosat-5.8.0] -- Python LDFLAGS: '-lcrypt -lintl -ldl'
[pycryptosat-5.8.0] -- Python LINKFORSHARED flags: ''
[pycryptosat-5.8.0] -- Python module installation prefix: --prefix=/home/tscri/sage/local/var/lib/sage/venv-python3.9
[pycryptosat-5.8.0] -- Configuring incomplete, errors occurred!
[pycryptosat-5.8.0] See also "/home/tscri/sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/pycryptosat-5.8.0/src/CMakeFiles/CMakeOutput.log".
[pycryptosat-5.8.0] See also "/home/tscri/sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/pycryptosat-5.8.0/src/CMakeFiles/CMakeError.log".
[pycryptosat-5.8.0] ****************************************************************************************************************************************************
[pycryptosat-5.8.0] Error configuring pycryptosat-5.8.0 with cmake
[pycryptosat-5.8.0] See the file
[pycryptosat-5.8.0]     /home/tscri/sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/pycryptosat-5.8.0/src/CMakeFiles/CMakeOutput.log
[pycryptosat-5.8.0] for details.
[pycryptosat-5.8.0] ****************************************************************************************************************************************************
```



---

Comment by fbissey created at 2022-06-23 01:15:25

Go figure, it needs patching too since it is the same package. I am going to update the branch.


---

Comment by tscrim created at 2022-06-23 01:15:52

I am now trying with the same patch copied over. This seems to be working...


---

Comment by git created at 2022-06-23 01:18:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-23 01:19:14

That worked and the tests in that file pass.


---

Comment by fbissey created at 2022-06-23 01:19:25

Cool and now that the branch is updated we should make sure `./sage -i pycryptosat` works properly from this branch.


---

Comment by fbissey created at 2022-06-23 01:20:48

And I should upstream the thing too, fixing this was just a matter of removing dead branches :)


---

Comment by tscrim created at 2022-06-23 01:21:55

I just did a force rebuild of `./sage -i -f pycryptosat` with the new branch and it is working.


---

Comment by fbissey created at 2022-06-23 01:28:58

I have added myself to authors, does anyone need to add themselves? Dima?

Next we need some reviewers to put their hands up. `@`tscrim just did cygwin so I added him there.


---

Comment by tscrim created at 2022-06-23 01:29:15

The force rebuild finished and the tests in files that mention `pycryptosat` and `cryptominisat` passed on Cygwin.


---

Comment by mkoeppe created at 2022-06-27 02:12:42

We should also add https://github.com/msoos/cryptominisat/pull/679 as a patch so that the next `setuptools` upgrade (#33866) does not break `cryptominisat`


---

Comment by fbissey created at 2022-06-27 02:15:25

Very sensible. I'll add it to my branch in the next few hours if no one else does it.


---

Comment by mkoeppe created at 2022-06-27 02:16:58

On macOS, I also get:

```
[cryptominisat-5.8.0] cd /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/cryptominisat-5.8.0/src/pycryptosat && /Users/mkoeppe/s/sage/sage-rebasing/local/bin/cmake -E env CFLAGS='-isysroot/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk\ -g\ -O2' /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.8/bin/python3 setup.py build_ext --inplace --rpath ../lib
[cryptominisat-5.8.0] [100%] Built target cryptominisat5-bin
[cryptominisat-5.8.0] clang: warning: no such sysroot directory: '/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -g -O2' [-Wmissing-sysroot]
[cryptominisat-5.8.0] In file included from /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/cryptominisat-5.8.0/src/pycryptosat/src/pycryptosat.cpp:27:
[cryptominisat-5.8.0] In file included from /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
[cryptominisat-5.8.0] /Library/Developer/CommandLineTools/usr/bin/../include/c++/v1/stdio.h:107:15: fatal error: 'stdio.h' file not found
```



---

Comment by mkoeppe created at 2022-06-27 03:10:44

This appears to come from https://github.com/msoos/cryptominisat/blob/master/python/CMakeLists.txt#L85


---

Comment by mkoeppe created at 2022-06-27 03:20:10

I don't see a fix for this in https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/cryptominisat.rb


---

Comment by mkoeppe created at 2022-06-27 03:25:53

cryptominisat master already contains a workaround for likely the same issue of misquoting: https://github.com/msoos/cryptominisat/pull/621/files


---

Comment by mkoeppe created at 2022-06-27 03:36:13

This whole broken `-isysroot` thing added in https://github.com/msoos/cryptominisat/commit/8e5c38b8f4099bf558ef1a18b2a8b893460e9943 should probably be removed upstream. But the path of least resistance for us would be to apply https://github.com/msoos/cryptominisat/pull/621 as a patch and to fake `NIX_CC`.


---

Comment by mkoeppe created at 2022-06-27 03:45:45

Next error:

```
[cryptominisat-5.8.0] [100%] Built target cryptominisat5-bin
[cryptominisat-5.8.0] In file included from src/pycryptosat.cpp:32:
[cryptominisat-5.8.0] In file included from ../cmsat5-src/cryptominisat5/cryptominisat.h:35:
[cryptominisat-5.8.0] ../cmsat5-src/cryptominisat5/solvertypesmini.h:33:1: error: unknown type name 'constexpr'
[cryptominisat-5.8.0] constexpr uint32_t var_Undef(0xffffffffU >> 4);
```

----
New commits:


---

Comment by git created at 2022-06-27 03:48:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-27 03:55:58

Now it builds at least `cryptominisat` for me.


---

Comment by fbissey created at 2022-06-27 04:03:34

It should work for `pycryptomini` provided you add the `NIX_CC=fake` thing to its `spkg-install.in` since I made its patches folder a link to the `cryptominisat` one, so patches would match.


---

Comment by mkoeppe created at 2022-06-27 04:05:13

pycryptosat currently fails for me with the `constexpr` problem (same as comment:115). This looks like it is the same as https://github.com/msoos/cryptominisat/issues/684


---

Comment by mkoeppe created at 2022-06-27 04:06:21

Homebrew fixes it like this: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/cryptominisat.rb#L39


---

Comment by git created at 2022-06-27 04:11:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-27 04:12:59

Now this builds for me. Strangely I didn't need the `NIX_CC` workaround. Looks like this broken stuff is only used when the Python module build is done from within the cmake build.


---

Comment by git created at 2022-06-27 04:15:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-06-27 04:16:06

So here's a simpler version without the NIX_CC workaround.


---

Comment by mkoeppe created at 2022-06-27 04:24:20

Builds OK and passes `./sage -tp src/sage/sat`


---

Comment by fbissey created at 2022-06-27 04:37:38

I am a bit uncertain as to where the c++11 flags are supposed to come from in https://github.com/msoos/cryptominisat/issues/684 and where they got missing. I'll dig that if I have time later, but some stuff is clearly not going well on OS X. I am not even sure how the above issue avoided the isysroot issue.


---

Comment by mkoeppe created at 2022-06-27 04:40:37

That pycryptosat setup.py.in is a big mess. Upstream should probably rewrite it using setuptools instead of distutils and back out the `sysconfig` manipulation.


---

Comment by mkoeppe created at 2022-06-27 04:47:07

Replying to [comment:128 fbissey]:
> I am not even sure how the above [...] avoided the isysroot issue.

Just by using `-DENABLE_PYTHON_INTERFACE=OFF` in the cryptominisat build


---

Comment by fbissey created at 2022-06-27 04:49:07

Replying to [comment:130 mkoeppe]:
> Replying to [comment:128 fbissey]:
> > I am not even sure how the above [...] avoided the isysroot issue.
> 
> Just by using `-DENABLE_PYTHON_INTERFACE=OFF` in the cryptominisat build

I was talking about https://github.com/msoos/cryptominisat/issues/684 which I guess means there were no `CFLAGS`.


---

Comment by mkoeppe created at 2022-06-27 04:49:52

With #34017 merged, also `tox -e docker-debian-stretch-standard -- pycryptosat` passes.


---

Comment by mkoeppe created at 2022-06-27 04:51:04

Replying to [comment:131 fbissey]:
> Replying to [comment:130 mkoeppe]:
> > Replying to [comment:128 fbissey]:
> > > I am not even sure how the above [...] avoided the isysroot issue.
> > 
> I was talking about https://github.com/msoos/cryptominisat/issues/684 which I guess means there were no `CFLAGS`.

I agree, that's the likely explanation.


---

Comment by mkoeppe created at 2022-06-27 05:11:32

I would be happy with setting this ticket to positive review. Perhaps it should be checked that the changes did not break anything on Cygwin, but I think it's unlikely


---

Comment by mkoeppe created at 2022-06-27 17:25:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-03 22:06:11

Resolution: fixed


---

Comment by msoos created at 2022-10-23 22:09:48

Replying to [comment:129 Matthias Köppe]:
> That pycryptosat setup.py.in is a big mess. Upstream should probably rewrite it using setuptools instead of distutils and back out the `sysconfig` manipulation.

Hi, this is upstream talking :) Yep, that is a big mess. Sorry. So, I fixed it up, and it's waaaaay more modern now. Also, there is a Python package, with pip install working etc:

https://pypi.org/project/pycryptosat/

Auto-builds the binary package using [GitHub](GitHub) actions so that's sweet. Let me know how it could be changed to be better. However, I think it should be a lot closer to "good" than the previous setup.

Mate


---

Comment by mkoeppe created at 2022-10-23 22:52:29

Next update in #34687
