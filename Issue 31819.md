# Issue 31819: python3 spkg: ModuleNotFoundError: No module named 'binascii'

Issue created by migration from https://trac.sagemath.org/ticket/32056

Original creator: mkoeppe

Original creation time: 2021-06-24 17:36:52

CC:  culler dimpase

Reported for Sage 9.3 (Python 3.9.2) within freshly installed Ubuntu 20.04.02 LTS in https://groups.google.com/g/sage-devel/c/euE9MJnfjAo/m/QUv4fXXuBQAJ 

Reported for Sage 9.4.beta3 (Python 3.9.5) on macOS 11.4 https://groups.google.com/g/sage-devel/c/euE9MJnfjAo/m/QUv4fXXuBQAJ


---

Comment by culler created at 2021-06-24 18:08:01

For macOS the binascii module mysteriously failed to be compiled after running


```
git switch develop
make
```


but the problem went away after running


```
make distclean
./configure
make
```



---

Comment by mkoeppe created at 2021-06-24 18:18:46

... that's unfortunately not specific enough. Any chance you can restore the broken state with TimeMachine so that we can diagnose the issue?


---

Comment by slabbe created at 2021-06-24 20:14:18

In my case, the end of log file is:


```
  [python3-3.9.5] error installing, exit status 1. End of log file:
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/var/tmp/sage/build/python3-3.9.5/src/./setup.py", line 33, in <module>
  [python3-3.9.5]       from distutils import log
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/_distutils_hack/__init__.py", line 83, in create_module
  [python3-3.9.5]       return importlib.import_module('setuptools._distutils')
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/var/tmp/sage/build/python3-3.9.5/src/Lib/importlib/__init__.py", line 127, in import_module
  [python3-3.9.5]       return _bootstrap._gcd_import(name[level:], package, level)
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/setuptools/__init__.py", line 16, in <module>
  [python3-3.9.5]       import setuptools.version
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/setuptools/version.py", line 1, in <module>
  [python3-3.9.5]       import pkg_resources
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/pkg_resources/__init__.py", line 23, in <module>
  [python3-3.9.5]       import zipfile
  [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/var/tmp/sage/build/python3-3.9.5/src/Lib/zipfile.py", line 6, in <module>
  [python3-3.9.5]       import binascii
  [python3-3.9.5]   ModuleNotFoundError: No module named 'binascii'
  [python3-3.9.5]   Makefile:641: recipe for target 'sharedmods' failed
  [python3-3.9.5]   make[5]: *** [sharedmods] Error 1
  [python3-3.9.5]   ********************************************************************************************
  [python3-3.9.5]   Error building python3-3.9.5
  [python3-3.9.5]   ********************************************************************************************
  [python3-3.9.5]   
  [python3-3.9.5]   real    2m13.957s
  [python3-3.9.5]   user    1m48.606s
  [python3-3.9.5]   sys    0m10.179s
  [python3-3.9.5]   ************************************************************************
  [python3-3.9.5]   Error building package python3-3.9.5
  [python3-3.9.5]   ************************************************************************
  [python3-3.9.5] Full log file: /home/slabbe/GitBox/sage/logs/pkgs/python3-3.9.5.log
```



---

Comment by mkoeppe created at 2021-06-24 20:19:09


```
 [python3-3.9.5]     File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/_distutils_hack/__init__.py", line 83, in create_module
```

Excellent -- it's what I thought.
Can you try `make setuptools-clean python3` please?


---

Comment by mkoeppe created at 2021-06-24 22:02:02

Here's a solution
----
New commits:


---

Comment by mkoeppe created at 2021-06-24 22:02:02

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-24 22:02:15

Changing priority from major to critical.


---

Comment by dimpase created at 2021-06-25 09:40:55

OK - although I don't have an easy way to reproduce the bug, so the review is based on reading only.


---

Comment by dimpase created at 2021-06-25 09:40:55

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2021-06-25 12:23:06

After the issue, I did `.configure --with-python=/usr/bin/python3.8` which made the compilation of sage to work.

This morning, I tried to reproduce the bug without the `--with-python=/usr/bin/python3.8`. It triggers the compilation of python3.9.5 shipped with sage, but it did build it correctly:


```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG python3...                                             
checking whether any of bzip2 xz libffi is installed as or will be installed as SPKG... no
checking for python3 >= 3.7.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline,
 socket, zlib, distutils.core...                                                                     checking ... whether /usr/bin/python3 is good... no, Python 3.6.9 is too old                 
                                                                                                     configure: to try to use a different system python, use ./configure --with-python=/path/to/python    
configure: no suitable system package found for SPKG python3                                         -----------------------------------------------------------------------------   

[...]

[python3-3.9.5] installing. Log file: /home/slabbe/GitBox/sage/logs/pkgs/python3-3.9.5.log
  [python3-3.9.5] successfully installed.
```


What should I do to reproduce the bug? Checkout 9.4.beta0, compile it, and then checkout 9.4.beta3 and then compile it?


---

Comment by slabbe created at 2021-06-25 13:03:03

Ok, I managed to reproduce the bug by compiling 9.4.beta1 (after downgrading from a compiled 9.4.beta3) which is shipped with Python 3.9.2.


```
  File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/setuptools/__init__.py", line 16, in <module>
    import setuptools.version
  File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/setuptools/version.py", line 1, in <module>
    import pkg_resources
  File "/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/pkg_resources/__init__.py", line 23, in <module>
    import zipfile
  File "/home/slabbe/GitBox/sage/local/var/tmp/sage/build/python3-3.9.2/src/Lib/zipfile.py", line 6, in <module>
    import binascii
ModuleNotFoundError: No module named 'binascii'
Makefile:638: recipe for target 'sharedmods' failed
make[5]: *** [sharedmods] Error 1
*****************************************************************************************************
Error building python3-3.9.2
*****************************************************************************************************
```



---

Comment by slabbe created at 2021-06-25 14:24:37

Then, I checked out 9.4.beta3, run make, and was able to reproduce the error with python 3.9.5. Then, I pulled the current branch of this ticket and then `python3.9.5` was built ok after a make. So I feel this branch is fixing the issue.

But, I now get an error with cython (forgot to copy paste the error message, sorry). Then, I did make distclean and make and I am waiting for the result.


---

Comment by slabbe created at 2021-06-25 14:50:44


```
[...]
Sage build/upgrade complete!
[...]
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4.beta3, Release Date: 2021-06-21               │
│ Using Python 3.9.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: 
```



---

Comment by mkoeppe created at 2021-06-25 15:37:50

Thanks for the review!


---

Attachment


---

Comment by culler created at 2021-06-25 20:10:01

I built the master branch after "make distclean" and then switched to the develop branch. I applied the patch to Makefile.in and then ran the incremental build with make.  There was no problem building python3.  However, the build failed on the numpy spkg. It is hard to imagine that this is related, as the exception occurred in the pip package. But perhaps there is an analagous issue with pip.  The actual exception was:


```
  ImportError: cannot import name 'gen' from 'tornado' (unknown location)  
```


The traceback is below.  I will attach the numpy build log. 

```
[numpy-1.20.3] Traceback (most recent call last):
[numpy-1.20.3]   File "/Users/culler/programs/Sage_macOS/Sage_framework/repo/sage/local/lib/python3.9/runpy.py", line 197, in _run_module_as_main
[numpy-1.20.3]     return _run_code(code, main_globals, None,
[numpy-1.20.3]   File "/Users/culler/programs/Sage_macOS/Sage_framework/repo/sage/local/lib/python3.9/runpy.py", line 87, in _run_code
[numpy-1.20.3]     exec(code, run_globals)
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/__main__.py", line 29, in <module>
[numpy-1.20.3]     from pip._internal.cli.main import main as _main
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/cli/main.py", line 9, in <module>
[numpy-1.20.3]     from pip._internal.cli.autocompletion import autocomplete
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/cli/autocompletion.py", line 10, in <module>
[numpy-1.20.3]     from pip._internal.cli.main_parser import create_main_parser
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/cli/main_parser.py", line 8, in <module>
[numpy-1.20.3]     from pip._internal.cli import cmdoptions
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/cli/cmdoptions.py", line 23, in <module>
[numpy-1.20.3]     from pip._internal.cli.parser import ConfigOptionParser
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/cli/parser.py", line 12, in <module>
[numpy-1.20.3]     from pip._internal.configuration import Configuration, ConfigurationError
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/configuration.py", line 27, in <module>
[numpy-1.20.3]     from pip._internal.utils.misc import ensure_dir, enum
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_internal/utils/misc.py", line 38, in <module>
[numpy-1.20.3]     from pip._vendor.tenacity import retry, stop_after_delay, wait_fixed
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_vendor/tenacity/__init__.py", line 523, in <module>
[numpy-1.20.3]     from pip._vendor.tenacity.tornadoweb import TornadoRetrying
[numpy-1.20.3]   File "/Users/culler/.sage/local/lib/python3.9/site-packages/pip/_vendor/tenacity/tornadoweb.py", line 23, in <module>
[numpy-1.20.3]     from tornado import gen
[numpy-1.20.3] ImportError: cannot import name 'gen' from 'tornado' (unknown location)
[numpy-1.20.3] Error: installing with pip3 failed
[numpy-1.20.3] ********************************************************************************
[numpy-1.20.3] Error installing numpy-1.20.3-cp39-cp39-macosx_10_9_x86_64.whl
[numpy-1.20.3] ******************************************************************************
```



---

Comment by culler created at 2021-06-25 20:18:35

I just noticed that the cysignals spkg also failed to install with the same exception about importing gen from tornado.  I was using make -j4, and evidently I got both errors simultaneously.


---

Comment by mkoeppe created at 2021-06-25 20:20:47

That's an unrelated problem fixed in #32022


---

Comment by vbraun created at 2021-06-29 17:40:01

Resolution: fixed


---

Comment by isuruf created at 2021-09-25 04:20:31

This is still an issue with conda-forge ubuntu tox job. See https://github.com/isuruf/sage/runs/3704134442?check_suite_focus=true


```
Log file: /home/runner/work/sage/sage/logs/pkgs/python3-3.9.6.log
  [python3-3.9.6] error installing, exit status 1. End of log file:
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/local/var/tmp/sage/build/python3-3.9.6/src/./setup.py", line 33, in <module>
  [python3-3.9.6]       from distutils import log
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/conda/lib/python3.9/site-packages/_distutils_hack/__init__.py", line 88, in create_module
  [python3-3.9.6]       return importlib.import_module('setuptools._distutils')
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/conda/lib/python3.9/importlib/__init__.py", line 127, in import_module
  [python3-3.9.6]       return _bootstrap._gcd_import(name[level:], package, level)
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/conda/lib/python3.9/site-packages/setuptools/__init__.py", line 16, in <module>
  [python3-3.9.6]       import setuptools.version
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/conda/lib/python3.9/site-packages/setuptools/version.py", line 1, in <module>
  [python3-3.9.6]       import pkg_resources
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/conda/lib/python3.9/site-packages/pkg_resources/__init__.py", line 23, in <module>
  [python3-3.9.6]       import zipfile
  [python3-3.9.6]     File "/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-minimal/conda/lib/python3.9/zipfile.py", line 6, in <module>
  [python3-3.9.6]       import binascii
  [python3-3.9.6]   ModuleNotFoundError: No module named 'binascii'
```

