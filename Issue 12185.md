# Issue 12185: Make groupoids garbage collectable

Issue created by migration from https://trac.sagemath.org/ticket/12357

Original creator: SimonKing

Original creation time: 2012-01-25 12:30:11

Assignee: rlm

CC:  nthiery jpflori

Currently, the groupoid of an object P can not be garbage collected, even when deleting P.

Even worse: The persistence of `Groupoid(P)` also prevents P from being garbage collected.

The attached patch aims at solving it: An external reference to either P or `Groupoid(P)` is enough to keep both alive. But without an external reference, both P and `Groupoid(P)` become collectable.

Example from the docs:

```
            sage: P = GF(151)['x','y']
            sage: n = id(Groupoid(P))
            sage: import gc
            sage: _ = gc.collect()
            sage: n == id(Groupoid(P))   # indirect doctest
            True

        Thus, the groupoid is cached. But when deleting ``P``, its
        groupoid can be garbage collected as well::

            sage: del P
            sage: _ = gc.collect()
            sage: P = GF(151)['x','y']
            sage: n == id(Groupoid(P))
            False

        TESTS:

        We test against some corner cases::

            sage: Groupoid(None)
            Traceback (most recent call last):
            ...
            TypeError: Groupoid of None is not defined
            sage: Groupoid(1)
            Traceback (most recent call last):
            ...
            TypeError: 1 must either allow attribute assignment or be instances of <type 'sage.structure.parent.Parent'>
            sage: class A: pass
            sage: a = A()
            sage: Groupoid(a)
            Groupoid with underlying set <__main__.A instance at ...>
            sage: Groupoid(a) is Groupoid(a)
            True
```



---

Comment by SimonKing created at 2012-01-25 12:34:07

Changing status from new to needs_review.


---

Comment by SimonKing created at 2012-01-25 12:34:07

I did not run the full test suite yet. It could be that some silly old doctests use the groupoids in a way they are not intended, such as `Groupoid(1)`. If this is the case, then my patch has to change. Otherwise: Needs review!


---

Comment by SimonKing created at 2012-01-25 19:10:19

To my surprise, there were no nasty old doctests. Hence, `make ptest` went well, with the patch from here and its dependencies!


---

Comment by SimonKing created at 2012-01-25 20:30:56

Concerning timings:

Without the patch, the groupoid of P is stored in a dictionary, indexed by P. Hence, access to the cache is slow if `hash(P)` is slow.

Some data points:

```
sage: P = GF(151)['x','y']
sage: %timeit G = Groupoid(P)  # slow hash
625 loops, best of 3: 20.9 µs per loop
sage: %timeit G = Groupoid(ZZ) # fast hash
625 loops, best of 3: 1.75 µs per loop
sage: class Bar(Parent): pass
....: 
sage: P = Bar()
sage: %timeit G = Groupoid(P)  # slow hash
625 loops, best of 3: 15.3 µs per loop
```


But with the patch, it is stored as an attribute of P. Hence, it is slow if attribute access is slow. The point is that even slow attribute access is faster than slow hash, and slow attribute access is only little slower than fast hash:

```
sage: P = GF(151)['x','y']
sage: %timeit G = Groupoid(P)  # slow attribute access
625 loops, best of 3: 3.11 µs per loop
sage: %timeit G = Groupoid(ZZ) # slow attribute access
625 loops, best of 3: 3.1 µs per loop
sage: class Bar(Parent): pass
....: 
sage: P = Bar()
sage: %timeit G = Groupoid(P)  # fast attribute access
625 loops, best of 3: 1.59 µs per loop
```


Hence, I believe that the patch is not only fixing a memory leak, but has the potential to generate a speed-up.


---

Comment by jpflori created at 2012-02-08 17:19:44

Changing keywords from "" to "groupoid cache Cernay2012".


---

Comment by jpflori created at 2012-02-08 17:19:44

Changing status from needs_review to needs_info.


---

Comment by jpflori created at 2012-02-08 17:19:44

This is the simplest patch of the cache problems suite, and it does not depend on !#715, so I begin with this one.

I'm a little bit confused by all those tests for None in your patch.

Isn't the first one sufficient?

More specifically, the second test "if S is not None" isn't superfluous ?

And if it is not None, can G be None ? (I guess there is some cython voodoo involved here)

To answer my own question, I guess it is none if S is not a Parent (as in your example with 1).

Once you answer me back, I'll post a reviewer patch with some additional minor corrections.


---

Comment by SimonKing created at 2012-02-08 18:19:53

Yes, the test "if S is not None" in line 103 seems redundant, as S being None would result in an error being raised in line 92.

Concerning Cython voodoo: If S is not None and not of type Parent, then `G == S` in line 106 would result in a type error (since G is cdefined) - which is desired behaviour. But if S were None, then `G == S` in line 106 would not complain, and then line 109 would segfault. This is why there must be a test for the corner case - of course, one test would be enough.


---

Comment by SimonKing created at 2012-02-08 18:19:53

Changing status from needs_info to needs_review.


---

Comment by jpflori created at 2012-02-10 12:38:17

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2012-02-10 12:38:17

Ok, I've posted a reviewer patch removing the second test and adding some comments on the code.

Everything is fine for me (as long as further modification in #715 and #12313 do not affect the ticket here).

So I'll put is as positive review now.


---

Comment by jpflori created at 2012-02-10 12:38:48

Reviewer patch


---

Attachment

The reviewer patch looks fine to me. Thank you!


---

Comment by jdemeyer created at 2012-02-12 12:30:03

Moving this to sage-pending for now since it depends on two non-positively reviewed tickets.


---

Comment by SimonKing created at 2012-03-09 16:31:03

There is a conflict with #11943.

 - The ticket here is pending anyway
 - #11943 has only one dependency, that is already merged
 - #11943 is more fundamental than the patch here.

Therefore, I suggest to rebase my patch with respect to #11943.


---

Comment by SimonKing created at 2012-03-09 16:45:35

Done!

Apply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch


---

Comment by SimonKing created at 2012-04-15 13:44:55

Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.

Should one perhaps revert the dependencies? I.e., make it so that the patch here _only_ depends on #11943, and then rebase #715 and #12313 relative to it?


---

Comment by SimonKing created at 2012-04-15 13:44:55

Changing status from positive_review to needs_work.


---

Attachment

Make groupoids garbage collectable, but still use a cache by strong references. Relative #11943


---

Comment by SimonKing created at 2012-04-15 15:14:55

I had a test that works like "Create an object and store its memory address; delete it, do garbage collection, create the object again and show that the memory address is different from the old".

Of course, that is very fragile. By chance, when applying a totally unrelated ticket, the test breaks for me.

Therefore I made a change in the first patch. The test now verifies that the stored memory address does not occur among the memory addresses of uncollectable objects, after garbage collection.

I did not change the dependencies, yet. But perhaps the reviewer has an opinion on that matter?

Apply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch


---

Comment by SimonKing created at 2012-04-15 15:15:12

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2012-04-17 09:10:14

Replying to [comment:12 SimonKing]:
> Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.
You're right.
> 
> Should one perhaps revert the dependencies? I.e., make it so that the patch here _only_ depends on #11943, and then rebase #715 and #12313 relative to it?

The correct behavior here depends on the application of the three previous tickets, am I right ?
So I think its ok to have the three of them as dependencies (as there is no conflict to apply all of them).


---

Comment by jpflori created at 2012-04-17 11:25:42

Apart from my above remark, everything is fine on my install of beta13 plus #715, #11521, #12313, #11943 and this ticket.

The modified test is ok too.

From my point of view #715 (with #11521) and #12313 are needed to make the ticket here work, but the converse is not true.
And from a practical point of view, #11943 plus the ticket here can be applied before or after #715 and #12313 without conflicts.

So the dependencies look fine to me as they are now, I'm just adding #11521 because it now goes with #715.
I may also have missed something.

Rebasing everything to make all of that going the other way around seems to me to be a waste of time.


---

Comment by jpflori created at 2012-04-17 11:25:42

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2012-04-17 11:31:24

I've put the ticket back to positive review because I feel that #715 and #12313 will get positive review as well.


---

Comment by jdemeyer created at 2012-06-15 09:07:04

Unfortunalely, this regularly (not always but quite often) gives Segmentation Faults in `sage/schemes/elliptic_curves/gal_reps.py` _after_ the file has been tested:

```
$ ./sage -t --verbose "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
[...]
4 items had no tests:
    __main__
    __main__.change_warning_output
    __main__.check_with_tolerance
    __main__.warning_function
25 items passed all tests:
  26 tests in __main__.example_0
[...]
  10 tests in __main__.example_9
263 tests in 29 items.
263 passed and 0 failed.
Test passed.
Segmentation fault
         [21.5 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t --verbose "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
Total time for all tests: 21.6 seconds
```


This is with sage-5.1.beta4 + #12357 (beta4 is not yet released, but essentially finished).


---

Comment by jdemeyer created at 2012-06-15 09:07:04

Changing status from positive_review to needs_work.


---

Comment by SimonKing created at 2013-01-18 13:13:02

Jeroen, does the segmentation fault persists, now that #715 seems fine due to Cython upgrade?

Anyway, I am now running make ptest with MALLOCK_CHECK_=3 on sage-5.6.rc0 debug version (#13864) plus #12215, #12313 and #12357.


---

Comment by SimonKing created at 2013-01-18 13:39:49

Patchbot, apply trac12357_internal_strong_groupoid_cache.patch attachment:trac12357_reviewer.patch


---

Comment by SimonKing created at 2013-01-18 13:39:49

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2013-01-18 15:49:48

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2013-01-18 15:49:48

I got one doctest error, which unfortunately shows that the patch does not solve the problem it was created for:

```
File "/home/simon/SAGE/debug/sage-5.6.rc0/devel/sage/sage/categories/groupoid.pyx", line 64:
    sage: n in map(id, gc.get_objects())
Expected:
    False
Got:
    True
```


Hence, some garbage that was supposed to get collected did not become collected. And there also seems to be a timeout in

```
sage -t -force_lib "devel/sage/doc/en/bordeaux_2008/birds_other.rst"
```



---

Comment by SimonKing created at 2013-01-18 15:54:33

In fact, the polynomial ring in the failing example does not become collected, even _without_ creating its groupoid. I thought that this would have been fixed in one of the dependencies?

```
sage: P = GF(151)['x','y'] 
sage: import gc
sage: m = id(P)
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
True
```



---

Comment by SimonKing created at 2013-01-18 16:03:02

Perhaps I should use a test that avoids polynomial rings, but uses a custom `UniqueRepresentation`. Namely, #12215 makes `UniqueRepresentation` collectable, and the patch from here makes the groupoid collectable as well, namely:

```
sage: class MyParent(UniqueRepresentation, Parent):
....:     pass
....: 
sage: P = MyParent()
sage: import gc
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
False
sage: n in map(id, gc.get_objects()) 
False
```


What do you think?

By the way, the timeout is no problem: I had closed my laptop during the tests. Hence, the tests were interrupted, but the time was running.


---

Comment by SimonKing created at 2013-01-18 16:05:36

PS: In unpatched sage-5.6.rc0, one would obtain

```
sage: P = Parent()
sage: import gc
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
```

And this is even _without_ using a cache for P!!

Hence, the tests does demonstrate that some leak was fixed.


---

Comment by SimonKing created at 2013-01-18 17:07:25

Apart from changing the test, I'd like to change something more. Namely, it is stated that `UniqueRepresentation` is using cached_function - but that is wrong by #12215, which is a dependency of this ticket.

The main idea of storing the groupoid of P as an attribute of P is to avoid creating an external strong reference on the groupoid. But that would not be the case, when using a weak_cached_function for caching.

Hence, it could actually be that #12215 already fixes what is attempted here! I'll test that.


---

Comment by SimonKing created at 2013-01-18 17:12:52

Changing status from needs_work to positive_review.


---

Comment by SimonKing created at 2013-01-18 17:12:52

Indeed. With just #12215 and #12313 on top of sage-5.6.rc0, one obtains:

```
sage: P = Parent()
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: import gc
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
False
sage: n in map(id, gc.get_objects()) 
False
```

Hence, I suggest to resolve this as a duplicate. Jean-Pierre, please change if you disagree.


---

Comment by jdemeyer created at 2013-02-28 11:02:28

Resolution: duplicate
