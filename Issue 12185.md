# Issue 12185: Make groupoids garbage collectable

archive/issues_012185.json:
```json
{
    "body": "Assignee: @rlmill\n\nCC:  @nthiery jpflori\n\nCurrently, the groupoid of an object P can not be garbage collected, even when deleting P.\n\nEven worse: The persistence of `Groupoid(P)` also prevents P from being garbage collected.\n\nThe attached patch aims at solving it: An external reference to either P or `Groupoid(P)` is enough to keep both alive. But without an external reference, both P and `Groupoid(P)` become collectable.\n\nExample from the docs:\n\n```\n            sage: P = GF(151)['x','y']\n            sage: n = id(Groupoid(P))\n            sage: import gc\n            sage: _ = gc.collect()\n            sage: n == id(Groupoid(P))   # indirect doctest\n            True\n\n        Thus, the groupoid is cached. But when deleting ``P``, its\n        groupoid can be garbage collected as well::\n\n            sage: del P\n            sage: _ = gc.collect()\n            sage: P = GF(151)['x','y']\n            sage: n == id(Groupoid(P))\n            False\n\n        TESTS:\n\n        We test against some corner cases::\n\n            sage: Groupoid(None)\n            Traceback (most recent call last):\n            ...\n            TypeError: Groupoid of None is not defined\n            sage: Groupoid(1)\n            Traceback (most recent call last):\n            ...\n            TypeError: 1 must either allow attribute assignment or be instances of <type 'sage.structure.parent.Parent'>\n            sage: class A: pass\n            sage: a = A()\n            sage: Groupoid(a)\n            Groupoid with underlying set <__main__.A instance at ...>\n            sage: Groupoid(a) is Groupoid(a)\n            True\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12357\n\n",
    "created_at": "2012-01-25T12:30:11Z",
    "labels": [
        "component: memleak",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Make groupoids garbage collectable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12185",
    "user": "https://github.com/simon-king-jena"
}
```
Assignee: @rlmill

CC:  @nthiery jpflori

Currently, the groupoid of an object P can not be garbage collected, even when deleting P.

Even worse: The persistence of `Groupoid(P)` also prevents P from being garbage collected.

The attached patch aims at solving it: An external reference to either P or `Groupoid(P)` is enough to keep both alive. But without an external reference, both P and `Groupoid(P)` become collectable.

Example from the docs:

```
            sage: P = GF(151)['x','y']
            sage: n = id(Groupoid(P))
            sage: import gc
            sage: _ = gc.collect()
            sage: n == id(Groupoid(P))   # indirect doctest
            True

        Thus, the groupoid is cached. But when deleting ``P``, its
        groupoid can be garbage collected as well::

            sage: del P
            sage: _ = gc.collect()
            sage: P = GF(151)['x','y']
            sage: n == id(Groupoid(P))
            False

        TESTS:

        We test against some corner cases::

            sage: Groupoid(None)
            Traceback (most recent call last):
            ...
            TypeError: Groupoid of None is not defined
            sage: Groupoid(1)
            Traceback (most recent call last):
            ...
            TypeError: 1 must either allow attribute assignment or be instances of <type 'sage.structure.parent.Parent'>
            sage: class A: pass
            sage: a = A()
            sage: Groupoid(a)
            Groupoid with underlying set <__main__.A instance at ...>
            sage: Groupoid(a) is Groupoid(a)
            True
```


Issue created by migration from https://trac.sagemath.org/ticket/12357





---

archive/issue_comments_141726.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-25T12:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141726",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_141727.json:
```json
{
    "body": "I did not run the full test suite yet. It could be that some silly old doctests use the groupoids in a way they are not intended, such as `Groupoid(1)`. If this is the case, then my patch has to change. Otherwise: Needs review!",
    "created_at": "2012-01-25T12:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141727",
    "user": "https://github.com/simon-king-jena"
}
```

I did not run the full test suite yet. It could be that some silly old doctests use the groupoids in a way they are not intended, such as `Groupoid(1)`. If this is the case, then my patch has to change. Otherwise: Needs review!



---

archive/issue_comments_141728.json:
```json
{
    "body": "To my surprise, there were no nasty old doctests. Hence, `make ptest` went well, with the patch from here and its dependencies!",
    "created_at": "2012-01-25T19:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141728",
    "user": "https://github.com/simon-king-jena"
}
```

To my surprise, there were no nasty old doctests. Hence, `make ptest` went well, with the patch from here and its dependencies!



---

archive/issue_comments_141729.json:
```json
{
    "body": "Concerning timings:\n\nWithout the patch, the groupoid of P is stored in a dictionary, indexed by P. Hence, access to the cache is slow if `hash(P)` is slow.\n\nSome data points:\n\n```\nsage: P = GF(151)['x','y']\nsage: %timeit G = Groupoid(P)  # slow hash\n625 loops, best of 3: 20.9 \u00b5s per loop\nsage: %timeit G = Groupoid(ZZ) # fast hash\n625 loops, best of 3: 1.75 \u00b5s per loop\nsage: class Bar(Parent): pass\n....: \nsage: P = Bar()\nsage: %timeit G = Groupoid(P)  # slow hash\n625 loops, best of 3: 15.3 \u00b5s per loop\n```\n\n\nBut with the patch, it is stored as an attribute of P. Hence, it is slow if attribute access is slow. The point is that even slow attribute access is faster than slow hash, and slow attribute access is only little slower than fast hash:\n\n```\nsage: P = GF(151)['x','y']\nsage: %timeit G = Groupoid(P)  # slow attribute access\n625 loops, best of 3: 3.11 \u00b5s per loop\nsage: %timeit G = Groupoid(ZZ) # slow attribute access\n625 loops, best of 3: 3.1 \u00b5s per loop\nsage: class Bar(Parent): pass\n....: \nsage: P = Bar()\nsage: %timeit G = Groupoid(P)  # fast attribute access\n625 loops, best of 3: 1.59 \u00b5s per loop\n```\n\n\nHence, I believe that the patch is not only fixing a memory leak, but has the potential to generate a speed-up.",
    "created_at": "2012-01-25T20:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141729",
    "user": "https://github.com/simon-king-jena"
}
```

Concerning timings:

Without the patch, the groupoid of P is stored in a dictionary, indexed by P. Hence, access to the cache is slow if `hash(P)` is slow.

Some data points:

```
sage: P = GF(151)['x','y']
sage: %timeit G = Groupoid(P)  # slow hash
625 loops, best of 3: 20.9 µs per loop
sage: %timeit G = Groupoid(ZZ) # fast hash
625 loops, best of 3: 1.75 µs per loop
sage: class Bar(Parent): pass
....: 
sage: P = Bar()
sage: %timeit G = Groupoid(P)  # slow hash
625 loops, best of 3: 15.3 µs per loop
```


But with the patch, it is stored as an attribute of P. Hence, it is slow if attribute access is slow. The point is that even slow attribute access is faster than slow hash, and slow attribute access is only little slower than fast hash:

```
sage: P = GF(151)['x','y']
sage: %timeit G = Groupoid(P)  # slow attribute access
625 loops, best of 3: 3.11 µs per loop
sage: %timeit G = Groupoid(ZZ) # slow attribute access
625 loops, best of 3: 3.1 µs per loop
sage: class Bar(Parent): pass
....: 
sage: P = Bar()
sage: %timeit G = Groupoid(P)  # fast attribute access
625 loops, best of 3: 1.59 µs per loop
```


Hence, I believe that the patch is not only fixing a memory leak, but has the potential to generate a speed-up.



---

archive/issue_comments_141730.json:
```json
{
    "body": "Changing keywords from \"\" to \"groupoid cache Cernay2012\".",
    "created_at": "2012-02-08T17:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141730",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing keywords from "" to "groupoid cache Cernay2012".



---

archive/issue_comments_141731.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2012-02-08T17:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141731",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_141732.json:
```json
{
    "body": "This is the simplest patch of the cache problems suite, and it does not depend on !#715, so I begin with this one.\n\nI'm a little bit confused by all those tests for None in your patch.\n\nIsn't the first one sufficient?\n\nMore specifically, the second test \"if S is not None\" isn't superfluous ?\n\nAnd if it is not None, can G be None ? (I guess there is some cython voodoo involved here)\n\nTo answer my own question, I guess it is none if S is not a Parent (as in your example with 1).\n\nOnce you answer me back, I'll post a reviewer patch with some additional minor corrections.",
    "created_at": "2012-02-08T17:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141732",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

This is the simplest patch of the cache problems suite, and it does not depend on !#715, so I begin with this one.

I'm a little bit confused by all those tests for None in your patch.

Isn't the first one sufficient?

More specifically, the second test "if S is not None" isn't superfluous ?

And if it is not None, can G be None ? (I guess there is some cython voodoo involved here)

To answer my own question, I guess it is none if S is not a Parent (as in your example with 1).

Once you answer me back, I'll post a reviewer patch with some additional minor corrections.



---

archive/issue_comments_141733.json:
```json
{
    "body": "Yes, the test \"if S is not None\" in line 103 seems redundant, as S being None would result in an error being raised in line 92.\n\nConcerning Cython voodoo: If S is not None and not of type Parent, then `G == S` in line 106 would result in a type error (since G is cdefined) - which is desired behaviour. But if S were None, then `G == S` in line 106 would not complain, and then line 109 would segfault. This is why there must be a test for the corner case - of course, one test would be enough.",
    "created_at": "2012-02-08T18:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141733",
    "user": "https://github.com/simon-king-jena"
}
```

Yes, the test "if S is not None" in line 103 seems redundant, as S being None would result in an error being raised in line 92.

Concerning Cython voodoo: If S is not None and not of type Parent, then `G == S` in line 106 would result in a type error (since G is cdefined) - which is desired behaviour. But if S were None, then `G == S` in line 106 would not complain, and then line 109 would segfault. This is why there must be a test for the corner case - of course, one test would be enough.



---

archive/issue_comments_141734.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-02-08T18:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141734",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_141735.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-10T12:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141735",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141736.json:
```json
{
    "body": "Ok, I've posted a reviewer patch removing the second test and adding some comments on the code.\n\nEverything is fine for me (as long as further modification in #715 and #12313 do not affect the ticket here).\n\nSo I'll put is as positive review now.",
    "created_at": "2012-02-10T12:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141736",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, I've posted a reviewer patch removing the second test and adding some comments on the code.

Everything is fine for me (as long as further modification in #715 and #12313 do not affect the ticket here).

So I'll put is as positive review now.



---

archive/issue_comments_141737.json:
```json
{
    "body": "Reviewer patch",
    "created_at": "2012-02-10T12:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141737",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Reviewer patch



---

archive/issue_comments_141738.json:
```json
{
    "body": "Attachment [trac12357_reviewer.patch](tarball://root/attachments/some-uuid/ticket12357/trac12357_reviewer.patch) by @simon-king-jena created at 2012-02-10 16:40:30\n\nThe reviewer patch looks fine to me. Thank you!",
    "created_at": "2012-02-10T16:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141738",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac12357_reviewer.patch](tarball://root/attachments/some-uuid/ticket12357/trac12357_reviewer.patch) by @simon-king-jena created at 2012-02-10 16:40:30

The reviewer patch looks fine to me. Thank you!



---

archive/issue_comments_141739.json:
```json
{
    "body": "Moving this to sage-pending for now since it depends on two non-positively reviewed tickets.",
    "created_at": "2012-02-12T12:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141739",
    "user": "https://github.com/jdemeyer"
}
```

Moving this to sage-pending for now since it depends on two non-positively reviewed tickets.



---

archive/issue_comments_141740.json:
```json
{
    "body": "There is a conflict with #11943.\n\n- The ticket here is pending anyway\n- #11943 has only one dependency, that is already merged\n- #11943 is more fundamental than the patch here.\n\nTherefore, I suggest to rebase my patch with respect to #11943.",
    "created_at": "2012-03-09T16:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141740",
    "user": "https://github.com/simon-king-jena"
}
```

There is a conflict with #11943.

- The ticket here is pending anyway
- #11943 has only one dependency, that is already merged
- #11943 is more fundamental than the patch here.

Therefore, I suggest to rebase my patch with respect to #11943.



---

archive/issue_comments_141741.json:
```json
{
    "body": "Done!\n\nApply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch",
    "created_at": "2012-03-09T16:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141741",
    "user": "https://github.com/simon-king-jena"
}
```

Done!

Apply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch



---

archive/issue_comments_141742.json:
```json
{
    "body": "Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.\n\nShould one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?",
    "created_at": "2012-04-15T13:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141742",
    "user": "https://github.com/simon-king-jena"
}
```

Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.

Should one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?



---

archive/issue_comments_141743.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-04-15T13:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141743",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_141744.json:
```json
{
    "body": "Attachment [trac12357_internal_strong_groupoid_cache.patch](tarball://root/attachments/some-uuid/ticket12357/trac12357_internal_strong_groupoid_cache.patch) by @simon-king-jena created at 2012-04-15 15:11:06\n\nMake groupoids garbage collectable, but still use a cache by strong references. Relative #11943",
    "created_at": "2012-04-15T15:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141744",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac12357_internal_strong_groupoid_cache.patch](tarball://root/attachments/some-uuid/ticket12357/trac12357_internal_strong_groupoid_cache.patch) by @simon-king-jena created at 2012-04-15 15:11:06

Make groupoids garbage collectable, but still use a cache by strong references. Relative #11943



---

archive/issue_comments_141745.json:
```json
{
    "body": "I had a test that works like \"Create an object and store its memory address; delete it, do garbage collection, create the object again and show that the memory address is different from the old\".\n\nOf course, that is very fragile. By chance, when applying a totally unrelated ticket, the test breaks for me.\n\nTherefore I made a change in the first patch. The test now verifies that the stored memory address does not occur among the memory addresses of uncollectable objects, after garbage collection.\n\nI did not change the dependencies, yet. But perhaps the reviewer has an opinion on that matter?\n\nApply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch",
    "created_at": "2012-04-15T15:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141745",
    "user": "https://github.com/simon-king-jena"
}
```

I had a test that works like "Create an object and store its memory address; delete it, do garbage collection, create the object again and show that the memory address is different from the old".

Of course, that is very fragile. By chance, when applying a totally unrelated ticket, the test breaks for me.

Therefore I made a change in the first patch. The test now verifies that the stored memory address does not occur among the memory addresses of uncollectable objects, after garbage collection.

I did not change the dependencies, yet. But perhaps the reviewer has an opinion on that matter?

Apply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch



---

archive/issue_comments_141746.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-15T15:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141746",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141747.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n> Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.\nYou're right.\n> \n> Should one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?\n\nThe correct behavior here depends on the application of the three previous tickets, am I right ?\nSo I think its ok to have the three of them as dependencies (as there is no conflict to apply all of them).",
    "created_at": "2012-04-17T09:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141747",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:12 SimonKing]:
> Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.
You're right.
> 
> Should one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?

The correct behavior here depends on the application of the three previous tickets, am I right ?
So I think its ok to have the three of them as dependencies (as there is no conflict to apply all of them).



---

archive/issue_comments_141748.json:
```json
{
    "body": "Apart from my above remark, everything is fine on my install of beta13 plus #715, #11521, #12313, #11943 and this ticket.\n\nThe modified test is ok too.\n\nFrom my point of view #715 (with #11521) and #12313 are needed to make the ticket here work, but the converse is not true.\nAnd from a practical point of view, #11943 plus the ticket here can be applied before or after #715 and #12313 without conflicts.\n\nSo the dependencies look fine to me as they are now, I'm just adding #11521 because it now goes with #715.\nI may also have missed something.\n\nRebasing everything to make all of that going the other way around seems to me to be a waste of time.",
    "created_at": "2012-04-17T11:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141748",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Apart from my above remark, everything is fine on my install of beta13 plus #715, #11521, #12313, #11943 and this ticket.

The modified test is ok too.

From my point of view #715 (with #11521) and #12313 are needed to make the ticket here work, but the converse is not true.
And from a practical point of view, #11943 plus the ticket here can be applied before or after #715 and #12313 without conflicts.

So the dependencies look fine to me as they are now, I'm just adding #11521 because it now goes with #715.
I may also have missed something.

Rebasing everything to make all of that going the other way around seems to me to be a waste of time.



---

archive/issue_comments_141749.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-17T11:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141749",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141750.json:
```json
{
    "body": "I've put the ticket back to positive review because I feel that #715 and #12313 will get positive review as well.",
    "created_at": "2012-04-17T11:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141750",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've put the ticket back to positive review because I feel that #715 and #12313 will get positive review as well.



---

archive/issue_comments_141751.json:
```json
{
    "body": "Unfortunalely, this regularly (not always but quite often) gives Segmentation Faults in `sage/schemes/elliptic_curves/gal_reps.py` *after* the file has been tested:\n\n```\n$ ./sage -t --verbose \"devel/sage/sage/schemes/elliptic_curves/gal_reps.py\"\n[...]\n4 items had no tests:\n    __main__\n    __main__.change_warning_output\n    __main__.check_with_tolerance\n    __main__.warning_function\n25 items passed all tests:\n  26 tests in __main__.example_0\n[...]\n  10 tests in __main__.example_9\n263 tests in 29 items.\n263 passed and 0 failed.\nTest passed.\nSegmentation fault\n         [21.5 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t --verbose \"devel/sage/sage/schemes/elliptic_curves/gal_reps.py\"\nTotal time for all tests: 21.6 seconds\n```\n\n\nThis is with sage-5.1.beta4 + #12357 (beta4 is not yet released, but essentially finished).",
    "created_at": "2012-06-15T09:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141751",
    "user": "https://github.com/jdemeyer"
}
```

Unfortunalely, this regularly (not always but quite often) gives Segmentation Faults in `sage/schemes/elliptic_curves/gal_reps.py` *after* the file has been tested:

```
$ ./sage -t --verbose "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
[...]
4 items had no tests:
    __main__
    __main__.change_warning_output
    __main__.check_with_tolerance
    __main__.warning_function
25 items passed all tests:
  26 tests in __main__.example_0
[...]
  10 tests in __main__.example_9
263 tests in 29 items.
263 passed and 0 failed.
Test passed.
Segmentation fault
         [21.5 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t --verbose "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
Total time for all tests: 21.6 seconds
```


This is with sage-5.1.beta4 + #12357 (beta4 is not yet released, but essentially finished).



---

archive/issue_comments_141752.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-06-15T09:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141752",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_141753.json:
```json
{
    "body": "Jeroen, does the segmentation fault persists, now that #715 seems fine due to Cython upgrade?\n\nAnyway, I am now running make ptest with MALLOCK_CHECK_=3 on sage-5.6.rc0 debug version (#13864) plus #12215, #12313 and #12357.",
    "created_at": "2013-01-18T13:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141753",
    "user": "https://github.com/simon-king-jena"
}
```

Jeroen, does the segmentation fault persists, now that #715 seems fine due to Cython upgrade?

Anyway, I am now running make ptest with MALLOCK_CHECK_=3 on sage-5.6.rc0 debug version (#13864) plus #12215, #12313 and #12357.



---

archive/issue_comments_141754.json:
```json
{
    "body": "Patchbot, apply trac12357_internal_strong_groupoid_cache.patch attachment:trac12357_reviewer.patch",
    "created_at": "2013-01-18T13:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141754",
    "user": "https://github.com/simon-king-jena"
}
```

Patchbot, apply trac12357_internal_strong_groupoid_cache.patch attachment:trac12357_reviewer.patch



---

archive/issue_comments_141755.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-18T13:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141755",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141756.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-18T15:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141756",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141757.json:
```json
{
    "body": "I got one doctest error, which unfortunately shows that the patch does not solve the problem it was created for:\n\n```\nFile \"/home/simon/SAGE/debug/sage-5.6.rc0/devel/sage/sage/categories/groupoid.pyx\", line 64:\n    sage: n in map(id, gc.get_objects())\nExpected:\n    False\nGot:\n    True\n```\n\n\nHence, some garbage that was supposed to get collected did not become collected. And there also seems to be a timeout in\n\n```\nsage -t -force_lib \"devel/sage/doc/en/bordeaux_2008/birds_other.rst\"\n```\n",
    "created_at": "2013-01-18T15:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141757",
    "user": "https://github.com/simon-king-jena"
}
```

I got one doctest error, which unfortunately shows that the patch does not solve the problem it was created for:

```
File "/home/simon/SAGE/debug/sage-5.6.rc0/devel/sage/sage/categories/groupoid.pyx", line 64:
    sage: n in map(id, gc.get_objects())
Expected:
    False
Got:
    True
```


Hence, some garbage that was supposed to get collected did not become collected. And there also seems to be a timeout in

```
sage -t -force_lib "devel/sage/doc/en/bordeaux_2008/birds_other.rst"
```




---

archive/issue_comments_141758.json:
```json
{
    "body": "In fact, the polynomial ring in the failing example does not become collected, even *without* creating its groupoid. I thought that this would have been fixed in one of the dependencies?\n\n```\nsage: P = GF(151)['x','y'] \nsage: import gc\nsage: m = id(P)\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nTrue\n```\n",
    "created_at": "2013-01-18T15:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141758",
    "user": "https://github.com/simon-king-jena"
}
```

In fact, the polynomial ring in the failing example does not become collected, even *without* creating its groupoid. I thought that this would have been fixed in one of the dependencies?

```
sage: P = GF(151)['x','y'] 
sage: import gc
sage: m = id(P)
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
True
```




---

archive/issue_comments_141759.json:
```json
{
    "body": "Perhaps I should use a test that avoids polynomial rings, but uses a custom `UniqueRepresentation`. Namely, #12215 makes `UniqueRepresentation` collectable, and the patch from here makes the groupoid collectable as well, namely:\n\n```\nsage: class MyParent(UniqueRepresentation, Parent):\n....:     pass\n....: \nsage: P = MyParent()\nsage: import gc\nsage: m = id(P)\nsage: n = id(Groupoid(P)) \nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nFalse\nsage: n in map(id, gc.get_objects()) \nFalse\n```\n\n\nWhat do you think?\n\nBy the way, the timeout is no problem: I had closed my laptop during the tests. Hence, the tests were interrupted, but the time was running.",
    "created_at": "2013-01-18T16:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141759",
    "user": "https://github.com/simon-king-jena"
}
```

Perhaps I should use a test that avoids polynomial rings, but uses a custom `UniqueRepresentation`. Namely, #12215 makes `UniqueRepresentation` collectable, and the patch from here makes the groupoid collectable as well, namely:

```
sage: class MyParent(UniqueRepresentation, Parent):
....:     pass
....: 
sage: P = MyParent()
sage: import gc
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
False
sage: n in map(id, gc.get_objects()) 
False
```


What do you think?

By the way, the timeout is no problem: I had closed my laptop during the tests. Hence, the tests were interrupted, but the time was running.



---

archive/issue_comments_141760.json:
```json
{
    "body": "PS: In unpatched sage-5.6.rc0, one would obtain\n\n```\nsage: P = Parent()\nsage: import gc\nsage: m = id(P)\nsage: n = id(Groupoid(P)) \nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\n```\n\nAnd this is even *without* using a cache for P!!\n\nHence, the tests does demonstrate that some leak was fixed.",
    "created_at": "2013-01-18T16:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141760",
    "user": "https://github.com/simon-king-jena"
}
```

PS: In unpatched sage-5.6.rc0, one would obtain

```
sage: P = Parent()
sage: import gc
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
```

And this is even *without* using a cache for P!!

Hence, the tests does demonstrate that some leak was fixed.



---

archive/issue_comments_141761.json:
```json
{
    "body": "Apart from changing the test, I'd like to change something more. Namely, it is stated that `UniqueRepresentation` is using cached_function - but that is wrong by #12215, which is a dependency of this ticket.\n\nThe main idea of storing the groupoid of P as an attribute of P is to avoid creating an external strong reference on the groupoid. But that would not be the case, when using a weak_cached_function for caching.\n\nHence, it could actually be that #12215 already fixes what is attempted here! I'll test that.",
    "created_at": "2013-01-18T17:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141761",
    "user": "https://github.com/simon-king-jena"
}
```

Apart from changing the test, I'd like to change something more. Namely, it is stated that `UniqueRepresentation` is using cached_function - but that is wrong by #12215, which is a dependency of this ticket.

The main idea of storing the groupoid of P as an attribute of P is to avoid creating an external strong reference on the groupoid. But that would not be the case, when using a weak_cached_function for caching.

Hence, it could actually be that #12215 already fixes what is attempted here! I'll test that.



---

archive/issue_comments_141762.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-01-18T17:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141762",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_141763.json:
```json
{
    "body": "Indeed. With just #12215 and #12313 on top of sage-5.6.rc0, one obtains:\n\n```\nsage: P = Parent()\nsage: m = id(P)\nsage: n = id(Groupoid(P)) \nsage: import gc\nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nFalse\nsage: n in map(id, gc.get_objects()) \nFalse\n```\n\nHence, I suggest to resolve this as a duplicate. Jean-Pierre, please change if you disagree.",
    "created_at": "2013-01-18T17:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141763",
    "user": "https://github.com/simon-king-jena"
}
```

Indeed. With just #12215 and #12313 on top of sage-5.6.rc0, one obtains:

```
sage: P = Parent()
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: import gc
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
False
sage: n in map(id, gc.get_objects()) 
False
```

Hence, I suggest to resolve this as a duplicate. Jean-Pierre, please change if you disagree.



---

archive/issue_events_012200.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:02:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12185#event-12200"
}
```



---

archive/issue_comments_141764.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2013-02-28T11:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12185#issuecomment-141764",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate
