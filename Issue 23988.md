# Issue 23988: py3: check for long before check for int in some pyx files

Issue created by migration from https://trac.sagemath.org/ticket/24225

Original creator: chapoton

Original creation time: 2017-11-16 13:17:34

CC:  embray jdemeyer tscrim fbissey

as in #24221


---

Comment by chapoton created at 2017-11-16 13:18:00

Changing status from new to needs_review.


---

Comment by git created at 2017-11-16 13:18:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-11-16 13:25:14

Syntax error in `src/sage/libs/mpmath/ext_impl.pyx`


---

Comment by jdemeyer created at 2017-11-16 13:27:28

The `int()` call in `plural.pyx` requires further thought. Can you revert that for now?


---

Comment by jdemeyer created at 2017-11-16 13:37:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-11-16 13:40:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-11-16 13:41:14

Done, thanks.


---

Comment by chapoton created at 2017-11-16 13:41:14

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-16 13:43:22

Good for me if the (Python 2) patchbot passes.


---

Comment by embray created at 2017-11-16 15:40:34

Ah, I just fixed a bunch of these myself :)  Glad I don't have to make a ticket for it now.

I might add a comment, at least a few of these cases, making it clear that the `isinstance(..., int)` case should _never_ run on Python 3, since this is somewhat non-obvious, at least to me.


---

Comment by embray created at 2017-11-16 15:42:28

Spoke too soon.  Here's a couple more if you want to add them to this ticket; otherwise I can open a new one...


```diff
diff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx
index 7e86b95..ff186cc 100644
--- a/src/sage/rings/integer.pyx
+++ b/src/sage/rings/integer.pyx
@@ -926,13 +929,14 @@ cdef class Integer(sage.structure.element.EuclideanDomainEleme
             c = mpz_cmp((<Integer>left).value, (<Integer>right).value)
         elif isinstance(right, Rational):
             c = -mpq_cmp_z((<Rational>right).value, (<Integer>left).value)
-        elif isinstance(right, int):
-            c = mpz_cmp_si((<Integer>left).value, PyInt_AS_LONG(right))
         elif isinstance(right, long):
             mpz_init(mpz_tmp)
             mpz_set_pylong(mpz_tmp, right)
             c = mpz_cmp((<Integer>left).value, mpz_tmp)
             mpz_clear(mpz_tmp)
+        elif isinstance(right, int):
+            # This case should only occur on Python 2
+            c = mpz_cmp_si((<Integer>left).value, PyInt_AS_LONG(right))
         elif isinstance(right, float):
             d = right
             if isnan(d):
@@ -3115,6 +3119,11 @@ cdef class Integer(sage.structure.element.EuclideanDomainElem
         cdef Integer z
         cdef long yy, res

+        if isinstance(y, long):
+            # This should be treated basically the same as if y is an Integer
+            # so go ahead and convert y to an Integer first
+            y = Integer(y)
+
         # First case: Integer % Integer
         if type(x) is type(y):
             if not mpz_sgn((<Integer>y).value):
```


Edit: Originally a few of these diffs were the same as in #24221, but I think the ones here now are still new...


---

Comment by chapoton created at 2017-11-16 15:47:51

Those are done in #24221

oh, I missed your edit..


---

Comment by chapoton created at 2017-11-16 15:48:47

maybe we should rather add them to #24221 to minimize conflicts


---

Comment by chapoton created at 2017-11-16 16:12:28

I have added your additional changes to #24221, that is back to "needs review"


---

Comment by chapoton created at 2017-11-16 16:33:16

green bot here


---

Comment by jdemeyer created at 2017-11-16 16:41:09

Replying to [comment:13 chapoton]:
> I have added your additional changes to #24221

Moved that to #24227 instead.


---

Comment by jdemeyer created at 2017-11-16 18:38:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-11 01:02:14

Resolution: fixed
