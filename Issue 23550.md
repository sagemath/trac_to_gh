# Issue 23550: py3: richcmp for ideals

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-09-05 19:28:55

CC:  jdemeyer tscrim jhpalmieri

as another small step towards py3


---

Comment by chapoton created at 2017-09-05 19:29:35

some doctests are failing, needs to be investigated
----
New commits:


---

Comment by chapoton created at 2017-09-05 19:29:35

Changing status from new to needs_info.


---

Comment by jdemeyer created at 2017-09-06 07:58:48

Typically, one would replace `__cmp__` by `__richcmp__`, not `_richcmp_`.


---

Comment by chapoton created at 2017-09-06 08:02:47

This is work in progress.. But one has

```
class Ideal_generic(MonoidElement)
```

so every ideal is an "Element"...


---

Comment by tscrim created at 2017-09-07 05:49:03

It looks like all of the failures are related to the ordering of the ideals. You have introduced at least one behavior change: Principal ideals used to be considered as smaller as non-principal ideals, but now that no longer holds on your branch. So this should fix the test failure in `rings/ideal.py`. I suspect the others are coming from your changes in `rings/number_field/number_field_ideal.py`.


---

Comment by tscrim created at 2017-09-07 05:53:54

PS, this will conflict with changes on #22982. However, I suspect this will be ready first.


---

Comment by chapoton created at 2017-09-07 08:33:20

I suspect that this ticket here will be **hard** to fix. If it was easy, this would not be my third or 4th failing tentative to solve the issue.


---

Comment by git created at 2017-09-12 19:58:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-18 13:43:00

Changing status from needs_info to needs_work.


---

Comment by chapoton created at 2017-09-22 06:18:31

This is now the last set of places where cmp is used.


---

Comment by jdemeyer created at 2017-09-22 07:06:13

I think you need to decide whether you want `__richcmp__` or `_richcmp_` here. I understand why `_richcmp_` makes sense, but then you should also remove the various `isinstance()` checks that are still there.


---

Comment by jdemeyer created at 2017-09-22 07:07:17

In number field ideals, why add `.sage()` to the PARI instances?


---

Comment by chapoton created at 2017-09-22 07:17:12

Replying to [comment:11 jdemeyer]:
> In number field ideals, why add `.sage()` to the PARI instances?

Because the pari objects could not be compared. If you know a better solution, please go on.


---

Comment by chapoton created at 2017-09-22 11:48:03

Hmm. It seems that MPolynomialIdeal uses two different semantics for `__lt__` and `__gt___` (for inclusion) and `__cmp__`.


---

Comment by chapoton created at 2017-09-22 13:03:09

I have split-off #23920


---

Comment by git created at 2017-10-19 18:44:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-20 19:21:19

Jeroen, is there a way to change the following behaviour (cmp works but not richcmp on cypari Gen objects) ?

```
sage: from sage.structure.richcmp import *
sage: K.<a, b> = NumberField([x^2 + 23, x^2 - 7])
sage: I = K.ideal(2, (a + 2*b + 3)/2)
sage: J = K.ideal(2, a - b)
sage: richcmp(I.pari_rhnf(), J.pari_rhnf() , op_LE)
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-24-c3ae4cea545c> in <module>()
----> 1 richcmp(I.pari_rhnf(), J.pari_rhnf() , op_LE)

/home/chapoton/sage/src/sage/structure/richcmp.pyx in sage.structure.richcmp.richcmp (build/cythonized/sage/structure/richcmp.c:1361)()
    103         False
    104     """
--> 105     return PyObject_RichCompare(x, y, op)
    106 
    107 

cypari2/gen.pyx in cypari2.gen.Gen.__richcmp__()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()

PariError: forbidden comparison t_VEC (2 elts) , t_VEC (2 elts)
sage: cmp(I.pari_rhnf(), J.pari_rhnf())
-1
```



---

Comment by chapoton created at 2017-10-26 18:13:08

Jeroen, any idea for my previous question, please ?


---

Comment by chapoton created at 2017-10-30 16:25:17

This ticket (last call to cmp anywhere) seem to be stuck..

The current branch has only 4 very mild failing doctests, that I have failed to understand and fix.

Opinion required, please. Should I just fix the doctests, or should one try to match absolutely the existing behaviour ?


---

Comment by tscrim created at 2017-10-30 22:11:33

Replying to [comment:18 chapoton]:
> This ticket (last call to cmp anywhere) seem to be stuck..

Wow, that is amazing. Thank you for all your work so far. Now to get over this.

> The current branch has only 4 very mild failing doctests, that I have failed to understand and fix.

I will look into them today. Although I don't know anything about comment:16.

> Opinion required, please. Should I just fix the doctests, or should one try to match absolutely the existing behaviour ?

I think we should try to match the existing behavior, or at least understand why the changes are necessary. The tests that have a different order are not so big IMO, but the `I < J` and `J > I` test failing should be explained.


---

Comment by tscrim created at 2017-10-30 23:24:11

The change in the output for the `SUK = UnitGroup(K,S=21); SUK` test comes down to sorting in the `factorization` object.


---

Comment by tscrim created at 2017-10-30 23:35:17

The `cmp` calls `Gen.__cmp__` calls PARI's `cmp_universal`, which has no mathematical meaning [according to the docs](https://pari.math.u-bordeaux.fr/dochtml/html-stable/Standard_monadic_or_dyadic_operators.html). So converting back to Sage objects and doing the comparison is a much better comparison IMO. Subsequently that is a test we can simply update.


---

Comment by tscrim created at 2017-10-30 23:45:00

The test in `Ideal_principal._richcmp_` does not actually test that code:

```
sage: I.__class__.__mro__
(<class 'sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal'>,
 <class sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr at 0x7f98c6dbc668>,
 <class sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_base_repr at 0x7f98c6dbc600>,
 <class sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_macaulay2_repr at 0x7f98c6dbc6d0>,
 <class sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_magma_repr at 0x7f98c6dbc598>,
 <class 'sage.rings.ideal.Ideal_generic'>,
 <type 'sage.structure.element.MonoidElement'>,
 <type 'sage.structure.element.Element'>,
 <type 'sage.structure.sage_object.SageObject'>,
 <type 'object'>)
```

However, all the same, that is not the problem. Something very strange is going on:

```
sage: [richcmp(I.gens(), J.gens(), val) for val in range(6)]  # Defines the behavior
[False, False, False, True, True, True]
sage: [richcmp(I, J, val) for val in range(6)]  # What?
[True, True, False, True, False, False]
sage: [I._richcmp_(J, val) for val in range(6)]  # What!?!?!?
[False, False, False, True, True, True]
```



---

Comment by tscrim created at 2017-10-30 23:53:01

Oh, I know why. Just look at `I.__richcmp__`, which gives the multivariate comparison (using GrÃ¶bner bases) and never even sees this code path. So I am going to remove the `I > J` and `J < I` tests.


---

Comment by tscrim created at 2017-10-30 23:53:47

Correction, I am going to change the test to not use the multivariate code and actually test that code.


---

Comment by tscrim created at 2017-10-31 00:09:30

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-10-31 00:09:30

Okay, I fixed that and a bug along the way now that the code is actually being tested.

The remaining failure is the same as the other number field because it was using `cmp_universal`. So I just updated the output.

Needs review.
----
New commits:


---

Comment by chapoton created at 2017-10-31 14:20:53

Thanks a lot. The bot is morally green, so I am going to set this to positive review.


---

Comment by chapoton created at 2017-10-31 14:20:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-11-02 11:06:02

Resolution: fixed


---

Comment by jdemeyer created at 2017-12-08 14:53:22

Scrimsaw sounds cool though :-)
