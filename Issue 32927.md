# Issue 32927: fix broken caching in EllipticCurve_generic.division_polynomial()

Issue created by migration from https://trac.sagemath.org/ticket/33164

Original creator: lorenz

Original creation time: 2022-01-14 03:09:05

CC:  defeo cremona

This was discovered while digging for the underlying reason behind #33156:


```
sage: E = EllipticCurve('11a3')
sage: R.<X> = QQ[]
sage: S.<Y> = R.quotient(X^2)
sage: E.division_polynomial(5, x=Y)
-5*Y
sage: E.division_polynomial(5, x=X)
-5*Y
```


To fix it, we should probably include `x.parent()` in the cache key.


---

Comment by lorenz created at 2022-01-17 06:25:59

Changing priority from minor to major.


---

Comment by lorenz created at 2022-01-17 06:25:59

Changing status from new to needs_review.


---

Comment by lorenz created at 2022-01-17 06:25:59

New commits:


---

Comment by lorenz created at 2022-01-17 06:26:59

The changes in `Polynomial.__call__` are from the dependency.


---

Comment by git created at 2022-02-18 03:44:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-21 07:30:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-21 07:52:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-27 10:22:35

As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.

For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.


---

Comment by lorenz created at 2022-03-01 08:49:35

Thank you for looking at this.

Replying to [comment:7 tscrim]:
> As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.

Doesn't commit `ad9a380b80` (added after you pointed out the issue in #33165) take care of this?

Replying to [comment:7 tscrim]:
> For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.

So, if I understand this correctly, you'd like a keyword argument to override the (existing) `evaluate` flag?


---

Comment by tscrim created at 2022-03-01 08:56:36

Replying to [comment:8 lorenz]:
> Thank you for looking at this.
> 
> Replying to [comment:7 tscrim]:
> > As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.
> 
> Doesn't commit `ad9a380b80` (added after you pointed out the issue in #33165) take care of this?

Yes, sorry, I missed that commit.

> Replying to [comment:7 tscrim]:
> > For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.
> 
> So, if I understand this correctly, you'd like a keyword argument to override the (existing) `evaluate` flag?

Yes, that is correct. At least, I could see a few situations where this could be useful for just a few simple lines of code.


---

Comment by git created at 2022-03-01 12:09:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-01 12:12:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-03-01 12:13:11

Alright, added an optional argument to override the default.


---

Comment by tscrim created at 2022-03-02 00:23:34

Thank you. One last little detail. In `division_polynomial()`, have the docstring bullet points have the indentation as

```
- ``arg`` -- short description

  A long description in a separate paragraph.

- ``more`` -- another argument

  Another long description paragraph.
```

Right now, your subsequent paragraphs are also indented, which may not be the desired effect.


---

Comment by tscrim created at 2022-03-02 00:28:17

Also one pyflakes thing:

```
src/sage/schemes/elliptic_curves/ell_generic.py:62:1 'sage.misc.cachefunc.cached_function' imported but unused
```


Here's two more optional things:

Actually, it might make sense to `cpdef bint polynomial_is_variable()` with a (top-level) `cimport MPolynomial` (you don't need to worry about cyclic imports since it has a header file). Although this is a definite micro-optimization that might not be so useful.

I might also change this

```diff
-        return x.is_gen() \
-                or (x.degree() == 1 and x[0].is_zero() and x[1].is_one())
+        return (x.is_gen()
+                or (x.degree() == 1 and x[0].is_zero() and x[1].is_one()))
```



---

Comment by git created at 2022-03-02 03:17:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-03-02 03:19:54

Thanks, all done.


---

Comment by tscrim created at 2022-03-02 03:40:31

Thank you. Green bot => positive review.


---

Comment by tscrim created at 2022-03-02 07:02:55

Changing status from needs_review to positive_review.


---

Comment by lorenz created at 2022-03-02 07:19:31

Thank you!


---

Comment by vbraun created at 2022-03-03 23:13:57

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-03-03 23:13:57

Merge failure on top of:

c7adc6cc57 Trac #33112: some speedups in AdditiveAbelianGroupWrapper.discrete_log()

8230df5b38 Trac #32770: Expose and access `tachyon` command line flags

135c8e5bb1 Trac #31426: Apply flat shading when plotting 3d polyhedra with Three.js

32e26f275f Trac #24536: find_local_maximum/minimum() fails with expressions containing complex numbers

c0b15ffde0 Trac #33450: Improve vs code config

a76af34b81 Trac #33312: WeierstrassIsomorphism.degree() returns a Python int

8368718592 Trac #33094: update URLs in SPKG.rst for ECL

4f76f139db Trac #32922: Change parameter name

44b5d43de7 Trac #32384: make some AdditiveAbelianGroupWrapper methods visible

232f88fe88 Trac #32251: Fix doctest in the "Y pentamino" example from Donald Knuth

6adf64eec4 Trac #30999: expose method hyperbolicity in graphs

14e3e755d2 Trac #25787: Remove documentation configuration from micro_release

87d5c62133 Trac #33414: Remove sage-open

c254f33235 Trac #33413: Remove sage-native-execute

6dcb3dc676 Trac #33412: Remove sage-update-src

aeb3fb2594 Trac #33411: include time for checking doctest output in '--warn-long'

b20aeb7ee9 Trac #33322: Several ImageMagick tests need "long time"

db459d4eb3 Trac #33318: speed up is_prime() for very small integers

0df0bad12f Trac #33308: Remove expired deprecations that use lazy_import(MODULE, "*")

7c9535ef80 Trac #33292: mark invlex ordering as global

e6d8672713 Trac #33286: Put topology in the reference manual

6e45b9e469 Trac #33270: Difference between a formula and an image in Contour Plots

895ded3c44 Trac #33224: PARI-backed LaurentSeries truncates exact polynomials to default precision

eeda513423 Trac #33434: Fix pyflake in sage.graphs.graph

f45550a9d3 Trac #33424: pep8 for function field maps

9553cc37d8 Trac #33319: polynomial rings should not attempt to use Singular in characteristic >= 2^31

13d038fd9f Trac #33147: use PARI's ellmul() for elliptic curves over finite fields

0c85ad2f59 Trac #33433: Correct order of parameters in min_spanning_tree

8e935af159 Trac #33421: Add elliptic_curves dependency to sagemath_doc_html

111bcfa1f7 Trac #33216: reduce precision for .formal() in EllipticCurveIsogeny.dual()

195cf6ab4d Trac #33215: WeierstrassIsomorphism should coerce its inputs to a common parent

df9c2612a6 Trac #33210: Fix Cython warnings in sage.rings.polynomial.polynomial_modn_dense_ntl

ac61ea8b62 Trac #33208: Remove unused code from sage/rings/padics/pow_computer_ext.pyx

bc069a7cb2 Trac #33193: Fix Cython incompatible redefinition warnings in padics

8a21049265 Trac #33186: Fix "referenced before assignment" warnings in padics

490fdfded3 Trac #33055: conda-forge: Fix build of python3 spkg

beedaabc7e Trac #32997: docker image fails to build on tigerlake

28f2f9a48b Trac #32786: opportunistic caching of elliptic-curve and point orders

1ac2b995a4 Trac #12419: factorization of 0 in GF(p)[x,y] fails

9349a36d34 Trac #33429: some cleanup in toric schemes

df9d1d77aa Trac #33427: numerical noise in effective_resistance involving RDF

c6f2af1800 Trac #33425: adjust error messages in combinat/words

449c7f1d66 Trac #33423: Cancel the linter

b30c72fe86 Trac #33420: fix E111 (indentation) in quadratic_forms

cc8a39082b Trac #33419: fix E111 (indentation) in manifolds, stats, finance

6410a7cd86 Trac #33415: fix the linter

ec318c0d08 Trac #33410: Polyhedron_base.volume(engine='lrs', measure='induced')

b6fecc7464 Trac #33399: Bug in ExpressionNice with composite variables

6779f414bf Trac #33363: (Too) long doctest in sage/matrix/matrix_integer_dense.pyx

9e90afaba0 Trac #29215: valuation error

2a16069f4c Trac #29114: Only ./bootstrap should glob build/pkgs

062a90c9d1 Trac #33403: Polyhedron._test_product, _test_dilation: Skip tests if test prereqs cannot be imported

cc4ffb3fa1 Trac #33402: sage.geometry.polyhedron: More # optional

9333fa5dc3 Trac #33395: document using Wolfram Engine (a.k.a. wolframscript) with Sage

f346730807 Trac #33394: correct docs for running notebook on a specific port

1e8ba0aac4 Updated [SageMath](SageMath) version to 9.6.beta3



merge was not clean: conflicts in src/sage/schemes/elliptic_curves/ell_generic.py


---

Comment by git created at 2022-03-08 14:11:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-03-08 14:12:26

Changing status from needs_work to positive_review.


---

Comment by lorenz created at 2022-03-08 14:12:26

Trivial merge.


---

Comment by vbraun created at 2022-03-12 15:11:11

Resolution: fixed
