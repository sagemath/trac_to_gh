# Issue 18673: Boost minimum spanning tree

Issue created by migration from Trac.

Original creator: borassi

Original creation time: 2015-07-16 08:36:09

CC:  ncohen dcoudert stefan rudi




---

Comment by borassi created at 2015-07-16 08:39:09

Changing type from PLEASE CHANGE to enhancement.


---

Comment by borassi created at 2015-07-16 08:39:09

Changing keywords from "" to "Boost, minimum spanning tree".


---

Comment by borassi created at 2015-07-16 08:39:09

Changing component from PLEASE CHANGE to graph theory.


---

Comment by borassi created at 2015-07-19 16:34:01

Hello!

This is the first version of Boost minimum spanning tree. With this code, I'm inserting in Sage the code to interface with Boost weighted graphs. The improvement on this specific algorithm is not striking (about 2x over the old algorithm), but I still set the Boost algorithm as default.

Some benchmark:


```
sage: sage: def random_weighted_graph(n, m, lower_weight = 1, upper_weight = 100): 
        import random
        g = graphs.RandomGNM(n,m)
        m = g.num_edges()
        weights = [random.randint(lower_weight, upper_weight) for r in xrange(m)]
        uw_edges = g.edges()
        w_edges = [(uw_edges[i][0], uw_edges[i][1], weights[i]) for i in xrange(m)]
        return Graph(w_edges, weighted = True)
....: 
sage: g = random_weighted_graph(20000,200000)
sage: %timeit(g.min_spanning_tree(algorithm="Prim_Boost"))
1 loops, best of 3: 279 ms per loop
sage: %timeit(g.min_spanning_tree(algorithm="Kruskal_Boost"))
1 loops, best of 3: 361 ms per loop
sage: %timeit(g.min_spanning_tree(algorithm="Kruskal"))
1 loops, best of 3: 492 ms per loop
sage: %timeit(g.min_spanning_tree(algorithm="NetworkX"))
1 loops, best of 3: 1.92 s per loop
sage: %timeit(g.min_spanning_tree(algorithm="Prim_edge"))
1 loops, best of 3: 17.3 s per loop
sage: %timeit(g.min_spanning_tree(algorithm="Prim_fringe"))
1 loops, best of 3: 36.1 s per loop
```

Hope you like it!

Michele


---

Comment by borassi created at 2015-07-21 05:58:18

Changing status from new to needs_review.


---

Comment by dcoudert created at 2015-07-21 08:15:55

The weight function you use does not allow to access all possible stuff that might be stored on an edge. For instance, I may have an edge like `(u, v, {'weight':3, 'toto':4})` in which case a function like `weight_function=lambda e:e[2]['weight']` is possible. With current implementation, you assume that `weight_function((u,v))` returns the weight. Better to have `weight_function(e)` or `weight_function((u,v,l))`.

Also, could you be a bit more specific with the description of the weight function

```
- ``weight_function`` -- A function that takes an edge and returns a
          numeric weight. If ``None`` (default), the algorithm uses the edge
          weights, if available, otherwise it assigns weight 1 to each edge (in
          the latter case, the output can be any spanning tree).
```

In particular, the default behavior assume that edge weights are numbers, that is if `e=(u,v,l)` then `l` is a number.

David.


---

Comment by git created at 2015-07-21 13:40:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by borassi created at 2015-07-21 13:41:48

Hello!

you are absolutely right: I have made the modification you asked, I have improved the explanation of the weight function, and I have added an example in the generic_graph file.

Thank you very much!

Michele


---

Comment by dcoudert created at 2015-07-21 14:59:43

Hello,

I know that dealing with weights is not easy. However, here we have different behaviors.

```
sage: g = Graph([(0,1,{'blop':1}), (1,2,{'blop':'b'})])
sage: g.min_spanning_tree(algorithm="Prim_Boost", weight_function=lambda e:e[2]['blop'])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: a float is required
sage: g = Graph([(0,1,1), (1,2,'b')])
sage: g.min_spanning_tree(algorithm="Prim_Boost", weight_function=lambda e:e[2])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: a float is required
sage: g.min_spanning_tree(algorithm="Prim_Boost")
[(0, 1, 1), (1, 2, 'b')]
```


David.


---

Comment by borassi created at 2015-07-21 16:17:31

Hello!

Yeah, I have some problems, too: it is difficult to decide which is the correct behavior. In your examples, I have trouble understanding which improvement you are suggesting: could you be a bit more specific?

In particular, in the first two cases, you provide a weight function which is not correct, so a TypeError is raised (if you provide a function, the algorithm raises an error if it is not correct). In the third case, your graph is not weighted:


```
sage: g = Graph([(0,1,1), (1,2,'b')])
sage: g.weighted()
False
```

Hence, the algorithm simply says "Since the graph is not weighted, I ignore the label and set weight 1 to each edge".

Maybe a problem occurs if the graph is weighted and no function is provided: in this case, the algorithm tries to use labels even if they are not numbers. In Boost algorithms, non-numeric weights are assumed to be 1, while in other algorithms labels are simply compared, and Python decides which is the biggest.


```
sage: g = Graph([(0,1,1), (1,2,'b')], weighted=True)
sage: g.min_spanning_tree(algorithm="Prim_Boost")
[(0, 1, 1), (1, 2, 'b')]
sage: g.min_spanning_tree(algorithm="Prim_fringe")
[(0, 1, 1), (1, 2, 'b')]
sage: g.min_spanning_tree(algorithm="Prim_edge")
[(0, 1, 1), (1, 2, 'b')]
sage: g.min_spanning_tree(algorithm="Kruskal")
[(0, 1, 1), (1, 2, 'b')]
sage: g.min_spanning_tree(algorithm="Kruskal_Boost")
[(0, 1, 1), (1, 2, 'b')]
sage: g.min_spanning_tree(algorithm="NetworkX")
[(0, 1, 1), (1, 2, 'b')]
```

In the latter example, do you think I should only improve the explanation, which is in the INPUT section of the documentation and in the examples? Or do you think I should raise an exception if a weight is not a number?

Thank you very much!

Michele


---

Comment by dcoudert created at 2015-07-21 17:07:46

I think it's a weird behavior to assume that an edge like `(1, 2, 'b')` has weight 1. However, it was the original behavior of the method, so I propose to keep it unchanged.
So don't raise exception, but if you can improve further the doc, it should be ok.
Thanks.


---

Comment by git created at 2015-07-22 11:05:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by borassi created at 2015-07-22 11:07:00

Hello!

I have changed the behavior: now, if edge weights are not convertible to floats through `float()` function, an error is raised. I have tried to clarify this behavior as much as possible in the documentation.

Thank you very much!

Michele


---

Comment by dcoudert created at 2015-07-22 13:05:11

The documentation builds properly and is now good.

I tracked all calls to `min_spanning_tree` to launch tests. All tests pass in graphs and homology.
However, one test is broken in `src/sage/matroids/utilities.py`, method `lift_cross_ratios`. I suspect that this is due to the change in the output ordering of edges.
I don't know what to do here. I have forced you to sort edges because all methods where not returning edges in the same order, and I think it is better now (the output is independent on the algorithm). 

The set T constructed in this method is, before applying this patch:

```
set([((0, 0), (0, 1), (0, 0)), ((0, 0), (2, 1), (0, 2)), ((0, 1), (1, 0), (1, 0)), ((1, 0), (1, 1), (1, 1)), ((1, 1), (2, 0), (2, 1)), ((0, 0), (3, 1), (0, 3)), ((0, 0), (4, 1), (0, 4))])
```

and with this patch:

```
set([((0, 0), (0, 1), (0, 0)), ((0, 0), (2, 1), (0, 2)), ((0, 1), (1, 0), (1, 0)), ((1, 0), (1, 1), (1, 1)), ((2, 0), (2, 1), (2, 2)), ((0, 0), (3, 1), (0, 3)), ((0, 0), (4, 1), (0, 4))])
```

So only one entry differs: `((1, 1), (2, 0), (2, 1))` becomes `((2, 0), (2, 1), (2, 2))`.

I don't know if we can safely update the expected output of this test or not. Nathann?


---

Comment by ncohen created at 2015-07-22 14:28:55

Hello,

> I don't know if we can safely update the expected output of this test or not. Nathann?

Not sure. Possible, but not sure. The best is to ask the matroid guys. Stefan, Rudi? Does it look okay to you if by changing the behaviour of a graph spanning tree routine, the output of 

```
sage: Z = lift_cross_ratios(A, to_sixth_root_of_unity)
```


at line 416 of matroids/utilities.py changes like that?

```
Failed example:
    Z
Expected:
    [ 1  0  1  1  1]
    [ 1  1  0  0  z]
    [ 0  1 -z -1  0]
Got:
    [     1      0      1      1      1]
    [     1      1      0      0      z]
    [     0  z - 1      1 -z + 1      0]
```


It may be caused by a different spanning tree, or by a reordering of its edges.

Nathann


---

Comment by Rudi created at 2015-07-22 14:42:34

Replying to [comment:14 ncohen]:
> Stefan, Rudi? Does it look okay to you if by changing the behaviour of a graph spanning tree routine, the output of 
> {{{
> sage: Z = lift_cross_ratios(A, to_sixth_root_of_unity)
> }}}
> 
> at line 416 of matroids/utilities.py changes like that?
> {{{
> Failed example:
>     Z
> Expected:
>     [ 1  0  1  1  1]
>     [ 1  1  0  0  z]
>     [ 0  1 -z -1  0]
> Got:
>     [     1      0      1      1      1]
>     [     1      1      0      0      z]
>     [     0  z - 1      1 -z + 1      0]
> }}}
> 
> It may be caused by a different spanning tree, or by a reordering of its edges.

Yes, that looks OK. This output matrix Z is fixed up to scaling of rows and columns, and the tree is used to determine the scaling. Looks like in this example the bottom row is scaled by  z-1 (which happens to equal -z<sup>-1</sup> in that ring, z is is a sixth root of unity). 

So it's safe to just update the output of the test.


---

Comment by ncohen created at 2015-07-22 15:11:00

> Yes, that looks OK.

Great. Thanks for your answer `:-)`

Nathann


---

Comment by git created at 2015-07-22 15:24:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by borassi created at 2015-07-22 15:25:08

Done! Thank you very much, Rudi!


---

Comment by dcoudert created at 2015-07-22 15:51:42

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-07-22 15:51:42

Good!


---

Comment by git created at 2015-07-30 10:39:05

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2015-07-30 10:39:05

Changing status from positive_review to needs_review.


---

Comment by borassi created at 2015-07-30 10:39:59

I have merged this ticket with the latest version of #18876 to avoid conflicts.


---

Comment by dcoudert created at 2015-07-30 11:30:51

When I click on the link to the code (to of the page, branch `u/borassi/boost_minimum_spanning_tree`), for file `bandwidth.pyx` I see the following line which has been changed in #18876. 

```
+    :meth:`bandwidth_heuristics()<sage.graphs.base.boost_graph.bandwidth_heuristics>` | Uses Boost heuristics to approximate the bandwidth of the input graph
```

Is it normal??


---

Comment by borassi created at 2015-07-30 12:47:56

Yes, it is normal, I think: I modified that line only after I merged #18876. However, I do not think it is a problem, because the new commit in #18876 should not create conflicts (I have tested the merge).

In any case, I re-merged them with this new commit.

Replying to [comment:22 dcoudert]:


> When I click on the link to the code (to of the page, branch `u/borassi/boost_minimum_spanning_tree`), for file `bandwidth.pyx` I see the following line which has been changed in #18876. 
> {{{
> +    :meth:`bandwidth_heuristics()<sage.graphs.base.boost_graph.bandwidth_heuristics>` | Uses Boost heuristics to approximate the bandwidth of the input graph
> }}}
> Is it normal??


---

Comment by git created at 2015-07-30 12:48:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-30 16:24:57

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-07-30 16:24:57

for me the patch is good to go !


---

Comment by vbraun created at 2015-07-31 17:52:20

Resolution: fixed
