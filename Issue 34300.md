# Issue 34300: Prepare for pari 2.15

Issue created by migration from https://trac.sagemath.org/ticket/34537

Original creator: vdelecroix

Original creation time: 2022-09-15 08:21:09

CC:  arojas @collares cremona

PARI/GP is about to release a new version


---

Attachment


---

Comment by vdelecroix created at 2022-09-15 09:45:55

Indeed, according to Bill Allombert `ANYARG` is gone in PARI/GP 2.15.0.


---

Comment by vdelecroix created at 2022-09-15 09:54:29

a solution

```
#ifdef __cplusplus
#  define ANYARG ...
#else
#  define ANYARG
#endif
```



---

Comment by vdelecroix created at 2022-09-15 10:15:39

New commits:


---

Attachment


---

Comment by vdelecroix created at 2022-09-15 18:54:02

For the complete log, see [testall.log](https://trac.sagemath.org/raw-attachment/ticket/34537/testall.log)

```
geometry/polyhedron/backend_normaliz.py  # 1 doctest failed
geometry/polyhedron/backend_field.py  # 2 doctests failed
dynamics/arithmetic_dynamics/projective_ds.py  # 1 doctest failed
arith/misc.py  # 4 doctests failed
libs/pari/tests.py  # 2 doctests failed
doctest/forker.py  # 1 doctest failed
doctest/sources.py  # 1 doctest failed
modular/cusps_nf.py  # 1 doctest failed
modular/modform/l_series_gross_zagier.py  # 1 doctest failed
modular/modsym/p1list_nf.py  # 3 doctests failed
modular/modform_hecketriangle/hecke_triangle_group_element.py  # 1 doctest failed
interfaces/genus2reduction.py  # 15 doctests failed
plot/plot3d/index_face_set.pyx  # Timed out
modules/free_quadratic_module_integer_symmetric.py  # 6 doctests failed
lfunctions/pari.py  # 1 doctest failed
lfunctions/dokchitser.py  # 4 doctests failed
rings/qqbar.py  # 28 doctests failed
rings/function_field/function_field.py  # 1 doctest failed
rings/number_field/selmer_group.py  # 1 doctest failed
rings/number_field/class_group.py  # 3 doctests failed
rings/number_field/number_field_ideal_rel.py  # 3 doctests failed
rings/number_field/bdd_height.py  # 1 doctest failed
rings/number_field/order.py  # 1 doctest failed
rings/number_field/S_unit_solver.py  # 4 doctests failed
rings/number_field/number_field.py  # 20 doctests failed
rings/number_field/number_field_rel.py  # 2 doctests failed
rings/number_field/number_field_ideal.py  # 1 doctest failed
rings/number_field/number_field_element.pyx  # 3 doctests failed
rings/number_field/galois_group.py  # 1 doctest failed
rings/finite_rings/finite_field_prime_modn.py  # 1 doctest failed
rings/finite_rings/residue_field.pyx  # 12 doctests failed
rings/polynomial/polynomial_quotient_ring.py  # 1 doctest failed
rings/polynomial/polynomial_element.pyx  # 2 doctests failed
rings/polynomial/polynomial_number_field.pyx  # 1 doctest failed
groups/fqf_orthogonal.py  # 1 doctest failed
groups/matrix_gps/isometries.py  # 1 doctest failed
schemes/curves/affine_curve.py  # 3 doctests failed
schemes/plane_conics/con_rational_function_field.py  # 3 doctests failed
schemes/elliptic_curves/gal_reps_number_field.py  # 2 doctests failed
schemes/elliptic_curves/ell_rational_field.py  # 17 doctests failed
schemes/elliptic_curves/isogeny_small_degree.py  # 1 doctest failed
schemes/elliptic_curves/gp_simon.py  # 1 doctest failed
schemes/elliptic_curves/modular_parametrization.py  # 3 doctests failed
schemes/elliptic_curves/BSD.py  # 3 doctests failed
schemes/elliptic_curves/ell_generic.py  # 1 doctest failed
schemes/elliptic_curves/heegner.py  # 181 doctests failed
schemes/elliptic_curves/ell_field.py  # 1 doctest failed
schemes/elliptic_curves/ell_number_field.py  # 6 doctests failed
schemes/hyperelliptic_curves/jacobian_endomorphism_utils.py  # 4 doctests failed
schemes/hyperelliptic_curves/jacobian_generic.py  # 10 doctests failed
schemes/affine/affine_morphism.py  # 1 doctest failed
quadratic_forms/binary_qf.py  # 25 doctests failed
quadratic_forms/quadratic_form__automorphisms.py  # 1 doctest failed
quadratic_forms/qfsolve.py  # 1 doctest failed
quadratic_forms/genera/genus.py  # 5 doctests failed
```



---

Comment by arojas created at 2022-09-20 19:04:25

Pushed fixes for test failures caused by different choice of generators and syntax changes so we have a clear picture of the actual issues. Remaining failures:

```
sage -t --long /usr/lib/python3.10/site-packages/sage/quadratic_forms/qfsolve.py  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/quadratic_forms/binary_qf.py  # 25 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/quadratic_forms/genera/genus.py  # 4 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/modular/modform/l_series_gross_zagier.py  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/plane_conics/con_rational_function_field.py  # 3 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/curves/affine_curve.py  # 3 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/heegner.py  # 181 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py  # 17 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/BSD.py  # 3 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/modular_parametrization.py  # 3 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/gp_simon.py  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/hyperelliptic_curves/jacobian_generic.py  # 10 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/hyperelliptic_curves/jacobian_endomorphism_utils.py  # 4 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/lfunctions/dokchitser.py  # 4 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/groups/fqf_orthogonal.py  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/rings/number_field/number_field.py  # 11 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/rings/number_field/number_field_element.pyx  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/rings/polynomial/polynomial_element.pyx  # 2 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/rings/polynomial/polynomial_number_field.pyx  # 1 doctest failed
sage -t --long /usr/lib/python3.10/site-packages/sage/rings/function_field/function_field.py  # 1 doctest failed
```

----
New commits:


---

Comment by git created at 2022-09-20 20:26:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-20 21:10:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 06:39:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-21 08:04:38

Upstream report for the failures in `schemes.curves.affine_curve` and `rings.number_field.number_field`:

https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2414


---

Comment by git created at 2022-09-21 08:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 08:14:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-22 15:41:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-22 18:04:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-22 18:15:48

Only two remaining issues that are going to need more help from experts:

```
sage -t --long /usr/lib/python3.10/site-packages/sage/interfaces/genus2reduction.py  # 15 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/hyperelliptic_curves/jacobian_generic.py  # 10 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/schemes/hyperelliptic_curves/jacobian_endomorphism_utils.py  # 4 doctests failed
```

These are caused by the changes in gp's `genus2red` output from https://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=a41e4fa95925eae42830217313583efc80628763

Sage's `genus2reduction.py` needs to be adapted to those changes.


```
sage -t --long /usr/lib/python3.10/site-packages/sage/groups/fqf_orthogonal.py  # 1 doctest failed
```


This is a weird issue that involves pari and gap code. Needs further investigation.


---

Comment by git created at 2022-09-23 14:46:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-23 17:15:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-24 21:26:39

Replying to [comment:11 Antonio Rojas]:
> Upstream report for the failures in `schemes.curves.affine_curve` and `rings.number_field.number_field`:
> 
> https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2414

The bug was fixed upstream, but we may want to keep the workaround. It's not particularly hackish and will allow to use an unpatched system pari 2.15.0


---

Comment by mkoeppe created at 2022-09-25 01:49:46

Changing priority from major to critical.


---

Comment by mkoeppe created at 2022-09-25 01:50:24

Is this ready to go, or should we put the giac build fix on a separate ticket?


---

Comment by arojas created at 2022-09-25 06:54:29

It's not ready, see comment:16


---

Comment by mkoeppe created at 2022-09-25 19:56:55

That's now #34586


---

Comment by vdelecroix created at 2022-09-29 09:08:10

Instead of using the `ellQ_ellrank` from Denis Simon script we should be using the `ellrank` from PARI/GP (available from version 2.15). Though, the latter only works over rational numbers.


---

Comment by arojas created at 2022-09-29 09:30:38

Replying to [comment:25 Vincent Delecroix]:
> Instead of using the `ellQ_ellrank` from Denis Simon script we should be using the `ellrank` from PARI/GP (available from version 2.15). Though, the latter only works over rational numbers.

That should go in a follow-up ticket, I think. The branch is already big enough.


---

Comment by vdelecroix created at 2022-09-29 09:42:25

Replying to [comment:26 Antonio Rojas]:
> Replying to [comment:25 Vincent Delecroix]:
> > Instead of using the `ellQ_ellrank` from Denis Simon script we should be using the `ellrank` from PARI/GP (available from version 2.15). Though, the latter only works over rational numbers.
> 
> That should go in a follow-up ticket, I think. The branch is already big enough.

Sure: #34608


---

Comment by vdelecroix created at 2022-09-29 09:42:52

I am with Bill. I will push a fix for the genus 2 reduction.


---

Comment by vdelecroix created at 2022-09-29 10:02:07

New commits:


---

Comment by vdelecroix created at 2022-09-29 10:02:47

The modifications I have done are incompatible with PARI < 2.15. I think it would be simpler to enforce PARI >= 2.15 in the next sage version.


---

Comment by git created at 2022-09-30 06:47:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-09-30 07:34:05

Replying to [comment:30 Vincent Delecroix]:
> I think it would be simpler to enforce PARI >= 2.15 in the next sage version.

If done, this would simplify the patch at #33360, which currently chooses from two distinct implementations depending on the PARI version.


---

Comment by dimpase created at 2022-09-30 12:12:58

Meanwhile, please see #34496 - to forbid system Pari 2.15 and newer, until we're done here.


---

Comment by git created at 2022-09-30 13:18:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-30 13:19:59

This is almost ready, just needs someone to figure out the failure in `sage/groups/fqf_orthogonal.py`


---

Comment by vdelecroix created at 2022-09-30 14:31:28

The test in `fqf_orthogonal.py` does not make much sense as `Oq` and `OL` are different groups.


---

Comment by git created at 2022-09-30 14:31:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-30 14:31:51

Replying to [comment:35 Antonio Rojas]:
> This is almost ready, just needs someone to figure out the failure in `sage/groups/fqf_orthogonal.py`

OK, from a closer look it looks like this is just caused by a different choice of generators for the orthogonal group. Replacing

```
sage: assert Oq(OL.0) == Oq(OL.0.matrix())
```

with

```
sage: assert Oq(OL.1) == Oq(OL.1.matrix())
```

gives the same failure with pari 2.13. So, even though this looks like an actual issue, it is not a regression from the pari update, it just happened to work by chance before due to a different matrix being tested. I think we should just flag this as known bug and proceed with this.
----
New commits:


---

Comment by vdelecroix created at 2022-09-30 14:34:42

I pushed a "fix" in 48ea610. I do not think there is anything deep about generators that is tested here. Otherwise this should have been documented!


---

Comment by vdelecroix created at 2022-09-30 14:35:18

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2022-09-30 14:35:55

Antonio, if you don't like my last commit feel free to replace with "known bug".


---

Comment by vdelecroix created at 2022-09-30 14:36:27

Should we enforce pari 2.15 at configure step?


---

Comment by vdelecroix created at 2022-09-30 14:36:27

Changing status from needs_review to needs_info.


---

Comment by git created at 2022-09-30 14:42:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-30 14:44:00

Replying to [comment:42 Vincent Delecroix]:
> Should we enforce pari 2.15 at configure step?

Was just doing that. Since there are backwards-incompatible changes, we should


---

Comment by arojas created at 2022-09-30 14:44:00

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2022-09-30 15:11:01

see the rationale for putting #34496 into dependencies in #34496


---

Comment by dimpase created at 2022-09-30 15:15:32

Also `m4_pushdef([SAGE_PARI_MINVER],["134912"])` is not right. This is pari 2.15.0, but without a patch it won't work. So this has to be a bigger value.


---

Comment by git created at 2022-09-30 15:23:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2022-09-30 15:24:32

I've rebased over the branch of #34496 and bumped SAGE_PARI_MIN/MAXVER accordingly.


---

Comment by arojas created at 2022-09-30 15:33:09

Replying to [comment:46 Dima Pasechnik]:
> Also `m4_pushdef([SAGE_PARI_MINVER],["134912"])` is not right. This is pari 2.15.0, but without a patch it won't work. So this has to be a bigger value.

Which patch? This works fine with plain 2.15.0


---

Comment by git created at 2022-09-30 15:37:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-09-30 15:38:23

OK, right, I didn't pay attention. It's giac's patch, not pari's. Fixed.


---

Comment by arojas created at 2022-09-30 16:01:21

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2022-09-30 16:01:21

Looks like the force push reverted part of the 9.8.beta1 rebase. The changes in `sage/geometry/polyhedron/backend_normaliz.py` shouldn't be there, and the pycodestyle changes from #34522 in `src/sage/lfunctions/pari.py` are missing.


---

Comment by git created at 2022-09-30 16:09:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-30 16:10:13

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-10-01 07:33:58

tests good on macOS with Homebrew's pari 2.15.0


---

Comment by dimpase created at 2022-10-01 07:35:02

I suppose this needs a round of testing on GH Actions.


---

Comment by dimpase created at 2022-10-01 09:53:32

I've started https://github.com/sagemath/sagetrac-mirror/actions/runs/3164081241
I see the CI has been refactored, not sure how to run more tests.


---

Comment by mkoeppe created at 2022-10-01 16:40:24

Replying to [comment:57 Dima Pasechnik]:
> I've started https://github.com/sagemath/sagetrac-mirror/actions/runs/3164081241
> I see the CI has been refactored, not sure how to run more tests.

Use https://github.com/sagemath/sagetrac-mirror/actions/workflows/ci-linux.yml?query=branch%3Apublic%2F34537 and push "Run workflow"

or https://github.com/sagemath/sagetrac-mirror/actions/workflows/ci-macos.yml?query=branch%3Apublic%2F34537 and push "Run workflow"


---

Comment by dimpase created at 2022-10-02 08:50:10

started 

https://github.com/sagemath/sagetrac-mirror/actions/runs/3167926282

and 

https://github.com/sagemath/sagetrac-mirror/actions/runs/3167930205

By the way, with such urls as you provided, it's not sufficent to just push "Run workflow", as this widget still has "develop" as a branch to run - so the branch still had to manually selected.


---

Comment by dimpase created at 2022-10-03 07:38:20

works on M1 mac with Homebrew, too.


---

Comment by dimpase created at 2022-10-03 15:01:07

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-10-03 15:01:07

there were errors with many CI runs on macOS, but I think it's not because of this. LGTM


---

Comment by dimpase created at 2022-10-04 10:12:46

I spoke too soon. While Sage tests all pass, some of giac's selftests fail (this is on macOS M1 machine)

```
[giac-1.9.0.15p0] make  check-TESTS
[giac-1.9.0.15p0] PASS: chk_partfrac
[giac-1.9.0.15p0] PASS: chk_factor
[giac-1.9.0.15p0] PASS: chk_integrate
[giac-1.9.0.15p0] PASS: chk_geo
[giac-1.9.0.15p0] FAIL: chk_fhan2
[giac-1.9.0.15p0] PASS: chk_cas
[giac-1.9.0.15p0] PASS: chk_fhan3
[giac-1.9.0.15p0] FAIL: chk_fhan4
[giac-1.9.0.15p0] PASS: chk_xavier
[giac-1.9.0.15p0] PASS: chk_morley_demo
[giac-1.9.0.15p0] FAIL: chk_fhan6
[giac-1.9.0.15p0] PASS: chk_limit
[giac-1.9.0.15p0] FAIL: chk_fhan8
[giac-1.9.0.15p0] PASS: chk_fhan5
[giac-1.9.0.15p0] PASS: chk_fhan0
[giac-1.9.0.15p0] PASS: chk_normalize
[giac-1.9.0.15p0] FAIL: chk_fhan13
[giac-1.9.0.15p0] FAIL: chk_fhan12
[giac-1.9.0.15p0] PASS: chk_fhan14
[giac-1.9.0.15p0] PASS: chk_fhan1
[giac-1.9.0.15p0] PASS: chk_fhan15
[giac-1.9.0.15p0] FAIL: chk_fhan11
[giac-1.9.0.15p0] PASS: chk_fhan17
[giac-1.9.0.15p0] PASS: chk_fhan16
[giac-1.9.0.15p0] PASS: chk_fhan20
[giac-1.9.0.15p0] PASS: chk_fhan19
[giac-1.9.0.15p0] PASS: chk_fhan21
[giac-1.9.0.15p0] FAIL: chk_fhan9
[giac-1.9.0.15p0] PASS: chk_fhan18
[giac-1.9.0.15p0] PASS: chk_fhan7
[giac-1.9.0.15p0] ============================================================================
[giac-1.9.0.15p0] Testsuite summary for giac 1.9.0
[giac-1.9.0.15p0] ============================================================================
[giac-1.9.0.15p0] # TOTAL: 30
[giac-1.9.0.15p0] # PASS:  22
[giac-1.9.0.15p0] # SKIP:  0
[giac-1.9.0.15p0] # XFAIL: 0
[giac-1.9.0.15p0] # FAIL:  8
[giac-1.9.0.15p0] # XPASS: 0
```


hopefully it's just formatting, but needs investigation


---

Comment by dimpase created at 2022-10-04 10:12:46

Changing status from positive_review to needs_info.


---

Comment by arojas created at 2022-10-04 21:05:07

I'm seeing just one failure, which is a segfault

```
  ***   the thread stack overflows !
  current stack size: 1024000 (0.977 Mbytes)
  [hint] set 'threadsizemax' to a nonzero value in your GPRC
  *** matdet: Warning: increasing stack size to 2048000.
  ***   at top-level: matdet([-10,-7,6,-7,1,4,-1,-2,-2,-5,1,7,-6,7,-
  ***                 ^----------------------------------------------
  *** matdet: the thread stack overflows !
  current stack size: 1024000 (0.977 Mbytes)
  [hint] set 'threadsizemax' to a nonzero value in your GPRC
Error in PARI subsystem
./chk_fhan4: line 3: 21708 Segmentation fault      (core dumped) ../src/icas TP04-sol.cas > TP04.tst
```

caused by the garbage collection changes in https://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=259f62c17c101c380cfed56d303304a13e21ec1e


---

Comment by dimpase created at 2022-10-04 21:28:47

I see this segfault too. Does setting `threadsizemax` in `~/.gprc` help?


---

Comment by jhpalmieri created at 2022-10-04 21:59:31

Dima, as noted at #32785#comment:7, it is not new that `giac` fails its test suite, at least on OS X machines. On Intel (old version of `giac` and `pari`):

```
PASS: chk_partfrac
PASS: chk_fhan3
PASS: chk_factor
FAIL: chk_fhan2
PASS: chk_geo
PASS: chk_integrate
PASS: chk_fhan0
PASS: chk_cas
PASS: chk_fhan5
PASS: chk_fhan13
PASS: chk_fhan12
PASS: chk_fhan14
PASS: chk_fhan15
PASS: chk_fhan17
PASS: chk_fhan6
PASS: chk_fhan19
PASS: chk_fhan16
PASS: chk_fhan20
PASS: chk_fhan21
FAIL: chk_fhan9
PASS: chk_fhan18
PASS: chk_fhan7
PASS: chk_xavier
PASS: chk_morley_demo
PASS: chk_limit
PASS: chk_fhan11
PASS: chk_fhan8
PASS: chk_fhan4
PASS: chk_fhan1
PASS: chk_normalize
```

I'll try on an m2 machine later, to see what failures I get.


---

Comment by dimpase created at 2022-10-04 22:06:45

ok, thus it is not much of a regression.


---

Comment by jhpalmieri created at 2022-10-04 23:56:34

By the way, should #34496 really be a dependency, or is the point of this ticket to be able to bypass the problem of building with the newest `pari`?


---

Comment by dimpase created at 2022-10-05 10:28:35

Replying to [comment:67 John Palmieri]:
> By the way, should #34496 really be a dependency, or is the point of this ticket to be able to bypass the problem of building with the newest `pari`?

#34496 added a useful tweak to spkg-configure of pari, and so we build up on it.


---

Comment by jhpalmieri created at 2022-10-05 15:09:29

I'm not going to be able to check test suite failures with the old `pari`/`giac` on Apple M2 until Friday.


---

Comment by jhpalmieri created at 2022-10-07 21:29:51

On Apple M2, the old pari and the old giac give these results in giac's test suite:

```
make  check-TESTS
PASS: chk_partfrac
PASS: chk_factor
PASS: chk_integrate
PASS: chk_geo
PASS: chk_cas
PASS: chk_limit
FAIL: chk_fhan2
PASS: chk_xavier
PASS: chk_morley_demo
PASS: chk_fhan3
PASS: chk_normalize
FAIL: chk_fhan4
FAIL: chk_fhan6
FAIL: chk_fhan8
PASS: chk_fhan5
PASS: chk_fhan0
FAIL: chk_fhan13
FAIL: chk_fhan12
PASS: chk_fhan1
PASS: chk_fhan14
PASS: chk_fhan15
FAIL: chk_fhan11
PASS: chk_fhan17
PASS: chk_fhan16
PASS: chk_fhan20
PASS: chk_fhan19
PASS: chk_fhan21
FAIL: chk_fhan9
PASS: chk_fhan18
PASS: chk_fhan7
```



---

Comment by jhpalmieri created at 2022-10-07 21:56:39

Looks like the same failures that Dima saw, so not a regression. I don't think it should be an obstacle to this ticket.


---

Comment by dimpase created at 2022-10-08 20:28:17

Changing status from needs_info to positive_review.


---

Comment by dimpase created at 2022-10-08 20:28:17

OK, thanks. Back to positive.


---

Comment by vbraun created at 2022-10-10 22:17:19

The cypari testsuite fails on OSX (intel), worked before

```
Successfully installed cypari2-2.1.2

real    1m45.872s
user    1m35.524s
sys     0m9.197s
Copying package files from temporary location /Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.10.5/var/tmp/sage/build/cypari-2.1.2/inst to /Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.10.5
Running the test suite for cypari-2.1.2...
ulimit -s 8192; python3 -u tests/rundoctest.py
================================================================================
Testing cypari2.closure
**********************************************************************
File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.10.5/lib/python3.10/site-packages/cypari2/closure.cpython-310-darwin.so", line ?, in cypari2.closure.__test__.objtoclosure (line 145)
Failed example:
    mul([1], [2])
Differences (ndiff with -expected +actual):
      Traceback (most recent call last):
    - ...
    - PariError: call_python: forbidden multiplication t_VEC (1 elts) * t_VEC (1 elts)
    +   File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.10.5/lib/python3.10/doctest.py", line 1350, in __run
    +     exec(compile(example.source, filename, "single",
    +   File "<doctest cypari2.closure.__test__.objtoclosure (line 145)[18]>", line 1, in <module>
    +     mul([1], [2])
    +   File "cypari2/gen.pyx", line 4110, in cypari2.gen.Gen.__call__
    +     sig_on()
    +   File "cypari2/handle_error.pyx", line 213, in cypari2.handle_error._pari_err_handle
    +     raise PariError(errnum, pari_error_string, clone_gen_noclear(E))
    + PariError: call_python: incorrect type in qfbcomp (t_VEC)
**********************************************************************
File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.10.5/lib/python3.10/site-packages/cypari2/closure.cpython-310-darwin.so", line ?, in cypari2.closure.objtoclosure
Failed example:
    mul([1], [2])
Differences (ndiff with -expected +actual):
      Traceback (most recent call last):
    - ...
    - PariError: call_python: forbidden multiplication t_VEC (1 elts) * t_VEC (1 elts)
    +   File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.10.5/lib/python3.10/doctest.py", line 1350, in __run
    +     exec(compile(example.source, filename, "single",
    +   File "<doctest cypari2.closure.objtoclosure[18]>", line 1, in <module>
    +     mul([1], [2])
    +   File "cypari2/gen.pyx", line 4110, in cypari2.gen.Gen.__call__
    +     sig_on()
    +   File "cypari2/handle_error.pyx", line 213, in cypari2.handle_error._pari_err_handle
    +     raise PariError(errnum, pari_error_string, clone_gen_noclear(E))
    + PariError: call_python: incorrect type in qfbcomp (t_VEC)
**********************************************************************
```



---

Comment by vbraun created at 2022-10-10 22:17:19

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2022-10-10 22:26:53

Replying to [comment:74 Volker Braun]:
> The cypari testsuite fails on OSX (intel), worked before
> {{{
> ...
> }}}

The error message indeed changed in PARI 2.15. Should that really block this ticket? Otherwise, we do have to upgrade cypari2 at the same time.


---

Comment by vbraun created at 2022-10-11 09:14:07

The (cy)pari testsuite is generally pretty solid so I'd hate to have to permanently disable it on the buildbot


---

Comment by thansen created at 2022-10-14 17:01:35

Here is an explanation for the cypari error:
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1020456#10


---

Comment by dimpase created at 2022-10-17 10:53:36

Replying to [comment:77 Tobias Hansen]:
> Here is an explanation for the cypari error:
> https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1020456#10
report to upstream:  https://github.com/sagemath/cypari2/issues/122


---

Comment by tornaria created at 2022-10-30 21:30:18

I have cypari2 pass all tests on pari-2.15 using
 - patch on pari: https://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commit;h=9c4bcd3f497f30f757c8eecadc9b45b33754a540 (just remove the first hunk patching the file `CHANGES` since it will not apply otherwise)
 - patch on cypari2: https://github.com/sagemath/cypari2/pull/123


---

Comment by dimpase created at 2022-11-10 23:31:49

pari 2.15.1 is out, see https://pari.math.u-bordeaux.fr/archives/pari-announce-22/msg00002.html


---

Comment by tornaria created at 2022-11-10 23:55:47

Replying to [comment:80 Dima Pasechnik]:
> pari 2.15.1 is out, see https://pari.math.u-bordeaux.fr/archives/pari-announce-22/msg00002.html

Pari 2.15.1 includes the fix I cherry picked in my last comment.

The current HEAD of cypari2 already fied testsuite passes on pari 2.15, and Vincent said he will do a release soon.

It would be very nice if this can be merged for 9.8.


---

Comment by arojas created at 2022-11-11 06:59:59

Also, giac 1.9.0.29 builds fine against 2.15 without patching.


---

Comment by dimpase created at 2022-11-11 15:10:38

Replying to [comment:82 Antonio Rojas]:
> Also, giac 1.9.0.29 builds fine against 2.15 without patching.

do you want giac updated here, or on another ticket?


---

Comment by mkoeppe created at 2022-11-11 18:53:40

cypari2 upgrade in #33878


---

Comment by arojas created at 2022-11-24 21:13:35

Replying to [comment:83 Dima Pasechnik]:
> do you want giac updated here, or on another ticket?

I don't personally mind, was just pointing out the possibility of updating giac instead of patching. Can this go back to needs_review now?


---

Comment by dimpase created at 2022-11-24 21:33:32

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-11-29 19:13:46

The title of the ticket says that we're upgrading to 2.15.1, but the branch only goes to 2.15.0.


---

Comment by dimpase created at 2022-11-29 20:17:38

Oh, right, I tested with Homebrew's pari, and Gentoo's pari (they are both 2.15.1), and forgot to bump this branch.


---

Comment by dimpase created at 2022-11-29 20:34:36

OK, readly now
----
Last 10 new commits:


---

Comment by dimpase created at 2022-11-29 20:34:54

rebased over 9.8.beta4


---

Comment by jhpalmieri created at 2022-11-30 00:47:50

On OS X Intel, the basic functionality is there (i.e., Sage builds and `make ptestlong` works), but the test suite for pari hangs. I see this in the log file, with no changes in more than an hour:

```
: gp-sta
* Testing addprimes        gp-sta..TIME=    8   gp-dyn..TIME=    8   
* Testing agm              gp-sta..TIME=   65   gp-dyn..TIME=   59   
* Testing algebras         gp-sta..TIME= 1490   gp-dyn..TIME= 1481   
* Testing alggroup         gp-sta..TIME=  661   gp-dyn..TIME=  651   
* Testing alghasse         gp-sta..TIME= 2701   gp-dyn..TIME= 2523   
* Testing alglattices      gp-sta..TIME= 1153   gp-dyn..TIME= 1150   
* Testing algsplit         gp-sta..TIME=  946   gp-dyn..TIME= 1139   
* Testing analyz           gp-sta..TIME=   22   gp-dyn..TIME=   20   
* Testing apply            gp-sta..TIME=    1   gp-dyn..TIME=    1   
* Testing arith            gp-sta..TIME=    0   gp-dyn..TIME=    0   
* Testing asymp            gp-sta..TIME=  129   gp-dyn..TIME=  117   
* Testing aurifeuille      gp-sta..TIME=    1   gp-dyn..TIME=    1   
* Testing bbhnf            gp-sta..TIME=  959   gp-dyn..TIME=  918   
* Testing bern             gp-sta..TIME=13627   gp-dyn..TIME=13270   
* Testing bessel           gp-sta..TIME=  177   gp-dyn..TIME=  170   
* Testing bestappr         gp-sta..TIME=    1   gp-dyn..TIME=    1   
* Testing binomial         gp-sta..TIME=  240   gp-dyn..TIME=  243   
* Testing bit              gp-sta..TIME=    1   gp-dyn..TIME=    1   
* Testing bnf              gp-sta..TIME=31168   gp-dyn..TIME=31762   
* Testing bnfisintnorm     gp-sta..TIME=  504   gp-dyn..TIME=  506   
* Testing bnflog           
```

This is after running `export SAGE_CHECK=yes` and `make pari`.


---

Comment by jhpalmieri created at 2022-11-30 06:25:21

I seem to get the same thing with the previous version of `pari`. I'm trying again and I will update later.


---

Comment by dimpase created at 2022-11-30 07:53:12

perhaps upstream does not test with macOS at all, or perhaps only with old versions, and not 13.0 ?


---

Comment by jhpalmieri created at 2022-11-30 16:47:21

Right, I get the same with the previous version of `pari`, so this failure should not hold up this ticket.


---

Comment by jhpalmieri created at 2022-11-30 17:32:12

On Apple Silicon, both the old and new `pari` pass their test suites.


---

Comment by jhpalmieri created at 2022-11-30 19:20:23

Many of the changes in doctests look fine to me, but I can't vouch for all of them. Can other people check them? (One example is the change in sage/schemes/elliptic_curves/ell_field.py, although there are others. Looks plausible but I don't know the details.)


---

Comment by dimpase created at 2022-12-07 18:01:21

John C., can you have a look ?


---

Comment by cremona created at 2022-12-09 11:25:42

Replying to [comment:97 Dima Pasechnik]:
> John C., can you have a look ?
Sorry, only jut noticed this -- will do today.


---

Comment by cremona created at 2022-12-09 12:01:24

genus2reduction: makes sense for our doctests to just have y^2 = ... since these reductions are not unique. The most important thing is for the minimal discriminant to be correct which we do check.

cusps_nf: OK

lfunctions/*: OK

libs/pari/tests: OK

S_unit_solver: OK

number_field/*: OK

polynomial/*: OK

QQbar: looks reasonable, would take ages to rigorously check everything

elliptic_curves/
ell_field: OK (the two fields are isomorphic)
ell_generic: OK (0 is displayed differently)

ell_number_field: (1) the first simon_two_descent test in the diffs is strange as E is defined by EllipticCurve(K, '37') where K is a number field; the resulting curve is the one with label '37a1'.  Would you believe tat I had never noticed that the function parse_cremona_label() was happy both to have the curve number default to 1 (which I knew) and also the isogeny class letter code default to 'a'?  Fine, it is documented, but one day I'll change that '37' to '37a1' to be less obscure.
(2) the different matrices are OK since the rows/cols will be permuted if the curves in the class are sorted differently; the docstring (written by me) says "The curves in the class are sorted first by CM discriminant (then lexicographically using
a-invariants)" which can lead to differences, either because the field generator changes or because the choice of minimal reduced model (and hence the a-invariants) is not deterministic.  One day I'll implement the LMFDB way of sorting curves in the class.

The rest of the elliptic curves stuff is fine.

Note that we no longer need, and could deprecate, the simon_two_descent() method for curves over QQ, since the pari ellrank() function will always be better (being a C implementation with a lot of extra geatures of the same underlying theory).  But this is *not* the case for that methof for curves over number fields, at present.  And for a similar reason the rank() method for elliptic curves over Q (and related methods such as gens()) should definitely now have an 'algorithm=pari' option now which calls ellrank().  It's also probably true that it should be the default, for curves not in the database, as it is extremely good (=fast and good at finding generators).  But not on this ticket.

I looked at mst of the files, and all the ones where I thought my expertise would be helpful.  Looks good!


---

Comment by dimpase created at 2022-12-09 13:00:53

Thanks John, I take your long review as OK.


---

Comment by dimpase created at 2022-12-09 13:00:53

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2022-12-09 14:59:18

Replying to [comment:100 Dima Pasechnik]:
> Thanks John, I take your long review as OK.

yes!


---

Comment by vbraun created at 2022-12-18 11:31:55

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-12-18 11:31:55

There are a bunch of numerical noise issues on 32-bit:

```
**********************************************************************
File "src/sage/calculus/calculus.py", line 242, in sage.calculus.calculus
Failed example:
    float(z)
Expected:
    4.646783762432936
Got:
    4.646783762432935
**********************************************************************
File "src/sage/calculus/calculus.py", line 772, in sage.calculus.calculus.?
Failed example:
    float(f)
Expected:
    -480.0
Got:
    -2336.0
**********************************************************************
File "src/sage/calculus/calculus.py", line 784, in sage.calculus.calculus.?
Failed example:
    f.nintegrate(x,0,1)
Expected:
    (-480.0000000000001, 5.32907051820075...e-12, 21, 0)
Got:
    (-831.9999999999999, 9.237055564881304e-12, 21, 0)
**********************************************************************
2 items had failures:
   1 of 118 in sage.calculus.calculus
   2 of  15 in sage.calculus.calculus.?
    [457 tests, 3 failures, 19.44 s]
**********************************************************************
File "src/sage/calculus/wester.py", line 283, in sage.calculus.wester
Failed example:
    float(a)
Expected:
    1.1368683772...e-13
Got:
    0.0
**********************************************************************
1 item had failures:
   1 of 202 in sage.calculus.wester
    [201 tests, 1 failure, 2.45 s]
**********************************************************************
File "src/sage/categories/finite_coxeter_groups.py", line 705, in sage.categories.finite_coxeter_groups.FiniteCoxeterGroups.ParentMethods.permutahedron
Failed example:
    W.permutahedron()
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.finite_coxeter_groups.FiniteCoxeterGroups.ParentMethods.permutahedron[1]>", line 1, in <module>
        W.permutahedron()
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/categories/finite_coxeter_groups.py", line 755, in permutahedron
        return Polyhedron(vertices=vertices, base_ring=base_ring)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/geometry/polyhedron/constructor.py", line 759, in Polyhedron
        return parent(Vrep, Hrep, convert=convert, verbose=verbose, mutable=mutable)
      File "sage/structure/parent.pyx", line 898, in sage.structure.parent.Parent.__call__
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args
        raise
      File "sage/structure/coerce_maps.pyx", line 175, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args
        return C._element_constructor(x, *args, **kwds)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/geometry/polyhedron/parent.py", line 684, in _element_constructor_
        return self.element_class(self, Vrep, Hrep, **kwds)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/geometry/polyhedron/backend_cdd_rdf.py", line 98, in __init__
        Polyhedron_cdd.__init__(self, parent, Vrep, Hrep, **kwds)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/geometry/polyhedron/base0.py", line 174, in __init__
        self._init_from_Vrepresentation(vertices, rays, lines, **kwds)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/geometry/polyhedron/backend_cdd.py", line 65, in _init_from_Vrepresentation
        s = self._run_cdd(s, '--repall', verbose=verbose)
      File "/var/lib/buildbot/worker/sage_git/build/src/sage/geometry/polyhedron/backend_cdd.py", line 172, in _run_cdd
        raise ValueError(ans.strip())
    ValueError: *Error: Numerical inconsistency is found.  Use the GMP exact arithmetic.
**********************************************************************
1 item had failures:
   1 of   6 in sage.categories.finite_coxeter_groups.FiniteCoxeterGroups.ParentMethods.permutahedron
    [151 tests, 1 failure, 4.74 s]
**********************************************************************
File "src/sage/dynamics/complex_dynamics/mandel_julia_helper.pyx", line 219, in sage.dynamics.complex_dynamics.mandel_julia_helper.?
Failed example:
    fast_external_ray(0,S=1,D=1)
Expected:
    [(100.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000,
      0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000),
     (9.51254777713729174697578576623132297117784691109499464854806785133621315075854778426714908,
      0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)]
Got:
    [(100.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000,
      0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000),
     (9.51254777713729032775694689466896914675974929808733306327787458869355202130788654602053071,
      0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)]
**********************************************************************
File "src/sage/dynamics/complex_dynamics/mandel_julia_helper.pyx", line 229, in sage.dynamics.complex_dynamics.mandel_julia_helper.?
Failed example:
    fast_external_ray(1/3,S=1,D=1)
Expected:
    [(-49.9999999999999786837179271969944238662719726562500000000000000000000000000000000000000000,
      86.6025403784438765342201804742217063903808593750000000000000000000000000000000000000000000),
     (-5.50628047023173006234970878097113901879832542655926629309001652388544528575532346900138516,
      8.64947510053972513843999918917106032664030380426885745306040284140385975750462108180377187)]
Got:
    [(-49.9999999999999786837179271969944238662719726562500000000000000000000000000000000000000000,
      86.6025403784438765342201804742217063903808593750000000000000000000000000000000000000000000),
     (-5.50628047023172980317558651097220813419960642675275525034690583138202683104446159128356526,
      8.64947510053972416699388454766038069022656677613412868926274778156654918224636699020909555)]
**********************************************************************
File "src/sage/dynamics/complex_dynamics/mandel_julia_helper.pyx", line 238, in sage.dynamics.complex_dynamics.mandel_julia_helper.?
Failed example:
    fast_external_ray(0.75234,S=1,D=1)
Expected:
    [(1.47021239172637052661229972727596759796142578125000000000000000000000000000000000000000000,
      -99.9891917935294287644865107722580432891845703125000000000000000000000000000000000000000000),
     (-0.352790406744857508500937144524776555433184352559852962308757189778284058275081335121601384,
      -9.98646630765023514178761177926164047797465369576787921409326037870837930920646860774032363)]
Got:
    [(1.47021239172637052661229972727596759796142578125000000000000000000000000000000000000000000,
      -99.9891917935294287644865107722580432891845703125000000000000000000000000000000000000000000),
     (-0.352790406744857531982226711825539675074733886273844201352581335945053660908669195067107961,
      -9.98646630765023371851343140849138176796542428333725755653082848714206880231557255794864137)]
**********************************************************************
1 item had failures:
   3 of  42 in sage.dynamics.complex_dynamics.mandel_julia_helper.?
    [43 tests, 3 failures, 5.81 s]
**********************************************************************
File "src/sage/functions/log.py", line 45, in sage.functions.log.Function_exp
Failed example:
    exp(float(2.5))
Expected:
    12.182493960703473
Got:
    12.182493960703475
**********************************************************************
File "src/sage/functions/log.py", line 47, in sage.functions.log.Function_exp
Failed example:
    exp(RDF('2.5'))
Expected:
    12.182493960703473
Got:
    12.182493960703475
**********************************************************************
1 item had failures:
   2 of  41 in sage.functions.log.Function_exp
    [281 tests, 2 failures, 4.10 s]
**********************************************************************
File "src/sage/functions/trig.py", line 608, in sage.functions.trig.Function_arccos.__init__
Failed example:
    acos(complex(1,1))
Expected:
    (0.9045568943023814-1.0612750619050357j)
Got:
    (0.9045568943023815-1.0612750619050357j)
**********************************************************************
1 item had failures:
   1 of  18 in sage.functions.trig.Function_arccos.__init__
    [261 tests, 1 failure, 2.37 s]
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 2384, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicHM._plot_vertices
Failed example:
    g._plot_vertices(5)
Expected:
    [(4.0, -4.0, 5.744562...),
     (1.363213..., -1.637073..., 2.353372...),
     (0.138568..., -0.969980..., 1.400022...),
     (-0.942533..., -1.307681..., 1.896945...),
     (-3.0, -3.0, 4.358898...)]
Got:
    [(4.0, -4.0, 5.744562646538029),
     (1.3632131724692087, -1.6370738298435317, 2.3533722353151303),
     (0.1385685838744788, -0.9699800871213657, 1.4000223647674161),
     (-0.942533854284406, -1.3076813974501604, 1.8969450977056255),
     (-3.0, -3.000000000000014, 4.35889894354068)]
**********************************************************************
1 item had failures:
   1 of   6 in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicHM._plot_vertices
    [447 tests, 1 failure, 8.67 s]
**********************************************************************
File "src/sage/interacts/test_jupyter.rst", line 120, in sage.interacts.test_jupyter
Failed example:
    test(interacts.calculus.newton_method)
Expected:
    ...Interactive function <function newton_method at ...> with 7 widgets
      title: HTMLText(value='<h2>Newton method</h2>')
      f: EvalText(value='x^2 - 2', description='f', layout=Layout(max_width='81em'))
      c: IntSlider(value=6, description='Start ($x$)', max=10, min=-10)
      d: IntSlider(value=3, description='$10^{-d}$ precision', max=16, min=1)
      maxn: IntSlider(value=10, description='max iterations', max=15)
      interval: IntRangeSlider(value=(0, 6), description='Interval', max=10, min=-10)
      list_steps: Checkbox(value=False, description='List steps')
    \(\text{Precision } 2h = 0.001\)
    \({c = }1.4142141576301823\)
    \({f(c) = }1.6836416460996873 \times 10^{-06}\)
    \(6 \text{ iterations}\)
Got:
    <CSI-2K>
<CSI-2K>
\(\text{Precision } 2h = 0.0010000000000000002\)
    \({c = }1.4142141576301823\)
    \({f(c) = }1.6836416460996873 \times 10^{-06}\)
    \(6 \text{ iterations}\)
    Interactive function <function newton_method at 0xa6a181d8> with 7 widgets
      title: HTMLText(value='<h2>Newton method</h2>')
      f: EvalText(value='x^2 - 2', description='f', layout=Layout(max_width='81em'))
      c: IntSlider(value=6, description='Start ($x$)', max=10, min=-10)
      d: IntSlider(value=3, description='$10^{-d}$ precision', max=16, min=1)
      maxn: IntSlider(value=10, description='max iterations', max=15)
      interval: IntRangeSlider(value=(0, 6), description='Interval', max=10, min=-10)
      list_steps: Checkbox(value=False, description='List steps')
    \(\text{Precision } 2h = 0.0010000000000000002\)
    \({c = }1.4142141576301823\)
    \({f(c) = }1.6836416460996873 \times 10^{-06}\)
    \(6 \text{ iterations}\)
**********************************************************************
1 item had failures:
   1 of  30 in sage.interacts.test_jupyter
    [29 tests, 1 failure, 70.30 s]
**********************************************************************
File "src/sage/matrix/matrix_double_dense.pyx", line 1624, in sage.matrix.matrix_double_dense.Matrix_double_dense.right_eigenvectors
Failed example:
    spectrum[3]  # tol 1e-13
Expected:
    (-1.0, [(1.0, -0.5, 2.0, 0.5)], 1)
Got:
    (-1.0000000000000828,
     [(1.0, -0.4999999999999238, 1.9999999999997218, 0.4999999999999161)],
     1)
Tolerance exceeded in 3 of 6:
    -0.5 vs -0.4999999999999238, tolerance 2e-13 > 1e-13
    2.0 vs 1.9999999999997218, tolerance 2e-13 > 1e-13
    0.5 vs 0.4999999999999161, tolerance 2e-13 > 1e-13
**********************************************************************
1 item had failures:
   1 of  24 in sage.matrix.matrix_double_dense.Matrix_double_dense.right_eigenvectors
    [611 tests, 1 failure, 0.92 s]
**********************************************************************
File "src/sage/matrix/matrix_symbolic_dense.pyx", line 441, in sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense.exp
Failed example:
    exp(matrix(SR, [[1.2, 5.6], [3,4]])).change_ring(RDF)  # rel tol 1e-15
Expected:
    [ 346.5574872980695  661.7345909344504]
    [354.50067371488416  677.4247827652946]
Got:
    [346.55748729806896  661.7345909344492]
    [354.50067371488353  677.4247827652937]
Tolerance exceeded in 4 of 4:
    346.5574872980695 vs 346.55748729806896, tolerance 2e-15 > 1e-15
    661.7345909344504 vs 661.7345909344492, tolerance 2e-15 > 1e-15
    354.50067371488416 vs 354.50067371488353, tolerance 2e-15 > 1e-15
    677.4247827652946 vs 677.4247827652937, tolerance 2e-15 > 1e-15
**********************************************************************
1 item had failures:
   1 of  17 in sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense.exp
    [224 tests, 1 failure, 5.48 s]
**********************************************************************
File "src/sage/modules/free_module_element.pyx", line 1687, in sage.modules.free_module_element.FreeModuleElement.norm
Failed example:
    v.norm(5)
Expected:
    3.077384885394063
Got:
    3.0773848853940633
**********************************************************************
1 item had failures:
   1 of  24 in sage.modules.free_module_element.FreeModuleElement.norm
    [1081 tests, 1 failure, 5.08 s]
**********************************************************************
File "src/sage/modules/vector_real_double_dense.pyx", line 7, in sage.modules.vector_real_double_dense
Failed example:
    v
Expected:
    (1.0, 3.141592653589793, 1.414213562373095)
Got:
    (1.0, 3.141592653589793, 1.4142135623730951)
**********************************************************************
File "src/sage/modules/vector_real_double_dense.pyx", line 14, in sage.modules.vector_real_double_dense
Failed example:
    v
Expected:
    (5.0, 3.141592653589793, 1.414213562373095)
Got:
    (5.0, 3.141592653589793, 1.4142135623730951)
**********************************************************************
1 item had failures:
   2 of   8 in sage.modules.vector_real_double_dense
    [19 tests, 2 failures, 10.89 s]
**********************************************************************
File "src/sage/rings/complex_double.pyx", line 1136, in sage.rings.complex_double.ComplexDoubleElement._latex_
Failed example:
    z._latex_()
Expected:
    '-6.443164690985956 \\times 10^{34} - 6.113241307762409 \\times 10^{34}i'
Got:
    '-6.443164690985963 \\times 10^{34} - 6.113241307762415 \\times 10^{34}i'
**********************************************************************
File "src/sage/rings/complex_double.pyx", line 1685, in sage.rings.complex_double.ComplexDoubleElement._pow_
Failed example:
    CDF(-0.26319743704743886) ^ -2
Expected:
    14.435661446561994
Got:
    14.435661446561992
**********************************************************************
File "src/sage/rings/complex_double.pyx", line 1936, in sage.rings.complex_double.ComplexDoubleElement.arccos
Failed example:
    CDF(1,1).arccos()
Expected:
    0.9045568943023814 - 1.0612750619050357*I
Got:
    0.9045568943023815 - 1.0612750619050357*I
**********************************************************************
File "src/sage/rings/complex_double.pyx", line 2115, in sage.rings.complex_double.ComplexDoubleElement.arccosh
Failed example:
    CDF(1,1).arccosh()
Expected:
    1.0612750619050357 + 0.9045568943023814*I
Got:
    1.0612750619050357 + 0.9045568943023815*I
**********************************************************************
4 items had failures:
   1 of   4 in sage.rings.complex_double.ComplexDoubleElement._latex_
   1 of  19 in sage.rings.complex_double.ComplexDoubleElement._pow_
   1 of   2 in sage.rings.complex_double.ComplexDoubleElement.arccos
   1 of   2 in sage.rings.complex_double.ComplexDoubleElement.arccosh
    [341 tests, 4 failures, 0.27 s]
**********************************************************************
File "src/sage/rings/complex_mpc.pyx", line 1524, in sage.rings.complex_mpc.MPComplexNumber.__abs__
Failed example:
    float(sqrt(2^2 + 1^1))
Expected:
    2.23606797749979
Got:
    2.2360679774997894
**********************************************************************
1 item had failures:
   1 of  10 in sage.rings.complex_mpc.MPComplexNumber.__abs__
    [410 tests, 1 failure, 0.21 s]
**********************************************************************
File "src/sage/rings/complex_mpfr.pyx", line 1885, in sage.rings.complex_mpfr.ComplexNumber.__abs__
Failed example:
    float(sqrt(2^2 + 1^1))
Expected:
    2.23606797749979
Got:
    2.2360679774997894
**********************************************************************
1 item had failures:
   1 of   9 in sage.rings.complex_mpfr.ComplexNumber.__abs__
    [539 tests, 1 failure, 1.78 s]
**********************************************************************
File "src/sage/rings/number_field/number_field_element.pyx", line 1640, in sage.rings.number_field.number_field_element.NumberFieldElement.is_norm
Failed example:
    t = (-a).is_norm(L, element=True); t
Expected:
    (True, -b^3 - 1)
Got:
    (True, b^3 - 1)
**********************************************************************
File "src/sage/rings/number_field/number_field_element.pyx", line 1755, in sage.rings.number_field.number_field_element.NumberFieldElement._rnfisnorm
Failed example:
    t = (-a)._rnfisnorm(L); t
Expected:
    (-b^3 - 1, 1)
Got:
    (b^3 - 1, 1)
**********************************************************************
File "src/sage/rings/number_field/number_field_element.pyx", line 1759, in sage.rings.number_field.number_field_element.NumberFieldElement._rnfisnorm
Failed example:
    t = K(3)._rnfisnorm(L); t
Expected:
    (b^3 + a*b^2 + a^2*b - 1, 3*a^2 - 3*a + 6)
Got:
    (-b^3 + a*b^2 - a^2*b - 1, 3*a^2 - 3*a + 6)
**********************************************************************
2 items had failures:
   2 of  27 in sage.rings.number_field.number_field_element.NumberFieldElement._rnfisnorm
   1 of  28 in sage.rings.number_field.number_field_element.NumberFieldElement.is_norm
    [1168 tests, 3 failures, 14.02 s]
doctest:warning
  File "/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.10.8/lib/python3.10/threading.py", line 973, in _bootstrap
    self._bootstrap_inner()
  File "/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.10.8/lib/python3.10/threading.py", line 1002, in _bootstrap_inner
    self._set_tstate_lock()
  File "/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.10.8/lib/python3.10/threading.py", line 991, in _set_tstate_lock
    self._tstate_lock = _set_sentinel()
  File "/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.10.8/lib/python3.10/warnings.py", line 109, in _showwarnmsg
    sw(msg.message, msg.category, msg.filename, msg.lineno,
:
RuntimeWarning: cypari2 leaked 4032445012 bytes on the PARI stack
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 154, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_int
Failed example:
    base._pow_int(2^57)
Expected:
    78962960182680.42
Got:
    78962960182680.27
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 156, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_int
Failed example:
    base._pow_int(2^57 + 1)
Expected:
    78962960182680.42
Got:
    78962960182680.27
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 170, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_int
Failed example:
    base._pow_int(2^57)
Expected:
    78962960182680.42
Got:
    78962960182680.27
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 172, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_int
Failed example:
    base._pow_int(2^57 + 1)
Expected:
    -78962960182680.42
Got:
    -78962960182680.27
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 195, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_long
Failed example:
    base ^ (2^57)
Expected:
    78962960182680.42
Got:
    78962960182680.27
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 197, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_long
Failed example:
    base ^ RDF(2^57)
Expected:
    78962960182680.42
Got:
    78962960182680.27
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 384, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp
Failed example:
    a = r.exp(); a
Expected:
    106588847274864.47
Got:
    106588847274864.22
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 392, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp
Failed example:
    r.exp()
Expected:
    9.381844588498685e-15
Got:
    9.381844588498707e-15
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 418, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp2
Failed example:
    r.exp2()
Expected:
    4294967295.9999967
Got:
    4294967296.0
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 424, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp2
Failed example:
    r.exp2()
Expected:
    1.8911724825302065e-10
Got:
    1.8911724825302072e-10
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 445, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp10
Failed example:
    r.exp10()
Expected:
    1.0000000000000069e+32
Got:
    1.0000000000000062e+32
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 451, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp10
Failed example:
    r.exp10()
Expected:
    5.011872336272702e-33
Got:
    5.011872336272695e-33
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 651, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.acosh
Failed example:
    i = q.cosh(); i
Expected:
    2.5091784786580567
Got:
    2.509178478658056
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 665, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.arcsinh
Failed example:
    i = q.sinh(); i
Expected:
    2.3012989023072947
Got:
    2.3012989023072943
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 679, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.arctanh
Failed example:
    i = q.tanh(); i
Expected:
    0.9171523356672744
Got:
    0.9171523356672743
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 681, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.arctanh
Failed example:
    i.arctanh() - q  # rel tol 1
Expected:
    4.440892098500626e-16
Got:
    -4.440892098500626e-16
Tolerance exceeded:
    4.440892098500626e-16 vs -4.440892098500626e-16, tolerance 3e0 > 1e0
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 692, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.sech
Failed example:
    RDF(pi).sech()
Expected:
    0.08626673833405443
Got:
    0.08626673833405446
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 694, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.sech
Failed example:
    CDF(pi).sech()
Expected:
    0.08626673833405443
Got:
    0.08626673833405446
**********************************************************************
File "src/sage/rings/real_double_element_gsl.pyx", line 705, in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.csch
Failed example:
    RDF(pi).csch()
Expected:
    0.08658953753004694
Got:
    0.08658953753004697
**********************************************************************
10 items had failures:
   4 of  23 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_int
   2 of   8 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl._pow_long
   1 of   4 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.acosh
   1 of   4 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.arcsinh
   2 of   4 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.arctanh
   1 of   3 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.csch
   2 of   9 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp
   2 of   7 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp10
   2 of   7 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.exp2
   2 of   3 in sage.rings.real_double_element_gsl.RealDoubleElement_gsl.sech
    [145 tests, 19 failures, 0.06 s]
**********************************************************************
File "src/sage/stats/hmm/hmm.pyx", line 596, in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel._forward_scale
Failed example:
    m._forward_scale(stats.IntList([0,1]*10))
Expected:
    -14.378663512219454
Got:
    -14.378663512219456
**********************************************************************
File "src/sage/stats/hmm/hmm.pyx", line 601, in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel._forward_scale
Failed example:
    m.log_likelihood(stats.IntList([0,1]*10))
Expected:
    -14.378663512219454
Got:
    -14.378663512219456
**********************************************************************
1 item had failures:
   2 of   8 in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel._forward_scale
    [121 tests, 2 failures, 0.67 s]
**********************************************************************
File "src/sage/structure/element.pyx", line 2016, in sage.structure.element.Element.__pow__
Failed example:
    complex(1,2)**(1/2)
Expected:
    (1.272019649514069+0.786151377757423...j)
Got:
    (1.2720196495140692+0.7861513777574234j)
**********************************************************************
1 item had failures:
   1 of  24 in sage.structure.element.Element.__pow__
    [756 tests, 1 failure, 12.71 s]
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 1659, in sage.symbolic.expression.Expression._convert
Failed example:
    f._convert({'parent':RDF})
Expected:
    -1.40006081533995
Got:
    -1.4000608153399503
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 7581, in sage.symbolic.expression.Expression.polynomial
Failed example:
    f.polynomial(CDF)   # abs tol 5e-16
Expected:
    54.598150033144236*x^4 - 20.085536923187668*I*x^3 - 7.38905609893065*x^2 + 2.718281828459045*I*x + 1.0
Got:
    54.598150033144236*x^4 - 20.08553692318767*I*x^3 - 7.38905609893065*x^2 + 2.718281828459045*I*x + 1.0
Tolerance exceeded in 1 of 8:
    - 20.085536923187668 vs - 20.08553692318767, tolerance 3e-15 > 5e-16
**********************************************************************
2 items had failures:
   1 of  18 in sage.symbolic.expression.Expression._convert
   1 of  31 in sage.symbolic.expression.Expression.polynomial
    [3077 tests, 2 failures, 38.85 s]
**********************************************************************
File "src/sage_setup/autogen/interpreters/specs/cdf.py", line 57, in sage_setup.autogen.interpreters.specs.cdf.CDFInterpreter.__init__
Failed example:
    f(CDF(1+2j))  # rel tol 4e-16
Expected:
    -10391778.999999996 + 3349659.499999962*I
Got:
    -10391779.000000013 + 3349659.4999999646*I
Tolerance exceeded in 2 of 2:
    -10391778.999999996 vs -10391779.000000013, tolerance 2e-15 > 4e-16
    + 3349659.499999962 vs + 3349659.4999999646, tolerance 8e-16 > 4e-16
**********************************************************************
1 item had failures:
   1 of  20 in sage_setup.autogen.interpreters.specs.cdf.CDFInterpreter.__init__
    [19 tests, 1 failure, 0.08 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/calculus/calculus.py  # 3 doctests failed
sage -t --long --random-seed=0 src/sage/calculus/wester.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/categories/finite_coxeter_groups.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/dynamics/complex_dynamics/mandel_julia_helper.pyx  # 3 doctests failed
sage -t --long --random-seed=0 src/sage/functions/log.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/functions/trig.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/interacts/test_jupyter.rst  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/matrix/matrix_double_dense.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/matrix/matrix_symbolic_dense.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/modules/free_module_element.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/modules/vector_real_double_dense.pyx  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/rings/complex_double.pyx  # 4 doctests failed
sage -t --long --random-seed=0 src/sage/rings/complex_mpc.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/rings/complex_mpfr.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/rings/number_field/number_field_element.pyx  # 3 doctests failed
sage -t --long --random-seed=0 src/sage/rings/real_double_element_gsl.pyx  # 19 doctests failed
sage -t --long --random-seed=0 src/sage/stats/hmm/hmm.pyx  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/structure/element.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 2 doctests failed
sage -t --long --random-seed=0 src/sage_setup/autogen/interpreters/specs/cdf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 7092.1 seconds
    cpu time: 12138.2 seconds
    cumulative wall time: 12442.3 seconds
```

Full log: http://build.sagemath.org/#/builders/47/builds/14/steps/14/logs/stdio


---

Comment by vdelecroix created at 2022-12-18 13:21:04

Many of these numerical noises do not involve PARI/GP at all!


---

Comment by dimpase created at 2022-12-18 13:49:16

Indeed, e.g.

```
File "src/sage/calculus/calculus.py", line 772, in sage.calculus.calculus.?
Failed example:
    float(f)
Expected:
    -480.0
Got:
    -2336.0
```

and ensuing error in this file have nothing to do with Pari.
Are we still supporting 32-bit seriously? 
Indeed, these 32-bit errors should have been caught elsewhere.


I wonder whether Pari 2.15.1 passes its selftests on 32-bit, too.


---

Comment by tornaria created at 2022-12-18 14:19:35

Fix:
https://github.com/void-linux/void-packages/blob/master/srcpkgs/pari/patches/float32.patch

All tests pass on void linux i686 (using that patch on pari).


---

Comment by tornaria created at 2022-12-18 14:56:12

BTW, I've just submitted a report upstream to the pari bug tracker, which I had neglected to do before.


---

Comment by vbraun created at 2022-12-18 16:41:34

Replying to [comment:103 Vincent Delecroix]:
> Many of these numerical noises do not involve PARI/GP at all!

tests run fine without this ticket tho...


---

Comment by dimpase created at 2022-12-18 18:55:43

Replying to [comment:107 Volker Braun]:
> Replying to [comment:103 Vincent Delecroix]:
> > Many of these numerical noises do not involve PARI/GP at all!
> 
> tests run fine without this ticket tho...

The offending Pari commit, reverted by Gonzalo's patch, is not in 2.13.3, but is in 2.15.1.
Maybe it flips FPU switches somewhere...


---

Comment by tornaria created at 2022-12-18 19:14:56

Replying to [comment:108 Dima Pasechnik]:
> Replying to [comment:107 Volker Braun]:
> > Replying to [comment:103 Vincent Delecroix]:
> > > Many of these numerical noises do not involve PARI/GP at all!
> > 
> > tests run fine without this ticket tho...
> 
> The offending Pari commit, reverted by Gonzalo's patch, is not in 2.13.3, but is in 2.15.1.
> Maybe it flips FPU switches somewhere...

Precisely. The 387 fpu has a switch to choose between 64-bit (double) and 80-bit (long double) arithmetic. The problem is that transcendental functions depend on 80 bit arithmetic to give accurate 64 bit results 🤦‍♂️

Just linking to pari (without even initializing it) will affect a program, as demonstrated in the test program in my commit message (https://github.com/void-linux/void-packages/blob/master/srcpkgs/pari/patches/float32.patch).

Maybe it is possible to override the -mpc64 setting in pari library by explicitly adding -mpc80 to the linking step of sage. Or adding code in sage init to explicitly initialize the FPU to a safe mode.

Be warned that removing the `-mpc64` flag in pari might result in some numerical differences on pari itself due to 80 bit precission. In void linux we compile pari with `-ffloat-store` which avoids this issue.


---

Comment by tornaria created at 2022-12-18 19:18:48

https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2435


---

Comment by dimpase created at 2022-12-21 09:36:44

should we proceed with the Gonzalo's patch ? 

the upstream is clearly wrong in applying this change unconditionally, IMHO
