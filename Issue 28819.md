# Issue 28819: numpy: make numpy find openblas from Homebrew

Issue created by migration from https://trac.sagemath.org/ticket/29056

Original creator: @mwageringel

Original creation time: 2020-01-20 19:48:40

CC:  dimpase mkoeppe

Keywords: numpy, scipy

For numpy to find Homebrew's openblas on macOS, this ticket adds an `[openblas]` section to numpy's site.cfg if Sage is using openblas. This is also what Homebrew's [numpy formula](https://github.com/Homebrew/homebrew-core/blob/f2463cbba086689c872cddd3a8bc242976a603ff/Formula/numpy.rb#L25-L30) does. See also the upstream [site.cfg.example](https://github.com/numpy/numpy/blob/2199ba7fb7f8bb383552fdcd6feec4faee7ae394/site.cfg.example#L129-L132).

Before this ticket, numpy would use the macOS Accelerate framework instead of openblas, as can be seen from the logs:


```
  FOUND:
    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']
    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']
    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]
```


After:


```
  FOUND:
    libraries = ['openblas', 'openblas']
    library_dirs = ['/usr/local/Cellar/openblas/0.3.7/lib']
    language = c
    define_macros = [('HAVE_CBLAS', None)]
```


This problem was previously discussed on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/91e0GfHT-Yo).



---

Comment by @mwageringel created at 2020-01-20 19:54:21

In order to test this, one currently needs to force-link Homebrew's readline to `/usr/local` (#29000) and configure Sage with

```
./configure LDFLAGS="-L/usr/local/opt/openblas/lib" CPPFLAGS="-I/usr/local/opt/openblas/include" PKG_CONFIG_PATH="/usr/local/opt/openblas/lib/pkgconfig"
```

as openblas is keg-only.
----
New commits:


---

Comment by @mwageringel created at 2020-01-20 19:54:21

Changing priority from major to minor.


---

Comment by @mwageringel created at 2020-01-20 19:54:21

Changing status from new to needs_review.


---

Comment by git created at 2020-01-22 07:36:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-22 10:08:48

won't you be getting `KeyError` in the case of pkg-config not available (and so pkgconfig creating empty dicts)?


---

Comment by git created at 2020-01-25 17:22:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2020-01-25 17:31:45

Replying to [comment:3 dimpase]:
> won't you be getting `KeyError` in the case of pkg-config not available (and so pkgconfig creating empty dicts)?

Is pkg-config not always present, possibly by installing the pkgconf spkg? In any case, I changed the relevant line to account for the possibility of an empty dictionary:

```diff
-    if 'openblas' in pc_blas['libraries']:
+    if 'openblas' in pc_blas.get('libraries', []):
```


I have tested this on 9.1.beta1 both using openblas from Homebrew and from Sage and in each case both numpy and scipy find the correct openblas.


---

Comment by dimpase created at 2020-01-26 11:10:50

could this be made dependent on #29051 ?


---

Comment by @mwageringel created at 2020-01-26 16:25:22

Of course. Let us postpone this then.


---

Comment by dimpase created at 2020-01-26 18:08:44

perhaps MacOS with pkg-config  and openblas may be handled the same way as the "generic" systems by this script.


---

Comment by @mwageringel created at 2020-01-26 18:27:36

Replying to [comment:8 dimpase]:
> perhaps MacOS with pkg-config  and openblas may be handled the same way as the "generic" systems by this script.

You mean by removing the Darwin if-case? I tried that first, but for some reason it did not work, possibly because Numpy has the [preference](https://docs.scipy.org/doc/numpy/user/building.html#blas): OpenBLAS > Accelerate > BLAS/LAPACK.

This preference can be changed using the variables `NPY_BLAS_ORDER`/`NPY_LAPACK_ORDER`, but setting these in Numpy's `spkg-install` did not seem to help either.


---

Comment by mkoeppe created at 2020-01-29 19:07:14

I would suggest to also add #29071, #29084 as prereqs


---

Comment by mkoeppe created at 2020-01-29 21:38:48

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-01-29 21:38:48

I've merged in the tickets mentioned above and tested using `tox -e local-homebrew-macos-standard` from #29104.
----
New commits:


---

Comment by @mwageringel created at 2020-01-29 22:02:39

Thank you.


---

Comment by vbraun created at 2020-01-31 23:49:14

Resolution: fixed
