# Issue 27239: Add patch to zn_poly for support for Python 2.6

archive/issues_027239.json:
```json
{
    "body": "CC:  jdemeyer embray\n\nWe change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27476\n\n",
    "created_at": "2019-03-12T23:12:41Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Add patch to zn_poly for support for Python 2.6",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27239",
    "user": "tscrim"
}
```
CC:  jdemeyer embray

We change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.

Issue created by migration from https://trac.sagemath.org/ticket/27476





---

archive/issue_comments_383772.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-12T23:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383772",
    "user": "tscrim"
}
```

New commits:



---

archive/issue_comments_383773.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-12T23:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383773",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_383774.json:
```json
{
    "body": "Travis, can you please confirm that this actually works with Python 2.6?",
    "created_at": "2019-03-13T06:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383774",
    "user": "jdemeyer"
}
```

Travis, can you please confirm that this actually works with Python 2.6?



---

archive/issue_comments_383775.json:
```json
{
    "body": "Yes, I rebuilt it on my university's cluster.",
    "created_at": "2019-03-13T07:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383775",
    "user": "tscrim"
}
```

Yes, I rebuilt it on my university's cluster.



---

archive/issue_comments_383776.json:
```json
{
    "body": "I also built it on a different machine that also did not have Python 2.7.",
    "created_at": "2019-03-14T02:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383776",
    "user": "tscrim"
}
```

I also built it on a different machine that also did not have Python 2.7.



---

archive/issue_comments_383777.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-14T09:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383777",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_383778.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-15T08:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383778",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_383779.json:
```json
{
    "body": "This breaks the build with python3 on my machine, apparently.\n\n```\n[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] Finished extraction\n[zn_poly-0.9.1.p0] Applying patches from ../patches...\n[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch\n[zn_poly-0.9.1.p0] patching file makemakefile.py\n[zn_poly-0.9.1.p0] Hunk #1 FAILED at 151.\n[zn_poly-0.9.1.p0] Hunk #2 FAILED at 161.\n[zn_poly-0.9.1.p0] Hunk #3 FAILED at 177.\n[zn_poly-0.9.1.p0] Hunk #4 FAILED at 205.\n[zn_poly-0.9.1.p0] 4 out of 4 hunks FAILED -- saving rejects to file makemakefile.py.rej\n[zn_poly-0.9.1.p0] Error applying '../patches/python_2_6_format_support.patch'\n```\n\nEDIT: maybe a conflict between patches with `build/pkgs/zn_poly/patches/python3.patch`",
    "created_at": "2019-03-20T08:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383779",
    "user": "chapoton"
}
```

This breaks the build with python3 on my machine, apparently.

```
[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Finished extraction
[zn_poly-0.9.1.p0] Applying patches from ../patches...
[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] Hunk #1 FAILED at 151.
[zn_poly-0.9.1.p0] Hunk #2 FAILED at 161.
[zn_poly-0.9.1.p0] Hunk #3 FAILED at 177.
[zn_poly-0.9.1.p0] Hunk #4 FAILED at 205.
[zn_poly-0.9.1.p0] 4 out of 4 hunks FAILED -- saving rejects to file makemakefile.py.rej
[zn_poly-0.9.1.p0] Error applying '../patches/python_2_6_format_support.patch'
```

EDIT: maybe a conflict between patches with `build/pkgs/zn_poly/patches/python3.patch`



---

archive/issue_comments_383780.json:
```json
{
    "body": "Building with Python 2 or Python 3 wouldn't make any difference in that: The patches are applied the same way to the same sources either way, and Python doesn't enter into it.",
    "created_at": "2019-03-20T08:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383780",
    "user": "embray"
}
```

Building with Python 2 or Python 3 wouldn't make any difference in that: The patches are applied the same way to the same sources either way, and Python doesn't enter into it.



---

archive/issue_comments_383781.json:
```json
{
    "body": "So any other idea ?",
    "created_at": "2019-03-20T08:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383781",
    "user": "chapoton"
}
```

So any other idea ?



---

archive/issue_comments_383782.json:
```json
{
    "body": "The python3 builds works on another machine..",
    "created_at": "2019-03-20T08:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383782",
    "user": "chapoton"
}
```

The python3 builds works on another machine..



---

archive/issue_comments_383783.json:
```json
{
    "body": "Replying to [comment:10 chapoton]:\n> So any other idea ? \n\nDo you happen to have patched `zn_poly` yourself? What does `git status` say?",
    "created_at": "2019-03-20T09:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383783",
    "user": "jdemeyer"
}
```

Replying to [comment:10 chapoton]:
> So any other idea ? 

Do you happen to have patched `zn_poly` yourself? What does `git status` say?



---

archive/issue_comments_383784.json:
```json
{
    "body": "Let's see what the release manager says...",
    "created_at": "2019-03-20T09:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383784",
    "user": "jdemeyer"
}
```

Let's see what the release manager says...



---

archive/issue_comments_383785.json:
```json
{
    "body": "Replying to [comment:10 chapoton]:\n> So any other idea ? \n\nIt worked fine on my python3 build:\n\n\n```\n[zn_poly-0.9.1.p0] Found local metadata for zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] Using cached file /home/embray/src/sagemath/sage-python3/upstream/zn_poly-0.9.1.tar.gz\n[zn_poly-0.9.1.p0] zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] ====================================================\n[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] Finished extraction\n[zn_poly-0.9.1.p0] Applying patches from ../patches...\n[zn_poly-0.9.1.p0] Applying ../patches/python3.patch\n[zn_poly-0.9.1.p0] patching file makemakefile.py\n[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch\n[zn_poly-0.9.1.p0] patching file makemakefile.py\n[zn_poly-0.9.1.p0] ****************************************************\n```\n\n\nIn your log snippet it didn't show `Applying ../patches/python3.patch` first.  Was it present?  I wonder if it's possible t was missing for you somehow, or if the patches were being applied in a different order.",
    "created_at": "2019-03-20T09:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383785",
    "user": "embray"
}
```

Replying to [comment:10 chapoton]:
> So any other idea ? 

It worked fine on my python3 build:


```
[zn_poly-0.9.1.p0] Found local metadata for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Using cached file /home/embray/src/sagemath/sage-python3/upstream/zn_poly-0.9.1.tar.gz
[zn_poly-0.9.1.p0] zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] ====================================================
[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Finished extraction
[zn_poly-0.9.1.p0] Applying patches from ../patches...
[zn_poly-0.9.1.p0] Applying ../patches/python3.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] ****************************************************
```


In your log snippet it didn't show `Applying ../patches/python3.patch` first.  Was it present?  I wonder if it's possible t was missing for you somehow, or if the patches were being applied in a different order.



---

archive/issue_comments_383786.json:
```json
{
    "body": "I have not patched zn_poly myself.\n\nThe python3 patch is not present in my log snippet, indeed. How is the order of patches determined ?\n\nEDIT: the python3 patch is present in the patches subdirectory\n\nEDIT: monkey-skipping the patch-apply failure, the build of zn_poly works..",
    "created_at": "2019-03-20T09:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383786",
    "user": "chapoton"
}
```

I have not patched zn_poly myself.

The python3 patch is not present in my log snippet, indeed. How is the order of patches determined ?

EDIT: the python3 patch is present in the patches subdirectory

EDIT: monkey-skipping the patch-apply failure, the build of zn_poly works..



---

archive/issue_comments_383787.json:
```json
{
    "body": "There *is* something strange going on here I think.  Alphanumerically, python3 should come before python_2_6_format_patch since ascii '3' is less than ascii '_'.  \n\nAnd indeed, when I run `./sage -f zn_poly` any number of times it always applies these patches in the correct order.  But if I manually cd into the build directory and run `sage-apply-patches` it applies them in the wrong order.  Maybe a shell option somewhere?",
    "created_at": "2019-03-20T10:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383787",
    "user": "embray"
}
```

There *is* something strange going on here I think.  Alphanumerically, python3 should come before python_2_6_format_patch since ascii '3' is less than ascii '_'.  

And indeed, when I run `./sage -f zn_poly` any number of times it always applies these patches in the correct order.  But if I manually cd into the build directory and run `sage-apply-patches` it applies them in the wrong order.  Maybe a shell option somewhere?



---

archive/issue_comments_383788.json:
```json
{
    "body": "You might want to check your `LC_COLLATE` environment variable, or possibly other related LC_ variables.  To be in the safe side it might be best if `sage-apply-patches` explicitly called `sort` over the patches.",
    "created_at": "2019-03-20T10:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383788",
    "user": "embray"
}
```

You might want to check your `LC_COLLATE` environment variable, or possibly other related LC_ variables.  To be in the safe side it might be best if `sage-apply-patches` explicitly called `sort` over the patches.



---

archive/issue_comments_383789.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Let's see what the release manager says...\n\nThis is already merged (I missed that) so it passes on the buildbot...",
    "created_at": "2019-03-20T10:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383789",
    "user": "jdemeyer"
}
```

Replying to [comment:13 jdemeyer]:
> Let's see what the release manager says...

This is already merged (I missed that) so it passes on the buildbot...



---

archive/issue_comments_383790.json:
```json
{
    "body": "Try this patch and see if it fixes for you.  If so, we'll make a ticket for it\n\n\n```diff\ndiff --git a/build/bin/sage-apply-patches b/build/bin/sage-apply-patches\nindex 522116e..88d0601 100755\n--- a/build/bin/sage-apply-patches\n+++ b/build/bin/sage-apply-patches\n@@ -57,6 +57,11 @@ while [[ $# > 0 ]]; do\n     shift\n done\n\n+# The locale can have some strange effects on how filename are sorted depending\n+# on the LC_COLLATE variable, so ensure that it's \"C\" (basically ASCII order)\n+# so that patches are applied in a sensible roder\n+export LC_COLLATE=\"C\"\n+\n patchdir=\"${patchdir}/${patch_subdir}\"\n patchdir=\"${patchdir%/}\"\n patches=( \"${patchdir}\"/*.patch )\n```\n",
    "created_at": "2019-03-20T10:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383790",
    "user": "embray"
}
```

Try this patch and see if it fixes for you.  If so, we'll make a ticket for it


```diff
diff --git a/build/bin/sage-apply-patches b/build/bin/sage-apply-patches
index 522116e..88d0601 100755
--- a/build/bin/sage-apply-patches
+++ b/build/bin/sage-apply-patches
@@ -57,6 +57,11 @@ while [[ $# > 0 ]]; do
     shift
 done

+# The locale can have some strange effects on how filename are sorted depending
+# on the LC_COLLATE variable, so ensure that it's "C" (basically ASCII order)
+# so that patches are applied in a sensible roder
+export LC_COLLATE="C"
+
 patchdir="${patchdir}/${patch_subdir}"
 patchdir="${patchdir%/}"
 patches=( "${patchdir}"/*.patch )
```




---

archive/issue_comments_383791.json:
```json
{
    "body": "Another option might be to combine the two patches into 1 so there is no possibility of conflicts due to ordering.",
    "created_at": "2019-03-20T10:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383791",
    "user": "tscrim"
}
```

Another option might be to combine the two patches into 1 so there is no possibility of conflicts due to ordering.



---

archive/issue_comments_383792.json:
```json
{
    "body": "There is no LC_COLLATE variable in this machine bash configuration. I get very standard\n\n```\n~$ echo $LC_ALL \nen_US.UTF-8\n~$ echo $LANG\nen_US.UTF-8\n```\n\nand\n\n```\n~$ lsb_release -a \nNo LSB modules are available.\nDistributor ID:\tUbuntu\nDescription:\tUbuntu 16.04.5 LTS\nRelease:\t16.04\nCodename:\txenial\n```\n",
    "created_at": "2019-03-20T12:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383792",
    "user": "chapoton"
}
```

There is no LC_COLLATE variable in this machine bash configuration. I get very standard

```
~$ echo $LC_ALL 
en_US.UTF-8
~$ echo $LANG
en_US.UTF-8
```

and

```
~$ lsb_release -a 
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 16.04.5 LTS
Release:	16.04
Codename:	xenial
```




---

archive/issue_comments_383793.json:
```json
{
    "body": "New ticket, guys",
    "created_at": "2019-03-20T14:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383793",
    "user": "vbraun"
}
```

New ticket, guys



---

archive/issue_comments_383794.json:
```json
{
    "body": "I made #28322 for the patch-related problem.",
    "created_at": "2019-08-04T14:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27239#issuecomment-383794",
    "user": "chapoton"
}
```

I made #28322 for the patch-related problem.
