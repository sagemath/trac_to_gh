# Issue 27239: Add patch to zn_poly for support for Python 2.6

Issue created by migration from https://trac.sagemath.org/ticket/27476

Original creator: tscrim

Original creation time: 2019-03-12 23:12:41

CC:  jdemeyer embray

We change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.


---

Comment by tscrim created at 2019-03-12 23:13:22

New commits:


---

Comment by tscrim created at 2019-03-12 23:13:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-03-13 06:44:39

Travis, can you please confirm that this actually works with Python 2.6?


---

Comment by tscrim created at 2019-03-13 07:08:56

Yes, I rebuilt it on my university's cluster.


---

Comment by tscrim created at 2019-03-14 02:26:19

I also built it on a different machine that also did not have Python 2.7.


---

Comment by jdemeyer created at 2019-03-14 09:00:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-15 08:09:34

Resolution: fixed


---

Comment by chapoton created at 2019-03-20 08:37:16

This breaks the build with python3 on my machine, apparently.

```
[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Finished extraction
[zn_poly-0.9.1.p0] Applying patches from ../patches...
[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] Hunk #1 FAILED at 151.
[zn_poly-0.9.1.p0] Hunk #2 FAILED at 161.
[zn_poly-0.9.1.p0] Hunk #3 FAILED at 177.
[zn_poly-0.9.1.p0] Hunk #4 FAILED at 205.
[zn_poly-0.9.1.p0] 4 out of 4 hunks FAILED -- saving rejects to file makemakefile.py.rej
[zn_poly-0.9.1.p0] Error applying '../patches/python_2_6_format_support.patch'
```

EDIT: maybe a conflict between patches with `build/pkgs/zn_poly/patches/python3.patch`


---

Comment by embray created at 2019-03-20 08:42:10

Building with Python 2 or Python 3 wouldn't make any difference in that: The patches are applied the same way to the same sources either way, and Python doesn't enter into it.


---

Comment by chapoton created at 2019-03-20 08:43:16

So any other idea ?


---

Comment by chapoton created at 2019-03-20 08:45:01

The python3 builds works on another machine..


---

Comment by jdemeyer created at 2019-03-20 09:11:19

Replying to [comment:10 chapoton]:
> So any other idea ? 

Do you happen to have patched `zn_poly` yourself? What does `git status` say?


---

Comment by jdemeyer created at 2019-03-20 09:13:18

Let's see what the release manager says...


---

Comment by embray created at 2019-03-20 09:19:03

Replying to [comment:10 chapoton]:
> So any other idea ? 

It worked fine on my python3 build:


```
[zn_poly-0.9.1.p0] Found local metadata for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Using cached file /home/embray/src/sagemath/sage-python3/upstream/zn_poly-0.9.1.tar.gz
[zn_poly-0.9.1.p0] zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] ====================================================
[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Finished extraction
[zn_poly-0.9.1.p0] Applying patches from ../patches...
[zn_poly-0.9.1.p0] Applying ../patches/python3.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] ****************************************************
```


In your log snippet it didn't show `Applying ../patches/python3.patch` first.  Was it present?  I wonder if it's possible t was missing for you somehow, or if the patches were being applied in a different order.


---

Comment by chapoton created at 2019-03-20 09:38:15

I have not patched zn_poly myself.

The python3 patch is not present in my log snippet, indeed. How is the order of patches determined ?

EDIT: the python3 patch is present in the patches subdirectory

EDIT: monkey-skipping the patch-apply failure, the build of zn_poly works..


---

Comment by embray created at 2019-03-20 10:11:36

There _is_ something strange going on here I think.  Alphanumerically, python3 should come before python_2_6_format_patch since ascii '3' is less than ascii '_'.  

And indeed, when I run `./sage -f zn_poly` any number of times it always applies these patches in the correct order.  But if I manually cd into the build directory and run `sage-apply-patches` it applies them in the wrong order.  Maybe a shell option somewhere?


---

Comment by embray created at 2019-03-20 10:18:33

You might want to check your `LC_COLLATE` environment variable, or possibly other related LC_ variables.  To be in the safe side it might be best if `sage-apply-patches` explicitly called `sort` over the patches.


---

Comment by jdemeyer created at 2019-03-20 10:41:07

Replying to [comment:13 jdemeyer]:
> Let's see what the release manager says...

This is already merged (I missed that) so it passes on the buildbot...


---

Comment by embray created at 2019-03-20 10:45:11

Try this patch and see if it fixes for you.  If so, we'll make a ticket for it


```diff
diff --git a/build/bin/sage-apply-patches b/build/bin/sage-apply-patches
index 522116e..88d0601 100755
--- a/build/bin/sage-apply-patches
+++ b/build/bin/sage-apply-patches
@@ -57,6 +57,11 @@ while [[ $# > 0 ]]; do
     shift
 done

+# The locale can have some strange effects on how filename are sorted depending
+# on the LC_COLLATE variable, so ensure that it's "C" (basically ASCII order)
+# so that patches are applied in a sensible roder
+export LC_COLLATE="C"
+
 patchdir="${patchdir}/${patch_subdir}"
 patchdir="${patchdir%/}"
 patches=( "${patchdir}"/*.patch )
```



---

Comment by tscrim created at 2019-03-20 10:47:01

Another option might be to combine the two patches into 1 so there is no possibility of conflicts due to ordering.


---

Comment by chapoton created at 2019-03-20 12:40:53

There is no LC_COLLATE variable in this machine bash configuration. I get very standard

```
~$ echo $LC_ALL 
en_US.UTF-8
~$ echo $LANG
en_US.UTF-8
```

and

```
~$ lsb_release -a 
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 16.04.5 LTS
Release:	16.04
Codename:	xenial
```



---

Comment by vbraun created at 2019-03-20 14:40:26

New ticket, guys


---

Comment by chapoton created at 2019-08-04 14:39:17

I made #28322 for the patch-related problem.
