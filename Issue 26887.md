# Issue 26887: File manifests complete broken on OSX

archive/issues_026887.json:
```json
{
    "body": "CC:  @jhpalmieri\n\nThe JSON files written to `$SAGE_LOCAL/var/lib/sage/installed/` are syntactically invalid on OSX due to the filenames in the the `files` list not being quoted.  I believe this may be a regression introduced in #26011.  In particular the `sed` command in the line\n\n\n```\nFILE_LIST=\"$(echo \"$FILE_LIST\" | sed 's/^\\(.\\+\\)$/\"\\1\"/; 2,$s/^/        /; $!s/$/,/')\"\n```\n\n\ndoes not work at all correctly with the BSD sed on OSX.\n\nThe main impact of this is that packages cannot be properly uninstalled, which may in turn have had various snowball effects on OSX builds.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27124\n\n",
    "created_at": "2019-01-25T13:58:54Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "File manifests complete broken on OSX",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26887",
    "user": "https://github.com/embray"
}
```
CC:  @jhpalmieri

The JSON files written to `$SAGE_LOCAL/var/lib/sage/installed/` are syntactically invalid on OSX due to the filenames in the the `files` list not being quoted.  I believe this may be a regression introduced in #26011.  In particular the `sed` command in the line


```
FILE_LIST="$(echo "$FILE_LIST" | sed 's/^\(.\+\)$/"\1"/; 2,$s/^/        /; $!s/$/,/')"
```


does not work at all correctly with the BSD sed on OSX.

The main impact of this is that packages cannot be properly uninstalled, which may in turn have had various snowball effects on OSX builds.

Issue created by migration from https://trac.sagemath.org/ticket/27124





---

archive/issue_comments_377878.json:
```json
{
    "body": "This works for me. I can now uninstall packages successfully.\n\nNote that independent of this ticket, some manifests have empty file lists: gap, python3 (but not python2), libhomfly are some examples.\n\nEdit: I think I'm wrong about this. libhomfly is an example, but not the others: they have proper manifests.\n\n----\nNew commits:",
    "created_at": "2019-02-12T23:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377878",
    "user": "https://github.com/jhpalmieri"
}
```

This works for me. I can now uninstall packages successfully.

Note that independent of this ticket, some manifests have empty file lists: gap, python3 (but not python2), libhomfly are some examples.

Edit: I think I'm wrong about this. libhomfly is an example, but not the others: they have proper manifests.

----
New commits:



---

archive/issue_comments_377879.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-12T23:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377879",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_377880.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-13T18:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377880",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377881.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-13T19:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377881",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_377882.json:
```json
{
    "body": "I can't get this to work with Python: `$FILE_LIST` can be too long, apparently, at least the way I was trying to do things: something like\n\n```\nFILE_LIST=`sage-system-python -c \"from sys import argv; s = ',\\n      '.join(['\\\"' + x + '\\\"' for x in argv[1].split()]); print(s)\" \"$FILE_LIST\"`\n```\n\nThe file manifest for Python 3 was too long, so it ended up completely blank.\n\nI think I can do everything in bash, though. Ugly but it seems to work. I'll post a branch once I'm done building.",
    "created_at": "2019-02-13T20:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377882",
    "user": "https://github.com/jhpalmieri"
}
```

I can't get this to work with Python: `$FILE_LIST` can be too long, apparently, at least the way I was trying to do things: something like

```
FILE_LIST=`sage-system-python -c "from sys import argv; s = ',\n      '.join(['\"' + x + '\"' for x in argv[1].split()]); print(s)" "$FILE_LIST"`
```

The file manifest for Python 3 was too long, so it ended up completely blank.

I think I can do everything in bash, though. Ugly but it seems to work. I'll post a branch once I'm done building.



---

archive/issue_comments_377883.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-13T22:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377883",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377884.json:
```json
{
    "body": "Okay, let's try this.",
    "created_at": "2019-02-13T22:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377884",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, let's try this.



---

archive/issue_comments_377885.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-13T22:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377885",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_377886.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-13T22:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377886",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377887.json:
```json
{
    "body": "I think previously it *was* like this, and this bug was introduced when I tried to fix it, because Jeroen complained that the previous code was too slow on long file lists (this was #26011).  However, your version is using `+=` for string concatenation, which is a bash-ism.  That might be okay since I think the script requires bash anyways. What I don't know for sure (and maybe you do) is if this is any faster as a method of string concatenation (maybe it is!)\n\nA few weeks ago before I got side-tracked I started on a little Python script that would just generate the stamp file though, obviating the need for any fragile shell code for generating JSON :/",
    "created_at": "2019-02-21T13:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377887",
    "user": "https://github.com/embray"
}
```

I think previously it *was* like this, and this bug was introduced when I tried to fix it, because Jeroen complained that the previous code was too slow on long file lists (this was #26011).  However, your version is using `+=` for string concatenation, which is a bash-ism.  That might be okay since I think the script requires bash anyways. What I don't know for sure (and maybe you do) is if this is any faster as a method of string concatenation (maybe it is!)

A few weeks ago before I got side-tracked I started on a little Python script that would just generate the stamp file though, obviating the need for any fragile shell code for generating JSON :/



---

archive/issue_comments_377888.json:
```json
{
    "body": "The script starts with `#!/usr/bin/env bash`, so bash-isms are fine.\n\nI just checked some timings. On my machine, `boost_cropped` has one of the largest file manifests, and also the package itself is quick to install. With the `develop` branch:\n\n```\nreal\t0m21.080s\nuser\t0m7.821s\nsys\t0m12.785s\n```\n\nWith this branch:\n\n```\nreal\t0m21.285s\nuser\t0m7.959s\nsys\t0m12.966s\n```\n\nFor the `pari_galpol` packaged mentioned at #26011, with `develop`:\n\n```\nreal\t0m21.661s\nuser\t0m3.776s\nsys\t0m17.486s\n```\n\nWith this branch:\n\n```\nreal\t0m20.393s\nuser\t0m4.042s\nsys\t0m15.856s\n```\n\nSo timing is not an issue, I think.",
    "created_at": "2019-02-21T17:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377888",
    "user": "https://github.com/jhpalmieri"
}
```

The script starts with `#!/usr/bin/env bash`, so bash-isms are fine.

I just checked some timings. On my machine, `boost_cropped` has one of the largest file manifests, and also the package itself is quick to install. With the `develop` branch:

```
real	0m21.080s
user	0m7.821s
sys	0m12.785s
```

With this branch:

```
real	0m21.285s
user	0m7.959s
sys	0m12.966s
```

For the `pari_galpol` packaged mentioned at #26011, with `develop`:

```
real	0m21.661s
user	0m3.776s
sys	0m17.486s
```

With this branch:

```
real	0m20.393s
user	0m4.042s
sys	0m15.856s
```

So timing is not an issue, I think.



---

archive/issue_comments_377889.json:
```json
{
    "body": "With Python, by the way, I had problems feeding the whole file list to Python: for some packages it was too long for a command line argument. At some point, as you and others have said, it would be good to rewrite all of `sage-spkg` in Python, at which point this would be easy to handle.",
    "created_at": "2019-02-21T17:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377889",
    "user": "https://github.com/jhpalmieri"
}
```

With Python, by the way, I had problems feeding the whole file list to Python: for some packages it was too long for a command line argument. At some point, as you and others have said, it would be good to rewrite all of `sage-spkg` in Python, at which point this would be easy to handle.



---

archive/issue_comments_377890.json:
```json
{
    "body": "I'm also tempted to add a doctest:\n\n```diff\ndiff --git a/src/sage/misc/package.py b/src/sage/misc/package.py\nindex 8501acb53f..f2ea30aa44 100644\n--- a/src/sage/misc/package.py\n+++ b/src/sage/misc/package.py\n@@ -453,6 +453,41 @@ def experimental_packages():\n     return (sorted(pkg['name'] for pkg in pkgs if pkg['installed']),\n             sorted(pkg['name'] for pkg in pkgs if not pkg['installed']))\n \n+def package_manifest(package, package_type='standard'):\n+    \"\"\"\n+    Return the file manifest for ``package``.\n+\n+    INPUT:\n+\n+    - ``package`` -- package name\n+    - ``package_type`` (optional, default \"standard\") -- either\n+      \"standard\", \"optional\", or \"experimental\"\n+\n+    The manifest is written in the file\n+    ``SAGE_SPKG_INST/package-VERSION``. It is a JSON file containing\n+    dictionary with the package name, version, installation date, list\n+    of installed files, etc.\n+\n+    EXAMPLES::\n+\n+        sage: from sage.misc.packages import package_manifest\n+        sage: sagetex_manifest = package_manifest('sagetex')\n+        sage: sagetex_manifest == 'sagetex'\n+        True\n+        sage: 'files' in sagetex_manifest\n+        True\n+    \"\"\"\n+    version = package_versions(package_type)[package][0]\n+    stamp_file = os.path.join(os.environ['SAGE_SPKG_INST'],\n+                              '{}-{}'.format(package, version))\n+    spkg_meta = {}\n+    try:\n+        with open(stamp_file) as f:\n+            spkg_meta = json.load(f)\n+    except ValueError: # Error reading JSON file\n+        pass\n+    return spkg_meta\n+\n }}}\nIt probably needs more error checking that I want to do right now: is it actually a valid package name, etc.?",
    "created_at": "2019-02-21T18:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377890",
    "user": "https://github.com/jhpalmieri"
}
```

I'm also tempted to add a doctest:

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 8501acb53f..f2ea30aa44 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -453,6 +453,41 @@ def experimental_packages():
     return (sorted(pkg['name'] for pkg in pkgs if pkg['installed']),
             sorted(pkg['name'] for pkg in pkgs if not pkg['installed']))
 
+def package_manifest(package, package_type='standard'):
+    """
+    Return the file manifest for ``package``.
+
+    INPUT:
+
+    - ``package`` -- package name
+    - ``package_type`` (optional, default "standard") -- either
+      "standard", "optional", or "experimental"
+
+    The manifest is written in the file
+    ``SAGE_SPKG_INST/package-VERSION``. It is a JSON file containing
+    dictionary with the package name, version, installation date, list
+    of installed files, etc.
+
+    EXAMPLES::
+
+        sage: from sage.misc.packages import package_manifest
+        sage: sagetex_manifest = package_manifest('sagetex')
+        sage: sagetex_manifest == 'sagetex'
+        True
+        sage: 'files' in sagetex_manifest
+        True
+    """
+    version = package_versions(package_type)[package][0]
+    stamp_file = os.path.join(os.environ['SAGE_SPKG_INST'],
+                              '{}-{}'.format(package, version))
+    spkg_meta = {}
+    try:
+        with open(stamp_file) as f:
+            spkg_meta = json.load(f)
+    except ValueError: # Error reading JSON file
+        pass
+    return spkg_meta
+
 }}}
It probably needs more error checking that I want to do right now: is it actually a valid package name, etc.?



---

archive/issue_comments_377891.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> With Python, by the way, I had problems feeding the whole file list to Python: for some packages it was too long for a command line argument. At some point, as you and others have said, it would be good to rewrite all of `sage-spkg` in Python, at which point this would be easy to handle.\n\nYes, I had thought of maybe writing the list to a file and having the script read the list from that file.  I do want to rewrite that entire script in python too, but that's another issue.\n\nYour timings are helpful, thank you.  ISTM `+=` is much more efficient than repeated string interpolation like I had previously.\n\nThe utility function + tests sounds like a good idea.  Let's add that too.  I think that if it can't be parsed as a valid JSON document that *should* raise an error and not just silently return an empty dict.",
    "created_at": "2019-02-21T19:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377891",
    "user": "https://github.com/embray"
}
```

Replying to [comment:11 jhpalmieri]:
> With Python, by the way, I had problems feeding the whole file list to Python: for some packages it was too long for a command line argument. At some point, as you and others have said, it would be good to rewrite all of `sage-spkg` in Python, at which point this would be easy to handle.

Yes, I had thought of maybe writing the list to a file and having the script read the list from that file.  I do want to rewrite that entire script in python too, but that's another issue.

Your timings are helpful, thank you.  ISTM `+=` is much more efficient than repeated string interpolation like I had previously.

The utility function + tests sounds like a good idea.  Let's add that too.  I think that if it can't be parsed as a valid JSON document that *should* raise an error and not just silently return an empty dict.



---

archive/issue_comments_377892.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-21T20:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377892",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377893.json:
```json
{
    "body": "Okay, here is a doctest. It tests the manifest for `sagetex`, so I bumped the version number on that package to make sure that the new manifest gets built; otherwise this doctest will fail on OS X machines doing incremental upgrades.\n\nPeople should probably rebuild everything once this is in place to make sure they have valid file manifests, but I don't want to impose that.",
    "created_at": "2019-02-21T20:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377893",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, here is a doctest. It tests the manifest for `sagetex`, so I bumped the version number on that package to make sure that the new manifest gets built; otherwise this doctest will fail on OS X machines doing incremental upgrades.

People should probably rebuild everything once this is in place to make sure they have valid file manifests, but I don't want to impose that.



---

archive/issue_comments_377894.json:
```json
{
    "body": "Replying to [comment:15 jhpalmieri]:\n> People should probably rebuild everything once this is in place to make sure they have valid file manifests, but I don't want to impose that.\n\n\nYes, it's an unfortunate corner case in a way (just one that happens to affect anyone building Sage on OSX--too bad).\n\nThank you for the test.",
    "created_at": "2019-02-22T13:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377894",
    "user": "https://github.com/embray"
}
```

Replying to [comment:15 jhpalmieri]:
> People should probably rebuild everything once this is in place to make sure they have valid file manifests, but I don't want to impose that.


Yes, it's an unfortunate corner case in a way (just one that happens to affect anyone building Sage on OSX--too bad).

Thank you for the test.



---

archive/issue_comments_377895.json:
```json
{
    "body": "The line\n\n\n```diff\n+    spkg_meta = {}\n```\n\n\nis now superfluous but I can remove that in a squash, if you want.  Or if you get to it first that's fine too.",
    "created_at": "2019-02-22T13:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377895",
    "user": "https://github.com/embray"
}
```

The line


```diff
+    spkg_meta = {}
```


is now superfluous but I can remove that in a squash, if you want.  Or if you get to it first that's fine too.



---

archive/issue_comments_377896.json:
```json
{
    "body": "Another neat test would be to actually provide a schema for these files, and try to validate all of them against the schema.\n\nIf, in the off chance, someone is upgrading some very old SAGE_ROOT and has some files that don't fit the schema it could warn them that they should rebuild those packages.",
    "created_at": "2019-02-22T13:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377896",
    "user": "https://github.com/embray"
}
```

Another neat test would be to actually provide a schema for these files, and try to validate all of them against the schema.

If, in the off chance, someone is upgrading some very old SAGE_ROOT and has some files that don't fit the schema it could warn them that they should rebuild those packages.



---

archive/issue_comments_377897.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-22T17:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377897",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377898.json:
```json
{
    "body": "Replying to [comment:18 embray]:\n> Another neat test would be to actually provide a schema for these files, and try to validate all of them against the schema.\n> \n> If, in the off chance, someone is upgrading some very old SAGE_ROOT and has some files that don't fit the schema it could warn them that they should rebuild those packages.\n\nI think that would belong on a separate ticket; I want to get this problem fixed quickly.\n\nI'm also not sure how to do it. If it's a doctest, it would fail for everyone using OS X, unless it's lenient about the format. Or would it run (once?) when you start up Sage? What did you have in mind for a schema?",
    "created_at": "2019-02-22T18:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377898",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:18 embray]:
> Another neat test would be to actually provide a schema for these files, and try to validate all of them against the schema.
> 
> If, in the off chance, someone is upgrading some very old SAGE_ROOT and has some files that don't fit the schema it could warn them that they should rebuild those packages.

I think that would belong on a separate ticket; I want to get this problem fixed quickly.

I'm also not sure how to do it. If it's a doctest, it would fail for everyone using OS X, unless it's lenient about the format. Or would it run (once?) when you start up Sage? What did you have in mind for a schema?



---

archive/issue_comments_377899.json:
```json
{
    "body": "I think if the test failed that would be a good thing: It informs that that system still has some old stamp files either in the old format (before I made it a JSON format which was quite a few Sage versions ago now), or the system was affected by this bug in which case it would be good to rebuild and regenerate those files anyways.",
    "created_at": "2019-02-26T12:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377899",
    "user": "https://github.com/embray"
}
```

I think if the test failed that would be a good thing: It informs that that system still has some old stamp files either in the old format (before I made it a JSON format which was quite a few Sage versions ago now), or the system was affected by this bug in which case it would be good to rebuild and regenerate those files anyways.



---

archive/issue_comments_377900.json:
```json
{
    "body": "But I agree, it should be a separate issue.\n\nNot sure what the patchbots are saying about pyflakes.  I think it might just be bugginess on the patchbot's part.",
    "created_at": "2019-02-26T12:43:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377900",
    "user": "https://github.com/embray"
}
```

But I agree, it should be a separate issue.

Not sure what the patchbots are saying about pyflakes.  I think it might just be bugginess on the patchbot's part.



---

archive/issue_comments_377901.json:
```json
{
    "body": "I made #27363 for the schema idea.  I'm going to test this a bit on Windows but otherwise it looks good.",
    "created_at": "2019-02-26T12:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377901",
    "user": "https://github.com/embray"
}
```

I made #27363 for the schema idea.  I'm going to test this a bit on Windows but otherwise it looks good.



---

archive/issue_comments_377902.json:
```json
{
    "body": "Finally got a chance to test this.  Thanks again!",
    "created_at": "2019-03-01T13:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377902",
    "user": "https://github.com/embray"
}
```

Finally got a chance to test this.  Thanks again!



---

archive/issue_comments_377903.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-01T13:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377903",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_377904.json:
```json
{
    "body": "Thank you!",
    "created_at": "2019-03-01T18:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377904",
    "user": "https://github.com/jhpalmieri"
}
```

Thank you!



---

archive/issue_comments_377905.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-03T22:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377905",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067374.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-03T22:38:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26887#event-67374"
}
```



---

archive/issue_comments_377906.json:
```json
{
    "body": "The new doctest fails for me on distro, since there are no package manifests. Is there any point to those manifests on distro?",
    "created_at": "2019-04-06T12:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377906",
    "user": "https://github.com/timokau"
}
```

The new doctest fails for me on distro, since there are no package manifests. Is there any point to those manifests on distro?



---

archive/issue_comments_377907.json:
```json
{
    "body": "Can you point out where distro versions of Sage are documented? I don't know the answers to all sorts of basic questions:\n- do you ever run `sage -i PKG`? (Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.)\n- is there a directory `SAGE_ROOT`? If so, what subdirectories of it exist?\n- does `SAGE_SPKG_INST` exist?\nOne way to help make distro versions of Sage more prominent is to actually document them, probably in the developer's guide. That could be more efficient than having people with no distro experience make changes which break things.",
    "created_at": "2019-04-06T16:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377907",
    "user": "https://github.com/jhpalmieri"
}
```

Can you point out where distro versions of Sage are documented? I don't know the answers to all sorts of basic questions:
- do you ever run `sage -i PKG`? (Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.)
- is there a directory `SAGE_ROOT`? If so, what subdirectories of it exist?
- does `SAGE_SPKG_INST` exist?
One way to help make distro versions of Sage more prominent is to actually document them, probably in the developer's guide. That could be more efficient than having people with no distro experience make changes which break things.



---

archive/issue_comments_377908.json:
```json
{
    "body": "Replying to [comment:28 jhpalmieri]:\n> Can you point out where distro versions of Sage are documented?\n\nDoes https://wiki.sagemath.org/Distribution#Package_managers cover what you are looking for?\n\n> I don't know the answers to all sorts of basic questions:\n\nI can only speak for sage on nix with authority, but the answers will probably hold for other distros as well.\n\n> - do you ever run `sage -i PKG`? (Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.)\n\nNo, `sage -i` is never used. The package manager is responsible for installing and uninstalling packages.\n\n> - is there a directory `SAGE_ROOT`? If so, what subdirectories of it exist?\n\nIn the case of `nix` I just set `SAGE_ROOT` to a directory just containing the sage source code. I think that's not really important, I just do that to statisfy some doctest IIRC. Other distros will differ here. `SAGE_LOCAL` etc. are not subdirectories of `SAGE_ROOT` but explicitly set.\n\n> - does `SAGE_SPKG_INST` exist?\n\nNot sure what that is exactly. The only thing I do currently is create a file in `SAGE_LOCAL/installed` (that is probably `SAGE_SPKG_INST`?) for every installed dependency. The files are empty and again are mostly to statisfy some sage doctest that tries to determine weather or not a package is installed. This will hopefully become unnecessary at some point in the future due to #20382.\n\n> One way to help make distro versions of Sage more prominent is to actually document them, probably in the developer's guide. That could be more efficient than having people with no distro experience make changes which break things.\n\nThere is the wiki page, is that not enough? Not sure how much sage-the-project directly supports the distro packages.",
    "created_at": "2019-04-06T16:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377908",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:28 jhpalmieri]:
> Can you point out where distro versions of Sage are documented?

Does https://wiki.sagemath.org/Distribution#Package_managers cover what you are looking for?

> I don't know the answers to all sorts of basic questions:

I can only speak for sage on nix with authority, but the answers will probably hold for other distros as well.

> - do you ever run `sage -i PKG`? (Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.)

No, `sage -i` is never used. The package manager is responsible for installing and uninstalling packages.

> - is there a directory `SAGE_ROOT`? If so, what subdirectories of it exist?

In the case of `nix` I just set `SAGE_ROOT` to a directory just containing the sage source code. I think that's not really important, I just do that to statisfy some doctest IIRC. Other distros will differ here. `SAGE_LOCAL` etc. are not subdirectories of `SAGE_ROOT` but explicitly set.

> - does `SAGE_SPKG_INST` exist?

Not sure what that is exactly. The only thing I do currently is create a file in `SAGE_LOCAL/installed` (that is probably `SAGE_SPKG_INST`?) for every installed dependency. The files are empty and again are mostly to statisfy some sage doctest that tries to determine weather or not a package is installed. This will hopefully become unnecessary at some point in the future due to #20382.

> One way to help make distro versions of Sage more prominent is to actually document them, probably in the developer's guide. That could be more efficient than having people with no distro experience make changes which break things.

There is the wiki page, is that not enough? Not sure how much sage-the-project directly supports the distro packages.



---

archive/issue_comments_377909.json:
```json
{
    "body": "Replying to [comment:29 gh-timokau]:\n> Replying to [comment:28 jhpalmieri]:\n> > Can you point out where distro versions of Sage are documented?\n> \n> Does https://wiki.sagemath.org/Distribution#Package_managers cover what you are looking for?\n\nNo, because it doesn't answer my questions.\n> \n> > I don't know the answers to all sorts of basic questions:\n> \n> I can only speak for sage on nix with authority, but the answers will probably hold for other distros as well.\n> \n> > - do you ever run `sage -i PKG`? (Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.)\n> \n> No, `sage -i` is never used. The package manager is responsible for installing and uninstalling packages.\n> \n> > - is there a directory `SAGE_ROOT`? If so, what subdirectories of it exist?\n> \n> In the case of `nix` I just set `SAGE_ROOT` to a directory just containing the sage source code. I think that's not really important, I just do that to statisfy some doctest IIRC. Other distros will differ here. `SAGE_LOCAL` etc. are not subdirectories of `SAGE_ROOT` but explicitly set.\n> \n> > - does `SAGE_SPKG_INST` exist?\n> Not sure what that is exactly.\n\nIt's set to SAGE_LOCAL/var/lib/sage/installed in sage/env.py.\n\n> The only thing I do currently is create a file in `SAGE_LOCAL/installed` (that is probably `SAGE_SPKG_INST`?) for every installed dependency. The files are empty and again are mostly to statisfy some sage doctest that tries to determine weather or not a package is installed. This will hopefully become unnecessary at some point in the future due to #20382.\n> \n> > One way to help make distro versions of Sage more prominent is to actually document them, probably in the developer's guide. That could be more efficient than having people with no distro experience make changes which break things.\n> \n> There is the wiki page, is that not enough? Not sure how much sage-the-project directly supports the distro packages.\n\nThere should be guidance in the developer's guide about for example: what directories can be assumed to exist when writing code for the Sage library or Sage scripts, what sorts of doctests should be avoided and/or are incompatible with distros, etc.\n\nI'm not sure how much support there is, either. If you want more support, more documentation is always good.\n\n-------\n\nIn this particular case, the doctest could perhaps be changed to something like: if the directory `SAGE_SPKG_INST` exists, then check the validity of the file manifest.",
    "created_at": "2019-04-06T23:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377909",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:29 gh-timokau]:
> Replying to [comment:28 jhpalmieri]:
> > Can you point out where distro versions of Sage are documented?
> 
> Does https://wiki.sagemath.org/Distribution#Package_managers cover what you are looking for?

No, because it doesn't answer my questions.
> 
> > I don't know the answers to all sorts of basic questions:
> 
> I can only speak for sage on nix with authority, but the answers will probably hold for other distros as well.
> 
> > - do you ever run `sage -i PKG`? (Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.)
> 
> No, `sage -i` is never used. The package manager is responsible for installing and uninstalling packages.
> 
> > - is there a directory `SAGE_ROOT`? If so, what subdirectories of it exist?
> 
> In the case of `nix` I just set `SAGE_ROOT` to a directory just containing the sage source code. I think that's not really important, I just do that to statisfy some doctest IIRC. Other distros will differ here. `SAGE_LOCAL` etc. are not subdirectories of `SAGE_ROOT` but explicitly set.
> 
> > - does `SAGE_SPKG_INST` exist?
> Not sure what that is exactly.

It's set to SAGE_LOCAL/var/lib/sage/installed in sage/env.py.

> The only thing I do currently is create a file in `SAGE_LOCAL/installed` (that is probably `SAGE_SPKG_INST`?) for every installed dependency. The files are empty and again are mostly to statisfy some sage doctest that tries to determine weather or not a package is installed. This will hopefully become unnecessary at some point in the future due to #20382.
> 
> > One way to help make distro versions of Sage more prominent is to actually document them, probably in the developer's guide. That could be more efficient than having people with no distro experience make changes which break things.
> 
> There is the wiki page, is that not enough? Not sure how much sage-the-project directly supports the distro packages.

There should be guidance in the developer's guide about for example: what directories can be assumed to exist when writing code for the Sage library or Sage scripts, what sorts of doctests should be avoided and/or are incompatible with distros, etc.

I'm not sure how much support there is, either. If you want more support, more documentation is always good.

-------

In this particular case, the doctest could perhaps be changed to something like: if the directory `SAGE_SPKG_INST` exists, then check the validity of the file manifest.



---

archive/issue_comments_377910.json:
```json
{
    "body": "Replying to [comment:30 jhpalmieri]:\n> Replying to [comment:29 gh-timokau]:\n> > > - does `SAGE_SPKG_INST` exist?\n> > Not sure what that is exactly.\n> \n> It's set to SAGE_LOCAL/var/lib/sage/installed in sage/env.py.\n\nOh nevermind I misread my own build script. SAGE_LOCAL/var/lib/sage/installed is where I install those files to.\n\n> There should be guidance in the developer's guide about for example: what directories can be assumed to exist when writing code for the Sage library or Sage scripts, what sorts of doctests should be avoided and/or are incompatible with distros, etc.\n> \n> I'm not sure how much support there is, either. If you want more support, more documentation is always good.\n\nThe issue is that there is no central authority to say that there is or isn't support. But I think at least Erik has been pushing in the support direction.\n\n> In this particular case, the doctest could perhaps be changed to something like: if the directory `SAGE_SPKG_INST` exists, then check the validity of the file manifest.\n\nBack to my first question: what are the usecases for these manifests?\n\n\nAnd to answer your question: As a generalization, trac tickets that only touch \"sagelib\" (i.e. most stuff under `src/`, the actual math library) shouldn't need any special attention for distros. Similarly, everything that only changes the build system/\"package manager\"/\"sage-the-distro\" aspects of sage (most stuff under `build/`) should be fine, since distros don't use any of that.\n\nIssues are likely when a ticket touches both sagelib and sage-the-distro. For example when a package is updated and the sagelib doctests have to be adjusted because of some minor precision changes, all distros will have to cherry-pick the doctest fixes when they update the dependency (solution for this is not to limit the precision of the doctests to something realistic instead of just adjusting them with every dependency update). Another example is when, like it is the case here, aspects of the build system are tested. The nicest solution for this would be Erik's plan to separate sagelib and sage-the-distro. The whole `package.py` file doesn't serve any purpose on distros.\n\nSorry if this is a bit hard to follow, I can imagine the separation between sagelib and sage-the-distro is something non-packagers don't think about often. I'd be glad to clear up any unclarity. By the way, if you run a linux machine you could test-drive the sage nix package if you feel like it :)",
    "created_at": "2019-04-07T08:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377910",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:30 jhpalmieri]:
> Replying to [comment:29 gh-timokau]:
> > > - does `SAGE_SPKG_INST` exist?
> > Not sure what that is exactly.
> 
> It's set to SAGE_LOCAL/var/lib/sage/installed in sage/env.py.

Oh nevermind I misread my own build script. SAGE_LOCAL/var/lib/sage/installed is where I install those files to.

> There should be guidance in the developer's guide about for example: what directories can be assumed to exist when writing code for the Sage library or Sage scripts, what sorts of doctests should be avoided and/or are incompatible with distros, etc.
> 
> I'm not sure how much support there is, either. If you want more support, more documentation is always good.

The issue is that there is no central authority to say that there is or isn't support. But I think at least Erik has been pushing in the support direction.

> In this particular case, the doctest could perhaps be changed to something like: if the directory `SAGE_SPKG_INST` exists, then check the validity of the file manifest.

Back to my first question: what are the usecases for these manifests?


And to answer your question: As a generalization, trac tickets that only touch "sagelib" (i.e. most stuff under `src/`, the actual math library) shouldn't need any special attention for distros. Similarly, everything that only changes the build system/"package manager"/"sage-the-distro" aspects of sage (most stuff under `build/`) should be fine, since distros don't use any of that.

Issues are likely when a ticket touches both sagelib and sage-the-distro. For example when a package is updated and the sagelib doctests have to be adjusted because of some minor precision changes, all distros will have to cherry-pick the doctest fixes when they update the dependency (solution for this is not to limit the precision of the doctests to something realistic instead of just adjusting them with every dependency update). Another example is when, like it is the case here, aspects of the build system are tested. The nicest solution for this would be Erik's plan to separate sagelib and sage-the-distro. The whole `package.py` file doesn't serve any purpose on distros.

Sorry if this is a bit hard to follow, I can imagine the separation between sagelib and sage-the-distro is something non-packagers don't think about often. I'd be glad to clear up any unclarity. By the way, if you run a linux machine you could test-drive the sage nix package if you feel like it :)



---

archive/issue_comments_377911.json:
```json
{
    "body": "Replying to [comment:31 gh-timokau]:\n> Back to my first question: what are the usecases for these manifests?\n\nHere's what I said above: Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.\n\nThere was a bug in writing the manifests which caused packages to not be removed properly, and fixing that bug motivated the doctest.",
    "created_at": "2019-04-07T16:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377911",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:31 gh-timokau]:
> Back to my first question: what are the usecases for these manifests?

Here's what I said above: Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.

There was a bug in writing the manifests which caused packages to not be removed properly, and fixing that bug motivated the doctest.



---

archive/issue_comments_377912.json:
```json
{
    "body": "Maybe there should be a tag for doctests which are skipped by distros. If so, then in addition to being able to specify it directly when running \"sage -t\", maybe there could be a way of trying to intelligently detect whether to set it. That would require knowing what things hold in common among all of the distros and not for sage-the-distro: the existence of SAGE_ROOT/upstream, or some other directory or some file created just for this purpose: a file like `SAGE_ROOT/lib/sage-current-location.txt` which is written by sage-the-distro but not by everyone else.",
    "created_at": "2019-04-07T16:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377912",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe there should be a tag for doctests which are skipped by distros. If so, then in addition to being able to specify it directly when running "sage -t", maybe there could be a way of trying to intelligently detect whether to set it. That would require knowing what things hold in common among all of the distros and not for sage-the-distro: the existence of SAGE_ROOT/upstream, or some other directory or some file created just for this purpose: a file like `SAGE_ROOT/lib/sage-current-location.txt` which is written by sage-the-distro but not by everyone else.



---

archive/issue_comments_377913.json:
```json
{
    "body": "Replying to [comment:32 jhpalmieri]:\n> Replying to [comment:31 gh-timokau]:\n> > Back to my first question: what are the usecases for these manifests?\n> \n> Here's what I said above\n\nSorry, I asked again because I wasn't completely sure if the mentioned usecase was the only one.\n\n> Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.\n\nOkay, so in that case it should be fine to continue to ignore those manifests on distro. Thanks for the explanation :)",
    "created_at": "2019-04-07T16:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377913",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:32 jhpalmieri]:
> Replying to [comment:31 gh-timokau]:
> > Back to my first question: what are the usecases for these manifests?
> 
> Here's what I said above

Sorry, I asked again because I wasn't completely sure if the mentioned usecase was the only one.

> Installing and uninstalling packages are the reason for the manifests: if you want to uninstall a package, which for example is part of upgrading a package, Sage uses the file manifest to know which files to remove.

Okay, so in that case it should be fine to continue to ignore those manifests on distro. Thanks for the explanation :)



---

archive/issue_comments_377914.json:
```json
{
    "body": "Replying to [comment:33 jhpalmieri]:\n> Maybe there should be a tag for doctests which are skipped by distros.\n\nYes I thought about that too, maybe something similar to #26110 with a `# optional - buildsystem` that is enabled by default. Distros can then skip that.\n\nIts not perfect since some distros will differ in how they handle certain things (for example #27230 introduced a doctest that fails on nixos although no functionality is actually broken, but will probably work on most other distros). But a lot of stuff could be covered, pretty much all of `package.py` for example.\n\nThis could be seen as a first step of separating sage and the sage build system, so Erik may have an opinion on that.\n\n>  If so, then in addition to being able to specify it directly when running \"sage -t\", maybe there could be a way of trying to intelligently detect whether to set it.\n\nI think intelligent detection isn't that important: Just enable it by default (since most manual runs of sage tests will be in a non-distro context) and let distros disable it (as it only needs to be done once).",
    "created_at": "2019-04-07T16:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377914",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:33 jhpalmieri]:
> Maybe there should be a tag for doctests which are skipped by distros.

Yes I thought about that too, maybe something similar to #26110 with a `# optional - buildsystem` that is enabled by default. Distros can then skip that.

Its not perfect since some distros will differ in how they handle certain things (for example #27230 introduced a doctest that fails on nixos although no functionality is actually broken, but will probably work on most other distros). But a lot of stuff could be covered, pretty much all of `package.py` for example.

This could be seen as a first step of separating sage and the sage build system, so Erik may have an opinion on that.

>  If so, then in addition to being able to specify it directly when running "sage -t", maybe there could be a way of trying to intelligently detect whether to set it.

I think intelligent detection isn't that important: Just enable it by default (since most manual runs of sage tests will be in a non-distro context) and let distros disable it (as it only needs to be done once).



---

archive/issue_comments_377915.json:
```json
{
    "body": "New ticket please.\n\nI would just change the test to try/except and ignore errors if the file does not exist.\n\nIt also occurs to me that the `package_manifest` function should not use `os.environ['SAGE_SPKG_INST']` but rather should probably take that value from `sage.env` (and add it is a variable to `sage.env` if one does not already exist).",
    "created_at": "2019-04-08T15:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377915",
    "user": "https://github.com/embray"
}
```

New ticket please.

I would just change the test to try/except and ignore errors if the file does not exist.

It also occurs to me that the `package_manifest` function should not use `os.environ['SAGE_SPKG_INST']` but rather should probably take that value from `sage.env` (and add it is a variable to `sage.env` if one does not already exist).



---

archive/issue_comments_377916.json:
```json
{
    "body": "See #27621 for the distro question and #27622 for getting `SAGE_SPKG_INST` from `sage.env` instead of `os.environ`. (They're separate issues and one has an easy obvious fix. The other I'm not so sure about.)",
    "created_at": "2019-04-08T17:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26887#issuecomment-377916",
    "user": "https://github.com/jhpalmieri"
}
```

See #27621 for the distro question and #27622 for getting `SAGE_SPKG_INST` from `sage.env` instead of `os.environ`. (They're separate issues and one has an easy obvious fix. The other I'm not so sure about.)
