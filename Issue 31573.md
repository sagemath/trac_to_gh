# Issue 31573: Speedup number field element __getitem__ and for Guassians

Issue created by migration from https://trac.sagemath.org/ticket/31810

Original creator: tscrim

Original creation time: 2021-05-11 01:51:22

CC:  vdelecroix mmezzarobba

Keywords: number field element, Gaussian

Right now we needlessly construct a polynomial to call `__getitem__` on a number field element. We can just directly call `_coefficients()` and return 0 if the index is outside that list.

We also do some other speedups for the Guassian numbers.


---

Comment by tscrim created at 2021-05-11 01:53:49

Changing status from new to needs_review.


---

Comment by tscrim created at 2021-05-11 01:53:49

There is no real dependency on #31808 other than it made things easier for conflicts.

I also did some slight bit of trivial cleanup.
----
New commits:


---

Comment by vdelecroix created at 2021-05-11 06:39:18

Guassians :)


---

Comment by tscrim created at 2021-05-11 06:46:57

They are like the Gaussian, but under the nonstandard embedding into correct spelling. `:P`

I type too quickly and don't proofread as much as I should. Bad habits. `^^;;`


---

Comment by mmezzarobba created at 2021-05-11 07:39:46

Using `parts()` to implement `__getitem__()` changes the output of

```
sage: K.<a> = NumberField(x^2-x+7)
sage: list(a)
[1/2, 3/2]
```

(cf. the documentation of `parts()`).


---

Comment by mmezzarobba created at 2021-05-11 07:39:46

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2021-05-11 08:09:37

This would be a good opportunity to fix this typo
(from #5930 merged in Sage 4.0.rc0):

```diff
         Return the real part of ``self``, which is either ``self`` (if
-        ``self`` lives it a totally real field) or a rational number.
+        ``self`` lives in a totally real field) or a rational number.
```



---

Comment by tscrim created at 2021-05-11 12:42:38

Good catch. I am going to create a subclass for that case since it is something based on the parent and can be decided during the parent initialization. I will also add a doctest for the `list(a)` and fix the typo (feel free to suggest other things to fix/cleanup too).


---

Comment by git created at 2021-05-12 06:39:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-12 06:45:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2021-05-12 06:47:23

I have created the subclass that separates the two cases for the number fields. I couldn't think of a good solution in terms of the classes for the `Order`, so I just left that as a delegation. Likewise for the `_coefficients()` in the new class; I couldn't see a way to get around that call to get the generator. However, it does remove some checks for calling `_coefficients()`.

I did some other cleanup too. The documentation of `is_sqrt_disc()` is poor because it does not depend on `D`. However, I don't know the theory here to be able to change it.


---

Comment by tscrim created at 2021-05-13 02:29:57

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2021-05-13 12:53:47

I haven't read the code in detail (and I am not really familiar with the theory either), but can you explain why you decided to create a subclass for the case where `is_sqrt_disc()` is `False` rather than for the other case? (It seems to me that the code for the case `is_sqrt_disc() == False` works in the other case too, at least for some methods. Is that correct?)


---

Comment by tscrim created at 2021-05-13 23:37:46

I was thinking of `NumberFieldElement_gaussian` keeping the same structure, but if I did swap it, I could just put it as a subclass of the new `_sqrt` class. That is a good idea to swap the two. I will do that, as well as fix the doctest failures.


---

Comment by tscrim created at 2021-05-13 23:37:46

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-14 00:22:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-05-14 00:36:37

I have changed it. I also made some simplifications to the `Matrix_cyclotomic_dense.set_unsafe()` code (mirroring the `get_unsafe()` implementation) as part of the bug fixing. `CyclotomicField(4)` now takes advantage of the fact it is the same as `QuadraticField(-1)` by using the `NumberFieldElement_gaussian` class.

Timings:

```
sage: %timeit list(I)
1.46 µs ± 5.9 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit I[0]
351 ns ± 2.13 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

versus before:

```
sage: %timeit list(I)
16 µs ± 58.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit I[0]
7.62 µs ± 91.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

Comment by tscrim created at 2021-05-14 00:36:37

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2021-05-15 08:57:33

Thanks Travis!

The code looks good to me, but I cannot easily run the complete testsuite locally at the moment, so let's wait for the patchbot to wake up.


---

Comment by git created at 2021-05-15 09:54:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-05-15 10:01:03

Patchbot did have a look at it, and found more errors. These came from the fact I forgot to move the `__getitem__` to the `_sqrt` class. Although debugging this was annoying because of how it was appearing in the polynomial code. Anyways, this should squash all other doctest failures (and hopefully bugs!).

Some other timings:

```
sage: K.<a> = NumberField(x^5 + x^4 + x^2 - 5)
sage: p = a^5
sage: %timeit list(p)
6.91 µs ± 30.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit p[3]
1.41 µs ± 13.8 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)

sage: K.<a> = QuadraticField(5)
sage: %timeit list(a)
1.45 µs ± 6.69 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a[1]
372 ns ± 7.12 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

versus before

```
sage: %timeit list(p)
41.3 µs ± 561 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit p[3]
7.94 µs ± 143 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: %timeit list(a)
16.9 µs ± 77.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit a[1]
7.95 µs ± 57 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

Comment by tscrim created at 2021-05-15 10:02:30

Also

```
sage: K.<a> = NumberField(x^5 + x^4 + x^2 - 5)
sage: p = a^3
sage: %timeit p[4]
1.3 µs ± 4.6 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

versus before

```
7.73 µs ± 53 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

Comment by git created at 2021-05-17 23:37:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-05-17 23:38:43

Patchbot was green except for one trivial doctest output, which is now fixed:

```
sage -t --random-seed=0 src/sage/libs/singular/singular.pyx
    [78 tests, 0.09 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 0.1 seconds
```



---

Comment by mmezzarobba created at 2021-05-18 07:22:12

There is still a detail that I am not sure I like:

```
--- a/src/sage/matrix/matrix_cyclo_dense.pyx
+++ b/src/sage/matrix/matrix_cyclo_dense.pyx
-        if type(value) is NumberFieldElement_quadratic:
+        if self._degree == 2:
```

will lead to crashes if someone force-creates `NumberFieldElement_absolute` elements of degree two.
At the same time, I suppose a call to `isinstance()` would be slower, and we don't usually support messing with the choice of element classes too much.

So I think this is good to go. Thanks again Travis!


---

Comment by mmezzarobba created at 2021-05-18 07:22:12

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-05-19 04:45:48

Thank you for the review.

It is called `set_unsafe()` for a reason `;)`. Yet, that is a good point I hadn't considered. My counterargument would be that we should optimize for assuming it is the correct type of element and if there is a specific need for this, then we can address it later.


---

Comment by vbraun created at 2021-06-19 20:57:30

Resolution: fixed
