# Issue 19365: Fix dependencies on MPIR

archive/issues_019365.json:
```json
{
    "body": "CC:  vbraun\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19602\n\n",
    "created_at": "2015-11-19T15:02:59Z",
    "labels": [
        "cython",
        "major",
        "bug"
    ],
    "title": "Fix dependencies on MPIR",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19365",
    "user": "jdemeyer"
}
```
CC:  vbraun



Issue created by migration from https://trac.sagemath.org/ticket/19602





---

archive/issue_comments_266063.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-11-19T17:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266063",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_266064.json:
```json
{
    "body": "Changing component from cython to build.",
    "created_at": "2015-11-19T17:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266064",
    "user": "jdemeyer"
}
```

Changing component from cython to build.



---

archive/issue_comments_266065.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-19T17:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266065",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_266066.json:
```json
{
    "body": "how about putting wrap_create_extension_list into sage_setup?",
    "created_at": "2015-11-19T17:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266066",
    "user": "vbraun"
}
```

how about putting wrap_create_extension_list into sage_setup?



---

archive/issue_comments_266067.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-19T19:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266067",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_266068.json:
```json
{
    "body": "There seems to be a problem with distutils...",
    "created_at": "2015-11-19T19:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266068",
    "user": "jdemeyer"
}
```

There seems to be a problem with distutils...



---

archive/issue_comments_266069.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-20T06:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266069",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_266070.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-20T06:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266070",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266071.json:
```json
{
    "body": "Wow, getting more and more inefficient (memory footprint, number of system calls/filesystem accesses).  (W.r.t. reinventing the wheel, we should probably consider dynamically creating Makefiles to build the Sage library... ;-) )\n\nYou could at least cache the mapping of library names to their (existing, probably single) pathnames (and reuse them instead of creating hundreds of copies); if there's a shared library, you don't have to record another potential static one of the same library -- on *nix at least.  Not sure whether hardcoding the library folders (`SAGE_LOCAL/lib*/`) there makes sense, or is appropriate.\n\nAfter all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.\n\n\n\n\n`libFOO.dll` is not the convention used on Windows AFAIK; we may specialize according to the platform, also avoiding unnecessary calls of `glob()`.\n\n\n\n\nDo you want to keep the verbose listing of (lengthy!) dependencies by default?\n\n\n\n\nYou've renamed the parameter `library_order` to `library_sort_key`, the docstring of `wrap_create_extension_list()` doesn't yet reflect that change.",
    "created_at": "2015-11-20T09:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266071",
    "user": "leif"
}
```

Wow, getting more and more inefficient (memory footprint, number of system calls/filesystem accesses).  (W.r.t. reinventing the wheel, we should probably consider dynamically creating Makefiles to build the Sage library... ;-) )

You could at least cache the mapping of library names to their (existing, probably single) pathnames (and reuse them instead of creating hundreds of copies); if there's a shared library, you don't have to record another potential static one of the same library -- on *nix at least.  Not sure whether hardcoding the library folders (`SAGE_LOCAL/lib*/`) there makes sense, or is appropriate.

After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.




`libFOO.dll` is not the convention used on Windows AFAIK; we may specialize according to the platform, also avoiding unnecessary calls of `glob()`.




Do you want to keep the verbose listing of (lengthy!) dependencies by default?




You've renamed the parameter `library_order` to `library_sort_key`, the docstring of `wrap_create_extension_list()` doesn't yet reflect that change.



---

archive/issue_comments_266072.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> Wow, getting more and more inefficient (memory footprint, number of system calls/filesystem accesses).  (W.r.t. reinventing the wheel, we should probably consider dynamically creating Makefiles to build the Sage library... ;-) )\nI'd love to, but I think neither upstream Cython nor upstream distutils will want to support that.\n\n> You could at least cache the mapping of library names to their (existing, probably single) pathnames\nRight.\n\n> if there's a shared library, you don't have to record another potential static one of the same library -- on *nix at least.\nWell, it doesn't really hurt either. It's just to be safe.\n\n> After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.\nAgain, you are right but I don't see an easy way to express this in the build system.\n\n> Do you want to keep the verbose listing of (lengthy!) dependencies by default?\nWhich \"verbose listing of (lengthy!) dependencies\"?",
    "created_at": "2015-11-20T10:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266072",
    "user": "jdemeyer"
}
```

Replying to [comment:10 leif]:
> Wow, getting more and more inefficient (memory footprint, number of system calls/filesystem accesses).  (W.r.t. reinventing the wheel, we should probably consider dynamically creating Makefiles to build the Sage library... ;-) )
I'd love to, but I think neither upstream Cython nor upstream distutils will want to support that.

> You could at least cache the mapping of library names to their (existing, probably single) pathnames
Right.

> if there's a shared library, you don't have to record another potential static one of the same library -- on *nix at least.
Well, it doesn't really hurt either. It's just to be safe.

> After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.
Again, you are right but I don't see an easy way to express this in the build system.

> Do you want to keep the verbose listing of (lengthy!) dependencies by default?
Which "verbose listing of (lengthy!) dependencies"?



---

archive/issue_comments_266073.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-20T11:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266073",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266074.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.\n\nI must say that I find some truth in this. Volker, do you agree that it's simply a bad idea to rely on timestamps of library files?",
    "created_at": "2015-11-20T11:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266074",
    "user": "jdemeyer"
}
```

Replying to [comment:10 leif]:
> After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.

I must say that I find some truth in this. Volker, do you agree that it's simply a bad idea to rely on timestamps of library files?



---

archive/issue_comments_266075.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Replying to [comment:10 leif]:\n> > After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.\n> \n> I must say that I find some truth in this.\n\nIMHO rather a matter of enforcing [people to comply with] such convention.  Just like our \"manual\" spkg dependencies.  (As before, there could be more than one file per library reflecting a significant change that triggers a rebuild.  In fact, for [ELF] shared libraries, the `soname` -- containing the \"major\" version number -- matters, nothing else [should].)",
    "created_at": "2015-11-20T11:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266075",
    "user": "leif"
}
```

Replying to [comment:13 jdemeyer]:
> Replying to [comment:10 leif]:
> > After all, not relying on (say) timestamps of headers but recompiling and relinking on every change of a shared library is pretty much against one of their purposes.
> 
> I must say that I find some truth in this.

IMHO rather a matter of enforcing [people to comply with] such convention.  Just like our "manual" spkg dependencies.  (As before, there could be more than one file per library reflecting a significant change that triggers a rebuild.  In fact, for [ELF] shared libraries, the `soname` -- containing the "major" version number -- matters, nothing else [should].)



---

archive/issue_comments_266076.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-20T14:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266076",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266077.json:
```json
{
    "body": "Relying no the timestamp of the header sounds good to me.\n\nIt assumes that we don't overlink, but thats obviously to be avoided anyways.",
    "created_at": "2015-11-21T00:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266077",
    "user": "vbraun"
}
```

Relying no the timestamp of the header sounds good to me.

It assumes that we don't overlink, but thats obviously to be avoided anyways.



---

archive/issue_comments_266078.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-21T08:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266078",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_266079.json:
```json
{
    "body": "So are we confident that\n\n* this is currently true for all libraries, i.e., an update (or just reinstallation) of each of them causes some of their header(s) to have newer timestamps,\n* all modules linking to them explicitly depend on those,\n* it's sufficiently documented, both for spkg maintainers creating or updating spkgs as well as for reviewers such that they check this still holds?\n\n(I recall in the past occasionally some updates only incidentally worked, but I'm not aware of current trouble besides what Jeroen discovered regarding \"overlinking\" either.  No idea of how well-documented or -known the potential problems are.)",
    "created_at": "2015-11-21T15:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266079",
    "user": "leif"
}
```

So are we confident that

* this is currently true for all libraries, i.e., an update (or just reinstallation) of each of them causes some of their header(s) to have newer timestamps,
* all modules linking to them explicitly depend on those,
* it's sufficiently documented, both for spkg maintainers creating or updating spkgs as well as for reviewers such that they check this still holds?

(I recall in the past occasionally some updates only incidentally worked, but I'm not aware of current trouble besides what Jeroen discovered regarding "overlinking" either.  No idea of how well-documented or -known the potential problems are.)



---

archive/issue_comments_266080.json:
```json
{
    "body": "P.S.:  People adding (or significantly changing) extension modules, or changing `module_list.py` should also know the potential pitfalls.\n\nThere should probably be some document / file reflecting which header(s) to use (i.e., to add to a module's `depends`) when linking to some library.  In Sage's `setup.py` we intentionally only add a few `depends` automagically (namely in case a module links to one of the most prominent libraries such as GMP/MPIR).",
    "created_at": "2015-11-21T15:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266080",
    "user": "leif"
}
```

P.S.:  People adding (or significantly changing) extension modules, or changing `module_list.py` should also know the potential pitfalls.

There should probably be some document / file reflecting which header(s) to use (i.e., to add to a module's `depends`) when linking to some library.  In Sage's `setup.py` we intentionally only add a few `depends` automagically (namely in case a module links to one of the most prominent libraries such as GMP/MPIR).



---

archive/issue_comments_266081.json:
```json
{
    "body": "Replying to [comment:19 leif]:\n> So are we confident that\n> \n>  * this is currently true for all libraries, i.e., an update (or just reinstallation) of each of them causes some of their header(s) to have newer timestamps,\n\nI just checked\n\n```\nfind local/ -type f |xargs ls -l --sort=time\n```\n\n\nand the only old files were from `numpy`. So everything except numpy seems to install everything with recent timestamps.",
    "created_at": "2015-11-22T10:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266081",
    "user": "jdemeyer"
}
```

Replying to [comment:19 leif]:
> So are we confident that
> 
>  * this is currently true for all libraries, i.e., an update (or just reinstallation) of each of them causes some of their header(s) to have newer timestamps,

I just checked

```
find local/ -type f |xargs ls -l --sort=time
```


and the only old files were from `numpy`. So everything except numpy seems to install everything with recent timestamps.



---

archive/issue_comments_266082.json:
```json
{
    "body": "Let me also add that using\n\n```\n# distutils: ...\n```\n\ndeclarations, the dependency checking is actually easier than the old `src/module_list.py` system. You just need to add the right declarations to the library `.pxd` files.",
    "created_at": "2015-11-22T10:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266082",
    "user": "jdemeyer"
}
```

Let me also add that using

```
# distutils: ...
```

declarations, the dependency checking is actually easier than the old `src/module_list.py` system. You just need to add the right declarations to the library `.pxd` files.



---

archive/issue_comments_266083.json:
```json
{
    "body": "Replying to [comment:20 leif]:\n> i.e., to add to a module's `depends`\n\nExplicitly using `depends` should only be done in exceptional cases where the normal dependency checking doesn't work. #19610 is such an exceptional case (because the dependency is through a `.c` or `.h` file).",
    "created_at": "2015-11-22T10:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266083",
    "user": "jdemeyer"
}
```

Replying to [comment:20 leif]:
> i.e., to add to a module's `depends`

Explicitly using `depends` should only be done in exceptional cases where the normal dependency checking doesn't work. #19610 is such an exceptional case (because the dependency is through a `.c` or `.h` file).



---

archive/issue_comments_266084.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> Let me also add that using\n> {{{\n> # distutils: ...\n> }}}\n> declarations, the dependency checking is actually easier than the old `src/module_list.py` system. You just need to add the right declarations to the library `.pxd` files.\n\nAs we have seen, you can easily add `distutils: libraries = foo bar` **without** making the modules *depend* (in distutils' sense) on the libraries (i.e., their proper headers).  This was more transparent or obvious in our older `module_list.py` (where we by the way could also use things like `uname_specific()`).",
    "created_at": "2015-11-22T12:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266084",
    "user": "leif"
}
```

Replying to [comment:22 jdemeyer]:
> Let me also add that using
> {{{
> # distutils: ...
> }}}
> declarations, the dependency checking is actually easier than the old `src/module_list.py` system. You just need to add the right declarations to the library `.pxd` files.

As we have seen, you can easily add `distutils: libraries = foo bar` **without** making the modules *depend* (in distutils' sense) on the libraries (i.e., their proper headers).  This was more transparent or obvious in our older `module_list.py` (where we by the way could also use things like `uname_specific()`).



---

archive/issue_comments_266085.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2015-11-22T20:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266085",
    "user": "vbraun"
}
```

Resolution: invalid



---

archive/issue_comments_266086.json:
```json
{
    "body": "Replying to [comment:24 leif]:\n> As we have seen, you can easily add `distutils: libraries = foo bar` **without** making the modules *depend* (in distutils' sense) on the libraries (i.e., their proper headers).\n\nRight, **and this was the reason I created this ticket**.",
    "created_at": "2015-11-23T07:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266086",
    "user": "jdemeyer"
}
```

Replying to [comment:24 leif]:
> As we have seen, you can easily add `distutils: libraries = foo bar` **without** making the modules *depend* (in distutils' sense) on the libraries (i.e., their proper headers).

Right, **and this was the reason I created this ticket**.



---

archive/issue_comments_266087.json:
```json
{
    "body": "Replying to [comment:24 leif]:\n> This was more transparent or obvious in our older `module_list.py` (where we by the way could also use things like `uname_specific()`).\n\nI completely disagree with this statement though. Listing libraries in `module_list.py` is much more prone to errors because you manually need to keep track of all libraries that a module uses. Using `module_list.py`, if some module uses PARI functions, I need to change `module_list.py`. With the `# distutils: libraries` declarations, I don't need special effort: I just `cimport sage.libs.pari.foo` and the library gets added automatically.\n\nSo I would say that using `# distutils` makes it easier to get it right (but it's still possible to make mistakes of course).",
    "created_at": "2015-11-23T07:04:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266087",
    "user": "jdemeyer"
}
```

Replying to [comment:24 leif]:
> This was more transparent or obvious in our older `module_list.py` (where we by the way could also use things like `uname_specific()`).

I completely disagree with this statement though. Listing libraries in `module_list.py` is much more prone to errors because you manually need to keep track of all libraries that a module uses. Using `module_list.py`, if some module uses PARI functions, I need to change `module_list.py`. With the `# distutils: libraries` declarations, I don't need special effort: I just `cimport sage.libs.pari.foo` and the library gets added automatically.

So I would say that using `# distutils` makes it easier to get it right (but it's still possible to make mistakes of course).



---

archive/issue_comments_266088.json:
```json
{
    "body": "Some testing would be nice, e.g. use gcc include dependency output and compare with linked libraries.",
    "created_at": "2015-11-23T07:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19365#issuecomment-266088",
    "user": "vbraun"
}
```

Some testing would be nice, e.g. use gcc include dependency output and compare with linked libraries.
