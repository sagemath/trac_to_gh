# Issue 28437: RecursivelyEnumeratedSet: certified enumeration order

archive/issues_028437.json:
```json
{
    "body": "CC:  @seblabbe @vinklein @jhpalmieri @tscrim\n\nThis ticket is a follow-up to #27967. It makes the following changes related to enumeration orders of `RecursivelyEnumeratedSet`:\n\n\u2022 implements (and documents) a certified enumeration order for breadth-first search of recursively enumerated sets (left-to-right traversal). The graded case has already been implemented in #27967. In particular, this gives consistent results between Python 2 and 3, also for the generic and symmetric case.\n\n  (The depth-first search already returns consistent results \u2013 this ticket adds this fact to its documentation as well.)\n\n\u2022 further optimizes the implementation of breadth-first search as suggested in [ticket:27967#comment:15]. With this, elements are generally returned much earlier during the search: by an entire generation earlier. In other words, it is possible to explore one level further before potentially running out of memory.\n\n\u2022 implements a custom breadth-first search iterator for `RecursivelyEnumeratedSet_symmetric` (this is necessary because the previous implementation was based on `graded_component()` which returns unordered sets). As a result, `_breadth_first_search_iterator_from_graded_component_iterator()` is not used anymore and therefore removed.\n\n\u2022 fixes an off-by-one error in the `max_depth` of the breadth-first iterator for RES of `symmetric` structure:\n\n  {{{\n  sage: f = lambda a: [a-1, a+1]\n  sage: C = RecursivelyEnumeratedSet([0], f)\n  sage: D = RecursivelyEnumeratedSet([0], f, structure='symmetric')\n  sage: sorted(C.breadth_first_search_iterator(max_depth=2))\n  [-2, -1, 0, 1, 2]\n  sage: sorted(D.breadth_first_search_iterator(max_depth=2))  # should be the same\n  [-1, 0, 1]\n  }}}\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28674\n\n",
    "created_at": "2019-10-29T23:02:50Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "RecursivelyEnumeratedSet: certified enumeration order",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28437",
    "user": "@mwageringel"
}
```
CC:  @seblabbe @vinklein @jhpalmieri @tscrim

This ticket is a follow-up to #27967. It makes the following changes related to enumeration orders of `RecursivelyEnumeratedSet`:

• implements (and documents) a certified enumeration order for breadth-first search of recursively enumerated sets (left-to-right traversal). The graded case has already been implemented in #27967. In particular, this gives consistent results between Python 2 and 3, also for the generic and symmetric case.

  (The depth-first search already returns consistent results – this ticket adds this fact to its documentation as well.)

• further optimizes the implementation of breadth-first search as suggested in [ticket:27967#comment:15]. With this, elements are generally returned much earlier during the search: by an entire generation earlier. In other words, it is possible to explore one level further before potentially running out of memory.

• implements a custom breadth-first search iterator for `RecursivelyEnumeratedSet_symmetric` (this is necessary because the previous implementation was based on `graded_component()` which returns unordered sets). As a result, `_breadth_first_search_iterator_from_graded_component_iterator()` is not used anymore and therefore removed.

• fixes an off-by-one error in the `max_depth` of the breadth-first iterator for RES of `symmetric` structure:

  {{{
  sage: f = lambda a: [a-1, a+1]
  sage: C = RecursivelyEnumeratedSet([0], f)
  sage: D = RecursivelyEnumeratedSet([0], f, structure='symmetric')
  sage: sorted(C.breadth_first_search_iterator(max_depth=2))
  [-2, -1, 0, 1, 2]
  sage: sorted(D.breadth_first_search_iterator(max_depth=2))  # should be the same
  [-1, 0, 1]
  }}}


Issue created by migration from https://trac.sagemath.org/ticket/28674





---

archive/issue_comments_401690.json:
```json
{
    "body": "After these changes, only the `naive` enumeration order will give unordered results, as is clearly stated in its documentation, as well as the function `graded_component()` (and consequently `graded_component_iterator()` as well as `elements_of_depth_iterator()`), as `graded_component()` returns an unordered `set` of elements rather than an iterator of its elements.\n\n----\n\nMoreover, this ticket should allow to revert the workaround implemented in #28227 and might also help with #28539.",
    "created_at": "2019-10-29T23:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401690",
    "user": "@mwageringel"
}
```

After these changes, only the `naive` enumeration order will give unordered results, as is clearly stated in its documentation, as well as the function `graded_component()` (and consequently `graded_component_iterator()` as well as `elements_of_depth_iterator()`), as `graded_component()` returns an unordered `set` of elements rather than an iterator of its elements.

----

Moreover, this ticket should allow to revert the workaround implemented in #28227 and might also help with #28539.



---

archive/issue_comments_401691.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-10-29T23:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401691",
    "user": "@mwageringel"
}
```

New commits:



---

archive/issue_comments_401692.json:
```json
{
    "body": "Several doctests outside of `sets/recursively_enumerated_set.py` seem to rely on a coincidental non-certified BFS order and have to be updated as a result of these changes. With the current branch and Python 3, I get these failures:\n\n\n```\nsrc/sage/algebras/quantum_groups/representations.py  # 3 doctests failed\nsrc/sage/categories/crystals.py  # 6 doctests failed\nsrc/sage/categories/regular_crystals.py  # 2 doctests failed\nsrc/sage/combinat/crystals/subcrystal.py  # 1 doctest failed\nsrc/sage/combinat/root_system/integrable_representations.py  # 4 doctests failed\nsrc/sage/groups/perm_gps/permgroup.py  # 1 doctest failed\n```\n",
    "created_at": "2019-10-29T23:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401692",
    "user": "@mwageringel"
}
```

Several doctests outside of `sets/recursively_enumerated_set.py` seem to rely on a coincidental non-certified BFS order and have to be updated as a result of these changes. With the current branch and Python 3, I get these failures:


```
src/sage/algebras/quantum_groups/representations.py  # 3 doctests failed
src/sage/categories/crystals.py  # 6 doctests failed
src/sage/categories/regular_crystals.py  # 2 doctests failed
src/sage/combinat/crystals/subcrystal.py  # 1 doctest failed
src/sage/combinat/root_system/integrable_representations.py  # 4 doctests failed
src/sage/groups/perm_gps/permgroup.py  # 1 doctest failed
```




---

archive/issue_comments_401693.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-30T23:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401693",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_401694.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-30T23:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401694",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401695.json:
```json
{
    "body": "I have updated all the failing doctests, most of them related to subcrystals.\n\nNow ptestlong passes on my end, with both python 2 and 3. This is ready for review if the patchbot is happy.",
    "created_at": "2019-10-30T23:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401695",
    "user": "@mwageringel"
}
```

I have updated all the failing doctests, most of them related to subcrystals.

Now ptestlong passes on my end, with both python 2 and 3. This is ready for review if the patchbot is happy.



---

archive/issue_comments_401696.json:
```json
{
    "body": "LGTM but IMO a documentation fix should be done first:\n\n```diff\n-        - ``max_depth`` -- (Default: ``None``) Specifies the maximal depth\n-          to which elements are computed. If None, the value of\n-          ``self._max_depth`` is used.\n+        - ``max_depth`` -- (default: ``self._max_depth``) specifies the\n+          maximal depth to which elements are computed\n```\n\n(I know it is not like this elsewhere, but I don't think that is a good reason to perpetuate the practice of breaking from the recommended formatting style.)",
    "created_at": "2019-11-01T01:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401696",
    "user": "@tscrim"
}
```

LGTM but IMO a documentation fix should be done first:

```diff
-        - ``max_depth`` -- (Default: ``None``) Specifies the maximal depth
-          to which elements are computed. If None, the value of
-          ``self._max_depth`` is used.
+        - ``max_depth`` -- (default: ``self._max_depth``) specifies the
+          maximal depth to which elements are computed
```

(I know it is not like this elsewhere, but I don't think that is a good reason to perpetuate the practice of breaking from the recommended formatting style.)



---

archive/issue_comments_401697.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-03T15:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401697",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_401698.json:
```json
{
    "body": "Indeed. Thank you for the feedback. I have updated the documentation accordingly.",
    "created_at": "2019-11-03T15:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401698",
    "user": "@mwageringel"
}
```

Indeed. Thank you for the feedback. I have updated the documentation accordingly.



---

archive/issue_comments_401699.json:
```json
{
    "body": "LGTM.",
    "created_at": "2019-11-04T01:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401699",
    "user": "@tscrim"
}
```

LGTM.



---

archive/issue_comments_401700.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-04T01:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401700",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401701.json:
```json
{
    "body": "I just reviewed the code. Doctests work on my side. Thanks for working on that.",
    "created_at": "2019-11-04T15:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401701",
    "user": "@seblabbe"
}
```

I just reviewed the code. Doctests work on my side. Thanks for working on that.



---

archive/issue_comments_401702.json:
```json
{
    "body": "Thanks for the reviews.",
    "created_at": "2019-11-04T17:45:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401702",
    "user": "@mwageringel"
}
```

Thanks for the reviews.



---

archive/issue_comments_401703.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-07T23:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28437#issuecomment-401703",
    "user": "@vbraun"
}
```

Resolution: fixed
