# Issue 32132: Rewrite Clifford and exterior algebras to have a basis indexed by integers

Issue created by migration from https://trac.sagemath.org/ticket/32369

Original creator: tscrim

Original creation time: 2021-08-12 10:02:02

CC:  tscrim tkarn

Integers are a more compact way of representing subsets with their bits. This should both decrease the memory usage to store elements and the speed due to using bit operations and nearly trivial hashing.


---

Comment by tkarn created at 2022-06-13 11:05:23

Set assignee to tkarn.


---

Comment by tkarn created at 2022-06-13 19:57:05

Changing keywords from "" to "gsoc2022 exterior algebra index integer".


---

Comment by git created at 2022-06-14 23:21:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2022-06-21 12:15:49

New commits:


---

Comment by git created at 2022-06-21 17:33:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-21 18:21:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-22 20:16:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-23 20:40:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-24 14:13:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-26 03:33:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-06-28 14:18:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-03 18:58:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-05 14:44:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-05 22:57:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2022-07-05 23:05:36

Associativity is broken...


```
sage: E.<a,b,c> = ExteriorAlgebra(QQ)
sage: b.__mul__(c*a)
a*b*c
sage: (b*c).__mul__(a)
-a*b*c
```



---

Comment by git created at 2022-07-08 14:45:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-08 14:50:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-23 01:19:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2022-07-23 01:20:06

Changing status from new to needs_review.


---

Comment by tkarn created at 2022-07-25 14:44:23

Changing status from needs_review to needs_work.


---

Comment by tkarn created at 2022-07-25 14:44:23

There was a merge issue.


---

Comment by git created at 2022-07-25 15:25:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-07-25 15:38:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-25 15:39:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 15:41:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2022-07-25 17:46:17

It looks like part of the merge problem was that I was on 9.7.beta2, and there was a change in 9.7.beta5 or beta6 that touched `clifford_algebra.py`. I rebased off of 9.7.beta6 with `-X theirs` and going to test.


---

Comment by git created at 2022-07-25 19:42:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by tkarn created at 2022-07-25 19:46:31

Merge issue seems to be fixed -- all tests pass.


---

Comment by tkarn created at 2022-07-25 19:58:43

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-08-02 05:31:06

This is faster for hashing and equality testing, which are two of the big things I wanted to speed up since the element implementation is using `dict`s:

```
sage: t = (1,3,6,7,9,13)
sage: X = FrozenBitset(t)
sage: X
01010011010001
sage: %timeit hash(t)
61.4 ns ± 1.09 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
sage: %timeit hash(X)
33.6 ns ± 0.354 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)

sage: s = tuple(list(t))
sage: Y = FrozenBitset(s)
sage: s is t
False
sage: Y is X
False
sage: %timeit s == t
28.3 ns ± 0.381 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
sage: %timeit X == Y
20.2 ns ± 0.215 ns per loop (mean ± std. dev. of 7 runs, 100,000,000 loops each)
```


I made a number of small reviewer changes. If they are good with you, then this is a positive review.
----
New commits:


---

Comment by git created at 2022-08-08 00:52:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-08 01:01:25

This should now pass all the doctests. The indexing set should be a `UniqueRepresentation`, which fixes an issue with comparisons. I had to make a few tweaks to how elements were being constructed. I also made the `E.basis().keys().an_element()` behave as before.

Some simple timings for multiplication:

```
sage: E.<a,b,c,d> = ExteriorAlgebra(QQ)
sage: r = E.an_element(); r
b*c + 2*a + 3*b + 1
sage: %timeit r * r
10.9 µs ± 46.7 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
sage: r = sum(E.basis())
sage: %timeit r * r
99 µs ± 438 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)

sage: E = ExteriorAlgebra(QQ, 'x', 10)
sage: r = sum(E.basis())
sage: %timeit r * r
179 ms ± 939 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

versus before

```
11.1 µs ± 42.2 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops 
139 µs ± 271 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)

931 ms ± 5.76 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

So we are seeing substantial gains when multiplying larger elements. With the Cythonization of #34138, this then becomes

```
8.05 µs ± 91.9 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
73.4 µs ± 631 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)

129 ms ± 1.04 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

Is it easy to run timings for these computations in M2?


---

Comment by git created at 2022-08-08 05:22:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2022-08-08 15:13:51

Replying to [comment:38 tscrim]:
> Is it easy to run timings for these computations in M2?

Here you go:


```
i1 : E = QQ[a..d, SkewCommutative=>true]

o1 = E

o1 : PolynomialRing, 4 skew commutative variables

i2 : r = b*c + 2*a + 3*b + 1;

i3 : time r*r;
     -- used 0.000222222 seconds

i4 : r = sum(flatten(entries(basis E)));

i5 : r

o5 = a*b*c*d + a*b*c + a*b*d + a*c*d + b*c*d + a*b + a*c + b*c + a*d + b*d + c*d + a + b + c + d + 1

o5 : E

i6 : time r*r;
     -- used 0.00095186 seconds

i7 : E = QQ[x_1..x_10, SkewCommutative=>true]

o7 = E

o7 : PolynomialRing, 10 skew commutative variables

i8 : r = sum(flatten(entries(basis E)));

i9 : time r*r;
     -- used 0.315753 seconds
```



---

Comment by tkarn created at 2022-08-08 20:03:13

Your machine is better than mine, so I'm including the same timings on my machine so the comparison to M2 is more apples-to-apples.


```
sage: E.<a,b,c,d> = ExteriorAlgebra(QQ)
sage: r = E.an_element(); r
b*c + 2*a + 3*b + 1
sage: %timeit r * r
32.2 µs ± 2.49 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
sage: r = sum(E.basis())
sage: %timeit r * r
274 µs ± 9.02 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)

sage: E = ExteriorAlgebra(QQ, 'x', 10)
sage: r = sum(E.basis())
sage: %timeit r * r
514 ms ± 8.92 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```



---

Comment by tscrim created at 2022-08-08 23:38:50

Interesting...Sage is faster on small examples but slower (almost 2x) on larger examples. I would have expected something far more uniform.


---

Comment by tscrim created at 2022-08-09 03:47:20

Patchbot is (morally) green. So if my review changes are good, then I think we are at a positive review.


---

Comment by tkarn created at 2022-08-10 00:33:37

Changes look good to me!

Replying to [comment:43 tscrim]:
> Patchbot is (morally) green. So if my review changes are good, then I think we are at a positive review.


---

Comment by tkarn created at 2022-08-10 00:33:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-08-29 11:24:09

Resolution: fixed
