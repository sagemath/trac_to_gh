# Issue 14941: the pexpect in sage has a major bug in it -- the which command is broken (easy to fix)

Issue created by migration from https://trac.sagemath.org/ticket/15178

Original creator: was, certik

Original creation time: 2013-09-08 17:51:46

CC:  fbissey

It's pretty obvious that there is a problem.  This was reported in the thread:

   https://groups.google.com/forum/#!topic/sage-cloud/8NgkWfTbU78

There is an easy 1-line fix, which is to put

```
   f = filename
```

at the beginning of the "which" function.


---

Comment by bradlys created at 2014-05-08 03:09:03

New commits:


---

Comment by bradlys created at 2014-05-08 03:09:03

Changing status from new to needs_review.


---

Comment by was created at 2014-05-09 19:30:13

Changing status from needs_review to needs_work.


---

Comment by was created at 2014-05-09 19:30:13


```
sage -f pexpect

patching file pexpect.py
patching file pexpect.py
patching file pexpect.py
Hunk #1 FAILED at 1134.
1 out of 1 hunk FAILED -- saving rejects to file pexpect.py.rej
Error applying '../patches/filename.patch'
 
real    0m0.092s
user    0m0.003s
sys     0m0.009s
************************************************************************
Error installing package pexpect-2.0.p5
```



---

Comment by git created at 2014-05-10 19:33:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-11 00:15:47

Changing status from needs_work to needs_review.


---

Comment by leif created at 2014-05-11 00:21:36

Probably the patch level in the package version (`package-version.txt`) should get bumped (to `.p6`), although with the "new git workflow" others just drop it (and also delete the changelog in `SPKG.txt`, which I don't like).


---

Comment by leif created at 2014-05-11 00:25:49

Changing status from needs_review to needs_work.


---

Comment by leif created at 2014-05-11 00:25:49

Actually, the bug is introduced by us, trying to fix something else:

```patch
--- a/pexpect.py	2007-04-16 07:08:24.000000000 -0700
+++ b/pexpect.py	2009-01-23 01:49:18.000000000 -0800
@@ -1130,7 +1130,7 @@
     """
     # Special case where filename already contains a path.
     if os.path.dirname(filename) != '':
-        if os.access (filename, os.X_OK):
+        if os.access (filename, os.X_OK) and not os.path.isdir(f):
             return filename
 
     if not os.environ.has_key('PATH') or os.environ['PATH'] == '':
@@ -1145,7 +1145,7 @@
 
     for path in pathlist:
         f = os.path.join(path, filename)
-        if os.access(f, os.X_OK):
+        if os.access(f, os.X_OK) and not os.path.isdir(f):
             return f
     return None
 
```

(This is `patches/pexpect.py-isdir_bug_fix.patch`, so _that one_ should get fixed.)


---

Comment by leif created at 2014-05-11 00:34:57

Oh, that one apparently dates back to 2009:

```
### pexpect-2.0.p2 (William Stein, January 23rd, 2009)
 * created proper SPKG.txt
 * fixed bug in pexpect where it tried to run directories
```


(Sorry William, could not resist... B) )


---

Comment by was created at 2014-05-11 14:54:34

Replying to [comment:12 leif]:
> Oh, that one apparently dates back to 2009:
> {{{
> === pexpect-2.0.p2 (William Stein, January 23rd, 2009) ===
>  * created proper SPKG.txt
>  * fixed bug in pexpect where it tried to run directories
> }}}
> 
> (Sorry William, could not resist... B) )

Thanks!  Isn't revision control awesome...


---

Comment by leif created at 2014-05-11 15:05:04

Replying to [comment:13 was]:
> Thanks!  Isn't revision control awesome...

Well, in this case it was our hand-made changelog in `SPKG.txt`, and others don't update but delete it when converting "legacy" spkgs to "new style" spkgs.


---

Comment by git created at 2014-05-13 02:47:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-13 11:12:57

Changing status from needs_work to needs_review.


---

Comment by leif created at 2014-05-13 11:12:57

Ok.  I personally would have started from scratch, then pushing _a new branch_ to trac (with `-f`, force), but the commits aren't that large, so I don't really mind.


---

Comment by pbruin created at 2014-05-17 20:43:43

Replying to [comment:10 leif]:
> Probably the patch level in the package version (`package-version.txt`) should get bumped (to `.p6`), although with the "new git workflow" others just drop it
I do think you have to update `package-version.txt`; isn't that how Sage knows that it should reinstall the package with the updated patches?


---

Comment by leif created at 2014-05-17 20:59:55

Replying to [comment:17 pbruin]:
> Replying to [comment:10 leif]:
> > Probably the patch level in the package version (`package-version.txt`) should get bumped (to `.p6`), although with the "new git workflow" others just drop it
> I do think you have to update `package-version.txt`; isn't that how Sage knows that it should reinstall the package with the updated patches?

Yes.


---

Comment by fbissey created at 2014-05-17 21:04:53

Leif beat me to it. The only reason not to bump the version is if you fix a building bug which prevented some people (but not everyone) to install. People with successful install shouldn't have to re-install and the people for whom you provided the fix couldn't install.


---

Comment by rws created at 2014-05-18 13:21:32

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-05-18 13:21:32

patchbot:

```
sage -t --long /scratch/sage/src/sage/interfaces/expect.py
**********************************************************************
File "/scratch/sage/src/sage/interfaces/expect.py", line 786, in sage.interface
s.expect.Expect._eval_line
Failed example:
    singular.interrupt(timeout=3)  # sometimes very slow (up to 60s on sage.mat
h, 2012)
Expected:
    False
Got:
    True
**********************************************************************
1 item had failures:
   1 of  15 in sage.interfaces.expect.Expect._eval_line
    [81 tests, 1 failure, 20.20 s]
```



---

Comment by leif created at 2014-05-18 13:48:22

Replying to [comment:20 rws]:
> patchbot:
> {{{
> sage -t --long /scratch/sage/src/sage/interfaces/expect.py
> **********************************************************************
> File "/scratch/sage/src/sage/interfaces/expect.py", line 786, in sage.interface
> s.expect.Expect._eval_line
> Failed example:
>     singular.interrupt(timeout=3)  # sometimes very slow (up to 60s on sage.mat
> h, 2012)
> Expected:
>     False
> Got:
>     True
> **********************************************************************
> 1 item had failures:
>    1 of  15 in sage.interfaces.expect.Expect._eval_line
>     [81 tests, 1 failure, 20.20 s]
> }}}

How could the change here be related to this?


---

Comment by rws created at 2014-05-18 13:51:44

Is it not? I was only superficially skimming. Then it's another patchbot problem. Sorry for the fuss.

Edit: Actually it was #10476 that hit.


---

Comment by rws created at 2014-05-18 13:51:44

Changing status from needs_work to needs_review.


---

Comment by leif created at 2014-05-18 14:04:28

So, are we going to update `package-version.txt`?

The changelog entry in `SPKG.txt` refers to `.p6`, but we could also just delete the whole changelog (later?).

In the latter case, should `package-version.txt` still refer to `.p5`? ;-)

But here we actually change a patch to `pexpect`, so...


---

Comment by leif created at 2014-05-18 14:04:28

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2014-05-24 12:02:27

Merged the previous commits into one and added the `package-version.txt` update as a reviewer patch.


---

Comment by pbruin created at 2014-05-24 12:02:27

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-05-25 17:31:46

Resolution: fixed
