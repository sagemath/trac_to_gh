# Issue 14684: Make FiniteField_pari_ffelt the default for generic finite fields

archive/issues_014684.json:
```json
{
    "body": "Assignee: cpernet\n\nKeywords: FiniteField performance\n\nTicket #12142 implements an interface to PARI's t_FFELT type for finite fields, which is much faster than the one currently used by Sage, in which finite field elements are PARI objects like `Mod(Mod(1, 3)*a, Mod(1, 3)*a^17 + Mod(2, 3)*a + Mod(1, 3))`.  The attached patch makes the new implementation the default for those finite fields that currently use the slow PARI implementation, namely those of cardinality *p<sup>n</sup>* with *p* > 2 prime, *n* > 1 and *p<sup>n</sup>* > 2<sup>16</sup>.\n\nThe actual switch is just a trivial change in the `FiniteField` constructor.  The only other real addition is construction of `Integer` from `t_FFELT`; the rest of the patch fixes doctests.  Almost all fixes are for doctests that assumed `FiniteField_elt_pari` to be the default.  One somewhat notable point is that certain finite elements now compare differently (see the changed doctest in `polynomial_zz_pex.py`).  This is because `gcmp_sage` (in `sage/libs/pari/misc.h`) compares all non-real PARI types via their string representations.  With the new `FiniteFieldElement_pari_ffelt`, string comparison gives the same result as lexicographic comparison of polynomials expressing finite field elements in terms of the chosen generator, which is nice.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14888\n\n",
    "created_at": "2013-07-13T17:43:49Z",
    "labels": [
        "finite rings",
        "major",
        "enhancement"
    ],
    "title": "Make FiniteField_pari_ffelt the default for generic finite fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14684",
    "user": "pbruin"
}
```
Assignee: cpernet

Keywords: FiniteField performance

Ticket #12142 implements an interface to PARI's t_FFELT type for finite fields, which is much faster than the one currently used by Sage, in which finite field elements are PARI objects like `Mod(Mod(1, 3)*a, Mod(1, 3)*a^17 + Mod(2, 3)*a + Mod(1, 3))`.  The attached patch makes the new implementation the default for those finite fields that currently use the slow PARI implementation, namely those of cardinality *p<sup>n</sup>* with *p* > 2 prime, *n* > 1 and *p<sup>n</sup>* > 2<sup>16</sup>.

The actual switch is just a trivial change in the `FiniteField` constructor.  The only other real addition is construction of `Integer` from `t_FFELT`; the rest of the patch fixes doctests.  Almost all fixes are for doctests that assumed `FiniteField_elt_pari` to be the default.  One somewhat notable point is that certain finite elements now compare differently (see the changed doctest in `polynomial_zz_pex.py`).  This is because `gcmp_sage` (in `sage/libs/pari/misc.h`) compares all non-real PARI types via their string representations.  With the new `FiniteFieldElement_pari_ffelt`, string comparison gives the same result as lexicographic comparison of polynomials expressing finite field elements in terms of the chosen generator, which is nice.

Issue created by migration from https://trac.sagemath.org/ticket/14888





---

archive/issue_comments_186952.json:
```json
{
    "body": "Attachment\n\nswitch to FiniteField_pari_ffelt; based on 5.11.beta3 + #12142",
    "created_at": "2013-07-13T17:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186952",
    "user": "pbruin"
}
```

Attachment

switch to FiniteField_pari_ffelt; based on 5.11.beta3 + #12142



---

archive/issue_comments_186953.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-07-13T17:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186953",
    "user": "pbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_186954.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-15T12:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186954",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186955.json:
```json
{
    "body": "Looks good and works fine for what I tried, good work Peter!",
    "created_at": "2013-07-15T12:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186955",
    "user": "jpflori"
}
```

Looks good and works fine for what I tried, good work Peter!



---

archive/issue_comments_186956.json:
```json
{
    "body": "Haven't read the code of #12142, but does pickling work properly and has it been doctested? If not, then #14888 should be set back to needs_work.",
    "created_at": "2013-07-21T21:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186956",
    "user": "jdemeyer"
}
```

Haven't read the code of #12142, but does pickling work properly and has it been doctested? If not, then #14888 should be set back to needs_work.



---

archive/issue_comments_186957.json:
```json
{
    "body": "There shouldn't be any problems with pickling, see the comment I just made at #12142.",
    "created_at": "2013-07-21T21:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186957",
    "user": "pbruin"
}
```

There shouldn't be any problems with pickling, see the comment I just made at #12142.



---

archive/issue_comments_186958.json:
```json
{
    "body": "Doctest failures on 32-bit systems:\n\n```\nsage -t --long devel/sage/sage/graphs/generic_graph.py\n**********************************************************************\nFile \"devel/sage/sage/graphs/generic_graph.py\", line 14898, in sage.graphs.generic_graph.GenericGraph.plot\nFailed example:\n    H = S.hecke_matrix(2)\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 479, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 838, in execute\n        exec compiled in globs\n      File \"<doctest sage.graphs.generic_graph.GenericGraph.plot[78]>\", line 1, in <module>\n        H = S.hecke_matrix(Integer(2))\n      File \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/modular/ssmod/ssmod.py\", line 1042, in hecke_matrix\n        SS, II = self.supersingular_points()\n      File \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/modular/ssmod/ssmod.py\", line 906, in supersingular_points\n        neighbors = Phi_polys(2,X,ss_points[pos]).roots()\n      File \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/modular/ssmod/ssmod.py\", line 206, in Phi_polys\n        return x.parent()([j_pow[3] - 162000*j_pow[2] + 8748000000*j_pow[1] -\n      File \"element.pyx\", line 1701, in sage.structure.element.RingElement.__mul__ (sage/structure/element.c:14531)\n      File \"coerce.pyx\", line 803, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:7330)\n      File \"coerce.pyx\", line 917, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8529)\n      File \"coerce_maps.pyx\", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3856)\n      File \"coerce_maps.pyx\", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3757)\n      File \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/finite_field_pari_ffelt.py\", line 501, in _element_constructor_\n        return self.element_class(self, x)\n      File \"element_pari_ffelt.pyx\", line 145, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.__init__ (sage/rings/finite_rings/element_pari_ffelt.c:2975)\n      File \"element_pari_ffelt.pyx\", line 206, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.construct_from (sage/rings/finite_rings/element_pari_ffelt.c:3341)\n    OverflowError: Python int too large to convert to C long\n**********************************************************************\n```\n\n(the same error occurs in other places)\n\n\n```\nsage -t --long devel/sage/sage/groups/generic.py\n**********************************************************************\nFile \"devel/sage/sage/groups/generic.py\", line 422, in sage.groups.generic.bsgs\nFailed example:\n    P=E.lift_x(a); P\nExpected:\n    (a : 9*a^4 + 22*a^3 + 23*a^2 + 30 : 1)\nGot:\n    (a : 28*a^4 + 15*a^3 + 14*a^2 + 7 : 1)\n**********************************************************************\nFile \"devel/sage/sage/groups/generic.py\", line 851, in sage.groups.generic.discrete_log_lambda\nFailed example:\n    P=E.lift_x(a); P\nExpected:\n    (a : 28*a^4 + 15*a^3 + 14*a^2 + 7 : 1)\nGot:\n    (a : 9*a^4 + 22*a^3 + 23*a^2 + 30 : 1)\n**********************************************************************\n```\n\n(due to a different square root being returned)",
    "created_at": "2013-08-26T20:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186958",
    "user": "jdemeyer"
}
```

Doctest failures on 32-bit systems:

```
sage -t --long devel/sage/sage/graphs/generic_graph.py
**********************************************************************
File "devel/sage/sage/graphs/generic_graph.py", line 14898, in sage.graphs.generic_graph.GenericGraph.plot
Failed example:
    H = S.hecke_matrix(2)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 479, in _run
        self.execute(example, compiled, test.globs)
      File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 838, in execute
        exec compiled in globs
      File "<doctest sage.graphs.generic_graph.GenericGraph.plot[78]>", line 1, in <module>
        H = S.hecke_matrix(Integer(2))
      File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/modular/ssmod/ssmod.py", line 1042, in hecke_matrix
        SS, II = self.supersingular_points()
      File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/modular/ssmod/ssmod.py", line 906, in supersingular_points
        neighbors = Phi_polys(2,X,ss_points[pos]).roots()
      File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/modular/ssmod/ssmod.py", line 206, in Phi_polys
        return x.parent()([j_pow[3] - 162000*j_pow[2] + 8748000000*j_pow[1] -
      File "element.pyx", line 1701, in sage.structure.element.RingElement.__mul__ (sage/structure/element.c:14531)
      File "coerce.pyx", line 803, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:7330)
      File "coerce.pyx", line 917, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8529)
      File "coerce_maps.pyx", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3856)
      File "coerce_maps.pyx", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3757)
      File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/finite_field_pari_ffelt.py", line 501, in _element_constructor_
        return self.element_class(self, x)
      File "element_pari_ffelt.pyx", line 145, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.__init__ (sage/rings/finite_rings/element_pari_ffelt.c:2975)
      File "element_pari_ffelt.pyx", line 206, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.construct_from (sage/rings/finite_rings/element_pari_ffelt.c:3341)
    OverflowError: Python int too large to convert to C long
**********************************************************************
```

(the same error occurs in other places)


```
sage -t --long devel/sage/sage/groups/generic.py
**********************************************************************
File "devel/sage/sage/groups/generic.py", line 422, in sage.groups.generic.bsgs
Failed example:
    P=E.lift_x(a); P
Expected:
    (a : 9*a^4 + 22*a^3 + 23*a^2 + 30 : 1)
Got:
    (a : 28*a^4 + 15*a^3 + 14*a^2 + 7 : 1)
**********************************************************************
File "devel/sage/sage/groups/generic.py", line 851, in sage.groups.generic.discrete_log_lambda
Failed example:
    P=E.lift_x(a); P
Expected:
    (a : 28*a^4 + 15*a^3 + 14*a^2 + 7 : 1)
Got:
    (a : 9*a^4 + 22*a^3 + 23*a^2 + 30 : 1)
**********************************************************************
```

(due to a different square root being returned)



---

archive/issue_comments_186959.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-08-26T20:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186959",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_186960.json:
```json
{
    "body": "The first problem is in the following code:\n\n```\n        elif isinstance(x, int) or isinstance(x, long):\n            g = (<pari_gen>self._parent._gen_pari).g\n            sig_on()\n            x_GEN = stoi(x)\n            self.construct(INT_to_FFELT(g, x_GEN))\n```\n\nThe Python `long` type doesn't convert to a C `long` (confusingly, a C `long` corresponds to a Python `int`).\n\nTo see the problem on 64 bits (let this inspire a doctest):\n\n```\nsage: GF(7^20, 'a')(long(2^63))\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\n<ipython-input-18-d85771ca8953> in <module>()\n----> 1 GF(Integer(7)**Integer(20), 'a')(long(Integer(2)**Integer(63)))\n\n/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8372)()\n\n/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3856)()\n\n/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3757)()\n\n/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/finite_field_pari_ffelt.pyc in _element_constructor_(self, x)\n    499             return x\n    500         else:\n--> 501             return self.element_class(self, x)\n    502 \n    503     def _coerce_map_from_(self, R):\n\n/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/element_pari_ffelt.so in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.__init__ (sage/rings/finite_rings/element_pari_ffelt.c:2975)()\n\n/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/element_pari_ffelt.so in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.construct_from (sage/rings/finite_rings/element_pari_ffelt.c:3341)()\n\nOverflowError: Python int too large to convert to C long\n```\n",
    "created_at": "2013-08-26T21:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186960",
    "user": "jdemeyer"
}
```

The first problem is in the following code:

```
        elif isinstance(x, int) or isinstance(x, long):
            g = (<pari_gen>self._parent._gen_pari).g
            sig_on()
            x_GEN = stoi(x)
            self.construct(INT_to_FFELT(g, x_GEN))
```

The Python `long` type doesn't convert to a C `long` (confusingly, a C `long` corresponds to a Python `int`).

To see the problem on 64 bits (let this inspire a doctest):

```
sage: GF(7^20, 'a')(long(2^63))
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
<ipython-input-18-d85771ca8953> in <module>()
----> 1 GF(Integer(7)**Integer(20), 'a')(long(Integer(2)**Integer(63)))

/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8372)()

/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3856)()

/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3757)()

/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/finite_field_pari_ffelt.pyc in _element_constructor_(self, x)
    499             return x
    500         else:
--> 501             return self.element_class(self, x)
    502 
    503     def _coerce_map_from_(self, R):

/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/element_pari_ffelt.so in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.__init__ (sage/rings/finite_rings/element_pari_ffelt.c:2975)()

/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/rings/finite_rings/element_pari_ffelt.so in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt.construct_from (sage/rings/finite_rings/element_pari_ffelt.c:3341)()

OverflowError: Python int too large to convert to C long
```




---

archive/issue_comments_186961.json:
```json
{
    "body": "Working on it...",
    "created_at": "2013-08-29T09:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186961",
    "user": "jdemeyer"
}
```

Working on it...



---

archive/issue_comments_186962.json:
```json
{
    "body": "There are more serious issues with `element_pari_ffelt.pyx`. For example, it really requires `sig_on()` to be the `sig_on()` from `libs/pari/gen.pyx`. So I feel like this ticket isn't quite ready yet.",
    "created_at": "2013-08-29T11:16:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186962",
    "user": "jdemeyer"
}
```

There are more serious issues with `element_pari_ffelt.pyx`. For example, it really requires `sig_on()` to be the `sig_on()` from `libs/pari/gen.pyx`. So I feel like this ticket isn't quite ready yet.



---

archive/issue_comments_186963.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-08-31T12:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186963",
    "user": "jdemeyer"
}
```

Attachment



---

archive/issue_comments_186964.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-08-31T12:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186964",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_186965.json:
```json
{
    "body": "Somebody should review [attachment:14888_fix_32bit.patch] which fixes doctests on 32-bit systems.",
    "created_at": "2013-09-02T10:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186965",
    "user": "jdemeyer"
}
```

Somebody should review [attachment:14888_fix_32bit.patch] which fixes doctests on 32-bit systems.



---

archive/issue_comments_186966.json:
```json
{
    "body": "Looks good and still passes tests on my 64-bit system.  I would give [attachment:14888_fix_32bit.patch] a positive review except for the fact that the main change in it is specifically for 32-bit systems; at least somebody with a 32-bit system should verify that specific doctest.",
    "created_at": "2013-09-03T13:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186966",
    "user": "pbruin"
}
```

Looks good and still passes tests on my 64-bit system.  I would give [attachment:14888_fix_32bit.patch] a positive review except for the fact that the main change in it is specifically for 32-bit systems; at least somebody with a 32-bit system should verify that specific doctest.



---

archive/issue_comments_186967.json:
```json
{
    "body": "I assure you that doctests pass on 32-bit.",
    "created_at": "2013-09-03T13:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186967",
    "user": "jdemeyer"
}
```

I assure you that doctests pass on 32-bit.



---

archive/issue_comments_186968.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-09-03T13:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186968",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186969.json:
```json
{
    "body": "This happens sometimes:\n\n```\n**********************************************************************\nFile \"devel/sage/sage/schemes/plane_conics/con_finite_field.py\", line 110, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?\nFailed example:\n    C.has_rational_point(point = True)  # output is random\nException raised:\n    Traceback (most recent call last):\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 479, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 838, in execute\n        exec compiled in globs\n      File \"<doctest sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?[9]>\", line 1, in <module>\n        C.has_rational_point(point = True)  # output is random\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_finite_field.py\", line 132, in has_rational_point\n        s, pt = self.has_singular_point(point = True)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.py\", line 595, in has_singular_point\n        return True, self.point(Sequence(D.right_kernel().gen()))\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.py\", line 886, in point\n        p = ProjectiveCurve_generic.point(self, v, check=check)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/scheme.py\", line 370, in point\n        return self.point_homset() (v, check=check)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py\", line 263, in __call__\n        return Set_generic.__call__(self, *args, **kwds)\n      File \"parent.pyx\", line 1011, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8392)\n      File \"coerce_maps.pyx\", line 427, in sage.structure.coerce_maps.ListMorphism._call_with_args (sage/structure/coerce_maps.c:8035)\n      File \"coerce_maps.pyx\", line 100, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (sage/structure/coerce_maps.c:4278)\n      File \"coerce_maps.pyx\", line 90, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (sage/structure/coerce_maps.c:4089)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py\", line 455, in _element_constructor_\n        return self.codomain()._point(self, v, **kwds)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 583, in _point\n        return self.__A._point(*args, **kwds)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/projective/projective_space.py\", line 835, in _point\n        return SchemeMorphism_point_projective_finite_field(*args, **kwds)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/projective/projective_point.py\", line 764, in __init__\n        X.extended_codomain()._check_satisfies_equations(v)\n      File \"/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 967, in _check_satisfies_equations\n        raise TypeError, \"Coordinates %s do not define a point on %s\"%(coords,self)\n    TypeError: Coordinates [0, 0, 1] do not define a point on Projective Conic Curve over Finite Field in a of size 7^20 defined by x^2 + (a)*y^2 + 2*z^2\n**********************************************************************\n```\n\nNote the code path in the traceback showing that Sage thinks the conic is singular.",
    "created_at": "2013-09-30T19:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186969",
    "user": "jdemeyer"
}
```

This happens sometimes:

```
**********************************************************************
File "devel/sage/sage/schemes/plane_conics/con_finite_field.py", line 110, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?
Failed example:
    C.has_rational_point(point = True)  # output is random
Exception raised:
    Traceback (most recent call last):
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 479, in _run
        self.execute(example, compiled, test.globs)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 838, in execute
        exec compiled in globs
      File "<doctest sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?[9]>", line 1, in <module>
        C.has_rational_point(point = True)  # output is random
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_finite_field.py", line 132, in has_rational_point
        s, pt = self.has_singular_point(point = True)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.py", line 595, in has_singular_point
        return True, self.point(Sequence(D.right_kernel().gen()))
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/plane_conics/con_field.py", line 886, in point
        p = ProjectiveCurve_generic.point(self, v, check=check)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/scheme.py", line 370, in point
        return self.point_homset() (v, check=check)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py", line 263, in __call__
        return Set_generic.__call__(self, *args, **kwds)
      File "parent.pyx", line 1011, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8392)
      File "coerce_maps.pyx", line 427, in sage.structure.coerce_maps.ListMorphism._call_with_args (sage/structure/coerce_maps.c:8035)
      File "coerce_maps.pyx", line 100, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (sage/structure/coerce_maps.c:4278)
      File "coerce_maps.pyx", line 90, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (sage/structure/coerce_maps.c:4089)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py", line 455, in _element_constructor_
        return self.codomain()._point(self, v, **kwds)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 583, in _point
        return self.__A._point(*args, **kwds)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/projective/projective_space.py", line 835, in _point
        return SchemeMorphism_point_projective_finite_field(*args, **kwds)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/projective/projective_point.py", line 764, in __init__
        X.extended_codomain()._check_satisfies_equations(v)
      File "/scratch/release/merger/sage-5.13.beta0/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 967, in _check_satisfies_equations
        raise TypeError, "Coordinates %s do not define a point on %s"%(coords,self)
    TypeError: Coordinates [0, 0, 1] do not define a point on Projective Conic Curve over Finite Field in a of size 7^20 defined by x^2 + (a)*y^2 + 2*z^2
**********************************************************************
```

Note the code path in the traceback showing that Sage thinks the conic is singular.



---

archive/issue_comments_186970.json:
```json
{
    "body": "Adding extra doctests shows\n\n```\nsage -t devel/sage/sage/schemes/plane_conics/con_finite_field.py\n**********************************************************************\nFile \"devel/sage/sage/schemes/plane_conics/con_finite_field.py\", line 110, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?\nFailed example:\n    C._coefficients\nExpected:\n    [1, 0, 0, a, 0, 2]\nGot:\n    [1, 0, 0, a, 0, 0]\n**********************************************************************\nFile \"devel/sage/sage/schemes/plane_conics/con_finite_field.py\", line 112, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?\nFailed example:\n    D = C.symmetric_matrix(); D\nExpected:\n    [1 0 0]\n    [0 a 0]\n    [0 0 2]\nGot:\n    [1 0 0]\n    [0 a 0]\n    [0 0 0]\n**********************************************************************\n```\n",
    "created_at": "2013-09-30T19:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186970",
    "user": "jdemeyer"
}
```

Adding extra doctests shows

```
sage -t devel/sage/sage/schemes/plane_conics/con_finite_field.py
**********************************************************************
File "devel/sage/sage/schemes/plane_conics/con_finite_field.py", line 110, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?
Failed example:
    C._coefficients
Expected:
    [1, 0, 0, a, 0, 2]
Got:
    [1, 0, 0, a, 0, 0]
**********************************************************************
File "devel/sage/sage/schemes/plane_conics/con_finite_field.py", line 112, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?
Failed example:
    D = C.symmetric_matrix(); D
Expected:
    [1 0 0]
    [0 a 0]
    [0 0 2]
Got:
    [1 0 0]
    [0 a 0]
    [0 0 0]
**********************************************************************
```




---

archive/issue_comments_186971.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-09-30T20:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186971",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_186972.json:
```json
{
    "body": "Sorry, this one seems to be hard to debug. And it doesn't help that Singular is involved too because of the defining polynomial.",
    "created_at": "2013-09-30T20:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186972",
    "user": "jdemeyer"
}
```

Sorry, this one seems to be hard to debug. And it doesn't help that Singular is involved too because of the defining polynomial.



---

archive/issue_comments_186973.json:
```json
{
    "body": "Note that I'm not even sure that this patch is what actually causes this...",
    "created_at": "2013-09-30T21:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186973",
    "user": "jdemeyer"
}
```

Note that I'm not even sure that this patch is what actually causes this...



---

archive/issue_comments_186974.json:
```json
{
    "body": "Hmm, this is annoying.  How often does it occur?  I just ran doctests on this file several dozens of times and did not get any failures.  (System: x86_64 with 5.11.beta3 and this patch applied, and several others which probably shouldn't influence this.)\n\nDo I understand correctly that there are no failures in the doctest checking that the equation is `x^2 + (a)*y^2 + 2*z^2`?  If so, then the problem can hardly anywhere else than in the initialisation of `C._coefficients`, i.e. (probably) when converting the coefficient of `z^2` from Singular to PARI.\n\nI did adapt the conversion function (formerly `si2sa_GFqPari`, now `si2sa_GFq_generic`) in #12142; the changes seem harmless, but this function does look like a possible culprit to me.",
    "created_at": "2013-09-30T22:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186974",
    "user": "pbruin"
}
```

Hmm, this is annoying.  How often does it occur?  I just ran doctests on this file several dozens of times and did not get any failures.  (System: x86_64 with 5.11.beta3 and this patch applied, and several others which probably shouldn't influence this.)

Do I understand correctly that there are no failures in the doctest checking that the equation is `x^2 + (a)*y^2 + 2*z^2`?  If so, then the problem can hardly anywhere else than in the initialisation of `C._coefficients`, i.e. (probably) when converting the coefficient of `z^2` from Singular to PARI.

I did adapt the conversion function (formerly `si2sa_GFqPari`, now `si2sa_GFq_generic`) in #12142; the changes seem harmless, but this function does look like a possible culprit to me.



---

archive/issue_comments_186975.json:
```json
{
    "body": "Replying to [comment:20 pbruin]:\n> Hmm, this is annoying.  How often does it occur?  I just ran doctests on this file several dozens of times and did not get any failures.\nThat might not be enough times. Try a few hundred or 1000 times.\n\n> Do I understand correctly that there are no failures in the doctest checking that the equation is `x^2 + (a)*y^2 + 2*z^2`?  If so, then the problem can hardly anywhere else than in the initialisation of `C._coefficients`\nExactly.\n\nThe first thing I want to do now is to make sure that it is really this ticket which causes the bug.",
    "created_at": "2013-10-01T06:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186975",
    "user": "jdemeyer"
}
```

Replying to [comment:20 pbruin]:
> Hmm, this is annoying.  How often does it occur?  I just ran doctests on this file several dozens of times and did not get any failures.
That might not be enough times. Try a few hundred or 1000 times.

> Do I understand correctly that there are no failures in the doctest checking that the equation is `x^2 + (a)*y^2 + 2*z^2`?  If so, then the problem can hardly anywhere else than in the initialisation of `C._coefficients`
Exactly.

The first thing I want to do now is to make sure that it is really this ticket which causes the bug.



---

archive/issue_comments_186976.json:
```json
{
    "body": "It seems the problem only appears if #14957 and #14958 are also applied.",
    "created_at": "2013-10-01T08:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186976",
    "user": "jdemeyer"
}
```

It seems the problem only appears if #14957 and #14958 are also applied.



---

archive/issue_comments_186977.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> It seems the problem only appears if #14957 and #14958 are also applied.\nUnfortunately I still haven't been able to reproduce it.  I tried a different x86_64 system with these patches applied and ran the test 10,000 times, but it succeeds every time.",
    "created_at": "2013-10-01T11:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186977",
    "user": "pbruin"
}
```

Replying to [comment:22 jdemeyer]:
> It seems the problem only appears if #14957 and #14958 are also applied.
Unfortunately I still haven't been able to reproduce it.  I tried a different x86_64 system with these patches applied and ran the test 10,000 times, but it succeeds every time.



---

archive/issue_comments_186978.json:
```json
{
    "body": "I tracked down the problem to this line in `devel/sage/sage/libs/singular/singular.pyx`:\n\n```\nret = ret + c\n```\n\nwhere ret is a `pari_ffelt` element equal to zero, `c` is the C `long` equal to 2. The result is 0, while it should be 2.",
    "created_at": "2013-10-01T11:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186978",
    "user": "jdemeyer"
}
```

I tracked down the problem to this line in `devel/sage/sage/libs/singular/singular.pyx`:

```
ret = ret + c
```

where ret is a `pari_ffelt` element equal to zero, `c` is the C `long` equal to 2. The result is 0, while it should be 2.



---

archive/issue_comments_186979.json:
```json
{
    "body": "Great work Jeroen!",
    "created_at": "2013-10-01T11:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186979",
    "user": "jpflori"
}
```

Great work Jeroen!



---

archive/issue_comments_186980.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n> I tracked down the problem to this line in `devel/sage/sage/libs/singular/singular.pyx`:\n> {{{\n> ret = ret + c\n> }}}\n> where ret is a `pari_ffelt` element equal to zero, `c` is the C `long` equal to 2. The result is 0, while it should be 2.\nI wondered about the same line yesterday evening when I was looking at the surrounding function, but thought that it hardly looked like something that could fail with some small probability.  Does this line always give the wrong result (and for some reason just isn't called most of the time)?\n\nI noticed that c is defined by `cdef int c` (i.e. C int, not Python int), but is later used as a long; is that something to be suspicious about?\n\nIf not, then (since `c` is wrapped into a Python `int` before being added to `ret`) it must be the conversion from Python `int` to `pari_ffelt` that is causing the problem, but in that case it is strange that it only fails here.",
    "created_at": "2013-10-01T13:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186980",
    "user": "pbruin"
}
```

Replying to [comment:24 jdemeyer]:
> I tracked down the problem to this line in `devel/sage/sage/libs/singular/singular.pyx`:
> {{{
> ret = ret + c
> }}}
> where ret is a `pari_ffelt` element equal to zero, `c` is the C `long` equal to 2. The result is 0, while it should be 2.
I wondered about the same line yesterday evening when I was looking at the surrounding function, but thought that it hardly looked like something that could fail with some small probability.  Does this line always give the wrong result (and for some reason just isn't called most of the time)?

I noticed that c is defined by `cdef int c` (i.e. C int, not Python int), but is later used as a long; is that something to be suspicious about?

If not, then (since `c` is wrapped into a Python `int` before being added to `ret`) it must be the conversion from Python `int` to `pari_ffelt` that is causing the problem, but in that case it is strange that it only fails here.



---

archive/issue_comments_186981.json:
```json
{
    "body": "Replying to [comment:26 pbruin]:\n> Replying to [comment:24 jdemeyer]:\n> > I tracked down the problem to this line in `devel/sage/sage/libs/singular/singular.pyx`:\n> > {{{\n> > ret = ret + c\n> > }}}\n> > where ret is a `pari_ffelt` element equal to zero, `c` is the C `long` equal to 2. The result is 0, while it should be 2.\n> I wondered about the same line yesterday evening when I was looking at the surrounding function, but thought that it hardly looked like something that could fail with some small probability. \n\n> Does this line always give the wrong result (and for some reason just isn't called most of the time)?\nNo, it *rarely* gives the wrong result.\n\n> I noticed that c is defined by `cdef int c` (i.e. C int, not Python int), but is later used as a long; is that something to be suspicious about?\nIt's not the cleanest coding (`c = <int>napGetCoeff(z)` would be better), but I don't see how that could make a difference, especially since this doesn't seem to be a case of overflow.\n\n> it must be the conversion from Python `int` to `pari_ffelt` that is causing the problem\nI also guess that this is the problem.",
    "created_at": "2013-10-01T14:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186981",
    "user": "jdemeyer"
}
```

Replying to [comment:26 pbruin]:
> Replying to [comment:24 jdemeyer]:
> > I tracked down the problem to this line in `devel/sage/sage/libs/singular/singular.pyx`:
> > {{{
> > ret = ret + c
> > }}}
> > where ret is a `pari_ffelt` element equal to zero, `c` is the C `long` equal to 2. The result is 0, while it should be 2.
> I wondered about the same line yesterday evening when I was looking at the surrounding function, but thought that it hardly looked like something that could fail with some small probability. 

> Does this line always give the wrong result (and for some reason just isn't called most of the time)?
No, it *rarely* gives the wrong result.

> I noticed that c is defined by `cdef int c` (i.e. C int, not Python int), but is later used as a long; is that something to be suspicious about?
It's not the cleanest coding (`c = <int>napGetCoeff(z)` would be better), but I don't see how that could make a difference, especially since this doesn't seem to be a case of overflow.

> it must be the conversion from Python `int` to `pari_ffelt` that is causing the problem
I also guess that this is the problem.



---

archive/issue_comments_186982.json:
```json
{
    "body": "Replying to [comment:27 jdemeyer]:\n> > it must be the conversion from Python `int` to `pari_ffelt` that is causing the problem\n> I also guess that this is the problem.\nIn the line `ret = ret + c`, could you replace `c` by `base(c)` to do the coercion explicitly, just to make sure it isn't some quirk in the coercion system?  Or insert a line verifying that `c == base(c)` to test directly whether it is the conversion that is at fault?",
    "created_at": "2013-10-01T18:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186982",
    "user": "pbruin"
}
```

Replying to [comment:27 jdemeyer]:
> > it must be the conversion from Python `int` to `pari_ffelt` that is causing the problem
> I also guess that this is the problem.
In the line `ret = ret + c`, could you replace `c` by `base(c)` to do the coercion explicitly, just to make sure it isn't some quirk in the coercion system?  Or insert a line verifying that `c == base(c)` to test directly whether it is the conversion that is at fault?



---

archive/issue_comments_186983.json:
```json
{
    "body": "The annoying thing is that this error is damned hard to reproduce. Sometimes adding debugging code makes the error go away. So as long as we haven't found the root of the problem, we're just guessing.",
    "created_at": "2013-10-01T19:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186983",
    "user": "jdemeyer"
}
```

The annoying thing is that this error is damned hard to reproduce. Sometimes adding debugging code makes the error go away. So as long as we haven't found the root of the problem, we're just guessing.



---

archive/issue_comments_186984.json:
```json
{
    "body": "Here is one more guess: in `sage/rings/finite_rings/element_pari_ffelt.pyx` the Python int `x` is first converted into a PARI t_INT as follows (lines 209-210):\n\n```\npari_catch_sig_on()\nx_GEN = (<pari_gen>pari(x)).g\n```\n\nThe order of these two lines should be interchanged.\n\nBefore #15125, the second line was `x_GEN = stoi(x)`; here `pari_catch_sig_on()` must be called first since we call the un-wrapped PARI function.  However, now we call `pari(x)`, which does its own `pari_catch_sig_on()...pari_catch_sig_off()`.  As we know, the current error-handling code is non-reentrant.  I don't see exactly how this could cause our bug, but maybe my imagination is too limited.\n\nThere is a similar mistake in the `__pow__` method in the same file.",
    "created_at": "2013-10-01T22:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186984",
    "user": "pbruin"
}
```

Here is one more guess: in `sage/rings/finite_rings/element_pari_ffelt.pyx` the Python int `x` is first converted into a PARI t_INT as follows (lines 209-210):

```
pari_catch_sig_on()
x_GEN = (<pari_gen>pari(x)).g
```

The order of these two lines should be interchanged.

Before #15125, the second line was `x_GEN = stoi(x)`; here `pari_catch_sig_on()` must be called first since we call the un-wrapped PARI function.  However, now we call `pari(x)`, which does its own `pari_catch_sig_on()...pari_catch_sig_off()`.  As we know, the current error-handling code is non-reentrant.  I don't see exactly how this could cause our bug, but maybe my imagination is too limited.

There is a similar mistake in the `__pow__` method in the same file.



---

archive/issue_comments_186985.json:
```json
{
    "body": "Replying to [comment:30 pbruin]:\n> Here is one more guess: in `sage/rings/finite_rings/element_pari_ffelt.pyx` the Python int `x` is first converted into a PARI t_INT as follows (lines 209-210):\n> {{{\n> pari_catch_sig_on()\n> x_GEN = (<pari_gen>pari(x)).g\n> }}}\n> The order of these two lines should be interchanged.\n> \n> Before #15125, the second line was `x_GEN = stoi(x)`; here `pari_catch_sig_on()` must be called first since we call the un-wrapped PARI function.  However, now we call `pari(x)`, which does its own `pari_catch_sig_on()...pari_catch_sig_off()`.  As we know, the current error-handling code is non-reentrant.  I don't see exactly how this could cause our bug, but maybe my imagination is too limited.\nI agree that is a mistake, but on the other hand, we are not handling any errors here, so the non-reentrant error handling code isn't called. So that cannot explain the problem.\n\n> In the line `ret = ret + c`, could you replace `c` by `base(c)`\nWith that change, I no longer get the error (which unfortunately doesn't imply that the bug is fixed).",
    "created_at": "2013-10-02T06:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186985",
    "user": "jdemeyer"
}
```

Replying to [comment:30 pbruin]:
> Here is one more guess: in `sage/rings/finite_rings/element_pari_ffelt.pyx` the Python int `x` is first converted into a PARI t_INT as follows (lines 209-210):
> {{{
> pari_catch_sig_on()
> x_GEN = (<pari_gen>pari(x)).g
> }}}
> The order of these two lines should be interchanged.
> 
> Before #15125, the second line was `x_GEN = stoi(x)`; here `pari_catch_sig_on()` must be called first since we call the un-wrapped PARI function.  However, now we call `pari(x)`, which does its own `pari_catch_sig_on()...pari_catch_sig_off()`.  As we know, the current error-handling code is non-reentrant.  I don't see exactly how this could cause our bug, but maybe my imagination is too limited.
I agree that is a mistake, but on the other hand, we are not handling any errors here, so the non-reentrant error handling code isn't called. So that cannot explain the problem.

> In the line `ret = ret + c`, could you replace `c` by `base(c)`
With that change, I no longer get the error (which unfortunately doesn't imply that the bug is fixed).



---

archive/issue_comments_186986.json:
```json
{
    "body": "Replying to [comment:31 jdemeyer]:\n> I agree that is a mistake, but on the other hand, we are not handling any errors here, so the non-reentrant error handling code isn't called. So that cannot explain the problem.\nProbably true; the only sort of thing that I could imagine happening here is that PARI runs out of stack space, the call has to be restarted, and the error handler does a `longjmp()` to the wrong stack frame.  However, this can hardly be the problem, because nothing is using a lot of PARI memory here.\n\n> > In the line `ret = ret + c`, could you replace `c` by `base(c)`\n> With that change, I no longer get the error (which unfortunately doesn't imply that the bug is fixed).\nMysterious.  I checked that the coercion system does exactly the same thing internally, as it should (convert the Python int `c` to `pari_ffelt` and then add this to `ret` in `base`), so there is no other intermediate conversion that could go wrong.",
    "created_at": "2013-10-02T09:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186986",
    "user": "pbruin"
}
```

Replying to [comment:31 jdemeyer]:
> I agree that is a mistake, but on the other hand, we are not handling any errors here, so the non-reentrant error handling code isn't called. So that cannot explain the problem.
Probably true; the only sort of thing that I could imagine happening here is that PARI runs out of stack space, the call has to be restarted, and the error handler does a `longjmp()` to the wrong stack frame.  However, this can hardly be the problem, because nothing is using a lot of PARI memory here.

> > In the line `ret = ret + c`, could you replace `c` by `base(c)`
> With that change, I no longer get the error (which unfortunately doesn't imply that the bug is fixed).
Mysterious.  I checked that the coercion system does exactly the same thing internally, as it should (convert the Python int `c` to `pari_ffelt` and then add this to `ret` in `base`), so there is no other intermediate conversion that could go wrong.



---

archive/issue_comments_186987.json:
```json
{
    "body": "Some more news from the debugging camp: I added\n\n```diff\ndiff --git a/sage/rings/finite_rings/element_pari_ffelt.pyx b/sage/rings/finite_rings/element_pari_ffelt.pyx\n--- a/sage/rings/finite_rings/element_pari_ffelt.pyx\n+++ b/sage/rings/finite_rings/element_pari_ffelt.pyx\n@@ -450,6 +450,7 @@\n         pari_catch_sig_on()\n         x.construct(FF_add((<FiniteFieldElement_pari_ffelt>self).val,\n                            (<FiniteFieldElement_pari_ffelt>right).val))\n+        print \"%s + %s = %s\"%(self, right, x)\n         return x\n \n     cpdef ModuleElement _sub_(FiniteFieldElement_pari_ffelt self, ModuleElement right):\n@@ -482,6 +483,7 @@\n         pari_catch_sig_on()\n         x.construct(FF_mul((<FiniteFieldElement_pari_ffelt>self).val,\n                            (<FiniteFieldElement_pari_ffelt>right).val))\n+        print \"%s * %s = %s\"%(self, right, x)\n         return x\n \n     cpdef RingElement _div_(FiniteFieldElement_pari_ffelt self, RingElement right):\n```\n\nand adjusted some doctests. This clearly shows the error in the conversion to PARI:\n\n```\nsage -t devel/sage/sage/schemes/plane_conics/con_finite_field.py\n**********************************************************************\nFile \"devel/sage/sage/schemes/plane_conics/con_finite_field.py\", line 108, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?\nFailed example:\n    C = Conic([1, a, -5]); C\nExpected:\n    a * 1 = a\n    0 + a = a\n    0 + 2 = 2\n    Projective Conic Curve over Finite Field in a of size 7^20 defined by x^2 + (a)*y^2 + 2*z^2\nGot:\n    a * 0 = 0\n    0 + 0 = 0\n    0 + 2 = 2\n    Projective Conic Curve over Finite Field in a of size 7^20 defined by x^2 + (a)*y^2 + 2*z^2\n**********************************************************************\nFile \"devel/sage/sage/schemes/plane_conics/con_finite_field.py\", line 113, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?\nFailed example:\n    C._coefficients\nExpected:\n    [1, 0, 0, a, 0, 2]\nGot:\n    [1, 0, 0, 0, 0, 2]\n**********************************************************************\n```\n",
    "created_at": "2013-10-02T10:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186987",
    "user": "jdemeyer"
}
```

Some more news from the debugging camp: I added

```diff
diff --git a/sage/rings/finite_rings/element_pari_ffelt.pyx b/sage/rings/finite_rings/element_pari_ffelt.pyx
--- a/sage/rings/finite_rings/element_pari_ffelt.pyx
+++ b/sage/rings/finite_rings/element_pari_ffelt.pyx
@@ -450,6 +450,7 @@
         pari_catch_sig_on()
         x.construct(FF_add((<FiniteFieldElement_pari_ffelt>self).val,
                            (<FiniteFieldElement_pari_ffelt>right).val))
+        print "%s + %s = %s"%(self, right, x)
         return x
 
     cpdef ModuleElement _sub_(FiniteFieldElement_pari_ffelt self, ModuleElement right):
@@ -482,6 +483,7 @@
         pari_catch_sig_on()
         x.construct(FF_mul((<FiniteFieldElement_pari_ffelt>self).val,
                            (<FiniteFieldElement_pari_ffelt>right).val))
+        print "%s * %s = %s"%(self, right, x)
         return x
 
     cpdef RingElement _div_(FiniteFieldElement_pari_ffelt self, RingElement right):
```

and adjusted some doctests. This clearly shows the error in the conversion to PARI:

```
sage -t devel/sage/sage/schemes/plane_conics/con_finite_field.py
**********************************************************************
File "devel/sage/sage/schemes/plane_conics/con_finite_field.py", line 108, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?
Failed example:
    C = Conic([1, a, -5]); C
Expected:
    a * 1 = a
    0 + a = a
    0 + 2 = 2
    Projective Conic Curve over Finite Field in a of size 7^20 defined by x^2 + (a)*y^2 + 2*z^2
Got:
    a * 0 = 0
    0 + 0 = 0
    0 + 2 = 2
    Projective Conic Curve over Finite Field in a of size 7^20 defined by x^2 + (a)*y^2 + 2*z^2
**********************************************************************
File "devel/sage/sage/schemes/plane_conics/con_finite_field.py", line 113, in sage.schemes.plane_conics.con_finite_field.ProjectiveConic_finite_field.?
Failed example:
    C._coefficients
Expected:
    [1, 0, 0, a, 0, 2]
Got:
    [1, 0, 0, 0, 0, 2]
**********************************************************************
```




---

archive/issue_comments_186988.json:
```json
{
    "body": "If you have access to boxen, the build I use with these problems is in `/release/sage-5.13.beta0`. You could probably copy that and experiment with it.",
    "created_at": "2013-10-02T10:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186988",
    "user": "jdemeyer"
}
```

If you have access to boxen, the build I use with these problems is in `/release/sage-5.13.beta0`. You could probably copy that and experiment with it.



---

archive/issue_comments_186989.json:
```json
{
    "body": "Replying to [comment:30 pbruin]:\n> Here is one more guess: in `sage/rings/finite_rings/element_pari_ffelt.pyx` the Python int `x` is first converted into a PARI t_INT as follows (lines 209-210):\n> {{{\n> pari_catch_sig_on()\n> x_GEN = (<pari_gen>pari(x)).g\n> }}}\n> The order of these two lines should be interchanged.\nI just tried that, and it doesn't make the error go away.",
    "created_at": "2013-10-02T10:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186989",
    "user": "jdemeyer"
}
```

Replying to [comment:30 pbruin]:
> Here is one more guess: in `sage/rings/finite_rings/element_pari_ffelt.pyx` the Python int `x` is first converted into a PARI t_INT as follows (lines 209-210):
> {{{
> pari_catch_sig_on()
> x_GEN = (<pari_gen>pari(x)).g
> }}}
> The order of these two lines should be interchanged.
I just tried that, and it doesn't make the error go away.



---

archive/issue_comments_186990.json:
```json
{
    "body": "Replying to [comment:32 pbruin]:\n> > > In the line `ret = ret + c`, could you replace `c` by `base(c)`\n> > With that change, I no longer get the error (which unfortunately doesn't imply that the bug is fixed).\n> Mysterious.  I checked that the coercion system does exactly the same thing internally\nHow did you check? I think it's more and more likely that the coercion system is the problem here, because\n\n1) The coercion system is notorious for generating hard-to-reproduce bugs since it relies on (hashes of) memory addresses.\n\n2) Making the conversions explicit (see diff below) fixes the problem.\n\n```diff\ndiff --git a/sage/libs/singular/singular.pyx b/sage/libs/singular/singular.pyx\n--- a/sage/libs/singular/singular.pyx\n+++ b/sage/libs/singular/singular.pyx\n@@ -232,9 +232,9 @@\n         c = <long>napGetCoeff(z)\n         e = napGetExpFrom(z,1, _ring)\n         if e == 0:\n-            ret = ret + c\n+            ret = ret + base(c)\n         elif c != 0:\n-            ret = ret  + c * a**e\n+            ret = ret  + (a**e) * base(c)\n         z = <napoly*>pNext(<poly*>z)\n     return ret\n \n```\n",
    "created_at": "2013-10-02T11:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186990",
    "user": "jdemeyer"
}
```

Replying to [comment:32 pbruin]:
> > > In the line `ret = ret + c`, could you replace `c` by `base(c)`
> > With that change, I no longer get the error (which unfortunately doesn't imply that the bug is fixed).
> Mysterious.  I checked that the coercion system does exactly the same thing internally
How did you check? I think it's more and more likely that the coercion system is the problem here, because

1) The coercion system is notorious for generating hard-to-reproduce bugs since it relies on (hashes of) memory addresses.

2) Making the conversions explicit (see diff below) fixes the problem.

```diff
diff --git a/sage/libs/singular/singular.pyx b/sage/libs/singular/singular.pyx
--- a/sage/libs/singular/singular.pyx
+++ b/sage/libs/singular/singular.pyx
@@ -232,9 +232,9 @@
         c = <long>napGetCoeff(z)
         e = napGetExpFrom(z,1, _ring)
         if e == 0:
-            ret = ret + c
+            ret = ret + base(c)
         elif c != 0:
-            ret = ret  + c * a**e
+            ret = ret  + (a**e) * base(c)
         z = <napoly*>pNext(<poly*>z)
     return ret
 
```




---

archive/issue_comments_186991.json:
```json
{
    "body": "Replying to [comment:34 jdemeyer]:\n> If you have access to boxen, the build I use with these problems is in `/release/sage-5.13.beta0`. You could probably copy that and experiment with it.\nOK, got it.  It gave me a warning about unsupported ssse3 instructions, but at least the files in question don't seem to be affected.",
    "created_at": "2013-10-02T11:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186991",
    "user": "pbruin"
}
```

Replying to [comment:34 jdemeyer]:
> If you have access to boxen, the build I use with these problems is in `/release/sage-5.13.beta0`. You could probably copy that and experiment with it.
OK, got it.  It gave me a warning about unsupported ssse3 instructions, but at least the files in question don't seem to be affected.



---

archive/issue_comments_186992.json:
```json
{
    "body": "Replying to [comment:36 jdemeyer]:\n> > Mysterious.  I checked that the coercion system does exactly the same thing internally\n> How did you check? I think it's more and more likely that the coercion system is the problem here\nI did the following (and I agree that this doesn't prove that the coercion always goes like this):\n\n```\nsage: F.<a>=FiniteField(7^20)\nsage: from sage.structure.coerce import CoercionModel_cache_maps\nsage: cm=CoercionModel_cache_maps()\nsage: cm.explain(a,int(0))\nCoercion on right operand via\n    Conversion map:\n      From: Set of Python objects of type 'int'\n      To:   Finite Field in a of size 7^20\nArithmetic performed after coercions.\nResult lives in Finite Field in a of size 7^20\nFinite Field in a of size 7^20\n```\n",
    "created_at": "2013-10-02T11:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186992",
    "user": "pbruin"
}
```

Replying to [comment:36 jdemeyer]:
> > Mysterious.  I checked that the coercion system does exactly the same thing internally
> How did you check? I think it's more and more likely that the coercion system is the problem here
I did the following (and I agree that this doesn't prove that the coercion always goes like this):

```
sage: F.<a>=FiniteField(7^20)
sage: from sage.structure.coerce import CoercionModel_cache_maps
sage: cm=CoercionModel_cache_maps()
sage: cm.explain(a,int(0))
Coercion on right operand via
    Conversion map:
      From: Set of Python objects of type 'int'
      To:   Finite Field in a of size 7^20
Arithmetic performed after coercions.
Result lives in Finite Field in a of size 7^20
Finite Field in a of size 7^20
```




---

archive/issue_comments_186993.json:
```json
{
    "body": "Got it! The following line is no good:\n\n```\nx_GEN = (<pari_gen>pari(x)).g\n```\n\nPython can destroy the object `pari(x)` because there are no references to it (the pointer `x_GEN` doesn't count as a reference for Python's garbage collecting).",
    "created_at": "2013-10-02T11:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186993",
    "user": "jdemeyer"
}
```

Got it! The following line is no good:

```
x_GEN = (<pari_gen>pari(x)).g
```

Python can destroy the object `pari(x)` because there are no references to it (the pointer `x_GEN` doesn't count as a reference for Python's garbage collecting).



---

archive/issue_comments_186994.json:
```json
{
    "body": "Patch coming up...",
    "created_at": "2013-10-02T11:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186994",
    "user": "jdemeyer"
}
```

Patch coming up...



---

archive/issue_comments_186995.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-10-02T11:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186995",
    "user": "jdemeyer"
}
```

Attachment



---

archive/issue_comments_186996.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-10-02T11:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186996",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_186997.json:
```json
{
    "body": "Replying to [comment:39 jdemeyer]:\n> Got it! The following line is no good:\n> {{{\n> x_GEN = (<pari_gen>pari(x)).g\n> }}}\n> Python can destroy the object `pari(x)` because there are no references to it (the pointer `x_GEN` doesn't count as a reference for Python's garbage collecting).\nBeautiful!  I checked the C code generated by Cython and it does indeed decrease the reference count of this temporary object too early.\n\nI have never been able to reproduce the bug, but I'm convinced that you nailed the problem.  I'll run doctests and then give this a positive review.",
    "created_at": "2013-10-02T13:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186997",
    "user": "pbruin"
}
```

Replying to [comment:39 jdemeyer]:
> Got it! The following line is no good:
> {{{
> x_GEN = (<pari_gen>pari(x)).g
> }}}
> Python can destroy the object `pari(x)` because there are no references to it (the pointer `x_GEN` doesn't count as a reference for Python's garbage collecting).
Beautiful!  I checked the C code generated by Cython and it does indeed decrease the reference count of this temporary object too early.

I have never been able to reproduce the bug, but I'm convinced that you nailed the problem.  I'll run doctests and then give this a positive review.



---

archive/issue_comments_186998.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-10-02T14:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186998",
    "user": "pbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186999.json:
```json
{
    "body": "OK, all tests pass.",
    "created_at": "2013-10-02T14:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-186999",
    "user": "pbruin"
}
```

OK, all tests pass.



---

archive/issue_comments_187000.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-10-07T06:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14684#issuecomment-187000",
    "user": "jdemeyer"
}
```

Resolution: fixed
