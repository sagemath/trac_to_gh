# Issue 22905: Fix missing synchronisation upon starting gap3

Issue created by migration from https://trac.sagemath.org/ticket/23142

Original creator: nthiery

Original creation time: 2017-06-06 02:03:39

CC:  saliola stumpc5 jmichel

Bug reported by Jean Michel:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.0.beta9, Release Date: 2017-05-31               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

sage: gap3.eval("1+1")
''
sage: gap3.eval("1+2")
2
sage: gap3.eval("1+3")
3
```

Equivalently, the above can be reproduced with the `%%gap3` magic.

Analysis: unlike the `gap` interface, no synchronization was done upon starting the `gap3` interface. This did not show up when calling `gap3(cmd)` as the latter triggers an explicit synchronization.

This ticket adds the missing synchronization and, upon suggestion by Jean, adds the option `-b` in the call to gap3 (no banner).


---

Comment by nthiery created at 2017-06-06 02:09:36

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-06-06 02:36:09

Is there suppose to be a branch or marked as invalid?


---

Comment by tscrim created at 2017-06-06 02:36:58

Okay, it seems the commit got mixed in with #23132.


---

Comment by nthiery created at 2017-06-06 03:11:28

Oops; thanks for spotting this. Fixed!
----
New commits:


---

Comment by tscrim created at 2017-06-06 11:14:09

LGTM.


---

Comment by tscrim created at 2017-06-06 11:14:09

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2017-06-06 11:24:10

Thanks!


---

Comment by chapoton created at 2017-06-06 19:44:03

hey, guys.. doctests do not pass...


---

Comment by chapoton created at 2017-06-06 19:44:03

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-06-06 20:12:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-06 20:26:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2017-06-06 20:26:40

Arr, sorry! Apparently I am getting lazy due to being used to having a continuous integration tool immediately running the tests for me ... I can't wait until we really have this for Sage (e.g. more patchbots; we really need to set up a couple of them in Orsay).
In the mean time, I indeed should have waited for my Sage to compile and run the tests for real before setting this for review.


---

Comment by nthiery created at 2017-06-06 20:29:23

The following failures already appear with develop:


```
mistral-/opt/sage/src/sage/interfaces>sage -t --optional gap3 gap3.py 
too many failed tests, not using stored timings
Running doctests with ID 2017-06-06-16-24-24-c343198f.
Git branch: develop
Using --optional=gap3
Doctesting 1 file.
sage -t gap3.py
**********************************************************************
File "gap3.py", line 441, in sage.interfaces.gap3.Gap3.help
Failed example:
    m                                        #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    <BLANKLINE>
**********************************************************************
File "gap3.py", line 443, in sage.interfaces.gap3.Gap3.help
Failed example:
    m.Print()                                #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    "__SAGE_LAST__"
**********************************************************************
File "gap3.py", line 447, in sage.interfaces.gap3.Gap3.help
Failed example:
    m                                        #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    <BLANKLINE>
**********************************************************************
File "gap3.py", line 449, in sage.interfaces.gap3.Gap3.help
Failed example:
    m.Print()                                #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    "__SAGE_LAST__"
**********************************************************************
1 item had failures:
   4 of  10 in sage.interfaces.gap3.Gap3.help
    [95 tests, 4 failures, 11.90 s]
----------------------------------------------------------------------
sage -t gap3.py  # 4 doctests failed
----------------------------------------------------------------------
Total time for all tests: 18.0 seconds
    cpu time: 4.2 seconds
    cumulative wall time: 11.9 seconds
```


Something should be done about them, but it's an independent problem.
Hence back to needs review.


---

Comment by nthiery created at 2017-06-06 21:36:21

Out of curiosity, I just tried fixing the above problem by adding a ``self._expect.expect("`@`i")`` at the end of ``Gap3.help``. This in case there would be a trivial fix to include in this ticket. This seemed at first to work, but not quite; it triggers another error

```
sage -t gap3.py
**********************************************************************
File "gap3.py", line 717, in sage.interfaces.gap3.GAP3Element.__getitem__
Failed example:
    a[1]                                     #optional - gap3
Expected:
    1
Got:
    2
```


I am therefore dropping the case.


---

Comment by tscrim created at 2017-06-08 08:47:52

Ah, right, gap3 is not optional but experimental. I also get the same errors with

```
./sage -tp --optional=sage,gap3 src/sage/interfaces/gap3.py
```

on both `develop` and this branch.


---

Comment by tscrim created at 2017-06-08 08:47:52

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-06-11 09:13:21

Resolution: fixed
