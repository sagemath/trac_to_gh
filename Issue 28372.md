# Issue 28372: Coercion of multivariate polynomials over padics

archive/issues_028372.json:
```json
{
    "body": "CC:  @alexjbest\n\n\n```\nsage:PolynomialRing(Qp(2), 3, 'x')({(0,0,0):O(2)}).dict()\n{}\n```\n\ninstead of\n`{(0,0,0):O(2)}`\n\nAs a side effect substitution is also broken:\n\n```\nsage: R.<x,y,z> = Qp(2)[]\nsage: f = x  + y + z - 1\nsage: f.dict()\n{(0, 0, 0): 1 + 2 + 2^2 + 2^3 + 2^4 + 2^5 + 2^6 + 2^7 + 2^8 + 2^9 + 2^10 + 2^11 + 2^12 + 2^13 + 2^14 + 2^15 + 2^16 + 2^17 + 2^18 + 2^19 + O(2^20),\n (0, 0, 1): 1 + O(2^20),\n (0, 1, 0): 1 + O(2^20),\n (1, 0, 0): 1 + O(2^20)}\nsage: f.substitute(x=Qp(2)(1).add_bigoh(1)).dict()\n{(0, 0, 1): 1 + O(2^20), (0, 1, 0): 1 + O(2^20)}\nsage: f((Qp(2)(1).add_bigoh(1),y,z)).dict()\n{(0, 0, 1): 1 + O(2^20), (0, 1, 0): 1 + O(2^20)}\n```\n\n\nWhile I would expect: `{(0, 0, 1): 1 + O(2^20), (0, 1, 0): 1 + O(2^20), (0,0,0): O(2)}`\n\nAlex Best, pointed out that most likely this has to do with a \nkey removal being done with\n`if blah == 0:` instead of `if blah.is_zero()`\n\nIssue created by migration from https://trac.sagemath.org/ticket/28609\n\n",
    "created_at": "2019-10-15T15:35:06Z",
    "labels": [
        "padics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Coercion of multivariate polynomials over padics",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28372",
    "user": "@edgarcosta"
}
```
CC:  @alexjbest


```
sage:PolynomialRing(Qp(2), 3, 'x')({(0,0,0):O(2)}).dict()
{}
```

instead of
`{(0,0,0):O(2)}`

As a side effect substitution is also broken:

```
sage: R.<x,y,z> = Qp(2)[]
sage: f = x  + y + z - 1
sage: f.dict()
{(0, 0, 0): 1 + 2 + 2^2 + 2^3 + 2^4 + 2^5 + 2^6 + 2^7 + 2^8 + 2^9 + 2^10 + 2^11 + 2^12 + 2^13 + 2^14 + 2^15 + 2^16 + 2^17 + 2^18 + 2^19 + O(2^20),
 (0, 0, 1): 1 + O(2^20),
 (0, 1, 0): 1 + O(2^20),
 (1, 0, 0): 1 + O(2^20)}
sage: f.substitute(x=Qp(2)(1).add_bigoh(1)).dict()
{(0, 0, 1): 1 + O(2^20), (0, 1, 0): 1 + O(2^20)}
sage: f((Qp(2)(1).add_bigoh(1),y,z)).dict()
{(0, 0, 1): 1 + O(2^20), (0, 1, 0): 1 + O(2^20)}
```


While I would expect: `{(0, 0, 1): 1 + O(2^20), (0, 1, 0): 1 + O(2^20), (0,0,0): O(2)}`

Alex Best, pointed out that most likely this has to do with a 
key removal being done with
`if blah == 0:` instead of `if blah.is_zero()`

Issue created by migration from https://trac.sagemath.org/ticket/28609





---

archive/issue_comments_400647.json:
```json
{
    "body": "The problem is in the PolyDict __add__ function calls the PolyDict constructor with zero=K.zero() and remove_zeroes=True, this is quite awkward as it makes it hard to fix this while maintaining that variables with exact zero coefficient removed. Maybe this should be changed so that if PolyDict constructor is called with remove_zeroes=True then the base ring `.is_zero()` method is called. Possibly this is a performance hit though?\n\nthe offending lines are \n\n```\nif pdict[k] == zero:\n    del pdict[k]\n```\n\nin sage/rings/polynomial/polydict.pyx\n\n\nAs for the constructor issue, it is the same with line `x = polydict.PolyDict(x, parent.base_ring()(0), remove_zero=True)` in `sage/rings/polynomial/multi_polynomial_element.py` that does it.",
    "created_at": "2019-10-15T15:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28372",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28372#issuecomment-400647",
    "user": "@alexjbest"
}
```

The problem is in the PolyDict __add__ function calls the PolyDict constructor with zero=K.zero() and remove_zeroes=True, this is quite awkward as it makes it hard to fix this while maintaining that variables with exact zero coefficient removed. Maybe this should be changed so that if PolyDict constructor is called with remove_zeroes=True then the base ring `.is_zero()` method is called. Possibly this is a performance hit though?

the offending lines are 

```
if pdict[k] == zero:
    del pdict[k]
```

in sage/rings/polynomial/polydict.pyx


As for the constructor issue, it is the same with line `x = polydict.PolyDict(x, parent.base_ring()(0), remove_zero=True)` in `sage/rings/polynomial/multi_polynomial_element.py` that does it.



---

archive/issue_comments_400648.json:
```json
{
    "body": "Alex asked today about this ticket at the p-adics meeting on zulip.\n> Essentially the issue is that O(2) == 0 is true and a notion of exact zero should be used instead, I notice that there is a function _is_exact_zero but also x.is_zero(absprec=Infinity) for p-adic elements, are either of these suitable for a fix?\n\nJulian mentioned there's at least one more ticket about this somewhere\n\nOn side a note, univariate polynomials seem to do the right thing:\n\n```\nsage: f = PolynomialRing(Qp(2),'a')([O(2),O(2^3)])\nsage: f\nO(2^3)*a + O(2)\n```\n",
    "created_at": "2019-10-18T00:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28372",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28372#issuecomment-400648",
    "user": "@edgarcosta"
}
```

Alex asked today about this ticket at the p-adics meeting on zulip.
> Essentially the issue is that O(2) == 0 is true and a notion of exact zero should be used instead, I notice that there is a function _is_exact_zero but also x.is_zero(absprec=Infinity) for p-adic elements, are either of these suitable for a fix?

Julian mentioned there's at least one more ticket about this somewhere

On side a note, univariate polynomials seem to do the right thing:

```
sage: f = PolynomialRing(Qp(2),'a')([O(2),O(2^3)])
sage: f
O(2^3)*a + O(2)
```




---

archive/issue_comments_400649.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28372",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28372#issuecomment-400649",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_400650.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28372",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28372#issuecomment-400650",
    "user": "@mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_400651.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28372",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28372#issuecomment-400651",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
