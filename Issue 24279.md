# Issue 24279: Cygwin test failures in lseries_ell

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-01-11 15:35:03

CC:  jdemeyer

Keywords: pari

I have been seeing regular test failures on the Cygwin patchbot of the form:


```
sage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 269, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros
Failed example:
    E.lseries().zeros(2)
Expected:
    [0.000000000, 5.00317001]
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    [0.000000000, 5.00317001]
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 272, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros
Failed example:
    a = E.lseries().zeros(20)             # long time
Expected nothing
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 307, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros_in_interval
Failed example:
    E.lseries().zeros_in_interval(6, 10, 0.1)      # long time
Expected:
    [(6.87039122, 0.248922780), (8.01433081, -0.140168533), (9.93309835, -0.129943029)]
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    [(6.87039122, 0.248922780),
     (8.01433081, -0.140168533),
     (9.93309835, -0.129943029)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 338, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.values_along_line
Failed example:
    E.lseries().values_along_line(1, 0.5 + 20*I, 5)
Expected:
    [(0.500000000, ...),
     (0.400000000 + 4.00000000*I, 3.31920245 - 2.60028054*I),
     (0.300000000 + 8.00000000*I, -0.886341185 - 0.422640337*I),
     (0.200000000 + 12.0000000*I, -3.50558936 - 0.108531690*I),
     (0.100000000 + 16.0000000*I, -3.87043288 - 1.88049411*I)]
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    [(0.500000000, 0.000000000),
     (0.400000000 + 4.00000000*I, 3.31920245 - 2.60028054*I),
     (0.300000000 + 8.00000000*I, -0.886341185 - 0.422640337*I),
     (0.200000000 + 12.0000000*I, -3.50558936 - 0.108531690*I),
     (0.100000000 + 16.0000000*I, -3.87043288 - 1.88049411*I)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 376, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_values
Failed example:
    vals = E.lseries().twist_values(1, -12, -4)
Expected nothing
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 416, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_zeros
Failed example:
    E.lseries().twist_zeros(3, -4, -3)         # long time
Expected:
    {-4: [1.60813783, 2.96144840, 3.89751747], -3: [2.06170900, 3.48216881, 4.45853219]}
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    {-4: [1.60813783, 2.96144840, 3.89751747],
     -3: [2.06170900, 3.48216881, 4.45853219]}
**********************************************************************
5 items had failures:
   1 of   8 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_values
   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_zeros
   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.values_along_line
   2 of   5 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros
   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros_in_interval
    [99 tests, 6 failures, 13.63 s]
```


#24481 would work around this by squelching the relevant warning (which comes from PARI), but it would b good to investigate why this is happening in the first place.


---

Comment by jdemeyer created at 2018-01-11 15:46:05

Thanks! I thought that the failures were caused by #24481 but that's not the case.


---

Comment by jdemeyer created at 2018-01-11 15:51:34

Could it be that you are genuinely running low on memory? Does Windows have a concept of overcommitting memory, where an application can request much more memory than is available? It seems that lcalc is allocating 1GB of memory, but it only uses a small part of it.


---

Comment by jdemeyer created at 2018-01-11 16:11:31

I looked in the sources and it's pretty simple where this warning comes from: lcalc wants to use PARI with a hardcoded stack size of 1 GB. PARI tries to allocate this memory (using `mmap`) and this allocation fails. It then halves the stack size (printing the warning) until it succeeds with 1/4 GB. Since there are no further failures, apparently that stack size is sufficient.

Now _why_ this happens on your Cygwin patchbot is an entirely different question.


---

Comment by jdemeyer created at 2018-01-11 16:39:33

Looking more closely at the lcalc sources... it actually first creates a PARI stack of 1 GB to do some preliminary computations and then resizes it to `(size_t)N_terms*16 + 1000000`. Probably the preliminary computations can be done with much less stack, I'll investigate.


---

Comment by embray created at 2018-01-12 09:56:28

Wow, thanks for looking into it so quickly.  I think it should be able to allocate 1GB but I'll take a closer look.  The VM that patchbot is running on has actually been really bad lately and I've been trying to get onto better hardware.


---

Comment by jdemeyer created at 2018-01-12 10:03:42

It's also good to know that there is a plan to get rid of lcalc completely in Sage. We should be able to replace it with functionality from PARI itself. I plan to work on that next week during the [PARI atelier](https://pari.math.u-bordeaux.fr/Events/PARI2018/). Just to say: don't waste too much time with lcalc.


---

Comment by embray created at 2018-01-15 09:02:42

Oh okay, thanks for letting me know.


---

Comment by jdemeyer created at 2018-01-15 09:06:29

See #24532 for that.


---

Comment by jdemeyer created at 2018-01-15 16:52:14

Since I closed #24532 as "wontfix", we need to fix this issue anyway. I'll have a look.


---

Comment by jdemeyer created at 2018-01-30 11:02:52

All tests involving lcalc still pass when decreasing the initial stack from 1GB to 1MB. So I propose to use 16MB which should still have plenty of margin.
----
New commits:


---

Comment by jdemeyer created at 2018-01-30 11:02:52

Changing status from new to needs_review.


---

Comment by embray created at 2018-01-30 11:14:00

Thanks. I'll give this a try.


---

Comment by embray created at 2018-02-02 13:52:43

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-02-02 13:52:43

Seems to work--thanks.


---

Comment by vbraun created at 2018-02-03 17:50:05

Resolution: fixed
