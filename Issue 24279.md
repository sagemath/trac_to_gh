# Issue 24279: Cygwin test failures in lseries_ell

archive/issues_024279.json:
```json
{
    "body": "CC:  @jdemeyer\n\nKeywords: pari\n\nI have been seeing regular test failures on the Cygwin patchbot of the form:\n\n```\nsage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/lseries_ell.py\", line 269, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros\nFailed example:\n    E.lseries().zeros(2)\nExpected:\n    [0.000000000, 5.00317001]\nGot:\n      ***   Warning: not enough memory, new stack 500039680\n      ***   Warning: not enough memory, new stack 250019840\n    [0.000000000, 5.00317001]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/lseries_ell.py\", line 272, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros\nFailed example:\n    a = E.lseries().zeros(20)             # long time\nExpected nothing\nGot:\n      ***   Warning: not enough memory, new stack 500039680\n      ***   Warning: not enough memory, new stack 250019840\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/lseries_ell.py\", line 307, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros_in_interval\nFailed example:\n    E.lseries().zeros_in_interval(6, 10, 0.1)      # long time\nExpected:\n    [(6.87039122, 0.248922780), (8.01433081, -0.140168533), (9.93309835, -0.129943029)]\nGot:\n      ***   Warning: not enough memory, new stack 500039680\n      ***   Warning: not enough memory, new stack 250019840\n    [(6.87039122, 0.248922780),\n     (8.01433081, -0.140168533),\n     (9.93309835, -0.129943029)]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/lseries_ell.py\", line 338, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.values_along_line\nFailed example:\n    E.lseries().values_along_line(1, 0.5 + 20*I, 5)\nExpected:\n    [(0.500000000, ...),\n     (0.400000000 + 4.00000000*I, 3.31920245 - 2.60028054*I),\n     (0.300000000 + 8.00000000*I, -0.886341185 - 0.422640337*I),\n     (0.200000000 + 12.0000000*I, -3.50558936 - 0.108531690*I),\n     (0.100000000 + 16.0000000*I, -3.87043288 - 1.88049411*I)]\nGot:\n      ***   Warning: not enough memory, new stack 500039680\n      ***   Warning: not enough memory, new stack 250019840\n    [(0.500000000, 0.000000000),\n     (0.400000000 + 4.00000000*I, 3.31920245 - 2.60028054*I),\n     (0.300000000 + 8.00000000*I, -0.886341185 - 0.422640337*I),\n     (0.200000000 + 12.0000000*I, -3.50558936 - 0.108531690*I),\n     (0.100000000 + 16.0000000*I, -3.87043288 - 1.88049411*I)]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/lseries_ell.py\", line 376, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_values\nFailed example:\n    vals = E.lseries().twist_values(1, -12, -4)\nExpected nothing\nGot:\n      ***   Warning: not enough memory, new stack 500039680\n      ***   Warning: not enough memory, new stack 250019840\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/lseries_ell.py\", line 416, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_zeros\nFailed example:\n    E.lseries().twist_zeros(3, -4, -3)         # long time\nExpected:\n    {-4: [1.60813783, 2.96144840, 3.89751747], -3: [2.06170900, 3.48216881, 4.45853219]}\nGot:\n      ***   Warning: not enough memory, new stack 500039680\n      ***   Warning: not enough memory, new stack 250019840\n    {-4: [1.60813783, 2.96144840, 3.89751747],\n     -3: [2.06170900, 3.48216881, 4.45853219]}\n**********************************************************************\n5 items had failures:\n   1 of   8 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_values\n   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_zeros\n   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.values_along_line\n   2 of   5 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros\n   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros_in_interval\n    [99 tests, 6 failures, 13.63 s]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/24516\n\n",
    "closed_at": "2018-02-03T17:50:05Z",
    "created_at": "2018-01-11T15:35:03Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Cygwin test failures in lseries_ell",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24279",
    "user": "https://github.com/embray"
}
```
CC:  @jdemeyer

Keywords: pari

I have been seeing regular test failures on the Cygwin patchbot of the form:

```
sage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 269, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros
Failed example:
    E.lseries().zeros(2)
Expected:
    [0.000000000, 5.00317001]
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    [0.000000000, 5.00317001]
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 272, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros
Failed example:
    a = E.lseries().zeros(20)             # long time
Expected nothing
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 307, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros_in_interval
Failed example:
    E.lseries().zeros_in_interval(6, 10, 0.1)      # long time
Expected:
    [(6.87039122, 0.248922780), (8.01433081, -0.140168533), (9.93309835, -0.129943029)]
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    [(6.87039122, 0.248922780),
     (8.01433081, -0.140168533),
     (9.93309835, -0.129943029)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 338, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.values_along_line
Failed example:
    E.lseries().values_along_line(1, 0.5 + 20*I, 5)
Expected:
    [(0.500000000, ...),
     (0.400000000 + 4.00000000*I, 3.31920245 - 2.60028054*I),
     (0.300000000 + 8.00000000*I, -0.886341185 - 0.422640337*I),
     (0.200000000 + 12.0000000*I, -3.50558936 - 0.108531690*I),
     (0.100000000 + 16.0000000*I, -3.87043288 - 1.88049411*I)]
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    [(0.500000000, 0.000000000),
     (0.400000000 + 4.00000000*I, 3.31920245 - 2.60028054*I),
     (0.300000000 + 8.00000000*I, -0.886341185 - 0.422640337*I),
     (0.200000000 + 12.0000000*I, -3.50558936 - 0.108531690*I),
     (0.100000000 + 16.0000000*I, -3.87043288 - 1.88049411*I)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 376, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_values
Failed example:
    vals = E.lseries().twist_values(1, -12, -4)
Expected nothing
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
**********************************************************************
File "src/sage/schemes/elliptic_curves/lseries_ell.py", line 416, in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_zeros
Failed example:
    E.lseries().twist_zeros(3, -4, -3)         # long time
Expected:
    {-4: [1.60813783, 2.96144840, 3.89751747], -3: [2.06170900, 3.48216881, 4.45853219]}
Got:
      ***   Warning: not enough memory, new stack 500039680
      ***   Warning: not enough memory, new stack 250019840
    {-4: [1.60813783, 2.96144840, 3.89751747],
     -3: [2.06170900, 3.48216881, 4.45853219]}
**********************************************************************
5 items had failures:
   1 of   8 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_values
   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.twist_zeros
   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.values_along_line
   2 of   5 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros
   1 of   3 in sage.schemes.elliptic_curves.lseries_ell.Lseries_ell.zeros_in_interval
    [99 tests, 6 failures, 13.63 s]
```

Issue created by migration from https://trac.sagemath.org/ticket/24516





---

archive/issue_comments_339548.json:
```json
{
    "body": "Thanks! I thought that the failures were caused by #24481 but that's not the case.",
    "created_at": "2018-01-11T15:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339548",
    "user": "https://github.com/jdemeyer"
}
```

Thanks! I thought that the failures were caused by #24481 but that's not the case.



---

archive/issue_comments_339549.json:
```json
{
    "body": "Could it be that you are genuinely running low on memory? Does Windows have a concept of overcommitting memory, where an application can request much more memory than is available? It seems that lcalc is allocating 1GB of memory, but it only uses a small part of it.",
    "created_at": "2018-01-11T15:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339549",
    "user": "https://github.com/jdemeyer"
}
```

Could it be that you are genuinely running low on memory? Does Windows have a concept of overcommitting memory, where an application can request much more memory than is available? It seems that lcalc is allocating 1GB of memory, but it only uses a small part of it.



---

archive/issue_comments_339550.json:
```json
{
    "body": "I looked in the sources and it's pretty simple where this warning comes from: lcalc wants to use PARI with a hardcoded stack size of 1\u00a0GB. PARI tries to allocate this memory (using `mmap`) and this allocation fails. It then halves the stack size (printing the warning) until it succeeds with 1/4\u00a0GB. Since there are no further failures, apparently that stack size is sufficient.\n\nNow *why* this happens on your Cygwin patchbot is an entirely different question.",
    "created_at": "2018-01-11T16:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339550",
    "user": "https://github.com/jdemeyer"
}
```

I looked in the sources and it's pretty simple where this warning comes from: lcalc wants to use PARI with a hardcoded stack size of 1 GB. PARI tries to allocate this memory (using `mmap`) and this allocation fails. It then halves the stack size (printing the warning) until it succeeds with 1/4 GB. Since there are no further failures, apparently that stack size is sufficient.

Now *why* this happens on your Cygwin patchbot is an entirely different question.



---

archive/issue_comments_339551.json:
```json
{
    "body": "Looking more closely at the lcalc sources... it actually first creates a PARI stack of 1 GB to do some preliminary computations and then resizes it to `(size_t)N_terms*16 + 1000000`. Probably the preliminary computations can be done with much less stack, I'll investigate.",
    "created_at": "2018-01-11T16:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339551",
    "user": "https://github.com/jdemeyer"
}
```

Looking more closely at the lcalc sources... it actually first creates a PARI stack of 1 GB to do some preliminary computations and then resizes it to `(size_t)N_terms*16 + 1000000`. Probably the preliminary computations can be done with much less stack, I'll investigate.



---

archive/issue_comments_339552.json:
```json
{
    "body": "Wow, thanks for looking into it so quickly.  I think it should be able to allocate 1GB but I'll take a closer look.  The VM that patchbot is running on has actually been really bad lately and I've been trying to get onto better hardware.",
    "created_at": "2018-01-12T09:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339552",
    "user": "https://github.com/embray"
}
```

Wow, thanks for looking into it so quickly.  I think it should be able to allocate 1GB but I'll take a closer look.  The VM that patchbot is running on has actually been really bad lately and I've been trying to get onto better hardware.



---

archive/issue_comments_339553.json:
```json
{
    "body": "It's also good to know that there is a plan to get rid of lcalc completely in Sage. We should be able to replace it with functionality from PARI itself. I plan to work on that next week during the [PARI atelier](https://pari.math.u-bordeaux.fr/Events/PARI2018/). Just to say: don't waste too much time with lcalc.",
    "created_at": "2018-01-12T10:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339553",
    "user": "https://github.com/jdemeyer"
}
```

It's also good to know that there is a plan to get rid of lcalc completely in Sage. We should be able to replace it with functionality from PARI itself. I plan to work on that next week during the [PARI atelier](https://pari.math.u-bordeaux.fr/Events/PARI2018/). Just to say: don't waste too much time with lcalc.



---

archive/issue_comments_339554.json:
```json
{
    "body": "Oh okay, thanks for letting me know.",
    "created_at": "2018-01-15T09:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339554",
    "user": "https://github.com/embray"
}
```

Oh okay, thanks for letting me know.



---

archive/issue_comments_339555.json:
```json
{
    "body": "See #24532 for that.",
    "created_at": "2018-01-15T09:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339555",
    "user": "https://github.com/jdemeyer"
}
```

See #24532 for that.



---

archive/issue_comments_339556.json:
```json
{
    "body": "Since I closed #24532 as \"wontfix\", we need to fix this issue anyway. I'll have a look.",
    "created_at": "2018-01-15T16:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339556",
    "user": "https://github.com/jdemeyer"
}
```

Since I closed #24532 as "wontfix", we need to fix this issue anyway. I'll have a look.



---

archive/issue_comments_339557.json:
```json
{
    "body": "All tests involving lcalc still pass when decreasing the initial stack from 1GB to 1MB. So I propose to use 16MB which should still have plenty of margin.\n\n---\nNew commits:",
    "created_at": "2018-01-30T11:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339557",
    "user": "https://github.com/jdemeyer"
}
```

All tests involving lcalc still pass when decreasing the initial stack from 1GB to 1MB. So I propose to use 16MB which should still have plenty of margin.

---
New commits:



---

archive/issue_comments_339558.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-30T11:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339558",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_339559.json:
```json
{
    "body": "Thanks. I'll give this a try.",
    "created_at": "2018-01-30T11:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339559",
    "user": "https://github.com/embray"
}
```

Thanks. I'll give this a try.



---

archive/issue_comments_339560.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-02T13:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339560",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339561.json:
```json
{
    "body": "Seems to work--thanks.",
    "created_at": "2018-02-02T13:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339561",
    "user": "https://github.com/embray"
}
```

Seems to work--thanks.



---

archive/issue_comments_339562.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-03T17:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24279#issuecomment-339562",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061833.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-03T17:50:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24279",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24279#event-61833"
}
```
