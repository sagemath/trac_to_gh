# Issue 12779: Support cached_methods on extension types

Issue created by migration from https://trac.sagemath.org/ticket/12951

Original creator: SimonKing

Original creation time: 2012-05-15 17:15:03

Assignee: jason

CC:  hivert robertwb

In old versions of Cython, one would have seen an error like "arbitrary decorators are not supported" when attempting to use `@`cached_method on the methods of a cdef class. That has now been improved. However, cached methods would still not work, because an attribute `__module__` is requested that does not exist.

The aim is to work around that limitation, so that cached methods and functions genuinely work in Cython.


---

Comment by SimonKing created at 2012-05-15 21:02:49

Changing status from new to needs_review.


---

Comment by SimonKing created at 2012-05-15 21:02:49

As it turns out, it is still impossible to use arbitrary decorators on c(p)def functions or methods. However, the attached patch makes it possible to use the decorator on def-methods of extension classes. That used to fail, because of the attribute error mentioned in the ticket description. It is of course still required that the instances of the extension class either allow to override an attribute of the class by an attribute of the instance, or that the instance has a public attribute `__cached_methods`.

For the latter case, we now have (from the doc tests):

```
    sage: cython_code = [
    ... "from sage.misc.cachefunc import cached_method",
    ... "cdef class MyClass:",
    ... "    cdef public dict __cached_methods",
    ... "    @cached_method",
    ... "    def f(self, a,b):",
    ... "        return a*b"]
    sage: cython(os.linesep.join(cython_code))
    sage: P = MyClass()
    sage: P.f(2,3)
    6
    sage: P.f(2,3) is P.f(2,3)
    True
```

Note that by #11115, sage.structure.parent.Parent has the `__cached_methods` attribute. Hence, any cdef subclass of Parent will do!

Providing attribute access is a bit more tricky, since it is needed that an attribute inherited by the instance from its class can be overridden on the instance. That is why providing a `__getattr__` would not be enough in the following example:

```
    sage: cython_code = [
    ... "from sage.misc.cachefunc import cached_method",
    ... "cdef class MyOtherClass:",
    ... "    cdef dict D",
    ... "    def __init__(self):",
    ... "        self.D = {}",
    ... "    def __setattr__(self, n,v):",
    ... "        self.D[n] = v",
    ... "    def __getattribute__(self, n):",
    ... "        try:",
    ... "            return self.D[n]",
    ... "        except KeyError:",
    ... "            pass",
    ... "        return getattr(type(self),n).__get__(self)",
    ... "    @cached_method",
    ... "    def f(self, a,b):",
    ... "        return a+b"]
    sage: cython(os.linesep.join(cython_code))
    sage: Q = MyOtherClass()
    sage: Q.f(2,3)
    5
    sage: Q.f(2,3) is Q.f(2,3)
    True
```


Supporting attribute access apparently is more complicated than the other approach, and probably not recommended. However, on cached methods, it is somehow faster than the easier method:

```
    sage: timeit("a = P.f(2,3)")   # random
    625 loops, best of 3: 1.3 Âµs per loop
    sage: timeit("a = Q.f(2,3)")   # random
    625 loops, best of 3: 931 ns per loop
```


Needs review!


---

Comment by SimonKing created at 2012-06-25 09:11:46

Any reviewer?


---

Comment by SimonKing created at 2012-08-14 11:02:05

There is a conflict with #12215. Both tickets need review, but I think that #12215 is more important than this ticket. Hence, I introduced a dependency, and changed my patch accordingly.


---

Comment by SimonKing created at 2013-01-19 18:28:14

Note to myself: Test that this patch still applies.


---

Comment by SimonKing created at 2013-01-21 10:17:13

Patch relative to #12215


---

Attachment

I had to rebase the patch. Now it should work again. Still needing review!


---

Comment by tscrim created at 2013-04-01 22:48:23

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2013-04-01 22:48:23

Looks good to me. Thanks Simon.


---

Comment by jdemeyer created at 2013-04-04 17:38:44

Resolution: fixed
