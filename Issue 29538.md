# Issue 29538: Add a bit of typing to manifolds package

archive/issues_029538.json:
```json
{
    "body": "CC:  @tscrim @nthiery @mjungmath @fchapoton\n\nKeywords: typing\n\nThis PR adds a bit of typing information to some of the methods in the manifolds package that I added while browsing the code. I've changed the inline documentation accordingly. If these types of changes are ok, I'll add further typing information as I proceed understanding the code.\nProbably the biggest change is the addition of the identity map for a smooth manifold (which is a `DiffMap` and not just a `ContininousMap`).\n\nMoreover, a few very minor clarifications to the documentation were added as well.\n\n(This is my first real PR to sagemath, so please forgive me if I overlooked something.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/29775\n\n",
    "created_at": "2020-06-01T12:04:41Z",
    "labels": [
        "component: geometry",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Add a bit of typing to manifolds package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29538",
    "user": "https://github.com/tobiasdiez"
}
```
CC:  @tscrim @nthiery @mjungmath @fchapoton

Keywords: typing

This PR adds a bit of typing information to some of the methods in the manifolds package that I added while browsing the code. I've changed the inline documentation accordingly. If these types of changes are ok, I'll add further typing information as I proceed understanding the code.
Probably the biggest change is the addition of the identity map for a smooth manifold (which is a `DiffMap` and not just a `ContininousMap`).

Moreover, a few very minor clarifications to the documentation were added as well.

(This is my first real PR to sagemath, so please forgive me if I overlooked something.)

Issue created by migration from https://trac.sagemath.org/ticket/29775





---

archive/issue_comments_418915.json:
```json
{
    "body": "In case people are interested in a general discussion of typing in the Sage library: #29756 Meta-ticket: Review of Python 3 features that sagelib should use systematically",
    "created_at": "2020-06-01T19:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418915",
    "user": "https://github.com/mkoeppe"
}
```

In case people are interested in a general discussion of typing in the Sage library: #29756 Meta-ticket: Review of Python 3 features that sagelib should use systematically



---

archive/issue_comments_418916.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-01T22:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418916",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_418917.json:
```json
{
    "body": "The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...",
    "created_at": "2020-06-02T10:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418917",
    "user": "https://github.com/egourgoulhon"
}
```

The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...



---

archive/issue_comments_418918.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-02T14:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418918",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418919.json:
```json
{
    "body": "Replying to [comment:3 egourgoulhon]:\n> The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...\n\n\nI think this is a very important point, and one that needs discussion in a broader context. \n\n1) Can the category system be used to add these tightened type annotations automatically?\n\n2) In such situations, should the doctests be replaced or augmented by `_test_...` methods so that subclasses are tested properly.",
    "created_at": "2020-06-02T16:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418919",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:3 egourgoulhon]:
> The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...


I think this is a very important point, and one that needs discussion in a broader context. 

1) Can the category system be used to add these tightened type annotations automatically?

2) In such situations, should the doctests be replaced or augmented by `_test_...` methods so that subclasses are tested properly.



---

archive/issue_comments_418920.json:
```json
{
    "body": "Replying to [comment:3 egourgoulhon]:\n> The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...\n\n\nIf we don't duplicate the code, then the output type of `identity_map` is indicated as `ContinuousMap`, which is correct for a smooth manifold as well. Of course, for such a manifold, it is a particular kind of continuous map, namely a smooth one and the returned object pertains to the subclass `DiffMap` of `ContinuousMap`. But I would say we can live with this; IMHO, it is preferable not to duplicate the code and have type hints not as precise as they could be.",
    "created_at": "2020-06-02T18:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418920",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:3 egourgoulhon]:
> The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...


If we don't duplicate the code, then the output type of `identity_map` is indicated as `ContinuousMap`, which is correct for a smooth manifold as well. Of course, for such a manifold, it is a particular kind of continuous map, namely a smooth one and the returned object pertains to the subclass `DiffMap` of `ContinuousMap`. But I would say we can live with this; IMHO, it is preferable not to duplicate the code and have type hints not as precise as they could be.



---

archive/issue_comments_418921.json:
```json
{
    "body": "It's true that I noticed while working on typing support, but the addition is actually rather independent of this. As Eric says, `identity_map` on a differentiable manifold only returns a `ContinuousMap` and one can thus not take it's differential etc. So far this doesn't lead to any problems since the identity case is always handled separately in the code. I'm not familiar with the category code, but maybe it can be improved so that the function `def hom_set: return Hom(self, self)` defined in class A, returns the correct homomrophisms for derived classes `B(A)` as well (so `b.hom_set` returns the hom set of `b` as an element of B).\n\nIf it were just for typing, one could also annotate the original `identity_map` on `TopologicalManifold` (see https://mypy.readthedocs.io/en/stable/more_types.html#advanced-uses-of-self-types).",
    "created_at": "2020-06-03T11:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418921",
    "user": "https://github.com/tobiasdiez"
}
```

It's true that I noticed while working on typing support, but the addition is actually rather independent of this. As Eric says, `identity_map` on a differentiable manifold only returns a `ContinuousMap` and one can thus not take it's differential etc. So far this doesn't lead to any problems since the identity case is always handled separately in the code. I'm not familiar with the category code, but maybe it can be improved so that the function `def hom_set: return Hom(self, self)` defined in class A, returns the correct homomrophisms for derived classes `B(A)` as well (so `b.hom_set` returns the hom set of `b` as an element of B).

If it were just for typing, one could also annotate the original `identity_map` on `TopologicalManifold` (see https://mypy.readthedocs.io/en/stable/more_types.html#advanced-uses-of-self-types).



---

archive/issue_comments_418922.json:
```json
{
    "body": "Replying to [comment:8 gh-tobiasdiez]:\n> It's true that I noticed while working on typing support, but the addition is actually rather independent of this. As Eric says, `identity_map` on a differentiable manifold only returns a `ContinuousMap` and one can thus not take it's differential etc. \n\n\nNo, one can take the differential because the returned object in this case is actually a `DiffMap`, which is also a `ContinuousMap` since `DiffMap` is a subclass of `ContinuousMap` (see the example below). \n\n>I'm not familiar with the category code, but maybe it can be improved so that the function `def hom_set: return Hom(self, self)` defined in class A, returns the correct homomrophisms for derived classes `B(A)` as well (so `b.hom_set` returns the hom set of `b` as an element of B).\n\n\nNo need for improvement, this is already the case:\n\n```\nsage: M = Manifold(2, 'M'); M\n2-dimensional differentiable manifold M\nsage: Id = M.identity_map()\nsage: type(Id)\n<class 'sage.manifolds.differentiable.manifold_homset.DifferentiableManifoldHomset_with_category.element_class'>\nsage: isinstance(Id, sage.manifolds.differentiable.diff_map.DiffMap)\nTrue\nsage: isinstance(Id, sage.manifolds.continuous_map.ContinuousMap)\nTrue\nsage: Id.parent()\nSet of Morphisms from 2-dimensional differentiable manifold M \n to 2-dimensional differentiable manifold M in Category of \n smooth manifolds over Real Field with 53 bits of precision\n```",
    "created_at": "2020-06-03T12:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418922",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:8 gh-tobiasdiez]:
> It's true that I noticed while working on typing support, but the addition is actually rather independent of this. As Eric says, `identity_map` on a differentiable manifold only returns a `ContinuousMap` and one can thus not take it's differential etc. 


No, one can take the differential because the returned object in this case is actually a `DiffMap`, which is also a `ContinuousMap` since `DiffMap` is a subclass of `ContinuousMap` (see the example below). 

>I'm not familiar with the category code, but maybe it can be improved so that the function `def hom_set: return Hom(self, self)` defined in class A, returns the correct homomrophisms for derived classes `B(A)` as well (so `b.hom_set` returns the hom set of `b` as an element of B).


No need for improvement, this is already the case:

```
sage: M = Manifold(2, 'M'); M
2-dimensional differentiable manifold M
sage: Id = M.identity_map()
sage: type(Id)
<class 'sage.manifolds.differentiable.manifold_homset.DifferentiableManifoldHomset_with_category.element_class'>
sage: isinstance(Id, sage.manifolds.differentiable.diff_map.DiffMap)
True
sage: isinstance(Id, sage.manifolds.continuous_map.ContinuousMap)
True
sage: Id.parent()
Set of Morphisms from 2-dimensional differentiable manifold M 
 to 2-dimensional differentiable manifold M in Category of 
 smooth manifolds over Real Field with 53 bits of precision
```



---

archive/issue_comments_418923.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-04T10:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418923",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418924.json:
```json
{
    "body": "Thanks for the clarification. I actually tested it before, but apparently made some mistakes as `identity_map` indeed returns a `DiffMap` on a differentiable manifold.\n\nI've thus removed the `identity_map` method again from `DifferentiableManifold` and instead added the typing information to the existing map.\n\nAnything else that needs improvement? From my side this is good to go. I would add more typing in follow-up issues to keep the size of the changes small and reviewable.",
    "created_at": "2020-06-04T14:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418924",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for the clarification. I actually tested it before, but apparently made some mistakes as `identity_map` indeed returns a `DiffMap` on a differentiable manifold.

I've thus removed the `identity_map` method again from `DifferentiableManifold` and instead added the typing information to the existing map.

Anything else that needs improvement? From my side this is good to go. I would add more typing in follow-up issues to keep the size of the changes small and reviewable.



---

archive/issue_comments_418925.json:
```json
{
    "body": "There are some doctest errors, as well as coverage, pyflakes and pycodeystyle errors; check the patchbot reports (click on the \"9.2.beta0 button\" in the top right of the ticket description).",
    "created_at": "2020-06-08T13:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418925",
    "user": "https://github.com/egourgoulhon"
}
```

There are some doctest errors, as well as coverage, pyflakes and pycodeystyle errors; check the patchbot reports (click on the "9.2.beta0 button" in the top right of the ticket description).



---

archive/issue_comments_418926.json:
```json
{
    "body": "Another thing: the typing information does not show up in the html documentation produced by Sphinx.",
    "created_at": "2020-06-08T13:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418926",
    "user": "https://github.com/egourgoulhon"
}
```

Another thing: the typing information does not show up in the html documentation produced by Sphinx.



---

archive/issue_comments_418927.json:
```json
{
    "body": "The file `pyrightconfig.json` at the root of the Sage directory has probably been added to the commit by mistake.",
    "created_at": "2020-06-08T13:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418927",
    "user": "https://github.com/egourgoulhon"
}
```

The file `pyrightconfig.json` at the root of the Sage directory has probably been added to the commit by mistake.



---

archive/issue_comments_418928.json:
```json
{
    "body": "I had a quick look at the errors and most of them are a result of that the tools (pyflakes and pycodestyle) have problems with the typing syntax. After a bit of googling, it appears that these issues are fixed in the most recent versions (e.g. https://github.com/PyCQA/pyflakes/issues/247 and https://github.com/vim-syntastic/syntastic/issues/1667). Where do I find the version used? Moreover, one common problems seems to be that these tools need to be installed under python 3, since otherwise they check the files using python 2 syntax (e.g. https://github.com/vim-syntastic/syntastic/issues/1667#issuecomment-172538109). How can I make sure that it's the case indeed?\nI'll have a look at the remaining issues after these false positives are fixed.\n\nFinally, the `pyrightconfig.json` is the configuration file for `pyright`, which is static type checker. At the moment there are still to many type problems but in the long term this should be integrated in the build progress.",
    "created_at": "2020-06-08T17:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418928",
    "user": "https://github.com/tobiasdiez"
}
```

I had a quick look at the errors and most of them are a result of that the tools (pyflakes and pycodestyle) have problems with the typing syntax. After a bit of googling, it appears that these issues are fixed in the most recent versions (e.g. https://github.com/PyCQA/pyflakes/issues/247 and https://github.com/vim-syntastic/syntastic/issues/1667). Where do I find the version used? Moreover, one common problems seems to be that these tools need to be installed under python 3, since otherwise they check the files using python 2 syntax (e.g. https://github.com/vim-syntastic/syntastic/issues/1667#issuecomment-172538109). How can I make sure that it's the case indeed?
I'll have a look at the remaining issues after these false positives are fixed.

Finally, the `pyrightconfig.json` is the configuration file for `pyright`, which is static type checker. At the moment there are still to many type problems but in the long term this should be integrated in the build progress.



---

archive/issue_comments_418929.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> Finally, the `pyrightconfig.json` is the configuration file for `pyright`, which is static type checker. At the moment there are still to many type problems but in the long term this should be integrated in the build progress.\n\n\nCould you create a separate ticket for this please and link to it from #28936",
    "created_at": "2020-07-22T17:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418929",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> Finally, the `pyrightconfig.json` is the configuration file for `pyright`, which is static type checker. At the moment there are still to many type problems but in the long term this should be integrated in the build progress.


Could you create a separate ticket for this please and link to it from #28936



---

archive/issue_comments_418930.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> I had a quick look at the errors and most of them are a result of that the tools (pyflakes and pycodestyle) have problems with the typing syntax. ... Where do I find the version used? \n\n\nBest to open an issue on https://github.com/sagemath/sage-patchbot",
    "created_at": "2020-07-22T17:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418930",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> I had a quick look at the errors and most of them are a result of that the tools (pyflakes and pycodestyle) have problems with the typing syntax. ... Where do I find the version used? 


Best to open an issue on https://github.com/sagemath/sage-patchbot



---

archive/issue_comments_418931.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-14T12:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418931",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418932.json:
```json
{
    "body": "branch is red and needs to be rebased on the latest beta",
    "created_at": "2020-08-14T12:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418932",
    "user": "https://github.com/fchapoton"
}
```

branch is red and needs to be rebased on the latest beta



---

archive/issue_comments_418933.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-14T20:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418933",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418934.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-14T20:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418934",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418935.json:
```json
{
    "body": "`@`mkoeppe done!\n`@`chapoton rebased!\n\nThe pyflakes tests still fail because pyflakes does not (fully) understand the typings code. Not sure if the reason is an old pyflakes or if this is even unresolved in the most recent version. Refs https://github.com/sagemath/sage-patchbot/issues/143. Can I disable pyflakes for the lines that are wrongly reported?",
    "created_at": "2020-08-14T21:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418935",
    "user": "https://github.com/tobiasdiez"
}
```

`@`mkoeppe done!
`@`chapoton rebased!

The pyflakes tests still fail because pyflakes does not (fully) understand the typings code. Not sure if the reason is an old pyflakes or if this is even unresolved in the most recent version. Refs https://github.com/sagemath/sage-patchbot/issues/143. Can I disable pyflakes for the lines that are wrongly reported?



---

archive/issue_comments_418936.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-14T21:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418936",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418937.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-16T05:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418937",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418938.json:
```json
{
    "body": "```\nsage -t --long --warn-long 63.8 --random-seed=0 src/sage/manifolds/manifold.py\n**********************************************************************\nFile \"src/sage/manifolds/manifold.py\", line 2203, in sage.manifolds.manifold.TopologicalManifold.identity_map\nFailed example:\n    isinstance(id, DiffMap)\nException raised:\n    Traceback (most recent call last):\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 715, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1139, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.manifolds.manifold.TopologicalManifold.identity_map[10]>\", line 1, in <module>\n        isinstance(id, DiffMap)\n    NameError: name 'DiffMap' is not defined\n**********************************************************************\nFile \"src/sage/manifolds/manifold.py\", line 2209, in sage.manifolds.manifold.TopologicalManifold.identity_map\nFailed example:\n    isinstance(M.identity_map(), DiffMap)\nException raised:\n    Traceback (most recent call last):\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 715, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1139, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.manifolds.manifold.TopologicalManifold.identity_map[12]>\", line 1, in <module>\n        isinstance(M.identity_map(), DiffMap)\n    NameError: name 'DiffMap' is not defined\n```",
    "created_at": "2020-08-16T05:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418938",
    "user": "https://github.com/kliem"
}
```

```
sage -t --long --warn-long 63.8 --random-seed=0 src/sage/manifolds/manifold.py
**********************************************************************
File "src/sage/manifolds/manifold.py", line 2203, in sage.manifolds.manifold.TopologicalManifold.identity_map
Failed example:
    isinstance(id, DiffMap)
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.manifold.TopologicalManifold.identity_map[10]>", line 1, in <module>
        isinstance(id, DiffMap)
    NameError: name 'DiffMap' is not defined
**********************************************************************
File "src/sage/manifolds/manifold.py", line 2209, in sage.manifolds.manifold.TopologicalManifold.identity_map
Failed example:
    isinstance(M.identity_map(), DiffMap)
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.manifold.TopologicalManifold.identity_map[12]>", line 1, in <module>
        isinstance(M.identity_map(), DiffMap)
    NameError: name 'DiffMap' is not defined
```



---

archive/issue_comments_418939.json:
```json
{
    "body": "Thanks for your comment. How are imports for the documentation handled? Should I simply add the import for the whole file, or is there a special way to do this just for the doc tests?",
    "created_at": "2020-08-16T12:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418939",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for your comment. How are imports for the documentation handled? Should I simply add the import for the whole file, or is there a special way to do this just for the doc tests?



---

archive/issue_comments_418940.json:
```json
{
    "body": "I think you can just do\n\n```\nfrom sage.manifolds.differentiable.diff_map import DiffMap\n```\n\nat the beginning of the doctest or\n\n```\nisinstance(id, sage.manifolds.differentiable.diff_map.DiffMap)\n```\n\nAfter building your modified sage, the doctest should pass with\n\n```\nsage -t --long src/sage/manifolds/manifold.py\n```\n\nThe doctest works almost like a mini sage session.",
    "created_at": "2020-08-16T18:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418940",
    "user": "https://github.com/kliem"
}
```

I think you can just do

```
from sage.manifolds.differentiable.diff_map import DiffMap
```

at the beginning of the doctest or

```
isinstance(id, sage.manifolds.differentiable.diff_map.DiffMap)
```

After building your modified sage, the doctest should pass with

```
sage -t --long src/sage/manifolds/manifold.py
```

The doctest works almost like a mini sage session.



---

archive/issue_comments_418941.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-28T17:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418942.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-28T17:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418942",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418943.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-28T17:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418943",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418944.json:
```json
{
    "body": "I've finally fixed these missing imports (or so I hope, I cannot run sage -t because pip couldn't be installed via make -- I will report this elsewhere). Thanks `@`gh-kliem for the helpful instructions.\n\nThe patchbot warnings should be fixed now as well. Note that the negative coverage changes  are due to the fact that ``@`overload` seems not to be supported.",
    "created_at": "2020-08-28T17:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418944",
    "user": "https://github.com/tobiasdiez"
}
```

I've finally fixed these missing imports (or so I hope, I cannot run sage -t because pip couldn't be installed via make -- I will report this elsewhere). Thanks `@`gh-kliem for the helpful instructions.

The patchbot warnings should be fixed now as well. Note that the negative coverage changes  are due to the fact that ``@`overload` seems not to be supported.



---

archive/issue_comments_418945.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-25T17:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418945",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418946.json:
```json
{
    "body": "red branch => needs work",
    "created_at": "2020-09-25T17:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418946",
    "user": "https://github.com/fchapoton"
}
```

red branch => needs work



---

archive/issue_comments_418947.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-26T19:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418947",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418948.json:
```json
{
    "body": "Thanks. I've now merged upstream into this branch.",
    "created_at": "2020-09-26T19:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418948",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks. I've now merged upstream into this branch.



---

archive/issue_comments_418949.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-26T19:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418949",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_076214.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76214"
}
```



---

archive/issue_comments_418950.json:
```json
{
    "body": "red branch => needs work",
    "created_at": "2020-11-01T18:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418950",
    "user": "https://github.com/fchapoton"
}
```

red branch => needs work



---

archive/issue_comments_418951.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-01T18:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418951",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418952.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-08T13:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418952",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418953.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-08T13:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418953",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418954.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-08T13:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418954",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418955.json:
```json
{
    "body": "Merged upstream.",
    "created_at": "2020-11-08T13:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418955",
    "user": "https://github.com/tobiasdiez"
}
```

Merged upstream.



---

archive/issue_comments_418956.json:
```json
{
    "body": "In changes like this one:\n\n```\n@@ -596,14 +597,13 @@ class DegenerateSubmanifold(DegenerateManifold, DifferentiableSubmanifold):\n         self._default_screen = self._screens[name]\n         return self._screens[name]\n \n-    def induced_metric(self):\n+    def induced_metric(self) -> DegenerateMetric:\n         r\"\"\"\n         Return the pullback of the ambient metric.\n \n         OUTPUT:\n \n-        - induced metric, as an instance of\n-          :class:`~sage.manifolds.differentiable.metric.DegenerateMetric`\n+        - induced mettric\n \n         EXAMPLES:\n```\nDid you check that our built documentation contains the output type?\n\n(Also note this introduces a typo)",
    "created_at": "2020-11-09T02:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418956",
    "user": "https://github.com/mkoeppe"
}
```

In changes like this one:

```
@@ -596,14 +597,13 @@ class DegenerateSubmanifold(DegenerateManifold, DifferentiableSubmanifold):
         self._default_screen = self._screens[name]
         return self._screens[name]
 
-    def induced_metric(self):
+    def induced_metric(self) -> DegenerateMetric:
         r"""
         Return the pullback of the ambient metric.
 
         OUTPUT:
 
-        - induced metric, as an instance of
-          :class:`~sage.manifolds.differentiable.metric.DegenerateMetric`
+        - induced mettric
 
         EXAMPLES:
```
Did you check that our built documentation contains the output type?

(Also note this introduces a typo)



---

archive/issue_comments_418957.json:
```json
{
    "body": "Replying to [comment:39 mkoeppe]:\n> In changes like this one:\n> \n> ```\n> -    def induced_metric(self):\n> +    def induced_metric(self) -> DegenerateMetric:\n>  \n> -        - induced metric, as an instance of\n> -          :class:`~sage.manifolds.differentiable.metric.DegenerateMetric`\n> +        - induced mettric\n> ```\n> Did you check that our built documentation contains the output type?\n> \n\n\nNo it does not: the output type does no longer appear in the generated html documentation.\n> (Also note this introduces a typo)\n> \n\n\nMoreover, what is the meaning of this change in `src/sage/manifolds/differentiable/manifold.py`:\n\n```diff\n-    def metric(self, name, signature=None, latex_name=None, dest_map=None):\n+    def metric(self, name=None, signature=None, latex_name=None, dest_map=None) -> PseudoRiemannianMetric:\n```\ni.e. why `name` is replaced by `name=None` ?",
    "created_at": "2020-11-09T20:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418957",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:39 mkoeppe]:
> In changes like this one:
> 
> ```
> -    def induced_metric(self):
> +    def induced_metric(self) -> DegenerateMetric:
>  
> -        - induced metric, as an instance of
> -          :class:`~sage.manifolds.differentiable.metric.DegenerateMetric`
> +        - induced mettric
> ```
> Did you check that our built documentation contains the output type?
> 


No it does not: the output type does no longer appear in the generated html documentation.
> (Also note this introduces a typo)
> 


Moreover, what is the meaning of this change in `src/sage/manifolds/differentiable/manifold.py`:

```diff
-    def metric(self, name, signature=None, latex_name=None, dest_map=None):
+    def metric(self, name=None, signature=None, latex_name=None, dest_map=None) -> PseudoRiemannianMetric:
```
i.e. why `name` is replaced by `name=None` ?



---

archive/issue_comments_418958.json:
```json
{
    "body": "If we do\n\n```\nsage: M = Manifold(2, 'M')                                                                          \nsage: M.vector_field_module?                                                                        \n```\nwe get\n\n``` \nSignature:     \nM.vector_field_module(\n    dest_map: sage.manifolds.differentiable.diff_map.DiffMap = None,\n    force_free=False,\n) -> sage.manifolds.differentiable.vectorfield_module.VectorFieldModule\n```\nwhich is barely readable, I think.",
    "created_at": "2020-11-09T21:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418958",
    "user": "https://github.com/egourgoulhon"
}
```

If we do

```
sage: M = Manifold(2, 'M')                                                                          
sage: M.vector_field_module?                                                                        
```
we get

``` 
Signature:     
M.vector_field_module(
    dest_map: sage.manifolds.differentiable.diff_map.DiffMap = None,
    force_free=False,
) -> sage.manifolds.differentiable.vectorfield_module.VectorFieldModule
```
which is barely readable, I think.



---

archive/issue_comments_418959.json:
```json
{
    "body": "I'm currently working on a solution to show the typing information in the documentation using https://pypi.org/project/sphinx-autodoc-typehints/ (in a new ticket of course).\n\nNot sure why I changed the name to `None`. Probably I was \"inspired\" by the constructor of a generic tensor field:\n\n```\ndef __init__(self, vector_field_module, tensor_type, name=None,\n                 latex_name=None, sym=None, antisym=None, parent=None):\n```\nDoes the name has to be set for a metric?",
    "created_at": "2020-11-09T21:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418959",
    "user": "https://github.com/tobiasdiez"
}
```

I'm currently working on a solution to show the typing information in the documentation using https://pypi.org/project/sphinx-autodoc-typehints/ (in a new ticket of course).

Not sure why I changed the name to `None`. Probably I was "inspired" by the constructor of a generic tensor field:

```
def __init__(self, vector_field_module, tensor_type, name=None,
                 latex_name=None, sym=None, antisym=None, parent=None):
```
Does the name has to be set for a metric?



---

archive/issue_comments_418960.json:
```json
{
    "body": "Replying to [comment:42 gh-tobiasdiez]:\n> \n> Not sure why I changed the name to `None`. Probably I was \"inspired\" by the constructor of a generic tensor field:\n> \n> ```\n> def __init__(self, vector_field_module, tensor_type, name=None,\n>                  latex_name=None, sym=None, antisym=None, parent=None):\n> ```\n> Does the name has to be set for a metric? \n\nYes for it is used to set the name of derived quantities (Levi-Civita connection, curvature tensor, etc.). Of course, this can be discussed and changed, but in another ticket, since this definitely does not pertain to the current ticket.",
    "created_at": "2020-11-10T14:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418960",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:42 gh-tobiasdiez]:
> 
> Not sure why I changed the name to `None`. Probably I was "inspired" by the constructor of a generic tensor field:
> 
> ```
> def __init__(self, vector_field_module, tensor_type, name=None,
>                  latex_name=None, sym=None, antisym=None, parent=None):
> ```
> Does the name has to be set for a metric? 

Yes for it is used to set the name of derived quantities (Levi-Civita connection, curvature tensor, etc.). Of course, this can be discussed and changed, but in another ticket, since this definitely does not pertain to the current ticket.



---

archive/issue_comments_418961.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-11T17:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418961",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418962.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-21T12:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418963.json:
```json
{
    "body": "I tried to change the documentation to incorporate typing information, but this turns out to be a bit more complicated than expected.\nSo for now I've readded the class information in the documentation.\n\nMoreover, I've removed the `name = None` for the metric again.\n\nSo it should be ready for review now.",
    "created_at": "2020-11-21T12:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418963",
    "user": "https://github.com/tobiasdiez"
}
```

I tried to change the documentation to incorporate typing information, but this turns out to be a bit more complicated than expected.
So for now I've readded the class information in the documentation.

Moreover, I've removed the `name = None` for the metric again.

So it should be ready for review now.



---

archive/issue_comments_418964.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-21T12:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418964",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418965.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-19T18:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418965",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418966.json:
```json
{
    "body": "red branch",
    "created_at": "2020-12-19T18:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418966",
    "user": "https://github.com/fchapoton"
}
```

red branch



---

archive/issue_comments_418967.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-20T22:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418967",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418968.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-20T22:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418968",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418969.json:
```json
{
    "body": "Merged develop branch.",
    "created_at": "2020-12-20T22:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418969",
    "user": "https://github.com/tobiasdiez"
}
```

Merged develop branch.



---

archive/issue_comments_418970.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418970",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_076215.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76215"
}
```



---

archive/issue_events_076216.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76216"
}
```



---

archive/issue_comments_418971.json:
```json
{
    "body": "It would be nice if this ticket could be reviewed. Thanks!",
    "created_at": "2021-04-23T08:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418971",
    "user": "https://github.com/tobiasdiez"
}
```

It would be nice if this ticket could be reviewed. Thanks!



---

archive/issue_comments_418972.json:
```json
{
    "body": "The patchbot reports many doctest errors.",
    "created_at": "2021-04-24T12:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418972",
    "user": "https://github.com/egourgoulhon"
}
```

The patchbot reports many doctest errors.



---

archive/issue_comments_418973.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-24T21:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418973",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418974.json:
```json
{
    "body": "Also, now that we can use `from __future__ import annotations`, I think some of the type annotations can be simplified",
    "created_at": "2021-05-27T23:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418974",
    "user": "https://github.com/mkoeppe"
}
```

Also, now that we can use `from __future__ import annotations`, I think some of the type annotations can be simplified



---

archive/issue_comments_418975.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418975",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_076217.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76217"
}
```



---

archive/issue_events_076218.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76218"
}
```



---

archive/issue_comments_418976.json:
```json
{
    "body": "Sorry for the delay, but the doctests should be fixed now. I also use the future import for annotations, which indeed simplifies a few things. \nAgain ready for review.",
    "created_at": "2021-11-28T20:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418976",
    "user": "https://github.com/tobiasdiez"
}
```

Sorry for the delay, but the doctests should be fixed now. I also use the future import for annotations, which indeed simplifies a few things. 
Again ready for review.



---

archive/issue_comments_418977.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-28T20:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418977",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418978.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-28T20:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418978",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-28T20:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418979",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_076219.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76219"
}
```



---

archive/issue_events_076220.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76220"
}
```



---

archive/issue_comments_418980.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418980",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_418981.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-12-28T16:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418981",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418982.json:
```json
{
    "body": "red branch => needs work",
    "created_at": "2021-12-28T16:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418982",
    "user": "https://github.com/fchapoton"
}
```

red branch => needs work



---

archive/issue_comments_418983.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-12-28T17:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418983",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418984.json:
```json
{
    "body": "Setting it back to needs review as the merge conflict should be easy to resolve but I'm not near my dev machine for a couple of days.\n\nIt would be really nice if someone could review this ticket, as it's in this limbo state now for quite some time.",
    "created_at": "2021-12-28T17:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418984",
    "user": "https://github.com/tobiasdiez"
}
```

Setting it back to needs review as the merge conflict should be easy to resolve but I'm not near my dev machine for a couple of days.

It would be really nice if someone could review this ticket, as it's in this limbo state now for quite some time.



---

archive/issue_comments_418985.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T12:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418985",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418986.json:
```json
{
    "body": "Changing component from geometry to manifolds.",
    "created_at": "2022-01-28T00:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418986",
    "user": "https://github.com/tobiasdiez"
}
```

Changing component from geometry to manifolds.



---

archive/issue_comments_418987.json:
```json
{
    "body": "red branch",
    "created_at": "2022-02-23T17:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418987",
    "user": "https://github.com/mkoeppe"
}
```

red branch



---

archive/issue_comments_418988.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-23T17:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418988",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418989.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-23T21:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418989",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418990.json:
```json
{
    "body": "Merging the develop branch should be trivial, but I'll not be able to do this is in the near future; so setting it back to \"needs review\".",
    "created_at": "2022-02-23T21:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418990",
    "user": "https://github.com/tobiasdiez"
}
```

Merging the develop branch should be trivial, but I'll not be able to do this is in the near future; so setting it back to "needs review".



---

archive/issue_comments_418991.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T13:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418991",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418992.json:
```json
{
    "body": "```\n--- a/src/sage/manifolds/differentiable/metric.py\n+++ b/src/sage/manifolds/differentiable/metric.py\n@@ -41,12 +41,16 @@ REFERENCES:\n #  the License, or (at your option) any later version.\n #                  https://www.gnu.org/licenses/\n # *****************************************************************************\n+from __future__ import annotations\n+from typing import overload, TYPE_CHECKING\n \n from __future__ import annotations\n from typing import TYPE_CHECKING\n from sage.rings.integer import Integer\n from sage.manifolds.differentiable.tensorfield import TensorField\n from sage.manifolds.differentiable.tensorfield_paral import TensorFieldParal\n+if TYPE_CHECKING:\n+    from sage.manifolds.differentiable.diff_form import DiffForm\n \n if TYPE_CHECKING:\n     from sage.manifolds.differentiable.diff_form import DiffForm\n```\n\nThis doesn't look right",
    "created_at": "2022-03-01T17:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418992",
    "user": "https://github.com/mkoeppe"
}
```

```
--- a/src/sage/manifolds/differentiable/metric.py
+++ b/src/sage/manifolds/differentiable/metric.py
@@ -41,12 +41,16 @@ REFERENCES:
 #  the License, or (at your option) any later version.
 #                  https://www.gnu.org/licenses/
 # *****************************************************************************
+from __future__ import annotations
+from typing import overload, TYPE_CHECKING
 
 from __future__ import annotations
 from typing import TYPE_CHECKING
 from sage.rings.integer import Integer
 from sage.manifolds.differentiable.tensorfield import TensorField
 from sage.manifolds.differentiable.tensorfield_paral import TensorFieldParal
+if TYPE_CHECKING:
+    from sage.manifolds.differentiable.diff_form import DiffForm
 
 if TYPE_CHECKING:
     from sage.manifolds.differentiable.diff_form import DiffForm
```

This doesn't look right



---

archive/issue_comments_418993.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-01T17:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418993",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418994.json:
```json
{
    "body": "And I would urge to use more restraint in changing the coding style.\nFor example, these changes are entirely gratuitous:\n\n```\n     if structure is None:\n-        diff_degree = extra_kwds.get('diff_degree', infinity)\n+        diff_degree = extra_kwds.get(\"diff_degree\", infinity)\n         if diff_degree == infinity:\n-            structure = 'smooth'\n+            structure = \"smooth\"\n         elif diff_degree > 0:\n-            structure = 'differentiable'\n+            structure = \"differentiable\"\n         else:\n-            structure = 'topological'\n+            structure = \"topological\"\n```",
    "created_at": "2022-03-01T17:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418994",
    "user": "https://github.com/mkoeppe"
}
```

And I would urge to use more restraint in changing the coding style.
For example, these changes are entirely gratuitous:

```
     if structure is None:
-        diff_degree = extra_kwds.get('diff_degree', infinity)
+        diff_degree = extra_kwds.get("diff_degree", infinity)
         if diff_degree == infinity:
-            structure = 'smooth'
+            structure = "smooth"
         elif diff_degree > 0:
-            structure = 'differentiable'
+            structure = "differentiable"
         else:
-            structure = 'topological'
+            structure = "topological"
```



---

archive/issue_comments_418995.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T18:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_418996.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-01T18:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418996",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418997.json:
```json
{
    "body": "Replying to [comment:67 mkoeppe]:\n> {{{\n> --- a/src/sage/manifolds/differentiable/metric.py\n> +++ b/src/sage/manifolds/differentiable/metric.py\n> This doesn't look right\n\n\nThanks, I was still in the process of fixing some of the merge conflicts. Done now.",
    "created_at": "2022-03-01T18:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418997",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:67 mkoeppe]:
> {{{
> --- a/src/sage/manifolds/differentiable/metric.py
> +++ b/src/sage/manifolds/differentiable/metric.py
> This doesn't look right


Thanks, I was still in the process of fixing some of the merge conflicts. Done now.



---

archive/issue_comments_418998.json:
```json
{
    "body": "You didn't address comment:69",
    "created_at": "2022-03-03T01:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418998",
    "user": "https://github.com/mkoeppe"
}
```

You didn't address comment:69



---

archive/issue_comments_418999.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-03T01:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-418999",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_419000.json:
```json
{
    "body": "And this change is an API change (= introduces a bug).\n\nThe argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.\n\nYour change removes the marshaling.\n\n```\n TensorType = Tuple[int, int]\n\n@@ -402,8 +405,17 @@ class TensorField(ModuleElementWithMutability):\n         ValueError: the name of an immutable element cannot be changed\n \n     \"\"\"\n-    def __init__(self, vector_field_module, tensor_type, name=None,\n-                 latex_name=None, sym=None, antisym=None, parent=None):\n+\n+    def __init__(\n+        self,\n+        vector_field_module: VectorFieldModule,\n+        tensor_type: TensorType,\n+        name: Optional[str] = None,\n+        latex_name: Optional[str] = None,\n+        sym=None,\n+        antisym=None,\n+        parent=None,\n+    ):\n         r\"\"\"\n         Construct a tensor field.\n \n@@ -451,7 +463,7 @@ class TensorField(ModuleElementWithMutability):\n             parent = vector_field_module.tensor_module(*tensor_type)\n         ModuleElementWithMutability.__init__(self, parent)\n         self._vmodule = vector_field_module\n-        self._tensor_type = tuple(tensor_type)\n+        self._tensor_type = tensor_type\n         self._tensor_rank = self._tensor_type[0] + self._tensor_type[1]\n         self._is_zero = False # a priori, may be changed below or via\n                               # method __bool__()\n```",
    "created_at": "2022-03-03T01:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419000",
    "user": "https://github.com/mkoeppe"
}
```

And this change is an API change (= introduces a bug).

The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.

Your change removes the marshaling.

```
 TensorType = Tuple[int, int]

@@ -402,8 +405,17 @@ class TensorField(ModuleElementWithMutability):
         ValueError: the name of an immutable element cannot be changed
 
     """
-    def __init__(self, vector_field_module, tensor_type, name=None,
-                 latex_name=None, sym=None, antisym=None, parent=None):
+
+    def __init__(
+        self,
+        vector_field_module: VectorFieldModule,
+        tensor_type: TensorType,
+        name: Optional[str] = None,
+        latex_name: Optional[str] = None,
+        sym=None,
+        antisym=None,
+        parent=None,
+    ):
         r"""
         Construct a tensor field.
 
@@ -451,7 +463,7 @@ class TensorField(ModuleElementWithMutability):
             parent = vector_field_module.tensor_module(*tensor_type)
         ModuleElementWithMutability.__init__(self, parent)
         self._vmodule = vector_field_module
-        self._tensor_type = tuple(tensor_type)
+        self._tensor_type = tensor_type
         self._tensor_rank = self._tensor_type[0] + self._tensor_type[1]
         self._is_zero = False # a priori, may be changed below or via
                               # method __bool__()
```



---

archive/issue_comments_419001.json:
```json
{
    "body": "Replying to [comment:73 mkoeppe]:\n> And this change is an API change (= introduces a bug).\n> \n> The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.\n\n\nAccording to the documentation \n> - ``tensor_type`` -- pair `(k,l)` with `k` being the contravariant rank\n\n      and `l` the covariant rank\n\nwhich is quite clear about that it expects a 2-tuple. Thus, this change is only a formalization of the current public interface; I can of course revert it and adapt the documentation to point out that it also accepts arbitrary iterables if that's really desired. It feels however more consistent to represent the tensor type everywhere by a tuple.",
    "created_at": "2022-03-03T12:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419001",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:73 mkoeppe]:
> And this change is an API change (= introduces a bug).
> 
> The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.


According to the documentation 
> - ``tensor_type`` -- pair `(k,l)` with `k` being the contravariant rank

      and `l` the covariant rank

which is quite clear about that it expects a 2-tuple. Thus, this change is only a formalization of the current public interface; I can of course revert it and adapt the documentation to point out that it also accepts arbitrary iterables if that's really desired. It feels however more consistent to represent the tensor type everywhere by a tuple.



---

archive/issue_comments_419002.json:
```json
{
    "body": "Replying to [comment:72 mkoeppe]:\n> You didn't address comment:69\n\n\nI accidentally run a code formatter over these files and committed the changes; sorry for this. Will try not to do this again in the future.",
    "created_at": "2022-03-03T12:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419002",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:72 mkoeppe]:
> You didn't address comment:69


I accidentally run a code formatter over these files and committed the changes; sorry for this. Will try not to do this again in the future.



---

archive/issue_comments_419003.json:
```json
{
    "body": "Replying to [comment:74 gh-tobiasdiez]:\n> Replying to [comment:73 mkoeppe]:\n> > And this change is an API change (= introduces a bug).\n> > \n> > The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.\n\n> \n> According to the documentation \n> > - ``tensor_type`` -- pair `(k,l)` with `k` being the contravariant rank\n \n>       and `l` the covariant rank\n> \n> which is quite clear about that it expects a 2-tuple. \n\n\nWell, the code obviously was concerned about making it a tuple to provide a robust interface. \n\n> Thus, this change is only a formalization of the current public interface\n\n\nNo, this is not how Python typing works. You cannot rely on the type annotations for input checking/marshaling; this still has to be done by code. Type annotations are merely decoration for documentation purposes and static checkers.",
    "created_at": "2022-03-03T19:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419003",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:74 gh-tobiasdiez]:
> Replying to [comment:73 mkoeppe]:
> > And this change is an API change (= introduces a bug).
> > 
> > The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.

> 
> According to the documentation 
> > - ``tensor_type`` -- pair `(k,l)` with `k` being the contravariant rank
 
>       and `l` the covariant rank
> 
> which is quite clear about that it expects a 2-tuple. 


Well, the code obviously was concerned about making it a tuple to provide a robust interface. 

> Thus, this change is only a formalization of the current public interface


No, this is not how Python typing works. You cannot rely on the type annotations for input checking/marshaling; this still has to be done by code. Type annotations are merely decoration for documentation purposes and static checkers.



---

archive/issue_comments_419004.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-20T13:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419005.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-20T16:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419005",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_419006.json:
```json
{
    "body": "I think these changes are not good. They are obscuring the internal data representation\n\n```\n@@ -847,11 +847,11 @@ class TopologicalSubmanifold(TopologicalManifold):\n              3-dimensional topological manifold M\n \n         \"\"\"\n-        if not self._immersed:\n+        if not self._immersed or not self._immersion:\n             raise ValueError(\"the submanifold is not immersed\")\n         return self._immersion\n\n[...] \n@@ -873,7 +873,7 @@ class TopologicalSubmanifold(TopologicalManifold):\n              3-dimensional topological manifold M\n \n         \"\"\"\n-        if not self._embedded:\n+        if not self._embedded or not self._immersion:\n             raise ValueError(\"the submanifold is not embedded\")\n         return self._immersion\n \n```",
    "created_at": "2022-03-20T16:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419006",
    "user": "https://github.com/mkoeppe"
}
```

I think these changes are not good. They are obscuring the internal data representation

```
@@ -847,11 +847,11 @@ class TopologicalSubmanifold(TopologicalManifold):
              3-dimensional topological manifold M
 
         """
-        if not self._immersed:
+        if not self._immersed or not self._immersion:
             raise ValueError("the submanifold is not immersed")
         return self._immersion

[...] 
@@ -873,7 +873,7 @@ class TopologicalSubmanifold(TopologicalManifold):
              3-dimensional topological manifold M
 
         """
-        if not self._embedded:
+        if not self._embedded or not self._immersion:
             raise ValueError("the submanifold is not embedded")
         return self._immersion
 
```



---

archive/issue_comments_419007.json:
```json
{
    "body": "I'm personally in favor of these changes (the 80 character limit is a bit inflexible when module names or identifiers are already 40-ish characters long), but probably `@`egourgoulhon should indicate whether these formatting changes are acceptable / welcome.\n\n```\n@@ -647,8 +654,8 @@ class VectorFieldModule(UniqueRepresentation, Parent):\n             for more examples and documentation.\n \n         \"\"\"\n-        from sage.manifolds.differentiable.diff_form_module import \\\n-                                                                 DiffFormModule\n+        from sage.manifolds.differentiable.diff_form_module import DiffFormModule\n+\n         if p == 0:\n             return self._ring\n         if p not in self._dual_exterior_powers:\n```",
    "created_at": "2022-03-20T16:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419007",
    "user": "https://github.com/mkoeppe"
}
```

I'm personally in favor of these changes (the 80 character limit is a bit inflexible when module names or identifiers are already 40-ish characters long), but probably `@`egourgoulhon should indicate whether these formatting changes are acceptable / welcome.

```
@@ -647,8 +654,8 @@ class VectorFieldModule(UniqueRepresentation, Parent):
             for more examples and documentation.
 
         """
-        from sage.manifolds.differentiable.diff_form_module import \
-                                                                 DiffFormModule
+        from sage.manifolds.differentiable.diff_form_module import DiffFormModule
+
         if p == 0:
             return self._ring
         if p not in self._dual_exterior_powers:
```



---

archive/issue_comments_419008.json:
```json
{
    "body": "I don't understand what you mean. How can a submanifold be considered to be immersed/embedded if there is map that provides such an immersion?",
    "created_at": "2022-03-20T17:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419008",
    "user": "https://github.com/tobiasdiez"
}
```

I don't understand what you mean. How can a submanifold be considered to be immersed/embedded if there is map that provides such an immersion?



---

archive/issue_comments_419009.json:
```json
{
    "body": "It is an invariant of the internal representation (data structure) that `_immersed or _embedded` implies that `_immersion` is set.",
    "created_at": "2022-03-20T18:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419009",
    "user": "https://github.com/mkoeppe"
}
```

It is an invariant of the internal representation (data structure) that `_immersed or _embedded` implies that `_immersion` is set.



---

archive/issue_comments_419010.json:
```json
{
    "body": "Replying to [comment:82 mkoeppe]:\n> It is an invariant of the internal representation (data structure) that `_immersed or _embedded` implies that `_immersion` is set.\n\n\nBut that's not something a static checker could infer and thus they warn that `return self._immersion` might return null although the method is decorated to always return a continuous map.",
    "created_at": "2022-03-20T19:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419010",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:82 mkoeppe]:
> It is an invariant of the internal representation (data structure) that `_immersed or _embedded` implies that `_immersion` is set.


But that's not something a static checker could infer and thus they warn that `return self._immersion` might return null although the method is decorated to always return a continuous map.



---

archive/issue_comments_419011.json:
```json
{
    "body": "It may be a use case for an `assert _immersion` here. If the static checker still can't infer it after that, get a better one",
    "created_at": "2022-03-20T19:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419011",
    "user": "https://github.com/mkoeppe"
}
```

It may be a use case for an `assert _immersion` here. If the static checker still can't infer it after that, get a better one



---

archive/issue_comments_419012.json:
```json
{
    "body": "Replying to [comment:84 mkoeppe]:\n> It may be a use case for an `assert _immersion` here. If the static checker still can't infer it after that, get a better one\n\n\nBut that's what the above code is doing (except for displaying a nicer error message in the case its null). What a type checker cannot infer is the \"invariant of the internal representation\" that `_immersed is true` implies that `_immersion is not null`. There are workarounds for such implications for type checkers but they are overkill in this situation.",
    "created_at": "2022-03-20T19:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419012",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:84 mkoeppe]:
> It may be a use case for an `assert _immersion` here. If the static checker still can't infer it after that, get a better one


But that's what the above code is doing (except for displaying a nicer error message in the case its null). What a type checker cannot infer is the "invariant of the internal representation" that `_immersed is true` implies that `_immersion is not null`. There are workarounds for such implications for type checkers but they are overkill in this situation.



---

archive/issue_comments_419013.json:
```json
{
    "body": "No, your changes weaken the invariant, indicating to developers that it's OK to set `_immersed` to `True` and `_immersion` to `None`.",
    "created_at": "2022-03-20T19:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419013",
    "user": "https://github.com/mkoeppe"
}
```

No, your changes weaken the invariant, indicating to developers that it's OK to set `_immersed` to `True` and `_immersion` to `None`.



---

archive/issue_comments_419014.json:
```json
{
    "body": "Would it be okay if I completely replace the `_immersed` variable with checks if `_immersion` is None? As you indirectly noticed, keeping the internal state consistent just creates an unnecessary overhead.",
    "created_at": "2022-03-20T20:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419014",
    "user": "https://github.com/tobiasdiez"
}
```

Would it be okay if I completely replace the `_immersed` variable with checks if `_immersion` is None? As you indirectly noticed, keeping the internal state consistent just creates an unnecessary overhead.



---

archive/issue_comments_419015.json:
```json
{
    "body": "Try `assert` if you haven't yet.",
    "created_at": "2022-03-20T20:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419015",
    "user": "https://github.com/mkoeppe"
}
```

Try `assert` if you haven't yet.



---

archive/issue_comments_419016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-20T21:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419017.json:
```json
{
    "body": "To separate the changes that the ticket promises from the reformatting, I'd recommend `git merge 9.6.beta5 && git reset 9.6.beta5 && git add -p`.",
    "created_at": "2022-03-20T21:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419017",
    "user": "https://github.com/mkoeppe"
}
```

To separate the changes that the ticket promises from the reformatting, I'd recommend `git merge 9.6.beta5 && git reset 9.6.beta5 && git add -p`.



---

archive/issue_comments_419018.json:
```json
{
    "body": "Just tried it on gitpod: merge: 9.6.beta5 - not something we can merge",
    "created_at": "2022-03-20T21:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419018",
    "user": "https://github.com/tobiasdiez"
}
```

Just tried it on gitpod: merge: 9.6.beta5 - not something we can merge



---

archive/issue_comments_419019.json:
```json
{
    "body": "Fetch it first: `git fetch trac 9.6.beta5`",
    "created_at": "2022-03-20T21:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419019",
    "user": "https://github.com/mkoeppe"
}
```

Fetch it first: `git fetch trac 9.6.beta5`



---

archive/issue_comments_419020.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-20T22:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419020",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_419021.json:
```json
{
    "body": "That also don't work, but I've managed to revert (most of) the formatting changes now. Still don't understand why its worth that we both spend more time discussing this than it would to have been to review.",
    "created_at": "2022-03-20T22:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419021",
    "user": "https://github.com/tobiasdiez"
}
```

That also don't work, but I've managed to revert (most of) the formatting changes now. Still don't understand why its worth that we both spend more time discussing this than it would to have been to review.



---

archive/issue_comments_419022.json:
```json
{
    "body": "I think time would be well spent on some git practice...",
    "created_at": "2022-03-20T22:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419022",
    "user": "https://github.com/mkoeppe"
}
```

I think time would be well spent on some git practice...



---

archive/issue_comments_419023.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-20T22:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419023",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_419024.json:
```json
{
    "body": "Please learn to use `git reset` and `git add -p` and prepare a ticket that only changes what needs to be changed. comment:69 still unaddressed.",
    "created_at": "2022-03-20T22:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419024",
    "user": "https://github.com/mkoeppe"
}
```

Please learn to use `git reset` and `git add -p` and prepare a ticket that only changes what needs to be changed. comment:69 still unaddressed.



---

archive/issue_comments_419025.json:
```json
{
    "body": "Replying to [comment:94 gh-tobiasdiez]:\n> Still don't understand why its worth that we both spend more time discussing this than it would to have been to review. \n\n\nThen please prepare a focused ticket instead of forcing reviewers to look at all that stuff.",
    "created_at": "2022-03-20T22:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419025",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:94 gh-tobiasdiez]:
> Still don't understand why its worth that we both spend more time discussing this than it would to have been to review. 


Then please prepare a focused ticket instead of forcing reviewers to look at all that stuff.



---

archive/issue_comments_419026.json:
```json
{
    "body": "Replying to [comment:95 mkoeppe]:\n> I think time would be well spent on some git practice...\n\n\nThanks for this very constructive and helpful comment. Definitely motivated me to not spend any more time in reverting formatting changes.\n\nIf you really think its worth the time to extract the homogenization of quotes around strings in 3 lines to a new ticket, please be my guest.",
    "created_at": "2022-03-20T22:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419026",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:95 mkoeppe]:
> I think time would be well spent on some git practice...


Thanks for this very constructive and helpful comment. Definitely motivated me to not spend any more time in reverting formatting changes.

If you really think its worth the time to extract the homogenization of quotes around strings in 3 lines to a new ticket, please be my guest.



---

archive/issue_comments_419027.json:
```json
{
    "body": "There's no need for a new ticket because the change is not an improvement.",
    "created_at": "2022-03-20T22:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419027",
    "user": "https://github.com/mkoeppe"
}
```

There's no need for a new ticket because the change is not an improvement.



---

archive/issue_comments_419028.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-20T22:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419028",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_419029.json:
```json
{
    "body": "Replying to [comment:98 gh-tobiasdiez]:\n> please be my guest.\n\n\nhere we go",
    "created_at": "2022-03-20T22:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419029",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:98 gh-tobiasdiez]:
> please be my guest.


here we go



---

archive/issue_comments_419030.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-20T22:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419030",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_419031.json:
```json
{
    "body": "This is now focused on the change described on the ticket, so I can review it without needing to consult with the original authors regarding style changes (comment:80).",
    "created_at": "2022-03-20T22:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419031",
    "user": "https://github.com/mkoeppe"
}
```

This is now focused on the change described on the ticket, so I can review it without needing to consult with the original authors regarding style changes (comment:80).



---

archive/issue_comments_419032.json:
```json
{
    "body": "Replying to [comment:94 gh-tobiasdiez]:\n> why its worth that we both spend more time discussing this\n\n\nThere's no need to worry about my time - I'm investing it for the long term benefits.",
    "created_at": "2022-03-20T22:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419032",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:94 gh-tobiasdiez]:
> why its worth that we both spend more time discussing this


There's no need to worry about my time - I'm investing it for the long term benefits.



---

archive/issue_comments_419033.json:
```json
{
    "body": "OK, `./sage -tox -e pyright src/sage/manifolds/topological_submanifold.py` (#30411) does not report additional failures introduced here, so it looks like the solution with `assert` worked.",
    "created_at": "2022-03-20T23:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419033",
    "user": "https://github.com/mkoeppe"
}
```

OK, `./sage -tox -e pyright src/sage/manifolds/topological_submanifold.py` (#30411) does not report additional failures introduced here, so it looks like the solution with `assert` worked.



---

archive/issue_comments_419034.json:
```json
{
    "body": "I've also successfully tested `./sage -tp --long src/sage/manifolds/` with python 3.7.",
    "created_at": "2022-03-21T00:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419034",
    "user": "https://github.com/mkoeppe"
}
```

I've also successfully tested `./sage -tp --long src/sage/manifolds/` with python 3.7.



---

archive/issue_comments_419035.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-21T00:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419035",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_419036.json:
```json
{
    "body": "Thanks for this contribution.",
    "created_at": "2022-03-21T00:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419036",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for this contribution.



---

archive/issue_comments_419037.json:
```json
{
    "body": "Thanks",
    "created_at": "2022-03-21T09:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419037",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks



---

archive/issue_comments_419038.json:
```json
{
    "body": "Why do we have doc changes in here such as:\n\n```diff\n-    the *vector field module* `\\mathfrak{X}(U,\\Phi)` is the set of\n+    the *vector field module* `\\mathfrak{X}(U,\\Phi) = \\Gamma(\\Phi^* TM)` is the set of\n```\n\nThis should not be part of this ticket, should it?\n\nI agree that the doc could use some upgrades, but I suggest we do that in another ticket, and then thoroughly.",
    "created_at": "2022-03-21T10:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419038",
    "user": "https://github.com/mjungmath"
}
```

Why do we have doc changes in here such as:

```diff
-    the *vector field module* `\mathfrak{X}(U,\Phi)` is the set of
+    the *vector field module* `\mathfrak{X}(U,\Phi) = \Gamma(\Phi^* TM)` is the set of
```

This should not be part of this ticket, should it?

I agree that the doc could use some upgrades, but I suggest we do that in another ticket, and then thoroughly.



---

archive/issue_comments_419039.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2022-03-21T10:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419039",
    "user": "https://github.com/mjungmath"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_419040.json:
```json
{
    "body": "Here's the corresponding follow-up: #33542",
    "created_at": "2022-03-21T10:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419040",
    "user": "https://github.com/mjungmath"
}
```

Here's the corresponding follow-up: #33542



---

archive/issue_comments_419041.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-21T11:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419041",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_419042.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-03-21T11:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419042",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_419043.json:
```json
{
    "body": "I've reduced the scope of the ticket as requested",
    "created_at": "2022-03-21T11:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419043",
    "user": "https://github.com/mkoeppe"
}
```

I've reduced the scope of the ticket as requested



---

archive/issue_comments_419044.json:
```json
{
    "body": "The documentation changes are now on #33542.",
    "created_at": "2022-03-21T11:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419044",
    "user": "https://github.com/mkoeppe"
}
```

The documentation changes are now on #33542.



---

archive/issue_comments_419045.json:
```json
{
    "body": "I really don't like the extra imports like\n\n```diff\n+ from sage.tensor.modules.free_module_basis import FreeModuleBasis\n```\nin `src/sage/tensor/modules/free_module_tensor.py`. They are used only for type checking. On a pure Python side, they make the code more complicated (and potentially slower) for nothing. Do we have a policy at the level of all Sage for this?",
    "created_at": "2022-03-21T17:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419045",
    "user": "https://github.com/egourgoulhon"
}
```

I really don't like the extra imports like

```diff
+ from sage.tensor.modules.free_module_basis import FreeModuleBasis
```
in `src/sage/tensor/modules/free_module_tensor.py`. They are used only for type checking. On a pure Python side, they make the code more complicated (and potentially slower) for nothing. Do we have a policy at the level of all Sage for this?



---

archive/issue_comments_419046.json:
```json
{
    "body": "We can move them into `if TYPE_CHECKING:` blocks.",
    "created_at": "2022-03-21T20:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419046",
    "user": "https://github.com/mkoeppe"
}
```

We can move them into `if TYPE_CHECKING:` blocks.



---

archive/issue_comments_419047.json:
```json
{
    "body": "I believe this the currently preferred solution, at least until https://peps.python.org/pep-0649/ hits. I don't think we need a Sage-specific policy on this.",
    "created_at": "2022-03-21T20:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419047",
    "user": "https://github.com/mkoeppe"
}
```

I believe this the currently preferred solution, at least until https://peps.python.org/pep-0649/ hits. I don't think we need a Sage-specific policy on this.



---

archive/issue_comments_419048.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-21T20:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419048",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419049.json:
```json
{
    "body": "Replying to [comment:117 mkoeppe]:\n> We can move them into `if TYPE_CHECKING:` blocks.\n\nYes, at least this would be consistent with other parts of the code introduced in this ticket where `if TYPE_CHECKING:` is used.",
    "created_at": "2022-03-21T20:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419049",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:117 mkoeppe]:
> We can move them into `if TYPE_CHECKING:` blocks.

Yes, at least this would be consistent with other parts of the code introduced in this ticket where `if TYPE_CHECKING:` is used.



---

archive/issue_comments_419050.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-21T20:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419051.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-21T20:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419051",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-21T20:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419053.json:
```json
{
    "body": "There's also one file that still manually string-quotes types instead of relying on `from __future__ import annotations`.",
    "created_at": "2022-03-21T20:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419053",
    "user": "https://github.com/mkoeppe"
}
```

There's also one file that still manually string-quotes types instead of relying on `from __future__ import annotations`.



---

archive/issue_comments_419054.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-21T20:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419054",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_419055.json:
```json
{
    "body": "Ready now, I think. \n\nThe patch is still bigger than really necessary as a result of Tobias's tool alphabetically sorting the imports.\n\nAlso the formatting of the typed argument lists uses a mix of styles across the file.",
    "created_at": "2022-03-21T20:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419055",
    "user": "https://github.com/mkoeppe"
}
```

Ready now, I think. 

The patch is still bigger than really necessary as a result of Tobias's tool alphabetically sorting the imports.

Also the formatting of the typed argument lists uses a mix of styles across the file.



---

archive/issue_comments_419056.json:
```json
{
    "body": "Tests still OK with Python 3.7",
    "created_at": "2022-03-21T20:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419056",
    "user": "https://github.com/mkoeppe"
}
```

Tests still OK with Python 3.7



---

archive/issue_comments_419057.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-28T10:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419057",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_419058.json:
```json
{
    "body": "As all remarks seem to be addressed, Matthias is fine with my changes and I'm with his, I'll set it back to positively reviewed.",
    "created_at": "2022-03-28T10:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419058",
    "user": "https://github.com/tobiasdiez"
}
```

As all remarks seem to be addressed, Matthias is fine with my changes and I'm with his, I'll set it back to positively reviewed.



---

archive/issue_comments_419059.json:
```json
{
    "body": "There is a merge failure with Sage 9.6.beta6",
    "created_at": "2022-03-28T10:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419059",
    "user": "https://github.com/egourgoulhon"
}
```

There is a merge failure with Sage 9.6.beta6



---

archive/issue_comments_419060.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-03-28T10:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419060",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_419061.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-28T16:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419061",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_419062.json:
```json
{
    "body": "rebased",
    "created_at": "2022-03-28T16:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419062",
    "user": "https://github.com/mkoeppe"
}
```

rebased



---

archive/issue_comments_419063.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-28T16:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419063",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_419064.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-29T06:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419064",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_419065.json:
```json
{
    "body": "The patchbot reveals some coverage issue, but this seems to be triggered by the use of ``@`overload`, hence this is more an issue about the patchbot's `coverage` plugin than about the present code.",
    "created_at": "2022-03-29T06:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419065",
    "user": "https://github.com/egourgoulhon"
}
```

The patchbot reveals some coverage issue, but this seems to be triggered by the use of ``@`overload`, hence this is more an issue about the patchbot's `coverage` plugin than about the present code.



---

archive/issue_comments_419066.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-03-29T08:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419066",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks!



---

archive/issue_comments_419067.json:
```json
{
    "body": "Replying to [comment:132 egourgoulhon]:\n> The patchbot reveals some coverage issue, but this seems\n> to be triggered by the use of ``@`overload`, hence this is\n> more an issue about the patchbot's `coverage` plugin\n> than about the present code.\n\n\nMight be worth opening a ticket at\n\n- https://github.com/sagemath/sage-patchbot/issues",
    "created_at": "2022-03-29T19:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419067",
    "user": "https://github.com/slel"
}
```

Replying to [comment:132 egourgoulhon]:
> The patchbot reveals some coverage issue, but this seems
> to be triggered by the use of ``@`overload`, hence this is
> more an issue about the patchbot's `coverage` plugin
> than about the present code.


Might be worth opening a ticket at

- https://github.com/sagemath/sage-patchbot/issues



---

archive/issue_comments_419068.json:
```json
{
    "body": "Replying to [comment:135 slelievre]:\n> \n> Might be worth opening a ticket at\n> \n> - https://github.com/sagemath/sage-patchbot/issues\n\n\nThanks for the suggestion; this is now\nhttps://github.com/sagemath/sage-patchbot/issues/161",
    "created_at": "2022-03-30T20:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419068",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:135 slelievre]:
> 
> Might be worth opening a ticket at
> 
> - https://github.com/sagemath/sage-patchbot/issues


Thanks for the suggestion; this is now
https://github.com/sagemath/sage-patchbot/issues/161



---

archive/issue_events_076221.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-02T10:52:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29538#event-76221"
}
```



---

archive/issue_comments_419069.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-02T10:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29538#issuecomment-419069",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
