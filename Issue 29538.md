# Issue 29538: Add a bit of typing to manifolds package

Issue created by migration from https://trac.sagemath.org/ticket/29775

Original creator: @tobiasdiez

Original creation time: 2020-06-01 12:04:41

CC:  tscrim nthiery @mjungmath chapoton

Keywords: typing

This PR adds a bit of typing information to some of the methods in the manifolds package that I added while browsing the code. I've changed the inline documentation accordingly. If these types of changes are ok, I'll add further typing information as I proceed understanding the code.
Probably the biggest change is the addition of the identity map for a smooth manifold (which is a `DiffMap` and not just a `ContininousMap`).

Moreover, a few very minor clarifications to the documentation were added as well.

(This is my first real PR to sagemath, so please forgive me if I overlooked something.)


---

Comment by mkoeppe created at 2020-06-01 19:26:39

In case people are interested in a general discussion of typing in the Sage library: #29756 Meta-ticket: Review of Python 3 features that sagelib should use systematically


---

Comment by @tobiasdiez created at 2020-06-01 22:49:13

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2020-06-02 10:32:54

The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...


---

Comment by git created at 2020-06-02 14:44:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-02 16:26:38

Replying to [comment:3 egourgoulhon]:
> The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...

I think this is a very important point, and one that needs discussion in a broader context. 

1) Can the category system be used to add these tightened type annotations automatically?

2) In such situations, should the doctests be replaced or augmented by `_test_...` methods so that subclasses are tested properly.


---

Comment by egourgoulhon created at 2020-06-02 18:58:27

Replying to [comment:3 egourgoulhon]:
> The addition of `identity_map` to `DifferentiableManifold` is code duplication (the code is identical to `identity_map` provided by the mother class `TopologicalManifold`). I'm not sure adding typing  is worth duplicating the code, opening the root to all evil...

If we don't duplicate the code, then the output type of `identity_map` is indicated as `ContinuousMap`, which is correct for a smooth manifold as well. Of course, for such a manifold, it is a particular kind of continuous map, namely a smooth one and the returned object pertains to the subclass `DiffMap` of `ContinuousMap`. But I would say we can live with this; IMHO, it is preferable not to duplicate the code and have type hints not as precise as they could be.


---

Comment by @tobiasdiez created at 2020-06-03 11:50:47

It's true that I noticed while working on typing support, but the addition is actually rather independent of this. As Eric says, `identity_map` on a differentiable manifold only returns a `ContinuousMap` and one can thus not take it's differential etc. So far this doesn't lead to any problems since the identity case is always handled separately in the code. I'm not familiar with the category code, but maybe it can be improved so that the function `def hom_set: return Hom(self, self)` defined in class A, returns the correct homomrophisms for derived classes `B(A)` as well (so `b.hom_set` returns the hom set of `b` as an element of B).

If it were just for typing, one could also annotate the original `identity_map` on `TopologicalManifold` (see https://mypy.readthedocs.io/en/stable/more_types.html#advanced-uses-of-self-types).


---

Comment by egourgoulhon created at 2020-06-03 12:18:22

Replying to [comment:8 gh-tobiasdiez]:
> It's true that I noticed while working on typing support, but the addition is actually rather independent of this. As Eric says, `identity_map` on a differentiable manifold only returns a `ContinuousMap` and one can thus not take it's differential etc. 

No, one can take the differential because the returned object in this case is actually a `DiffMap`, which is also a `ContinuousMap` since `DiffMap` is a subclass of `ContinuousMap` (see the example below). 

>I'm not familiar with the category code, but maybe it can be improved so that the function `def hom_set: return Hom(self, self)` defined in class A, returns the correct homomrophisms for derived classes `B(A)` as well (so `b.hom_set` returns the hom set of `b` as an element of B).

No need for improvement, this is already the case:

```
sage: M = Manifold(2, 'M'); M
2-dimensional differentiable manifold M
sage: Id = M.identity_map()
sage: type(Id)
<class 'sage.manifolds.differentiable.manifold_homset.DifferentiableManifoldHomset_with_category.element_class'>
sage: isinstance(Id, sage.manifolds.differentiable.diff_map.DiffMap)
True
sage: isinstance(Id, sage.manifolds.continuous_map.ContinuousMap)
True
sage: Id.parent()
Set of Morphisms from 2-dimensional differentiable manifold M 
 to 2-dimensional differentiable manifold M in Category of 
 smooth manifolds over Real Field with 53 bits of precision
```



---

Comment by git created at 2020-06-04 10:19:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-06-04 14:09:58

Thanks for the clarification. I actually tested it before, but apparently made some mistakes as `identity_map` indeed returns a `DiffMap` on a differentiable manifold.

I've thus removed the `identity_map` method again from `DifferentiableManifold` and instead added the typing information to the existing map.

Anything else that needs improvement? From my side this is good to go. I would add more typing in follow-up issues to keep the size of the changes small and reviewable.


---

Comment by egourgoulhon created at 2020-06-08 13:27:44

There are some doctest errors, as well as coverage, pyflakes and pycodeystyle errors; check the patchbot reports (click on the "9.2.beta0 button" in the top right of the ticket description).


---

Comment by egourgoulhon created at 2020-06-08 13:30:26

Another thing: the typing information does not show up in the html documentation produced by Sphinx.


---

Comment by egourgoulhon created at 2020-06-08 13:40:23

The file `pyrightconfig.json` at the root of the Sage directory has probably been added to the commit by mistake.


---

Comment by @tobiasdiez created at 2020-06-08 17:02:08

I had a quick look at the errors and most of them are a result of that the tools (pyflakes and pycodestyle) have problems with the typing syntax. After a bit of googling, it appears that these issues are fixed in the most recent versions (e.g. https://github.com/PyCQA/pyflakes/issues/247 and https://github.com/vim-syntastic/syntastic/issues/1667). Where do I find the version used? Moreover, one common problems seems to be that these tools need to be installed under python 3, since otherwise they check the files using python 2 syntax (e.g. https://github.com/vim-syntastic/syntastic/issues/1667#issuecomment-172538109). How can I make sure that it's the case indeed?
I'll have a look at the remaining issues after these false positives are fixed.

Finally, the `pyrightconfig.json` is the configuration file for `pyright`, which is static type checker. At the moment there are still to many type problems but in the long term this should be integrated in the build progress.


---

Comment by mkoeppe created at 2020-07-22 17:28:18

Replying to [comment:15 gh-tobiasdiez]:
> Finally, the `pyrightconfig.json` is the configuration file for `pyright`, which is static type checker. At the moment there are still to many type problems but in the long term this should be integrated in the build progress.

Could you create a separate ticket for this please and link to it from #28936


---

Comment by mkoeppe created at 2020-07-22 17:31:14

Replying to [comment:15 gh-tobiasdiez]:
> I had a quick look at the errors and most of them are a result of that the tools (pyflakes and pycodestyle) have problems with the typing syntax. ... Where do I find the version used? 

Best to open an issue on https://github.com/sagemath/sage-patchbot


---

Comment by chapoton created at 2020-08-14 12:46:22

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2020-08-14 12:46:22

branch is red and needs to be rebased on the latest beta


---

Comment by git created at 2020-08-14 20:21:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-14 20:32:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-14 21:04:20

`@`mkoeppe done!
`@`chapoton rebased!

The pyflakes tests still fail because pyflakes does not (fully) understand the typings code. Not sure if the reason is an old pyflakes or if this is even unresolved in the most recent version. Refs https://github.com/sagemath/sage-patchbot/issues/143. Can I disable pyflakes for the lines that are wrongly reported?


---

Comment by @tobiasdiez created at 2020-08-14 21:04:45

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-08-16 05:48:04

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-08-16 05:48:04


```
sage -t --long --warn-long 63.8 --random-seed=0 src/sage/manifolds/manifold.py
**********************************************************************
File "src/sage/manifolds/manifold.py", line 2203, in sage.manifolds.manifold.TopologicalManifold.identity_map
Failed example:
    isinstance(id, DiffMap)
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.manifold.TopologicalManifold.identity_map[10]>", line 1, in <module>
        isinstance(id, DiffMap)
    NameError: name 'DiffMap' is not defined
**********************************************************************
File "src/sage/manifolds/manifold.py", line 2209, in sage.manifolds.manifold.TopologicalManifold.identity_map
Failed example:
    isinstance(M.identity_map(), DiffMap)
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.manifold.TopologicalManifold.identity_map[12]>", line 1, in <module>
        isinstance(M.identity_map(), DiffMap)
    NameError: name 'DiffMap' is not defined
```



---

Comment by @tobiasdiez created at 2020-08-16 12:53:55

Thanks for your comment. How are imports for the documentation handled? Should I simply add the import for the whole file, or is there a special way to do this just for the doc tests?


---

Comment by @kliem created at 2020-08-16 18:22:17

I think you can just do

```
from sage.manifolds.differentiable.diff_map import DiffMap
```


at the beginning of the doctest or

```
isinstance(id, sage.manifolds.differentiable.diff_map.DiffMap)
```


After building your modified sage, the doctest should pass with

```
sage -t --long src/sage/manifolds/manifold.py
```


The doctest works almost like a mini sage session.


---

Comment by git created at 2020-08-28 17:08:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-28 17:17:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-28 17:21:55

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-08-28 17:21:55

I've finally fixed these missing imports (or so I hope, I cannot run sage -t because pip couldn't be installed via make -- I will report this elsewhere). Thanks `@`gh-kliem for the helpful instructions.

The patchbot warnings should be fixed now as well. Note that the negative coverage changes  are due to the fact that ``@`overload` seems not to be supported.


---

Comment by chapoton created at 2020-09-25 17:01:16

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2020-09-25 17:01:16

red branch => needs work


---

Comment by git created at 2020-09-26 19:39:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-09-26 19:41:03

Thanks. I've now merged upstream into this branch.


---

Comment by @tobiasdiez created at 2020-09-26 19:41:03

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-11-01 18:06:17

red branch => needs work


---

Comment by chapoton created at 2020-11-01 18:06:31

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-08 13:47:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-08 13:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-08 13:55:42

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-11-08 13:55:42

Merged upstream.


---

Comment by mkoeppe created at 2020-11-09 02:06:06

In changes like this one:

```
@@ -596,14 +597,13 @@ class DegenerateSubmanifold(DegenerateManifold, DifferentiableSubmanifold):
         self._default_screen = self._screens[name]
         return self._screens[name]
 
-    def induced_metric(self):
+    def induced_metric(self) -> DegenerateMetric:
         r"""
         Return the pullback of the ambient metric.
 
         OUTPUT:
 
-        - induced metric, as an instance of
-          :class:`~sage.manifolds.differentiable.metric.DegenerateMetric`
+        - induced mettric
 
         EXAMPLES:
```

Did you check that our built documentation contains the output type?

(Also note this introduces a typo)


---

Comment by egourgoulhon created at 2020-11-09 20:54:54

Replying to [comment:39 mkoeppe]:
> In changes like this one:
> {{{
> -    def induced_metric(self):
> +    def induced_metric(self) -> DegenerateMetric:
>  
> -        - induced metric, as an instance of
> -          :class:`~sage.manifolds.differentiable.metric.DegenerateMetric`
> +        - induced mettric
> }}}
> Did you check that our built documentation contains the output type?
> 

No it does not: the output type does no longer appear in the generated html documentation.
> (Also note this introduces a typo)
> 

Moreover, what is the meaning of this change in `src/sage/manifolds/differentiable/manifold.py`:

```diff
-    def metric(self, name, signature=None, latex_name=None, dest_map=None):
+    def metric(self, name=None, signature=None, latex_name=None, dest_map=None) -> PseudoRiemannianMetric:
```

i.e. why `name` is replaced by `name=None` ?


---

Comment by egourgoulhon created at 2020-11-09 21:28:33

If we do

```
sage: M = Manifold(2, 'M')                                                                          
sage: M.vector_field_module?                                                                        
```

we get

``` 
Signature:     
M.vector_field_module(
    dest_map: sage.manifolds.differentiable.diff_map.DiffMap = None,
    force_free=False,
) -> sage.manifolds.differentiable.vectorfield_module.VectorFieldModule
```

which is barely readable, I think.


---

Comment by @tobiasdiez created at 2020-11-09 21:29:18

I'm currently working on a solution to show the typing information in the documentation using https://pypi.org/project/sphinx-autodoc-typehints/ (in a new ticket of course).

Not sure why I changed the name to `None`. Probably I was "inspired" by the constructor of a generic tensor field:

```
def __init__(self, vector_field_module, tensor_type, name=None,
                 latex_name=None, sym=None, antisym=None, parent=None):
```

Does the name has to be set for a metric?


---

Comment by egourgoulhon created at 2020-11-10 14:43:58

Replying to [comment:42 gh-tobiasdiez]:
> 
> Not sure why I changed the name to `None`. Probably I was "inspired" by the constructor of a generic tensor field:
> {{{
> def __init__(self, vector_field_module, tensor_type, name=None,
>                  latex_name=None, sym=None, antisym=None, parent=None):
> }}}
> Does the name has to be set for a metric? 
Yes for it is used to set the name of derived quantities (Levi-Civita connection, curvature tensor, etc.). Of course, this can be discussed and changed, but in another ticket, since this definitely does not pertain to the current ticket.


---

Comment by mkoeppe created at 2020-11-11 17:01:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-21 12:20:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-21 12:35:52

I tried to change the documentation to incorporate typing information, but this turns out to be a bit more complicated than expected.
So for now I've readded the class information in the documentation.

Moreover, I've removed the `name = None` for the metric again.

So it should be ready for review now.


---

Comment by @tobiasdiez created at 2020-11-21 12:35:52

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-12-19 18:21:18

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2020-12-19 18:21:18

red branch


---

Comment by git created at 2020-12-20 22:46:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-20 22:47:48

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-12-20 22:47:48

Merged develop branch.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by @tobiasdiez created at 2021-04-23 08:12:41

It would be nice if this ticket could be reviewed. Thanks!


---

Comment by egourgoulhon created at 2021-04-24 12:26:46

The patchbot reports many doctest errors.


---

Comment by mkoeppe created at 2021-04-24 21:03:47

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-05-27 23:28:08

Also, now that we can use `from __future__ import annotations`, I think some of the type annotations can be simplified


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by @tobiasdiez created at 2021-11-28 20:52:49

Sorry for the delay, but the doctests should be fixed now. I also use the future import for annotations, which indeed simplifies a few things. 
Again ready for review.


---

Comment by @tobiasdiez created at 2021-11-28 20:52:49

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-11-28 20:53:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-28 20:53:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by chapoton created at 2021-12-28 16:27:19

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-12-28 16:27:19

red branch => needs work


---

Comment by @tobiasdiez created at 2021-12-28 17:53:03

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-12-28 17:53:03

Setting it back to needs review as the merge conflict should be easy to resolve but I'm not near my dev machine for a couple of days.

It would be really nice if someone could review this ticket, as it's in this limbo state now for quite some time.


---

Comment by git created at 2022-01-03 12:13:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-28 00:07:33

Changing component from geometry to manifolds.


---

Comment by mkoeppe created at 2022-02-23 17:58:27

red branch


---

Comment by mkoeppe created at 2022-02-23 17:58:27

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-02-23 21:52:57

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-23 21:52:57

Merging the develop branch should be trivial, but I'll not be able to do this is in the near future; so setting it back to "needs review".


---

Comment by git created at 2022-03-01 13:30:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-01 17:24:06


```
--- a/src/sage/manifolds/differentiable/metric.py
+++ b/src/sage/manifolds/differentiable/metric.py
@@ -41,12 +41,16 @@ REFERENCES:
 #  the License, or (at your option) any later version.
 #                  https://www.gnu.org/licenses/
 # *****************************************************************************
+from __future__ import annotations
+from typing import overload, TYPE_CHECKING
 
 from __future__ import annotations
 from typing import TYPE_CHECKING
 from sage.rings.integer import Integer
 from sage.manifolds.differentiable.tensorfield import TensorField
 from sage.manifolds.differentiable.tensorfield_paral import TensorFieldParal
+if TYPE_CHECKING:
+    from sage.manifolds.differentiable.diff_form import DiffForm
 
 if TYPE_CHECKING:
     from sage.manifolds.differentiable.diff_form import DiffForm
```


This doesn't look right


---

Comment by mkoeppe created at 2022-03-01 17:24:15

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-03-01 17:25:51

And I would urge to use more restraint in changing the coding style.
For example, these changes are entirely gratuitous:

```
     if structure is None:
-        diff_degree = extra_kwds.get('diff_degree', infinity)
+        diff_degree = extra_kwds.get("diff_degree", infinity)
         if diff_degree == infinity:
-            structure = 'smooth'
+            structure = "smooth"
         elif diff_degree > 0:
-            structure = 'differentiable'
+            structure = "differentiable"
         else:
-            structure = 'topological'
+            structure = "topological"
```



---

Comment by git created at 2022-03-01 18:18:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-01 18:19:50

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-01 18:19:50

Replying to [comment:67 mkoeppe]:
> {{{
> --- a/src/sage/manifolds/differentiable/metric.py
> +++ b/src/sage/manifolds/differentiable/metric.py
> This doesn't look right

Thanks, I was still in the process of fixing some of the merge conflicts. Done now.


---

Comment by mkoeppe created at 2022-03-03 01:01:19

You didn't address comment:69


---

Comment by mkoeppe created at 2022-03-03 01:01:19

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-03-03 01:11:26

And this change is an API change (= introduces a bug).

The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.

Your change removes the marshaling.


```
 TensorType = Tuple[int, int]

@@ -402,8 +405,17 @@ class TensorField(ModuleElementWithMutability):
         ValueError: the name of an immutable element cannot be changed
 
     """
-    def __init__(self, vector_field_module, tensor_type, name=None,
-                 latex_name=None, sym=None, antisym=None, parent=None):
+
+    def __init__(
+        self,
+        vector_field_module: VectorFieldModule,
+        tensor_type: TensorType,
+        name: Optional[str] = None,
+        latex_name: Optional[str] = None,
+        sym=None,
+        antisym=None,
+        parent=None,
+    ):
         r"""
         Construct a tensor field.
 
@@ -451,7 +463,7 @@ class TensorField(ModuleElementWithMutability):
             parent = vector_field_module.tensor_module(*tensor_type)
         ModuleElementWithMutability.__init__(self, parent)
         self._vmodule = vector_field_module
-        self._tensor_type = tuple(tensor_type)
+        self._tensor_type = tensor_type
         self._tensor_rank = self._tensor_type[0] + self._tensor_type[1]
         self._is_zero = False # a priori, may be changed below or via
                               # method __bool__()
```



---

Comment by @tobiasdiez created at 2022-03-03 12:10:22

Replying to [comment:73 mkoeppe]:
> And this change is an API change (= introduces a bug).
> 
> The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.

According to the documentation 
> - ``tensor_type`` -- pair `(k,l)` with `k` being the contravariant rank
      and `l` the covariant rank

which is quite clear about that it expects a 2-tuple. Thus, this change is only a formalization of the current public interface; I can of course revert it and adapt the documentation to point out that it also accepts arbitrary iterables if that's really desired. It feels however more consistent to represent the tensor type everywhere by a tuple.


---

Comment by @tobiasdiez created at 2022-03-03 12:11:16

Replying to [comment:72 mkoeppe]:
> You didn't address comment:69

I accidentally run a code formatter over these files and committed the changes; sorry for this. Will try not to do this again in the future.


---

Comment by mkoeppe created at 2022-03-03 19:07:50

Replying to [comment:74 gh-tobiasdiez]:
> Replying to [comment:73 mkoeppe]:
> > And this change is an API change (= introduces a bug).
> > 
> > The argument `tensor_type` does NOT have `Tuple[int, int]` as its input type. It also accepts lists. It marshals the input to a tuple.
> 
> According to the documentation 
> > - ``tensor_type`` -- pair `(k,l)` with `k` being the contravariant rank
>       and `l` the covariant rank
> 
> which is quite clear about that it expects a 2-tuple. 

Well, the code obviously was concerned about making it a tuple to provide a robust interface. 

> Thus, this change is only a formalization of the current public interface

No, this is not how Python typing works. You cannot rely on the type annotations for input checking/marshaling; this still has to be done by code. Type annotations are merely decoration for documentation purposes and static checkers.


---

Comment by git created at 2022-03-20 13:13:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-20 16:23:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-20 16:54:09

I think these changes are not good. They are obscuring the internal data representation

```
@@ -847,11 +847,11 @@ class TopologicalSubmanifold(TopologicalManifold):
              3-dimensional topological manifold M
 
         """
-        if not self._immersed:
+        if not self._immersed or not self._immersion:
             raise ValueError("the submanifold is not immersed")
         return self._immersion

[...] 
@@ -873,7 +873,7 @@ class TopologicalSubmanifold(TopologicalManifold):
              3-dimensional topological manifold M
 
         """
-        if not self._embedded:
+        if not self._embedded or not self._immersion:
             raise ValueError("the submanifold is not embedded")
         return self._immersion
 
```



---

Comment by mkoeppe created at 2022-03-20 16:57:42

I'm personally in favor of these changes (the 80 character limit is a bit inflexible when module names or identifiers are already 40-ish characters long), but probably `@`egourgoulhon should indicate whether these formatting changes are acceptable / welcome.

```
@@ -647,8 +654,8 @@ class VectorFieldModule(UniqueRepresentation, Parent):
             for more examples and documentation.
 
         """
-        from sage.manifolds.differentiable.diff_form_module import \
-                                                                 DiffFormModule
+        from sage.manifolds.differentiable.diff_form_module import DiffFormModule
+
         if p == 0:
             return self._ring
         if p not in self._dual_exterior_powers:
```



---

Comment by @tobiasdiez created at 2022-03-20 17:00:19

I don't understand what you mean. How can a submanifold be considered to be immersed/embedded if there is map that provides such an immersion?


---

Comment by mkoeppe created at 2022-03-20 18:58:32

It is an invariant of the internal representation (data structure) that `_immersed or _embedded` implies that `_immersion` is set.


---

Comment by @tobiasdiez created at 2022-03-20 19:39:58

Replying to [comment:82 mkoeppe]:
> It is an invariant of the internal representation (data structure) that `_immersed or _embedded` implies that `_immersion` is set.

But that's not something a static checker could infer and thus they warn that `return self._immersion` might return null although the method is decorated to always return a continuous map.


---

Comment by mkoeppe created at 2022-03-20 19:41:38

It may be a use case for an `assert _immersion` here. If the static checker still can't infer it after that, get a better one


---

Comment by @tobiasdiez created at 2022-03-20 19:46:54

Replying to [comment:84 mkoeppe]:
> It may be a use case for an `assert _immersion` here. If the static checker still can't infer it after that, get a better one

But that's what the above code is doing (except for displaying a nicer error message in the case its null). What a type checker cannot infer is the "invariant of the internal representation" that `_immersed is true` implies that `_immersion is not null`. There are workarounds for such implications for type checkers but they are overkill in this situation.


---

Comment by mkoeppe created at 2022-03-20 19:50:12

No, your changes weaken the invariant, indicating to developers that it's OK to set `_immersed` to `True` and `_immersion` to `None`.


---

Comment by @tobiasdiez created at 2022-03-20 20:08:30

Would it be okay if I completely replace the `_immersed` variable with checks if `_immersion` is None? As you indirectly noticed, keeping the internal state consistent just creates an unnecessary overhead.


---

Comment by mkoeppe created at 2022-03-20 20:10:41

Try `assert` if you haven't yet.


---

Comment by git created at 2022-03-20 21:08:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-20 21:25:18

To separate the changes that the ticket promises from the reformatting, I'd recommend `git merge 9.6.beta5 && git reset 9.6.beta5 && git add -p`.


---

Comment by @tobiasdiez created at 2022-03-20 21:31:19

Just tried it on gitpod: merge: 9.6.beta5 - not something we can merge


---

Comment by mkoeppe created at 2022-03-20 21:35:14

Fetch it first: `git fetch trac 9.6.beta5`


---

Comment by git created at 2022-03-20 22:01:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @tobiasdiez created at 2022-03-20 22:03:42

That also don't work, but I've managed to revert (most of) the formatting changes now. Still don't understand why its worth that we both spend more time discussing this than it would to have been to review.


---

Comment by mkoeppe created at 2022-03-20 22:06:20

I think time would be well spent on some git practice...


---

Comment by mkoeppe created at 2022-03-20 22:09:43

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-03-20 22:09:43

Please learn to use `git reset` and `git add -p` and prepare a ticket that only changes what needs to be changed. comment:69 still unaddressed.


---

Comment by mkoeppe created at 2022-03-20 22:11:47

Replying to [comment:94 gh-tobiasdiez]:
> Still don't understand why its worth that we both spend more time discussing this than it would to have been to review. 

Then please prepare a focused ticket instead of forcing reviewers to look at all that stuff.


---

Comment by @tobiasdiez created at 2022-03-20 22:16:54

Replying to [comment:95 mkoeppe]:
> I think time would be well spent on some git practice...

Thanks for this very constructive and helpful comment. Definitely motivated me to not spend any more time in reverting formatting changes.

If you really think its worth the time to extract the homogenization of quotes around strings in 3 lines to a new ticket, please be my guest.


---

Comment by mkoeppe created at 2022-03-20 22:19:33

There's no need for a new ticket because the change is not an improvement.


---

Comment by git created at 2022-03-20 22:25:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-20 22:26:02

Replying to [comment:98 gh-tobiasdiez]:
> please be my guest.

here we go


---

Comment by mkoeppe created at 2022-03-20 22:26:55

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-20 22:35:18

This is now focused on the change described on the ticket, so I can review it without needing to consult with the original authors regarding style changes (comment:80).


---

Comment by mkoeppe created at 2022-03-20 22:47:31

Replying to [comment:94 gh-tobiasdiez]:
> why its worth that we both spend more time discussing this

There's no need to worry about my time - I'm investing it for the long term benefits.


---

Comment by mkoeppe created at 2022-03-20 23:11:40

OK, `./sage -tox -e pyright src/sage/manifolds/topological_submanifold.py` (#30411) does not report additional failures introduced here, so it looks like the solution with `assert` worked.


---

Comment by mkoeppe created at 2022-03-21 00:09:31

I've also successfully tested `./sage -tp --long src/sage/manifolds/` with python 3.7.


---

Comment by mkoeppe created at 2022-03-21 00:09:54

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-03-21 00:09:54

Thanks for this contribution.


---

Comment by @tobiasdiez created at 2022-03-21 09:50:10

Thanks


---

Comment by @mjungmath created at 2022-03-21 10:24:00

Why do we have doc changes in here such as:


```diff
-    the *vector field module* `\mathfrak{X}(U,\Phi)` is the set of
+    the *vector field module* `\mathfrak{X}(U,\Phi) = \Gamma(\Phi^* TM)` is the set of
```


This should not be part of this ticket, should it?

I agree that the doc could use some upgrades, but I suggest we do that in another ticket, and then thoroughly.


---

Comment by @mjungmath created at 2022-03-21 10:24:00

Changing status from positive_review to needs_info.


---

Comment by @mjungmath created at 2022-03-21 10:35:56

Here's the corresponding follow-up: #33542


---

Comment by git created at 2022-03-21 11:34:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-21 11:35:10

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2022-03-21 11:36:19

I've reduced the scope of the ticket as requested


---

Comment by mkoeppe created at 2022-03-21 11:39:00

The documentation changes are now on #33542.


---

Comment by egourgoulhon created at 2022-03-21 17:43:40

I really don't like the extra imports like

```diff
+ from sage.tensor.modules.free_module_basis import FreeModuleBasis
```

in `src/sage/tensor/modules/free_module_tensor.py`. They are used only for type checking. On a pure Python side, they make the code more complicated (and potentially slower) for nothing. Do we have a policy at the level of all Sage for this?


---

Comment by mkoeppe created at 2022-03-21 20:02:44

We can move them into `if TYPE_CHECKING:` blocks.


---

Comment by mkoeppe created at 2022-03-21 20:05:27

I believe this the currently preferred solution, at least until https://peps.python.org/pep-0649/ hits. I don't think we need a Sage-specific policy on this.


---

Comment by git created at 2022-03-21 20:09:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-03-21 20:11:12

Replying to [comment:117 mkoeppe]:
> We can move them into `if TYPE_CHECKING:` blocks.
Yes, at least this would be consistent with other parts of the code introduced in this ticket where `if TYPE_CHECKING:` is used.


---

Comment by git created at 2022-03-21 20:14:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-21 20:15:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-21 20:19:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-21 20:21:00

There's also one file that still manually string-quotes types instead of relying on `from __future__ import annotations`.


---

Comment by git created at 2022-03-21 20:26:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-21 20:35:04

Ready now, I think. 

The patch is still bigger than really necessary as a result of Tobias's tool alphabetically sorting the imports.

Also the formatting of the typed argument lists uses a mix of styles across the file.


---

Comment by mkoeppe created at 2022-03-21 20:52:17

Tests still OK with Python 3.7


---

Comment by @tobiasdiez created at 2022-03-28 10:37:37

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-28 10:37:37

As all remarks seem to be addressed, Matthias is fine with my changes and I'm with his, I'll set it back to positively reviewed.


---

Comment by egourgoulhon created at 2022-03-28 10:48:45

There is a merge failure with Sage 9.6.beta6


---

Comment by egourgoulhon created at 2022-03-28 10:48:45

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-03-28 16:42:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-28 16:42:32

rebased


---

Comment by mkoeppe created at 2022-03-28 16:42:32

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2022-03-29 06:59:49

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-03-29 06:59:49

The patchbot reveals some coverage issue, but this seems to be triggered by the use of ``@`overload`, hence this is more an issue about the patchbot's `coverage` plugin than about the present code.


---

Comment by @tobiasdiez created at 2022-03-29 08:41:16

Thanks!


---

Comment by slelievre created at 2022-03-29 19:11:42

Replying to [comment:132 egourgoulhon]:
> The patchbot reveals some coverage issue, but this seems
> to be triggered by the use of ``@`overload`, hence this is
> more an issue about the patchbot's `coverage` plugin
> than about the present code.

Might be worth opening a ticket at

- https://github.com/sagemath/sage-patchbot/issues


---

Comment by egourgoulhon created at 2022-03-30 20:07:15

Replying to [comment:135 slelievre]:
> 
> Might be worth opening a ticket at
> 
> - https://github.com/sagemath/sage-patchbot/issues

Thanks for the suggestion; this is now
https://github.com/sagemath/sage-patchbot/issues/161


---

Comment by vbraun created at 2022-04-02 10:52:31

Resolution: fixed
