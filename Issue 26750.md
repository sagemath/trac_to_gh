# Issue 26750: Failing tests for gap.help

archive/issues_026750.json:
```json
{
    "body": "CC:  @dimpase @embray @slel\n\nOn some patchbots, I see this:\n\n```\nsage -t --long src/sage/interfaces/gap.py\n**********************************************************************\nFile \"src/sage/interfaces/gap.py\", line 1351, in sage.interfaces.gap.Gap.help\nFailed example:\n    print(gap.help('SymmetricGroup', pager=False))\nExpected:\n    <BLANKLINE>\n      50.1-... SymmetricGroup\n    <BLANKLINE>\n      \u2023 SymmetricGroup( [filt, ]deg ) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 function\n    ...\n    <BLANKLINE>\nGot:\n    <BLANKLINE>\n    <BLANKLINE>\n      50.1-10 SymmetricGroup\n    <BLANKLINE>\n      > SymmetricGroup( [filt, ]deg ) ----------------------------------- function\n[..many more lines..]\n```\n\n\nThis seems to be a matter of unicode output or not.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26987\n\n",
    "created_at": "2019-01-01T09:08:29Z",
    "labels": [
        "doctest coverage",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "Failing tests for gap.help",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26750",
    "user": "@jdemeyer"
}
```
CC:  @dimpase @embray @slel

On some patchbots, I see this:

```
sage -t --long src/sage/interfaces/gap.py
**********************************************************************
File "src/sage/interfaces/gap.py", line 1351, in sage.interfaces.gap.Gap.help
Failed example:
    print(gap.help('SymmetricGroup', pager=False))
Expected:
    <BLANKLINE>
      50.1-... SymmetricGroup
    <BLANKLINE>
      ‣ SymmetricGroup( [filt, ]deg ) ─────────────────────────────────── function
    ...
    <BLANKLINE>
Got:
    <BLANKLINE>
    <BLANKLINE>
      50.1-10 SymmetricGroup
    <BLANKLINE>
      > SymmetricGroup( [filt, ]deg ) ----------------------------------- function
[..many more lines..]
```


This seems to be a matter of unicode output or not.

Issue created by migration from https://trac.sagemath.org/ticket/26987





---

archive/issue_comments_376200.json:
```json
{
    "body": "Changing keywords from \"\" to \"GAP\".",
    "created_at": "2019-01-01T23:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376200",
    "user": "@slel"
}
```

Changing keywords from "" to "GAP".



---

archive/issue_comments_376201.json:
```json
{
    "body": "Please provide a link to the full log. It is not clear whether \"many more lines\" mean more errors or not.\n\nFor this particular one I am inclined just to add more `...`\n\nI don't think Sage must produce the same output for different locales, or whatever the real reason for this discrepancy is (perhaps just a patchbot bug).",
    "created_at": "2019-01-02T03:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376201",
    "user": "@dimpase"
}
```

Please provide a link to the full log. It is not clear whether "many more lines" mean more errors or not.

For this particular one I am inclined just to add more `...`

I don't think Sage must produce the same output for different locales, or whatever the real reason for this discrepancy is (perhaps just a patchbot bug).



---

archive/issue_comments_376202.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> Please provide a link to the full log.\n\nI don't know where it was, but the problem is obvious.\n\n> It is not clear whether \"many more lines\" mean more errors or not.\n\nNot errors, since anything after that wrong line is caught by the already-existing `...`",
    "created_at": "2019-01-02T10:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376202",
    "user": "@jdemeyer"
}
```

Replying to [comment:2 dimpase]:
> Please provide a link to the full log.

I don't know where it was, but the problem is obvious.

> It is not clear whether "many more lines" mean more errors or not.

Not errors, since anything after that wrong line is caught by the already-existing `...`



---

archive/issue_comments_376203.json:
```json
{
    "body": "full log at the bottom of\n\nhttps://patchbot.sagemath.org/log/26985/Ubuntu/18.04/x86_64/3.13.0-123-generic/44e979ad077a/2018-12-31%2020:58:39?short",
    "created_at": "2019-01-02T12:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376203",
    "user": "@fchapoton"
}
```

full log at the bottom of

https://patchbot.sagemath.org/log/26985/Ubuntu/18.04/x86_64/3.13.0-123-generic/44e979ad077a/2018-12-31%2020:58:39?short



---

archive/issue_comments_376204.json:
```json
{
    "body": "Replying to [comment:4 chapoton]:\n> full log at the bottom of\n> \n> https://patchbot.sagemath.org/log/26985/Ubuntu/18.04/x86_64/3.13.0-123-generic/44e979ad077a/2018-12-31%2020:58:39?short\n\nThis is with 8.6.rc0 - it would be more interesting to see rc1, where more GAP 4.10 is merged.",
    "created_at": "2019-01-02T13:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376204",
    "user": "@dimpase"
}
```

Replying to [comment:4 chapoton]:
> full log at the bottom of
> 
> https://patchbot.sagemath.org/log/26985/Ubuntu/18.04/x86_64/3.13.0-123-generic/44e979ad077a/2018-12-31%2020:58:39?short

This is with 8.6.rc0 - it would be more interesting to see rc1, where more GAP 4.10 is merged.



---

archive/issue_comments_376205.json:
```json
{
    "body": "for 8.6.beta1:\n\nhttps://patchbot.sagemath.org/log/0/Ubuntu/18.04/x86_64/3.13.0-123-generic/44e979ad077a/2019-01-01%2014:41:41?short",
    "created_at": "2019-01-02T13:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376205",
    "user": "@fchapoton"
}
```

for 8.6.beta1:

https://patchbot.sagemath.org/log/0/Ubuntu/18.04/x86_64/3.13.0-123-generic/44e979ad077a/2019-01-01%2014:41:41?short



---

archive/issue_comments_376206.json:
```json
{
    "body": "is it possible to find out what exactly happens there - is it `print()` unable to output UTF-8, or GAP outputting its help in ASCII, not UTF-8? E.g. I have\n\n```\nsage: type(gap.help('SymmetricGroup', pager=False))\n<type 'unicode'>\n```\n\nand it prints OK, too.",
    "created_at": "2019-01-02T13:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376206",
    "user": "@dimpase"
}
```

is it possible to find out what exactly happens there - is it `print()` unable to output UTF-8, or GAP outputting its help in ASCII, not UTF-8? E.g. I have

```
sage: type(gap.help('SymmetricGroup', pager=False))
<type 'unicode'>
```

and it prints OK, too.



---

archive/issue_comments_376207.json:
```json
{
    "body": "It is most likely a question of the system's locale.  This has happened before with other random patchbots that have things like `LC_CTYPE=C` and such.  It should instead set a UTF-8 locale.  GAP will not use unicode if it does not detect a unicode locale.\n\nI think the patchbot itself should either set LC_CTYPE, or perhaps even the Sage doctest runner.  While it can be interesting to catch locale-related failures, for the sake of builds it's probably best to ensure a consistent environment, and only manipulate locales for specific regression tests for known locale-related bugs.",
    "created_at": "2019-01-02T14:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376207",
    "user": "@embray"
}
```

It is most likely a question of the system's locale.  This has happened before with other random patchbots that have things like `LC_CTYPE=C` and such.  It should instead set a UTF-8 locale.  GAP will not use unicode if it does not detect a unicode locale.

I think the patchbot itself should either set LC_CTYPE, or perhaps even the Sage doctest runner.  While it can be interesting to catch locale-related failures, for the sake of builds it's probably best to ensure a consistent environment, and only manipulate locales for specific regression tests for known locale-related bugs.



---

archive/issue_comments_376208.json:
```json
{
    "body": "I don't think this is a blocker since it's a system environment issue on the affected patchbots.",
    "created_at": "2019-01-02T14:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376208",
    "user": "@embray"
}
```

I don't think this is a blocker since it's a system environment issue on the affected patchbots.



---

archive/issue_comments_376209.json:
```json
{
    "body": "Changing priority from blocker to minor.",
    "created_at": "2019-01-02T14:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376209",
    "user": "@embray"
}
```

Changing priority from blocker to minor.



---

archive/issue_comments_376210.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> I don't think this is a blocker since it's a system environment issue on the affected patchbots.\n\nSo you consider a patchbot environment broken if it doesn't support UTF-8? We generally try to support UTF-8 and non-UTF-8 locales in Sage doctests.\n\nAnd if you're really convinced that it's a patchbot problem, this bug should be closed as \"workforme\", not downgraded to \"minor\".",
    "created_at": "2019-01-02T14:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376210",
    "user": "@jdemeyer"
}
```

Replying to [comment:9 embray]:
> I don't think this is a blocker since it's a system environment issue on the affected patchbots.

So you consider a patchbot environment broken if it doesn't support UTF-8? We generally try to support UTF-8 and non-UTF-8 locales in Sage doctests.

And if you're really convinced that it's a patchbot problem, this bug should be closed as "workforme", not downgraded to "minor".



---

archive/issue_comments_376211.json:
```json
{
    "body": "Changing priority from minor to blocker.",
    "created_at": "2019-01-02T14:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376211",
    "user": "@jdemeyer"
}
```

Changing priority from minor to blocker.



---

archive/issue_comments_376212.json:
```json
{
    "body": "It's obviously not a blocker if it's just a trivial formatting issue in some test that can be fixed by setting the locale on your system.\n\nI do think *something* should be done about this though so closing it as \"worksforme\" would be equally reactionary.  Whether it's just adding `...` in those tests (fine by me), or as I suggested above fixing the locale either in the tests, the doctest runner, or the patchbot (I don't have an opinion about which would be most appropriate), or whether we should actually force a locale on GAP when initializing libgap.",
    "created_at": "2019-01-02T14:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376212",
    "user": "@embray"
}
```

It's obviously not a blocker if it's just a trivial formatting issue in some test that can be fixed by setting the locale on your system.

I do think *something* should be done about this though so closing it as "worksforme" would be equally reactionary.  Whether it's just adding `...` in those tests (fine by me), or as I suggested above fixing the locale either in the tests, the doctest runner, or the patchbot (I don't have an opinion about which would be most appropriate), or whether we should actually force a locale on GAP when initializing libgap.



---

archive/issue_comments_376213.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> whether we should actually force a locale on GAP when initializing libgap.\n\nTo clarify, in this case the test in question is only affected by the pexpect interface.  So the output from GAP in that case is going to depend on the environment passed when starting gap.",
    "created_at": "2019-01-02T14:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376213",
    "user": "@embray"
}
```

Replying to [comment:11 embray]:
> whether we should actually force a locale on GAP when initializing libgap.

To clarify, in this case the test in question is only affected by the pexpect interface.  So the output from GAP in that case is going to depend on the environment passed when starting gap.



---

archive/issue_comments_376214.json:
```json
{
    "body": "I think should suffice for now; leave other questions 'til later.\n----\nNew commits:",
    "created_at": "2019-01-02T14:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376214",
    "user": "@embray"
}
```

I think should suffice for now; leave other questions 'til later.
----
New commits:



---

archive/issue_comments_376215.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-02T14:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376215",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_376216.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-02T19:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376216",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_376217.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-03T09:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26750#issuecomment-376217",
    "user": "@vbraun"
}
```

Resolution: fixed
