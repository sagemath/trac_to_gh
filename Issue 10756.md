# Issue 10756: sage -sh doesn't work on OSX

Issue created by migration from https://trac.sagemath.org/ticket/10822

Original creator: jason

Original creation time: 2011-02-22 19:38:27

On OSX (10.6.6), when starting zsh, the /etc/zshenv file is always executed (even if the -f option is used to start zsh).  This file:


```
# system-wide environment settings for zsh(1)
if [ -x /usr/libexec/path_helper ]; then
	eval `/usr/libexec/path_helper -s`
fi
```


modifies the path to put things like /usr/bin, etc., in at the *start* of the path (even though the documentation for path_helper says that it *appends* things to the PATH variable).

So in the end, I get:


```
bash-3.2$ ~/sage/sage -sh
Detected SAGE64 flag
Building Sage on OS X in 64-bit mode

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

SAGE_ROOT=/Users/grout/sage
(sage subshell) tiny:~/sage/local/bin grout$ echo $PATH    
/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/git/bin:/usr/texbin:/usr/X11/bin:/Users/grout/sage/local/Frameworks/Python.framework/Versions/2.5/bin:/Users/grout/sage:/Users/grout/sage/local/bin:.
SAGE_ROOT=/Users/grout/sage
(sage subshell) tiny:~/sage/local/bin grout$ 


```


Notice that the Sage paths are at the end of the PATH variable.  This causes all sorts of problems when trying to do anything with sage -sh.


---

Comment by jhpalmieri created at 2011-02-22 21:05:52

First of all, I think path_helper might be working properly.  On my machine, the documentation says that it adds paths found in the files in /etc/paths.d/, which on my machine just adds `/usr/texbin` and `/usr/X11/bin`.  In particular, I think that /usr/bin, etc. are already at the start of the path before path_helper is run.

Second, I don't see this problem, but maybe I'm not doing things right.  My default shell is bash, but if I do

```
$ zsh
jpalmieri538% sage -sh

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

SAGE_ROOT=/Applications/sage
(sage subshell) jpalmieri538:~ palmieri$ echo $PATH
/Applications/sage/local/Frameworks/Python.framework/Versions/2.5/bin:/Applications/sage:/Applications/sage/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/texbin:/usr/X11/bin:/Users/palmieri/bin:/Applications/sage
SAGE_ROOT=/Applications/sage
```

(Also, are you sure that this has to do with zsh?  Your first line says `bash-3.2$`.)

To troubleshoot this, try applying this patch to sage-sage in SAGE_ROOT/local/bin:

```diff

diff -r e7a865848991 sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -476,6 +476,7 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
     SHELL_NAME=`basename $SHELL`
     echo "Bypassing shell configuration files ..."
     echo
+    echo "PATH is set to $PATH"
     # We must start a new shell with no .profile or .bashrc files
     # processed, so that we know our path is correct
     PS1="SAGE_ROOT=${SAGE_ROOT}\n(sage subshell) \h:\W \u\$ "
```

Then it will print the PATH before it even starts the new shell.


---

Comment by jason created at 2011-02-22 22:10:51

At first I thought it was peculiar to zsh, but then in my example above I tried it with bash, so it's not particular to zsh on my computer.

Can you try the following simple test?


```
bash-3.2$ PATH='.';export PATH
bash-3.2$ /usr/libexec/path_helper -s
PATH="/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/git/bin:/usr/texbin:/usr/X11/bin:."; export PATH;
```


Do you see "." at the end or the start of PATH in the output of path_helper?


---

Comment by jason created at 2011-02-22 22:14:40

Also, just to make sure, could you check the md5 of your path_helper binary?


```
$ md5 /usr/libexec/path_helper 
MD5 (/usr/libexec/path_helper) = 66b40636fd8adb430b0b8667135bcefe
```



---

Comment by jason created at 2011-02-22 22:19:20

Replying to [comment:2 jason]:
> At first I thought it was peculiar to zsh, but then in my example above I tried it with bash, so it's not particular to zsh on my computer.
> 
> Can you try the following simple test?
> 
> {{{
> bash-3.2$ PATH='.';export PATH
> bash-3.2$ /usr/libexec/path_helper -s
> PATH="/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/git/bin:/usr/texbin:/usr/X11/bin:."; export PATH;
> }}}
> 
> Do you see "." at the end or the start of PATH in the output of path_helper?

I just tried the simple test above with the guest account on my computer and I got the same results---path_helper prepended its paths instead of appending them.


---

Comment by jhpalmieri created at 2011-02-22 22:21:53

I get the same as you in both cases.  Now I see I didn't read all of the path_helper documentation: in addition to adding paths from /etc/paths.d/, it also says

```
Prior to reading these directories, default PATH and MANPATH values are obtained from the files
/etc/paths and /etc/manpaths respectively.
```

Note that there are no promises about appending anything.

However, I still don't have the problem you're having with "sage -sh".  Indeed, I would guess that your PATH is set incorrectly whenever you run Sage, and then I'm surprised that anything works right.  What happens if you do this in Sage:

```
sage: import os
sage: os.environ.get('PATH')
```

Are the Sage directories at the beginning or end?


---

Comment by jason created at 2011-02-22 22:23:09

John, when I apply your patch, I get:


```
% sage -sh
Detected SAGE64 flag
Building Sage on OS X in 64-bit mode

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

PATH is set to /Users/grout/sage/local/Frameworks/Python.framework/Versions/2.5/bin:/Users/grout/sage:/Users/grout/sage/local/bin:/Users/grout/sage:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/git/bin:/usr/texbin:/usr/X11/bin:/opt/local/bin:/Users/grout/bin:/opt/local/bin
```


So the path is set correctly before starting up the shell (well, except that I don't know what's going on with the 2.5 version framework, but regardless, sage is at the start of the path).

Jason


---

Comment by jason created at 2011-02-22 22:24:59

From within Sage:


```
sage: os.environ.get('PATH')
'/Users/grout/sage/local/Frameworks/Python.framework/Versions/2.5/bin:/Users/grout/sage:/Users/grout/sage/local/bin:/Users/grout/sage:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/git/bin:/usr/texbin:/usr/X11/bin:/opt/local/bin:/Users/grout/bin:/opt/local/bin'
```


So it's set correctly in there.  I'm positive it's also set correctly when I'm installing spkgs.


---

Comment by jason created at 2011-02-22 22:30:39

Okay, so if I use chsh to change my shell to bash, then sage -sh has the right $PATH.  John, if you change your shell to zsh using chsh, do you have the right $PATH?

Thanks, Jason


---

Comment by jhpalmieri created at 2011-02-23 02:16:34

Replying to [comment:8 jason]:
> Okay, so if I use chsh to change my shell to bash, then sage -sh has the right $PATH.  John, if you change your shell to zsh using chsh, do you have the right $PATH?

No, the Sage stuff comes at the end.  Also, the prompt is bad:

```
Macintosh% /Applications/sage/sage -sh

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

SAGE_ROOT=/Applications/sage\n(sage subshell) \h:\W \u$ echo $PATH
/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/texbin:/usr/X11/bin:/Applications/sage/local/Frameworks/Python.framework/Versions/2.5/bin:/Applications/sage:/Applications/sage/local/bin
```



---

Comment by jhpalmieri created at 2011-02-23 03:42:36

I have one idea how to fix this, but it doesn't seem ideal: first, change the SHELL_OPTS for zsh to " -d".  Then create a .zshrc file, say in SAGE_ROOT/local/bin, containing 

```
export PATH=$SAGE_ROOT:$SAGE_LOCAL/bin:$PATH
```

and then tell zsh to read this file when starting up.  The following patch to sage-sage does it, and also fixes the prompt:

```diff
diff -r e7a865848991 sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -478,16 +478,19 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
     echo
     # We must start a new shell with no .profile or .bashrc files
     # processed, so that we know our path is correct
-    PS1="SAGE_ROOT=${SAGE_ROOT}\n(sage subshell) \h:\W \u\$ "
-    export PS1
     case $SHELL_NAME in
         bash)
+	    PS1="SAGE_ROOT=${SAGE_ROOT}\n(sage subshell) \h:\W \u\$ "
+	    export PS1
             SHELL_OPTS=" --norc"
             ;;
         csh)
             SHELL_OPTS=" -f"
             ;;
         ksh)
+	    PS1="""SAGE_ROOT=${SAGE_ROOT}
+(sage subshell) `hostname -s`:\${PWD##*/} $USER$ """
+	    export PS1
             SHELL_OPTS=" -p"
             ;;
         sh)
@@ -497,7 +500,12 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
             SHELL_OPTS=" -f"
             ;;
         zsh)
-            SHELL_OPTS=" -f -d"
+	    PS1="""SAGE_ROOT=${SAGE_ROOT}
+(sage subshell) %m:%1~ %n$ """
+	    export PS1
+	    ZDOTDIR=${SAGE_ROOT}/local/bin/
+	    export ZDOTDIR
+            SHELL_OPTS=" -d"
             ;;
         *)
             echo >&2 "Unknown shell: $SHELL!"
```

I think that setting the prompt for csh and tcsh might require a similar trick, since their prompt doesn't seem to be governed by an environment variable the same way.


---

Comment by jhpalmieri created at 2011-02-23 19:39:19

(We could also generate the file `.zshrc` on the fly and store it in some temporary directory.)


---

Comment by jhpalmieri created at 2011-03-25 22:05:03

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-03-25 22:05:03

Here's a patch implementing the idea above.  I can't figure out a safe way to deal with csh and tcsh: the only idea I have is to temporarily overwrite the user's .cshrc or .tcshrc file, and this seems risky.  So with this patch, the prompts for those shells are not set correctly.


---

Comment by jhpalmieri created at 2011-03-25 22:08:38

It would be good to test this on different platforms.  I can test it on my mac, but I don't know if I have access to another system which has zsh installed and on which I can run "chsh" successfully.


---

Comment by jhpalmieri created at 2011-09-28 21:07:34

Rebased to #11866 and #11790.


---

Attachment

scripts repo


---

Comment by malb created at 2011-09-28 21:37:06

Not an expert on zsh but the patch works for me on Debian GNU/Linux using zsh. 

On my machine `mktemp -t sage` wouldn't work though:


```
$ mktemp -t sage
mktemp: too few X's in template `sage'
$ mktemp -t sageXXX
/tmp/sage5WO
```



---

Comment by ppurka created at 2011-09-29 15:48:18

What does the -d option do for zsh? I can't find anything [at the manual](http://zsh.sourceforge.net/Doc/Release/Options.html#Single-Letter-Options) which suggests that that option is available.

Secondly, I believe one of the reasons for creating a new .zshrc is to avoid sourcing user settings (as I read it in sage-sage). In this case, one should invoke zsh as `zsh -o noglobalrcs` see [Files](http://zsh.sourceforge.net/Doc/Release/Files.html#Files).

A cleaner way to implement the ZDOTDIR would be to then *remove* /tmp/.zshrc if it is present and echo a newer one. In fact, one could even use the RPROMPT of zsh to get a cleaner prompt. It is less annoying that a massive prompt that is obtained otherwise. :)

Here's a diff of what changes I did to sage-sage.

```diff
# HG changeset patch
# User P Purkayastha <ppurka@gmail.com>
# Date 1317310855 -28800
# Node ID 469d05f30083d92990be2a0af692062d9b51c7be
# Parent  f8f1496d316ce8556a8d7350de61e0f755c23681
[mq]: trac_10822_fix_zsh_shell.patch

diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -497,7 +497,23 @@
             SHELL_OPTS=" -f"
             ;;
         zsh)
-            SHELL_OPTS=" -f -d"
+            FILE="/tmp/.zshrc"
+            if [ -e "$FILE" ]; then
+                if ! rm -f "$FILE"; then
+                    echo "No permission to delete and create new file $FILE"
+                    exit 1
+                fi
+            fi
+            cat > "$FILE" << EOF
+PATH="$SAGE_ROOT:$SAGE_LOCAL/bin:$PATH"
+export PATH
+PS1="%m:%~ %n$ "
+export PS1
+RPROMPT=" #SAGE_ROOT=${SAGE_ROOT} (sage subshell)"
+export RPROMPT
+EOF
+            export ZDOTDIR="/tmp"
+            SHELL_OPTS="-o noglobalrcs"
             ;;
         *)
             echo >&2 "Unknown shell: $SHELL!"
```



---

Comment by ppurka created at 2011-09-29 15:55:06

Sorry, I got my exports all backwards.

```diff
# HG changeset patch
# User P Purkayastha <ppurka@gmail.com>
# Date 1317311589 -28800
# Node ID 09875d34e10e03692a831a8b5cb9f65693c6a7b3
# Parent  f8f1496d316ce8556a8d7350de61e0f755c23681
[mq]: trac_10822_fix_zsh_shell.patch

diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -497,7 +497,20 @@
             SHELL_OPTS=" -f"
             ;;
         zsh)
-            SHELL_OPTS=" -f -d"
+            FILE="/tmp/.zshrc"
+            if [ -e "$FILE" ]; then
+                if ! rm -f "$FILE"; then
+                    echo "No permission to delete and create new file $FILE"
+                    exit 1
+                fi
+            fi
+            cat > "$FILE" << EOF
+export PATH="$SAGE_ROOT:$SAGE_LOCAL/bin:$PATH"
+export PS1="%m:%~ %n$ "
+export RPROMPT=" #SAGE_ROOT=${SAGE_ROOT} (sage subshell)"
+EOF
+            ZDOTDIR="/tmp" && export ZDOTDIR
+            SHELL_OPTS="-o noglobalrcs"
             ;;
         *)
             echo >&2 "Unknown shell: $SHELL!"
```



---

Comment by jhpalmieri created at 2011-09-29 17:12:08

Replying to [comment:17 ppurka]:
> What does the -d option do for zsh? I can't find anything [at the manual](http://zsh.sourceforge.net/Doc/Release/Options.html#Single-Letter-Options) which suggests that that option is available.

In section 16.2.5 of [http://zsh.sourceforge.net/Doc/Release/Options.html#Options](http://zsh.sourceforge.net/Doc/Release/Options.html#Options), it says

```
GLOBAL_RCS (-d) <D>
If this option is unset, the startup files /etc/zprofile, /etc/zshrc, /etc/zlogin and /etc/zlogout will not be run. It can be disabled and re-enabled at any time, including inside local startup files (.zshrc, etc.).
```


I'll take a look at the rest of your changes later (as will other people, I hope).


---

Comment by ppurka created at 2011-09-29 17:16:22

Replying to [comment:19 jhpalmieri]:
> Replying to [comment:17 ppurka]:
> > What does the -d option do for zsh? I can't find anything [at the manual](http://zsh.sourceforge.net/Doc/Release/Options.html#Single-Letter-Options) which suggests that that option is available.
> 
> In section 16.2.5 of [http://zsh.sourceforge.net/Doc/Release/Options.html#Options](http://zsh.sourceforge.net/Doc/Release/Options.html#Options), it says
> {{{
> GLOBAL_RCS (-d) <D>
> If this option is unset, the startup files /etc/zprofile, /etc/zshrc, /etc/zlogin and /etc/zlogout will not be run. It can be disabled and re-enabled at any time, including inside local startup files (.zshrc, etc.).
> }}}
> 
> I'll take a look at the rest of your changes later (as will other people, I hope).

Thanks. It is the same as `-o noglobalopts` then.


---

Comment by jdemeyer created at 2012-04-02 10:16:55

This obviously needs to be rebased...


---

Comment by jdemeyer created at 2012-04-02 10:16:55

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-04-02 10:18:40

Moreover: it's better not to use `mktemp -p` or `mktemp -t`: use `mktemp TEMPLATE` which seems to be portable.


---

Comment by jason created at 2012-04-05 10:50:19

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-04-05 10:50:19

I've uploaded my take on what should be done.  Apply patch to root repository.


---

Comment by jdemeyer created at 2012-04-05 14:00:51

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-04-05 14:00:51

This still needs to be rebased to a recent beta.


---

Comment by jason created at 2012-04-05 14:10:00

I had it based on beta6.  I'm downloading beta12 now.


---

Comment by jason created at 2012-04-06 01:21:23

apply instead of previous patch


---

Attachment

I rebased the patch to beta12


---

Comment by jason created at 2012-04-06 01:22:48

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-04-06 08:43:30

The patch looks okay on visual inspection, but I cannot give positive_review because I don't have zsh to test this.


---

Comment by ppurka created at 2012-04-06 09:10:11

I run zsh as my shell. But I don't have a Mac to test it on. So, I can't give a proper review either.


---

Comment by ppurka created at 2012-05-26 15:10:41

This change is quite small and looks good. Just needs someone with a mac to test.


---

Comment by ppurka created at 2012-05-26 15:10:41

Changing keywords from "" to "sd40.5".


---

Comment by was created at 2012-05-27 18:23:36

1. Trivial nitpick: it says "`create a temporary .zshenv to reset the path`" but shouldn't it say "`create .zshenv to reset the path.`", since the file is in fact _not_ temporary.

2. After reading the above I still don't get the point of this patch.  Before applying it, on OS X 10.7 I get:

```
$ zsh
...
$ sage -sh
$ echo $PATH
(sage-sh) wstein@blastoff:sage-5.0.beta15$ echo $PATH
/Users/wstein/sage/build/sage-5.0.beta15/local/Frameworks/Python.framework/Versions/2.5/bin:/Users/wstein/sage/build/sage-5.0.beta15/spkg/bin:/Users/wstein/sage/build/sage-5.0.beta15/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/X11/bin:/usr/texbin:/Users/wstein/sage/build/sage-5.0.beta15:/Users/wstein/bin:/Users/wstein/local/bin
```

which looks fine to me.


---

Comment by jhpalmieri created at 2012-05-27 23:37:47

Regarding point 2, try instead to use `chsh` to switch your shell to `/bin/zsh`, open up a new terminal window (now running zsh) and try

```
$ sage -sh
$ echo $PATH
```

again. When I do this, I get things like /usr/bin at the front of the path.


---

Comment by jason created at 2012-05-28 13:22:19

In sage -sh, it has this code to pick the shell run:


```

    # If $SHELL is unset, default to bash
    if [ -z "$SHELL" ]; then
        export SHELL=bash
    fi
```


Is your $SHELL variable set to zsh?


---

Comment by iandrus created at 2012-05-29 15:26:25

I can confirm on a Mac with Sage 5.0 (having run `chsh -s /bin/zsh`) that without the patch my PATH starts with `/usr/bin:/bin:/usr/sbin:/sbin:...`, but after applying the patch it starts with `/Users/gvol/SageStuff/sage-5.0.rc0/local/Frameworks/Python.framework/Versions/2.5/bin:/Users/gvol/SageStuff/sage-5.0.rc0/spkg/bin:/Users/gvol/SageStuff/sage-5.0.rc0/local/bin:`.  

I give it a positive review based on my reading of the comments here that testing on a Mac was all that was required.  Looking at the patch I don't see any problems, but then, I don't use zsh either.


---

Comment by iandrus created at 2012-05-29 15:26:25

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-02 13:42:12

Resolution: fixed
