# Issue 10158: matplotlib: avoid race condition when creating config directory

archive/issues_010158.json:
```json
{
    "body": "Assignee: tbd\n\nKeywords: matplotlib\n\nThis is a followup to #6235.  You can find a new spkg at \n\n[http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg)\n\nand I've attached the mercurial patch from the old version to the new, for reference.  There are two changes: record in the SPKG.txt file the change from #6235 about MPLCONFIGDIR, so that in future upgrades, we don't screw up how that variable is set.  Also, patch texmanager.py so that it creates the config dir in a way less likely to cause problems.  (See #8677 for a similar situation; the solution was taken from there.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/10159\n\n",
    "created_at": "2010-10-23T18:33:09Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "matplotlib: avoid race condition when creating config directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10158",
    "user": "jhpalmieri"
}
```
Assignee: tbd

Keywords: matplotlib

This is a followup to #6235.  You can find a new spkg at 

[http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg)

and I've attached the mercurial patch from the old version to the new, for reference.  There are two changes: record in the SPKG.txt file the change from #6235 about MPLCONFIGDIR, so that in future upgrades, we don't screw up how that variable is set.  Also, patch texmanager.py so that it creates the config dir in a way less likely to cause problems.  (See #8677 for a similar situation; the solution was taken from there.)

Issue created by migration from https://trac.sagemath.org/ticket/10159





---

archive/issue_comments_102857.json:
```json
{
    "body": "A note about the patch: it is a little large because I had to add the file patches/texmanager.py to the repository.  Also, in addition to the important changes, it also changes various parts of SPKG.txt so that the lines are shorter than 80 characters.",
    "created_at": "2010-10-23T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102857",
    "user": "jhpalmieri"
}
```

A note about the patch: it is a little large because I had to add the file patches/texmanager.py to the repository.  Also, in addition to the important changes, it also changes various parts of SPKG.txt so that the lines are shorter than 80 characters.



---

archive/issue_comments_102858.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-10-23T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102858",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_102859.json:
```json
{
    "body": "I just reported this upstream.  If I get any feedback, I'll report it here.",
    "created_at": "2010-10-23T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102859",
    "user": "jhpalmieri"
}
```

I just reported this upstream.  If I get any feedback, I'll report it here.



---

archive/issue_comments_102860.json:
```json
{
    "body": "Apart from the typo in the commit message, and I'm not sure if I like `assert` there, I'm ok with the patch, and the spkg is clean.\n\nWorks for me as advertised, so positive review.\n\n(Tested on Ubuntu 10.04 x86_64, Core2 Quad. I also deleted the MPL config dir and then ran\n\n```sh\n$ ./sage -tp N -long devel/sage/sage/plot/ # N={32,64} (though only 49 files)\n```\n\nEach time all doctests passed. Perhaps others should stress-[doc]test it on other platforms like MacOS X, too.)",
    "created_at": "2010-10-23T21:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102860",
    "user": "leif"
}
```

Apart from the typo in the commit message, and I'm not sure if I like `assert` there, I'm ok with the patch, and the spkg is clean.

Works for me as advertised, so positive review.

(Tested on Ubuntu 10.04 x86_64, Core2 Quad. I also deleted the MPL config dir and then ran

```sh
$ ./sage -tp N -long devel/sage/sage/plot/ # N={32,64} (though only 49 files)
```

Each time all doctests passed. Perhaps others should stress-[doc]test it on other platforms like MacOS X, too.)



---

archive/issue_comments_102861.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-23T21:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102861",
    "user": "leif"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_102862.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> Apart from the typo in the commit message\n\nIf you mean the spurious apostrophe, I've removed it.\n\n> , and I'm not sure if I like `assert` \n\nI just took that from #8677. \n\n> Works for me as advertised, so positive review.\n\nGreat, thanks!",
    "created_at": "2010-10-23T21:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102862",
    "user": "jhpalmieri"
}
```

Replying to [comment:3 leif]:
> Apart from the typo in the commit message

If you mean the spurious apostrophe, I've removed it.

> , and I'm not sure if I like `assert` 

I just took that from #8677. 

> Works for me as advertised, so positive review.

Great, thanks!



---

archive/issue_comments_102863.json:
```json
{
    "body": "Oh, I just noticed the patch does *not* (exactly) what the ticket advertises... \n(In fact, the patch addresses the race condition in the creation of the TeX cache.)\n\nThere are still some other instances of `if not os.path.exists(foo): mkdir(foo)` and similar, so it's a bit surprising I did not run into any race condition.\n\nJohn, are you willing to fix these, too?\n\nUnless you meanwhile have Sun's grep installed, you can find them by e.g.\n\n```sh\n$ grep -B5 -A2  mkdir `find src -name \\*.py`\n```\n\n(Giving about two false positives; also not all are equally important I think.)",
    "created_at": "2010-10-23T21:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102863",
    "user": "leif"
}
```

Oh, I just noticed the patch does *not* (exactly) what the ticket advertises... 
(In fact, the patch addresses the race condition in the creation of the TeX cache.)

There are still some other instances of `if not os.path.exists(foo): mkdir(foo)` and similar, so it's a bit surprising I did not run into any race condition.

John, are you willing to fix these, too?

Unless you meanwhile have Sun's grep installed, you can find them by e.g.

```sh
$ grep -B5 -A2  mkdir `find src -name \*.py`
```

(Giving about two false positives; also not all are equally important I think.)



---

archive/issue_comments_102864.json:
```json
{
    "body": "I tried the same multiple times with `DOT_SAGE` set to some NFS-mounted filesystem, made that busy by another machine, but still don't get any errors...",
    "created_at": "2010-10-23T22:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102864",
    "user": "leif"
}
```

I tried the same multiple times with `DOT_SAGE` set to some NFS-mounted filesystem, made that busy by another machine, but still don't get any errors...



---

archive/issue_comments_102865.json:
```json
{
    "body": "Okay, I've fixed some more of these.  I think that only the files in src/lib/matplotlib get installed, so I haven't bothered with the other ones.  I also ignored the function \"mkdirs\" in cbook.py.  This is only used in sphinxext/plot_directive.py, so I don't think it should affect us.  Also, the function could perhaps just be replaced with a call to [os.makedirs](http://docs.python.org/library/os.html#os.makedirs), which is already recursive and allows you to set the mode.  Maybe the matplotlib people are worried about the presence of \"..\" in the pathname?  Anyway, I don't have a good way to test any changes to that part of the code, so I'm going to leave it alone.",
    "created_at": "2010-10-23T22:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102865",
    "user": "jhpalmieri"
}
```

Okay, I've fixed some more of these.  I think that only the files in src/lib/matplotlib get installed, so I haven't bothered with the other ones.  I also ignored the function "mkdirs" in cbook.py.  This is only used in sphinxext/plot_directive.py, so I don't think it should affect us.  Also, the function could perhaps just be replaced with a call to [os.makedirs](http://docs.python.org/library/os.html#os.makedirs), which is already recursive and allows you to set the mode.  Maybe the matplotlib people are worried about the presence of ".." in the pathname?  Anyway, I don't have a good way to test any changes to that part of the code, so I'm going to leave it alone.



---

archive/issue_comments_102866.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2010-10-23T22:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102866",
    "user": "jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_102867.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-10-23T22:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102867",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_102868.json:
```json
{
    "body": "Mercurial patch for matplotlib spkg; for reference only",
    "created_at": "2010-10-23T22:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102868",
    "user": "jhpalmieri"
}
```

Mercurial patch for matplotlib spkg; for reference only



---

archive/issue_comments_102869.json:
```json
{
    "body": "Changing keywords from \"matplotlib\" to \"matplotlib MPLCONFIGDIR tex.cache condition errno 17\".",
    "created_at": "2010-10-23T23:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102869",
    "user": "leif"
}
```

Changing keywords from "matplotlib" to "matplotlib MPLCONFIGDIR tex.cache condition errno 17".



---

archive/issue_comments_102870.json:
```json
{
    "body": "Attachment\n\nOk.\n\nAlso, `raise` is more adequate there, since one cannot assert the only possible `OSError` is `EEXIST`, so it's less confusing now.\n\n(I still can't force errors.)",
    "created_at": "2010-10-23T23:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102870",
    "user": "leif"
}
```

Attachment

Ok.

Also, `raise` is more adequate there, since one cannot assert the only possible `OSError` is `EEXIST`, so it's less confusing now.

(I still can't force errors.)



---

archive/issue_comments_102871.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-23T23:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102871",
    "user": "leif"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_102872.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-01T10:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10158",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10158#issuecomment-102872",
    "user": "jdemeyer"
}
```

Resolution: fixed
