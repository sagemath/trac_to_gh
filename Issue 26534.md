# Issue 26534: Implement generalized cluster algebras

Issue created by migration from https://trac.sagemath.org/ticket/26771

Original creator: @kelleye

Original creation time: 2018-11-26 18:23:58

CC:  tscrim gmoose05 stumpc5 etn40ff @ebanaian drupel

Keywords: cluster algebra, generalized cluster algebra,

This ticket is being opened to describe proposed work for an coding sprint at the IMA.

In 2011, [Chekhov and Shapiro](https://arxiv.org/abs/1111.3963) introduced a generalization of cluster algebras in which the exchange polynomials are allowed to have arbitrarily many terms.

We want to create a new class, GeneralizedClusterSeed, and related methods necessary to implement these algebras in Sage. We plan to build on the framework established by Rupel and Stella's [implementation](http://doc.sagemath.org/html/en/reference/algebras/sage/algebras/cluster_algebra.html) of cluster algebras.

Our major functionality objectives are:
* creating a class for generalized cluster seeds, with analogous attributes to ClusterSeed
* implementing generalized mutation for arbitrary coefficients
* creating methods for calculating left and right companion algebras
* creating a method for unfolding cluster algebras

For more information, see:

[https://arxiv.org/abs/1111.3963](https://arxiv.org/abs/1111.3963)

[https://arxiv.org/abs/1504.06758](https://arxiv.org/abs/1504.06758)

[https://arxiv.org/pdf/1006.4276.pdf](https://arxiv.org/pdf/1006.4276.pdf)


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Attachment

First step in adding exchange degrees.


---

Comment by @kelleye created at 2019-07-10 15:25:59

Current beta version of the generalized cluster algebra code.


---

Comment by gmoose05 created at 2019-07-10 15:29:21

Old attachment can now be ignored.
----
Last 10 new commits:


---

Comment by git created at 2019-07-10 16:09:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-10 16:11:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gmoose05 created at 2019-07-10 16:13:11

Code rebased for 8.9-beta_2 - still in testing and debugging phase


---

Comment by git created at 2019-07-10 22:25:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 03:01:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 14:40:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kelleye created at 2019-07-11 15:25:02

Added some doctests.


---

Comment by git created at 2019-07-11 16:08:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 16:27:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 16:53:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 21:52:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 22:10:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 22:26:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 22:33:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-07-13 08:08:01

* you should rather work with a `public/your_favorite_branch_name` branch, instead of switching all the time

* reference [NR2016] is not defined anywhere
----
Last 10 new commits:


---

Comment by gmoose05 created at 2019-07-22 15:21:50

Changing keywords from "cluster algebra, generalized cluster algebra," to "ima-coding-sprints, sd99, cluster algebra, generalized cluster algebra,".


---

Comment by gmoose05 created at 2019-07-22 15:21:50

New commits:


---

Comment by gmoose05 created at 2019-07-22 15:26:25

Changing keywords from "ima-coding-sprints, sd99, cluster algebra, generalized cluster algebra," to "IMA coding sprints, days99, cluster algebra, generalized cluster algebra,".


---

Comment by gmoose05 created at 2019-07-23 16:24:33

Replying to [comment:44 chapoton]:
> * you should rather work with a `public/your_favorite_branch_name` branch, instead of switching all the time
> ----
We are using the automated behavior of the git trac command.  Does this command needed to be updated to make the default use "public" as opposed to "user_names", especially when multiple developers are collaborating?


---

Comment by chapoton created at 2019-07-23 20:17:37

Well, then forget about git trac and learn to use git. Much better to use git directly imho.


---

Comment by git created at 2019-07-25 02:21:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-25 14:59:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-26 17:13:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-26 18:19:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kelleye created at 2019-07-26 19:43:15

Merged changes from ticket 28176.


---

Comment by @kelleye created at 2019-07-30 18:23:53

Merged with Sage version 8.9 beta4


---

Comment by git created at 2019-07-30 19:23:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-31 16:38:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-08-01 08:46:22

doc still does not build, see comment:44


---

Comment by git created at 2019-08-01 16:42:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gmoose05 created at 2019-08-01 17:06:16

Changing status from new to needs_review.


---

Comment by embray created at 2019-08-02 09:39:31

Replying to [comment:48 gmoose05]:
> Replying to [comment:44 chapoton]:
> > * you should rather work with a `public/your_favorite_branch_name` branch, instead of switching all the time
> > ----
> We are using the automated behavior of the git trac command.  Does this command needed to be updated to make the default use "public" as opposed to "user_names", especially when multiple developers are collaborating?

The default behavior generally assumes one person pushing to a private branch.  The solution here is to stop using the default bahavior.

Instead, please run something like:


```
git trac push --branch public/ticket-26771 26771
```


This will set the branch name for the ticket to `public/ticket-26771` and subsequent pushes will continue to use that upstream branch, rather than constantly switching it between your private branches.  

Locally your branch is still yours to work in.  It's just when you push/pull that you will have to resolve conflicts, etc.
----
New commits:


---

Comment by gmoose05 created at 2019-08-02 13:18:56

I wasn't aware of that option with git trac push, that's what I was missing.  I will use this in the future and if we need further edits for this ticket.  Thanks!


---

Comment by etn40ff created at 2019-08-02 14:40:57

Dear All,

I would like to be the one giving the final green light to this ticket: it changes quite a lot of the implementation of `ClusterAlgebra` so I would prefer to make sure that things still works as expected.
As you know, I am quite busy with my personal life at the moment so please allow me some extra time to process this.


---

Comment by chapoton created at 2019-08-27 15:45:56

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-08-27 15:45:56

red branch, signaling a conflict with the latest beta release


---

Comment by chapoton created at 2019-08-31 08:28:14

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-08-31 08:28:14

so back to needs review, I guess ?
----
New commits:


---

Comment by chapoton created at 2019-09-13 07:53:48

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-09-13 07:53:48

red branch again


---

Comment by git created at 2019-09-13 13:35:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-09-16 07:30:40

so back to needs review again, I guess ?


---

Comment by chapoton created at 2019-09-16 07:30:40

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-04-11 10:19:39

This has started to bit-rot seriously. If nobody takes care of the review, this will be lost work.


---

Comment by etn40ff created at 2020-04-11 10:31:21

My fault entirely, I got too swamped with other things. Sorry
I hope to get to this soon.


---

Comment by etn40ff created at 2020-04-11 23:51:00

First of all please accept my apologies for taking so long before reviewing this.

I think that the code in this ticket is far from being ready for a positive
review for several reasons.

First of all there is still some debugging scaffolding left over, e.g. at lines
just after 1275. This, and any other such, should be removed.

Talking of these lines, is `//` really not working? If so this could explain the major
issue I will point out later on.

Second the code introduces a lot of unnecessary small changes like spaces and
newlines that make the patch much bigger than it needs to be. Unnecessary white
spaces at the end of lines should be avoided. It looks to me that the code here
was based on #28176 before it was finalized and therefore it redoes/undoes many of
the changes already implemented there. Please remove all of those; ideally this
thicket should be rebased on the current develop. I tried doing so but it is not
working automagically so someone (else) familiar with the changes should do it. 

Similarly the code should be better formatted avoiding long lines and using the
correct spacing.

On a more substantial note, the use of both `d` and `Z` is redundant. I
understand that one wants to allow `d` as an input but there is no need to carry
over both of them in the implementation.

Why are you keeping around two copies of the greedy_element framework?

The major obstacle to giving a positive review to this code is the big slowdown
it introduces. For example here is the old version in action on my laptop


```
  sage: A = ClusterAlgebra(['E',8],foo=random())
  ....: S = A.seeds(mutating_F = False)
  ....: %time _ = list(S)
  CPU times: user 21.4 s, sys: 209 ms, total: 21.6 s
  Wall time: 21.6 s
  sage: A = ClusterAlgebra(['E',8],foo=random())
  ....: %time A.explore_to_depth(infinity)
  CPU times: user 23.9 s, sys: 191 ms, total: 24.1 s
  Wall time: 24.1 s
```


and here is the new one:


```
  sage: A = ClusterAlgebra(['E',8],foo=random())
  ....: S = A.seeds(mutating_F = False)
  ....: %time _ = list(S)
  CPU times: user 1min 35s, sys: 1.69 s, total: 1min 37s
  Wall time: 1min 37s
```


exploring the exchange graph while computing cluster variables with the new code
does not terminate in any reasonable amount of time (I killed it after 30
minutes).

I see three possible reasons for this slowdown: 

- the algorithms are inherently slower for generalized cluster algebras

- working over symbolic rings is slow

- you are using `/` rather than `//`

I doubt the reason is the third one since the slowdown appear also when not
mutating F_polynomials. The code computing mutations of seeds uses just basic
linear algebra and a 400% slowdown in it indicates some major issue.

If the reasons are the first two I would strongly advice to retool this
implementation according to this scheme: 

- write a base class in which all the common code is located

- add two more classes ClusterAlgebra and GeneralizedClusterAlgebra that inherit
  from the base class

In doing so please make sure that no significant slowdown is introduced in the
current code.


---

Comment by etn40ff created at 2020-04-11 23:51:00

Changing status from needs_review to needs_work.


---

Comment by @drupel created at 2020-04-12 03:41:12

Thanks Salvatore for the detailed report!  

There is quite some work to do to try to speed up the divisions because of the symbolic expressions and the exponential growth in terms due to the higher degree exchange polynomials.  I am sure that digging into the implementation of polynomial division and carefully sorting terms would eliminate some issues coming from the explosion of terms.  More precisely, taking the cluster variables as degree 0 and the exchange coefficients as degree 1 to organize the division should give quite a speed up, but the effort may not be worth the time expense to implement this.  Probably retooling as you say at the end is the way to go.
