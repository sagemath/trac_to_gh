# Issue 16782: preparser for .sage files no longer respects module docstrings

archive/issues_016782.json:
```json
{
    "body": "Keywords: docstring, preparse\n\nRunning ./sage --preparse on a .sage produces a .py file such that this is a proper Python file. If the .sage file contains a module docstring, then this should be present as the module docstring of the resulting .py file. This means that no code-lines (non-comment, non-blank) may be added before this module docstring.\n\nThere are some lines to handle this in sage-preparse. However, it is not handled properly, as a call to sage.misc.preparse.preparse_file earlier on might already then add some lines before the original docstring.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17019\n\n",
    "created_at": "2014-09-20T19:16:12Z",
    "labels": [
        "misc",
        "minor",
        "bug"
    ],
    "title": "preparser for .sage files no longer respects module docstrings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16782",
    "user": "jsrn"
}
```
Keywords: docstring, preparse

Running ./sage --preparse on a .sage produces a .py file such that this is a proper Python file. If the .sage file contains a module docstring, then this should be present as the module docstring of the resulting .py file. This means that no code-lines (non-comment, non-blank) may be added before this module docstring.

There are some lines to handle this in sage-preparse. However, it is not handled properly, as a call to sage.misc.preparse.preparse_file earlier on might already then add some lines before the original docstring.

Issue created by migration from https://trac.sagemath.org/ticket/17019





---

archive/issue_comments_221945.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-20T19:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221945",
    "user": "jsrn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_221946.json:
```json
{
    "body": "Since the patch is on a python file outside the usual Sage tree, I am not aware of doc-test rules etc. I wouldn't even know how to make a doctest for this (and there are no other doctests in sage-preparse).\n----\nNew commits:",
    "created_at": "2014-09-20T19:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221946",
    "user": "jsrn"
}
```

Since the patch is on a python file outside the usual Sage tree, I am not aware of doc-test rules etc. I wouldn't even know how to make a doctest for this (and there are no other doctests in sage-preparse).
----
New commits:



---

archive/issue_comments_221947.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-21T20:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221947",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_221948.json:
```json
{
    "body": "Replying to [comment:2 jsrn]:\n> Since the patch is on a python file outside the usual Sage tree, I am not aware of doc-test rules etc. I wouldn't even know how to make a doctest for this (and there are no other doctests in sage-preparse).\nThere are doctest (even for `sage-preparse`) in `src/sage/tests/cmdline.py` and I think you should add a doctest for this (needs_work because of this).",
    "created_at": "2014-09-21T20:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221948",
    "user": "jdemeyer"
}
```

Replying to [comment:2 jsrn]:
> Since the patch is on a python file outside the usual Sage tree, I am not aware of doc-test rules etc. I wouldn't even know how to make a doctest for this (and there are no other doctests in sage-preparse).
There are doctest (even for `sage-preparse`) in `src/sage/tests/cmdline.py` and I think you should add a doctest for this (needs_work because of this).



---

archive/issue_comments_221949.json:
```json
{
    "body": "Also, you don't need an additional\n\n```\nfrom sage.misc.preparser import preparse_file\n```\n",
    "created_at": "2014-09-21T20:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221949",
    "user": "jdemeyer"
}
```

Also, you don't need an additional

```
from sage.misc.preparser import preparse_file
```




---

archive/issue_comments_221950.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-22T09:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221950",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_221951.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-22T09:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221951",
    "user": "jsrn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_221952.json:
```json
{
    "body": "Ok, I've added a doctest for this.",
    "created_at": "2014-09-22T09:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221952",
    "user": "jsrn"
}
```

Ok, I've added a doctest for this.



---

archive/issue_comments_221953.json:
```json
{
    "body": "The Build-bot's doctests failing is in some numerical stability tests, and seem to have nothing to do with this patch.",
    "created_at": "2014-09-23T08:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221953",
    "user": "jsrn"
}
```

The Build-bot's doctests failing is in some numerical stability tests, and seem to have nothing to do with this patch.



---

archive/issue_comments_221954.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-25T11:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221954",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_221955.json:
```json
{
    "body": "Sorry to bother again, but you should rebase this over #16955.",
    "created_at": "2014-09-25T11:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221955",
    "user": "jdemeyer"
}
```

Sorry to bother again, but you should rebase this over #16955.



---

archive/issue_comments_221956.json:
```json
{
    "body": "...and instead of adding a completely new doctest, why not simply change the old test for `sage --preparse`?",
    "created_at": "2014-09-25T11:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221956",
    "user": "jdemeyer"
}
```

...and instead of adding a completely new doctest, why not simply change the old test for `sage --preparse`?



---

archive/issue_comments_221957.json:
```json
{
    "body": "You removed support for `coding`.",
    "created_at": "2014-09-25T11:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221957",
    "user": "jdemeyer"
}
```

You removed support for `coding`.



---

archive/issue_comments_221958.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-25T12:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221958",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_221959.json:
```json
{
    "body": "I tried to do the rebase, but the instructions in the documentation were not clear to me on this use-case. Did I do it right?\n\nI don't know what you mean with \"removed support for `coding`\".\n\nI added a new doctest instead of making the old one bigger because I didn't want the old one to be too large and confusing (as it is, it is hard to read). In the new doc-test is an `import inspect` and a strange line printing out the doc string.",
    "created_at": "2014-09-25T12:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221959",
    "user": "jsrn"
}
```

I tried to do the rebase, but the instructions in the documentation were not clear to me on this use-case. Did I do it right?

I don't know what you mean with "removed support for `coding`".

I added a new doctest instead of making the old one bigger because I didn't want the old one to be too large and confusing (as it is, it is hard to read). In the new doc-test is an `import inspect` and a strange line printing out the doc string.



---

archive/issue_comments_221960.json:
```json
{
    "body": "Replying to [comment:12 jsrn]:\n> I tried to do the rebase, but the instructions in the documentation were not clear to me on this use-case. Did I do it right?\nI guess so, at least I don't see anything obviously bad.\n\n> \n> I don't know what you mean with \"removed support for `coding`\".\ngrep `src/bin/sage-preparse` for `coding` and you will see what I mean.",
    "created_at": "2014-09-25T12:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221960",
    "user": "jdemeyer"
}
```

Replying to [comment:12 jsrn]:
> I tried to do the rebase, but the instructions in the documentation were not clear to me on this use-case. Did I do it right?
I guess so, at least I don't see anything obviously bad.

> 
> I don't know what you mean with "removed support for `coding`".
grep `src/bin/sage-preparse` for `coding` and you will see what I mean.



---

archive/issue_comments_221961.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-25T12:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221961",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_221962.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-25T12:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221962",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_221963.json:
```json
{
    "body": "Good catch with the coding line. I reinstated it, and added it to the doctest.\n\nI also simplified the doctest and simply examine the produced file directly instead of doing strange reflection stuff.",
    "created_at": "2014-09-25T12:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221963",
    "user": "jsrn"
}
```

Good catch with the coding line. I reinstated it, and added it to the doctest.

I also simplified the doctest and simply examine the produced file directly instead of doing strange reflection stuff.



---

archive/issue_comments_221964.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-25T12:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221964",
    "user": "jsrn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_221965.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-07T12:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221965",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_221966.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-10-07T12:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221966",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_221967.json:
```json
{
    "body": "I think the doctest is not good enough, since it passes even *without the changes* to `sage-preparse`. If you want to convince me that this ticket is needed, show me a doctest which failed before and passes now.",
    "created_at": "2014-10-07T12:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221967",
    "user": "jdemeyer"
}
```

I think the doctest is not good enough, since it passes even *without the changes* to `sage-preparse`. If you want to convince me that this ticket is needed, show me a doctest which failed before and passes now.



---

archive/issue_comments_221968.json:
```json
{
    "body": "No need to get snappy -- obviously the problem was there or I wouldn't waste my time on this. It seems, however, that somewhere between 6.2 and 6.3 the generation of the _sage_const_X lines were moved, and this presents an alternative solution to the problem (those lines were previously put before the module doc-string).\n\nNow for this ticket: the change in sage-preparse could be rolled back since it is not necessary for the moment. The doc-test changes could be retained since it actually tests something which was not tested before. The latest test that you saw was however rather silly, since I forgot to reinstate a constant in the code after I merged the two doctests into one. I've fixed the doc test...",
    "created_at": "2014-10-08T08:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221968",
    "user": "jsrn"
}
```

No need to get snappy -- obviously the problem was there or I wouldn't waste my time on this. It seems, however, that somewhere between 6.2 and 6.3 the generation of the _sage_const_X lines were moved, and this presents an alternative solution to the problem (those lines were previously put before the module doc-string).

Now for this ticket: the change in sage-preparse could be rolled back since it is not necessary for the moment. The doc-test changes could be retained since it actually tests something which was not tested before. The latest test that you saw was however rather silly, since I forgot to reinstate a constant in the code after I merged the two doctests into one. I've fixed the doc test...



---

archive/issue_comments_221969.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2014-10-08T08:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221969",
    "user": "jsrn"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_221970.json:
```json
{
    "body": "Replying to [comment:21 jsrn]:\n> Now for this ticket: the change in sage-preparse could be rolled back since it is not necessary for the moment.\nI didn't say the changes were bad, in fact I do think they make sense. I only said that I could not check whether they solved the problem mentioned in this ticket.",
    "created_at": "2014-10-08T09:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221970",
    "user": "jdemeyer"
}
```

Replying to [comment:21 jsrn]:
> Now for this ticket: the change in sage-preparse could be rolled back since it is not necessary for the moment.
I didn't say the changes were bad, in fact I do think they make sense. I only said that I could not check whether they solved the problem mentioned in this ticket.



---

archive/issue_comments_221971.json:
```json
{
    "body": "Replying to [comment:21 jsrn]:\n> I've fixed the doc test...\nThen please push your branch...\n\nAlso: can you update the ticket description please, since the problem is no longer applicable.",
    "created_at": "2014-10-08T09:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221971",
    "user": "jdemeyer"
}
```

Replying to [comment:21 jsrn]:
> I've fixed the doc test...
Then please push your branch...

Also: can you update the ticket description please, since the problem is no longer applicable.



---

archive/issue_comments_221972.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2014-10-08T09:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221972",
    "user": "jsrn"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_221973.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2014-10-08T09:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221973",
    "user": "jsrn"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_221974.json:
```json
{
    "body": "I'm sorry but I'm completely lost in these branches. I'm working on branch t/17019/ticket/17019 but if I try to push with **git push trac t/17019/ticket/17019**, I get the following error\n\n\n```\nTotal 0 (delta 0), reused 0 (delta 0)\nremote: FATAL: W refs/heads/t/17019/ticket/17019 sage jsrn DENIED by fallthru\nremote: error: hook declined to update refs/heads/t/17019/ticket/17019\nTo git@trac.sagemath.org:sage.git\n ! [remote rejected] t/17019/ticket/17019 -> t/17019/ticket/17019 (hook declined)\nerror: failed to push some refs to 'git@trac.sagemath.org:sage.git'\n```\n\n\nIf I try to push with **git trac push**, it works fine but pushes to **u/jsrn/ticket/17019**, which doesn't seem to put my code into this ticket (but it does add the message \"Branch changed from bla-bla-bla\" which appears twice above).\n\nWhat do I do?\n----\nNew commits:",
    "created_at": "2014-10-08T09:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221974",
    "user": "jsrn"
}
```

I'm sorry but I'm completely lost in these branches. I'm working on branch t/17019/ticket/17019 but if I try to push with **git push trac t/17019/ticket/17019**, I get the following error


```
Total 0 (delta 0), reused 0 (delta 0)
remote: FATAL: W refs/heads/t/17019/ticket/17019 sage jsrn DENIED by fallthru
remote: error: hook declined to update refs/heads/t/17019/ticket/17019
To git@trac.sagemath.org:sage.git
 ! [remote rejected] t/17019/ticket/17019 -> t/17019/ticket/17019 (hook declined)
error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
```


If I try to push with **git trac push**, it works fine but pushes to **u/jsrn/ticket/17019**, which doesn't seem to put my code into this ticket (but it does add the message "Branch changed from bla-bla-bla" which appears twice above).

What do I do?
----
New commits:



---

archive/issue_comments_221975.json:
```json
{
    "body": "Ok, now I'm really confused: with 6 minutes delay the commit came through??? Did I do it right or was I just lucky and abusive towards the system?",
    "created_at": "2014-10-08T09:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221975",
    "user": "jsrn"
}
```

Ok, now I'm really confused: with 6 minutes delay the commit came through??? Did I do it right or was I just lucky and abusive towards the system?



---

archive/issue_comments_221976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-06T15:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221976",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_221977.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-06T15:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221977",
    "user": "jsrn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_221978.json:
```json
{
    "body": "I'm reviving this: Sage has displayed the doc-mangling behaviour after preprocessing in more or less all releases since this ticket was last discussed, possibly except the one Jeroen tested on a year ago. I don't know why that was.\n\nAt least, I've just tested that the doctest in this ticket fails if it's tested on the current beta, and that this patch fixes it.",
    "created_at": "2015-11-06T15:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221978",
    "user": "jsrn"
}
```

I'm reviving this: Sage has displayed the doc-mangling behaviour after preprocessing in more or less all releases since this ticket was last discussed, possibly except the one Jeroen tested on a year ago. I don't know why that was.

At least, I've just tested that the doctest in this ticket fails if it's tested on the current beta, and that this patch fixes it.



---

archive/issue_comments_221979.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-30T09:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221979",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_221980.json:
```json
{
    "body": "Necro-review -- thanks! :-)",
    "created_at": "2016-05-30T09:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221980",
    "user": "jsrn"
}
```

Necro-review -- thanks! :-)



---

archive/issue_comments_221981.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-31T07:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16782#issuecomment-221981",
    "user": "vbraun"
}
```

Resolution: fixed
