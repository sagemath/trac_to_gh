# Issue 30209: wrong result on symbolic exponentiation

Issue created by migration from https://trac.sagemath.org/ticket/30446

Original creator: dkrenn

Original creation time: 2020-08-26 14:33:36

CC:  zimmerma


```
sage: n((24*sqrt(3))^(100/50))
3.80392047155301e5927962146
sage: n((24*sqrt(3))^(2))
1728.00000000000
```

Clearly, both should be the same, namely the second.

This was on [SageMath](SageMath) 9.1 on openSUSE Leap 15.2 (64bit) (reported by a colleague to me).

I've tried to reproduce, but my [SageMath](SageMath), as well as on Cocalc crashes. The error message on my machine was

```
Traceback (most recent call last):
  File "<string>", line 25, in <module>
ModuleNotFoundError: No module named 'Cython'
Error while executing Python code.
Saved trace to /home/dakrenn/.sage/crash_logs/crash_lqkqgydq.log
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Aborted (core dumped)
```

However, my [SageMath](SageMath) seems to be fine otherwise, `make ptestlong` passes.
Same on current 9.2.beta9.


---

Comment by @DaveWitteMorris created at 2020-08-26 16:35:48

I confirm the error. I get exactly the same answers as in the original report. I am using Mac OS 10.15.5, and tested both 9.1 and 9.2b10. (The version with 100/2 is slow -- takes about 50 seconds.) 

When I tried `CoCalc`, it failed because it ran out of memory. (The memory gauge was over 3GB before it aborted.)


---

Comment by @bmlivin created at 2020-09-21 02:02:47

Set assignee to @bmlivin.


---

Comment by @DaveWitteMorris created at 2020-10-01 04:18:00

There is no need to use big numbers, so the situation is even worse than it first appeared:

```
sage: n((2*sqrt(2))^(2/1))                                                      
1.24131221754531e1292913987
sage: n((2*sqrt(2))^2)                                                          
8.00000000000000
```

This only takes a few seconds with 9.1 on `CoCalc` (but needs more than 1GB of memory) or with 9.2b13 on MacOS 10.15.6.


---

Comment by mantepse created at 2020-10-01 08:01:26

I can confirm this on Ubuntu 18 with [SageMath](SageMath) version 9.2.beta13, using Python 3.8.5.


---

Comment by @bmlivin created at 2020-10-03 23:17:23

Remove assignee @bmlivin.


---

Comment by @bmlivin created at 2020-10-03 23:17:23

Okay, I believe I've tracked this down. It is a `pynac` bug. Here's what's happening:

`Sage` eventually calls `pynac`'s `pow` from `sage.symbolic.expression:Expression._pow_`, but before that happens, it simplifies the exponent. Specifically, it simplifies the exponent so that `pynac` thinks it is an integer, but its type is still `MPQ`.

None of that should matter, except that what `pynac` calls to evaluate the expression is `numeric::pow_intexp`. Here is the content of that function:


```
if (not exponent.is_integer())
    throw std::runtime_error("nueric::pow_intexp: exponent not integer");
if (exponent.t == MPZ) {
    if (not mpz_fits_sint_p(exponent.v._bigint))
        throw std::runtime_error("size of exponent exceeds signed long size");
    return power(mpz_get_si(exponent.v._bigint));
}
return power(exponent.v._long);
```


In this function, `exponent.is_integer()` is `True` and `exponent.t` is `MPQ`. So both of the `if` statements are false, and `power(exponent.v._long)` is called. The problem is that `v._long` contains junk (very large junk!). Evaluating that statement takes a long time, and it won't give you the answer you want.

If, on the other hand, the second `if` statement were true, the result would have been exactly what you want. So simply checking whether `exponent.t == MPQ` or `exponent.t == MPZ` should fix this. I haven't tried this, but it's what I would at least try.

I think it may be possible as well to fix this by getting `Sage` to change the type of the exponent when it's cancelled out. I haven't looked into this and I think it sounds like a bad idea.

I'm unassigning this because I can't currently report it upstream.


---

Comment by @bmlivin created at 2020-10-12 02:29:53

Changing status from new to needs_review.


---

Comment by @bmlivin created at 2020-10-12 02:29:53

I've fixed this upstream and submitted a pull request: https://github.com/pynac/pynac/pull/355. The pull request also includes additions to the doctest for `sage.symbolic.expression.Expression::_pow_`.


---

Comment by dimpase created at 2021-01-10 11:51:46

OK, trying https://patch-diff.githubusercontent.com/raw/pynac/pynac/pull/355.patch now.

But where are "additions to the doctest for `sage.symbolic.expression.Expression::_pow_`"?

I presume they should be here, on this ticket.


---

Comment by dimpase created at 2021-01-10 11:59:04

OK, with that patch,

```
sage: QQ((24*sqrt(3))^(100/50))==1728                                                                                                                                
True
```

works. I'll add this as a doctest somewhere.


---

Comment by dimpase created at 2021-01-10 12:37:55

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-01-10 12:37:55

patches from pynac PRs to be removed at the next pynac update.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-01-10 22:43:55

This patch to pynac also fixes #28620, #30304, and #30786. The PR at #30786 adds doctests for all 3 of these tickets (and also moves the doctest of this ticket from the `_latex_` method to the `_pow_` method, which seems like a more appropriate place).


---

Comment by @DaveWitteMorris created at 2021-01-11 02:05:23

fyi: Patchbot `Linux/74-Ubuntu_SMP_Tue_Sep_17_17%3A06%3A04_UTC_2019/x86_64/4.15.0-65-generic/pc72` seems to have failed to build pynac at ticket #30786. ("Error installing package pynac-0.7.26.sage-2020-04-03.p1") If there is a genuine problem, I think it must be because of this ticket.


---

Comment by @DaveWitteMorris created at 2021-01-12 02:26:51

This patch also seems to fix #31137. I added a doctest there.


---

Comment by @DaveWitteMorris created at 2021-01-12 08:21:58

fyi: Another ubuntu patchbot failed to build pynac (on ticket #31137 this time). Both failures say `WARNING: 'aclocal-1.16' is missing on your system. ... Makefile:432: recipe for target 'aclocal.m4' failed`.


---

Comment by vbraun created at 2021-01-17 19:26:38

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-01-17 19:26:38

Patch touches configure stuff which triggers automake run (which is not a Sage dependency)

```
Building pynac-0.7.26.sage-2020-04-03.p1
CDPATH="${ZSH_VERSION+.}:" && cd . && /bin/bash /var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/pynac-0.7.26.sage-2020-04-03.p1/src/missing aclocal-1.16 -I m4
/var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/pynac-0.7.26.sage-2020-04-03.p1/src/missing: line 81: aclocal-1.16: command not found
WARNING: 'aclocal-1.16' is missing on your system.
         You should only need it if you modified 'acinclude.m4' or
         'configure.ac' or m4 files included by 'configure.ac'.
         The 'aclocal' program is part of the GNU Automake package:
         <https://www.gnu.org/software/automake>
         It also requires GNU Autoconf, GNU m4 and Perl in order to run:
         <https://www.gnu.org/software/autoconf>
         <https://www.gnu.org/software/m4/>
         <https://www.perl.org/>
Makefile:432: recipe for target 'aclocal.m4' failed
make[5]: *** [aclocal.m4] Error 127
make[5]: Failed to remake makefile 'Makefile'.
make[5]: Target 'all' not remade because of errors.
```



---

Comment by @mjungmath created at 2021-01-23 18:21:50

Changing priority from major to critical.


---

Comment by @mjungmath created at 2021-01-23 18:21:50

I set this to critical since many tickets (some already positively reviewed providing a doctest) rely on this one.


---

Comment by mkoeppe created at 2021-01-23 20:16:48

https://doc.sagemath.org/html/en/developer/packaging.html#when-to-patch-when-to-repackage-when-to-autoconfiscate explains that patching is not an option here.
A pynac release needs to be made and the new release tarball needs to be used.


---

Comment by dimpase created at 2021-01-24 19:14:21

I'll repurpose this ticket for the package update.


---

Comment by dimpase created at 2021-01-24 19:51:21

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-01-24 19:51:21

New commits:


---

Comment by mkoeppe created at 2021-01-24 19:57:17

When you make official releases in https://github.com/pynac/pynac, there is no need for a version suffix such as "sage-2020-04-03". I used this when I made the previous release from https://github.com/mkoeppe/pynac to make clear that this was an unofficial release.


---

Comment by mkoeppe created at 2021-01-24 19:57:23

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-01-24 20:00:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-24 20:17:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-01-24 20:18:44

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-01-24 20:30:58

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-01-24 20:30:58

should provide a cleaner tarball


---

Comment by dimpase created at 2021-01-24 21:06:09

Replying to [comment:20 mkoeppe]:
> When you make official releases in https://github.com/pynac/pynac, there is no need for a version suffix such as "sage-2020-04-03". I used this when I made the previous release from https://github.com/mkoeppe/pynac to make clear that this was an unofficial release.

but then https://github.com/pynac/pynac/commit/bbaff9d21d31e73f74bf3dd751b16c4dd3ac28a7 has sneaked upstream in some way :-)


---

Comment by git created at 2021-01-24 21:29:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-01-24 21:40:55

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-01-24 21:56:36

`build/pkgs/pynac/SPKG.rst` could use an update. In particular "Special Update/Build Instructions" should be removed


---

Comment by mkoeppe created at 2021-01-24 22:00:50

Changing status from needs_review to positive_review.


---

Comment by git created at 2021-01-24 22:07:25

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-01-24 22:07:25

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2021-01-24 22:08:07

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-01-24 22:08:07

ok, done


---

Comment by vbraun created at 2021-02-08 00:10:03


```
[dochtml] [calculus ] docstring of sage.symbolic.expression.Expression.subs:135: WARNING: Literal block expected; none found.
[dochtml] [calculus ] docstring of sage.symbolic.expression.Expression.substitute:135: WARNING: Literal block expected; none found.
[dochtml] [manifolds] The inventory files are in local/share/doc/sage/inventory/en/reference/manifolds.
[dochtml] Build finished. The built documents can be found in /home/release/Sage/local/share/doc/sage/inventory/en/reference/manifolds
[dochtml] [calculus ] The inventory files are in local/share/doc/sage/inventory/en/reference/calculus.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib64/python3.9/runpy.py", line 197, in _run_module_as_main
[dochtml]     return _run_code(code, main_globals, None,
[dochtml]   File "/usr/lib64/python3.9/runpy.py", line 87, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 1730, in main
[dochtml]     builder()
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 343, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 569, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 555, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 295, in build_many
[dochtml]     _build_many(target, args, processes=NUM_THREADS)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/utils.py", line 289, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] OSError: docstring of sage.symbolic.expression.Expression.subs:135: WARNING: Literal block expected; none found.
[dochtml] 
[dochtml]     Note: incremental documentation builds sometimes cause spurious
[dochtml]     error messages. To be certain that these are real errors, run
[dochtml]     "make doc-clean" first and try again.
```



---

Comment by vbraun created at 2021-02-08 00:10:03

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-02-20 16:55:34

Could someone fix up the documentation markup please?


---

Comment by @DaveWitteMorris created at 2021-02-21 20:27:40

I can't find any mistake, the patchbots are green, and the html documentation builds for me.

I wonder if maybe this error was posted to the wrong ticket? It is exactly the same error that was reported by a patchbot on ticket #30378 because I goofed up the `WARNING` block there:

```
[dochtml] OSError: docstring of sage.symbolic.expression.Expression.subs:135: WARNING: Literal block expected; none found.
```



---

Comment by mkoeppe created at 2021-02-21 21:12:40

Thanks for checking! Works for me too (tested on top of 31344)


---

Comment by mkoeppe created at 2021-02-21 21:12:40

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-03-07 17:06:32

Resolution: fixed
