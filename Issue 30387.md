# Issue 30387: Improve configure's recommendation message

Issue created by migration from https://trac.sagemath.org/ticket/30624

Original creator: slelievre

Original creation time: 2020-09-21 09:21:52

CC:  egourgoulhon mjo mkoeppe slelievre @tobiasdiez slabbe

**Context**

Recent work on Sage's build system enables to use many
system packages as possible when building Sage.
See meta-ticket #27330 for an overview.

Part of that effort is to have `configure` end with
recommendations of extra system packages to install.

Making this recommendation system very precise would not
be sustainable. As a compromise, it recommends installing
packages whenever

- satisfactory versions of these packages
  are not found to be already installed
- some version of that OS has versions of these packages
  that would avoid having to build them

**Problem**

With the wording of the recommendation hint up to
Sage 9.2.beta12, users can be puzzled when it recommends
installing a package that is already installed.

**Solution**

Improve the recommendation message and along the way
make it better stand out.

Before this ticket:

```
configure: hint: installing the following system packages
is recommended and may avoid building some of the above SPKGs
from source:
configure:   $ sudo apt-get update
$ sudo apt-get install libcdd-dev libcdd-tools libnauty-dev
```


After this ticket:

```
configure:

    hint: installing the following system packages, if not
    already present, is recommended and may avoid building
    some of them from source (though some of them may
    have to be built anyway):

    $ sudo apt-get update
    $ sudo apt-get install libcdd-dev libcdd-tools libnauty-dev

```



See the 2020-09 discussion on sage-release,
in particular these posts:

- https://groups.google.com/d/msg/sage-release/hobZzw74Rv0/xtBCPrGrAgAJ
- https://groups.google.com/d/msg/sage-release/hobZzw74Rv0/1IYw5RG_BQAJ
- https://groups.google.com/d/msg/sage-release/hobZzw74Rv0/MWUqj400BgAJ


---

Comment by slelievre created at 2020-10-05 07:22:09

Changing status from new to needs_review.


---

Comment by slelievre created at 2020-10-05 07:22:09

Here is a branch.

Illustration on macOS.

Before:

```
$ source .homebrew-build-env && ./bootstrap -q && ./configure
...
config.status: creating directory local/lib/pkgconfig
config.status: creating directory local/share
config.status: creating directory local/var/lib/sage/installed
configure: notice: the following SPKGs did not find equivalent system packages: cbc coxeter3 gp2c libnauty libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata perl_cpan_polymake_prereq perl_term_readline_gnu python3 tox
checking for the package system in use... -n (ignoring conda because no environment is active)
homebrew
configure: hint: installing the following system packages is recommended and may avoid building some of the above SPKGs from source:
configure:   $ brew install python3
# To automatically take care of homebrew messages regarding
# keg-only packages for the current shell session:
  $ source /opt/s/sage9/.homebrew-build-env
# Add this to your shell profile if you want it to persist between shell sessions.
configure: After installation, re-run configure using:
configure:   $ ./config.status --recheck && ./config.status
```


After:

```
$ source .homebrew-build-env && ./bootstrap -q && ./configure
...
config.status: creating directory local/lib/pkgconfig
config.status: creating directory local/share
config.status: creating directory local/var/lib/sage/installed
configure:

    notice: the following SPKGs did not find equivalent system packages:

        cbc coxeter3 gp2c libnauty libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata perl_cpan_polymake_prereq perl_term_readline_gnu python3 tox

checking for the package system in use... -n (ignoring conda because no environment is active)
homebrew
configure:

    hint: installing the following system packages, if not
    already present, is recommended and may avoid having to
    build them (though some may have to be built anyway):

      $ brew install python3

    Homebrew can issue suggestions regarding keg-only packages.
    The following command is to automatically apply these suggestions.
    Run it once to apply the suggestions for the current session.
    Add it to your shell profile to apply them for all future sessions.

      $ source /opt/s/sage92b6/.homebrew-build-env

    After installation, re-run configure using:

      $ ./config.status --recheck && ./config.status
```


Illustration on Debian.

Before:

```
$ ./bootstrap -q && ./configure
...
config.status: creating directory local/lib/pkgconfig
config.status: creating directory local/share
config.status: creating directory local/var/lib/sage/installed
configure: notice: the following SPKGs did not find equivalent system packages: coxeter3 gp2c libnauty libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata tox
checking for the package system in use... debian
configure: hint: installing the following system packages is recommended and may avoid building some of the above SPKGs
from source:
configure:   $ sudo apt-get update
  $ sudo apt-get install pari-gp2c libnauty-dev
configure: After installation, re-run configure using:
configure:   $ ./config.status --recheck && ./config.status
```


After:

```
$ ./bootstrap -q && ./configure
...
config.status: creating directory local/lib/pkgconfig
config.status: creating directory local/share
config.status: creating directory local/var/lib/sage/installed
configure:

    notice: the following SPKGs did not find equivalent system packages:

        coxeter3 gp2c libnauty libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata tox

checking for the package system in use... debian
configure:

    hint: installing the following system packages, if not
    already present, is recommended and may avoid having to
    build them (though some may have to be built anyway):

      $ sudo apt-get update
  $ sudo apt-get install pari-gp2c libnauty-dev

    After installation, re-run configure using:

      $ ./config.status --recheck && ./config.status
```

----
New commits:


---

Comment by slelievre created at 2020-10-05 07:25:47

Polishing commits welcome (here or in a follow-up ticket).

I'll update the "before/after" in the ticket description
once the branch gets positive review.


---

Comment by mkoeppe created at 2020-10-05 11:46:27

This change is not good. # is the shell comment character.
The idea here is that (if PROMPT is not used) that you get a valid shell script as the output.

```
-        $IF_VERBOSE echo "# To automatically take care of homebrew messages regarding "
-        $IF_VERBOSE echo "# keg-only packages for the current shell session:"
+        $IF_VERBOSE echo ""
+        $IF_VERBOSE echo "    Homebrew can issue suggestions regarding keg-only packages."
+        $IF_VERBOSE echo "    The following command is to automatically apply these suggestions."
```



---

Comment by mkoeppe created at 2020-10-05 11:56:25

If you put this ticket on top of #30606, you could add customization of the comment prefix in the same way that #30606 adds customization of the prompt...


---

Comment by git created at 2020-10-05 19:36:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-10-05 19:38:13

Rebased as I suggested. You can now modify the invocations of `sage-print-system-package-command` to use something like this for the desired effect:

```
build/bin/sage-print-system-package-command homebrew --verbose='     ' --prompt='               $ ' setup-build-env foo
```



---

Comment by mkoeppe created at 2020-10-05 21:21:03

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-10-07 18:26:10

Your turn, Samuel...


---

Comment by slelievre created at 2020-10-08 16:44:24

Neither of the "notice: ...", "hint: ...",
or "After installation, ..." parts start with "# ".

So I tried to also avoid "# " for the text
on linking Homebrew's keg-only packages.

Thanks for showing me the correct way to do that.


---

Comment by mkoeppe created at 2020-11-01 19:41:20

Samuel, do you plan to work on this?


---

Comment by egourgoulhon created at 2020-11-02 20:12:32

FWIW, I've installed Sage 9.3.beta0 from scratch on Ubuntu 20.04; `configure` ends with the following recommendations:

```
configure: hint: installing the following system packages is recommended and may 
avoid building some of the above SPKGs from source:
configure:   $ sudo apt-get update 
  $ sudo apt-get install texlive-generic-extra texlive-xetex latexmk pandoc dvipng 
default-jdk ffmpeg libavdevice-dev libcdd-dev libcdd-tools libec-dev eclib-tools 
libgc-dev libgiac-dev xcas pari-gp2c lcalc liblfunction-dev libnauty-dev nauty 
pari-gp2c libpari-dev pari-doc pari-elldata pari-galdata pari-galpol pari-seadata 
sympow
```

Now, as mentioned in #29557#comment:56, `texlive-generic-extra` does not exist on Ubuntu 20.04 (there is `texlive-latex-extra`, which is already installed on my system). Moreover the recommended packages `texlive-xetex`,  `latexmk`, `pandoc`, `dvipng`, `default-jdk`, `ffmpeg`, `libavdevice-dev`, `libcdd-dev` and `libcdd-tools` are already installed on my system.


---

Comment by mkoeppe created at 2020-11-17 02:30:57

Updates of the package list and similar improvements -- please in #30930 or other tickets, not here.

Let's keep this ticket narrowly focused on what is already on the branch.


---

Comment by mkoeppe created at 2020-11-17 18:46:42

Samuel, please let me know if I can help with anything else to get this ticket finished.


---

Comment by slelievre created at 2020-11-17 23:53:08

What you did is good. Maybe set to `needs_review` and review as is?


---

Comment by mkoeppe created at 2020-11-18 00:18:47

The new options that I introduced for you (comment:7) are not used yet.


---

Comment by git created at 2020-11-27 01:18:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-11-27 01:18:50

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-11-27 01:18:50

Ready for review


---

Comment by slabbe created at 2020-11-27 07:55:20

I just tested the branch on Ubuntu 18.04, I obtain:


```
configure:

    notice: the following SPKGs did not find equivalent system packages:

        _recommended boost coxeter3 gp2c igraph isl libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata
        
checking for the package system in use... debian
configure:

    hint: installing the following system packages, if not
    already present, is recommended and may avoid having to
    build them (though some may have to be built anyway):

      $ sudo apt-get update 
      $ sudo apt-get install  texlive-generic-extra texlive-xetex latexmk pandoc dvipng default-jdk ffmpeg libavdevice-dev libboost-dev pari-gp2c libigraph-dev libisl-dev

    After installation, re-run configure using:

      $ ./config.status --recheck && ./config.status
         
```


Should `_recommended` be listed in the first list?


---

Comment by slabbe created at 2020-11-27 07:58:28

> Should _recommended be listed in the first list? 

If the answer to that question is yes, please change the status of this ticket to positive review.


---

Comment by slabbe created at 2020-11-27 08:00:56

> Should _recommended be listed in the first list? 

I just observed that this is the current behavior on 9.3.beta2. So, this is independent of this ticket.


---

Comment by slabbe created at 2020-11-27 08:00:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-11-27 18:30:15

Thank you!


---

Comment by mkoeppe created at 2020-11-27 18:31:42

Replying to [comment:25 slabbe]:
> I just tested the branch on Ubuntu 18.04, I obtain:
> 
> {{{
> configure:
> 
>     notice: the following SPKGs did not find equivalent system packages:
> 
>         _recommended boost coxeter3 gp2c igraph isl libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata
> 
> Should `_recommended` be listed in the first list?

I am making some changes in this direction - suppressing display of packages starting with underscore - in #29124


---

Comment by vbraun created at 2020-12-05 22:13:18

Resolution: fixed
