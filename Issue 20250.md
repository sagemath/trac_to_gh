# Issue 20250: Numpy build broken on Cygwin since #20450

Issue created by migration from https://trac.sagemath.org/ticket/20487

Original creator: embray

Original creation time: 2016-04-22 14:19:03

Since the upgrade to Numpy 1.11, the patch cygwin-lapack_lite-setup.py.patch no longer applies.  This is hardly the first time (#17014, etc. :)

It's not entirely clear whether this patch is even needed anymore.  The first version of it was added 8 years ago: http://git.sagemath.org/sage.git/commit/?h=develop&id=f0ef7690e4f601e289608a09fe30df9d242eb3e8

It's not exactly clear what issue this is fixing, and I can't find any obvious reference to what it might have been--not in any of the more recent Cygwin-related documentation or anywhere.  Numpy _compiles_ fine without it. 


---

Comment by embray created at 2016-04-22 15:51:18

I think there may also be an issue with Numpy and BLAS configuration.  After rebasing my Cython branch I'm running into some build issues with SciPy that I never encountered before, which seem to do with how Numpy is reporting what libraries it was built with. I need to spend more time investigating though.


---

Comment by embray created at 2016-04-27 14:37:59

From my testing I've concluded that the patch in question can be dropped.  It seems that with some ancient version of Numpy the `-shared` flag was being excluded when linking this module on Cygwin for some reason or other.  That is no longer the case though.
----
New commits:


---

Comment by embray created at 2016-04-27 14:37:59

Changing keywords from "" to "cygwin windows numpy".


---

Comment by embray created at 2016-04-27 14:37:59

Changing status from new to needs_review.


---

Comment by gouezel created at 2016-04-28 11:08:18

Changing status from needs_review to positive_review.


---

Comment by gouezel created at 2016-04-28 11:08:18

Works for me as well.


---

Comment by vbraun created at 2016-04-29 07:13:32

Resolution: fixed


---

Comment by vbraun created at 2016-04-30 16:41:47

Ok this prevents all patches from being applied. Note the difference:

```
$ for patch in "patches/*.patch"; do echo $patch; done
patches/numpy-1.10.1-asarray_conversion.patch patches/numpy-1.10.2-no-hardcode-blas.patch
$ for patch in patches/*.patch; do echo $patch; done
patches/numpy-1.10.1-asarray_conversion.patch
patches/numpy-1.10.2-no-hardcode-blas.patch
```



---

Comment by vbraun created at 2016-04-30 16:41:47

Changing status from closed to new.


---

Comment by vbraun created at 2016-04-30 16:41:47

Resolution changed from fixed to 


---

Comment by embray created at 2016-05-02 09:16:30

Yup, that's a typo.


---

Comment by embray created at 2016-05-02 09:18:06

This raises a question:  If the patchbot passed for the original version of this change, what is being patched in Numpy that there isn't a regression test for?


---

Comment by embray created at 2016-05-02 09:31:42

Changing status from new to needs_info.


---

Comment by embray created at 2016-05-02 09:31:42

I'm marking this as "needs_info" out of concern that this was previously marked "fixed" and it's not clear how the issue was caught.
----
New commits:


---

Comment by vbraun created at 2016-05-02 09:39:17

Numpy was not recompiled because you didn't change `package-version.txt`


---

Comment by embray created at 2016-05-02 10:08:16

Why would I change package-version.txt?


---

Comment by vbraun created at 2016-05-02 10:14:43

to trigger recompilation if necessary


---

Comment by jdemeyer created at 2016-05-02 10:40:18

Replying to [comment:11 embray]:
> Why would I change package-version.txt?

To elaborate a bit on this: the build system of Sage tracks versions of installed packages. If you change the `spkg-install` script or change patches of a package, Sage will _not_ automatically rebuild that package.

If you do want the package to be rebuilt, you need to increase the patchlevel in `package-version.txt`. This means either appending `.p0` or changing `.pN` to `.p(N+1)`.

You should always increase the patchlevel when changing the `spkg-install` script or patches of a package _unless there is a good reason not to_. Typical reasons "not to":

- A completely trivial change, like a typo.

- A change which affects only the *build system* of the package but does *not change the installed package* (not even in a minor way).

- The change affects only a particular platform *and* the package did not *build* on that platform before.

Regardless of the above reasons, a reviewer should always check that the changed package builds and works fine. This means doing a forced rebuild of the package using `sage -f PACKAGE`. Ideally, a build from scratch (`make distclean; make`) should also be tested.


---

Comment by embray created at 2016-05-02 12:47:13

Okay, that sounds reasonable-ish.  I'll touch the patch number then.  Should I also just go ahead and squash my commits or do we not care about that?


---

Comment by jdemeyer created at 2016-05-02 13:06:15

Replying to [comment:14 embray]:
> Should I also just go ahead and squash my commits or do we not care about that?

I would say that Sage has a policy to _not_ squash commits, at least not while a branch is in review.


---

Comment by git created at 2016-05-03 07:44:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-05-06 13:54:05

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2016-05-13 12:44:07

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-05-13 12:44:19

Builds fine on Linux too.


---

Comment by vbraun created at 2016-05-17 07:16:31

Resolution: fixed
