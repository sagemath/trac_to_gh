# Issue 28795: spkg-configure.m4 for python3 with SAGE_LOCAL as a venv for system pythons

archive/issues_028795.json:
```json
{
    "body": "This is an experimental alternative proposal to #27824.\n\nIt isn't yet as \"complete\" as #27824 as it lacks some of the fixes (e.g. the patches to Pillow) which I didn't need for my tests, but which may still be needed on other platforms (TBD).\n\nThe spkg-configure.m4 itself is taken almost directly from #27824, as most of it was great, except for a couple minor changes:\n\n* No temporary \"config_venv\" to test the system Python's packages; instead just run the system Python (if detected) with the `-S` flag.\n\n* `config_setup.py` and `config_build` are renamed `conftest.py` and `conftest.dir` respectively since autoconf will automatically clean up files and directories beginning with \"conftest\"; see https://www.gnu.org/software/autoconf/manual/autoconf-2.60/autoconf.html#Guidelines\n\n* `AC_SUBST([SAGE_SYSTEM_PYTHON])` instead of `AC_SUBST([PYTHON_FOR_VENV])`\n\n\nThe changes to `build/make/deps` are also inspired by #27824 but are simpler in my opinion: Instead of creating a virtualenv nested inside SAGE_LOCAL, SAGE_LOCAL itself is just treated as a virtualenv, and we install the necessary files for the Python interpreter to treat it as such, which keeps things simpler, as SAGE_LOCAL + `source sage-env` already fills the same purpose as a virtualenv.\n\nThis was tested on Ubuntu 18.04, and `make ptestlong` passes from a clean build with the system Python detected.  No guarantees about OSX or other platforms.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29032\n\n",
    "created_at": "2020-01-17T17:12:44Z",
    "labels": [
        "build: configure",
        "major",
        "enhancement"
    ],
    "title": "spkg-configure.m4 for python3 with SAGE_LOCAL as a venv for system pythons",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28795",
    "user": "embray"
}
```
This is an experimental alternative proposal to #27824.

It isn't yet as "complete" as #27824 as it lacks some of the fixes (e.g. the patches to Pillow) which I didn't need for my tests, but which may still be needed on other platforms (TBD).

The spkg-configure.m4 itself is taken almost directly from #27824, as most of it was great, except for a couple minor changes:

* No temporary "config_venv" to test the system Python's packages; instead just run the system Python (if detected) with the `-S` flag.

* `config_setup.py` and `config_build` are renamed `conftest.py` and `conftest.dir` respectively since autoconf will automatically clean up files and directories beginning with "conftest"; see https://www.gnu.org/software/autoconf/manual/autoconf-2.60/autoconf.html#Guidelines

* `AC_SUBST([SAGE_SYSTEM_PYTHON])` instead of `AC_SUBST([PYTHON_FOR_VENV])`


The changes to `build/make/deps` are also inspired by #27824 but are simpler in my opinion: Instead of creating a virtualenv nested inside SAGE_LOCAL, SAGE_LOCAL itself is just treated as a virtualenv, and we install the necessary files for the Python interpreter to treat it as such, which keeps things simpler, as SAGE_LOCAL + `source sage-env` already fills the same purpose as a virtualenv.

This was tested on Ubuntu 18.04, and `make ptestlong` passes from a clean build with the system Python detected.  No guarantees about OSX or other platforms.

Issue created by migration from https://trac.sagemath.org/ticket/29032





---

archive/issue_comments_406904.json:
```json
{
    "body": "See also #29033 which expands on this to add support for a system Python 3.6.",
    "created_at": "2020-01-17T17:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406904",
    "user": "embray"
}
```

See also #29033 which expands on this to add support for a system Python 3.6.



---

archive/issue_comments_406905.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-17T17:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406905",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406906.json:
```json
{
    "body": "Thanks for working of this. \nI have started to merge a few things from this branch.\n\nOne concern that I have is that in this approach, there is a `$SAGE_LOCAL/bin/activate` which signals to users that it would \"activate\" `$SAGE_LOCAL`. But it doesn't. It only activates the venv.",
    "created_at": "2020-01-17T19:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406906",
    "user": "mkoeppe"
}
```

Thanks for working of this. 
I have started to merge a few things from this branch.

One concern that I have is that in this approach, there is a `$SAGE_LOCAL/bin/activate` which signals to users that it would "activate" `$SAGE_LOCAL`. But it doesn't. It only activates the venv.



---

archive/issue_comments_406907.json:
```json
{
    "body": "A comment regarding the variable `SAGE_SYSTEM_PYTHON`: I think this is not specific enough because `build/bin/sage-system-python` means something different from that.",
    "created_at": "2020-01-17T21:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406907",
    "user": "mkoeppe"
}
```

A comment regarding the variable `SAGE_SYSTEM_PYTHON`: I think this is not specific enough because `build/bin/sage-system-python` means something different from that.



---

archive/issue_comments_406908.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> Thanks for working of this. \n> I have started to merge a few things from this branch.\n> \n> One concern that I have is that in this approach, there is a `$SAGE_LOCAL/bin/activate` which signals to users that it would \"activate\" `$SAGE_LOCAL`. But it doesn't. It only activates the venv.\n\nAre you sure?  I'll double check, but with this branch as written it should *not* install any bin/activate scripts.",
    "created_at": "2020-01-22T11:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406908",
    "user": "embray"
}
```

Replying to [comment:4 mkoeppe]:
> Thanks for working of this. 
> I have started to merge a few things from this branch.
> 
> One concern that I have is that in this approach, there is a `$SAGE_LOCAL/bin/activate` which signals to users that it would "activate" `$SAGE_LOCAL`. But it doesn't. It only activates the venv.

Are you sure?  I'll double check, but with this branch as written it should *not* install any bin/activate scripts.



---

archive/issue_comments_406909.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> A comment regarding the variable `SAGE_SYSTEM_PYTHON`: I think this is not specific enough because `build/bin/sage-system-python` means something different from that.\n\nRight, that's a bit confusing.  I wasn't totally sure how I felt about that variable name either, but I couldn't think of something better.  I think it does make *some* sense in that just as `build/bin/sage-system-python` runs the system Python, `SAGE_SYSTEM_PYTHON` points to the path to the system Python *if* it is being used to run Sage.  But I'm open to other ideas here.",
    "created_at": "2020-01-22T11:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406909",
    "user": "embray"
}
```

Replying to [comment:5 mkoeppe]:
> A comment regarding the variable `SAGE_SYSTEM_PYTHON`: I think this is not specific enough because `build/bin/sage-system-python` means something different from that.

Right, that's a bit confusing.  I wasn't totally sure how I felt about that variable name either, but I couldn't think of something better.  I think it does make *some* sense in that just as `build/bin/sage-system-python` runs the system Python, `SAGE_SYSTEM_PYTHON` points to the path to the system Python *if* it is being used to run Sage.  But I'm open to other ideas here.



---

archive/issue_comments_406910.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> Replying to [comment:4 mkoeppe]:\n> > Thanks for working of this. \n> > I have started to merge a few things from this branch.\n> > \n> > One concern that I have is that in this approach, there is a `$SAGE_LOCAL/bin/activate` which signals to users that it would \"activate\" `$SAGE_LOCAL`. But it doesn't. It only activates the venv.\n> \n> Are you sure?  I'll double check, but with this branch as written it should *not* install any bin/activate scripts.\n\nI confirmed that as expected it does not install an `activate` script.  Is it possible you had that hanging around from something else?",
    "created_at": "2020-01-22T11:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406910",
    "user": "embray"
}
```

Replying to [comment:6 embray]:
> Replying to [comment:4 mkoeppe]:
> > Thanks for working of this. 
> > I have started to merge a few things from this branch.
> > 
> > One concern that I have is that in this approach, there is a `$SAGE_LOCAL/bin/activate` which signals to users that it would "activate" `$SAGE_LOCAL`. But it doesn't. It only activates the venv.
> 
> Are you sure?  I'll double check, but with this branch as written it should *not* install any bin/activate scripts.

I confirmed that as expected it does not install an `activate` script.  Is it possible you had that hanging around from something else?



---

archive/issue_comments_406911.json:
```json
{
    "body": "Rebased on top of #29357 (and 9.1.beta7)\n----\nNew commits:",
    "created_at": "2020-03-18T21:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406911",
    "user": "mkoeppe"
}
```

Rebased on top of #29357 (and 9.1.beta7)
----
New commits:



---

archive/issue_comments_406912.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-19T02:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406912",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_406913.json:
```json
{
    "body": "Rebased again on top of #29357 (and 9.1.beta8)",
    "created_at": "2020-03-19T02:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406913",
    "user": "mkoeppe"
}
```

Rebased again on top of #29357 (and 9.1.beta8)



---

archive/issue_comments_406914.json:
```json
{
    "body": "`@`embray\nI have adopted the approach of using `venv.EnvBuilder` on `SAGE_LOCAL`  in #27824. Thanks for your work on it.\n\nCould you elaborate on what the environment variable `VIRTUAL_ENV` is needed for?\n\nThe present ticket can be closed as a duplicate.",
    "created_at": "2020-03-19T16:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406914",
    "user": "mkoeppe"
}
```

`@`embray
I have adopted the approach of using `venv.EnvBuilder` on `SAGE_LOCAL`  in #27824. Thanks for your work on it.

Could you elaborate on what the environment variable `VIRTUAL_ENV` is needed for?

The present ticket can be closed as a duplicate.



---

archive/issue_comments_406915.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-30T14:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406915",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_406916.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2020-06-20T06:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28795#issuecomment-406916",
    "user": "chapoton"
}
```

Resolution: duplicate
