# Issue 24547: search_doc broken with jupyter notebook

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2018-02-19 17:23:27

Keywords: jupyter

First reported at https://ask.sagemath.org/question/41170/search_doc-readable-format/. Running a command like `search_doc("curl", whole_word=True)` opens a window containing garbage. On my machine, a long string that starts:

```
aHRtbC9lbi9yZWZlcmVuY2UvZ2VuaW5kZXgtYWxsLmh0bWw6MTM5MTA6ICAgICAgPGxpPjxhIGhyZWY
```

`search_src` works, for what that's worth.


---

Comment by jhpalmieri created at 2018-08-20 21:30:03

The problem is that the output from `search_doc` regularly contains non-ascii characters, like "¶", and the IPython pager does not handle these well. We can catch the error and then remove the offending character, or we can try to skip those search matches altogether ("Permalink to this definition: ¶" is probably not a useful search result).


---

Comment by jhpalmieri created at 2018-08-20 21:44:02

New commits:


---

Comment by jhpalmieri created at 2018-08-20 21:44:02

Changing status from new to needs_review.


---

Comment by nthiery created at 2018-08-21 07:54:51

Thanks much John for investigating!
I confirm that the above search now displays non garbage with the above 
search on "curl".

However it still break on e.g.:

```
    search_doc("combinat")
```


Also, the rendering is still not as nice as in 
the old notebook where you get an itemized list of clickable links rather
than the plain text:

```
html/en/reference/genindex-all.html:14283:      <li><a href="manifolds/sage/manifolds/operators.html#sage.manifolds.operators.curl">curl() (in module sage.manifolds.operators)</a>
html/en/reference/genindex-all.html:14286:        <li><a href="manifolds/sage/manifolds/differentiable/vectorfield.html#sage.manifolds.differentiable.vectorfield.VectorField.curl">(sage.manifolds.differentiable.vectorfield.VectorField method)</a>
```

This could be for a latter ticket though (to be mentioned in #25837).


Some minor additional suggestions:
- use `"XXX" not in line` rather than find
- add a doctest


---

Comment by nthiery created at 2018-08-21 07:55:10

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-08-21 08:55:36

When you say "IPython pager" I'm confused, because I thought we were talking about the notebook.  Why would anything in the notebook not properly handle non-ASCII characters?  And if so, I think that's something we should patch upstream rather than make our output worse.  Maybe I'm missing something though.


---

Comment by embray created at 2018-08-21 09:10:04

Nevermind; I reproduced the issue and I see it now.  Nevertheless, it's a bit surprising that this works for me fine at the command line and that it's broken in the notebook.  What's weirder is I don't know why containing non-ASCII characters should have anything to do with it.

The "garbage" that is displayed in the notebook is the base64-encoding of the expected output.  If I copy/paste the whole thing and wrap it in `print(base64.b64decode())`, the output from _that_ displays just fine in the notebook, including the paragraph symbol.

I think something a little deeper to do with IPython output formatting is going on here.  I don't think we want a hack workaround; especially since there can be non-ASCII characters in other search results, and sometimes we'll want those too.

(Incidentally, the output of `search_doc` is pretty atrocious to begin with.  Why does it output all this HTML instead of searching and returning results from the plain-text docs?  What use is having search results from the auto-generated index, for that matter? Anyways,  that's a separate issue; it just surprises me every time I see it...)


---

Comment by embray created at 2018-08-21 09:20:00

Replying to [comment:4 nthiery]:
> Also, the rendering is still not as nice as in 
> the old notebook where you get an itemized list of clickable links rather
> than the plain text:

It seems that `search_doc` checks a global variable called `EMBEDDED_MODE`, which I guess is set somehow when running in the sage notebook.  If `EMBDEDDED_MODE` then it HTML-formats the results.  Whereas otherwise it just calls `IPython.core.page.page`.

I think I might understand the problem now: Although `search_doc` contains unicode characters, it's just returning the raw UTF-8 byte strings.  Your terminal knows how to display these.  But Jupyter is just treating this as a binary blob and displaying it in the notebook as base64.  We need to instead pass an actual unicode string (I'm guessing).  Further, I need to look into whether it's possible to pass HTML to the pager in supported contexts; I wonder if it supports multi-part MIME data like other Jupyter output contexts...


---

Comment by embray created at 2018-08-21 09:53:57

I've almost got it working--the HTML-formatted results are currently only formatted in a way that makes sense for the legacy notebook, so it needs two formatting modes.


---

Comment by embray created at 2018-08-21 09:56:46

Yikes.  A `<font>` tag.


---

Comment by embray created at 2018-08-21 10:22:01

This is turning out to be something of a rabbit hole, as the old-style HTML-formatted results are...not great.  And as I pointed out above, broken in Jupyter, since the URLs to the results are only meaningful inside the legacy notebook.

Should I attach just an interim patch for the immediate issue, and push off updating the HTML results for another ticket, or just do it all at once?


---

Comment by embray created at 2018-08-21 11:26:37

How's this look for a start?  Aside from a few other minor code updates this doesn't change any functionality, but just improves support for unicode text in the existing behavior.  I will create a follow-up ticket for improving the HTML-formatted search results and making them work in the Jupyter Notebook.

Thanks again John to pointing out in the first place that the issue had to do with unicode characters, which is what led me in the right direction.
----
New commits:


---

Comment by embray created at 2018-08-21 11:26:37

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-08-21 11:45:12

I created a follow-up #26104 for improving the HTML search results.


---

Comment by jhpalmieri created at 2018-08-21 17:47:08


```
sage: search_src('Steenrod')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

...

TypeError: format_search_as_html() got an unexpected keyword argument 'whole_word'
```

Maybe it should be

```diff
diff --git a/src/sage/misc/sagedoc.py b/src/sage/misc/sagedoc.py
index 2576cf9090..7b3c2630ed 100644
--- a/src/sage/misc/sagedoc.py
+++ b/src/sage/misc/sagedoc.py
`@``@` -958,8 +958,7 `@``@` You can build this with 'sage -docbuild {} html'.""".format(s))
     if not interact:
         return format_text_results()
 
-    html_results = format_search_as_html(title, results, [string] + extras,
-                                         whole_word=whole_word)
+    html_results = format_search_as_html(title, results, string)
 
     from sage.server.support import EMBEDDED_MODE
     if EMBEDDED_MODE:
```


Edit: no, looking at the old code, you're right that we need to use `[string] + extras`. But I think `whole_word` does not belong there.


---

Comment by jhpalmieri created at 2018-08-21 17:51:15

I don't quite see the point behind `format_text_results`. This looks a little simpler to me:

```diff
diff --git a/src/sage/misc/sagedoc.py b/src/sage/misc/sagedoc.py
index 2576cf9090..36c5928efd 100644
--- a/src/sage/misc/sagedoc.py
+++ b/src/sage/misc/sagedoc.py
`@``@` -936,7 +936,7 `@``@` You can build this with 'sage -docbuild {} html'.""".format(s))
                                 if not re.search(extra, match_list):
                                     match_list = None
                         if match_list:
-                            append(filename[strip:].lstrip("/"))
+                            append(filename[strip:].lstrip("/") + "\n")
                     else:
                         match_list = [(lineno, line) for lineno, line in
                                       enumerate(open(filename).read().splitlines(True))
`@``@` -949,14 +949,9 `@``@` You can build this with 'sage -docbuild {} html'.""".format(s))
                             append(':'.join([filename[strip:].lstrip("/"),
                                              str(num + 1), line]))
 
-    def format_text_results():
-        if multiline:
-            return '\n'.join(results)
-        else:
-            return ''.join(results)
-
+    text_results = ''.join(results)
     if not interact:
-        return format_text_results()
+        return text_results
 
     html_results = format_search_as_html(title, results, [string] + extras,
                                          whole_word=whole_word)
`@``@` -968,7 +963,6 `@``@` You can build this with 'sage -docbuild {} html'.""".format(s))
     else:
         # Pass through the IPython pager in a mime bundle
         from IPython.core.page import page
-        text_results = format_text_results()
         if not isinstance(text_results, text_type):
             text_results = text_results.decode('utf-8', 'replace')
 
                                     # formatted for Jupyter use
```

(N.B. This diff doesn't include the previous one for `format_search_as_html`.)


---

Comment by jhpalmieri created at 2018-08-21 17:52:55

See also #26102 for a speed-up for `search_doc`: mainly, don't search the `_static` directories.


---

Comment by jhpalmieri created at 2018-08-21 17:54:53

I personally find that the change `append = results.append` makes the code harder to read without much benefit, but I won't argue about it.


---

Comment by jhpalmieri created at 2018-08-21 18:24:22

With the legacy Sage notebook, searches with `multiline=True` don't print anything with this branch. (To get it to work at all, I removed the `whole_word=whole_word` from the call to `format_results_as_html`, but I made no other changes.) It also prints the output in a slightly funny way: when I evaluate `search_src('Steenrod', multiline=True)`, the old header said `Search Source Code: "Steenrod"`. The new header says `Search Source Code: "Steenrod", "", "", "", "", ""` – it's printing the `extra` terms separately. I can upload screenshots if you want. This is not the highest priority since we're working on deprecating the legacy notebook, but I suppose we shouldn't actively make things worse for it.


---

Comment by jhpalmieri created at 2018-08-21 18:25:50

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-08-22 09:10:24

Oops, I left in a change that I meant to omit (I had started down a path down #26104 but decided to separate off those changes).  That's where all of those reported problems came from.


---

Comment by embray created at 2018-08-22 09:13:40

Replying to [comment:16 jhpalmieri]:
> I don't quite see the point behind `format_text_results`. This looks a little simpler to me:

I think that's probably fine , yeah.  I think when I first added that I didn't fully understand what was going on with `if multiline`.  This code is still a bit confusing in general and should probably be rewritten but that's for another time.


---

Comment by embray created at 2018-08-22 09:20:04

Replying to [comment:18 jhpalmieri]:
> I personally find that the change `append = results.append` makes the code harder to read without much benefit, but I won't argue about it.

This can be a useful optimization in a loop, but in retrospect it will only be called in this case where there is a search match, which is relatively infrequent, so I agree there's not much benefit in this case.


---

Comment by git created at 2018-08-22 09:24:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-08-22 09:24:54

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2018-08-22 18:57:47


```
sage: search_src('IdealMonoid')
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)

  ...

NameError: global name 'format_text_results' is not defined
```

You forgot to delete a line:

```diff
diff --git a/src/sage/misc/sagedoc.py b/src/sage/misc/sagedoc.py
index c77f76f2a5..64f4b8afaa 100644
--- a/src/sage/misc/sagedoc.py
+++ b/src/sage/misc/sagedoc.py
`@``@` -961,7 +961,6 `@``@` You can build this with 'sage -docbuild {} html'.""".format(s))
     else:
         # Pass through the IPython pager in a mime bundle
         from IPython.core.page import page
-        text_results = format_text_results()
         if not isinstance(text_results, text_type):
             text_results = text_results.decode('utf-8', 'replace')
 
```

I would encourage you to actually try a few simple cases before marking it as `needs_review`  ;) 

I wonder if we should put an example with `interact=True` in the doctests to catch this sort of thing; for example:

```diff
diff --git a/src/sage/misc/sagedoc.py b/src/sage/misc/sagedoc.py
index c77f76f2a5..ff8021ffff 100644
--- a/src/sage/misc/sagedoc.py
+++ b/src/sage/misc/sagedoc.py
`@``@` -1143,6 +1143,13 `@``@` def search_src(string, extra1=_, extra2=_, extra3=_, extra4=_,
         matrix/matrix0.pyx:924:        Set the 2 x 2 submatrix of M, starting at row index and column
         matrix/matrix0.pyx:933:        Set the 2 x 3 submatrix of M starting at row index and column
 
+    One example with ``interact=True``::
+
+        sage: search_src('IdealMonoid') # random
+        misc/sagedoc.py:1145:        sage: search_src('IdealMonoid')
+        algebras/letterplace/free_algebra_letterplace.pyx:110:from sage.rings.noncommutative_ideals import IdealMonoid_ncalgebras/letterplace/free_algebra_letterplace.pyx:556:            self.__monoid = IdealMonoid_nc(self)
+        rings/ideal_monoid.py:12:def IdealMonoid(R):
+        ...
     """
     return _search_src_or_doc('src', string, extra1=extra1, extra2=extra2,
                               extra3=extra3, extra4=extra4, extra5=extra5,
```


Also, with `multiline=True`, it still doesn't work with the legacy notebook. The colons which used to be inserted seem to be necessary. You could keep the old code and defer any changes involving `html_results` to #26104.


---

Comment by jhpalmieri created at 2018-08-22 18:57:47

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-08-22 19:19:36

Replying to [comment:26 jhpalmieri]:
> I would encourage you to actually try a few simple cases before marking it as `needs_review`  ;) 

I'm actually now going to have to review the doctests for this code, because I _did_ run the doctests and somehow it passed.  That obviously can't be good.


---

Comment by embray created at 2018-08-22 19:30:05

A related, but actually different problem, is that many of the tests in this module are (unsurprisingly) marked `# long time`, and I wasn't testing with `--long`.


---

Comment by jhpalmieri created at 2018-08-22 19:35:44

Replying to [comment:27 embray]:
> Replying to [comment:26 jhpalmieri]:
> > I would encourage you to actually try a few simple cases before marking it as `needs_review`  ;) 
> 
> I'm actually now going to have to review the doctests for this code, because I _did_ run the doctests and somehow it passed.  That obviously can't be good.

The issue is that (I think) the doctests all use `interact=False`, so they bypass parts of the code. Hence my suggestion for a new doctest.


---

Comment by embray created at 2018-08-22 19:53:07

Replying to [comment:26 jhpalmieri]:
> Also, with `multiline=True`, it still doesn't work with the legacy notebook. The colons which used to be inserted seem to be necessary. You could keep the old code and defer any changes involving `html_results` to #26104.

I'll fix that.  Just another symptom of the bad interface for `format_search_as_html`.


---

Comment by jhpalmieri created at 2018-08-22 19:59:14

Replying to [comment:28 embray]:
> A related, but actually different problem, is that many of the tests in this module are (unsurprisingly) marked `# long time`, and I wasn't testing with `--long`.

Another issue is that some doctests are marked `# optional - dochtml`, and they are not run by default, although I was led to believe in #25345 that they would be. To verify this, I added

```
    sage: 1+1==5 # optional - dochtml
    True
```

to the file, and doctests pass unless I explicitly use the `--optional dochtml` flag. I'll open a new ticket for that: #26110.


---

Comment by git created at 2018-08-22 20:47:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-08-22 20:49:55

Should be fixed.

Given more time, I would like to redo the tests for this module.  While maybe it's OK to have one or two tests that go over all of the sage sources, most of the `# long time` tests in this module should be done away with.  The tests can instead run the search over just a small subset of docs/source to speed them up.


---

Comment by embray created at 2018-08-22 20:51:38

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2018-08-22 21:21:49

Not a big deal, but in the code

```
    for L in results:
        filename = L.strip().split(':', 1)[0]
        if filename:
            files.add(filename)
```

as long as `L` is nonempty and doesn't start with a colon, `filename` will be nonempty as well. Do you expect `L` to start with a colon? I tried a few cases and didn't see that come up.


---

Comment by jhpalmieri created at 2018-08-22 21:39:34

Replying to [comment:33 embray]:
> Should be fixed.
> 
> Given more time, I would like to redo the tests for this module.  While maybe it's OK to have one or two tests that go over all of the sage sources, most of the `# long time` tests in this module should be done away with.  The tests can instead run the search over just a small subset of docs/source to speed them up.

This can wait for another ticket, but if you are thinking about changes like this, then that sounds like a good idea:

```diff
diff --git a/src/sage/misc/sagedoc.py b/src/sage/misc/sagedoc.py
index 94fe79bd6c..539f7420fd 100644
--- a/src/sage/misc/sagedoc.py
+++ b/src/sage/misc/sagedoc.py
`@``@` -782,10 +782,9 `@``@` def _search_src_or_doc(what, string, extra1=_, extra2=_, extra3='',
     EXAMPLES::
 
         sage: from sage.misc.sagedoc import _search_src_or_doc
-        sage: print(_search_src_or_doc('src', r'matrix\(',  # long time random
+        sage: print(_search_src_or_doc('src', r'matrix\(',  # random
         ....:       'incidence_structures', 'self',
-        ....:       '^combinat', interact=False))
-        misc/sagedoc.py:        sage: _search_src_or_doc('src', 'matrix(', 'incidence_structures', 'self', '^combinat', interact=False)
+        ....:       '^combinat', module='sage.combinat', interact=False))
         combinat/designs/incidence_structures.py:        M1 = self.incidence_matrix()
         combinat/designs/incidence_structures.py:        A = self.incidence_matrix()
         combinat/designs/incidence_structures.py:        M = transpose(self.incidence_matrix())
`@``@` -818,7 +817,7 `@``@` def _search_src_or_doc(what, string, extra1=_, extra2=_, extra3='',
 
         sage: from sage.misc.sagedoc import _search_src_or_doc
         sage: _search_src_or_doc('src', r'def _search_src_or_doc\(',
-        ....:                    interact=True)  # long time
+        ....:                    module='sage.misc', interact=True)
         misc/sagedoc.py:...:        def _search_src_or_doc(what, string, extra1=_, extra2=_, extra3='',
     """
 
`@``@` -1061,18 +1060,18 `@``@` def search_src(string, extra1=_, extra2=_, extra3=_, extra4=_,
     The following produces an error because the string 'fetch(' is a
     malformed regular expression::
 
-        sage: print(search_src(" fetch(", "def", interact=False))
+        sage: print(search_src(" fetch(", "def", module="sage.matrix", interact=False))
         Traceback (most recent call last):
         ...
         error: unbalanced parenthesis
 
     To fix this, *escape* the parenthesis with a backslash::
 
-        sage: print(search_src(" fetch\(", "def", interact=False)) # random # long time
+        sage: print(search_src(" fetch\(", "def", module="sage.matrix", interact=False)) # random
         matrix/matrix0.pyx:    cdef fetch(self, key):
         matrix/matrix0.pxd:    cdef fetch(self, key)
 
-        sage: print(search_src(" fetch\(", "def", "pyx", interact=False)) # random # long time
+        sage: print(search_src(" fetch\(", "def", "pyx", module="sage.matrix", interact=False)) # random
         matrix/matrix0.pyx:    cdef fetch(self, key):
 
     As noted above, the search is case-insensitive, but you can make it
```



---

Comment by jhpalmieri created at 2018-08-22 21:44:05

I get one doctest failure when run with `sage -t --long --optional=sage,dochtml`:

```
**********************************************************************
File "src/sage/misc/sagedoc.py", line 1179, in sage.misc.sagedoc.?
Failed example:
    len(search_doc('tree', whole_word=True, interact=False).splitlines()) < 2000  # optional - dochtml, long time
Expected:
    True
Got:
    False
**********************************************************************
```

Is this fixed by #26017? If so, should that ticket be a dependency of this one?


---

Comment by embray created at 2018-08-23 09:26:17

That's fixed by #26017.  Also, I don't get that failure, but as I wrote there that failure can also happen if you just have "junk" in your doc build and goes away with doc-clean.  I don't think it's related to this ticket.


---

Comment by embray created at 2018-08-23 09:34:53

Replying to [comment:35 jhpalmieri]:
> Not a big deal, but in the code
> {{{
>     for L in results:
>         filename = L.strip().split(':', 1)[0]
>         if filename:
>             files.add(filename)
> }}}
> as long as `L` is nonempty and doesn't start with a colon, `filename` will be nonempty as well. Do you expect `L` to start with a colon? I tried a few cases and didn't see that come up.

That's a good point.  The original code also would have broken if a filename started with a colon.  This should never be the case though so I'm not worried about it.


---

Comment by jhpalmieri created at 2018-08-23 17:40:20

Okay, let's close this one. Cleaning up the doctests can happen on another ticket.


---

Comment by jhpalmieri created at 2018-08-23 17:40:20

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-08-24 13:04:30

Agreed--thank you for filling the gap of my shoddy self-review.


---

Comment by vbraun created at 2018-08-26 09:38:08

Resolution: fixed


---

Comment by slelievre created at 2019-04-14 00:11:01

Note: similar issue with "table" at #27656.
