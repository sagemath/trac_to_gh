# Issue 10056: Change import location for decorator_defaults in sagenb interact.py

Issue created by migration from Trac.

Original creator: jason

Original creation time: 2010-10-02 19:44:08

Assignee: jason, was

CC:  jsrn

This line is in the interact.py file in sagenb:


```
from sage.misc.misc import decorator_defaults
```


#9907 moved this to sage.misc.decorators, so the import location should be changed after it is merged.


---

Attachment


---

Comment by mhansen created at 2010-10-09 20:10:01

Changing status from new to needs_review.


---

Comment by zimmerma created at 2012-01-10 10:41:43

Changing status from needs_review to needs_info.


---

Comment by zimmerma created at 2012-01-10 10:41:43

Mike,

I started to review that ticket, but I'm puzzled since

```
sage: from sage.misc.misc import decorator_defaults
```

still works. Shouldn't it fail?

Also, shouldn't the patch include a doctest?

Paul


---

Comment by zimmerma created at 2012-01-10 10:41:43

Changing keywords from "" to "sd35.5".


---

Comment by jsrn created at 2012-01-10 12:23:35

Replying to [comment:3 zimmerma]:
> Mike,
> 
> I started to review that ticket, but I'm puzzled since
> {{{
> sage: from sage.misc.misc import decorator_defaults
> }}}
> still works. Shouldn't it fail?
> 

The reason it doesn't fail is because sage.misc.misc contains an import statement, importing decorator_defaults among other (line 2735). This was introduced in #9907 for backwards compatibility, in case users assumed that these decorators would still be in sage.misc.misc. I assumed this would be a temporary thing, just as for keyword and attribute changes. #9907 was merged 14 months ago, so this is longer than the deprecation lifetime, but on the other hand, no deprecation warning has been issued to users doing the wrong thing for these past 14 months. I'm not sure what is usually done under such circumstances. Also, removing the import statement from sage.misc.misc will result in the pickle jar breaking, and I'm not sure how to remedy that and what consequences it might have. Need expert opinion here.

> Also, shouldn't the patch include a doctest?

Maybe that's just me, but isn't it a bit too much including a doctest just for a relocation of a function? It's still the same function.


---

Comment by zimmerma created at 2012-01-10 13:47:06

Changing status from needs_info to needs_review.


---

Comment by zimmerma created at 2012-01-10 13:47:06

ok I understand. But then I don't know what a reviewer is supposed to do for such a patch.
Anyway I put it back to needs review.

Paul


---

Comment by kcrisman created at 2013-06-18 20:08:14

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2014-12-06 20:38:24

Resolution: invalid


---

Comment by jdemeyer created at 2014-12-06 20:38:24

I'm working on a sagenb pull request.


---

Comment by kcrisman created at 2014-12-06 20:45:50

Resolution changed from invalid to 


---

Comment by kcrisman created at 2014-12-06 20:45:50

Changing status from closed to new.


---

Comment by kcrisman created at 2014-12-06 20:45:50

Hey, only the release manager gets to close a ticket!  ;-)

More seriously, should we remove the 'deprecated' import or is the pickle jar issue mentioned [comment:4 above] serious enough to not do that?  Anyway, better to keep this as an "upstream tracking" ticket, as sagenb will still need to be upgraded for this (and whatever else - https://github.com/sagemath/sagenb/pull/267 could use review, for instance).


---

Comment by jdemeyer created at 2014-12-06 20:52:28

Changing component from notebook to packages: standard.


---

Comment by jdemeyer created at 2014-12-06 20:52:28

OK, I'll rework the ticket.


---

Comment by kcrisman created at 2014-12-08 16:57:59

Okay.  Now if you can at least look at https://github.com/sagemath/sagenb/pull/282 for me (since you already have a working sagenb development environment) I would be grateful.  Given its importance, I'd also appreciate a look at https://github.com/sagemath/sagenb/pull/267 but I know that one requires just slightly more testing, though in reality both patches are fairly trivial.


---

Comment by kcrisman created at 2014-12-22 15:11:56

Changing status from new to needs_review.


---

Comment by kcrisman created at 2014-12-22 15:11:56

For reference to #17490, I used `gnutar` and not the standard Mac `tar`, so hopefully that is resolved temporarily with this sagenb.
----
New commits:


---

Comment by jdemeyer created at 2014-12-22 16:34:01

Replying to [comment:18 kcrisman]:
> For reference to #17490, I used `gnutar` and not the standard Mac `tar`, so hopefully that is resolved temporarily with this sagenb.

At least I see

```
jdemeyer`@`tamiyo:/usr/local/src/sage-git/upstream$ file sagenb-*
sagenb-0.10.8.2.tar: POSIX tar archive (GNU)
sagenb-0.11.0.tar:   POSIX tar archive
sagenb-0.11.1.tar:   POSIX tar archive
sagenb-0.11.2.tar:   POSIX tar archive (GNU)
```



---

Comment by kcrisman created at 2014-12-22 16:35:44

I don't know that this will _fix_ #17490, though I can fix the upstream release instructions.  But that is a good sign.

Anyway, ready for review.  Most stuff is either obvious fixes or stuff that doesn't affect day-to-day notebook operations (the translation stuff).


---

Comment by jdemeyer created at 2014-12-22 16:41:14

I guess a review will be mostly "does it build and pass doctests?", assuming that everything was actually reviewed upstream.


---

Comment by kcrisman created at 2014-12-22 17:11:08

I think it is worth checking whether there is any serious regression of behavior - make sure worksheets still work, test random functionality, etc. as a whole.  Especially worth making sure the _Sage_ tickets mentioned above are actually fixed by the upgrade.  The only possible issue I can foresee is if one of the packages upstream of upstream changed a doctest - I had some bizarre Sage failure related to Babel but I don't see how it could have come from a 'standard' sagenb installation. 

Which reminds me that #17482 is just waiting for your say-so, I made the change you requested.


---

Comment by kcrisman created at 2014-12-22 19:31:53

Can someone check whether this could cause

```
sage -t --long src/sage/symbolic/expression.pyx
Failed example:
    import sagenb.misc.support as s
Expected nothing
Got:
    doctest:14: ImportWarning: Not importing directory '/Users/...sage/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/localedata': missing __init__.py
```

or whether that is just because of my sagenb setup, not a problem per se?  There is a similar failure in 

```
sage -t --long src/sage/combinat/cluster_algebra_quiver/quiver.py
sage -t --long src/sage/misc/dev_tools.py
```

Also the usual

```

File "src/sage/repl/notebook_ipython.py", line 60, in sage.repl.notebook_ipython.have_prerequisites
Failed example:
    from sage.repl.notebook_ipython import have_prerequisites
Expected nothing
Got:
    doctest:57: PowmInsecureWarning: Not using mpz_powm_sec.  You should rebuild using libgmp >= 5 to avoid timing attack vulnerability.

```

also in

```
sage -t --long src/sage/repl/zmq_kernel.py
```

though I don't (yet) have beta4.


---

Comment by jdemeyer created at 2014-12-22 19:43:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-22 19:43:03

Indeed, this is a regression:

```
sage -t --long src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 10721, in sage.symbolic.expression.get_dynamic_class_for_function
Failed example:
    import sagenb.misc.support as s
Expected nothing
Got:
    doctest:14: ImportWarning: Not importing directory '/usr/local/src/sage-git/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/localedata': missing __init__.py
**********************************************************************
```



---

Comment by jdemeyer created at 2014-12-22 19:56:19

See https://github.com/voleg/babel/commit/14796d7f5d3d175b3feac73c2fe8bb87037514d5


---

Comment by kcrisman created at 2014-12-22 20:07:53

I have to admit I cannot figure out what change would have done this; we already have Babel 1.3 in previous Sage.  Maybe an unintended side effect of the changes in imports w.r.t. `sagenb.misc.support`?  Also notice this _only_ happens in doctests, not at the command line.


---

Comment by jdemeyer created at 2014-12-22 20:16:21

Replying to [comment:29 kcrisman]:
> we already have Babel 1.3 in previous Sage
Yes, but the previous Notebook version didn't actually _use_ babel.

> Also notice this _only_ happens in doctests, not at the command line.
Warnings in Python can be enabled/disabled. Apparently, this warning is enabled in doctests (which is probably a good thing) but not in the command line.


---

Comment by kcrisman created at 2014-12-22 20:16:47

Okay, I think it is stuff like https://github.com/sagemath/sagenb/commit/5ffa976e0d76b674e09cd6bddd2d1bd6105f166c - it actually happens in other places we import babel (or `flask.ext.babel`) but those were not doctested in Sage.

Unfortunately, the `util/fetch_deps.py` in sagenb doesn't exactly make it easy to just apply patches.


---

Comment by kcrisman created at 2014-12-22 20:19:08

> Yes, but the previous Notebook version didn't actually use babel.

Sure it did - e.g. https://github.com/sagemath/sagenb/commit/5511a2a01322b66fefdc942e41c4d3d95b1f1677


---

Comment by kcrisman created at 2014-12-22 20:23:44

> Unfortunately, the `util/fetch_deps.py` in sagenb doesn't exactly make it easy to just apply patches.
Worst case we could put this file in the egg at the very end, but that is pretty hackish.


---

Comment by kcrisman created at 2014-12-22 20:24:13

By the way, if you or others could test the _rest_ of the upgrade, or at any rate normal functioning of nb, then we could have just this issue to deal with.


---

Comment by jdemeyer created at 2014-12-22 20:24:33

Yes, I was sloppy. To be more precise: running the doctests with sagenb-0.11.1 didn't import the `babel` package.

To patch `babel`: it's probably best to remove `babel` from `sagenb` and install it like a normal package (this should really be done for all packages inside `sagenb`).


---

Comment by jdemeyer created at 2014-12-22 20:25:13

At least, the `babel` failure is the only doctest failure.


---

Comment by kcrisman created at 2014-12-22 20:30:26

> To patch babel: it's probably best to remove babel from sagenb and install it like a normal package (this should really be done for all packages inside sagenb).

Yes, but easier said than done.  I won't have time for this today, and I'm a little hazy on exactly how all the dependencies for sagenb might get properly imported from Sage itself.

It would also be nice if upstream were responsive at all to their many pull requests (this seems to be the case for several projects pocoo has "taken over").


---

Comment by jdemeyer created at 2014-12-22 20:54:29

Alternatively, if you just want to fix the doctest failure, you could import the `babel` stuff inside the method where you need it.


---

Comment by kcrisman created at 2014-12-22 20:55:59

Hmm, that might be easier.


---

Comment by kcrisman created at 2014-12-22 20:58:59

> Hmm, that might be easier.

Not that I wouldn't be averse to shipping the dependencies separately again!  I just feel like any time I have for sagenb is better used for actual bugs, of which there are already plenty.


---

Comment by kcrisman created at 2014-12-22 21:01:58

> Hmm, that might be easier.
Yes, that fixes it - and since there is only that one function, it's not a problem to import it in that one place.

I'll have a fix and new package in a little bit.  I hope.


---

Comment by git created at 2014-12-22 21:12:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by kcrisman created at 2014-12-22 21:15:00

Okay, it was a forced push but should be okay now.  Same address for the updated spkg.  Here is the diff - once this has positive review I'll push it all back upstream.

```diff
diff --git a/sagenb/misc/misc.py b/sagenb/misc/misc.py
index 88b3eef..5a647f7 100644
--- a/sagenb/misc/misc.py
+++ b/sagenb/misc/misc.py
`@``@` -20,8 +20,6 `@``@` Check that github issue #195 is fixed::
 #############################################################################
 
 from pkg_resources import resource_filename
-from babel import Locale
-from babel.core import UnknownLocaleError
 
 def stub(f):
     def g(*args, **kwds):
`@``@` -517,6 +515,8 `@``@` def translations_path():
     return os.path.join(SAGENB_ROOT, 'translations')
 
 def get_languages():
+    from babel import Locale
+    from babel.core import UnknownLocaleError
     langs = []
     dir_names = [lang for lang in os.listdir(translations_path())
                        if lang != 'en_US']
```



---

Comment by kcrisman created at 2014-12-22 21:15:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-23 21:49:46

All long doctests pass this time.


---

Comment by kcrisman created at 2014-12-24 02:01:16

And I assume that it is still a gnu tar archive?  

Okay, I think anyone can put this to positive review if they don't see any regressions in actual behavior.


---

Comment by kcrisman created at 2014-12-24 02:49:30

I'm tagging this upstream, so any additional problems will have to be 1) after Christmas and 2) version 0.11.3.


---

Comment by jdemeyer created at 2014-12-24 09:11:10

The tarball is made correctly, I don't get any warnings when extracting it.

I also checked that the tarball contents matches the git repo. I noticed a few missing files: [https://github.com/sagemath/sagenb/issues/327](https://github.com/sagemath/sagenb/issues/327) I consider this a serious issue (especially with the `COPYING` file missing), but not serious enough to block this ticket.


---

Comment by jdemeyer created at 2014-12-24 09:33:49

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-12-24 09:33:49

* #11275: fixed
* #8738: fixed
* #8427: fixed
* #17490: fixed


---

Comment by jdemeyer created at 2014-12-24 09:49:10

Changing priority from major to blocker.


---

Comment by vbraun created at 2015-01-02 15:46:34

Resolution: fixed
