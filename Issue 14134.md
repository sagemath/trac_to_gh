# Issue 14134: Fix debug() in notebook

Issue created by migration from https://trac.sagemath.org/ticket/14338

Original creator: nbruin

Original creation time: 2013-03-22 19:02:36

Assignee: tbd

On [sage-devel](https://groups.google.com/group/sage-devel/browse_thread/thread/ec5afc6027106c52?hl=en) it was observed that at least in 5.7 and 5.8 we have in the notebook:

```
sage: 1/0
ZeroDivideError
```

(as expected)

```
sage: debug()
IndexError: string index out of range
```

due to `inspect.getinnerframes` failing on a seemingly otherwise valid traceback object.


---

Comment by nbruin created at 2013-03-22 19:05:36

strip notebook frames prior to processing


---

Comment by nbruin created at 2013-03-22 19:09:43

Changing component from PLEASE CHANGE to notebook.


---

Comment by nbruin created at 2013-03-22 19:09:43

Changing type from PLEASE CHANGE to defect.


---

Attachment

One fix is to avoid the frames on which `inspect.findsource` chokes, since those are frames that have to do with the notebook, not with the user code, so they don't get displayed anyway.

The other fix would be to

`python/inspect.py:526`

```diff 
     file = getfile(object)
     sourcefile = getsourcefile(object)
-    if not sourcefile and file[0] + file[-1] != '<>':
+    if not sourcefile and (not file or file[0] + file[-1] != '<>'):
         raise IOError('source code not available')
     file = sourcefile if sourcefile else file
```

but that's a change to python, not to sage.


---

Comment by nbruin created at 2013-03-22 19:09:43

Changing status from new to needs_review.


---

Comment by novoselt created at 2013-03-22 20:23:25

Changing status from needs_review to positive_review.


---

Comment by novoselt created at 2013-03-22 20:23:25

Thanks for looking into it! The patch works for me and does what was done before in a slightly different way.


---

Comment by novoselt created at 2013-03-23 01:13:00

OK, I was too fast:

```
**********************************************************************
5 items had failures:
   2 of   4 in sage.interacts.debugger.Debug
   1 of   3 in sage.interacts.debugger.Debug.__init__
   2 of   4 in sage.interacts.debugger.Debug.curframe
   1 of   4 in sage.interacts.debugger.Debug.evaluate
   3 of   7 in sage.interacts.debugger.Debug.listing
    [23 tests, 9 failures, 1.7 s]
----------------------------------------------------------------------
sage -t --long sage/interacts/debugger.py  # 9 doctests failed
----------------------------------------------------------------------
```



---

Comment by novoselt created at 2013-03-23 01:13:00

Changing status from positive_review to needs_work.


---

Attachment

fix doctest


---

Comment by nbruin created at 2013-03-23 03:56:40

Changing status from needs_work to needs_review.


---

Comment by nbruin created at 2013-03-23 03:56:40

OK, the doctest uses a stacktrace that's shallower than will ever happen in the notebook, so when we strip off the 5 outer frames that should be removed in the notebook, we have nothing left (hence the error). Attached patch makes a deeper backtrace so that stripping off the first 5 still leaves something to test. Doctest text needs to be changed in some spots.


---

Comment by novoselt created at 2013-03-24 05:20:34

Looks good and all long tests pass now.


---

Comment by novoselt created at 2013-03-24 05:20:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-03-26 22:32:01

Resolution: fixed
