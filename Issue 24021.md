# Issue 24021: py3: support <type '...'> expected output in doctests on Python 3

Issue created by migration from https://trac.sagemath.org/ticket/24258

Original creator: embray

Original creation time: 2017-11-21 12:25:39

CC:  chapoton

On Python 3 all classes, including built-in types, are represented as `<class '...'>` instead of `<type '...'>` as Python 2 uses for built-in types.

This normalizes the expected doctest output on Python 3 to account for this difference.

Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.

This replaces #24228, #24229, #24230, and #24233.


---

Comment by embray created at 2017-11-21 12:26:26

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-11-22 08:07:38

Replying to [ticket:24258 embray]:
> Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.

Wouldn't it make sense to do that now, i.e. to replace `<type ` by `<class `? That would be more future-proof.


---

Comment by embray created at 2017-11-22 12:52:02

Replying to [comment:3 jdemeyer]:
> Replying to [ticket:24258 embray]:
> > Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.
> 
> Wouldn't it make sense to do that now, i.e. to replace `<type ` by `<class `? That would be more future-proof.

*nod* that was my original plan, but I decided:

a) This would be a less disruptive change for now--just a small change in one module vs. a small change in many

b) For the time being Python 2 is still the default for Sage, so changing all the existing tests (particularly "EXAMPLE" docs) could confuse readers.


---

Comment by jdemeyer created at 2017-11-28 10:51:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-28 10:51:33

Lots of breakage on the patchbot.


---

Comment by jdemeyer created at 2017-11-28 10:56:12

Replying to [comment:4 embray]:

> a) This would be a less disruptive change for now--just a small change in one module vs. a small change in many

If you plan a disruptive change anyway when we switch to Python 3, that argument makes little sense. Why is a disruptive change later better than a disruptive change now.

> b) For the time being Python 2 is still the default for Sage, so changing all the existing tests (particularly "EXAMPLE" docs) could confuse readers.

Fair enough.


---

Comment by embray created at 2017-11-28 11:06:21

I believe most of the (relevant) failures are actually due to #24257, where they've since been fixed.  I can rebase this on top of that....


---

Comment by git created at 2017-11-28 11:12:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-11-28 11:17:31

A similar, though not exactly the same difference I've noticed is that on Python 3 unbound methods of classes (which are just normal functions) are repr'd with their `__qualname__` which includes the class name.  E.g.


```
>>> class Foo:
...     def a(self): pass
...
>>> Foo.a
<function Foo.a at 0x7fe3d04c9b20>
```


So some tests that happen to rely on such output fail on python 3.

The tests could be rewritten, but it might be nice to automatically account for this difference.  In principle there's a little advantage to having the `__qualname__` in the output since we can also also see in what class the function was defined, but in the meantime we don't lose anything over what we already have by ignoring it.

I could either add that to this ticket, or add a new one.  It might be worth adding to this one since the same issue applies to nested classes.


---

Comment by embray created at 2017-11-28 13:47:55

Replying to [comment:9 embray]:
> I could either add that to this ticket, or add a new one.  It might be worth adding to this one since the same issue applies to nested classes.

I implemented a workaround for this, but in implementation it's distinct enough from this issue that I'll just open a separate ticket for this once I'm confident that it's ready.


---

Comment by embray created at 2018-01-11 12:22:16

I don't think this actually needs any new work--it's been working fine for me on my python 3 branch for some time.  The previous patchbot failures were due to #24257 which is now closed.


---

Comment by embray created at 2018-01-11 12:22:16

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-01-11 12:23:01

Would be nice to get this done--I have a number of other test output normalizations that I've added since this one.


---

Comment by jdemeyer created at 2018-01-11 13:13:11

Please add a test showing how `normalize_type_repr` works when given a more complicated expression. Something like:

```
sage: L = [Integer, float]
sage: normalize_type_repr(repr(L))
```



---

Comment by embray created at 2018-01-11 14:14:44

Sure--let me make sure that actually works in the first place (it should--I think I've already encountered some examples like that)


---

Comment by embray created at 2018-01-11 14:14:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-01-11 15:47:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-11 15:47:33

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-01-12 09:23:42

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-01-12 09:23:42

Patchbot complains about docbuild.


---

Comment by jdemeyer created at 2018-01-12 09:26:46

If I understand things correctly, this ticket ensures that both the following doctests would pass on Python 3:

```
sage: int
<class 'int'>
```

and

```
sage: int
<type 'int'>
```

but on Python 2 only

```
sage: int
<type 'int'>
```

would be accepted. Is that right?

I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make _new_ doctests more future-proof by using `<class` instead of `<type`.


---

Comment by chapoton created at 2018-01-16 09:39:01

I fixed the doc
----
New commits:


---

Comment by chapoton created at 2018-01-16 10:15:42

Replying to [comment:19 jdemeyer]:
> If I understand things correctly, this ticket ensures that both the following doctests would pass on Python 3:
> {{{
> sage: int
> <class 'int'>
> }}}
> and
> {{{
> sage: int
> <type 'int'>
> }}}
> but on Python 2 only
> {{{
> sage: int
> <type 'int'>
> }}}
> would be accepted. Is that right?
> 
> I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make _new_ doctests more future-proof by using `<class` instead of `<type`.

We can easily make new doctests future-proof by simply using `<... 'int'>`. There is a patchbot plugin that checks for that.


---

Comment by embray created at 2018-01-16 14:01:04

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-01-16 14:01:04

Replying to [comment:19 jdemeyer]:
> I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make _new_ doctests more future-proof by using `<class` instead of `<type`.

I thought I already addressed this, but it doesn't make enormous sense to write new doctests against Python 3-style output as long as Sage's default python remains python 2--that's what the documentation should be written against.  When Sage switches to python 3 as the default python, then it makes sense to make mass replacements on the documentation too, and not until then.

I wouldn't be opposed to making the output checker flexible in both cases, but I don't think there's any good reason to right now either.


---

Comment by vbraun created at 2018-01-18 18:09:22

Resolution: fixed


---

Comment by chapoton created at 2018-09-07 09:50:37

This seems not to work on

```
sage -t --long src/sage/rings/universal_cyclotomic_field.py  # 1 doctest failed
```

with sage 8.4.b4.


---

Comment by embray created at 2018-09-07 10:18:37

Replying to [comment:25 chapoton]:
> This seems not to work on
> {{{
> sage -t --long src/sage/rings/universal_cyclotomic_field.py  # 1 doctest failed
> }}}
> with sage 8.4.b4.

It's because the `<type ...>` repr is split onto multiple lines, which is not supported.  You could either change the regexp to be multi-line (but this introduces more complications), or just fix that test to not split `<type ...>` across lines.
