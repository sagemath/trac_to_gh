# Issue 24021: py3: support <type '...'> expected output in doctests on Python 3

archive/issues_024021.json:
```json
{
    "body": "CC:  chapoton\n\nOn Python 3 all classes, including built-in types, are represented as `<class '...'>` instead of `<type '...'>` as Python 2 uses for built-in types.\n\nThis normalizes the expected doctest output on Python 3 to account for this difference.\n\nWhenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.\n\nThis replaces #24228, #24229, #24230, and #24233.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24258\n\n",
    "created_at": "2017-11-21T12:25:39Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: support <type '...'> expected output in doctests on Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24021",
    "user": "embray"
}
```
CC:  chapoton

On Python 3 all classes, including built-in types, are represented as `<class '...'>` instead of `<type '...'>` as Python 2 uses for built-in types.

This normalizes the expected doctest output on Python 3 to account for this difference.

Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.

This replaces #24228, #24229, #24230, and #24233.

Issue created by migration from https://trac.sagemath.org/ticket/24258





---

archive/issue_comments_336661.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-21T12:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336661",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336662.json:
```json
{
    "body": "Replying to [ticket:24258 embray]:\n> Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.\n\nWouldn't it make sense to do that now, i.e. to replace `<type ` by `<class `? That would be more future-proof.",
    "created_at": "2017-11-22T08:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336662",
    "user": "jdemeyer"
}
```

Replying to [ticket:24258 embray]:
> Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.

Wouldn't it make sense to do that now, i.e. to replace `<type ` by `<class `? That would be more future-proof.



---

archive/issue_comments_336663.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> Replying to [ticket:24258 embray]:\n> > Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.\n> \n> Wouldn't it make sense to do that now, i.e. to replace `<type ` by `<class `? That would be more future-proof.\n\n*nod* that was my original plan, but I decided:\n\na) This would be a less disruptive change for now--just a small change in one module vs. a small change in many\n\nb) For the time being Python 2 is still the default for Sage, so changing all the existing tests (particularly \"EXAMPLE\" docs) could confuse readers.",
    "created_at": "2017-11-22T12:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336663",
    "user": "embray"
}
```

Replying to [comment:3 jdemeyer]:
> Replying to [ticket:24258 embray]:
> > Whenever Sage switches to Python 3 as a default it would be simple to also reverse the sense of this normalization, and update the doctests to expect `<class '...'>`.
> 
> Wouldn't it make sense to do that now, i.e. to replace `<type ` by `<class `? That would be more future-proof.

*nod* that was my original plan, but I decided:

a) This would be a less disruptive change for now--just a small change in one module vs. a small change in many

b) For the time being Python 2 is still the default for Sage, so changing all the existing tests (particularly "EXAMPLE" docs) could confuse readers.



---

archive/issue_comments_336664.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-28T10:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336664",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336665.json:
```json
{
    "body": "Lots of breakage on the patchbot.",
    "created_at": "2017-11-28T10:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336665",
    "user": "jdemeyer"
}
```

Lots of breakage on the patchbot.



---

archive/issue_comments_336666.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n\n> a) This would be a less disruptive change for now--just a small change in one module vs. a small change in many\n\nIf you plan a disruptive change anyway when we switch to Python 3, that argument makes little sense. Why is a disruptive change later better than a disruptive change now.\n\n> b) For the time being Python 2 is still the default for Sage, so changing all the existing tests (particularly \"EXAMPLE\" docs) could confuse readers.\n\nFair enough.",
    "created_at": "2017-11-28T10:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336666",
    "user": "jdemeyer"
}
```

Replying to [comment:4 embray]:

> a) This would be a less disruptive change for now--just a small change in one module vs. a small change in many

If you plan a disruptive change anyway when we switch to Python 3, that argument makes little sense. Why is a disruptive change later better than a disruptive change now.

> b) For the time being Python 2 is still the default for Sage, so changing all the existing tests (particularly "EXAMPLE" docs) could confuse readers.

Fair enough.



---

archive/issue_comments_336667.json:
```json
{
    "body": "I believe most of the (relevant) failures are actually due to #24257, where they've since been fixed.  I can rebase this on top of that....",
    "created_at": "2017-11-28T11:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336667",
    "user": "embray"
}
```

I believe most of the (relevant) failures are actually due to #24257, where they've since been fixed.  I can rebase this on top of that....



---

archive/issue_comments_336668.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T11:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336668",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336669.json:
```json
{
    "body": "A similar, though not exactly the same difference I've noticed is that on Python 3 unbound methods of classes (which are just normal functions) are repr'd with their `__qualname__` which includes the class name.  E.g.\n\n\n```\n>>> class Foo:\n...     def a(self): pass\n...\n>>> Foo.a\n<function Foo.a at 0x7fe3d04c9b20>\n```\n\n\nSo some tests that happen to rely on such output fail on python 3.\n\nThe tests could be rewritten, but it might be nice to automatically account for this difference.  In principle there's a little advantage to having the `__qualname__` in the output since we can also also see in what class the function was defined, but in the meantime we don't lose anything over what we already have by ignoring it.\n\nI could either add that to this ticket, or add a new one.  It might be worth adding to this one since the same issue applies to nested classes.",
    "created_at": "2017-11-28T11:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336669",
    "user": "embray"
}
```

A similar, though not exactly the same difference I've noticed is that on Python 3 unbound methods of classes (which are just normal functions) are repr'd with their `__qualname__` which includes the class name.  E.g.


```
>>> class Foo:
...     def a(self): pass
...
>>> Foo.a
<function Foo.a at 0x7fe3d04c9b20>
```


So some tests that happen to rely on such output fail on python 3.

The tests could be rewritten, but it might be nice to automatically account for this difference.  In principle there's a little advantage to having the `__qualname__` in the output since we can also also see in what class the function was defined, but in the meantime we don't lose anything over what we already have by ignoring it.

I could either add that to this ticket, or add a new one.  It might be worth adding to this one since the same issue applies to nested classes.



---

archive/issue_comments_336670.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> I could either add that to this ticket, or add a new one.  It might be worth adding to this one since the same issue applies to nested classes.\n\nI implemented a workaround for this, but in implementation it's distinct enough from this issue that I'll just open a separate ticket for this once I'm confident that it's ready.",
    "created_at": "2017-11-28T13:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336670",
    "user": "embray"
}
```

Replying to [comment:9 embray]:
> I could either add that to this ticket, or add a new one.  It might be worth adding to this one since the same issue applies to nested classes.

I implemented a workaround for this, but in implementation it's distinct enough from this issue that I'll just open a separate ticket for this once I'm confident that it's ready.



---

archive/issue_comments_336671.json:
```json
{
    "body": "I don't think this actually needs any new work--it's been working fine for me on my python 3 branch for some time.  The previous patchbot failures were due to #24257 which is now closed.",
    "created_at": "2018-01-11T12:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336671",
    "user": "embray"
}
```

I don't think this actually needs any new work--it's been working fine for me on my python 3 branch for some time.  The previous patchbot failures were due to #24257 which is now closed.



---

archive/issue_comments_336672.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-11T12:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336672",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336673.json:
```json
{
    "body": "Would be nice to get this done--I have a number of other test output normalizations that I've added since this one.",
    "created_at": "2018-01-11T12:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336673",
    "user": "embray"
}
```

Would be nice to get this done--I have a number of other test output normalizations that I've added since this one.



---

archive/issue_comments_336674.json:
```json
{
    "body": "Please add a test showing how `normalize_type_repr` works when given a more complicated expression. Something like:\n\n```\nsage: L = [Integer, float]\nsage: normalize_type_repr(repr(L))\n```\n",
    "created_at": "2018-01-11T13:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336674",
    "user": "jdemeyer"
}
```

Please add a test showing how `normalize_type_repr` works when given a more complicated expression. Something like:

```
sage: L = [Integer, float]
sage: normalize_type_repr(repr(L))
```




---

archive/issue_comments_336675.json:
```json
{
    "body": "Sure--let me make sure that actually works in the first place (it should--I think I've already encountered some examples like that)",
    "created_at": "2018-01-11T14:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336675",
    "user": "embray"
}
```

Sure--let me make sure that actually works in the first place (it should--I think I've already encountered some examples like that)



---

archive/issue_comments_336676.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-11T14:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336676",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336677.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-11T15:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336677",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336678.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-11T15:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336678",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336679.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-12T09:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336679",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336680.json:
```json
{
    "body": "Patchbot complains about docbuild.",
    "created_at": "2018-01-12T09:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336680",
    "user": "jdemeyer"
}
```

Patchbot complains about docbuild.



---

archive/issue_comments_336681.json:
```json
{
    "body": "If I understand things correctly, this ticket ensures that both the following doctests would pass on Python 3:\n\n```\nsage: int\n<class 'int'>\n```\n\nand\n\n```\nsage: int\n<type 'int'>\n```\n\nbut on Python 2 only\n\n```\nsage: int\n<type 'int'>\n```\n\nwould be accepted. Is that right?\n\nI would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make *new* doctests more future-proof by using `<class` instead of `<type`.",
    "created_at": "2018-01-12T09:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336681",
    "user": "jdemeyer"
}
```

If I understand things correctly, this ticket ensures that both the following doctests would pass on Python 3:

```
sage: int
<class 'int'>
```

and

```
sage: int
<type 'int'>
```

but on Python 2 only

```
sage: int
<type 'int'>
```

would be accepted. Is that right?

I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make *new* doctests more future-proof by using `<class` instead of `<type`.



---

archive/issue_comments_336682.json:
```json
{
    "body": "I fixed the doc\n----\nNew commits:",
    "created_at": "2018-01-16T09:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336682",
    "user": "chapoton"
}
```

I fixed the doc
----
New commits:



---

archive/issue_comments_336683.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> If I understand things correctly, this ticket ensures that both the following doctests would pass on Python 3:\n> {{{\n> sage: int\n> <class 'int'>\n> }}}\n> and\n> {{{\n> sage: int\n> <type 'int'>\n> }}}\n> but on Python 2 only\n> {{{\n> sage: int\n> <type 'int'>\n> }}}\n> would be accepted. Is that right?\n> \n> I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make *new* doctests more future-proof by using `<class` instead of `<type`.\n\nWe can easily make new doctests future-proof by simply using `<... 'int'>`. There is a patchbot plugin that checks for that.",
    "created_at": "2018-01-16T10:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336683",
    "user": "chapoton"
}
```

Replying to [comment:19 jdemeyer]:
> If I understand things correctly, this ticket ensures that both the following doctests would pass on Python 3:
> {{{
> sage: int
> <class 'int'>
> }}}
> and
> {{{
> sage: int
> <type 'int'>
> }}}
> but on Python 2 only
> {{{
> sage: int
> <type 'int'>
> }}}
> would be accepted. Is that right?
> 
> I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make *new* doctests more future-proof by using `<class` instead of `<type`.

We can easily make new doctests future-proof by simply using `<... 'int'>`. There is a patchbot plugin that checks for that.



---

archive/issue_comments_336684.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-01-16T14:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336684",
    "user": "embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_336685.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make *new* doctests more future-proof by using `<class` instead of `<type`.\n\nI thought I already addressed this, but it doesn't make enormous sense to write new doctests against Python 3-style output as long as Sage's default python remains python 2--that's what the documentation should be written against.  When Sage switches to python 3 as the default python, then it makes sense to make mass replacements on the documentation too, and not until then.\n\nI wouldn't be opposed to making the output checker flexible in both cases, but I don't think there's any good reason to right now either.",
    "created_at": "2018-01-16T14:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336685",
    "user": "embray"
}
```

Replying to [comment:19 jdemeyer]:
> I would very much prefer to accept `<class 'int'>` on Python 2 too. That way, we could at least make *new* doctests more future-proof by using `<class` instead of `<type`.

I thought I already addressed this, but it doesn't make enormous sense to write new doctests against Python 3-style output as long as Sage's default python remains python 2--that's what the documentation should be written against.  When Sage switches to python 3 as the default python, then it makes sense to make mass replacements on the documentation too, and not until then.

I wouldn't be opposed to making the output checker flexible in both cases, but I don't think there's any good reason to right now either.



---

archive/issue_comments_336686.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-18T18:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336686",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_336687.json:
```json
{
    "body": "This seems not to work on\n\n```\nsage -t --long src/sage/rings/universal_cyclotomic_field.py  # 1 doctest failed\n```\n\nwith sage 8.4.b4.",
    "created_at": "2018-09-07T09:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336687",
    "user": "chapoton"
}
```

This seems not to work on

```
sage -t --long src/sage/rings/universal_cyclotomic_field.py  # 1 doctest failed
```

with sage 8.4.b4.



---

archive/issue_comments_336688.json:
```json
{
    "body": "Replying to [comment:25 chapoton]:\n> This seems not to work on\n> {{{\n> sage -t --long src/sage/rings/universal_cyclotomic_field.py  # 1 doctest failed\n> }}}\n> with sage 8.4.b4.\n\nIt's because the `<type ...>` repr is split onto multiple lines, which is not supported.  You could either change the regexp to be multi-line (but this introduces more complications), or just fix that test to not split `<type ...>` across lines.",
    "created_at": "2018-09-07T10:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24021#issuecomment-336688",
    "user": "embray"
}
```

Replying to [comment:25 chapoton]:
> This seems not to work on
> {{{
> sage -t --long src/sage/rings/universal_cyclotomic_field.py  # 1 doctest failed
> }}}
> with sage 8.4.b4.

It's because the `<type ...>` repr is split onto multiple lines, which is not supported.  You could either change the regexp to be multi-line (but this introduces more complications), or just fix that test to not split `<type ...>` across lines.
