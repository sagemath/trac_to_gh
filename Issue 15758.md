# Issue 15758: Python 3 preparation: Adapt to the changed integer division semantics (/ vs. //)

archive/issues_015758.json:
```json
{
    "body": "CC:  embray jdemeyer fbissey tscrim jhpalmieri vklein\n\nKeywords: python3\n\nThe new semantics can be enabled in Python 2 with `from __future__ import division`.\n\nThis will require checking where to replace `/` by `//`\n\nChanges according to `libfuturize/fixes/division.py`:\n\n```\nAdd\nfrom __future__ import division\n```\n\n\nThis ticket is tracked as a dependency of meta-ticket ticket:15980.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15995\n\n",
    "created_at": "2014-03-20T15:40:59Z",
    "labels": [
        "distribution",
        "major",
        "enhancement"
    ],
    "title": "Python 3 preparation: Adapt to the changed integer division semantics (/ vs. //)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15758",
    "user": "wluebbe"
}
```
CC:  embray jdemeyer fbissey tscrim jhpalmieri vklein

Keywords: python3

The new semantics can be enabled in Python 2 with `from __future__ import division`.

This will require checking where to replace `/` by `//`

Changes according to `libfuturize/fixes/division.py`:

```
Add
from __future__ import division
```


This ticket is tracked as a dependency of meta-ticket ticket:15980.

Issue created by migration from https://trac.sagemath.org/ticket/15995





---

archive/issue_comments_204065.json:
```json
{
    "body": "The first attempt went like this: `futurize -w -f division src/`.\n\nThis added `from __future__ import division` to 411 py modules. \n\nRunning the doctests `./sage -t -p --all` gave billions of lines of doctest failures ... - I had to cancel the run. \n\nBut this result should not have come as a surprise because I had not fixed anything yet ...\n\nThe task is to identify those `/` and `/=` that operate solely on ints and longs and then change them to `//` and `//=`.\n\nThe Python source distribution has a script `Tools/scripts/finddiv.py` which has identified similar 416 py modules as the above programs (it performs clearly better as a simple grep since it tokenizes the code). It also outputs those 2625 lines that contain the / and /= operators - but for **all** types of operands (the analysis is purely syntactical).\n\nThere is another script `Tools/scripts/fixdiv.py` that uses the output of \n\n`python -Qwarnall yourscripts 2>the-warnings` to create a simple (commented) patch file for those division operators that only deal with ints and longs. This is possible since it uses the type information obtained by running the Python programs. \nThis should be much more useful!\n\nBut currently I am stuck:\n* I don't know how to pass the option `-Qwarnall` to the Python interpreter when running the doctests\n* and the warning output screws up the doctests.\nIt may be possible to use the `warnings` module to write the warnings to a file instead if stderr (by replacing `warnings.showwarning()` with a custom function).",
    "created_at": "2014-03-31T14:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204065",
    "user": "wluebbe"
}
```

The first attempt went like this: `futurize -w -f division src/`.

This added `from __future__ import division` to 411 py modules. 

Running the doctests `./sage -t -p --all` gave billions of lines of doctest failures ... - I had to cancel the run. 

But this result should not have come as a surprise because I had not fixed anything yet ...

The task is to identify those `/` and `/=` that operate solely on ints and longs and then change them to `//` and `//=`.

The Python source distribution has a script `Tools/scripts/finddiv.py` which has identified similar 416 py modules as the above programs (it performs clearly better as a simple grep since it tokenizes the code). It also outputs those 2625 lines that contain the / and /= operators - but for **all** types of operands (the analysis is purely syntactical).

There is another script `Tools/scripts/fixdiv.py` that uses the output of 

`python -Qwarnall yourscripts 2>the-warnings` to create a simple (commented) patch file for those division operators that only deal with ints and longs. This is possible since it uses the type information obtained by running the Python programs. 
This should be much more useful!

But currently I am stuck:
* I don't know how to pass the option `-Qwarnall` to the Python interpreter when running the doctests
* and the warning output screws up the doctests.
It may be possible to use the `warnings` module to write the warnings to a file instead if stderr (by replacing `warnings.showwarning()` with a custom function).



---

archive/issue_comments_204066.json:
```json
{
    "body": "I finally manage to run the doctests with the Python command line option `-3`. This is how I did it:\n\n```\n...:~/sage-6.2.beta8$ . src/bin/sage-env\n...:~/sage-6.2.beta8$ python -3 ./local/bin/sage-runtests  src/sage 1>logs/sage-warnings3-stdout.txt 2>logs/sage-warnings3-stderr.txt\n```\n\nA summary of `stderr` output is\n\n```\nnbr_lines= 133\n   83  Overriding __eq__ blocks inheritance of __hash__ in 3.x\n   27  classic int division\n   18  type inequality comparisons not supported in 3.x\n    2  the cmp argument is not supported in 3.x\n    1  execfile() not supported in 3.x; use exec()\n    1  file.softspace not supported in 3.x\n    1  tmpfile has been removed in 3.x; use the tempfile module\n```\n\nand of `stdout`\n\n```\nnbr_lines= 39630\n19386  type inequality comparisons not supported in 3.x\n 8779  Overriding __eq__ blocks inheritance of __hash__ in 3.x\n 4039  CObject type is not supported in 3.x. Please use capsule objects instead.\n 2139  reduce() not supported in 3.x; use functools.reduce()\n 2017  classic int division\n 2000  the cmp argument is not supported in 3.x\n  789  comparing unequal types not supported in 3.x\n  262  __getitem__ not supported for exception classes in 3.x; use args attribute\n   88  sys.exc_clear() not supported in 3.x; use except clauses\n   57  in 3.x, __getslice__ has been removed; use __getitem__\n   14  file.softspace not supported in 3.x\n   12  the commands module has been removed in Python 3.0; use the subprocess module instead\n    7  execfile() not supported in 3.x; use exec()\n    7  tmpfile has been removed in 3.x; use the tempfile module\n    5  dict inequality comparisons not supported in 3.x\n    3  \n    2  Use the Permutations object instead.\n    2  This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.\n    2  to_permutation() is deprecated. Use instead reading_word_permutation()\n    2  this class is deprecated. Use RibbonShapedTableau instead\n    2  BaseException.message has been deprecated as of Python 2.6\n    2  The 'new' module has been removed in Python 3.0; use the 'types' module instead.\n    2  this is done automatically by the doctest framework\n    2  derangements() is deprecated. Use Derangements instead.\n    1  The output of Transducer.cartesian_product will change. Please use Transducer.intersection for the original output.\n    1  Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\n    1  This method is deprecated. Use triangulate() instead.\n    1  In 3.x, reload() is renamed to imp.reload()\n    1  dict.has_key() not supported in 3.x; use the in operator\n    1  The output of\n    1  Substitution using\n    1  This method is deprecated. Use triangulate().simplicial_complex() instead.\n    1  Variable of integration should be specified explicitly.\n    1  OrderedAlphabet is deprecated; use Alphabet instead.\n```\n\nUnfortunately typical `stdout` printout looks like\n\n```\n**********************************************************************\nFile \"src/sage/modular/modsym/space.py\", line 929, in sage.modular.modsym.space.ModularSymbolsSpace._q_expansion_module\nFailed example:\n    ModularSymbols(11, 2, base_ring=GF(4,'a')).cuspidal_submodule()._q_expansion_module(prec=4, algorithm=\"hecke\")\nExpected:\n    Vector space of degree 4 and dimension 1 over Finite Field in a of size 2^2\n    Basis matrix:\n    [0 1 0 1]\nGot:\n    doctest:127: DeprecationWarning: type inequality comparisons not supported in 3.x\n    doctest:511: DeprecationWarning: classic int division\n    doctest:250: DeprecationWarning: type inequality comparisons not supported in 3.x\n    doctest:585: DeprecationWarning: classic int division\n    doctest:286: DeprecationWarning: classic int division\n    doctest:396: DeprecationWarning: classic int division\n    doctest:6464: DeprecationWarning: classic int division\n    Vector space of degree 4 and dimension 1 over Finite Field in a of size 2^2\n    Basis matrix:\n    [0 1 0 1]\n**********************************************************************\n```\n\nand I don't know how to correlate line likes `doctest:511` with the original line.\n\nThe line in stderr are more useful, but are few and far between\n\n```\n~/sage-6.2.beta8/local/lib/python2.7/site-packages/sage/groups/perm_gps/cubegroup.py:368: DeprecationWarning: classic int division\n  2:  [1/2,3/2,5/2], #  ub\n```\n",
    "created_at": "2014-04-24T12:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204066",
    "user": "wluebbe"
}
```

I finally manage to run the doctests with the Python command line option `-3`. This is how I did it:

```
...:~/sage-6.2.beta8$ . src/bin/sage-env
...:~/sage-6.2.beta8$ python -3 ./local/bin/sage-runtests  src/sage 1>logs/sage-warnings3-stdout.txt 2>logs/sage-warnings3-stderr.txt
```

A summary of `stderr` output is

```
nbr_lines= 133
   83  Overriding __eq__ blocks inheritance of __hash__ in 3.x
   27  classic int division
   18  type inequality comparisons not supported in 3.x
    2  the cmp argument is not supported in 3.x
    1  execfile() not supported in 3.x; use exec()
    1  file.softspace not supported in 3.x
    1  tmpfile has been removed in 3.x; use the tempfile module
```

and of `stdout`

```
nbr_lines= 39630
19386  type inequality comparisons not supported in 3.x
 8779  Overriding __eq__ blocks inheritance of __hash__ in 3.x
 4039  CObject type is not supported in 3.x. Please use capsule objects instead.
 2139  reduce() not supported in 3.x; use functools.reduce()
 2017  classic int division
 2000  the cmp argument is not supported in 3.x
  789  comparing unequal types not supported in 3.x
  262  __getitem__ not supported for exception classes in 3.x; use args attribute
   88  sys.exc_clear() not supported in 3.x; use except clauses
   57  in 3.x, __getslice__ has been removed; use __getitem__
   14  file.softspace not supported in 3.x
   12  the commands module has been removed in Python 3.0; use the subprocess module instead
    7  execfile() not supported in 3.x; use exec()
    7  tmpfile has been removed in 3.x; use the tempfile module
    5  dict inequality comparisons not supported in 3.x
    3  
    2  Use the Permutations object instead.
    2  This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    2  to_permutation() is deprecated. Use instead reading_word_permutation()
    2  this class is deprecated. Use RibbonShapedTableau instead
    2  BaseException.message has been deprecated as of Python 2.6
    2  The 'new' module has been removed in Python 3.0; use the 'types' module instead.
    2  this is done automatically by the doctest framework
    2  derangements() is deprecated. Use Derangements instead.
    1  The output of Transducer.cartesian_product will change. Please use Transducer.intersection for the original output.
    1  Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
    1  This method is deprecated. Use triangulate() instead.
    1  In 3.x, reload() is renamed to imp.reload()
    1  dict.has_key() not supported in 3.x; use the in operator
    1  The output of
    1  Substitution using
    1  This method is deprecated. Use triangulate().simplicial_complex() instead.
    1  Variable of integration should be specified explicitly.
    1  OrderedAlphabet is deprecated; use Alphabet instead.
```

Unfortunately typical `stdout` printout looks like

```
**********************************************************************
File "src/sage/modular/modsym/space.py", line 929, in sage.modular.modsym.space.ModularSymbolsSpace._q_expansion_module
Failed example:
    ModularSymbols(11, 2, base_ring=GF(4,'a')).cuspidal_submodule()._q_expansion_module(prec=4, algorithm="hecke")
Expected:
    Vector space of degree 4 and dimension 1 over Finite Field in a of size 2^2
    Basis matrix:
    [0 1 0 1]
Got:
    doctest:127: DeprecationWarning: type inequality comparisons not supported in 3.x
    doctest:511: DeprecationWarning: classic int division
    doctest:250: DeprecationWarning: type inequality comparisons not supported in 3.x
    doctest:585: DeprecationWarning: classic int division
    doctest:286: DeprecationWarning: classic int division
    doctest:396: DeprecationWarning: classic int division
    doctest:6464: DeprecationWarning: classic int division
    Vector space of degree 4 and dimension 1 over Finite Field in a of size 2^2
    Basis matrix:
    [0 1 0 1]
**********************************************************************
```

and I don't know how to correlate line likes `doctest:511` with the original line.

The line in stderr are more useful, but are few and far between

```
~/sage-6.2.beta8/local/lib/python2.7/site-packages/sage/groups/perm_gps/cubegroup.py:368: DeprecationWarning: classic int division
  2:  [1/2,3/2,5/2], #  ub
```




---

archive/issue_comments_204067.json:
```json
{
    "body": "Hi Wilfried,\nin #16371 I changed some `/` to `//`, maybe you can review it.\n\nBTW: how you got the summary of `stdout` and `stderr`?",
    "created_at": "2014-05-17T10:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204067",
    "user": "aapitzsch"
}
```

Hi Wilfried,
in #16371 I changed some `/` to `//`, maybe you can review it.

BTW: how you got the summary of `stdout` and `stderr`?



---

archive/issue_comments_204068.json:
```json
{
    "body": "Small Python script to create the summary",
    "created_at": "2014-05-17T13:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204068",
    "user": "wluebbe"
}
```

Small Python script to create the summary



---

archive/issue_comments_204069.json:
```json
{
    "body": "Attachment [read_deprecation-warnings-v1b.py](tarball://root/attachments/some-uuid/ticket15995/read_deprecation-warnings-v1b.py) by wluebbe created at 2014-05-17 13:49:36\n\nFor the summary see the small attached Py script ;-)\n\nI will look at your ticket.",
    "created_at": "2014-05-17T13:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204069",
    "user": "wluebbe"
}
```

Attachment [read_deprecation-warnings-v1b.py](tarball://root/attachments/some-uuid/ticket15995/read_deprecation-warnings-v1b.py) by wluebbe created at 2014-05-17 13:49:36

For the summary see the small attached Py script ;-)

I will look at your ticket.



---

archive/issue_comments_204070.json:
```json
{
    "body": "I created the ticket #18578 to address classes which define the special function `__div__()` (and `__truediv__()`). See also the comments 5 and 7 in #16731.",
    "created_at": "2015-06-02T05:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204070",
    "user": "wluebbe"
}
```

I created the ticket #18578 to address classes which define the special function `__div__()` (and `__truediv__()`). See also the comments 5 and 7 in #16731.



---

archive/issue_comments_204071.json:
```json
{
    "body": "One very small effort in the spirit of this ticket: #19535",
    "created_at": "2015-11-06T13:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204071",
    "user": "jdemeyer"
}
```

One very small effort in the spirit of this ticket: #19535



---

archive/issue_comments_204072.json:
```json
{
    "body": "Also #19536.",
    "created_at": "2015-11-06T14:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204072",
    "user": "jdemeyer"
}
```

Also #19536.



---

archive/issue_comments_204073.json:
```json
{
    "body": "Replying to [comment:1 wluebbe]:\n> But currently I am stuck:\n> * I don't know how to pass the option `-Qwarnall` to the Python interpreter when running the doctests\n\nCould you try the following:\n\nFrom a terminal, run `sage -sh`\n\nFrom this shell, run:\n\n\n```\nexport PYTHONIOENCODING=\"utf-8\"\npython -Qwarnall $(which sage-runtests) <options>\n```\n\n\nWhere `<options>` is something like `--all --long` (depending on the options you are using for doctesting) ?",
    "created_at": "2016-01-08T22:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204073",
    "user": "tmonteil"
}
```

Replying to [comment:1 wluebbe]:
> But currently I am stuck:
> * I don't know how to pass the option `-Qwarnall` to the Python interpreter when running the doctests

Could you try the following:

From a terminal, run `sage -sh`

From this shell, run:


```
export PYTHONIOENCODING="utf-8"
python -Qwarnall $(which sage-runtests) <options>
```


Where `<options>` is something like `--all --long` (depending on the options you are using for doctesting) ?



---

archive/issue_comments_204074.json:
```json
{
    "body": "Changing component from distribution to python3.",
    "created_at": "2016-05-02T13:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204074",
    "user": "jdemeyer"
}
```

Changing component from distribution to python3.



---

archive/issue_comments_204075.json:
```json
{
    "body": "one step done in #21127",
    "created_at": "2016-07-29T20:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204075",
    "user": "chapoton"
}
```

one step done in #21127



---

archive/issue_comments_204076.json:
```json
{
    "body": "another step in #22767",
    "created_at": "2017-04-06T12:58:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204076",
    "user": "chapoton"
}
```

another step in #22767



---

archive/issue_comments_204077.json:
```json
{
    "body": "another step in #23731",
    "created_at": "2017-08-27T07:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204077",
    "user": "chapoton"
}
```

another step in #23731



---

archive/issue_comments_204078.json:
```json
{
    "body": "another step in #24548",
    "created_at": "2018-01-16T16:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204078",
    "user": "chapoton"
}
```

another step in #24548



---

archive/issue_comments_204079.json:
```json
{
    "body": "Changing keywords from \"python3\" to \"division\".",
    "created_at": "2018-02-23T13:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204079",
    "user": "embray"
}
```

Changing keywords from "python3" to "division".



---

archive/issue_comments_204080.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2018-02-23T13:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204080",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_204081.json:
```json
{
    "body": "Some more status tracking for division-related work.",
    "created_at": "2018-02-23T14:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204081",
    "user": "embray"
}
```

Some more status tracking for division-related work.



---

archive/issue_comments_204082.json:
```json
{
    "body": "Attachment [read_deprecation-warnings-v2.py](tarball://root/attachments/some-uuid/ticket15995/read_deprecation-warnings-v2.py) by chapoton created at 2018-09-02 07:36:32\n\nupdated script",
    "created_at": "2018-09-02T07:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204082",
    "user": "chapoton"
}
```

Attachment [read_deprecation-warnings-v2.py](tarball://root/attachments/some-uuid/ticket15995/read_deprecation-warnings-v2.py) by chapoton created at 2018-09-02 07:36:32

updated script



---

archive/issue_comments_204083.json:
```json
{
    "body": "I think that we are now ready to close this one. Agreed ?",
    "created_at": "2019-06-02T16:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204083",
    "user": "chapoton"
}
```

I think that we are now ready to close this one. Agreed ?



---

archive/issue_comments_204084.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-02T16:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204084",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_204085.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-03T17:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204085",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_204086.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-04T09:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15758#issuecomment-204086",
    "user": "chapoton"
}
```

Resolution: fixed
