# Issue 32657: split out a separate Python package primecount

Issue created by migration from https://trac.sagemath.org/ticket/32894

Original creator: dimpase

Original creation time: 2021-11-18 10:43:18

CC:  mkoeppe

This is a followup to #25009

Here is my failing attempt to create such a package:
https://github.com/dimpase/primecount 

Attention of Cython/packaging experts needed


---

Comment by mkoeppe created at 2021-11-18 18:12:59

As you know, https://pypi.org/project/primecount/ is already taken...


---

Comment by dimpase created at 2021-11-18 19:57:00

I must say I don't quite know what exactly pypi package name is, and whether anything beyond changes in MANIFEST.in and setup.py is needed.
Can the module name still be the same, `primecount` ?

We'd call it `pyprimecount` instead.


---

Comment by mkoeppe created at 2021-11-18 21:23:14

I explained it recently in https://groups.google.com/g/sage-devel/c/p4MO6L95s7E/m/yZF93ewIBAAJ, take a look


---

Comment by dimpase created at 2021-11-18 22:00:15

OK, thanks. Another thing I don't understand is how the C++ library prinecount is meant to be provided. It's not something too standard to assume it's just installed.

 Does it mean to be a non-python dependency of Sage? Or of (py)prinecount?


---

Comment by mkoeppe created at 2021-11-18 22:31:32

When `pyprimecount` is installed from a source distribution, it will just assume that the necessary library is available. Python packages do not have a way to declare non-Python dependencies.

Later one may consider to build wheels that include a copy of the shared library.
This is what for example `numpy` does regarding BLAS: The source distribution certainly does not contain a copy of BLAS, but the wheels ship with a copy of the OpenBLAS shared library.


---

Comment by mkoeppe created at 2021-11-18 22:33:04

On the Sage side, there will be two SPKGs: One for `primecount`, one for `pyprimecount`. This mirrors what is done, for example, for `ppl` and `pplpy`. The SPKG `dependencies` of `pyprimecount` include `primecount`; so when `pyprimecount` is pip-installed, the library has already been installed.


---

Comment by dimpase created at 2021-11-19 11:23:59

after a very careful consideration, decided to rename it `primecountpy`.


---

Comment by dimpase created at 2021-11-20 14:39:45

OK, so prinecountpy works (needs setting up proper tests, etc), but other than that, what else is needed on that side?Some pypi/pip magic? 

(on Sage's side clearly code to be removed and replaced by hopefully clear something...)


---

Comment by mkoeppe created at 2021-11-20 16:47:41

when primecountpy is ready, use `setup.py sdist` to create an sdist and upload to PyPI with `twine`

Then on the Sage side, use `./sage -package create primecountpy --pypi`


---

Comment by dimpase created at 2021-11-25 12:13:11

OK, here it is: https://pypi.org/project/primecountpy/


---

Comment by dimpase created at 2021-11-25 13:11:05

Last 10 new commits:


---

Comment by dimpase created at 2021-11-25 13:45:58

it works, apparently.


---

Comment by dimpase created at 2021-11-25 13:45:58

Changing status from new to needs_review.


---

Comment by git created at 2021-11-25 13:54:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-26 23:40:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-26 23:42:24

this should go to #25009


---

Comment by git created at 2021-11-27 00:02:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-29 20:16:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-29 20:23:48

Shouldn't `sage.interfaces.primecount` provide some deprecated re-imports?


---

Comment by mkoeppe created at 2021-11-29 20:44:12

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-11-29 20:44:12

`build/pkgs/primecountpy/dependencies` is still missing the dependency `cython`. It is NOT part of `PYTHON_TOOLCHAIN` as you can see in `build/make/Makefile.in`


---

Comment by git created at 2021-11-30 09:46:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-30 09:47:07

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-12-01 13:52:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-01 20:17:15


```
+from primecountpy.primecount import prime_pi as _prime_pi
+from primecountpy.primecount import phi as _phi
```

I think this should use `lazy_import` with a `deprecation` parameter


---

Comment by dimpase created at 2021-12-01 20:54:38

What does one want to deprecate here?

lazy_import is a good idea, yes.


---

Comment by mkoeppe created at 2021-12-01 21:00:07

Sorry, I was looking in the wrong place. I should have said: `sage.interfaces.primecount`  cannot be eliminated immediately, instead it should use `lazy_import` with a `deprecation` parameter to re-export the functions provided by `primecountpy`.


---

Comment by git created at 2021-12-02 11:48:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-02 14:36:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-12-02 14:38:09

Replying to [comment:33 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[9cfdad8](https://git.sagemath.org/sage.git/commit/?id=9cfdad8bbb3bc7371d8c45f01e23d1e31e5cf732)||`deprecate sage.interfaces.primecount, not just remove`||

This should resolve comment:29 - although perhaps not perfectly, as this is now Python-only. I don't know how to deprecate Cython functions.


---

Comment by dimpase created at 2021-12-02 14:41:06

Replying to [comment:32 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[30346c0](https://git.sagemath.org/sage.git/commit/?id=30346c0f7a5866249ee791d5a5b3a00840f20143)||`cysignals are needed`||

Now the CI on https://github.com/dimpase/primecountpy/runs/4394526057
passes. (The whole platforms shebang is still running).


---

Comment by mkoeppe created at 2021-12-02 18:07:08

Replying to [comment:34 dimpase]:
> This should resolve comment:29 - although perhaps not perfectly, as this is now Python-only. 

Yes, this is what I had in mind, thanks.

> I don't know how to deprecate Cython functions.

We don't have a mechanism for that.


---

Comment by mkoeppe created at 2021-12-02 18:56:16

Changing status from needs_review to positive_review.


---

Comment by git created at 2021-12-02 20:41:03

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-12-02 20:41:03

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by dimpase created at 2021-12-02 20:42:05

a trivial addition.


---

Comment by dimpase created at 2021-12-02 20:42:05

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2021-12-05 04:02:34

Can you add `primesieve` conda package too?


---

Comment by git created at 2021-12-05 12:11:21

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-12-05 12:11:21

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by dimpase created at 2021-12-05 12:12:08

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-12-05 12:12:08

Replying to [comment:40 isuruf]:
> Can you add `primesieve` conda package too?
done.


---

Comment by vbraun created at 2021-12-12 17:37:06

Test fail, e.g. 

```
File "src/sage/plot/plot.py", line 1753, in sage.plot.plot.plot
Failed example:
    plot(lambda x: prime_pi(x), (x, 1, 100), exclude=jumps)
Expected:
    Graphics object consisting of 26 graphics primitives
Got:
    verbose 0 (3839: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 248 points.
    verbose 0 (3839: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'
    Graphics object consisting of 0 graphics primitives
**********************************************************************
1 item had failures:
   1 of 147 in sage.plot.plot.plot
    [423 tests, 1 failure, 28.78 s]
----------------------------------------------------------------------
sage -t --warn-long 47.7 --random-seed=57011699320160764553253619770787736483 src/sage/plot/plot.py  # 1 doctest failed
```



---

Comment by vbraun created at 2021-12-12 17:37:06

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-12-13 00:36:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-12-13 18:16:34

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-12-13 18:16:34

rebased an added `â€‹74b3845	allow float inputs for prime_pi` to deal with the need for `prime_pi` to accept floats as input.
All the relevant tests pass.


---

Comment by mkoeppe created at 2021-12-13 19:09:27

LGTM.


---

Comment by mkoeppe created at 2021-12-13 19:09:27

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-21 01:39:18

Marking this ticket "critical" in light of #33054 because it adds the conda package information


---

Comment by mkoeppe created at 2021-12-21 01:39:18

Changing priority from major to critical.


---

Comment by vbraun created at 2021-12-23 20:25:59

Resolution: fixed
