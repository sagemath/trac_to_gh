# Issue 25588: Move gap_packages and cremona db to features

Issue created by migration from Trac.

Original creator: @timokau

Original creation time: 2018-07-11 13:18:28

CC:  tscrim fbissey mkoeppe

This continues the work in #20382. After this patch is applied, only one usage of `is_package_installed` remains: The one in `OptionalExtension`.

To test this I ran `./sage -t --optional=sage,gap_packages,database_cremona_ellcurve $( git diff --name-only HEAD~2 )`.

After this I would propose to fix the usage in `OptionalExtension` (which seems to be a purely internal function just used for the build -- should be easy to fix) and then deprecate or remove `is_package_installed`.


---

Comment by @timokau created at 2018-07-11 13:18:42

Changing status from new to needs_review.


---

Comment by @timokau created at 2018-07-11 17:39:03

I just discovered #24718. This seems to be related/a duplicate. But that ticket seems to do some more unrelated stuff and probably needs a rebase. No clue why that is still "new".


---

Comment by jdemeyer created at 2018-07-11 18:40:15

In any case, I would rather have 1 ticket for each issue (1 for GAP, one for the Cremona database).


---

Comment by @timokau created at 2018-07-11 19:35:00

Sure, I'll split it up.


---

Comment by @timokau created at 2018-07-11 19:38:38

New commits:


---

Comment by git created at 2018-07-11 19:40:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-07-11 19:44:24

Split to this and #25835.


---

Comment by jdemeyer created at 2018-07-11 21:43:09

As I mentioned on #24718: We should also use the database location discovered by the feature check instead of hardcoding it. In other words: there should be a single source for the database location.


---

Comment by jdemeyer created at 2018-07-11 21:43:09

Changing status from needs_review to needs_work.


---

Comment by @timokau created at 2018-07-11 21:49:33

What do you mean by "discover"? It looks to me like the path to the database is just as hardcoded in the feature. Am I reading that wrong?

That should probably use the environment variable I introduced in #25309 though. So that'll have to be merged first.


---

Comment by jdemeyer created at 2018-07-11 22:09:21

Replying to [comment:10 gh-timokau]:
> It looks to me like the path to the database is just as hardcoded in the feature.

Yes, it's hardcoded in two different places which is bad design. There should be single source for it.


---

Comment by @timokau created at 2018-07-11 22:21:07

I agree, I'll use the environment variable after #25309 is merged.


---

Comment by git created at 2018-08-06 12:20:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-08-06 12:20:56

Alright I'm using the proper environment variables now.


---

Comment by @timokau created at 2018-08-06 12:20:56

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-08-06 12:55:35

My point was that you shouldn't use `CREMONA_MINI_DATA_DIR, CREMONA_LARGE_DATA_DIR` at all in the implementation, as the `Feature` already knows the filename.


---

Comment by @timokau created at 2018-08-06 13:03:40

Yes the filename, but not the directory. How is it supposed to know that?


---

Comment by saraedum created at 2018-08-07 17:09:54

I guess you should ask the feature for the path and not import it independently, see `StaticFile.absolute_path()`.


---

Comment by saraedum created at 2018-08-07 17:10:05

Changing status from needs_review to needs_work.


---

Comment by @timokau created at 2018-08-07 18:14:31

Changing status from needs_work to needs_info.


---

Comment by @timokau created at 2018-08-07 18:14:31

But how is the feature supposed to know the path?


---

Comment by saraedum created at 2018-08-07 18:55:54

The features looks at `CREMONA_*_DATA_DIR`. The point is that this information is only in the feature and users of the feature should not look at these variables again, i.e., the feature's implementation can change and we do not have to update all the users.


---

Comment by saraedum created at 2018-08-07 18:56:42

This is of course not so terribly important but it feels cleaner like that to me. (And closer to my idea of how features are supposed to work.)


---

Comment by @timokau created at 2018-08-07 20:10:37

Ah, that makes sense to me. Also would make it easier to switch out the ad-hoc environment variables for a `./configure` based system in the future. I thought Jeroen meant that I shouldn't use the environment variable at all.


---

Comment by @timokau created at 2018-08-07 20:10:37

Changing status from needs_info to needs_work.


---

Comment by @timokau created at 2018-08-07 20:17:27

In that case we'd still need `CREMONA_MINI_DATA_DIR` though, creating an assymetry. Should I change over anyways? Or make the two cremona databases mutually exclusive, always going through the feature and unifying the two env variables?


---

Comment by @timokau created at 2018-08-07 20:17:40

Changing status from needs_work to needs_info.


---

Comment by saraedum created at 2018-08-07 20:32:38

Shouldn't both databases be features? Isn't the only difference that the mini one is a standard SPKG and the full one is optional?


---

Comment by saraedum created at 2018-08-07 20:32:51

Changing status from needs_info to needs_work.


---

Comment by @timokau created at 2018-08-07 20:41:00

Yes, why would we use a feature to detect a standard package? Its always available by definition. Of course I would prefer to move more packages to `optional` and make sage more modular, but currently the mini db is standard.


---

Comment by saraedum created at 2018-08-07 21:19:07

It's a standard package in Sage-the-distribution but it still makes sense to use the feature infrastructure as it might make things easier for (us) packagers. Even if we always ship it we can rely on the features detecting the correct paths for things.


---

Comment by @timokau created at 2018-08-07 21:47:30

I'm not sure if features are the right choice / intended for that use case. In general I think detecting time at runtime usually causes problems. Would that feature then only provide a path?

CC'ing fbissey because this is related to #25309, which apparently created problems for him.


---

Comment by fbissey created at 2018-08-07 22:32:19

Thanks for the concern but I am a proponent of using `features` more (been wanting to move to such thing for years), and the part of #25309 related to this ticket is fine by me.


---

Comment by saraedum created at 2018-08-07 22:34:05

I think it should be a feature in particular because we should not handle the large database differently from the mini database.

The feature would tell you whether the mini database is present (which must be true) and provide its path. I think for the cremona DBs that's all we need.


---

Comment by @timokau created at 2018-08-07 23:03:30

Alright and what should we do if the database is not present?


---

Comment by saraedum created at 2018-08-09 00:17:06

For the mini database: I would just ask for its `absolute_path()` which throws if it cannot find it. If that happens, I'd just let it throw. It won't happen on a properly configured setup. (and maybe add something like that as a comment in the codeâ€¦)

Does that make sense?


---

Comment by @timokau created at 2018-08-09 08:30:31

Yeah that makes sense, I'll look into it.


---

Comment by @timokau created at 2018-08-09 08:46:34

Should I then remove `CREMONA_{LARGE,MINI}_DATA_DIR` entirely from `env.py` and instead read the variable directly (with fallback) in the feature?

That would have the advantage that there would be only one way to get that information. Otherwise, it will be easy for future code to use the variable from `env.py` instead.

But there would be the disadvantage that it wouldn't be as easy anymore to figure out which variables can be set to configure locations.

`@`fbissey as you were involved with `env.py`, do you have an opinion about that?


---

Comment by git created at 2018-08-09 15:45:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-09 15:50:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-08-09 15:51:21

I added a mechanism to `StaticFile` that takes an environment variable as an override for `search_path`. It will then also notify the user of the existence of that search path when the file is not found. I like that solution even better than the `env.py` one.

For the record: I think `resolution()` should be refactored to return a list of lines for easier extensibility. The variable `resolution` should be removed because users can just override `resolution()` if they want to change the message. But that is out of scope of this ticket.

Also in the future I hope `search_path_override` could be replaced by a key in a configuration file instead of an env var.
----
New commits:


---

Comment by @timokau created at 2018-08-09 15:51:21

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2019-01-25 22:52:37

This appears to need some kind of rebasing.


---

Comment by jdemeyer created at 2019-02-15 10:20:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-03-09 16:57:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2019-03-09 16:57:46

Rebased.
----
New commits:


---

Comment by fbissey created at 2019-03-17 22:22:49

Are there any outstanding issues with this ticket or should we put it back to positive review?


---

Comment by jdemeyer created at 2019-03-18 06:31:10

For consistency, I would prefer if the handling of environment variables would remain in `src/sage/env.py`. Right now, you're moving part of that to `src/sage/features/__init__.py`


---

Comment by @timokau created at 2019-03-18 08:43:27

How would you suggest we do that? I'm not convinced hard-coding a search path override variable for every feature would be a better solution, but if you prefer that I'll implement it.


---

Comment by jdemeyer created at 2019-03-18 09:14:48

Maybe just use `search_path=[CREMONA_MINI_DATA_DIR]` in `src/sage/features/databases.py`? That wouldn't require any changes to the general feature framework.


---

Comment by jdemeyer created at 2019-04-30 08:22:35

Let's try to finish this... I'm having a look at it now.


---

Comment by jdemeyer created at 2019-04-30 10:07:33

New commits:


---

Comment by jdemeyer created at 2019-04-30 10:07:33

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-04-30 10:08:26

The last 2 commits are not strictly needed, they are just cleaning stuff up. If a reviewer prefers to move that to a separate ticket, I'll do that.


---

Comment by tscrim created at 2019-04-30 11:50:30

I am just verifying the last two cleanup commits are good.


---

Comment by arojas created at 2019-07-15 20:54:06

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2019-07-15 20:54:06

Rebase needed


---

Comment by arojas created at 2020-10-08 16:02:09

Let's please try to get this finally in
----
New commits:


---

Comment by arojas created at 2020-10-08 16:02:09

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-10-08 16:02:21

Ticket description needs updating


---

Comment by arojas created at 2020-10-08 16:14:58

Replying to [comment:56 mkoeppe]:
> Ticket description needs updating

Is the `OptionalExtension` bit still relevant? I'm not familiar with the recent changes in that area.


---

Comment by mkoeppe created at 2020-10-08 16:18:38

No, the use of `OptionalExtension` has been eliminated. See https://wiki.sagemath.org/ReleaseTours/sage-9.2#For_developers:_Changes_to_the_build_system_of_sagelib


---

Comment by mkoeppe created at 2020-10-08 16:50:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-10-31 18:07:46

Resolution: fixed
