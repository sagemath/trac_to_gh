# Issue 21098: Noexpand/simple options for ex.normalize()

Issue created by migration from https://trac.sagemath.org/ticket/21335

Original creator: rws

Original creation time: 2016-08-25 13:17:47

At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final denominator is expanded:

```
sage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).normalize()
(x^(1/2*y) + 1)^2*(x^(1/2*y) - 1)^2/(x^y - 1)
sage: (x + y^2/(x + 2)).normalize()
(x^2 + y^2 + 2*x)/(x + 2)
```


The alternatives are provided atm by Maxima

```
sage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).simplify_rational(algorithm='simple')
(x^(2*y) - 2*x^y + 1)/(x^y - 1)
sage: (x + y^2/(x + 2)).simplify_rational(algorithm='noexpand')
((x + 2)*x + y^2)/(x + 2)
```


https://github.com/pynac/pynac/issues/191

After Pynac will have implemented `normalize()` options to these effect the calls to Maxima in `simplify_rational` should be replaced by the respective calls to Pynac.


---

Comment by rws created at 2016-08-29 13:14:44

This is implemented in Pynac master ~~but one doctest depends on #21360~~. Also, nested application ("full") needs to be done.


---

Comment by rws created at 2016-08-31 08:27:21

New commits:


---

Comment by git created at 2016-09-02 08:02:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-09-18 06:50:19

Three doctest fails in `symbolic/expression.pyx`.


---

Comment by git created at 2016-09-18 14:12:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-10-02 14:46:36

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2016-10-03 12:56:17

Minor point: "and and" should be "and".

Apart from that, I don't understand why `algorithm="full"` attempts to factor the simplified fraction (which is a potentially costly operation). Is there something in the way the Pynac `normal()` function works that makes it necessary to do so?


---

Comment by rws created at 2016-10-05 08:18:34

Indeed the performance question was the source of some headaches to me, as well. I figured at the time consistency with Maxima behaviour was more important. Without `factor` the following doctests will fail:

```
File "src/sage/symbolic/expression.pyx", line 9427, in sage.symbolic.expression.Expression.simplify_rational
Failed example:
    f.simplify_rational()
Expected:
    -2*sqrt(x - 1)/sqrt((x + 1)*(x - 1))
Got:
    ((x - 1)^(3/2) - sqrt(x - 1)*x - sqrt(x - 1))/sqrt((x + 1)*(x - 1))
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 9451, in sage.symbolic.expression.Expression.simplify_rational
Failed example:
    g.simplify_rational()
Expected:
    x^y - 1
Got:
    (x^(2*y) - 2*x^y + 1)/(x^y - 1)
```



---

Comment by git created at 2016-10-05 08:38:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2016-10-05 09:17:32

Replying to [comment:13 rws]:
> Indeed the performance question was the source of some headaches to me, as well. I figured at the time consistency with Maxima behaviour was more important.

I don't know exactly what either Maxima or Pynac does, but just by chance, do you think it would be okay to keep the loop but _expand_ the denominators instead of calling `factor()`?


---

Comment by rws created at 2016-10-05 12:47:43

Replying to [comment:15 mmezzarobba]:
> I don't know exactly what either Maxima or Pynac does, but just by chance, do you think it would be okay to keep the loop but _expand_ the denominators instead of calling `factor()`?

This will, additionally to the two doctests above, fail this doctest:

```
File "src/sage/symbolic/expression.pyx", line 9458, in sage.symbolic.expression.Expression.simplify_rational
Failed example:
    f.simplify_rational()
Expected:
    (2*x^2 + 5*x + 4)/((x + 2)^2*(x + 1))
Got:
    (2*x^2 + 5*x + 4)/(x^3 + 5*x^2 + 8*x + 4)
```



---

Comment by rws created at 2016-11-28 16:14:37

Changing status from needs_review to needs_work.


---

Comment by rws created at 2016-11-28 16:14:37

I think I see now how to resolve the three tests without factoring. Pynac's gcd needs to be a bit more aware of powers in the expression and needs to replace some of them with new symbols. This way also exponentials can be handled identically (which does not work atm).
