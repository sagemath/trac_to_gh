# Issue 24568: py3: miscellaneous division-related fixes, particularly for sage_setup.autogen

Issue created by migration from https://trac.sagemath.org/ticket/24805

Original creator: embray

Original creation time: 2018-02-21 12:12:37

Previously we used an opcode named 'div' both for the old `div` operator
and for `truediv` (for compatibility's sake, since use of `__truediv__`) depends
on whether or not `from __future__ import division` is in effect).

So again, for compatibility's sake, on Python 3 we call truediv just 'div',
while integer division is still explicitly 'floordiv'.

Includes a few other semi-related fixes found while testing.  This fixes most but not all Python 3 issues with `sage.ext.fast_callable`--at least those directly related to division.


---

Comment by git created at 2018-02-21 12:13:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-21 12:16:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-21 12:20:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-21 12:22:06

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-21 13:18:03

Wouldn't it make sense to use `PyNumber_TrueDivide` even on Python 2?


---

Comment by embray created at 2018-02-22 12:07:42

That's a good question.  Do we want to just always assume Python 3 division semantics?


---

Comment by jdemeyer created at 2018-02-22 12:43:18

Replying to [comment:6 embray]:
> That's a good question.  Do we want to just always assume Python 3 division semantics?

Sage typically assumes true division semantics anyway. For example, division of `Integer` instances is closer to `int.__truediv__` than to `int.__div__`. So, with this in mind, I would indeed use Python 3 division everywhere (assuming that it doesn't break tests of course).


---

Comment by embray created at 2018-02-22 12:49:47

I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.  It would also in principle break user-defined classes, if any were actually used in this context, that implement `__div__` but not `__truediv__`.

Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?


---

Comment by jdemeyer created at 2018-02-22 13:22:10

Replying to [comment:8 embray]:
> I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.

Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.

> Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?

I'm not against that, but I also don't think that it's important. If you do, I guess you should output a deprecation warning if `__div__` is used.


---

Comment by embray created at 2018-02-22 14:29:22

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 embray]:
> > I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.
> 
> Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.

Yep.

> > Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?
> 
> I'm not against that, but I also don't think that it's important.

I agree it's probably not a very likely scenario, but I did it anyways.  

> If you do, I guess you should output a deprecation warning if `__div__` is used.

Yep, did that.


---

Comment by git created at 2018-02-22 14:31:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-22 14:31:49

Perhaps something like this.


---

Comment by embray created at 2018-02-23 13:36:13

Changing keywords from "" to "division".


---

Comment by jdemeyer created at 2018-02-27 09:24:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-27 09:24:22

The way it's written now, it looks like the deprecation warning will be shown every time that `__truediv__` fails with a `TypeError`, regardless of whether `__div__` works.

Maybe better something like:

```
try:
    ...
except TypeError:
    IF PY_MAJOR_VERSION < 3:
        res = PyNumber_Divide(...)
        deprecation(...)
        return res
    ELSE
        raise
    ENDIF
```

This way, the deprecation will only be shown if `__div__` actually worked.


---

Comment by embray created at 2018-02-27 09:27:21

Yes, I was thinking of doing something like that as well, but I couldn't quite decide on the logic for it.  But I think your suggestion makes sense.


---

Comment by git created at 2018-02-27 09:31:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-27 09:32:06

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-27 21:20:43

I am getting consistent doctest timeouts on a particular test system:

```
sage -t src/sage/plot/plot3d/list_plot3d.py  # Timed out
sage -t src/sage/geometry/riemannian_manifolds/surface3d_generators.py  # Timed out
sage -t src/sage/stats/distributions/discrete_gaussian_lattice.py  # Timed out
```

I'll need to check whether this ticket has something to do with that.


---

Comment by jdemeyer created at 2018-02-28 06:26:36

The timeouts are unrelated to this ticket. They are still disturbing though...


---

Comment by jdemeyer created at 2018-02-28 06:27:25

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-02-28 14:20:43

I've been getting some timeouts too sometimes, but I'm not sure if it's the same modules.  I'll check.


---

Comment by jdemeyer created at 2018-02-28 14:25:42

Sorry, forgot to say... this is #13135.


---

Comment by vbraun created at 2018-03-05 17:52:58

Resolution: fixed
