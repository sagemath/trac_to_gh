# Issue 24568: py3: miscellaneous division-related fixes, particularly for sage_setup.autogen

archive/issues_024568.json:
```json
{
    "body": "Previously we used an opcode named 'div' both for the old `div` operator\nand for `truediv` (for compatibility's sake, since use of `__truediv__`) depends\non whether or not `from __future__ import division` is in effect).\n\nSo again, for compatibility's sake, on Python 3 we call truediv just 'div',\nwhile integer division is still explicitly 'floordiv'.\n\nIncludes a few other semi-related fixes found while testing.  This fixes most but not all Python 3 issues with `sage.ext.fast_callable`--at least those directly related to division.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24805\n\n",
    "created_at": "2018-02-21T12:12:37Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: miscellaneous division-related fixes, particularly for sage_setup.autogen",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24568",
    "user": "embray"
}
```
Previously we used an opcode named 'div' both for the old `div` operator
and for `truediv` (for compatibility's sake, since use of `__truediv__`) depends
on whether or not `from __future__ import division` is in effect).

So again, for compatibility's sake, on Python 3 we call truediv just 'div',
while integer division is still explicitly 'floordiv'.

Includes a few other semi-related fixes found while testing.  This fixes most but not all Python 3 issues with `sage.ext.fast_callable`--at least those directly related to division.

Issue created by migration from https://trac.sagemath.org/ticket/24805





---

archive/issue_comments_344711.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-21T12:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344711",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344712.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-21T12:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344712",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_344713.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-21T12:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344713",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344714.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-21T12:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344714",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_344715.json:
```json
{
    "body": "Wouldn't it make sense to use `PyNumber_TrueDivide` even on Python 2?",
    "created_at": "2018-02-21T13:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344715",
    "user": "jdemeyer"
}
```

Wouldn't it make sense to use `PyNumber_TrueDivide` even on Python 2?



---

archive/issue_comments_344716.json:
```json
{
    "body": "That's a good question.  Do we want to just always assume Python 3 division semantics?",
    "created_at": "2018-02-22T12:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344716",
    "user": "embray"
}
```

That's a good question.  Do we want to just always assume Python 3 division semantics?



---

archive/issue_comments_344717.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> That's a good question.  Do we want to just always assume Python 3 division semantics?\n\nSage typically assumes true division semantics anyway. For example, division of `Integer` instances is closer to `int.__truediv__` than to `int.__div__`. So, with this in mind, I would indeed use Python 3 division everywhere (assuming that it doesn't break tests of course).",
    "created_at": "2018-02-22T12:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344717",
    "user": "jdemeyer"
}
```

Replying to [comment:6 embray]:
> That's a good question.  Do we want to just always assume Python 3 division semantics?

Sage typically assumes true division semantics anyway. For example, division of `Integer` instances is closer to `int.__truediv__` than to `int.__div__`. So, with this in mind, I would indeed use Python 3 division everywhere (assuming that it doesn't break tests of course).



---

archive/issue_comments_344718.json:
```json
{
    "body": "I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.  It would also in principle break user-defined classes, if any were actually used in this context, that implement `__div__` but not `__truediv__`.\n\nPerhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?",
    "created_at": "2018-02-22T12:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344718",
    "user": "embray"
}
```

I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.  It would also in principle break user-defined classes, if any were actually used in this context, that implement `__div__` but not `__truediv__`.

Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?



---

archive/issue_comments_344719.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.\n\nThose should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.\n\n> Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?\n\nI'm not against that, but I also don't think that it's important. If you do, I guess you should output a deprecation warning if `__div__` is used.",
    "created_at": "2018-02-22T13:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344719",
    "user": "jdemeyer"
}
```

Replying to [comment:8 embray]:
> I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.

Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.

> Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?

I'm not against that, but I also don't think that it's important. If you do, I guess you should output a deprecation warning if `__div__` is used.



---

archive/issue_comments_344720.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:8 embray]:\n> > I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.\n> \n> Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.\n\nYep.\n\n> > Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?\n> \n> I'm not against that, but I also don't think that it's important.\n\nI agree it's probably not a very likely scenario, but I did it anyways.  \n\n> If you do, I guess you should output a deprecation warning if `__div__` is used.\n\nYep, did that.",
    "created_at": "2018-02-22T14:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344720",
    "user": "embray"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 embray]:
> > I'm fine with that, though I've found at least a few classes that implement `__div__` but not `__truediv__`.
> 
> Those should obviously be fixed. But keep in mind that everything inheriting from `Element` already supports both `__truediv__` and `__div__` through the coercion model.

Yep.

> > Perhaps instead of using `PyNumber_(True)Divide` it could use a little wrapper macro which prefers `__truediv__` if it exists, or falls back on `__div__`?
> 
> I'm not against that, but I also don't think that it's important.

I agree it's probably not a very likely scenario, but I did it anyways.  

> If you do, I guess you should output a deprecation warning if `__div__` is used.

Yep, did that.



---

archive/issue_comments_344721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-22T14:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344721",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344722.json:
```json
{
    "body": "Perhaps something like this.",
    "created_at": "2018-02-22T14:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344722",
    "user": "embray"
}
```

Perhaps something like this.



---

archive/issue_comments_344723.json:
```json
{
    "body": "Changing keywords from \"\" to \"division\".",
    "created_at": "2018-02-23T13:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344723",
    "user": "embray"
}
```

Changing keywords from "" to "division".



---

archive/issue_comments_344724.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-27T09:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344724",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_344725.json:
```json
{
    "body": "The way it's written now, it looks like the deprecation warning will be shown every time that `__truediv__` fails with a `TypeError`, regardless of whether `__div__` works.\n\nMaybe better something like:\n\n```\ntry:\n    ...\nexcept TypeError:\n    IF PY_MAJOR_VERSION < 3:\n        res = PyNumber_Divide(...)\n        deprecation(...)\n        return res\n    ELSE\n        raise\n    ENDIF\n```\n\nThis way, the deprecation will only be shown if `__div__` actually worked.",
    "created_at": "2018-02-27T09:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344725",
    "user": "jdemeyer"
}
```

The way it's written now, it looks like the deprecation warning will be shown every time that `__truediv__` fails with a `TypeError`, regardless of whether `__div__` works.

Maybe better something like:

```
try:
    ...
except TypeError:
    IF PY_MAJOR_VERSION < 3:
        res = PyNumber_Divide(...)
        deprecation(...)
        return res
    ELSE
        raise
    ENDIF
```

This way, the deprecation will only be shown if `__div__` actually worked.



---

archive/issue_comments_344726.json:
```json
{
    "body": "Yes, I was thinking of doing something like that as well, but I couldn't quite decide on the logic for it.  But I think your suggestion makes sense.",
    "created_at": "2018-02-27T09:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344726",
    "user": "embray"
}
```

Yes, I was thinking of doing something like that as well, but I couldn't quite decide on the logic for it.  But I think your suggestion makes sense.



---

archive/issue_comments_344727.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-27T09:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344727",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344728.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-27T09:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344728",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_344729.json:
```json
{
    "body": "I am getting consistent doctest timeouts on a particular test system:\n\n```\nsage -t src/sage/plot/plot3d/list_plot3d.py  # Timed out\nsage -t src/sage/geometry/riemannian_manifolds/surface3d_generators.py  # Timed out\nsage -t src/sage/stats/distributions/discrete_gaussian_lattice.py  # Timed out\n```\n\nI'll need to check whether this ticket has something to do with that.",
    "created_at": "2018-02-27T21:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344729",
    "user": "jdemeyer"
}
```

I am getting consistent doctest timeouts on a particular test system:

```
sage -t src/sage/plot/plot3d/list_plot3d.py  # Timed out
sage -t src/sage/geometry/riemannian_manifolds/surface3d_generators.py  # Timed out
sage -t src/sage/stats/distributions/discrete_gaussian_lattice.py  # Timed out
```

I'll need to check whether this ticket has something to do with that.



---

archive/issue_comments_344730.json:
```json
{
    "body": "The timeouts are unrelated to this ticket. They are still disturbing though...",
    "created_at": "2018-02-28T06:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344730",
    "user": "jdemeyer"
}
```

The timeouts are unrelated to this ticket. They are still disturbing though...



---

archive/issue_comments_344731.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-28T06:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344731",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_344732.json:
```json
{
    "body": "I've been getting some timeouts too sometimes, but I'm not sure if it's the same modules.  I'll check.",
    "created_at": "2018-02-28T14:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344732",
    "user": "embray"
}
```

I've been getting some timeouts too sometimes, but I'm not sure if it's the same modules.  I'll check.



---

archive/issue_comments_344733.json:
```json
{
    "body": "Sorry, forgot to say... this is #13135.",
    "created_at": "2018-02-28T14:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344733",
    "user": "jdemeyer"
}
```

Sorry, forgot to say... this is #13135.



---

archive/issue_comments_344734.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-05T17:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24568#issuecomment-344734",
    "user": "vbraun"
}
```

Resolution: fixed
