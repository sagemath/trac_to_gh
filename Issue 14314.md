# Issue 14314: update zeromq 3.2.0

Issue created by migration from https://trac.sagemath.org/ticket/14518

Original creator: vbraun

Original creation time: 2013-05-02 11:30:32

Assignee: tbd

CC:  jason rbeezer

There have been reports on build failures with the current zeromq optional spkg. It is also quite outdated and we should update. Here is a new spkg:

http://boxen.math.washington.edu/home/vbraun/spkg/zeromq-3.2.0.p0.spkg




---

Comment by kcrisman created at 2013-05-02 15:25:14

The changes are fine

```diff

diff --git a/SPKG.txt b/SPKG.txt
--- a/SPKG.txt
+++ b/SPKG.txt
@@ -29,6 +29,9 @@
 
 == Changelog ==
 
+=== zeromq-2.2.0.p0 (Volker Braun, 2 May 2013) ===
+ * Updated to latest upstream version
+
 === zeromq-2.2.0.p0 (Volker Braun, William Stein, 14 April 2012) ===
 
  * Initial version
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -1,17 +1,27 @@
 #!/usr/bin/env sh
 
-unset RM
+if [ -z "$SAGE_LOCAL" ]; then
+    echo >&2 "SAGE_LOCAL undefined ... exiting"
+    echo >&2 "Maybe run 'sage --sh'?"
+    exit 1
+fi
 
 cd src
 
 ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL"/lib
-
 if [ $? -ne 0 ]; then
+    echo "Failed to configure zeromq!"
     exit 1
 fi
 
-make install
-
+$MAKE
 if [ $? -ne 0 ]; then
+    echo "Failed to build zeromq!"
     exit 1
 fi
+
+$MAKE -j1 install
+if [ $? -ne 0 ]; then
+    echo "Failed to install zeromq!"
+    exit 1
+fi
```

why did we unset `RM` in the past?  But I note that if you updated then perhaps you should have 

```
+=== zeromq-2.2.0.p0 (Volker Braun, 2 May 2013) ===
```

changed by one character :-)  Also, probably it doesn't need to be a p0, since we aren't making any changes to upstream, are we?

What parts of Sage depend on this?  Just the notebook?

Jason, will having this zeromq be fine for the sage cell server, since that was the source of at least one of the ask.sagemath questions about this?


---

Comment by vbraun created at 2013-05-02 15:42:31

The infamous `RM` was removed in #3537.

We don't have a particular policy about whether or not to start with `.p0`.


---

Comment by vbraun created at 2013-05-02 15:44:07

I fixed the version number in SPKG.txt


---

Comment by kcrisman created at 2013-05-02 15:52:11

> We don't have a particular policy about whether or not to start with `.p0`.
Don't we now? See [here](http://www.sagemath.org/doc/developer/patching_spkgs.html) for at least a strong indication that p0 means patched - and I've seen this discussed on various tickets.  Typically I think it makes sense to have it without the p if there aren't any patches.  

Naturally, this discussion is bikeshedding and so I'm not going to complain (and I hope people try this out for solving their zeromq problems), but it's not a complete waste of time to make things clear what is patched and what isn't...


---

Comment by vbraun created at 2013-05-02 15:56:03

From the page that you linked:

If you start afresh from an upstream release without any patches to its source code, the resulting spkg need not have any patch-level labels (appending ”.p0” is allowed, but is optional).


---

Comment by kcrisman created at 2013-05-02 16:24:34

Hilarious!  Way at the bottom - I was looking at [this spot](http://www.sagemath.org/doc/developer/patching_spkgs.html#overview-of-patching-spkg-s), which says 
> Note that “p0” denotes the patch level of the spkg
Maybe we _should_ have a policy; it's kind of confusing, and in principle it would be nice to be able to tell with `sage -i` at a glance which packages we could just slap in and which ones needed a little care and feeding.  In particular, should p0 mean no patches and p1 means patches?  I bet there is inconsistency here, too - I certainly feel like I've seen packages that were labeled p1 but then someone (perhaps the release manager) said they should be p0 since it was the first (zeroth, but we use Python, of course (!)) patch...  sorry for even wasting time on this but it does seem just this side of useful, again.


---

Comment by vbraun created at 2013-05-02 16:43:59

Its hard to get excited about that, all that matters in the end is that you can tell which one  of two spkgs is newer.


---

Comment by jason created at 2013-05-02 18:19:41

Sagecell currently uses libzmq 2.2, but it doesn't look like there should be any problems upgrading to 3.2.  This spkg would allow us to remove a zmq dependency in the sagecell spkg, so thanks for looking at this!


---

Comment by stumpc5 created at 2013-05-03 08:43:28

Thanks for providing a new spkg! Unfortunately, I still get the same problem on one VM (to which I have root access, but which I haven't set up myself. If you need more info about the machine let me know how to get it). The old and as well the new version of the spkg do compile on my own 64bit Ubuntu computer.


```
asdf@findstatroot:~/sage-5.8$ ./sage -i http://boxen.math.washington.edu/home/vbraun/spkg/zeromq-3.2.0.p0.spkg

Attempting to download package zeromq-3.2.0.p0
>>> Downloading zeromq-3.2.0.p0.spkg.
[............................................................]
zeromq-3.2.0.p0

...

Host system:
Linux FindstatServer 3.5.0-27-generic #46-Ubuntu SMP Mon Mar 25 19:58:17 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
...
Thread model: posix
gcc version 4.6.3 (GCC) 
****************************************************

...

checking alloca.h usability... no
checking alloca.h presence... yes
configure: WARNING: alloca.h: present but cannot be compiled
configure: WARNING: alloca.h:     check for missing prerequisite headers?
configure: WARNING: alloca.h: see the Autoconf documentation
configure: WARNING: alloca.h:     section "Present But Cannot Be Compiled"
configure: WARNING: alloca.h: proceeding with the compiler's result
configure: WARNING:     ## ------------------------------------------ ##
configure: WARNING:     ## Report this to zeromq-dev@lists.zeromq.org ##
configure: WARNING:     ## ------------------------------------------ ##
checking for alloca.h... no
checking whether SOCK_CLOEXEC is supported... no
checking whether SO_KEEPALIVE is supported... no
checking whether TCP_KEEPCNT is supported... no
checking whether TCP_KEEPIDLE is supported... no
checking whether TCP_KEEPINTVL is supported... no
checking whether TCP_KEEPALIVE is supported... no
configure: creating ./config.status
config.status: creating Makefile
config.status: creating src/Makefile
config.status: creating doc/Makefile
config.status: creating perf/Makefile
config.status: creating src/libzmq.pc
config.status: creating builds/msvc/Makefile
config.status: creating tests/Makefile
config.status: creating foreign/openpgm/Makefile
config.status: creating builds/redhat/zeromq.spec
config.status: creating src/platform.hpp
config.status: executing depfiles commands
config.status: executing libtool commands
Making all in src
make[1]: Entering directory `/home/findstatroot/sage-5.8/spkg/build/zeromq-3.2.0.p0/src/src'
make  all-am
make[2]: Entering directory `/home/findstatroot/sage-5.8/spkg/build/zeromq-3.2.0.p0/src/src'
  CXX    libzmq_la-address.lo
  CXX    libzmq_la-clock.lo
  CXX    libzmq_la-ctx.lo
  CXX    libzmq_la-decoder.lo
  CXX    libzmq_la-devpoll.lo
In file included from /usr/include/x86_64-linux-gnu/sys/types.h:223:0,
                 from /usr/include/x86_64-linux-gnu/sys/epoll.h:23,
                 from epoll.hpp:30,
                 from poller.hpp:35,
                 from devpoll.hpp:26,
                 from devpoll.cpp:22:
/usr/include/x86_64-linux-gnu/sys/sysmacros.h:33:36: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
/usr/include/x86_64-linux-gnu/sys/sysmacros.h:36:36: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
/usr/include/x86_64-linux-gnu/sys/sysmacros.h:39:1: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
In file included from /usr/include/x86_64-linux-gnu/sys/types.h:271:0,
                 from /usr/include/x86_64-linux-gnu/sys/epoll.h:23,
                 from epoll.hpp:30,
                 from poller.hpp:35,
                 from devpoll.hpp:26,
                 from devpoll.cpp:22:
/usr/include/x86_64-linux-gnu/bits/pthreadtypes.h:121:19: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
/usr/include/x86_64-linux-gnu/bits/pthreadtypes.h:122:19: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
/usr/include/x86_64-linux-gnu/bits/pthreadtypes.h:123:19: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
/usr/include/x86_64-linux-gnu/bits/pthreadtypes.h:129:17: error: ISO C++ 1998 does not support 'long long' [-Werror=long-long]
cc1plus: all warnings being treated as errors
make[2]: *** [libzmq_la-devpoll.lo] Error 1
make[2]: Leaving directory `/home/findstatroot/sage-5.8/spkg/build/zeromq-3.2.0.p0/src/src'
make[1]: *** [all] Error 2
make[1]: Leaving directory `/home/findstatroot/sage-5.8/spkg/build/zeromq-3.2.0.p0/src/src'
make: *** [all-recursive] Error 1
Failed to build zeromq!


---

Comment by vbraun created at 2013-05-03 09:40:00

I've added `-Wno-long-long` to spkg-install, can you try again?


---

Comment by stumpc5 created at 2013-05-03 09:44:16

Replying to [comment:10 vbraun]:
> I've added `-Wno-long-long` to spkg-install, can you try again?

great, it does work now -- thanks!


---

Comment by vbraun created at 2013-05-03 09:49:17

Feel free to review the ticket then :-P


---

Comment by stumpc5 created at 2013-05-03 10:02:03

Replying to [comment:12 vbraun]:
> Feel free to review the ticket then :-P

I will give the ticket a positive review once the following question is positively answered:

> Jason, will having this zeromq be fine for the sage cell server, since that was the source of at least one of the ask.sagemath questions about this?

I can say that the provided zeromq spkg does install smoothly on one machine that had troubles before, it should thus solve my question on ask.sagemath. But I don't know if the new version of zeromq does interact properly with the sage cell.


---

Comment by JGuzman created at 2013-05-31 13:30:03

It worked fabulously in my hands! I tested with Sage 5.8 for both IPython notebook and Sage cell in Debian  (2.6.32-5-amd64) and Ubuntu (3.2.0-36-generic).


---

Comment by stumpc5 created at 2013-05-31 13:53:05

Replying to [comment:14 JGuzman]:
> It worked fabulously in my hands! I tested with Sage 5.8 for both IPython notebook and Sage cell in Debian  (2.6.32-5-amd64) and Ubuntu (3.2.0-36-generic). 

Thanks for checking, I then give it a positive review! Feel free to add your name as a reviewer...


---

Comment by stumpc5 created at 2013-05-31 13:53:05

Changing type from defect to enhancement.


---

Comment by stumpc5 created at 2013-05-31 13:53:05

Changing status from new to needs_review.


---

Comment by stumpc5 created at 2013-05-31 13:53:57

Changing status from needs_review to positive_review.


---

Comment by JGuzman created at 2013-05-31 13:57:29

My pleasure, is there anything I should do to review it more carefully?


---

Comment by stumpc5 created at 2013-05-31 15:32:54

Replying to [comment:17 JGuzman]:
> My pleasure

I think, reviewer names should be plain names, if possible.


---

Comment by JGuzman created at 2013-05-31 17:16:16

Replying to [comment:18 stumpc5]:
> Replying to [comment:17 JGuzman]:
> > My pleasure
> 
> I think, reviewer names should be plain names, if possible.

Good idea


---

Comment by schilly created at 2013-06-05 16:20:56

added to the optional packages on the server


---

Comment by jdemeyer created at 2013-06-05 19:51:41

Resolution: fixed


---

Comment by jdemeyer created at 2017-11-02 21:09:39

Replying to [comment:10 vbraun]:
> I've added `-Wno-long-long` to spkg-install, can you try again?

That would also be fixed by #24143.
