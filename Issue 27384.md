# Issue 27384: Fix file manifest doctest for distros

Issue created by migration from https://trac.sagemath.org/ticket/27621

Original creator: jhpalmieri

Original creation time: 2019-04-08 17:44:48

CC:  @timokau fbissey arojas embray

#27124 introduced a doctest for the validity of the file manifests in `local/var/lib/sage/installed/`. This breaks at least on nix, perhaps on other distros, because those manifests are either not present or are just empty placeholders.


---

Comment by jhpalmieri created at 2019-04-08 17:48:43

The `package_manifest` function can certainly test first and bail out if the file or directory does not exist, but if the file exists and is empty, then the test will fail (and probably should fail).

So what options are there? Should we create a new doctest tag – `# optional - buildsystem` was suggested at #27124 – which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an "optional" tag, it could be a different type of tag, the way we have `random` or `py2` or `long time`, etc.


---

Comment by jhpalmieri created at 2019-04-08 17:56:55

I'm making #27622 a dependency because that should be a trivial ticket to review and it touches the same code.


---

Comment by arojas created at 2019-04-08 18:55:19

Replying to [comment:2 jhpalmieri]:
> So what options are there? Should we create a new doctest tag – `# optional - buildsystem` was suggested at #27124 – which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an "optional" tag, it could be a 
different type of tag, the way we have `random` or `py2` or `long time`, etc.

I'd be very much in favour of this. There are currently quite a few doctests - particularly in sage/tests/cmdline.py and sage/misc/package.py modules - which fail simply because they make no sense in distro packages, so I'm just ignoring them for now. Removing this noise would be highly appreciated.


---

Comment by fbissey created at 2019-04-08 20:46:25

I was wondering what it was all about, so I did have a look at #27124. Well the doctest is in `misc/package.py` which, as a sage-on-distro person, I just want to die. In gentoo I am just replacing it with the only thing I ever need [https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py). Because I do that, I never noticed #27124.


---

Comment by embray created at 2019-04-10 13:02:18

Replying to [comment:5 arojas]:
> Replying to [comment:2 jhpalmieri]:
> > So what options are there? Should we create a new doctest tag – `# optional - buildsystem` was suggested at #27124 – which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an "optional" tag, it could be a 
> different type of tag, the way we have `random` or `py2` or `long time`, etc.
> 
> I'd be very much in favour of this. There are currently quite a few doctests - particularly in sage/tests/cmdline.py and sage/misc/package.py modules - which fail simply because they make no sense in distro packages, so I'm just ignoring them for now. Removing this noise would be highly appreciated. 

That's a fair point.  At first I wasn't sure how I feel about this idea but actually it would make a lot of sense to explicitly mark some tests that are only relevant to sage-the-distribution.  When running the tests out of a normal sage source tree build it would add those optional tests of course, but not otherwise.  This could be done quite easily I think.


---

Comment by embray created at 2019-04-10 13:04:14

I think I would call it `# optional - sagedist` but `build` or something like that is fine too.


---

Comment by embray created at 2019-04-10 13:37:44

I have created #27635 specifically for this approach.  Please follow up there.


---

Comment by jhpalmieri created at 2019-04-30 22:47:45

I think we can close this now: it's fixed by #27635, right?


---

Comment by jhpalmieri created at 2019-04-30 22:47:45

Changing status from new to needs_review.


---

Comment by fbissey created at 2019-04-30 23:39:12

I think so.


---

Comment by fbissey created at 2019-04-30 23:39:12

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-05-02 14:27:30

Resolution: worksforme
