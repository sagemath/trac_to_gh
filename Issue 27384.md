# Issue 27384: Fix file manifest doctest for distros

archive/issues_027384.json:
```json
{
    "body": "CC:  @timokau fbissey arojas embray\n\n#27124 introduced a doctest for the validity of the file manifests in `local/var/lib/sage/installed/`. This breaks at least on nix, perhaps on other distros, because those manifests are either not present or are just empty placeholders.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27621\n\n",
    "created_at": "2019-04-08T17:44:48Z",
    "labels": [
        "distribution",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Fix file manifest doctest for distros",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27384",
    "user": "jhpalmieri"
}
```
CC:  @timokau fbissey arojas embray

#27124 introduced a doctest for the validity of the file manifests in `local/var/lib/sage/installed/`. This breaks at least on nix, perhaps on other distros, because those manifests are either not present or are just empty placeholders.

Issue created by migration from https://trac.sagemath.org/ticket/27621





---

archive/issue_comments_385979.json:
```json
{
    "body": "The `package_manifest` function can certainly test first and bail out if the file or directory does not exist, but if the file exists and is empty, then the test will fail (and probably should fail).\n\nSo what options are there? Should we create a new doctest tag \u2013 `# optional - buildsystem` was suggested at #27124 \u2013\u00a0which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an \"optional\" tag, it could be a different type of tag, the way we have `random` or `py2` or `long time`, etc.",
    "created_at": "2019-04-08T17:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385979",
    "user": "jhpalmieri"
}
```

The `package_manifest` function can certainly test first and bail out if the file or directory does not exist, but if the file exists and is empty, then the test will fail (and probably should fail).

So what options are there? Should we create a new doctest tag – `# optional - buildsystem` was suggested at #27124 – which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an "optional" tag, it could be a different type of tag, the way we have `random` or `py2` or `long time`, etc.



---

archive/issue_comments_385980.json:
```json
{
    "body": "I'm making #27622 a dependency because that should be a trivial ticket to review and it touches the same code.",
    "created_at": "2019-04-08T17:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385980",
    "user": "jhpalmieri"
}
```

I'm making #27622 a dependency because that should be a trivial ticket to review and it touches the same code.



---

archive/issue_comments_385981.json:
```json
{
    "body": "Replying to [comment:2 jhpalmieri]:\n> So what options are there? Should we create a new doctest tag \u2013 `# optional - buildsystem` was suggested at #27124 \u2013\u00a0which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an \"optional\" tag, it could be a \ndifferent type of tag, the way we have `random` or `py2` or `long time`, etc.\n\nI'd be very much in favour of this. There are currently quite a few doctests - particularly in sage/tests/cmdline.py and sage/misc/package.py modules - which fail simply because they make no sense in distro packages, so I'm just ignoring them for now. Removing this noise would be highly appreciated.",
    "created_at": "2019-04-08T18:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385981",
    "user": "arojas"
}
```

Replying to [comment:2 jhpalmieri]:
> So what options are there? Should we create a new doctest tag – `# optional - buildsystem` was suggested at #27124 – which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an "optional" tag, it could be a 
different type of tag, the way we have `random` or `py2` or `long time`, etc.

I'd be very much in favour of this. There are currently quite a few doctests - particularly in sage/tests/cmdline.py and sage/misc/package.py modules - which fail simply because they make no sense in distro packages, so I'm just ignoring them for now. Removing this noise would be highly appreciated.



---

archive/issue_comments_385982.json:
```json
{
    "body": "I was wondering what it was all about, so I did have a look at #27124. Well the doctest is in `misc/package.py` which, as a sage-on-distro person, I just want to die. In gentoo I am just replacing it with the only thing I ever need [https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py). Because I do that, I never noticed #27124.",
    "created_at": "2019-04-08T20:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385982",
    "user": "fbissey"
}
```

I was wondering what it was all about, so I did have a look at #27124. Well the doctest is in `misc/package.py` which, as a sage-on-distro person, I just want to die. In gentoo I am just replacing it with the only thing I ever need [https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py). Because I do that, I never noticed #27124.



---

archive/issue_comments_385983.json:
```json
{
    "body": "Replying to [comment:5 arojas]:\n> Replying to [comment:2 jhpalmieri]:\n> > So what options are there? Should we create a new doctest tag \u2013 `# optional - buildsystem` was suggested at #27124 \u2013\u00a0which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an \"optional\" tag, it could be a \n> different type of tag, the way we have `random` or `py2` or `long time`, etc.\n> \n> I'd be very much in favour of this. There are currently quite a few doctests - particularly in sage/tests/cmdline.py and sage/misc/package.py modules - which fail simply because they make no sense in distro packages, so I'm just ignoring them for now. Removing this noise would be highly appreciated. \n\nThat's a fair point.  At first I wasn't sure how I feel about this idea but actually it would make a lot of sense to explicitly mark some tests that are only relevant to sage-the-distribution.  When running the tests out of a normal sage source tree build it would add those optional tests of course, but not otherwise.  This could be done quite easily I think.",
    "created_at": "2019-04-10T13:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385983",
    "user": "embray"
}
```

Replying to [comment:5 arojas]:
> Replying to [comment:2 jhpalmieri]:
> > So what options are there? Should we create a new doctest tag – `# optional - buildsystem` was suggested at #27124 – which is on by default and depends on Sage's packaging infrastructure? It doesn't have to be an "optional" tag, it could be a 
> different type of tag, the way we have `random` or `py2` or `long time`, etc.
> 
> I'd be very much in favour of this. There are currently quite a few doctests - particularly in sage/tests/cmdline.py and sage/misc/package.py modules - which fail simply because they make no sense in distro packages, so I'm just ignoring them for now. Removing this noise would be highly appreciated. 

That's a fair point.  At first I wasn't sure how I feel about this idea but actually it would make a lot of sense to explicitly mark some tests that are only relevant to sage-the-distribution.  When running the tests out of a normal sage source tree build it would add those optional tests of course, but not otherwise.  This could be done quite easily I think.



---

archive/issue_comments_385984.json:
```json
{
    "body": "I think I would call it `# optional - sagedist` but `build` or something like that is fine too.",
    "created_at": "2019-04-10T13:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385984",
    "user": "embray"
}
```

I think I would call it `# optional - sagedist` but `build` or something like that is fine too.



---

archive/issue_comments_385985.json:
```json
{
    "body": "I have created #27635 specifically for this approach.  Please follow up there.",
    "created_at": "2019-04-10T13:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385985",
    "user": "embray"
}
```

I have created #27635 specifically for this approach.  Please follow up there.



---

archive/issue_comments_385986.json:
```json
{
    "body": "I think we can close this now: it's fixed by #27635, right?",
    "created_at": "2019-04-30T22:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385986",
    "user": "jhpalmieri"
}
```

I think we can close this now: it's fixed by #27635, right?



---

archive/issue_comments_385987.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-30T22:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385987",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_385988.json:
```json
{
    "body": "I think so.",
    "created_at": "2019-04-30T23:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385988",
    "user": "fbissey"
}
```

I think so.



---

archive/issue_comments_385989.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-30T23:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385989",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_385990.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-05-02T14:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27384#issuecomment-385990",
    "user": "embray"
}
```

Resolution: worksforme
