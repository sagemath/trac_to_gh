# Issue 17447: density_plot() is broken with functions involving symbolic expressions

Issue created by migration from https://trac.sagemath.org/ticket/17684

Original creator: tmonteil

Original creation time: 2015-01-28 12:06:43

CC:  kcrisman

As reported on [this ask question](http://ask.sagemath.org/question/25617/density_plot-defed-python-function-typeerror/), the following does not work:


```
sage: f1(a, b) = 1 - b / a
sage: f2(a, b) = 1 - a / b
sage: def f12(a, b):
....:         if a - b < 0:
....:                 return f1(a, b)
....:         else:
....:                 return f2(a, b)
sage: density_plot(f,(1,2),(1,2))
KeyError: 'text/plain'
```


While the following works:


```
sage: f1(a, b) = 1 - b / a
sage: f2(a, b) = 1 - a / b
sage: def f12(a, b):
....:     if a - b < 0:
....:         return RDF(f1(a, b))
....:     else:
....:         return RDF(f2(a, b))
sage: density_plot(f12,(1,2),(1,2))
```




---

Comment by @DaveWitteMorris created at 2021-02-09 08:45:09

New commits:


---

Comment by @DaveWitteMorris created at 2021-02-09 08:45:09

Changing status from new to needs_review.


---

Comment by kcrisman created at 2021-02-09 13:42:26

Nice.  Unfortunately I can't upgrade my Sage currently to actually check this (quite old computer with fragile installation, based on past experience, and I can't afford to bork it), but patchbot says okay ... would you be willing to post some of the plots from the documentation (Including the tests for bug fixes, including your new one) here to verify?  Then I'd be happy to provide positive review, the code should certainly be okay.

----

That said, the real bug here is in `fast_float`, because it should still be taking this function in `setup_for_eval_on_grid` and doing the "right" thing with it.  See [this admittedly bizarre Sage cell interact](https://sagecell.sagemath.org/?z=eJyFUNuKwyAQfRf8h3k0YLON0JfQwv5HCGJSFSHRMNr9_h3bprAX6HkQ5Vxmjtl424PrhJEwNXCBDg4wwQcYzvKDUz84Q9y0c1fryPsU9Jy1hB52BEfqmnaG4x9yB9pyw_ja4LfMLtm-9ard-9wY0wr12m5LKu0a8gxh3RIWyOTYtEuo7ZdZdIraY7hyxtlniMWimQtntZUW7hbny0DtpOukU2PtV4d6CWiit5k-5P84MVTvKGEQnVSNvJ_0VKfmEbEhDRN-OI7NN3AcY8Q=&lang=sage&interacts=eJyLjgUAARUAuQ==).  Maybe we should open/search for a ticket about this error - I'm sure it comes up elsewhere, there are definitely open tickets with `fast_float` or `fast_callable` and I know some have suggested completely rewriting that code.


---

Comment by kcrisman created at 2021-02-09 13:43:20

(And of course if providing all that is too much to ask, that's fine too; I'm sure someone else will be able to review this, it's an obvious hotfix.)


---

Attachment

density plot doctests


---

Comment by @DaveWitteMorris created at 2021-02-14 01:15:12

I think the attachment ([density_plots.pdf](https://trac.sagemath.org/attachment/ticket/17684/density_plots.pdf)) has all of the plots that are in the doctests of this file. (Let me know if I missed any that you were wondering about.) However, I jpeg-compressed the file, so there are some artifacts, especially where the plot has white at an edge.

I did not find the issue of this ticket listed anywhere.  (Related: ticket #5572 seems to suggest replacing `fast_float` with `fast_callable`.)  I agree that the real problem is in `fast_float`, so probably a ticket should be opened (or a comment added to #5572).  I think that fix will take more care, because `RDF` works on this ticket, but I suspect that `fast_float` will need to consider the precision of its inputs before choosing the field of floating-point numbers to use.


---

Comment by kcrisman created at 2021-02-14 03:44:28

Nice, thank you very much!

Yes, go ahead and make a comment there at least - that is one of the tickets I was thinking of.


---

Comment by kcrisman created at 2021-02-14 03:44:28

Changing status from needs_review to positive_review.


---

Comment by @DaveWitteMorris created at 2021-02-16 05:53:59

Thanks for the reviews. I added a comment to the description of #5572.


---

Comment by vbraun created at 2021-03-01 00:21:04

Resolution: fixed


---

Comment by slelievre created at 2021-03-01 15:25:11

Thanks for fixing this. Is the problem reported
in [Ask Sage question 55824](https://ask.sagemath.org/question/55824) related?


---

Comment by @DaveWitteMorris created at 2021-03-11 21:47:19

It may be a similar issue, but I don't understand what is going on there. I opened #31488.
