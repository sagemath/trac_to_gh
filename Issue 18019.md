# Issue 18019: recythonize only if cython really changed

Issue created by migration from https://trac.sagemath.org/ticket/18256

Original creator: rws

Original creation time: 2015-04-20 07:14:36

Keywords: cythonize

In #17851 cycache was necessarily disabled. This now leads to recythonizing everything when only the cython version **number was touched** (e.g. by checking out an old branch followed by merging develop). Ideally, cythonizing everything should only happen if the cython binary is different when compared to the last cythonizing.


---

Comment by vdelecroix created at 2015-04-20 19:16:42

This was already reported upstream in #17851. We should not have a Sage specific solution for that! Of course we would have to set again the cache once this will be fixed upstream...


---

Comment by jdemeyer created at 2015-04-21 06:00:34

If the Cython version number was touched, it means that Cython really changed (otherwise, we wouldn't have changed the Cython version number...). So I don't really understand the issue.


---

Comment by rws created at 2015-04-21 06:34:55

Replying to [comment:2 jdemeyer]:
> If the Cython version number was touched, it means that Cython really changed (otherwise, we wouldn't have changed the Cython version number...). So I don't really understand the issue.
Maybe I'm stupid but somewhere the dependencies are described, e.g., in a Makefile or other config, which trigger the complete build. Instead, you trigger it when the version string changes, not when the timestamp changes. This results in identical behaviour on upgrade, but spares full recythonize when I do an old branch checkout followed by develop merge.


---

Comment by jdemeyer created at 2015-04-21 07:43:51

Replying to [comment:3 rws]:
> Replying to [comment:2 jdemeyer]:
> > If the Cython version number was touched, it means that Cython really changed (otherwise, we wouldn't have changed the Cython version number...). So I don't really understand the issue.
> Maybe I'm stupid but somewhere the dependencies are described, e.g., in a Makefile or other config, which trigger the complete build. Instead, you trigger it when the version string changes, not when the timestamp changes. This results in identical behaviour on upgrade, but spares full recythonize when I do an old branch checkout followed by develop merge.
???

I really don't understand what you are saying. Could you please clearly indicate _the problem_ (not an analysis or a fix, just the problem).


---

Comment by rws created at 2015-04-21 07:55:58

Replying to [comment:4 jdemeyer]:
> I really don't understand what you are saying. Could you please clearly indicate _the problem_ (not an analysis or a fix, just the problem).
I frequently checkout older branches to do a fix or a review. After checkout I often merge develop. Now when I `make`, due to (my guess) the change back and forth in cython version a full recythonize is triggered. But it is IMHO not necessary because I merged develop and so, only some Python code really changed, or only specific `pyx` files. The proposal here is to optimize the `make` behaviour in such cases.


---

Comment by jdemeyer created at 2015-04-21 08:00:10

Changing component from cython to build.


---

Comment by jdemeyer created at 2015-04-21 08:00:10

This has nothing to do with Cython, but with `make`.


---

Comment by jdemeyer created at 2015-04-21 08:00:28

Changing keywords from "cythonize" to "".


---

Comment by jdemeyer created at 2015-04-21 08:03:53

To clarify: this would happen with every package upgrade. Since building Cython and re-cythonizing takes a long time, you just notice it more when it's Cython which is being rebuilt.


---

Comment by jdemeyer created at 2015-04-21 08:07:34

Hmm no, that's not true. There is logic in `src/bin/sage-spkg` to not re-build packages if you're installing the version which is already installed.


---

Comment by jdemeyer created at 2015-04-21 08:11:41

Replying to [comment:5 rws]:
> a full recythonize is triggered.
Are you sure it's really a full recythonize and not just a rebuild of all files depending on a common file like `src/ext/interrupt.pxi`? It's true that Cython (just like `make`) uses timestamps to trigger rebuilds, so if the timestamp of `src/ext/interrupt.pxi` changes, then all Cython extensions depending on that (i.e. almost all of them) would be recythonized.

If this is the problem, I would like to close this ticket as `wontfix` since it's a feature, not a bug, to use timestamps for dependency checking. And even if it would be a bug, it's in upstream Cython, not Sage.


---

Comment by rws created at 2015-04-21 08:25:12

Replying to [comment:10 jdemeyer]:
> ...so if the timestamp of `src/ext/interrupt.pxi` changes, then all Cython extensions depending on that (i.e. almost all of them) would be recythonized.
Then that seems to have been the reason. If there is no way to make that more fine-grained I agree with wontfix here.


---

Comment by jdemeyer created at 2015-04-21 08:31:40

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-04-21 08:31:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-22 00:07:44

Resolution: wontfix
