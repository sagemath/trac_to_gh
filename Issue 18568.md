# Issue 18568: Add didactical implementation of tableau cutting planes to interactive_simplex_method

Issue created by migration from https://trac.sagemath.org/ticket/18805

Original creator: mkoeppe

Original creation time: 2015-06-28 19:45:26

CC:  novoselt yzh zwang pjxiao

We are working on a didactical implementation of the cutting plane method using tableau cutting planes,
such as Gomory's fractional cut and Gomory's mixed integer cut.

This would work with `InteractiveLP`, `LPAbstractDictionary`, etc.
(Via #18804, one could run the cutting plane method also on a backend tableau.)

To work correctly with mixed integer problems, one would need to remember which variables are real and which are integer. 

Would it be acceptable to add a slot such as `._integer_variables` (a set), and a corresponding accessor `.integer_variables`() to the various classes of interactive_simplex_method?




---

Comment by novoselt created at 2015-06-28 22:12:47

I think this would be great, but the interface should be very clean not to scare students ;-) Various checks and methods like `optimal_solution` should of course then be modified to take integrality into consideration.


---

Comment by mkoeppe created at 2015-07-30 04:22:01

We now have an implementation of the Gomory fractional and Gomory mixed integer cutting plane methods.

This is on top of an old version of #18742, and we'll later of course rebase it on top of the final version of it. 
But comments on the general design would already be very welcome at this point:

https://github.com/pgxiao/sage/blob/Peggy/src/sage/numerical/interactive_simplex_method.py


---

Comment by mkoeppe created at 2015-08-19 23:20:35

It is now rebased on top of current 'develop'.

Needs review.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2015-08-19 23:20:35

Changing status from new to needs_review.


---

Comment by novoselt created at 2015-08-20 03:41:06

I hope to take a closer look during upcoming Sage Days, but some picks at formatting for now, http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings has a long example docsctring:

 - there should be empty lines between arguments
 - there should be no empty lines (especially multiple ones) in the very beginning and the very end
 - references to other methods should be marked with `:meth:`, `:func:`, `:class:` as appropriate
 - the very first line should be a one-line description and if at all possible it should take only one line
 - mathematics should be in single back quotes and use of LaTeX is encouraged
 - there should be empty lines after `::` and before the test blocks
 - there should be `::` before EVERY test block

While some of these things are convention/taste/style, others are just plain necessary for documentation and testing frameworks to work. As you can see from the patchbot result, the current version does not build.


---

Comment by novoselt created at 2015-08-20 03:41:06

Changing status from needs_review to needs_work.


---

Comment by pjxiao created at 2015-08-21 22:45:50

Thanks a lot for taking a look and for your comments.Â 

I have revised the docstrings. The current version is supposed to build successfully. New commits:



---

Comment by pjxiao created at 2015-08-21 22:45:50

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2015-08-24 22:39:57

The very first change with all the commits::

```
+def form_thin_long_triangle(k):
+    r"""
+
+    Generate a thin long triangle with vertices (0, 0), (1, 0), and (1/2, k)
+    for some given integer K, and return the triangle in Ax<=b form.
+    This thin long triangle is an example of a system with large Chvatal rank.
+
+    INPUT:
+    -``k``-- an integer indicating the y coordinate of the top vertex for the triangle
+
+    OUTPUT:
+    -``A`` -- a two by two matrix
+    -``b`` -- a two-element vector
+
+    EXAMPLES::
+        sage: from sage.numerical.interactive_simplex_method \
+        ....:     import form_thin_long_triangle
+        sage: A, b, = form_thin_long_triangle(4)
+        sage: A, b
+        (([-8, 1], [8, 1]), (0, 8))
+
+    """
+    A = ([Integer(-2 * k), Integer(1)], [Integer(2 * k), Integer(1)])
+    b = (Integer(0), Integer(2 * k))
+    type(b[0])
+    return A, b
```


 - empty line in the beginning of the docstring
 - no one-line description in the beginning
 - math should be written as LaTeX
 - INPUT/OUTPUT/EXAMPLES blocks lack empty lines
 - I do not understand the documentation - what does it mean to generate a triangle in the form Ax<=b?
 - the output does not match the documentation, A is not a matrix and b is not a vector
 - there is no need in `Integer` conversion (and its import)
 - `type(...)` does nothing useful
 - why would a user need such a function??? If it is for internal use, perhaps start with underscore.


---

Comment by novoselt created at 2015-08-24 22:39:57

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2015-08-24 22:55:27


```
+        Examples for the sufficient conditions for integer slack variables::
+
+            sage: P = InteractiveLPProblem(A, b, c)
+            sage: P.integer_variables()
+            set()
+            sage: P = InteractiveLPProblem(A, b, c, integer_variables=True)
+            sage: P.integer_variables()
+            {x1, x2, x3, x4}
+            sage: b1 = (11/10, 5)
+            sage: P = InteractiveLPProblem(A, b1, c, integer_variables=True)
+            sage: P.integer_variables()
+            {x1, x2, x4}
+            sage: A1 = ([1, 1], [3/10, 1])
+            sage: P = InteractiveLPProblem(A1, b1, c, integer_variables=True)
+            sage: P.integer_variables()
+            {x1, x2}
+
+        Allow the user to choose integer slack variables which may violate the sufficient conditions::
+
+            sage: P = InteractiveLPProblem(A, b, c, integer_variables={'x1', 'x2', 'x3'})
+            sage: P.integer_variables()
+            {x1, x2, x3}
```

I do not understand the comments here. These examples should demonstrate creation of problems and use of parameters, there was no talk about slack variables, sufficient conditions, and their violation.


---

Comment by novoselt created at 2015-08-24 23:05:44


```
+        slack_variables = ["{}{:d}".format("x", i)
+                               for i in range(n + 1, n + m + 1)]
```

After all the work for supporting different styles there are now slack variables hard-coded to be x in generic problems that did not use to even have slack variables?!

This is not going to work for such a huge patch. Can you please provide a detailed text overview of what exactly should be achieved by this ticket and the plan of how this will be done?

It would be great also to have an incremental set of tickets that add new functionality without affecting much existing code. Looking at the commit messages, I am quite puzzled by the move of `ELLUL` method to abstract dictionaries: I think it does not make sense for revised dictionaries and for the regular ones its implementation relies on knowledge of the latex representation of these regular dictionaries - so it does belong to the place where it originally was...


---

Comment by novoselt created at 2015-08-24 23:23:57


```
+            integer_variables=self.integer_variables())
```

Most definitely wrong while constructing either a dual problem or converting to standard form!!!

The current code was used by several hundred students for working on individual assignments (i.e. applied to quite different problems some of which exposed corner cases), so it is relatively bug free and easy to use/consistent. With major changes it may be a good idea to use it for your course, make tweaks that surface during the term, and then work on a patch for changing the standard module.


---

Comment by novoselt created at 2015-08-24 23:33:53

As a possibility to consider - derive new classes like

```
class InteractiveMILPProblem(InteractiveLPProblem):
   ...
```

that will concentrate just on Gomory's cuts.


---

Comment by mkoeppe created at 2015-08-25 22:38:58

Thanks for your initial comments.

The individual commits on this branch, if you read them in the right order (from oldest to newest -- the commit with the triangle testcase is the last commit before the commits that clean up docstrings), add features gradually and should be easy to review. 

Making ELLUL available for both LPDictionary and LPRevisedDictionary is motivated by implementing run_dual_simplex_method as a dictionary method. I think this makes a lot of sense because each of the individual methods that ELLUL stands for are available for both dictionary types.

We need this as a subroutine for the cutting plane method. (Perhaps run_simplex_method and run_revised_simplex_method can and should be refactored as well and pushed down to become dictionary methods?)


---

Comment by git created at 2015-08-26 00:20:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2015-08-26 22:24:18

Replying to [comment:13 mkoeppe]:
> (Perhaps run_simplex_method and run_revised_simplex_method can and should be refactored as well and pushed down to become dictionary methods?)

We'll redo this ticket on top of #19097 that does the above and implements the dual simplex method. 
This is to make the present ticket smaller.


---

Comment by git created at 2015-09-05 17:08:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-09 03:15:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-24 21:46:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-30 06:41:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2015-10-04 17:59:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-04 22:59:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-22 17:56:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by novoselt created at 2015-10-22 20:43:23

I still think that this would be the ideal solution:

Replying to [comment:12 novoselt]:
> As a possibility to consider - derive new classes like
> {{{
> class InteractiveMILPProblem(InteractiveLPProblem):
>    ...
> }}}
> that will concentrate just on Gomory's cuts.

It may even make sense to start a new file for that given that current simplex method implementation is almost 4.5k lines. And I am not an expert in terminology, but my understanding is that "simplex method" is for real variables while Gomory cuts is a way to use it repeatedly adjusting constraints to solve integer optimization problems, i.e. "it builds on simplex method". Apart from ease of reviewing, it may make sense didactically as those who study simplex method may want to look at the code as well, so it is good to keep it simpler/cleaner.


---

Comment by mkoeppe created at 2015-10-22 21:29:50

Replying to [comment:25 novoselt]:
> I still think that this would be the ideal solution:
> 
> Replying to [comment:12 novoselt]:
> > As a possibility to consider - derive new classes like
> > {{{
> > class InteractiveMILPProblem(InteractiveLPProblem):
> >    ...
> > }}}
> > that will concentrate just on Gomory's cuts.
> 
> It may even make sense to start a new file for that given that current simplex method implementation is almost 4.5k lines. And I am not an expert in terminology, but my understanding is that "simplex method" is for real variables while Gomory cuts is a way to use it repeatedly adjusting constraints to solve integer optimization problems, i.e. "it builds on simplex method".

Yes.

> Apart from ease of reviewing, it may make sense didactically as those who study simplex method may want to look at the code as well, so it is good to keep it simpler/cleaner.

Yes, we'll look into this. But a few things from this patch would still make sense to add to the existing classes:

1) Refactoring of the plot method
2) Refactoring leaving_coefficients through row_coefficients etc.
3) The add_row methods

We can make separate tickets for all of these -- let me know.


---

Comment by novoselt created at 2015-10-22 23:43:24

Separate tickets for separate problems are always better ;-)

The sensitivity analysis methods require some careful thinking for fitting in into existing framework where:
 - problems are thought to be immutable (and I think it is a good decision in line with how other stuff in Sage works), so adding/removing constraints to them should return a new problem with augmented matrices etc;
 - dictionaries are mutable, but are supposed to always represent the same problem;
 - regular dictionaries are standalone entities that are not aware of "the original problem", which makes sense since they carry all the information, while revised dictionaries do remember the problem, which also makes sense since they rely on its data for computing necessary stuff.

It probably makes sense to have something like `problem.add_stuff(stuff_to_add, dictionary=None)` which returns the new problem and, optionally given a dictionary for the old problem, also a related dictionary for the new problem.


---

Comment by git created at 2016-03-04 02:16:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-04-09 05:37:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2016-04-09 05:39:13

rebased on top of 7.2.beta3


---

Comment by git created at 2016-04-26 00:32:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by novoselt created at 2016-04-26 03:13:23

So what exactly is going on here? I thought we have reached an agreement that it would be better to keep the simplex method stuff as is and have a separate class/module for dealing with integer variables via Gomory's cuts, changing problems and running simplex method repeatedly. As it stands now, this is a single huge commit changing a lot of code and injecting integer variables directly into `InteractiveLPProblem`.


---

Comment by mkoeppe created at 2016-04-26 03:49:36

Nothing much going on. The main author is busy with classes. 
I'm rebasing occasionally to keep it up-to-date with sage. 
The plan is to follow your suggestion and make it a separate set of classes.

But please take a look at #20500, split out (and cleaned up) from this huge patch.


---

Comment by git created at 2016-04-26 04:12:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2016-04-26 04:13:17

Rebased on top of #20500; it seems to work again.


---

Comment by pjxiao created at 2016-05-01 00:48:35

New commits:


---

Comment by git created at 2016-05-01 21:55:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-04 03:39:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-05-05 00:14:24

A part of this is now split out as #20559. Will rebase on top of that later.


---

Comment by mkoeppe created at 2020-01-23 18:25:57

Development of this, based on pjxiao's Aug 24, 2016 version from https://github.com/pgxiao/sage.git, is now taking place at https://github.com/mkoeppe/sage-numerical-interactive-mip

The present ticket should be closed.


---

Comment by mkoeppe created at 2020-01-23 18:25:57

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2020-01-23 21:13:22

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-01-24 08:21:42

Resolution: invalid
