# Issue 18075: Construction of a sparse matrix from sparse vectors does not exploit sparseness

Issue created by migration from https://trac.sagemath.org/ticket/18312

Original creator: nthiery

Original creation time: 2015-04-27 16:03:20

CC:  jdemeyer vdelecroix


```
sage: n = 10^3
sage: F = FreeModule(QQ, n, sparse=True)
sage: v = F.an_element()
sage: vectors = [v]*n

sage: %time a = matrix(vectors, sparse=True)
CPU times: user 2.01 s, sys: 38.4 ms, total: 2.05 s
Wall time: 1.96 s
```


Compare with the construction of the same matrix through an
intermediate dictionary:


```
sage: %time b = matrix(QQ, n, {(i,j): c for i,v in enumerate(vectors) for j,c in v.iteritems()}, sparse=True)
CPU times: user 7.33 ms, sys: 124 Âµs, total: 7.46 ms
Wall time: 6.06 ms
sage: a == b
True
```


Running `%prun` shows that the input vectors are converted to dense
lists and back (gasp), which gives a complexity of `n^2` instead of
linear in the number of nonzero entries as would be expected.


---

Comment by nthiery created at 2015-04-27 16:05:57

Changing keywords from "" to "sparse matrix constructor".


---

Comment by tscrim created at 2017-10-26 07:29:52

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-10-26 07:29:52

With my branch, I get:

```
sage: n = 10^3
sage: F = FreeModule(QQ, n, sparse=True)
sage: v = F.an_element()
sage: vecs = [v]*n
sage: %time a = matrix(vecs, sparse=True)
CPU times: user 8 ms, sys: 0 ns, total: 8 ms
Wall time: 4.76 ms
sage: MS = MatrixSpace(QQ, n, sparse=True)
sage: %time b = MS(vecs)
CPU times: user 4 ms, sys: 0 ns, total: 4 ms
Wall time: 1.31 ms
sage: %time c = matrix(QQ, n, {(i,j): c for i,v in enumerate(vecs) for j,c in v.iteritems()}, sparse=True)
CPU times: user 4 ms, sys: 0 ns, total: 4 ms
Wall time: 2.93 ms
```

----
New commits:


---

Comment by git created at 2018-02-04 23:50:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2018-07-03 20:35:52

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by git created at 2019-08-03 10:02:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-08-03 10:32:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-08-03 10:32:43

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-08-03 10:32:43

Rebased on the matrix constructor and tests pass in the matrix folder.


---

Comment by vdelecroix created at 2019-08-03 14:05:21

In

```
if isinstance(e[0], Vector) and all(vec.is_sparse() for vec in e):
```

you seem to assume that if the first element of the list is a vector than all elements are. This would break on something like

```
matrix(3, [vector([0,1,0],sparse=True), [0,1,0], [1,1,1]])
```



---

Comment by tscrim created at 2019-08-03 15:45:55

I know, but that matches what `sequence_type()` does. So I am just following the same assumption.


---

Comment by vdelecroix created at 2019-08-16 20:19:23

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2019-08-16 20:19:23

It is quite fragile then! It is not uncommon to have a bunch of vectors that we want to use to construct rows `0,...,k` and then feed a list for the `k+1`-th row.
Since it follows the design I guess it is what should be done...


---

Comment by tscrim created at 2019-08-16 22:54:33

Yea, I agree, but it probably requires a little larger of a change to fix it properly. Thank you for the review.


---

Comment by vbraun created at 2019-08-18 18:46:50

Resolution: fixed
