# Issue 21495: Move runtime documentation python modules into sagelib

Issue created by migration from https://trac.sagemath.org/ticket/21732

Original creator: infinity0

Original creation time: 2016-10-19 22:00:42

CC:  hivert isuruf fbissey jhpalmieri arojas

This would make life easier for binary distros. At the moment we (Debian) don't install SAGE_SRC or SAGE_DOC_SRC anywhere, but some (but not all) of the files here are needed at runtime for functionality such as '?'-suffix syntax.

I think it would be cleaner, both for Debian as well as Sage upstream, to move the following files like this:

- src/doc/common/* -> src/sage/doc/common/*
- src/doc/en/introspect/* -> src/sage/doc/introspect/*

This would also allow you to remove the sys.path and os.environ hacks that are currently in place everywhere, as well as to remove the `OMIT = ["introspect"]` exception in src/sage_setup/docbuild/build_options.py.

Does this sound sensible? If so I can do this for our Debian packaging already, test it, and send in an initial patch.


---

Comment by jdemeyer created at 2016-10-20 06:25:08

Putting the documentation as top-level directory of the project is the standard thing to do with Sphinx. We aren't quite using Sphinx in the standard way as there is a lot of Sage customization, but still... I see no reason to be even more different.

Just saying "it would make our lives easier to do X" is not a good explanation. You really need to justify better why you want to do X.


---

Comment by infinity0 created at 2016-10-20 07:18:21

Why is reducing development cost not a good explanation? None of the files I mentioned are actual direct sphinx config files, they are all meant to be included or used by something else. So they are already not being used in a "standard Sphinx way".


---

Comment by infinity0 created at 2016-10-20 07:18:54

Changing the title back because the ticket is not about moving all documentation sources.


---

Comment by jdemeyer created at 2016-10-20 07:27:22

Replying to [comment:2 infinity0]:
> Why is reducing development cost not a good explanation?

If you use an argument of the form "I want X because it helps Y" and we both agree that Y is a good thing, you still need to explain why X helps with Y. And I am totally missing that.

And this title is totally confusing me, I hardly see how it relates to moving `src/doc/common`. It might relate to moving the `introspect` doc, but then the title covers only a part of the ticket.


---

Comment by infinity0 created at 2016-10-20 07:39:38

It reduces development cost because you no longer have to track SAGE_DOC_SRC in many places and hack it into `sys.path` from `os.environ`. You can just do `from sage.doc.common import conf` or `from sage.doc.introspect import conf`. This helps with tickets like #21495 which is what we ideally need in Debian (but currently need to hack the equivalent functionality in via patches).

In additional to reducing development cost, this change (or something similar) is *necessary* for binary distributions because we normally don't install things like SAGE_SRC or SAGE_DOC_SRC onto end user machines, yet the files I mentioned are needed at runtime - and only these files, not the other `conf.py` files or doc sources.


---

Comment by infinity0 created at 2016-10-20 07:42:39


```
$ git grep SAGE_DOC_SRC -- src/sage
[..]
src/sage/misc/sagedoc.py:    sys.path = [os.path.join(SAGE_DOC_SRC, 'common')] + oldpath
[..]
src/sage/misc/sphinxify.py:    confdir = os.path.join(SAGE_DOC_SRC, 'en', 'introspect')
```


are the relevant lines.


---

Comment by jdemeyer created at 2016-10-20 12:25:53

Replying to [comment:5 infinity0]:
> It reduces development cost because you no longer have to track SAGE_DOC_SRC in many places and hack it into `sys.path` from `os.environ`. You can just do `from sage.doc.common import conf` or `from sage.doc.introspect import conf`. This helps with tickets like #21495 which is what we ideally need in Debian (but currently need to hack the equivalent functionality in via patches).

This explanation should be in the ticket description. There is no way I could figure out the above paragraph from just reading the description.


---

Comment by infinity0 created at 2016-10-20 17:34:23

Alright, sorry, I'll take some more time writing future tickets. I've edited the description now, hopefully it's OK.


---

Comment by jdemeyer created at 2016-10-21 13:06:05

At least I understand the problem now. Still, I don't know the best way to fix it.


---

Comment by mkoeppe created at 2016-10-23 07:01:53

I agree that sage at runtime should not refer to anything in SAGE_DOC_SRC.
Whatever is needed from there should be installed in an appropriate place in SAGE_LOCAL.


---

Comment by embray created at 2016-12-07 14:10:29

I noticed this recently too--glad to see there's already an issue for it.  I agree, using a location in `SAGE_LOCAL` would be best.


---

Comment by embray created at 2016-12-12 14:07:28

I'm starting to agree it would be good if this common doc stuff just went in a `sage.misc.docs` sub-package or something.  As it is common/conf.py imports from sage so it already has a dependency on it anyways.

This would be a good move toward the previously-discussed ideal of making it easier for third-party packages to use Sage's documentation utilities.

Another options which I've brought up before is to move all docs-related utilities to a separate sage_documention package (to which `sage_setup.docbuild` would also be moved).  This would necessarily be a runtime dependency of sage for docstring sphinxifying to work.


---

Comment by embray created at 2016-12-15 13:15:24

I'm working on a possible solution to this, but I believe that any reasonable solution should depend on #22061 at a minimum.


---

Comment by embray created at 2016-12-16 13:48:58

Here's my attempt at solving this.  It included a few other changes that I felt were needed (in addition to #22061), but that are not directly relevant either, so might be worth moving to another ticket.

I don't feel strongly about the choice of `sage.misc.docs`, but I am convinced that these files should be somewhere (for now) in the `sage` package.
----
New commits:


---

Comment by embray created at 2016-12-16 13:49:11

Changing status from new to needs_review.


---

Comment by infinity0 created at 2016-12-16 23:43:25

In here https://git.sagemath.org/sage.git/diff/src/sage/misc/sphinxify.py?id=2983351b1116ed29f08d5fc95c6c11dbcddeec64 and possible some of the other changes, don't we want SAGE_LOCAL instead of SAGE_SRC? (Assuming we don't want to always install SAGE_SRC at runtime.)


---

Comment by infinity0 created at 2016-12-16 23:45:28

er, I mean SAGE_LIB instead of SAGE_LOCAL (or SAGE_SRC)


---

Comment by embray created at 2016-12-19 10:08:03

Replying to [comment:17 infinity0]:
> In here https://git.sagemath.org/sage.git/diff/src/sage/misc/sphinxify.py?id=2983351b1116ed29f08d5fc95c6c11dbcddeec64 and possible some of the other changes, don't we want SAGE_LOCAL instead of SAGE_SRC? (Assuming we don't want to always install SAGE_SRC at runtime.)

Yes, this is true.  Actually, I have another branch where I'm trying to improve runtime dependency on SAGE_SRC (or, more specifically, SAGE_SRC is set to the same as SAGE_LIB when not running out of the source tree).

I guess this change is a holdover from that.  But at the same time I did this work as a prerequisite for fixing the other runtime dependencies on SAGE_DOC_SRC and SAGE_SRC, so I guess there's an interdependency between the two.

Maybe, for the sake of making this ticket make sense on its own, I'll bring in some of the changes from my other branch too.


---

Comment by kcrisman created at 2016-12-21 13:34:59

See also [sagenb PR 416](https://github.com/sagemath/sagenb/pull/416).  Perhaps an update ticket for that is needed too.


---

Comment by embray created at 2016-12-21 14:03:14

Replying to [comment:20 kcrisman]:
> See also [sagenb PR 416](https://github.com/sagemath/sagenb/pull/416).  Perhaps an update ticket for that is needed too.

You mean, to update the sagenb version in the distribution?


---

Comment by kcrisman created at 2016-12-21 14:31:30

> > See also [sagenb PR 416](https://github.com/sagemath/sagenb/pull/416).  Perhaps an update ticket for that is needed too.
> 
> You mean, to update the sagenb version in the distribution?

Correct.


---

Comment by embray created at 2016-12-21 14:58:34

Another possibility would be to keep a symlink to `sage/misc/docs/introspect` in its old location (`$SAGE_DOC_SRC/en/introspect`).  That would at least preserve backwards-compat, I think.


---

Comment by jdemeyer created at 2017-03-13 16:57:41

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-13 16:57:41

Does not merge.


---

Comment by jdemeyer created at 2017-03-13 16:57:41

Changing keywords from "" to "days85".


---

Comment by hivert created at 2017-03-13 17:04:16

I Handled the (trivial) merge.

Florent
----
New commits:


---

Comment by hivert created at 2017-03-13 17:04:47

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-03-13 19:59:38

needs rebase on 7.6.rc0


---

Comment by chapoton created at 2017-03-13 19:59:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-03-14 16:02:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2017-03-14 16:03:54

Changing status from needs_work to needs_review.


---

Comment by hivert created at 2017-03-14 17:12:45

I've reviewed this patch and it look quite good to me (though I'm not very competent about the necessity of this changes for better packaging in distros). I still have a few remark

- I agree with the comment in the head of commit [1e372a8](https://git.sagemath.org/sage.git/commit/?id=1e372a8e0cd5cab6523f6cafba7698bfa0761a07) that the moving of ``module_list.py`` into ``sage_setup`` should go into another ticket.

- I would have put thing under something like ``sage/doc-conf`` or ``sage/doc-script``. I'm not too happy putting this in misc...

- In `sage_setup/docbuild/__init__.py`, it says:
  {{{
  The sphinx subprocesses are configured in conf.py
  }}}
  I'd rather put here a comment explaining where to find this `conf.py` and why it was moved there.

- Finally, we should take the opportunity to update `python.inv`.

I'm not sure I'm completely competent to put a positive review here. And I'd rather have someone else looking quickly.


---

Comment by infinity0 created at 2017-03-14 17:19:17

Erik suggested in [This is the Trac macro *comment:19* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:19-macro) that he might make some further tweaks, are these still planned Erik?


---

Comment by embray created at 2017-03-14 17:32:37

This is a case of me not even remembering what I was doing 3 months ago, so I'll have to take a bit to remind myself.

I do remember that I was working on the larger task of eliminating any runtime dependencies on `SAGE_SRC` (or, put more accurately, allowing `SAGE_SRC` to point to `site-packages/sage` in some cases).


---

Comment by embray created at 2017-03-14 17:34:41

I think I see what I meant now in [comment:19].  It will make more sense if I post a ticket for my other branch with the follow-up work.  I think the question was whether or not to include the one change you mentioned in [comment:17] that doesn't otherwise seem obvious on its own.


---

Comment by jdemeyer created at 2017-03-14 17:35:37

I don't see why this needs to make so much changes to the Sage build system which look unrelated to the documentation. I think those changes should certainly be on a new ticket.


---

Comment by jdemeyer created at 2017-03-14 17:40:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-14 17:40:22

And then a bikeshed issue: I would suggest `src/sage/docs` instead of `src/sage/misc/docs`.


---

Comment by embray created at 2017-03-14 17:43:26

hivert wasn't crazy about putting it in `misc.docs` either.  `sage.docs` works for me.


---

Comment by embray created at 2017-03-14 17:45:29

Replying to [comment:35 jdemeyer]:
> I don't see why this needs to make so much changes to the Sage build system which look unrelated to the documentation. I think those changes should certainly be on a new ticket.

The other changes are necessary because of the poor way we currently handle non-Python files in packages, and I made some improvements there.  You're right though that it's not directly related; rather it was a prerequisite.  I could create a separate ticket if you prefer and move those changes.  Then this ticket would become dependent on the new ticket.


---

Comment by jdemeyer created at 2017-03-14 18:17:35

Replying to [comment:38 embray]:
> Replying to [comment:35 jdemeyer]:
> > I don't see why this needs to make so much changes to the Sage build system which look unrelated to the documentation. I think those changes should certainly be on a new ticket.
> 
> The other changes are necessary because of the poor way we currently handle non-Python files in packages, and I made some improvements there.

I'm not really convinced that you need to make such big changes (like moving `module_list.py`). But if you do make those changes, I think they should be on a different ticket.


---

Comment by fbissey created at 2017-03-14 20:38:19

I am not sure why I wasn't on this ticket before. Off course I suffer from this and my changes are much more minimalistic overall. I have to check more of the stuff to see if it is really useful to sage-on-distro in general. 
Note that moving `module_list.py` makes me scratch my head? Why? Like all the files in the `src` folder it is not actually installed. More consistency? May be. Breaking every sage-on-distro patch against `module_list.py`? Yes. Not difficult to deal with, just annoying.


---

Comment by fbissey created at 2017-03-15 08:12:14

Overall I like the changes that pertains to the documentation. Like Jeroen I would prefer the other bits touching setup.py, find.py and so on. I would prefer it being another ticket with a separate rational. If it is necessary I need more info. I can be very stupid that way.

Speaking of hacks, a related issue that beeped on my radar reading the ticket. We replaced SAGE_DOC_SRC by SAGE_SRC in a few place, including sphinxify.py. Me and probably most of the other distros point SAGE_SRC to SAGE_LIB at runtime. However it is not desirable to point to your sources at runtime. We may need a better mechanism in a follow up ticket.


---

Comment by fbissey created at 2017-03-15 09:37:34

I knew I had forgotten something. There is a lot of stuff in `sage/misc` I think stuff is coherent enough that it could go in `sage/docs` rather than `sage/misc/docs` but I am not going to insist on it if it takes to much time to move things.


---

Comment by jdemeyer created at 2017-03-15 09:46:05

Replying to [comment:42 fbissey]:
> I knew I had forgotten something. There is a lot of stuff in `sage/misc` I think stuff is coherent enough that it could go in `sage/docs` rather than `sage/misc/docs`

I agree but let's do that in a new ticket. There is already too much happening in this ticket. I suggest to move the files from `src/doc` to `src/sage/docs` but to keep the existing doc-related files in `src/sage/misc` for now.


---

Comment by embray created at 2017-03-15 10:28:43

Okay, well, there were definitely good reasons for the other changes, but it was long enough ago now that I don't remember what they all were.  Let me see if I can break it off to a separate ticket where I explain them better.

Moving `module_list.py` _might_ not have been necessary, but I don't recall (eventually I think it should go away entirely but that's another subject).


---

Comment by embray created at 2017-03-20 12:47:21

jdemeyer: You had mentioned that there was some other work you were doing that this ticket should depend on?  Is there a branch for that posted yet, that I could base on?  Or is mainly just a matter of naming the package in sage `sage.doc` (or is it `sage.docs`)?


---

Comment by jdemeyer created at 2017-03-20 13:15:42

Replying to [comment:45 embray]:
> jdemeyer: You had mentioned that there was some other work you were doing that this ticket should depend on?  Is there a branch for that posted yet, that I could base on?  Or is mainly just a matter of naming the package in sage `sage.doc` (or is it `sage.docs`)?

There is at least #22611, which creates the `sage.docs` directory.

You should also be aware of #22252 which affects docbuilding. Depending on how well `git` can deal with renames, this will probably not actually conflict.


---

Comment by embray created at 2017-03-20 14:20:16

Right, I think you had mentioned both of those.  Thanks!


---

Comment by embray created at 2017-03-21 09:37:16

New branch for this ticket based on #22655, which separates out the build changes to be considered separately.  This now just makes the code moves suggested in the description of the ticket.

To be clear, nothing substantive changed in these files except to update some imports, and remove bits of code that were previously needed to manipulate `sys.path`.  Now functions like `sphinxify` can work without `SAGE_DOC_SRC` needing to be installed somewhere on the system.
----
New commits:


---

Comment by embray created at 2017-03-21 09:40:15

Also, as already noted, this will likely conflict with #22611, but I'm fine waiting for that to be merged first.


---

Comment by embray created at 2017-03-22 13:51:01

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-04-01 06:41:07

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-04-01 06:41:07

does not apply


---

Comment by mkoeppe created at 2020-02-11 20:00:14

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-02-11 20:00:14

This ticket appears to be outdated, as #25786 (Fix introspection with ? when doc source is not available) and other tickets seem to have done the described moves. I propose to close this ticket.


---

Comment by jhpalmieri created at 2020-02-11 22:44:33

It looks okay to me to close this, but the distro people should take a look.


---

Comment by fbissey created at 2020-02-12 08:02:30

I used to have to move python files in sage-on-gentoo to make the doc work. Not anymore. Although I still copy `doc/common/themes` in place so there may still be something to do. For some reason we seem to produce a lot of cruft and strange things in the doc on distros but that should be a different ticket.


---

Comment by fbissey created at 2020-02-12 08:02:30

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-02-19 12:41:17

Resolution: invalid
