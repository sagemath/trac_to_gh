# Issue 30959: Code Improvements for Mutability module

archive/issues_030959.json:
```json
{
    "body": "CC:  @mkoeppe @tscrim\n\nI suggest some code improvements. For the decorator check, we should allow the attribute `_is_mutable` alongside with `_is_immutable`. Furthermore, the error message is aligned with the method `_require_immutable` so that this decorator can conveniently and effortlessly be used for the manifolds module.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31196\n\n",
    "created_at": "2021-01-07T14:49:31Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Code Improvements for Mutability module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30959",
    "user": "@mjungmath"
}
```
CC:  @mkoeppe @tscrim

I suggest some code improvements. For the decorator check, we should allow the attribute `_is_mutable` alongside with `_is_immutable`. Furthermore, the error message is aligned with the method `_require_immutable` so that this decorator can conveniently and effortlessly be used for the manifolds module.

Issue created by migration from https://trac.sagemath.org/ticket/31196





---

archive/issue_comments_442144.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-01-07T14:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442144",
    "user": "@mjungmath"
}
```

New commits:



---

archive/issue_comments_442145.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-07T14:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442145",
    "user": "@mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442146.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-07T15:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442146",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442147.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-07T15:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442147",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442148.json:
```json
{
    "body": "Alternatively, one could ask for the **method** `is_immutable()` instead of the *attribute*? Then it wouldn't matter what happens behind the scenes, that's most flexible.",
    "created_at": "2021-01-07T21:43:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442148",
    "user": "@mjungmath"
}
```

Alternatively, one could ask for the **method** `is_immutable()` instead of the *attribute*? Then it wouldn't matter what happens behind the scenes, that's most flexible.



---

archive/issue_comments_442149.json:
```json
{
    "body": "I strongly think the attribute name should be standardized and not look for the choice between the two. This will not only be faster but easier to maintain.",
    "created_at": "2021-01-08T00:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442149",
    "user": "@tscrim"
}
```

I strongly think the attribute name should be standardized and not look for the choice between the two. This will not only be faster but easier to maintain.



---

archive/issue_comments_442150.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> I strongly think the attribute name should be standardized and not look for the choice between the two. This will not only be faster but easier to maintain.\n\nThat makes sense. What about this instead:\n\n> Alternatively, one could ask for the method is_immutable() instead of the attribute?\n\nThen, the method is standardized, which I would favorize.\n\nAnd what do you think about the change of error message?",
    "created_at": "2021-01-08T09:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442150",
    "user": "@mjungmath"
}
```

Replying to [comment:9 tscrim]:
> I strongly think the attribute name should be standardized and not look for the choice between the two. This will not only be faster but easier to maintain.

That makes sense. What about this instead:

> Alternatively, one could ask for the method is_immutable() instead of the attribute?

Then, the method is standardized, which I would favorize.

And what do you think about the change of error message?



---

archive/issue_comments_442151.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-08T10:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442151",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442152.json:
```json
{
    "body": "Replying to [comment:11 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[df9a54c](https://git.sagemath.org/sage.git/commit/?id=df9a54cd7cef639c2875487635706317979b3304)||`Trac #31196: use \"is_immutable()\" + documentation`||\n\nI had something like this in mind...\n\nShould be even faster since `getattr` is completely avoided. Moreover, the error message is now much clearer if the object doesn't support mutability.",
    "created_at": "2021-01-08T10:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442152",
    "user": "@mjungmath"
}
```

Replying to [comment:11 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[df9a54c](https://git.sagemath.org/sage.git/commit/?id=df9a54cd7cef639c2875487635706317979b3304)||`Trac #31196: use "is_immutable()" + documentation`||

I had something like this in mind...

Should be even faster since `getattr` is completely avoided. Moreover, the error message is now much clearer if the object doesn't support mutability.



---

archive/issue_comments_442153.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-08T10:19:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442153",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442154.json:
```json
{
    "body": "The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with somethign in the docstring stating that it is a requirement to use the decorator.\n\nI am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).",
    "created_at": "2021-01-08T23:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442154",
    "user": "@tscrim"
}
```

The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with somethign in the docstring stating that it is a requirement to use the decorator.

I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).



---

archive/issue_comments_442155.json:
```json
{
    "body": "Replying to [comment:16 tscrim]:\n> The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with somethign in the docstring stating that it is a requirement to use the decorator.\n\nI don't get your point entirely. Is your `AttributeError` concern related only to the method or generally speaking? If it's related, I'd say we use the attribute only (even though I personally like methods more, because they are not interested in implementation details), drop the `getattr` (because it's faster) and raise an attribute error if that is not implemented. I think it should definitely raise an attribute error in cases where we cannot say whether the object is immutable or not. The decorator wouldn't make much sense in situations like this, same for the error message.\n\n> I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).\n\nAny ideas for a compromise? I think, from a developer's viewpoint, the original error message was more clear. But my plan, so far, is that this decorator should be used for the mutability checks in the manifold setting (after the pickling in #31182 had been solved).",
    "created_at": "2021-01-09T00:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442155",
    "user": "@mjungmath"
}
```

Replying to [comment:16 tscrim]:
> The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with somethign in the docstring stating that it is a requirement to use the decorator.

I don't get your point entirely. Is your `AttributeError` concern related only to the method or generally speaking? If it's related, I'd say we use the attribute only (even though I personally like methods more, because they are not interested in implementation details), drop the `getattr` (because it's faster) and raise an attribute error if that is not implemented. I think it should definitely raise an attribute error in cases where we cannot say whether the object is immutable or not. The decorator wouldn't make much sense in situations like this, same for the error message.

> I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).

Any ideas for a compromise? I think, from a developer's viewpoint, the original error message was more clear. But my plan, so far, is that this decorator should be used for the mutability checks in the manifold setting (after the pickling in #31182 had been solved).



---

archive/issue_comments_442156.json:
```json
{
    "body": "For the records, I suggested this change because of #31194, to avoid possible incompatibilites in case of slight variations in the implementation.",
    "created_at": "2021-01-09T00:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442156",
    "user": "@mjungmath"
}
```

For the records, I suggested this change because of #31194, to avoid possible incompatibilites in case of slight variations in the implementation.



---

archive/issue_comments_442157.json:
```json
{
    "body": "Replying to [comment:17 gh-mjungmath]:\n> Replying to [comment:16 tscrim]:\n> > The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with something in the docstring stating that it is a requirement to use the decorator.\n> \n> I don't get your point entirely. Is your `AttributeError` concern related only to the method or generally speaking? If it's related, I'd say we use the attribute only (even though I personally like methods more, because they are not interested in implementation details), drop the `getattr` (because it's faster) and raise an attribute error if that is not implemented. I think it should definitely raise an attribute error in cases where we cannot say whether the object is immutable or not. The decorator wouldn't make much sense in situations like this, same for the error message.\n\nI don't understand this distinction you're trying to make. If you use this decorator with a method on a class that does not implement an `is_immutable` method, then you get an `AttributeError`. However, it is potentially reasonable for a class to add an attribute `_is_immutable` when it becomes immutable. I agree with your point on not depending on implementation details, but because we are trying to set the API for implementations, I feel like that is somewhat moot. There is also something to be said for having different error messages, but having more flexibility I think trumps this, although just barely.\n\n> > I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).\n> \n> Any ideas for a compromise? I think, from a developer's viewpoint, the original error message was more clear. But my plan, so far, is that this decorator should be used for the mutability checks in the manifold setting (after the pickling in #31182 had been solved).\n\nI would generally avoid the decorator and just directly call stuff. It is nearly the same amount of code. While it does make it slightly easier to refactor, it obfuscates the code mode and slows it down. This is good for the more casual user, but for production code, I would avoid the decorator in this case.",
    "created_at": "2021-01-09T01:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442157",
    "user": "@tscrim"
}
```

Replying to [comment:17 gh-mjungmath]:
> Replying to [comment:16 tscrim]:
> > The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with something in the docstring stating that it is a requirement to use the decorator.
> 
> I don't get your point entirely. Is your `AttributeError` concern related only to the method or generally speaking? If it's related, I'd say we use the attribute only (even though I personally like methods more, because they are not interested in implementation details), drop the `getattr` (because it's faster) and raise an attribute error if that is not implemented. I think it should definitely raise an attribute error in cases where we cannot say whether the object is immutable or not. The decorator wouldn't make much sense in situations like this, same for the error message.

I don't understand this distinction you're trying to make. If you use this decorator with a method on a class that does not implement an `is_immutable` method, then you get an `AttributeError`. However, it is potentially reasonable for a class to add an attribute `_is_immutable` when it becomes immutable. I agree with your point on not depending on implementation details, but because we are trying to set the API for implementations, I feel like that is somewhat moot. There is also something to be said for having different error messages, but having more flexibility I think trumps this, although just barely.

> > I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).
> 
> Any ideas for a compromise? I think, from a developer's viewpoint, the original error message was more clear. But my plan, so far, is that this decorator should be used for the mutability checks in the manifold setting (after the pickling in #31182 had been solved).

I would generally avoid the decorator and just directly call stuff. It is nearly the same amount of code. While it does make it slightly easier to refactor, it obfuscates the code mode and slows it down. This is good for the more casual user, but for production code, I would avoid the decorator in this case.



---

archive/issue_comments_442158.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> ...\n\nAlright then. I thought it might be convenient. Too much thinking, eh? I'll just add a warning to make clear that such objects require a `_is_immutable` attribute.\n\nAs for the manifold code, I should switch to `_require_immutable` in `Mutability` instead?",
    "created_at": "2021-01-09T01:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442158",
    "user": "@mjungmath"
}
```

Replying to [comment:19 tscrim]:
> ...

Alright then. I thought it might be convenient. Too much thinking, eh? I'll just add a warning to make clear that such objects require a `_is_immutable` attribute.

As for the manifold code, I should switch to `_require_immutable` in `Mutability` instead?



---

archive/issue_comments_442159.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-09T13:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442159",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442160.json:
```json
{
    "body": "Like this?",
    "created_at": "2021-01-09T13:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442160",
    "user": "@mjungmath"
}
```

Like this?



---

archive/issue_comments_442161.json:
```json
{
    "body": "Replying to [comment:22 gh-mjungmath]:\n> Like this?\n\nI think this is good overall. However I have one question and comment:\n\nWhy is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.",
    "created_at": "2021-01-10T12:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442161",
    "user": "@tscrim"
}
```

Replying to [comment:22 gh-mjungmath]:
> Like this?

I think this is good overall. However I have one question and comment:

Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.



---

archive/issue_comments_442162.json:
```json
{
    "body": "Replying to [comment:24 tscrim]:\n> I think this is good overall. However I have one question and comment:\n> \n> Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`?\n\nI actually don't know. That was the setup I found there. Actually, due to #31182, I think it is better to make this class completely Pythonic. If there is a need for a Cythonic version, I suggest to introduce a `SageObjectWithMutability`. See my [comment](https://trac.sagemath.org/ticket/31182#comment:12).\n\n> I think you need an `except -1` too.\n\nWhat do you mean?",
    "created_at": "2021-01-10T15:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442162",
    "user": "@mjungmath"
}
```

Replying to [comment:24 tscrim]:
> I think this is good overall. However I have one question and comment:
> 
> Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`?

I actually don't know. That was the setup I found there. Actually, due to #31182, I think it is better to make this class completely Pythonic. If there is a need for a Cythonic version, I suggest to introduce a `SageObjectWithMutability`. See my [comment](https://trac.sagemath.org/ticket/31182#comment:12).

> I think you need an `except -1` too.

What do you mean?



---

archive/issue_comments_442163.json:
```json
{
    "body": "Replying to [comment:25 gh-mjungmath]:\n> Replying to [comment:24 tscrim]:\n> > I think this is good overall. However I have one question and comment:\n> > \n> > Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`?\n> \n> I actually don't know. That was the setup I found there. Actually, due to #31182, I think it is better to make this class completely Pythonic. If there is a need for a Cythonic version, I suggest to introduce a `SageObjectWithMutability`. See my [comment](https://trac.sagemath.org/ticket/31182#comment:12).\n\n-1 on this. I will comment on #31182 for more about this.\n\n> > I think you need an `except -1` too.\n> \n> What do you mean?\n\nhttps://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#error-return-values",
    "created_at": "2021-01-12T00:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442163",
    "user": "@tscrim"
}
```

Replying to [comment:25 gh-mjungmath]:
> Replying to [comment:24 tscrim]:
> > I think this is good overall. However I have one question and comment:
> > 
> > Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`?
> 
> I actually don't know. That was the setup I found there. Actually, due to #31182, I think it is better to make this class completely Pythonic. If there is a need for a Cythonic version, I suggest to introduce a `SageObjectWithMutability`. See my [comment](https://trac.sagemath.org/ticket/31182#comment:12).

-1 on this. I will comment on #31182 for more about this.

> > I think you need an `except -1` too.
> 
> What do you mean?

https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#error-return-values



---

archive/issue_comments_442164.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-17T19:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442164",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442165.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-17T19:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442165",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442166.json:
```json
{
    "body": "Replying to [comment:24 tscrim]:\n> Replying to [comment:22 gh-mjungmath]:\n> > Like this?\n> \n> I think this is good overall. However I have one question and comment:\n> \n> Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.\n\nIs that better? I think, the `except *` syntax is needed since these functions do not return anything.",
    "created_at": "2021-01-17T19:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442166",
    "user": "@mjungmath"
}
```

Replying to [comment:24 tscrim]:
> Replying to [comment:22 gh-mjungmath]:
> > Like this?
> 
> I think this is good overall. However I have one question and comment:
> 
> Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.

Is that better? I think, the `except *` syntax is needed since these functions do not return anything.



---

archive/issue_comments_442167.json:
```json
{
    "body": "Replying to [comment:29 gh-mjungmath]:\n> Replying to [comment:24 tscrim]:\n> > Replying to [comment:22 gh-mjungmath]:\n> > > Like this?\n> > \n> > I think this is good overall. However I have one question and comment:\n> > \n> > Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.\n> \n> Is that better? I think, the `except *` syntax is needed since these functions do not return anything.\n\nBuilt won't work: *Exception clause not allowed for function returning Python object*. You sure that the exception clause is needed here?",
    "created_at": "2021-01-17T20:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442167",
    "user": "@mjungmath"
}
```

Replying to [comment:29 gh-mjungmath]:
> Replying to [comment:24 tscrim]:
> > Replying to [comment:22 gh-mjungmath]:
> > > Like this?
> > 
> > I think this is good overall. However I have one question and comment:
> > 
> > Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.
> 
> Is that better? I think, the `except *` syntax is needed since these functions do not return anything.

Built won't work: *Exception clause not allowed for function returning Python object*. You sure that the exception clause is needed here?



---

archive/issue_comments_442168.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-17T20:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442168",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442169.json:
```json
{
    "body": "Okay, I added an example that works perfectly and improved the documentation incidentally. The except clause is apparently not needed.",
    "created_at": "2021-01-17T20:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442169",
    "user": "@mjungmath"
}
```

Okay, I added an example that works perfectly and improved the documentation incidentally. The except clause is apparently not needed.



---

archive/issue_comments_442170.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-17T20:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442170",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442171.json:
```json
{
    "body": "Ah, it's fine because it doesn't have a return value (and hence returns `None`). Let's wait for the patchbot. If that is green, then positive review.",
    "created_at": "2021-01-18T00:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442171",
    "user": "@tscrim"
}
```

Ah, it's fine because it doesn't have a return value (and hence returns `None`). Let's wait for the patchbot. If that is green, then positive review.



---

archive/issue_comments_442172.json:
```json
{
    "body": "Also, while it is technically not your responsibility since it existed previously, it would be good add docstrings and tests to all methods, including `cpdef` ones.",
    "created_at": "2021-01-18T09:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442172",
    "user": "@tscrim"
}
```

Also, while it is technically not your responsibility since it existed previously, it would be good add docstrings and tests to all methods, including `cpdef` ones.



---

archive/issue_comments_442173.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-18T09:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442173",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442174.json:
```json
{
    "body": "Replying to [comment:35 tscrim]:\n> Also, while it is technically not your responsibility since it existed previously, it would be good add docstrings and tests to all methods, including `cpdef` ones.\n\nDone.",
    "created_at": "2021-01-18T09:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442174",
    "user": "@mjungmath"
}
```

Replying to [comment:35 tscrim]:
> Also, while it is technically not your responsibility since it existed previously, it would be good add docstrings and tests to all methods, including `cpdef` ones.

Done.



---

archive/issue_comments_442175.json:
```json
{
    "body": "Patchbot is satisfied. :)",
    "created_at": "2021-01-18T21:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442175",
    "user": "@mjungmath"
}
```

Patchbot is satisfied. :)



---

archive/issue_comments_442176.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2021-01-20T06:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442176",
    "user": "@tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_442177.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-20T06:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442177",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442178.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2021-01-20T09:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442178",
    "user": "@mjungmath"
}
```

Thanks for the review!



---

archive/issue_comments_442179.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-31T20:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30959",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30959#issuecomment-442179",
    "user": "@vbraun"
}
```

Resolution: fixed
