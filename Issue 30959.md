# Issue 30959: Code Improvements for Mutability module

Issue created by migration from https://trac.sagemath.org/ticket/31196

Original creator: @mjungmath

Original creation time: 2021-01-07 14:49:31

CC:  mkoeppe tscrim

I suggest some code improvements. For the decorator check, we should allow the attribute `_is_mutable` alongside with `_is_immutable`. Furthermore, the error message is aligned with the method `_require_immutable` so that this decorator can conveniently and effortlessly be used for the manifolds module.


---

Comment by @mjungmath created at 2021-01-07 14:51:02

New commits:


---

Comment by @mjungmath created at 2021-01-07 14:51:11

Changing status from new to needs_review.


---

Comment by git created at 2021-01-07 15:03:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-01-07 15:32:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-07 21:43:07

Alternatively, one could ask for the **method** `is_immutable()` instead of the _attribute_? Then it wouldn't matter what happens behind the scenes, that's most flexible.


---

Comment by tscrim created at 2021-01-08 00:30:36

I strongly think the attribute name should be standardized and not look for the choice between the two. This will not only be faster but easier to maintain.


---

Comment by @mjungmath created at 2021-01-08 09:28:57

Replying to [comment:9 tscrim]:
> I strongly think the attribute name should be standardized and not look for the choice between the two. This will not only be faster but easier to maintain.

That makes sense. What about this instead:

> Alternatively, one could ask for the method is_immutable() instead of the attribute?

Then, the method is standardized, which I would favorize.

And what do you think about the change of error message?


---

Comment by git created at 2021-01-08 10:11:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-08 10:14:48

Replying to [comment:11 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[df9a54c](https://git.sagemath.org/sage.git/commit/?id=df9a54cd7cef639c2875487635706317979b3304)||`Trac #31196: use "is_immutable()" + documentation`||

I had something like this in mind...

Should be even faster since `getattr` is completely avoided. Moreover, the error message is now much clearer if the object doesn't support mutability.


---

Comment by git created at 2021-01-08 10:19:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-01-08 23:45:54

The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with somethign in the docstring stating that it is a requirement to use the decorator.

I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).


---

Comment by @mjungmath created at 2021-01-09 00:06:10

Replying to [comment:16 tscrim]:
> The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with somethign in the docstring stating that it is a requirement to use the decorator.

I don't get your point entirely. Is your `AttributeError` concern related only to the method or generally speaking? If it's related, I'd say we use the attribute only (even though I personally like methods more, because they are not interested in implementation details), drop the `getattr` (because it's faster) and raise an attribute error if that is not implemented. I think it should definitely raise an attribute error in cases where we cannot say whether the object is immutable or not. The decorator wouldn't make much sense in situations like this, same for the error message.

> I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).

Any ideas for a compromise? I think, from a developer's viewpoint, the original error message was more clear. But my plan, so far, is that this decorator should be used for the mutability checks in the manifold setting (after the pickling in #31182 had been solved).


---

Comment by @mjungmath created at 2021-01-09 00:45:26

For the records, I suggested this change because of #31194, to avoid possible incompatibilites in case of slight variations in the implementation.


---

Comment by tscrim created at 2021-01-09 01:07:59

Replying to [comment:17 gh-mjungmath]:
> Replying to [comment:16 tscrim]:
> > The problem with this approach is that it will raise an attribute error if it is used on a class that does not implement an `is_immutable()` method. Although I mostly agree that it generally should if it is using this feature, but I could conceive of a reason why it wouldn't. I would say it is more likely that things will have some attribute to hold the mutability status than just a method to check it. Ultimately I would leave the check the way it currently is with something in the docstring stating that it is a requirement to use the decorator.
> 
> I don't get your point entirely. Is your `AttributeError` concern related only to the method or generally speaking? If it's related, I'd say we use the attribute only (even though I personally like methods more, because they are not interested in implementation details), drop the `getattr` (because it's faster) and raise an attribute error if that is not implemented. I think it should definitely raise an attribute error in cases where we cannot say whether the object is immutable or not. The decorator wouldn't make much sense in situations like this, same for the error message.

I don't understand this distinction you're trying to make. If you use this decorator with a method on a class that does not implement an `is_immutable` method, then you get an `AttributeError`. However, it is potentially reasonable for a class to add an attribute `_is_immutable` when it becomes immutable. I agree with your point on not depending on implementation details, but because we are trying to set the API for implementations, I feel like that is somewhat moot. There is also something to be said for having different error messages, but having more flexibility I think trumps this, although just barely.

> > I am not 100% convinced the error message is more clear, but I am okay with it (once you remove the trailing period).
> 
> Any ideas for a compromise? I think, from a developer's viewpoint, the original error message was more clear. But my plan, so far, is that this decorator should be used for the mutability checks in the manifold setting (after the pickling in #31182 had been solved).

I would generally avoid the decorator and just directly call stuff. It is nearly the same amount of code. While it does make it slightly easier to refactor, it obfuscates the code mode and slows it down. This is good for the more casual user, but for production code, I would avoid the decorator in this case.


---

Comment by @mjungmath created at 2021-01-09 01:51:47

Replying to [comment:19 tscrim]:
> ...

Alright then. I thought it might be convenient. Too much thinking, eh? I'll just add a warning to make clear that such objects require a `_is_immutable` attribute.

As for the manifold code, I should switch to `_require_immutable` in `Mutability` instead?


---

Comment by git created at 2021-01-09 13:05:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-01-09 13:12:42

Like this?


---

Comment by tscrim created at 2021-01-10 12:56:15

Replying to [comment:22 gh-mjungmath]:
> Like this?

I think this is good overall. However I have one question and comment:

Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.


---

Comment by @mjungmath created at 2021-01-10 15:18:56

Replying to [comment:24 tscrim]:
> I think this is good overall. However I have one question and comment:
> 
> Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`?

I actually don't know. That was the setup I found there. Actually, due to #31182, I think it is better to make this class completely Pythonic. If there is a need for a Cythonic version, I suggest to introduce a `SageObjectWithMutability`. See my [comment](https://trac.sagemath.org/ticket/31182#comment:12).

> I think you need an `except -1` too.

What do you mean?


---

Comment by tscrim created at 2021-01-12 00:14:32

Replying to [comment:25 gh-mjungmath]:
> Replying to [comment:24 tscrim]:
> > I think this is good overall. However I have one question and comment:
> > 
> > Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`?
> 
> I actually don't know. That was the setup I found there. Actually, due to #31182, I think it is better to make this class completely Pythonic. If there is a need for a Cythonic version, I suggest to introduce a `SageObjectWithMutability`. See my [comment](https://trac.sagemath.org/ticket/31182#comment:12).

-1 on this. I will comment on #31182 for more about this.

> > I think you need an `except -1` too.
> 
> What do you mean?

https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#error-return-values


---

Comment by git created at 2021-01-17 19:39:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-01-17 19:54:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-01-17 19:55:43

Replying to [comment:24 tscrim]:
> Replying to [comment:22 gh-mjungmath]:
> > Like this?
> 
> I think this is good overall. However I have one question and comment:
> 
> Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.

Is that better? I think, the `except *` syntax is needed since these functions do not return anything.


---

Comment by @mjungmath created at 2021-01-17 20:15:03

Replying to [comment:29 gh-mjungmath]:
> Replying to [comment:24 tscrim]:
> > Replying to [comment:22 gh-mjungmath]:
> > > Like this?
> > 
> > I think this is good overall. However I have one question and comment:
> > 
> > Why is the `_require_immutable` not a `cpdef` method but instead a Python and `cdef`? I think you need an `except -1` added too.
> 
> Is that better? I think, the `except *` syntax is needed since these functions do not return anything.

Built won't work: _Exception clause not allowed for function returning Python object_. You sure that the exception clause is needed here?


---

Comment by git created at 2021-01-17 20:23:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-01-17 20:23:55

Okay, I added an example that works perfectly and improved the documentation incidentally. The except clause is apparently not needed.


---

Comment by git created at 2021-01-17 20:36:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-01-18 00:08:51

Ah, it's fine because it doesn't have a return value (and hence returns `None`). Let's wait for the patchbot. If that is green, then positive review.


---

Comment by tscrim created at 2021-01-18 09:27:37

Also, while it is technically not your responsibility since it existed previously, it would be good add docstrings and tests to all methods, including `cpdef` ones.


---

Comment by git created at 2021-01-18 09:51:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-18 09:58:23

Replying to [comment:35 tscrim]:
> Also, while it is technically not your responsibility since it existed previously, it would be good add docstrings and tests to all methods, including `cpdef` ones.

Done.


---

Comment by @mjungmath created at 2021-01-18 21:41:17

Patchbot is satisfied. :)


---

Comment by tscrim created at 2021-01-20 06:03:24

Thank you. LGTM.


---

Comment by tscrim created at 2021-01-20 06:03:24

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2021-01-20 09:45:39

Thanks for the review!


---

Comment by vbraun created at 2021-01-31 20:53:38

Resolution: fixed
