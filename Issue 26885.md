# Issue 26885: Adding -march=native to build/cythonized/setup.py

Issue created by migration from https://trac.sagemath.org/ticket/27122

Original creator: @kliem

Original creation time: 2019-01-25 11:36:49

CC:  selia vbraun embray fbissey

Keywords: Intrinsics, SIMD, Polyhedra, FindPoly

In #26887 we are constructing a class that makes fast computations of combinatorial data of Polyhedra.

Can we add the extra compile argument `-march=native` in `build/cythonized/setup.py`?


```
if os.environ.get("SAGE_FAT_BINARY") != "yes":
    extra_compile_args.append('-march=native')
```


This would speed up those calculations depending on the architecture:

- `f_vector` of `polytopes.permutahedron(8)` takes 1.6 seconds with intrinsics and 4.8 seconds without.
- `f_vector` of a 20-dimensional counterexample of the Hirsch-conjecture takes about 3 minutes with intrinsics and 9 minutes without (the polytope contains 353,731,266 faces).

As we are setting up a database `FindPoly`, which shall contain a lot of polytopes, we would like calculations to be done as fast as somehow possible. The project does not depend on this happening, but still it would be nice.


---

Comment by jdemeyer created at 2019-01-25 11:57:50

The topic has nothing to do with polyhedra, many parts of Sage could benefit from it.


---

Comment by jdemeyer created at 2019-01-25 11:57:50

Changing keywords from "Intrinsics, SIMD, Polyhedra, FindPoly" to "Intrinsics, SIMD".


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by @kliem created at 2019-10-22 06:33:44

Changing priority from minor to major.


---

Comment by @kliem created at 2019-10-23 10:06:35

New commits:


---

Comment by @kliem created at 2019-10-23 10:21:42

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-10-23 10:21:42

I added a very naive approach of doing it. Wondering if this is remotely ok or going in the right direction.


---

Comment by dimpase created at 2019-10-23 11:36:14

looks OK - not sure whether converting version to `float()` is normal practice, but that's minor.

I'm also not sure whether this will pass the argument to Cython, or it needs

`# distutils: extra_compile_args = -march=native`

in `*.pxd` files.


---

Comment by @kliem created at 2019-10-23 19:32:22

I believe it works, but I'm not entirely sure.

This seems to state that `sage/stats/distributions/discrete_gaussian_integer.pyx` was compiled with `-march=native`.

I have not set it with `CFLAGS`, in that case it would have appeared twice on the list.

```
[sagelib-9.0.beta2] [469/499] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/cypari2 -I./sage/libs/ntl -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/
cysignals -I/srv/public/kliem/sage/local/include -I/srv/public/kliem/sage/src -I/srv/public/kliem/sage/src/sage/ext -I/srv/public/kliem/sage/local/include/python2.7 -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/numpy/core/include -Ibuild/cythonized -I/srv/pu
blic/kliem/sage/local/include/python2.7 -c build/cythonized/sage/stats/distributions/discrete_gaussian_integer.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/stats/distributions/discrete_gaussian_integer.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -march
=native -D_XOPEN_SOURCE=600 -std=c99                                                                                                                                                                                                                                           
[sagelib-9.0.beta2] build/cythonized/sage/stats/hmm/hmm.c: In function ‘__pyx_pw_4sage_5stats_3hmm_3hmm_25DiscreteHiddenMarkovModel_17_forward’:          
```



---

Comment by @kliem created at 2019-10-25 08:06:47

It works for me. All tests passed. No significant time difference.

- Operating System: Debian GNU/Linux 10 (buster)
- Kernel: Linux 4.19.0-6-amd64
- Architecture: x86-64
- CPU Model name: Intel(R) Core(TM) i7-7700 CPU `@` 3.60GHz


---

Comment by @kliem created at 2019-10-26 10:29:14

Works on

- Operating System: Ubuntu 18.04.3 LTS
- Kernel: Linux 4.15.0-65-generic
- Architecture: x86-64
- Model name:          Intel(R) Core(TM) i5-7200U CPU `@` 2.50GHz


---

Comment by charpent created at 2019-10-26 15:33:05

Success on my notebook running a Python 3-based 9.0.beta2 on top of Debian testing :

 - Operating System: Debian GNU/Linux bullseye/sid
 - Kernel: Linux 5.2.0-3-amd64
 - Architecture: x86-64
 - Nom de modèle : Intel(R) Core(TM) i7-8550U CPU `@` 1.80GHz

HTH,


---

Comment by dimpase created at 2019-10-27 08:21:23

works on Intel(R) Core(TM) i5-2500 CPU `@` 3.30GHz (in 32-bit mode), Ubunty 14.04 LTS


---

Comment by mjo created at 2019-10-28 13:50:07

I don't think we should be reinventing the thirty-year-old standard CFLAGS here. It looks like setup.py will already use CFLAGS if it's set. I'm not arguing against sane defaults, just saying that appending `-march=native` on **top** of my CFLAGS is a bit rude if I've set them to what I want.

Instead, why don't we try to set a decent default for CFLAGS if the user does not already have it set? Typically this amounts to something like


```
CFLAGS ?= -march=native -O2
```


in a makefile somewhere. For people who don't care, CFLAGS will get set to something nice, and setup.py will use that value. For the people who have set CFLAGS to something special, nothing goes wrong.


---

Comment by git created at 2019-10-28 14:14:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-10-28 14:19:12

Ok, this should respect CFLAGS now.

I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.


---

Comment by mjo created at 2019-10-28 15:25:12

Replying to [comment:18 gh-kliem]:
> Ok, this should respect CFLAGS now.
> 
> I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.

I'd bet that our ./configure script is capable of doing that in a more reliable way, since it's something that C programs need to do often and python programs basically never. For example, I think we already check for a suitable version of gcc to see if we need to build our own. And we include an autoconf macro (m4/ax_c_check_flag.m4) that will try to compile a file using `-march=native`, and then report back if it worked or not.

Ideally, CFLAGS set in the environment will work everywhere, subject to upstream/spkg cooperation. But they definitely work in setup.py, so if we're able to detect these features at a higher level and then (by default) set CFLAGS/CXXFLAGS to include them, more code would be able to benefit from it. The setup.py script would still pick them up from the environment, but anything else that respects the environment variables would benefit, too.

(I don't know off the top of my head that setup.py doesn't affect spkgs, but I would guess not.)


---

Comment by @kliem created at 2019-11-11 19:58:29

Thanks for the comment by the way. It makes sense to me.

I'm just very busy at the moment and didn't have time to see how that could be handled by the configure script.

Replying to [comment:19 mjo]:
> Replying to [comment:18 gh-kliem]:
> > Ok, this should respect CFLAGS now.
> > 
> > I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.
> 
> I'd bet that our ./configure script is capable of doing that in a more reliable way, since it's something that C programs need to do often and python programs basically never. For example, I think we already check for a suitable version of gcc to see if we need to build our own. And we include an autoconf macro (m4/ax_c_check_flag.m4) that will try to compile a file using `-march=native`, and then report back if it worked or not.
> 
> Ideally, CFLAGS set in the environment will work everywhere, subject to upstream/spkg cooperation. But they definitely work in setup.py, so if we're able to detect these features at a higher level and then (by default) set CFLAGS/CXXFLAGS to include them, more code would be able to benefit from it. The setup.py script would still pick them up from the environment, but anything else that respects the environment variables would benefit, too.
> 
> (I don't know off the top of my head that setup.py doesn't affect spkgs, but I would guess not.)


---

Comment by mjo created at 2020-01-01 19:08:47

This does the trick, but might be a bit blunt:


```
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index eea7ceb7dc..a5966b8011 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -17,6 +17,13 @@
 # Always use bash for make rules
 SHELL = @SHELL@

+# Use safe-but-efficient optimization flags, if the user does not
+# provide his own.
+CFLAGS ?= -O2 -march=native
+CXXFLAGS ?= -O2 -march=native
+export CFLAGS
+export CXXFLAGS
+
 ifndef SAGE_SPKG_INST
 ifndef DEBUG_RULES
 $(error This Makefile needs to be invoked by build/make/install)
```


In any case, it would make sense at that point to go through every spkg-install and strip out any "-O2" and "-march=native" additions.


---

Comment by @kliem created at 2020-01-06 08:34:06

New commits:


---

Comment by @kliem created at 2020-01-06 08:44:42

Thanks. I basically did it like this.

I also added `-O0`, `-O2` and `-g` according to `SAGE_DEBUG`. This helps clean up a lot of code (basically every package sets those flags manually).

Finally, I used `src/bin/testcflags.sh` to remove unsupported flags.

The package `ecm` still adds `-march=native` on top of `CFLAGS` unless a similar flag is present.

Some packages prefer `-O3` over `-O2`, so I left the flag `-O3` as it is.

With this branch all tests passed on my end (ran distclean and installed all packages I touched).

Replying to [comment:21 mjo]:
> This does the trick, but might be a bit blunt:
> 
> {{{
> diff --git a/build/make/Makefile.in b/build/make/Makefile.in
> index eea7ceb7dc..a5966b8011 100644
> --- a/build/make/Makefile.in
> +++ b/build/make/Makefile.in
> `@``@` -17,6 +17,13 `@``@`
>  # Always use bash for make rules
>  SHELL = `@`SHELL`@`
> 
> +# Use safe-but-efficient optimization flags, if the user does not
> +# provide his own.
> +CFLAGS ?= -O2 -march=native
> +CXXFLAGS ?= -O2 -march=native
> +export CFLAGS
> +export CXXFLAGS
> +
>  ifndef SAGE_SPKG_INST
>  ifndef DEBUG_RULES
>  $(error This Makefile needs to be invoked by build/make/install)
> }}}
> 
> In any case, it would make sense at that point to go through every spkg-install and strip out any "-O2" and "-march=native" additions.


---

Comment by @kliem created at 2020-01-15 10:43:18

Is the new code acceptable?


---

Comment by mjo created at 2020-01-18 01:39:12

LGTM at first glance. Good job figuring out what to do with SAGE_DEBUG and SAGE_FAT_BINARY, I missed those entirely.

I've never tried passing `-march=native` to gfortran, but it looks like it should work. I've added it to my local config for future builds.

The use of testcflags.sh only attempts to compile a C program with those flags, but then appends them to the compiler flags for C++ and fortran as well. That's not 100% correct, but I think we're already making the assumption that every compiler is from the same version of the same gcc suite? (Anyone?) So long as it works, I'd be happy with a comment about that. In the future, we could always change it to use the `AX_CHECK_COMPILE_FLAG` repeatedly, but that's overkill until we can actually swap out compilers.


---

Comment by @kliem created at 2020-01-27 10:41:54

Ok, I added a comment about that assumption.

Is this at a point where people can/should test it again?
----
New commits:


---

Comment by mjo created at 2020-01-27 15:08:36

Yeah, now it just needs testing on a few different platforms. I've been using `-march=native` in my exported CFLAGS for years without problems, and your implementation looks OK to me, but I'm on a boring amd64/linux system and these days I'm doing my best to *not* build any spkgs.

While testing, you should be sure that the spkg really gets used (otherwise, the CFLAGS are irrelevant). The `./configure` script nowadays will do its best to use packages from the system instead of an spkg. You can disable that using e.g. `--without-system-foo`, but there are a lot of flags you have to pass. Something like


```
$ ./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/'
--without-system-arb
--without-system-atlas
--without-system-bzip2
...
```


can be used to get the full list for your branch.


---

Comment by @kliem created at 2020-01-29 10:50:02

Ok. Took a while, but it seems to work now. The test `sage -t --long src/sage/interfaces/psage.py` only worked on retry, but I guess this is fine.

What I did was basically the following:


```
$ make distclean
$ ./configure $(./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | past -sd " ")
$ make build; ./sage -i openssl; ./sage -f python3; ./sage -i pyopenssl; make build
$ ./sage -i $(./sage --optional | awk -F\. '{print $1}' | grep -v warnings | grep -v package |  grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd " ")
$ sage -i sage_numerical_backends_coin
$ make
$ sage -t --long --all
```

(install gcc)


```
$ make distclean
$ ./configure $(./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd " ")
$ make build; ./sage -i openssl; ./sage -f python3; ./sage -i pyopenssl; make build
$ ./sage -i $(./sage --optional | awk -F\. '{print $1}' | grep -v warnings | grep -v package | grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd " ")
$ sage -i sage_numerical_backends_coin; make; sage -t --long --all
```

(use system gcc)

I'm often having trouble with openssl and I don't exactly understand the problem (but the workaround seems to work), so I guess you can ignore that part.

I would suggest the following for others to test it:

- Pull ticket.
- Unset `CFLAGS` etc.
- `make distclean`
- configure to compile as you would usually do, plus add the following:

```
$ ./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd " "
```

  so e.g. one would configure to compile with clang as follows:

```
$ CC=clang CXX=clang++ FC=flang ./configure $(./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd " ")
```

- make sage
- install optional packages

```
$ ./sage -i $(./sage --optional | awk -F\. '{print $1}' | grep -v warnings | grep -v package |  grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd " ") sage_numerical_backends_coin
```

- test everything with `sage -t --all --long`

Report any (unusual) trouble you are having.


---

Comment by mkoeppe created at 2020-02-02 17:31:38

To test build changes like this systematically, I recommend to use #29053 / #29087.


---

Comment by @kliem created at 2020-02-03 15:18:31

[https://github.com/kliem/sage-test-27122/runs/422709282](https://github.com/kliem/sage-test-27122/runs/422709282)

I pulled the newest develop and #29087 to run those tests.

It's really hard to see the difference to your run: [https://github.com/mkoeppe/sage/runs/422167181](https://github.com/mkoeppe/sage/runs/422167181). I'm reducing my attention here to those tests that suceeded for you:

- Problems with gsl for
  - ubuntu-xenial, minimal, ubuntu-latest
  - ubuntu-xenial, standard, ubuntu-latest

- Problems with gsl and libatomic_ops for
  - ubuntu-bionic, standard, ubuntu-latest
  - ubuntu-eoan, standard, ubuntu-latest
  - fedora-26, standard, ubuntu-latest
  - fedora-28, standard, ubuntu-latest

- Never ran the following:
  - ubuntu-bionic-i386, standard:

From this I gather that maybe one shouldn't use `-march=native` for those two packages. Does this make any sense?

Replying to [comment:30 mkoeppe]:
> To test build changes like this systematically, I recommend to use #29053 / #29087.


---

Comment by @kliem created at 2020-03-30 07:20:29

New commits:


---

Comment by @kliem created at 2020-03-31 15:08:59

Can someone please help me with the following issue.

- conda-forge and homebrew-macos

```
  `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`
```

  The following line seems to be a problem:

```
+opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))
```


Otherwise things are looking good, I would say.

Things have improved "by themselves" (of course not):

[https://github.com/kliem/sage-test-27122/actions/runs/66307817](https://github.com/kliem/sage-test-27122/actions/runs/66307817)

Now the current ticket (with #29087 merged) runs as smooth as the current beta [https://github.com/mkoeppe/sage/actions/runs/65613035](https://github.com/mkoeppe/sage/actions/runs/65613035). However many tests got cancelled due to exceeding 6 hours.

- ubuntu-trusty, minimal:
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/matrix/matrix2.pyx  # Timed out

```
sage: all(L.change_ring(SR).is_cross_positive_on(K)
    for L in K.cross_positive_operators_gens())  # long time ## line 15240 ##
```


  Got cancelled at `sage -t src/sage/numerical/linear_tensor.py` (6 hours)
- ubuntu-trusty, standard
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  
  Got cancelled at `sage -t src/sage/modular/local_comp/liftings.py`
- ubuntu-trusty, standard-python2
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/doctest/test.py [https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ](https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ)

  Got cancelled at `sage -t src/sage/schemes/affine/affine_subscheme.py`

- ubuntu-xenial, minimal -- ubuntu-bionic, minimal -- debian-jessie, minimal -- debian-buster, minimal -- fedora-26, minimal -- fedora-26, standard -- centos-8, standard -- archlinux-latest, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed

- ubuntu-xenial, standard -- ubuntu-xenial, standard-python2
  - sage -t src/sage/graphs/digraph_generators.py  # 5 doctests failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- ubuntu-bionic, standard -- ubuntu-bionic, standard-python2 -- ubuntu-focal, standard -- ubuntu-focal, standard-python2 -- linuxmint-19.3, standard, linuxmint-19.3, standard-python2
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (only python3)
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed
- ubuntu-eoan, minimal
  Got cancelled at `sage -t src/sage/manifolds/differentiable/differentiable_submanifold.py`
- ubuntu-eoan, standard

```
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/u/underscore/libjs-underscore_1.8.3~dfsg-1_all.deb  Could not connect to azure.archive.ubuntu.com:80 (52.177.174.250), connection timed out
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/s/sphinx/libjs-sphinxdoc_1.6.7-1ubuntu1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-pluggy/python3-pluggy_0.6.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-py/python3-py_1.5.2-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/p/python-setuptools/python3-setuptools_39.0.1-2_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-virtualenv/python3-virtualenv_15.1.0+ds-1.1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-virtualenv/virtualenv_15.1.0+ds-1.1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/t/tox/tox_2.5.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/t/tox/python-tox_2.5.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing?
```

- ubuntu-eoan, standard-python2
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/libs/eclib/interface.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed
- ubuntu-focal, minimal

  cancelled at `sage -t src/sage/geometry/hyperplane_arrangement/check_freeness.py`

- debian-jessie, standard
  - sage -t src/sage/doctest/test.py  # Timed out

```
 sage: if system() == "Linux":
    P = subprocess.Popen(["sage", "-t", "--warn-long", "0", "--memlimit=2000", "memlimit.rst"], stdout=subprocess.PIPE, **kwds)
    out, err = P.communicate()
    ok = ("MemoryError: failed to allocate" in bytes_to_str(out)) ## line 521 ##
```

    probably related to [https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ](https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ)
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- debian-jessie, standard-python2
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py
    Timed out
  - sage -t src/sage/doctest/test.py  # 1 doctest failed
  cancelled at `sage -t src/sage/rings/rational.pxd`

- debian-buster, standard -- debian-buster, standard-python2
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (only python3)
  - sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 2 doctests failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- debian-bullseye, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  cancelled at `sage -t src/sage/modular/modform/weight1.py`

- debian-bullseye, standard -- debian-bullseye, standard-python2 -- debian-sid, standard
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/lfunctions/dokchitser.py  # 2 doctests failed
  - sage -t src/sage/lfunctions/pari.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/interfaces/maxima.py  # Timed out (only debian-sid, standard-python2)
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/number_field/number_field_ideal.py  # 2 doctests failed
  - sage -t src/sage/rings/number_field/number_field.py  # 8 doctests failed
  - sage -t src/sage/rings/number_field/unit_group.py  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (python3 only)
  - sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed
  - sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out
  - sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # 3 doctests failed
  - sage -t src/sage/schemes/elliptic_curves/height.py  # 6 doctests failed
  - sage -t src/sage/schemes/plane_conics/con_number_field.py  # 1 doctest failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- debian-sid, minimal

  cancelled at `sage -t src/sage/misc/bindable_class.py`
- linuxmint-19.3, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
  cancelled at `sage -t src/sage/rings/polynomial/polynomial_number_field.pyx`

- fedora-26, standard-python2

- fedora-28, minimal

  cancelled at `sage -t src/sage/plot/disk.py`
- centos-7, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  cancelled at `sage -t src/sage/sat/solvers/satsolver.pxd`
- centos-8, standard
  
  cancelled during `[pplpy-0.8.4] installing. Log file: /sage/logs/pkgs/pplpy-0.8.4.log`
- centos-8, standard-python2
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
- centos-8, minimal
 
  cancelled at `sage -t src/sage/manifolds/differentiable/characteristic_class.py`
- centos-8, standard-python2

  cancelled during traceback of `sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out`

- archlinux-latest, standard -- archlinux-latest, standard-python2
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (python3 only)

- slackware (build failure, see #29373)


---

Comment by @kliem created at 2020-03-31 15:09:43

Replying to [comment:33 gh-kliem]:
> Can someone please help me with the following issue.
> 
> - conda-forge and homebrew-macos
> {{{
>   `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`
> }}}
>   The following line seems to be a problem:
> {{{
> +opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))
> }}}


---

Comment by @kliem created at 2020-03-31 15:09:43

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-03-31 15:53:02

Replying to [comment:34 gh-kliem]:
> Replying to [comment:33 gh-kliem]:
> > Can someone please help me with the following issue.
> > 
> > - conda-forge and homebrew-macos
> > {{{
> >   `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`
> > }}}
> >   The following line seems to be a problem:
> > {{{
> > +opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))
> > }}}

Where do you see this line?


---

Comment by mkoeppe created at 2020-03-31 15:55:28

Oh, I see, you added this on the ticket. See #29381.


---

Comment by mkoeppe created at 2020-03-31 15:57:40

Lots of the doctest failures that you reported can also be seen on 9.1.beta9 on these platforms. 
Help with fixing them is very welcome.
See https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/5vDLmipuAwAJ


---

Comment by git created at 2020-03-31 16:49:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-03-31 16:51:35

Replying to [comment:36 mkoeppe]:
> Oh, I see, you added this on the ticket. See #29381.

Thanks.

Well, turns out I haven't tested anything new. Enabling `march=native` just failed everywhere and I retested the newest beta.


---

Comment by @kliem created at 2020-04-01 08:35:33

Seems to work now:

[https://github.com/kliem/sage-test-27122/actions/runs/67557444](https://github.com/kliem/sage-test-27122/actions/runs/67557444)

Some strange fail in (debian-bullseye, standard):

```
cp: cannot create directory '/sage/local/./lib/python3.7/site-packages/Cython/__pycache__': File exists
```

Looks somewhat like a racing condition to me. Given that it bullseye suceeds on minimal and standard-python2, I would say it's fine.

Otherwise its the usual suspects (note that macos got cancelled due to timout):

- sage -t src/sage/doctest/test.py  # 1 doctest failed
- sage -t src/sage/graphs/digraph_generators.py  # 5 doctests failed

  e.g. ubuntu-xenial, standard, might be related to #28958

  seems to use system nauty: `configure: will use system package and not install SPKG nauty`
- sage -t src/sage/interfaces/r.py  # 1 doctest failed #29471
- sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed #29442
- sage -t src/sage/lfunctions/dokchitser.py  # 2 doctests failed #29472
- sage -t src/sage/lfunctions/pari.py  # 1 doctest failed #29472
- sage -t src/sage/libs/eclib/interface.py  # 2 doctests failed #28943
- sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed #29493
- sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out #29440
- sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed #29493
- sage -t src/sage/rings/number_field/unit_group.py  # 1 doctest failed #29472
- sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out #29472
- sage -t src/sage/rings/number_field/number_field_ideal.py  # 2 doctests failed #29445 and #29472
- sage -t src/sage/rings/number_field/number_field.py  # 8 doctests failed #29472
- sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed #29272
- sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed #29472
- sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # 3 doctests failed #29472 (fixes 2 of them)
- sage -t src/sage/schemes/elliptic_curves/height.py  # 6 doctests failed
- sage -t src/sage/schemes/plane_conics/con_number_field.py  # 1 doctest failed
- sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 2 doctests failed #29494
- sage -t src/sage/tests/cmdline.py  # 3 doctests failed #29092


---

Comment by @kliem created at 2020-04-01 08:35:33

Changing status from needs_info to needs_review.


---

Comment by @kliem created at 2020-04-24 08:05:09

Is this ticket anywhere near a positive review?

It would be nice to migrate my own implementation for bitsets for `CombinatorialPolyhedron` to the one in `data_structures/bitsets.pxi`. That would prevent a lot of code duplication for #29191. But I would only do this, if I can modify `data_structures/bitsets.pxi` such that it uses intrinsics.

But, enabling intrinsics without `-march=native` as default would mean that a lot of code is never really tested as many cases are very dependent on the specific architecture (see #27103).


---

Comment by dimpase created at 2020-04-24 11:17:27

One problem with `-march=native` as default is that building binary packages with it is a bit hard (unless it is combined with settings for a low grade CPU).

Perhaps, keeping it a non-default is more meaningful?


---

Comment by @kliem created at 2020-04-24 11:54:18

Isn't that what `SAGE_FAT_BINARY` is for?

I just noticed that need to rebase.


---

Comment by @kliem created at 2020-04-24 13:21:30

New commits:


---

Comment by mkoeppe created at 2020-04-24 13:51:45

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-24 13:51:45

Looks good to me and should be merged early in the 9.2 series


---

Comment by @kliem created at 2020-04-24 13:52:17

Thanks.


---

Comment by mkoeppe created at 2020-04-25 15:45:10

Looks like `@`vbraun is already merging it for 9.1.

In a test run for `ubuntu-trusty-minimal` (https://github.com/mkoeppe/sage/runs/617198833) I see a new error building gfortran:

```
/sage/local/var/tmp/sage/build/gfortran-9.2.0/gcc-build/./gcc/xgcc -B/sage/local/var/tmp/sage/build/gfortran-9.2.0/gcc-build/./gcc/ -B/sage/local/x86_64-pc-linux-gnu/bin/ -B/sage/local/x86_64-pc-linux-gnu/lib/ -isystem /sage/local/x86_64-pc-linux-gnu/include -isystem /sage/local/x86_64-pc-linux-gnu/sys-include    -O2 -g -march=native -O2  -O2 -g -march=native -DIN_GCC    -W -Wall -Wno-narrowing -Wwrite-strings -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -fpic -mlong-double-80 -DUSE_ELF_SYMVER  -g -DIN_LIBGCC2 -fbuilding-libgcc -fno-stack-protector   -fpic -mlong-double-80 -DUSE_ELF_SYMVER  -I. -I. -I../.././gcc -I../../../src/libgcc -I../../../src/libgcc/. -I../../../src/libgcc/../gcc -I../../../src/libgcc/../include -I../../../src/libgcc/config/libbid -DENABLE_DECIMAL_BID_FORMAT -DHAVE_CC_TLS  -DUSE_TLS -o _ffssi2_s.o -MT _ffssi2_s.o -MD -MP -MF _ffssi2_s.dep -DSHARED -DL_ffssi2 -c ../../../src/libgcc/libgcc2.c
/tmp/ccjkcyn0.s: Assembler messages:
/tmp/ccjkcyn0.s:3937: Error: no such instruction: `vmovdqu8 (%rcx),%xmm0'
/tmp/ccjkcyn0.s:3939: Error: no such instruction: `vmovdqu8 -16(%rcx,%r8),%xmm1'
/tmp/ccjkcyn0.s:6032: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6033: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6034: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6035: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6036: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6037: Error: operand size mismatch for `vmovdqa64'
```


Also #29575 (debian-jessie: fflas_ffpack again) is from that run.

So this may need some more work


---

Comment by mkoeppe created at 2020-04-25 15:45:59

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-04-25 15:47:13

Also segfaults building dochtml with `ubuntu-bionic-standard` (https://github.com/mkoeppe/sage/runs/617198861)


---

Comment by mkoeppe created at 2020-04-25 15:50:47

Also segfault on `linuxmint-19.3-minimal` (https://github.com/mkoeppe/sage/runs/617198994)

Definitely not ready for 9.1.


---

Comment by mkoeppe created at 2020-04-25 15:53:45

Also breaks gfortran build on `cygwin-minimal` (https://github.com/mkoeppe/sage/runs/617198553)


---

Comment by vbraun created at 2020-04-25 21:35:08

Resolution: fixed


---

Comment by vbraun created at 2020-04-25 21:36:03

Changing status from closed to new.


---

Comment by vbraun created at 2020-04-25 21:36:03

Resolution changed from fixed to 


---

Comment by @kliem created at 2020-04-25 21:53:53

New commits:


---

Comment by @kliem created at 2020-04-25 22:30:24

What I'm getting from the failures above is the following:

Don't use `-march=native` as a default for gfortran and and python.

Require gcc at least 5.1 in addition to the checks here (this was my first approach, I don't find the bug anymore that caused me to think we need at least version 5.1, but certainly 4.9.2 isn't working for us).


---

Comment by mkoeppe created at 2020-04-26 18:22:25

This change is broken (empty then clause)

```
diff --git a/build/pkgs/pari/spkg-check.in b/build/pkgs/pari/spkg-check.in
index ae3aecb..a353b0e 100644
--- a/build/pkgs/pari/spkg-check.in
+++ b/build/pkgs/pari/spkg-check.in
@@ -3,10 +3,8 @@
 ###########################################
 
 if [ "x$SAGE_DEBUG" = xyes ] ; then
-    CFLAGS="$CFLAGS -O0 -g" # Disable optimisation, add debug symbols. Good
-                            # for debugging or working around compiler bugs.
 else
-    CFLAGS="-O3 -g $CFLAGS" # Default optimisation, with debug symbols.
+    CFLAGS="-O3 $CFLAGS" # Default optimisation, with debug symbols.
                             # Prepend to not override user's setting.
 fi
 
```

Reported by vbraun at #29589


---

Comment by @kliem created at 2020-04-27 09:16:50

Replying to [comment:52 mkoeppe]:
> Also segfault on `linuxmint-19.3-minimal` (https://github.com/mkoeppe/sage/runs/617198994)
> 
> Definitely not ready for 9.1.

This appears to be #28800. I'm currently using the original settings for
- pari (to fix this segemtation fault),
- fflas_ffpack,
- gfortran.

I'll push something, once I have more luck.


---

Comment by @kliem created at 2020-04-27 15:19:15

New commits:


---

Comment by git created at 2020-04-27 15:25:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-04-28 06:20:33

It seems that my approaches for disabling `-march=native` for certain packages don't work.

For ubuntu-trusty it tried to compile `gfortran` with `-march=native`, but I tried to disable that.

https://github.com/kliem/sage-test-27122/runs/622914460?check_suite_focus=true

For linuxmint-19, python 2 I'm still getting the segmentation fault when building the documentation. So I'm suspecting that `pari` was build with `-march=native` against my wishes.

https://github.com/kliem/sage-test-27122/runs/622915243?check_suite_focus=true

I can keep on trying, but maybe someone that understands those scripts better than me finds a mistake. I would appreciate that.


---

Comment by @kliem created at 2020-04-28 06:20:33

Changing status from new to needs_info.


---

Comment by git created at 2020-04-29 08:09:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-04-29 08:29:41

Turns out my makefile syntax was completely wrong. But I think I got it figured out now and it should correctly determine the gcc version (and check correctly `SAGE_DEBUG` and `SAGE_FAT_BINARY`).

`@`embray: As you wrote a workaround that fixes segmentation faults when building the documentation in #28356, maybe you have an educated guess, which package might be causing the following problem. Currently I disable `-march=native` for the following:
- pari
- cypari
- pari_jupyter
- fflas_ffpack
- gfortran
- gcc (I'm not sure if `gcc/build_gcc` will do that, it seemed to help the gfortran issue however)
- linbox


```
[combinat ] building [inventory]: targets for 368 source files that are out of date
[combinat ] updating environment: 368 added, 0 changed, 0 removed
Error building the documentation.
Traceback (most recent call last):
  File "/sage/local/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/sage/local/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 1720, in main
    builder()
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 327, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 552, in _wrapper
    self._build_everything_except_bibliography(lang, format, *args, **kwds)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 538, in _build_everything_except_bibliography
    build_many(build_ref_doc, non_references)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 280, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
Exception: ('Non-exception during docbuild: Segmentation fault', SignalError('Segmentation fault'))
```


`@`all: Is there a way to obtain a meaningful backtrace? Antonio Rojas stated that he downgraded sage to obtain that. But that is not really an option here. 
https://groups.google.com/d/msg/sage-packaging/VU4h8IWGFLA/rU-8NCPjBgAJ


---

Comment by mkoeppe created at 2020-05-13 22:14:20

I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY


---

Comment by mkoeppe created at 2020-05-13 22:14:52

likewise for SAGE_DEBUG


---

Comment by @kliem created at 2020-05-14 07:13:27

Yes, I also realized that.

When I was looking for which flags the packages where using, I always looked into the configure file, because that's the place where it belongs to :-) It took me a while to realize that I'm doing it wrong then.


---

Comment by saraedum created at 2020-05-27 14:53:20

Sorry, haven't read through all the discussion, so apologies if this already came up. The gcc manpage recommends `-Og -g` to "Optimize debugging experience" over `-O0` and the resulting code runs much faster.


---

Comment by @kliem created at 2020-06-15 13:36:10

New try. Do it in `configure.ac` now, this is where it belongs I think. I will most likely have all the old problems again.
----
New commits:


---

Comment by @kliem created at 2020-06-15 13:39:38

Replying to [comment:65 mkoeppe]:
> I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY

What kind of options should I add for this?

Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.


---

Comment by git created at 2020-06-15 13:43:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-06-15 13:47:52

we configure compilers mostly in `build/pkgs/{gcc,gfortran}/spkg-configure.m4` - could you perhaps move (most of) your changes to `configure.ac` there?


---

Comment by @kliem created at 2020-06-15 13:57:12

I don't think this is where it belongs. I'm setting flags for building any package.

This is usually done in `configure.ac` and is so already. If you don't set `CFLAGS` then `AC_PROG_CC()` will set `CFLAGS` to `-g -02` (or different order).


---

Comment by dimpase created at 2020-06-15 14:10:58

Replying to [comment:73 gh-kliem]:
> I don't think this is where it belongs. I'm setting flags for building any package.

sure, you are setting compilers' flags, and this is done in the files I pointed to.
E.g. in `build/pkgs/gcc/spkg-configure.m4` we have

```
    # Modify CXX to include an option that enables C++11 support if necessary
    AX_CXX_COMPILE_STDCXX_11([], optional)
```

which adds if needed something to `CXXFLAGS`, etc.


> 
> This is usually done in `configure.ac` and is so already. If you don't set `CFLAGS` then `AC_PROG_CC()` will set `CFLAGS` to `-g -02` (or different order).

AC_PROG_CC only is called early in `configure.ac` to ensure general sanity.
As you might know, `build/pkgs/*/spkg-configure.m4` are collected by `./boostrap` and used to
generate `./configure` from them and `configure.ac`. We have moved a lot of compiler-specific stuff into  `build/pkgs/*/spkg-configure.m4` when the latter were instroduced, and for a good reason.


---

Comment by mkoeppe created at 2020-06-15 14:20:53

Replying to [comment:70 gh-kliem]:
> Replying to [comment:65 mkoeppe]:
> > I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY
> 
> What kind of options should I add for this?
> 
> Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.

What I meant by this was for the top-level configure to have an option `--enable-fat-binary` (or perhaps a better name for that) so that this is not controlled by an environment variable.


---

Comment by git created at 2020-06-15 15:06:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-15 15:07:16

Replying to [comment:75 mkoeppe]:
> Replying to [comment:70 gh-kliem]:
> > Replying to [comment:65 mkoeppe]:
> > > I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY
> > 
> > What kind of options should I add for this?
> > 
> > Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.
> 
> What I meant by this was for the top-level configure to have an option `--enable-fat-binary` (or perhaps a better name for that) so that this is not controlled by an environment variable.

Yes this should make things easier.


---

Comment by git created at 2020-06-16 05:25:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-17 21:38:21

Changing status from needs_info to needs_review.


---

Comment by @kliem created at 2020-06-17 21:38:21

It seems that with the new approach things have improved. Or maybe some work has been done somewhere else.

- tox.ini:

  looks the same to me (new failure to push docker image for debian-jessie):

  beta1: https://github.com/sagemath/sage/actions/runs/134966983

  #27122: https://github.com/kliem/sage/actions/runs/136808684

- optional:

  no new failure (although tests aren't all the way done yet)

  beta1: https://github.com/sagemath/sage/actions/runs/134966981

  #27122: https://github.com/kliem/sage/actions/runs/136808682 

- `gcc_spkg`:

  some tests take half an hour longer, but I don't know if that has any say

  beta1: https://github.com/sagemath/sage/actions/runs/134966986

  #27122: https://github.com/kliem/sage/actions/runs/136808677

- cygwin-standard:

  looks the same to me:

  beta1: https://github.com/sagemath/sage/actions/runs/134966985

  #27122: https://github.com/kliem/sage/actions/runs/136808676

- cygwin-minimal:

  looks the same to me:

  beta1: https://github.com/sagemath/sage/actions/runs/134966984

  https://github.com/kliem/sage/actions/runs/136808673


---

Comment by @kliem created at 2020-06-17 22:11:44

Never mind. The environment variables `CFLAGS` never made it from `configure.ac` to anywhere else.

I'm trying to figure out, who to do this. Any help welcome.


---

Comment by @kliem created at 2020-06-17 22:11:44

Changing status from needs_review to needs_info.


---

Comment by git created at 2020-06-17 22:40:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-17 22:41:47

Changing status from needs_info to needs_work.


---

Comment by @kliem created at 2020-06-17 22:41:47

I think I found the correct place.

Now it's probably going to fail on certain machines again.


---

Comment by dimpase created at 2020-06-18 13:22:21

once again, settings of gcc flags are not to be done in `configure.ac` - as I explained, we already have all of them we currently set, set in `build/pkgs/{gcc,gfortran}/spkg-configure.m4`

Please move them accordingly, or if you have problem doing that, I can help, but doing compiler settings in two different places is verboden.


---

Comment by @kliem created at 2020-06-18 18:48:17

Well, `configure.ac` runs `AC_PROG_CC()`, which sets `CFLAGS` to `-g -O2` if not set, so we must grep the user `CFLAGS` in `configure.ac` (it was already pointed out above that user input `CFLAGS` should not be overridden unless necessary).

If I get this right, `configure.ac` just barely checks if there is anything that can be used to at least build gcc. In `gcc` we futher analyse what the user has and figure out, whether this suffices.

I agree that it makes sense to figure out the flags there as we are doing all those case distinctions already (what compiler are you etc, can you compile a basic file etc.). I'll take care of it soon, but not today (as for testing it shouldn't really make a difference, there are many open problems with this).


---

Comment by dimpase created at 2020-06-18 23:45:04

I think `AC_PROG_CC` etc can be moved to gcc/gfortran's `spkg-configure.m4`


---

Comment by dimpase created at 2020-06-19 10:36:55

Replying to [comment:85 dimpase]:
> I think `AC_PROG_CC` etc can be moved to gcc/gfortran's `spkg-configure.m4`

I did a very quick check, applying

```diff
--- a/configure.ac
+++ b/configure.ac
@@ -308,6 +308,7 @@ AX_PROG_PERL_VERSION([5.8.0],[],[
 # Check C/C++/Fortran compilers
 ###############################################################################
 
+SAGE_SPKG_COLLECT()
 SAGE_CHECK_CONDA_COMPILERS
 
 AC_PROG_CC()
@@ -412,7 +413,6 @@ AS_IF([test "x$enable_download_from_upstream_url" = "xyes"], [
 ])
 AC_SUBST([SAGE_SPKG_OPTIONS])
 
-SAGE_SPKG_COLLECT()
 
 # We need sage-env-config to exist before running this.
 # TODO: fix this in Trac #21524
```

and everything still seemed to be working. This means that we can move all these `AC_PROG_*()`
(perhaps using `AC_REQUIRE()`) to respective `build/pkgs/*/*.m4` files.

If you could try this during the refactoring you're planning to do, it'd be great.


---

Comment by git created at 2020-06-20 05:36:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-20 05:40:02

And back to the old problems again.

https://github.com/kliem/sage/actions/runs/140694723

There are sementation faults when building the documentation e.g. in ubuntu bionic.

However, I disabled `march=native` for pari and all packages depending on `pari` and that still didn't seem to fix the issue (according to the logs this seemed to work).

Something isn't thread safe from above probably as in #28800. I have no clue, about that and I'm left with disabling `march=native` for random packages and hoping that I have luck.

Or does anyone know how to get a meaningful log of the documentation build?


---

Comment by @kliem created at 2020-06-20 05:40:02

Changing status from needs_work to needs_info.


---

Comment by @kliem created at 2020-06-20 05:45:30

One thing one could do, is to not build the documentation and hope that the problem shows up during the doctests.


---

Comment by fbissey created at 2020-06-20 05:55:06

permutahedron. Looks like stuff linked to cddlib, it says so in the code. I don't remember cddlib to be so sensitive to optimisation. Heck, I use `-march=native` in my sage-on-gentoo builds and I am fine.
But `pari` is definitely sensitive to optimisation. When I was working on enabling clang, I also tried the Intel compiler. `pari` needed to be compiled at `-O0` with it. Any optimisation with icc would break it. That was the only package that I remember with that issue.


---

Comment by @kliem created at 2020-06-20 12:33:18

Thanks. I'm going through the packages now. It might have been `lcalc` after all though. Turns out it also uses `CFLAGS`, but we never minded that in `spkg-install`. And as it uses the pari headers, it might recompile something and then lead to the problem.


---

Comment by @kliem created at 2020-06-20 12:33:37

And it wasn't `cddlib`, at least not by itself.


---

Comment by @kliem created at 2020-06-21 06:38:04

I think I found the problem. After disabling gap, it worked.

https://github.com/kliem/sage/actions/runs/141805272


---

Comment by @kliem created at 2020-06-21 06:38:04

Changing status from needs_info to needs_review.


---

Comment by git created at 2020-06-23 06:58:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2020-06-23 07:27:41

I meant to change from "needs info" to "needs work" earlier.


---

Comment by @kliem created at 2020-06-23 07:27:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-06-23 12:02:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-23 12:07:53

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-06-23 12:07:53

Tests are running here:

- tox.ini: https://github.com/kliem/sage/actions/runs/144837797
- tox.ini with gcc-spkg: https://github.com/kliem/sage/actions/runs/144837787
- optional: https://github.com/kliem/sage/actions/runs/144837791
- cygwin minimal: https://github.com/kliem/sage/actions/runs/144837775
- cygwin standard: https://github.com/kliem/sage/actions/runs/144837781

In comparison to 9.2beta1:

- tox.ini: https://github.com/sagemath/sage/actions/runs/134966983
- tox.ini with gcc-spkg: https://github.com/sagemath/sage/actions/runs/134966986
- optional: https://github.com/sagemath/sage/actions/runs/134966981
- cygwin minimal: https://github.com/sagemath/sage/actions/runs/134966984
- cygwin standard: https://github.com/sagemath/sage/actions/runs/134966985


---

Comment by @kliem created at 2020-06-23 21:43:53

Somehow it seems the second last commit `74b82b6506cd71d87f616389fe2fa142dd16f4cf` has messed up the `scipy` build. Or something else is going on. I'm getting:


```
 [sagelib-9.2.beta1] installing. Log file: /sage/logs/pkgs/sagelib-9.2.beta1.log
  [sagelib-9.2.beta1] successfully installed.
  [scipy-1.2.3] error installing, exit status 1. End of log file:
  [scipy-1.2.3]       Running setup.py install for scipy: finished with status 'error'
  [scipy-1.2.3]   Cleaning up...
  [scipy-1.2.3]     Removing source in /tmp/pip-req-build-18apw96c
  [scipy-1.2.3]   Removed build tracker '/tmp/pip-req-tracker-x3hgraz6'
  [scipy-1.2.3]   Command "/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-req-build-18apw96c/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-record-v0usfnl4/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/scipy-1.2.3/inst --compile --install-headers /sage/local/include/site/python3.7/scipy" failed with error code 1 in /tmp/pip-req-build-18apw96c/
  [scipy-1.2.3]   Exception information:
  [scipy-1.2.3]   Traceback (most recent call last):
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/cli/base_command.py", line 143, in main
  [scipy-1.2.3]       status = self.run(options, args)
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/commands/install.py", line 366, in run
  [scipy-1.2.3]       use_user_site=options.use_user_site,
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/req/__init__.py", line 49, in install_given_reqs
  [scipy-1.2.3]       **kwargs
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/req/req_install.py", line 791, in install
  [scipy-1.2.3]       spinner=spinner,
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/utils/misc.py", line 705, in call_subprocess
  [scipy-1.2.3]       % (command_desc, proc.returncode, cwd))
  [scipy-1.2.3]   pip._internal.exceptions.InstallationError: Command "/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-req-build-18apw96c/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-record-v0usfnl4/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/scipy-1.2.3/inst --compile --install-headers /sage/local/include/site/python3.7/scipy" failed with error code 1 in /tmp/pip-req-build-18apw96c/
  [scipy-1.2.3]   Error: installing with pip3 failed
```


on many platforms. Seems like I messed up when moving stuff around from `configure.ac` to `{gcc,gfortran}/spkg-configure.ac`.


---

Comment by git created at 2020-06-24 22:27:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-24 22:29:53

I undid part of the reordering (or most of it).

It looks much better now (some tests still running):

- tox.ini: https://github.com/kliem/sage/actions/runs/145781781
- gcc-spkg: https://github.com/kliem/sage/actions/runs/145781778
- optional: https://github.com/kliem/sage/actions/runs/145781780
- cygwin minimal: https://github.com/kliem/sage/actions/runs/145781783
- cygwin standard: https://github.com/kliem/sage/actions/runs/145781785


---

Comment by dimpase created at 2020-06-25 06:58:47

OK, this still looks acceptable, w.r.t. what is done in configure.ac, and try further refactoring on another ticket.


---

Comment by mkoeppe created at 2020-06-25 07:18:31

I took a brief look at the source changes, and it looks clean to me. 
I haven't looked at the tests.


---

Comment by @kliem created at 2020-06-25 10:44:12

Here is a overview, over the test results (all in comparison to the 9.2.beta1 tests and only mentioning differences):

- tox.ini:
  - ubuntu-trusty-standard
    `sage -t src/sage/interfaces/maxima.py  # Timed out` after

```
sage: maxima._batch('10003;') ## line 864 ##
'kill(sage121)$batchload("/root/.sage/temp/9b341214822c/14051/interface/tmp14054-1371013559");1+952962022;\r\n\r\n(%o771) "/root/.sage/temp/9b341214822c/14051/interface/tmp14054-1371013559"\r\n(%o772) '
sage: maxima._batch('10003;',batchload=False) ## line 866 ##
```

  - debian-stretch-standard: didn't finish in 6 hours
  - linuxmint-19.3-minimal: didn't finish in 6 hours
  - fedora-26, standard: `sage -t src/sage/symbolic/expression.pyx  # 1 doctest failed`
  - fedora-27, minimal: failed to build `mpir`
  - fedora-28, standard: `sage -t src/sage/interfaces/maxima.py  # Timed out`
  - fedora-31, minimal: `sage -t src/sage/symbolic/integration/integral.py  # 1 doctest failed`7
  - fedora-32, standard didn't finish in time and `sage -t src/sage/interfaces/maxima.py  # Timed out`
  - local-macos (homebrew-macos-python3_xcode, minimal): new failures

```
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot3d/platonic.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
```

  - local-macos (homebrew-macos-python3_xcode, standard): new failures

```
sage -t src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst  # Timed out
sage -t src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst  # Timed out
sage -t src/sage/geometry/polyhedron/base.py  # Timed out
sage -t src/sage/manifolds/differentiable/affine_connection.py  # Timed out
sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/manifolds/differentiable/multivectorfield.py  # Timed out
sage -t src/sage/manifolds/differentiable/pseudo_riemannian_submanifold.py  # Timed out
sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot3d/platonic.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/isogeny_class.py  # Timed out
```

  - local-macos (homebrew-macos-python3_xcode-nokegonly, minimal)

```
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
```

  - local-macos (homebrew-macos-python3_xcode-nokegonly, standard)

```
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
```

  - local-macos (homebrew-macos-python3_pythonorg, minimal)

```
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
```

  -  local-macos (homebrew-macos-python3_pythonorg, standard)

```
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot3d/platonic.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/schemes/elliptic_curves/isogeny_class.py  # Timed out
sage -t src/sage/symbolic/relation.py  # Timed out
```

  - local-macos (conda-forge-macos): many failures, looks like the new ones are the same as other mac

I'll leave it at that for now.

All those new mac failures don't look good.


---

Comment by @kliem created at 2020-06-25 10:50:02

Replying to [comment:90 fbissey]:
> permutahedron. Looks like stuff linked to cddlib, it says so in the code. I don't remember cddlib to be so sensitive to optimisation. Heck, I use `-march=native` in my sage-on-gentoo builds and I am fine.
> But `pari` is definitely sensitive to optimisation. When I was working on enabling clang, I also tried the Intel compiler. `pari` needed to be compiled at `-O0` with it. Any optimisation with icc would break it. That was the only package that I remember with that issue.

It really looks like `pari` shouldn't be optimzed. At least not when using `clang`.
https://github.com/kliem/sage/runs/787575732?check_suite_focus=true

This old run, didn't have the new doctest failures.

So try disabling `-march=native` for `pari` and maxima`?


---

Comment by git created at 2020-06-25 10:57:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-25 16:46:56

`maxima` doesn't compile with `-march=native`, so I guess this has nothing to do with it.
Hopefully the new run without `pari` will resolve the other problems:
- tox.ini https://github.com/kliem/sage/actions/runs/147321660
- tox.ini gcc-spkg: https://github.com/kliem/sage/actions/runs/147321678
- targets optional: https://github.com/kliem/sage/actions/runs/147321655
- cygwin minimal: https://github.com/kliem/sage/actions/runs/147321676
- cygwin standard: https://github.com/kliem/sage/actions/runs/147321676


---

Comment by dimpase created at 2020-06-25 17:17:09

Replying to [comment:107 gh-kliem]:
> `maxima` doesn't compile with `-march=native`, so I guess this has nothing to do with it.

As far as I understand, Maxima build process does not involve anything but a Lisp compiler, ECL in the case of Sage. And ECL compiles directly into object files, as far as I know.

So this is probably a red herring.


---

Comment by @kliem created at 2020-06-26 09:01:14

The last commits don't make a difference as far as I can tell. But the new mac failures seem to be real random. They are also present here (which is a completely different ticket):
- local-macos (homebrew-macos-python3_pythonorg, minimal) https://github.com/mkoeppe/sage/runs/785733405?check_suite_focus=true

I personally guess the new errors on mac are either random or caused by something else (some package updated maybe). That would also explain why on homebrew-macos-python3_xcode there are so many new failures for standard, but not for minimal. (As this ticket here is supposed to influence minimal much more than standard.)

Something is going on either way, as even on 9.2.beta1 we have many time outs in `plot` and `manifolds`. So if I get an extra error in `sage -t src/sage/plot/plot3d/shapes.pyx`, I don't even know if this is really bad or just random.

Basically, I see the following options now:

- revert the last two commits or not (independent of the other options):

  I don't see an advantage in disabling `-march=native` for `pari`, but maybe that is really something we should do.
- decide that the macos failures are either random or acceptable
- disable `-march=native` for clang (but it is not said that things would improve for mac then)
- someone has an educated guess about what I could do about the mac failures

It is possible however that some of the new mac failures are caused by the fact that the default `CFLAGS` is now `-g -O2` instead of just empty.

For an updated comparison, I started a mac only test on the current develop again:
https://github.com/kliem/sage/actions/runs/148471033


---

Comment by git created at 2020-06-26 20:49:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-26 20:51:19

I can confirm that the mac os errors also happen on a clean build from 9.2.beta1, so I think it has nothing to do with that ticket and is just somewhat random behaviour:

local-macos (homebrew-macos-python3_pythonorg, minimal)
https://github.com/kliem/sage/runs/810515848?check_suite_focus=true

had the following failures:


```
sage -t src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot.py  # Timed out
sage -t src/sage/plot/plot3d/base.pyx  # Timed out
sage -t src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/plot/plot3d/shapes2.py  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
```


I would propose leaving the ticket as it is. Testwise I think it looks fine.


---

Comment by mkoeppe created at 2020-06-26 21:11:37

Could you comment on whether this implements autotools semantics of "precious variables" (see #29507) for CFLAGS, FCFLAGS etc.?


---

Comment by @kliem created at 2020-06-27 09:20:17

This definitely doesn't implement autotools semantics of "precious variables", but I think it is an improvement towards that.

Until now, every build of sage would pick up `CFLAGS`, `CXXFLAGS`, `FCFLAGS` and `F77FLAGS` again from the environment. This is strange especially now that we have seperated `make` from `configure`.

With this ticket the flags will be picked up on `configure` (if set) and will overwritten for `make` according to their set up (this is what `sage-build-env-config.in` does). They are also mostly respected now. Until now, if you set `CFLAGS` to `-O0`, every package `spkg-install.in` would just overwrite that (or add `-g -O2`, which in practice overwrites it I think). Now many (but not all) packages will just respect that.

I think it needs very little change to implement autotools semantics of "precious variables" `CFLAGS` etc. from here, but I'm not sure exactly how to do this.


---

Comment by git created at 2020-06-27 09:20:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-27 09:22:28

Regarding the last commit, we should really pick up `SAGE_DEBUG` from configuration time and not from build time. It will influence the build of some packages.


---

Comment by mkoeppe created at 2020-07-04 19:20:08

Can users still use the `SAGE_DEBUG` environment variable at all to configure anythin, or is it overridden by the enable value?


---

Comment by @kliem created at 2020-07-05 06:00:09


```diff
+AC_ARG_ENABLE([debug],
+              [AS_HELP_STRING([--enable-debug={no|symbols|yes}],
+                              [controls debugging support: "no" debugging; debugging "symbols" (default); build debug version ("yes")])],
+              [AC_SUBST(SAGE_DEBUG, $enableval)],
+              [])
+
```

Yes you can still set `SAGE_DEBUG`. However, if you configure with the option `--enable-debug=...`, it will override this variable.

Note also that this must now be done at configuration time.

I just checked. The following all work:

```
./configure --enable-debug=yes
```


```
./configure SAGE_DEBUG=yes
```


```
export SAGE_DEBUG=yes; ./configure
```



---

Comment by mkoeppe created at 2020-07-06 18:39:02

I think it would be good if at least `make SAGE_DEBUG=yes some-package` would still be supported.


---

Comment by @kliem created at 2020-07-06 18:50:43

Replying to [comment:118 mkoeppe]:
> I think it would be good if at least `make SAGE_DEBUG=yes some-package` would still be supported.

The problem is that what `SAGE_DEBUG` mostly does is to set `CFLAGS` accordingly. If we configure this stuff in `configure` then it feels like doing everything twice. Unless we ignore `SAGE_DEBUG` mostly in `configure` and wait for this until `sage-build-env-config.in`. There we could do

```
export SAGE_DEBUG?="@SAGE_DEBUG@"
```

and then build together all the flags according to `SAGE_DEBUG`.


---

Comment by mkoeppe created at 2020-07-06 19:45:13

This sounds like a good solution.

I think it's important to support per-package SAGE_DEBUG, just like we support per-package SAGE_CHECK.


---

Comment by git created at 2020-07-07 08:20:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @kliem created at 2020-07-07 09:43:32

Ok. I went back into `build/make/Makefile.in`. I think it works now.

If you run `make build SAGE_DEBUG=yes` without configuration, it will still assemble according to `SAGE_DEBUG`. You can even choose different flags with `make CFLAGS=-O2 some-package`. That will also work.

However `export SAGE_DEBUG=yes; make build` will not work, unless for some reason this will induce configuration.


---

Comment by git created at 2020-08-13 05:13:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-08-16 05:40:09

I would be glad if we could bring this in, in an early 9.3 beta.

One could also think of splitting this ticket into two. One that reorders the all the flags and one where we enable march=native.


---

Comment by mkoeppe created at 2020-08-16 06:29:40

Yes, I agree with both points.


---

Comment by git created at 2020-08-16 07:24:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-08-16 07:28:40

Replying to [comment:126 mkoeppe]:
> Yes, I agree with both points.

Ok. The controversial part of adding `-march=native` is now down to a rather small commit.


---

Comment by mkoeppe created at 2020-12-01 17:31:04

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-12-03 10:29:57

Last 10 new commits:


---

Comment by @kliem created at 2020-12-03 10:29:57

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-03 17:53:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-15 06:21:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-12-21 18:26:16

Instead of `SAGE_MARCH`, perhaps something like `CFLAGS_MARCH`...?!
And I would suggest to not use the prefix `CONFIGURED_` here -- because I think this is not a case as for CFLAGS where we want to respect user variable settings?


---

Comment by git created at 2020-12-21 18:48:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-21 18:53:20

Replying to [comment:135 mkoeppe]:
> Instead of `SAGE_MARCH`, perhaps something like `CFLAGS_MARCH`...?!
> And I would suggest to not use the prefix `CONFIGURED_` here -- because I think this is not a case as for CFLAGS where we want to respect user variable settings?

Sure.


---

Comment by mkoeppe created at 2020-12-21 18:56:35

And I thought you had found a better solution for that `free-form` business in #30375?


---

Comment by git created at 2020-12-21 20:36:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-21 20:37:25

Replying to [comment:138 mkoeppe]:
> And I thought you had found a better solution for that `free-form` business in #30375?

Right, I forgot to change that.


---

Comment by mkoeppe created at 2020-12-21 23:00:47

Looks good to me. If you have capacity on GH Actions, could you run it one more time? (Ideally with #31064 for the latest version of the cygwin workflow)


---

Comment by @kliem created at 2020-12-22 07:39:53

Replying to [comment:141 mkoeppe]:
> Looks good to me. If you have capacity on GH Actions, could you run it one more time? (Ideally with #31064 for the latest version of the cygwin workflow)

Capacities are fine. Actually, I'm not using it most of the time, so if you ping me, I can run something.


---

Comment by mkoeppe created at 2020-12-25 19:37:23

Looking good. Thanks for your patience with this long review process.


---

Comment by mkoeppe created at 2020-12-25 19:37:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-12-27 23:25:41

Resolution: fixed


---

Comment by @kliem created at 2020-12-28 06:28:06

Replying to [comment:144 mkoeppe]:
> Looking good. Thanks for your patience with this long review process.
> 

Thank you. And thank you in particular for creating the github workflow for testing.
