# Issue 31711: Reimplement parallel docbuild using make

Issue created by migration from https://trac.sagemath.org/ticket/31948

Original creator: mkoeppe

Original creation time: 2021-06-10 03:21:10

CC:  dimpase

Based on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.


---

Comment by jhpalmieri created at 2021-06-10 20:41:43

I'm not quite sure how to go about this. I tried this:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index fb3a6ed5bc..4581dc3226 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -335,7 +335,12 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
-doc: doc-html
+doc: doc-new
+
+doc-new: $(DOC_DEPENDENCIES)
+       for doc in $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/dochtml.log; \
+       done
 
 doc-html: $(DOC_DEPENDENCIES)
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```

and it seems to build the documentation, but it doesn't do it in parallel, I think because  we've turned off parallel processing for recursive calls to make earlier in the file.

If it did work, this approach would need a little tinkering: we should build the reference manual first, then everything else.

A separate question: why do we use `cd ../..` in the recipe for `doc-html` (and other doc targets), rather than `cd $(SAGE_ROOT)`?


---

Comment by jhpalmieri created at 2021-06-10 20:43:25

And if we really want to pull all of the parallel building out of the current system, then we should build the pieces of the reference manual separately in the `Makefile`. I think this is what you intended.


---

Comment by jhpalmieri created at 2021-06-11 01:18:20

Here is my current attempt, which doesn't quite work:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index fb3a6ed5bc..c199de440d 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -335,7 +335,27 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
-doc: doc-html
+doc: doc-references doc-other
+
+doc-references: $(DOC_DEPENDENCIES)
+       $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))
+       $(eval biblio = $(firstword $(DOCS)))
+       $(eval other_docs = $(wordlist 2, 100, $(DOCS)))
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $(biblio) inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       for doc in $(other_docs); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       done
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links reference inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $(biblio) html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       for doc in $(other_docs); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links reference html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       done
+
+doc-other: $(DOC_DEPENDENCIES) doc-references
+       for doc in $(wordlist 2, 100, $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all)); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/docs-other-html.log; \
+       done
 
 doc-html: $(DOC_DEPENDENCIES)
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index 79005b903a..a3caa8a92d 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -116,7 +116,7 @@ def builder_helper(type):
             # WEBSITESPHINXOPTS is either empty or " -A hide_pdf_links=1 "
             options += WEBSITESPHINXOPTS
 
-        if kwds.get('use_multidoc_inventory', True):
+        if kwds.get('use_multidoc_inventory', True) and type != 'inventory':
             options += ' -D multidoc_first_pass=0'
         else:
             options += ' -D multidoc_first_pass=1'
```

Several problems:

- lack of parallel building
- line 348 should be replaced by something that just builds the top-level reference manual stuff, assembling the parts into one set of indices, etc. Probably the same for line 352.
- I'm getting some warning messages that I don't know what to make of: "[schemes  ] Handler <function on_build_finished at 0x33872ef70> for event 'build-finished' threw an exception", for example.


---

Comment by mkoeppe created at 2021-06-11 03:37:24

To get `make` to parallelize it, the individual documents need to become `make` targets. A combination of `$(eval...)` and a macro call can do this -- similar to https://www.gnu.org/software/make/manual/html_node/Eval-Function.html


---

Comment by jhpalmieri created at 2021-06-11 05:30:07

I don't see how to do anything like that unless we hardcode the list of documents: we can't run `sage --docbuild ...` without building some other targets, so it seems to me that we have to construct the list of documents inside a recipe. But I'm very far from a `Makefile` expert, so I could be missing something.


---

Comment by jhpalmieri created at 2021-06-11 05:41:28

Or write a standalone script to construct the document list.


---

Comment by mkoeppe created at 2021-06-11 16:07:33

Could you push your current version to the ticket please?


---

Comment by jhpalmieri created at 2021-06-11 16:36:22

Here it is.
----
New commits:


---

Comment by mkoeppe created at 2021-06-11 17:46:02

Here's a solution using recursive make invocation
----
New commits:


---

Comment by jhpalmieri created at 2021-06-12 00:59:27

This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.

```
[reference] building [inventory]: targets for 1 source files that are out of date
[reference] updating environment: [new config] 1 added, 0 changed, 0 removed
[reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references
Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds
Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1762, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 769, in _wrapper
    self.write_auto_rest_file(module_name)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1070, in write_auto_rest_file
    with open(filename, 'w') as outfile:
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'
```

With the following change, the documentation builds:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index 339497fd17..12b4e56b20 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -349,11 +349,7 @@ doc-references: $(DOC_DEPENDENCIES)
        $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))
        $(eval biblio = $(firstword $(DOCS)))
        $(eval other_docs = $(wordlist 2, 100, $(DOCS)))
-       +$(MAKE_REC) doc-inventory-$(subst /,-,$(biblio))
-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-inventory-$(subst /,-,$(doc)))
        +$(MAKE_REC) doc-inventory-reference
-       +$(MAKE_REC) doc-html-$(subst /,-,$(biblio))
-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-html-$(subst /,-,$(doc)))
        +$(MAKE_REC) doc-html-reference
 
 doc-other: $(DOC_DEPENDENCIES) doc-references
```

This is a hybrid model, using the old parallel building methods for the reference manual. The inventory build is fine, but I get some strange warnings during the html build:

```
[repl     ] building [html]: targets for 35 source files that are out of date
[polynomia] building [html]: targets for 62 source files that are out of date
[spkg     ] building [html]: targets for 316 source files that are out of date
[tensor_fr] building [html]: targets for 19 source files that are out of date
[algebras ] building [html]: targets for 97 source files that are out of date
[manifolds] building [html]: targets for 81 source files that are out of date
[repl     ] writing additional pages...  searchdone
[repl     ] dumping search index in English (code: en)... done
[repl     ] The HTML pages are in local/share/doc/sage/html/en/reference/repl.
[repl     ] Extension error:
[repl     ] Handler <function on_build_finished at 0x33c247af0> for event 'build-finished' threw an exception
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/html/en/reference/repl
[tensor_fr] writing additional pages...  searchdone
[tensor_fr] dumping search index in English (code: en)... done
[tensor_fr] The HTML pages are in local/share/doc/sage/html/en/reference/tensor_free_modules.
[tensor_fr] Extension error:
[tensor_fr] Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception
```

I don't know what `Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception` means or where it comes from.


---

Comment by mkoeppe created at 2021-06-12 01:14:41

Replying to [comment:12 jhpalmieri]:
> This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.
> {{{
> [reference] building [inventory]: targets for 1 source files that are out of date
> [reference] updating environment: [new config] 1 added, 0 changed, 0 removed
> [reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.
> Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references
> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds
> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage
> Error building the documentation.
> Traceback (most recent call last):
>   File "/usr/local/Cellar/python`@`3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
>     return _run_code(code, main_globals, None,
>   File "/usr/local/Cellar/python`@`3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
>     exec(code, run_globals)
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
>     main()
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1762, in main
>     builder()
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 769, in _wrapper
>     self.write_auto_rest_file(module_name)
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1070, in write_auto_rest_file
>     with open(filename, 'w') as outfile:
> FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'
> }}}

Looks like something forgot to create the directory in which this .rst file is to be created


---

Comment by mkoeppe created at 2021-06-12 01:28:02

I was able to reproduce an error of this form as well.


---

Comment by mkoeppe created at 2021-06-12 01:29:28

If you do `make doc-clean && make SAGE_DOCBUILD_OPTS="--verbose=3" doc`, you can see that this is a race between creating directories and "deleting empty directories"


---

Comment by mkoeppe created at 2021-06-12 01:37:11

I'll add an option to turn it off


---

Comment by git created at 2021-06-12 02:02:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-06-12 04:41:23

I still see

```
[valuation] Extension error:
[valuation] Handler <function on_build_finished at 0x3375808b0> for event 'build-finished' threw an exception
```

for (I think) every piece of the reference manual. Any ideas about this?

Edit: the manual seems to build correctly, regardless.


---

Comment by mkoeppe created at 2021-06-12 05:02:09

No idea about this error. I don't see it here. I suppose you could try to run the docbuild for a document in `pdb` to debug this.


---

Comment by jhpalmieri created at 2021-06-12 17:02:20

I haven't tried `pdb`, but I get it when doing `make doc-clean && make` — running `make` again at that point doesn't produce the error. I also get it on two different machines, one Big Sur, one Catalina.

One more task: the reference manual is built twice: the line

```
+$(MAKE_REC) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference
```

needs to be replaced with something that just builds the top-level ref manual indices, and similarly for the html build. I may be able to work on this later, but please go ahead if you want to take a stab at it.


---

Comment by mkoeppe created at 2021-06-12 17:22:07

If it shows up again, perhaps #31005 (Add traceback information to exceptions during docbuild) can help to diagnose it


---

Comment by mkoeppe created at 2021-06-12 17:37:53

OK, I see `Handler <function on_build_finished at 0x3b9411310> for event 'build-finished' threw an exception` now too


---

Comment by git created at 2021-06-12 17:52:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-12 17:53:09

Here's an attempt to do the same for PDF.


---

Comment by jhpalmieri created at 2021-06-12 17:58:29

When I merged with #31005, I didn't see any extra information.


---

Comment by dimpase created at 2021-06-12 18:56:58

I tried the html build here, and the Japanese is gone. I see that `Handler <function on_build_finished...` messages too.
Something to configure for sphinx, I gather. The default `on_build_finished()` needs to be replaced by something we should do
(maybe just `pass`)


---

Comment by dimpase created at 2021-06-12 20:00:50


```
src/docs/conf.py:              'sphinx.ext.graphviz'
```

and in Sphinx in `sphinx/ext/graphviz.py` there is 

```
def on_build_finished(app: Sphinx, exc: Exception) -> None:
    if exc is None:
        src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')
        dst = path.join(app.outdir, '_static')
        copy_asset(src, dst)
```



---

Comment by jhpalmieri created at 2021-06-12 22:16:32

Okay, I'm annoyed. First, we've [had problems](https://trac.sagemath.org/ticket/26451#comment:26) with the Sphinx graphviz extension before. Why do we even need it? As far as I can tell, it only [provides](https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html) Sphinx directives `.. graphviz::`, `.. graph`, and `.. digraph::`, and I don't see any of those in our code. Second, it's labeled an optional Sage package, so why load the extension all of the time? Third, what sort of ridiculous package is it? Its `spkg-install.in` script just says
{{{#! /usr/bin/env bash
echo Error: graphviz is not installed as a system package.
echo Please install the system package recommended by ./configure
exit 1
```

Can we delete it?

The documentation builds without error if we remove `sphinx.ext.graphviz` and the related `sphinx.ext.inheritance_diagram` from the list of Sphinx extensions. Can we remove these extensions?


---

Comment by mkoeppe created at 2021-06-12 22:19:11

This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.


---

Comment by mkoeppe created at 2021-06-12 22:20:11

I'm pretty sure that this sphinx extension is not used anywhere in our documentation. It's probably a leftover from antiquity


---

Comment by jhpalmieri created at 2021-06-12 22:37:00

Replying to [comment:31 mkoeppe]:
> This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.

I think it would make more sense for `graphviz` to be part of `_recommended` rather than its own package.


---

Comment by mkoeppe created at 2021-06-12 22:46:20

No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all "_recommended" package can't do that. See #30930.

In any case, all of this is unrelated to the errors in the present ticket.


---

Comment by jhpalmieri created at 2021-06-12 22:49:01

Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?


---

Comment by dimpase created at 2021-06-12 22:50:06

graphviz sphinx extension came in #7549 (in 2009)


---

Comment by jhpalmieri created at 2021-06-12 22:50:54

Replying to [comment:34 mkoeppe]:
> No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all "_recommended" package can't do that. See #30930.
> 
> In any case, all of this is unrelated to the errors in the present ticket.

I agree with all of this, but I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.


---

Comment by mkoeppe created at 2021-06-12 22:51:10

Replying to [comment:35 jhpalmieri]:
> Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?
I think that's a good idea.


---

Comment by jhpalmieri created at 2021-06-12 22:53:21

Replying to [comment:36 dimpase]:
> graphviz sphinx extension came in #7549 (in 2009)

Thank you, Dima. Let's delete those extensions.


---

Comment by mkoeppe created at 2021-06-12 22:53:50

Replying to [comment:37 jhpalmieri]:
> I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.

`ffmpeg` should also be broken out of `_recommended` and transformed to its separate script package. 
When I created `_recommended`, I did not anticipate that users would be confused when the configure script recommends to install things that are already installed.


---

Comment by jhpalmieri created at 2021-06-12 22:58:15

I think that we could also delete the `cleanup` method in `src/sage_docbuild/ext/inventory_builder.py`: its docstring says

```
        Remove the '_static' directory.

        This directory is unnecessary for the inventory build, but it
        may be created by the graphviz extension. Its presence will
        break the docbuild later on, so remove it.
```

But let's keep it for now. It doesn't cause any harm.
----
New commits:


---

Comment by dimpase created at 2021-06-12 22:59:46

Replying to [comment:39 jhpalmieri]:
> Replying to [comment:36 dimpase]:
> > graphviz sphinx extension came in #7549 (in 2009)
> 
> Thank you, Dima. Let's delete those extensions.
Sure. Reading #7549 tells that it was meant for https://www.sphinx-doc.org/en/master/usage/extensions/inheritance.html


---

Comment by jhpalmieri created at 2021-06-12 23:07:46

Replying to [comment:38 mkoeppe]:
> Replying to [comment:35 jhpalmieri]:
> > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?
> I think that's a good idea.

Actually, can we do this? I don't know enough about distro use: can we really recommend "make doc" and "make doc-pdf" as replacements?


---

Comment by mkoeppe created at 2021-06-12 23:48:34

Replying to [comment:44 jhpalmieri]:
> Replying to [comment:38 mkoeppe]:
> > Replying to [comment:35 jhpalmieri]:
> > > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?
> > I think that's a good idea.
> 
> Actually, can we do this? I don't know enough about distro use: can we really recommend "make doc" and "make doc-pdf" as replacements?

I'd say just adding a deprecation warning won't break anything.

Having these make recipes in our main Makefile probably shouldn't be the final form of this. 
In #31356, I hope that we can restructure the docbuild as script packages (`sagemath_doc_html`, `sagemath_doc_pdf`), and in the next step as pip-installable packages (#29868).


---

Comment by git created at 2021-06-13 21:03:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-13 21:05:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2021-06-13 21:06:04

Okay, here is a deprecation warning, plus my attempt to add a builder for just the top-level reference manual document(s). It looks like it works, but it needs more testing.


---

Comment by jhpalmieri created at 2021-06-13 21:06:47

(In general I feel like the docbuilding code should be torn down and rebuilt from scratch; I find it very confusing and hard to work with.)


---

Comment by mkoeppe created at 2021-06-13 22:52:03

The HTML build seems to work well for me, even with high parallelization. PDF stops somewhere with LaTeX complaining about an undefined reference and some unicode characters, but that may be coming from some tickets that I have merged into my development branch.

I'd say let's get this in and see how this works for other people


---

Comment by mkoeppe created at 2021-06-13 22:53:19


```
[docpdf] Latexmk: Log file says output to 'combinat.pdf'
[docpdf] Latexmk: List of undefined refs and citations:
[docpdf]   Reference `index:module-sage.combinat' on page 3639 undefined on input line 348243
[docpdf] Latexmk: Summary of warnings from last run of *latex:
[docpdf]   Latex failed to resolve 1 reference(s)
[docpdf]   =====Latex reported missing or unavailable character(s).
[docpdf] =====See log file for details.
```



---

Comment by git created at 2021-06-13 22:57:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-14 00:58:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2021-06-14 01:01:01

I'm struggling to get this to work. The current branch works for me when building the html documentation with `make doc`, but `./sage --docbuild all html` fails with

```
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1811, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 345, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 589, in _wrapper
    self._build_top_level(format, *args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 571, in _build_top_level
    getattr(ReferenceTopBuilder(), format)(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 627, in __init__
    DocBuilder.__init__(self, *args, **kwds)
TypeError: __init__() missing 1 required positional argument: 'name'
```

If I add an argument, for example `"reference"`, to the call

```
        DocBuilder.__init__(self, *args, **kwds)
```

in `ReferenceTopBuilder.__init__`, then `make doc` fails.


---

Comment by git created at 2021-06-14 02:32:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-14 05:09:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-06-14 05:09:44

I think that fixes my problem. I've seen the combinat.pdf failure once, but I can't reproduce it. I'll keep trying.


---

Comment by dimpase created at 2021-06-14 09:26:19

on Lunix I am seeing

```
[dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed
[dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date
[dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed
[dochtml] Error, reached the pre-set memory limit
[dochtml] (change it with the -o command line option)
[dochtml] Error, was not in any namespace
```

not sure what limit is involved here and why.


---

Comment by dimpase created at 2021-06-14 12:15:01

otherwise, all works on Linux, both html and pdf builds.


---

Comment by jhpalmieri created at 2021-06-14 16:53:54

Replying to [comment:58 dimpase]:
> on Lunix I am seeing
> {{{
> [dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed
> [dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date
> [dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed
> [dochtml] Error, reached the pre-set memory limit
> [dochtml] (change it with the -o command line option)
> [dochtml] Error, was not in any namespace
> }}}
> not sure what limit is involved here and why.

Is that error new? Is it repeatable?


---

Comment by dimpase created at 2021-06-14 18:13:29

it might be due to the new GAP 4.11.1 I have in my branch (this message comes from GAP, that's certain).
Let's ignore it now. I'll try to reproduce it on another system.


---

Comment by jhpalmieri created at 2021-06-15 01:59:35

This also works for me with the Sphinx upgrade at #31696.


---

Comment by dimpase created at 2021-06-15 08:54:28

I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.


---

Comment by jhpalmieri created at 2021-06-15 16:40:10

Replying to [comment:63 dimpase]:
> I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.

Probably, but on another ticket. Should we start using `src/doc/Makefile` for more than just cleaning? As I said earlier, I am unclear on the distro situation: I don't know what packages are going to be available in general, and in particular in this case: if we have the documentation source files, can we be guaranteed to have `sage_docbuild`?

In any case, this may all fit somehow into #31356 and related tickets.


---

Comment by mkoeppe created at 2021-06-15 16:51:08

Replying to [comment:64 jhpalmieri]:
> Replying to [comment:63 dimpase]:
> > I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.
> 
> Probably, but on another ticket. 

I agree.

> Should we start using `src/doc/Makefile` for more than just cleaning? 

I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.


---

Comment by jhpalmieri created at 2021-06-15 18:14:39

Replying to [comment:65 mkoeppe]:
> Replying to [comment:64 jhpalmieri]:
> > Should we start using `src/doc/Makefile` for more than just cleaning? 
> 
> I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.

I'm experimenting with this and it seems to be working. A few questions about our Makefiles:

- Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.

- Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.

- Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?


---

Comment by mkoeppe created at 2021-06-15 19:08:07

Replying to [comment:66 jhpalmieri]:
> Replying to [comment:65 mkoeppe]:
> > Replying to [comment:64 jhpalmieri]:
> > > Should we start using `src/doc/Makefile` for more than just cleaning? 
> > 
> > I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.
> 
> I'm experimenting with this and it seems to be working. A few questions about our Makefiles:
> 
> - Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.

It comes from the environment and is set in `build/make/install`. 

> - Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.

`$(MAKE)` is fine here - https://www.gnu.org/software/make/manual/make.html#MAKE-Variable

> - Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?

You'd need to copy this definition from Makefile.in; it's not exported


---

Comment by git created at 2021-06-15 20:19:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-06-15 20:21:41

That's helpful, thank you. Here's an attempt. I'm not sure how to handle `SAGE_ROOT` in `src/doc/Makefile`: if it's not set, exit with an error? That's my current approach.

The new branch keeps the logging in `build/make/Makefile`: if someone wants to use `src/doc/Makefile` to build the documentation, maybe they don't want it logged. This seems consistent with how we do logging in general. It does mean that `make doc-pdf` logs all docbuilding, including inventory building, in `docpdf.log`, whereas it used to put the inventory logs into `dochtml.log`.


---

Comment by git created at 2021-06-15 20:49:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-16 02:04:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-16 02:04:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2021-06-16 04:01:14

Okay, I think I'm done tinkering now.


---

Comment by mkoeppe created at 2021-06-16 05:24:51

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-16 06:02:51

Looks good and seems to work well. Positive review from my side


---

Comment by jhpalmieri created at 2021-06-16 17:13:17

Dima, any comments? I'm happy with Matthias' contributions.


---

Comment by git created at 2021-06-16 23:33:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-17 10:22:54

looks good, thanks!


---

Comment by dimpase created at 2021-06-17 10:22:54

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-06-17 16:09:05

Great, thank you!


---

Comment by mkoeppe created at 2021-06-17 17:30:19

Changing priority from major to blocker.


---

Comment by vbraun created at 2021-06-20 08:14:49

Resolution: fixed


---

Comment by klee created at 2021-06-23 04:05:49

Previously `sage --docbuild all pdf` built a main website listing all documentations with icons linking to pdf files. Now it seems that `make doc-pdf` does not build such an website. Is there a way to build the website?


---

Comment by mkoeppe created at 2021-06-23 16:00:14

I've opened #32043 for this


---

Comment by dimpase created at 2021-07-21 16:54:24

I am seeing a race condition, sphinx may race `FileExistsError`, cf. e.g.

```
[dochtml] [reference] preparing documents... skipping loading of indexes... done
[dochtml] [reference] Merging js index files...
[dochtml] [reference]     algebras: 4424 js index entries
[dochtml] [reference]     arithgroup: 1204 js index entries
...

[dochtml] [reference]     topology: 1937 js index entries
[dochtml] [reference]     valuations: 973 js index entries
[dochtml] [reference] ... done (64387 js index entries)
[dochtml] [reference] copying static files... failed
[dochtml] [reference] WARNING: cannot copy static file
FileExistsError(17, 'File exists')
[dochtml] [reference] dumping search index in English (code: en)... done
[dochtml] [reference] The HTML pages are in
local/share/doc/sage/html/en/reference.
[dochtml] Error building the documentation.
```


`make -j1`
allows the docs to build. 

See e.g. https://github.com/sagemath/sagetrac-mirror/runs/3104375540

It's of course not totally surprising that several processes may try to, say, create the same directory. Perhaps the relevant part of the builder should be launched with this specific error being ignored?


---

Comment by jhpalmieri created at 2021-07-21 21:08:24

It's strange because that doesn't look like part of the docbuild process that's done in parallel with anything else: it looks like the main reference page, built after the other parts of the reference manual. How reliably can you reproduce this?

I think this part of the process (copying static files) is controlled by Sphinx, not by Sage or its modifications to Sphinx, for what that's worth.


---

Comment by mkoeppe created at 2021-07-21 23:46:19

Replying to [comment:85 dimpase]:
> I am seeing a race condition, sphinx may race `FileExistsError`

new ticket please?


---

Comment by klee created at 2021-07-22 02:03:30

Replying to [comment:87 mkoeppe]:
> Replying to [comment:85 dimpase]:
> > I am seeing a race condition, sphinx may race `FileExistsError`
> 
> new ticket please?

This is now #32262
