# Issue 31711: Reimplement parallel docbuild using make

archive/issues_031711.json:
```json
{
    "body": "CC:  @dimpase\n\nBased on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31948\n\n",
    "created_at": "2021-06-10T03:21:10Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Reimplement parallel docbuild using make",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31711",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase

Based on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.

Issue created by migration from https://trac.sagemath.org/ticket/31948





---

archive/issue_comments_452527.json:
```json
{
    "body": "I'm not quite sure how to go about this. I tried this:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex fb3a6ed5bc..4581dc3226 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -335,7 +335,12 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \\\n        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \\\n        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)\n \n-doc: doc-html\n+doc: doc-new\n+\n+doc-new: $(DOC_DEPENDENCIES)\n+       for doc in $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)\" logs/dochtml.log; \\\n+       done\n \n doc-html: $(DOC_DEPENDENCIES)\n        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log\n```\n\nand it seems to build the documentation, but it doesn't do it in parallel, I think because  we've turned off parallel processing for recursive calls to make earlier in the file.\n\nIf it did work, this approach would need a little tinkering: we should build the reference manual first, then everything else.\n\nA separate question: why do we use `cd ../..` in the recipe for `doc-html` (and other doc targets), rather than `cd $(SAGE_ROOT)`?",
    "created_at": "2021-06-10T20:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452527",
    "user": "https://github.com/jhpalmieri"
}
```

I'm not quite sure how to go about this. I tried this:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index fb3a6ed5bc..4581dc3226 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -335,7 +335,12 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
-doc: doc-html
+doc: doc-new
+
+doc-new: $(DOC_DEPENDENCIES)
+       for doc in $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/dochtml.log; \
+       done
 
 doc-html: $(DOC_DEPENDENCIES)
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```

and it seems to build the documentation, but it doesn't do it in parallel, I think because  we've turned off parallel processing for recursive calls to make earlier in the file.

If it did work, this approach would need a little tinkering: we should build the reference manual first, then everything else.

A separate question: why do we use `cd ../..` in the recipe for `doc-html` (and other doc targets), rather than `cd $(SAGE_ROOT)`?



---

archive/issue_comments_452528.json:
```json
{
    "body": "And if we really want to pull all of the parallel building out of the current system, then we should build the pieces of the reference manual separately in the `Makefile`. I think this is what you intended.",
    "created_at": "2021-06-10T20:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452528",
    "user": "https://github.com/jhpalmieri"
}
```

And if we really want to pull all of the parallel building out of the current system, then we should build the pieces of the reference manual separately in the `Makefile`. I think this is what you intended.



---

archive/issue_comments_452529.json:
```json
{
    "body": "Here is my current attempt, which doesn't quite work:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex fb3a6ed5bc..c199de440d 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -335,7 +335,27 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \\\n        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \\\n        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)\n \n-doc: doc-html\n+doc: doc-references doc-other\n+\n+doc-references: $(DOC_DEPENDENCIES)\n+       $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))\n+       $(eval biblio = $(firstword $(DOCS)))\n+       $(eval other_docs = $(wordlist 2, 100, $(DOCS)))\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $(biblio) inventory $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       for doc in $(other_docs); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc inventory $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       done\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links reference inventory $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $(biblio) html $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       for doc in $(other_docs); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links reference html $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       done\n+\n+doc-other: $(DOC_DEPENDENCIES) doc-references\n+       for doc in $(wordlist 2, 100, $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all)); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)\" logs/docs-other-html.log; \\\n+       done\n \n doc-html: $(DOC_DEPENDENCIES)\n        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log\ndiff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\nindex 79005b903a..a3caa8a92d 100644\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -116,7 +116,7 @@ def builder_helper(type):\n             # WEBSITESPHINXOPTS is either empty or \" -A hide_pdf_links=1 \"\n             options += WEBSITESPHINXOPTS\n \n-        if kwds.get('use_multidoc_inventory', True):\n+        if kwds.get('use_multidoc_inventory', True) and type != 'inventory':\n             options += ' -D multidoc_first_pass=0'\n         else:\n             options += ' -D multidoc_first_pass=1'\n```\n\nSeveral problems:\n\n- lack of parallel building\n- line 348 should be replaced by something that just builds the top-level reference manual stuff, assembling the parts into one set of indices, etc. Probably the same for line 352.\n- I'm getting some warning messages that I don't know what to make of: \"[schemes  ] Handler <function on_build_finished at 0x33872ef70> for event 'build-finished' threw an exception\", for example.",
    "created_at": "2021-06-11T01:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452529",
    "user": "https://github.com/jhpalmieri"
}
```

Here is my current attempt, which doesn't quite work:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index fb3a6ed5bc..c199de440d 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -335,7 +335,27 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
-doc: doc-html
+doc: doc-references doc-other
+
+doc-references: $(DOC_DEPENDENCIES)
+       $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))
+       $(eval biblio = $(firstword $(DOCS)))
+       $(eval other_docs = $(wordlist 2, 100, $(DOCS)))
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $(biblio) inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       for doc in $(other_docs); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       done
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links reference inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $(biblio) html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       for doc in $(other_docs); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links reference html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       done
+
+doc-other: $(DOC_DEPENDENCIES) doc-references
+       for doc in $(wordlist 2, 100, $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all)); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/docs-other-html.log; \
+       done
 
 doc-html: $(DOC_DEPENDENCIES)
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index 79005b903a..a3caa8a92d 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -116,7 +116,7 @@ def builder_helper(type):
             # WEBSITESPHINXOPTS is either empty or " -A hide_pdf_links=1 "
             options += WEBSITESPHINXOPTS
 
-        if kwds.get('use_multidoc_inventory', True):
+        if kwds.get('use_multidoc_inventory', True) and type != 'inventory':
             options += ' -D multidoc_first_pass=0'
         else:
             options += ' -D multidoc_first_pass=1'
```

Several problems:

- lack of parallel building
- line 348 should be replaced by something that just builds the top-level reference manual stuff, assembling the parts into one set of indices, etc. Probably the same for line 352.
- I'm getting some warning messages that I don't know what to make of: "[schemes  ] Handler <function on_build_finished at 0x33872ef70> for event 'build-finished' threw an exception", for example.



---

archive/issue_comments_452530.json:
```json
{
    "body": "To get `make` to parallelize it, the individual documents need to become `make` targets. A combination of `$(eval...)` and a macro call can do this -- similar to https://www.gnu.org/software/make/manual/html_node/Eval-Function.html",
    "created_at": "2021-06-11T03:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452530",
    "user": "https://github.com/mkoeppe"
}
```

To get `make` to parallelize it, the individual documents need to become `make` targets. A combination of `$(eval...)` and a macro call can do this -- similar to https://www.gnu.org/software/make/manual/html_node/Eval-Function.html



---

archive/issue_comments_452531.json:
```json
{
    "body": "I don't see how to do anything like that unless we hardcode the list of documents: we can't run `sage --docbuild ...` without building some other targets, so it seems to me that we have to construct the list of documents inside a recipe. But I'm very far from a `Makefile` expert, so I could be missing something.",
    "created_at": "2021-06-11T05:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452531",
    "user": "https://github.com/jhpalmieri"
}
```

I don't see how to do anything like that unless we hardcode the list of documents: we can't run `sage --docbuild ...` without building some other targets, so it seems to me that we have to construct the list of documents inside a recipe. But I'm very far from a `Makefile` expert, so I could be missing something.



---

archive/issue_comments_452532.json:
```json
{
    "body": "Or write a standalone script to construct the document list.",
    "created_at": "2021-06-11T05:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452532",
    "user": "https://github.com/jhpalmieri"
}
```

Or write a standalone script to construct the document list.



---

archive/issue_comments_452533.json:
```json
{
    "body": "Could you push your current version to the ticket please?",
    "created_at": "2021-06-11T16:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452533",
    "user": "https://github.com/mkoeppe"
}
```

Could you push your current version to the ticket please?



---

archive/issue_comments_452534.json:
```json
{
    "body": "Here it is.\n----\nNew commits:",
    "created_at": "2021-06-11T16:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452534",
    "user": "https://github.com/jhpalmieri"
}
```

Here it is.
----
New commits:



---

archive/issue_comments_452535.json:
```json
{
    "body": "Here's a solution using recursive make invocation\n----\nNew commits:",
    "created_at": "2021-06-11T17:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452535",
    "user": "https://github.com/mkoeppe"
}
```

Here's a solution using recursive make invocation
----
New commits:



---

archive/issue_comments_452536.json:
```json
{
    "body": "This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.\n\n```\n[reference] building [inventory]: targets for 1 source files that are out of date\n[reference] updating environment: [new config] 1 added, 0 changed, 0 removed\n[reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.\nBuild finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references\nDeleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds\nDeleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n    return _run_code(code, main_globals, None,\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n    exec(code, run_globals)\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1762, in main\n    builder()\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 769, in _wrapper\n    self.write_auto_rest_file(module_name)\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1070, in write_auto_rest_file\n    with open(filename, 'w') as outfile:\nFileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'\n```\n\nWith the following change, the documentation builds:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex 339497fd17..12b4e56b20 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -349,11 +349,7 @@ doc-references: $(DOC_DEPENDENCIES)\n        $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))\n        $(eval biblio = $(firstword $(DOCS)))\n        $(eval other_docs = $(wordlist 2, 100, $(DOCS)))\n-       +$(MAKE_REC) doc-inventory-$(subst /,-,$(biblio))\n-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-inventory-$(subst /,-,$(doc)))\n        +$(MAKE_REC) doc-inventory-reference\n-       +$(MAKE_REC) doc-html-$(subst /,-,$(biblio))\n-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-html-$(subst /,-,$(doc)))\n        +$(MAKE_REC) doc-html-reference\n \n doc-other: $(DOC_DEPENDENCIES) doc-references\n```\n\nThis is a hybrid model, using the old parallel building methods for the reference manual. The inventory build is fine, but I get some strange warnings during the html build:\n\n```\n[repl     ] building [html]: targets for 35 source files that are out of date\n[polynomia] building [html]: targets for 62 source files that are out of date\n[spkg     ] building [html]: targets for 316 source files that are out of date\n[tensor_fr] building [html]: targets for 19 source files that are out of date\n[algebras ] building [html]: targets for 97 source files that are out of date\n[manifolds] building [html]: targets for 81 source files that are out of date\n[repl     ] writing additional pages...  searchdone\n[repl     ] dumping search index in English (code: en)... done\n[repl     ] The HTML pages are in local/share/doc/sage/html/en/reference/repl.\n[repl     ] Extension error:\n[repl     ] Handler <function on_build_finished at 0x33c247af0> for event 'build-finished' threw an exception\nBuild finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/html/en/reference/repl\n[tensor_fr] writing additional pages...  searchdone\n[tensor_fr] dumping search index in English (code: en)... done\n[tensor_fr] The HTML pages are in local/share/doc/sage/html/en/reference/tensor_free_modules.\n[tensor_fr] Extension error:\n[tensor_fr] Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception\n```\n\nI don't know what `Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception` means or where it comes from.",
    "created_at": "2021-06-12T00:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452536",
    "user": "https://github.com/jhpalmieri"
}
```

This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.

```
[reference] building [inventory]: targets for 1 source files that are out of date
[reference] updating environment: [new config] 1 added, 0 changed, 0 removed
[reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references
Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds
Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1762, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 769, in _wrapper
    self.write_auto_rest_file(module_name)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1070, in write_auto_rest_file
    with open(filename, 'w') as outfile:
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'
```

With the following change, the documentation builds:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index 339497fd17..12b4e56b20 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -349,11 +349,7 @@ doc-references: $(DOC_DEPENDENCIES)
        $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))
        $(eval biblio = $(firstword $(DOCS)))
        $(eval other_docs = $(wordlist 2, 100, $(DOCS)))
-       +$(MAKE_REC) doc-inventory-$(subst /,-,$(biblio))
-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-inventory-$(subst /,-,$(doc)))
        +$(MAKE_REC) doc-inventory-reference
-       +$(MAKE_REC) doc-html-$(subst /,-,$(biblio))
-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-html-$(subst /,-,$(doc)))
        +$(MAKE_REC) doc-html-reference
 
 doc-other: $(DOC_DEPENDENCIES) doc-references
```

This is a hybrid model, using the old parallel building methods for the reference manual. The inventory build is fine, but I get some strange warnings during the html build:

```
[repl     ] building [html]: targets for 35 source files that are out of date
[polynomia] building [html]: targets for 62 source files that are out of date
[spkg     ] building [html]: targets for 316 source files that are out of date
[tensor_fr] building [html]: targets for 19 source files that are out of date
[algebras ] building [html]: targets for 97 source files that are out of date
[manifolds] building [html]: targets for 81 source files that are out of date
[repl     ] writing additional pages...  searchdone
[repl     ] dumping search index in English (code: en)... done
[repl     ] The HTML pages are in local/share/doc/sage/html/en/reference/repl.
[repl     ] Extension error:
[repl     ] Handler <function on_build_finished at 0x33c247af0> for event 'build-finished' threw an exception
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/html/en/reference/repl
[tensor_fr] writing additional pages...  searchdone
[tensor_fr] dumping search index in English (code: en)... done
[tensor_fr] The HTML pages are in local/share/doc/sage/html/en/reference/tensor_free_modules.
[tensor_fr] Extension error:
[tensor_fr] Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception
```

I don't know what `Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception` means or where it comes from.



---

archive/issue_comments_452537.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.\n> {{{\n> [reference] building [inventory]: targets for 1 source files that are out of date\n> [reference] updating environment: [new config] 1 added, 0 changed, 0 removed\n> [reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.\n> Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references\n> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds\n> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage\n> Error building the documentation.\n> Traceback (most recent call last):\n>   File \"/usr/local/Cellar/python`@`3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n>     return _run_code(code, main_globals, None,\n>   File \"/usr/local/Cellar/python`@`3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n>     exec(code, run_globals)\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n>     main()\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1762, in main\n>     builder()\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 769, in _wrapper\n>     self.write_auto_rest_file(module_name)\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1070, in write_auto_rest_file\n>     with open(filename, 'w') as outfile:\n> FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'\n> }}}\n\nLooks like something forgot to create the directory in which this .rst file is to be created",
    "created_at": "2021-06-12T01:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452537",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 jhpalmieri]:
> This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.
> {{{
> [reference] building [inventory]: targets for 1 source files that are out of date
> [reference] updating environment: [new config] 1 added, 0 changed, 0 removed
> [reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.
> Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references
> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds
> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage
> Error building the documentation.
> Traceback (most recent call last):
>   File "/usr/local/Cellar/python`@`3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
>     return _run_code(code, main_globals, None,
>   File "/usr/local/Cellar/python`@`3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
>     exec(code, run_globals)
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
>     main()
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1762, in main
>     builder()
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 769, in _wrapper
>     self.write_auto_rest_file(module_name)
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1070, in write_auto_rest_file
>     with open(filename, 'w') as outfile:
> FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'
> }}}

Looks like something forgot to create the directory in which this .rst file is to be created



---

archive/issue_comments_452538.json:
```json
{
    "body": "I was able to reproduce an error of this form as well.",
    "created_at": "2021-06-12T01:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452538",
    "user": "https://github.com/mkoeppe"
}
```

I was able to reproduce an error of this form as well.



---

archive/issue_comments_452539.json:
```json
{
    "body": "If you do `make doc-clean && make SAGE_DOCBUILD_OPTS=\"--verbose=3\" doc`, you can see that this is a race between creating directories and \"deleting empty directories\"",
    "created_at": "2021-06-12T01:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452539",
    "user": "https://github.com/mkoeppe"
}
```

If you do `make doc-clean && make SAGE_DOCBUILD_OPTS="--verbose=3" doc`, you can see that this is a race between creating directories and "deleting empty directories"



---

archive/issue_comments_452540.json:
```json
{
    "body": "I'll add an option to turn it off",
    "created_at": "2021-06-12T01:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452540",
    "user": "https://github.com/mkoeppe"
}
```

I'll add an option to turn it off



---

archive/issue_comments_452541.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-12T02:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452541",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452542.json:
```json
{
    "body": "I still see\n\n```\n[valuation] Extension error:\n[valuation] Handler <function on_build_finished at 0x3375808b0> for event 'build-finished' threw an exception\n```\n\nfor (I think) every piece of the reference manual. Any ideas about this?\n\nEdit: the manual seems to build correctly, regardless.",
    "created_at": "2021-06-12T04:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452542",
    "user": "https://github.com/jhpalmieri"
}
```

I still see

```
[valuation] Extension error:
[valuation] Handler <function on_build_finished at 0x3375808b0> for event 'build-finished' threw an exception
```

for (I think) every piece of the reference manual. Any ideas about this?

Edit: the manual seems to build correctly, regardless.



---

archive/issue_comments_452543.json:
```json
{
    "body": "No idea about this error. I don't see it here. I suppose you could try to run the docbuild for a document in `pdb` to debug this.",
    "created_at": "2021-06-12T05:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452543",
    "user": "https://github.com/mkoeppe"
}
```

No idea about this error. I don't see it here. I suppose you could try to run the docbuild for a document in `pdb` to debug this.



---

archive/issue_comments_452544.json:
```json
{
    "body": "I haven't tried `pdb`, but I get it when doing `make doc-clean && make` \u2014\u00a0running `make` again at that point doesn't produce the error. I also get it on two different machines, one Big Sur, one Catalina.\n\nOne more task: the reference manual is built twice: the line\n\n```\n+$(MAKE_REC) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" doc-inventory--reference\n```\n\nneeds to be replaced with something that just builds the top-level ref manual indices, and similarly for the html build. I may be able to work on this later, but please go ahead if you want to take a stab at it.",
    "created_at": "2021-06-12T17:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452544",
    "user": "https://github.com/jhpalmieri"
}
```

I haven't tried `pdb`, but I get it when doing `make doc-clean && make` — running `make` again at that point doesn't produce the error. I also get it on two different machines, one Big Sur, one Catalina.

One more task: the reference manual is built twice: the line

```
+$(MAKE_REC) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference
```

needs to be replaced with something that just builds the top-level ref manual indices, and similarly for the html build. I may be able to work on this later, but please go ahead if you want to take a stab at it.



---

archive/issue_comments_452545.json:
```json
{
    "body": "If it shows up again, perhaps #31005 (Add traceback information to exceptions during docbuild) can help to diagnose it",
    "created_at": "2021-06-12T17:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452545",
    "user": "https://github.com/mkoeppe"
}
```

If it shows up again, perhaps #31005 (Add traceback information to exceptions during docbuild) can help to diagnose it



---

archive/issue_comments_452546.json:
```json
{
    "body": "OK, I see `Handler <function on_build_finished at 0x3b9411310> for event 'build-finished' threw an exception` now too",
    "created_at": "2021-06-12T17:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452546",
    "user": "https://github.com/mkoeppe"
}
```

OK, I see `Handler <function on_build_finished at 0x3b9411310> for event 'build-finished' threw an exception` now too



---

archive/issue_comments_452547.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-12T17:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452547",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452548.json:
```json
{
    "body": "Here's an attempt to do the same for PDF.",
    "created_at": "2021-06-12T17:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452548",
    "user": "https://github.com/mkoeppe"
}
```

Here's an attempt to do the same for PDF.



---

archive/issue_comments_452549.json:
```json
{
    "body": "When I merged with #31005, I didn't see any extra information.",
    "created_at": "2021-06-12T17:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452549",
    "user": "https://github.com/jhpalmieri"
}
```

When I merged with #31005, I didn't see any extra information.



---

archive/issue_comments_452550.json:
```json
{
    "body": "I tried the html build here, and the Japanese is gone. I see that `Handler <function on_build_finished...` messages too.\nSomething to configure for sphinx, I gather. The default `on_build_finished()` needs to be replaced by something we should do\n(maybe just `pass`)",
    "created_at": "2021-06-12T18:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452550",
    "user": "https://github.com/dimpase"
}
```

I tried the html build here, and the Japanese is gone. I see that `Handler <function on_build_finished...` messages too.
Something to configure for sphinx, I gather. The default `on_build_finished()` needs to be replaced by something we should do
(maybe just `pass`)



---

archive/issue_comments_452551.json:
```json
{
    "body": "\n```\nsrc/docs/conf.py:              'sphinx.ext.graphviz'\n```\n\nand in Sphinx in `sphinx/ext/graphviz.py` there is \n\n```\ndef on_build_finished(app: Sphinx, exc: Exception) -> None:\n    if exc is None:\n        src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')\n        dst = path.join(app.outdir, '_static')\n        copy_asset(src, dst)\n```\n",
    "created_at": "2021-06-12T20:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452551",
    "user": "https://github.com/dimpase"
}
```


```
src/docs/conf.py:              'sphinx.ext.graphviz'
```

and in Sphinx in `sphinx/ext/graphviz.py` there is 

```
def on_build_finished(app: Sphinx, exc: Exception) -> None:
    if exc is None:
        src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')
        dst = path.join(app.outdir, '_static')
        copy_asset(src, dst)
```




---

archive/issue_comments_452552.json:
```json
{
    "body": "Okay, I'm annoyed. First, we've [had problems](https://trac.sagemath.org/ticket/26451#comment:26) with the Sphinx graphviz extension before. Why do we even need it? As far as I can tell, it only [provides](https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html) Sphinx directives `.. graphviz::`, `.. graph`, and `.. digraph::`, and I don't see any of those in our code. Second, it's labeled an optional Sage package, so why load the extension all of the time? Third, what sort of ridiculous package is it? Its `spkg-install.in` script just says\n{{{#! /usr/bin/env bash\necho Error: graphviz is not installed as a system package.\necho Please install the system package recommended by ./configure\nexit 1\n```\n\nCan we delete it?\n\nThe documentation builds without error if we remove `sphinx.ext.graphviz` and the related `sphinx.ext.inheritance_diagram` from the list of Sphinx extensions. Can we remove these extensions?",
    "created_at": "2021-06-12T22:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452552",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, I'm annoyed. First, we've [had problems](https://trac.sagemath.org/ticket/26451#comment:26) with the Sphinx graphviz extension before. Why do we even need it? As far as I can tell, it only [provides](https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html) Sphinx directives `.. graphviz::`, `.. graph`, and `.. digraph::`, and I don't see any of those in our code. Second, it's labeled an optional Sage package, so why load the extension all of the time? Third, what sort of ridiculous package is it? Its `spkg-install.in` script just says
{{{#! /usr/bin/env bash
echo Error: graphviz is not installed as a system package.
echo Please install the system package recommended by ./configure
exit 1
```

Can we delete it?

The documentation builds without error if we remove `sphinx.ext.graphviz` and the related `sphinx.ext.inheritance_diagram` from the list of Sphinx extensions. Can we remove these extensions?



---

archive/issue_comments_452553.json:
```json
{
    "body": "This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.",
    "created_at": "2021-06-12T22:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452553",
    "user": "https://github.com/mkoeppe"
}
```

This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.



---

archive/issue_comments_452554.json:
```json
{
    "body": "I'm pretty sure that this sphinx extension is not used anywhere in our documentation. It's probably a leftover from antiquity",
    "created_at": "2021-06-12T22:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452554",
    "user": "https://github.com/mkoeppe"
}
```

I'm pretty sure that this sphinx extension is not used anywhere in our documentation. It's probably a leftover from antiquity



---

archive/issue_comments_452555.json:
```json
{
    "body": "Replying to [comment:31 mkoeppe]:\n> This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.\n\nI think it would make more sense for `graphviz` to be part of `_recommended` rather than its own package.",
    "created_at": "2021-06-12T22:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452555",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:31 mkoeppe]:
> This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.

I think it would make more sense for `graphviz` to be part of `_recommended` rather than its own package.



---

archive/issue_comments_452556.json:
```json
{
    "body": "No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all \"_recommended\" package can't do that. See #30930.\n\nIn any case, all of this is unrelated to the errors in the present ticket.",
    "created_at": "2021-06-12T22:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452556",
    "user": "https://github.com/mkoeppe"
}
```

No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all "_recommended" package can't do that. See #30930.

In any case, all of this is unrelated to the errors in the present ticket.



---

archive/issue_comments_452557.json:
```json
{
    "body": "Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?",
    "created_at": "2021-06-12T22:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452557",
    "user": "https://github.com/jhpalmieri"
}
```

Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?



---

archive/issue_comments_452558.json:
```json
{
    "body": "graphviz sphinx extension came in #7549 (in 2009)",
    "created_at": "2021-06-12T22:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452558",
    "user": "https://github.com/dimpase"
}
```

graphviz sphinx extension came in #7549 (in 2009)



---

archive/issue_comments_452559.json:
```json
{
    "body": "Replying to [comment:34 mkoeppe]:\n> No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all \"_recommended\" package can't do that. See #30930.\n> \n> In any case, all of this is unrelated to the errors in the present ticket.\n\nI agree with all of this, but I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.",
    "created_at": "2021-06-12T22:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452559",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:34 mkoeppe]:
> No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all "_recommended" package can't do that. See #30930.
> 
> In any case, all of this is unrelated to the errors in the present ticket.

I agree with all of this, but I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.



---

archive/issue_comments_452560.json:
```json
{
    "body": "Replying to [comment:35 jhpalmieri]:\n> Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?\nI think that's a good idea.",
    "created_at": "2021-06-12T22:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452560",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:35 jhpalmieri]:
> Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?
I think that's a good idea.



---

archive/issue_comments_452561.json:
```json
{
    "body": "Replying to [comment:36 dimpase]:\n> graphviz sphinx extension came in #7549 (in 2009)\n\nThank you, Dima. Let's delete those extensions.",
    "created_at": "2021-06-12T22:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452561",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:36 dimpase]:
> graphviz sphinx extension came in #7549 (in 2009)

Thank you, Dima. Let's delete those extensions.



---

archive/issue_comments_452562.json:
```json
{
    "body": "Replying to [comment:37 jhpalmieri]:\n> I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.\n\n`ffmpeg` should also be broken out of `_recommended` and transformed to its separate script package. \nWhen I created `_recommended`, I did not anticipate that users would be confused when the configure script recommends to install things that are already installed.",
    "created_at": "2021-06-12T22:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452562",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:37 jhpalmieri]:
> I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.

`ffmpeg` should also be broken out of `_recommended` and transformed to its separate script package. 
When I created `_recommended`, I did not anticipate that users would be confused when the configure script recommends to install things that are already installed.



---

archive/issue_comments_452563.json:
```json
{
    "body": "I think that we could also delete the `cleanup` method in `src/sage_docbuild/ext/inventory_builder.py`: its docstring says\n\n```\n        Remove the '_static' directory.\n\n        This directory is unnecessary for the inventory build, but it\n        may be created by the graphviz extension. Its presence will\n        break the docbuild later on, so remove it.\n```\n\nBut let's keep it for now. It doesn't cause any harm.\n----\nNew commits:",
    "created_at": "2021-06-12T22:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452563",
    "user": "https://github.com/jhpalmieri"
}
```

I think that we could also delete the `cleanup` method in `src/sage_docbuild/ext/inventory_builder.py`: its docstring says

```
        Remove the '_static' directory.

        This directory is unnecessary for the inventory build, but it
        may be created by the graphviz extension. Its presence will
        break the docbuild later on, so remove it.
```

But let's keep it for now. It doesn't cause any harm.
----
New commits:



---

archive/issue_comments_452564.json:
```json
{
    "body": "Replying to [comment:39 jhpalmieri]:\n> Replying to [comment:36 dimpase]:\n> > graphviz sphinx extension came in #7549 (in 2009)\n> \n> Thank you, Dima. Let's delete those extensions.\nSure. Reading #7549 tells that it was meant for https://www.sphinx-doc.org/en/master/usage/extensions/inheritance.html",
    "created_at": "2021-06-12T22:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452564",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:39 jhpalmieri]:
> Replying to [comment:36 dimpase]:
> > graphviz sphinx extension came in #7549 (in 2009)
> 
> Thank you, Dima. Let's delete those extensions.
Sure. Reading #7549 tells that it was meant for https://www.sphinx-doc.org/en/master/usage/extensions/inheritance.html



---

archive/issue_comments_452565.json:
```json
{
    "body": "Replying to [comment:38 mkoeppe]:\n> Replying to [comment:35 jhpalmieri]:\n> > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?\n> I think that's a good idea.\n\nActually, can we do this? I don't know enough about distro use: can we really recommend \"make doc\" and \"make doc-pdf\" as replacements?",
    "created_at": "2021-06-12T23:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452565",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:38 mkoeppe]:
> Replying to [comment:35 jhpalmieri]:
> > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?
> I think that's a good idea.

Actually, can we do this? I don't know enough about distro use: can we really recommend "make doc" and "make doc-pdf" as replacements?



---

archive/issue_comments_452566.json:
```json
{
    "body": "Replying to [comment:44 jhpalmieri]:\n> Replying to [comment:38 mkoeppe]:\n> > Replying to [comment:35 jhpalmieri]:\n> > > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?\n> > I think that's a good idea.\n> \n> Actually, can we do this? I don't know enough about distro use: can we really recommend \"make doc\" and \"make doc-pdf\" as replacements?\n\nI'd say just adding a deprecation warning won't break anything.\n\nHaving these make recipes in our main Makefile probably shouldn't be the final form of this. \nIn #31356, I hope that we can restructure the docbuild as script packages (`sagemath_doc_html`, `sagemath_doc_pdf`), and in the next step as pip-installable packages (#29868).",
    "created_at": "2021-06-12T23:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452566",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:44 jhpalmieri]:
> Replying to [comment:38 mkoeppe]:
> > Replying to [comment:35 jhpalmieri]:
> > > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?
> > I think that's a good idea.
> 
> Actually, can we do this? I don't know enough about distro use: can we really recommend "make doc" and "make doc-pdf" as replacements?

I'd say just adding a deprecation warning won't break anything.

Having these make recipes in our main Makefile probably shouldn't be the final form of this. 
In #31356, I hope that we can restructure the docbuild as script packages (`sagemath_doc_html`, `sagemath_doc_pdf`), and in the next step as pip-installable packages (#29868).



---

archive/issue_comments_452567.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-13T21:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452567",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452568.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-13T21:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_452569.json:
```json
{
    "body": "Okay, here is a deprecation warning, plus my attempt to add a builder for just the top-level reference manual document(s). It looks like it works, but it needs more testing.",
    "created_at": "2021-06-13T21:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452569",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, here is a deprecation warning, plus my attempt to add a builder for just the top-level reference manual document(s). It looks like it works, but it needs more testing.



---

archive/issue_comments_452570.json:
```json
{
    "body": "(In general I feel like the docbuilding code should be torn down and rebuilt from scratch; I find it very confusing and hard to work with.)",
    "created_at": "2021-06-13T21:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452570",
    "user": "https://github.com/jhpalmieri"
}
```

(In general I feel like the docbuilding code should be torn down and rebuilt from scratch; I find it very confusing and hard to work with.)



---

archive/issue_comments_452571.json:
```json
{
    "body": "The HTML build seems to work well for me, even with high parallelization. PDF stops somewhere with LaTeX complaining about an undefined reference and some unicode characters, but that may be coming from some tickets that I have merged into my development branch.\n\nI'd say let's get this in and see how this works for other people",
    "created_at": "2021-06-13T22:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452571",
    "user": "https://github.com/mkoeppe"
}
```

The HTML build seems to work well for me, even with high parallelization. PDF stops somewhere with LaTeX complaining about an undefined reference and some unicode characters, but that may be coming from some tickets that I have merged into my development branch.

I'd say let's get this in and see how this works for other people



---

archive/issue_comments_452572.json:
```json
{
    "body": "\n```\n[docpdf] Latexmk: Log file says output to 'combinat.pdf'\n[docpdf] Latexmk: List of undefined refs and citations:\n[docpdf]   Reference `index:module-sage.combinat' on page 3639 undefined on input line 348243\n[docpdf] Latexmk: Summary of warnings from last run of *latex:\n[docpdf]   Latex failed to resolve 1 reference(s)\n[docpdf]   =====Latex reported missing or unavailable character(s).\n[docpdf] =====See log file for details.\n```\n",
    "created_at": "2021-06-13T22:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452572",
    "user": "https://github.com/mkoeppe"
}
```


```
[docpdf] Latexmk: Log file says output to 'combinat.pdf'
[docpdf] Latexmk: List of undefined refs and citations:
[docpdf]   Reference `index:module-sage.combinat' on page 3639 undefined on input line 348243
[docpdf] Latexmk: Summary of warnings from last run of *latex:
[docpdf]   Latex failed to resolve 1 reference(s)
[docpdf]   =====Latex reported missing or unavailable character(s).
[docpdf] =====See log file for details.
```




---

archive/issue_comments_452573.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-13T22:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452573",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_452574.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-14T00:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_452575.json:
```json
{
    "body": "I'm struggling to get this to work. The current branch works for me when building the html documentation with `make doc`, but `./sage --docbuild all html` fails with\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n    return _run_code(code, main_globals, None,\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n    exec(code, run_globals)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1811, in main\n    builder()\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 345, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 589, in _wrapper\n    self._build_top_level(format, *args, **kwds)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 571, in _build_top_level\n    getattr(ReferenceTopBuilder(), format)(*args, **kwds)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 627, in __init__\n    DocBuilder.__init__(self, *args, **kwds)\nTypeError: __init__() missing 1 required positional argument: 'name'\n```\n\nIf I add an argument, for example `\"reference\"`, to the call\n\n```\n        DocBuilder.__init__(self, *args, **kwds)\n```\n\nin `ReferenceTopBuilder.__init__`, then `make doc` fails.",
    "created_at": "2021-06-14T01:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452575",
    "user": "https://github.com/jhpalmieri"
}
```

I'm struggling to get this to work. The current branch works for me when building the html documentation with `make doc`, but `./sage --docbuild all html` fails with

```
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1811, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 345, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 589, in _wrapper
    self._build_top_level(format, *args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 571, in _build_top_level
    getattr(ReferenceTopBuilder(), format)(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 627, in __init__
    DocBuilder.__init__(self, *args, **kwds)
TypeError: __init__() missing 1 required positional argument: 'name'
```

If I add an argument, for example `"reference"`, to the call

```
        DocBuilder.__init__(self, *args, **kwds)
```

in `ReferenceTopBuilder.__init__`, then `make doc` fails.



---

archive/issue_comments_452576.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T02:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452576",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452577.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T05:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452577",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452578.json:
```json
{
    "body": "I think that fixes my problem. I've seen the combinat.pdf failure once, but I can't reproduce it. I'll keep trying.",
    "created_at": "2021-06-14T05:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452578",
    "user": "https://github.com/jhpalmieri"
}
```

I think that fixes my problem. I've seen the combinat.pdf failure once, but I can't reproduce it. I'll keep trying.



---

archive/issue_comments_452579.json:
```json
{
    "body": "on Lunix I am seeing\n\n```\n[dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed\n[dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date\n[dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed\n[dochtml] Error, reached the pre-set memory limit\n[dochtml] (change it with the -o command line option)\n[dochtml] Error, was not in any namespace\n```\n\nnot sure what limit is involved here and why.",
    "created_at": "2021-06-14T09:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452579",
    "user": "https://github.com/dimpase"
}
```

on Lunix I am seeing

```
[dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed
[dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date
[dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed
[dochtml] Error, reached the pre-set memory limit
[dochtml] (change it with the -o command line option)
[dochtml] Error, was not in any namespace
```

not sure what limit is involved here and why.



---

archive/issue_comments_452580.json:
```json
{
    "body": "otherwise, all works on Linux, both html and pdf builds.",
    "created_at": "2021-06-14T12:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452580",
    "user": "https://github.com/dimpase"
}
```

otherwise, all works on Linux, both html and pdf builds.



---

archive/issue_comments_452581.json:
```json
{
    "body": "Replying to [comment:58 dimpase]:\n> on Lunix I am seeing\n> {{{\n> [dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed\n> [dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date\n> [dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed\n> [dochtml] Error, reached the pre-set memory limit\n> [dochtml] (change it with the -o command line option)\n> [dochtml] Error, was not in any namespace\n> }}}\n> not sure what limit is involved here and why.\n\nIs that error new? Is it repeatable?",
    "created_at": "2021-06-14T16:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452581",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:58 dimpase]:
> on Lunix I am seeing
> {{{
> [dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed
> [dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date
> [dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed
> [dochtml] Error, reached the pre-set memory limit
> [dochtml] (change it with the -o command line option)
> [dochtml] Error, was not in any namespace
> }}}
> not sure what limit is involved here and why.

Is that error new? Is it repeatable?



---

archive/issue_comments_452582.json:
```json
{
    "body": "it might be due to the new GAP 4.11.1 I have in my branch (this message comes from GAP, that's certain).\nLet's ignore it now. I'll try to reproduce it on another system.",
    "created_at": "2021-06-14T18:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452582",
    "user": "https://github.com/dimpase"
}
```

it might be due to the new GAP 4.11.1 I have in my branch (this message comes from GAP, that's certain).
Let's ignore it now. I'll try to reproduce it on another system.



---

archive/issue_comments_452583.json:
```json
{
    "body": "This also works for me with the Sphinx upgrade at #31696.",
    "created_at": "2021-06-15T01:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452583",
    "user": "https://github.com/jhpalmieri"
}
```

This also works for me with the Sphinx upgrade at #31696.



---

archive/issue_comments_452584.json:
```json
{
    "body": "I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.",
    "created_at": "2021-06-15T08:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452584",
    "user": "https://github.com/dimpase"
}
```

I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.



---

archive/issue_comments_452585.json:
```json
{
    "body": "Replying to [comment:63 dimpase]:\n> I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.\n\nProbably, but on another ticket. Should we start using `src/doc/Makefile` for more than just cleaning? As I said earlier, I am unclear on the distro situation: I don't know what packages are going to be available in general, and in particular in this case: if we have the documentation source files, can we be guaranteed to have `sage_docbuild`?\n\nIn any case, this may all fit somehow into #31356 and related tickets.",
    "created_at": "2021-06-15T16:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452585",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:63 dimpase]:
> I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.

Probably, but on another ticket. Should we start using `src/doc/Makefile` for more than just cleaning? As I said earlier, I am unclear on the distro situation: I don't know what packages are going to be available in general, and in particular in this case: if we have the documentation source files, can we be guaranteed to have `sage_docbuild`?

In any case, this may all fit somehow into #31356 and related tickets.



---

archive/issue_comments_452586.json:
```json
{
    "body": "Replying to [comment:64 jhpalmieri]:\n> Replying to [comment:63 dimpase]:\n> > I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.\n> \n> Probably, but on another ticket. \n\nI agree.\n\n> Should we start using `src/doc/Makefile` for more than just cleaning? \n\nI think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.",
    "created_at": "2021-06-15T16:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452586",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:64 jhpalmieri]:
> Replying to [comment:63 dimpase]:
> > I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.
> 
> Probably, but on another ticket. 

I agree.

> Should we start using `src/doc/Makefile` for more than just cleaning? 

I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.



---

archive/issue_comments_452587.json:
```json
{
    "body": "Replying to [comment:65 mkoeppe]:\n> Replying to [comment:64 jhpalmieri]:\n> > Should we start using `src/doc/Makefile` for more than just cleaning? \n> \n> I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.\n\nI'm experimenting with this and it seems to be working. A few questions about our Makefiles:\n\n- Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.\n\n- Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.\n\n- Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?",
    "created_at": "2021-06-15T18:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452587",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:65 mkoeppe]:
> Replying to [comment:64 jhpalmieri]:
> > Should we start using `src/doc/Makefile` for more than just cleaning? 
> 
> I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.

I'm experimenting with this and it seems to be working. A few questions about our Makefiles:

- Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.

- Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.

- Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?



---

archive/issue_comments_452588.json:
```json
{
    "body": "Replying to [comment:66 jhpalmieri]:\n> Replying to [comment:65 mkoeppe]:\n> > Replying to [comment:64 jhpalmieri]:\n> > > Should we start using `src/doc/Makefile` for more than just cleaning? \n> > \n> > I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.\n> \n> I'm experimenting with this and it seems to be working. A few questions about our Makefiles:\n> \n> - Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.\n\nIt comes from the environment and is set in `build/make/install`. \n\n> - Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.\n\n`$(MAKE)` is fine here - https://www.gnu.org/software/make/manual/make.html#MAKE-Variable\n\n> - Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?\n\nYou'd need to copy this definition from Makefile.in; it's not exported",
    "created_at": "2021-06-15T19:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452588",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:66 jhpalmieri]:
> Replying to [comment:65 mkoeppe]:
> > Replying to [comment:64 jhpalmieri]:
> > > Should we start using `src/doc/Makefile` for more than just cleaning? 
> > 
> > I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.
> 
> I'm experimenting with this and it seems to be working. A few questions about our Makefiles:
> 
> - Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.

It comes from the environment and is set in `build/make/install`. 

> - Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.

`$(MAKE)` is fine here - https://www.gnu.org/software/make/manual/make.html#MAKE-Variable

> - Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?

You'd need to copy this definition from Makefile.in; it's not exported



---

archive/issue_comments_452589.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-15T20:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452589",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452590.json:
```json
{
    "body": "That's helpful, thank you. Here's an attempt. I'm not sure how to handle `SAGE_ROOT` in `src/doc/Makefile`: if it's not set, exit with an error? That's my current approach.\n\nThe new branch keeps the logging in `build/make/Makefile`: if someone wants to use `src/doc/Makefile` to build the documentation, maybe they don't want it logged. This seems consistent with how we do logging in general. It does mean that `make doc-pdf` logs all docbuilding, including inventory building, in `docpdf.log`, whereas it used to put the inventory logs into `dochtml.log`.",
    "created_at": "2021-06-15T20:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452590",
    "user": "https://github.com/jhpalmieri"
}
```

That's helpful, thank you. Here's an attempt. I'm not sure how to handle `SAGE_ROOT` in `src/doc/Makefile`: if it's not set, exit with an error? That's my current approach.

The new branch keeps the logging in `build/make/Makefile`: if someone wants to use `src/doc/Makefile` to build the documentation, maybe they don't want it logged. This seems consistent with how we do logging in general. It does mean that `make doc-pdf` logs all docbuilding, including inventory building, in `docpdf.log`, whereas it used to put the inventory logs into `dochtml.log`.



---

archive/issue_comments_452591.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-15T20:49:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452591",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_452592.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-16T02:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452592",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452593.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-16T02:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452593",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_452594.json:
```json
{
    "body": "Okay, I think I'm done tinkering now.",
    "created_at": "2021-06-16T04:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452594",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, I think I'm done tinkering now.



---

archive/issue_comments_452595.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-16T05:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452595",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452596.json:
```json
{
    "body": "Looks good and seems to work well. Positive review from my side",
    "created_at": "2021-06-16T06:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452596",
    "user": "https://github.com/mkoeppe"
}
```

Looks good and seems to work well. Positive review from my side



---

archive/issue_comments_452597.json:
```json
{
    "body": "Dima, any comments? I'm happy with Matthias' contributions.",
    "created_at": "2021-06-16T17:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452597",
    "user": "https://github.com/jhpalmieri"
}
```

Dima, any comments? I'm happy with Matthias' contributions.



---

archive/issue_comments_452598.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-16T23:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452598",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452599.json:
```json
{
    "body": "looks good, thanks!",
    "created_at": "2021-06-17T10:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452599",
    "user": "https://github.com/dimpase"
}
```

looks good, thanks!



---

archive/issue_comments_452600.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-17T10:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452600",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452601.json:
```json
{
    "body": "Great, thank you!",
    "created_at": "2021-06-17T16:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452601",
    "user": "https://github.com/jhpalmieri"
}
```

Great, thank you!



---

archive/issue_comments_452602.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2021-06-17T17:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452602",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_452603.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-20T08:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452603",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_452604.json:
```json
{
    "body": "Previously `sage --docbuild all pdf` built a main website listing all documentations with icons linking to pdf files. Now it seems that `make doc-pdf` does not build such an website. Is there a way to build the website?",
    "created_at": "2021-06-23T04:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452604",
    "user": "https://github.com/kwankyu"
}
```

Previously `sage --docbuild all pdf` built a main website listing all documentations with icons linking to pdf files. Now it seems that `make doc-pdf` does not build such an website. Is there a way to build the website?



---

archive/issue_comments_452605.json:
```json
{
    "body": "I've opened #32043 for this",
    "created_at": "2021-06-23T16:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452605",
    "user": "https://github.com/mkoeppe"
}
```

I've opened #32043 for this



---

archive/issue_comments_452606.json:
```json
{
    "body": "I am seeing a race condition, sphinx may race `FileExistsError`, cf. e.g.\n\n```\n[dochtml] [reference] preparing documents... skipping loading of indexes... done\n[dochtml] [reference] Merging js index files...\n[dochtml] [reference]     algebras: 4424 js index entries\n[dochtml] [reference]     arithgroup: 1204 js index entries\n...\n\n[dochtml] [reference]     topology: 1937 js index entries\n[dochtml] [reference]     valuations: 973 js index entries\n[dochtml] [reference] ... done (64387 js index entries)\n[dochtml] [reference] copying static files... failed\n[dochtml] [reference] WARNING: cannot copy static file\nFileExistsError(17, 'File exists')\n[dochtml] [reference] dumping search index in English (code: en)... done\n[dochtml] [reference] The HTML pages are in\nlocal/share/doc/sage/html/en/reference.\n[dochtml] Error building the documentation.\n```\n\n\n`make -j1`\nallows the docs to build. \n\nSee e.g. https://github.com/sagemath/sagetrac-mirror/runs/3104375540\n\nIt's of course not totally surprising that several processes may try to, say, create the same directory. Perhaps the relevant part of the builder should be launched with this specific error being ignored?",
    "created_at": "2021-07-21T16:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452606",
    "user": "https://github.com/dimpase"
}
```

I am seeing a race condition, sphinx may race `FileExistsError`, cf. e.g.

```
[dochtml] [reference] preparing documents... skipping loading of indexes... done
[dochtml] [reference] Merging js index files...
[dochtml] [reference]     algebras: 4424 js index entries
[dochtml] [reference]     arithgroup: 1204 js index entries
...

[dochtml] [reference]     topology: 1937 js index entries
[dochtml] [reference]     valuations: 973 js index entries
[dochtml] [reference] ... done (64387 js index entries)
[dochtml] [reference] copying static files... failed
[dochtml] [reference] WARNING: cannot copy static file
FileExistsError(17, 'File exists')
[dochtml] [reference] dumping search index in English (code: en)... done
[dochtml] [reference] The HTML pages are in
local/share/doc/sage/html/en/reference.
[dochtml] Error building the documentation.
```


`make -j1`
allows the docs to build. 

See e.g. https://github.com/sagemath/sagetrac-mirror/runs/3104375540

It's of course not totally surprising that several processes may try to, say, create the same directory. Perhaps the relevant part of the builder should be launched with this specific error being ignored?



---

archive/issue_comments_452607.json:
```json
{
    "body": "It's strange because that doesn't look like part of the docbuild process that's done in parallel with anything else: it looks like the main reference page, built after the other parts of the reference manual. How reliably can you reproduce this?\n\nI think this part of the process (copying static files) is controlled by Sphinx, not by Sage or its modifications to Sphinx, for what that's worth.",
    "created_at": "2021-07-21T21:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452607",
    "user": "https://github.com/jhpalmieri"
}
```

It's strange because that doesn't look like part of the docbuild process that's done in parallel with anything else: it looks like the main reference page, built after the other parts of the reference manual. How reliably can you reproduce this?

I think this part of the process (copying static files) is controlled by Sphinx, not by Sage or its modifications to Sphinx, for what that's worth.



---

archive/issue_comments_452608.json:
```json
{
    "body": "Replying to [comment:85 dimpase]:\n> I am seeing a race condition, sphinx may race `FileExistsError`\n\nnew ticket please?",
    "created_at": "2021-07-21T23:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452608",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:85 dimpase]:
> I am seeing a race condition, sphinx may race `FileExistsError`

new ticket please?



---

archive/issue_comments_452609.json:
```json
{
    "body": "Replying to [comment:87 mkoeppe]:\n> Replying to [comment:85 dimpase]:\n> > I am seeing a race condition, sphinx may race `FileExistsError`\n> \n> new ticket please?\n\nThis is now #32262",
    "created_at": "2021-07-22T02:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31711#issuecomment-452609",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:87 mkoeppe]:
> Replying to [comment:85 dimpase]:
> > I am seeing a race condition, sphinx may race `FileExistsError`
> 
> new ticket please?

This is now #32262
