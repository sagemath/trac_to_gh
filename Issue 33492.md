# Issue 33492: %display latex:  \ZZ undefined

archive/issues_033492.json:
```json
{
    "body": "CC:  egourgoulhon\n\nIt seems that `\\ZZ` is undefined in MathJax:\n\n```\nZn=IntegerModRing(6)\nZn\n```\n\ngives `Ring of integers modulo 6`.\nBut after `%display latex`, this gives\n\n<span style=\"color:red\">\\ZZ</span>/6<span style=\"color:red\">\\ZZ</span>\n\nThis is on [SageMath](SageMath) 9.5 (for 9.6rc0 see https://groups.google.com/g/sage-support/c/NWGRB50xXNk).\n\nIssue created by migration from https://trac.sagemath.org/ticket/33729\n\n",
    "created_at": "2022-04-18T21:51:55Z",
    "labels": [
        "user interface",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "%display latex:  \\ZZ undefined",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33492",
    "user": "@GMS103"
}
```
CC:  egourgoulhon

It seems that `\ZZ` is undefined in MathJax:

```
Zn=IntegerModRing(6)
Zn
```

gives `Ring of integers modulo 6`.
But after `%display latex`, this gives

<span style="color:red">\ZZ</span>/6<span style="color:red">\ZZ</span>

This is on [SageMath](SageMath) 9.5 (for 9.6rc0 see https://groups.google.com/g/sage-support/c/NWGRB50xXNk).

Issue created by migration from https://trac.sagemath.org/ticket/33729





---

archive/issue_comments_476838.json:
```json
{
    "body": "Strange. It works well with me both with 9.6rc0 (on my desktop) and 9.5 (on Cocalc).\n\nWith 9.6rc0, what do you get from `print(html(Zn))`? I get\n\n```\n<html>\\(\\displaystyle \\newcommand{\\ZZ}{\\Bold{Z}}\\ZZ/6\\ZZ\\)</html>\n```\n",
    "created_at": "2022-04-19T13:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476838",
    "user": "klee"
}
```

Strange. It works well with me both with 9.6rc0 (on my desktop) and 9.5 (on Cocalc).

With 9.6rc0, what do you get from `print(html(Zn))`? I get

```
<html>\(\displaystyle \newcommand{\ZZ}{\Bold{Z}}\ZZ/6\ZZ\)</html>
```




---

archive/issue_comments_476839.json:
```json
{
    "body": "I get\n\n```\n<html>\\[\\newcommand{\\Bold}[1]{\\mathbf{#1}}\\ZZ/6\\ZZ\\]</html>\n```\n\nBTW, this `\\newcommand{\\Bold}[1]{\\mathbf{#1}}` appears every time for every displayed line.\n\nThis is on [SageMath](SageMath) 9.5 from https://github.com/3-manifolds/Sage_macOS/releases",
    "created_at": "2022-04-19T13:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476839",
    "user": "@GMS103"
}
```

I get

```
<html>\[\newcommand{\Bold}[1]{\mathbf{#1}}\ZZ/6\ZZ\]</html>
```

BTW, this `\newcommand{\Bold}[1]{\mathbf{#1}}` appears every time for every displayed line.

This is on [SageMath](SageMath) 9.5 from https://github.com/3-manifolds/Sage_macOS/releases



---

archive/issue_comments_476840.json:
```json
{
    "body": "Replying to [comment:2 gh-GMS103]:\n> I get\n> {{{\n> <html>\\[\\newcommand{\\Bold}[1]{\\mathbf{#1}}\\ZZ/6\\ZZ\\]</html>\n> }}}\n> BTW, this `\\newcommand{\\Bold}[1]{\\mathbf{#1}}` appears every time for every displayed line.\n> \n> This is on [SageMath](SageMath) 9.5 from https://github.com/3-manifolds/Sage_macOS/releases\n\nOn sage 9.5 (on Cocalc), I get the same but it display well.",
    "created_at": "2022-04-19T13:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476840",
    "user": "klee"
}
```

Replying to [comment:2 gh-GMS103]:
> I get
> {{{
> <html>\[\newcommand{\Bold}[1]{\mathbf{#1}}\ZZ/6\ZZ\]</html>
> }}}
> BTW, this `\newcommand{\Bold}[1]{\mathbf{#1}}` appears every time for every displayed line.
> 
> This is on [SageMath](SageMath) 9.5 from https://github.com/3-manifolds/Sage_macOS/releases

On sage 9.5 (on Cocalc), I get the same but it display well.



---

archive/issue_comments_476841.json:
```json
{
    "body": "Replying to [comment:2 gh-GMS103]:\n> BTW, this `\\newcommand{\\Bold}[1]{\\mathbf{#1}}` appears every time for every displayed line.\n\nThat was normal before sage 9.6.beta6.",
    "created_at": "2022-04-19T13:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476841",
    "user": "klee"
}
```

Replying to [comment:2 gh-GMS103]:
> BTW, this `\newcommand{\Bold}[1]{\mathbf{#1}}` appears every time for every displayed line.

That was normal before sage 9.6.beta6.



---

archive/issue_comments_476842.json:
```json
{
    "body": "I did experiments again, and now I can confirm that `Zn` shows\n\n```\n\\Bold\ud835\udc4d/6\\Bold\ud835\udc4d\n```\n\nand `print(html(Zn))` shows\n\n```\n<html>\\(\\displaystyle \\newcommand{\\ZZ}{\\Bold{Z}}\\ZZ/6\\ZZ\\)</html>\n```\n\nwith sage 9.6rc0. On the other hand, `ZZ` displays correctly and `print(html(ZZ))` shows\n\n```\n<html>\\(\\displaystyle \\newcommand{\\Bold}[1]{\\mathbf{#1}}\\Bold{Z}\\)</html>\n```\n\n\nI don't know what happened with me before...",
    "created_at": "2022-04-20T01:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476842",
    "user": "klee"
}
```

I did experiments again, and now I can confirm that `Zn` shows

```
\Boldùëç/6\Boldùëç
```

and `print(html(Zn))` shows

```
<html>\(\displaystyle \newcommand{\ZZ}{\Bold{Z}}\ZZ/6\ZZ\)</html>
```

with sage 9.6rc0. On the other hand, `ZZ` displays correctly and `print(html(ZZ))` shows

```
<html>\(\displaystyle \newcommand{\Bold}[1]{\mathbf{#1}}\Bold{Z}\)</html>
```


I don't know what happened with me before...



---

archive/issue_comments_476843.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2022-04-20T04:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476843",
    "user": "klee"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_476844.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-04-20T04:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476844",
    "user": "klee"
}
```

New commits:



---

archive/issue_comments_476845.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-20T04:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476845",
    "user": "klee"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_476846.json:
```json
{
    "body": "The branch was tested with \n\nhttps://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb\n\nwhich may need an update for this ticket.",
    "created_at": "2022-04-20T04:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476846",
    "user": "klee"
}
```

The branch was tested with 

https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb

which may need an update for this ticket.



---

archive/issue_comments_476847.json:
```json
{
    "body": "To reviewer: \n\n#33475 changed the way to get html(mathjax) output from the latex string of an object. It appends sage-defined macros that only appear in the latex string. But some macros use macros themselves. Hence the definitions of the latter macros are not included in the html output, causing the broken display. \n\nThe patch redefines the code to add macro definitions recursively.",
    "created_at": "2022-04-20T04:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476847",
    "user": "klee"
}
```

To reviewer: 

#33475 changed the way to get html(mathjax) output from the latex string of an object. It appends sage-defined macros that only appear in the latex string. But some macros use macros themselves. Hence the definitions of the latter macros are not included in the html output, causing the broken display. 

The patch redefines the code to add macro definitions recursively.



---

archive/issue_comments_476848.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-20T08:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476848",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_476849.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-21T07:01:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476849",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_476850.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-04-22T00:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476850",
    "user": "klee"
}
```

Thanks!



---

archive/issue_comments_476851.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-24T06:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476851",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_476852.json:
```json
{
    "body": "Replying to [comment:8 klee]:\n> The branch was tested with \n> \n> https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb\n> \n> which may need an update for this ticket.\n\nDone (cf. new cell no. 7). \n\nBTW, thank you for the fix!",
    "created_at": "2022-04-26T09:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476852",
    "user": "egourgoulhon"
}
```

Replying to [comment:8 klee]:
> The branch was tested with 
> 
> https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb
> 
> which may need an update for this ticket.

Done (cf. new cell no. 7). 

BTW, thank you for the fix!



---

archive/issue_comments_476853.json:
```json
{
    "body": "Replying to [comment:17 egourgoulhon]:\n> \n> Done (cf. new cell no. 7). \n\nThanks. The notebook is already very helpful.",
    "created_at": "2022-04-26T11:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33492#issuecomment-476853",
    "user": "klee"
}
```

Replying to [comment:17 egourgoulhon]:
> 
> Done (cf. new cell no. 7). 

Thanks. The notebook is already very helpful.
