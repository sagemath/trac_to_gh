# Issue 33492: %display latex:  \ZZ undefined

Issue created by migration from https://trac.sagemath.org/ticket/33729

Original creator: @GMS103

Original creation time: 2022-04-18 21:51:55

CC:  egourgoulhon

It seems that `\ZZ` is undefined in MathJax:

```
Zn=IntegerModRing(6)
Zn
```

gives `Ring of integers modulo 6`.
But after `%display latex`, this gives

<span style="color:red">\ZZ</span>/6<span style="color:red">\ZZ</span>

This is on [SageMath](SageMath) 9.5 (for 9.6rc0 see https://groups.google.com/g/sage-support/c/NWGRB50xXNk).


---

Comment by klee created at 2022-04-19 13:07:42

Strange. It works well with me both with 9.6rc0 (on my desktop) and 9.5 (on Cocalc).

With 9.6rc0, what do you get from `print(html(Zn))`? I get

```
<html>\(\displaystyle \newcommand{\ZZ}{\Bold{Z}}\ZZ/6\ZZ\)</html>
```



---

Comment by @GMS103 created at 2022-04-19 13:36:09

I get

```
<html>\[\newcommand{\Bold}[1]{\mathbf{#1}}\ZZ/6\ZZ\]</html>
```

BTW, this `\newcommand{\Bold}[1]{\mathbf{#1}}` appears every time for every displayed line.

This is on [SageMath](SageMath) 9.5 from https://github.com/3-manifolds/Sage_macOS/releases


---

Comment by klee created at 2022-04-19 13:39:02

Replying to [comment:2 gh-GMS103]:
> I get
> {{{
> <html>\[\newcommand{\Bold}[1]{\mathbf{#1}}\ZZ/6\ZZ\]</html>
> }}}
> BTW, this `\newcommand{\Bold}[1]{\mathbf{#1}}` appears every time for every displayed line.
> 
> This is on [SageMath](SageMath) 9.5 from https://github.com/3-manifolds/Sage_macOS/releases

On sage 9.5 (on Cocalc), I get the same but it display well.


---

Comment by klee created at 2022-04-19 13:41:21

Replying to [comment:2 gh-GMS103]:
> BTW, this `\newcommand{\Bold}[1]{\mathbf{#1}}` appears every time for every displayed line.

That was normal before sage 9.6.beta6.


---

Comment by klee created at 2022-04-20 01:25:43

I did experiments again, and now I can confirm that `Zn` shows

```
\Boldùëç/6\Boldùëç
```

and `print(html(Zn))` shows

```
<html>\(\displaystyle \newcommand{\ZZ}{\Bold{Z}}\ZZ/6\ZZ\)</html>
```

with sage 9.6rc0. On the other hand, `ZZ` displays correctly and `print(html(ZZ))` shows

```
<html>\(\displaystyle \newcommand{\Bold}[1]{\mathbf{#1}}\Bold{Z}\)</html>
```


I don't know what happened with me before...


---

Comment by klee created at 2022-04-20 04:15:16

Changing priority from major to blocker.


---

Comment by klee created at 2022-04-20 04:15:16

New commits:


---

Comment by klee created at 2022-04-20 04:15:16

Changing status from new to needs_review.


---

Comment by klee created at 2022-04-20 04:19:16

The branch was tested with 

https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb

which may need an update for this ticket.


---

Comment by klee created at 2022-04-20 04:46:57

To reviewer: 

#33475 changed the way to get html(mathjax) output from the latex string of an object. It appends sage-defined macros that only appear in the latex string. But some macros use macros themselves. Hence the definitions of the latter macros are not included in the html output, causing the broken display. 

The patch redefines the code to add macro definitions recursively.


---

Comment by git created at 2022-04-20 08:17:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-21 07:01:25

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-04-22 00:01:13

Thanks!


---

Comment by vbraun created at 2022-04-24 06:31:12

Resolution: fixed


---

Comment by egourgoulhon created at 2022-04-26 09:07:45

Replying to [comment:8 klee]:
> The branch was tested with 
> 
> https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb
> 
> which may need an update for this ticket.

Done (cf. new cell no. 7). 

BTW, thank you for the fix!


---

Comment by klee created at 2022-04-26 11:39:04

Replying to [comment:17 egourgoulhon]:
> 
> Done (cf. new cell no. 7). 

Thanks. The notebook is already very helpful.
