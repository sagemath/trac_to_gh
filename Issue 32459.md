# Issue 32459: 1 internet doctest failing in src/sage/finance/stock.py

Issue created by migration from https://trac.sagemath.org/ticket/32696

Original creator: slabbe

Original creation time: 2021-10-14 18:26:36

With Ubuntu 18.04 and 9.5.beta3, the command

```
$ sage -t --optional=sage,internet src/sage/finance/stock.py
```

gives

```
Using --optional=internet,sage
Doctesting 1 file.
sage -t --random-seed=0 src/sage/finance/stock.py
**********************************************************************
File "src/sage/finance/stock.py", line 553, in sage.finance.stock.Stock.load_from_file
Failed example:
    finance.Stock('aapl').load_from_file(filename)[:5]
Expected:
    doctest:warning...
    DeprecationWarning: Importing finance from here is deprecated...
    [
    1212408060 188.00 188.00 188.00 188.00        687,
    1212408000 188.00 188.11 188.00 188.00       2877,
    1212407700 188.00 188.00 188.00 188.00       1000,
    1212407640 187.75 188.00 187.75 188.00       2000,
    1212405780 187.80 187.80 187.80 187.80        100
    ]
Got:
    [
    1212408060 188.00 188.00 188.00 188.00        687,
    1212408000 188.00 188.11 188.00 188.00       2877,
    1212407700 188.00 188.00 188.00 188.00       1000,
    1212407640 187.75 188.00 187.75 188.00       2000,
    1212405780 187.80 187.80 187.80 187.80        100
    ]
**********************************************************************
1 item had failures:
   1 of   5 in sage.finance.stock.Stock.load_from_file
    [26 tests, 1 failure, 0.01 s]
----------------------------------------------------------------------
sage -t --random-seed=0 src/sage/finance/stock.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2021-10-14 18:59:45

The whole package is deprecated - https://wiki.sagemath.org/ReleaseTours/sage-9.5#Deprecated_and_removed_functionality


---

Comment by chapoton created at 2021-10-15 16:51:45

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-10-15 16:51:45

please review
----
New commits:


---

Comment by slabbe created at 2021-10-15 20:28:12

does not work because "..." does not replace "empty":


```
sage -t --random-seed=0 src/sage/finance/stock.py
**********************************************************************
File "src/sage/finance/stock.py", line 553, in sage.finance.stock.Stock.load_from_file
Failed example:
    finance.Stock('aapl').load_from_file(filename)[:5]
Expected:
    ...
    [
    1212408060 188.00 188.00 188.00 188.00        687,
    1212408000 188.00 188.11 188.00 188.00       2877,
    1212407700 188.00 188.00 188.00 188.00       1000,
    1212407640 187.75 188.00 187.75 188.00       2000,
    1212405780 187.80 187.80 187.80 187.80        100
    ]
Got:
    [
    1212408060 188.00 188.00 188.00 188.00        687,
    1212408000 188.00 188.11 188.00 188.00       2877,
    1212407700 188.00 188.00 188.00 188.00       1000,
    1212407640 187.75 188.00 187.75 188.00       2000,
    1212405780 187.80 187.80 187.80 187.80        100
    ]
**********************************************************************
1 item had failures:
   1 of   5 in sage.finance.stock.Stock.load_from_file
    [26 tests, 1 failure, 0.01 s]
----------------------------------------------------------------------
sage -t --random-seed=0 src/sage/finance/stock.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by slabbe created at 2021-10-15 20:28:12

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-10-16 18:27:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2021-10-16 18:27:55

oh, boy..


---

Comment by chapoton created at 2021-10-16 18:27:55

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-10-16 20:14:51

How about just marking this whole file `# sage.doctest: optional - deprecated_sage_finance`
via #30778, see 
https://wiki.sagemath.org/ReleaseTours/sage-9.5#Module-level_.22.23_optional_-_FEATURE.22_for_doctests


---

Comment by chapoton created at 2021-10-18 07:29:30

I am leaving this to other hands


---

Comment by chapoton created at 2021-10-18 07:29:36

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2021-10-22 13:13:22

Ok, why not. I added the new global optional tag, but it does not work: the command

```
$ sage -t --optional=sage,internet src/sage/finance/stock.py
```

still provide a doctest failure.
----
New commits:


---

Comment by mkoeppe created at 2021-10-22 15:29:14

This needs to go to the very top of the file


---

Comment by git created at 2021-10-28 08:38:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2021-10-28 08:40:39

Replying to [comment:11 mkoeppe]:
> This needs to go to the very top of the file

I tried it, but it did not work.


---

Comment by slabbe created at 2021-10-28 08:41:45

I did a fix like the one proposed by Frederic but by making sure the `...` always replaces a non empty string, i.e., containing at least the opening bracket `[`.

Now, both

```
sage -t --optional=sage,internet src/sage/finance/stock.py
sage -t src/sage/finance/stock.py
```

works for me.

Needs review!


---

Comment by slabbe created at 2021-10-28 08:42:43

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-11-15 18:54:33

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-11-15 18:54:33

Allons-y !


---

Comment by vbraun created at 2021-11-18 23:38:04

Resolution: fixed
