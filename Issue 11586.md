# Issue 11586: Bug in global_height function

archive/issues_011586.json:
```json
{
    "body": "Assignee: @JohnCremona\n\nCC:  @JohnCremona @koffie\n\nKeywords: global height\n\nThe global_height function for elements of number fields gives incorrect results. Here is an example:\n\n```\nsage: K.<s> = QuadraticField(2)\nsage: s.global_height()\n0.346573590279973\nsage: (1/s).global_height()\n0.693147180559945\n```\n\nThis is incorrect since s and 1/s should have the same height. I'm running Sage 4.7 on Mac OS X 10.6.8.\n\nI believe the reason for the error is explained in the author's comments in the code for this function:\n\n\"The absolute logarithmic height of this number field element; that is, the sum of the local heights at all finite and infinite places, with the contributions from the infinite places scaled by the degree to make the result independent of the parent field.\"\n\nHowever, it is both the arch. and non-arch. contributions that need to be scaled by the degree.\n\napply [attachment:trac_11758_global_height.2.patch]\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11758\n\n",
    "closed_at": "2011-12-22T13:05:53Z",
    "created_at": "2011-08-30T00:12:45Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Bug in global_height function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11586",
    "user": "https://trac.sagemath.org/admin/accounts/users/dkrumm"
}
```
Assignee: @JohnCremona

CC:  @JohnCremona @koffie

Keywords: global height

The global_height function for elements of number fields gives incorrect results. Here is an example:

```
sage: K.<s> = QuadraticField(2)
sage: s.global_height()
0.346573590279973
sage: (1/s).global_height()
0.693147180559945
```

This is incorrect since s and 1/s should have the same height. I'm running Sage 4.7 on Mac OS X 10.6.8.

I believe the reason for the error is explained in the author's comments in the code for this function:

"The absolute logarithmic height of this number field element; that is, the sum of the local heights at all finite and infinite places, with the contributions from the infinite places scaled by the degree to make the result independent of the parent field."

However, it is both the arch. and non-arch. contributions that need to be scaled by the degree.

apply [attachment:trac_11758_global_height.2.patch]


Issue created by migration from https://trac.sagemath.org/ticket/11758





---

archive/issue_comments_130295.json:
```json
{
    "body": "This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?",
    "created_at": "2011-08-30T18:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130295",
    "user": "https://github.com/JohnCremona"
}
```

This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?



---

archive/issue_comments_130296.json:
```json
{
    "body": "Replying to [comment:3 cremona]:\n> This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?\n\n\nYes, I'd like to do that. I'm trying to figure out how to make a patch (I'm completely new to Sage development), but it should not take too long. In a related question, I have my own height function that I use instead of this one, in which the result is guaranteed to be correct within any given accuracy, and I think the current height in Sage does not (the precision in the input refers not to the accuracy of the output, but to the accuracy used in computing the embeddings of the number field). Do you think it would be good to try to include this height function into Sage?",
    "created_at": "2011-08-30T20:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130296",
    "user": "https://trac.sagemath.org/admin/accounts/users/dkrumm"
}
```

Replying to [comment:3 cremona]:
> This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?


Yes, I'd like to do that. I'm trying to figure out how to make a patch (I'm completely new to Sage development), but it should not take too long. In a related question, I have my own height function that I use instead of this one, in which the result is guaranteed to be correct within any given accuracy, and I think the current height in Sage does not (the precision in the input refers not to the accuracy of the output, but to the accuracy used in computing the embeddings of the number field). Do you think it would be good to try to include this height function into Sage?



---

archive/issue_comments_130297.json:
```json
{
    "body": "Replying to [comment:4 dkrumm]:\n> Replying to [comment:3 cremona]:\n> > This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?\n\n> \n> Yes, I'd like to do that. I'm trying to figure out how to make a patch (I'm completely new to Sage development), but it should not take too long. In a related question, I have my own height function that I use instead of this one, in which the result is guaranteed to be correct within any given accuracy, and I think the current height in Sage does not (the precision in the input refers not to the accuracy of the output, but to the accuracy used in computing the embeddings of the number field). Do you think it would be good to try to include this height function into Sage?\n\n\nDefinitely.  Do it!  But on this ticket, limit the patch to fixing the bug (with doctest), and then create a new ticket for the better function, with a corss-reference from here.",
    "created_at": "2011-08-31T09:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130297",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:4 dkrumm]:
> Replying to [comment:3 cremona]:
> > This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?

> 
> Yes, I'd like to do that. I'm trying to figure out how to make a patch (I'm completely new to Sage development), but it should not take too long. In a related question, I have my own height function that I use instead of this one, in which the result is guaranteed to be correct within any given accuracy, and I think the current height in Sage does not (the precision in the input refers not to the accuracy of the output, but to the accuracy used in computing the embeddings of the number field). Do you think it would be good to try to include this height function into Sage?


Definitely.  Do it!  But on this ticket, limit the patch to fixing the bug (with doctest), and then create a new ticket for the better function, with a corss-reference from here.



---

archive/issue_comments_130298.json:
```json
{
    "body": "Changing assignee from somebody to @JohnCremona.",
    "created_at": "2011-08-31T09:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130298",
    "user": "https://github.com/JohnCremona"
}
```

Changing assignee from somebody to @JohnCremona.



---

archive/issue_comments_130299.json:
```json
{
    "body": "Replying to [comment:5 cremona]:\n> Replying to [comment:4 dkrumm]:\n> > Replying to [comment:3 cremona]:\n> > > This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?\n\n> > \n> > Yes, I'd like to do that. I'm trying to figure out how to make a patch (I'm completely new to Sage development), but it should not take too long. In a related question, I have my own height function that I use instead of this one, in which the result is guaranteed to be correct within any given accuracy, and I think the current height in Sage does not (the precision in the input refers not to the accuracy of the output, but to the accuracy used in computing the embeddings of the number field). Do you think it would be good to try to include this height function into Sage?\n\n> \n> Definitely.  Do it!  But on this ticket, limit the patch to fixing the bug (with doctest), and then create a new ticket for the better function, with a corss-reference from here.\n  \nI hope I've created the patch correctly. Sorry, I don't know what doctest is.",
    "created_at": "2011-08-31T22:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130299",
    "user": "https://trac.sagemath.org/admin/accounts/users/dkrumm"
}
```

Replying to [comment:5 cremona]:
> Replying to [comment:4 dkrumm]:
> > Replying to [comment:3 cremona]:
> > > This looks like a valid bug to me (the author, sorry).  Would you (dkrumm) like to make a patch fixing it, with your example as a doctest?

> > 
> > Yes, I'd like to do that. I'm trying to figure out how to make a patch (I'm completely new to Sage development), but it should not take too long. In a related question, I have my own height function that I use instead of this one, in which the result is guaranteed to be correct within any given accuracy, and I think the current height in Sage does not (the precision in the input refers not to the accuracy of the output, but to the accuracy used in computing the embeddings of the number field). Do you think it would be good to try to include this height function into Sage?

> 
> Definitely.  Do it!  But on this ticket, limit the patch to fixing the bug (with doctest), and then create a new ticket for the better function, with a corss-reference from here.
  
I hope I've created the patch correctly. Sorry, I don't know what doctest is.



---

archive/issue_comments_130300.json:
```json
{
    "body": "Replying to [comment:6 dkrumm]:\n> I hope I've created the patch correctly. Sorry, I don't know what doctest is.\n\n\nA doctest is some test contained in the documentation of a function. Just do:\n\n```\nsage: K.<s> = QuadraticField(2)\nsage: s.global_height?\n```\nYou should now see documentation on how to use the global height. The examples like:\n\n```\n          sage: R.<x> = QQ[]\n          sage: K.<a> = NumberField(x^4+3*x^2-17)\n          sage: b = a/2\n          sage: b.global_height()\n          2.869222240687...\n          sage: b.global_height(prec=200)\n          2.8692222406879748488543678846959454765968722137813736080066\n```\ngiven there are called doctests since they are used for automated testing of the sage library (see http://www.sagemath.org/doc/developer/doctesting.html). All those examples are tested and should produce the shown output before a patch is accepted. In this case it means that the doctests have to change since the answers show are not correct. What john asked is if you could also add your example wich you posted in the description as a test (ofcourse with the new and imporved answers.",
    "created_at": "2011-09-01T00:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130300",
    "user": "https://github.com/koffie"
}
```

Replying to [comment:6 dkrumm]:
> I hope I've created the patch correctly. Sorry, I don't know what doctest is.


A doctest is some test contained in the documentation of a function. Just do:

```
sage: K.<s> = QuadraticField(2)
sage: s.global_height?
```
You should now see documentation on how to use the global height. The examples like:

```
          sage: R.<x> = QQ[]
          sage: K.<a> = NumberField(x^4+3*x^2-17)
          sage: b = a/2
          sage: b.global_height()
          2.869222240687...
          sage: b.global_height(prec=200)
          2.8692222406879748488543678846959454765968722137813736080066
```
given there are called doctests since they are used for automated testing of the sage library (see http://www.sagemath.org/doc/developer/doctesting.html). All those examples are tested and should produce the shown output before a patch is accepted. In this case it means that the doctests have to change since the answers show are not correct. What john asked is if you could also add your example wich you posted in the description as a test (ofcourse with the new and imporved answers.



---

archive/issue_comments_130301.json:
```json
{
    "body": "Replying to [comment:7 mderickx]:\n> Replying to [comment:6 dkrumm]:\n> > I hope I've created the patch correctly. Sorry, I don't know what doctest is.\n\n> \n> A doctest is some test contained in the documentation of a function. Just do:\n> \n> ```\n> sage: K.<s> = QuadraticField(2)\n> sage: s.global_height?\n> ```\n> You should now see documentation on how to use the global height. The examples like:\n> \n> ```\n>           sage: R.<x> = QQ[]\n>           sage: K.<a> = NumberField(x^4+3*x^2-17)\n>           sage: b = a/2\n>           sage: b.global_height()\n>           2.869222240687...\n>           sage: b.global_height(prec=200)\n>           2.8692222406879748488543678846959454765968722137813736080066\n> ```\n> given there are called doctests since they are used for automated testing of the sage library (see http://www.sagemath.org/doc/developer/doctesting.html). All those examples are tested and should produce the shown output before a patch is accepted. In this case it means that the doctests have to change since the answers show are not correct. What john asked is if you could also add your example wich you posted in the description as a test (ofcourse with the new and imporved answers.\n\n\nOk, thanks for the explanation. Unfortunately, I can't put in those examples yet, because my sage library won't build. So even though I've made the changes in the code, I can't get sage to recognize them. I have this problem on my personal computer, and also on the ones in my department.. do you think this problem with Lion and Xcode will be fixed any time soon?",
    "created_at": "2011-09-01T01:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130301",
    "user": "https://trac.sagemath.org/admin/accounts/users/dkrumm"
}
```

Replying to [comment:7 mderickx]:
> Replying to [comment:6 dkrumm]:
> > I hope I've created the patch correctly. Sorry, I don't know what doctest is.

> 
> A doctest is some test contained in the documentation of a function. Just do:
> 
> ```
> sage: K.<s> = QuadraticField(2)
> sage: s.global_height?
> ```
> You should now see documentation on how to use the global height. The examples like:
> 
> ```
>           sage: R.<x> = QQ[]
>           sage: K.<a> = NumberField(x^4+3*x^2-17)
>           sage: b = a/2
>           sage: b.global_height()
>           2.869222240687...
>           sage: b.global_height(prec=200)
>           2.8692222406879748488543678846959454765968722137813736080066
> ```
> given there are called doctests since they are used for automated testing of the sage library (see http://www.sagemath.org/doc/developer/doctesting.html). All those examples are tested and should produce the shown output before a patch is accepted. In this case it means that the doctests have to change since the answers show are not correct. What john asked is if you could also add your example wich you posted in the description as a test (ofcourse with the new and imporved answers.


Ok, thanks for the explanation. Unfortunately, I can't put in those examples yet, because my sage library won't build. So even though I've made the changes in the code, I can't get sage to recognize them. I have this problem on my personal computer, and also on the ones in my department.. do you think this problem with Lion and Xcode will be fixed any time soon?



---

archive/issue_comments_130302.json:
```json
{
    "body": "If you have problems building Sage ask questions on sage-devel, not here.\n\nRead the developers' guide for instructions on how to write doctests and make patches, etc.  And I suggest that you don't post a patch until you have tested it which you obviously cannot do until you have your own development build up and running.",
    "created_at": "2011-09-03T07:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130302",
    "user": "https://github.com/JohnCremona"
}
```

If you have problems building Sage ask questions on sage-devel, not here.

Read the developers' guide for instructions on how to write doctests and make patches, etc.  And I suggest that you don't post a patch until you have tested it which you obviously cannot do until you have your own development build up and running.



---

archive/issue_comments_130303.json:
```json
{
    "body": "I just added the doctest so that the patch is ready for review.",
    "created_at": "2011-11-26T16:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130303",
    "user": "https://github.com/koffie"
}
```

I just added the doctest so that the patch is ready for review.



---

archive/issue_comments_130304.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-11-26T16:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130304",
    "user": "https://github.com/koffie"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_130305.json:
```json
{
    "body": "Replying to [comment:10 mderickx]:\n> I just added the doctest so that the patch is ready for review.\n\nYou need to put a proper commit message in the patch",
    "created_at": "2011-11-26T22:16:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130305",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 mderickx]:
> I just added the doctest so that the patch is ready for review.

You need to put a proper commit message in the patch



---

archive/issue_comments_130306.json:
```json
{
    "body": "Attachment [trac_11758_global_height.patch](tarball://root/attachments/some-uuid/ticket11758/trac_11758_global_height.patch) by @koffie created at 2011-12-02 20:57:43\n\nReplying to [comment:11 jdemeyer]:\n> You need to put a proper commit message in the patch\n\n\ndone",
    "created_at": "2011-12-02T20:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130306",
    "user": "https://github.com/koffie"
}
```

Attachment [trac_11758_global_height.patch](tarball://root/attachments/some-uuid/ticket11758/trac_11758_global_height.patch) by @koffie created at 2011-12-02 20:57:43

Replying to [comment:11 jdemeyer]:
> You need to put a proper commit message in the patch


done



---

archive/issue_comments_130307.json:
```json
{
    "body": "Original patch, with a trivial typo fixed in a docstring.",
    "created_at": "2011-12-17T17:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130307",
    "user": "https://trac.sagemath.org/admin/accounts/users/fschulze"
}
```

Original patch, with a trivial typo fixed in a docstring.



---

archive/issue_comments_130308.json:
```json
{
    "body": "Attachment [trac_11758_global_height.2.patch](tarball://root/attachments/some-uuid/ticket11758/trac_11758_global_height.2.patch) by fschulze created at 2011-12-17 17:18:23\n\nThe above patch fixes a trivial typo in Maarten's patch.\n\nOtherwise everything is fine. Also, Magma gives the same result for both doctests.",
    "created_at": "2011-12-17T17:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130308",
    "user": "https://trac.sagemath.org/admin/accounts/users/fschulze"
}
```

Attachment [trac_11758_global_height.2.patch](tarball://root/attachments/some-uuid/ticket11758/trac_11758_global_height.2.patch) by fschulze created at 2011-12-17 17:18:23

The above patch fixes a trivial typo in Maarten's patch.

Otherwise everything is fine. Also, Magma gives the same result for both doctests.



---

archive/issue_comments_130309.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-12-17T17:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130309",
    "user": "https://trac.sagemath.org/admin/accounts/users/fschulze"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_130310.json:
```json
{
    "body": "Thanks for reviewing.\n\nIf you review something you should set the reviewer field. And if there are multiple patches you should specify wich to apply.",
    "created_at": "2011-12-17T18:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130310",
    "user": "https://github.com/koffie"
}
```

Thanks for reviewing.

If you review something you should set the reviewer field. And if there are multiple patches you should specify wich to apply.



---

archive/issue_comments_130311.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-12-22T13:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11586#issuecomment-130311",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_030925.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-22T13:05:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11586",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11586#event-30925"
}
```
