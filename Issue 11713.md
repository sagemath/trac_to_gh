# Issue 11713: call function in sage.libs.mpmath.utils doesn't handle parent=parent(float)

Issue created by migration from https://trac.sagemath.org/ticket/11885

Original creator: benjaminfjones

Original creation time: 2011-09-30 19:06:44

Assignee: burcin

CC:  burcin

Keywords: mpmath call parent

In multiple places in the Sage library the function `sage.libs.mpmath.utils.call` is called and inputs are passed along with their parents. If the parent of the input doesn't have a `prec` method, an AttributeError is raised:


```
sage: import sage.libs.mpmath.all as a
sage: z = float(4)
sage: a.call(a.e1, z)
0.00377935240984891
sage: a.call(a.e1, z, parent=parent(z))
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/Users/jonesbe/sage/sage-4.7.2.alpha2/devel/sage-test/sage/<ipython console> in <module>()

/Users/jonesbe/sage/latest/local/lib/python2.6/site-packages/sage/libs/mpmath/utils.so in sage.libs.mpmath.utils.call (sage/libs/mpmath/utils.c:5277)()

AttributeError: type object 'float' has no attribute 'prec'
```


This can be fixed with a simple check in in the `call` code in `sage/libs/mpmath/utils.pyx`.


---

Comment by benjaminfjones created at 2011-09-30 19:09:33

adds check that parent has attribute 'prec' before calling


---

Attachment


---

Comment by leif created at 2011-09-30 20:54:55

Changing keywords from "mpmath call parent" to "mpmath call parent precision".


---

Comment by leif created at 2011-09-30 20:54:55

Changing status from new to needs_review.


---

Comment by burcin created at 2011-10-07 09:33:11

Changing status from needs_review to needs_work.


---

Comment by burcin created at 2011-10-07 09:33:11

Thanks for the patch. It looks good, though I have minor suggestions:
 * this needs to be doctested
 * using

```
try:
    prec = parent.prec()
except AttributeError:
    pass
```

might be faster than performing a test with `hasattr()` first, then looking up the `prec()` method again.


---

Comment by benjaminfjones created at 2011-10-07 19:56:02

adds an exception check in call()


---

Comment by benjaminfjones created at 2011-10-07 19:59:13

Changing status from needs_work to needs_review.


---

Attachment

Good point! I made the change and added a doctest to `call()` to illustrate that the bug is fixed.

The change does give a speedup. The best case I found was running

```
sage: timeit('mputils.call(a.ei, 1.0r, parent=float)')
```


Before the old patch, I was getting about 87 micro seconds. With the new patch, the best time I got was about 60 micro seconds.


---

Comment by leif created at 2011-10-07 21:52:11

Replying to [comment:3 benjaminfjones]:
> Good point! I made the change and added a doctest to `call()` to illustrate that the bug is fixed.
> 
> The change does give a speedup. The best case I found was running

```
sage: timeit('mputils.call(a.ei, 1.0r, parent=float)')
```

> 
> Before the old patch, I was getting about 87 micro seconds. With the new patch, the best time I got was about 60 micro seconds.

I'm not sure whether that's a deterministic result.

But Burcin is right, using `try: ...` is (at least) faster _in case `parent` *does* have a `prec()` method_.


---

Comment by burcin created at 2011-10-10 09:05:39

Thanks for the changes. Positive review.


---

Comment by burcin created at 2011-10-10 09:05:39

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-10-17 07:58:29

Resolution: fixed


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted
