# Issue 24480: Branch cuts of functions on ComplexBallFields

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2018-02-12 14:19:28

CC:  fredrik.johansson vdelecroix cheuberg

Add support for the ``analytic`` argument required by the rigorous integration code in (some) methods of complex balls.


---

Comment by mmezzarobba created at 2018-02-12 15:32:26

Let's hope I didn't get too many branch cuts wrong...
----
Last 10 new commits:


---

Comment by mmezzarobba created at 2018-02-12 15:32:26

Changing status from new to needs_review.


---

Comment by fredrik.johansson created at 2018-02-12 15:41:18

This looks great. I would just suggest adding a pow method with this flag as well, and perhaps documenting some examples for .integral() where these are used (examples with .integral() could also be used as doctests for the individual methods).


---

Comment by mmezzarobba created at 2018-02-12 17:22:35

Replying to [comment:2 fredrik.johansson]:
> This looks great. I would just suggest adding a pow method with this flag as well,

Yes, and there are several other methods that could implement `analytic=True`--but I thought it would be better to have some easy ones now rather than all later. (Though, thinking of it, pow wouldn't be that hard to support.)

> and perhaps documenting some examples for .integral() where these are used (examples with .integral() could also be used as doctests for the individual methods).

Either I don't understand what you mean, or there are already one or two such examples.


---

Comment by fredrik.johansson created at 2018-02-12 17:28:23

Replying to [comment:3 mmezzarobba]:
> Replying to [comment:2 fredrik.johansson]:
> > This looks great. I would just suggest adding a pow method with this flag as well,
> 
> Yes, and there are several other methods that could implement `analytic=True`--but I thought it would be better to have some easy ones now rather than all later. (Though, thinking of it, pow wouldn't be that hard to support.)

Indeed, but pow is perhaps the most important of them all...

> > and perhaps documenting some examples for .integral() where these are used (examples with .integral() could also be used as doctests for the individual methods).
> 
> Either I don't understand what you mean, or there are already one or two such examples.

Thanks, I missed that.


---

Comment by mmezzarobba created at 2018-02-12 17:49:57

Replying to [comment:4 fredrik.johansson]:
> Indeed, but pow is perhaps the most important of them all...

Yes, but it is also a bit harder to implement due to the need to share code with the `__pow__`, which participates in the coercion system... but ok, I'll try to see what I can do.


---

Comment by git created at 2018-02-12 19:25:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-02-13 01:00:51

Replying to [comment:5 mmezzarobba]:
> Replying to [comment:4 fredrik.johansson]:
> > Indeed, but pow is perhaps the most important of them all...
> 
> Yes, but it is also a bit harder to implement due to the need to share code with the `__pow__`, which participates in the coercion system... but ok, I'll try to see what I can do.

If you implement `__pow__`, you bypass the coercion system altogether (similar to if you implement `__mul__`). ADDENDUM - Unless of course you call the coercion framework yourself.


---

Comment by mmezzarobba created at 2018-02-13 09:43:11

Replying to [comment:7 tscrim]:
> ADDENDUM - Unless of course you call the coercion framework yourself.

Yes, that's what both the previous code and my patch are doing.


---

Comment by vdelecroix created at 2018-03-04 10:58:52

I agree with [comment:2 comment:2] that this would better be tested in conjunction with numerical integration.

Moreover, does it work correctly with function compositions? Could I integrate cos(exp(x)) using

```
lambda z,f: z.exp(f).cos(f)
```

If so, we shoud add examples in `CBF.integral`.


---

Comment by chapoton created at 2018-03-11 17:14:39

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-03-11 17:14:39

does not apply


---

Comment by git created at 2018-03-11 18:48:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-03-11 19:19:34

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2018-03-11 19:19:34

thanks, rebased!


---

Comment by vdelecroix created at 2018-04-07 14:30:37

You should be using `PY_NEW(Integer)` and not `Integer.__new__(Integer)` (unless something changed around Cython about `tp_new`).

It would be nice to have usage example in the `integral` docstring.


---

Comment by mmezzarobba created at 2018-04-07 18:58:18

Replying to [comment:14 vdelecroix]:
> You should be using `PY_NEW(Integer)` and not `Integer.__new__(Integer)` (unless something changed around Cython about `tp_new`).

Can you explain the difference? I thought `Integer.__new__(Integer)` had been working already for a long time, and


```
$ git grep 'Integer.__new__' | wc -l
95
```


> It would be nice to have usage example in the `integral` docstring.

See [comment:3 above] :-)


---

Comment by vdelecroix created at 2018-04-07 21:50:46

Replying to [comment:15 mmezzarobba]:
> Replying to [comment:14 vdelecroix]:
> > You should be using `PY_NEW(Integer)` and not `Integer.__new__(Integer)` (unless something changed around Cython about `tp_new`).
> 
> Can you explain the difference? I thought `Integer.__new__(Integer)` had been working already for a long time, and
> 
> {{{
> $ git grep 'Integer.__new__' | wc -l
> 95
> }}}

On the other hand, this is the current `PY_NEW` documentation

```
    Return ``t.__new__(t)``.  This works even for types like
    :class:`Integer` where we change ``tp_new`` at runtime (Cython
    optimizations assume that ``tp_new`` doesn't change).
```


> > It would be nice to have usage example in the `integral` docstring.
> 
> See [comment:3 above] :-)

Oups.


---

Comment by mmezzarobba created at 2018-04-08 08:25:01

Replying to [comment:16 vdelecroix]:
> On the other hand, this is the current `PY_NEW` documentation

Ok. This has nothing to do with this ticket (I'm just changing `s.r.i.Integer` to `Integer` in an existing call), but let's be safe.


---

Comment by git created at 2018-04-08 08:25:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-04-08 14:12:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-06 17:15:30

Merge conflict


---

Comment by vbraun created at 2018-05-06 17:15:30

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-07 07:46:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-07 07:48:57

Rebased (but without conflict for me: are you seeing a merge conflict with `develop`, or was that with additional changes?).


---

Comment by mmezzarobba created at 2018-05-07 07:48:57

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-05-08 17:30:04

Merge conflict (wait for the next beta)


---

Comment by vbraun created at 2018-05-08 17:30:04

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-10 19:09:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-10 19:10:34

Ok, it was a trivial conflict.


---

Comment by mmezzarobba created at 2018-05-10 19:10:34

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-05-12 12:52:21

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-05-12 12:52:21


```
[sagelib-8.3.beta0] Error compiling Cython file:
[sagelib-8.3.beta0] ------------------------------------------------------------
[sagelib-8.3.beta0] ...
[sagelib-8.3.beta0]             sage: ZZ(CBF(i))
[sagelib-8.3.beta0]             Traceback (most recent call last):
[sagelib-8.3.beta0]             ...
[sagelib-8.3.beta0]             ValueError: 1.000000000000000*I does not contain a unique integer
[sagelib-8.3.beta0]         """
[sagelib-8.3.beta0]         cdef Integer res
[sagelib-8.3.beta0]             ^
[sagelib-8.3.beta0] ------------------------------------------------------------
[sagelib-8.3.beta0] 
[sagelib-8.3.beta0] sage/rings/complex_arb.pyx:1512:13: 'Integer' is not a type identifier
```



---

Comment by git created at 2018-05-12 13:44:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-12 13:44:50

Changing status from needs_work to positive_review.


---

Comment by mmezzarobba created at 2018-05-12 13:44:50

Sorry.


---

Comment by vbraun created at 2018-05-15 22:33:59

Resolution: fixed
