# Issue 22733: use flint fmpq_mat for rational dense matrices

Issue created by migration from https://trac.sagemath.org/ticket/22970

Original creator: vdelecroix

Original creation time: 2017-05-10 10:03:42

CC:  cpernet mmasdeu

The flint library has a builtin type for rational matrices. This ticket proposes to replace the current array of `mpq_t` for the data to the `fmpq_mat_t` type of flint.

(See also the related #22924 and #22872)


---

Comment by vdelecroix created at 2017-05-11 09:43:29

Changing component from PLEASE CHANGE to linear algebra.


---

Comment by vdelecroix created at 2017-05-11 09:43:29

New commits:


---

Comment by vdelecroix created at 2017-05-11 09:53:47

For a discussion about an annoying segfault related to this ticket, see [this thread](https://groups.google.com/forum/#!topic/sage-devel/Vk3gAZiBfQ8).


---

Comment by git created at 2017-05-11 14:54:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-11 14:55:23

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-05-11 15:30:04

Changing keywords from "" to "thursdaysbdx".


---

Comment by git created at 2017-05-12 07:29:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-05-12 11:42:28

New commits:


---

Comment by git created at 2017-05-12 11:42:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-12 13:48:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmasdeu created at 2017-05-15 11:02:14

Thanks for the work Vincent! I think that it's my duty to review this one :-).

While I update my develop branch and check the ticket out, could you check that that the docstring in the determinant method is correct? In ``algorithm``, I see ``None`` missing.

Also, do you happen to have timings? that compare with the previous implementation? Otherwise I can produce some...


---

Comment by vdelecroix created at 2017-05-15 11:20:30

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-05-15 11:20:30

Hi Marc,

Thanks for proposing the review! I need some more work on my branch as I have strange failing doctests in `sage/modular` that I don't understand right now.

I will provide proper timings for the following methods (tell me if you have more in mind):
 - `determinant`
 - `multiplication`
 - `echelonize`
 - `charpoly` (not yet in flint, but can go through integer matrices)
 - `minpoly` (not yet in flint, but can go through integer matrices)


---

Attachment


---

Comment by git created at 2017-05-15 13:51:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-15 13:52:00

At commit `edfa6f46b5` using [attachment:test_file.sage] I obtain (within different session because of caching)

```
sage: %runfile test_file.sage
sage: test(seed=0)
f = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)
K = Number Field in a1 with defining polynomial x^2 + 32*x - 9984
a = 1/2*a1
True
False
```

and

```
sage: %runfile test_file.sage
sage: test(seed=1)
f = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)
K = Number Field in a1 with defining polynomial x^2 + 32*x - 9984
a = 1/2*a1
False
True
```

And it looks like a bug to me that this result depends on the seed of the random generator...


---

Comment by vdelecroix created at 2017-05-15 14:05:55

Replying to [comment:14 comment:14]: Discussed at 
[this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/7VpAxhycBe0).


---

Attachment

From [attachment:benchmark_matrices.py]

- echelonize: flint is better except when coefficients are huge in which case multimodular is best

```
nrows=5  ncols=5  rank=5, density=1.0000 nbits(height)=100
flint        0.0565
multimodular 0.3284
padic        0.5626

nrows=10  ncols=10  rank=5, density=1.0000 nbits(height)=37
flint        0.1063
multimodular 2.6420
padic        7.6511

nrows=100  ncols=100  rank=20, density=0.1799 nbits(height)=12
flint        9.1834
multimodular 12.2192
padic        74.8152

nrows=10  ncols=10  rank=10, density=1.0000 nbits(height)=200
flint        10.1606
multimodular 1.5586
padic        2.1540
```

- determinant

```
dim=3 density=0.7778 nbits(height)=3
flint        0.0092
integer      0.1334
pari         0.0017

dim=3 density=1.0000 nbits(height)=100
flint        0.0113
integer      0.1188
pari         0.0269

dim=30 density=1.0000 nbits(height)=5
flint        0.9006
integer      1.0754
pari         34.5452

dim=30 density=0.2544 nbits(height)=5
flint        0.4389
integer      0.9986
pari         179.9622
```

- charpoly

```
dim=3 density=0.7778 nbits(height)=2
flint        0.3875
linbox       1.3019
generic      0.0431

dim=4 density=0.5625 nbits(height)=2
flint        0.1776
linbox       1.2013
generic      0.0450

dim=5 density=0.6400 nbits(height)=2
flint        0.1737
linbox       1.2952
generic      0.0532

dim=6 density=0.6111 nbits(height)=2
flint        0.1850
linbox       1.2773
generic      0.0651

dim=10 density=0.4100 nbits(height)=2
flint        0.2343
linbox       1.4250
generic      0.1818

dim=10 density=1.0000 nbits(height)=2
flint        0.2521
linbox       1.4264
generic      0.4842

dim=30 density=1.0000 nbits(height)=2
flint        4.8531
linbox       3.4320
generic      50.0362
```



---

Comment by git created at 2017-05-16 09:58:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-16 09:59:15

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-05-16 09:59:15

Needs review again. I tried to make independent of the random seed the annoying doctests in sage/modular...


---

Comment by vdelecroix created at 2017-05-16 12:59:54

patchbot is green!! (with a weird ascii complaints)


---

Comment by mmasdeu created at 2017-05-16 14:41:02

On my computer, a call to

```
sage: CuspForms(101,12).hecke_matrix(3)
```


takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.

Maybe the default algorithm should be changed if the entries are large?


---

Comment by vdelecroix created at 2017-05-16 14:49:30

Replying to [comment:20 mmasdeu]:
> On my computer, a call to
> {{{
> sage: CuspForms(101,12).hecke_matrix(3)
> }}}
> 
> takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.
> 
> Maybe the default algorithm should be changed if the entries are large?

I did not do proper tunings (since I will redo it after #22924 anyway). However, I can try to do something better for `echelon_form/echelonize`. Do you have other relevant examples in mind?


---

Comment by mmasdeu created at 2017-05-16 15:12:14

Not at the moment. I haven't done exhaustive tests either, but it seems that in many cases the performance is similar.

As for other examples, many operations with subquotients involve doing this kind of linear algebra.


---

Comment by vdelecroix created at 2017-05-17 08:49:44

Some remarks
- flint has several algorithms for echelon form and this is not finely tuned.
- On very specific instances, multimodular can be much faster (up to x100). This is the reason why your example `CuspForms(101,12).hecke_matrix(3)` gets slower. I have no idea how to detect such instances.
- for `random_matrix(QQ, ...)` (ie independent entries) flint looks like to be the best option excepted in the range `10 <= nrows=ncols <= 20` where flint tuning (over Z) is very bad

One way to go might be to have a global option that controls the default behavior of the echelon form. I am thinking of something that can be used like

```python
def my_modular_form_algorithm():
    with rational_echelon_form('multimodular'):
        # some relevant code here
        ....
```

What do you think?


---

Comment by vdelecroix created at 2017-05-17 08:56:07

Second option, allow the option `algorithm=my_function` where `my_function` takes a matrix as input and returns a valid algorithm for echelon form. (I do prefer this one better)

EDIT: this will not work since `echelon_form` is *indirectly* called in modular function algorithms...


---

Comment by vdelecroix created at 2017-05-17 09:58:04

Implementing the idea from [comment:23 comment:23] I got

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 7.52 s, sys: 63.3 ms, total: 7.59 s
Wall time: 7.55 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 13s, sys: 203 ms, total: 2min 13s
Wall time: 2min 13s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 5min 10s, sys: 663 ms, total: 5min 10s
Wall time: 5min 10s
```

against the following in develop

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 13.5 s, sys: 43.3 ms, total: 13.6 s
Wall time: 13.5 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 3min 8s, sys: 250 ms, total: 3min 9s
Wall time: 3min 9s

%time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 8min 7s, sys: 527 ms, total: 8min 8s
Wall time: 8min 8s
```

(so close to x2 improvement)

I propose to postpone this improvement to another ticket since this one is already a big change. If you agree I will open a new one and work on it as soon as this one is closed.


---

Comment by mmasdeu created at 2017-05-18 11:07:00

1) I agree that this can be dealt with in another ticket, but it is moderately urgent. ModularSymbols / ModularForms becoming twice slower than currently is not good news...

Another example of a reasonable calculation: with the Sage 7.5.1 the following calculation takes 22 seconds on my laptop. It takes 1min22s (!) with the proposed patch.

```
sage: %time A = ModularSymbols(11,60).hecke_matrix(3)
```


2) While reviewing, in `sage/modular/hecke/module.py` there is a doctest that changed in a suspicious way. It seems that a number field was created with a different generator and that causes the output to look different. I propose that the line that causes trouble gets changed into

```
sage: [o.minpoly() for o in A.system_of_eigenvalues(3)]
[x - 1, x + 1, x^2 - 2*x - 2]
```


The output that appears should not depend on the implementation.

3) There seems to be quite a mess on what are the acceptable values to the 'algorithm' parameter. Maybe it's a good time to change that! My suggestion would be that the default would always be None, and then the docstring would specify what is done in this case.


---

Comment by mmasdeu created at 2017-05-18 11:07:00

Changing status from needs_review to needs_work.


---

Comment by fredrik.johansson created at 2017-05-18 16:03:48

I might have an explanation for why Flint is slow for these modular symbol matrices. See:

https://github.com/wbhart/flint2/issues/335

It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.


---

Comment by vdelecroix created at 2017-05-18 16:17:36

Replying to [comment:27 fredrik.johansson]:
> I might have an explanation for why Flint is slow for these modular symbol matrices. See:
> 
> https://github.com/wbhart/flint2/issues/335
> 
> It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.

Would be tremendous!


---

Comment by vdelecroix created at 2017-05-18 16:22:44

`@`mmasdeu: for the sake of this ticket I will set the default to `multimodular` that should actually speed up all modular symbol computations. Then #23026 will deal with making flint the default (that is much faster on random instances).


---

Comment by mmasdeu created at 2017-05-18 16:32:17

That sounds reasonable...at least there is no regression in speed (hopefully!).


---

Comment by git created at 2017-05-18 17:40:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-18 18:32:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-18 18:32:31

at commit b5f5600 I got

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 11.7 s, sys: 40 ms, total: 11.7 s
Wall time: 11.7 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 52s, sys: 283 ms, total: 2min 52s
Wall time: 2min 52s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 7min 17s, sys: 620 ms, total: 7min 18s
Wall time: 7min 18s
```


and at 5f2e1ba the even better

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 7.5 s, sys: 36.7 ms, total: 7.53 s
Wall time: 7.51 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 10s, sys: 223 ms, total: 2min 10s
Wall time: 2min 10s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 5min 9s, sys: 603 ms, total: 5min 10s
Wall time: 5min 10s
```



---

Comment by vdelecroix created at 2017-05-18 18:33:00

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-05-19 12:32:48

And tests also pass on beta7!


---

Comment by mmasdeu created at 2017-05-21 16:32:29

This is definitely more than satisfying. The code looks very clean, and all tests pass. Thanks for the great work!


---

Comment by mmasdeu created at 2017-05-21 16:32:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-05-22 22:35:06

Merge conflict


---

Comment by vbraun created at 2017-05-22 22:35:06

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2017-05-23 06:45:19

Too bad. The code is fine on beta7. Can I try to fix it by merging another ticket?


---

Comment by git created at 2017-05-29 13:06:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2017-05-29 13:07:08

rebased (I launched the patchbot)


---

Comment by vdelecroix created at 2017-05-29 13:07:08

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-05-29 22:01:47

patchbot still happy!


---

Comment by vdelecroix created at 2017-05-29 22:01:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-05-31 22:25:35

Resolution: fixed
