# Issue 22733: use flint fmpq_mat for rational dense matrices

archive/issues_022733.json:
```json
{
    "body": "CC:  @ClementPernet @mmasdeu\n\nThe flint library has a builtin type for rational matrices. This ticket proposes to replace the current array of `mpq_t` for the data to the `fmpq_mat_t` type of flint.\n\n(See also the related #22924 and #22872)\n\nIssue created by migration from https://trac.sagemath.org/ticket/22970\n\n",
    "created_at": "2017-05-10T10:03:42Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "use flint fmpq_mat for rational dense matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22733",
    "user": "https://github.com/videlec"
}
```
CC:  @ClementPernet @mmasdeu

The flint library has a builtin type for rational matrices. This ticket proposes to replace the current array of `mpq_t` for the data to the `fmpq_mat_t` type of flint.

(See also the related #22924 and #22872)

Issue created by migration from https://trac.sagemath.org/ticket/22970





---

archive/issue_comments_317038.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to linear algebra.",
    "created_at": "2017-05-11T09:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317038",
    "user": "https://github.com/videlec"
}
```

Changing component from PLEASE CHANGE to linear algebra.



---

archive/issue_comments_317039.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-05-11T09:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317039",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_317040.json:
```json
{
    "body": "For a discussion about an annoying segfault related to this ticket, see [this thread](https://groups.google.com/forum/#!topic/sage-devel/Vk3gAZiBfQ8).",
    "created_at": "2017-05-11T09:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317040",
    "user": "https://github.com/videlec"
}
```

For a discussion about an annoying segfault related to this ticket, see [this thread](https://groups.google.com/forum/#!topic/sage-devel/Vk3gAZiBfQ8).



---

archive/issue_comments_317041.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-11T14:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317041",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317042.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-11T14:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317042",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_317043.json:
```json
{
    "body": "Changing keywords from \"\" to \"thursdaysbdx\".",
    "created_at": "2017-05-11T15:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317043",
    "user": "https://github.com/videlec"
}
```

Changing keywords from "" to "thursdaysbdx".



---

archive/issue_comments_317044.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-12T07:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317044",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317045.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-05-12T11:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317045",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_317046.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-12T11:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317046",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317047.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-12T13:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317048.json:
```json
{
    "body": "Thanks for the work Vincent! I think that it's my duty to review this one :-).\n\nWhile I update my develop branch and check the ticket out, could you check that that the docstring in the determinant method is correct? In ``algorithm``, I see ``None`` missing.\n\nAlso, do you happen to have timings? that compare with the previous implementation? Otherwise I can produce some...",
    "created_at": "2017-05-15T11:02:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317048",
    "user": "https://github.com/mmasdeu"
}
```

Thanks for the work Vincent! I think that it's my duty to review this one :-).

While I update my develop branch and check the ticket out, could you check that that the docstring in the determinant method is correct? In ``algorithm``, I see ``None`` missing.

Also, do you happen to have timings? that compare with the previous implementation? Otherwise I can produce some...



---

archive/issue_comments_317049.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-15T11:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317049",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_317050.json:
```json
{
    "body": "Hi Marc,\n\nThanks for proposing the review! I need some more work on my branch as I have strange failing doctests in `sage/modular` that I don't understand right now.\n\nI will provide proper timings for the following methods (tell me if you have more in mind):\n- `determinant`\n- `multiplication`\n- `echelonize`\n- `charpoly` (not yet in flint, but can go through integer matrices)\n- `minpoly` (not yet in flint, but can go through integer matrices)",
    "created_at": "2017-05-15T11:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317050",
    "user": "https://github.com/videlec"
}
```

Hi Marc,

Thanks for proposing the review! I need some more work on my branch as I have strange failing doctests in `sage/modular` that I don't understand right now.

I will provide proper timings for the following methods (tell me if you have more in mind):
- `determinant`
- `multiplication`
- `echelonize`
- `charpoly` (not yet in flint, but can go through integer matrices)
- `minpoly` (not yet in flint, but can go through integer matrices)



---

archive/issue_comments_317051.json:
```json
{
    "body": "Attachment [test_file.sage](tarball://root/attachments/some-uuid/ticket22970/test_file.sage) by @videlec created at 2017-05-15 13:47:47",
    "created_at": "2017-05-15T13:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317051",
    "user": "https://github.com/videlec"
}
```

Attachment [test_file.sage](tarball://root/attachments/some-uuid/ticket22970/test_file.sage) by @videlec created at 2017-05-15 13:47:47



---

archive/issue_comments_317052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-15T13:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317053.json:
```json
{
    "body": "At commit `edfa6f46b5` using [attachment:test_file.sage] I obtain (within different session because of caching)\n\n```\nsage: %runfile test_file.sage\nsage: test(seed=0)\nf = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)\nK = Number Field in a1 with defining polynomial x^2 + 32*x - 9984\na = 1/2*a1\nTrue\nFalse\n```\n\nand\n\n```\nsage: %runfile test_file.sage\nsage: test(seed=1)\nf = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)\nK = Number Field in a1 with defining polynomial x^2 + 32*x - 9984\na = 1/2*a1\nFalse\nTrue\n```\n\nAnd it looks like a bug to me that this result depends on the seed of the random generator...",
    "created_at": "2017-05-15T13:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317053",
    "user": "https://github.com/videlec"
}
```

At commit `edfa6f46b5` using [attachment:test_file.sage] I obtain (within different session because of caching)

```
sage: %runfile test_file.sage
sage: test(seed=0)
f = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)
K = Number Field in a1 with defining polynomial x^2 + 32*x - 9984
a = 1/2*a1
True
False
```

and

```
sage: %runfile test_file.sage
sage: test(seed=1)
f = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)
K = Number Field in a1 with defining polynomial x^2 + 32*x - 9984
a = 1/2*a1
False
True
```

And it looks like a bug to me that this result depends on the seed of the random generator...



---

archive/issue_comments_317054.json:
```json
{
    "body": "Replying to [comment:14 comment:14]: Discussed at \n[this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/7VpAxhycBe0).",
    "created_at": "2017-05-15T14:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317054",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:14 comment:14]: Discussed at 
[this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/7VpAxhycBe0).



---

archive/issue_comments_317055.json:
```json
{
    "body": "Attachment [benchmark_matrices.py](tarball://root/attachments/some-uuid/ticket22970/benchmark_matrices.py) by @videlec created at 2017-05-16 08:20:12\n\nFrom [attachment:benchmark_matrices.py]\n\n- echelonize: flint is better except when coefficients are huge in which case multimodular is best\n\n```\nnrows=5  ncols=5  rank=5, density=1.0000 nbits(height)=100\nflint        0.0565\nmultimodular 0.3284\npadic        0.5626\n\nnrows=10  ncols=10  rank=5, density=1.0000 nbits(height)=37\nflint        0.1063\nmultimodular 2.6420\npadic        7.6511\n\nnrows=100  ncols=100  rank=20, density=0.1799 nbits(height)=12\nflint        9.1834\nmultimodular 12.2192\npadic        74.8152\n\nnrows=10  ncols=10  rank=10, density=1.0000 nbits(height)=200\nflint        10.1606\nmultimodular 1.5586\npadic        2.1540\n```\n\n- determinant\n\n```\ndim=3 density=0.7778 nbits(height)=3\nflint        0.0092\ninteger      0.1334\npari         0.0017\n\ndim=3 density=1.0000 nbits(height)=100\nflint        0.0113\ninteger      0.1188\npari         0.0269\n\ndim=30 density=1.0000 nbits(height)=5\nflint        0.9006\ninteger      1.0754\npari         34.5452\n\ndim=30 density=0.2544 nbits(height)=5\nflint        0.4389\ninteger      0.9986\npari         179.9622\n```\n\n- charpoly\n\n```\ndim=3 density=0.7778 nbits(height)=2\nflint        0.3875\nlinbox       1.3019\ngeneric      0.0431\n\ndim=4 density=0.5625 nbits(height)=2\nflint        0.1776\nlinbox       1.2013\ngeneric      0.0450\n\ndim=5 density=0.6400 nbits(height)=2\nflint        0.1737\nlinbox       1.2952\ngeneric      0.0532\n\ndim=6 density=0.6111 nbits(height)=2\nflint        0.1850\nlinbox       1.2773\ngeneric      0.0651\n\ndim=10 density=0.4100 nbits(height)=2\nflint        0.2343\nlinbox       1.4250\ngeneric      0.1818\n\ndim=10 density=1.0000 nbits(height)=2\nflint        0.2521\nlinbox       1.4264\ngeneric      0.4842\n\ndim=30 density=1.0000 nbits(height)=2\nflint        4.8531\nlinbox       3.4320\ngeneric      50.0362\n```\n",
    "created_at": "2017-05-16T08:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317055",
    "user": "https://github.com/videlec"
}
```

Attachment [benchmark_matrices.py](tarball://root/attachments/some-uuid/ticket22970/benchmark_matrices.py) by @videlec created at 2017-05-16 08:20:12

From [attachment:benchmark_matrices.py]

- echelonize: flint is better except when coefficients are huge in which case multimodular is best

```
nrows=5  ncols=5  rank=5, density=1.0000 nbits(height)=100
flint        0.0565
multimodular 0.3284
padic        0.5626

nrows=10  ncols=10  rank=5, density=1.0000 nbits(height)=37
flint        0.1063
multimodular 2.6420
padic        7.6511

nrows=100  ncols=100  rank=20, density=0.1799 nbits(height)=12
flint        9.1834
multimodular 12.2192
padic        74.8152

nrows=10  ncols=10  rank=10, density=1.0000 nbits(height)=200
flint        10.1606
multimodular 1.5586
padic        2.1540
```

- determinant

```
dim=3 density=0.7778 nbits(height)=3
flint        0.0092
integer      0.1334
pari         0.0017

dim=3 density=1.0000 nbits(height)=100
flint        0.0113
integer      0.1188
pari         0.0269

dim=30 density=1.0000 nbits(height)=5
flint        0.9006
integer      1.0754
pari         34.5452

dim=30 density=0.2544 nbits(height)=5
flint        0.4389
integer      0.9986
pari         179.9622
```

- charpoly

```
dim=3 density=0.7778 nbits(height)=2
flint        0.3875
linbox       1.3019
generic      0.0431

dim=4 density=0.5625 nbits(height)=2
flint        0.1776
linbox       1.2013
generic      0.0450

dim=5 density=0.6400 nbits(height)=2
flint        0.1737
linbox       1.2952
generic      0.0532

dim=6 density=0.6111 nbits(height)=2
flint        0.1850
linbox       1.2773
generic      0.0651

dim=10 density=0.4100 nbits(height)=2
flint        0.2343
linbox       1.4250
generic      0.1818

dim=10 density=1.0000 nbits(height)=2
flint        0.2521
linbox       1.4264
generic      0.4842

dim=30 density=1.0000 nbits(height)=2
flint        4.8531
linbox       3.4320
generic      50.0362
```




---

archive/issue_comments_317056.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-16T09:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317057.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-16T09:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317057",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_317058.json:
```json
{
    "body": "Needs review again. I tried to make independent of the random seed the annoying doctests in sage/modular...",
    "created_at": "2017-05-16T09:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317058",
    "user": "https://github.com/videlec"
}
```

Needs review again. I tried to make independent of the random seed the annoying doctests in sage/modular...



---

archive/issue_comments_317059.json:
```json
{
    "body": "patchbot is green!! (with a weird ascii complaints)",
    "created_at": "2017-05-16T12:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317059",
    "user": "https://github.com/videlec"
}
```

patchbot is green!! (with a weird ascii complaints)



---

archive/issue_comments_317060.json:
```json
{
    "body": "On my computer, a call to\n\n```\nsage: CuspForms(101,12).hecke_matrix(3)\n```\n\n\ntakes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.\n\nMaybe the default algorithm should be changed if the entries are large?",
    "created_at": "2017-05-16T14:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317060",
    "user": "https://github.com/mmasdeu"
}
```

On my computer, a call to

```
sage: CuspForms(101,12).hecke_matrix(3)
```


takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.

Maybe the default algorithm should be changed if the entries are large?



---

archive/issue_comments_317061.json:
```json
{
    "body": "Replying to [comment:20 mmasdeu]:\n> On my computer, a call to\n> {{{\n> sage: CuspForms(101,12).hecke_matrix(3)\n> }}}\n> \n> takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.\n> \n> Maybe the default algorithm should be changed if the entries are large?\n\nI did not do proper tunings (since I will redo it after #22924 anyway). However, I can try to do something better for `echelon_form/echelonize`. Do you have other relevant examples in mind?",
    "created_at": "2017-05-16T14:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317061",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:20 mmasdeu]:
> On my computer, a call to
> {{{
> sage: CuspForms(101,12).hecke_matrix(3)
> }}}
> 
> takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.
> 
> Maybe the default algorithm should be changed if the entries are large?

I did not do proper tunings (since I will redo it after #22924 anyway). However, I can try to do something better for `echelon_form/echelonize`. Do you have other relevant examples in mind?



---

archive/issue_comments_317062.json:
```json
{
    "body": "Not at the moment. I haven't done exhaustive tests either, but it seems that in many cases the performance is similar.\n\nAs for other examples, many operations with subquotients involve doing this kind of linear algebra.",
    "created_at": "2017-05-16T15:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317062",
    "user": "https://github.com/mmasdeu"
}
```

Not at the moment. I haven't done exhaustive tests either, but it seems that in many cases the performance is similar.

As for other examples, many operations with subquotients involve doing this kind of linear algebra.



---

archive/issue_comments_317063.json:
```json
{
    "body": "Some remarks\n- flint has several algorithms for echelon form and this is not finely tuned.\n- On very specific instances, multimodular can be much faster (up to x100). This is the reason why your example `CuspForms(101,12).hecke_matrix(3)` gets slower. I have no idea how to detect such instances.\n- for `random_matrix(QQ, ...)` (ie independent entries) flint looks like to be the best option excepted in the range `10 <= nrows=ncols <= 20` where flint tuning (over Z) is very bad\n\nOne way to go might be to have a global option that controls the default behavior of the echelon form. I am thinking of something that can be used like\n\n```python\ndef my_modular_form_algorithm():\n    with rational_echelon_form('multimodular'):\n        # some relevant code here\n        ....\n```\n\nWhat do you think?",
    "created_at": "2017-05-17T08:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317063",
    "user": "https://github.com/videlec"
}
```

Some remarks
- flint has several algorithms for echelon form and this is not finely tuned.
- On very specific instances, multimodular can be much faster (up to x100). This is the reason why your example `CuspForms(101,12).hecke_matrix(3)` gets slower. I have no idea how to detect such instances.
- for `random_matrix(QQ, ...)` (ie independent entries) flint looks like to be the best option excepted in the range `10 <= nrows=ncols <= 20` where flint tuning (over Z) is very bad

One way to go might be to have a global option that controls the default behavior of the echelon form. I am thinking of something that can be used like

```python
def my_modular_form_algorithm():
    with rational_echelon_form('multimodular'):
        # some relevant code here
        ....
```

What do you think?



---

archive/issue_comments_317064.json:
```json
{
    "body": "Second option, allow the option `algorithm=my_function` where `my_function` takes a matrix as input and returns a valid algorithm for echelon form. (I do prefer this one better)\n\nEDIT: this will not work since `echelon_form` is **indirectly** called in modular function algorithms...",
    "created_at": "2017-05-17T08:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317064",
    "user": "https://github.com/videlec"
}
```

Second option, allow the option `algorithm=my_function` where `my_function` takes a matrix as input and returns a valid algorithm for echelon form. (I do prefer this one better)

EDIT: this will not work since `echelon_form` is **indirectly** called in modular function algorithms...



---

archive/issue_comments_317065.json:
```json
{
    "body": "Implementing the idea from [comment:23 comment:23] I got\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 7.52 s, sys: 63.3 ms, total: 7.59 s\nWall time: 7.55 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 2min 13s, sys: 203 ms, total: 2min 13s\nWall time: 2min 13s\n\nsage: %time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 5min 10s, sys: 663 ms, total: 5min 10s\nWall time: 5min 10s\n```\n\nagainst the following in develop\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 13.5 s, sys: 43.3 ms, total: 13.6 s\nWall time: 13.5 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 3min 8s, sys: 250 ms, total: 3min 9s\nWall time: 3min 9s\n\n%time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 8min 7s, sys: 527 ms, total: 8min 8s\nWall time: 8min 8s\n```\n\n(so close to x2 improvement)\n\nI propose to postpone this improvement to another ticket since this one is already a big change. If you agree I will open a new one and work on it as soon as this one is closed.",
    "created_at": "2017-05-17T09:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317065",
    "user": "https://github.com/videlec"
}
```

Implementing the idea from [comment:23 comment:23] I got

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 7.52 s, sys: 63.3 ms, total: 7.59 s
Wall time: 7.55 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 13s, sys: 203 ms, total: 2min 13s
Wall time: 2min 13s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 5min 10s, sys: 663 ms, total: 5min 10s
Wall time: 5min 10s
```

against the following in develop

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 13.5 s, sys: 43.3 ms, total: 13.6 s
Wall time: 13.5 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 3min 8s, sys: 250 ms, total: 3min 9s
Wall time: 3min 9s

%time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 8min 7s, sys: 527 ms, total: 8min 8s
Wall time: 8min 8s
```

(so close to x2 improvement)

I propose to postpone this improvement to another ticket since this one is already a big change. If you agree I will open a new one and work on it as soon as this one is closed.



---

archive/issue_comments_317066.json:
```json
{
    "body": "1) I agree that this can be dealt with in another ticket, but it is moderately urgent. ModularSymbols / ModularForms becoming twice slower than currently is not good news...\n\nAnother example of a reasonable calculation: with the Sage 7.5.1 the following calculation takes 22 seconds on my laptop. It takes 1min22s (!) with the proposed patch.\n\n```\nsage: %time A = ModularSymbols(11,60).hecke_matrix(3)\n```\n\n\n2) While reviewing, in `sage/modular/hecke/module.py` there is a doctest that changed in a suspicious way. It seems that a number field was created with a different generator and that causes the output to look different. I propose that the line that causes trouble gets changed into\n\n```\nsage: [o.minpoly() for o in A.system_of_eigenvalues(3)]\n[x - 1, x + 1, x^2 - 2*x - 2]\n```\n\n\nThe output that appears should not depend on the implementation.\n\n3) There seems to be quite a mess on what are the acceptable values to the 'algorithm' parameter. Maybe it's a good time to change that! My suggestion would be that the default would always be None, and then the docstring would specify what is done in this case.",
    "created_at": "2017-05-18T11:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317066",
    "user": "https://github.com/mmasdeu"
}
```

1) I agree that this can be dealt with in another ticket, but it is moderately urgent. ModularSymbols / ModularForms becoming twice slower than currently is not good news...

Another example of a reasonable calculation: with the Sage 7.5.1 the following calculation takes 22 seconds on my laptop. It takes 1min22s (!) with the proposed patch.

```
sage: %time A = ModularSymbols(11,60).hecke_matrix(3)
```


2) While reviewing, in `sage/modular/hecke/module.py` there is a doctest that changed in a suspicious way. It seems that a number field was created with a different generator and that causes the output to look different. I propose that the line that causes trouble gets changed into

```
sage: [o.minpoly() for o in A.system_of_eigenvalues(3)]
[x - 1, x + 1, x^2 - 2*x - 2]
```


The output that appears should not depend on the implementation.

3) There seems to be quite a mess on what are the acceptable values to the 'algorithm' parameter. Maybe it's a good time to change that! My suggestion would be that the default would always be None, and then the docstring would specify what is done in this case.



---

archive/issue_comments_317067.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-18T11:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317067",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_317068.json:
```json
{
    "body": "I might have an explanation for why Flint is slow for these modular symbol matrices. See:\n\nhttps://github.com/wbhart/flint2/issues/335\n\nIt can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.",
    "created_at": "2017-05-18T16:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317068",
    "user": "https://github.com/fredrik-johansson"
}
```

I might have an explanation for why Flint is slow for these modular symbol matrices. See:

https://github.com/wbhart/flint2/issues/335

It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.



---

archive/issue_comments_317069.json:
```json
{
    "body": "Replying to [comment:27 fredrik.johansson]:\n> I might have an explanation for why Flint is slow for these modular symbol matrices. See:\n> \n> https://github.com/wbhart/flint2/issues/335\n> \n> It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.\n\nWould be tremendous!",
    "created_at": "2017-05-18T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317069",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:27 fredrik.johansson]:
> I might have an explanation for why Flint is slow for these modular symbol matrices. See:
> 
> https://github.com/wbhart/flint2/issues/335
> 
> It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.

Would be tremendous!



---

archive/issue_comments_317070.json:
```json
{
    "body": "`@`mmasdeu: for the sake of this ticket I will set the default to `multimodular` that should actually speed up all modular symbol computations. Then #23026 will deal with making flint the default (that is much faster on random instances).",
    "created_at": "2017-05-18T16:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317070",
    "user": "https://github.com/videlec"
}
```

`@`mmasdeu: for the sake of this ticket I will set the default to `multimodular` that should actually speed up all modular symbol computations. Then #23026 will deal with making flint the default (that is much faster on random instances).



---

archive/issue_comments_317071.json:
```json
{
    "body": "That sounds reasonable...at least there is no regression in speed (hopefully!).",
    "created_at": "2017-05-18T16:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317071",
    "user": "https://github.com/mmasdeu"
}
```

That sounds reasonable...at least there is no regression in speed (hopefully!).



---

archive/issue_comments_317072.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-18T17:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317073.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-18T18:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317074.json:
```json
{
    "body": "at commit b5f5600 I got\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 11.7 s, sys: 40 ms, total: 11.7 s\nWall time: 11.7 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 2min 52s, sys: 283 ms, total: 2min 52s\nWall time: 2min 52s\n\nsage: %time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 7min 17s, sys: 620 ms, total: 7min 18s\nWall time: 7min 18s\n```\n\n\nand at 5f2e1ba the even better\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 7.5 s, sys: 36.7 ms, total: 7.53 s\nWall time: 7.51 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 2min 10s, sys: 223 ms, total: 2min 10s\nWall time: 2min 10s\n\nsage: %time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 5min 9s, sys: 603 ms, total: 5min 10s\nWall time: 5min 10s\n```\n",
    "created_at": "2017-05-18T18:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317074",
    "user": "https://github.com/videlec"
}
```

at commit b5f5600 I got

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 11.7 s, sys: 40 ms, total: 11.7 s
Wall time: 11.7 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 52s, sys: 283 ms, total: 2min 52s
Wall time: 2min 52s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 7min 17s, sys: 620 ms, total: 7min 18s
Wall time: 7min 18s
```


and at 5f2e1ba the even better

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 7.5 s, sys: 36.7 ms, total: 7.53 s
Wall time: 7.51 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 10s, sys: 223 ms, total: 2min 10s
Wall time: 2min 10s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 5min 9s, sys: 603 ms, total: 5min 10s
Wall time: 5min 10s
```




---

archive/issue_comments_317075.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-18T18:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317075",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_317076.json:
```json
{
    "body": "And tests also pass on beta7!",
    "created_at": "2017-05-19T12:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317076",
    "user": "https://github.com/videlec"
}
```

And tests also pass on beta7!



---

archive/issue_comments_317077.json:
```json
{
    "body": "This is definitely more than satisfying. The code looks very clean, and all tests pass. Thanks for the great work!",
    "created_at": "2017-05-21T16:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317077",
    "user": "https://github.com/mmasdeu"
}
```

This is definitely more than satisfying. The code looks very clean, and all tests pass. Thanks for the great work!



---

archive/issue_comments_317078.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-21T16:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317078",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_317079.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2017-05-22T22:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317079",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_317080.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-05-22T22:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317080",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_317081.json:
```json
{
    "body": "Too bad. The code is fine on beta7. Can I try to fix it by merging another ticket?",
    "created_at": "2017-05-23T06:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317081",
    "user": "https://github.com/videlec"
}
```

Too bad. The code is fine on beta7. Can I try to fix it by merging another ticket?



---

archive/issue_comments_317082.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-05-29T13:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317082",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_317083.json:
```json
{
    "body": "rebased (I launched the patchbot)",
    "created_at": "2017-05-29T13:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317083",
    "user": "https://github.com/videlec"
}
```

rebased (I launched the patchbot)



---

archive/issue_comments_317084.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-29T13:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317084",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_317085.json:
```json
{
    "body": "patchbot still happy!",
    "created_at": "2017-05-29T22:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317085",
    "user": "https://github.com/videlec"
}
```

patchbot still happy!



---

archive/issue_comments_317086.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-29T22:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317086",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_317087.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-31T22:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22733#issuecomment-317087",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_021368.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2017-05-31T22:25:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22733",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22733#event-21368"
}
```
