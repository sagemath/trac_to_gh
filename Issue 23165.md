# Issue 23165: faster hash of number field elements

archive/issues_023165.json:
```json
{
    "body": "CC:  @bhutz\n\nHashing of nf element go through `self.polynomial()` which is damn slow!\n\nIssue created by migration from https://trac.sagemath.org/ticket/23402\n\n",
    "created_at": "2017-07-11T13:58:58Z",
    "labels": [
        "number fields",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "faster hash of number field elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23165",
    "user": "@videlec"
}
```
CC:  @bhutz

Hashing of nf element go through `self.polynomial()` which is damn slow!

Issue created by migration from https://trac.sagemath.org/ticket/23402





---

archive/issue_comments_323960.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-07-13T17:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323960",
    "user": "@videlec"
}
```

New commits:



---

archive/issue_comments_323961.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-13T17:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323961",
    "user": "@videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_323962.json:
```json
{
    "body": "Where did the two magic numbers come from? Also, why is one is hex and the other in decimal?",
    "created_at": "2017-07-14T00:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323962",
    "user": "@tscrim"
}
```

Where did the two magic numbers come from? Also, why is one is hex and the other in decimal?



---

archive/issue_comments_323963.json:
```json
{
    "body": "These \"magic numbers\" are just used to randomize the bits and can be obtained via\n\n```\nsage: phi = (1 + sqrt(5))/2\nsage: hex(int(2^32 / phi))\n'0x9e3779b9'\nsage: int(phi * 2^62)\n7461864723258187525\n```\n\nThe `7461864723258187525` was not chosen by me but comes from the hash value of rationals...\n\nI can actually be more coherent and use the same value in both places.",
    "created_at": "2017-07-14T13:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323963",
    "user": "@videlec"
}
```

These "magic numbers" are just used to randomize the bits and can be obtained via

```
sage: phi = (1 + sqrt(5))/2
sage: hex(int(2^32 / phi))
'0x9e3779b9'
sage: int(phi * 2^62)
7461864723258187525
```

The `7461864723258187525` was not chosen by me but comes from the hash value of rationals...

I can actually be more coherent and use the same value in both places.



---

archive/issue_comments_323964.json:
```json
{
    "body": "... bad idea (got stupid collisions)",
    "created_at": "2017-07-14T13:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323964",
    "user": "@videlec"
}
```

... bad idea (got stupid collisions)



---

archive/issue_comments_323965.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-14T13:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323965",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_323966.json:
```json
{
    "body": "More coherent version in `8124ba5` where both values are:\n- 63 bits\n- documented\n- in decimal notation",
    "created_at": "2017-07-14T13:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323966",
    "user": "@videlec"
}
```

More coherent version in `8124ba5` where both values are:
- 63 bits
- documented
- in decimal notation



---

archive/issue_comments_323967.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-14T13:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323967",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_323968.json:
```json
{
    "body": "Okay, thanks. LGTM.",
    "created_at": "2017-07-14T14:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323968",
    "user": "@tscrim"
}
```

Okay, thanks. LGTM.



---

archive/issue_comments_323969.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-14T14:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323969",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_323970.json:
```json
{
    "body": "Changing the hash is changing the order of display in sets... some doctests break.",
    "created_at": "2017-07-20T10:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323970",
    "user": "@videlec"
}
```

Changing the hash is changing the order of display in sets... some doctests break.



---

archive/issue_comments_323971.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-07-20T10:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323971",
    "user": "@videlec"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_323972.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-20T13:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323972",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323973.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-20T13:23:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323973",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_323974.json:
```json
{
    "body": "Now tests do pass.",
    "created_at": "2017-07-20T15:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323974",
    "user": "@videlec"
}
```

Now tests do pass.



---

archive/issue_comments_323975.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-20T15:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323975",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323976.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-20T22:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323976",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_323977.json:
```json
{
    "body": "Fails on 32-bit:\n\n```\nsage -t --long src/sage/rings/number_field/number_field_element.pyx\n**********************************************************************\nFile \"src/sage/rings/number_field/number_field_element.pyx\", line 2888, in sage.rings.number_field.number_field_element.NumberFieldElement.__hash__\nFailed example:\n    len(set(map(hash, elts))) == len(elts)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of   9 in sage.rings.number_field.number_field_element.NumberFieldElement.__hash__\n    [1084 tests, 1 failure, 827.34 s]\n```\n",
    "created_at": "2017-07-26T22:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323977",
    "user": "@vbraun"
}
```

Fails on 32-bit:

```
sage -t --long src/sage/rings/number_field/number_field_element.pyx
**********************************************************************
File "src/sage/rings/number_field/number_field_element.pyx", line 2888, in sage.rings.number_field.number_field_element.NumberFieldElement.__hash__
Failed example:
    len(set(map(hash, elts))) == len(elts)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   9 in sage.rings.number_field.number_field_element.NumberFieldElement.__hash__
    [1084 tests, 1 failure, 827.34 s]
```




---

archive/issue_comments_323978.json:
```json
{
    "body": "Indeed... 3 collisions in 32 bits! Probabilistically, we should not see any collision before a sample of size 2<sup>16</sup> = sqrt(2<sup>32</sup>).",
    "created_at": "2017-07-27T12:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323978",
    "user": "@videlec"
}
```

Indeed... 3 collisions in 32 bits! Probabilistically, we should not see any collision before a sample of size 2<sup>16</sup> = sqrt(2<sup>32</sup>).



---

archive/issue_comments_323979.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-07-27T13:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323979",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_323980.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-07-27T13:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323980",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_323981.json:
```json
{
    "body": "needs review (no collision on the 18 first bits which is more than enough for 32 bits)",
    "created_at": "2017-07-27T13:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323981",
    "user": "@videlec"
}
```

needs review (no collision on the 18 first bits which is more than enough for 32 bits)



---

archive/issue_comments_323982.json:
```json
{
    "body": "Doctest order failures due to the new hash. See patchbot report.",
    "created_at": "2017-07-27T15:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323982",
    "user": "@tscrim"
}
```

Doctest order failures due to the new hash. See patchbot report.



---

archive/issue_comments_323983.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-27T15:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323983",
    "user": "@tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_323984.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-08-23T23:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323984",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_323985.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-08-23T23:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323985",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323986.json:
```json
{
    "body": "(rebased with a new commit to fix the doctests)",
    "created_at": "2017-08-23T23:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323986",
    "user": "@videlec"
}
```

(rebased with a new commit to fix the doctests)



---

archive/issue_comments_323987.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-24T02:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323987",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323988.json:
```json
{
    "body": "The second doctest change in `8d8a2ea708` looks fishy. Actually, the version after my changes looks better!!",
    "created_at": "2017-08-24T02:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323988",
    "user": "@videlec"
}
```

The second doctest change in `8d8a2ea708` looks fishy. Actually, the version after my changes looks better!!



---

archive/issue_comments_323989.json:
```json
{
    "body": "`@`bhutz: Ben can you have a look at the doctest change in `invariants_of_degree`? The first change just a reordering. But the second one reproduced below looks like there was something very wrong before\n\n```diff\n             sage: S3 = MatrixGroup(SymmetricGroup(3))\n             sage: chi = S3.character(S3.character_table()[0])\n             sage: S3.invariants_of_degree(5, chi=chi)\n-            [x*y + (2*izeta3^3 + 3*izeta3^2 + 8*izeta3 + 3)*x*z + (-2*izeta3^3 -\n-            3*izeta3^2 - 8*izeta3 - 4)*y*z,\n-             x^2 + (-2*izeta3^3 - 3*izeta3^2 - 8*izeta3 - 4)*y^2 + (2*izeta3^3 +\n-            3*izeta3^2 + 8*izeta3 + 3)*z^2]\n+            [x0^4*x1 - x0*x1^4 - x0^4*x2 + x1^4*x2 + x0*x2^4 - x1*x2^4,\n+             x0^3*x1^2 - x0^2*x1^3 - x0^3*x2^2 + x1^3*x2^2 + x0^2*x2^3 - x1^2*x2^3]\n```\n",
    "created_at": "2017-08-24T02:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323989",
    "user": "@videlec"
}
```

`@`bhutz: Ben can you have a look at the doctest change in `invariants_of_degree`? The first change just a reordering. But the second one reproduced below looks like there was something very wrong before

```diff
             sage: S3 = MatrixGroup(SymmetricGroup(3))
             sage: chi = S3.character(S3.character_table()[0])
             sage: S3.invariants_of_degree(5, chi=chi)
-            [x*y + (2*izeta3^3 + 3*izeta3^2 + 8*izeta3 + 3)*x*z + (-2*izeta3^3 -
-            3*izeta3^2 - 8*izeta3 - 4)*y*z,
-             x^2 + (-2*izeta3^3 - 3*izeta3^2 - 8*izeta3 - 4)*y^2 + (2*izeta3^3 +
-            3*izeta3^2 + 8*izeta3 + 3)*z^2]
+            [x0^4*x1 - x0*x1^4 - x0^4*x2 + x1^4*x2 + x0*x2^4 - x1*x2^4,
+             x0^3*x1^2 - x0^2*x1^3 - x0^3*x2^2 + x1^3*x2^2 + x0^2*x2^3 - x1^2*x2^3]
```




---

archive/issue_comments_323990.json:
```json
{
    "body": "Actually, it looks like you messed up the doc test in commit 4f26871 and are now changing it back in commit 8d8a2ea.\n\nSo I see nothing wrong here with the invariants code.",
    "created_at": "2017-08-24T11:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323990",
    "user": "@bhutz"
}
```

Actually, it looks like you messed up the doc test in commit 4f26871 and are now changing it back in commit 8d8a2ea.

So I see nothing wrong here with the invariants code.



---

archive/issue_comments_323991.json:
```json
{
    "body": "Replying to [comment:26 bhutz]:\n> Actually, it looks like you messed up the doc test in commit 4f26871 and are now changing it back in commit 8d8a2ea.\n> \n> So I see nothing wrong here with the invariants code.\n\nMy bad. Thanks for having a look!",
    "created_at": "2017-08-24T12:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323991",
    "user": "@videlec"
}
```

Replying to [comment:26 bhutz]:
> Actually, it looks like you messed up the doc test in commit 4f26871 and are now changing it back in commit 8d8a2ea.
> 
> So I see nothing wrong here with the invariants code.

My bad. Thanks for having a look!



---

archive/issue_comments_323992.json:
```json
{
    "body": "Changing keywords from \"\" to \"days88, IMA coding sprints\".",
    "created_at": "2017-08-24T14:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323992",
    "user": "@tscrim"
}
```

Changing keywords from "" to "days88, IMA coding sprints".



---

archive/issue_comments_323993.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-24T14:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323993",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_323994.json:
```json
{
    "body": "Thanks.\n\nLGTM.",
    "created_at": "2017-08-24T14:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323994",
    "user": "@tscrim"
}
```

Thanks.

LGTM.



---

archive/issue_comments_323995.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-29T19:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23165",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23165#issuecomment-323995",
    "user": "@vbraun"
}
```

Resolution: fixed
