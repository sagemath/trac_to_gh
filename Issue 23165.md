# Issue 23165: faster hash of number field elements

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2017-07-11 13:58:58

CC:  bhutz

Hashing of nf element go through `self.polynomial()` which is damn slow!


---

Comment by vdelecroix created at 2017-07-13 17:22:19

New commits:


---

Comment by vdelecroix created at 2017-07-13 17:22:19

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-07-14 00:03:10

Where did the two magic numbers come from? Also, why is one is hex and the other in decimal?


---

Comment by vdelecroix created at 2017-07-14 13:28:47

These "magic numbers" are just used to randomize the bits and can be obtained via

```
sage: phi = (1 + sqrt(5))/2
sage: hex(int(2^32 / phi))
'0x9e3779b9'
sage: int(phi * 2^62)
7461864723258187525
```

The `7461864723258187525` was not chosen by me but comes from the hash value of rationals...

I can actually be more coherent and use the same value in both places.


---

Comment by vdelecroix created at 2017-07-14 13:36:31

... bad idea (got stupid collisions)


---

Comment by git created at 2017-07-14 13:36:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-07-14 13:38:06

More coherent version in `8124ba5` where both values are:
 - 63 bits
 - documented
 - in decimal notation


---

Comment by git created at 2017-07-14 13:40:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-07-14 14:35:30

Okay, thanks. LGTM.


---

Comment by tscrim created at 2017-07-14 14:35:30

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-07-20 10:07:47

Changing the hash is changing the order of display in sets... some doctests break.


---

Comment by vdelecroix created at 2017-07-20 10:07:47

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-07-20 13:22:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 13:23:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-07-20 15:21:34

Now tests do pass.


---

Comment by vdelecroix created at 2017-07-20 15:21:34

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-07-20 22:20:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-07-26 22:10:36

Fails on 32-bit:

```
sage -t --long src/sage/rings/number_field/number_field_element.pyx
**********************************************************************
File "src/sage/rings/number_field/number_field_element.pyx", line 2888, in sage.rings.number_field.number_field_element.NumberFieldElement.__hash__
Failed example:
    len(set(map(hash, elts))) == len(elts)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   9 in sage.rings.number_field.number_field_element.NumberFieldElement.__hash__
    [1084 tests, 1 failure, 827.34 s]
```



---

Comment by vdelecroix created at 2017-07-27 12:19:58

Indeed... 3 collisions in 32 bits! Probabilistically, we should not see any collision before a sample of size 2<sup>16</sup> = sqrt(2<sup>32</sup>).


---

Comment by git created at 2017-07-27 13:16:22

Changing status from positive_review to needs_review.


---

Comment by git created at 2017-07-27 13:16:22

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by vdelecroix created at 2017-07-27 13:18:16

needs review (no collision on the 18 first bits which is more than enough for 32 bits)


---

Comment by tscrim created at 2017-07-27 15:44:33

Doctest order failures due to the new hash. See patchbot report.


---

Comment by tscrim created at 2017-07-27 15:44:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-23 23:47:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-08-23 23:48:40

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-08-23 23:48:40

(rebased with a new commit to fix the doctests)


---

Comment by git created at 2017-08-24 02:32:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-08-24 02:33:01

The second doctest change in `8d8a2ea708` looks fishy. Actually, the version after my changes looks better!!


---

Comment by vdelecroix created at 2017-08-24 02:36:31

`@`bhutz: Ben can you have a look at the doctest change in `invariants_of_degree`? The first change just a reordering. But the second one reproduced below looks like there was something very wrong before

```diff
             sage: S3 = MatrixGroup(SymmetricGroup(3))
             sage: chi = S3.character(S3.character_table()[0])
             sage: S3.invariants_of_degree(5, chi=chi)
-            [x*y + (2*izeta3^3 + 3*izeta3^2 + 8*izeta3 + 3)*x*z + (-2*izeta3^3 -
-            3*izeta3^2 - 8*izeta3 - 4)*y*z,
-             x^2 + (-2*izeta3^3 - 3*izeta3^2 - 8*izeta3 - 4)*y^2 + (2*izeta3^3 +
-            3*izeta3^2 + 8*izeta3 + 3)*z^2]
+            [x0^4*x1 - x0*x1^4 - x0^4*x2 + x1^4*x2 + x0*x2^4 - x1*x2^4,
+             x0^3*x1^2 - x0^2*x1^3 - x0^3*x2^2 + x1^3*x2^2 + x0^2*x2^3 - x1^2*x2^3]
```



---

Comment by bhutz created at 2017-08-24 11:58:32

Actually, it looks like you messed up the doc test in commit 4f26871 and are now changing it back in commit 8d8a2ea.

So I see nothing wrong here with the invariants code.


---

Comment by vdelecroix created at 2017-08-24 12:57:48

Replying to [comment:26 bhutz]:
> Actually, it looks like you messed up the doc test in commit 4f26871 and are now changing it back in commit 8d8a2ea.
> 
> So I see nothing wrong here with the invariants code.

My bad. Thanks for having a look!


---

Comment by tscrim created at 2017-08-24 14:14:53

Changing keywords from "" to "days88, IMA coding sprints".


---

Comment by tscrim created at 2017-08-24 14:14:53

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-08-24 14:14:53

Thanks.

LGTM.


---

Comment by vbraun created at 2017-08-29 19:50:58

Resolution: fixed
