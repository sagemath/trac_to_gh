# Issue 21030: Port SageNB widgets/interact to Jupyter

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-08-17 15:54:10

CC:  charpent

Support old SageNB widgets in Jupyter notebooks. This is done by writing small wrapper functions with the old SageNB names returning `ipywidgets` widgets. That is, we essentially do

```
def input_box(...):
    return ipywidgets.Text(...)
```


We also try to support the old SageNB ``@`interact` functionality. Many examples of SageNB interacts can be found on https://wiki.sagemath.org/interact and we try to support as much as possible in Jupyter without changes in the user code.


---

Comment by vbraun created at 2016-08-17 20:11:54

Are there any API conflicts? And if yes, how are we dealing with that? Separate ``@`jupyterinteract` or what? A global switch?


---

Comment by jdemeyer created at 2016-08-17 21:02:25

Replying to [comment:1 vbraun]:
> Are there any API conflicts?

At least, the API is mostly compatible. I don't know any case where SageNB and Jupyter have significantly different behaviour. For the things that SageNB supports but Jupyter does not, either drop support for that feature or work with upstream to implement the feature in Jupyter. I don't strive to achieve 100% compatibility, I'm happy if it mostly works.

In some cases, the visual presentation might be different (Jupyter using a drop-down box while SageNB uses something like radio buttons). I don't care about that.

One potential issue is that SageNB supports all kinds of numbers (`Integer`, `RealNumber`, `Rational`, ...) for sliders while Jupyter only supports `int` and `float`.


---

Comment by git created at 2016-09-19 16:22:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by kcrisman created at 2016-09-20 01:34:02

WOW how did I not know about this ticket!


---

Comment by jdemeyer created at 2016-09-20 06:24:27

Replying to [comment:5 kcrisman]:
> WOW how did I not know about this ticket!  

I'll let you know when I need testers.


---

Comment by charpent created at 2016-09-20 14:21:32

I [posted](https://groups.google.com/forum/#!topic/sage-support/r7XTZ8EIiZs) a temporary workaround for people wanting interactive graphs in Jupyter notebooks using the Sage kernel.


---

Comment by jdemeyer created at 2016-09-20 14:38:42

For the record, I consider this branch mostly feature-complete. It still lacks documentation and tests and the required changes to the `ipywidgets` package.

I have not decided what to do with the upstream situation. There are 3 options:
- add a whole lot of patches to `build/pkgs/ipywidgets`
- package the upstream `master` branch
- wait for `ipywidgets-6` to be released


---

Comment by git created at 2016-09-20 15:23:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2016-09-21 00:16:46

Replying to [comment:2 jdemeyer]:
> ... I don't strive to achieve 100% compatibility, I'm happy if it mostly works.

I say that it is quite important to work towards such a goal for all interfaces: SageNB, Jupyter, SageMathCloud, SageMathCell. It is highly annoying to develop a nice interact and then discover that it does not work with another interface. Perhaps SageNB can be left behind now, but I hope that other 3 can converge to a single documented standard...


---

Comment by jdemeyer created at 2016-09-21 07:23:18

Replying to [comment:11 novoselt]:
> I say that it is quite important to work towards such a goal for all interfaces: SageNB, Jupyter, SageMathCloud, SageMathCell. It is highly annoying to develop a nice interact and then discover that it does not work with another interface. Perhaps SageNB can be left behind now, but I hope that other 3 can converge to a single documented standard...

I agree that we should _work towards such a goal_ but some things are not so easy at the moment. In particular, this patch is re-using the existing widgets from `ipywidgets`, it doesn't add completely new widgets (it doesn't change any Javascript). For example, `ipywidgets` doesn't have a slider with rational numbers so we cannot have that. Luckily, this can be emulated by a slider taking an arbitrary list of values. But this trick does not work for a `range_slider`, so a `range_slider` with rational numbers is not supported here.


---

Comment by jdemeyer created at 2016-09-21 08:28:22

IMHO, sliders behave strangely in SageNB:

```
`@`interact
def f(x=(1, 10)):
    print(x, parent(x))
```

This gives a slider with floating-point values between 1 and 10. In `ipywidgets`, this would become a slider with integer values between 1 and 10. I think that the `ipywidgets` convention makes more sense here: the type of the variable should correspond to the type in the interact abbrevation (`x=(1, 10)` gives integers while `x=(1.0, 10.0)` gives floats).

On top of this, this gives Python `float`s while in a Sage context, an element of `RR` would be more appropriate.


---

Comment by git created at 2016-09-21 09:30:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-21 09:31:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-09-21 12:03:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-09-23 10:51:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-02 20:53:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-03 15:51:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-05 16:56:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-06 16:02:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by charpent created at 2017-01-17 13:25:20

Replying to [comment:30 jdemeyer]:

Is this upgrade ready for review ? Or do you need any form of help before formal review ?


---

Comment by jdemeyer created at 2017-01-17 17:58:25

Essentially yes, it's ready.

I didn't formally set the ticket to needs_review because I'd like to wait until the stable release of `ipywidgets` is released.


---

Comment by git created at 2017-01-19 15:43:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-21 19:39:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-31 08:57:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-02-24 10:20:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-02-24 11:49:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-02-24 15:19:49

Changing status from new to needs_review.


---

Comment by charpent created at 2017-02-24 20:08:01

starting with  a freshly fetched 7.6.beta4, ` make distclean && make ptestlong ` passes with one well-known-failure :

```
----------------------------------------------------------------------
sage -t --long src/sage/homology/simplicial_complex.py  # 1 doctest failed
----------------------------------------------------------------------
```


which passes when ran standalone.

A couple warnings are repeated in `widgetsnbextension-2.0.0rc1.log` and `ipywidgets-6.0.0.rc2.log` :

```
/usr/local/sage-exp/local/lib/python2.7/site-packages/setuptools/dist.py:285: UserWarning: Normalizing '2.0.0.rc1' to '2.0.0rc1'
warning: manifest_maker: standard file '-c' not found
/usr/local/sage-exp/local/lib/python2.7/site-packages/setuptools/dist.py:285: UserWarning: Normalizing '6.0.0.rc2' to '6.0.0rc2'
```


which look like innocuous booboos.

==> `positive_review `

For the record : congratulations for this intricate, lengthy and much expected patch. Thank you very much !

I'd recommend expedited inclusion of this update, which should go a long way making the Jupyter notebook as functional as the old one.

I plan to merge this one in my current working branch (which includes #20523 an its dependencies) and give it a couple "real-life" functional tests. But unless the results turns out to be non- or barely-functional (which would surprise me), further enhancements should go towards a new ticket.


---

Comment by charpent created at 2017-02-24 20:08:01

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2017-02-24 21:07:24

Damn !

from the PREP tutorial "Sage Interact Quickstart" :

```
sage: `@`interact
sage: def _(f=input_box(x^2,width=20),
....: color=color_selector(widget='colorpicker', label=""),
....: axes=True,
....: fill=True,
....: zoom=range_slider(-3,3,default=(-3,3))):
....:     show(plot(f,(x,zoom[0], zoom[1]), color=color, axes=axes,fill=fill, figsize=3))
```

(I added the `figsize=3`)

gives a **static** fgure, with no controls. I see that in the terminal windows from where I launched the notebook :

```
[IPKernelApp] WARNING | The installed widget Javascript is the wrong version. It must satisfy the semver range ~2.1.0.
```

One hidden dependency ? Something to document (in plain English...) ? 

Or something more serious ?

BTW : this works well in the old Sage notebook (same binary, ran from another terminal...).


---

Comment by charpent created at 2017-02-24 21:07:24

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-02-25 07:49:28

Replying to [comment:47 charpent]:
> Damn !
> 
> from the PREP tutorial "Sage Interact Quickstart" :
> {{{
> sage: `@`interact
> sage: def _(f=input_box(x^2,width=20),
> ....: color=color_selector(widget='colorpicker', label=""),
> ....: axes=True,
> ....: fill=True,
> ....: zoom=range_slider(-3,3,default=(-3,3))):
> ....:     show(plot(f,(x,zoom[0], zoom[1]), color=color, axes=axes,fill=fill, figsize=3))
> }}}
> (I added the `figsize=3`)
> 
> gives a **static** fgure, with no controls. I see that in the terminal windows from where I launched the notebook :
> {{{
> [IPKernelApp] WARNING | The installed widget Javascript is the wrong version. It must satisfy the semver range ~2.1.0.
> }}}
> One hidden dependency ? Something to document (in plain English...) ?

Your example works for me. My guess is that it's something like a browser cache which might interfere. Can you try clearing the cache and try again?


---

Comment by charpent created at 2017-02-25 09:14:52

Replying to [comment:48 jdemeyer]:
> Replying to [comment:47 charpent]:
[ Snip ...]
> Your example works for me. My guess is that it's something like a browser cache which might 
interfere. Can you try clearing the cache and try again?

Done. Same result.

I might have another problem : when I type "SAGE_BROWSER=chromium sage -n jupyter", Sage still opens a Firefox sheet.

Logging out of this sheet, manually opening Chromium, and pasting the address given in the controlling terminal window allows to open the same sheet in Chrome, with the **same** result.

Suggestions ?


---

Comment by charpent created at 2017-02-25 09:49:54

One more data point : same results (incl. Firefox starting with SAGE_BROWSER="chromium") after rebooting ths whole hawg...

I'm at loss.


---

Comment by jdemeyer created at 2017-02-25 19:57:23

Replying to [comment:49 charpent]:
> Suggestions ?

This is most likely not Sage-related, so please report this issue upstream to ipywidgets: 
https://github.com/ipython/ipywidgets/issues


---

Comment by charpent created at 2017-02-25 20:24:44

Replying to [comment:51 jdemeyer]:
> Replying to [comment:49 charpent]:
> > Suggestions ?
> 
> This is most likely not Sage-related, so please report this issue upstream to ipywidgets: 
> https://github.com/ipython/ipywidgets/issues

This is now ipywidget's [issue 1611](https://github.com/ipython/ipywidgets/issues/1161).


---

Comment by git created at 2017-02-27 10:41:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-02-28 10:58:02

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-02-28 10:58:02

Replying to [comment:47 charpent]:
> {{{
> [IPKernelApp] WARNING | The installed widget Javascript is the wrong version. It must satisfy the semver range ~2.1.0.
> }}}

Do you happen to have another installation of `ipywidgets`/`widgetsnbextension` which might interfere?

I'm setting this back to needs_review because I cannot reproduce your problem. I hope that other people will try it, so we can see if it works for them.


---

Comment by charpent created at 2017-03-01 08:59:27

I tried your patch on two different installations (one physical machine, one pristine VM) where it succeeded. Coming back to my initial test case, I took the speps to remove entierely ipywidgets an widgetsnbextension from the systemwide installs. Theren your patch worked.

I conclude that, somehow, the systemwide installation(s) of Python extensions take precedence over a sage-specific installation. hence a couple questions :
* Is that expected or is that a bug ?
* If a bug, does it deserve a ticket ?
* If expected (not a bug), shouldn't this behavior be documented ?

In any case, This lifts my objections ==> `positive_review`.

And kudos !


---

Comment by charpent created at 2017-03-01 08:59:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-03-01 09:04:31

Upstream is aware of issues with conflicting installations. In fact that's why I made the suggestion in [comment:55] to check other installations.


---

Comment by vbraun created at 2017-03-02 17:43:53

Resolution: fixed


---

Comment by fbissey created at 2017-03-02 21:25:20

`@` Jeroen: quick question, I notice you have added two patches for `ipywidgets`. Are those upstreamed? If so can you give some references?


---

Comment by jdemeyer created at 2017-03-03 06:46:01

Replying to [comment:59 fbissey]:
> `@` Jeroen: quick question, I notice you have added two patches for `ipywidgets`.

Actually, there are 3 patches. Two of them (`get_interact_value_output.patch` and `output_exception.patch`) should be in https://pypi.python.org/pypi/ipywidgets/6.0.0.rc3

The other one (`widget_repr.patch`) is being discussed at https://github.com/ipython/ipywidgets/pull/1031 but upstream isn't very happy about it. However, this one is really only relevant for doctesting, not for runtime functionality.


---

Comment by fbissey created at 2017-03-03 06:50:06

Replying to [comment:60 jdemeyer]:
> Replying to [comment:59 fbissey]:
> > `@` Jeroen: quick question, I notice you have added two patches for `ipywidgets`.
> 
> Actually, there are 3 patches. Two of them (`get_interact_value_output.patch` and `output_exception.patch`) should be in https://pypi.python.org/pypi/ipywidgets/6.0.0.rc3
> 

OK, good!

> The other one (`widget_repr.patch`) is being discussed at https://github.com/ipython/ipywidgets/pull/1031 but upstream isn't very happy about it. However, this one is really only relevant for doctesting, not for runtime functionality.

OK, I missed that one completely, I suppose that is why I have 

```
File "/usr/lib64/python2.7/site-packages/sage/repl/ipython_kernel/widgets.py", line 349, in sage.repl.ipython_kernel.widgets.Grid.__init__
Failed example:
    w
Expected:
    Grid(value=[[0, 1], [4, 5]], description=u'2x2 matrix', children=(Label(value=u'2x2 matrix'), VBox(children=(EvalText(value=u'0'), EvalText(value=u'4'))), VBox(children=(EvalText(value=u'1'), EvalText(value=u'5')))))
Got:
    <sage.repl.ipython_kernel.widgets.Grid object at 0x7f8d65145f90>
```

And indeed it doesn't seem to have an impact on functionality.


---

Comment by jdemeyer created at 2017-03-08 11:25:46

Follow-up: #22550, please review


---

Comment by jason created at 2017-05-17 16:12:16

I updated the description to reflect recent changes in upstream ipywidgets.


---

Comment by jdemeyer created at 2017-05-18 09:30:58

Thanks for the pointers, I will certainly follow up on this (but maybe not right now).
