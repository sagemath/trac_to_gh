# Issue 24374: fix linking issues in Singular on Solaris

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2018-01-29 23:28:14

CC:  jdemeyer embray

there are two issues:

* specific `-Wl` linker syntax in `libpolys/polys/Makefile.am` which nukes linking (as Solaris linker does not accept `dynamic_lookup` parameter). (By right, it's autotools that should generate such platform-specific arguments, it's asking for trouble to give them explicitly). (see http://www.singular.uni-kl.de:8002/trac/ticket/816)

* undefined `gethostbyname` and some other symbols from `-lsocket` and `-lnsl`. This is something that should be set by an autoconf macro, e.g. [ax_lib_socket_nsl](https://www.gnu.org/software/autoconf-archive/ax_lib_socket_nsl.html)


---

Comment by dimpase created at 2018-01-30 09:46:40

Changing status from new to needs_info.


---

Comment by dimpase created at 2018-01-30 09:46:40

I have a fix for this, not yet tested on other systems

```
diff --git a/libpolys/polys/Makefile.am b/libpolys/polys/Makefile.am
index 307cb48..556d919 100644
--- a/libpolys/polys/Makefile.am
+++ b/libpolys/polys/Makefile.am
`@``@` -65,7 +65,7 `@``@` p_Procs_FieldIndep_la_CPPFLAGS = -Dp_Procs_FieldIndep ${P_PROCS_CPPFLAGS_COMMON}
 p_Procs_FieldQ_la_CPPFLAGS = -Dp_Procs_FieldQ ${P_PROCS_CPPFLAGS_COMMON}
 p_Procs_FieldZp_la_CPPFLAGS = -Dp_Procs_FieldZp ${P_PROCS_CPPFLAGS_COMMON}
 
-P_PROCS_MODULE_LDFLAGS = -shared -module -dynamic -export-dynamic -avoid-version -weak_reference_mismatches weak -undefined dynamic_lookup -Wl,-undefined -Wl,dynamic_lookup -flat_namespace $(SINGULAR_LDFLAGS)
+P_PROCS_MODULE_LDFLAGS = -shared -module -dynamic -export-dynamic -avoid-version -weak_reference_mismatches weak -undefined dynamic_lookup -flat_namespace $(SINGULAR_LDFLAGS)
 
 p_Procs_FieldGeneral_la_LDFLAGS = ${P_PROCS_MODULE_LDFLAGS}
 p_Procs_FieldIndep_la_LDFLAGS = ${P_PROCS_MODULE_LDFLAGS}
```

note that `P_PROCS_MODULE_LDFLAGS` still looks very verbose, I wonder why.

(The following still needs to be reported upstream):
Adding `https://www.gnu.org/software/autoconf-archive/ax_lib_socket_nsl.html`
to `m4/` and calling it

```
diff --git a/configure.ac b/configure.ac
index 00e1113..6d238a7 100644
--- a/configure.ac
+++ b/configure.ac
`@``@` -153,6 +153,7 `@``@` m4_ifval([$3],
 fi[]dnl
 ])])
 
+AX_LIB_SOCKET_NSL
 
 AC_DEFINE_UNQUOTED([CC],"$CC",[CC])
 AC_DEFINE_UNQUOTED([CXX],"$CXX",[CXX])
```


After these changes, I ran Singular's `./autogen.sh`, producing a 90+K diff to their tarball. Applying this patch makes Singular build on Solaris 11.
(Probably the diff size can be reduced by using a more closely matching, version-wise, autotools).

Packaging a 90+K diff looks a bit silly - what should one do to package it (until the upstream picks it up, which might take I don't know how long).

Do we distribute a patched tarball now?


---

Comment by embray created at 2018-01-30 11:19:40

That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.


---

Comment by dimpase created at 2018-01-30 11:27:38

Replying to [comment:2 embray]:
> That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.

Do you need to do something Cygwin specific to get gethostbyname working in Singular?
(IIRC you need `-lsocket` on Cygwin).

How do you report bugs for Singular? Do you have a trac account with them, or you submit anonymously, like I did?


---

Comment by embray created at 2018-01-30 11:30:58

Replying to [comment:3 dimpase]:
> Replying to [comment:2 embray]:
> > That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.
> 
> Do you need to do something Cygwin specific to get gethostbyname working in Singular?
> (IIRC you need `-lsocket` on Cygwin).

Nope, it's not needed. Sockets are part of the Cygwin DLL.

> How do you report bugs for Singular? Do you have a trac account with them, or you submit anonymously, like I did?

They have a GitHub. I just sent pull requests: https://github.com/Singular/Sources


---

Comment by jdemeyer created at 2018-01-31 10:37:40

The first bug is already fixed :-)


---

Comment by dimpase created at 2018-01-31 11:38:43

I am going to submit a Singular issue for `gethostbyname` problem.


---

Comment by dimpase created at 2018-01-31 12:57:37

Replying to [comment:7 dimpase]:
> I am going to submit a Singular issue for `gethostbyname` problem.

This is now https://github.com/Singular/Sources/pull/847


---

Comment by dimpase created at 2018-01-31 14:22:56

Replying to [comment:8 dimpase]:
> Replying to [comment:7 dimpase]:
> > I am going to submit a Singular issue for `gethostbyname` problem.
> 
> This is now https://github.com/Singular/Sources/pull/847

now merged.


---

Comment by dimpase created at 2018-02-01 01:35:31

Are we going to make a patched tarball? (I am able to build with the linking-related patches as well as the one adding `std::` to `int pow(int, int)` calls).

`std::` to `int pow(int, int)` still needs to be reported upstream


---

Comment by dimpase created at 2018-02-01 15:40:04

Replying to [comment:10 dimpase]:
> 
> `std::` to `int pow(int, int)` still needs to be reported upstream

done: I created https://github.com/Singular/Sources/pull/848


---

Comment by jdemeyer created at 2018-02-02 11:30:56

Should I create a new spkg?


---

Comment by dimpase created at 2018-02-02 11:59:48

please do - I might get busy later today with other things.


---

Comment by git created at 2018-02-02 15:12:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-02 17:53:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2018-02-02 18:07:35

Note that the actual commit Singular for `int pow(int,int)` actually does casting to doubles and then back to ints (yuck!) --- well, they do this all over their code; no wonder one regularly comes up with an example a polynomial computation in Singular that uses large exponents, and returns patently wrong results, uncaught by the implementation...
----
New commits:


---

Comment by dimpase created at 2018-02-03 04:15:08

I'd submitted https://github.com/Singular/Sources/pull/850 to deal with the `floor(int)` thing.


---

Comment by git created at 2018-02-03 08:30:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-03 10:15:46

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2018-02-03 20:00:49

All patches are now applied upstream.


---

Comment by dimpase created at 2018-02-05 21:47:20

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-02-05 21:47:20

looks good to me


---

Comment by vbraun created at 2018-02-09 08:03:54

Resolution: fixed
