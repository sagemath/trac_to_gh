# Issue 24374: fix linking issues in Singular on Solaris

archive/issues_024374.json:
```json
{
    "body": "CC:  @jdemeyer @embray\n\nthere are two issues:\n\n* specific `-Wl` linker syntax in `libpolys/polys/Makefile.am` which nukes linking (as Solaris linker does not accept `dynamic_lookup` parameter). (By right, it's autotools that should generate such platform-specific arguments, it's asking for trouble to give them explicitly). (see http://www.singular.uni-kl.de:8002/trac/ticket/816)\n\n* undefined `gethostbyname` and some other symbols from `-lsocket` and `-lnsl`. This is something that should be set by an autoconf macro, e.g. [ax_lib_socket_nsl](https://www.gnu.org/software/autoconf-archive/ax_lib_socket_nsl.html)\n\nIssue created by migration from https://trac.sagemath.org/ticket/24611\n\n",
    "created_at": "2018-01-29T23:28:14Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "fix linking issues in Singular on Solaris",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24374",
    "user": "@dimpase"
}
```
CC:  @jdemeyer @embray

there are two issues:

* specific `-Wl` linker syntax in `libpolys/polys/Makefile.am` which nukes linking (as Solaris linker does not accept `dynamic_lookup` parameter). (By right, it's autotools that should generate such platform-specific arguments, it's asking for trouble to give them explicitly). (see http://www.singular.uni-kl.de:8002/trac/ticket/816)

* undefined `gethostbyname` and some other symbols from `-lsocket` and `-lnsl`. This is something that should be set by an autoconf macro, e.g. [ax_lib_socket_nsl](https://www.gnu.org/software/autoconf-archive/ax_lib_socket_nsl.html)

Issue created by migration from https://trac.sagemath.org/ticket/24611





---

archive/issue_comments_341451.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2018-01-30T09:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341451",
    "user": "@dimpase"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_341452.json:
```json
{
    "body": "I have a fix for this, not yet tested on other systems\n\n```\ndiff --git a/libpolys/polys/Makefile.am b/libpolys/polys/Makefile.am\nindex 307cb48..556d919 100644\n--- a/libpolys/polys/Makefile.am\n+++ b/libpolys/polys/Makefile.am\n@@ -65,7 +65,7 @@ p_Procs_FieldIndep_la_CPPFLAGS = -Dp_Procs_FieldIndep ${P_PROCS_CPPFLAGS_COMMON}\n p_Procs_FieldQ_la_CPPFLAGS = -Dp_Procs_FieldQ ${P_PROCS_CPPFLAGS_COMMON}\n p_Procs_FieldZp_la_CPPFLAGS = -Dp_Procs_FieldZp ${P_PROCS_CPPFLAGS_COMMON}\n \n-P_PROCS_MODULE_LDFLAGS = -shared -module -dynamic -export-dynamic -avoid-version -weak_reference_mismatches weak -undefined dynamic_lookup -Wl,-undefined -Wl,dynamic_lookup -flat_namespace $(SINGULAR_LDFLAGS)\n+P_PROCS_MODULE_LDFLAGS = -shared -module -dynamic -export-dynamic -avoid-version -weak_reference_mismatches weak -undefined dynamic_lookup -flat_namespace $(SINGULAR_LDFLAGS)\n \n p_Procs_FieldGeneral_la_LDFLAGS = ${P_PROCS_MODULE_LDFLAGS}\n p_Procs_FieldIndep_la_LDFLAGS = ${P_PROCS_MODULE_LDFLAGS}\n```\n\nnote that `P_PROCS_MODULE_LDFLAGS` still looks very verbose, I wonder why.\n\n(The following still needs to be reported upstream):\nAdding `https://www.gnu.org/software/autoconf-archive/ax_lib_socket_nsl.html`\nto `m4/` and calling it\n\n```\ndiff --git a/configure.ac b/configure.ac\nindex 00e1113..6d238a7 100644\n--- a/configure.ac\n+++ b/configure.ac\n@@ -153,6 +153,7 @@ m4_ifval([$3],\n fi[]dnl\n ])])\n \n+AX_LIB_SOCKET_NSL\n \n AC_DEFINE_UNQUOTED([CC],\"$CC\",[CC])\n AC_DEFINE_UNQUOTED([CXX],\"$CXX\",[CXX])\n```\n\n\nAfter these changes, I ran Singular's `./autogen.sh`, producing a 90+K diff to their tarball. Applying this patch makes Singular build on Solaris 11.\n(Probably the diff size can be reduced by using a more closely matching, version-wise, autotools).\n\nPackaging a 90+K diff looks a bit silly - what should one do to package it (until the upstream picks it up, which might take I don't know how long).\n\nDo we distribute a patched tarball now?",
    "created_at": "2018-01-30T09:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341452",
    "user": "@dimpase"
}
```

I have a fix for this, not yet tested on other systems

```
diff --git a/libpolys/polys/Makefile.am b/libpolys/polys/Makefile.am
index 307cb48..556d919 100644
--- a/libpolys/polys/Makefile.am
+++ b/libpolys/polys/Makefile.am
@@ -65,7 +65,7 @@ p_Procs_FieldIndep_la_CPPFLAGS = -Dp_Procs_FieldIndep ${P_PROCS_CPPFLAGS_COMMON}
 p_Procs_FieldQ_la_CPPFLAGS = -Dp_Procs_FieldQ ${P_PROCS_CPPFLAGS_COMMON}
 p_Procs_FieldZp_la_CPPFLAGS = -Dp_Procs_FieldZp ${P_PROCS_CPPFLAGS_COMMON}
 
-P_PROCS_MODULE_LDFLAGS = -shared -module -dynamic -export-dynamic -avoid-version -weak_reference_mismatches weak -undefined dynamic_lookup -Wl,-undefined -Wl,dynamic_lookup -flat_namespace $(SINGULAR_LDFLAGS)
+P_PROCS_MODULE_LDFLAGS = -shared -module -dynamic -export-dynamic -avoid-version -weak_reference_mismatches weak -undefined dynamic_lookup -flat_namespace $(SINGULAR_LDFLAGS)
 
 p_Procs_FieldGeneral_la_LDFLAGS = ${P_PROCS_MODULE_LDFLAGS}
 p_Procs_FieldIndep_la_LDFLAGS = ${P_PROCS_MODULE_LDFLAGS}
```

note that `P_PROCS_MODULE_LDFLAGS` still looks very verbose, I wonder why.

(The following still needs to be reported upstream):
Adding `https://www.gnu.org/software/autoconf-archive/ax_lib_socket_nsl.html`
to `m4/` and calling it

```
diff --git a/configure.ac b/configure.ac
index 00e1113..6d238a7 100644
--- a/configure.ac
+++ b/configure.ac
@@ -153,6 +153,7 @@ m4_ifval([$3],
 fi[]dnl
 ])])
 
+AX_LIB_SOCKET_NSL
 
 AC_DEFINE_UNQUOTED([CC],"$CC",[CC])
 AC_DEFINE_UNQUOTED([CXX],"$CXX",[CXX])
```


After these changes, I ran Singular's `./autogen.sh`, producing a 90+K diff to their tarball. Applying this patch makes Singular build on Solaris 11.
(Probably the diff size can be reduced by using a more closely matching, version-wise, autotools).

Packaging a 90+K diff looks a bit silly - what should one do to package it (until the upstream picks it up, which might take I don't know how long).

Do we distribute a patched tarball now?



---

archive/issue_comments_341453.json:
```json
{
    "body": "That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.",
    "created_at": "2018-01-30T11:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341453",
    "user": "@embray"
}
```

That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.



---

archive/issue_comments_341454.json:
```json
{
    "body": "Replying to [comment:2 embray]:\n> That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.\n\nDo you need to do something Cygwin specific to get gethostbyname working in Singular?\n(IIRC you need `-lsocket` on Cygwin).\n\nHow do you report bugs for Singular? Do you have a trac account with them, or you submit anonymously, like I did?",
    "created_at": "2018-01-30T11:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341454",
    "user": "@dimpase"
}
```

Replying to [comment:2 embray]:
> That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.

Do you need to do something Cygwin specific to get gethostbyname working in Singular?
(IIRC you need `-lsocket` on Cygwin).

How do you report bugs for Singular? Do you have a trac account with them, or you submit anonymously, like I did?



---

archive/issue_comments_341455.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> Replying to [comment:2 embray]:\n> > That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.\n> \n> Do you need to do something Cygwin specific to get gethostbyname working in Singular?\n> (IIRC you need `-lsocket` on Cygwin).\n\nNope, it's not needed. Sockets are part of the Cygwin DLL.\n\n> How do you report bugs for Singular? Do you have a trac account with them, or you submit anonymously, like I did?\n\nThey have a GitHub. I just sent pull requests: https://github.com/Singular/Sources",
    "created_at": "2018-01-30T11:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341455",
    "user": "@embray"
}
```

Replying to [comment:3 dimpase]:
> Replying to [comment:2 embray]:
> > That I don't know. I've been reasonably successful in getting singular to accept patches for platform-specific build issues though.
> 
> Do you need to do something Cygwin specific to get gethostbyname working in Singular?
> (IIRC you need `-lsocket` on Cygwin).

Nope, it's not needed. Sockets are part of the Cygwin DLL.

> How do you report bugs for Singular? Do you have a trac account with them, or you submit anonymously, like I did?

They have a GitHub. I just sent pull requests: https://github.com/Singular/Sources



---

archive/issue_comments_341456.json:
```json
{
    "body": "The first bug is already fixed :-)",
    "created_at": "2018-01-31T10:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341456",
    "user": "@jdemeyer"
}
```

The first bug is already fixed :-)



---

archive/issue_comments_341457.json:
```json
{
    "body": "I am going to submit a Singular issue for `gethostbyname` problem.",
    "created_at": "2018-01-31T11:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341457",
    "user": "@dimpase"
}
```

I am going to submit a Singular issue for `gethostbyname` problem.



---

archive/issue_comments_341458.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> I am going to submit a Singular issue for `gethostbyname` problem.\n\nThis is now https://github.com/Singular/Sources/pull/847",
    "created_at": "2018-01-31T12:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341458",
    "user": "@dimpase"
}
```

Replying to [comment:7 dimpase]:
> I am going to submit a Singular issue for `gethostbyname` problem.

This is now https://github.com/Singular/Sources/pull/847



---

archive/issue_comments_341459.json:
```json
{
    "body": "Replying to [comment:8 dimpase]:\n> Replying to [comment:7 dimpase]:\n> > I am going to submit a Singular issue for `gethostbyname` problem.\n> \n> This is now https://github.com/Singular/Sources/pull/847\n\nnow merged.",
    "created_at": "2018-01-31T14:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341459",
    "user": "@dimpase"
}
```

Replying to [comment:8 dimpase]:
> Replying to [comment:7 dimpase]:
> > I am going to submit a Singular issue for `gethostbyname` problem.
> 
> This is now https://github.com/Singular/Sources/pull/847

now merged.



---

archive/issue_comments_341460.json:
```json
{
    "body": "Are we going to make a patched tarball? (I am able to build with the linking-related patches as well as the one adding `std::` to `int pow(int, int)` calls).\n\n`std::` to `int pow(int, int)` still needs to be reported upstream",
    "created_at": "2018-02-01T01:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341460",
    "user": "@dimpase"
}
```

Are we going to make a patched tarball? (I am able to build with the linking-related patches as well as the one adding `std::` to `int pow(int, int)` calls).

`std::` to `int pow(int, int)` still needs to be reported upstream



---

archive/issue_comments_341461.json:
```json
{
    "body": "Replying to [comment:10 dimpase]:\n> \n> `std::` to `int pow(int, int)` still needs to be reported upstream\n\ndone: I created https://github.com/Singular/Sources/pull/848",
    "created_at": "2018-02-01T15:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341461",
    "user": "@dimpase"
}
```

Replying to [comment:10 dimpase]:
> 
> `std::` to `int pow(int, int)` still needs to be reported upstream

done: I created https://github.com/Singular/Sources/pull/848



---

archive/issue_comments_341462.json:
```json
{
    "body": "Should I create a new spkg?",
    "created_at": "2018-02-02T11:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341462",
    "user": "@jdemeyer"
}
```

Should I create a new spkg?



---

archive/issue_comments_341463.json:
```json
{
    "body": "please do - I might get busy later today with other things.",
    "created_at": "2018-02-02T11:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341463",
    "user": "@dimpase"
}
```

please do - I might get busy later today with other things.



---

archive/issue_comments_341464.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-02T15:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341464",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_341465.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-02T17:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341465",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_341466.json:
```json
{
    "body": "Note that the actual commit Singular for `int pow(int,int)` actually does casting to doubles and then back to ints (yuck!) --- well, they do this all over their code; no wonder one regularly comes up with an example a polynomial computation in Singular that uses large exponents, and returns patently wrong results, uncaught by the implementation...\n----\nNew commits:",
    "created_at": "2018-02-02T18:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341466",
    "user": "@dimpase"
}
```

Note that the actual commit Singular for `int pow(int,int)` actually does casting to doubles and then back to ints (yuck!) --- well, they do this all over their code; no wonder one regularly comes up with an example a polynomial computation in Singular that uses large exponents, and returns patently wrong results, uncaught by the implementation...
----
New commits:



---

archive/issue_comments_341467.json:
```json
{
    "body": "I'd submitted https://github.com/Singular/Sources/pull/850 to deal with the `floor(int)` thing.",
    "created_at": "2018-02-03T04:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341467",
    "user": "@dimpase"
}
```

I'd submitted https://github.com/Singular/Sources/pull/850 to deal with the `floor(int)` thing.



---

archive/issue_comments_341468.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-03T08:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341468",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_341469.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-02-03T10:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341469",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_341470.json:
```json
{
    "body": "All patches are now applied upstream.",
    "created_at": "2018-02-03T20:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341470",
    "user": "@jdemeyer"
}
```

All patches are now applied upstream.



---

archive/issue_comments_341471.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-05T21:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341471",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_341472.json:
```json
{
    "body": "looks good to me",
    "created_at": "2018-02-05T21:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341472",
    "user": "@dimpase"
}
```

looks good to me



---

archive/issue_comments_341473.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-09T08:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24374#issuecomment-341473",
    "user": "@vbraun"
}
```

Resolution: fixed
