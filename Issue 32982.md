# Issue 32982: ffmpeg/imagemagick feature checks still broken

Issue created by migration from https://trac.sagemath.org/ticket/33219

Original creator: vbraun

Original creation time: 2022-01-22 17:32:15

CC:  mkoeppe slabbe mjo

On the kucalc buildbot (debian 9 x86_64):

```
[...]
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 700 ##
0
sage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],
               xmin=0, xmax=2*pi, figsize=[2,1]) ## line 787 ##
sage: a.show()       # optional -- ImageMagick ## line 789 ##
sage: a.show(iterations=3)    # optional -- ImageMagick ## line 794 ##
sage: a.show(delay=50)        # optional -- ImageMagick ## line 798 ##
sage: a.show(format="ogg")         # optional -- ffmpeg ## line 802 ##
sage: a.show(format="webm")        # optional -- ffmpeg ## line 803 ##
sage: a.show(format="mp4")         # optional -- ffmpeg ## line 804 ##
------------------------------------------------------------------------
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6c28)[0x7fdba3db8c28]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6e08)[0x7fdba3db8e08]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x91fa)[0x7fdba3dbb1fa]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fdbabeed390]
/lib/x86_64-linux-gnu/libpthread.so.0(waitpid+0x6b)[0x7fdbabeecf7b]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x1ccd19)[0x7fdbac2c5d19]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0xe57e1)[0x7fdbac1de7e1]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7fdbac16a9ee]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x67a88)[0x7fdbac160a88]
[...]
**********************************************************************
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/plot/animate.py  # Timed out
----------------------------------------------------------------------

}}} 


---

Comment by mjo created at 2022-01-22 17:42:36

We know. The timeout is a separate issue (#33045). Please try SÃ©bastien's branch there.

Feature checks at runtime won't easily be able to detect a process that hangs. It's Yet Another fundamental problem with runtime checks.


---

Comment by mkoeppe created at 2022-01-22 17:46:55

If trying to use this feature can hang, then we should probably declare this feature as unsafe again by adding it back to `external_features`, https://github.com/sagemath/sage/blob/develop/src/sage/doctest/external.py#L336


---

Comment by slabbe created at 2022-01-25 15:02:13

Since #32174, we are automatically testing "safe" external features including `ffmpeg`. It turns out that those doctests are broken (hang, doctests time out) on machines I don't have access to including the buildbots on which Volker tests tickets.

I have been testing those optional tests and others on my machine for some time now and reporting on sage-release, but indeed, not on a big variety of machines. Therefore, those optional doctests are not guarrenty to work on all machines.

There are two solutions to this:

 - put back `ffmpeg` to the list of optional doctests that we never test (as it was before #32174)
 - try to fix the issue, this is #33045

The current branch implements the former. Needs review!

#33045 can be dealt with later once we find a way to test that it fixes the issue on a buildbot.
----
New commits:


---

Comment by slabbe created at 2022-01-25 15:02:13

Changing status from new to needs_review.


---

Comment by slabbe created at 2022-01-25 15:02:13

Changing priority from major to blocker.


---

Comment by mkoeppe created at 2022-01-25 19:32:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-01-27 22:05:03

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-01-27 22:05:03


```
sage -t --long --warn-long 50.8 --random-seed=123 src/sage/doctest/external.py
**********************************************************************
File "src/sage/doctest/external.py", line 381, in sage.doctest.external.AvailableSoftware
Failed example:
    external_software
Expected:
    ['cplex',
     'gurobi',
     'internet',
     'latex',
     'latex_package_tkz_graph',
     'lualatex',
     'macaulay2',
     'magma',
     'maple',
     'mathematica',
     'matlab',
     'octave',
     'pdflatex',
     'scilab',
     'xelatex']
Got:
    ['cplex',
     'ffmpeg',
     'gurobi',
     'internet',
     'latex',
     'latex_package_tkz_graph',
     'lualatex',
     'macaulay2',
     'magma',
     'maple',
     'mathematica',
     'matlab',
     'octave',
     'pdflatex',
     'scilab',
     'xelatex']
**********************************************************************
1 item had failures:
   1 of   3 in sage.doctest.external.AvailableSoftware
    [39 tests, 1 failure, 0.02 s]
----------------------------------------------------------------------
sage -t --long --warn-long 50.8 --random-seed=123 src/sage/doctest/external.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2022-01-27 22:19:30

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2022-01-27 22:19:30

New commits:


---

Comment by vbraun created at 2022-01-29 17:34:33

Resolution: fixed
