# Issue 28825: build/pkgs/python3/spkg-install: Install valgrind-python.supp in $SAGE_LOCAL, not in $SAGE_SRC

Issue created by migration from https://trac.sagemath.org/ticket/29062

Original creator: mkoeppe

Original creation time: 2020-01-21 18:31:27

CC:  dimpase embray rws jhpalmieri jdemeyer vbraun

`valgrind-python.supp` is supplied by the Python source code tarball.

In preparation for #27824 - spkg-configure.m4 for python3:
- we install this file in $SAGE_LOCAL/lib/valgrind/ instead. 
- make `sage -valgrind` more flexible in how it accesses the file.

This change also has the side effect of removing a peculiar use of `SAGE_EXTCODE` during building: Without this ticket, `python.supp` is first installed in the source directory (`$SAGE_SRC/ext`), and then from there in `$SAGE_LOCAL`. This simplifies #21785.

-------

Related old tickets:
- #19398 (Be more verbose when running valgrind)
- #17139 (Installing local/share/sage/ext/valgrind/python.supp fails)
- #11918 (Sage should ship its Valgrind suppressions file, or not insist on its presence)


---

Comment by mkoeppe created at 2020-01-21 19:32:45

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-21 19:32:45

New commits:


---

Comment by embray created at 2020-01-22 10:56:55

Makes sense to me, although I don't know about adding the Debian-specific paths.  How standard is `<prefix>/lib/valgrind/` on other distros?  Perhaps the script could just take an optional path to the suppressions file as command-line argument, or have the ability to pass additional command-line arguments directly to valgrind?


---

Comment by dimpase created at 2020-01-22 11:10:31

my Fedora box has `/usr/lib64/valgrind/`


---

Comment by mkoeppe created at 2020-01-22 13:49:04

Replying to [comment:4 dimpase]:
> my Fedora box has `/usr/lib64/valgrind/`
OK I'll add that.


---

Comment by mkoeppe created at 2020-01-22 13:50:53

Replying to [comment:3 embray]:
> Makes sense to me, although I don't know about adding the Debian-specific paths.  How standard is `<prefix>/lib/valgrind/` on other distros?  

As far as I can see, `<prefix>/lib/valgrind/` is the install location of upstream valgrind. It has the default suppression file. It's a natural place for distros to install additional things into.

> Perhaps the script could just take an optional path to the suppressions file as command-line argument, or have the ability to pass additional command-line arguments directly to valgrind?

A follow-up ticket.


---

Comment by git created at 2020-01-22 16:18:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-24 16:00:33

Ready for review


---

Comment by mkoeppe created at 2020-01-28 18:13:51

Replying to [comment:5 mkoeppe]:
> Replying to [comment:4 dimpase]:
> > my Fedora box has `/usr/lib64/valgrind/`
> OK I'll add that.
This is added and the ticket is waiting for review...


---

Comment by dimpase created at 2020-01-29 13:56:49

How can this be tested?


---

Comment by mkoeppe created at 2020-01-29 14:11:12

Check that sage-valgrind works without error in a fresh build from a distclean source, both in a python2 and python3 build.


---

Comment by dimpase created at 2020-01-31 18:37:32

this is what I see on py3 on Debian 10

```
(sage-sh) dimpase@penguin:sage-src$ sage-valgrind 
Using default flags: --leak-resolution=high --leak-check=full --num-callers=25  --suppressions=/usr/lib/valgrind/python3.supp --suppressions=/home/dimpase/sage-src/local/share/sage/ext/valgrind/pyalloc.supp --suppressions=/home/dimpase/sage-src/local/share/sage/ext/valgrind/sage.supp --suppressions=/home/dimpase/sage-src/local/share/sage/ext/valgrind/sage-additional.supp
==17460== Memcheck, a memory error detector
==17460== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==17460== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info
==17460== Command: /home/dimpase/sage-src/src/bin/sage-ipython -i
==17460== 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.1.beta2, Release Date: 2020-01-26               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: 2+2
4
sage:                                                                                                                                                                                     
Exiting Sage (CPU time 0m0.17s, Wall time 2m5.33s).
(sage-sh) dimpase@penguin:sage-src$ 
```

Is this what's expected?

PS. `sage --valgrind` produces the same output.


---

Comment by mkoeppe created at 2020-01-31 20:05:23

Yes, looks right.


---

Comment by dimpase created at 2020-01-31 21:15:50

I'll run a whole build of this branch on py2, just to be sure.


---

Comment by dimpase created at 2020-01-31 23:39:24

On py2 it does not seem to get installed in the right place:

```
$ ./sage --valgrind
Python suppressions not found (not installed?), skipping
Using default flags: --leak-resolution=high --leak-check=full --num-callers=25  --suppressions=/home/scratch2/dimpase/sage/sage-clang/local/share/sage/ext/valgrind/pyalloc.supp --suppressions=/home/scratch2/dimpase/sage/sage-clang/local/share/sage/ext/valgrind/sage.supp --suppressions=/home/scratch2/dimpase/sage/sage-clang/local/share/sage/ext/valgrind/sage-additional.supp
==21807== Memcheck, a memory error detector
==21807== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==21807== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==21807== Command: /home/scratch2/dimpase/sage/sage-clang/src/bin/sage-ipython -i
==21807== 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.1.beta2, Release Date: 2020-01-26               │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: 2+2
4
sage: exit
Exiting Sage (CPU time 0m0.11s, Wall time 0m5.92s).
```


In install log I see

```
cp <SAGEROOT>/src/ext/valgrind/sage.supp <SAGEROOT>/local/share/sage/ext/valgrind/sage.supp
```

and the same with files `pyalloc.supp`, `sage-additional.supp`.

And then

```
[python2-2.7.15.p1] Installing valgrind suppression file...
[python2-2.7.15.p1] Misc/valgrind-python.supp -> <SAGELOCAL>/var/tmp/sage/build/python2-2.7.15.p1/inst/home/scratch2/dimpase/sage/sage-clang/local/var/tmp/sage/build/python2-2.7.15.p1/inst/home/scratch2/dimpase/sage/sage-clang/local/lib/valgrind/python.supp
```


Is this branch missing needed py2 changes?


---

Comment by mkoeppe created at 2020-01-31 23:53:42

This all looks fine... Are you using `sage -valgrind` or are you trying to execute the `sage-valgrind` script directly?


---

Comment by mkoeppe created at 2020-01-31 23:54:52

Does the `local/lib/valgrind/python.supp` file exist after installation?


---

Comment by dimpase created at 2020-02-01 00:03:07

Replying to [comment:19 mkoeppe]:
> Does the `local/lib/valgrind/python.supp` file exist after installation?
no.


---

Comment by git created at 2020-02-01 00:10:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-02-01 00:11:49

Thanks for catching this.


---

Comment by dimpase created at 2020-02-01 00:28:53

have you fixed the problem? I only see a change in 
`build/pkgs/python3/spkg-install` - should not be relevant for the py2


---

Comment by mkoeppe created at 2020-02-01 00:30:18

Py2 has a symlink to the same script


---

Comment by dimpase created at 2020-02-01 00:41:14

Replying to [comment:24 mkoeppe]:
> Py2 has a symlink to the same script
this is evil :-)


---

Comment by mkoeppe created at 2020-02-01 00:57:40

Wasn't me :)


---

Comment by dimpase created at 2020-02-01 01:28:45

OK, good, this works for py2. 

I'll double-check for py3 - the previous check might have been faulty due to incomplete cleaning...


---

Comment by mkoeppe created at 2020-02-01 01:29:29

Thanks!


---

Comment by dimpase created at 2020-02-01 08:36:10

looks good.


---

Comment by dimpase created at 2020-02-01 08:36:10

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-02-01 13:45:40

Thanks for reviewing!


---

Comment by vbraun created at 2020-02-10 20:05:50

Resolution: fixed
