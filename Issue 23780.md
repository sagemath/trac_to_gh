# Issue 23780: Add sdh_die helper function--report an error message and exit

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-10-12 08:14:11

As brought up in #23160, a lot of the `spkg-install` scripts define a helper function like this, so this adds one that they can share.

In many cases this won't even be needed because error messaging is already handled in the `sdh_make` helpers and the like.  But occasionally it's still useful.  This can be used like:


```
command || sdh_die "Error message"
```


much like the `die` command in perl.


---

Comment by embray created at 2017-10-12 08:14:20

Changing status from new to needs_review.


---

Comment by embray created at 2017-10-12 08:24:49

Oops--accidentally pulled in some unrelated changes from #22509.


---

Comment by embray created at 2017-10-12 08:24:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-12 08:31:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-10-12 08:31:34

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-12 08:31:34

Cleaned up.


---

Comment by embray created at 2017-10-12 10:58:01

This will conflict with #24014, so better to add that as a dependency and make the required changes here to make them compatible.


---

Comment by embray created at 2017-10-12 10:58:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-12 13:44:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-10-12 13:47:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-10-25 09:35:02

The `$(_sdh_cols)` thing seems over-engineered to me. In particular, I have doubts about

```
echo "$msg" | fmt -s -w $(_sdh_cols)
```

because it means that we have to worry about the portability of the `fmt` program. I think it would be much better to just echo the message as-is. Also, there is a typo in a comment: `90` should be `80`.

I like your `sdh_die << _EOF_` trick but then that should be documented too at the top of `sage-dist-helpers`.


---

Comment by jdemeyer created at 2017-10-25 09:35:02

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-10-25 10:13:04

Replying to [comment:8 jdemeyer]:
> The `$(_sdh_cols)` thing seems over-engineered to me.

That's fair in general :)

> In particular, I have doubts about
> {{{
> echo "$msg" | fmt -s -w $(_sdh_cols)
> }}}
> because it means that we have to worry about the portability of the `fmt` program.

`fmt` is actually very portable, moreso even than grep.  It's a sadly little-known, but very widely installed program and hasn't changed much over the ages.  See for yourself--it's on OSX, openbsd, freebsd, pretty much any linux, and it's the same everywhere.

I'm not married to having it here, but I think the end result is nicer-looking error messages almost everywhere.

> I think it would be much better to just echo the message as-is. Also, there is a typo in a comment: `90` should be `80`.
> 
> I like your `sdh_die << _EOF_` trick but then that should be documented too at the top of `sage-dist-helpers`.

Oh you're right--I thought i did write docs about that but apparently not.


---

Comment by git created at 2017-10-25 10:22:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-25 12:19:16

Replying to [comment:10 embray]:
> `fmt` is actually very portable, moreso even than grep.  It's a sadly little-known, but very widely installed program and hasn't changed much over the ages.  See for yourself--it's on OSX, openbsd, freebsd, pretty much any linux, and it's the same everywhere.

Fair enough. I give you the benefit of the doubt. It still feels over-engineered to me, but I won't block this ticket because of it.

Remember to set this back to needs_review when you are done.


---

Comment by embray created at 2017-10-25 12:30:15

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-25 12:30:15

I don't disagree with the "over-engineered" assessment--there's more going on there than is needed for the bare-minimum functionality.  But let's try it out for a bit.  I think it is a nice little "quality of life" touch.


---

Comment by jdemeyer created at 2017-10-25 13:21:36

Concerning

```
If the last command run exited with an error,
```


Why this condition? It means that you couldn't do something like

```
if some_condition; then
    sdh_die "bla bla bla"
fi
```



---

Comment by embray created at 2017-10-25 13:45:47

This could be written something like


```
[ some_condition ] || sdh_die ...
```


though I realize in your example `some_condition` need not be the `test` command either.

Hmm--I think the original logic was that it was a failsafe of sorts; it would not "die" unless the previous command actually exited with an error.  For example, although it's typically used with `||`, if one ran `command; sdh_die ...` it would only "die" if the command returned a non-zero exit status.

But maybe sometimes you'd also want to "die" if some command succeeded.  So I think ultimately this restriction is not well-justified.  I'll remove it.


---

Comment by git created at 2017-10-25 13:51:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-26 08:08:34

In

```
if [ $ret -ne 0 ]; then
```

did you mean

```
if [ $ret -eq 0 ]; then
```



---

Comment by embray created at 2017-10-26 10:03:11

Replying to [comment:17 jdemeyer]:
> In
> {{{
> if [ $ret -ne 0 ]; then
> }}}
> did you mean
> {{{
> if [ $ret -eq 0 ]; then
> }}}

Yes, thank you for catching that.


---

Comment by git created at 2017-10-26 10:04:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-26 10:05:57

Is there a good place to put miscellaneous tests that aren't for an actual module in the `sage` package?  Under `src/sage/tests`, maybe?

I would like to add a test suite for these functions (in a separate ticket).


---

Comment by jdemeyer created at 2017-10-26 10:16:58

Replying to [comment:20 embray]:
> Under `src/sage/tests`, maybe?

Since it's about building Sage, it would better be in `src/sage_setup`.


---

Comment by embray created at 2017-10-26 10:19:57

There's not a `sage_setup.tests` package yet to speak of, but I guess there could/should be.


---

Comment by jdemeyer created at 2017-10-27 09:24:37

Works for me.


---

Comment by jdemeyer created at 2017-10-27 09:24:37

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-10-27 12:26:19

FWIW the recent patchbot failure is due to the issue fixed by #24092, though it might be good the make that a dependency of this...


---

Comment by embray created at 2017-10-27 12:26:19

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-10-27 12:27:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-27 12:28:35

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-10-27 12:28:35

Added #24092 as a dependency in the hopes of getting better patchbot feedback.


---

Comment by jdemeyer created at 2017-10-27 12:38:16

Replying to [comment:26 embray]:
> Added #24092 as a dependency in the hopes of getting better patchbot feedback.

Does the patchbot even look at the dependencies?


---

Comment by embray created at 2017-10-27 12:50:15

I don't think so, but it still makes sense to track doesn't it?

(I am also trying to update the trac plugin to better diff branches against their dependencies, but that's a moot point for now...)


---

Comment by vbraun created at 2017-10-30 07:41:19

Resolution: fixed
