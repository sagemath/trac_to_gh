# Issue 29300: Crash on building documentation and on startup, NTL-related, on cygwin-standard

Issue created by migration from https://trac.sagemath.org/ticket/29537

Original creator: mkoeppe

Original creation time: 2020-04-20 07:47:56

CC:  dimpase mjo fbissey embray @darijgr tscrim @kliem slabbe


```
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 183, in _run_module_as_main
[dochtml]     mod_name, mod_spec, code = _get_module_details(mod_name, _Error)
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 142, in _get_module_details
[dochtml]     return _get_module_details(pkg_main_name, error)
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 109, in _get_module_details
[dochtml]     __import__(pkg_name)
[dochtml]   File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 59, in <module>
[dochtml]     import sage.all
[dochtml]   File "/sage/local/lib/python3.7/site-packages/sage/all.py", line 125, in <module>
[dochtml]     from sage.libs.all       import *
[dochtml]   File "/sage/local/lib/python3.7/site-packages/sage/libs/all.py", line 3, in <module>
[dochtml]     import sage.libs.ntl.all as ntl
[dochtml]   File "/sage/local/lib/python3.7/site-packages/sage/libs/ntl/all.py", line 24, in <module>
[dochtml]     from sage.libs.ntl.ntl_ZZ import (
[dochtml]   File "sage/libs/ntl/ntl_ZZ.pyx", line 458, in init sage.libs.ntl.ntl_ZZ (build/cythonized/sage/libs/ntl/ntl_ZZ.cpp:9100)
[dochtml]   File "sage/libs/ntl/ntl_ZZ.pyx", line 454, in sage.libs.ntl.ntl_ZZ.ntl_setSeed (build/cythonized/sage/libs/ntl/ntl_ZZ.cpp:6106)
[dochtml] cysignals.signals.SignalError: Illegal instruction
```




```

$ ./sage
This looks like the first time you are running Sage.
Cleaning up, do not interrupt this.
Done cleaning.
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.1.rc0, Release Date: 2020-04-12                 │
│ Using Python 3.7.4. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
---------------------------------------------------------------------------
---------------------------------------------------------------------------
SignalError                           Python 3.7.4: /sage/local/bin/python3
                                                   Mon Apr 20 00:31:18 2020
A problem occurred executing Python code.  Here is the sequence of function
calls leading up to the error, with the most recent (innermost) call last.
/cygdrive/c/sage/sage2/src/bin/sage-ipython in <module>()
      1 #!/usr/bin/env sage-python
      2 # -*- coding: utf-8 -*-
      3 """
      4 Sage IPython startup script.
      5 """
      6
      7 # Display startup banner. Do this before anything else to give the user
      8 # early feedback that Sage is starting.
      9 from sage.misc.banner import banner
     10 banner()
     11
     12 from sage.repl.interpreter import SageTerminalApp
     13
     14 app = SageTerminalApp.instance()
---> 15 app.initialize()
        global app.initialize = <bound method TerminalIPythonApp.initialize of <sage.repl.interpreter.SageTerminalApp object at 0x6fffffec7710>>
     16 app.start()

</sage/local/lib/python3.7/site-packages/decorator.py:decorator-gen-110> in initialize(self=<sage.repl.interpreter.SageTerminalApp object>, argv=None)

/sage/local/lib/python3.7/site-packages/traitlets/config/application.py in catch_config_error(method=<function TerminalIPythonApp.initialize>, app=<sage.repl.interpreter.SageTerminalApp object>, *args=(None,), **kwargs={})
     72     TRAITLETS_APPLICATION_RAISE_CONFIG_FILE_ERROR = False
     73 else:
     74     raise ValueError("Unsupported value for environment variable: 'TRAITLETS_APPLICATION_RAISE_CONFIG_FILE_ERROR' is set to '%s' which is none of  {'0', '1', 'false', 'true', ''}."% _envvar )
     75
     76
     77 @decorator
     78 def catch_config_error(method, app, *args, **kwargs):
     79     """Method decorator for catching invalid config (Trait/ArgumentErrors) during init.
     80
     81     On a TraitError (generally caused by bad config), this will print the trait's
     82     message, and exit the app.
     83
     84     For use on init methods, to prevent invoking excepthook on invalid input.
     85     """
     86     try:
---> 87         return method(app, *args, **kwargs)
        method = <function TerminalIPythonApp.initialize at 0x6ffffec18560>
        app = <sage.repl.interpreter.SageTerminalApp object at 0x6fffffec7710>
        args = (None,)
        kwargs = {}
     88     except (TraitError, ArgumentError) as e:
     89         app.print_help()
     90         app.log.fatal("Bad config encountered during initialization:")
     91         app.log.fatal(str(e))
     92         app.log.debug("Config at the time: %s", app.config)
     93         app.exit(1)
     94
     95
     96 class ApplicationError(Exception):
     97     pass
     98
     99
    100 class LevelFormatter(logging.Formatter):
    101     """Formatter with additional `highlevel` record
    102

/sage/local/lib/python3.7/site-packages/IPython/terminal/ipapp.py in initialize(self=<sage.repl.interpreter.SageTerminalApp object>, argv=None)
    301
    302         return super(TerminalIPythonApp, self).parse_command_line(argv)
    303
    304     @catch_config_error
    305     def initialize(self, argv=None):
    306         """Do actions after construct, but before starting the app."""
    307         super(TerminalIPythonApp, self).initialize(argv)
    308         if self.subapp is not None:
    309             # don't bother initializing further, starting subapp
    310             return
    311         # print self.extra_args
    312         if self.extra_args and not self.something_to_run:
    313             self.file_to_run = self.extra_args[0]
    314         self.init_path()
    315         # create the shell
--> 316         self.init_shell()
        self.init_shell = <bound method SageTerminalApp.init_shell of <sage.repl.interpreter.SageTerminalApp object at 0x6fffffec7710>>
    317         # and draw the banner
    318         self.init_banner()
    319         # Now a variety of things that happen after the banner is printed.
    320         self.init_gui_pylab()
    321         self.init_extensions()
    322         self.init_code()
    323
    324     def init_shell(self):
    325         """initialize the InteractiveShell instance"""
    326         # Create an InteractiveShell instance.
    327         # shell.display_banner should always be False for the terminal
    328         # based app, because we call shell.show_banner() by hand below
    329         # so the banner shows *before* all extension loading stuff.
    330         self.shell = self.interactive_shell_class.instance(parent=self,
    331                         profile_dir=self.profile_dir,

/sage/local/lib/python3.7/site-packages/sage/repl/interpreter.py in init_shell(self=<sage.repl.interpreter.SageTerminalApp object>)
    772         self.shell.has_sage_extensions = SAGE_EXTENSION in self.extensions
    773
    774         # Load the %lprun extension if available
    775         try:
    776             import line_profiler
    777         except ImportError:
    778             pass
    779         else:
    780             self.extensions.append('line_profiler')
    781
    782         if self.shell.has_sage_extensions:
    783             self.extensions.remove(SAGE_EXTENSION)
    784
    785             # load sage extension here to get a crash if
    786             # something is wrong with the sage library
--> 787             self.shell.extension_manager.load_extension(SAGE_EXTENSION)
        self.shell.extension_manager.load_extension = <bound method ExtensionManager.load_extension of <IPython.core.extensions.ExtensionManager object at 0x6ffffec1dc90>>
        global SAGE_EXTENSION = 'sage'
    788
    789

/sage/local/lib/python3.7/site-packages/IPython/core/extensions.py in load_extension(self=<IPython.core.extensions.ExtensionManager object>, module_str='sage')
     70
     71         Returns the string "already loaded" if the extension is already loaded,
     72         "no load function" if the module doesn't have a load_ipython_extension
     73         function, or None if it succeeded.
     74         """
     75         if module_str in self.loaded:
     76             return "already loaded"
     77
     78         from IPython.utils.syspathcontext import prepended_to_syspath
     79
     80         with self.shell.builtin_trap:
     81             if module_str not in sys.modules:
     82                 with prepended_to_syspath(self.ipython_extension_dir):
     83                     __import__(module_str)
     84             mod = sys.modules[module_str]
---> 85             if self._call_load_ipython_extension(mod):
        self._call_load_ipython_extension = <bound method ExtensionManager._call_load_ipython_extension of <IPython.core.extensions.ExtensionManager object at 0x6ffffec1dc90>>
        mod = <module 'sage' from '/sage/local/lib/python3.7/site-packages/sage/__init__.py'>
     86                 self.loaded.add(module_str)
     87             else:
     88                 return "no load function"
     89
     90     def unload_extension(self, module_str):
     91         """Unload an IPython extension by its module name.
     92
     93         This function looks up the extension's name in ``sys.modules`` and
     94         simply calls ``mod.unload_ipython_extension(self)``.
     95
     96         Returns the string "no unload function" if the extension doesn't define
     97         a function to unload itself, "not loaded" if the extension isn't loaded,
     98         otherwise None.
     99         """
    100         if module_str not in self.loaded:

/sage/local/lib/python3.7/site-packages/IPython/core/extensions.py in _call_load_ipython_extension(self=<IPython.core.extensions.ExtensionManager object>, mod=<module 'sage' from '/sage/local/lib/python3.7/site-packages/sage/__init__.py'>)
    117         """
    118         from IPython.utils.syspathcontext import prepended_to_syspath
    119
    120         if (module_str in self.loaded) and (module_str in sys.modules):
    121             self.unload_extension(module_str)
    122             mod = sys.modules[module_str]
    123             with prepended_to_syspath(self.ipython_extension_dir):
    124                 reload(mod)
    125             if self._call_load_ipython_extension(mod):
    126                 self.loaded.add(module_str)
    127         else:
    128             self.load_extension(module_str)
    129
    130     def _call_load_ipython_extension(self, mod):
    131         if hasattr(mod, 'load_ipython_extension'):
--> 132             mod.load_ipython_extension(self.shell)
        mod.load_ipython_extension = <function load_ipython_extension at 0x6fffffde1710>
        self.shell = <sage.repl.interpreter.SageTerminalInteractiveShell object at 0x6fffffec79d0>
    133             return True
    134
    135     def _call_unload_ipython_extension(self, mod):
    136         if hasattr(mod, 'unload_ipython_extension'):
    137             mod.unload_ipython_extension(self.shell)
    138             return True
    139
    140     def install_extension(self, url, filename=None):
    141         """Download and install an IPython extension.
    142
    143         If filename is given, the file will be so named (inside the extension
    144         directory). Otherwise, the name from the URL will be used. The file must
    145         have a .py or .zip extension; otherwise, a ValueError will be raised.
    146
    147         Returns the full path to the installed file.

/sage/local/lib/python3.7/site-packages/sage/__init__.py in load_ipython_extension(*args=(<sage.repl.interpreter.SageTerminalInteractiveShell object>,))
      1 __all__ = ['all']
      2
      3 # Set sage.__version__ to the current version number. This is analogous
      4 # to many other Python packages.
      5 from sage.version import version as __version__
      6
      7 # Make sure that the correct zlib library is loaded. This is needed
      8 # to prevent the system zlib to be loaded instead of the Sage one.
      9 # See https://trac.sagemath.org/ticket/23122
     10 import zlib
     11
     12 # IPython calls this when starting up
     13 def load_ipython_extension(*args):
     14     import sage.repl.ipython_extension
---> 15     sage.repl.ipython_extension.load_ipython_extension(*args)
        sage.repl.ipython_extension.load_ipython_extension = <function load_ipython_extension at 0x6ffffe3f27a0>
        args = (<sage.repl.interpreter.SageTerminalInteractiveShell object at 0x6fffffec79d0>,)
     16
     17
     18 # Monkey-patch inspect.isfunction() to support Cython functions.
     19 def isfunction(obj):
     20     """
     21     Check whether something is a function.
     22
     23     We assume that anything which has a genuine ``__code__``
     24     attribute (not using ``__getattr__`` overrides) is a function.
     25     This is meant to support Cython functions.
     26
     27     EXAMPLES::
     28
     29         sage: from inspect import isfunction
     30         sage: def f(): pass
     31         sage: isfunction(f)

/sage/local/lib/python3.7/site-packages/sage/repl/ipython_extension.py in wrapper(*args=(<sage.repl.interpreter.SageTerminalInteractiveShell object>,), **kwargs={})
    549         ....:     if work:
    550         ....:         return 'foo worked'
    551         ....:     raise RuntimeError("foo didn't work")
    552         sage: foo(False)
    553         Traceback (most recent call last):
    554         ...
    555         RuntimeError: foo didn't work
    556         sage: foo(True)
    557         'foo worked'
    558         sage: foo(False)
    559         sage: foo(True)
    560     """
    561     @wraps(func)
    562     def wrapper(*args, **kwargs):
    563         if not wrapper.has_run:
--> 564             result = func(*args, **kwargs)
        result = undefined
        global func = undefined
        args = (<sage.repl.interpreter.SageTerminalInteractiveShell object at 0x6fffffec79d0>,)
        kwargs = {}
    565             wrapper.has_run = True
    566             return result
    567     wrapper.has_run = False
    568     return wrapper
    569
    570
    571 @run_once
    572 def load_ipython_extension(ip):
    573     """
    574     Load the extension in IPython.
    575     """
    576     # this modifies ip
    577     SageCustomizations(shell=ip)

/sage/local/lib/python3.7/site-packages/sage/repl/ipython_extension.py in load_ipython_extension(ip=<sage.repl.interpreter.SageTerminalInteractiveShell object>)
    562     def wrapper(*args, **kwargs):
    563         if not wrapper.has_run:
    564             result = func(*args, **kwargs)
    565             wrapper.has_run = True
    566             return result
    567     wrapper.has_run = False
    568     return wrapper
    569
    570
    571 @run_once
    572 def load_ipython_extension(ip):
    573     """
    574     Load the extension in IPython.
    575     """
    576     # this modifies ip
--> 577     SageCustomizations(shell=ip)
        global SageCustomizations = <class 'sage.repl.ipython_extension.SageCustomizations'>
        global shell = undefined
        ip = <sage.repl.interpreter.SageTerminalInteractiveShell object at 0x6fffffec79d0>

/sage/local/lib/python3.7/site-packages/sage/repl/ipython_extension.py in __init__(self=<sage.repl.ipython_extension.SageCustomizations object>, shell=<sage.repl.interpreter.SageTerminalInteractiveShell object>)
    420     def __init__(self, shell=None):
    421         """
    422         Initialize the Sage plugin.
    423         """
    424         self.shell = shell
    425
    426         self.auto_magics = SageMagics(shell)
    427         self.shell.register_magics(self.auto_magics)
    428
    429         import sage.misc.edit_module as edit_module
    430         self.shell.set_hook('editor', edit_module.edit_devel)
    431
    432         self.init_inspector()
    433         self.init_line_transforms()
    434
--> 435         import sage.all # until sage's import hell is fixed
        sage.all = undefined
    436
    437         self.shell.verbose_quit = True
    438         self.set_quit_hook()
    439
    440         self.register_interface_magics()
    441
    442         if SAGE_IMPORTALL == 'yes':
    443             self.init_environment()
    444
    445     def register_interface_magics(self):
    446         """
    447         Register magics for each of the Sage interfaces
    448         """
    449         from sage.repl.interface_magic import InterfaceMagic
    450         InterfaceMagic.register_all(self.shell)

/sage/local/lib/python3.7/site-packages/sage/all.py in <module>()
    110 # This import also sets up the interrupt handler
    111 from cysignals.signals import (AlarmInterrupt, SignalError,
    112         sig_on_reset as sig_on_count)
    113
    114 from time                import sleep
    115 from functools import reduce  # in order to keep reduce in python3
    116
    117 import sage.misc.lazy_import
    118
    119 from sage.misc.all       import *         # takes a while
    120 from sage.typeset.all    import *
    121 from sage.repl.all       import *
    122
    123 from sage.misc.sh import sh
    124
--> 125 from sage.libs.all       import *
        global sage.libs.all = undefined
    126 from sage.data_structures.all import *
    127 from sage.doctest.all    import *
    128
    129 from sage.structure.all  import *
    130 from sage.rings.all      import *
    131 from sage.arith.all      import *
    132 from sage.matrix.all     import *
    133
    134 from sage.symbolic.all   import *
    135 from sage.modules.all    import *
    136 from sage.monoids.all    import *
    137 from sage.algebras.all   import *
    138 from sage.modular.all    import *
    139 from sage.sat.all        import *
    140 from sage.schemes.all    import *

/sage/local/lib/python3.7/site-packages/sage/libs/all.py in <module>()
      1 from __future__ import absolute_import
      2
----> 3 import sage.libs.ntl.all as ntl
        global sage.libs.ntl.all = undefined
        global ntl = undefined
      4
      5 from sage.libs.pari.all import pari, pari_gen, PariError
      6
      7 import sage.libs.symmetrica.all as symmetrica
      8
      9 from sage.misc.lazy_import import lazy_import
     10 lazy_import('sage.libs.gap.libgap', 'libgap')
     11
     12 lazy_import('sage.libs.eclib.all', ('mwrank_EllipticCurve',
     13         'mwrank_MordellWeil', 'mwrank_initprimes', 'CremonaModularSymbols'))
     14 lazy_import('sage.libs.eclib.all', 'get_precision', 'mwrank_get_precision')
     15 lazy_import('sage.libs.eclib.all', 'set_precision', 'mwrank_set_precision')

/sage/local/lib/python3.7/site-packages/sage/libs/ntl/all.py in <module>()
      9 #*****************************************************************************
     10 #       Copyright (C) 2005 William Stein <wstein@gmail.com>
     11 #
     12 #  Distributed under the terms of the GNU General Public License (GPL)
     13 #
     14 #    This code is distributed in the hope that it will be useful,
     15 #    but WITHOUT ANY WARRANTY; without even the implied warranty of
     16 #    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
     17 #    General Public License for more details.
     18 #
     19 #  The full text of the GPL is available at:
     20 #
     21 #                  http://www.gnu.org/licenses/
     22 #*****************************************************************************
     23
---> 24 from sage.libs.ntl.ntl_ZZ import (
        global sage.libs.ntl.ntl_ZZ = undefined
        global ntl_setSeed = undefined
        global ntl_ZZ = undefined
        global ZZ = undefined
        global randomBnd = undefined
        global ZZ_random = undefined
        global randomBits = undefined
        global ZZ_random_bits = undefined
     25                  ntl_setSeed, \
     26                  ntl_ZZ as ZZ,
     27                  randomBnd as ZZ_random,
     28                  randomBits as ZZ_random_bits )
     29
     30 from sage.libs.ntl.ntl_ZZ_pContext import ntl_ZZ_pContext as ZZ_pContext
     31
     32 from sage.libs.ntl.ntl_ZZ_p import (
     33                  ntl_ZZ_p as ZZ_p,
     34                  ntl_ZZ_p_random_element as ZZ_p_random )
     35
     36 from sage.libs.ntl.ntl_ZZX import (
     37                  ntl_ZZX as ZZX,
     38                  zero_ZZX, one_ZZX )
     39

/sage/local/lib/python3.7/site-packages/sage/libs/ntl/ntl_ZZ.pyx in init sage.libs.ntl.ntl_ZZ (build/cythonized/sage/libs/ntl/ntl_ZZ.cpp:9100)()
    443
    444         sage: ntl.ntl_setSeed(10)
    445         sage: ntl.ZZ_random(1000)
    446         935
    447     """
    448     cdef ntl_ZZ seed = ntl_ZZ(1)
    449     if x is None:
    450         from random import randint
    451         seed = ntl_ZZ(randint(0,int(2)**64))
    452     else:
    453         seed = ntl_ZZ(x)
    454     sig_on()
    455     ZZ_SetSeed(seed.x)
    456     sig_off()
    457
--> 458 ntl_setSeed()
        global ntl_setSeed = <built-in function ntl_setSeed>
    459
    460
    461 def randomBnd(q):
    462     r"""
    463     Return a random number in the range [0,n).
    464
    465     According to the NTL documentation, these numbers are
    466     "cryptographically strong"; of course, that depends in part on
    467     how they are seeded.
    468
    469     EXAMPLES::
    470
    471         sage: [ntl.ZZ_random(99999) for i in range(5)]
    472         [30675, 84282, 80559, 6939, 44798]
    473

/sage/local/lib/python3.7/site-packages/sage/libs/ntl/ntl_ZZ.pyx in sage.libs.ntl.ntl_ZZ.ntl_setSeed (build/cythonized/sage/libs/ntl/ntl_ZZ.cpp:6106)()
    439         979
    440
    441     Now you can call this function, and it will not be overridden until
    442     the next time the main Sage random number seed is changed::
    443
    444         sage: ntl.ntl_setSeed(10)
    445         sage: ntl.ZZ_random(1000)
    446         935
    447     """
    448     cdef ntl_ZZ seed = ntl_ZZ(1)
    449     if x is None:
    450         from random import randint
    451         seed = ntl_ZZ(randint(0,int(2)**64))
    452     else:
    453         seed = ntl_ZZ(x)
--> 454     sig_on()
        global sig_on = undefined
    455     ZZ_SetSeed(seed.x)
    456     sig_off()
    457
    458 ntl_setSeed()
    459
    460
    461 def randomBnd(q):
    462     r"""
    463     Return a random number in the range [0,n).
    464
    465     According to the NTL documentation, these numbers are
    466     "cryptographically strong"; of course, that depends in part on
    467     how they are seeded.
    468
    469     EXAMPLES::

SignalError: Illegal instruction

**********************************************************************

Oops, Sage crashed. We do our best to make it stable, but...

A crash report was automatically generated with the following information:
  - A verbatim copy of the crash traceback.
  - A copy of your input history during this session.
  - Data on your current Sage configuration.

It was left in the file named:
        '/home/Matthias Koeppe/.sage/ipython-5.0.0/Sage_crash_report.txt'
If you can email this file to the developers, the information in it will help
them in understanding and correcting the problem.

You can mail it to: sage-support at sage-support@googlegroups.com
with the subject 'Sage Crash Report'.

If you want to do it now, the following command will work (under Unix):
mail -s 'Sage Crash Report' sage-support@googlegroups.com < /home/Matthias Koeppe/.sage/ipython-5.0.0/Sage_crash_report.txt

In your email, please also include information about:
- The operating system under which the crash happened: Linux, macOS, Windows,
  other, and which exact version (for example: Ubuntu 16.04.3, macOS 10.13.2,
  Windows 10 Pro), and whether it is 32-bit or 64-bit;
- How Sage was installed: using pip or conda, from GitHub, as part of
  a Docker container, or other, providing more detail if possible;
- How to reproduce the crash: what exact sequence of instructions can one
  input to get the same crash? Ideally, find a minimal yet complete sequence
  of instructions that yields the crash.

To ensure accurate tracking of this issue, please file a report about it at:
http://trac.sagemath.org

Hit <Enter> to quit (your terminal may close):
```



---

Comment by mkoeppe created at 2020-04-20 07:48:16

Changing priority from major to blocker.


---

Comment by dimpase created at 2020-04-20 08:48:23

could it be some kind of hardware mismatch?


---

Comment by mkoeppe created at 2020-04-20 15:54:54

Possibly, I'll investigate


---

Comment by mkoeppe created at 2020-04-20 17:10:37

I will try with the configuration that Erik's https://github.com/sagemath/sage-windows/blob/master/Makefile
uses


---

Comment by mkoeppe created at 2020-05-05 01:06:47

Changing priority from blocker to critical.


---

Comment by embray created at 2020-06-26 12:05:05

I looked at one of the build logs on [GitHub](GitHub) and it does look like `SAGE_FAT_BINARY=yes` is being passed down, so other than that I'm not aware of any issue that would cause this unless there's a new issue with NTL I haven't seen before.


---

Comment by embray created at 2020-06-26 12:11:46

Possibly related: #29109


---

Comment by mkoeppe created at 2020-12-09 20:56:59

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-25 19:42:25

It's quite possible that this also affects our Docker builds.


---

Comment by mkoeppe created at 2020-12-28 18:08:25

A report regarding the Docker builds: https://groups.google.com/g/sage-devel/c/Dbd4nFi8R7I (but no NTL involvement visible)


---

Comment by mkoeppe created at 2020-12-28 18:08:25

Changing component from porting: Cygwin to porting.


---

Comment by @kliem created at 2020-12-29 08:57:11

From `NTL/doc/tour-win.html`:


```
152 Configuration flags.
153 </b>
154 <p>
155 
156 Also in directory "<tt>include/NTL</tt>" is a file called "<tt>config.h</tt>".
157 You can edit this file to override some of NTL's default options
158 for basic configuration and performance.
159 Again, the defaults should be good for
160 Windows with MSVC++.
```


In `config.h` there is a couple of flags that needs to be set by hand apparently.

Those look like they might make problems:


```
195 #if 0
196 #define NTL_CLEAN_INT
197 
198 /*
199  *   This will disallow the use of some non-standard integer arithmetic
200  *   that may improve performance somewhat.
201  *
202  */
203 
204 #endif
205 
206 #if 1
207 #define NTL_CLEAN_PTR
208 
209 /*
210  *   This will disallow the use of some non-standard pointer arithmetic
211  *   that may improve performance somewhat.
212  *
213  */
214 
215 #endif
216 
217 #if 1
218 #define NTL_SAFE_VECTORS
219 
220 /*
221  * This will compile NTL in "safe vector" mode, only assuming
222  * the relocatability property for trivial types and types
223  * explicitly declared relocatable.  See vector.txt for more details.
224  */
225 
226 #endif
227 
228 #if 0
229 #define NTL_ENABLE_AVX_FFT
230 
231 /*
232  * This will compile NTL in a way that enables an AVX implemention
233  * of the small-prime FFT.
234  */
235 
236 #endif
237 
238 
239 #if 0
240 #define NTL_AVOID_AVX512
241  
242 /*
243  * This will compile NTL in a way that avoids 512-bit operations,
244  * even if AVX512 is available.
245  */
246 
247 #endif
248  
249 #if 0
250 #define NTL_RANGE_CHECK
251 
252 /*
253  *   This will generate vector subscript range-check code.
254  *   Useful for debugging, but it slows things down of course.
255  *
256  */
257 
258 #endif
```



---

Comment by @kliem created at 2020-12-29 09:00:15

So I guess we have to patch NTL as to avoid those flags by configuration.


---

Comment by @kliem created at 2020-12-29 09:10:42

The relevant configuration is done in `src/DoConfig`, which is unfortunately perl (yet another language whichs syntax I do not understand).

But one might even define those things as environment variables and this might be passed through??

In `src/DoConfig` there is the following list:


```
 55 %ConfigFlag = (
 56 
 57 'NTL_LEGACY_NO_NAMESPACE' => 'off',
 58 'NTL_LEGACY_INPUT_ERROR'  => 'off',
 59 'NTL_DISABLE_LONGDOUBLE'  => 'off',
 60 'NTL_DISABLE_LONGLONG'    => 'off',
 61 'NTL_DISABLE_LL_ASM'      => 'off',
 62 'NTL_MAXIMIZE_SP_NBITS'   => 'off',
 63 'NTL_LEGACY_SP_MULMOD'    => 'off',
 64 'NTL_THREADS'             => 'on',
 65 'NTL_TLS_HACK'            => 'on',
 66 'NTL_EXCEPTIONS'          => 'off',
 67 'NTL_STD_CXX11'           => 'on',
 68 'NTL_STD_CXX14'           => 'off',
 69 'NTL_DISABLE_MOVE_ASSIGN' => 'on',
 70 'NTL_DISABLE_MOVE'        => 'off',
 71 'NTL_THREAD_BOOST'        => 'on',
 72 'NTL_GMP_LIP'             => 'on',
 73 'NTL_GF2X_LIB'            => 'off',
 74 'NTL_X86_FIX'             => 'off',
 75 'NTL_NO_X86_FIX'          => 'off',
 76 'NTL_NO_INIT_TRANS'       => 'on',
 77 'NTL_CLEAN_INT'           => 'off',
 78 'NTL_CLEAN_PTR'           => 'on',
 79 'NTL_SAFE_VECTORS'        => 'on',
 80 'NTL_RANGE_CHECK'         => 'off',
 81 'NTL_ENABLE_AVX_FFT'      => 'off',
 82 'NTL_AVOID_AVX512'        => 'off',
 83 
 84 
 85 'NTL_SPMM_ULL'            => 'off',
 86 'NTL_AVOID_BRANCHING'     => 'off',
 87 'NTL_FFT_BIGTAB'          => 'off',
 88 'NTL_FFT_LAZYMUL'         => 'off',
 89 'NTL_TBL_REM'             => 'off',
 90 'NTL_CRT_ALTCODE'         => 'off',
 91 'NTL_CRT_ALTCODE_SMALL'   => 'off',
 92 'NTL_GF2X_NOINLINE'       => 'off',
 93 'NTL_GF2X_ALTCODE'        => 'off',
 94 'NTL_GF2X_ALTCODE1'       => 'off',
 95 
 96 
 97 );
```


What makes me thing that it might be AVX512 related, is that we haven't encountered this before. Github workflows is the only place where I encountered processors capable of AVX512.


---

Comment by mkoeppe created at 2020-12-29 18:54:33

I agree that `NTL_AVOID_AVX512` is a top suspect here. 
Perhaps it can be passed to `configure`, like we already pass `NATIVE=off` when `SAGE_FAT_BINARY=yes`?


---

Comment by @kliem created at 2020-12-29 21:05:33

Ok. Lets try that. How do I test it? Do I just start the cygwin actions with that? What tickets do I need to pull yet?
----
New commits:


---

Comment by mkoeppe created at 2020-12-29 21:11:33

Run it with #31064 (or #29152)


---

Comment by @kliem created at 2020-12-29 21:15:44

https://github.com/kliem/sage/actions/runs/451492157


---

Comment by @kliem created at 2020-12-31 09:56:56

iii-a already failed. Is this permanent? Should I just rerun?

https://github.com/kliem/sage/runs/1625789472?check_suite_focus=true


---

Comment by mkoeppe created at 2021-01-01 20:56:16

Hm. This failure is from `fpylll` - I have created #31146 for this.

Note that `cygwin-standard` does not build `ntl` because it finds the package provided by `cygwin`. Would need to test `cygwin-minimal`


---

Comment by @kliem created at 2021-01-01 21:47:49

ok, I started cygwin-minimal.

But now I'm confused. How does this relate to the ticket description?

By default the github workflow does not set `SAGE_FAT_BINARY` it seems, so of course one cannot use it locally.


---

Comment by mkoeppe created at 2021-01-01 21:58:44

Looks like the ticket description is outdated and cygwin's ntl package is accepted in current sage.


---

Comment by embray created at 2021-01-05 09:46:46

This is also related to [this issue](https://github.com/sagemath/sage-windows/issues/53) with Sage Windows, due to the fact that the NTL package for Cygwin is not built with `NATIVE=off` (and I was building Sage with the system package).

I reported the issue to the package maintainer who has rebuilt the package: https://cygwin.com/pipermail/cygwin/2020-December/247206.html


---

Comment by mkoeppe created at 2021-03-04 17:02:16

I have encountered a similar problem again on Cygwin. This time it seems to come from OpenBLAS. 

The Cygwin build takes place in multiple stages, passing on partial builds of $SAGE_LOCAL to the next stages via artifacts.
I have now seen several instances (latest: 
in which the artifacts contain native instructions that lead to SIGILL on use in the next stage.

For example, in https://github.com/mkoeppe/sage/runs/2029013426?check_suite_focus=true aborts early in the sagelib build. On a local machine I can reproduce it as well by downloading the artifact. Using `gdb` it can be seen that merely importing some `numpy` modules already gives `SIGILL`.

Perhaps the latest change to OpenBLAS in #22179 needs revisiting.


---

Comment by mkoeppe created at 2021-03-06 20:41:30

Testing with revert of #22179 (for Cygwin) in https://github.com/mkoeppe/sage/actions/runs/628022275


---

Comment by embray created at 2021-03-08 13:20:05

This might also be related to https://github.com/sagemath/sage-windows/issues/57

NTL is working now on sage-windows, but I suspect there is a portability issue with OpenBLAS (thought it is resulting in segfaults, apparently, not illegal instructions).


---

Comment by mkoeppe created at 2021-03-08 13:29:57

Thanks for the pointer. 

Even with reverting #22179 (for Cygwin), I'm still getting SIGILL, but (apparently) from numpy itself, in `PyInit__multiarray_umath`. It should be checked if numpy is somehow configuring itself using different CFLAGS


---

Comment by mkoeppe created at 2021-03-09 08:27:14

I think we may have to use `-march=...` explicitly to fix numpy


---

Comment by @kliem created at 2021-03-09 11:06:24

https://github.com/numpy/numpy/blob/cb557b79fa0ce467c881830f8e8e042c484ccfaa/doc/source/reference/simd/simd-optimizations.rst

This is the page to look at, I guess. If I understand correctly, we need to build numpy with `--cpu-baseline=NONE` if `SAGE_FAT_BINARY`.


---

Comment by embray created at 2021-03-09 15:04:24

Replying to [comment:30 gh-kliem]:
> https://github.com/numpy/numpy/blob/cb557b79fa0ce467c881830f8e8e042c484ccfaa/doc/source/reference/simd/simd-optimizations.rst
> 
> This is the page to look at, I guess. If I understand correctly, we need to build numpy with `--cpu-baseline=NONE` if `SAGE_FAT_BINARY`.

Thanks for finding that.  I knew about the new SIMD stuff in Numpy, but not about the new associated compilation options (nor the fact that we weren't using them yet).

I think `--cpu-baseline=MIN` should also be good-enough to run on the vast, vast majority of machines that are modern enough to even be capable of running Sage.

We should also look into `--cpu-dispatch`.  It will result in larger binaries, but IIUC will allow Numpy to perform runtime CPU feature detection and call the correct implementations.


---

Comment by @kliem created at 2021-03-09 15:11:52

I agree that we should consider `--cpu-dispatch` for our binaries.

I don't think `--cpu-baseline=MIN` will work. If compiled on an `x86` this will return `SSE SSE2`, but that won't work on apples M1.

The problem is that `--cpu-baseline=MIN` still assumes a similar architecture.


---

Comment by embray created at 2021-03-09 15:44:09

Replying to [comment:32 gh-kliem]:
> I don't think `--cpu-baseline=MIN` will work. If compiled on an `x86` this will return `SSE SSE2`, but that won't work on apples M1.
> 
> The problem is that `--cpu-baseline=MIN` still assumes a similar architecture.

I don't think that's true.  If you look at the docs you linked, the meaning of baseline=MIN is architecture-dependent.  It won't enable features that are not relevant for the target architecture.

Of course, that means we need to build Sage binaries for aarch64 but that's already the case anyways I assume.


---

Comment by mkoeppe created at 2021-03-09 19:31:12

Let's ignore the harder problem of building universal binaries that work on both `x86_64` and `arm`.

Using `--cpu-dispatch` when `SAGE_FAT_BINARY` is set sounds like the right solution. Could one of you prepare a branch please?


---

Comment by mkoeppe created at 2021-03-09 19:58:30

Changing priority from critical to blocker.


---

Comment by git created at 2021-03-09 20:17:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-09 20:29:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-10 18:58:41

I ran this also in https://github.com/mkoeppe/sage/actions/runs/637210121 (on top of #25993 and other tickets - https://github.com/mkoeppe/sage/tree/ci-25993-2021-03-05-29827-29537)
and I am still getting SIGSEGVs from plotting and SIGILLs


---

Comment by mkoeppe created at 2021-03-10 18:59:42

Erik, in https://groups.google.com/g/sage-devel/c/s_inhvSxLp8/m/Vtb35oYcAgAJ you say you have fixed it in the windows binary build --- what's the solution?


---

Comment by embray created at 2021-03-12 11:51:07

Replying to [comment:41 mkoeppe]:
> Erik, in https://groups.google.com/g/sage-devel/c/s_inhvSxLp8/m/Vtb35oYcAgAJ you say you have fixed it in the windows binary build --- what's the solution?

The issue on the NTL side was fixed: https://github.com/sagemath/sage-windows/issues/53

The solution was to not use the NTL package from Cygwin and custom compile it instead.

I also brought the issue up with the package maintainer: https://cygwin.com/pipermail/cygwin/2020-December/247196.html

He has released a new version of the package to address it: https://cygwin.com/pipermail/cygwin/2020-December/247205.html

He still rebuilt it, with my perhaps fault suggestion of including `CXXFLAGS=-mavx`, which others have rightfully pointed out will still make it less portable, though I think that's how I built it as well.

He released another new NTL package in January but I'm not sure whether or not it changes anything about this: https://cygwin.com/pipermail/cygwin/2021-January/247439.html

The NTL fix definitely worked for some, but others are still reporting segfaults in plotting, so I think that has to do either with OpenBLAS or Numpy, but I haven't been able to gather enough details: https://github.com/sagemath/sage-windows/issues/57


---

Comment by embray created at 2021-03-12 11:59:17

Replying to [comment:40 mkoeppe]:
> I ran this also in https://github.com/mkoeppe/sage/actions/runs/637210121 (on top of #25993 and other tickets - https://github.com/mkoeppe/sage/tree/ci-25993-2021-03-05-29827-29537)
> and I am still getting SIGSEGVs from plotting and SIGILLs 

Do we know anything about the CPU architecture of the machines these builds are being run on?  I looked through the logs but didn't find anything.  It might be helpful to add a `cat /proc/cpuinfo` somewhere.


---

Comment by embray created at 2021-03-12 12:17:02

Possibly related but I'm not sure since others are reporting it's fixed in 1.19.4.  I didn't know Numpy was now installing its own copies of libraries in `numpy.libs` when you install from a wheel.  I don't think that should be affecting Sage, but it's worth a look: https://github.com/numpy/numpy/issues/17674


---

Comment by embray created at 2021-03-12 12:19:22

Worth a look in part because Numpy with OpenBLAS 0.3.12 was causing segfaults, so they reverted to OpenBLAS 0.3.9: https://github.com/numpy/numpy/pull/17680 

We are using 0.3.13 which might also have problems with Numpy, though I wish I had more insight into what those problems actually are.


---

Comment by embray created at 2021-03-12 12:25:38

Many seem to have suggested it might have to do with OpenBLAS threading.  Could we try setting `export OPENBLAS_NUM_THREADS=1` and see if it makes any difference?


---

Comment by embray created at 2021-03-12 12:30:30

Alas, Sage 9.2 has OpenBLAS 0.3.9, so I guess this is not directly related to the people reporting this against Sage 9.2 for Windows :/


---

Comment by mkoeppe created at 2021-03-12 16:02:42

Replying to [comment:46 embray]:
> Many seem to have suggested it might have to do with OpenBLAS threading.  Could we try setting `export OPENBLAS_NUM_THREADS=1` and see if it makes any difference?

We already set this in `src/bin/sage-env`


---

Comment by git created at 2021-03-12 16:17:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-12 16:18:17

Replying to [comment:43 embray]:
> Replying to [comment:40 mkoeppe]:
> > I ran this also in https://github.com/mkoeppe/sage/actions/runs/637210121 (on top of #25993 and other tickets - https://github.com/mkoeppe/sage/tree/ci-25993-2021-03-05-29827-29537)
> > and I am still getting SIGSEGVs from plotting and SIGILLs 
> 
> Do we know anything about the CPU architecture of the machines these builds are being run on? 

Only that it varies even within one run.

> I looked through the logs but didn't find anything.  It might be helpful to add a `cat /proc/cpuinfo` somewhere.

I have added it at the beginning of each job


---

Comment by mkoeppe created at 2021-03-12 16:24:15

Replying to [comment:42 embray]:
> The issue on the NTL side was fixed: https://github.com/sagemath/sage-windows/issues/53
> 
> The solution was to not use the NTL package from Cygwin and custom compile it instead.
> 
> I also brought the issue up with the package maintainer: [...]
> He released another new NTL package in January but I'm not sure whether or not it changes anything about this: https://cygwin.com/pipermail/cygwin/2021-January/247439.html
> 
> The NTL fix definitely worked for some [...]

Thanks a lot for the details on NTL. I haven't seen the NTL-related failures in a while, so let's assume it is fixed by the changes to the Cygwin package.  (But unrelated issues currently block the `cygwin-minimal` build -- so we cannot be sure yet that our NTL works in this configuration.)


---

Comment by git created at 2021-03-12 21:29:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-12 21:37:02

Changing status from new to needs_review.


---

Comment by git created at 2021-03-12 21:54:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-13 06:25:57

In https://github.com/mkoeppe/sage/runs/2099002937?check_suite_focus=true I see a build failure:

```
  ...
  [openblas-0.3.13]   /usr/lib/gcc/x86_64-pc-cygwin/10/../../../../x86_64-pc-cygwin/bin/ld: cannot export zlatm6_: symbol not defined
  [openblas-0.3.13]   /usr/lib/gcc/x86_64-pc-cygwin/10/../../../../x86_64-pc-cygwin/bin/ld: cannot export zlatm6_: symbol not defined
  [openblas-0.3.13]   /usr/lib/gcc/x86_64-pc-cygwin/10/../../../../x86_64-pc-cygwin/bin/ld: cannot export zlatme_: symbol not defined
  ...
```



---

Comment by mkoeppe created at 2021-03-13 06:44:21

The full log does not reveal a specific error message, but building one object fails, it looks like gcc crashes. 

And in a second attempt in the same run, the build succeeds.


---

Attachment


---

Comment by mkoeppe created at 2021-03-13 20:37:42

Upon restarting the workflow, the `openblas` build succeeds without issues. 
Running into rebasing issues again (haven't seen this in a while!) https://github.com/mkoeppe/sage/runs/2103478775?check_suite_focus=true

```
  [pillow-8.0.1]         0 [main] python3 47699 child_info_fork::abort: address space needed by 'Scanners.cpython-38-x86_64-cygwin.dll' (0x400000) is already occupied
  [pillow-8.0.1]         0 [main] python3 47700 child_info_fork::abort: address space needed by 'Scanners.cpython-38-x86_64-cygwin.dll' (0x400000) is already occupied
```



---

Comment by git created at 2021-03-14 20:19:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2021-03-17 16:04:23

That's weird.  `Scanners.cpython-38-x86_64-cygwin.dll` is part of Cython.  This suggests that rebase failed after installing Cython, or possibly that Cython had just been installed but the rebase lock was still held.  It doesn't look that way from the logs though; I would have thought Cython was installed in an earlier stage.


---

Comment by embray created at 2021-03-17 16:12:38

From the logs from the previous stage of that run:


```
Copying package files from temporary location /opt/sage-461876e6c77b59756ad9db557c884486eb40881e/var/tmp/sage/build/cython-0.29.21/inst to /opt/sage-461876e6c77b59756ad9db557c884486eb40881e
Waiting for rebase lock
Getting list of dlls. This may take a while...
Now rebasing...
Successfully installed cython-0.29.21
```


So that's mysterious.


---

Comment by mkoeppe created at 2021-03-17 16:36:16

Thanks for looking into this -- I really need your expertise here! 

I run rebasing at the end of `.github/workflows/extract-sage-local.sh` - to make sure that the downloaded stages that have been built in parallel can work together.


---

Comment by embray created at 2021-03-17 16:36:32

On [this build](https://github.com/mkoeppe/sage/runs/2129378838?check_suite_focus=true) I notice during "Extract sage-local artifact":


```
Filesystem       Size  Used Avail Use% Mounted on
C:/tools/cygwin  256G  170G   86G  67% /
D:                14G  2.2G   12G  16% /cygdrive/d
Getting list of dlls. This may take a while...
Now rebasing...
rebaseall: only ash or dash processes are allowed during rebasing
    Exit all Cygwin processes and stop all Cygwin services.
    Execute ash (or dash) from Start/Run... or a cmd or command window.
    Execute '/bin/rebaseall' from ash (or dash).
Error: Process completed with exit code 1.
```


If you want to do a full rebase in this step it can't be called from a shell script run with /bin/bash.  The script either needs to be run with dash, or as a separate command with dash.


---

Comment by mkoeppe created at 2021-03-17 16:37:34

Yes, in this run I tried to fix the problem by changing to `rebaseall`...


---

Comment by embray created at 2021-03-17 16:41:57

Replying to [comment:66 mkoeppe]:
> Yes, in this run I tried to fix the problem by changing to `rebaseall`...

Ah, OK.  I think that's a good idea.  It just needs to be run outside a Cygwin process with no other Cygwin processes running (since it can also modify the cygwin DLL itself and other support libraries that are not normally touched by plain `rebase`).


---

Comment by mkoeppe created at 2021-03-17 16:51:01

Is this the cygwin `dash` that should be used?


---

Comment by embray created at 2021-03-17 17:19:20

Yes, or you can just call `C:\cygwin64\bin\rebaseall` directly without going through a shell, I think.


---

Comment by mkoeppe created at 2021-03-17 18:18:35

Right, but I want to keep it in the extraction script so that it is easy to use manually too


---

Comment by mkoeppe created at 2021-03-17 18:33:11

OK, testing with dash at https://github.com/mkoeppe/sage/actions/runs/662065807


---

Comment by mkoeppe created at 2021-03-17 21:58:22

This worked! https://github.com/mkoeppe/sage/runs/2134463553

I'll push the fixes to this ticket.


---

Comment by git created at 2021-03-17 22:06:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-17 22:14:31

Now testing at https://github.com/mkoeppe/sage/actions/runs/662602246


---

Comment by mkoeppe created at 2021-03-18 22:19:24

With the rebasing fixes applied, I am getting again to `sage-iii` (https://github.com/mkoeppe/sage/runs/2140904387?check_suite_focus=true)

```
  [sagelib-9.3.beta9]   Generating auto-generated sources
  [sagelib-9.3.beta9]   Building interpreters for fast_callable
  [sagelib-9.3.beta9]   -> First build of interpreters
  [sagelib-9.3.beta9]   running build_cython
  [sagelib-9.3.beta9]   Enabling Cython debugging support
  [sagelib-9.3.beta9]   /cygdrive/d/a/sage/sage/build/pkgs/sagelib/spkg-install: line 58: 61038 Illegal instruction     (core dumped) python3 -u setup.py --no-user-cfg build install
```

which is again coming from `numpy`, I think.
Help....


---

Comment by mkoeppe created at 2021-03-19 03:32:02

But the current branch is already an improvement, so let's get this in...


---

Comment by @kliem created at 2021-03-19 08:33:58

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-03-19 08:33:58

LGTM.


---

Comment by mkoeppe created at 2021-03-19 15:47:48

Thanks!


---

Comment by mkoeppe created at 2021-03-19 16:49:28

Follow-up in #31521


---

Comment by vbraun created at 2021-03-20 15:31:32

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-03-20 15:31:32

Merge conflict

```
    STDOUT: Auto-merging tox.ini
    STDOUT: Auto-merging .github/workflows/ci-cygwin-standard.yml
    STDOUT: CONFLICT (content): Merge conflict in .github/workflows/ci-cygwin-standard.yml
    STDOUT: Auto-merging .github/workflows/ci-cygwin-minimal.yml
    STDOUT: CONFLICT (content): Merge conflict in .github/workflows/ci-cygwin-minimal.yml
    STDOUT: Automatic merge failed; fix conflicts and then commit the result.
```



---

Comment by git created at 2021-03-20 16:04:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-20 16:05:24

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-03-22 23:54:13

Resolution: fixed
