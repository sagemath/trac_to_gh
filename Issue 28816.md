# Issue 28816: Installation manual: Generate 'apt-get install' and 'yum install' lines from build/pkgs at ./bootstrap time

Issue created by migration from https://trac.sagemath.org/ticket/29053

Original creator: mkoeppe

Original creation time: 2020-01-20 15:02:23

CC:  dimpase embray arojas isuruf @timokau

https://doc.sagemath.org/html/en/installation/source.html#linux-recommended-installation
gives `apt-get install` and `yum install` command lines to install system packages that will be recognized by `build/pkgs/SPKG/spkg-configure.m4`.

Several packages are missing, see comments in
https://trac.sagemath.org/attachment/ticket/27824/Dockerfile-ubuntu-minimal

We propose to put this information on a per-package basis into `build/pkgs/SPKG/apt`, `.../yum` or similarly named files and to aggregate it during `./bootstrap` to produce the command lines shown in the manual.

(Similar to #29041.)


---

Comment by git created at 2020-01-21 03:53:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-25 03:27:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-25 04:10:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-25 04:31:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-25 07:41:25

how do you generate these per package?

by the way, Arch has namewise
a naming scheme close to Gentoo and Homebrew.


---

Comment by mkoeppe created at 2020-01-25 13:53:06

Replying to [comment:7 dimpase]:
> how do you generate these per package?

I created these files by manual copy-paste from the installation manual.


---

Comment by git created at 2020-01-25 18:03:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-25 18:07:13

Changing component from documentation to build.


---

Comment by git created at 2020-01-26 00:01:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-26 00:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-26 00:35:20

Changing status from new to needs_review.


---

Comment by git created at 2020-01-26 02:10:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-26 02:20:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-26 04:08:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-26 04:33:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-26 12:01:53

gf2x 1.3.0 is also on Arch, so you can add it (package name `gf2x`). It'll work after #29081 is merged.


---

Comment by dimpase created at 2020-01-26 12:09:01

You've changed `build/pkgs/gfortran/type` to `standard` - is this intentional?


---

Comment by mkoeppe created at 2020-01-26 14:55:35

Replying to [comment:23 dimpase]:
> You've changed `build/pkgs/gfortran/type` to `standard` - is this intentional?
Yes - it's an intended correction.


---

Comment by dimpase created at 2020-01-26 15:36:15

Replying to [comment:24 mkoeppe]:
> Replying to [comment:23 dimpase]:
> > You've changed `build/pkgs/gfortran/type` to `standard` - is this intentional?
> Yes - it's an intended correction.

can this be documented - ideally both here and in the commit message?

I guess it was `optional` just as it predated the `spkg-configure.m4` machinery, and it was not fixed then, right?


---

Comment by mkoeppe created at 2020-01-26 15:39:28

Replying to [comment:25 dimpase]:
> Replying to [comment:24 mkoeppe]:
> > Replying to [comment:23 dimpase]:
> > > You've changed `build/pkgs/gfortran/type` to `standard` - is this intentional?
> > Yes - it's an intended correction.
> 
> can this be documented - ideally both here and in the commit message?

The commit message already says:

```
â€‹97b09de	Make gfortran a standard package - it is a prereq of standard package numpy
```

> I guess it was `optional` just as it predated the `spkg-configure.m4` machinery, and it was not fixed then, right?

Yes, I agree with this theory.


---

Comment by mkoeppe created at 2020-01-26 15:45:38

I've added a comment on the ticket summary.


---

Comment by isuruf created at 2020-01-26 15:51:43

Can you use just one file? Or put them into a new folder inside?


---

Comment by git created at 2020-01-26 16:00:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-26 16:01:43

Replying to [comment:29 isuruf]:
> Can you use just one file? Or put them into a new folder inside?

Good suggestion, I'll put them into a new subfolder. 

I'm also looking for a good solution for distro versioning. For example, ubuntu before bionic is missing many packages


---

Comment by git created at 2020-01-26 16:13:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2020-01-26 17:08:25

Added conda as well. We can generate the environment.yml from this.
----
New commits:


---

Comment by isuruf created at 2020-01-26 17:10:18

There are some packages here that don't have `spkg-configure.m4`. Should those be removed?


---

Comment by isuruf created at 2020-01-26 17:16:52

Did you use a script to generate `src/doc/en/installation/fedora.txt`?


---

Comment by mkoeppe created at 2020-01-26 17:20:35

Replying to [comment:35 isuruf]:
> There are some packages here that don't have `spkg-configure.m4`. Should those be removed?
No, that's OK and good preparation for when that is added. 
I'll update the scripts to only use packages that do have spkg-configure.m4`.


---

Comment by mkoeppe created at 2020-01-26 17:21:04

Replying to [comment:34 isuruf]:
> Added conda as well. We can generate the environment.yml from this.
> ----
> New commits:
> ||[1cfa89b](https://git.sagemath.org/sage.git/commit?id=1cfa89b91b766030c361ef0e04474b7a4a639258)||`Add conda.txt`||

Great! Thanks very much


---

Comment by mkoeppe created at 2020-01-26 17:22:59

Replying to [comment:36 isuruf]:
> Did you use a script to generate `src/doc/en/installation/fedora.txt`?
No, not yet. This is only taken out from the manual. I haven't written the formatting script yet.


---

Comment by mkoeppe created at 2020-01-27 05:15:51

More changes at https://github.com/mkoeppe/sage/commits/test-29053-on-29051
----
New commits:


---

Comment by mkoeppe created at 2020-01-27 15:27:55

`@`isuruf: Compiling python3 on conda-forge gives me an error that looks like it's related to ffi - https://github.com/mkoeppe/sage/runs/410329852


---

Comment by arojas created at 2020-01-27 15:32:53

Arch package sage-data-elliptic_curves corresponds to Sage's elliptic_curves, not to the optional database_cremona_ellcurve


---

Comment by isuruf created at 2020-01-27 16:16:53

Replying to [comment:42 mkoeppe]:
> `@`isuruf: Compiling python3 on conda-forge gives me an error that looks like it's related to ffi - https://github.com/mkoeppe/sage/runs/410329852

Looks like you are not activating the conda environment.


---

Comment by git created at 2020-01-27 16:30:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-27 16:32:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-27 16:32:29

Replying to [comment:43 arojas]:
> Arch package sage-data-elliptic_curves corresponds to Sage's elliptic_curves, not to the optional database_cremona_ellcurve
Thank you! Fixed.


---

Comment by mkoeppe created at 2020-01-27 17:23:27

Ready for review.


---

Comment by git created at 2020-01-27 19:30:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-27 22:59:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-27 23:13:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-28 00:30:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-28 02:00:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-28 02:05:52

Replying to [comment:44 isuruf]:
> Replying to [comment:42 mkoeppe]:
> > `@`isuruf: Compiling python3 on conda-forge gives me an error that looks like it's related to ffi - https://github.com/mkoeppe/sage/runs/410329852
> 
> Looks like you are not activating the conda environment.
Thank you! That helped.
But now (https://github.com/mkoeppe/sage/runs/412042067), still in the python3 build, I am hitting again #29012:

```
Testing importing of various modules...
ctypes module imported OK
math module imported OK
hashlib module imported OK
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Lib/crypt.py", line 3, in <module>
    import _crypt
ModuleNotFoundError: No module named '_crypt'
crypt module failed to import
```



---

Comment by isuruf created at 2020-01-28 03:14:50

Looks like python's setup.py doesn't find the conda compiler's sysroot. https://github.com/python/cpython/blob/v3.7.3/setup.py#L867


---

Comment by git created at 2020-01-28 12:27:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-28 23:04:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-29 19:44:14

there are no `distros/` for `boost_cropped/` for some reason.
(I've added these on #29100)


---

Comment by dimpase created at 2020-01-29 21:48:54

looks OK to me.


---

Comment by dimpase created at 2020-01-29 21:49:11

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-01-29 21:59:02

Thank you!


---

Comment by dimpase created at 2020-01-31 22:58:35

What's suprising to me is that these GH Actions don't time out, as these builds take quite a while...


---

Comment by mkoeppe created at 2020-01-31 23:03:06

It's quite generous - it provides  6 hours per job and up to 20 Jobs in parallel.


---

Comment by vbraun created at 2020-01-31 23:49:34

Resolution: fixed


---

Comment by mkoeppe created at 2020-02-01 15:04:06

added follow-up ticket to the description


---

Comment by embray created at 2020-02-05 11:51:16

Somehow missed this in the fervor over other issues, but this kicks ass, thank you!  I'll open a ticket to adding cygwin to this as well.  repology.org also just recently added Cygwin.


---

Comment by embray created at 2020-02-05 11:52:55

One thing I might suggest is that rather than having the distro-specific commands hard-coded in `sage-spkg`, they could go in a text file or something, with the option to override and/or add support for other distros without having to patch sage-spkg.

That could be done in a follow-up though.


---

Comment by dimpase created at 2020-02-05 13:32:27

Replying to [comment:71 embray]:
> Somehow missed this in the fervor over other issues, but this kicks ass, thank you!  I'll open a ticket to adding cygwin to this as well.  repology.org also just recently added Cygwin.

see, mkoeppe practically buried me under his tickets, and then came you with #29118 :P


---

Comment by mkoeppe created at 2020-02-05 13:41:38

Replying to [comment:71 embray]:
>  I'll open a ticket to adding cygwin to this as well.  repology.org also just recently added Cygwin.

The cygwin ticket is #29106 (Add cygwin package information). It would be great if also corresponding CI scripts could be added, to help elevate the cygwin platform to a first class target for sage.


---

Comment by mkoeppe created at 2020-02-05 20:20:31

Replying to [comment:72 embray]:
> One thing I might suggest is that rather than having the distro-specific commands hard-coded in `sage-spkg`, they could go in a text file or something, with the option to override and/or add support for other distros without having to patch sage-spkg.
> 
> That could be done in a follow-up though.

Thanks, I have added this suggestion to #29146, which already has a number of ideas for improvements.


---

Comment by mkoeppe created at 2020-02-16 18:14:55

(sorry, pushed to the wrong ticket by accident)


---

Comment by fbissey created at 2020-02-28 01:32:54

Somehow in recent merges I experienced failure to build the documentation in sage-on-gentoo. It seems the `literalinclude` are causing me trouble.

```
[installat] The HTML pages are in ../../build_doc/html/en/installation.
Error building the documentation.
Traceback (most recent call last):
  File "sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 1720, in main
    builder()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 336, in _wrapper
    build_many(build_other_doc, L)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/__init__.py", line 280, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
OSError: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/doc/en/installation/source.rst:228: WARNING: Include file '/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/doc/en/installation/debian.txt' not found or reading it failed
```

I am thinking of removing the installation instruction from sage-on-gentoo but I am curious at what could have caused this. Especially when you consider that it started happening sometime after this ticket was merged. My last successful build of volker's branch is dated 20th of February and would corresponding to the first merging attempt of #21785.


---

Comment by mkoeppe created at 2020-02-28 01:43:41

Replying to [comment:78 fbissey]:
> Somehow in recent merges I experienced failure to build the documentation in sage-on-gentoo. It seems the `literalinclude` are causing me trouble.
> {{{
> [installat] The HTML pages are in ../../build_doc/html/en/installation.
> Error building the documentation.
> ...
> OSError: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/doc/en/installation/source.rst:228: WARNING: Include file '/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/doc/en/installation/debian.txt' not found or reading it failed
> }}}

Yes, as of #26964, these files are being generated by `bootstrap` and are not sources in the git tree any more.

Distributors should build either from a bootstrapped source tree or from a sagelib sdist (see  ticket #21516 - Fix sagelib sdist (src/setup.py sdist); which needs help).

> I am thinking of removing the installation instruction from sage-on-gentoo 

Yes, there's no point in shipping the installation manual with a distribution package.


---

Comment by fbissey created at 2020-02-28 01:52:00

I see, a sagelib sdist is a good development as it makes it more like a regular python package I guess. But right now I am missing the ability to build sagelib directly from git head. Thanks for explanation.


---

Comment by dimpase created at 2020-03-03 11:23:41

This has missed 	`build/pkgs/r/` from #28884.
I've opened #29273 to deal with it.


---

Comment by isuruf created at 2020-03-11 16:59:04

Replying to [comment:56 mkoeppe]:
> Replying to [comment:44 isuruf]:
> > Replying to [comment:42 mkoeppe]:
> > > `@`isuruf: Compiling python3 on conda-forge gives me an error that looks like it's related to ffi - https://github.com/mkoeppe/sage/runs/410329852
> > 
> > Looks like you are not activating the conda environment.
> Thank you! That helped.
> But now (https://github.com/mkoeppe/sage/runs/412042067), still in the python3 build, I am hitting again #29012:
> {{{
> Testing importing of various modules...
> ctypes module imported OK
> math module imported OK
> hashlib module imported OK
> Traceback (most recent call last):
>   File "<string>", line 1, in <module>
>   File "/sage/local/var/tmp/sage/build/python3-3.7.3.p1/src/Lib/crypt.py", line 3, in <module>
>     import _crypt
> ModuleNotFoundError: No module named '_crypt'
> crypt module failed to import
> }}}

This patch might help https://github.com/conda-forge/python-feedstock/blob/master/recipe/patches/0014-Fix-cross-compilation-on-Debian-based-distros.patch
