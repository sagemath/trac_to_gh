# Issue 11588: 'sage-location' shouldn't "initialize" .pc (pkg-config) files more than once

archive/issues_011588.json:
```json
{
    "body": "Keywords: pkgconfig libpng\n\nThe logic of \"initializing\" `.pc` files exactly once is currently broken, which at the moment \"only\" causes trouble with libpng if `pkg-config` is installed.\n\nThe main reason is that `sage-location` doesn't really check whether a `.pc` file already contains a definition of `SAGE_ROOT`, and unconditionally replaces any occurrences of `$SAGE_ROOT` (i.e., its current value) by `${SAGE_ROOT}`, then adding a (in the case of `update_pkgconfig_files()`, *replacing* the first) line defining `SAGE_ROOT` to have the current value.\n\nThe specific problem with libpng (see e.g. #11686, which was originally intended to just again fix a *completely unrelated* issue with the matplotlib spkg) arises since it installs *both* a `libpng12.pc` file *and a symbolic link* `libpng.pc`, the latter pointing to the former. `sage-location` now \"initializes\" all of Sage's `.pc` files, not checking whether a `.pc` file is just a symbolic link to another one, nor checking whether a file already got modified as mentioned above.\n\nNote that the \"initialization\" doesn't take place *during* a build, but when Sage is started for the first time, also when e.g. running tests, such that problems with modified `.pc` files occur later, when one tries to (re)install some package(s), which includes *upgrading* Sage.\n\nIn the long run, `sage-location` shouldn't (have to) deal with `.pc` files at all, but we IMHO need a **quick fix** until we have a better, more general solution to *all* issues with `pkg-config`. (There are a couple of other issues; cf. for example #10202, #9668, #11687.) Therefore *this* ticket isn't intended to fix any of the other issues.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11760\n\n",
    "created_at": "2011-08-30T18:36:37Z",
    "labels": [
        "scripts",
        "blocker",
        "bug"
    ],
    "title": "'sage-location' shouldn't \"initialize\" .pc (pkg-config) files more than once",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11588",
    "user": "leif"
}
```
Keywords: pkgconfig libpng

The logic of "initializing" `.pc` files exactly once is currently broken, which at the moment "only" causes trouble with libpng if `pkg-config` is installed.

The main reason is that `sage-location` doesn't really check whether a `.pc` file already contains a definition of `SAGE_ROOT`, and unconditionally replaces any occurrences of `$SAGE_ROOT` (i.e., its current value) by `${SAGE_ROOT}`, then adding a (in the case of `update_pkgconfig_files()`, *replacing* the first) line defining `SAGE_ROOT` to have the current value.

The specific problem with libpng (see e.g. #11686, which was originally intended to just again fix a *completely unrelated* issue with the matplotlib spkg) arises since it installs *both* a `libpng12.pc` file *and a symbolic link* `libpng.pc`, the latter pointing to the former. `sage-location` now "initializes" all of Sage's `.pc` files, not checking whether a `.pc` file is just a symbolic link to another one, nor checking whether a file already got modified as mentioned above.

Note that the "initialization" doesn't take place *during* a build, but when Sage is started for the first time, also when e.g. running tests, such that problems with modified `.pc` files occur later, when one tries to (re)install some package(s), which includes *upgrading* Sage.

In the long run, `sage-location` shouldn't (have to) deal with `.pc` files at all, but we IMHO need a **quick fix** until we have a better, more general solution to *all* issues with `pkg-config`. (There are a couple of other issues; cf. for example #10202, #9668, #11687.) Therefore *this* ticket isn't intended to fix any of the other issues.

Issue created by migration from https://trac.sagemath.org/ticket/11760





---

archive/issue_comments_130526.json:
```json
{
    "body": "Changing keywords from \"pkgconfig libpng\" to \"pkgconfig libpng Duplicate definition SAGE_ROOT\".",
    "created_at": "2011-08-30T18:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130526",
    "user": "leif"
}
```

Changing keywords from "pkgconfig libpng" to "pkgconfig libpng Duplicate definition SAGE_ROOT".



---

archive/issue_comments_130527.json:
```json
{
    "body": "leif, this ticket is listed as blocker.  Any ideas for a quick fix?",
    "created_at": "2011-10-09T08:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130527",
    "user": "jdemeyer"
}
```

leif, this ticket is listed as blocker.  Any ideas for a quick fix?



---

archive/issue_comments_130528.json:
```json
{
    "body": "SCRIPTS repo. Based on Sage 4.7.2.alpha3.",
    "created_at": "2011-10-09T13:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130528",
    "user": "leif"
}
```

SCRIPTS repo. Based on Sage 4.7.2.alpha3.



---

archive/issue_comments_130529.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-09T14:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130529",
    "user": "leif"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_130530.json:
```json
{
    "body": "Attachment\n\nCouldn't resist to also do some clean-up.\n\nActual (trivial) fix starting on line 178.",
    "created_at": "2011-10-09T14:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130530",
    "user": "leif"
}
```

Attachment

Couldn't resist to also do some clean-up.

Actual (trivial) fix starting on line 178.



---

archive/issue_comments_130531.json:
```json
{
    "body": "P.S.:\n\nThe fix doesn't *cure* already broken installations (i.e., `.pc` files already containing multiple definitions, like usually `libpng[12].pc`).\n\nTo test the patch, you can change the contents of or remove the file `$SAGE_ROOT/local/lib/sage-current-location.txt` (perhaps first removing the line `SAGE_ROOT=${SAGE_ROOT}` from `libpng12.pc`).  The former triggers `update_pkgconfig_files()`, the latter `initialize_pkgconfig_files()`.",
    "created_at": "2011-10-09T14:29:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130531",
    "user": "leif"
}
```

P.S.:

The fix doesn't *cure* already broken installations (i.e., `.pc` files already containing multiple definitions, like usually `libpng[12].pc`).

To test the patch, you can change the contents of or remove the file `$SAGE_ROOT/local/lib/sage-current-location.txt` (perhaps first removing the line `SAGE_ROOT=${SAGE_ROOT}` from `libpng12.pc`).  The former triggers `update_pkgconfig_files()`, the latter `initialize_pkgconfig_files()`.



---

archive/issue_comments_130532.json:
```json
{
    "body": "Replying to [comment:5 leif]:\n> The fix doesn't *cure* already broken installations (i.e., `.pc` files already containing multiple definitions, like usually `libpng[12].pc`).\n\nI could more or less easily also add that, but it wouldn't help much (on e.g. upgrades) since neither `update_pkgconfig_files()` nor `initialize_pkgconfig_files()` is called later, or more precisely, before we run into potential errors due to multiple definitions.",
    "created_at": "2011-10-09T14:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130532",
    "user": "leif"
}
```

Replying to [comment:5 leif]:
> The fix doesn't *cure* already broken installations (i.e., `.pc` files already containing multiple definitions, like usually `libpng[12].pc`).

I could more or less easily also add that, but it wouldn't help much (on e.g. upgrades) since neither `update_pkgconfig_files()` nor `initialize_pkgconfig_files()` is called later, or more precisely, before we run into potential errors due to multiple definitions.



---

archive/issue_comments_130533.json:
```json
{
    "body": "In lines 178-181:\n\n``` \n            if re.search(\"^SAGE_ROOT=\", config, re.MULTILINE): \n\t                # There's already a definition of SAGE_ROOT, \n\t                # so skip this file. (Cf. #11760). \n\t                continue \n```\n\nwhat if the path to SAGE_ROOT has changed?  Would it be better to delete this first line (containing `SAGE_ROOT=...`) and then proceed with the rest of the code in the loop?  I guess that these files shouldn't have SAGE_ROOT in them already at this point, but just in case?",
    "created_at": "2011-10-09T16:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130533",
    "user": "jhpalmieri"
}
```

In lines 178-181:

``` 
            if re.search("^SAGE_ROOT=", config, re.MULTILINE): 
	                # There's already a definition of SAGE_ROOT, 
	                # so skip this file. (Cf. #11760). 
	                continue 
```

what if the path to SAGE_ROOT has changed?  Would it be better to delete this first line (containing `SAGE_ROOT=...`) and then proceed with the rest of the code in the loop?  I guess that these files shouldn't have SAGE_ROOT in them already at this point, but just in case?



---

archive/issue_comments_130534.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> In lines 178-181:\n\n``` \n            if re.search(\"^SAGE_ROOT=\", config, re.MULTILINE): \n\t        # There's already a definition of SAGE_ROOT, \n\t        # so skip this file. (Cf. #11760). \n\t        continue \n```\n\n> what if the path to SAGE_ROOT has changed?\n\nThis is **`initialize`**`_pkgconfig_files()`, not `update_...()`.\n\n\n\n\n> Would it be better to delete this first line (containing `SAGE_ROOT=...`) and then proceed with the rest of the code in the loop?  I guess that these files shouldn't have SAGE_ROOT in them already at this point, but just in case?\n\nAs mentioned in the description, I was aiming at a *quick* fix which solves *the issue we have*, not at curing arbitrary corrupted `pkg-config` files.\n\nAlso, `initialize_pkgconfig_files()` is only called *once* (unless one messes around with Sage's files as noted for testing the patch).\n\nNevertheless, any *wrong* definition of `SAGE_ROOT` present during `initialize_pkgconfig_files()` will be corrected in the subsequent call to `update_pkgconfig_files()`.\n\n\n\n\nSince `sage-location` won't have to deal with `.pc` files in the long term anyway, it doesn't make sense to implement sophisticated consistency checks and corrections *there*.",
    "created_at": "2011-10-09T17:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130534",
    "user": "leif"
}
```

Replying to [comment:7 jhpalmieri]:
> In lines 178-181:

``` 
            if re.search("^SAGE_ROOT=", config, re.MULTILINE): 
	        # There's already a definition of SAGE_ROOT, 
	        # so skip this file. (Cf. #11760). 
	        continue 
```

> what if the path to SAGE_ROOT has changed?

This is **`initialize`**`_pkgconfig_files()`, not `update_...()`.




> Would it be better to delete this first line (containing `SAGE_ROOT=...`) and then proceed with the rest of the code in the loop?  I guess that these files shouldn't have SAGE_ROOT in them already at this point, but just in case?

As mentioned in the description, I was aiming at a *quick* fix which solves *the issue we have*, not at curing arbitrary corrupted `pkg-config` files.

Also, `initialize_pkgconfig_files()` is only called *once* (unless one messes around with Sage's files as noted for testing the patch).

Nevertheless, any *wrong* definition of `SAGE_ROOT` present during `initialize_pkgconfig_files()` will be corrected in the subsequent call to `update_pkgconfig_files()`.




Since `sage-location` won't have to deal with `.pc` files in the long term anyway, it doesn't make sense to implement sophisticated consistency checks and corrections *there*.



---

archive/issue_comments_130535.json:
```json
{
    "body": "Replying to [comment:8 leif]:\n> Nevertheless, any *wrong* definition of `SAGE_ROOT` present during `initialize_pkgconfig_files()` will be corrected in the subsequent call to `update_pkgconfig_files()`.\n\nAh, I see. `update_pkgconfig_files()` is *not* called in the *same* invocation of `sage-location` if `initialize_pkgconfig_files()` was called, since `install_moved()` in this case returns `False`.\n\nSo we *could* in principle add\n\n```diff\ndiff --git a/sage-location b/sage-location\n--- a/sage-location\n+++ b/sage-location\n@@ -68,6 +68,7 @@\n         write_location_file()\n         update_library_files()\n         initialize_pkgconfig_files()\n+        update_pkgconfig_files()\n         return False\n     elif path != SAGE_ROOT:\n         # location moved\n```\n\nbut that's IMHO really a minor issue since that situation doesn't occur unless *the user* damages his `pkg-config` files.",
    "created_at": "2011-10-09T17:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130535",
    "user": "leif"
}
```

Replying to [comment:8 leif]:
> Nevertheless, any *wrong* definition of `SAGE_ROOT` present during `initialize_pkgconfig_files()` will be corrected in the subsequent call to `update_pkgconfig_files()`.

Ah, I see. `update_pkgconfig_files()` is *not* called in the *same* invocation of `sage-location` if `initialize_pkgconfig_files()` was called, since `install_moved()` in this case returns `False`.

So we *could* in principle add

```diff
diff --git a/sage-location b/sage-location
--- a/sage-location
+++ b/sage-location
@@ -68,6 +68,7 @@
         write_location_file()
         update_library_files()
         initialize_pkgconfig_files()
+        update_pkgconfig_files()
         return False
     elif path != SAGE_ROOT:
         # location moved
```

but that's IMHO really a minor issue since that situation doesn't occur unless *the user* damages his `pkg-config` files.



---

archive/issue_comments_130536.json:
```json
{
    "body": "John, would the following make you happy?\n\n\n```diff\ndiff --git a/sage-location b/sage-location\n--- a/sage-location\n+++ b/sage-location\n@@ -167,6 +167,7 @@\n     the Sage installation has moved, i.e., paths have changed.\n     \"\"\"\n     import re\n+    pat = re.compile(r\"^SAGE_ROOT=.*\\n\", re.MULTILINE)\n     LIB = os.path.join(os.path.abspath(SAGE_ROOT), 'local', 'lib')\n     PKG = os.path.join(LIB, 'pkgconfig')\n     for name in os.listdir(PKG):\n@@ -175,10 +176,23 @@\n             with open(filename) as file:\n                 config = file.read()\n \n-            if re.search(\"^SAGE_ROOT=\", config, re.MULTILINE):\n-                # There's already a definition of SAGE_ROOT,\n-                # so skip this file. (Cf. #11760).\n-                continue\n+            first_match = pat.search(config)\n+            if first_match:\n+                # There are already one or more definitions of SAGE_ROOT,\n+                # which also happens if we previously processed the same\n+                # file (here) because of [symbolic or hard] links, so this\n+                # isn't necessarily an error. (Cf. #11760).\n+                # For simplicity, we just remove any definition, and only\n+                # issue a warning if there was more than one, and don't\n+                # check whether a previous definition was already current:\n+                config, n = pat.subn(\"\", config)\n+                if n>1:\n+                    sys.stderr.write(\n+                        \"Warning: sage_location: initialize_pkgconfig_files():\\n\" +\n+                        \"  File \\\"%s\\\" already contained %d definitions of SAGE_ROOT.\\n\" %\n+                            (name, n) +\n+                        \"  These will get replaced by a single, current definition.\\n\")\n+                    sys.stderr.flush()\n \n             new_config = config.replace(os.path.abspath(SAGE_ROOT), \"${SAGE_ROOT}\")\n             new_config = 'SAGE_ROOT=%s\\n' % os.path.abspath(SAGE_ROOT) + new_config\n```\n\n\nIf so, I'll just attach that patch, to be applied on top of the other one.",
    "created_at": "2011-10-09T19:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130536",
    "user": "leif"
}
```

John, would the following make you happy?


```diff
diff --git a/sage-location b/sage-location
--- a/sage-location
+++ b/sage-location
@@ -167,6 +167,7 @@
     the Sage installation has moved, i.e., paths have changed.
     """
     import re
+    pat = re.compile(r"^SAGE_ROOT=.*\n", re.MULTILINE)
     LIB = os.path.join(os.path.abspath(SAGE_ROOT), 'local', 'lib')
     PKG = os.path.join(LIB, 'pkgconfig')
     for name in os.listdir(PKG):
@@ -175,10 +176,23 @@
             with open(filename) as file:
                 config = file.read()
 
-            if re.search("^SAGE_ROOT=", config, re.MULTILINE):
-                # There's already a definition of SAGE_ROOT,
-                # so skip this file. (Cf. #11760).
-                continue
+            first_match = pat.search(config)
+            if first_match:
+                # There are already one or more definitions of SAGE_ROOT,
+                # which also happens if we previously processed the same
+                # file (here) because of [symbolic or hard] links, so this
+                # isn't necessarily an error. (Cf. #11760).
+                # For simplicity, we just remove any definition, and only
+                # issue a warning if there was more than one, and don't
+                # check whether a previous definition was already current:
+                config, n = pat.subn("", config)
+                if n>1:
+                    sys.stderr.write(
+                        "Warning: sage_location: initialize_pkgconfig_files():\n" +
+                        "  File \"%s\" already contained %d definitions of SAGE_ROOT.\n" %
+                            (name, n) +
+                        "  These will get replaced by a single, current definition.\n")
+                    sys.stderr.flush()
 
             new_config = config.replace(os.path.abspath(SAGE_ROOT), "${SAGE_ROOT}")
             new_config = 'SAGE_ROOT=%s\n' % os.path.abspath(SAGE_ROOT) + new_config
```


If so, I'll just attach that patch, to be applied on top of the other one.



---

archive/issue_comments_130537.json:
```json
{
    "body": "I could of course remove the temporary variable `first_match`; it's only there for documentation purposes. ;-)\n\nI.e.,\n\n```python\n            if pat.search(config):\n                ...\n```\n\nwould be sufficient.",
    "created_at": "2011-10-09T20:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130537",
    "user": "leif"
}
```

I could of course remove the temporary variable `first_match`; it's only there for documentation purposes. ;-)

I.e.,

```python
            if pat.search(config):
                ...
```

would be sufficient.



---

archive/issue_comments_130538.json:
```json
{
    "body": "P.S.: We could do similar in **`update`**`_pkgconfig_files()`.",
    "created_at": "2011-10-09T20:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130538",
    "user": "leif"
}
```

P.S.: We could do similar in **`update`**`_pkgconfig_files()`.



---

archive/issue_comments_130539.json:
```json
{
    "body": "Replying to [comment:12 leif]:\n> P.S.: We could do similar in **`update`**`_pkgconfig_files()`.\n\nLike this, which IMHO is also somehow a bit cleaner:\n\n```diff\n\ndiff --git a/sage-location b/sage-location\n--- a/sage-location\n+++ b/sage-location\n@@ -194,16 +207,17 @@\n     ``initialize_pkgconfig_files()``, in particular, each of them contains a\n     definition of the variable ``SAGE_ROOT``, since only that is updated here.\n     \"\"\"\n+    import re\n+    pat = re.compile(r\"^SAGE_ROOT=.*\\n\", re.MULTILINE)\n     LIB = os.path.join(os.path.abspath(SAGE_ROOT), 'local', 'lib')\n     PKG = os.path.join(LIB, 'pkgconfig')\n     for name in os.listdir(PKG):\n-        filename = os.path.join(PKG,name)\n+        filename = os.path.join(PKG, name)\n         if os.path.splitext(filename)[1]==\".pc\":\n             with open(filename) as file:\n                 config = file.read()\n \n-            prefix_start = config.find('SAGE_ROOT=')\n-            if prefix_start==-1:\n+            if not pat.search(config):\n                 # This should never happen, unless the user modified the file.\n                 sys.stderr.write(\n                     \"Error: sage_location: update_pkgconfig_files():\\n\" +\n@@ -211,12 +225,16 @@\n                     name + \"  Skipping it...\\n\")\n                 sys.stderr.flush()\n                 continue\n+                # We could of course call initialize_pkgconfig_file(filename)\n+                # here instead to fix this issue, but unfortunately there's no\n+                # such function (for a single file) [yet].\n \n-            prefix_end = config.find('\\n', prefix_start)\n-            new_prefix = 'SAGE_ROOT=%s' % os.path.abspath(SAGE_ROOT)\n-            new_config = config[:prefix_start] + new_prefix + config[prefix_end:]\n+            # Delete all previous definitions of SAGE_ROOT:\n+            config = pat.sub(\"\", config)\n+\n+            definition = \"SAGE_ROOT=%s\\n\" % os.path.abspath(SAGE_ROOT)\n             with open(filename, 'w') as file:\n-                file.write(new_config)\n+                file.write(definition + config)\n \n \n def remove_files(path, remove_extensions):\n```\n",
    "created_at": "2011-10-09T20:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130539",
    "user": "leif"
}
```

Replying to [comment:12 leif]:
> P.S.: We could do similar in **`update`**`_pkgconfig_files()`.

Like this, which IMHO is also somehow a bit cleaner:

```diff

diff --git a/sage-location b/sage-location
--- a/sage-location
+++ b/sage-location
@@ -194,16 +207,17 @@
     ``initialize_pkgconfig_files()``, in particular, each of them contains a
     definition of the variable ``SAGE_ROOT``, since only that is updated here.
     """
+    import re
+    pat = re.compile(r"^SAGE_ROOT=.*\n", re.MULTILINE)
     LIB = os.path.join(os.path.abspath(SAGE_ROOT), 'local', 'lib')
     PKG = os.path.join(LIB, 'pkgconfig')
     for name in os.listdir(PKG):
-        filename = os.path.join(PKG,name)
+        filename = os.path.join(PKG, name)
         if os.path.splitext(filename)[1]==".pc":
             with open(filename) as file:
                 config = file.read()
 
-            prefix_start = config.find('SAGE_ROOT=')
-            if prefix_start==-1:
+            if not pat.search(config):
                 # This should never happen, unless the user modified the file.
                 sys.stderr.write(
                     "Error: sage_location: update_pkgconfig_files():\n" +
@@ -211,12 +225,16 @@
                     name + "  Skipping it...\n")
                 sys.stderr.flush()
                 continue
+                # We could of course call initialize_pkgconfig_file(filename)
+                # here instead to fix this issue, but unfortunately there's no
+                # such function (for a single file) [yet].
 
-            prefix_end = config.find('\n', prefix_start)
-            new_prefix = 'SAGE_ROOT=%s' % os.path.abspath(SAGE_ROOT)
-            new_config = config[:prefix_start] + new_prefix + config[prefix_end:]
+            # Delete all previous definitions of SAGE_ROOT:
+            config = pat.sub("", config)
+
+            definition = "SAGE_ROOT=%s\n" % os.path.abspath(SAGE_ROOT)
             with open(filename, 'w') as file:
-                file.write(new_config)
+                file.write(definition + config)
 
 
 def remove_files(path, remove_extensions):
```




---

archive/issue_comments_130540.json:
```json
{
    "body": "Ok, I've further improved and normalized both functions...\n\nJust wonder whether using `use_pat.sub(\"${SAGE_ROOT}\", config)` (where `use_pat` is a **compiled** pattern matching `os.path.abspath(SAGE_ROOT)`) would be faster than `config.replace(SAGE_ROOT_absolute, \"${SAGE_ROOT}\")`.\n\n(I've factored out `os.path.abspath(SAGE_ROOT)` since it was not only used more than once, but also inside the loops. 8/ *shudder*)",
    "created_at": "2011-10-09T21:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130540",
    "user": "leif"
}
```

Ok, I've further improved and normalized both functions...

Just wonder whether using `use_pat.sub("${SAGE_ROOT}", config)` (where `use_pat` is a **compiled** pattern matching `os.path.abspath(SAGE_ROOT)`) would be faster than `config.replace(SAGE_ROOT_absolute, "${SAGE_ROOT}")`.

(I've factored out `os.path.abspath(SAGE_ROOT)` since it was not only used more than once, but also inside the loops. 8/ *shudder*)



---

archive/issue_comments_130541.json:
```json
{
    "body": "Attachment\n\nSCRIPTS repo. Optional improvements to `{initialize,update}_pkgconfig_files()`. Apply on top of other patch..",
    "created_at": "2011-10-09T22:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130541",
    "user": "leif"
}
```

Attachment

SCRIPTS repo. Optional improvements to `{initialize,update}_pkgconfig_files()`. Apply on top of other patch..



---

archive/issue_comments_130542.json:
```json
{
    "body": "Ok, I've attached another, **optional** patch, to be applied on top of the other one.",
    "created_at": "2011-10-09T22:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130542",
    "user": "leif"
}
```

Ok, I've attached another, **optional** patch, to be applied on top of the other one.



---

archive/issue_comments_130543.json:
```json
{
    "body": "Attachment\n\nCumulative diff of both patches against Sage 4.7.2.alpha3. For review only.",
    "created_at": "2011-10-09T23:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130543",
    "user": "leif"
}
```

Attachment

Cumulative diff of both patches against Sage 4.7.2.alpha3. For review only.



---

archive/issue_comments_130544.json:
```json
{
    "body": "Note that (as I already mentioned elsewhere), on a follow-up or one of the other tickets, we have to (re-)initialize `.pc` files whenever a package [providing a `.pc` file] gets (re)installed (preferably at the end of `sage-spkg`, just like `sage-make_relative` is called), since that's very likely to overwrite our \"once\" modified / initialized `pkg-config` files, until all spkgs fix their own `.pc` files in their `spkg-install` files (or just call a Sage script / shell function that does that for them from there).\n\nThis ticket just fixes the worst cases, and especially the one that currently *always* occurs (since more than a year by the way), namely *duplicate definitions* of `SAGE_ROOT` in a `.pc` file.\n\n\n\n\nIf sh*t happens during reinstallation of one or more packages, with the patches here, the user will now be able to repair all `pkg-config` files by simply deleting `$SAGE_ROOT/local/lib/sage-current-location.txt`, and afterwards running Sage (e.g. just `./sage -c quit`), without having to check and manually edit any `pkg-config` files, which is certainly not perfect, but an improvement.",
    "created_at": "2011-10-10T00:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130544",
    "user": "leif"
}
```

Note that (as I already mentioned elsewhere), on a follow-up or one of the other tickets, we have to (re-)initialize `.pc` files whenever a package [providing a `.pc` file] gets (re)installed (preferably at the end of `sage-spkg`, just like `sage-make_relative` is called), since that's very likely to overwrite our "once" modified / initialized `pkg-config` files, until all spkgs fix their own `.pc` files in their `spkg-install` files (or just call a Sage script / shell function that does that for them from there).

This ticket just fixes the worst cases, and especially the one that currently *always* occurs (since more than a year by the way), namely *duplicate definitions* of `SAGE_ROOT` in a `.pc` file.




If sh*t happens during reinstallation of one or more packages, with the patches here, the user will now be able to repair all `pkg-config` files by simply deleting `$SAGE_ROOT/local/lib/sage-current-location.txt`, and afterwards running Sage (e.g. just `./sage -c quit`), without having to check and manually edit any `pkg-config` files, which is certainly not perfect, but an improvement.



---

archive/issue_comments_130545.json:
```json
{
    "body": "Regarding the comment\n\n```\nWill have weird effects in case SAGE_ROOT_absolute contains other characters having special\nmeaning in regular expressions. \n```\n\nYou could use [re.escape](http://docs.python.org/library/re.html#re.escape) to deal with this issue.\n\nIn `update_pkgconfig_files`, the code\n\n```\n# Delete all previous definitions of SAGE_ROOT:\nconfig = def_pat.sub(\"\", config)\n```\n\nThe `sub` method only replaces one definition, not all of them.  There should be only one at this point anyway, of course.  Perhaps change the comment to reflect this?\n\nOtherwise, the combined patch looks pretty good to me.  I still have to actually test it...",
    "created_at": "2011-10-10T17:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130545",
    "user": "jhpalmieri"
}
```

Regarding the comment

```
Will have weird effects in case SAGE_ROOT_absolute contains other characters having special
meaning in regular expressions. 
```

You could use [re.escape](http://docs.python.org/library/re.html#re.escape) to deal with this issue.

In `update_pkgconfig_files`, the code

```
# Delete all previous definitions of SAGE_ROOT:
config = def_pat.sub("", config)
```

The `sub` method only replaces one definition, not all of them.  There should be only one at this point anyway, of course.  Perhaps change the comment to reflect this?

Otherwise, the combined patch looks pretty good to me.  I still have to actually test it...



---

archive/issue_comments_130546.json:
```json
{
    "body": "Replying to [comment:17 jhpalmieri]:\n> You could use [re.escape](http://docs.python.org/library/re.html#re.escape) to deal with this issue.\n\nYep, but I haven't tested [yet] whether using `sub()` is faster than `str.replace()`.\n\n\n\n\n> The `sub` method only replaces one definition, not all of them.\n\nNope. The optional `count` parameter defaults to 0, which means replace all occurrences.",
    "created_at": "2011-10-10T17:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130546",
    "user": "leif"
}
```

Replying to [comment:17 jhpalmieri]:
> You could use [re.escape](http://docs.python.org/library/re.html#re.escape) to deal with this issue.

Yep, but I haven't tested [yet] whether using `sub()` is faster than `str.replace()`.




> The `sub` method only replaces one definition, not all of them.

Nope. The optional `count` parameter defaults to 0, which means replace all occurrences.



---

archive/issue_comments_130547.json:
```json
{
    "body": "Replying to [comment:18 leif]:\n> Replying to [comment:17 jhpalmieri]:\n> > You could use [re.escape](http://docs.python.org/library/re.html#re.escape) to deal with this issue.\n> \n> Yep, but I haven't tested [yet] whether using `sub()` is faster than `str.replace()`.\n\nThere seems to be no (measurable) difference (10.9--11 vs. 11 ns with `%timeit -c ...`, and the \"largest\" `.pc` file we have).  I only tested substituting `${SAGE_ROOT}` by `${SAGE_FOO}` though, i.e., on an *already \"initialized\"* `.pc` file.  Might differ with longer patterns (i.e. paths) to match, and the original file is slightly larger of course.",
    "created_at": "2011-10-10T17:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130547",
    "user": "leif"
}
```

Replying to [comment:18 leif]:
> Replying to [comment:17 jhpalmieri]:
> > You could use [re.escape](http://docs.python.org/library/re.html#re.escape) to deal with this issue.
> 
> Yep, but I haven't tested [yet] whether using `sub()` is faster than `str.replace()`.

There seems to be no (measurable) difference (10.9--11 vs. 11 ns with `%timeit -c ...`, and the "largest" `.pc` file we have).  I only tested substituting `${SAGE_ROOT}` by `${SAGE_FOO}` though, i.e., on an *already "initialized"* `.pc` file.  Might differ with longer patterns (i.e. paths) to match, and the original file is slightly larger of course.



---

archive/issue_comments_130548.json:
```json
{
    "body": "Btw., with `re.escape()` typical paths get much longer... 8&",
    "created_at": "2011-10-10T18:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130548",
    "user": "leif"
}
```

Btw., with `re.escape()` typical paths get much longer... 8&



---

archive/issue_comments_130549.json:
```json
{
    "body": "Looks like IPython's `%timeit` is broken; I **always** get 11 ns, regardless of the size of the file / string... XD",
    "created_at": "2011-10-10T18:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130549",
    "user": "leif"
}
```

Looks like IPython's `%timeit` is broken; I **always** get 11 ns, regardless of the size of the file / string... XD



---

archive/issue_comments_130550.json:
```json
{
    "body": "Replying to [comment:21 leif]:\n> Looks like IPython's `%timeit` is broken; I **always** get 11 ns, regardless of the size of the file / string... XD\n\nOh, my bad, I quoted the statement... 8/\n\nBtw., interestingly the timing framework somehow makes the braces special characters, so I have to escape them for the timing tests, but the backslashs also end up in the result... Weird.",
    "created_at": "2011-10-10T18:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130550",
    "user": "leif"
}
```

Replying to [comment:21 leif]:
> Looks like IPython's `%timeit` is broken; I **always** get 11 ns, regardless of the size of the file / string... XD

Oh, my bad, I quoted the statement... 8/

Btw., interestingly the timing framework somehow makes the braces special characters, so I have to escape them for the timing tests, but the backslashs also end up in the result... Weird.



---

archive/issue_comments_130551.json:
```json
{
    "body": "Replying to [comment:18 leif]:\n> Replying to [comment:17 jhpalmieri]:\n> > The `sub` method only replaces one definition, not all of them.\n> \n> Nope. The optional `count` parameter defaults to 0, which means replace all occurrences.\n\nSorry, I misread the documentation (thought it said \"leftmost non-overlapping occurrence\" instead of \"leftmost non-overlapping occurrence**s**\").\n\n> Btw., with re.escape() typical paths get much longer... 8&\n\nYes, but you don't have to ever look at them, do you?  Just pass them on to `re`.\n\nAnyway, things look good to me.  In testing, the old version acts badly if, for example, you delete \"sage-location.txt\", whereas the new version does a good job of cleaning up the resulting mess.  I've tried to break the new version in other ways, but not successfully.  There may still be holes, but I'm not sure where.  In any case, it's an improvement over the previous version.\n\n(If you feel like adding a comment about re.escape, in case someone else works on this, go ahead.  No need for further review in that case.)",
    "created_at": "2011-10-10T20:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130551",
    "user": "jhpalmieri"
}
```

Replying to [comment:18 leif]:
> Replying to [comment:17 jhpalmieri]:
> > The `sub` method only replaces one definition, not all of them.
> 
> Nope. The optional `count` parameter defaults to 0, which means replace all occurrences.

Sorry, I misread the documentation (thought it said "leftmost non-overlapping occurrence" instead of "leftmost non-overlapping occurrence**s**").

> Btw., with re.escape() typical paths get much longer... 8&

Yes, but you don't have to ever look at them, do you?  Just pass them on to `re`.

Anyway, things look good to me.  In testing, the old version acts badly if, for example, you delete "sage-location.txt", whereas the new version does a good job of cleaning up the resulting mess.  I've tried to break the new version in other ways, but not successfully.  There may still be holes, but I'm not sure where.  In any case, it's an improvement over the previous version.

(If you feel like adding a comment about re.escape, in case someone else works on this, go ahead.  No need for further review in that case.)



---

archive/issue_comments_130552.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-10T20:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130552",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_130553.json:
```json
{
    "body": "Replying to [comment:23 jhpalmieri]:\n> Replying to [comment:18 leif]:\n> > Btw., with re.escape() typical paths get much longer... 8&\n> \n> Yes, but you don't have to ever look at them, do you?  Just pass them on to `re`.\n\nOf course, but longer strings take longer to compile... ;-)\n\n> (If you feel like adding a comment about re.escape, in case someone else works on this, go ahead.  No need for further review in that case.)\n\nIt seems `sub()` is indeed *slower* than `str.replace()` (about 7:4 in CPU time), so it's not worth using it there instead.  Users won't notice any difference anyway I think; I was just curious.  (And it's hardly worth updating the patch or providing a new one just to update the comment on that.)",
    "created_at": "2011-10-11T02:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130553",
    "user": "leif"
}
```

Replying to [comment:23 jhpalmieri]:
> Replying to [comment:18 leif]:
> > Btw., with re.escape() typical paths get much longer... 8&
> 
> Yes, but you don't have to ever look at them, do you?  Just pass them on to `re`.

Of course, but longer strings take longer to compile... ;-)

> (If you feel like adding a comment about re.escape, in case someone else works on this, go ahead.  No need for further review in that case.)

It seems `sub()` is indeed *slower* than `str.replace()` (about 7:4 in CPU time), so it's not worth using it there instead.  Users won't notice any difference anyway I think; I was just curious.  (And it's hardly worth updating the patch or providing a new one just to update the comment on that.)



---

archive/issue_comments_130554.json:
```json
{
    "body": "P.S.: Thanks for reviewing this; triple X when it's finally merged and we get rid of this long-lasting issue.",
    "created_at": "2011-10-11T02:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130554",
    "user": "leif"
}
```

P.S.: Thanks for reviewing this; triple X when it's finally merged and we get rid of this long-lasting issue.



---

archive/issue_comments_130555.json:
```json
{
    "body": "Replying to [comment:26 leif]:\n> P.S.: Thanks for reviewing this; triple X when it's finally merged and we get rid of this long-lasting issue.\n\nSo where is the party?",
    "created_at": "2011-10-11T06:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130555",
    "user": "jdemeyer"
}
```

Replying to [comment:26 leif]:
> P.S.: Thanks for reviewing this; triple X when it's finally merged and we get rid of this long-lasting issue.

So where is the party?



---

archive/issue_comments_130556.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-10-11T06:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130556",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_130557.json:
```json
{
    "body": "See #12331 for a follow-up.",
    "created_at": "2012-01-20T18:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11588#issuecomment-130557",
    "user": "jhpalmieri"
}
```

See #12331 for a follow-up.
