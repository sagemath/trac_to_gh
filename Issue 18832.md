# Issue 18832: Expose matroid sum and matroid union to end users

Issue created by migration from Trac.

Original creator: Stefan

Original creation time: 2015-08-21 20:18:58

CC:  chaoxu yomcat rudi

In #19027 matroid union, sum, partition are implemented, but most are not made discoverable by end users. I propose the following two ways of doing that:

* add import statements to sage/matroids/advanced.py
* create a new "submenu" matroids.constructions (similar to matroids.named_matroids) for these and future other constructions. So we could do

```
sage: M = matroids.constructions.Union([M1, M2])
```



---

Comment by tmonteil created at 2015-08-22 11:44:19

Let me suggest also the following standard syntax:


```
sage: M = M1.union(M2)
```


To do this, just create a `union` method for matroids. The benefits is that, after creating a matroid `M1`, the user can see all available features by typing `M1.<TAB>`.


---

Comment by Stefan created at 2017-03-16 02:38:22

I agree with tmonteil that a `union` method for the Matroid class would be nice, that can take either a matroid or list of matroids as input. I would also definitely do the first of the two suggestions here (and document it inside the `union` method docstring). The second way can wait.

I marked the other ticket asking for this as duplicate: #20357 .


---

Comment by zgershkoff created at 2017-05-31 01:37:45

Changing status from new to needs_review.


---

Comment by zgershkoff created at 2017-05-31 01:37:45

I added a union method and it seems to work well enough. I wasn't able to get it to work with cython-- it kept giving me an error "Expected an identifier" when I defined the union method. I also unearthed some issues with the union method, but I can talk with Stefan about that later. For now, it's exposed.
----
New commits:


---

Comment by git created at 2017-06-10 01:55:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-10 01:58:24

`_union()` is able to cythonize and everything compiles if `union()` is commented out, but with `union()` I get the following error and it won't compile.


```
Error compiling Cython file:
------------------------------------------------------------
...
        """
        if isinstance(matroids, Matroid):
            matroids = [matroids]
        # place this matroid at the beginning of the list
        matroids.insert(0,self)
        return _union(iter(matroids))
                    ^
------------------------------------------------------------

sage/matroids/matroid.pyx:7772:21: undeclared name not builtin: _union
```


More trouble with "union" being a reserved keyword, perhaps?


---

Comment by tscrim created at 2017-06-10 03:15:03

Don't you want `self._union`? Also, I don't see the point of having a `_union` method since there is no real safety checks that need to be performed and everything computationally is handled by `MatroidUnion`.


---

Comment by zgershkoff created at 2017-06-10 21:55:06

Yes, I forgot the `self`.

The reason we need the `_union` method (Stefan helped me figure this out) is that "union" is a reserved keyword for Cython, so `cpdef union` gives the following error when compiling:


```
Error compiling Cython file:
------------------------------------------------------------
...
            Ternary matroid of rank 3 on 7 elements, type 0-
        """
        from . import union_matroid
        return union_matroid.MatroidUnion(matroids)

    cpdef union(self, matroids):
              ^
------------------------------------------------------------

sage/matroids/matroid.pyx:7747:15: Expected an identifier
```


So instead we make `def union` sanitize the input and pass it to `cpdef _union`.


---

Comment by git created at 2017-06-10 21:57:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-10 22:00:28

I don't claim to know the benefit of using Cython when all it does is pass the input to another Cython method. I just know it works the way I had intended it now.

Perhaps I should change it back to just Python?


---

Comment by zgershkoff created at 2017-06-10 22:12:01

Changing status from needs_review to needs_info.


---

Comment by zgershkoff created at 2017-06-10 22:12:01

I'll take this off "needs review" until we decide.


---

Comment by tscrim created at 2017-06-10 23:57:43

Changing status from needs_info to needs_work.


---

Comment by tscrim created at 2017-06-10 23:57:43

Ah, I see, right. Well, there is an advantage to only having C code paths (I would make `_union` simply a `cdef` method because it should only be called from `def union`). However, you are going to have to do a number of Python calls when constructing the `MatroidUnion`, so having an extra Python function call for a lightweight function will not really change much. Especially since this is not likely to be called in tight loops and if you really wanted the most speed, you would just directly construct `MatriodUnion` anyways. So there should only be a Python `def union` IMO.


---

Comment by Stefan created at 2017-06-11 01:32:16

I think I have come around to Travis' point of view. Only a "def union" will do for this one. Sorry for making you do extra work.

--Stefan.


---

Comment by git created at 2017-06-11 02:39:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-11 02:43:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-11 02:43:50

No worries. It was a good learning experience.


---

Comment by zgershkoff created at 2017-06-11 02:43:50

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-11 02:47:58

Should we have `M.union([]) == M`?


---

Comment by git created at 2017-06-11 03:03:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-11 03:04:49

Makes sense to me.


---

Comment by tscrim created at 2017-06-11 23:10:51

This is not correct:

```diff
-        if matroids = []:
+        if matroids == []:
```

Once that is changed and you fill in the author name, you can set a positive review on my behalf.


---

Comment by tscrim created at 2017-06-11 23:19:45

Actually, a better test is `if not matroids:` as it is both faster and covers inputs like `()`. This would also pick up the empty matroid, which is okay as the union with the empty matroid should also not change the matroid and `MatroidUnion` should behave the same as other matroids, right? There is a case to be made that the output type is always the same, but I'm not convinced by that here. If we did want to enforce that, we just need to move the `isinstance(matroids, Matroid)` check first before `if not matroids:`.


---

Comment by git created at 2017-06-13 23:00:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-13 23:08:01

Changing status from needs_review to needs_work.


---

Comment by zgershkoff created at 2017-06-13 23:08:01

That will teach me to make a commit before testing it.

I'm not getting expected behavior with `M.union([])` where `M` is a matroid (in particular, I used the Fano).

You can also fool this with a list of empty matroids. I can make it take empty matroids out of the list, but we may be getting diminishing returns with the sanitizing.


---

Comment by git created at 2017-06-14 04:23:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-14 04:36:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-14 04:39:23

Changing status from needs_work to needs_review.


---

Comment by zgershkoff created at 2017-06-14 04:39:23

Replying to [comment:23 zgershkoff]:
> I'm not getting expected behavior with `M.union([])`
Sorry, this was wrong. An error on my part.

I rewrote it to filter out empty matroids from a list. I also figured that the cost of adding an empty matroid to the list and then removing it was worth the simplicity of not performing the same check twice.


---

Comment by git created at 2017-06-14 04:57:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-17 04:29:50

One last thing, we don't typically write error messages as full sentences:

```diff
-                    raise TypeError("Can only take the union with a "
-                                     + "matroid or list of matroids.")
+                    raise TypeError("can only take the union with a "
+                                     + "matroid or list of matroids")
```

Once you make that change and add your real name to the authors, you can set a positive review on my behalf.


---

Comment by git created at 2017-06-17 19:27:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zgershkoff created at 2017-06-17 19:28:34

Changing status from needs_review to positive_review.


---

Comment by zgershkoff created at 2017-06-17 19:28:34

Done.


---

Comment by vbraun created at 2017-06-22 07:23:20

Resolution: fixed
