# Issue 24203: Infinite loop from proving an expression

Issue created by migration from https://trac.sagemath.org/ticket/24440

Original creator: rws

Original creation time: 2017-12-28 15:48:02

This was indirectly found by `random_expr()`:

```
sage: bool(tanh(pi/(e + 0.1)) == 0)

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__nonzero__ (build/cythonized/sage/symbolic/expression.cpp:19787)()
   2822                 if pynac_result == relational_notimplemented and self.operator()==operator.ne:
   2823                     return not (self.lhs()-self.rhs()).is_trivial_zero()
-> 2824                 res = self.test_relation()
   2825                 if res is True:
   2826                     return True

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.test_relation (build/cythonized/sage/symbolic/expression.cpp:20439)()
   2931         if domain is None:
   2932             is_interval = True
-> 2933             if self.lhs().is_algebraic() and self.rhs().is_algebraic():
   2934                 if op == equal or op == not_equal:
   2935                     domain = QQbar

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.is_algebraic (build/cythonized/sage/symbolic/expression.cpp:15604)()
   1976         """
   1977         try:
-> 1978             ex = sage.rings.all.QQbar(self)
   1979         except (TypeError, ValueError, NotImplementedError):
   1980             return False

/home/ralf/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9406)()
    915         if mor is not None:
    916             if no_extra_args:
--> 917                 return mor._call_(x)
    918             else:
    919                 return mor._call_with_args(x, args, kwds)

/home/ralf/sage/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4972)()
    153                 print(type(C), C)
    154                 print(type(C._element_constructor), C._element_constructor)
--> 155             raise
    156 
    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/ralf/sage/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4840)()
    148         cdef Parent C = self._codomain
    149         try:
--> 150             return C._element_constructor(x)
    151         except Exception:
    152             if print_warnings:

/home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/qqbar.pyc in _element_constructor_(self, x)
   1138             return AlgebraicNumber(x._descr)
   1139         elif hasattr(x, '_algebraic_'):
-> 1140             return x._algebraic_(QQbar)
   1141         return AlgebraicNumber(x)
   1142 

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:12139)()
   1477         """
   1478         from sage.symbolic.expression_conversions import algebraic
-> 1479         return algebraic(self, field)
   1480 
   1481     def __hash__(self):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in algebraic(ex, field)
   1046         0
   1047     """
-> 1048     return AlgebraicConverter(field)(ex)
   1049 
   1050 ##############

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    224             return self.tuple(ex)
    225         else:
--> 226             return self.composition(ex, operator)
    227 
    228     def get_fake_div(self, ex):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
    987                 res = -QQbar.zeta(4)*(exp_ia - ~exp_ia)/(exp_ia + ~exp_ia)
    988         elif func_name in ['sinh', 'cosh', 'tanh']:
--> 989             exp_a = exp(operand)._algebraic_(QQbar)
    990             if func_name == 'sinh':
    991                 res = (exp_a - ~exp_a)/2

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:12139)()
   1477         """
   1478         from sage.symbolic.expression_conversions import algebraic
-> 1479         return algebraic(self, field)
   1480 
   1481     def __hash__(self):

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in algebraic(ex, field)
   1046         0
   1047     """
-> 1048     return AlgebraicConverter(field)(ex)
   1049 
   1050 ##############

... last 6 frames repeated, from the frame below ...

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

RuntimeError: maximum recursion depth exceeded in __instancecheck__
```



---

Comment by rws created at 2018-02-02 09:52:53

Changing component from symbolics to basic arithmetic.


---

Comment by rws created at 2018-02-09 07:13:28

Also `QQbar(sin(I*pi/7))` crashes (with or without `hold=True`) but differently. Finally,

```
sage: QQbar(sinh(I*pi/7.,hold=True))
...
/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
    976             # Coerce (not convert, see #22571) arg to a rational
    977             arg = operand.imag()/(2*ex.parent().pi())
--> 978             rat_arg = QQ.coerce(arg.pyobject())
    979             res = QQbar.zeta(rat_arg.denom())**rat_arg.numer()
    980         elif func_name in ['sin', 'cos', 'tan']:
...
TypeError: no canonical coercion from Real Field with 53 bits of precision to Rational Field
```



---

Comment by rws created at 2018-02-09 07:54:33

Changing status from new to needs_review.


---

Comment by rws created at 2018-02-09 07:54:33

New commits:


---

Comment by slabbe created at 2018-04-28 20:32:35

Changing status from needs_review to positive_review.


---

Comment by rws created at 2018-04-29 03:17:28

Thanks.


---

Comment by vbraun created at 2018-05-08 17:27:55

Resolution: fixed
