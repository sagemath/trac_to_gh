# Issue 25915: Remove symlink local/share/mathjax/mathjax

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-08-28 14:47:43

CC:  jhpalmieri embray

There is a symlink `local/share/mathjax/mathjax` pointing to `local/share/mathjax`. Presumably, this was created by old sagenb versions.

This is creating trouble for the Sage documentation (see also #25111). We should ensure that this symlink is not created in the first place and removed if it already exists.


---

Comment by embray created at 2018-08-28 14:51:20

This is already fixed--it does not get created anymore.  The question is whether or not to bother putting in something to remove it if it exists.  Personally I don't think it's a blocker because it can easily just be removed, and would only be a problem in the case of some incremental builds that wound up with it at some point.


---

Comment by jdemeyer created at 2018-08-28 15:07:36

Replying to [comment:1 embray]:
> This is already fixed--it does not get created anymore.

I also assumed that also but we are wrong! The symlink does get created when sagenb is rebuilt (this may also be a bug in the `sage-spkg` script). So there is certainly something to be fixed here.
----
New commits:


---

Comment by jdemeyer created at 2018-08-28 15:16:32

I created #26153 for the `sage-spkg` problem.


---

Comment by jdemeyer created at 2018-08-28 15:16:38

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-08-28 20:52:27

Replying to [comment:4 jdemeyer]:
> Replying to [comment:1 embray]:
> > This is already fixed--it does not get created anymore.
> 
> I also assumed that also but we are wrong! The symlink does get created when sagenb is rebuilt (this may also be a bug in the `sage-spkg` script). So there is certainly something to be fixed here.

I am unable to recreate the symlink. Can you do this reliably?

To test so far, I have created the symlink by hand, and then when I ran `make` with this branch, it got deleted. So that's good.


---

Comment by jdemeyer created at 2018-08-28 21:01:21

Replying to [comment:9 jhpalmieri]:
> I am unable to recreate the symlink. Can you do this reliably?


```
(cd local/var/lib/sage/installed; rm mathjax* sagenb*); make sagenb
```



---

Comment by jhpalmieri created at 2018-08-28 21:18:41

Okay, that does it. I don't know why the various combinations of `./sage -f mathjax` and `./sage -f sagenb` don't also do it. And in fact, you don't need to delete the whole `sagenb` file in `installed`: for me, just deleting the line

```
        "lib/python2.7/site-packages/sagenb/data/mathjax",
```

is enough for `./sage -f sagenb` to recreate the link. I don't know what these file manifests are supposed to do, especially since at the beginning of the `sagenb` install, it says

```
No record that 'sagenb' was ever installed; skipping uninstall
```

That implied to me that the manifest was being ignored, but I guess that's not the case. Are these manifest files and their roles documented anywhere?


---

Comment by jhpalmieri created at 2018-08-28 21:36:16

It seems to me that the solution here is temporary: it will fix the issue for anyone who has the link right now, but as you point out, if sagenb is reinstalled, the link may come back. Will #26153 fix the problem permanently? Is there a way to force mathjax to be reinstalled after sagenb (even though mathjax is a dependency for sagenb), to ensure that any bad links are removed?


---

Comment by jdemeyer created at 2018-08-28 21:53:22

Replying to [comment:11 jhpalmieri]:
> I don't know what these file manifests are supposed to do, especially since at the beginning of the `sagenb` install, it says
> {{{
> No record that 'sagenb' was ever installed; skipping uninstall
> }}}
> That implied to me that the manifest was being ignored, but I guess that's not the case.

I agree that this may be confusing. The answer is that `./sage -f` is really an uninstall followed by an install, not a reinstall. The message that you quoted refers to uninstallation done as part of the installation. But by the time, `sagenb` is already uninstalled. This would be different if the uninstall would be part of a reinstall (for a version upgrade for example).


---

Comment by embray created at 2018-08-29 10:00:53

Now that running `sage-spkg-uninstall` is part of the normal package installation/upgrade process anyways it would be less confusing to change `./sage -f` to somehow force calling `sage-spkg <package>` without checking (via `make`) whether it is already up-to-date.


---

Comment by embray created at 2018-08-29 10:04:44

Replying to [comment:12 jhpalmieri]:
> It seems to me that the solution here is temporary: it will fix the issue for anyone who has the link right now, but as you point out, if sagenb is reinstalled, the link may come back. Will #26153 fix the problem permanently? Is there a way to force mathjax to be reinstalled after sagenb (even though mathjax is a dependency for sagenb), to ensure that any bad links are removed?

This is only a problem if you're doing things that you are not supposed to do, like removing the package installation record (the one in `local/var/lib/sage/installed`) without also removing the files installed by that package.  We can't account for every possible way someone's `$SAGE_LOCAL` is corrupted.

The issue caused by symlinks in this case is somewhat unique to symlinks, and the existing package installation code not handling existing symlinks properly; that's what #26153 is addressing.


---

Comment by jdemeyer created at 2018-08-29 11:01:46

Replying to [comment:15 embray]:
> This is only a problem if you're doing things that you are not supposed to do, like removing the package installation record (the one in `local/var/lib/sage/installed`) without also removing the files installed by that package.  We can't account for every possible way someone's `$SAGE_LOCAL` is corrupted.

I agree partially. We should be mostly assuming a consistent state, but I can imagine some realistic scenarios where the information in `local/var/lib/sage/installed` is not consistent with the actual filesystem. For example, pressing CTRL-C while the files are being installed.

We shouldn't worry about it too much but we also shouldn't ignore it either.


---

Comment by embray created at 2018-08-29 11:06:43

Maybe it would be better, in that case, if the file manifest were written _first_.  Currently it is only written after file installation is complete.  If it were written first then it would represent, at least, what is _supposed_ to be in `$SAGE_LOCAL`, and then uninstallation can still be used for cleanup.

The only problem with that is that the manifest is written to the same file that indicates that installation succeeded.  Maybe it should be a separate file; I don't know.


---

Comment by jhpalmieri created at 2018-08-29 17:20:07

Replying to [comment:17 embray]:
> Maybe it would be better, in that case, if the file manifest were written _first_.  Currently it is only written after file installation is complete.  If it were written first then it would represent, at least, what is _supposed_ to be in `$SAGE_LOCAL`, and then uninstallation can still be used for cleanup.
> 
> The only problem with that is that the manifest is written to the same file that indicates that installation succeeded.  Maybe it should be a separate file; I don't know.

Maybe I'm misunderstanding, but you could write the manifest in a temporary location (and use it there for uninstallation) and then install it after file installation is complete.


---

Comment by jhpalmieri created at 2018-08-29 17:21:13

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2018-08-29 17:21:13

I'm willing to give this a positive review as a stopgap measure. I hope the real issue with symlinks can be addressed at #26153.


---

Comment by vbraun created at 2018-08-30 22:25:04

Resolution: fixed


---

Comment by embray created at 2018-09-03 09:44:09

Replying to [comment:18 jhpalmieri]:
> Replying to [comment:17 embray]:
> > Maybe it would be better, in that case, if the file manifest were written _first_.  Currently it is only written after file installation is complete.  If it were written first then it would represent, at least, what is _supposed_ to be in `$SAGE_LOCAL`, and then uninstallation can still be used for cleanup.
> > 
> > The only problem with that is that the manifest is written to the same file that indicates that installation succeeded.  Maybe it should be a separate file; I don't know.
> 
> Maybe I'm misunderstanding, but you could write the manifest in a temporary location (and use it there for uninstallation) and then install it after file installation is complete.

I thought I posted it here but maybe forgot. But yes, I arrived at the same conclusion independently, so that's probably the obvious thing to do.  Write it first to a temp file, then move it to its proper location once installation completes successfully.

The only trick is that those "temp" files still need to be written some place that the uninstaller can find it.  Maybe it would be the same file by with a `.tmp` extension added, with the uninstaller updated to also find those `.tmp` files.


---

Comment by dimpase created at 2018-09-25 11:25:20

Could anyone with working MathJax in Jupyter Sage notebooks post their setup?

After this was fixed, I can't get it to work any more...


---

Comment by jhpalmieri created at 2018-09-25 14:49:24

What do you mean by "setup"? I don't think I've done anything special, and math displays fine for me in Sage's Jupyter notebook. So I'm happy to provide information, but what are you looking for?


---

Comment by dimpase created at 2018-09-25 18:38:03

It was possible to set all the display to MathJax, no?
What works for me is putting 

```
%display latex
...
```

in a cell, and then it seems to use MathJax to show stuff in it.
So it might be that my memory is fuzzy at this point, and I'm confusing this with some
other notebook...


---

Comment by jhpalmieri created at 2018-09-25 18:49:37

(a) The legacy Sage notebook had an option to typeset all output, in which case it would use MathJax by default. Could that be what you're thinking of? I don't know of such an option for the Jupyter notebook, so I can't answer that part of your question. 

(b) If you're actually missing a feature, I don't think it would be due to this ticket. (Or if it was, then the feature was relying on seriously buggy behavior, and I think that is unlikely.) In particular, MathJax does work with the Jupyter notebook, for instance if I do `show(matrix(10, 10, lambda i, j: i+j))` or I put `$x=y$` in a markdown cell. It sounds like you also see MathJax in action.


---

Comment by embray created at 2018-09-26 09:15:18

Yeah all this ticket did was force reinstallation of the mathjax spkg for some people.


---

Comment by jhpalmieri created at 2018-10-31 15:00:59

This problem has returned for me. As part of Sage's installation (part of some package, I'm not sure which one, or maybe a level up from that), should we check whether this link exists, and if so, delete it?


---

Comment by jhpalmieri created at 2018-10-31 19:00:54

See #26612 for a proposed solution (although I still don't know what is causing the problem).
