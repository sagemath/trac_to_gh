# Issue 22272: Install packages in temporary root before copying to $SAGE_LOCAL

Issue created by migration from https://trac.sagemath.org/ticket/22509

Original creator: embray

Original creation time: 2017-03-03 13:23:24

CC:  mkoeppe

Currently we build packages, in most cases, but setting `--prefix=$SAGE_LOCAL` (in `./configure`, or the equivalent in non-autoconf packages), and then install directly to that prefix.

This is fine to keep as is.  But with automake packages we can also set `DESTDIR` (https://www.gnu.org/software/automake/manual/html_node/DESTDIR.html#DESTDIR) to an alternative (typically temporary) directory into which to install.  This has a couple advantages:

* Although it's not as usual for `make install` to fail after a successful `make`, it _can_ happen. This prevents messy partial installs in the case of a failed `make install` run.

* It gives us the opportunity to make an exact list of the files that were installed.  This is a prerequisite to improving package uninstallation/reinstallation in sage-dist.

This is also standard operating procedure in most other packaging systems, so it would be good for Sage to adopt too.  It is also already possible for Python packages (e.g. `pip install --root`), and shouldn't be too hard to patch into whatever packages don't support it out of the box for whatever reason.


---

Comment by embray created at 2017-05-31 12:13:28

Started work on this, and converted I think all standard packages to work with a staged installation (install first to a temporary directory, then copy from the temp directory into `$SAGE_LOCAL`).

As I wrote in the description, most packages are easy--either they use automake, or at least a Makefile that's compatible with the `DESTDIR` convention, or they are Python packages in which case the `--root` option does the same thing.  A handful of packages needed hand-tweaking.

This is currently implemented in such a way that if a package _doesn't_ yet support staged install, it will still install just fine. The only major downside is that the installed files are not recorded yet, so they wouldn't be able to take advantage of improved uninstall.

That said, I'm going to continue converting the remaining packages. My only question is whether to continue work in this ticket, or separate the general changes (i.e. to `sage-spkg`) from the updates to the packages themselves.
----
Last 10 new commits:


---

Comment by embray created at 2017-05-31 12:13:28

Changing status from new to needs_review.


---

Comment by embray created at 2017-05-31 12:19:19

By way of explanation, the idea here is that there is a variable exported by `sage-spkg` called `$SAGE_INST_TEMP` (the name is open to bikeshedding), so this is expected to be passed to each `spkg-install` to use an alternative install root.  In principle this could be defined in each `spkg-install` individually, but it's less trouble to standardize in one place, and in any case `sage-spkg` still needs to know this path to copy files from it to `$SAGE_LOCAL`.

Of course, if we take this approach, the developer docs will also need to be updated with some guidance on how to implement staged installation for new packages.


---

Comment by git created at 2017-05-31 12:25:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-05-31 13:13:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-31 13:34:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-01 08:15:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-02 07:36:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by jdemeyer created at 2017-06-06 19:46:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-06-06 19:46:06

This already fails on the first package... `patch`:

```
Making install in src
make[5]: Entering directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/src'
make[6]: Entering directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/src'
 /bin/mkdir -p '/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/inst/opt/sage/sage-git/local/bin'
  /usr/bin/install -c patch '/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/inst/opt/sage/sage-git/local/bin'
make[6]: Nothing to be done for `install-data-am'.
make[6]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/src'
make[5]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/src'
Making install in tests
make[5]: Entering directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/tests'
make[6]: Entering directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/tests'
make[6]: Nothing to be done for `install-exec-am'.
make[6]: Nothing to be done for `install-data-am'.
make[6]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/tests'
make[5]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src/tests'
make[5]: Entering directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src'
make[6]: Entering directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src'
make[6]: Nothing to be done for `install-exec-am'.
 /bin/mkdir -p '/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/inst/opt/sage/sage-git/local/share/man/man1'
 /usr/bin/install -c -m 644 'patch.man' '/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/inst/opt/sage/sage-git/local/share/man/man1/patch.1'
make[6]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src'
make[5]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src'
make[4]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src'
make[3]: Leaving directory `/opt/sage/sage-git/local/var/tmp/sage/build/patch-2.7.5/src'
Cannot find the patch program we just installed
```



---

Comment by jdemeyer created at 2017-06-06 19:47:25

I see `${SAGE_INST_TEMP}${SAGE_LOCAL}` occuring in various places, maybe you should define a new variable for this.


---

Comment by jdemeyer created at 2017-06-06 19:48:25

Let me say that this a very brave patch :-)


---

Comment by embray created at 2017-06-07 11:48:45

Replying to [comment:14 jdemeyer]:
> I see `${SAGE_INST_TEMP}${SAGE_LOCAL}` occuring in various places, maybe you should define a new variable for this.

Yeah, I keep thinking about that.  At first I was just going to redefine `$SAGE_LOCAL` to that, but that doesn't work because one needs the bare `$SAGE_LOCAL`, e.g., for the prefix.  I think I just need a good name for the combined path.  Maybe `$SAGE_LOCAL_TEMP`?


---

Comment by embray created at 2017-06-07 12:01:19

Replying to [comment:15 jdemeyer]:
> Let me say that this a very brave patch :-)

Thanks! I just hope you agree with it in principle, because I really think it should be done.  Open to ideas on the specific details, although I think this is already pretty close.  There's a lot of things we could be doing better packaging-wise in the first place of course, but I'm still just trying to make the least disruptive changes I can.


---

Comment by jdemeyer created at 2017-06-07 12:41:08

Replying to [comment:16 embray]:
> Maybe `$SAGE_LOCAL_TEMP`?

I would prefer `$SAGE_TEMP_LOCAL` simply because that's consistent with the order (first `SAGE_INST_TEMP`, then `SAGE_LOCAL`).


---

Comment by embray created at 2017-06-07 14:45:56

That's fine.  But before I do a mass rename on this, perhaps you (and/or others) could have a look at #23160.  It would be very nice to have this, or something like it, as a dependency on this ticket so that I can make a few bulk changes once (in the case of #23160 it would be replacing all calls to `$MAKE/make install` with `sdh_make_install`, and then many future tweaks can be made in one place--the definition of `sdh_make_install`).


---

Comment by git created at 2017-06-07 14:46:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-07 14:52:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-06-07 14:54:43

Replying to [comment:13 jdemeyer]:
> This already fails on the first package... `patch`:

Just a peculiarity of that package's `spkg-install`.  I removed the seemingly pointless check for now.


---

Comment by git created at 2017-06-08 07:39:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-08 08:30:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-11 15:21:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-07-11 15:23:44

Now depends on #23160.  Updates a bunch of packages to use the helper functions--once that change is made once it will be much easier to make mass updates simply by updating the helper functions.


---

Comment by git created at 2017-07-11 15:28:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-12 11:15:59

Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 embray]:
> > Maybe `$SAGE_LOCAL_TEMP`?
> 
> I would prefer `$SAGE_TEMP_LOCAL` simply because that's consistent with the order (first `SAGE_INST_TEMP`, then `SAGE_LOCAL`).

Actually, I think I'm going to rename `$SAGE_INST_TEMP` to `$SAGE_DESTDIR` for consistency with the DESTDIR convention. I think that makes it clear what it's for.  Then the `$SAGE_DESTDIR$SAGE_LOCAL` combination can be called `$SAGE_DESTDIR_LOCAL`.


---

Comment by git created at 2017-07-12 16:07:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-13 08:21:33

Replying to [comment:14 jdemeyer]:
> I see `${SAGE_INST_TEMP}${SAGE_LOCAL}` occuring in various places, maybe you should define a new variable for this.

Actually on second thought, there was a reason for this: The idea was that if `$SAGE_INST_TEMP` isn't set then installation straight into `$SAGE_LOCAL` will still work.  The way this works currently is `$SAGE_INST_TEMP` is set by `sage-spkg` which handles the details of how to copy from the temporary install path into SAGE_LOCAL, and record the file manifest.

But if you're just running a package's spkg-install directly, then `$SAGE_INST_TEMP` is not set.  With #23179 in place I could make it so that `$SAGE_INST_TEMP` is always set in the script wrappers.  But I'm not necessarily sure that's desirable, since if you're running the script outside of sage-spkg the implementation details of staged installation are not meaningful, and it may be more useful to install directly into SAGE_LOCAL assuming it's for testing purposes.  Of course, one can always manually pass in a value for `$SAGE_INST_TEMP`.

So I think it would be better *not* to combine `$SAGE_INST_TEMP$SAGE_LOCAL` into a single variable, unless others are convinced that there is no use case for installing without `$SAGE_INST_TEMP` set.

(I do still want to rename it `$SAGE_DESTDIR`--in this way it is used quite analogously to the way `$(DESTDIR)` is used in Makefiles.)


---

Comment by embray created at 2017-07-13 08:24:36

If it helps makes things more readable I could use the curly-brace syntax like `${SAGE_INST_TEMP}${SAGE_LOCAL}` rather then running them directly together.


---

Comment by git created at 2017-07-13 08:27:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-20 16:08:33

I think that, pending #23160, this is basically ready.  I've tested it quite extensively myself on Linux and Cygwin and haven't encountered any more obvious problems.

The only exception would be that there are still some packages that write files that clobber each other, but they are only cases of optional/experimental packages clobbering standard packages, or optional/experimental packages clobbering each other.  These include:

 * openblas / atlas
 * mpir / gmp
 * boost_cropped / boost
 * pari_seadata_small / database_pari
 * database_stein_watkins_small / database_stein_watkins
 * gcc / compilerwrapper

However, these incompatibilities were already the status quo.  While it will be possible in the future to improve the status quo (#23465 is work in that direction), I think these cases can be fixed independently of this ticket.  This ticket otherwise fixes all examples among standard (and some optional packages) where files were overwriting each other.


---

Comment by embray created at 2017-07-20 16:08:33

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-07-20 16:54:24

On OS X, I get this with the `patch` package:

```
cp: illegal option -- u
usage: cp [-R [-H | -L | -P]] [-fi | -n] [-apvX] source_file target_file
       cp [-R [-H | -L | -P]] [-fi | -n] [-apvX] source_file ... target_directory
cp: illegal option -- u
usage: cp [-R [-H | -L | -P]] [-fi | -n] [-apvX] source_file target_file
       cp [-R [-H | -L | -P]] [-fi | -n] [-apvX] source_file ... target_directory
Successfully installed patch-2.7.5
```

A little later the same error causes yasm not to be installed, so mpir won't install:

```
[mpir-3.0.0.p0] configure: error: no system-wide yasm found
```

In addition to fixing the `cp` command in `sage-spkg`, should you also check for errors after executing commands like this so as to avoid "Successfully installed patch-2.7.5" when it didn't actually successfully install?


---

Comment by jhpalmieri created at 2017-07-20 16:54:24

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2017-07-20 17:00:10

See also https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/cp.1.html (this page says it is retired, but it agrees with the man page on my Mac) and possibly also https://stackoverflow.com/questions/1132508/how-to-emulate-cp-update-behavior-on-mac-os-x.


---

Comment by embray created at 2017-07-20 17:01:56

Thanks for the quick feedback!  I'll have to take a look at the OSX manpage ðŸ˜ž.  This is fairly simple functionality to duplicate.


---

Comment by embray created at 2017-07-20 17:10:59

Honestly, the `-u` isn't even necessary.  In most cases it's going to be superfluous so I'd probably just remove it.


---

Comment by git created at 2017-07-20 17:14:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-20 17:15:24

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-07-20 21:06:22

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2017-07-20 21:06:22

`ncurses` fails to install for me (on OS X):

```
Copying package files from temporary location /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.0.rc0/local/var/tmp/sage/build/ncurses-6.0/inst to /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.0.rc0/local
cp: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.0.rc0/local/var/tmp/sage/build/ncurses-6.0/inst/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.0.rc0/local//lib/terminfo is a directory (not copied).
************************************************************************
Error copying files for ncurses.
************************************************************************
```



---

Comment by embray created at 2017-07-21 08:16:06

Do you know the correct way to copy a symbolic link without dereferencing it on OSX?  It should be `-P`, but according to that man page it only respects `-P` if `-R` is used also.  But this is copying files one at a time.  I _could_ use `-R` but would still have to loop over all the files anyways in order to build the manifest.  Also that man page says:


```
In -R mode, cp will continue copying even if errors are detected.
```


which isn't necessarily what I want either.


---

Comment by git created at 2017-07-21 08:21:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-21 08:22:12

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-07-21 12:24:44

~~It occurs to me that the `pkgconf` package isn't being handled quite correctly.  This leads to problems when re-installing / upgrading that package.~~

Nevermind, for the purposes of _this_ ticket it's fine.  It's only a problem in #22510.


---

Comment by jhpalmieri created at 2017-07-22 05:10:59

Now python2 and python3 don't install:

```
Installing valgrind suppression file...
./spkg-install: line 140: ./python: is a directory
Testing importing of various modules...
./spkg-install: line 162: ./python: is a directory
ctypes module failed to import
./spkg-install: line 162: ./python: is a directory
math module failed to import
./spkg-install: line 162: ./python: is a directory
hashlib module failed to import
./spkg-install: line 162: ./python: is a directory
crypt module failed to import
./spkg-install: line 162: ./python: is a directory
readline module failed to import
./spkg-install: line 162: ./python: is a directory
socket module failed to import
./spkg-install: line 171: ./python: is a directory
_scproxy module failed to import
Error: One or more modules failed to import.
```



---

Comment by embray created at 2017-07-31 09:11:58

Does OSX have case-insensitivity or something?


---

Comment by embray created at 2017-07-31 10:44:31

Or in other words, if I have in the same directory an executable called `python` and a directory called `Python` (as is the case in the CPython source tree) what will happen if I run `./python` on OSX?


---

Comment by embray created at 2017-07-31 12:21:25

Coincidentally, I just discovered that this also fixes a rare race condition that results from the fact that multiple packages write to `$SAGE_LOCAL/usr/share/info/dir`.  If two packages that write to that file are installed in parallel there are probably a number of ways that can go wrong, such as (what just happened to me):

A) `[ ! -d $(DESTDIR)$info_dir ] ...`

B) `mkdir $(DESTDIR)$info_dir`

A) `... || mkdir $(DESTDIR)$info_dir`


resulting in directory already exists error.


---

Comment by embray created at 2017-07-31 12:30:15

Replying to [comment:46 embray]:
> Does OSX have case-insensitivity or something?

It turns out Python's `./configure` explicitly checks this.  Does the build log say something like


```
checking for case-insensitive build directory...yes
```


?


---

Comment by embray created at 2017-07-31 12:39:13

Indeed, it looks like on _any_ OS (including OSX) if a case-insensitive filesystem is being built on it outputs the Python executable in the build dir as `python.exe` so we just need to look for that I guess.


---

Comment by git created at 2017-07-31 12:45:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-31 12:45:39

Give that a try. I can't imagine there's any other reason for this.


---

Comment by jhpalmieri created at 2017-07-31 17:24:05

Yes, OS X has a type of case-insensitivity. The current branch gets a little farther, but still fails. With python2:

```
Installing valgrind suppression file...
Testing importing of various modules...
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/Lib/ctypes/__init__.py", line 7, in <module>
    from _ctypes import Union, Structure, Array
ImportError: dlopen(/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_ctypes.so, 2): Symbol not found: _PyUnicodeUCS4_AsEncodedString
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_ctypes.so
  Expected in: flat namespace
 in /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_ctypes.so
ctypes module failed to import
math module imported OK
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/Lib/hashlib.py", line 158, in <module>
    import struct
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/Lib/struct.py", line 1, in <module>
    from _struct import *
ImportError: dlopen(/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_struct.so, 2): Symbol not found: _PyUnicodeUCS4_AsEncodedString
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_struct.so
  Expected in: flat namespace
 in /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_struct.so
hashlib module failed to import
crypt module imported OK
readline module imported OK
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/Lib/socket.py", line 47, in <module>
    import _socket
ImportError: dlopen(/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_socket.so, 2): Symbol not found: _PyUnicodeUCS4_AsEncodedString
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_socket.so
  Expected in: flat namespace
 in /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python2-2.7.13.p1/src/build/lib.macosx-10.9-x86_64-2.7/_socket.so
socket module failed to import
_scproxy module imported OK
Error: One or more modules failed to import.
```

It's odd that some of the modules succeeded while others failed.

With python3:

```
Installing valgrind suppression file...
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
Testing importing of various modules...
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 160: 84992 Abort trap: 6           $PYTHON -c "import $module"
ctypes module failed to import
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 160: 84993 Abort trap: 6           $PYTHON -c "import $module"
math module failed to import
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 160: 84995 Abort trap: 6           $PYTHON -c "import $module"
hashlib module failed to import
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 160: 84997 Abort trap: 6           $PYTHON -c "import $module"
crypt module failed to import
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 160: 84998 Abort trap: 6           $PYTHON -c "import $module"
readline module failed to import
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 160: 85000 Abort trap: 6           $PYTHON -c "import $module"
socket module failed to import
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/lib/libpython3.6m.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/python3-3.6.1/src/./python.exe
  Reason: image not found
./spkg-install: line 176: 85001 Abort trap: 6           $PYTHON -c "import _scproxy"
_scproxy module failed to import
Error: One or more modules failed to import.
```



---

Comment by embray created at 2017-08-01 13:22:52

I see.  This probably means that some `DYLD_LIBRARY_PATH` or similar needs to be set in order for Python being run out of the source tree to link with the correct libpython.

Thanks for your testing / patience--I need to bother nthiery to get me an OSX machine I can test on so that this will be easier in the future.

Other than this Python thing I don't anticipate too many other issues with this.  The only reason Python is being stubborn is that I made a somewhat non-trivial change to how the Python self-tests are performed.  Very few of the other packages otherwise have significant changes to how they're installed (though a few do).


---

Comment by jhpalmieri created at 2017-08-01 18:23:08

Python has also always been finicky to install on OS X. Anyway, imitating what was there already for linux works on this machine: adding

```
if [ "$UNAME" = "Darwin" ]; then
   export DYLD_LIBRARY_PATH="."
fi
```

right before `echo "Testing importing of various modules..."`, for example, fixed both `python2` and `python3`.

Other issues: this one is strange and non-repeatable, but I saw this once with maxima:

```
Found local metadata for maxima-5.39.0.p0
Could not find platform independent libraries <prefix>
Could not find platform dependent libraries <exec_prefix>
Consider setting $PYTHONHOME to <prefix>[:<exec_prefix>]
ImportError: No module named site
************************************************************************
Error downloading maxima-5.39.0.tar.gz
************************************************************************
```

In this case, the maxima tarball had already been downloaded to the `upstream` directory. When I ran "make" again, it went smoothly. I don't know if this is worth investigating.

More importantly, I get build errors with `gsl` and `numpy`. For `gsl`:

```
checking build system type... x86_64-apple-darwin16.7.0
checking host system type... x86_64-apple-darwin16.7.0
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... configure: error: in `/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta0/local/var/tmp/sage/build/gsl-2.3/src':
configure: error: cannot run C compiled programs.
If you meant to cross compile, use `--host'.
See `config.log' for more details
```

config.log says

```
configure:3480: checking whether the C compiler works
configure:3502: gcc -g -O2   -L/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib  conftest.c -lopenblas   -lm >&5
configure:3506: $? = 0
configure:3554: result: yes
configure:3557: checking for C compiler default output file name
configure:3559: result: a.out
configure:3565: checking for suffix of executables
configure:3572: gcc -o conftest -g -O2   -L/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib  conftest.c -lopenblas   -lm >&5
configure:3576: $? = 0
configure:3598: result: 
configure:3620: checking whether we are cross compiling
configure:3628: gcc -o conftest -g -O2   -L/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib  conftest.c -lopenblas   -lm >&5
configure:3632: $? = 0
configure:3639: ./conftest
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/openblas-0.2.19.p0/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/libopenblas_haswell-r0.2.19.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/gsl-2.3/src/./conftest
  Reason: image not found
./configure: line 3641:  5891 Abort trap: 6           ./conftest$ac_cv_exeext
configure:3643: $? = 134
configure:3650: error: in `/Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/gsl-2.3/src':
configure:3652: error: cannot run C compiled programs.
If you meant to cross compile, use `--host'.
```

I don't know why it seems to be looking for `libopenblas_haswell-r0.2.19.dylib` in the temporary directory; the command invoking `./configure` has the correct `--prefix` and `--libdir`.

For `numpy`:

```
Copying numpy.egg-info to /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/numpy-1.12.1-py2.7.egg-info
running install_scripts
creating /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/bin
copying build/scripts.macosx-10.9-x86_64-2.7/f2py2 -> /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/bin
changing mode of /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/bin/f2py2 to 755
Traceback (most recent call last):
  File "<stdin>", line 3, in <module>
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/numpy/__init__.py", line 142, in <module>
    from . import add_newdocs
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/numpy/add_newdocs.py", line 13, in <module>
    from numpy.lib import add_newdoc
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/numpy/lib/__init__.py", line 8, in <module>
    from .type_check import *
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/numpy/lib/type_check.py", line 11, in <module>
    import numpy.core.numeric as _nx
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/numpy-1.12.1/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/numpy/core/__init__.py", line 24, in <module>
    raise ImportError(msg)
ImportError: 
Importing the multiarray numpy extension module failed.  Most
likely you are trying to import a failed build of numpy.
If you're working with a numpy git repo, try `git clean -xdf` (removes all
files not under version control).  Otherwise reinstall numpy.
```



---

Comment by embray created at 2017-08-07 08:57:33

I don't get any of these problems.  I will probably need an OSX machine to investigate.

It could have something to do with the

```
LIBS="`pkg-config --libs-only-l cblas` -lm"
```

passed to `configure` in gsl's spkg-install.  But that *shouldn't* be a problem.


---

Comment by git created at 2017-08-09 13:06:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-08-09 13:11:54

Rebased on the latest (positively reviewed) #23160.

I added the `DYLD_LIBRARY_PATH` fix needed for Python installation.

Also added an _untested_ possible fix for the gsl installation issue.  I think the issue here was a bug in OpenBLAS's Makefile on OSX with how it uses `install_name_tool`, and this should fix it but I'm not positive.  Chances are this would also fix the problem with numpy which is probably trying to link (unsuccessfully) to openblas.


---

Comment by jhpalmieri created at 2017-08-09 17:30:11

This works now, Sage builds and all tests pass.


---

Comment by jhpalmieri created at 2017-08-09 21:33:35

Several packages fail their test suites. flint:

```
gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt    -c -o test_helpers.o test_helpers.c
make  build/test/t-add_ssaaaa  build/test/t-add_sssaaaaaa  build/test/t-count_leading_zeros  build/test/t-count_trailing_zeros  build/test/t-sdiv_qrnnd  build/test/t-smul_ppmm  build/test/t-sub_ddmmss  build/test/t-udiv_qrnnd  build/test/t-udiv_qrnnd_preinv  build/test/t-umul_ppmm
mkdir -p build/test
gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib  test/t-add_ssaaaa.c -o build/test/t-add_ssaaaa -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread 

[snip]

gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib  test/t-udiv_qrnnd_preinv.c -o build/test/t-udiv_qrnnd_preinv -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread 
gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/include -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib  test/t-umul_ppmm.c -o build/test/t-umul_ppmm -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread 
(BUILD_DIR=build; export BUILD_DIR; make -f Makefile.subdirs -C . check || exit$?;)
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib/libflint-13.5.2.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/flint-2.5.2.p1/src/build/test/t-add_ssaaaa
  Reason: image not found
make[4]: *** [build/test/t-add_ssaaaa_RUN] Abort trap: 6
/bin/sh: exit2: command not found
make[3]: *** [check] Error 127
Error: FLINT failed to pass its test suite.
```

arb:

```
Running the test suite for arb-2.8.1.p1...
make[4]: Nothing to be done for `shared'.
make[5]: Nothing to be done for `shared'.
    CC   ../build/fmpr/test/t-abs_bound_le_2exp_fmpz
    CC   ../build/fmpr/test/t-abs_bound_lt_2exp_fmpz
    CC   ../build/fmpr/test/t-abs_bound_lt_2exp_si
    CC   ../build/fmpr/test/t-add
    CC   ../build/fmpr/test/t-add_naive
    CC   ../build/fmpr/test/t-cmp
    CC   ../build/fmpr/test/t-cmp_2exp_si
    CC   ../build/fmpr/test/t-cmpabs
    CC   ../build/fmpr/test/t-cmpabs_2exp_si
    CC   ../build/fmpr/test/t-div
    CC   ../build/fmpr/test/t-divappr_abs_ubound
    CC   ../build/fmpr/test/t-exp
    CC   ../build/fmpr/test/t-expm1
    CC   ../build/fmpr/test/t-get_d
    CC   ../build/fmpr/test/t-get_fmpz
    CC   ../build/fmpr/test/t-get_mpfr
    CC   ../build/fmpr/test/t-log
    CC   ../build/fmpr/test/t-log1p
    CC   ../build/fmpr/test/t-mul
    CC   ../build/fmpr/test/t-mul_fmpz
    CC   ../build/fmpr/test/t-mul_naive
    CC   ../build/fmpr/test/t-mul_si
    CC   ../build/fmpr/test/t-mul_ui
    CC   ../build/fmpr/test/t-normalise
    CC   ../build/fmpr/test/t-root
    CC   ../build/fmpr/test/t-rsqrt
    CC   ../build/fmpr/test/t-set_fmpq
    CC   ../build/fmpr/test/t-set_fmpz_2exp
    CC   ../build/fmpr/test/t-set_round_mpn
    CC   ../build/fmpr/test/t-set_round_ui_2exp_fmpz
    CC   ../build/fmpr/test/t-set_round_uiui_2exp_fmpz
    CC   ../build/fmpr/test/t-sqrt
    CC   ../build/fmpr/test/t-sub
    CC   ../build/fmpr/test/t-sum
    CC   ../build/fmpr/test/t-ulp
dyld: Library not loaded: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib/libarb-1.1.1.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/arb-2.8.1.p1/src/fmpr/../build/fmpr/test/t-abs_bound_le_2exp_fmpz
  Reason: image not found
make[4]: *** [../build/fmpr/test/t-abs_bound_le_2exp_fmpz_RUN] Abort trap: 6
make[3]: *** [check] Error 2
```

R:

```
Running the test suite for r-3.4.0.p0...
../../bin/R: line 246: /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib/R//etc/ldpaths: No such file or directory
make[6]: *** [test-Examples-Base] Error 1
make[5]: *** [test-Examples] Error 2
make[4]: *** [test-all-basics] Error 1
make[3]: *** [check] Error 2
Error while running the R testsuite ... exiting
```

Singular:

```
Running the test suite for singular-4.1.0p3.p0...
./spkg-check: line 33: Singular: command not found
Error loading the freegb library in Singular.
```

pycrypto:

```
Running the test suite for pycrypto-2.6.1.p2...
PyCrypto will now be tested
running test
Traceback (most recent call last):
  File "setup.py", line 456, in <module>
    core.setup(**kw)
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib/python2.7/distutils/core.py", line 151, in setup
    dist.run_commands()
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib/python2.7/distutils/dist.py", line 953, in run_commands
    self.run_command(cmd)
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/lib/python2.7/distutils/dist.py", line 972, in run_command
    cmd_obj.run()
  File "setup.py", line 321, in run
    from Crypto import SelfTest
ImportError: No module named Crypto
Error: PyCrypto failed to pass its test suite.
```

cvxopt:

```
Running the test suite for cvxopt-1.1.8.p2...
Testing in /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/cvxopt-1.1.8.p2/src/examples/doc/chap10
Testing l1svc.py ...
Traceback (most recent call last):
  File "l1svc.py", line 3, in <module>
    from cvxopt import normal, setseed
ImportError: No module named cvxopt
Error: test /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.1.beta1/local/var/tmp/sage/build/cvxopt-1.1.8.p2/src/examples/doc/chap10/l1svc.py failed
```



---

Comment by embray created at 2017-08-10 18:21:49

How are you running these?  I don't know why it would work any differently.


---

Comment by jhpalmieri created at 2017-08-10 19:02:16

I get failures from `make distclean; export SAGE_CHECK=yes; make`. I get some (but not all) of these failures from  `./sage -f -c PKG_NAME`; this is after unsetting `SAGE_CHECK` and running `make`. But once the package has been installed successfully, then `./sage -f -c PKG_NAME` may behave differently, because it may be using installed versions of libraries, binaries, etc.; if it hasn't been installed, it won't be installed until `spkg-check` finishes successfully.


---

Comment by jdemeyer created at 2017-08-11 11:35:04

In `build/pkgs/widgetsnbextension/spkg-install` you write

```
# Note: Setting PYTHONPATH here is something of a hack to support
# installation into $SAGE_DESTDIR.  This might be better handled
# as a post-install step
SITE_PACKAGES="$(sage-python23 -c 'import site; print(site.getsitepackages()[0])')"
PYTHONPATH="$SAGE_DESTDIR$SITE_PACKAGES" jupyter nbextension enable --sys-prefix --py widgetsnbextension
```

I agree that this looks more like a post-install step, so why didn't you implement it that way?


---

Comment by jdemeyer created at 2017-08-11 12:00:52

I am a bit lost where the `DESTDIR` stuff for autoconf packages is actually implemented. For Python packages, I see that you added the `--root` option to `PIP_INSTALL`.


---

Comment by jdemeyer created at 2017-08-11 12:03:58

Replying to [comment:33 embray]:
> This ticket otherwise fixes all examples among standard (and some optional packages) where files were overwriting each other.

What is the relevance of that for this ticket?

All those packages worked before. If such clobbering is no longer allowed, I consider that a regression introduced by this ticket.


---

Comment by embray created at 2017-08-11 12:29:18

Replying to [comment:63 jdemeyer]:
> I agree that this looks more like a post-install step, so why didn't you implement it that way?

When I first wrote that, support for post-install scripts wasn't added yet.  Now that it's there, I could probably revisit things like that.  Though I'd have to review what exactly `jupyter nbextension enable` does.  If it just writes some files then this might be fine.


---

Comment by embray created at 2017-08-11 12:42:09

Replying to [comment:62 jhpalmieri]:
> I get failures from `make distclean; export SAGE_CHECK=yes; make`. I get some (but not all) of these failures from  `./sage -f -c PKG_NAME`; this is after unsetting `SAGE_CHECK` and running `make`. But once the package has been installed successfully, then `./sage -f -c PKG_NAME` may behave differently, because it may be using installed versions of libraries, binaries, etc.; if it hasn't been installed, it won't be installed until `spkg-check` finishes successfully.

I'm having trouble building python3 with `SAGE_CHECK=yes`.  Did that ever work in the first place?


---

Comment by jhpalmieri created at 2017-08-11 15:00:12

In my experience, neither `python2` nor `python3` passed their self tests. With `python2` at least, this was true on a range of platforms. We should probably change the default value of `SAGE_CHECK_PACKAGES` to exclude `python3`; it already excludes `python2`.

Edit: I created #23612.


---

Comment by embray created at 2017-08-21 15:14:05

On the topic of the other SAGE_CHECK failures, the problem is probably similar to the problems I was having with Python: The checks are being performed before the files are installed from `SAGE_DESTDIR` into `SAGE_LOCAL`, so at the very least it might be necessary to set `LD_LIBRARY_PATH/DYLIB_LIBRARY_PATH`, but possibly other paths as well?

Rather than trying to fix every `spkg-check`, which may be difficult especially if I can't reproduce all the problems, it might be better for the sake of this ticket if I moved execution of `spkg-check` until after installation to `SAGE_LOCAL`.  This has the downside that the package still gets installed even if the check failed, but that's the existing situation anyways.  Once #22510 is done (which depends on this) it will be easier to do things like make a backup of an old package--try installing the new one--and revert to the old one if the installation failed.


---

Comment by embray created at 2017-08-21 15:19:02

Replying to [comment:64 jdemeyer]:
> I am a bit lost where the `DESTDIR` stuff for autoconf packages is actually implemented. For Python packages, I see that you added the `--root` option to `PIP_INSTALL`.

Just realized I never replied to this.  `DESTDIR=` is added in the helper function `sdh_make_install` (which is partly why I wanted that feature implemented for this ticket).  Note that it assumes `SAGE_DESTDIR` is set, which it may not be if the `spkg-install` is not being run from `sage-spkg`.  It might be worth noting that this is intentional--if `SAGE_DESTDIR` is left blank then direct installation to `SAGE_LOCAL` proceeds as normal, which is important and useful for testing, if nothing else. 

Otherwise, `SAGE_DESTDIR` is set in `sage-spkg`, and gets passed to `make install`, in most cases, by way of `sdh_make_install`.


---

Comment by embray created at 2017-08-21 17:26:23

For some reason on Linux I couldn't reproduce the problems running the tests for flint or arb (despite running `make distclean` first).  But I did get the same problems for the other packages.  As I wrote [here](https://trac.sagemath.org/ticket/22509#comment:69) it seems to be mostly a matter of setting the required environment variables.  But I think I'll still revert to the old behavior for SAGE_CHECK for now, just to keep this simpler.


---

Comment by git created at 2017-09-04 08:37:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-09-04 08:38:39

Just remembered there was still unfinished work on this that I hadn't pushed yet.  I think now it's addressed all the issues that have been raised so far.


---

Comment by jdemeyer created at 2017-09-04 09:31:26

One concern with this patch is that it's really a patch bomb, which might be hard to get reviewed and merged.

I don't think you have answered [comment:65]


---

Comment by embray created at 2017-09-04 10:28:02

I thought I addressed this somewhere but maybe not...

Replying to [comment:65 jdemeyer]:
> Replying to [comment:33 embray]:
> > This ticket otherwise fixes all examples among standard (and some optional packages) where files were overwriting each other.
> 
> What is the relevance of that for this ticket?
> 
> All those packages worked before. If such clobbering is no longer allowed, I consider that a regression introduced by this ticket.

I wouldn't consider it a regression at all.  The fact that some packages overwrote files installed by other packages is a bug, just one that hasn't had very serious effects.  Most cases of this were very minor (e.g. python3 overwrote the valgrind.supp installed by python2).

The goal of this ticket is, along with #22510 (where this becomes important) is to make sagedist work a little more like a real OS packaging system in that files are belonged by packages, with any one file belonging to just one package.  That way, uninstalling one package does not break another package that owns some of the same file(s).

In theory one _could_ design a packaging system where a file can belong to multiple packages, and only be removed once all packages that use it are removed.  But this is more complicated, and only works if that file is identical for all packages that use it (it may not be).

There is one particular example of a file shared between packages where this ticket _would_ introduce a regression if it didn't carefully handle this case: There's a file `info/share/dir` that is updated by any package that installs an `info` manual.  The new way packages are installed by ticket is such that each package will write a fresh `info/share/dir`, and then overwrite the existing one, rather than updating the existing one.  This makes sure to always update `info/share/dir` in a post-install script for those packages. 

Other than that, the other cases are mostly trivial.


---

Comment by git created at 2017-09-04 10:34:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-09-04 10:35:19

Had to rebase after I realized I pop'd the completely wrong stash entry into an earlier commit.


---

Comment by embray created at 2017-09-04 10:37:38

Replying to [comment:74 jdemeyer]:
> One concern with this patch is that it's really a patch bomb, which might be hard to get reviewed and merged.

True, but there's not much other way to handle it (I don't mind separating some changes out to separate tickets but some of them go hand-in-hand with this). John did test this extensively in OSX and got it working.  The only remaining concern was that some `spkg-check` tests weren't working.  I believe I've addressed that now, though it's hard to be 100% sure since some of those tests aren't working for me with or without this patch.

> I don't think you have answered [comment:65]

Done.


---

Comment by embray created at 2017-09-04 17:18:30

In an effort to split this up a little bit, I'm moving some of the fixes for the Python2/3 packages to a separate ticket, since it can work independently of this ticket: #23781


---

Comment by embray created at 2017-09-04 17:19:24

Wrong ticket.


---

Comment by git created at 2017-09-04 18:02:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by jdemeyer created at 2017-09-05 13:49:39

Replying to [comment:78 embray]:
> Replying to [comment:74 jdemeyer]:
> > One concern with this patch is that it's really a patch bomb, which might be hard to get reviewed and merged.
> 
> True, but there's not much other way to handle it

Why do you think that? This doesn't have to be an all-or-nothing patch: you could first implement the general framework and then gradually fix packages.

Anyway, if you find somebody else to review this, I don't mind at all. But for me, I am quite discouraged from reviewing such a big patch. And then there is also the potential for merge conflicts if you make so many changes.


---

Comment by embray created at 2017-09-05 14:07:14

I'm not sure how you would propose breaking this up.  It is pretty all-or-nothing: Either DESTDIR installation works or it doesn't.

There's no sense in "gradually fix packages" because they've already _all_ been fixed here, and in a way that is likely to result in only minor conflicts at worse (no more so than in #23179--the analysis in [this comment](https://trac.sagemath.org/ticket/23179#comment:43) still mostly applies).

I could break it up into multiple tickets--I already did in one case.  But for the most part I don't see what that solves.  If you want guidance on what to review, start by ignoring all the `build/pkgs` changes since the vast majority of them are completely mechanistic.


---

Comment by jdemeyer created at 2017-09-05 14:35:30

Replying to [comment:83 embray]:
> I'm not sure how you would propose breaking this up.  It is pretty all-or-nothing: Either DESTDIR installation works or it doesn't.

You could start with "`DESTDIR` works for a few selected packages" or "`DESTDIR` works for Python packages only"

> in a way that is likely to result in only minor conflicts at worse

A merge conflict is a merge conflict. It doesn't matter how minor it is.


---

Comment by embray created at 2017-09-05 15:42:52

Alright, that's fair.  I'll see if I can break this up a bit more.  

Fact remains, there's not much benefit to this unless all packages are updated.  There's no real logical way I can think of to carving it up into multiple tickets, when it can all be done at once.  But for the sake of making review easier I'll try out your suggestion...


---

Comment by jdemeyer created at 2017-09-06 08:21:37

Replying to [comment:85 embray]:
> I'll see if I can break this up a bit more.

Let me mention that this is a personal "pet peeve". If somebody else (John Palmieri for example) is happy with this ticket and wants to review it, I won't object to that.


---

Comment by jhpalmieri created at 2017-09-06 14:18:54

I'm not sure I understand the build process well enough to be competent enough to review it.


---

Comment by embray created at 2017-09-06 15:28:15

Replying to [comment:86 jdemeyer]:
> Replying to [comment:85 embray]:
> > I'll see if I can break this up a bit more.
> 
> Let me mention that this is a personal "pet peeve". If somebody else (John Palmieri for example) is happy with this ticket and wants to review it, I won't object to that.

It's fine--I see your point.  I think it's easier to review if one patch contains just:

* The basic structural changes
* A few motivating examples for the different cases

and then leave the remaining boilerplate changes to a separate ticket.


---

Comment by jdemeyer created at 2017-09-06 21:29:25

Replying to [comment:88 embray]:
> I think it's easier to review if one patch contains just:
> 
> * The basic structural changes
> * A few motivating examples for the different cases

Exactly. But I would prefer to finish #23781 and #21535 first.


---

Comment by embray created at 2017-09-07 09:48:45

I'm not exactly sure what #21535 has to do with this.


---

Comment by jdemeyer created at 2017-09-07 10:18:05

Replying to [comment:90 embray]:
> I'm not exactly sure what #21535 has to do with this.

It's unrelated. I just mentioned it because I can only keep track of a limited number of build-system tickets in my brain cache.


---

Comment by git created at 2017-10-11 15:07:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-10-11 15:09:29

Went ahead and rebased on current #23781.  But I'm now I'm going to do some surgery to break this into some smaller tickets for which this ticket will serve as the mothership.


---

Comment by embray created at 2017-10-11 15:14:45

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-20 14:50:01

Replying to [comment:93 embray]:
> Went ahead and rebased on current #23781.

This doesn't need to depend on #23781. Just leave the Python build script alone.


---

Comment by embray created at 2017-10-23 08:47:00

Uhh, it does need to in a manner of speaking.  Eventually the Python build script needs to be updated to support this.  But I'm already working on completely breaking this up in to separate tickets.


---

Comment by embray created at 2017-10-25 15:04:35

Added #24106--a simplified ticket demonstrating the core functionality of the branch on this ticket.  Will add followup tickets with additional details.


---

Comment by jdemeyer created at 2018-02-02 15:20:12

I am surprised now to see that #22509 and #24106 are distinct tickets. Isn't this one a "duplicate"? There is a stale branch here, is that still relevant?


---

Comment by embray created at 2018-02-02 15:41:45

see [comment:93]


---

Comment by jdemeyer created at 2018-03-19 08:27:37

Replying to [comment:28 embray]:
> Then the `$SAGE_DESTDIR$SAGE_LOCAL` combination can be called `$SAGE_DESTDIR_LOCAL`.

I don't remember if there was a reason not to do this, but I'll introduce this variable in #25001.


---

Comment by embray created at 2018-03-19 08:41:48

Yes, there was a reason: #22509#comment:30

Though I suppose if `$SAGE_DESTDIR` isn't set then it's fine if `$SAGE_DESTDIR_LOCAL == $SAGE_LOCAL`.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-02-09 22:34:08

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-02-09 22:34:08

I suggest to close this ticket because its goals have been achieved and the remaining tasks seem to be covered by #24024.
