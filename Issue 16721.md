# Issue 16721: MPolynomial eval mem leak

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2014-09-10 13:57:33

CC:  malb jpflori




---

Comment by vbraun created at 2014-09-10 14:09:19

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-09-10 14:09:19

Changing component from PLEASE CHANGE to algebra.


---

Comment by vbraun created at 2014-09-10 14:09:19

New commits:


---

Comment by vbraun created at 2014-09-10 14:09:19

Changing type from PLEASE CHANGE to defect.


---

Comment by jpflori created at 2014-09-10 14:33:20

Can you add a doctest showing the leak is fixed?


---

Comment by vbraun created at 2014-09-10 14:42:00

Mmm got another segfault elsewhere..


---

Comment by vbraun created at 2014-09-10 14:42:00

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2014-09-10 15:43:26

Shouldn't those fixes be reported upstream?


---

Comment by SimonKing created at 2014-09-10 15:44:29

Ah, sorry, spoke to soon: The leak was in Sage library, not in Singular.


---

Comment by nbruin created at 2014-09-10 18:37:33

Replying to [comment:4 vbraun]:
> Mmm got another segfault elsewhere..
That doesn't surprise me. We tried to properly interface with libsingular's reference counting before and, while we came close, it ended up being a rather nightmarish experience. See #13447.

I am still quite hopeful that this can be fixed *if the right experts get in the same room* for a couple of days (either that or people will find out if libsingular's reference counting is fundamentally broken).

(note that #13447 is about garbage collecting rings, which are probably a little more complicated data structures. Nonetheless, there may well be components in common).


---

Comment by vbraun created at 2014-09-10 19:04:28

I'm pretty sure I'm doing the right thing, you get a pointer to a poly so duh of course it needs to be deallocated. There are only two doctest failures in Sage, so I'm mildly optimistic. I'm probably uncovering bugs elsewhere...

Simon, did you make any progress towards a debug build?


---

Comment by SimonKing created at 2014-09-10 19:29:35

Replying to [comment:8 vbraun]:
> Simon, did you make any progress towards a debug build?

I got answer from Hans SchÃ¶nemann. But I don't know yet if it works. To be discussed on the other ticket.


---

Comment by git created at 2014-09-14 12:27:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-14 12:58:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-14 13:05:09

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-09-14 13:05:09

Singular's `fast_map` returns non-normalized values (e.g. rational coefficients are not in standard form). As far as I know, this shouldn't be a problem yet we still segfault in the `p_Delete`. Adding a `p_Normalize` avoids the segfault. Perhaps there is a subtle bug / hidden assumption in `fast_map` that requires the normalization, I don't know.


---

Comment by malb created at 2014-09-23 14:08:49

Replying to [comment:12 vbraun]:
> Singular's `fast_map` returns non-normalized values (e.g. rational coefficients are not in standard form). As far as I know, this shouldn't be a problem yet we still segfault in the `p_Delete`. Adding a `p_Normalize` avoids the segfault. Perhaps there is a subtle bug / hidden assumption in `fast_map` that requires the normalization, I don't know. 

I don't know the answer, maybe ask on [libsingular-devel]?


---

Comment by vbraun created at 2014-09-30 11:11:30

I asked at https://groups.google.com/d/msg/libsingular-devel/NV_j8Fugi4o/a7OdyHQSFf4J but didn't get a reply


---

Comment by jpflori created at 2014-12-08 15:02:44

Works fine for me.
For sure the need for normalize does not really make sense, but it makes the situation a little better here.


---

Comment by jpflori created at 2014-12-08 15:02:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-12-12 12:29:41

Resolution: fixed


---

Comment by SimonKing created at 2014-12-12 12:42:28

I wonder if that fixes the memory leak for the letterplace algebra, that I noticed while working on #17435. If it doesn't, I should open a new ticket at some point...


---

Comment by SimonKing created at 2014-12-12 22:19:44

Why has the commit information been written into the "branch" field when Volker closed the ticket? And why has my post resulted in a deletion of the commit field? I didn't touch it!
