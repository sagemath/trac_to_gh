# Issue 18086: switch to C++11

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2015-04-28 16:11:00

Keywords: c++ gcc cxx gcc5

C++11 is at least needed by NTL and a development version of Pynac, and it's the default with gcc5.

https://en.wikipedia.org/wiki/C%2B%2B11

The complications are eg compile errors in lcalc headers:

```
In file included from ../local/include/libLfunction/Lglobals.h:48:0,
                 from ../local/include/libLfunction/L.h:40,
                 from build/cythonized/sage/libs/lcalc/lcalc_sage.h:1,
                 from build/cythonized/sage/libs/lcalc/lcalc_Lfunction.cpp:337:
../local/include/libLfunction/Lcommon.h: In member function ‘void smallPoly<T>::resize(int)’:
../local/include/libLfunction/Lcommon.h:71:23: error: expected ‘;’ before ‘i’
   loop(i,this->N,N)
                       ^
../local/include/libLfunction/Lcommon.h:71:36: error: ‘i’ was not declared in this scope
   loop(i,this->N,N)
                                    ^
../local/include/libLfunction/Lcommon.h: In function ‘smallPoly<T>::poly operator*(const poly&, const poly&)’:
../local/include/libLfunction/Lcommon.h:87:15: error: there are no arguments to ‘typeof’ that depend on a template parameter, so a declaration of ‘typeof’ must be available [-fpermissive]
   loop(i,0,f.N) result[i]=0;
               ^
../local/include/libLfunction/Lcommon.h:87:15: note: (if you use ‘-fpermissive’, G++ will accept your code, but allowing the use of an undeclared name is deprecated)
```

We don't want these to go through with `-fpermissive`.


---

Comment by leif created at 2015-04-28 17:00:57

Well, we don't *have to* compile everything in C++ (implicitly or explicitly) with `-std=c++11`, but Lcalc's special anyway (cf. http://trac.sagemath.org/ticket/12437#comment:15 for example).  See also #12426 and many (already closed) tickets dealing with C++11/GCC 4.7, 5.x.


---

Comment by leif created at 2015-04-28 17:16:39

P.S.:  While the GCC 4.6 and 4.7 series reached "end of life", there are still (LTS) distros using these.


---

Comment by fbissey created at 2015-04-28 23:01:57

Remember also that gcc 5.1 is defaulting to `-std=gnu11` for C so there may be other surprises but you would already have noticed them I am guessing?


---

Comment by fbissey created at 2015-04-29 00:14:36

We should list all the other tickets for `C++11` or have a meta ticket somewhere.


---

Comment by leif created at 2015-04-29 01:39:22

Replying to [comment:3 fbissey]:
> Remember also that gcc 5.1 is defaulting to `-std=gnu11` for C so there may be other surprises but you would already have noticed them I am guessing?

Ahem, like #18326, which is a duplicate of #18247? B)


---

Comment by leif created at 2015-04-29 09:27:52

Replying to [comment:4 fbissey]:
> We should list all the other tickets for `C++11` or have a meta ticket somewhere. 

We've already done a lot in that direction in the past, see for example the closed metaticket on GCC 4.7.0 (#12751), or [search for C++11 on trac](http://trac.sagemath.org/search?q=C%2B%2B11&noquickjump=1&ticket=on).

Related: #12426 (Metaticket for Clang; at least some issues are related to C++ or GNUisms)


---

Comment by fbissey created at 2015-04-29 09:35:51

I like meta tickets (but not abusing them). I guess I should rather look for a port to gcc 5.1 meta ticket, this one would just be a consequence. Looking at #18301now...


---

Comment by leif created at 2015-04-29 10:37:52

Replying to [comment:7 fbissey]:
> I like meta tickets (but not abusing them). I guess I should rather look for a port to gcc 5.1 meta ticket, this one would just be a consequence. Looking at #18301 now...

There's a thread "Issues with GCC 5.x" on sage-devel.  Besides MPIR, Lcalc, and ncurses (all fixed), I'm having problems with gf2x on x86_64 (work-around: `-O0` or `GF2X_CONFIGURE=--disable-hardware-specific-code`).


---

Comment by rws created at 2015-04-30 07:15:26

I just confirmed that you simply cannot compile a package with C++11 and expect the `.so` file to match all references generated by libsage compilation using a pre-C++11 compile. Specifically the template `class std::vector<GiNaC::ex>` will create incompatible code.

Okay, you knew that beforehand, but I had to prove it to myself.


---

Comment by rws created at 2015-04-30 07:40:19

Sorry for specializing but only this guarantees that I will be working on it.


---

Comment by git created at 2015-04-30 08:26:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-04-30 08:28:07

Changing status from new to needs_review.


---

Comment by fbissey created at 2015-04-30 09:29:25

I'll be picky.
 1) I would have put that patch in the same ticket that starts the use of `C++11` in pynac. That's where it belongs, it's an associated change.
 2) cosmetic, the indentation is wrong.
 3) do you need to define a variable with an extra long name to replace what is just `-std=c++11` in only three different places? It feels overkill. I would have tolerated a variable with a shorter name, to switch `C++11` on - we'll see more of that certainly. Unless you plan to add more flags in the near future, I don't see why it should be symbolics specific


---

Comment by rws created at 2015-04-30 12:40:48

Thanks for the input. We could as well wait until gcc5 is mandatory in Sage, or even earlier, as soon as all C++ packages compile with C++11, and then switch globally. It's not that there is pressing interest in Pynac right now.


---

Comment by leif created at 2015-04-30 14:22:18

Just for the record:  `g++` 5.x doesn't default to `-std=c++11`, not even `-std=gnu++11` or `-std=gnu++0x`, but `-std=gnu++98`.


---

Comment by leif created at 2015-04-30 14:54:52

... and the first `g++` version said to be C++11 feature-complete is 4.8.1.

Since we already have 4.9.2 in Sage, we'd "just" have to `SAGE_INSTALL_GCC` on systems with 4.8.0 (if such exist at all), 4.7, 4.6, and earlier.

Ubuntu 12.04 with 5-year LTS still ships with "Ubuntu/Linaro GCC" 4.6 for example.


---

Comment by leif created at 2015-04-30 16:34:17

If you have time, you could try building Sage with `-Werror=c++11-compat` in `CXXFLAGS` (`CFLAGS` for modules built by distutils, or added to `extra_compile_args`)... :P


---

Comment by jdemeyer created at 2015-05-03 11:07:37

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-03 11:07:37

You should leave `module_list.py` alone and move those flags to the appropriate `.pxd` file.


---

Comment by rws created at 2015-05-27 07:44:10

Replying to [comment:20 jdemeyer]:
> You should leave `module_list.py` alone and move those flags to the appropriate `.pxd` file.
How do I do that? The manual says nothing of it:

"A definition file can contain:

 * Any kind of C type declaration.
 * extern C function or variable declarations.
 * Declarations of C functions defined in the module.
 * The definition part of an extension type (see below)."


---

Comment by jdemeyer created at 2015-05-27 07:54:54

See #18450 (note that this ticket might also conflict with that)


---

Comment by rws created at 2015-05-27 09:37:29

This works now but still relies on a C++11 compiler. It was discussed above what efforts were already done to make the rest of Sage gcc5 compatible. My mistake was to assume that with gcc5 we would automatically get C++11. So what are the chances that whatever shipped gcc, which is at 4.9x I understand, will be made mandatory (it need not be switched to C++11 globally, it just needs to be there when the seven files are compiled)?
----
New commits:


---

Comment by rws created at 2015-05-27 09:37:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-27 09:38:01

If those flags are only needed to support pynac, they should only be added to pynac declarations, not other random files like `ring.pxd`.


---

Comment by jdemeyer created at 2015-05-27 09:38:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-27 09:39:44

This needs [https://github.com/cython/cython/pull/381](https://github.com/cython/cython/pull/381): therefore, it needs to depend on #18450 or you need to wait for the next Cython release.


---

Comment by jdemeyer created at 2015-05-27 09:56:13

Replying to [comment:24 rws]:
> So what are the chances that whatever shipped gcc, which is at 4.9x I understand, will be made mandatory (it need not be switched to C++11 globally, it just needs to be there when the seven files are compiled)?

I don't think we should ever make `GCC 4.9.x` mandatory. What could be discussed is making `C++0x` or `C++11` support mandatory.


---

Comment by rws created at 2015-05-27 10:04:22

Replying to [comment:25 jdemeyer]:
> If those flags are only needed to support pynac, they should only be added to pynac declarations, not other random files like `ring.pxd`.
Indeed, it boils down to `expression.pxd`.
> it needs to depend on #18450 or you need to wait for the next Cython release.
It's pending, so just wait. I expect some friction with mandatory C++11, anyway.
----
New commits:


---

Comment by rws created at 2015-05-27 10:04:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-27 10:32:59

Replying to [comment:30 rws]:
> Indeed, it boils down to `expression.pxd`.

Really? Not `ginac.pxd`?


---

Comment by rws created at 2015-05-27 13:11:10

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 rws]:
> > Indeed, it boils down to `expression.pxd`.
> 
> Really? Not `ginac.pxd`?

Never had a look at that: both work because the same files are affected. Granted, it would fit better with `ginac.pxd`.


---

Comment by jdemeyer created at 2015-05-27 13:58:30

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-27 15:44:01

Replying to [comment:30 rws]:
> I expect some friction with mandatory C++11, anyway.
Personally, I don't think it would be such a problem. The most annoying part will be testing with older GCC versions (for example, GCC 4.6.x supports some C++11 features, are these enough for Pynac?).

I put back the dependency on #18450 since otherwise this patch won't work properly.


---

Comment by rws created at 2015-05-27 16:35:32

Replying to [comment:34 jdemeyer]:
> Replying to [comment:30 rws]:
> > I expect some friction with mandatory C++11, anyway.
> Personally, I don't think it would be such a problem. The most annoying part will be testing with older GCC versions (for example, GCC 4.6.x supports some C++11 features, are these enough for Pynac?).
From a table I have here 4.6 is missing `override`. I could hold back usage of `override`, no problem.


---

Comment by fbissey created at 2015-09-22 03:38:22

Coming back to this... We could check for the feature that are necessary. If you need `override` we can first check for `c++11` as suggested by Jeroen, once we know that we have a `c++11` switch we can check for particular features like `override` it is just a matter of writing a test in `configure.ac`.

But making a decision on what we should want as minimal features for the compiler should be matter of debate on sage-devel.


---

Comment by jdemeyer created at 2015-09-22 08:05:15

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-22 08:05:15

Replying to [comment:14 fbissey]:
> I would have put that patch in the same ticket that starts the use of `C++11` in pynac. That's where it belongs, it's an associated change.

I totally agree. Close as "wontfix"?


---

Comment by fbissey created at 2015-09-22 08:52:00

Replying to [comment:37 jdemeyer]:
> Replying to [comment:14 fbissey]:
> > I would have put that patch in the same ticket that starts the use of `C++11` in pynac. That's where it belongs, it's an associated change.
> 
> I totally agree. Close as "wontfix"?

I am fine with closing. We should open a new ticket when we have decided exactly what we want on sage-devel.


---

Comment by fbissey created at 2015-09-22 08:52:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-25 08:21:20

I disagree. Holding back on allowing C++11 just means 
* taking on more technical debt as authors can't take advantage of the new features, writing code that may have to be changed later
* prevent contributors from being exposed to new C++11 features, slowing down their learning
* online C++ resources increasingly include C++11 features, making it even more difficult to learn how to not use them 
* delaying the inevitable, we'll have to shitlist broken compilers anyways


---

Comment by jdemeyer created at 2015-09-25 08:46:16

This ticket is about adding `std=c++11` for some ginac files. It's not about C++11 in general.

Besides, why do you think that people are prevented from using C++11? It's not like we prevent people from using their own C++11 compiler. Once their code gets in Sage, we make the switch in Sage.


---

Comment by fbissey created at 2015-09-25 08:48:55

Replying to [comment:40 jdemeyer]:
> This ticket is about adding `std=c++11` for some ginac files. It's not about C++11 in general.
> 

And a separate ticket wasn't the right place for it.

> Besides, why do you think that people are prevented from using C++11? It's not like we prevent people from using their own C++11 compiler. Once their code gets in Sage, we make the switch in Sage.

This ticket is not the right forum for the discussion. 

Nevertheless which minimum `gcc` would we be aiming for?


---

Comment by jdemeyer created at 2015-09-25 08:51:32

Replying to [comment:41 fbissey]:
> This ticket is not the right forum for the discussion.
Right, there is already a thread on sage-devel. Let's just close this discussion here.


---

Comment by cpernet created at 2015-09-25 08:57:29

Replying to [comment:40 jdemeyer]:
>  Once their code gets in Sage, we make the switch in Sage.

We are facing this problem for the update of LinBox Givaro and fflas-ffpack in #17635.


---

Comment by vbraun created at 2015-09-30 21:51:19

Resolution: wontfix
