# Issue 17335: Sage 6.5.beta4 build fails at r-3.1.2p0 on OS X 10.10.1

Issue created by migration from Trac.

Original creator: hsnyder

Original creation time: 2014-12-31 02:38:39

Keywords: r clang

Make fails after compiling sage binary while building r-3.1.2.p0. I'm using git source, branch "develop", on OS X 10.10.1. Error reported is missing header file "omp.h", but that file is present in ./local/lib/gcc/x86_64-apple-darwin14.0.0/4.9.2/include/omp.h. This also happens with OS X 10.10 and with Sage 6.4.beta3 and Sage 6.3. I'm using Xcode 6.1.1 and commandlinetoolsosx10.10forxcode6.1.1.

Reported in sage-release group under topic "Sage 6.5.beta4 released". Logfile ./logs/pkgs/r-3.1.2.p0.log to be attached.


---

Comment by hsnyder created at 2014-12-31 02:41:36

logs/pkgs/r-3.1.2.p0.log


---

Attachment

Can we have the config.log for R in /Users/uu1024/Git/sage/local/var/tmp/sage/build/r-3.1.2.p0/src/ ?
I don't have this problem on my own 10.10.1 machine. I note that clang is used only in some R packages and that's where a failure occurs. I don't appear to get clang anywhere in my logs.


---

Comment by hsnyder created at 2014-12-31 03:10:44

./local/var/tmp/sage/build/r-3.1.2.p0/src/config.log


---

Attachment

config.log attached. Do I need to add this comment, or does notification happen when a file is attached?


---

Comment by fbissey created at 2014-12-31 05:24:14

You most definitely need to comment. Notifications are not sent to me at least when files are attached.


---

Comment by fbissey created at 2014-12-31 08:45:15

I am not completely sure at this stage. Furthermore every R package usually has its own configure but it is all automatically erased in case of failure. Nevertheless two things come to mind
 * You have a very long PATH that may contain stuff that interfere. It it difficult to be sure without doing fault isolation.
 * For some reason tcl/tk is not detected while you appear to at least havehad quartz/X11 at some point.

As I said your PATh is quite long according to configure

```
PATH: /Users/uu1024/Git/sage/src/bin
PATH: /Users/uu1024/Git/sage/local/bin
PATH: /Users/uu1024/Git/sage/src/bin
PATH: /Users/uu1024/Git/sage/local/bin
PATH: /opt/local/bin
PATH: /opt/local/sbin
PATH: /Users/uu1024/Gcloud/google-cloud-sdk/bin
PATH: /Users/uu1024/.rvm/gems/ruby-2.0.0-p0/bin
PATH: /Users/uu1024/.rvm/gems/ruby-2.0.0-p0`@`global/bin
PATH: /Users/uu1024/.rvm/rubies/ruby-2.0.0-p0/bin
PATH: /Users/uu1024/.rvm/bin
PATH: /Users/uu1024/.rvm/bin
PATH: /opt/local/bin
PATH: /opt/local/sbin
PATH: /opt/local/bin
PATH: /opt/local/sbin
PATH: /opt/local/bin
PATH: /opt/local/sbin
PATH: /usr/local/bin
PATH: /usr/bin
PATH: /bin
PATH: /usr/sbin
PATH: /sbin
PATH: /opt/X11/bin
PATH: /usr/local/MacGPG2/bin
PATH: /Applications/Julia-0.2.0-pre-77cc4f1c90.app/Contents/Resources/julia/bin
```

What's in /opt/local? Is there anything in /usr/local?


---

Comment by jdemeyer created at 2014-12-31 09:09:35

The underlying reason is that `clang` is used to build parts of R, not `gcc`.


---

Comment by hsnyder created at 2014-12-31 09:15:35

`@`fbissey - 

/opt/local is where macports puts everything. But the sage build system tells me to move it aside, so that directory does not exist at all during the build. (I would love to not have to do that.)

/usr/local is for a few third party apps that want to be installed there outside of macports, including octave.

tcl is installed, but it's in macports under /opt/local so is invisible during the build

`@`jdemeyer - is the following relevant?
[in OS X 10.10]  'GCC' is no longer the real GNU gcc but is clang.
- http://stackoverflow.com/questions/27308323/osx-10-10-yosemite-clang-gcc-versions


---

Comment by fbissey created at 2014-12-31 09:17:32

Difficult to know

```
794	R is now configured for x86_64-apple-darwin14.0.0
795	
796	  Source directory:          .
797	  Installation directory:    /Users/uu1024/Git/sage/local
798	
799	  C compiler:                gcc -std=gnu99  -g -O2
800	  Fortran 77 compiler:       gfortran  -g -O2
801	
802	  C++ compiler:              g++  -g -O2
803	  C++ 11 compiler:           g++  -std=c++11 -g -O2
804	  Fortran 90/95 compiler:    gfortran -g -O2
805	  Obj-C compiler:            /usr/bin/cc -g -O2 -fobjc-exceptions
806	
807	  Interfaces supported:      aqua
808	  External libraries:        readline
809	  Additional capabilities:   NLS, ICU
810	  Options enabled:           shared R library, shared BLAS, R profiling
811	
812	  Capabilities skipped:      PNG, JPEG, TIFF, cairo
813	  Options not enabled:       memory profiling
814	
815	  Recommended packages:      yes
```

Of course gcc could be clang if PATH is misconfigured. But clang only explicitly appears in the log during the compilation of R packages after R is compiled.

gcc should be gnu because we always compile it on OS X so you have an install under $SAGE_LOCAL.


---

Comment by fbissey created at 2014-12-31 09:22:36

So you moved macport but you still have the PATH for it defined in your shell?


---

Comment by hsnyder created at 2014-12-31 23:50:55

`@`fbissey Right, all I do before checkout and make is sudo mv /opt/local /opt/local0. Extra gunk in PATH is generally harmless. I've been doing it this way for almost a year. Worked til a few weeks ago.

I've pruned PATH anyway and am rebuilding develop branch after make distclean to get a clean start. This takes about 6 hours on a 2.4 GHz Intel Core i5 with 8 GB of RAM. (I've tried parallel make in the past, but it always crashes during build of sage). I'll look into the r config & clang if the error is still there, which I expect.


---

Comment by fbissey created at 2015-01-01 00:22:26

Would you happen to have another, system wide, install of R? In any case could you find and post "Makeconf" in the R building hierarchy

```
find . -name Makeconf
```

from /Users/uu1024/Git/sage/local/var/tmp/sage/build/r-3.1.2.p0/src/ should help locate it if it exist.


---

Comment by jdemeyer created at 2015-01-01 11:53:47

> Difficult to know
> {{{
> 794	R is now configured for x86_64-apple-darwin14.0.0
> 795	
> 796	  Source directory:          .
> 797	  Installation directory:    /Users/uu1024/Git/sage/local
> 798	
> 799	  C compiler:                gcc -std=gnu99  -g -O2
> 800	  Fortran 77 compiler:       gfortran  -g -O2
> 801	
> 802	  C++ compiler:              g++  -g -O2
> 803	  C++ 11 compiler:           g++  -std=c++11 -g -O2
> 804	  Fortran 90/95 compiler:    gfortran -g -O2
> 805	  Obj-C compiler:            /usr/bin/cc -g -O2 -fobjc-exceptions
> 806	
> 807	  Interfaces supported:      aqua
> 808	  External libraries:        readline
> 809	  Additional capabilities:   NLS, ICU
> 810	  Options enabled:           shared R library, shared BLAS, R profiling
> 811	
> 812	  Capabilities skipped:      PNG, JPEG, TIFF, cairo
> 813	  Options not enabled:       memory profiling
> 814	
> 815	  Recommended packages:      yes
> }}}
> Of course gcc could be clang if PATH is misconfigured. But clang only explicitly appears in the log during the compilation of R packages after R is compiled.

Yes, that's strange, `clang` does not appear in the above list. I don't know where R suddenly gets this `clang` from.


---

Comment by jdemeyer created at 2015-01-01 11:55:08

Ideally, we should have the log file of a succesfull R build on a similar system and diff them.


---

Attachment

successful log


---

Comment by fbissey created at 2015-01-01 12:10:48

Replying to [comment:12 jdemeyer]:
> Ideally, we should have the log file of a succesfull R build on a similar system and diff them.

Your wish is granted.


---

Comment by jdemeyer created at 2015-01-01 14:02:22

The log at least shows that `clang` was _not_ used in the good build. The good build uses `gcc -std=gnu99` where the bad build used `clang`.

The only differences in the logs are support for `tex` and `Tcl/Tk`, different timezones and directories. There is nothing which could indicate how this happened or where the mysterious `clang` came from.


---

Comment by jdemeyer created at 2015-01-01 14:21:12

`@`hsnyder: the only possible explanation I see is your environment. What is the output of

```
./sage --sh -c env
```



---

Attachment

output of ./sage --sh -c env


---

Comment by hsnyder created at 2015-01-02 03:08:24

Output of ./sage --sh -c env attached. The only way I can see clang getting involved is with these two lines:

```
OBJC=/usr/bin/cc
OBJCXX=/usr/bin/c++
```


The rebuild after cleaning up PATH did not eliminate the error. I also moved renamed /usr/bin/R and /usr/bin/Rscript to XR and XRscript and still got the error.


---

Comment by fbissey created at 2015-01-02 03:17:49

Did you look for Makeconf? Also is RHOME defined? If it is renaming R and Rscript may not be enough as RHOME may point to a system installed Makeconf.


---

Comment by jdemeyer created at 2015-01-02 09:53:43

Sorry, I have no more ideas...

It must be something particular on your system though as this issue was never reported before.


---

Comment by hsnyder created at 2015-01-02 16:12:31

I looked for RHOME and R_HOME and didn't see any definitions under local/var/tmp/sage/build/r-3.1.2.p0 outside the sage build directory. The local R installation (including Makeconf) is under /Library/Frameworks/R.framework so I moved that aside and rebuilt and got same error.

Clang first shows up in R build console output during the build of r-3.1.2.p0/src/src/library/Recommended. I'll look there a bit.

Is there a way to turn off the build of R completely? There is already a functioning R on the system.


---

Comment by fbissey created at 2015-01-02 19:19:50

Replying to [comment:20 hsnyder]:
> Is there a way to turn off the build of R completely? There is already a functioning R on the system.

No. On most platforms it doesn't make sense and it would be difficult because sage includes rpy. Using system wide R leads to a library jungle between the system and sage that is probably unhealthy.

Did you find a Makeconf for the R that sage is building?


---

Comment by hsnyder created at 2015-01-20 01:43:53

./sage/local/var/tmp/sage/build/r-3.1.2.p0/src/Makeconf


---

Attachment

I attached ./sage/local/var/tmp/sage/build/r-3.1.2.p0/src/Makeconf from the OS X 10.10.1 Xcode 6.1.1 build. It shows ```CC = gcc -std=gnu99```. 

Based on a similar-looking problem reported by homebrew project at https://github.com/Homebrew/homebrew-science/issues/1304 I also tried reverting to Xcode 6.0 and matching command line tools. This was only possible with OS X 10.9.5 because there's no matching set of command line tools for OS X 10.10. Build of the sage R package still fails.

I also tried patching src/configure for the R package to turn off aqua in the build, because of a workaround reported at https://github.com/twelve17/homebrew-science/commit/fced84b20f2854741b7c41d0a1e6a43d80fc677f . That would probably not be a desirable solution, because X11 is already turned off in the sage R package according to comments in spkg-install, but I was curious if the build would complete. It did not.


---

Comment by hsnyder created at 2015-05-23 13:00:24

I finally got a build of sage from source to complete on OS X 10.9.5, using a hint from this posting: https://support.enthought.com/hc/en-us/articles/204469410-OS-X-GCC-Clang-and-Cython-in-10-9-Mavericks. I checked out current sage source (version 6.7) from git://github.com/sagemath/sage.git, moved MacPorts /opt/local to /opt/local0 as usual, then ran make. After about 5 hours the make aborted on the usual error, 

ERROR: compilation failed for package 'mgcv'
...
Error installing package r-3.2.0.p0

I then did

export SAGE_KEEP_BUILT_SPKGS=yes
export CXXFLAGS="-mmacosx-version-min=10.6"
export LDFLAGS="-mmacosx-version-min=10.6"

and re-ran make. Make finished in 38 minutes and the resulting sage binary includes r-3.2.0.

I haven't tried a clean make from scratch, nor have I tested it on OS X 10.10.2 yet. The blog posting cited above also suggests compiler and linker flag of "-stdlib=libstdc++", but this was rejected by sage's gcc in both flags.


---

Comment by vbraun created at 2015-05-23 14:18:38

Clang only gets picked up when compiling R's own packages, which is done using R's own logic. You can trigger it by hand by unpacking the R tarball and running

```
$ sage -R CMD INSTALL R-3.2.0/src/library/Recommended/MASS.tgz 
* installing to library ‘/home/vbraun/Code/sage.git/local/lib/R/library’
* installing *source* package ‘MASS’ ...
** package ‘MASS’ successfully unpacked and MD5 sums checked
** libs
gcc -std=gnu99 -I/home/vbraun/Code/sage.git/local/lib/R//include -DNDEBUG      -fpic  -g -O2   -c MASS.c -o MASS.o
gcc -std=gnu99 -I/home/vbraun/Code/sage.git/local/lib/R//include -DNDEBUG      -fpic  -g -O2   -c lqs.c -o lqs.o
gcc -std=gnu99 -shared -L/home/vbraun/Code/sage.git/local/lib/R//lib -L/home/vbraun/Code/sage.git/local/lib/ -o MASS.so MASS.o lqs.o -L/home/vbraun/Code/sage.git/local/lib/R//lib -lR
installing to /home/vbraun/Code/sage.git/local/lib/R/library/MASS/libs
** R
** data
*** moving datasets to lazyload DB
** inst
** byte-compile and prepare package for lazy loading
** help
*** installing help indices
** building package indices
** testing if installed package can be loaded
* DONE (MASS)
}}} 
The CFLAGS/CXXFLAGS should be equivalent to 
{{{
$ MACOSX_DEPLOYMENT_TARGET=10.6 sage -R CMD INSTALL R-3.2.0/src/library/Recommended/MASS.tgz
}}}
maybe you can give this a try?


---

Comment by vbraun created at 2015-05-23 14:22:51

Also, make sure you don't override the compiler in `~/.R/Makevars`


---

Comment by hsnyder created at 2015-05-24 13:06:34

Thank you. Makevars might be the whole problem.

Both Macs have ~/.R/Makevars with
CC=clang
CXX=clang++
Timestamps are Oct 4 2014 on the OS X 10.9 system and Oct 1 2014 on the OS X 10.10 system, around the time I first noticed builds failing at the r package. I don't recall setting that file manually, but was trying several ways of building R at the time.

Simply removing ~/.R/Makevars might be all that is needed. I moved aside ~/.R/Makevars, the R package, and its install marker file, unset CXXFLAGS and LDFLAGS, and ran make at the top level of sage git repo. The build ran (starting with r) to completion. Will try a full build next. Those take 6-8 hours.

P.S.: I tried unpacking R and building MASS as you suggested. MASS built and seemed to install successfully, but the build used clang as a compiler, both before and after I moved aside ~/.R/Makevars


---

Comment by vbraun created at 2015-05-24 13:50:40

Can you try this branch (with `~/.R/Makevars` in place)?
----
New commits:


---

Comment by vbraun created at 2015-05-24 13:50:40

Changing status from new to needs_review.


---

Comment by jpswanson created at 2015-05-24 18:43:48

Changing status from needs_review to positive_review.


---

Comment by jpswanson created at 2015-05-24 18:43:48

Works for me, thanks Volker!


---

Comment by hsnyder created at 2015-05-25 01:42:56

Another + review. Commit ​bb5c9f3 builds successfully on OS X 10.10.1 with ~/.R/Makevars in place with contents:
CC=clang
CXX=clang++

Should the milestone for this ticket be changed from 6.5 to 6.8? What is that trac field used for?

Thank you.


---

Comment by vbraun created at 2015-05-25 07:29:55

Resolution: fixed


---

Comment by charpent created at 2015-06-12 20:28:49

bb5c9f3a2d9a6edcffe787716faa91fa5fd4aed6 breaks the installation of several R packages (among them "git2r", on which devtools depends).

Breakage reported as #18691
