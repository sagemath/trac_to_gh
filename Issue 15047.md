# Issue 15047: Memory leak in the interface with Gurobi

archive/issues_015047.json:
```json
{
    "body": "CC:  azi\n\nAs reported by Jernej, the `env` variable is allocated but not freed on `__dealloc___`. That's fixed here !\n\nNathann\n\nIssue created by migration from https://trac.sagemath.org/ticket/15284\n\n",
    "created_at": "2013-10-16T08:29:10Z",
    "labels": [
        "linear programming",
        "major",
        "bug"
    ],
    "title": "Memory leak in the interface with Gurobi",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15047",
    "user": "ncohen"
}
```
CC:  azi

As reported by Jernej, the `env` variable is allocated but not freed on `__dealloc___`. That's fixed here !

Nathann

Issue created by migration from https://trac.sagemath.org/ticket/15284





---

archive/issue_comments_192436.json:
```json
{
    "body": "New commits:",
    "created_at": "2013-10-16T08:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192436",
    "user": "ncohen"
}
```

New commits:



---

archive/issue_comments_192437.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-16T08:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192437",
    "user": "ncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_192438.json:
```json
{
    "body": "Hello!\n\nThe patch is good just a short question - why do we need to check if it is NULL?",
    "created_at": "2013-10-16T18:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192438",
    "user": "azi"
}
```

Hello!

The patch is good just a short question - why do we need to check if it is NULL?



---

archive/issue_comments_192439.json:
```json
{
    "body": "Ahahaha. Don't really know. Just used to checking that before freeing memory `:-)`\n\nThis being said, I just checled the doc and it explicitly says that `env` should only be freed after the model has been freed :\nhttp://www.gurobi.com/documentation/5.6/reference-manual/c_grbfreeenv\n\nAlso, there was some \"weird\" memory leak, which this patch now fixes : in order to define a model you need to define a \"master environment\", and the model creates a copy of the \"master environment\", and that copy is the one you should work on. However, if you delete the master environment segfault follows.\n\nSo. This patch creates a \"master environment\" variable to STORE the temporary environment that was never deallocated. Everything then is done on the real environment, and when everything is done both environment are deallocated. Without checks for NULL, as it has been checked before, when the environment were created.\n\nWeird behaviour, but branch updated ! `;-)`\n\nNathann\n\nP.S. : Oh, and I also replace `** model` by `* model`. Makes the code simpler `:-P`",
    "created_at": "2013-10-17T10:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192439",
    "user": "ncohen"
}
```

Ahahaha. Don't really know. Just used to checking that before freeing memory `:-)`

This being said, I just checled the doc and it explicitly says that `env` should only be freed after the model has been freed :
http://www.gurobi.com/documentation/5.6/reference-manual/c_grbfreeenv

Also, there was some "weird" memory leak, which this patch now fixes : in order to define a model you need to define a "master environment", and the model creates a copy of the "master environment", and that copy is the one you should work on. However, if you delete the master environment segfault follows.

So. This patch creates a "master environment" variable to STORE the temporary environment that was never deallocated. Everything then is done on the real environment, and when everything is done both environment are deallocated. Without checks for NULL, as it has been checked before, when the environment were created.

Weird behaviour, but branch updated ! `;-)`

Nathann

P.S. : Oh, and I also replace `** model` by `* model`. Makes the code simpler `:-P`



---

archive/issue_comments_192440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-10-17T10:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192440",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_192441.json:
```json
{
    "body": "The patch looks good to me!",
    "created_at": "2013-10-18T09:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192441",
    "user": "azi"
}
```

The patch looks good to me!



---

archive/issue_comments_192442.json:
```json
{
    "body": "The patch looks good to me!",
    "created_at": "2013-10-18T09:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192442",
    "user": "azi"
}
```

The patch looks good to me!



---

archive/issue_comments_192443.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-10-18T09:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192443",
    "user": "azi"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_192444.json:
```json
{
    "body": "Thaaaaaaaaaanks ! `;-)`\n\nNathann",
    "created_at": "2013-10-18T09:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192444",
    "user": "ncohen"
}
```

Thaaaaaaaaaanks ! `;-)`

Nathann



---

archive/issue_comments_192445.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-21T18:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15047#issuecomment-192445",
    "user": "vbraun"
}
```

Resolution: fixed
