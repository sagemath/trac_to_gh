# Issue 10515: multipying sparse matrices by integers in unnecceraly slow

Issue created by migration from Trac.

Original creator: mderickx

Original creation time: 2011-01-07 15:04:45

Assignee: jason, was

The below shows that a speedup of a factor 20 or more can be obtained in certain cases


```
sage: M=MatrixSpace(QQ,1240,3720,sparse=true)
sage: m=M.random_element(density=4/3720)
sage: time a=2*m
CPU times: user 8.17 s, sys: 0.02 s, total: 8.19 s
Wall time: 8.33 s
sage: time b=diagonal_matrix(QQ,1240,2,sparse=True)*m
CPU times: user 0.33 s, sys: 0.00 s, total: 0.33 s
Wall time: 0.34 s
sage: a==b
True
```






---

Comment by mderickx created at 2011-01-07 16:55:31

it can be even faster then the second suggestion. with still the same m as above:

sage: time for key in m._dict(): m._dict()[key]=2*(m._dict()[key])
CPU times: user 0.03 s, sys: 0.00 s, total: 0.04 s
Wall time: 0.04 s


---

Comment by mderickx created at 2011-01-07 17:02:24

With the patch applied I now get:


```
sage: M=MatrixSpace(QQ,1240,3720,sparse=true)
sage: m=M.random_element(density=4/3720)
sage: set_verbose(2)
sage: m._lmul_(2)
verbose 2 (_lmul_) scalar multiplying
verbose 2 (_lmul_) scalar multiplying finished (time = 0.033165)
1240 x 3720 sparse matrix over Rational Field (type 'print m.str()' to see all of the entries)
sage: time 2*m
CPU times: user 15.97 s, sys: 0.04 s, total: 16.01 s
Wall time: 16.36 s
1240 x 3720 sparse matrix over Rational Field
sage: time m*2
CPU times: user 15.93 s, sys: 0.04 s, total: 15.97 s
Wall time: 16.46 s
1240 x 3720 sparse matrix over Rational Field
```


So the newer and faster _lmul_ is there but for some reason it is not called.


---

Comment by mderickx created at 2011-01-07 17:28:45

And its not because 2 is an integer and not a rational since the following also doesn't work:


```
sage: M=MatrixSpace(QQ,1240,3720,sparse=true)
sage: m=M.random_element(density=4/3720) 
sage: set_verbose(2)
sage: QQ(2)*m
```



---

Attachment


---

Attachment


---

Comment by mderickx created at 2011-01-11 01:53:48

Changing status from new to needs_review.


---

Comment by mderickx created at 2011-01-11 01:53:48

Ok the problem was that I had to cpdef the _lmul_ operator. It's now dramatically faster as the following shows:

```
sage: M=MatrixSpace(QQ,1240,3720,sparse=true)
sage: m=M.random_element(density=4/3720) 
sage: set_verbose(2)
sage: time QQ(2)*m
CPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s
Wall time: 0.03 s
1240 x 3720 sparse matrix over Rational Field
```

The old code was multiplying sparse matrices as if they were still regular (dense) matrices, so no wonder it was terribly slow.


---

Comment by mderickx created at 2011-01-11 01:54:41

By the way, I fail with uploading files. Only apply:
10568-speedup-QQmatrix-lmul


---

Attachment


---

Comment by rbeezer created at 2011-02-07 21:49:53

Maarten,

Looks real good and is a good thing to get into Sage.  Seems like sparse matrices are often neglected.  I bet there is more like this to be done in other places.  I used just `10568-speedup-QQmatrix-lmul`, which I hope was the right file.  Some comments and suggestions follow.

Rob

  * I like the HUGE doctest.  ;-)

  * A doctest like the following might be a nice addition - it'd show a multiplier outside the base ring cooperating with the coercion model and doing the right thing.

    {{{
    sage: F = FiniteField(3)
    sage: two = F(2)
    sage: A = matrix(ZZ, 3, range(30), sparse=True)
    sage: B = two*A; B
    [0 2 1 0 2 1 0 2 1 0]
    [2 1 0 2 1 0 2 1 0 2]
    [1 0 2 1 0 2 1 0 2 1]
    sage: B.parent()
    Full MatrixSpace of 3 by 10 sparse matrices over Finite Field of size 3
    }}}

  * How about an `INPUT:` and `OUTPUT:` block in the docstring?  Even though these internal methods don't show in tab-completion, you can still view them in the notebook with formatting, so I think the consistent style is a good idea.

  * If you name your files as `*.patch` then Trac gives a very nice red-green/leaving-entering view and my local patch viewer (kompare) will do tab-completion on the filename.  ;-)

  * I'd imagine the release manager can clear out the two uploads you didn't want?


---

Comment by rbeezer created at 2011-02-07 21:49:53

Changing status from needs_review to needs_info.


---

Comment by mderickx created at 2011-02-08 11:02:11

Changing status from needs_info to needs_review.


---

Comment by mderickx created at 2011-02-08 11:02:11

Yeah, I thought the HUGE doctest was nice to :). It at least shows what is different about this function compared to the function it overwrites. And it makes sure that if someone accidentally replaces this function by something not sparse that the doctest would never complete :).

I don't think the doctest you suggest is a good addition in this particular place, from the reference manual http://www.sagemath.org/doc/reference/coercion.html:

```
If R is the base of S (as in the first example), simply implement
_rmul_ and/or _lmul_ on the Elements of S. In this case r * s gets
handled as s._rmul_(r) and s * r as s._lmul_(r). The argument to
_rmul_ and _lmul_ are guaranteed to be Elements of the base of S (with
coercion happening beforehand if necessary).
```

So the new code has noting to do with coercion. I really think that tests should be performed in the place where the relevant code is. Since there is no coercion happening in this low level _lmul_ function this should not be tested here.

Input and output block are added and now with .patch extension :


---

Comment by rbeezer created at 2011-02-08 18:22:28

Changing status from needs_review to positive_review.


---

Comment by rbeezer created at 2011-02-08 18:22:28

Maarten,

I like my doctests to mash up as much of Sage as possible, and show how different things work together.  But you have a good argument.  And as an underscore method it's not that critical, anyway.

Trac Tip: once somebody comments on a ticket, they get email for life on that one, so no need to add such a person to the cc.

Passes all tests.  Nice contribution!

Rob


---

Comment by jdemeyer created at 2011-03-08 10:40:45

The patch seems not to be a proper HG changeset.  Patches should be made using `hg export tip` (and not `hg diff`).


---

Comment by jdemeyer created at 2011-03-08 10:40:45

Changing status from positive_review to needs_work.


---

Comment by mderickx created at 2011-03-08 11:12:12

Sorry, jeroen. I thought uploading files from my .hg/patches/ was easier then having to create a patch again each time. But apparently the files are not stored there in a proper patch format. I uploaded a proper one now.


---

Comment by mderickx created at 2011-03-08 11:12:29

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2011-03-08 11:24:22

Replying to [comment:12 mderickx]:
> Sorry, jeroen. I thought uploading files from my .hg/patches/ was easier then having to create a patch again each time. But apparently the files are not stored there in a proper patch format. I uploaded a proper one now.

I think you did something wrong, because the "new" file is exactly the same as the old.


---

Comment by jdemeyer created at 2011-03-08 11:24:22

Changing status from positive_review to needs_work.


---

Comment by mderickx created at 2011-03-08 11:32:11

Use this one, the others are old version


---

Comment by mderickx created at 2011-03-08 11:33:34

Changing status from needs_work to positive_review.


---

Attachment

I must be the worst person ever with uploading patches. So here is the right one finally I hope.


---

Comment by jdemeyer created at 2011-03-08 21:46:10

Resolution: fixed
