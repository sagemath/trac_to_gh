# Issue 32839: PDF doc build is broken

Issue created by migration from https://trac.sagemath.org/ticket/33076

Original creator: vbraun

Original creation time: 2021-12-24 13:32:56

Apparently works for incremental builds, but not for clean ones:

```
LaTeX Warning: File `{../../../../../local/share/doc/sage/doctrees/en/reference
/plot_directive/sage/manifolds/subset-1}.pdf' not found on input line 4281.


! Package pdftex.def Error: File `../../../../../local/share/doc/sage/doctrees/
en/reference/plot_directive/sage/manifolds/subset-1.pdf' not found: using draft
 setting.

See the pdftex.def package documentation for explanation.
Type  H <return>  for immediate help.
 ...                                              
                                                  
l.4281 ..._directive/sage/manifolds/subset-1}.pdf}
                                                  
? 
! Emergency stop.
 ...                                              
                                                  
l.4281 ..._directive/sage/manifolds/subset-1}.pdf}
                                                  
!  ==> Fatal error occurred, no output PDF file produced!
```



---

Comment by strogdon created at 2021-12-24 18:58:00


```
make doc-clean
make doc-pdf
```

works here. I have not tried from the tarball. Perhaps parallel make - related? If so, let's hope #32928 is not the culprit.


---

Comment by strogdon created at 2021-12-24 20:06:31


```
make distclean
make doc-pdf
```

also works for me.

```
$ tail logs/pkgs/sagemath_doc_pdf-none.log 

PDF documents have been created in subdirectories of

  /local/sage-git/sage/local/share/doc/sage/pdf/en/reference

Alternatively, you can open

  /local/sage-git/sage/local/share/doc/sage/pdf/en/reference/index.html

for a webpage listing all of the documents.
```



---

Comment by fbissey created at 2021-12-24 20:08:10

Replying to [comment:1 strogdon]:
> {{{
> make doc-clean
> make doc-pdf
> }}}
> works here. I have not tried from the tarball. Perhaps parallel make - related? If so, let's hope #32928 is not the culprit.

I only have trouble with parallel make of the documentation if I do `make doc-html doc-pdf` in one go. Then yes, there are parallel make issue that are uncovered once it is enabled by #32298. :(


---

Comment by mkoeppe created at 2021-12-24 21:14:22

Best to test on top of #32759, which makes changes to the build system for doc


---

Comment by dimpase created at 2021-12-31 09:45:46

I'm testing  #32759 as the fix for this ticket now.


---

Comment by dimpase created at 2021-12-31 10:30:49

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-12-31 10:32:10

Fixed by  #32759. Something like `make -j12 doc-pdf` produces what's expected.


---

Comment by dimpase created at 2021-12-31 10:32:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-01-02 00:53:12

Not fixed by #32759


---

Comment by vbraun created at 2022-01-02 01:47:24

Changing status from positive_review to needs_work.


---

Comment by strogdon created at 2022-01-02 02:16:28

Replying to [comment:9 vbraun]:
> Not fixed by #32759

Perhaps you could indicate exactly what you do to get building the PDF docs to fail.


---

Comment by mkoeppe created at 2022-01-02 02:17:35

Changing status from needs_work to needs_info.


---

Comment by strogdon created at 2022-01-02 02:18:05

I see you did indicate this on #32759


---

Comment by strogdon created at 2022-01-02 03:37:10

Without #32759 and with

```
$ echo $MAKE
make -j9
```

then

```
$ git clean -f -d -x
$ ./configure
$ make doc-pdf
```

completely builds sage, html-docs and pdf-docs.


---

Comment by strogdon created at 2022-01-02 03:46:45

`@`vbraun

I noticed from #32759#comment:124 that you have

```
[sagemath_doc_pdf-none] LaTeX2e <2020-10-01> patch level 4
[sagemath_doc_pdf-none] L3 programming layer <2021-05-07>
```

while I have

```
LaTeX2e <2020-10-01> patch level 4
L3 programming layer <2021-02-18>
```

Is this of significance?


---

Comment by dimpase created at 2022-01-02 09:12:26

I've tested with #32759 and

```
LaTeX2e <2020-10-01> patch level 4
L3 programming layer <2021-01-09>
```

(standard Debian 11)
and

```
LaTeX2e <2020-02-02> patch level 5
L3 programming layer <2020-04-06>
```

(standard Fedora 34).

I'll re-test the latter after full `git clean -fdx` and report.


---

Comment by vbraun created at 2022-01-02 11:59:22

The missing `../../..` is apparently already wrong in the doctree file:

```
[release@zen Sage]$ strings ./local/share/doc/sage/doctrees/en/reference/combinat/sage/combinat/crystals/mv_polytopes.doctree | grep mv_polytopes-1
.. figure:: ../../../../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.svg
r../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.svg
.. figure:: ../../../../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.*
p../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.*
r../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.svg
r../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.pdf
r../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.png
```

The docstring with the originial `figure:` has 8, but the actual images only 5 ".."s


---

Comment by vbraun created at 2022-01-02 13:29:57

I've been building it a couple of times now and sometimes the (incorrect) relative path ends up in the tex file, and sometimes there is only the filename like:

```
\noindent\sphinxincludegraphics[width=300\sphinxpxdimen]{{mv_polytopes-1}.pdf}
```

The latter works, the former does not.


---

Comment by strogdon created at 2022-01-03 02:27:03

There are numerous places where there `seem` to be missing `".."`s. For example

```
$ strings ./local/share/doc/sage/doctrees/en/reference/manifolds/sage/manifolds/subset.doctree | grep subset-1
v.. figure:: ../../../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.svg
d../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.svg
t.. figure:: ../../../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.*
b../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.*
d../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.png
d../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.pdf
d../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/manifolds/subset-1.svg
```

However, on my system when I search for `sphinxincludegraphics` in the TeX files there are no `".."`s anywhere that pdfs are included, i.e.

```
$ grep sphinxincludegraphics ./local/share/doc/sage/latex/en/reference/manifolds/manifolds.tex | grep subset-1
\noindent\sphinxincludegraphics{{subset-1}.pdf}
```



---

Comment by dimpase created at 2022-01-03 12:06:43

Replying to [comment:16 dimpase]:
> I've tested with #32759 and
> {{{
> LaTeX2e <2020-10-01> patch level 4
> L3 programming layer <2021-01-09>
> }}}
> (standard Debian 11)
> and
> {{{
> LaTeX2e <2020-02-02> patch level 5
> L3 programming layer <2020-04-06>
> }}}
> (standard Fedora 34).
> 
> I'll re-test the latter after full `git clean -fdx` and report. 
> 
the build got stuck just before scipy for no apparent reason. Just hanging. Killed and restarted without cleaning, completed fine.


---

Comment by mkoeppe created at 2022-01-12 17:27:39

Is this failure still showing up?


---

Comment by vbraun created at 2022-01-12 17:37:42

I haven't seen it in the last week, possibly random


---

Comment by vbraun created at 2022-01-12 17:37:42

Changing priority from blocker to major.


---

Comment by slelievre created at 2022-01-30 15:44:20

Set milestone to sage-9.6 after Sage 9.5 release.


---

Comment by mkoeppe created at 2022-04-23 01:05:37

Changing status from needs_info to needs_review.


---

Comment by klee created at 2022-04-26 06:39:06

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-04-26 06:39:06

No problem now.


---

Comment by mkoeppe created at 2022-05-11 02:14:43

Resolution: invalid
