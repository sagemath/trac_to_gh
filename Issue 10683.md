# Issue 10683: Refactor matrix kernel routines

archive/issues_010683.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  jason spancratz stumpc5\n\nThis patch reorganizes the matrix kernel code with as little change in behavior as possible.\n\nOverview:\n\nRaw computations and results are now separated from subsequent conversions, format choices and conveniences.\n\nEach subclass has a new (or modified) private `_right_kernel_matrix()` method, and the top-level code has several new private helper functions that have names starting with `_right_kernel_matrix`.  These take no input options, and return a string identifying the nature of their results, and a matrix whose rows are a basis for the right kernel.  These methods are meant to impose as little overhead as possible on top of the necessary computations.\n\nThe new `right_kernel_matrix` method manages which algorithms are used and if the basis is converted, such as being echelonized.  This introduces the \"pivot\" format which is a natural way to express basis vectors for a kernel obtained from the echelon form of a matrix.  Several algorithms currently in use return results in this format, or something very close.  This is the original motivation for this work.\n\nKernels, right or left, then build vector spaces with the rows of the right kernel matrix.\n\n\nImprovements:\n\n* Caching of kernels and immutbility of the matrix happens in exactly two places, once for left and once for right, ensuring consistency.\n\n* Trivial cases (zero dimension, or full dimension) are handled in one place, again ensuring consistency.\n\n* Adding new algorithms, or specialized behavior for new subclasses, should be easier.\n\n* The logic of how various cases are handled should be more obvious.\n\n* Several bugs have been corrected due to these changes.\n\n* The `right_kernel_matrix()` method allows great flexibility for those who want easy access to a \"raw\" kernel, either unadorned, or massaged into one of several formats.\n\n* Warnings via the `verbose()` system have been added to make it easy to verify the flow of the computations, and these are doctested.\n\n\nChanges in behavior:\n\n* For a matrix whose kernel is an entire vector space (ie the ambient vector space), the kernels are returned as such.  Previously, they were often built as submodules that were just as big as the whole space.  So this is the reason for many of the docstring changes.\n\n* `_right_kernel_matrix` for integer matrices was used just once outside of the matrix code.  It now behaves differently, but can be replaced by the public `right_kernel_matrix()` which behaves almost identically.  The exception is that a conversion to an LLL basis is accomplished with a different keyword.\n\n* Documentation infers that keywords can be passed to the echelon form code.  This was not working properly since extra keywords, or keywords with the same name (eg `algorithm`), followed logic that was not as described in the documentation.  This should be easy to add properly on a subsequent ticket as this new code was written with this in mind.  See comments in the source.\n\n* Actual code for the computations is largely unmodified from before.  The very few changes needed outside of the `sage/matrix` directory is a reflection of this.  These changes are all contained in the \"external\" patch.\n\nDepends #10714\n\nIssue created by migration from https://trac.sagemath.org/ticket/10746\n\n",
    "created_at": "2011-02-05T21:12:44Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "title": "Refactor matrix kernel routines",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10683",
    "user": "rbeezer"
}
```
Assignee: jason, was

CC:  jason spancratz stumpc5

This patch reorganizes the matrix kernel code with as little change in behavior as possible.

Overview:

Raw computations and results are now separated from subsequent conversions, format choices and conveniences.

Each subclass has a new (or modified) private `_right_kernel_matrix()` method, and the top-level code has several new private helper functions that have names starting with `_right_kernel_matrix`.  These take no input options, and return a string identifying the nature of their results, and a matrix whose rows are a basis for the right kernel.  These methods are meant to impose as little overhead as possible on top of the necessary computations.

The new `right_kernel_matrix` method manages which algorithms are used and if the basis is converted, such as being echelonized.  This introduces the "pivot" format which is a natural way to express basis vectors for a kernel obtained from the echelon form of a matrix.  Several algorithms currently in use return results in this format, or something very close.  This is the original motivation for this work.

Kernels, right or left, then build vector spaces with the rows of the right kernel matrix.


Improvements:

* Caching of kernels and immutbility of the matrix happens in exactly two places, once for left and once for right, ensuring consistency.

* Trivial cases (zero dimension, or full dimension) are handled in one place, again ensuring consistency.

* Adding new algorithms, or specialized behavior for new subclasses, should be easier.

* The logic of how various cases are handled should be more obvious.

* Several bugs have been corrected due to these changes.

* The `right_kernel_matrix()` method allows great flexibility for those who want easy access to a "raw" kernel, either unadorned, or massaged into one of several formats.

* Warnings via the `verbose()` system have been added to make it easy to verify the flow of the computations, and these are doctested.


Changes in behavior:

* For a matrix whose kernel is an entire vector space (ie the ambient vector space), the kernels are returned as such.  Previously, they were often built as submodules that were just as big as the whole space.  So this is the reason for many of the docstring changes.

* `_right_kernel_matrix` for integer matrices was used just once outside of the matrix code.  It now behaves differently, but can be replaced by the public `right_kernel_matrix()` which behaves almost identically.  The exception is that a conversion to an LLL basis is accomplished with a different keyword.

* Documentation infers that keywords can be passed to the echelon form code.  This was not working properly since extra keywords, or keywords with the same name (eg `algorithm`), followed logic that was not as described in the documentation.  This should be easy to add properly on a subsequent ticket as this new code was written with this in mind.  See comments in the source.

* Actual code for the computations is largely unmodified from before.  The very few changes needed outside of the `sage/matrix` directory is a reflection of this.  These changes are all contained in the "external" patch.

Depends #10714

Issue created by migration from https://trac.sagemath.org/ticket/10746





---

archive/issue_comments_112299.json:
```json
{
    "body": "Attachment\n\nChanges within sage/matrix",
    "created_at": "2011-02-05T21:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112299",
    "user": "rbeezer"
}
```

Attachment

Changes within sage/matrix



---

archive/issue_comments_112300.json:
```json
{
    "body": "Changes outside sage/matrix",
    "created_at": "2011-02-05T21:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112300",
    "user": "rbeezer"
}
```

Changes outside sage/matrix



---

archive/issue_comments_112301.json:
```json
{
    "body": "Attachment\n\nA failing doc-test needs attention before this can proceed.  More details posted on sage-devel at\n\nhttp://groups.google.com/group/sage-devel/browse_thread/thread/64b227bc9067b012\n\n\n```\nsage -t  \"devel/sage/sage/modular/hecke/module.py\"\n**********************************************************************\nFile \"/sage/dev/devel/sage/sage/modular/hecke/module.py\", line 1560:\n    sage: [A.system_of_eigenvalues(3) for A in S.decomposition()]\nExpected:\n    [[1, 1, 0], [1, -1, -alpha - 1]]\nGot:\n    [[1, 1, 0], [1, -1, -1/2*alpha - 1/2]]\n**********************************************************************\n```\n",
    "created_at": "2011-02-05T22:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112301",
    "user": "rbeezer"
}
```

Attachment

A failing doc-test needs attention before this can proceed.  More details posted on sage-devel at

http://groups.google.com/group/sage-devel/browse_thread/thread/64b227bc9067b012


```
sage -t  "devel/sage/sage/modular/hecke/module.py"
**********************************************************************
File "/sage/dev/devel/sage/sage/modular/hecke/module.py", line 1560:
    sage: [A.system_of_eigenvalues(3) for A in S.decomposition()]
Expected:
    [[1, 1, 0], [1, -1, -alpha - 1]]
Got:
    [[1, 1, 0], [1, -1, -1/2*alpha - 1/2]]
**********************************************************************
```




---

archive/issue_comments_112302.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2011-02-05T22:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112302",
    "user": "rbeezer"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_112303.json:
```json
{
    "body": "Replaces previous \"external\" patch,  still apply this second",
    "created_at": "2011-02-07T19:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112303",
    "user": "rbeezer"
}
```

Replaces previous "external" patch,  still apply this second



---

archive/issue_comments_112304.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-02-07T19:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112304",
    "user": "rbeezer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_112305.json:
```json
{
    "body": "Attachment\n\n#10714 now has a positive review (thanks, Jason) and the failing doctest has been updated based on advice in the sage-devel thread referenced above.  So this is ready to go now, built on 4.6.2.alpha3, and I'll try to keep it updated.",
    "created_at": "2011-02-07T19:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112305",
    "user": "rbeezer"
}
```

Attachment

#10714 now has a positive review (thanks, Jason) and the failing doctest has been updated based on advice in the sage-devel thread referenced above.  So this is ready to go now, built on 4.6.2.alpha3, and I'll try to keep it updated.



---

archive/issue_comments_112306.json:
```json
{
    "body": "Attachment\n\nRebased for 4.6.2.alpha4, apply first",
    "created_at": "2011-02-08T03:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112306",
    "user": "rbeezer"
}
```

Attachment

Rebased for 4.6.2.alpha4, apply first



---

archive/issue_comments_112307.json:
```json
{
    "body": "Rebased the larger patch for 4.6.2.alpha4, the external patch didn't need it.  I had the immutability of the *input* versus the immutability of the *output* a bit confused in a couple places, but that is fixed now as well.  Use both v2 patches, \"external\" is second.",
    "created_at": "2011-02-08T03:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112307",
    "user": "rbeezer"
}
```

Rebased the larger patch for 4.6.2.alpha4, the external patch didn't need it.  I had the immutability of the *input* versus the immutability of the *output* a bit confused in a couple places, but that is fixed now as well.  Use both v2 patches, "external" is second.



---

archive/issue_comments_112308.json:
```json
{
    "body": "Attachment\n\nApply first, then follow with external patch",
    "created_at": "2011-02-15T23:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112308",
    "user": "rbeezer"
}
```

Attachment

Apply first, then follow with external patch



---

archive/issue_comments_112309.json:
```json
{
    "body": "Some editing in response to suggetions (via email) by Sebastian Pancratz creates the \"v3\" patch for the main changes to the `sage/matrix` code.  Passes long tests.\n\n\n* Remove unreachable code containing exception for unhandled right kernel basis format\n\n* Clarified documentation about full-rank kernels being buildable for any ring with a one.\n\n* Docstring text, code comments wrapped at column 79\n\n* Docstring text pared down wherever possible\n\n* Left kernel documentation is reduced, relying on the right kernel documentation - but still tests `kernel` and `left_kernel` as aliases, an echelon basis versus a user basis, corner (trivial) cases and caching (which differs substantially for left versus right).",
    "created_at": "2011-02-16T00:05:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112309",
    "user": "rbeezer"
}
```

Some editing in response to suggetions (via email) by Sebastian Pancratz creates the "v3" patch for the main changes to the `sage/matrix` code.  Passes long tests.


* Remove unreachable code containing exception for unhandled right kernel basis format

* Clarified documentation about full-rank kernels being buildable for any ring with a one.

* Docstring text, code comments wrapped at column 79

* Docstring text pared down wherever possible

* Left kernel documentation is reduced, relying on the right kernel documentation - but still tests `kernel` and `left_kernel` as aliases, an echelon basis versus a user basis, corner (trivial) cases and caching (which differs substantially for left versus right).



---

archive/issue_comments_112310.json:
```json
{
    "body": "Latest patches apply, build and test (sage/matrix) fine on 4.7.alpha1.",
    "created_at": "2011-03-20T05:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112310",
    "user": "rbeezer"
}
```

Latest patches apply, build and test (sage/matrix) fine on 4.7.alpha1.



---

archive/issue_comments_112311.json:
```json
{
    "body": "I am willing to work through this, and at first glance the changes look good.\n\nThere is one major issue: A kernel IS a subspace. Always. Even if it can be canonically identified with the whole space.\n\nI wouldn't let this pass for a minor release like 4.7.1. Rather, since the behavior changes, we should wait for 4.8 or 5.0, until we merge this.",
    "created_at": "2011-03-25T04:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112311",
    "user": "mraum"
}
```

I am willing to work through this, and at first glance the changes look good.

There is one major issue: A kernel IS a subspace. Always. Even if it can be canonically identified with the whole space.

I wouldn't let this pass for a minor release like 4.7.1. Rather, since the behavior changes, we should wait for 4.8 or 5.0, until we merge this.



---

archive/issue_comments_112312.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-03-25T04:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112312",
    "user": "mraum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_112313.json:
```json
{
    "body": "Apply only this",
    "created_at": "2011-04-27T06:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112313",
    "user": "rbeezer"
}
```

Apply only this



---

archive/issue_comments_112314.json:
```json
{
    "body": "Attachment\n\nMartin has suggested that even if a kernel is equal to the ambient space, it should be built and reported as a subspace of the ambient space.  I have made that change (in the right_kernel() routine) by removing the logic that recognized when the right kernel matrix is an identity matrix.\n\nThis had the pleasant side-effect that fewer changes are needed elsewhere.  So now there are exactly two changes outside the matrix code - a replacement of the private `_right_kernel_matrix()` by the public `right_kernel_matrix()` in the quaternion algebra code, and a documentation change.\n\nSo there is no longer a separate patch containing changes external to the sage/matrix code.  *Everything* is now in the v4 patch.  This passes long tests on 4.7.rc0.\n\nApply: trac_10746-matrix-kernel-refactor-v4.patch",
    "created_at": "2011-04-27T06:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112314",
    "user": "rbeezer"
}
```

Attachment

Martin has suggested that even if a kernel is equal to the ambient space, it should be built and reported as a subspace of the ambient space.  I have made that change (in the right_kernel() routine) by removing the logic that recognized when the right kernel matrix is an identity matrix.

This had the pleasant side-effect that fewer changes are needed elsewhere.  So now there are exactly two changes outside the matrix code - a replacement of the private `_right_kernel_matrix()` by the public `right_kernel_matrix()` in the quaternion algebra code, and a documentation change.

So there is no longer a separate patch containing changes external to the sage/matrix code.  *Everything* is now in the v4 patch.  This passes long tests on 4.7.rc0.

Apply: trac_10746-matrix-kernel-refactor-v4.patch



---

archive/issue_comments_112315.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-27T06:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112315",
    "user": "rbeezer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_112316.json:
```json
{
    "body": "The patch looks very well organized and extensively documented.\n\nAs the latest version does not contain many changes outside of the matrix code, I think it is okay to put this patch into 4.7, and not to wait for 4.8 or even version 5.\n\nI leave it as needs review, as maybe someone working more with linear algebra / matrices should have a look as well.\n\nOne doctest failed in 4.6.2, but I guess this doesn't happen anymore in 4.7.rc0, see the attached patch.\n\nChristian",
    "created_at": "2011-05-05T19:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112316",
    "user": "stumpc5"
}
```

The patch looks very well organized and extensively documented.

As the latest version does not contain many changes outside of the matrix code, I think it is okay to put this patch into 4.7, and not to wait for 4.8 or even version 5.

I leave it as needs review, as maybe someone working more with linear algebra / matrices should have a look as well.

One doctest failed in 4.6.2, but I guess this doesn't happen anymore in 4.7.rc0, see the attached patch.

Christian



---

archive/issue_comments_112317.json:
```json
{
    "body": "Attachment\n\nReplying to [comment:10 stumpc5]:\n> One doctest failed in 4.6.2, but I guess this doesn't happen anymore in 4.7.rc0, see the attached patch.\n\nThanks, Christian.  Indeed, the pivots have switched to tuples instead of lists at #10752, so that failure would be expected on 4.6.2.  So the [attachment:trac_10746-review-cs.patch] patch should *not* be applied.\n\nThanks again.",
    "created_at": "2011-05-05T19:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112317",
    "user": "rbeezer"
}
```

Attachment

Replying to [comment:10 stumpc5]:
> One doctest failed in 4.6.2, but I guess this doesn't happen anymore in 4.7.rc0, see the attached patch.

Thanks, Christian.  Indeed, the pivots have switched to tuples instead of lists at #10752, so that failure would be expected on 4.6.2.  So the [attachment:trac_10746-review-cs.patch] patch should *not* be applied.

Thanks again.



---

archive/issue_comments_112318.json:
```json
{
    "body": "The patch definitely deserve a positive review, even at a second glance -- the organization of the matrix kernel code is much cleaner now, and the documentation and the examples are very helpful!\n\nBest, Christian",
    "created_at": "2011-05-24T10:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112318",
    "user": "stumpc5"
}
```

The patch definitely deserve a positive review, even at a second glance -- the organization of the matrix kernel code is much cleaner now, and the documentation and the examples are very helpful!

Best, Christian



---

archive/issue_comments_112319.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-05-24T10:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112319",
    "user": "stumpc5"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_112320.json:
```json
{
    "body": "Replying to [comment:12 stumpc5]:\n\nThanks, Christian.  Good luck with the upcoming new arrival!\n\nRob",
    "created_at": "2011-05-24T17:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112320",
    "user": "rbeezer"
}
```

Replying to [comment:12 stumpc5]:

Thanks, Christian.  Good luck with the upcoming new arrival!

Rob



---

archive/issue_comments_112321.json:
```json
{
    "body": "I have built this patch against 4.7.rc3, and tested it against a subset of the Sage library with no problems, so it should be ready to go.",
    "created_at": "2011-05-24T17:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112321",
    "user": "rbeezer"
}
```

I have built this patch against 4.7.rc3, and tested it against a subset of the Sage library with no problems, so it should be ready to go.



---

archive/issue_comments_112322.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2011-05-25T12:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112322",
    "user": "jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_112323.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-05-30T14:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10683",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10683#issuecomment-112323",
    "user": "jdemeyer"
}
```

Resolution: fixed
