# Issue 12233: Add $SAGE_LOCAL/lib64 to LD_LIBRARY_PATH

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-01-31 22:39:16

Assignee: leif

This is needed for #12369 (and would probably have provided an easier fix for #12131).


---

Comment by vbraun created at 2012-01-31 23:12:57

`lib64` is widely used but no standard. `lib32` isn't standard at all, as far as I know only debian variants use it. And they are moving towards multiarch, which will rename these to `lib/i386-linux-gnu` etc., see  http://wiki.debian.org/Multiarch. So unless you want to add all possible triplets to the `LD_LIBRARY_PATH` I suggest we rather the gcc package to respect standard configure options.

-1 from me for this proposal.


---

Comment by jdemeyer created at 2012-01-31 23:19:23

Replying to [comment:3 vbraun]:
*If* we decide to ship a gcc package *and* this patch works *and* nobody comes up with a better solution, I guess we have no choice, right?


---

Comment by jdemeyer created at 2012-01-31 23:27:09

If you prefer: we could only add _existing_ directories (or some unknown-to-me way of detecting the multilib directories)


---

Comment by vbraun created at 2012-01-31 23:33:35

I'll try fixing the gcc package first, this is really the sane way to do. At the very least we need to disable multilib building because not everybody has a multilib toolchain (Fedora doesn't, for example).


---

Comment by jdemeyer created at 2012-02-10 12:45:25

Replying to [comment:6 vbraun]:
> I'll try fixing the gcc package first, this is really the sane way to do. At the very least we need to disable multilib building because not everybody has a multilib toolchain (Fedora doesn't, for example).

Volker, in your GCC spkg, you copy files from `lib64` to `lib`.  This suffers from all the problems you mentioned here.  It has the additional problem that you need to decide _which_ files you copy.

So I still think changing `LD_LIBRARY_PATH` is the best solution.  But I'm certainly open to suggestions...


---

Comment by jhpalmieri created at 2012-03-02 18:07:17

I don't understand any of the subtleties here, but would it make sense to test whether the directory `$SAGE_ROOT/local/lib64` exists, and if so, put it first (before `local/lib`) in `$LD_LIBRARY_PATH`? If some spkg (like gcc) is the first one to install files in lib64, does `$LD_LIBRARY_PATH` need to include lib64 while that spkg is being installed, or will it only matter for later spkgs?  If only for later ones, well, sage-spkg should run sage-env for each installation, so `$LD_LIBRARY_PATH` should get set for all subsequent packages.


---

Comment by jdemeyer created at 2012-03-02 21:39:07

Replying to [comment:8 jhpalmieri]:
> I don't understand any of the subtleties here, but would it make sense to test whether the directory `$SAGE_ROOT/local/lib64` exists, and if so, put it first (before `local/lib`) in `$LD_LIBRARY_PATH`?
Yes, that would make a lot of sense.

> If some spkg (like gcc) is the first one to install files in lib64, does `$LD_LIBRARY_PATH` need to include lib64 while that spkg is being installed
No.

> or will it only matter for later spkgs?
Exactly, there might be some subtleties with parallel builds though.  But GCC (the package this is about) normally isn't built in parallel with anything else, so it doesn't really matter.


---

Comment by jhpalmieri created at 2012-03-02 22:00:38

Replying to [comment:9 jdemeyer]:
> Exactly, there might be some subtleties with parallel builds though. 

Even with parallel builds, if `deps` is correct, then if two packages are built at the same time, they shouldn't install things in `local/lib64` that the other one needs. There could be a race condition in creating `local/lib64`, I suppose, but that should be avoidable.


---

Comment by jdemeyer created at 2012-03-05 09:05:03

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-03-05 09:05:03

I changed the patch to add only existing directories.


---

Attachment


---

Comment by jhpalmieri created at 2012-03-05 21:27:42

This looks okay to me, but I don't think I'm qualified to review it. vbraun, what do you think?


---

Comment by vbraun created at 2012-03-05 21:33:30

I don't think adding more stuff to `LD_LIBRARY_PATH` is the way to go. On the contrary, we have to get rid of it or we'll always have library conflicts on some systems. Also, this ticket is really just our ignorance about how to make gcc install its libraries in a specified directory. It must be possible since distros can do it. 

Having said that, I don't mind if we use this as a bandaid until we figure out how to configure gcc correctly and/or Apple manages to ship a working compiler.


---

Comment by jdemeyer created at 2012-03-05 21:37:11

Replying to [comment:13 vbraun]:
> Having said that, I don't mind if we use this as a bandaid until we figure out how to configure gcc correctly.
Good.  As I mentioned above, I am certainly open to suggestions but this is the best "solution" I could think of.


---

Comment by jhpalmieri created at 2012-03-05 21:43:09

So can we give it a positive review? I've been using it successfully (via #12369) for a while now, with no problems.


---

Comment by vbraun created at 2012-03-05 22:53:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2012-03-05 22:53:49

Lets do it.


---

Comment by jdemeyer created at 2012-03-13 08:23:07

Resolution: fixed
