# Issue 29380: spkg-configure.m4 for ecl and maxima

archive/issues_029380.json:
```json
{
    "body": "CC:  mjo fbissey arojas @spaghettisalat @tobiasdiez isuruf mkoeppe mmarco jhpalmieri @jcuevas-rozo slelievre vbraun\n\nKeywords: spkg-configure; ECL; Maxima\n\nI tried to use ECL and Maxima from system packages as suggested by #27330, but without success for the moment.\n\nThe spkg-configure.m4 are trivial (see attachments), but the problems occur during build:\n\nIn [dochtml] [manifolds] this error is produced:\n\n\n```\n\tRuntimeError: ECL says: The function SET-LOCALE-SUBDIR is undefined\n```\n\n\nActually this error is reproducible out of the Sage's build mechanism:\n\n\n\n```\n$ ecl\n> (require 'maxima)\n> (in-package :maxima)\nMAXIMA> (set-locale-subdir)\nCondition of type: UNDEFINED-FUNCTION\nThe function MAXIMA::SET-LOCALE-SUBDIR is undefined.\n```\n\n\nAccording to Maxima's code, set-locale-subdir is defined in src/init-cl.lisp and:\n\n\n```\n\t     ;; If a file is declared as private-file it is loaded\n\t     ;; from the build tree (which makes an out-of-tree\n\t     ;; build possible), but not compiled (which means\n\t     ;; that with ECL or ABCL it won't end up in the final image)\n\t     ;; => no out-of-tree build for ECL.\n```\n\n\nMaybe someone with lisp-flu could patch it, if possible?\n\nIssue created by migration from https://trac.sagemath.org/ticket/29617\n\n",
    "created_at": "2020-04-29T15:37:15Z",
    "labels": [
        "build: configure",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "spkg-configure.m4 for ecl and maxima",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29380",
    "user": "@thierry-FreeBSD"
}
```
CC:  mjo fbissey arojas @spaghettisalat @tobiasdiez isuruf mkoeppe mmarco jhpalmieri @jcuevas-rozo slelievre vbraun

Keywords: spkg-configure; ECL; Maxima

I tried to use ECL and Maxima from system packages as suggested by #27330, but without success for the moment.

The spkg-configure.m4 are trivial (see attachments), but the problems occur during build:

In [dochtml] [manifolds] this error is produced:


```
	RuntimeError: ECL says: The function SET-LOCALE-SUBDIR is undefined
```


Actually this error is reproducible out of the Sage's build mechanism:



```
$ ecl
> (require 'maxima)
> (in-package :maxima)
MAXIMA> (set-locale-subdir)
Condition of type: UNDEFINED-FUNCTION
The function MAXIMA::SET-LOCALE-SUBDIR is undefined.
```


According to Maxima's code, set-locale-subdir is defined in src/init-cl.lisp and:


```
	     ;; If a file is declared as private-file it is loaded
	     ;; from the build tree (which makes an out-of-tree
	     ;; build possible), but not compiled (which means
	     ;; that with ECL or ABCL it won't end up in the final image)
	     ;; => no out-of-tree build for ECL.
```


Maybe someone with lisp-flu could patch it, if possible?

Issue created by migration from https://trac.sagemath.org/ticket/29617





---

archive/issue_comments_416650.json:
```json
{
    "body": "To be copied as build/pkgs/ecl/spkg-configure.m4",
    "created_at": "2020-04-29T15:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416650",
    "user": "@thierry-FreeBSD"
}
```

To be copied as build/pkgs/ecl/spkg-configure.m4



---

archive/issue_comments_416651.json:
```json
{
    "body": "Attachment [maxima_spkg-configure.m4](tarball://root/attachments/some-uuid/ticket29617/maxima_spkg-configure.m4) by @thierry-FreeBSD created at 2020-04-29 15:40:03\n\nTo be copied as build/pkgs/maxima/spkg-configure.m4",
    "created_at": "2020-04-29T15:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416651",
    "user": "@thierry-FreeBSD"
}
```

Attachment [maxima_spkg-configure.m4](tarball://root/attachments/some-uuid/ticket29617/maxima_spkg-configure.m4) by @thierry-FreeBSD created at 2020-04-29 15:40:03

To be copied as build/pkgs/maxima/spkg-configure.m4



---

archive/issue_comments_416652.json:
```json
{
    "body": "Note: I also tried to use only ECL from the system packages, and build maxima from Sage, but in this case Maxima fails\n\n- with the default ECLDIR in sage-env the cmp lisp files are not found:\n\n\n```\necl -norc -eval '(progn (load \"../lisp-utils/defsystem.lisp\") (load \"../lisp-utils/make-depends.lisp\") (funcall (intern \"CREATE-DEPENDENCY-FILE\" :mk) \"binary-ecl/maxima\" \"ecl-depends.mk\") (quit))'\n;;; Loading \"/usr/ports/math/sage/work/stage/usr/local/var/tmp/sage/build/maxima-5.42.2/src/src/../lisp-utils/defsystem.lisp\"\nAn error occurred during initialization:\nFilesystem error with pathname #P\"SYS:CMP.NEWEST\".\n```\n\n\n- when ECLDIR is patched to the right value, that works, but it fails when it tries to install the maxima library under this directory (unless you are root!).",
    "created_at": "2020-04-29T15:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416652",
    "user": "@thierry-FreeBSD"
}
```

Note: I also tried to use only ECL from the system packages, and build maxima from Sage, but in this case Maxima fails

- with the default ECLDIR in sage-env the cmp lisp files are not found:


```
ecl -norc -eval '(progn (load "../lisp-utils/defsystem.lisp") (load "../lisp-utils/make-depends.lisp") (funcall (intern "CREATE-DEPENDENCY-FILE" :mk) "binary-ecl/maxima" "ecl-depends.mk") (quit))'
;;; Loading "/usr/ports/math/sage/work/stage/usr/local/var/tmp/sage/build/maxima-5.42.2/src/src/../lisp-utils/defsystem.lisp"
An error occurred during initialization:
Filesystem error with pathname #P"SYS:CMP.NEWEST".
```


- when ECLDIR is patched to the right value, that works, but it fails when it tries to install the maxima library under this directory (unless you are root!).



---

archive/issue_comments_416653.json:
```json
{
    "body": "I would wait for #22191 before attempting this if I were you. We have a mountain of patches for ecl-16.1.2 that won't be present in any system copy, and ecl-16.1.3 is incompatible with sage (that's why we haven't upgraded to it after so many years). The latest v20.4.24 release is from just a few days ago, though, and with any luck it will work (unpatched) with sage and we can look for v20.4.24 on the system.",
    "created_at": "2020-04-29T16:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416653",
    "user": "mjo"
}
```

I would wait for #22191 before attempting this if I were you. We have a mountain of patches for ecl-16.1.2 that won't be present in any system copy, and ecl-16.1.3 is incompatible with sage (that's why we haven't upgraded to it after so many years). The latest v20.4.24 release is from just a few days ago, though, and with any luck it will work (unpatched) with sage and we can look for v20.4.24 on the system.



---

archive/issue_comments_416654.json:
```json
{
    "body": "OK, in FreeBSD the ECL system package is at 16.1.3!\n\nI did not know that it was incompatible with sage, maybe this is the source of the problem, thanks.",
    "created_at": "2020-04-29T16:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416654",
    "user": "@thierry-FreeBSD"
}
```

OK, in FreeBSD the ECL system package is at 16.1.3!

I did not know that it was incompatible with sage, maybe this is the source of the problem, thanks.



---

archive/issue_comments_416655.json:
```json
{
    "body": "Note: applying patches from build/pkgs/ecl/patches and build/pkgs/maxima/patches to the FreeBSD ports,  I have been able to use them as system packages. For ECL 16.1.3, the patches from #22191 are required.",
    "created_at": "2020-05-22T17:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416655",
    "user": "@thierry-FreeBSD"
}
```

Note: applying patches from build/pkgs/ecl/patches and build/pkgs/maxima/patches to the FreeBSD ports,  I have been able to use them as system packages. For ECL 16.1.3, the patches from #22191 are required.



---

archive/issue_comments_416656.json:
```json
{
    "body": "perhaps one can get FreeBSD's ECL bumped to v20.4.24 ? Well, we do ship a lot of patches for it in #22191 - but they are all upstream patches.",
    "created_at": "2020-07-31T12:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416656",
    "user": "dimpase"
}
```

perhaps one can get FreeBSD's ECL bumped to v20.4.24 ? Well, we do ship a lot of patches for it in #22191 - but they are all upstream patches.



---

archive/issue_comments_416657.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-09T10:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416657",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_416658.json:
```json
{
    "body": "It appears that perhaps Gentoo's `ecl` misses a number of important patches - in particular it can't build `maxima.fas` (some path mixup).",
    "created_at": "2020-09-09T23:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416658",
    "user": "dimpase"
}
```

It appears that perhaps Gentoo's `ecl` misses a number of important patches - in particular it can't build `maxima.fas` (some path mixup).



---

archive/issue_comments_416659.json:
```json
{
    "body": "I'm not an ecl maintainer, so we will probably have to wait for the next point release of ecl to address all of the bugs that sage fixes with patches. Afterwards the spkg-configure.m4 should check for a version newer than that patch release.\n\nIf we add this spkg-configure now, we're going to be in a position similar to the one we were in with pari a few months ago. The upstream release is unsuitable, so we need to test for all of the bugs fixed by the custom patches so that we don't accept a distro version that's missing them.",
    "created_at": "2020-09-09T23:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416659",
    "user": "mjo"
}
```

I'm not an ecl maintainer, so we will probably have to wait for the next point release of ecl to address all of the bugs that sage fixes with patches. Afterwards the spkg-configure.m4 should check for a version newer than that patch release.

If we add this spkg-configure now, we're going to be in a position similar to the one we were in with pari a few months ago. The upstream release is unsuitable, so we need to test for all of the bugs fixed by the custom patches so that we don't accept a distro version that's missing them.



---

archive/issue_comments_416660.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-08T17:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416660",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416661.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-08T17:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416661",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416662.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-08T17:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416662",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416663.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-08T18:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416663",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416664.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-08T18:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416664",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416665.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-09T21:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416665",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416666.json:
```json
{
    "body": "I've narrowed the ticket to ECL. Dealing with a system maxima can be done on a follow-up ticket.\n\nFollowing up on the discussion in #30770, when using a (sufficiently patched) system ECL, our maxima install script should not attempt to install the FASL in the (typically read only) ECL system directory but rather set the configuration variable `MAXIMA_FAS` to the correct path.",
    "created_at": "2021-01-19T21:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416666",
    "user": "mkoeppe"
}
```

I've narrowed the ticket to ECL. Dealing with a system maxima can be done on a follow-up ticket.

Following up on the discussion in #30770, when using a (sufficiently patched) system ECL, our maxima install script should not attempt to install the FASL in the (typically read only) ECL system directory but rather set the configuration variable `MAXIMA_FAS` to the correct path.



---

archive/issue_comments_416667.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-19T21:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416667",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416668.json:
```json
{
    "body": "How can we detect a sufficiently patched ECL, as is presumably shipped by conda, arch, gentoo, ...?",
    "created_at": "2021-01-19T21:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416668",
    "user": "mkoeppe"
}
```

How can we detect a sufficiently patched ECL, as is presumably shipped by conda, arch, gentoo, ...?



---

archive/issue_comments_416669.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-19T21:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416669",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416670.json:
```json
{
    "body": "Now that #31336 is in, I don't think we need to detect anything other than the ECL version. If they stick to the new versioning scheme, then the following constant (defined in `/usr/include/ecl/config.h`, here) can probably be checked with a simple integer comparison:\n\n\n```\n#define ECL_VERSION_NUMBER 210201\n```\n",
    "created_at": "2021-03-16T16:05:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416670",
    "user": "mjo"
}
```

Now that #31336 is in, I don't think we need to detect anything other than the ECL version. If they stick to the new versioning scheme, then the following constant (defined in `/usr/include/ecl/config.h`, here) can probably be checked with a simple integer comparison:


```
#define ECL_VERSION_NUMBER 210201
```




---

archive/issue_comments_416671.json:
```json
{
    "body": "+1",
    "created_at": "2021-03-16T17:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416671",
    "user": "mkoeppe"
}
```

+1



---

archive/issue_comments_416672.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-16T19:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416672",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_416673.json:
```json
{
    "body": "This rejects ecl-16.1.3 and accepts ecl-21.2.1 on Gentoo. I'm still waiting on the build to finish to see if it works, though.\n----\nNew commits:",
    "created_at": "2021-03-16T19:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416673",
    "user": "mjo"
}
```

This rejects ecl-16.1.3 and accepts ecl-21.2.1 on Gentoo. I'm still waiting on the build to finish to see if it works, though.
----
New commits:



---

archive/issue_comments_416674.json:
```json
{
    "body": "maxima install script needs adjustment, see comment 19",
    "created_at": "2021-03-16T19:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416674",
    "user": "mkoeppe"
}
```

maxima install script needs adjustment, see comment 19



---

archive/issue_comments_416675.json:
```json
{
    "body": "In sage-on-gentoo it works fine but the following doctest failure appeared\n\n```\nsage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/interfaces/tests.py\n**********************************************************************\nFile \"/usr/lib/python3.9/site-packages/sage/interfaces/tests.py\", line 34, in sage.interfaces.tests\nFailed example:\n    subprocess.call(\"echo syntax error | ecl\", **kwds) in (0, 255)\nExpected:\n    True\nGot:\n    False\n```\n\nNot sure if it is because of any other aspect of sage-on-gentoo/Gentoo or the lone patch in vanilla sage.",
    "created_at": "2021-03-16T20:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416675",
    "user": "fbissey"
}
```

In sage-on-gentoo it works fine but the following doctest failure appeared

```
sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/interfaces/tests.py
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/interfaces/tests.py", line 34, in sage.interfaces.tests
Failed example:
    subprocess.call("echo syntax error | ecl", **kwds) in (0, 255)
Expected:
    True
Got:
    False
```

Not sure if it is because of any other aspect of sage-on-gentoo/Gentoo or the lone patch in vanilla sage.



---

archive/issue_comments_416676.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-16T20:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416676",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_416677.json:
```json
{
    "body": "Replying to [comment:30 fbissey]:\n> In sage-on-gentoo it works fine but the following doctest failure appeared\n> ...\n> Not sure if it is because of any other aspect of sage-on-gentoo/Gentoo or the lone patch in vanilla sage.\n\nThat's from the missing patch. When stderr is /dev/full, ecl used to go into an infinite loop. That particular problem is fixed, but the test in question actually goes a bit further and checks what happens if both stdout and stderr are full. In short: it segfaults. I reported this upstream a few hours ago not realizing we had a test for it: https://gitlab.com/embeddable-common-lisp/ecl/-/issues/634\n\nI'd rather not add 139 (segault) to the list of allowed return codes there... so maybe we should make the ECL test weaker for the time being? The patch that sage carries is no longer being considered upstream anywhere.",
    "created_at": "2021-03-16T20:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416677",
    "user": "mjo"
}
```

Replying to [comment:30 fbissey]:
> In sage-on-gentoo it works fine but the following doctest failure appeared
> ...
> Not sure if it is because of any other aspect of sage-on-gentoo/Gentoo or the lone patch in vanilla sage.

That's from the missing patch. When stderr is /dev/full, ecl used to go into an infinite loop. That particular problem is fixed, but the test in question actually goes a bit further and checks what happens if both stdout and stderr are full. In short: it segfaults. I reported this upstream a few hours ago not realizing we had a test for it: https://gitlab.com/embeddable-common-lisp/ecl/-/issues/634

I'd rather not add 139 (segault) to the list of allowed return codes there... so maybe we should make the ECL test weaker for the time being? The patch that sage carries is no longer being considered upstream anywhere.



---

archive/issue_comments_416678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-17T13:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416678",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416679.json:
```json
{
    "body": "What's the correct way to substitute a `$SAGE_LOCAL` path into `sage_conf.py.in` at build time? The \"substitute ecl-config path into sage_conf\" commit is currently broken with the SPKG because I don't know what to put in there. It works with the system copy though.",
    "created_at": "2021-03-17T13:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416679",
    "user": "mjo"
}
```

What's the correct way to substitute a `$SAGE_LOCAL` path into `sage_conf.py.in` at build time? The "substitute ecl-config path into sage_conf" commit is currently broken with the SPKG because I don't know what to put in there. It works with the system copy though.



---

archive/issue_comments_416680.json:
```json
{
    "body": "Replying to [comment:34 mjo]:\n> What's the correct way to substitute a `$SAGE_LOCAL` path into `sage_conf.py.in` at build time? \nOK to just use `ecl-config` without path, as we may assume that `SAGE_LOCAL/bin` is near the front of the PATH.",
    "created_at": "2021-03-17T14:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416680",
    "user": "mkoeppe"
}
```

Replying to [comment:34 mjo]:
> What's the correct way to substitute a `$SAGE_LOCAL` path into `sage_conf.py.in` at build time? 
OK to just use `ecl-config` without path, as we may assume that `SAGE_LOCAL/bin` is near the front of the PATH.



---

archive/issue_comments_416681.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-20T22:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416681",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416682.json:
```json
{
    "body": "Ok, that worked.\n\nWe still need the maxima fix from comment:19. And I guess we should check the other packages (kenzo, fricas) that depend on ecl as well.",
    "created_at": "2021-03-20T22:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416682",
    "user": "mjo"
}
```

Ok, that worked.

We still need the maxima fix from comment:19. And I guess we should check the other packages (kenzo, fricas) that depend on ecl as well.



---

archive/issue_comments_416683.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-22T17:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416683",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416684.json:
```json
{
    "body": "Replying to [comment:35 mkoeppe]:\n> Replying to [comment:34 mjo]:\n> > What's the correct way to substitute a `$SAGE_LOCAL` path into `sage_conf.py.in` at build time? \n> OK to just use `ecl-config` without path, as we may assume that `SAGE_LOCAL/bin` is near the front of the PATH.\n\nI ran into the same problem with `MAXIMA_FAS`, which should default to the `SAGE_LOCAL` path where the Maxima SPKG installs it.\n\nI've worked around this in the latest commit but it's pretty ugly. I made the SPKG location the default again, undoing part of #26100. That works because `SAGE_LOCAL` is available in `env.py`.\n\nBut there are two other things you might want to set `MAXIMA_FAS` to: an unusual but correct path, and \"no path.\" Setting it to the correct path is easy, but now \"no path\" is achieved by setting `MAXIMA_FAS = <junk>` in sage_conf, and counting on the fallback in `maxima_lib.py`.\n\nI'm certainly open to other ideas. If we decide to keep the workaround, `@`arojas in particular should make sure I didn't mess anything up too badly for distro packages.\n\nThis passes tests with my system ECL and SPKG maxima on Gentoo.",
    "created_at": "2021-03-22T17:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416684",
    "user": "mjo"
}
```

Replying to [comment:35 mkoeppe]:
> Replying to [comment:34 mjo]:
> > What's the correct way to substitute a `$SAGE_LOCAL` path into `sage_conf.py.in` at build time? 
> OK to just use `ecl-config` without path, as we may assume that `SAGE_LOCAL/bin` is near the front of the PATH.

I ran into the same problem with `MAXIMA_FAS`, which should default to the `SAGE_LOCAL` path where the Maxima SPKG installs it.

I've worked around this in the latest commit but it's pretty ugly. I made the SPKG location the default again, undoing part of #26100. That works because `SAGE_LOCAL` is available in `env.py`.

But there are two other things you might want to set `MAXIMA_FAS` to: an unusual but correct path, and "no path." Setting it to the correct path is easy, but now "no path" is achieved by setting `MAXIMA_FAS = <junk>` in sage_conf, and counting on the fallback in `maxima_lib.py`.

I'm certainly open to other ideas. If we decide to keep the workaround, `@`arojas in particular should make sure I didn't mess anything up too badly for distro packages.

This passes tests with my system ECL and SPKG maxima on Gentoo.



---

archive/issue_comments_416685.json:
```json
{
    "body": "Replying to [comment:40 mjo]:\n \n> I'm certainly open to other ideas. If we decide to keep the workaround, `@`arojas in particular should make sure I didn't mess anything up too badly for distro packages.\n\nHi,\n Looks good as far as the Arch distro package is concerned. `ecl_eval(\"(require 'maxima \\\"{}\\\")\".format(MAXIMA_FAS))` fails because the ecl modules are in the default upstream path `/usr/lib/ecl-${version}`, but then `ecl_eval(\"(require 'maxima)\")` succeeds.",
    "created_at": "2021-03-22T18:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416685",
    "user": "arojas"
}
```

Replying to [comment:40 mjo]:
 
> I'm certainly open to other ideas. If we decide to keep the workaround, `@`arojas in particular should make sure I didn't mess anything up too badly for distro packages.

Hi,
 Looks good as far as the Arch distro package is concerned. `ecl_eval("(require 'maxima \"{}\")".format(MAXIMA_FAS))` fails because the ecl modules are in the default upstream path `/usr/lib/ecl-${version}`, but then `ecl_eval("(require 'maxima)")` succeeds.



---

archive/issue_comments_416686.json:
```json
{
    "body": "this works on my Gentoo box, with system's ECL, too.",
    "created_at": "2021-03-24T18:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416686",
    "user": "dimpase"
}
```

this works on my Gentoo box, with system's ECL, too.



---

archive/issue_comments_416687.json:
```json
{
    "body": "Matthias, as a Lisp guru, what's your opinion on this? Maybe it all may be fixed on Lisp level?",
    "created_at": "2021-03-31T11:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416687",
    "user": "dimpase"
}
```

Matthias, as a Lisp guru, what's your opinion on this? Maybe it all may be fixed on Lisp level?



---

archive/issue_comments_416688.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2021-03-31T11:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416688",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_416689.json:
```json
{
    "body": "I would think (hope) that the current solution is more complicated than needed.\n\nDistributions are able to install maxima in a way that a simple `(REQUIRE :MAXIMA)` works in ecl.\n(Note that this is not just a search for a `maxima.fasl` but rather goes through `EXT:*MODULE-PROVIDER-FUNCTIONS*` into which system definition facilities such as MK:DEFSYSTEM or ASDF hook.)\n\nIf the Sage distribution has to install maxima, then we install the FASL in a custom directory and set the variable `MAXIMA_FAS` to the correct value in `sage_conf`. No defaults should be set in `env.py`.\n\nInstead of the `try`/`except` in `maxima_lib.py`, just dispatch on empty/nonempty value of `MAXIMA_FAS`.",
    "created_at": "2021-03-31T18:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416689",
    "user": "mkoeppe"
}
```

I would think (hope) that the current solution is more complicated than needed.

Distributions are able to install maxima in a way that a simple `(REQUIRE :MAXIMA)` works in ecl.
(Note that this is not just a search for a `maxima.fasl` but rather goes through `EXT:*MODULE-PROVIDER-FUNCTIONS*` into which system definition facilities such as MK:DEFSYSTEM or ASDF hook.)

If the Sage distribution has to install maxima, then we install the FASL in a custom directory and set the variable `MAXIMA_FAS` to the correct value in `sage_conf`. No defaults should be set in `env.py`.

Instead of the `try`/`except` in `maxima_lib.py`, just dispatch on empty/nonempty value of `MAXIMA_FAS`.



---

archive/issue_comments_416690.json:
```json
{
    "body": "Replying to [comment:45 mkoeppe]:\n> If the Sage distribution has to install maxima, then we install the FASL in a custom directory and set the variable `MAXIMA_FAS` to the correct value in `sage_conf`. No defaults should be set in `env.py`.\n> \n> Instead of the `try`/`except` in `maxima_lib.py`, just dispatch on empty/nonempty value of `MAXIMA_FAS`.\n\nThis was the first thing I tried, but I ran into the same problem as in comment:34. With no (?) way to substitute `$SAGE_LOCAL` at `./configure`-time, I made the `$SAGE_LOCAL` location the default at runtime instead. That way you can effectively point `MAXIMA_FAS` at `SAGE_LOCAL` by leaving it undefined.\n\nPretty much all of the extra complexity comes from that. If there's a way to get `$SAGE_LOCAL` into `MAXIMA_FAS` at `./configure`-time, I can make this branch a lot simpler.",
    "created_at": "2021-04-01T00:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416690",
    "user": "mjo"
}
```

Replying to [comment:45 mkoeppe]:
> If the Sage distribution has to install maxima, then we install the FASL in a custom directory and set the variable `MAXIMA_FAS` to the correct value in `sage_conf`. No defaults should be set in `env.py`.
> 
> Instead of the `try`/`except` in `maxima_lib.py`, just dispatch on empty/nonempty value of `MAXIMA_FAS`.

This was the first thing I tried, but I ran into the same problem as in comment:34. With no (?) way to substitute `$SAGE_LOCAL` at `./configure`-time, I made the `$SAGE_LOCAL` location the default at runtime instead. That way you can effectively point `MAXIMA_FAS` at `SAGE_LOCAL` by leaving it undefined.

Pretty much all of the extra complexity comes from that. If there's a way to get `$SAGE_LOCAL` into `MAXIMA_FAS` at `./configure`-time, I can make this branch a lot simpler.



---

archive/issue_comments_416691.json:
```json
{
    "body": "OK, thanks for the explanation, I had forgotten about this issue.\n\nI'll work on a general solution for this problem.",
    "created_at": "2021-04-01T19:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416691",
    "user": "mkoeppe"
}
```

OK, thanks for the explanation, I had forgotten about this issue.

I'll work on a general solution for this problem.



---

archive/issue_comments_416692.json:
```json
{
    "body": "... see #31593.",
    "created_at": "2021-04-01T22:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416692",
    "user": "mkoeppe"
}
```

... see #31593.



---

archive/issue_comments_416693.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-04-02T13:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416693",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_416694.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-04-02T13:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416694",
    "user": "mjo"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_416695.json:
```json
{
    "body": "Looks a lot better now, just needs testing.",
    "created_at": "2021-04-02T13:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416695",
    "user": "mjo"
}
```

Looks a lot better now, just needs testing.



---

archive/issue_comments_416696.json:
```json
{
    "body": "I would suggest to change the lines\n\n```\n            if KENZO_FAS is not None:\n            if MAXIMA_FAS is not None:\n```\n\nto `if not KENZO_FAS` etc. so that it makes no difference whether these variables are undefined in `sage_conf.py` or defined as the empty string.",
    "created_at": "2021-04-02T16:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416696",
    "user": "mkoeppe"
}
```

I would suggest to change the lines

```
            if KENZO_FAS is not None:
            if MAXIMA_FAS is not None:
```

to `if not KENZO_FAS` etc. so that it makes no difference whether these variables are undefined in `sage_conf.py` or defined as the empty string.



---

archive/issue_comments_416697.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-02T19:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416697",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416698.json:
```json
{
    "body": "\n```\n+    # assumes that $SAGE_LOCAL/bin is somewhere near\n+    # the beginning of the user's PATH\n+    AC_SUBST(SAGE_ECL_CONFIG, ['${prefix}'/bin/ecl-config])\n```\n\nthis comment is no longer true and should be removed",
    "created_at": "2021-04-02T19:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416698",
    "user": "mkoeppe"
}
```


```
+    # assumes that $SAGE_LOCAL/bin is somewhere near
+    # the beginning of the user's PATH
+    AC_SUBST(SAGE_ECL_CONFIG, ['${prefix}'/bin/ecl-config])
```

this comment is no longer true and should be removed



---

archive/issue_comments_416699.json:
```json
{
    "body": "\n```\n+    from sage.env import KENZO_FAS\n+    if not KENZO_FAS:\n+        ecl_eval(\"(require :kenzo \\\"{}\\\")\".format(KENZO_FAS))\n+    else:\n+        ecl_eval(\"(require :kenzo)\")\n```\n\nI think this one is backwards",
    "created_at": "2021-04-02T19:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416699",
    "user": "mkoeppe"
}
```


```
+    from sage.env import KENZO_FAS
+    if not KENZO_FAS:
+        ecl_eval("(require :kenzo \"{}\")".format(KENZO_FAS))
+    else:
+        ecl_eval("(require :kenzo)")
```

I think this one is backwards



---

archive/issue_comments_416700.json:
```json
{
    "body": "\n```\necl_eval(\"(setf *load-verbose* NIL)\")\n-if MAXIMA_FAS is not None:\n+if not MAXIMA_FAS:\n     ecl_eval(\"(require 'maxima \\\"{}\\\")\".format(MAXIMA_FAS))\n```\n\nthis one too",
    "created_at": "2021-04-02T19:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416700",
    "user": "mkoeppe"
}
```


```
ecl_eval("(setf *load-verbose* NIL)")
-if MAXIMA_FAS is not None:
+if not MAXIMA_FAS:
     ecl_eval("(require 'maxima \"{}\")".format(MAXIMA_FAS))
```

this one too



---

archive/issue_comments_416701.json:
```json
{
    "body": "Could you add some comments regarding the \"fasb\" business for Kenzo?",
    "created_at": "2021-04-02T19:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416701",
    "user": "mkoeppe"
}
```

Could you add some comments regarding the "fasb" business for Kenzo?



---

archive/issue_comments_416702.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-02T19:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416702",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_416703.json:
```json
{
    "body": "Sure, all done.",
    "created_at": "2021-04-02T19:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416703",
    "user": "mjo"
}
```

Sure, all done.



---

archive/issue_comments_416704.json:
```json
{
    "body": "So this fixes a regression for the `kenzo` package introduced by the ECL update?\n\nIt would be good to update the ticket description.",
    "created_at": "2021-04-02T19:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416704",
    "user": "mkoeppe"
}
```

So this fixes a regression for the `kenzo` package introduced by the ECL update?

It would be good to update the ticket description.



---

archive/issue_comments_416705.json:
```json
{
    "body": "Also, run this ticket on GH Actions please so that we can see if the system packages are accepted correctly",
    "created_at": "2021-04-02T19:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416705",
    "user": "mkoeppe"
}
```

Also, run this ticket on GH Actions please so that we can see if the system packages are accepted correctly



---

archive/issue_comments_416706.json:
```json
{
    "body": "Replying to [comment:60 mkoeppe]:\n> So this fixes a regression for the `kenzo` package introduced by the ECL update?\n> \n\nKenzo is optional so I wouldn't guess as to when it stopped working. Some of its tests fail; for example, `sage/interfaces/kenzo.py` has\n\n\n```\nEXAMPLES::                                                                                                                                                               \n                                                                                                                                                                             \n    sage: from sage.interfaces.kenzo import MooreSpace   # optional - kenzo                                                                                              \n    sage: m24 = MooreSpace(2,4)                          # optional - kenzo                                                                                              \n    sage: m24                                            # optional - kenzo                                                                                              \n    [K10 Simplicial-Set]                                                    \n```\n\n\nbut when I run it I get\n\n\n```\nsage: from sage.interfaces.kenzo import MooreSpace                                                                                                                           \nsage: m24 = MooreSpace(2,4)                                                                                                                                                  \nsage: m24                                                                                                                                                                    \n[K1 Simplicial-Set]\n```\n",
    "created_at": "2021-04-02T20:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416706",
    "user": "mjo"
}
```

Replying to [comment:60 mkoeppe]:
> So this fixes a regression for the `kenzo` package introduced by the ECL update?
> 

Kenzo is optional so I wouldn't guess as to when it stopped working. Some of its tests fail; for example, `sage/interfaces/kenzo.py` has


```
EXAMPLES::                                                                                                                                                               
                                                                                                                                                                             
    sage: from sage.interfaces.kenzo import MooreSpace   # optional - kenzo                                                                                              
    sage: m24 = MooreSpace(2,4)                          # optional - kenzo                                                                                              
    sage: m24                                            # optional - kenzo                                                                                              
    [K10 Simplicial-Set]                                                    
```


but when I run it I get


```
sage: from sage.interfaces.kenzo import MooreSpace                                                                                                                           
sage: m24 = MooreSpace(2,4)                                                                                                                                                  
sage: m24                                                                                                                                                                    
[K1 Simplicial-Set]
```




---

archive/issue_comments_416707.json:
```json
{
    "body": "Tox run: https://github.com/orlitzky/sage/actions/runs/712735969",
    "created_at": "2021-04-02T20:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416707",
    "user": "mjo"
}
```

Tox run: https://github.com/orlitzky/sage/actions/runs/712735969



---

archive/issue_comments_416708.json:
```json
{
    "body": "Replying to [comment:62 mjo]:\n> Replying to [comment:60 mkoeppe]:\n> > So this fixes a regression for the `kenzo` package introduced by the ECL update?\n> > \n> \n> Kenzo is optional so I wouldn't guess as to when it stopped working. \n\nWe do run CI tests on GH Actions for all optional packages (just the installation + spkg-check). See for example https://github.com/sagemath/sage/runs/2223044706 for 9.3.rc1. I do not see any build failures for kenzo. Were just some tests of the sagelib testsuite failing when kenzo is installed (the GH Actions do not test this), or what is the issue?",
    "created_at": "2021-04-03T01:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416708",
    "user": "mkoeppe"
}
```

Replying to [comment:62 mjo]:
> Replying to [comment:60 mkoeppe]:
> > So this fixes a regression for the `kenzo` package introduced by the ECL update?
> > 
> 
> Kenzo is optional so I wouldn't guess as to when it stopped working. 

We do run CI tests on GH Actions for all optional packages (just the installation + spkg-check). See for example https://github.com/sagemath/sage/runs/2223044706 for 9.3.rc1. I do not see any build failures for kenzo. Were just some tests of the sagelib testsuite failing when kenzo is installed (the GH Actions do not test this), or what is the issue?



---

archive/issue_comments_416709.json:
```json
{
    "body": "Replying to [comment:65 mkoeppe]:\n> \n> We do run CI tests on GH Actions for all optional packages (just the installation + spkg-check). See for example https://github.com/sagemath/sage/runs/2223044706 for 9.3.rc1. I do not see any build failures for kenzo. Were just some tests of the sagelib testsuite failing when kenzo is installed (the GH Actions do not test this), or what is the issue?\n> \n\nDigging deeper, I probably just broke kenzo with the ECL spkg.\n\nOur ECL spkg bundles ASDF, and the bundled version works OK. But if the system copy of ECL is used and if that system copy does **not** bundle ASDF, then there's a backwards-incompatible API change in the ASDF `make-build` function which has been deprecated for a while (and now exists only for the sake of backwards-compatibility with ECL).\n\nUltimately the `make-build` function takes a `type` argument (was `:fasl` but I changed it to `:fasb`) and passes it to another function called `select-bundle-operation`. In the bundled copy of ASDF, it looks like\n\n\n```cl\n  ;; Find the operation that produces a given bundle-type                                                                                                                    \n  (defun select-bundle-operation (type &optional monolithic)\n    (ecase type\n      ((:dll :shared-library)\n       (if monolithic 'monolithic-dll-op 'dll-op))\n      ((:lib :static-library)\n       (if monolithic 'monolithic-lib-op 'lib-op))\n      ((:fasl)\n       (if monolithic 'monolithic-compile-bundle-op 'compile-bundle-op))\n      ((:image)\n       'image-op)\n      ((:program)\n       'program-op)))\n```\n\n\nbut in my unbundled ASDF, it's\n\n\n```cl\n  ;; Find the operation that produces a given bundle-type                                                                                                                    \n  (defun select-bundle-operation (type &optional monolithic)\n    (ecase type\n      ((:dll :shared-library)\n       (if monolithic 'monolithic-dll-op 'dll-op))\n      ((:lib :static-library)\n       (if monolithic 'monolithic-lib-op 'lib-op))\n      ((:fasb)\n       (if monolithic 'monolithic-compile-bundle-op 'compile-bundle-op))\n      ((:image)\n       'image-op)\n      ((:program)\n       'program-op))))\n```\n\n\nTo avoid having to support both, one idea that comes to mind is that we could take a newer version of `asdf.lisp` and copy it over the bundled version in the ECL spkg. Then `:fasb` would work in both of the situations above. However it would still fail if the system ECL is using a bundled `asdf.lisp`. Patching kenzo's `compile.lisp` to try both is likely the only reliable way.",
    "created_at": "2021-04-03T17:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416709",
    "user": "mjo"
}
```

Replying to [comment:65 mkoeppe]:
> 
> We do run CI tests on GH Actions for all optional packages (just the installation + spkg-check). See for example https://github.com/sagemath/sage/runs/2223044706 for 9.3.rc1. I do not see any build failures for kenzo. Were just some tests of the sagelib testsuite failing when kenzo is installed (the GH Actions do not test this), or what is the issue?
> 

Digging deeper, I probably just broke kenzo with the ECL spkg.

Our ECL spkg bundles ASDF, and the bundled version works OK. But if the system copy of ECL is used and if that system copy does **not** bundle ASDF, then there's a backwards-incompatible API change in the ASDF `make-build` function which has been deprecated for a while (and now exists only for the sake of backwards-compatibility with ECL).

Ultimately the `make-build` function takes a `type` argument (was `:fasl` but I changed it to `:fasb`) and passes it to another function called `select-bundle-operation`. In the bundled copy of ASDF, it looks like


```cl
  ;; Find the operation that produces a given bundle-type                                                                                                                    
  (defun select-bundle-operation (type &optional monolithic)
    (ecase type
      ((:dll :shared-library)
       (if monolithic 'monolithic-dll-op 'dll-op))
      ((:lib :static-library)
       (if monolithic 'monolithic-lib-op 'lib-op))
      ((:fasl)
       (if monolithic 'monolithic-compile-bundle-op 'compile-bundle-op))
      ((:image)
       'image-op)
      ((:program)
       'program-op)))
```


but in my unbundled ASDF, it's


```cl
  ;; Find the operation that produces a given bundle-type                                                                                                                    
  (defun select-bundle-operation (type &optional monolithic)
    (ecase type
      ((:dll :shared-library)
       (if monolithic 'monolithic-dll-op 'dll-op))
      ((:lib :static-library)
       (if monolithic 'monolithic-lib-op 'lib-op))
      ((:fasb)
       (if monolithic 'monolithic-compile-bundle-op 'compile-bundle-op))
      ((:image)
       'image-op)
      ((:program)
       'program-op))))
```


To avoid having to support both, one idea that comes to mind is that we could take a newer version of `asdf.lisp` and copy it over the bundled version in the ECL spkg. Then `:fasb` would work in both of the situations above. However it would still fail if the system ECL is using a bundled `asdf.lisp`. Patching kenzo's `compile.lisp` to try both is likely the only reliable way.



---

archive/issue_comments_416710.json:
```json
{
    "body": "Does Kenzo have an active upstream maintainer?",
    "created_at": "2021-04-03T17:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416710",
    "user": "mkoeppe"
}
```

Does Kenzo have an active upstream maintainer?



---

archive/issue_comments_416711.json:
```json
{
    "body": "Replying to [comment:66 mjo]:\n> we could take a newer version of `asdf.lisp` and copy it over the bundled version in the ECL spkg. Then `:fasb` would work in both of the situations above.\n\nAs we currently do not have plans to ship additional Common Lisp libraries in the Sage distribution, I think we should not do unbundling work on ECL but stick with upstream.\n\n> Patching kenzo's `compile.lisp` to try both is likely the only reliable way.\n\nYes, I agree, this seems to be the way to go. You can use `HANDLER-CASE` for this http://clhs.lisp.se/Body/m_hand_1.htm",
    "created_at": "2021-04-03T17:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416711",
    "user": "mkoeppe"
}
```

Replying to [comment:66 mjo]:
> we could take a newer version of `asdf.lisp` and copy it over the bundled version in the ECL spkg. Then `:fasb` would work in both of the situations above.

As we currently do not have plans to ship additional Common Lisp libraries in the Sage distribution, I think we should not do unbundling work on ECL but stick with upstream.

> Patching kenzo's `compile.lisp` to try both is likely the only reliable way.

Yes, I agree, this seems to be the way to go. You can use `HANDLER-CASE` for this http://clhs.lisp.se/Body/m_hand_1.htm



---

archive/issue_comments_416712.json:
```json
{
    "body": "It would probably also be good to add a `kenzo/spkg-check.in` that at least tries to load it into ECL.",
    "created_at": "2021-04-03T18:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416712",
    "user": "mkoeppe"
}
```

It would probably also be good to add a `kenzo/spkg-check.in` that at least tries to load it into ECL.



---

archive/issue_comments_416713.json:
```json
{
    "body": "Replying to [comment:67 mkoeppe]:\n> Does Kenzo have an active upstream maintainer?\n\nPaging `@`mmcarco :o\n\n* The original kenzo upstream is at https://www-fourier.ujf-grenoble.fr/~sergerar/Kenzo/\n* Our SPKG points to https://github.com/gheber/kenzo\n* The release itself comes from https://github.com/miguelmarco/kenzo/\n\nThe ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).",
    "created_at": "2021-04-03T18:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416713",
    "user": "mjo"
}
```

Replying to [comment:67 mkoeppe]:
> Does Kenzo have an active upstream maintainer?

Paging `@`mmcarco :o

* The original kenzo upstream is at https://www-fourier.ujf-grenoble.fr/~sergerar/Kenzo/
* Our SPKG points to https://github.com/gheber/kenzo
* The release itself comes from https://github.com/miguelmarco/kenzo/

The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).



---

archive/issue_comments_416714.json:
```json
{
    "body": "> \n> * The original kenzo upstream is at https://www-fourier.ujf-grenoble.fr/~sergerar/Kenzo/\n> * Our SPKG points to https://github.com/gheber/kenzo\n> * The release itself comes from https://github.com/miguelmarco/kenzo/\n> \n> The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).\n\n\nTo clarify this:\n\nWhat we maintain (by \"we\" I mean Ana Romeno, Julian Cuevas, Jose Divason and myself) is a small fork of Kenzo, modified to be compatible with ECL, easier to install, and some extra features to allow a better interface with Sage.\n\nI am not fluent in lisp myself, but will talk about this issues with the rest of the team. Maybe we can modify the package to make it more installation friendly.",
    "created_at": "2021-04-04T11:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416714",
    "user": "mmarco"
}
```

> 
> * The original kenzo upstream is at https://www-fourier.ujf-grenoble.fr/~sergerar/Kenzo/
> * Our SPKG points to https://github.com/gheber/kenzo
> * The release itself comes from https://github.com/miguelmarco/kenzo/
> 
> The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).


To clarify this:

What we maintain (by "we" I mean Ana Romeno, Julian Cuevas, Jose Divason and myself) is a small fork of Kenzo, modified to be compatible with ECL, easier to install, and some extra features to allow a better interface with Sage.

I am not fluent in lisp myself, but will talk about this issues with the rest of the team. Maybe we can modify the package to make it more installation friendly.



---

archive/issue_comments_416715.json:
```json
{
    "body": "Replying to [comment:70 mjo]:\n> The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).\n\nYes, this sounds the like the right solution.",
    "created_at": "2021-04-05T16:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416715",
    "user": "mkoeppe"
}
```

Replying to [comment:70 mjo]:
> The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).

Yes, this sounds the like the right solution.



---

archive/issue_comments_416716.json:
```json
{
    "body": "Replying to [comment:72 mkoeppe]:\n> Replying to [comment:70 mjo]:\n> > The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).\n> \n> Yes, this sounds the like the right solution.\n\n\nI have done some tests on that. Might release a new version with this change in a few days, after some testing.\n\nSo, to make sure: can you confirm that changing from \n\n\n\n```\n(asdf:make-build :kenzo :type :fasl :monolithic t :move-here #P\".\")\n```\n\n\nto \n\n```\n(asdf:operate 'asdf:monolithic-compile-bundle-op :kenzo)\n```\n\n\nin the `compile.lisp` file would solve the problem?",
    "created_at": "2021-04-05T17:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416716",
    "user": "mmarco"
}
```

Replying to [comment:72 mkoeppe]:
> Replying to [comment:70 mjo]:
> > The ASDF docs say that `program-op` and `program-system` should replace `make-build`. Those functions are available in the bundled copy of ASDF as well, so another good long-term option would be for kenzo upstream to switch to them (if possible).
> 
> Yes, this sounds the like the right solution.


I have done some tests on that. Might release a new version with this change in a few days, after some testing.

So, to make sure: can you confirm that changing from 



```
(asdf:make-build :kenzo :type :fasl :monolithic t :move-here #P".")
```


to 

```
(asdf:operate 'asdf:monolithic-compile-bundle-op :kenzo)
```


in the `compile.lisp` file would solve the problem?



---

archive/issue_comments_416717.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416717",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_416718.json:
```json
{
    "body": "is kenzo build fixed? I'm getting (on macOS/homebrew), with ecl from Homebrew\n\n```\n[kenzo-1.1.9] Package 'kenzo' is currently not installed\n[kenzo-1.1.9] No legacy uninstaller found for 'kenzo'; nothing to do\n[kenzo-1.1.9] sed: 1: \"compile.lisp\": command c expects \\ followed by text\n[kenzo-1.1.9] ********************************************************************************\n[kenzo-1.1.9] failed to update make-build invocation\n```\n",
    "created_at": "2021-04-07T20:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416718",
    "user": "dimpase"
}
```

is kenzo build fixed? I'm getting (on macOS/homebrew), with ecl from Homebrew

```
[kenzo-1.1.9] Package 'kenzo' is currently not installed
[kenzo-1.1.9] No legacy uninstaller found for 'kenzo'; nothing to do
[kenzo-1.1.9] sed: 1: "compile.lisp": command c expects \ followed by text
[kenzo-1.1.9] ********************************************************************************
[kenzo-1.1.9] failed to update make-build invocation
```




---

archive/issue_comments_416719.json:
```json
{
    "body": "Replying to [comment:73 mmarco]:\n> \n> I have done some tests on that. Might release a new version with this change in a few days, after some testing.\n> \n> So, to make sure: can you confirm that changing from \n> \n> \n> {{{\n> (asdf:make-build :kenzo :type :fasl :monolithic t :move-here #P\".\")\n> }}}\n> \n> to \n> {{{\n> (asdf:operate 'asdf:monolithic-compile-bundle-op :kenzo)\n> }}}\n> \n> in the `compile.lisp` file would solve the problem?\n\nIt fixes the build for my system ECL (with ASDF unbundled). If it also works with sage's ECL spkg, I think we have a solution. Thanks!",
    "created_at": "2021-04-08T01:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416719",
    "user": "mjo"
}
```

Replying to [comment:73 mmarco]:
> 
> I have done some tests on that. Might release a new version with this change in a few days, after some testing.
> 
> So, to make sure: can you confirm that changing from 
> 
> 
> {{{
> (asdf:make-build :kenzo :type :fasl :monolithic t :move-here #P".")
> }}}
> 
> to 
> {{{
> (asdf:operate 'asdf:monolithic-compile-bundle-op :kenzo)
> }}}
> 
> in the `compile.lisp` file would solve the problem?

It fixes the build for my system ECL (with ASDF unbundled). If it also works with sage's ECL spkg, I think we have a solution. Thanks!



---

archive/issue_comments_416720.json:
```json
{
    "body": "I just made a new release. You can get the tarball at https://github.com/miguelmarco/kenzo/releases/download/1.1.10/kenzo-1.1.10.tar.gz\n\nPlease check that it solves the problem, and then we can update the kenzo Sage package.",
    "created_at": "2021-04-08T10:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416720",
    "user": "mmarco"
}
```

I just made a new release. You can get the tarball at https://github.com/miguelmarco/kenzo/releases/download/1.1.10/kenzo-1.1.10.tar.gz

Please check that it solves the problem, and then we can update the kenzo Sage package.



---

archive/issue_comments_416721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-04-08T19:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416721",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_416722.json:
```json
{
    "body": "The kenzo upgrade is now included, and my previous broken spkg-install hack removed. Everything still works with system ECL.\n\nGithub has helpfully disabled actions on my account after the last run, and I'm waiting to hear back from support. Can someone else kick off a CI run please?",
    "created_at": "2021-04-08T19:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416722",
    "user": "mjo"
}
```

The kenzo upgrade is now included, and my previous broken spkg-install hack removed. Everything still works with system ECL.

Github has helpfully disabled actions on my account after the last run, and I'm waiting to hear back from support. Can someone else kick off a CI run please?



---

archive/issue_comments_416723.json:
```json
{
    "body": "Running at https://github.com/mkoeppe/sage/actions/runs/732049335 (with a bunch of other tickets)",
    "created_at": "2021-04-09T06:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416723",
    "user": "mkoeppe"
}
```

Running at https://github.com/mkoeppe/sage/actions/runs/732049335 (with a bunch of other tickets)



---

archive/issue_comments_416724.json:
```json
{
    "body": "One of the bunch of tickets was broken; the failures that you see in the run are from that.\n\nA new run is at https://github.com/mkoeppe/sage/actions/runs/733869032: \n\nCorrectly accepts system ecl on `homebrew-macos-11.0-xcode_default-standard` (https://github.com/mkoeppe/sage/runs/2308094353) and has clean doctests\n\nCorrectly accepts system ecl on `gentoo-standard` (https://github.com/mkoeppe/sage/runs/2308093679). The build completes. The numerous doctest failures are from the unrelated unfortunate situation described in #31578\n\nCorrectly accepts system ecl on `fedora-34-standard` (https://github.com/mkoeppe/sage/runs/2308093524), but the build fails for unrelated reasons\n\nCorrectly rejects too old system ecl on other platforms.\n\n\nBuild of `kenzo` was tested in https://github.com/mkoeppe/sage/actions/runs/732049334, looks OK.",
    "created_at": "2021-04-10T17:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416724",
    "user": "mkoeppe"
}
```

One of the bunch of tickets was broken; the failures that you see in the run are from that.

A new run is at https://github.com/mkoeppe/sage/actions/runs/733869032: 

Correctly accepts system ecl on `homebrew-macos-11.0-xcode_default-standard` (https://github.com/mkoeppe/sage/runs/2308094353) and has clean doctests

Correctly accepts system ecl on `gentoo-standard` (https://github.com/mkoeppe/sage/runs/2308093679). The build completes. The numerous doctest failures are from the unrelated unfortunate situation described in #31578

Correctly accepts system ecl on `fedora-34-standard` (https://github.com/mkoeppe/sage/runs/2308093524), but the build fails for unrelated reasons

Correctly rejects too old system ecl on other platforms.


Build of `kenzo` was tested in https://github.com/mkoeppe/sage/actions/runs/732049334, looks OK.



---

archive/issue_comments_416725.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-10T17:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416725",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_416726.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-05-26T23:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416726",
    "user": "slelievre"
}
```

New commits:



---

archive/issue_comments_416727.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-06-09T12:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416727",
    "user": "dimpase"
}
```

Changing priority from major to critical.



---

archive/issue_comments_416728.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-20T08:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29380#issuecomment-416728",
    "user": "vbraun"
}
```

Resolution: fixed
