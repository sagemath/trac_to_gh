# Issue 29834: speed up  Maxima computations by using more of maxima_lib

archive/issues_029834.json:
```json
{
    "body": "CC:  nbruin rws kcrisman\n\nEmpirically, `maxima_calculus.eval()` is 5-7 times faster than `maxima.eval()`, cf. e.g.\n\n```\nsage: timeit(\"L = [(i/100.0, maxima_calculus.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]\")\n5 loops, best of 3: 110 ms per loop\nsage: timeit(\"L = [(i/100.0, maxima.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]\")\n5 loops, best of 3: 556 ms per loop\n```\n\n\nFor some reason, there are dozens of `maxima.eval` calls in sage/[src,doc] - and none of `maxima_calculus.eval`. Just going and changing these will be an improvement (in particular, on Cygwin, where pexpect is very flaky, cf #22191).\n\nHowever, `maxima.jacobi_sn()` is about as fast as\n`maxima_calculus.jacobi_sn()`\n\nIssue created by migration from https://trac.sagemath.org/ticket/30071\n\n",
    "created_at": "2020-07-05T10:27:57Z",
    "labels": [
        "interfaces",
        "major",
        "enhancement"
    ],
    "title": "speed up  Maxima computations by using more of maxima_lib",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29834",
    "user": "dimpase"
}
```
CC:  nbruin rws kcrisman

Empirically, `maxima_calculus.eval()` is 5-7 times faster than `maxima.eval()`, cf. e.g.

```
sage: timeit("L = [(i/100.0, maxima_calculus.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]")
5 loops, best of 3: 110 ms per loop
sage: timeit("L = [(i/100.0, maxima.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]")
5 loops, best of 3: 556 ms per loop
```


For some reason, there are dozens of `maxima.eval` calls in sage/[src,doc] - and none of `maxima_calculus.eval`. Just going and changing these will be an improvement (in particular, on Cygwin, where pexpect is very flaky, cf #22191).

However, `maxima.jacobi_sn()` is about as fast as
`maxima_calculus.jacobi_sn()`

Issue created by migration from https://trac.sagemath.org/ticket/30071





---

archive/issue_comments_423801.json:
```json
{
    "body": "I really want to understand why `maxima_calculus.foo()` is as slow as `maxima.foo()` - this look more like a bug than anything else.\n\nI can't seem to find the code responsible for this, though.",
    "created_at": "2020-07-06T08:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423801",
    "user": "dimpase"
}
```

I really want to understand why `maxima_calculus.foo()` is as slow as `maxima.foo()` - this look more like a bug than anything else.

I can't seem to find the code responsible for this, though.



---

archive/issue_comments_423802.json:
```json
{
    "body": "Testing on macOS, I get\n\n```\n%timeit maxima_calculus.jacobi_sn(0.1,2.0)\n1000 loops, best of 5: 484 \u00b5s per loop\nsage: %timeit maxima.jacobi_sn(0.1,2.0)\n100 loops, best of 5: 1.98 ms per loop\n```\n",
    "created_at": "2020-07-06T12:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423802",
    "user": "mkoeppe"
}
```

Testing on macOS, I get

```
%timeit maxima_calculus.jacobi_sn(0.1,2.0)
1000 loops, best of 5: 484 µs per loop
sage: %timeit maxima.jacobi_sn(0.1,2.0)
100 loops, best of 5: 1.98 ms per loop
```




---

archive/issue_comments_423803.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> Testing on macOS, I get\n> {{{\n> %timeit maxima_calculus.jacobi_sn(0.1,2.0)\n> 1000 loops, best of 5: 484 \u00b5s per loop\n> sage: %timeit maxima.jacobi_sn(0.1,2.0)\n> 100 loops, best of 5: 1.98 ms per loop\n> }}}\n> \nright, I probably did something wrong here. Indeed, on Linux I  get similar timings.",
    "created_at": "2020-07-06T13:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423803",
    "user": "dimpase"
}
```

Replying to [comment:3 mkoeppe]:
> Testing on macOS, I get
> {{{
> %timeit maxima_calculus.jacobi_sn(0.1,2.0)
> 1000 loops, best of 5: 484 µs per loop
> sage: %timeit maxima.jacobi_sn(0.1,2.0)
> 100 loops, best of 5: 1.98 ms per loop
> }}}
> 
right, I probably did something wrong here. Indeed, on Linux I  get similar timings.



---

archive/issue_comments_423804.json:
```json
{
    "body": "still there is something funny going on\n\n```\nsage: timeit(\"L = [(i/100.0, maxima_calculus.jacobi_sn(i/100.0,2.0)) for i in range(-300,300)]\")\n5 loops, best of 3: 612 ms per loop\nsage: timeit(\"L = [(i/100.0, maxima_calculus.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]\")\n5 loops, best of 3: 89.3 ms per loop\n```\n\nIf I remove `_calculus` above, the first line errors out with `TIMEOUT: Timeout exceeded.`.",
    "created_at": "2020-07-06T13:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423804",
    "user": "dimpase"
}
```

still there is something funny going on

```
sage: timeit("L = [(i/100.0, maxima_calculus.jacobi_sn(i/100.0,2.0)) for i in range(-300,300)]")
5 loops, best of 3: 612 ms per loop
sage: timeit("L = [(i/100.0, maxima_calculus.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]")
5 loops, best of 3: 89.3 ms per loop
```

If I remove `_calculus` above, the first line errors out with `TIMEOUT: Timeout exceeded.`.



---

archive/issue_comments_423805.json:
```json
{
    "body": "Replying to [comment:5 dimpase]:\n> still there is something funny going on\n> {{{\n> sage: timeit(\"L = [(i/100.0, maxima_calculus.jacobi_sn(i/100.0,2.0)) for i in range(-300,300)]\")\n> 5 loops, best of 3: 612 ms per loop\n> sage: timeit(\"L = [(i/100.0, maxima_calculus.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]\")\n> 5 loops, best of 3: 89.3 ms per loop\n> }}}\nI think this example is showing that maxima's string parser is faster than our to/from binary data conversion for ecllib. I can believe that: there's still a lot of work and memory allocation to do to translate python objects to lisp objects and back. I can imagine that parsing such a small string is easier (the construction of the lisp float objects etc. needs to happen in both cases, so it's really just parsing against the python object constructions). You could try and profile the code to see if anything bad is happening.\n\nFor the results via the expect interface: since the python-to-maxima translation now needs to happen through parsing anyway, it's bound to be slower: there's no upside compared to the \"eval\" at all. The fact that it actually times out: I'd suspect there's an io buffer that gets flooded or an expect interface that gets out of sync due to the high data flow. Note that the timeout happens in the expect interface.",
    "created_at": "2020-07-06T16:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423805",
    "user": "nbruin"
}
```

Replying to [comment:5 dimpase]:
> still there is something funny going on
> {{{
> sage: timeit("L = [(i/100.0, maxima_calculus.jacobi_sn(i/100.0,2.0)) for i in range(-300,300)]")
> 5 loops, best of 3: 612 ms per loop
> sage: timeit("L = [(i/100.0, maxima_calculus.eval('jacobi_sn (%s/100.0,2.0)'%i)) for i in range(-300,300)]")
> 5 loops, best of 3: 89.3 ms per loop
> }}}
I think this example is showing that maxima's string parser is faster than our to/from binary data conversion for ecllib. I can believe that: there's still a lot of work and memory allocation to do to translate python objects to lisp objects and back. I can imagine that parsing such a small string is easier (the construction of the lisp float objects etc. needs to happen in both cases, so it's really just parsing against the python object constructions). You could try and profile the code to see if anything bad is happening.

For the results via the expect interface: since the python-to-maxima translation now needs to happen through parsing anyway, it's bound to be slower: there's no upside compared to the "eval" at all. The fact that it actually times out: I'd suspect there's an io buffer that gets flooded or an expect interface that gets out of sync due to the high data flow. Note that the timeout happens in the expect interface.



---

archive/issue_comments_423806.json:
```json
{
    "body": "In src/sage/calculus/calculus.py one reads\n\n```rst \nThe symbolic calculus package uses its own copy of Maxima for\nsimplification, etc., which is separate from the default\nsystem-wide version::\n\n    sage: maxima.eval('[x,y]: [1,2]')\n    '[1,2]'\n    sage: maxima.eval('expand((x+y)^3)')\n    '27'\n\nIf the copy of maxima used by the symbolic calculus package were\nthe same as the default one, then the following would return 27,\nwhich would be very confusing indeed!\n\n::\n\n    sage: x, y = var('x,y')\n    sage: expand((x+y)^3)\n    x^3 + 3*x^2*y + 3*x*y^2 + y^3\n```\n\n\nIs this the only issue (variable binding in SR done via `maxima`, not `maxima_lib`) that\nprevents Sage from fully switching to `maxima_lib` backend?",
    "created_at": "2020-07-07T09:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423806",
    "user": "dimpase"
}
```

In src/sage/calculus/calculus.py one reads

```rst 
The symbolic calculus package uses its own copy of Maxima for
simplification, etc., which is separate from the default
system-wide version::

    sage: maxima.eval('[x,y]: [1,2]')
    '[1,2]'
    sage: maxima.eval('expand((x+y)^3)')
    '27'

If the copy of maxima used by the symbolic calculus package were
the same as the default one, then the following would return 27,
which would be very confusing indeed!

::

    sage: x, y = var('x,y')
    sage: expand((x+y)^3)
    x^3 + 3*x^2*y + 3*x*y^2 + y^3
```


Is this the only issue (variable binding in SR done via `maxima`, not `maxima_lib`) that
prevents Sage from fully switching to `maxima_lib` backend?



---

archive/issue_comments_423807.json:
```json
{
    "body": "> For some reason, there are dozens of maxima.eval calls in sage/[src,doc] \n\nNote that at least in some modules, actually `lazy_import('sage.interfaces.maxima_lib','maxima')` is done.",
    "created_at": "2020-07-08T05:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423807",
    "user": "mkoeppe"
}
```

> For some reason, there are dozens of maxima.eval calls in sage/[src,doc] 

Note that at least in some modules, actually `lazy_import('sage.interfaces.maxima_lib','maxima')` is done.



---

archive/issue_comments_423808.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> > For some reason, there are dozens of maxima.eval calls in sage/[src,doc] \n> \n> Note that at least in some modules, actually `lazy_import('sage.interfaces.maxima_lib','maxima')` is done.\n\nin just one, in src/sage/calculus/calculus.py (which I quote in comment:7)",
    "created_at": "2020-07-08T08:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423808",
    "user": "dimpase"
}
```

Replying to [comment:8 mkoeppe]:
> > For some reason, there are dozens of maxima.eval calls in sage/[src,doc] 
> 
> Note that at least in some modules, actually `lazy_import('sage.interfaces.maxima_lib','maxima')` is done.

in just one, in src/sage/calculus/calculus.py (which I quote in comment:7)



---

archive/issue_comments_423809.json:
```json
{
    "body": "Also the code of `sage/symbolic/expression.pyx` (but not doctests) use `from sage.calculus.calculus import maxima`. Likewise other modules in `sage/symbolic`\n\n\nLet's make a list... Outside of doctests, I see:\n\n```\ncombinat/combinat.py: from sage.interfaces.all import maxima\n```\n\n\nAnything else?",
    "created_at": "2020-07-08T13:35:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423809",
    "user": "mkoeppe"
}
```

Also the code of `sage/symbolic/expression.pyx` (but not doctests) use `from sage.calculus.calculus import maxima`. Likewise other modules in `sage/symbolic`


Let's make a list... Outside of doctests, I see:

```
combinat/combinat.py: from sage.interfaces.all import maxima
```


Anything else?



---

archive/issue_comments_423810.json:
```json
{
    "body": "in src/doc - the example in the ticket description is from there",
    "created_at": "2020-07-08T13:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423810",
    "user": "dimpase"
}
```

in src/doc - the example in the ticket description is from there



---

archive/issue_comments_423811.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29834#issuecomment-423811",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
