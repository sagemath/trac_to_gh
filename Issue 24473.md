# Issue 24473: scipy build fails with gfortran complaining about CXXFLAGS

Issue created by migration from https://trac.sagemath.org/ticket/24710

Original creator: rws

Original creation time: 2018-02-11 14:46:21

Using the environment variables:

```
export CC="clang"
export CXX="clang++ --stdlib=libc++"
export CXXFLAGS="$CXXFLAGS --stdlib=libc++"
export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
```

scipy fails to build with

```
    /usr/bin/gfortran -Wall -g -shared -L/home/ralf/sage/local/lib -Wl,-rpath,/h
ome/ralf/sage/local/lib -L/home/ralf/sage/local/lib/python/lib -L/home/ralf/sage
/local/lib -lc++ --stdlib=libc++ -L/home/ralf/sage/local/lib/python/lib -L/home/
ralf/sage/local/lib build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy
/fftpack/_fftpackmodule.o build/temp.linux-x86_64-2.7/scipy/fftpack/src/zfft.o b
uild/temp.linux-x86_64-2.7/scipy/fftpack/src/drfft.o build/temp.linux-x86_64-2.7
/scipy/fftpack/src/zrfft.o build/temp.linux-x86_64-2.7/scipy/fftpack/src/zfftnd.
o build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy/fftpack/src/dct.o
 build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/scipy/fftpack/src/dst.o 
build/temp.linux-x86_64-2.7/build/src.linux-x86_64-2.7/build/src.linux-x86_64-2.
7/scipy/fftpack/fortranobject.o -L/home/ralf/sage/local/lib -Lbuild/temp.linux-x
86_64-2.7 -ldfftpack -lfftpack -lpython2.7 -lgfortran -o build/lib.linux-x86_64-
2.7/scipy/fftpack/_fftpack.so
    gfortran: error: unrecognized command line option '--stdlib=libc++'
```

Complete log is attached.


---

Attachment


---

Comment by rws created at 2018-02-11 16:03:15

With this patch scipy installs whenever `--stdlib=libc++` is used in LDFLAGS.
----
New commits:


---

Comment by rws created at 2018-02-11 16:03:15

Changing status from new to needs_review.


---

Comment by rws created at 2018-02-12 07:14:27

So this ticket is wontfix. Use these flags:

```
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
```



---

Comment by rws created at 2018-02-12 07:14:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-02-12 09:24:34

Resolution: invalid


---

Comment by SimonKing created at 2018-02-13 08:57:06

Perhaps closing the ticket was premature. See the comments around comment 25 in #24716: It seems that LDFLAGS is needed after all, which means that the fix from here is needed.


---

Comment by jdemeyer created at 2018-02-13 13:51:16

Replying to [comment:6 SimonKing]:
> It seems that LDFLAGS is needed after all

From a quick look at #24716, it seems that the bug is in NTL upstream. Globally setting `LDFLAGS` to something involving C++ libraries seems wrong because `LDFLAGS` is not specific to C++.

Anyway, if you want to reopen this ticket, I would like a good explanation why you need to change `LDFLAGS` globally.


---

Comment by rws created at 2018-02-13 16:12:17

Indeed libc++ does not seem necessary after all, #24701 may be a problem of the clang version or of the libstdc++ version. My mistake was after the initial #24701 I changed two things at once (clang version and stdlib) and assumed the wrong of the two produced success.


---

Comment by rws created at 2018-02-13 16:21:19

This however still begs the question how it would be possible to change the standard C++ library when building Sage, if needed.


---

Comment by SimonKing created at 2018-02-13 16:33:20

Replying to [comment:8 rws]:
> Indeed libc++ does not seem necessary after all, #24701 may be a problem of the clang version or of the libstdc++ version. My mistake was after the initial #24701 I changed two things at once (clang version and stdlib) and assumed the wrong of the two produced success.

Without doing something about stdlib, Sage simply doesn't build for me with clang. That has of course been the first thing that I tried.


---

Comment by rws created at 2018-02-13 16:56:18

But you didn't change your clang version, right? So how do you know your problem was only because of your missing libc++ flag? At that time I suggested so but I was wrong. ptestlong with clang-4/libstdc++ is fine here, as I just saw.


---

Comment by SimonKing created at 2018-02-13 17:01:37

Replying to [comment:11 rws]:
> But you didn't change your clang version, right? So how do you know your problem was only because of your missing libc++ flag? At that time I suggested so but I was wrong. ptestlong with clang-4/libstdc++ is fine here, as I just saw.

How to install clang-4 on ubuntu? `apt-get install clang` gives version 3.8.


---

Comment by SimonKing created at 2018-02-13 17:04:06

Replying to [comment:12 SimonKing]:
> How to install clang-4 on ubuntu? `apt-get install clang` gives version 3.8.

I see: `apt-get install clang-4.0`.


---

Comment by SimonKing created at 2018-02-14 06:28:34

I can confirm that on ubuntu with clang-4.0 Sage builds fine and passes all tests. However, I still see that some stuff that I care about is 14% slower with clang than with gcc. So, again, it is good for portability but not for production.


---

Comment by rws created at 2018-02-14 07:54:08

Thanks for testing it all on Ubuntu. So I think we can close this and recommend clang-4 with the flags `CC=clang CXX=clang++`.


---

Comment by SimonKing created at 2018-02-14 08:04:04

Replying to [comment:15 rws]:
> Thanks for testing it all on Ubuntu. So I think we can close this

... or rather "keep it closed".

> and recommend clang-4 with the flags `CC=clang CXX=clang++`.

Yes and no. Currently on ubuntu, "clang" is "clang version 3.8".
