# Issue 29395: segfault in `is_identity` morphism check over number fields

Issue created by migration from https://trac.sagemath.org/ticket/29632

Original creator: @mwageringel

Original creation time: 2020-05-01 19:42:47

The following causes a segmentation fault for the identity morphism of polynomial rings over number fields:

```
sage: R.<x,y> = QuadraticField(-1)[]
sage: f = R.hom(R.gens(), R)
sage: f.is_identity()
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
```

This does not happen for morphisms that are not the identity.

This bug was introduced between Sage 8.1 and 8.6.


---

Comment by pbruin created at 2021-02-20 11:08:05

The following also causes the crash:

```
sage: K.<a> = QuadraticField(-1)
sage: R.<x,y> = K[]
sage: h = y._lmul_(QQ.one())
```



---

Comment by pbruin created at 2021-02-20 11:31:10

In the original example this `_lmul_()` call happens in `sage.categories.morphism.Morphism._richcmp_()`.  The problem may be that the parent of the argument is not the scalar ring of the module element, but a smaller ring.


---

Comment by pbruin created at 2021-02-22 07:40:58

Here is a patch.  According to documentation in `sage.structure.coerce_actions`, the `_lmul_()` and `_rmul_()` methods may assume that the input lies in the base ring, so we have to ensure this in the calling function.


---

Comment by pbruin created at 2021-02-22 07:40:58

Changing status from new to needs_review.


---

Comment by pbruin created at 2021-02-22 07:42:39

Note: this does not fix the bug in #30938, so the branch there is still needed.


---

Comment by cremona created at 2021-02-22 15:06:08

I am not very confident reviewing pyx files but this looks fine and does fix the bug, and test pass.  OK!


---

Comment by cremona created at 2021-02-22 15:06:08

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2021-02-23 20:00:43

Thank you for looking into this. I think maybe it would be safer to use a coercion here instead of a conversion? For example

```diff
-gens = [(<ModuleElement>e)._lmul_(B(x)) for x in gens]
+gens = [(<ModuleElement>e)._lmul_(B._coerce_c(x)) for x in gens]
```

Just to be sure that no strange conversions are done.


---

Comment by pbruin created at 2021-02-24 19:01:05

Replying to [comment:7 gh-mwageringel]:
> Thank you for looking into this. I think maybe it would be safer to use a coercion here instead of a conversion? For example
> {{{#!diff
> -gens = [(<ModuleElement>e)._lmul_(B(x)) for x in gens]
> +gens = [(<ModuleElement>e)._lmul_(B._coerce_c(x)) for x in gens]
> }}}
> Just to be sure that no strange conversions are done.
> 
Sounds reasonable, but I prefer `B.coerce(x)` since `_coerce_c` is a remnant of the old coercion model.  Now running tests.


---

Comment by pbruin created at 2021-02-24 19:01:22

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-02-24 20:01:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2021-02-24 20:02:26

Changing status from needs_work to needs_review.


---

Comment by @mwageringel created at 2021-02-25 09:54:07

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2021-02-25 09:54:07

Replying to [comment:8 pbruin]:
> Sounds reasonable, but I prefer `B.coerce(x)` since `_coerce_c` is a remnant of the old coercion model.  Now running tests.

Ok, I did not know that. The tests passed, so I am setting this back to positive.


---

Comment by vbraun created at 2021-03-07 17:06:24

Resolution: fixed
