# Issue 28919: runtime error with simple expression

archive/issues_028919.json:
```json
{
    "body": "\n```\nsage: 2^(-21111111111/11111111111)\n...\nRuntimeError: \n```\n\nWhy is Sage unable to evaluate this expression?\n\nIssue created by migration from https://trac.sagemath.org/ticket/29156\n\n",
    "created_at": "2020-02-05T11:30:01Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "title": "runtime error with simple expression",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28919",
    "user": "zimmerma"
}
```

```
sage: 2^(-21111111111/11111111111)
...
RuntimeError: 
```

Why is Sage unable to evaluate this expression?

Issue created by migration from https://trac.sagemath.org/ticket/29156





---

archive/issue_comments_409364.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409364",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_409365.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-08-29T16:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409365",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_409366.json:
```json
{
    "body": "Set assignee to @bmlivin.",
    "created_at": "2020-09-14T02:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409366",
    "user": "@bmlivin"
}
```

Set assignee to @bmlivin.



---

archive/issue_comments_409367.json:
```json
{
    "body": "This is something that might be a bug in pynac, or it might be that Sage is using pynac incorrectly. Here is an excerpt from pynac's `numeric::power` in `numeric.cpp`, which is what ends up being called in this example:\n\n\n```\nif (exponent.is_negative()) {\n    long int_exp = -(expo.to_long());\n    ...\n}\n```\n\n\nIn your example, `exponent` is what you think it should be (-21111111111/11111111111). Here's what `to_long` does:\n\n\n```\nif (mpz_fits_sint_p(v._bigint)) {\n    long n = mpz_get_si(bigint);\n    mpz_clear(bigint);\n    return n;\n}\nmpz_clear(bigint);\nthrow conversion_error();\n```\n\n\nHere, `v._bigint` is the absolute value of the exponent's numerator, 21111111111. That happens to be a bit larger than 32 bits, so the if statement doesn't execute, and `throw_conversion_error` is called.\n\nI haven't combed through pynac's documentation to see whether they point out that `numeric::power` shouldn't be called with negative rational exponents whose numerators are greater than 32 bits, but I can't see why they would want to do this and not do the same with positive numerators or denominators greater than 32 bits. So I *think* this is a bug in pynac.",
    "created_at": "2020-09-20T00:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409367",
    "user": "@bmlivin"
}
```

This is something that might be a bug in pynac, or it might be that Sage is using pynac incorrectly. Here is an excerpt from pynac's `numeric::power` in `numeric.cpp`, which is what ends up being called in this example:


```
if (exponent.is_negative()) {
    long int_exp = -(expo.to_long());
    ...
}
```


In your example, `exponent` is what you think it should be (-21111111111/11111111111). Here's what `to_long` does:


```
if (mpz_fits_sint_p(v._bigint)) {
    long n = mpz_get_si(bigint);
    mpz_clear(bigint);
    return n;
}
mpz_clear(bigint);
throw conversion_error();
```


Here, `v._bigint` is the absolute value of the exponent's numerator, 21111111111. That happens to be a bit larger than 32 bits, so the if statement doesn't execute, and `throw_conversion_error` is called.

I haven't combed through pynac's documentation to see whether they point out that `numeric::power` shouldn't be called with negative rational exponents whose numerators are greater than 32 bits, but I can't see why they would want to do this and not do the same with positive numerators or denominators greater than 32 bits. So I *think* this is a bug in pynac.



---

archive/issue_comments_409368.json:
```json
{
    "body": "It may be a while before I can report this upstream. If someone else would like to do so, please go ahead.",
    "created_at": "2020-09-20T01:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409368",
    "user": "@bmlivin"
}
```

It may be a while before I can report this upstream. If someone else would like to do so, please go ahead.



---

archive/issue_comments_409369.json:
```json
{
    "body": "See https://github.com/pynac/pynac/issues/356 for the upstream report.",
    "created_at": "2020-10-12T02:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409369",
    "user": "@bmlivin"
}
```

See https://github.com/pynac/pynac/issues/356 for the upstream report.



---

archive/issue_comments_409370.json:
```json
{
    "body": "I've submitted a pull request for this with `pynac`: https://github.com/pynac/pynac/pull/358. That said, my pull request does not fix the underlying issue of dealing with negative exponents. It only loosens the requirement from the numerator needing to fit in a `C` `int` to needing to fit in a `C` `long`. That fixes the specific example reported in this ticket, but if someone wanted to raise to a rational power with a numerator greater than 63 bits, it would still raise an error.",
    "created_at": "2020-11-01T03:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409370",
    "user": "@bmlivin"
}
```

I've submitted a pull request for this with `pynac`: https://github.com/pynac/pynac/pull/358. That said, my pull request does not fix the underlying issue of dealing with negative exponents. It only loosens the requirement from the numerator needing to fit in a `C` `int` to needing to fit in a `C` `long`. That fixes the specific example reported in this ticket, but if someone wanted to raise to a rational power with a numerator greater than 63 bits, it would still raise an error.



---

archive/issue_comments_409371.json:
```json
{
    "body": "This should be fixed by the new commits to #30446. Since they're not merged in yet, I'm not sure whether to change this to needs review or not.",
    "created_at": "2021-01-31T02:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409371",
    "user": "@bmlivin"
}
```

This should be fixed by the new commits to #30446. Since they're not merged in yet, I'm not sure whether to change this to needs review or not.



---

archive/issue_comments_409372.json:
```json
{
    "body": "thanks let's look again once #30446 is merged",
    "created_at": "2021-01-31T05:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409372",
    "user": "zimmerma"
}
```

thanks let's look again once #30446 is merged



---

archive/issue_comments_409373.json:
```json
{
    "body": "This no longer gives an error, because it was fixed by the pynac update in #30446, as mentioned above. The PR just adds a doctest.\n----\nNew commits:",
    "created_at": "2021-03-12T01:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409373",
    "user": "@DaveWitteMorris"
}
```

This no longer gives an error, because it was fixed by the pynac update in #30446, as mentioned above. The PR just adds a doctest.
----
New commits:



---

archive/issue_comments_409374.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-12T01:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409374",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409375.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-12T04:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409375",
    "user": "klee"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_409376.json:
```json
{
    "body": "Looks good.",
    "created_at": "2021-03-12T04:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409376",
    "user": "klee"
}
```

Looks good.



---

archive/issue_comments_409377.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-03-12T06:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409377",
    "user": "@DaveWitteMorris"
}
```

Thanks!



---

archive/issue_comments_409378.json:
```json
{
    "body": "On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/rings/integer.pyx\", line 2201, in sage.rings.integer.Integer.__pow__\nFailed example:\n    2^(-21111111111/11111111111)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer.__pow__[22]>\", line 1, in <module>\n        Integer(2)**(-Integer(21111111111)/Integer(11111111111))\n      File \"sage/rings/integer.pyx\", line 2211, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15193)\n        return coercion_model.bin_op(left, right, operator.pow)\n      File \"sage/structure/coerce.pyx\", line 1204, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10671)\n        return PyObject_CallObject(op, xy)\n      File \"sage/structure/element.pyx\", line 2055, in sage.structure.element.Element.__pow__ (build/cythonized/sage/structure/element.c:14428)\n        return (<Element>left)._pow_(right)\n      File \"sage/rings/rational.pyx\", line 2602, in sage.rings.rational.Rational._pow_ (build/cythonized/sage/rings/rational.cpp:22251)\n        return SR(c) * SR(d).power(n, hold=True)\n      File \"sage/structure/element.pyx\", line 1513, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12170)\n        return (<Element>left)._mul_(right)\n      File \"sage/symbolic/expression.pyx\", line 3799, in sage.symbolic.expression.Expression._mul_ (build/cythonized/sage/symbolic/expression.cpp:25489)\n        x = left._gobj * _right._gobj\n    RuntimeError\n**********************************************************************\n```\n",
    "created_at": "2021-03-17T23:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409378",
    "user": "vbraun"
}
```

On 32-bit:

```
**********************************************************************
File "src/sage/rings/integer.pyx", line 2201, in sage.rings.integer.Integer.__pow__
Failed example:
    2^(-21111111111/11111111111)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.__pow__[22]>", line 1, in <module>
        Integer(2)**(-Integer(21111111111)/Integer(11111111111))
      File "sage/rings/integer.pyx", line 2211, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15193)
        return coercion_model.bin_op(left, right, operator.pow)
      File "sage/structure/coerce.pyx", line 1204, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10671)
        return PyObject_CallObject(op, xy)
      File "sage/structure/element.pyx", line 2055, in sage.structure.element.Element.__pow__ (build/cythonized/sage/structure/element.c:14428)
        return (<Element>left)._pow_(right)
      File "sage/rings/rational.pyx", line 2602, in sage.rings.rational.Rational._pow_ (build/cythonized/sage/rings/rational.cpp:22251)
        return SR(c) * SR(d).power(n, hold=True)
      File "sage/structure/element.pyx", line 1513, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12170)
        return (<Element>left)._mul_(right)
      File "sage/symbolic/expression.pyx", line 3799, in sage.symbolic.expression.Expression._mul_ (build/cythonized/sage/symbolic/expression.cpp:25489)
        x = left._gobj * _right._gobj
    RuntimeError
**********************************************************************
```




---

archive/issue_comments_409379.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-03-17T23:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409379",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_409380.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28919#issuecomment-409380",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.
