# Issue 28919: runtime error with simple expression

Issue created by migration from https://trac.sagemath.org/ticket/29156

Original creator: zimmerma

Original creation time: 2020-02-05 11:30:01


```
sage: 2^(-21111111111/11111111111)
...
RuntimeError: 
```

Why is Sage unable to evaluate this expression?


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-08-29 16:19:06

Changing priority from major to critical.


---

Comment by @bmlivin created at 2020-09-14 02:31:50

Set assignee to @bmlivin.


---

Comment by @bmlivin created at 2020-09-20 00:31:07

This is something that might be a bug in pynac, or it might be that Sage is using pynac incorrectly. Here is an excerpt from pynac's `numeric::power` in `numeric.cpp`, which is what ends up being called in this example:


```
if (exponent.is_negative()) {
    long int_exp = -(expo.to_long());
    ...
}
```


In your example, `exponent` is what you think it should be (-21111111111/11111111111). Here's what `to_long` does:


```
if (mpz_fits_sint_p(v._bigint)) {
    long n = mpz_get_si(bigint);
    mpz_clear(bigint);
    return n;
}
mpz_clear(bigint);
throw conversion_error();
```


Here, `v._bigint` is the absolute value of the exponent's numerator, 21111111111. That happens to be a bit larger than 32 bits, so the if statement doesn't execute, and `throw_conversion_error` is called.

I haven't combed through pynac's documentation to see whether they point out that `numeric::power` shouldn't be called with negative rational exponents whose numerators are greater than 32 bits, but I can't see why they would want to do this and not do the same with positive numerators or denominators greater than 32 bits. So I _think_ this is a bug in pynac.


---

Comment by @bmlivin created at 2020-09-20 01:18:05

It may be a while before I can report this upstream. If someone else would like to do so, please go ahead.


---

Comment by @bmlivin created at 2020-10-12 02:56:46

See https://github.com/pynac/pynac/issues/356 for the upstream report.


---

Comment by @bmlivin created at 2020-11-01 03:10:03

I've submitted a pull request for this with `pynac`: https://github.com/pynac/pynac/pull/358. That said, my pull request does not fix the underlying issue of dealing with negative exponents. It only loosens the requirement from the numerator needing to fit in a `C` `int` to needing to fit in a `C` `long`. That fixes the specific example reported in this ticket, but if someone wanted to raise to a rational power with a numerator greater than 63 bits, it would still raise an error.


---

Comment by @bmlivin created at 2021-01-31 02:48:20

This should be fixed by the new commits to #30446. Since they're not merged in yet, I'm not sure whether to change this to needs review or not.


---

Comment by zimmerma created at 2021-01-31 05:57:36

thanks let's look again once #30446 is merged


---

Comment by @DaveWitteMorris created at 2021-03-12 01:06:10

This no longer gives an error, because it was fixed by the pynac update in #30446, as mentioned above. The PR just adds a doctest.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-03-12 01:06:10

Changing status from new to needs_review.


---

Comment by klee created at 2021-03-12 04:59:51

Changing status from needs_review to positive_review.


---

Comment by klee created at 2021-03-12 04:59:58

Looks good.


---

Comment by @DaveWitteMorris created at 2021-03-12 06:10:04

Thanks!


---

Comment by vbraun created at 2021-03-17 23:39:32

On 32-bit:

```
**********************************************************************
File "src/sage/rings/integer.pyx", line 2201, in sage.rings.integer.Integer.__pow__
Failed example:
    2^(-21111111111/11111111111)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.__pow__[22]>", line 1, in <module>
        Integer(2)**(-Integer(21111111111)/Integer(11111111111))
      File "sage/rings/integer.pyx", line 2211, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15193)
        return coercion_model.bin_op(left, right, operator.pow)
      File "sage/structure/coerce.pyx", line 1204, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10671)
        return PyObject_CallObject(op, xy)
      File "sage/structure/element.pyx", line 2055, in sage.structure.element.Element.__pow__ (build/cythonized/sage/structure/element.c:14428)
        return (<Element>left)._pow_(right)
      File "sage/rings/rational.pyx", line 2602, in sage.rings.rational.Rational._pow_ (build/cythonized/sage/rings/rational.cpp:22251)
        return SR(c) * SR(d).power(n, hold=True)
      File "sage/structure/element.pyx", line 1513, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12170)
        return (<Element>left)._mul_(right)
      File "sage/symbolic/expression.pyx", line 3799, in sage.symbolic.expression.Expression._mul_ (build/cythonized/sage/symbolic/expression.cpp:25489)
        x = left._gobj * _right._gobj
    RuntimeError
**********************************************************************
```



---

Comment by vbraun created at 2021-03-17 23:39:32

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.
