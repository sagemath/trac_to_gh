# Issue 33038: Bug fixes for finitely presented graded modules (#32505)

archive/issues_033038.json:
```json
{
    "body": "CC:  @sverre320 kvanwoerden @tscrim @rrbruner @cnassau @louisng114\n\nSome bug fixes for the ticket #32505.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33275\n\n",
    "created_at": "2022-02-02T17:53:43Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Bug fixes for finitely presented graded modules (#32505)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33038",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @sverre320 kvanwoerden @tscrim @rrbruner @cnassau @louisng114

Some bug fixes for the ticket #32505.

Issue created by migration from https://trac.sagemath.org/ticket/33275





---

archive/issue_comments_470536.json:
```json
{
    "body": "Another item that I think needs to be fixed: in the `resolution` method:\n\n```\n            sage: E.<x,y> = ExteriorAlgebra(QQ)\n            sage: triv = FPModule(E, [0], [[x], [y]]) # trivial module\n            sage: triv.resolution(3)\n            [Free module morphism:\n               From: Free graded left module on 1 generator over The exterior algebra of rank 2 over Rational Field\n               To:   Finitely presented left module on 1 generator and 2 relations over The exterior algebra of rank 2 over Rational Field\n               Defn: g[0] |--> g[0],\n             Free module morphism:\n               From: Free graded left module on 2 generators over The exterior algebra of rank 2 over Rational Field\n               To:   Free graded left module on 1 generator over The exterior algebra of rank 2 over Rational Field\n               Defn: g[1, 0] |--> x*g[0]\n                     g[1, 1] |--> y*g[0],\n```\n\nThe first map here is not a \"Free module morphism\" because its codomain is not free.\n----\nLast 10 new commits:",
    "created_at": "2022-02-02T17:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470536",
    "user": "https://github.com/jhpalmieri"
}
```

Another item that I think needs to be fixed: in the `resolution` method:

```
            sage: E.<x,y> = ExteriorAlgebra(QQ)
            sage: triv = FPModule(E, [0], [[x], [y]]) # trivial module
            sage: triv.resolution(3)
            [Free module morphism:
               From: Free graded left module on 1 generator over The exterior algebra of rank 2 over Rational Field
               To:   Finitely presented left module on 1 generator and 2 relations over The exterior algebra of rank 2 over Rational Field
               Defn: g[0] |--> g[0],
             Free module morphism:
               From: Free graded left module on 2 generators over The exterior algebra of rank 2 over Rational Field
               To:   Free graded left module on 1 generator over The exterior algebra of rank 2 over Rational Field
               Defn: g[1, 0] |--> x*g[0]
                     g[1, 1] |--> y*g[0],
```

The first map here is not a "Free module morphism" because its codomain is not free.
----
Last 10 new commits:



---

archive/issue_comments_470537.json:
```json
{
    "body": "Another view of the problem above:\n\n```\nsage: from sage.modules.fp_graded.module import FPModule\nsage: from sage.modules.fp_graded.free_module import FreeGradedModule\nsage: E.<x,y> = ExteriorAlgebra(QQ)\nsage: triv = FPModule(E, [0], [[x], [y]])\nsage: M = FreeGradedModule(E, [0, 1])\nsage: type(Hom(M, triv))\n<class 'sage.modules.fp_graded.free_homspace.FreeGradedModuleHomspace_with_category_with_equality_by_id'>\nsage: type(Hom(triv, M))\n<class 'sage.modules.fp_graded.homspace.FPModuleHomspace_with_category_with_equality_by_id'>\n```\n\nIt seems to be determining the type of homset from the domain, not paying attention to the codomain.",
    "created_at": "2022-02-02T20:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470537",
    "user": "https://github.com/jhpalmieri"
}
```

Another view of the problem above:

```
sage: from sage.modules.fp_graded.module import FPModule
sage: from sage.modules.fp_graded.free_module import FreeGradedModule
sage: E.<x,y> = ExteriorAlgebra(QQ)
sage: triv = FPModule(E, [0], [[x], [y]])
sage: M = FreeGradedModule(E, [0, 1])
sage: type(Hom(M, triv))
<class 'sage.modules.fp_graded.free_homspace.FreeGradedModuleHomspace_with_category_with_equality_by_id'>
sage: type(Hom(triv, M))
<class 'sage.modules.fp_graded.homspace.FPModuleHomspace_with_category_with_equality_by_id'>
```

It seems to be determining the type of homset from the domain, not paying attention to the codomain.



---

archive/issue_comments_470538.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> Another view of the problem above:\n>\n> [snip]\n>\n> It seems to be determining the type of homset from the domain, not paying attention to the codomain.\n\nI thought about this, and I made a deliberate choice here (one which the code was actually already doing, it just didn't show up explicitly in the doctests). Having it be a free module homomorphism I think is the correct thing to do because we can take advantage of the fact the domain is a free module. I don't think I changed the doc for `FreeGradedModuleMorphism`, which only says that the codomain must be a graded module. So the output mentioned in comment:2 is correct IMO. For the code as it is now, there is no need to make a distinction based on the codomain AFAICS.",
    "created_at": "2022-02-02T23:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470538",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:4 jhpalmieri]:
> Another view of the problem above:
>
> [snip]
>
> It seems to be determining the type of homset from the domain, not paying attention to the codomain.

I thought about this, and I made a deliberate choice here (one which the code was actually already doing, it just didn't show up explicitly in the doctests). Having it be a free module homomorphism I think is the correct thing to do because we can take advantage of the fact the domain is a free module. I don't think I changed the doc for `FreeGradedModuleMorphism`, which only says that the codomain must be a graded module. So the output mentioned in comment:2 is correct IMO. For the code as it is now, there is no need to make a distinction based on the codomain AFAICS.



---

archive/issue_comments_470539.json:
```json
{
    "body": "Okay. It looks a little strange, but it does mean that all of the maps in `M.resolution()` are composable, which is nice (and could be awkward to handle if the 0th map is of a different type than the rest). If something related to this is contributing to issues in #30680, we can revisit it.\n\nI'll mark this as \"needs review\" now.",
    "created_at": "2022-02-03T00:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470539",
    "user": "https://github.com/jhpalmieri"
}
```

Okay. It looks a little strange, but it does mean that all of the maps in `M.resolution()` are composable, which is nice (and could be awkward to handle if the 0th map is of a different type than the rest). If something related to this is contributing to issues in #30680, we can revisit it.

I'll mark this as "needs review" now.



---

archive/issue_comments_470540.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-03T00:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470540",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470541.json:
```json
{
    "body": "Why are you testing `degree()` in `FPModuleElement.coefficients()`? Was this meant to be in `degree()`?\n\n\n```diff\n     - ``check`` -- boolean (default: ``True``); if ``True``, check\n-      that the morphism is well-defined.\n+      that the morphism is well-defined\n```\n\n\nThis is more of an optimization, but it might be better to use `self.codomain().linear_combination()` in `__call__` instead of\n\n```\n        value = sum((c * v for c, v in zip(x.coefficients(), self._values)),\n                    self.codomain().zero())\n```\n\nIf the `FPModule` class does not implement it, we should add it for compatibility.\n\nI am also thinking if we should store `_values` for a `FreeMorphism` as a `dict`, then we could use `x.monomial_coefficients(copy=False)` to only get the non-zero entries. This would also make it order independent. Although then we get into issues of sparse-vs-dense implementations.\n\nNote that `coefficients()` for the free module now has a different behavior than for `CFM` and from the category as it contains `0` entries. (Something I missed previously.) I think this should be changed and within the code we should use `dense_coefficient_list()` (with possibly passing the fixed order where necessary). In particular, I consider this to be a bug.",
    "created_at": "2022-02-03T01:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470541",
    "user": "https://github.com/tscrim"
}
```

Why are you testing `degree()` in `FPModuleElement.coefficients()`? Was this meant to be in `degree()`?


```diff
     - ``check`` -- boolean (default: ``True``); if ``True``, check
-      that the morphism is well-defined.
+      that the morphism is well-defined
```


This is more of an optimization, but it might be better to use `self.codomain().linear_combination()` in `__call__` instead of

```
        value = sum((c * v for c, v in zip(x.coefficients(), self._values)),
                    self.codomain().zero())
```

If the `FPModule` class does not implement it, we should add it for compatibility.

I am also thinking if we should store `_values` for a `FreeMorphism` as a `dict`, then we could use `x.monomial_coefficients(copy=False)` to only get the non-zero entries. This would also make it order independent. Although then we get into issues of sparse-vs-dense implementations.

Note that `coefficients()` for the free module now has a different behavior than for `CFM` and from the category as it contains `0` entries. (Something I missed previously.) I think this should be changed and within the code we should use `dense_coefficient_list()` (with possibly passing the fixed order where necessary). In particular, I consider this to be a bug.



---

archive/issue_comments_470542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-03T03:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470542",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470543.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Why are you testing `degree()` in `FPModuleElement.coefficients()`? Was this meant to be in `degree()`?\n\nIt was a test of the change in the `coefficients` method (removing the sorting), but it might make more sense in `degree`.\n\n> {{{#!diff\n>      - ``check`` -- boolean (default: ``True``); if ``True``, check\n> -      that the morphism is well-defined.\n> +      that the morphism is well-defined\n> }}}\n\nDone, and also got rid of an extra blank line there, too.\n\n> This is more of an optimization, but it might be better to use `self.codomain().linear_combination()` in `__call__` instead of\n> {{{\n>         value = sum((c * v for c, v in zip(x.coefficients(), self._values)),\n>                     self.codomain().zero())\n> }}}\n> If the `FPModule` class does not implement it, we should add it for compatibility.\n\nIt's already implemented, so I used it.\n\n> I am also thinking if we should store `_values` for a `FreeMorphism` as a `dict`, then we could use `x.monomial_coefficients(copy=False)` to only get the non-zero entries. This would also make it order independent. Although then we get into issues of sparse-vs-dense implementations.\n\nI haven't done this. Things are working without it, but we could make this change. We could do the same for coefficients for elements.\n \n> Note that `coefficients()` for the free module now has a different behavior than for `CFM` and from the category as it contains `0` entries. (Something I missed previously.) I think this should be changed and within the code we should use `dense_coefficient_list()` (with possibly passing the fixed order where necessary). In particular, I consider this to be a bug.\n\nI changed the name to `dense_coefficient_list`.",
    "created_at": "2022-02-03T03:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470543",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:7 tscrim]:
> Why are you testing `degree()` in `FPModuleElement.coefficients()`? Was this meant to be in `degree()`?

It was a test of the change in the `coefficients` method (removing the sorting), but it might make more sense in `degree`.

> {{{#!diff
>      - ``check`` -- boolean (default: ``True``); if ``True``, check
> -      that the morphism is well-defined.
> +      that the morphism is well-defined
> }}}

Done, and also got rid of an extra blank line there, too.

> This is more of an optimization, but it might be better to use `self.codomain().linear_combination()` in `__call__` instead of
> {{{
>         value = sum((c * v for c, v in zip(x.coefficients(), self._values)),
>                     self.codomain().zero())
> }}}
> If the `FPModule` class does not implement it, we should add it for compatibility.

It's already implemented, so I used it.

> I am also thinking if we should store `_values` for a `FreeMorphism` as a `dict`, then we could use `x.monomial_coefficients(copy=False)` to only get the non-zero entries. This would also make it order independent. Although then we get into issues of sparse-vs-dense implementations.

I haven't done this. Things are working without it, but we could make this change. We could do the same for coefficients for elements.
 
> Note that `coefficients()` for the free module now has a different behavior than for `CFM` and from the category as it contains `0` entries. (Something I missed previously.) I think this should be changed and within the code we should use `dense_coefficient_list()` (with possibly passing the fixed order where necessary). In particular, I consider this to be a bug.

I changed the name to `dense_coefficient_list`.



---

archive/issue_comments_470544.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-03T03:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470544",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_470545.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-03T06:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470545",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470546.json:
```json
{
    "body": "Thank you for the changes.\n\nReplying to [comment:9 jhpalmieri]:\n> Replying to [comment:7 tscrim]:\n> > I am also thinking if we should store `_values` for a `FreeMorphism` as a `dict`, then we could use `x.monomial_coefficients(copy=False)` to only get the non-zero entries. This would also make it order independent. Although then we get into issues of sparse-vs-dense implementations.\n> \n> I haven't done this. Things are working without it, but we could make this change. We could do the same for coefficients for elements.\n\nRight now all of the examples are effectively acting like dense modules or are small rank. This would be a more invasive change, so I would postpone it for later unless you have a strong desire for it.",
    "created_at": "2022-02-03T08:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470546",
    "user": "https://github.com/tscrim"
}
```

Thank you for the changes.

Replying to [comment:9 jhpalmieri]:
> Replying to [comment:7 tscrim]:
> > I am also thinking if we should store `_values` for a `FreeMorphism` as a `dict`, then we could use `x.monomial_coefficients(copy=False)` to only get the non-zero entries. This would also make it order independent. Although then we get into issues of sparse-vs-dense implementations.
> 
> I haven't done this. Things are working without it, but we could make this change. We could do the same for coefficients for elements.

Right now all of the examples are effectively acting like dense modules or are small rank. This would be a more invasive change, so I would postpone it for later unless you have a strong desire for it.



---

archive/issue_comments_470547.json:
```json
{
    "body": "Hopefully the patchbot will come around, but otherwise I am happy with this ticket modulo I would use `super()` instead of directly calling the category in `dense_coefficient_list()`.",
    "created_at": "2022-02-03T08:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470547",
    "user": "https://github.com/tscrim"
}
```

Hopefully the patchbot will come around, but otherwise I am happy with this ticket modulo I would use `super()` instead of directly calling the category in `dense_coefficient_list()`.



---

archive/issue_comments_470548.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> Hopefully the patchbot will come around, but otherwise I am happy with this ticket modulo I would use `super()` instead of directly calling the category in `dense_coefficient_list()`.\n\nI'm probably doing something stupid, but I can't figure out how to do that:\n\n```python\nsage: from sage.modules.fp_graded.free_module import FreeGradedModule\nsage: A = SteenrodAlgebra()\nsage: M = FreeGradedModule(A, (0, 2))\nsage: a = M.an_element()\nsage: super(FiniteDimensionalModulesWithBasis, a.parent())\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-68-e3772131b543> in <module>\n----> 1 super(FiniteDimensionalModulesWithBasis, a.parent())\n\nTypeError: super(type, obj): obj must be an instance or subtype of type\n\nsage: super(FiniteDimensionalModulesWithBasis.element_class, a)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-70-28003f3b5fda> in <module>\n----> 1 super(FiniteDimensionalModulesWithBasis.element_class, a)\n\nTypeError: super() argument 1 must be type, not lazy_attribute\n```\n\nI've tried a few other variations, but no luck so far.",
    "created_at": "2022-02-03T17:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470548",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:13 tscrim]:
> Hopefully the patchbot will come around, but otherwise I am happy with this ticket modulo I would use `super()` instead of directly calling the category in `dense_coefficient_list()`.

I'm probably doing something stupid, but I can't figure out how to do that:

```python
sage: from sage.modules.fp_graded.free_module import FreeGradedModule
sage: A = SteenrodAlgebra()
sage: M = FreeGradedModule(A, (0, 2))
sage: a = M.an_element()
sage: super(FiniteDimensionalModulesWithBasis, a.parent())
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-68-e3772131b543> in <module>
----> 1 super(FiniteDimensionalModulesWithBasis, a.parent())

TypeError: super(type, obj): obj must be an instance or subtype of type

sage: super(FiniteDimensionalModulesWithBasis.element_class, a)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-70-28003f3b5fda> in <module>
----> 1 super(FiniteDimensionalModulesWithBasis.element_class, a)

TypeError: super() argument 1 must be type, not lazy_attribute
```

I've tried a few other variations, but no luck so far.



---

archive/issue_comments_470549.json:
```json
{
    "body": "Here we go. Just use `super()`. `:)` If my change is good, then positive review.\n----\nNew commits:",
    "created_at": "2022-02-04T01:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470549",
    "user": "https://github.com/tscrim"
}
```

Here we go. Just use `super()`. `:)` If my change is good, then positive review.
----
New commits:



---

archive/issue_comments_470550.json:
```json
{
    "body": "Great, thanks!",
    "created_at": "2022-02-04T01:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470550",
    "user": "https://github.com/jhpalmieri"
}
```

Great, thanks!



---

archive/issue_comments_470551.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-04T01:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470551",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_029910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-16T23:57:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33038#event-29910"
}
```



---

archive/issue_comments_470552.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-16T23:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33038#issuecomment-470552",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
