# Issue 31214: Faster version of longest_increasing_subsequences

archive/issues_031214.json:
```json
{
    "body": "CC:  nadialafreniere enadeau tscrim\n\nKeywords: permutation, subsequences\n\nThe algorithm for the longest_increasing_subsequences function for permutations is currently very inefficient. I worked on a new version that vastly improves the run time of the function. \nNew version:\n\n\n```\nsage: %timeit Permutations(30).random_element().longest_increasing_subsequences()                                     \n19.6 ms \u00b1 2.28 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\n\nOld version:\n\n\n```\nsage: %timeit Permutations(30).random_element().longest_increasing_subsequences()                                     \nThe slowest run took 10.40 times longer than the fastest. This could mean that an intermediate result is being cached.\n3min 34s \u00b1 2min 47s per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31451\n\n",
    "created_at": "2021-03-03T23:08:54Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "title": "Faster version of longest_increasing_subsequences",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31214",
    "user": "@petermoraw"
}
```
CC:  nadialafreniere enadeau tscrim

Keywords: permutation, subsequences

The algorithm for the longest_increasing_subsequences function for permutations is currently very inefficient. I worked on a new version that vastly improves the run time of the function. 
New version:


```
sage: %timeit Permutations(30).random_element().longest_increasing_subsequences()                                     
19.6 ms ± 2.28 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
```


Old version:


```
sage: %timeit Permutations(30).random_element().longest_increasing_subsequences()                                     
The slowest run took 10.40 times longer than the fastest. This could mean that an intermediate result is being cached.
3min 34s ± 2min 47s per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


Issue created by migration from https://trac.sagemath.org/ticket/31451





---

archive/issue_comments_446206.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-03-03T23:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446206",
    "user": "nadialafreniere"
}
```

New commits:



---

archive/issue_comments_446207.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-03T23:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446207",
    "user": "nadialafreniere"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_446208.json:
```json
{
    "body": "* when citing a reference, you should append an underscore, like this\n\n```\n[Sch1961]_\n```\n\n\n* Do not use \"Returns\" in the first line of doc, but \"Return\"",
    "created_at": "2021-03-04T07:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446208",
    "user": "chapoton"
}
```

* when citing a reference, you should append an underscore, like this

```
[Sch1961]_
```


* Do not use "Returns" in the first line of doc, but "Return"



---

archive/issue_comments_446209.json:
```json
{
    "body": "and patchbot complains about\n\n```\nsrc/doc/en/reference/references/index.rst  # Tab character found\n```\n",
    "created_at": "2021-03-04T15:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446209",
    "user": "chapoton"
}
```

and patchbot complains about

```
src/doc/en/reference/references/index.rst  # Tab character found
```




---

archive/issue_comments_446210.json:
```json
{
    "body": "I think `seq == sorted(seq)` would be better replaced by\n\n```\nall(seq[i] <= seq[i+1] for i in range(len(seq)-1))\n```\n\n\nAlso, is there a way you can avoid all of the calls to `index` here:\n\n```\nself.index(seq[j]) < self.index(seq[j+1]):\n```\n\nI feel like there should be a better way to track things, otherwise this could run in `O(len(seq)^2)` (maybe `O(log(len(seq)*len(seq))`) time.\n\nYou can remove this useless list\n\n```diff\n-        potential_sequences = list(itertools.product(*s))\n-        for seq in potential_sequences:\n+        for seq in itertools.product(*s):\n```\n\n\nI think it is cleaner to write `j += 1` instead of `j = j+1`. It might also be marginally faster.",
    "created_at": "2021-03-06T03:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446210",
    "user": "tscrim"
}
```

I think `seq == sorted(seq)` would be better replaced by

```
all(seq[i] <= seq[i+1] for i in range(len(seq)-1))
```


Also, is there a way you can avoid all of the calls to `index` here:

```
self.index(seq[j]) < self.index(seq[j+1]):
```

I feel like there should be a better way to track things, otherwise this could run in `O(len(seq)^2)` (maybe `O(log(len(seq)*len(seq))`) time.

You can remove this useless list

```diff
-        potential_sequences = list(itertools.product(*s))
-        for seq in potential_sequences:
+        for seq in itertools.product(*s):
```


I think it is cleaner to write `j += 1` instead of `j = j+1`. It might also be marginally faster.



---

archive/issue_comments_446211.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-15T04:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446211",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446212.json:
```json
{
    "body": "you still have not fixed comment:3 and comment:4",
    "created_at": "2021-03-15T08:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446212",
    "user": "chapoton"
}
```

you still have not fixed comment:3 and comment:4



---

archive/issue_comments_446213.json:
```json
{
    "body": "Nor have you commented on why you did not implement all of the suggestions from comment:6.",
    "created_at": "2021-03-15T22:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446213",
    "user": "tscrim"
}
```

Nor have you commented on why you did not implement all of the suggestions from comment:6.



---

archive/issue_comments_446214.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-16T12:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446214",
    "user": "nadialafreniere"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_446215.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-17T17:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446215",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446216.json:
```json
{
    "body": "About comment:6, you actually don't need to use `index` at all. You can do a single pass on your permutation to check if the element of seq appear in the right order in your permutation.",
    "created_at": "2021-03-18T10:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446216",
    "user": "enadeau"
}
```

About comment:6, you actually don't need to use `index` at all. You can do a single pass on your permutation to check if the element of seq appear in the right order in your permutation.



---

archive/issue_comments_446217.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446217",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_446218.json:
```json
{
    "body": "There's a clever Python way to check if one sequence is a subsequence of another with a single pass ( https://stackoverflow.com/questions/24017363/how-to-test-if-one-string-is-a-subsequence-of-another ):\n\n\n```\ndef is_subseq(x, y):\n    it = iter(y)\n    return all(c in it for c in x)\n```\n\n\nShort enough that you could eliminate the helper function and go with\n\n\n```\nit = iter(self)\nif seq == sorted(seq) and all(c in it for c in seq):\n```\n\n\nthough including the helper function with the name may make code more transparent.\n\nWere there any other lingering concerns besides fixing that helper function? If no other concerns and no preference between in-line vs helper function, I'll pick one, push the change and set to 'needs review'.",
    "created_at": "2021-07-05T23:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446218",
    "user": "kdilks"
}
```

There's a clever Python way to check if one sequence is a subsequence of another with a single pass ( https://stackoverflow.com/questions/24017363/how-to-test-if-one-string-is-a-subsequence-of-another ):


```
def is_subseq(x, y):
    it = iter(y)
    return all(c in it for c in x)
```


Short enough that you could eliminate the helper function and go with


```
it = iter(self)
if seq == sorted(seq) and all(c in it for c in seq):
```


though including the helper function with the name may make code more transparent.

Were there any other lingering concerns besides fixing that helper function? If no other concerns and no preference between in-line vs helper function, I'll pick one, push the change and set to 'needs review'.



---

archive/issue_comments_446219.json:
```json
{
    "body": "I tried to implement Kevin's solution, but it runs slower than Peter's proposed solution on my computer. I agree that the code would look better, though.\nI think that Peter is working on a clever and much faster solution that would involve a directed graph to store the potential increasing subsequences. That would reduce the number of sequences to check, and they would automatically be subsequences of the permutation (so there would be no need to check that they indeed are; getting rid of the problem pointed out here).\n\nMaybe Peter can confirm my thoughts and update us with where he is in the process.",
    "created_at": "2021-07-07T15:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446219",
    "user": "nadialafreniere"
}
```

I tried to implement Kevin's solution, but it runs slower than Peter's proposed solution on my computer. I agree that the code would look better, though.
I think that Peter is working on a clever and much faster solution that would involve a directed graph to store the potential increasing subsequences. That would reduce the number of sequences to check, and they would automatically be subsequences of the permutation (so there would be no need to check that they indeed are; getting rid of the problem pointed out here).

Maybe Peter can confirm my thoughts and update us with where he is in the process.



---

archive/issue_comments_446220.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446220",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_446221.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-07-15T16:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446221",
    "user": "nadialafreniere"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_446222.json:
```json
{
    "body": "Peter decided to leave the project. I took his ideas as well as some ideas from Finn Hulse, another student I had in my class, to write the patch that should solve the problem. Instead of listing all potential longest increasing subsequences and checking for their presence in the sequence, it uses a directed graph in which all the paths from a source vertex to a sink are longest increasing subsequences.\n\nAs for speeding up the solution, I get the following results:\n\n```\nsage: %timeit Permutations(30).random_element().longest_increasing_subsequences()\n416 \u00b5s \u00b1 6.73 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit Permutations(100).random_element().longest_increasing_subsequences()\n3.34 ms \u00b1 291 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\n\nIn comparison, with the code currently in Sage 9.7.beta5, I get\n\n```\nsage: %timeit Permutations(30).random_element().longest_increasing_subsequences()\nThe slowest run took 34.93 times longer than the fastest. This could mean that an intermediate result is being cached.\n6min 27s \u00b1 6min 38s per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\n----\nNew commits:",
    "created_at": "2022-07-15T16:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446222",
    "user": "nadialafreniere"
}
```

Peter decided to leave the project. I took his ideas as well as some ideas from Finn Hulse, another student I had in my class, to write the patch that should solve the problem. Instead of listing all potential longest increasing subsequences and checking for their presence in the sequence, it uses a directed graph in which all the paths from a source vertex to a sink are longest increasing subsequences.

As for speeding up the solution, I get the following results:

```
sage: %timeit Permutations(30).random_element().longest_increasing_subsequences()
416 µs ± 6.73 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit Permutations(100).random_element().longest_increasing_subsequences()
3.34 ms ± 291 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


In comparison, with the code currently in Sage 9.7.beta5, I get

```
sage: %timeit Permutations(30).random_element().longest_increasing_subsequences()
The slowest run took 34.93 times longer than the fastest. This could mean that an intermediate result is being cached.
6min 27s ± 6min 38s per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

----
New commits:



---

archive/issue_comments_446223.json:
```json
{
    "body": "Sorry, I realized I push the wrong branch. Will push the correct one soon.",
    "created_at": "2022-07-15T19:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446223",
    "user": "nadialafreniere"
}
```

Sorry, I realized I push the wrong branch. Will push the correct one soon.



---

archive/issue_comments_446224.json:
```json
{
    "body": "Fixed the branch issue.",
    "created_at": "2022-07-15T20:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446224",
    "user": "nadialafreniere"
}
```

Fixed the branch issue.



---

archive/issue_comments_446225.json:
```json
{
    "body": "I think the end would be clearer as\n\n```diff\n-        increasing_subsequences = []\n    \n        for i in columns[0]:\n            D.add_edge(0, i)  # 0 is source\n        for i in columns[-1]:\n            D.add_edge(i, n+1) # n+1 is sink\n\n-        for p in D.all_paths(0, n+1):\n-            increasing_subsequences.append(p[1:-1])\n+        increasing_subsequences = [p[1:-1] for p in D.all_paths(0, n+1)]\n```\n",
    "created_at": "2022-07-21T21:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446225",
    "user": "vdelecroix"
}
```

I think the end would be clearer as

```diff
-        increasing_subsequences = []
    
        for i in columns[0]:
            D.add_edge(0, i)  # 0 is source
        for i in columns[-1]:
            D.add_edge(i, n+1) # n+1 is sink

-        for p in D.all_paths(0, n+1):
-            increasing_subsequences.append(p[1:-1])
+        increasing_subsequences = [p[1:-1] for p in D.all_paths(0, n+1)]
```




---

archive/issue_comments_446226.json:
```json
{
    "body": "Another detail,\n\n```\n        increasing_subsequences.sort()\n        increasing_subsequences.reverse()\n```\n\nwould better be\n\n```\n        increasing_subsequences.sort(reverse=True)\n```\n",
    "created_at": "2022-07-21T21:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446226",
    "user": "vdelecroix"
}
```

Another detail,

```
        increasing_subsequences.sort()
        increasing_subsequences.reverse()
```

would better be

```
        increasing_subsequences.sort(reverse=True)
```




---

archive/issue_comments_446227.json:
```json
{
    "body": "Wouldn't it be more efficient to keep the lists in `columns` sorted so that one can do early stop\n\n```\nfor k in columns[j-1]:\n    if k >= self[i]:\n        break\n    D.add_edge(k, self[i])\n```\n\nOf course keeping them sorted imposes a `log(|size|)` for insertion + something smarter than a list as a data structure.",
    "created_at": "2022-07-21T21:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446227",
    "user": "vdelecroix"
}
```

Wouldn't it be more efficient to keep the lists in `columns` sorted so that one can do early stop

```
for k in columns[j-1]:
    if k >= self[i]:
        break
    D.add_edge(k, self[i])
```

Of course keeping them sorted imposes a `log(|size|)` for insertion + something smarter than a list as a data structure.



---

archive/issue_comments_446228.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-22T16:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446228",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446229.json:
```json
{
    "body": "Thanks, Vincent, for your comments. I implemented the changes to the end of the code. I believe it is more readable now.\n\nReplying to [comment:25 vdelecroix]:\n> Wouldn't it be more efficient to keep the lists in `columns` sorted so that one can do early stop\n> {{{\n> for k in columns[j-1]:\n>     if k >= self[i]:\n>         break\n>     D.add_edge(k, self[i])\n> }}}\n> Of course keeping them sorted imposes a `log(|size|)` for insertion + something smarter than a list as a data structure.\n\nThat would indeed be more efficient. I'm trying to think of the appropriate data structure for it, but I'm not sure how to handle this in order to keep it efficient. Did you have anything in mind?",
    "created_at": "2022-07-22T16:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446229",
    "user": "nadialafreniere"
}
```

Thanks, Vincent, for your comments. I implemented the changes to the end of the code. I believe it is more readable now.

Replying to [comment:25 vdelecroix]:
> Wouldn't it be more efficient to keep the lists in `columns` sorted so that one can do early stop
> {{{
> for k in columns[j-1]:
>     if k >= self[i]:
>         break
>     D.add_edge(k, self[i])
> }}}
> Of course keeping them sorted imposes a `log(|size|)` for insertion + something smarter than a list as a data structure.

That would indeed be more efficient. I'm trying to think of the appropriate data structure for it, but I'm not sure how to handle this in order to keep it efficient. Did you have anything in mind?



---

archive/issue_comments_446230.json:
```json
{
    "body": "You can maintain the elements in a column sorted using\n\n```\nsage: from bisect import insort\nsage: L = []\nsage: for e in Permutations(30).random_element():\n....:     insort(L, e)\nsage: print(L)\n[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]\n```\n\n\nYou can also avoid the call to method `self.longest_increasing_subsequence_length` and ensure that both `use `first_row_p_tableau` and `columns[j]` are sorted. Overall this is faster than your current code.\n\n```\ndef longest_increasing_subsequences(self):\n    r\"\"\"\n    \"\"\"\n    n = self.size()\n    if not n:\n        return([[]])\n\n    from bisect import insort\n\n    # getting the column in which each element is inserted\n    first_row_p_tableau = []\n    columns = []\n    D = DiGraph(n+2)\n    for x in self:\n        j = bisect(first_row_p_tableau, x)\n        if j == len(first_row_p_tableau):\n            if columns:\n                for k in columns[-1]:\n                    if k >= x:\n                        break\n                    D.add_edge(k, x)\n            first_row_p_tableau.append(x)\n            columns.append([x])\n        else:\n            first_row_p_tableau[j] = x\n            insort(columns[j], x)\n            if j:\n                for k in columns[j-1]:\n                    if k >= x:\n                        break\n                    D.add_edge(k, x)\n\n    for i in columns[0]:\n        D.add_edge(0, i)  # 0 is source\n    for i in columns[-1]:\n        D.add_edge(i, n+1)  # n+1 is sink\n\n    return sorted([p[1:-1] for p in D.all_paths(0, n+1)], reverse=True)\n```\n",
    "created_at": "2022-07-23T10:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446230",
    "user": "dcoudert"
}
```

You can maintain the elements in a column sorted using

```
sage: from bisect import insort
sage: L = []
sage: for e in Permutations(30).random_element():
....:     insort(L, e)
sage: print(L)
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]
```


You can also avoid the call to method `self.longest_increasing_subsequence_length` and ensure that both `use `first_row_p_tableau` and `columns[j]` are sorted. Overall this is faster than your current code.

```
def longest_increasing_subsequences(self):
    r"""
    """
    n = self.size()
    if not n:
        return([[]])

    from bisect import insort

    # getting the column in which each element is inserted
    first_row_p_tableau = []
    columns = []
    D = DiGraph(n+2)
    for x in self:
        j = bisect(first_row_p_tableau, x)
        if j == len(first_row_p_tableau):
            if columns:
                for k in columns[-1]:
                    if k >= x:
                        break
                    D.add_edge(k, x)
            first_row_p_tableau.append(x)
            columns.append([x])
        else:
            first_row_p_tableau[j] = x
            insort(columns[j], x)
            if j:
                for k in columns[j-1]:
                    if k >= x:
                        break
                    D.add_edge(k, x)

    for i in columns[0]:
        D.add_edge(0, i)  # 0 is source
    for i in columns[-1]:
        D.add_edge(i, n+1)  # n+1 is sink

    return sorted([p[1:-1] for p in D.all_paths(0, n+1)], reverse=True)
```




---

archive/issue_comments_446231.json:
```json
{
    "body": "I did not know about `bisect.insort`. The Python implementation of list uses contiguous array so that insertion is `O(n)` and not `O(log n)`. A priori, using balanced search tree would be more efficient here : iterating through them is `O(1)` per element and insertion is `O(log n)`. Browsing quickly, I found https://pypi.org/project/blist/. But since we are dealing with integers, I would go with the `bstree` from `boost` in C++. Not sure it is worth implementing it, but it could be mentioned as a remark in the code.",
    "created_at": "2022-07-25T07:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446231",
    "user": "vdelecroix"
}
```

I did not know about `bisect.insort`. The Python implementation of list uses contiguous array so that insertion is `O(n)` and not `O(log n)`. A priori, using balanced search tree would be more efficient here : iterating through them is `O(1)` per element and insertion is `O(log n)`. Browsing quickly, I found https://pypi.org/project/blist/. But since we are dealing with integers, I would go with the `bstree` from `boost` in C++. Not sure it is worth implementing it, but it could be mentioned as a remark in the code.



---

archive/issue_comments_446232.json:
```json
{
    "body": "Right, insort is `O(n)`.  What we need here is a data structure with quick insert and enabling to iterate over the elements in increasing order without extra cost...",
    "created_at": "2022-07-25T08:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446232",
    "user": "dcoudert"
}
```

Right, insort is `O(n)`.  What we need here is a data structure with quick insert and enabling to iterate over the elements in increasing order without extra cost...



---

archive/issue_comments_446233.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-25T15:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446233",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446234.json:
```json
{
    "body": "Thanks, David. I did not know about bisect either. That's a great improvement!\nI left the columns into sorted lists and did not implement the BST mostly because I think that the code is easier to read this way and because the code is still pretty fast. Given how slow it used to be, I doubt anyone ever used this code on large permutations. As suggested by Vincent, I added a note to the docstring about it. If others think a more efficient data structure is worth implementing, I would also be fine with it.",
    "created_at": "2022-07-25T16:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446234",
    "user": "nadialafreniere"
}
```

Thanks, David. I did not know about bisect either. That's a great improvement!
I left the columns into sorted lists and did not implement the BST mostly because I think that the code is easier to read this way and because the code is still pretty fast. Given how slow it used to be, I doubt anyone ever used this code on large permutations. As suggested by Vincent, I added a note to the docstring about it. If others think a more efficient data structure is worth implementing, I would also be fine with it.



---

archive/issue_comments_446235.json:
```json
{
    "body": "Nadia, you need a line break after `.. NOTE::` as in\n\n```\n        .. NOTE::\n\n            This algorithm could be made faster using a balanced search tree\n            for each column instead of sorted lists. See discussion on\n            :trac:`31451`.\n```\n",
    "created_at": "2022-07-25T16:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446235",
    "user": "vdelecroix"
}
```

Nadia, you need a line break after `.. NOTE::` as in

```
        .. NOTE::

            This algorithm could be made faster using a balanced search tree
            for each column instead of sorted lists. See discussion on
            :trac:`31451`.
```




---

archive/issue_comments_446236.json:
```json
{
    "body": "The rest looks perfectly good to me. Thanks.",
    "created_at": "2022-07-25T16:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446236",
    "user": "vdelecroix"
}
```

The rest looks perfectly good to me. Thanks.



---

archive/issue_comments_446237.json:
```json
{
    "body": "and also 2 spaces before comments. Just a coding style.\n\n```diff\n-            D.add_edge(i, n+1) # n+1 is sink\n+            D.add_edge(i, n+1)  # n+1 is sink\n```\n\n\nI also think that this code is good enough for now.",
    "created_at": "2022-07-25T16:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446237",
    "user": "dcoudert"
}
```

and also 2 spaces before comments. Just a coding style.

```diff
-            D.add_edge(i, n+1) # n+1 is sink
+            D.add_edge(i, n+1)  # n+1 is sink
```


I also think that this code is good enough for now.



---

archive/issue_comments_446238.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-25T17:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446238",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446239.json:
```json
{
    "body": "Replying to [comment:35 vdelecroix]:\n> The rest looks perfectly good to me. Thanks.\n\n\nThanks, Vincent. I just fixed the formatting.",
    "created_at": "2022-07-25T17:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446239",
    "user": "nadialafreniere"
}
```

Replying to [comment:35 vdelecroix]:
> The rest looks perfectly good to me. Thanks.


Thanks, Vincent. I just fixed the formatting.



---

archive/issue_comments_446240.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-25T17:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446240",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_446241.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-01T20:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31214#issuecomment-446241",
    "user": "vbraun"
}
```

Resolution: fixed
