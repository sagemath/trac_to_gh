# Issue 20605: sage-uncompress-spkg takes ages

Issue created by migration from https://trac.sagemath.org/ticket/20842

Original creator: jdemeyer

Original creation time: 2016-06-18 06:59:32

CC:  embray kcrisman

The recent changes to `sage-uncompress-spkg` have made it _a lot_ slower than before. In particular uncompressing the GCC tarball takes 15 to 30 minutes. I haven't analysed in detail yet.


---

Comment by vbraun created at 2016-06-18 13:56:31

It seems that the script is accidentally quadratic in the number of filenames, and gcc has almost 100k files...


---

Comment by vbraun created at 2016-06-18 14:25:52

Changing status from new to needs_review.


---

Comment by vbraun created at 2016-06-18 14:25:52

New commits:


---

Comment by jhpalmieri created at 2016-06-18 15:55:30

This change certainly speeds things up for me: about 15 minutes to unpack `gcc` without it, about 1 minute with it.


---

Comment by leif created at 2016-06-18 16:12:47

It is still horrible regarding what its sole purpose is (namely to extract _all files_ from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).

Yay.


---

Comment by leif created at 2016-06-18 16:21:14

P.S.:  Because of its origin, it's by the way pretty legal to have the "same" (based on its name) file occur multiple times within a single tape archive. ;-)


---

Comment by jhpalmieri created at 2016-06-18 23:16:27

Replying to [comment:6 leif]:
> It is still horrible regarding what its sole purpose is.

Okay, so propose a fix, perhaps on another ticket.

In the meantime, Sage builds from scratch on my OS X machine in a reasonable amount of time and passes all doctests.


---

Comment by kcrisman created at 2016-06-19 01:07:08

This allowed me to start (not finish, as apparently my install of command line tools was somehow fake?!#%) building gcc, so thumbs up here.

PS I don't know the history of this file - it is really just to remove unintentional `.DS_STORE` files, some of which I know I inadvertently introduced at times?


---

Comment by vbraun created at 2016-06-19 09:03:04

IMHO the only thing wrong with the script is that there is no testing, it should be moved into the `sage_bootstrap` package and unit tested across Python versions. But thats not what this ticket is about.

The script consolidates our unpacking and fixes the usual warts that upstream tends to introduce into their tarballs. It also gives different archive types a uniform interface so that we can add more later. The interface uses filename strings instead of an archive-specific struct which helps in making the interface uniform. 

Finally, we don't need to handle every pathology that possibly can appear in every supported archive format, only the ones that do occur in the tarballs that we work with.


---

Comment by embray created at 2016-06-20 12:58:02

Replying to [comment:6 leif]:
> It is still horrible regarding what its sole purpose is (namely to extract _all files_ from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).

This was indeed motivated specifically by #20717.  Of course those files shouldn't be there in the first place.  But if they are, they _definitely_ shouldn't be extracted.


---

Comment by jhpalmieri created at 2016-06-20 19:47:20

Any reason this shouldn't get a positive review? It would be good to get it merged into the next beta, so `gcc` (among other things) will build in a reasonable amount of time.


---

Comment by vbraun created at 2016-06-20 21:04:53

IMHO none, somebody just press the button...


---

Comment by kcrisman created at 2016-06-21 01:04:31

Changing status from needs_review to positive_review.


---

Comment by leif created at 2016-06-21 12:46:42

Replying to [comment:12 jhpalmieri]:
> Any reason this shouldn't get a positive review? It would be good to get it merged into the next beta, so `gcc` (among other things) will build in a reasonable amount of time.

Sure.  It is now (hopefully) sub-quadratic in the number of files in the tarball... B)


---

Comment by leif created at 2016-06-21 13:09:38

Replying to [comment:11 embray]:
> Replying to [comment:6 leif]:
> > It is still horrible regarding what its sole purpose is (namely to extract _all files_ from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).
> 
> This was indeed motivated specifically by #20717.  Of course those files shouldn't be there in the first place.  But if they are, they _definitely_ shouldn't be extracted.

The script though _silently_ drops them; no warning, no error message.

Furthermore, there's absolutely no reason to sort the files by their names, then extracting them in their original order, not only but especially when there aren't any "OS-specific" files in the tarball (which is the common case -- as you said, there shouldn't be any in the first place).

While already the Python library's function name is "funny" (extract*all*()), it's not necessary to pass an _unmodified_ list of all tarball entries to it in the "non-error" case.


---

Comment by embray created at 2016-06-21 14:20:40

I would be fine with adding a warning message--it would be good to know when invalid files are in some tarball.  I have been advised that "nobody" reads the output from sage builds, but I do so...

I don't understand the rest.  There's no sorting for example.  As for the common case there's no way to detect that's the case without checking for files that shouldn't be extracted so that's a moot point.


---

Comment by vbraun created at 2016-06-21 20:45:21

You can always open another ticket if you want to make more changes...


---

Comment by vbraun created at 2016-06-21 20:45:39

Resolution: fixed
