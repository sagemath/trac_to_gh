# Issue 13041: Comparisons in real number field

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2012-07-08 18:45:16

Assignee: vdelecroix

Keywords: real number field, comparison

Provide the order from RR for number field embedded in RR as in

```
sage: K.<sqrt2> = NumberField(x^2 - 2, 'sqrt2', embedding=1.4142)
sage: sqrt2 - 1 > 0
True
sage: sqrt2 < 2
True
```


There is a patch for quadratic field. Another one is comming for general number fields.


---

Comment by aapitzsch created at 2012-07-08 19:42:26

I had a short look at your patch.
Could you use Python 3 compatible syntax to raise errors. E.g.

```
raise ValueError("absolute value not implemented for complex embeddings")
```



---

Comment by burcin created at 2012-07-10 17:04:55

Thanks again for the patch. A few comments:

* reimplementing the comparison of quadratic number field elements is a well defined unit of change itself. I suggest moving `floor()` and `ceil()` implementations to a separate patch, even a different ticket.
* Do you really need to use rich comparisons? Working only with `__cmp__` should simplify the case comparisons before the return statements and avoid the new `python_object.pxi` include.
* I guess speed could be further improved by using an approximation (with `double`s say) first and falling back to the exact computation if the results are too close.
* `left.D` is of type `Integer`. Cython tries to do the right thing for `<unsigned int> left.D`, but it would be better to use `mpz_mul()` with `left.D.value`.
* `mpz_sgn()` returns 0 if the argument is `0`. You don't seem to cover this case, though I couldn't find any example that returns wrong results.
* To avoid code duplication, it might be better change the if statement to:

```
        if mpz_sgn(i)*mpz_sgn(j) == 1:
            # both i and j are positive or negative
            mpz_mul(i, i, i)
            mpz_mul(j, j, j)
            mpz_mul_ui(j, j, <unsigned int> left.D)

            test = mpz_cmp(i, j)
            if mpz_sgn(i) == -1:
                # both i and j are negative
                test *= -1
```



---

Comment by vdelecroix created at 2012-07-11 07:37:03

> * reimplementing the comparison of quadratic number field elements is a well defined unit of change itself. I suggest moving `floor()` and `ceil()` implementations to a separate patch, even a different ticket.
> * `left.D` is of type `Integer`. Cython tries to do the right thing for `<unsigned int> left.D`, but it would be better to use `mpz_mul()` with `left.D.value`.

Done and done.

> * Do you really need to use rich comparisons? Working only with `__cmp__` should simplify the case comparisons before the return statements and avoid the new `python_object.pxi` include.

We loose speed (~1 micro sec) by doing this. I quickly look at the code of comparison for Integer. The comparison is directly implemented inside __richcmp__ and avoid as much as possible the coercion machinery (ie the type of the input is check with the cython function PY_TYPE_CHECK). Do you think we should proceed that way ?

> * I guess speed could be further improved by using an approximation (with `double`s say) first and falling back to the exact computation if the results are too close.

What do you mean by too close ? How do I certify that my float comparison is accurate enough ?
Moreover, if we proceed that way we have to perform conversion from mpz_t to float (or double or real_mpfr). A way it may work is to look first if a,b, D and denom have reasonable values (recall that mpz_t have unlimited precision) and if yes, convert it to double and try to compare the arguments.
Last, I'm not sure the gain of speed would be terrific. Comparison requires only 7 integer operations.

> * `mpz_sgn()` returns 0 if the argument is `0`. You don't seem to cover this case, though I couldn't find any example that returns wrong results.

Actually there is no problem since we compute the sign of an expression of the form a^2 + b^2 D where a and b are both integers (and one of them is non null) and D is a square free integer. Hence the sign is never 0.

> * To avoid code duplication, it might be better change the if statement to:
> {{{
>         if mpz_sgn(i)*mpz_sgn(j) == 1:
>             # both i and j are positive or negative
>             mpz_mul(i, i, i)
>             mpz_mul(j, j, j)
>             mpz_mul_ui(j, j, <unsigned int> left.D)
> 
>             test = mpz_cmp(i, j)
>             if mpz_sgn(i) == -1:
>                 # both i and j are negative
>                 test *= -1
> }}}

Sure but that way we call twice mpz_sgn(i)... I may change it if you prefer.


Actually, the part where a lot of time is lost is the check for embedding

```
if not RDF.has_coerce_map_from(left._parent):
    ...
```

By replacing it by

```
if left.D < 0:
   ...
```

I pass from 4 micro second to 2 micro seconds. That way comparison without embedding for positive discriminant will be equivalent to comparison with the standard embedding. This is in the last version of the patch. What do you think about that ?


---

Comment by vdelecroix created at 2012-07-14 18:54:58

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2012-07-18 11:59:40

The code for comparison introduces a small bug as it ask to the parent whether the embedding is standard or not (via the boolean attribute _standard_embedding). But the latter was not defined for Cyclotomic field of order 3,4,6 (which are the ones which are quadratic). In that case, the attribute _standard_embedding is created at the initialization of the cyclotomic field.

The new patch takes care of this.


---

Comment by vdelecroix created at 2012-08-04 04:29:17

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2012-08-04 12:38:37

Because there are many parents for quadratic elements, I was obliged to test whether the parent has a method '_standard_embedding' or not. I correct all tests (many output have changed) and waiting for patchbot and reviewer!


---

Comment by vdelecroix created at 2012-08-04 12:38:46

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2012-08-08 09:14:28

I corrected the two last tests that have failed...


---

Comment by jdemeyer created at 2012-08-08 12:42:37

How does this patch here relate to #7160?


---

Comment by jdemeyer created at 2012-08-08 12:45:14

In the ticket title "real number field", should it say "quadratic number field" instead?


---

Comment by vdelecroix created at 2012-08-08 13:30:35

Hi Jeroen,

From the last comment of Burcin on #7160, it seems to me that we will close #7160 as a duplicate. On the other hand, an other patch is coming for comparisons of general number field. Would you prefer to have it on a separate ticket ?


---

Comment by jdemeyer created at 2012-08-08 13:43:04

Replying to [comment:15 vdelecroix]:
> From the last comment of Burcin on #7160, it seems to me that we will close #7160 as a duplicate. On the other hand, an other patch is coming for comparisons of general number field. Would you prefer to have it on a separate ticket ?
I don't care very much, but I think it should be clear how the various tickets relate to eachother.  

Also #10064 is related, at least it has #7160 as dependency.


---

Comment by tkluck created at 2012-08-09 15:19:12

Just had a quick look at your patch. How about using ``@`cached_method` as a decorator for `_gen_approx`? Then you don't have to implement caching yourself. It makes the code a little bit easier to read.


---

Comment by vdelecroix created at 2012-08-13 15:56:31

Hello,

Actually, a lot of time is lost for asking questions to the parent. For quadratic number field, it is for asking about the attribute _standard_embedding. I build a new patch with a bint attribute added to NumberFieldElement_quadratic and the speed of comparison is divided by 10 (from 4 milliseconds to 400 nanoseconds). It will be updated as soon as possible.
As modifying the structure of NumberFieldElement_quadratic is a major change, I will split the patch into two parts : quadratic number fields and general number fields.

Vincent


---

Comment by vdelecroix created at 2013-05-10 09:49:56

apply trac_13213-quadratic_field_comparison.patch


---

Comment by jpflori created at 2013-05-10 14:27:25

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-05-10 14:27:25

This fails to apply on 5.10.beta2.
Having a look right now.


---

Comment by vdelecroix created at 2013-05-10 14:55:30

Replying to [comment:22 jpflori]:
> This fails to apply on 5.10.beta2.

Yes, it is a minor rejection on sage/schemes/elliptic_curves/ell_number_field.py and a more serious problem with python_object.pxi that seems to not exist anymore.

> Having a look right now.

Does it mean that I should wait for your modifications ?


---

Comment by jpflori created at 2013-05-10 15:03:06

No, if you identified the issues, please go ahead.
I've just untarred 10.beta2 and are currently on something else, so you will definitely get faster.


---

Comment by vdelecroix created at 2013-05-10 15:14:49

For the second problem I simply removed the import of python_object.pxi which was not needed anymore.

apply trac_13213-quadratic_field_comparison.patch


---

Comment by vdelecroix created at 2013-05-10 15:15:04

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2013-05-10 16:10:20

Last minute modification: more tests, more docs.

apply trac_13213-quadratic_field_comparison.patch


---

Comment by kcrisman created at 2013-05-10 16:21:08

#7545 is possibly a related ticket.


---

Comment by vdelecroix created at 2013-05-10 18:20:45

There is a *strange* problem

```
sage: K.<sqrt2> = QuadraticField(2)
sage: 1/2 + sqrt2 > 0
False
```



---

Comment by vdelecroix created at 2013-05-10 18:20:45

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2013-05-10 19:10:02

Replying to [comment:29 vdelecroix]:
> There is a *strange* problem
> {{{
> sage: K.<sqrt2> = QuadraticField(2)
> sage: 1/2 + sqrt2 > 0
> False
> }}}

I got the problem... it was because there is a natural morphism implemented from the rational field to quadratic number field (`sage.rings.number_field.number_field_element_quadratic.Q_to_quadratic_field_element`) which uses a non properly initialized instance of a quadratic element !


---

Comment by vdelecroix created at 2013-05-10 19:10:40

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2013-05-10 19:10:40

apply trac_13213-quadratic_field_comparison.patch


---

Comment by vbraun created at 2013-05-14 11:11:17

I get a doctest failure with sage-5.10.beta2:

```
File "devel/sage/doc/de/tutorial/tour_advanced.rst", line 483, in doc.de.tutorial.tour_advanced
Failed example:
    M.T(2).charpoly('x').factor()
Expected:
    (x - 2*zeta6 - 1) * (x - zeta6 - 2) * (x + zeta6 + 1)^2
Got:
    (x - zeta6 - 2) * (x - 2*zeta6 - 1) * (x + zeta6 + 1)^2
**********************************************************************
1 item had failures:
   1 of 136 in doc.de.tutorial.tour_advanced
    [118 tests, 1 failure, 1.44 s]
```



---

Attachment


---

Comment by vdelecroix created at 2013-05-15 14:32:33

Replying to [comment:32 vbraun]:
> I get a doctest failure with sage-5.10.beta2:
> {{{
> File "devel/sage/doc/de/tutorial/tour_advanced.rst", line 483, in doc.de.tutorial.tour_advanced
> Failed example:
>     M.T(2).charpoly('x').factor()
> Expected:
>     (x - 2*zeta6 - 1) * (x - zeta6 - 2) * (x + zeta6 + 1)^2
> Got:
>     (x - zeta6 - 2) * (x - 2*zeta6 - 1) * (x + zeta6 + 1)^2
> **********************************************************************
> 1 item had failures:
>    1 of 136 in doc.de.tutorial.tour_advanced
>     [118 tests, 1 failure, 1.44 s]
> }}}

Thanks for that. I got the same error on my computer and change the patch accordingly. Why was patchbot happy with the former patch ?

apply trac_13213-quadratic_field_comparison.patch


---

Comment by vbraun created at 2013-05-15 14:47:53

The patchbot apparently doesn't check German docs. Enttäuschend! ;-)


---

Comment by vbraun created at 2013-05-15 16:45:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-05-15 16:45:37

All tests pass.


---

Comment by jdemeyer created at 2013-05-17 06:32:23

Resolution: fixed
